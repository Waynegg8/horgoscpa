<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="è–ªè³‡ç®¡ç†" />
    <title>è–ªè³‡ç®¡ç†ï½œç¸½è¦½</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/payroll-page.css" />
    
    <!-- âš¡ é è¼‰å…¥èˆ‡å¿«å–ç³»çµ± -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <!-- é æ¸²æŸ“ç³»çµ±å·²ç¦ç”¨ï¼ˆæœƒå¹²æ“¾TABåˆ‡æ›ï¼‰ -->
    <!-- <script src="/assets/js/prerender.js"></script> -->
    <!-- <script src="/assets/js/page-prerender.js"></script> -->
  </head>
  <body class="payroll-page">
    <div style="padding:16px 20px;">
      <div id="infoBar" class="info-bar" style="display:none;" role="alert">æ‚¨æ²’æœ‰æ¬Šé™å­˜å–æ­¤æ¨¡çµ„</div>
      <div class="payroll-toolbar" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
        <label for="month">æœˆä»½</label>
        <input id="month" type="month" aria-label="æœˆä»½" />
        <div class="toolbar-spacer" style="flex:1;"></div>
        <button id="btn-finalize" type="button" class="btn primary" disabled>ç”¢è£½æœˆçµ</button>
        <button id="btn-export-csv" type="button" class="btn" disabled>åŒ¯å‡º CSV</button>
        <button id="btn-export-pdf" type="button" class="btn" disabled>åŒ¯å‡º PDF</button>
      </div>
      <div id="finalizeMsg" class="info-bar" style="display:none;"></div>
      <nav class="payroll-tabs" role="tablist" aria-label="è–ªè³‡ç®¡ç†åˆ†é " style="display:flex;gap:8px;border-bottom:2px solid #e5e7eb;">
        <button class="tab active" role="tab" aria-selected="true" data-tab="calc" data-admin-only="true">è–ªè³‡è¨ˆç®—</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="items" data-admin-only="true">è–ªè³‡é …ç›®è¨­å®š</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="emp" data-admin-only="true">å“¡å·¥è–ªè³‡è¨­å®š</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="bonus" data-admin-only="true">ç¸¾æ•ˆçé‡‘èª¿æ•´</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="yearend" data-admin-only="true">å¹´çµ‚çé‡‘</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="settings" data-admin-only="true">âš™ï¸ ç³»çµ±è¨­å®š</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="punch">ğŸ“ æ‰“å¡è¨˜éŒ„ä¸Šå‚³</button>
      </nav>
    </div>

    <main class="payroll-content">
      <!-- è–ªè³‡è¨ˆç®— -->
      <section id="panel-calc" class="panel" role="tabpanel" aria-labelledby="tab-calc">
        <div class="card">
          <div class="section-toolbar">
            <input id="empSearchCalc" type="search" placeholder="æœå°‹å“¡å·¥â€¦" />
            <select id="statusCalc">
              <option value="all">å…¨éƒ¨</option>
              <option value="complete">å·²å®Œæˆ</option>
              <option value="pending">æœªå®Œæˆ</option>
            </select>
            <button id="btnRefreshCalc" class="btn btn-sm" style="margin-left: 10px;">
              ğŸ”„ åˆ·æ–°æ•¸æ“š
            </button>
          </div>
          <table class="table" aria-label="è–ªè³‡è¨ˆç®—åˆ—è¡¨" style="font-size: 0.875rem;">
            <thead>
              <tr>
                <th rowspan="2" style="width: 40px;">æ˜ç´°</th>
                <th rowspan="2">å§“å</th>
                <th rowspan="2">åº•è–ª</th>
                <th colspan="7" style="background: #f0fdf4; text-align: center;">æ”¶å…¥æ˜ç´°</th>
                <th colspan="2" style="background: #fef2f2; text-align: center;">æ‰£æ¬¾æ˜ç´°</th>
                <th rowspan="2" style="background: #f0f9ff;">æ‡‰ç™¼</th>
                <th rowspan="2" style="background: #dbeafe;">å¯¦ç™¼</th>
              </tr>
              <tr>
                <th style="background: #f0fdf4;">æ´¥è²¼</th>
                <th style="background: #f0fdf4;">çé‡‘</th>
                <th style="background: #f0fdf4;">å…¨å‹¤</th>
                <th style="background: #f0fdf4;">åŠ ç­è²»<br><small style="font-weight:normal;font-size:0.75rem;">å·¥æ™‚Ã—æ™‚è–ª</small></th>
                <th style="background: #f0fdf4;">èª¤é¤è²»<br><small style="font-weight:normal;font-size:0.75rem;">å¤©æ•¸Ã—å–®åƒ¹</small></th>
                <th style="background: #f0fdf4;">äº¤é€š<br><small style="font-weight:normal;font-size:0.75rem;">é‡Œç¨‹</small></th>
                <th style="background: #f0fdf4;">ç¸¾æ•ˆ</th>
                <th style="background: #fef2f2;">å›ºå®š<br><small style="font-weight:normal;font-size:0.75rem;">å‹å¥ä¿ç­‰</small></th>
                <th style="background: #fef2f2;">è«‹å‡<br><small style="font-weight:normal;font-size:0.75rem;">ç—…/äº‹å‡</small></th>
              </tr>
            </thead>
            <tbody id="tbodyCalc">
              <tr><td colspan="13" class="muted">å°šç„¡è³‡æ–™</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- è–ªè³‡é …ç›®è¨­å®š -->
      <section id="panel-items" class="panel" role="tabpanel" aria-labelledby="tab-items">
        <div class="card">
          <div class="section-toolbar">
            <input id="itemSearch" type="search" placeholder="æœå°‹é …ç›®ä»£ç¢¼/åç¨±â€¦" />
            <button type="button" id="btnAddItem" class="btn primary">æ–°å¢é …ç›®</button>
          </div>
          <table class="table" aria-label="è–ªè³‡é …ç›®åˆ—è¡¨">
            <thead>
              <tr>
                <th>é …ç›®ä»£ç¢¼</th>
                <th>é …ç›®åç¨±</th>
                <th>é¡åˆ¥</th>
                <th>ç¶“å¸¸æ€§çµ¦èˆ‡</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbodyItems">
              <tr><td colspan="6" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- æ–°å¢/ç·¨è¼¯è–ªè³‡é …ç›®å°è©±æ¡† -->
      <dialog id="itemDialog" style="border-radius:12px;border:1px solid #e5e7eb;padding:0;width:90%;max-width:520px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);">
        <div style="padding:24px;border-bottom:1px solid #e5e7eb;background:#f9fafb;">
          <h3 id="itemDialogTitle" style="margin:0;font-size:20px;font-weight:600;color:#111827;">æ–°å¢è–ªè³‡é …ç›®</h3>
          <p style="margin:8px 0 0;font-size:14px;color:#6b7280;">è¨­å®šè–ªè³‡é …ç›®çš„åŸºæœ¬è³‡è¨Š</p>
        </div>
        <form id="itemForm" style="padding:24px;">
          <input type="hidden" id="itemTypeId" />
          
          <input type="hidden" id="itemCode" />
          
          <div style="margin-bottom:20px;">
            <label for="itemName" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">
              é …ç›®åç¨± <span style="color:#dc2626;">*</span>
            </label>
            <input id="itemName" type="text" required maxlength="50" placeholder="ä¾‹å¦‚ï¼šä¼™é£Ÿæ´¥è²¼ã€å…¨å‹¤çé‡‘" 
              style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;" />
            <small style="color:#6b7280;display:block;margin-top:4px;">ğŸ’¡ è¼¸å…¥æ¸…æ¥šæ˜“æ‡‚çš„åç¨±ï¼Œæ–¹ä¾¿å“¡å·¥è­˜åˆ¥</small>
          </div>

          <div style="margin-bottom:20px;">
            <label for="itemCategory" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">
              é¡åˆ¥ <span style="color:#dc2626;">*</span>
            </label>
            <select id="itemCategory" required style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
              <option value="">-- è«‹é¸æ“‡é¡åˆ¥ --</option>
              <option value="allowance">ğŸ’° æ´¥è²¼ï¼ˆå¦‚ï¼šäº¤é€šã€ä¼™é£Ÿã€é›»è©±ï¼‰</option>
              <option value="bonus">ğŸ çé‡‘ï¼ˆå¦‚ï¼šå…¨å‹¤ã€ç¸¾æ•ˆã€å¹´çµ‚ï¼‰</option>
              <option value="deduction">â– æ‰£æ¬¾ï¼ˆå¦‚ï¼šä¿è²»ã€é²åˆ°ï¼‰</option>
            </select>
            <small style="color:#6b7280;display:block;margin-top:4px;">ğŸ“‹ ä¾æ“šé …ç›®æ€§è³ªé¸æ“‡å°æ‡‰é¡åˆ¥</small>
          </div>

          <div style="margin-bottom:20px;background:#f0f9ff;padding:16px;border-radius:8px;border:1px solid #bfdbfe;">
            <label style="display:flex;align-items:flex-start;cursor:pointer;margin-bottom:12px;">
              <input type="checkbox" id="itemIsRegular" style="margin-top:2px;margin-right:10px;width:18px;height:18px;" />
              <div>
                <span style="font-weight:500;color:#1e40af;">ç¶“å¸¸æ€§çµ¦èˆ‡ï¼ˆè¨ˆå…¥æ™‚è–ªåŸºæº–ï¼‰</span>
                <small style="color:#1e40af;display:block;margin-top:4px;line-height:1.5;">
                  âš ï¸ <strong>é‡è¦ï¼š</strong>å‹¾é¸å¾Œæœƒè¨ˆå…¥æ™‚è–ªè¨ˆç®—ï¼Œå½±éŸ¿åŠ ç­è²»é‡‘é¡å’Œæˆæœ¬åˆ†æ<br>
                  âœ“ æ‡‰å‹¾é¸ï¼šå›ºå®šæ´¥è²¼ï¼ˆä¼™é£Ÿã€äº¤é€šï¼‰ã€å…¨å‹¤çé‡‘<br>
                  âœ— ä¸å‹¾é¸ï¼šç¸¾æ•ˆçé‡‘ã€å¹´çµ‚çé‡‘ã€ä¸‰ç¯€çé‡‘
                </small>
              </div>
            </label>
            
            <label style="display:flex;align-items:flex-start;cursor:pointer;padding-top:12px;border-top:1px solid #bfdbfe;">
              <input type="checkbox" id="itemIsPerformance" style="margin-top:2px;margin-right:10px;width:18px;height:18px;" />
              <div>
                <span style="font-weight:500;color:#1e40af;">ç”¨æ–¼ç¸¾æ•ˆçé‡‘èª¿æ•´åŠŸèƒ½</span>
                <small style="color:#1e40af;display:block;margin-top:4px;line-height:1.5;">
                  ğŸ“Š <strong>èªªæ˜ï¼š</strong>å‹¾é¸å¾Œï¼Œæ­¤é …ç›®æœƒåœ¨ã€Œç¸¾æ•ˆçé‡‘èª¿æ•´ã€é é¢é¡¯ç¤ºç‚ºé è¨­å€¼<br>
                  âœ“ å»ºè­°ç”¨é€”ï¼šæ¯æœˆè®Šå‹•çš„ç¸¾æ•ˆçé‡‘<br>
                  ğŸ’¡ åªèƒ½æœ‰ä¸€å€‹é …ç›®å‹¾é¸æ­¤é¸é …
                </small>
              </div>
            </label>
          </div>


          <div style="margin-bottom:20px;">
            <label for="itemDescription" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
            <textarea id="itemDescription" rows="3" maxlength="200" placeholder="ä¾‹å¦‚ï¼šæ¯æœˆå›ºå®šç™¼æ”¾ï¼Œç”¨æ–¼è£œåŠ©å“¡å·¥ä¼™é£Ÿè²»ç”¨" 
              style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;resize:vertical;"></textarea>
            <small style="color:#6b7280;display:block;margin-top:4px;">å¯èªªæ˜ç™¼æ”¾æ¢ä»¶ã€è¨ˆç®—æ–¹å¼ç­‰</small>
          </div>

          <div style="margin-bottom:20px;">
            <label for="itemDisplayOrder" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">é¡¯ç¤ºé †åº</label>
            <input id="itemDisplayOrder" type="number" min="0" value="99" 
              style="width:120px;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;" />
            <small style="color:#6b7280;display:block;margin-top:4px;">æ•¸å­—è¶Šå°è¶Šé å‰é¡¯ç¤ºï¼Œé è¨­ç‚º 99</small>
          </div>

          <div id="itemErrorMsg" style="color:#dc2626;margin-bottom:16px;display:none;padding:12px;background:#fee;border-radius:6px;border:1px solid #fecaca;"></div>
          
          <div style="display:flex;gap:12px;justify-content:flex-end;padding-top:20px;border-top:1px solid #e5e7eb;">
            <button type="button" id="btnCancelItem" class="btn" style="min-width:100px;">å–æ¶ˆ</button>
            <button type="submit" class="btn primary" style="min-width:100px;">ğŸ’¾ å„²å­˜</button>
          </div>
        </form>
      </dialog>

      <!-- å“¡å·¥è–ªè³‡è¨­å®š -->
      <section id="panel-emp" class="panel" role="tabpanel" aria-labelledby="tab-emp">
        <div class="card grid">
          <div class="col">
            <div class="section-toolbar">
              <input id="empSearch" type="search" placeholder="æœå°‹å“¡å·¥â€¦" />
            </div>
            <ul id="empList" class="list" aria-label="å“¡å·¥æ¸…å–®">
              <li class="muted">è¼‰å…¥ä¸­...</li>
            </ul>
          </div>
          <div class="col">
            <div id="empFormContainer" style="display: none;">
              <h3 id="empFormTitle">è«‹é¸æ“‡å“¡å·¥</h3>
            <div class="form">
              <div class="row">
                  <label>åº•è–ª</label>
                  <input id="empBaseSalary" type="number" min="0" step="1" placeholder="ä¾‹å¦‚ 40000" />
                </div>
                <div class="row">
                  <label>å‚™è¨»</label>
                  <textarea id="empSalaryNotes" rows="2" placeholder="è–ªè³‡å‚™è¨»"></textarea>
                </div>
                <hr />
                <div class="row">
                  <label>è–ªè³‡é …ç›®</label>
                  <button id="btnAddEmpItem" class="btn btn-sm" type="button">â• æ–°å¢é …ç›®</button>
                </div>
                <div id="empItemsList">
                  <small class="muted">å°šç„¡è–ªè³‡é …ç›®</small>
                </div>
                <div class="row">
                  <small class="muted">ğŸ’¡ æç¤ºï¼šå‹¾é¸ã€Œç¶“å¸¸æ€§çµ¦èˆ‡ã€å°‡è¨ˆå…¥æ™‚è–ªï¼Œå½±éŸ¿åŠ ç­è²»èˆ‡æˆæœ¬åˆ†æã€‚</small>
              </div>
              <div class="actions">
                  <button id="btnCancelEmp" class="btn" type="button">å–æ¶ˆ</button>
                  <button id="btnSaveEmp" class="btn primary" type="button">ğŸ’¾ å„²å­˜</button>
              </div>
              </div>
            </div>
            <div id="empEmptyState" style="text-align: center; padding: 2rem; color: #999;">
              ğŸ‘ˆ è«‹å¾å·¦å´é¸æ“‡å“¡å·¥
            </div>
          </div>
        </div>
      </section>

      <!-- ç¸¾æ•ˆçé‡‘èª¿æ•´ -->
      <section id="panel-bonus" class="panel" role="tabpanel" aria-labelledby="tab-bonus">
        <div class="card" style="padding: 12px;">
          <div class="section-toolbar" style="margin-bottom: 10px;">
            <label for="yearBonus" style="font-size: 14px;">å¹´åº¦</label>
            <select id="yearBonus" style="width: 100px; padding: 4px 8px; font-size: 14px; border: 1px solid #d1d5db; border-radius: 4px;">
              <!-- é¸é …æœƒç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </select>
            <div class="toolbar-spacer"></div>
            <div id="bonusSummary" class="stats" style="font-size: 13px;">
              <span>èª¿æ•´ï¼š<strong id="bonusAdjustedCount">0</strong> äººæ¬¡</span>
          </div>
            <button id="btnSaveBonus" class="btn primary" style="font-size: 13px; padding: 5px 12px;">ğŸ’¾ å„²å­˜</button>
          </div>
          <div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 6px;">
            <table class="table" aria-label="ç¸¾æ•ˆçé‡‘èª¿æ•´" style="margin: 0; font-size: 13px; width: 100%;">
            <thead>
              <tr>
                  <th rowspan="2" style="position: sticky; left: 0; background: white; z-index: 2; width: 80px; padding: 6px 8px;">å§“å</th>
                  <th colspan="12" style="text-align: center; background: #f0f9ff; padding: 6px 8px;">å„æœˆä»½ç¸¾æ•ˆï¼ˆå…ƒï¼‰</th>
                </tr>
                <tr>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">1æœˆ</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">2æœˆ</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">3æœˆ</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">4æœˆ</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">5æœˆ</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">6æœˆ</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">7æœˆ</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">8æœˆ</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">9æœˆ</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">10æœˆ</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">11æœˆ</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">12æœˆ</th>
              </tr>
            </thead>
              <tbody id="tbodyBonus">
                <tr><td colspan="13" class="muted" style="padding: 2rem; text-align: center;">è¼‰å…¥ä¸­...</td></tr>
            </tbody>
          </table>
          </div>
          <div class="muted" style="margin-top: 8px; font-size: 12px;">
            ğŸ’¡ ç•™ç©ºä½¿ç”¨é è¨­ç¸¾æ•ˆï¼›è¼¸å…¥é‡‘é¡å‰‡ä½¿ç”¨èª¿æ•´å¾Œçš„é‡‘é¡
          </div>
        </div>
      </section>

      <!-- å¹´çµ‚çé‡‘ç®¡ç† -->
      <section id="panel-yearend" class="panel" role="tabpanel" aria-labelledby="tab-yearend">
        <div class="card">
          <div class="section-toolbar">
            <label for="yearInput">å¹´åº¦</label>
            <input id="yearInput" type="number" min="2000" max="2100" step="1" />
            <div class="toolbar-spacer"></div>
            <div id="yearendStats" class="stats">
              <span>ç¸½é¡ï¼šâ€”</span><span>äººæ•¸ï¼šâ€”</span><span>å¹³å‡ï¼šâ€”</span>
            </div>
            <button id="btnSaveYearend" class="btn primary">ğŸ’¾ å„²å­˜</button>
          </div>
          <table class="table" aria-label="å¹´çµ‚çé‡‘">
            <thead>
              <tr>
                <th>å§“å</th>
                <th>åº•è–ª</th>
                <th>å¹´çµ‚é‡‘é¡</th>
                <th>ç™¼æ”¾æœˆä»½</th>
                <th>å‚™è¨»</th>
              </tr>
            </thead>
            <tbody id="tbodyYearend">
              <tr><td colspan="5" class="muted">è¼‰å…¥ä¸­...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- ç³»çµ±è¨­å®š -->
      <section id="panel-settings" class="panel" role="tabpanel" aria-labelledby="tab-settings">
        <div class="card" style="max-width: 1000px; margin: 0 auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
              <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600;">âš™ï¸ è–ªè³‡è¨ˆç®—ç³»çµ±è¨­å®š</h2>
              <p style="margin: 0.5rem 0 0; color: #666; font-size: 0.875rem;">èª¿æ•´è–ªè³‡è¨ˆç®—çš„æ ¸å¿ƒåƒæ•¸</p>
            </div>
            <button id="btnSaveSettings" class="btn primary">ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®š</button>
          </div>

          <!-- èª¤é¤è²»è¨­å®š -->
          <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin: 0 0 1rem; font-size: 1.125rem; font-weight: 600; color: #166534;">ğŸ± èª¤é¤è²»è¨­å®š</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">èª¤é¤è²»å–®åƒ¹ï¼ˆå…ƒ/æ¬¡ï¼‰</label>
                <input id="setting_meal_allowance_per_time" type="number" min="0" step="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">å¹³æ—¥åŠ ç­æ»¿æ¢ä»¶æ™‚ç™¼æ”¾çš„èª¤é¤è²»é‡‘é¡</small>
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æœ€ä½åŠ ç­æ™‚æ•¸ï¼ˆå°æ™‚ï¼‰</label>
                <input id="setting_meal_allowance_min_overtime_hours" type="number" min="0" step="0.5" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">é”åˆ°æ­¤åŠ ç­æ™‚æ•¸æ‰ç™¼æ”¾èª¤é¤è²»</small>
              </div>
            </div>
          </div>

          <!-- äº¤é€šè£œè²¼è¨­å®š -->
          <div style="background: #eff6ff; border: 1px solid #93c5fd; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin: 0 0 1rem; font-size: 1.125rem; font-weight: 600; color: #1e40af;">ğŸš— äº¤é€šè£œè²¼è¨­å®šï¼ˆå€é–“åˆ¶ï¼‰</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æ¯å€‹å€é–“å…¬é‡Œæ•¸</label>
                <input id="setting_transport_km_per_interval" type="number" min="1" step="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">ä¾‹å¦‚ï¼š5 å…¬é‡Œç‚º 1 å€‹å€é–“</small>
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æ¯å€‹å€é–“é‡‘é¡ï¼ˆå…ƒï¼‰</label>
                <input id="setting_transport_amount_per_interval" type="number" min="0" step="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">ä¾‹å¦‚ï¼šæ¯å€é–“ 60 å…ƒ</small>
              </div>
              <div style="display: flex; align-items: center; color: #666;">
                <p style="margin: 0;">ğŸ’¡ ç¯„ä¾‹ï¼š6-10å…¬é‡Œ = 2å€‹å€é–“ = 120å…ƒ</p>
              </div>
            </div>
          </div>

          <!-- è«‹å‡æ‰£æ¬¾è¨­å®š -->
          <div style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin: 0 0 1rem; font-size: 1.125rem; font-weight: 600; color: #991b1b;">ğŸ“… è«‹å‡æ‰£æ¬¾è¨­å®š</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ç—…å‡æ‰£æ¬¾æ¯”ä¾‹</label>
                <input id="setting_sick_leave_deduction_rate" type="number" min="0" max="1" step="0.1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">1.0 = å…¨é¡æ‰£é™¤ï¼Œ0.5 = æ‰£é™¤50%</small>
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">äº‹å‡æ‰£æ¬¾æ¯”ä¾‹</label>
                <input id="setting_personal_leave_deduction_rate" type="number" min="0" max="1" step="0.1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">é€šå¸¸ç‚º 1.0ï¼ˆå…¨é¡æ‰£é™¤ï¼‰</small>
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æ—¥è–ªè¨ˆç®—é™¤æ•¸</label>
                <input id="setting_leave_daily_salary_divisor" type="number" min="1" step="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">æ—¥è–ª = åº•è–ª Ã· æ­¤æ•¸å­—ï¼ˆé€šå¸¸ç‚º30ï¼‰</small>
              </div>
            </div>
          </div>

          <!-- æ™‚è–ªè¨ˆç®—è¨­å®š -->
          <div style="background: #f5f3ff; border: 1px solid #c4b5fd; border-radius: 8px; padding: 1.5rem;">
            <h3 style="margin: 0 0 1rem; font-size: 1.125rem; font-weight: 600; color: #5b21b6;">ğŸ§® æ™‚è–ªè¨ˆç®—è¨­å®š</h3>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æ™‚è–ªè¨ˆç®—é™¤æ•¸</label>
                <input id="setting_hourly_rate_divisor" type="number" min="1" step="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">ä¾å‹åŸºæ³•ç‚º 240 å°æ™‚/æœˆ</small>
              </div>
              <div style="display: flex; align-items: center; color: #666;">
                <p style="margin: 0;">ğŸ“Œ æ™‚è–ª = (åº•è–ª + ç¶“å¸¸æ€§çµ¦èˆ‡) Ã· é™¤æ•¸ï¼Œç”¨æ–¼è¨ˆç®—åŠ ç­è²»åŸºæº–</p>
              </div>
            </div>
          </div>

          <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
            <p style="margin: 0; color: #92400e; font-size: 0.875rem;">
              âš ï¸ <strong>é‡è¦æç¤ºï¼š</strong>ä¿®æ”¹é€™äº›è¨­å®šæœƒå½±éŸ¿æ‰€æœ‰æœªä¾†çš„è–ªè³‡è¨ˆç®—ã€‚å»ºè­°åœ¨æœˆåˆæˆ–æ¸¬è©¦ç’°å¢ƒä¸­èª¿æ•´ï¼Œç¢ºèªç„¡èª¤å¾Œå†å¥—ç”¨ã€‚
            </p>
          </div>
        </div>
      </section>

      <!-- æ‰“å¡è¨˜éŒ„ä¸Šå‚³ -->
      <section id="panel-punch" class="panel" role="tabpanel" aria-labelledby="tab-punch">
        <!-- å·¦å³åˆ†æ å¸ƒå±€ -->
        <div style="display: grid; grid-template-columns: 450px 1fr; gap: 16px;">
          <!-- å·¦å´ï¼šä¸Šå‚³è¡¨å–®å’Œæª”æ¡ˆåˆ—è¡¨ -->
          <div>
            <div class="card" style="padding: 1.5rem;">
              <div style="margin-bottom: 1.5rem;">
                <h2 style="margin: 0 0 0.5rem; font-size: 1.25rem; font-weight: 600;">ğŸ“ æ‰“å¡è¨˜éŒ„ä¸Šå‚³</h2>
                <p style="margin: 0; color: #666; font-size: 0.875rem;">ä¸Šå‚³æ¯æœˆæ‰“å¡è¨˜éŒ„</p>
              </div>

              <!-- ä¸Šå‚³å€åŸŸ -->
              <div style="background: #f0f9ff; border: 2px dashed #3b82f6; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center;">
                <input type="file" id="punchFileInput" style="display: none;" accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png,.zip" />
                <button id="btnSelectFile" class="btn primary" style="font-size: 0.875rem; padding: 0.5rem 1.5rem;">
                  ğŸ“ é¸æ“‡æª”æ¡ˆ
                </button>
                <p style="margin: 0.75rem 0 0; color: #666; font-size: 0.75rem;">
                  æ”¯æ´ï¼šPDFã€Excelã€åœ–ç‰‡ã€ZIP<br/>å–®æª”æœ€å¤§ 10MB
                </p>
              </div>

              <!-- ä¸Šå‚³è¡¨å–® -->
              <div id="uploadForm" style="display: none; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                <div style="margin-bottom: 0.75rem;">
                  <strong style="font-size: 0.875rem;">å·²é¸æ“‡ï¼š</strong> <span id="selectedFileName" style="font-size: 0.875rem;"></span>
                </div>
                <div style="margin-bottom: 0.75rem;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">æ‰€å±¬æœˆä»½ <span style="color: red;">*</span></label>
                  <input type="month" id="punchMonth" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;" />
                </div>
                <div style="margin-bottom: 1rem;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">å‚™è¨»</label>
                  <input type="text" id="punchNotes" placeholder="ä¾‹å¦‚ï¼šè£œå‚³10æœˆè³‡æ–™" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;" />
                </div>
                <div style="display: flex; gap: 0.75rem;">
                  <button id="btnUploadFile" class="btn primary" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                    â¬†ï¸ ä¸Šå‚³
                  </button>
                  <button id="btnCancelUpload" class="btn" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                    å–æ¶ˆ
                  </button>
                </div>
                <div id="uploadProgress" style="display: none; margin-top: 0.75rem;">
                  <div style="background: #e5e7eb; border-radius: 4px; height: 6px; overflow: hidden;">
                    <div id="uploadProgressBar" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s;"></div>
                  </div>
                  <p style="margin: 0.5rem 0 0; color: #666; font-size: 0.75rem;" id="uploadStatus">ä¸Šå‚³ä¸­...</p>
                </div>
              </div>

              <!-- å“¡å·¥é¸æ“‡å™¨ï¼ˆç®¡ç†å“¡å°ˆç”¨ï¼‰ -->
              <div id="punchAdminTools" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem; color: #1e40af;">
                  ğŸ‘¤ é¸æ“‡å“¡å·¥
                </label>
                <select id="punchUserSelect" style="width: 100%; padding: 0.5rem; border: 1px solid #93c5fd; border-radius: 6px; font-size: 0.875rem; background: white;">
                  <option value="">è«‹é¸æ“‡å“¡å·¥...</option>
                </select>
              </div>

              <!-- å·²ä¸Šå‚³æª”æ¡ˆåˆ—è¡¨ -->
              <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                  <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">ğŸ“‹ å·²ä¸Šå‚³è¨˜éŒ„</h3>
                  <button id="btnRefreshFiles" class="btn" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;">
                    ğŸ”„ åˆ·æ–°
                  </button>
                </div>
                <div style="max-height: 500px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <table class="table" aria-label="æ‰“å¡è¨˜éŒ„åˆ—è¡¨" style="margin: 0; font-size: 0.875rem;">
                    <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                      <tr>
                        <th style="padding: 0.5rem;">æœˆä»½</th>
                        <th style="padding: 0.5rem;">æª”æ¡ˆ</th>
                        <th style="padding: 0.5rem; width: 100px;">æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody id="punchFilesList">
                      <tr><td colspan="3" class="muted" style="padding: 2rem; text-align: center;">åˆ‡æ›åˆ°æ­¤åˆ†é å¾Œè¼‰å…¥...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- å³å´ï¼šé è¦½å€åŸŸ -->
          <div>
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; height: 100%;">
              <div id="punchPreviewArea" style="min-height: 85vh; display: flex; align-items: center; justify-content: center; background: #f9fafb;">
                <div style="text-align: center; max-width: 400px; padding: 40px 20px; color: #6b7280;">
                  <div style="font-size: 64px; margin-bottom: 16px;">ğŸ“„</div>
                  <p style="font-size: 18px; font-weight: 600; color: #374151; margin-bottom: 8px;">é»æ“Šå·¦å´æª”æ¡ˆæŸ¥çœ‹é è¦½</p>
                  <p style="font-size: 14px;">æ”¯æ´ç·šä¸Šé è¦½ PDFã€åœ–ç‰‡ç­‰æ ¼å¼</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const infoBar = document.getElementById('infoBar');
        const finalizeMsg = document.getElementById('finalizeMsg');
        const tabs = Array.from(document.querySelectorAll('.payroll-tabs .tab'));
        const panels = {
          calc: document.getElementById('panel-calc'),
          items: document.getElementById('panel-items'),
          emp: document.getElementById('panel-emp'),
          bonus: document.getElementById('panel-bonus'),
          yearend: document.getElementById('panel-yearend'),
          settings: document.getElementById('panel-settings'),
          punch: document.getElementById('panel-punch'),
        };

        // è–ªè³‡é …ç›®è¨­å®šç›¸é—œ DOM
        const tbodyItems = document.getElementById('tbodyItems');
        const itemSearch = document.getElementById('itemSearch');
        const btnAddItem = document.getElementById('btnAddItem');
        const itemDialog = document.getElementById('itemDialog');
        const itemDialogTitle = document.getElementById('itemDialogTitle');
        const itemForm = document.getElementById('itemForm');
        const btnCancelItem = document.getElementById('btnCancelItem');
        const itemErrorMsg = document.getElementById('itemErrorMsg');

        // è–ªè³‡é …ç›®ç‹€æ…‹
        const itemsState = { all: [], filtered: [] };

        // å“¡å·¥è–ªè³‡è¨­å®šç›¸é—œ DOM
        const empList = document.getElementById('empList');
        const empSearch = document.getElementById('empSearch');
        const empFormContainer = document.getElementById('empFormContainer');
        const empEmptyState = document.getElementById('empEmptyState');
        const empFormTitle = document.getElementById('empFormTitle');
        const empBaseSalary = document.getElementById('empBaseSalary');
        const empSalaryNotes = document.getElementById('empSalaryNotes');
        const empItemsList = document.getElementById('empItemsList');
        const btnAddEmpItem = document.getElementById('btnAddEmpItem');
        const btnCancelEmp = document.getElementById('btnCancelEmp');
        const btnSaveEmp = document.getElementById('btnSaveEmp');

        // å“¡å·¥è–ªè³‡ç‹€æ…‹
        const empState = { 
          allUsers: [], 
          filteredUsers: [],
          selectedUserId: null,
          currentUserData: null,
          userSalaryItems: [] 
        };

        // è¨ˆç®—ç›¸é—œ DOM
        const tbodyCalc = document.getElementById('tbodyCalc');
        const empSearchCalc = document.getElementById('empSearchCalc');
        const statusCalc = document.getElementById('statusCalc');
        const monthInput = document.getElementById('month');
        const btnFinalize = document.getElementById('btn-finalize');

        // è¨ˆç®—ç‹€æ…‹ï¼ˆç§»é™¤åˆ†é ï¼‰
        const calcState = { all: [], filtered: [] };

        function setTabsEnabled(enabled){
          tabs.forEach(b=>{ b.disabled = !enabled; });
          // åªç¦ç”¨ç‰¹å®šçš„å·¥å…·æ æ§åˆ¶å…ƒç´ ï¼Œä¸å½±å“ç»©æ•ˆå¥–é‡‘ç­‰åŠŸèƒ½çš„è¾“å…¥æ¡†
          document.querySelectorAll('.payroll-toolbar .btn, #empSearchCalc, #statusCalc, #month, #empSearch, #itemSearch').forEach(el=>{ el.disabled = !enabled; });
          // æ³¨æ„ï¼šä¸ç¦ç”¨ .bonus-input å’Œ #yearBonus
        }

        // æ‰“å¡è¨˜éŒ„æ˜¯å¦å·²åˆå§‹åŒ–ï¼ˆé¿å…é‡è¤‡åˆå§‹åŒ–ï¼‰
        let punchRecordsInitialized = false;

        // TABåˆ‡æ› - æœ€çµ‚æ–¹æ¡ˆï¼ˆä½¿ç”¨inline styleï¼Œå„ªå…ˆç´šæœ€é«˜ï¼‰
        function switchTab(targetKey) {
          console.log('[TABåˆ‡æ›]', targetKey);
          
          // æ›´æ–°TABæŒ‰éˆ•ç‹€æ…‹
          tabs.forEach(btn => {
            const isActive = btn.getAttribute('data-tab') === targetKey;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-selected', isActive);
          });
          
          // ç›´æ¥ä½¿ç”¨style.displayåˆ‡æ›é¢æ¿ï¼ˆå„ªå…ˆç´šæœ€é«˜ï¼Œä¸æœƒè¢«è¦†è“‹ï¼‰
          panels.calc.style.display = (targetKey === 'calc') ? 'block' : 'none';
          panels.items.style.display = (targetKey === 'items') ? 'block' : 'none';
          panels.emp.style.display = (targetKey === 'emp') ? 'block' : 'none';
          panels.bonus.style.display = (targetKey === 'bonus') ? 'block' : 'none';
          panels.yearend.style.display = (targetKey === 'yearend') ? 'block' : 'none';
          panels.settings.style.display = (targetKey === 'settings') ? 'block' : 'none';
          panels.punch.style.display = (targetKey === 'punch') ? 'block' : 'none';
          
          // ç•¶åˆ‡æ›åˆ°æ‰“å¡è¨˜éŒ„TABæ™‚ï¼Œé¦–æ¬¡é€²è¡Œåˆå§‹åŒ–
          if (targetKey === 'punch' && !punchRecordsInitialized) {
            console.log('[æ‰“å¡è¨˜éŒ„] é¦–æ¬¡åˆ‡æ›åˆ°æ­¤TABï¼Œé€²è¡Œåˆå§‹åŒ–');
            punchRecordsInitialized = true;
            
            if (isAdminMode) {
              // ç®¡ç†å“¡ï¼šåˆå§‹åŒ–å“¡å·¥é¸æ“‡å™¨
              initAdminPunchSelector();
            } else if (currentUserId) {
              // æ™®é€šå“¡å·¥ï¼šç›´æ¥è¼‰å…¥è¨˜éŒ„
              loadPunchRecords(currentUserId);
            }
          }
        }
        
        // ä½¿ç”¨äº‹ä»¶å§”è¨—ç¶å®šTABé»æ“Š
        document.querySelector('.payroll-tabs').addEventListener('click', (e) => {
          const tab = e.target.closest('.tab');
          if (tab && !tab.disabled) {
            switchTab(tab.getAttribute('data-tab'));
          }
        });
        
        // åˆå§‹åŒ–ï¼šé»˜èªé¡¯ç¤ºç¬¬ä¸€å€‹TAB
        switchTab('calc');

        async function ensureAdmin(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { 
              console.log('[æ¬Šé™æª¢æŸ¥] æœªç™»å…¥ï¼Œé‡å®šå‘åˆ°ç™»å…¥é ');
              location.assign('/login?redirect=/internal/payroll'); 
              return { isAdmin: false, userData: null }; 
            }
            const json = await res.json();
            console.log('[æ¬Šé™æª¢æŸ¥] API å›æ‡‰:', json);
            
            if (!json || !json.ok || !json.data) {
              console.error('[æ¬Šé™æª¢æŸ¥] API å›æ‡‰å¤±æ•—:', json);
              infoBar.textContent = 'API å›æ‡‰å¤±æ•—ï¼š' + (json?.message || 'æœªçŸ¥éŒ¯èª¤');
              infoBar.style.display = 'block';
              setTabsEnabled(false);
              return { isAdmin: false, userData: null };
            }
            
            const userData = json.data;
            const isAdmin = userData.isAdmin === true;
            
            console.log('[æ¬Šé™æª¢æŸ¥] ç”¨æˆ¶è³‡æ–™:', {
              username: userData.username,
              name: userData.name,
              isAdmin: isAdmin
            });
            
            // æ ¹æ“šæ¬Šé™æ§åˆ¶TABé¡¯ç¤º
            tabs.forEach(tab => {
              const adminOnly = tab.getAttribute('data-admin-only') === 'true';
              if (adminOnly && !isAdmin) {
                tab.style.display = 'none'; // éš±è—ç®¡ç†å“¡å°ˆç”¨TAB
              } else {
                tab.style.display = ''; // é¡¯ç¤ºTAB
              }
            });
            
            if (isAdmin) {
              console.log('[æ¬Šé™æª¢æŸ¥] âœ… ç®¡ç†å“¡é©—è­‰é€šé');
            setTabsEnabled(true);
              return { isAdmin: true, userData };
            } else {
              console.log('[æ¬Šé™æª¢æŸ¥] ğŸ‘¤ æ™®é€šå“¡å·¥ï¼Œåªèƒ½å­˜å–æ‰“å¡è¨˜éŒ„ä¸Šå‚³');
              // æ™®é€šå“¡å·¥ï¼šåˆ‡æ›åˆ°æ‰“å¡è¨˜éŒ„TAB
              switchTab('punch');
              setTabsEnabled(true);
              return { isAdmin: false, userData };
            }
          } catch (err) {
            console.error('[æ¬Šé™æª¢æŸ¥] ç•°å¸¸:', err);
            infoBar.textContent = 'è¼‰å…¥å¤±æ•—ï¼š' + err.message;
            infoBar.style.display = 'block';
            setTabsEnabled(false);
            return { isAdmin: false, userData: null };
          }
        }
        function setFinalizeUIDisabled(disabled){
          btnFinalize.disabled = disabled;
        }

        function setFinalizeMsg(type, text){
          if (!text) { finalizeMsg.style.display='none'; return; }
          finalizeMsg.textContent = text;
          finalizeMsg.style.display = 'block';
        }

        async function checkFinalized(){
          setFinalizeMsg('', '');
          try {
            const m = monthInput.value;
            const res = await fetch(`${apiBase}/admin/payroll?month=${encodeURIComponent(m)}`, { credentials:'include' });
            if (res.status === 200){
              const json = await res.json();
              const runId = json?.data?.runId;
              setFinalizeMsg('info', `æœ¬æœˆå·²ç”¢è£½ï¼ˆRun: ${runId}ï¼‰`);
              setFinalizeUIDisabled(true);
              return true;
            }
            if (res.status === 404){
              setFinalizeMsg('', '');
              setFinalizeUIDisabled(false);
              return false;
            }
            // å…¶ä»–éŒ¯èª¤
            setFinalizeMsg('error', 'æŸ¥è©¢æœˆçµç‹€æ…‹å¤±æ•—');
            setFinalizeUIDisabled(false);
            return false;
          } catch(_){
            setFinalizeMsg('error', 'æŸ¥è©¢æœˆçµç‹€æ…‹å¤±æ•—');
            setFinalizeUIDisabled(false);
            return false;
          }
        }

        function genIdk(){
          return 'idk_' + Date.now() + '_' + Math.random().toString(36).slice(2,10);
        }

        async function finalizeMonth(){
          setFinalizeMsg('', '');
          const m = monthInput.value;
          btnFinalize.disabled = true;
          try {
            const res = await fetch(`${apiBase}/admin/payroll/finalize`, {
              method:'POST', credentials:'include', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ month: m, idempotency_key: genIdk() })
            });
            const json = await res.json().catch(()=>({}));
            if (res.status === 201 && json?.ok){
              setFinalizeMsg('success', `å·²ç”¢è£½å®Œæˆï¼ˆRun: ${json.data?.runId}ï¼‰`);
              btnFinalize.disabled = true;
              return;
            }
            if (res.status === 409){
              setFinalizeMsg('info', `è©²æœˆä»½å·²ç”¢è£½ï¼ˆRun: ${json?.data?.runId || ''}ï¼‰`);
              btnFinalize.disabled = true;
              return;
            }
            if (res.status === 401){ location.assign('/login?redirect=/internal/payroll'); return; }
            if (res.status === 403){ setTabsEnabled(false); setFinalizeMsg('error', 'æ²’æœ‰æ¬Šé™'); return; }
            setFinalizeMsg('error', json?.message || 'ç”¢è£½å¤±æ•—');
            btnFinalize.disabled = false;
          } catch (_){
            setFinalizeMsg('error', 'ç”¢è£½å¤±æ•—');
            btnFinalize.disabled = false;
          }
        }


        function centsToTwd(n){
          const v = Number(n || 0) / 100;
          return 'NT$ ' + v.toLocaleString();
        }

        // ç”Ÿæˆè¯¦ç»†æ˜ç»†HTML
        function generateDetailRow(r, rowId) {
          const hourlyRate = centsToTwd(r.hourlyRateCents || 0).replace('NT$ ', '');
          const hourlyRateNum = (r.hourlyRateCents || 0) / 100;
          
          // æ™‚è–ªè¨ˆç®—åŸºç¤
          let hourlyRateBaseHtml = `<div style="margin-bottom: 10px;"><strong>æ™‚è–ªè¨ˆç®—åŸºç¤ï¼š</strong></div>`;
          hourlyRateBaseHtml += `<div style="margin-left: 10px;">åº•è–ª: ${centsToTwd(r.baseSalaryCents)}</div>`;
          if (r.hourlyRateBaseItems && r.hourlyRateBaseItems.length > 0) {
            r.hourlyRateBaseItems.forEach(item => {
              hourlyRateBaseHtml += `<div style="margin-left: 10px;">${item.name}: ${centsToTwd(item.amountCents)}</div>`;
            });
          }
          const totalBase = r.baseSalaryCents + r.regularAllowanceCents;
          hourlyRateBaseHtml += `<div style="margin-left: 10px; margin-top: 5px; font-weight: 600;">åˆè¨ˆ: ${centsToTwd(totalBase)} Ã· 240 = ${hourlyRate}</div>`;
          
          // åŠ ç­è²»æ˜ç´°
          let overtimeHtml = '<div style="margin-bottom: 10px; margin-top: 15px;"><strong>åŠ ç­è²»æ˜ç´°ï¼š</strong></div>';
          if (r.dailyOvertime && r.dailyOvertime.length > 0) {
            overtimeHtml += '<div style="margin-left: 10px;">';
            r.dailyOvertime.forEach(day => {
              const dayDate = day.date;
              const dayOfWeek = day.dayOfWeek || '';
              const holidayName = day.holidayName || '';
              const dateDisplay = holidayName ? `${dayDate} (å‘¨${dayOfWeek}ï¼Œ${holidayName})` : `${dayDate} (å‘¨${dayOfWeek})`;
              
              if (day.items && day.items.length > 0) {
                overtimeHtml += `<div style="margin-bottom: 8px;"><strong>${dateDisplay}</strong></div>`;
                day.items.forEach(item => {
                  // æ ¹æ®å·¥ä½œç±»å‹IDè·å–è§„åˆ™è¯´æ˜
                  const ruleMap = {
                    2: 'å‹åŸºæ³•ç¬¬24æ¢ï¼šå¹³æ—¥å»¶é•·å·¥æ™‚ç¬¬1-2å°æ™‚ï¼ŒåŠ çµ¦1/3ä»¥ä¸Š',
                    3: 'å‹åŸºæ³•ç¬¬24æ¢ï¼šå¹³æ—¥å»¶é•·å·¥æ™‚ç¬¬3-4å°æ™‚ï¼ŒåŠ çµ¦2/3ä»¥ä¸Š',
                    4: 'å‹åŸºæ³•ç¬¬24æ¢ï¼šä¼‘æ¯æ—¥å‰2å°æ™‚ï¼ŒåŠ çµ¦1/3ä»¥ä¸Š',
                    5: 'å‹åŸºæ³•ç¬¬24æ¢ï¼šä¼‘æ¯æ—¥ç¬¬3-8å°æ™‚ï¼ŒåŠ çµ¦2/3ä»¥ä¸Š',
                    6: 'å‹åŸºæ³•ç¬¬24æ¢ï¼šä¼‘æ¯æ—¥ç¬¬9-12å°æ™‚ï¼ŒåŠ çµ¦5/3ä»¥ä¸Š',
                    7: 'å‹åŸºæ³•ç¬¬39æ¢ï¼šåœ‹å®šå‡æ—¥å‡ºå‹¤8hå…§ï¼ŒåŠ å€ç™¼çµ¦ï¼ˆ2å€ï¼‰ï¼Œå¦çµ¦è£œä¼‘8h',
                    8: 'å‹åŸºæ³•ç¬¬24æ¢ï¼šåœ‹å®šå‡æ—¥è¶…é8héƒ¨åˆ†ï¼ŒæŒ‰å¹³æ—¥å»¶é•·å·¥æ™‚è¨ˆç®—ï¼ˆ1.34å€ï¼‰',
                    9: 'å‹åŸºæ³•ç¬¬24æ¢ï¼šåœ‹å®šå‡æ—¥è¶…é10héƒ¨åˆ†ï¼ŒæŒ‰å¹³æ—¥å»¶é•·å·¥æ™‚è¨ˆç®—ï¼ˆ1.67å€ï¼‰',
                    10: 'å‹åŸºæ³•ç¬¬40æ¢ï¼šä¾‹å‡æ—¥å› å¤©ç½äº‹è®Šå‡ºå‹¤ï¼Œå‰8håŠ å€ç™¼çµ¦ï¼ˆ2å€ï¼‰ï¼Œå¦çµ¦è£œä¼‘1æ—¥+8h',
                    11: 'å‹åŸºæ³•ç¬¬40æ¢ï¼šä¾‹å‡æ—¥è¶…é8héƒ¨åˆ†ï¼Œæ¯å°æ™‚åŠ å€ç™¼çµ¦ï¼ˆ2å€ï¼‰'
                  };
                  
                  const rule = ruleMap[item.workTypeId] || '';
                  const borderColor = item.workTypeId >= 10 ? '#dc2626' : (item.workTypeId >= 7 ? '#f59e0b' : '#3b82f6');
                  
                  overtimeHtml += `<div style="margin-left: 20px; margin-bottom: 8px; padding: 8px; background: #f9fafb; border-left: 3px solid ${borderColor}; font-size: 0.9em;">`;
                  
                  // ç¬¬ä¸€è¡Œï¼šå·¥ä½œç±»å‹
                  overtimeHtml += `<div style="display: flex; justify-content: space-between; align-items: center;">`;
                  overtimeHtml += `<strong style="color: #1f2937;">${item.workType}</strong>`;
                  overtimeHtml += `<span style="background: ${borderColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.85em; font-weight: 600;">${item.multiplier}å€</span>`;
                  overtimeHtml += `</div>`;
                  
                  // ç¬¬äºŒè¡Œï¼šæ³•è§„ä¾æ®
                  if (rule) {
                    overtimeHtml += `<div style="color: #6b7280; font-size: 0.85em; margin-top: 3px; padding: 3px 0; border-bottom: 1px dashed #d1d5db;">`;
                    overtimeHtml += `ğŸ“– ${rule}`;
                    overtimeHtml += `</div>`;
                  }
                  
                  // ç¬¬ä¸‰è¡Œï¼šè¯¦ç»†è®¡ç®—
                  overtimeHtml += `<div style="color: #374151; margin-top: 4px;">`;
                  overtimeHtml += `ğŸ’¼ å¯¦éš›å·¥ä½œ: <strong>${item.originalHours}h</strong>`;
                  
                  // æ˜¾ç¤ºè¡¥ä¼‘ç´¯ç§¯ï¼ˆå¦‚æœå’Œå·¥ä½œæ—¶é—´ä¸åŒï¼‰
                  if (item.isFixedType && item.compHoursGenerated && item.compHoursGenerated !== item.originalHours) {
                    overtimeHtml += ` <span style="color: #059669; font-weight: 600;">ï¼ˆç´¯ç©è£œä¼‘: ${item.compHoursGenerated}hï¼‰</span>`;
                  } else if (item.compHoursGenerated && item.compHoursGenerated === item.originalHours) {
                    overtimeHtml += ` <span style="color: #059669;">ï¼ˆç´¯ç©è£œä¼‘: ${item.compHoursGenerated}hï¼‰</span>`;
                  }
                  overtimeHtml += `</div>`;
                  
                  // ç¬¬å››è¡Œï¼šåŠ æƒè®¡ç®—
                  overtimeHtml += `<div style="color: #374151; margin-top: 2px;">`;
                  overtimeHtml += `ğŸ’° åŠ ç­è²»: ${item.originalHours}h Ã— ${item.multiplier}å€ = <strong style="color: #059669;">${item.originalWeighted.toFixed(2)}h</strong> åŠ æ¬Šå·¥æ™‚`;
                  overtimeHtml += `</div>`;
                  
                  // ç¬¬äº”è¡Œï¼šè¡¥ä¼‘æ‰£é™¤ï¼ˆå¦‚æœæœ‰ï¼‰
                  if (item.compDeducted > 0) {
                    overtimeHtml += `<div style="color: #dc2626; margin-top: 3px; padding-top: 3px; border-top: 1px dashed #fecaca;">`;
                    overtimeHtml += `âš ï¸ æ‰£é™¤è£œä¼‘: ${item.compDeducted}h â†’ å‰©é¤˜ ${item.remainingHours}h Ã— ${item.multiplier}å€ = <strong>${item.effectiveWeighted.toFixed(2)}h</strong> æœ‰æ•ˆåŠ æ¬Š`;
                    overtimeHtml += `</div>`;
                  }
                  
                  overtimeHtml += `</div>`;
                });
              }
            });
            overtimeHtml += '</div>';
            
            const effectiveHours = r.effectiveWeightedHours || 0;
            const expiredComp = r.expiredCompPayCents || 0;
            overtimeHtml += `<div style="margin-left: 10px; margin-top: 5px; font-weight: 600;">`;
            overtimeHtml += `æœ‰æ•ˆåŠ æ¬Šå·¥æ™‚: ${effectiveHours.toFixed(2)}h Ã— ${hourlyRate} = ${centsToTwd(Math.round(effectiveHours * hourlyRateNum * 100))}`;
            if (expiredComp > 0) {
              overtimeHtml += `<br>åˆ°æœŸè£œä¼‘è½‰åŠ ç­è²»: ${centsToTwd(expiredComp)}`;
            }
            if (r.totalCompHoursUsed > 0) {
              overtimeHtml += `<br><span style="color:#dc2626;">æœ¬æœˆä½¿ç”¨è£œä¼‘: ${r.totalCompHoursUsed}h</span>`;
            }
            overtimeHtml += `</div>`;
          } else {
            overtimeHtml += '<div style="margin-left: 10px; color: #9ca3af;">æœ¬æœˆç„¡åŠ ç­è¨˜éŒ„</div>';
          }
          
          // äº¤é€šè£œè²¼æ˜ç´°ï¼ˆæŒ‰å–®æ¬¡è¨ˆç®—å€é–“ï¼‰
          let transportHtml = '<div style="margin-bottom: 10px; margin-top: 15px;"><strong>äº¤é€šè£œè²¼æ˜ç´°ï¼š</strong></div>';
          if (r.tripDetails && r.tripDetails.length > 0) {
            transportHtml += '<div style="margin-left: 10px;">';
            r.tripDetails.forEach(trip => {
              transportHtml += `<div>${trip.date}: ${trip.destination}, ${trip.distance}km â†’ ${trip.intervals}å€é–“ Ã— NT$ ${trip.amount / trip.intervals} = NT$ ${trip.amount} - ${trip.purpose || ''}</div>`;
            });
            transportHtml += '</div>';
            transportHtml += `<div style="margin-left: 10px; margin-top: 5px; font-weight: 600;">`;
            transportHtml += `ç¸½è¨ˆ: ${r.totalKm || 0}kmï¼Œ${r.transportIntervals || 0}å€‹å€é–“ = ${centsToTwd(r.transportCents || 0)}`;
            transportHtml += `</div>`;
          } else {
            transportHtml += '<div style="margin-left: 10px; color: #9ca3af;">æœ¬æœˆç„¡å¤–å‡ºè¨˜éŒ„</div>';
          }
          
          // è«‹å‡æ‰£æ¬¾æ˜ç´°ï¼ˆåŒ…å«ç—…å‡ã€äº‹å‡ã€ç”Ÿç†å‡ï¼‰- é¡¯ç¤ºè©³ç´°æ—¥æœŸ
          let leaveHtml = '<div style="margin-bottom: 10px; margin-top: 15px;"><strong>è«‹å‡æ‰£æ¬¾æ˜ç´°ï¼š</strong></div>';
          const dailyRate = r.dailySalaryCents || 0; // ä½¿ç”¨å¾Œç«¯è¨ˆç®—çš„æ—¥è–ª
          
          if (r.leaveDetails && r.leaveDetails.length > 0) {
            const leaveTypeMap = { 'sick': 'ç—…å‡', 'personal': 'äº‹å‡', 'menstrual': 'ç”Ÿç†å‡' };
            const leavesByType = { 'sick': [], 'personal': [], 'menstrual': [] };
            
            // æŒ‰é¡å‹åˆ†çµ„
            r.leaveDetails.forEach(leave => {
              if (leavesByType[leave.leaveType]) leavesByType[leave.leaveType].push(leave);
            });
            
            leaveHtml += '<div style="margin-left: 10px;">';
            
            // é¡¯ç¤ºç—…å‡
            if (leavesByType.sick.length > 0) {
              leaveHtml += `<div style="margin-bottom: 8px;"><strong>ç—…å‡ (æ‰£50%)ï¼š</strong></div>`;
              leavesByType.sick.forEach(leave => {
                const dateRange = leave.startDate === leave.endDate ? leave.startDate : `${leave.startDate} ~ ${leave.endDate}`;
                leaveHtml += `<div style="margin-left: 20px;">â€¢ ${dateRange}: ${leave.amount}${leave.unit === 'day' ? 'å¤©' : 'å°æ™‚'}${leave.reason ? ` (${leave.reason})` : ''}</div>`;
              });
              leaveHtml += `<div style="margin-left: 20px; margin-top: 4px; color: #666;">å°è¨ˆ: ${r.sickDays}å¤© Ã— ${centsToTwd(dailyRate)} Ã— 50% = ${centsToTwd(Math.round(r.sickDays * dailyRate * 0.5))}</div>`;
            }
            
            // é¡¯ç¤ºäº‹å‡
            if (leavesByType.personal.length > 0) {
              leaveHtml += `<div style="margin-bottom: 8px; margin-top: 8px;"><strong>äº‹å‡ (æ‰£100%)ï¼š</strong></div>`;
              leavesByType.personal.forEach(leave => {
                const dateRange = leave.startDate === leave.endDate ? leave.startDate : `${leave.startDate} ~ ${leave.endDate}`;
                leaveHtml += `<div style="margin-left: 20px;">â€¢ ${dateRange}: ${leave.amount}${leave.unit === 'day' ? 'å¤©' : 'å°æ™‚'}${leave.reason ? ` (${leave.reason})` : ''}</div>`;
              });
              leaveHtml += `<div style="margin-left: 20px; margin-top: 4px; color: #666;">å°è¨ˆ: ${r.personalDays}å¤© Ã— ${centsToTwd(dailyRate)} Ã— 100% = ${centsToTwd(Math.round(r.personalDays * dailyRate))}</div>`;
            }
            
            // é¡¯ç¤ºç”Ÿç†å‡
            if (leavesByType.menstrual.length > 0) {
              leaveHtml += `<div style="margin-bottom: 8px; margin-top: 8px;"><strong>ç”Ÿç†å‡ (æ‰£50%)ï¼š</strong></div>`;
              leavesByType.menstrual.forEach(leave => {
                const dateRange = leave.startDate === leave.endDate ? leave.startDate : `${leave.startDate} ~ ${leave.endDate}`;
                leaveHtml += `<div style="margin-left: 20px;">â€¢ ${dateRange}: ${leave.amount}${leave.unit === 'day' ? 'å¤©' : 'å°æ™‚'}</div>`;
              });
              leaveHtml += `<div style="margin-left: 20px; margin-top: 4px; color: #666;">å°è¨ˆ: ${r.menstrualDays}å¤© Ã— ${centsToTwd(dailyRate)} Ã— 50% = ${centsToTwd(Math.round(r.menstrualDays * dailyRate * 0.5))}</div>`;
              if (r.menstrualFreeDays > 0) {
                leaveHtml += `<div style="margin-left: 20px;"><small style="color:#16a34a;">ï¼ˆå‰${r.menstrualFreeDays}å¤©ç¨ç«‹è¨ˆç®—ï¼Œä¸ä½µå…¥ç—…å‡é¡åº¦ï¼‰</small></div>`;
              }
              if (r.menstrualMergedDays > 0) {
                leaveHtml += `<div style="margin-left: 20px;"><small style="color:#f59e0b;">ï¼ˆ${r.menstrualMergedDays}å¤©ä½µå…¥ç—…å‡é¡åº¦ï¼‰</small></div>`;
              }
              leaveHtml += `<div style="margin-left: 20px;"><small style="color:#16a34a;">âœ“ ç”Ÿç†å‡ä¸å½±éŸ¿å…¨å‹¤</small></div>`;
            }
            
            leaveHtml += '</div>';
            leaveHtml += `<div style="margin-left: 10px; margin-top: 8px; font-weight: 600;">ç¸½æ‰£æ¬¾: ${centsToTwd(r.leaveDeductionCents || 0)}</div>`;
          } else {
            leaveHtml += '<div style="margin-left: 10px; color: #16a34a;">âœ“ ç„¡è«‹å‡è¨˜éŒ„</div>';
          }
          
          // å›ºå®šæ‰£æ¬¾æ˜ç´°ï¼ˆåŠ³ä¿ã€å¥ä¿ç­‰ï¼‰
          let deductionHtml = '<div style="margin-bottom: 10px; margin-top: 15px;"><strong>å›ºå®šæ‰£æ¬¾æ˜ç´°ï¼š</strong></div>';
          if (r.deductionItems && r.deductionItems.length > 0) {
            deductionHtml += '<div style="margin-left: 10px;">';
            r.deductionItems.forEach(item => {
              deductionHtml += `<div style="margin-bottom: 4px;">â€¢ ${item.name}: ${centsToTwd(item.amountCents)}</div>`;
            });
            deductionHtml += '</div>';
            deductionHtml += `<div style="margin-left: 10px; margin-top: 8px; font-weight: 600; color: #dc2626;">å°è¨ˆ: ${centsToTwd(r.deductionCents)}</div>`;
          } else {
            deductionHtml += '<div style="margin-left: 10px; color: #16a34a;">âœ“ ç„¡å›ºå®šæ‰£æ¬¾</div>';
          }
          
          // å…¨å‹¤çé‡‘åˆ¤æ–·
          let fullAttendanceHtml = '<div style="margin-bottom: 10px; margin-top: 15px;"><strong>å…¨å‹¤çé‡‘åˆ¤æ–·ï¼š</strong></div>';
          if (r.isFullAttendance) {
            fullAttendanceHtml += '<div style="margin-left: 10px; color: #16a34a;">';
            fullAttendanceHtml += 'âœ“ æœ¬æœˆå…¨å‹¤<br>';
            fullAttendanceHtml += '<small>ï¼ˆç„¡ç—…å‡ã€äº‹å‡ï¼‰</small>';
            if (r.menstrualDays > 0) {
              fullAttendanceHtml += '<br><small style="color:#16a34a;">ç”Ÿç†å‡ä¸å½±éŸ¿å…¨å‹¤</small>';
            }
            fullAttendanceHtml += '</div>';
          } else {
            fullAttendanceHtml += '<div style="margin-left: 10px; color: #dc2626;">';
            fullAttendanceHtml += 'âœ— æœªé”å…¨å‹¤æ¨™æº–<br>';
            fullAttendanceHtml += '<small>åŸå› : ';
            const reasons = [];
            if (r.sickDays > 0) reasons.push('ç—…å‡');
            if (r.personalDays > 0) reasons.push('äº‹å‡');
            fullAttendanceHtml += reasons.join('ã€');
            fullAttendanceHtml += '</small></div>';
          }
          
          return `
            <tr class="detail-row" id="${rowId}-detail" style="display: none; background: #fafafa;">
              <td colspan="13" style="padding: 15px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div>
                    ${hourlyRateBaseHtml}
                    ${overtimeHtml}
                  </div>
                  <div>
                    ${fullAttendanceHtml}
                    ${transportHtml}
                    ${deductionHtml}
                    ${leaveHtml}
                  </div>
                </div>
              </td>
            </tr>
          `;
        }

        function renderCalc(){
          // ç§»é™¤åˆ†é ï¼Œç›´æ¥é¡¯ç¤ºæ‰€æœ‰ç¯©é¸å¾Œçš„è³‡æ–™
          const rows = calcState.filtered;
          console.log('[æ¸²æŸ“] æ˜¾ç¤º', rows.length, 'æ¡è®°å½•');
          tbodyCalc.innerHTML = '';
          if (rows.length === 0){
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="13" class="muted">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td>';
            tbodyCalc.appendChild(tr);
          } else {
            rows.forEach((r, idx) => {
              const tr = document.createElement('tr');
              const rowId = `payroll-row-${idx}`;
              tr.id = rowId;
              
              // è®¡ç®—æ—¶è–ªæ˜¾ç¤º
              const hourlyRate = centsToTwd(r.hourlyRateCents || 0).replace('NT$ ', '');
              const effectiveHours = r.effectiveWeightedHours || 0;
              const overtimeDetail = r.overtimeCents > 0 ? `<br><small style="color:#059669;">${effectiveHours.toFixed(1)}h Ã— $${hourlyRate}</small>` : '';
              
              // è¯¯é¤è´¹æ˜ç»†
              const mealDays = r.overtimeDays || 0;
              const mealRate = r.mealAllowanceCents > 0 && mealDays > 0 ? Math.round((r.mealAllowanceCents / 100) / mealDays) : 0;
              const mealDetail = r.mealAllowanceCents > 0 ? `<br><small style="color:#059669;">${mealDays}å¤© Ã— $${mealRate}</small>` : '';
              
              // äº¤é€šè´¹æ˜ç»†
              const transportDetail = r.totalKm > 0 ? `<br><small style="color:#059669;">${r.totalKm}km (${r.transportIntervals || 0}åŒºé—´)</small>` : '';
              
              // è¯·å‡æ‰£æ¬¾æ˜ç»†
              const leaveDetail = (r.sickDays || r.personalDays) ? `<br><small style="color:#dc2626;">ç—…${r.sickDays || 0}å¤© äº‹${r.personalDays || 0}å¤©</small>` : '';
              
              // å…¨å‹¤å¥–é‡‘
              const fullAttendanceBonus = r.isFullAttendance ? (r.bonusCents > 0 ? 'å«å…¨å‹¤' : '') : '';
              
              tr.innerHTML = `
                <td style="text-align: center;">
                  <button class="btn btn-sm" onclick="window.togglePayrollDetail('${rowId}')" style="padding: 2px 8px; font-size: 0.75rem;">â–¼</button>
                </td>
                <td><strong>${r.name || ''}</strong></td>
                <td>${centsToTwd(r.baseSalaryCents)}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.regularAllowanceCents)}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.bonusCents)}${fullAttendanceBonus ? `<br><small style="color:#059669;">${fullAttendanceBonus}</small>` : ''}</td>
                <td style="background: #f0fdf4;text-align:center;">${r.isFullAttendance ? '<span style="color:#16a34a;font-size:1.2em;">âœ“</span>' : '<span style="color:#dc2626;">âœ—</span>'}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.overtimeCents)}${overtimeDetail}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.mealAllowanceCents || 0)}${mealDetail}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.transportCents || 0)}${transportDetail}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.performanceBonusCents || 0)}</td>
                <td style="background: #fef2f2;color:#dc2626;">${r.deductionCents > 0 ? '-' + centsToTwd(r.deductionCents) : '0'}</td>
                <td style="background: #fef2f2;color:#dc2626;">${r.leaveDeductionCents > 0 ? '-' + centsToTwd(r.leaveDeductionCents) : '0'}${leaveDetail}</td>
                <td style="font-weight:600;background:#f0f9ff;">${centsToTwd(r.grossSalaryCents)}</td>
                <td style="font-weight:600;color:#16a34a;background:#dbeafe;font-size:1.05em;">${centsToTwd(r.netSalaryCents)}</td>
              `;
              tbodyCalc.appendChild(tr);
              
              // æ·»åŠ è¯¦ç»†æ˜ç»†è¡Œ
              tbodyCalc.insertAdjacentHTML('beforeend', generateDetailRow(r, rowId));
            });
          }
        }
        
        // åˆ‡æ¢è¯¦ç»†æ˜ç»†æ˜¾ç¤º
        window.togglePayrollDetail = function(rowId) {
          const detailRow = document.getElementById(`${rowId}-detail`);
          const btn = document.querySelector(`#${rowId} button`);
          if (detailRow) {
            const isHidden = detailRow.style.display === 'none';
            detailRow.style.display = isHidden ? 'table-row' : 'none';
            if (btn) {
              btn.textContent = isHidden ? 'â–²' : 'â–¼';
            }
          }
        };

        function applyCalcFilters(){
          const kw = (empSearchCalc.value || '').trim().toLowerCase();
          const st = statusCalc.value;
          let rows = calcState.all.slice();
          console.log('[ç­›é€‰] åŸå§‹æ•°æ®:', rows.length, 'æ¡');
          console.log('[ç­›é€‰] å…³é”®è¯:', kw, 'çŠ¶æ€:', st);
          if (kw) rows = rows.filter(r => (r.name || '').toLowerCase().includes(kw));
          if (st === 'complete') rows = rows.filter(r => r.isFullAttendance === true);
          if (st === 'pending') rows = rows.filter(r => r.isFullAttendance === false);
          console.log('[ç­›é€‰] ç­›é€‰åæ•°æ®:', rows.length, 'æ¡');
          calcState.filtered = rows;
          calcState.page = 1;
          renderCalc();
        }

        // è–ªè³‡é è¦½å¿«å–ï¼ˆæŒ‰æœˆä»½ï¼‰
        const payrollCache = new Map(); // key: month, value: { data, timestamp }
        const CACHE_DURATION = 5 * 60 * 1000; // 5åˆ†é˜å¿«å–
        
        async function loadPreview(forceRefresh = false){
          const m = monthInput.value;
          
          // æª¢æŸ¥å¿«å–
          if (!forceRefresh && payrollCache.has(m)) {
            const cached = payrollCache.get(m);
            const now = Date.now();
            if (now - cached.timestamp < CACHE_DURATION) {
              console.log(`[è–ªè³‡è¨ˆç®—] âš¡ ä½¿ç”¨å¿«å–è³‡æ–™ (${m})`);
              calcState.all = cached.data;
              applyCalcFilters();
              return;
            } else {
              console.log(`[è–ªè³‡è¨ˆç®—] å¿«å–å·²éæœŸ (${m})`);
              payrollCache.delete(m);
            }
          }
          
          tbodyCalc.innerHTML = '<tr><td colspan="13" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>';
          try {
            const res = await fetch(`${apiBase}/admin/payroll/preview?month=${encodeURIComponent(m)}`, { credentials: 'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/payroll'); return; }
            if (res.status === 403) { infoBar.style.display = 'block'; setTabsEnabled(false); return; }
            const json = await res.json();
            if (!json || json.ok !== true) throw new Error('è¼‰å…¥å¤±æ•—');
            const users = (json.data && json.data.users) || [];
            console.log('[è–ªè³‡è¨ˆç®—] ğŸ”„ å¾ä¼ºæœå™¨è¼‰å…¥è³‡æ–™:', users.length, 'ç­†è¨˜éŒ„');
            
            // å­˜å…¥å¿«å–
            payrollCache.set(m, {
              data: users,
              timestamp: Date.now()
            });
            
            calcState.all = users;
            applyCalcFilters();
          } catch (err) {
            console.error('[è–ªè³‡è¨ˆç®—] è¼‰å…¥å¤±æ•—:', err);
            tbodyCalc.innerHTML = '<tr><td colspan="13" class="muted" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</td></tr>';
          }
        }

        // ==================== è–ªè³‡é …ç›®è¨­å®šåŠŸèƒ½ ====================

        function getCategoryLabel(cat) {
          const labels = { 'allowance': 'æ´¥è²¼', 'bonus': 'çé‡‘', 'deduction': 'æ‰£æ¬¾' };
          return labels[cat] || cat;
        }

        function renderItems() {
          tbodyItems.innerHTML = '';
          if (itemsState.filtered.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="7" class="muted">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td>';
            tbodyItems.appendChild(tr);
            return;
          }

          itemsState.filtered.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><code>${item.itemCode}</code></td>
              <td>${item.itemName}</td>
              <td>${getCategoryLabel(item.category)}</td>
              <td>${item.isRegularPayment ? 'âœ“ æ˜¯' : 'å¦'}</td>
              <td>${item.isActive ? '<span style="color:#16a34a;">å•Ÿç”¨</span>' : '<span style="color:#9ca3af;">åœç”¨</span>'}</td>
              <td>
                <button class="btn btn-sm" onclick="window.editItem(${item.itemTypeId})">ç·¨è¼¯</button>
                ${item.isActive ? 
                  `<button class="btn btn-sm" onclick="window.toggleItemStatus(${item.itemTypeId}, false)">åœç”¨</button>` :
                  `<button class="btn btn-sm" onclick="window.toggleItemStatus(${item.itemTypeId}, true)">å•Ÿç”¨</button>`
                }
              </td>
            `;
            tbodyItems.appendChild(tr);
          });
        }

        async function loadItems() {
          tbodyItems.innerHTML = '<tr><td colspan="7" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>';
          try {
            const res = await fetch(`${apiBase}/admin/salary-item-types`, { credentials: 'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/payroll'); return; }
            if (res.status === 403) { infoBar.style.display = 'block'; return; }
            const json = await res.json();
            if (!json || json.ok !== true) throw new Error('è¼‰å…¥å¤±æ•—');
            itemsState.all = json.data.items || [];
            applyItemFilters();
          } catch (err) {
            console.error('loadItems error:', err);
            tbodyItems.innerHTML = '<tr><td colspan="7" class="muted" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</td></tr>';
          }
        }

        function applyItemFilters() {
          const kw = (itemSearch.value || '').trim().toLowerCase();
          let items = itemsState.all.slice();
          if (kw) {
            items = items.filter(item => 
              item.itemCode.toLowerCase().includes(kw) || 
              item.itemName.toLowerCase().includes(kw)
            );
          }
          itemsState.filtered = items;
          renderItems();
        }

        function generateItemCode() {
          // è‡ªå‹•ç”Ÿæˆé …ç›®ä»£ç¢¼ï¼šITEM_YYYYMMDDHHMMSS
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const hour = String(now.getHours()).padStart(2, '0');
          const minute = String(now.getMinutes()).padStart(2, '0');
          const second = String(now.getSeconds()).padStart(2, '0');
          return `ITEM_${year}${month}${day}${hour}${minute}${second}`;
        }

        function openItemDialog(item = null) {
          itemErrorMsg.style.display = 'none';
          itemErrorMsg.textContent = '';
          
          if (item) {
            // ç·¨è¼¯æ¨¡å¼
            itemDialogTitle.innerHTML = 'ç·¨è¼¯è–ªè³‡é …ç›®';
            document.getElementById('itemDialogTitle').nextElementSibling.textContent = 'ä¿®æ”¹è–ªè³‡é …ç›®çš„è¨­å®š';
            document.getElementById('itemTypeId').value = item.itemTypeId;
            document.getElementById('itemCode').value = item.itemCode;
            document.getElementById('itemName').value = item.itemName;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemIsRegular').checked = item.isRegularPayment;
            document.getElementById('itemIsPerformance').checked = (item.itemCode === 'PERFORMANCE');
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('itemDisplayOrder').value = item.displayOrder || 0;
          } else {
            // æ–°å¢æ¨¡å¼
            itemDialogTitle.innerHTML = 'æ–°å¢è–ªè³‡é …ç›®';
            document.getElementById('itemDialogTitle').nextElementSibling.textContent = 'è¨­å®šè–ªè³‡é …ç›®çš„åŸºæœ¬è³‡è¨Š';
            itemForm.reset();
            document.getElementById('itemTypeId').value = '';
            document.getElementById('itemCode').value = '';
            document.getElementById('itemDisplayOrder').value = 99;
          }
          
          itemDialog.showModal();
        }

        async function saveItem(e) {
          e.preventDefault();
          itemErrorMsg.style.display = 'none';

          const itemTypeId = document.getElementById('itemTypeId').value;
          const isEdit = !!itemTypeId;
          const isPerformance = document.getElementById('itemIsPerformance').checked;

          // è‡ªå‹•è¨­ç½®é …ç›®ä»£ç¢¼
          let itemCode = document.getElementById('itemCode').value.trim();
          if (isPerformance) {
            itemCode = 'PERFORMANCE';
          } else if (!itemCode || itemCode === 'PERFORMANCE') {
            // å¦‚æœæ²’æœ‰ä»£ç¢¼ï¼Œæˆ–åŸæœ¬æ˜¯ PERFORMANCE ä½†ç¾åœ¨å–æ¶ˆå‹¾é¸ï¼Œå‰‡è‡ªå‹•ç”Ÿæˆ
            itemCode = generateItemCode();
          }

          const data = {
            itemCode: itemCode,
            itemName: document.getElementById('itemName').value.trim(),
            category: document.getElementById('itemCategory').value,
            isRegularPayment: document.getElementById('itemIsRegular').checked,
            description: document.getElementById('itemDescription').value.trim(),
            displayOrder: parseInt(document.getElementById('itemDisplayOrder').value) || 0
          };

          try {
            const url = isEdit 
              ? `${apiBase}/admin/salary-item-types/${itemTypeId}`
              : `${apiBase}/admin/salary-item-types`;
            const method = isEdit ? 'PUT' : 'POST';

            const res = await fetch(url, {
              method,
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });

            const json = await res.json();

            if (res.ok && json.ok) {
              itemDialog.close();
              await loadItems();
              alert(isEdit ? 'æ›´æ–°æˆåŠŸï¼' : 'æ–°å¢æˆåŠŸï¼');
            } else {
              itemErrorMsg.textContent = json.message || 'æ“ä½œå¤±æ•—';
              itemErrorMsg.style.display = 'block';
            }
          } catch (err) {
            console.error('saveItem error:', err);
            itemErrorMsg.textContent = 'æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
            itemErrorMsg.style.display = 'block';
          }
        }

        async function toggleItemStatus(itemTypeId, newStatus) {
          if (!confirm(`ç¢ºå®šè¦${newStatus ? 'å•Ÿç”¨' : 'åœç”¨'}æ­¤é …ç›®ï¼Ÿ`)) return;

          try {
            const res = await fetch(`${apiBase}/admin/salary-item-types/${itemTypeId}`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ isActive: newStatus })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              await loadItems();
            } else {
              alert(json.message || 'æ“ä½œå¤±æ•—');
            }
          } catch (err) {
            console.error('toggleItemStatus error:', err);
            alert('æ“ä½œå¤±æ•—');
          }
        }

        // å…¨å±€å‡½æ•¸ä¾› onclick ä½¿ç”¨
        window.editItem = function(itemTypeId) {
          const item = itemsState.all.find(i => i.itemTypeId === itemTypeId);
          if (item) openItemDialog(item);
        };

        window.toggleItemStatus = toggleItemStatus;

        // ==================== å“¡å·¥è–ªè³‡è¨­å®šåŠŸèƒ½ ====================

        // åŠ è¼‰æ‰€æœ‰å“¡å·¥
        async function loadUsers() {
          try {
            const res = await fetch(`${apiBase}/admin/users`, { credentials: 'include' });
            if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
            const json = await res.json();
            empState.allUsers = json.data?.users || [];
            empState.filteredUsers = [...empState.allUsers];
            renderUserList();
          } catch (err) {
            console.error('loadUsers error:', err);
            empList.innerHTML = '<li class="muted">è¼‰å…¥å¤±æ•—</li>';
          }
        }

        // æ¸²æŸ“å“¡å·¥åˆ—è¡¨
        function renderUserList() {
          if (empState.filteredUsers.length === 0) {
            empList.innerHTML = '<li class="muted">ç„¡ç¬¦åˆæ¢ä»¶çš„å“¡å·¥</li>';
            return;
          }
          empList.innerHTML = empState.filteredUsers.map(u => `
            <li class="${empState.selectedUserId === u.userId ? 'active' : ''}" 
                onclick="selectUser(${u.userId})" 
                style="cursor: pointer; padding: 0.75rem;">
              <div style="font-weight: 500;">${u.name || u.username}</div>
              <div style="font-size: 0.875rem; color: #666;">åº•è–ª: ${u.baseSalary.toLocaleString()} å…ƒ</div>
            </li>
          `).join('');
        }

        // æœå°‹å“¡å·¥
        function applyUserFilters() {
          const keyword = empSearch.value.toLowerCase().trim();
          if (!keyword) {
            empState.filteredUsers = [...empState.allUsers];
          } else {
            empState.filteredUsers = empState.allUsers.filter(u => 
              (u.name || '').toLowerCase().includes(keyword) ||
              (u.username || '').toLowerCase().includes(keyword)
            );
          }
          renderUserList();
        }

        // é¸æ“‡å“¡å·¥
        window.selectUser = async function(userId) {
          empState.selectedUserId = userId;
          renderUserList();
          await loadUserSalary(userId);
        };

        // åŠ è¼‰å“¡å·¥è–ªè³‡è¨­å®š
        async function loadUserSalary(userId) {
          try {
            const res = await fetch(`${apiBase}/admin/users/${userId}/salary`, { credentials: 'include' });
            if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
            const json = await res.json();
            empState.currentUserData = json.data;
            empState.userSalaryItems = json.data.salaryItems || [];
            renderUserSalaryForm();
          } catch (err) {
            console.error('loadUserSalary error:', err);
            alert('è¼‰å…¥å“¡å·¥è–ªè³‡å¤±æ•—');
          }
        }

        // æ¸²æŸ“å“¡å·¥è–ªè³‡è¡¨å–®
        function renderUserSalaryForm() {
          const data = empState.currentUserData;
          if (!data) {
            empFormContainer.style.display = 'none';
            empEmptyState.style.display = 'block';
            return;
          }

          empFormContainer.style.display = 'block';
          empEmptyState.style.display = 'none';
          empFormTitle.textContent = `${data.name} çš„è–ªè³‡è¨­å®š`;
          empBaseSalary.value = data.baseSalary || 0;
          empSalaryNotes.value = data.salaryNotes || '';
          
          renderUserSalaryItems();
        }

        // æ¸²æŸ“å“¡å·¥è–ªè³‡é …ç›®åˆ—è¡¨
        function renderUserSalaryItems() {
          if (empState.userSalaryItems.length === 0) {
            empItemsList.innerHTML = '<small class="muted">å°šç„¡è–ªè³‡é …ç›®</small>';
            return;
          }

          empItemsList.innerHTML = empState.userSalaryItems.map((item, index) => {
            const recurringType = item.recurringType || 'monthly';
            let recurringMonths = [];
            if (item.recurringMonths) {
              try {
                recurringMonths = JSON.parse(item.recurringMonths);
              } catch (e) {
                console.error('Failed to parse recurring_months:', item.recurringMonths);
              }
            }
            const showMonthSelector = recurringType === 'yearly';
            
            return `
            <div class="salary-item-row" style="background: #f9fafb; border: 1px solid #e0e0e0; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem;">
              <div style="display: grid; grid-template-columns: 2fr 1fr 1.5fr auto; gap: 0.5rem; align-items: start; margin-bottom: 0.5rem;">
                <div>
                  <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.25rem;">é …ç›®</label>
                  <select class="item-type-select" data-index="${index}" style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    ${renderItemTypeOptions(item.itemTypeId)}
                  </select>
                </div>
                <div>
                  <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.25rem;">é‡‘é¡ï¼ˆå…ƒï¼‰</label>
                  <input type="number" class="item-amount" data-index="${index}" value="${item.amountCents / 100}" 
                         placeholder="0.00" min="0" step="0.01" style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;" />
                </div>
                <div>
                  <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.25rem;">ç™¼æ”¾é€±æœŸ</label>
                  <select class="item-recurring-type" data-index="${index}" onchange="toggleMonthSelector(${index})" style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    <option value="monthly" ${recurringType === 'monthly' ? 'selected' : ''}>æ¯æœˆç™¼æ”¾</option>
                    <option value="yearly" ${recurringType === 'yearly' ? 'selected' : ''}>æ¯å¹´æŒ‡å®šæœˆä»½</option>
                    <option value="once" ${recurringType === 'once' ? 'selected' : ''}>åƒ…ç™¼æ”¾ä¸€æ¬¡</option>
                  </select>
                </div>
                <div style="padding-top: 1.25rem;">
                  <button type="button" class="btn btn-sm" onclick="removeUserSalaryItem(${index})" style="padding: 0.375rem 0.75rem;">âŒ</button>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                <div>
                  <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.25rem;">ğŸ“… ç”Ÿæ•ˆæ—¥æœŸ</label>
                  <input type="date" class="item-effective-date" data-index="${index}" value="${item.effectiveDate || ''}" 
                         style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;" />
                </div>
                <div>
                  <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.25rem;">ğŸ“… å¤±æ•ˆæ—¥æœŸï¼ˆé¸å¡«ï¼‰</label>
                  <input type="date" class="item-expiry-date" data-index="${index}" value="${item.expiryDate || ''}" 
                         placeholder="ç•™ç©ºè¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ"
                         style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;" />
                </div>
              </div>
              <div class="month-selector-${index}" style="display: ${showMonthSelector ? 'block' : 'none'};">
                <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.5rem;">ğŸ“… ç™¼æ”¾æœˆä»½ï¼ˆå¯å¤šé¸ï¼‰</label>
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.25rem;">
                  ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `
                    <label style="display: flex; align-items: center; padding: 0.25rem; font-size: 0.875rem;">
                      <input type="checkbox" class="month-checkbox-${index}" value="${m}" ${recurringMonths.includes(m) ? 'checked' : ''} style="margin-right: 0.25rem;" />
                      ${m}æœˆ
                    </label>
                  `).join('')}
                </div>
              </div>
            </div>
          `;
          }).join('');
        }

        // æ¸²æŸ“è–ªè³‡é …ç›®é¡å‹é¸é …
        function renderItemTypeOptions(selectedId) {
          return itemsState.all
            .filter(t => t.isActive)
            .map(t => `<option value="${t.itemTypeId}" ${t.itemTypeId === selectedId ? 'selected' : ''}>
              ${t.itemName} (${t.category === 'allowance' ? 'æ´¥è²¼' : t.category === 'bonus' ? 'çé‡‘' : 'æ‰£æ¬¾'})
            </option>`)
            .join('');
        }

        // åˆ‡æ›æœˆä»½é¸æ“‡å™¨é¡¯ç¤º
        window.toggleMonthSelector = function(index) {
          const selector = document.querySelector(`.month-selector-${index}`);
          const recurringTypeSelect = document.querySelector(`.item-recurring-type[data-index="${index}"]`);
          if (selector && recurringTypeSelect) {
            selector.style.display = recurringTypeSelect.value === 'yearly' ? 'block' : 'none';
          }
        };

        // æ–°å¢å“¡å·¥è–ªè³‡é …ç›®
        window.addUserSalaryItem = function() {
          if (itemsState.all.filter(t => t.isActive).length === 0) {
            alert('è«‹å…ˆåœ¨ã€Œè–ªè³‡é …ç›®è¨­å®šã€ä¸­æ–°å¢å¯ç”¨çš„è–ªè³‡é …ç›®');
            return;
          }
          const today = new Date().toISOString().split('T')[0];
          empState.userSalaryItems.push({
            itemTypeId: itemsState.all.filter(t => t.isActive)[0]?.itemTypeId || null,
            amountCents: 0,
            recurringType: 'monthly',
            recurringMonths: null,
            effectiveDate: today,
            expiryDate: null
          });
          renderUserSalaryItems();
        };

        // ç§»é™¤å“¡å·¥è–ªè³‡é …ç›®
        window.removeUserSalaryItem = function(index) {
          empState.userSalaryItems.splice(index, 1);
          renderUserSalaryItems();
        };

        // å„²å­˜å“¡å·¥è–ªè³‡è¨­å®š
        async function saveUserSalary() {
          if (!empState.selectedUserId) return;

          const baseSalary = parseFloat(empBaseSalary.value) || 0;
          const salaryNotes = empSalaryNotes.value.trim();

          // æ”¶é›†è–ªè³‡é …ç›®
          const salaryItems = [];
          const itemRows = empItemsList.querySelectorAll('.salary-item-row');
          itemRows.forEach((row, index) => {
            const typeSelect = row.querySelector('.item-type-select');
            const amountInput = row.querySelector('.item-amount');
            const recurringTypeSelect = row.querySelector('.item-recurring-type');
            const effectiveDateInput = row.querySelector('.item-effective-date');
            const expiryDateInput = row.querySelector('.item-expiry-date');
            
            const itemTypeId = parseInt(typeSelect.value);
            const amount = parseFloat(amountInput.value) || 0;
            const recurringType = recurringTypeSelect.value;
            const effectiveDate = effectiveDateInput.value || new Date().toISOString().split('T')[0];
            const expiryDate = expiryDateInput.value || null;
            
            // æ”¶é›†é¸ä¸­çš„æœˆä»½
            let recurringMonths = null;
            if (recurringType === 'yearly') {
              const monthCheckboxes = row.querySelectorAll(`.month-checkbox-${index}:checked`);
              const selectedMonths = Array.from(monthCheckboxes).map(cb => parseInt(cb.value));
              if (selectedMonths.length > 0) {
                recurringMonths = JSON.stringify(selectedMonths);
              }
            }
            
            if (itemTypeId && amount > 0) {
              salaryItems.push({
                itemTypeId,
                amountCents: Math.round(amount * 100),
                effectiveDate,
                expiryDate,
                recurringType,
                recurringMonths
              });
            }
          });

          try {
            const res = await fetch(`${apiBase}/admin/users/${empState.selectedUserId}/salary`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ baseSalary, salaryNotes, salaryItems })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              alert('âœ… å„²å­˜æˆåŠŸ');
              // æ¸…é™¤è–ªè³‡é è¦½å¿«å–ï¼Œå¼·åˆ¶é‡æ–°è¨ˆç®—
              console.log('[å“¡å·¥è–ªè³‡] æ¸…é™¤è–ªè³‡é è¦½å¿«å–');
              payrollCache.clear();
              await loadUsers(); // é‡æ–°åŠ è¼‰å“¡å·¥åˆ—è¡¨
              await loadUserSalary(empState.selectedUserId); // é‡æ–°åŠ è¼‰ç•¶å‰å“¡å·¥
            } else {
              alert(json.message || 'å„²å­˜å¤±æ•—');
            }
          } catch (err) {
            console.error('saveUserSalary error:', err);
            alert('å„²å­˜å¤±æ•—');
          }
        }

        // ç¶å®šè–ªè³‡é …ç›®äº‹ä»¶
        let searchTimer = null;
        itemSearch.addEventListener('input', () => {
          clearTimeout(searchTimer);
          searchTimer = setTimeout(applyItemFilters, 300);
        });
        btnAddItem.addEventListener('click', () => openItemDialog());
        btnCancelItem.addEventListener('click', () => itemDialog.close());
        itemForm.addEventListener('submit', saveItem);

        // ç¶å®šå“¡å·¥è–ªè³‡è¨­å®šäº‹ä»¶
        let empSearchTimer = null;
        empSearch.addEventListener('input', () => {
          clearTimeout(empSearchTimer);
          empSearchTimer = setTimeout(applyUserFilters, 300);
        });
        btnAddEmpItem.addEventListener('click', addUserSalaryItem);
        btnCancelEmp.addEventListener('click', () => {
          empState.selectedUserId = null;
          empFormContainer.style.display = 'none';
          empEmptyState.style.display = 'block';
          renderUserList();
        });
        btnSaveEmp.addEventListener('click', saveUserSalary);

        // ==================== ç¸¾æ•ˆçé‡‘èª¿æ•´åŠŸèƒ½ ====================

        const tbodyBonus = document.getElementById('tbodyBonus');
        const bonusAdjustedCount = document.getElementById('bonusAdjustedCount');
        const yearBonusInput = document.getElementById('yearBonus');
        const btnSaveBonus = document.getElementById('btnSaveBonus');

        // ç‹€æ…‹ï¼šå­˜å„²æ‰€æœ‰å“¡å·¥çš„å…¨å¹´12å€‹æœˆæ•¸æ“š
        let bonusState = { employees: [] };

        // åŠ è¼‰å¹´åº¦ç¸¾æ•ˆæ•¸æ“šï¼ˆ12å€‹æœˆï¼‰
        async function loadYearlyBonus() {
          const year = yearBonusInput.value;
          if (!year) return;

          try {
            const res = await fetch(`${apiBase}/admin/bonus/year/${year}`, { credentials: 'include' });
            if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
            const json = await res.json();
            bonusState.employees = json.data?.employees || [];
            renderBonusTable();
          } catch (err) {
            console.error('loadYearlyBonus error:', err);
            tbodyBonus.innerHTML = '<tr><td colspan="13" class="muted">è¼‰å…¥å¤±æ•—</td></tr>';
          }
        }

        // æ¸²æŸ“å…¨å¹´ç¸¾æ•ˆè¡¨æ ¼
        function renderBonusTable() {
          if (bonusState.employees.length === 0) {
            tbodyBonus.innerHTML = '<tr><td colspan="13" class="muted">ç„¡å“¡å·¥è³‡æ–™</td></tr>';
            return;
          }

          tbodyBonus.innerHTML = bonusState.employees.map((emp, empIndex) => {
            // ç”Ÿæˆ12å€‹æœˆçš„è¼¸å…¥æ¡†
            const monthInputs = [];
            for (let month = 1; month <= 12; month++) {
              // ç²å–è©²æœˆçš„é è¨­ç¸¾æ•ˆï¼ˆè€ƒæ…®ç”Ÿæ•ˆæ—¥æœŸï¼‰
              const monthDefault = emp.monthlyDefaults?.[month] || 0;
              const defaultAmount = (monthDefault / 100).toFixed(0);
              
              // ç²å–è©²æœˆçš„èª¿æ•´é‡‘é¡
              const monthData = emp.monthlyAdjustments?.[month] || null;
              const value = monthData ? (monthData.bonusAmountCents / 100).toFixed(0) : '';
              
              // å¦‚æœæœ‰èª¿æ•´é‡‘é¡ï¼Œé¡¯ç¤ºèª¿æ•´å¾Œçš„é‡‘é¡ï¼›å¦å‰‡é¡¯ç¤ºé è¨­é‡‘é¡ä½œç‚ºplaceholder
              monthInputs.push(`
                <td style="padding: 4px 6px;">
                  <input type="number" 
                         class="bonus-input" 
                         data-emp-index="${empIndex}" 
                         data-month="${month}" 
                         value="${value}" 
                         placeholder="${defaultAmount}" 
                         min="0" 
                         step="1" 
                         title="é è¨­: ${defaultAmount} å…ƒ"
                         style="width: 75px; padding: 4px 6px; text-align: right; font-size: 13px; border: 1px solid #d1d5db; border-radius: 4px;" />
                </td>
              `);
            }
            
            return `
              <tr>
                <td style="position: sticky; left: 0; background: white; font-weight: 500; padding: 6px 8px; font-size: 13px;">
                  ${emp.name || emp.username}
                </td>
                ${monthInputs.join('')}
              </tr>
            `;
          }).join('');

          updateBonusSummary();
        }

        // æ›´æ–°çµ±è¨ˆæ‘˜è¦
        function updateBonusSummary() {
          let totalAdjustments = 0;
          bonusState.employees.forEach(emp => {
            if (emp.monthlyAdjustments) {
              totalAdjustments += Object.keys(emp.monthlyAdjustments).length;
            }
          });
          bonusAdjustedCount.textContent = totalAdjustments;
        }

        // å„²å­˜å…¨å¹´ç¸¾æ•ˆèª¿æ•´
        async function saveYearlyBonus() {
          const year = yearBonusInput.value;
          if (!year) {
            alert('è«‹é¸æ“‡å¹´åº¦');
            return;
          }

          // æ”¶é›†æ‰€æœ‰æœˆä»½çš„èª¿æ•´æ•¸æ“š
          const allAdjustments = [];
          const inputs = tbodyBonus.querySelectorAll('.bonus-input');

          inputs.forEach(input => {
            const empIndex = parseInt(input.dataset.empIndex);
            const month = parseInt(input.dataset.month);
            const emp = bonusState.employees[empIndex];
            
            if (!emp) return;

            const value = input.value.trim();
            
            // åªä¿å­˜æœ‰å¡«å¯«é‡‘é¡çš„é …ç›®
            if (value !== '') {
              const monthStr = `${year}-${String(month).padStart(2, '0')}`;
              allAdjustments.push({
                userId: emp.userId,
                month: monthStr,
                bonusAmountCents: Math.round(parseFloat(value) * 100),
                notes: null
              });
            }
          });

          try {
            const res = await fetch(`${apiBase}/admin/bonus/year/${year}`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ adjustments: allAdjustments })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              alert('âœ… å…¨å¹´ç¸¾æ•ˆèª¿æ•´å·²å„²å­˜');
              // æ¸…é™¤è–ªè³‡é è¦½å¿«å–
              console.log('[å…¨å¹´ç¸¾æ•ˆçé‡‘] æ¸…é™¤è–ªè³‡é è¦½å¿«å–');
              payrollCache.clear();
              await loadYearlyBonus();
            } else {
              alert(json.message || 'å„²å­˜å¤±æ•—');
            }
          } catch (err) {
            console.error('saveYearlyBonus error:', err);
            alert('å„²å­˜å¤±æ•—');
          }
        }

        // ç›£è½ç¸¾æ•ˆçé‡‘è¼¸å…¥æ¡†çš„è®Šæ›´ï¼ˆä½¿ç”¨äº‹ä»¶å§”è¨—ï¼‰
        tbodyBonus.addEventListener('input', (e) => {
          if (e.target.classList.contains('bonus-input')) {
            const empIndex = parseInt(e.target.dataset.empIndex);
            const month = parseInt(e.target.dataset.month);
            const value = e.target.value.trim();
            
            // æ›´æ–° bonusState
            if (bonusState.employees[empIndex]) {
              if (!bonusState.employees[empIndex].monthlyAdjustments) {
                bonusState.employees[empIndex].monthlyAdjustments = {};
              }
              
              if (value !== '') {
                bonusState.employees[empIndex].monthlyAdjustments[month] = {
                  bonusAmountCents: Math.round(parseFloat(value) * 100)
                };
              } else {
                delete bonusState.employees[empIndex].monthlyAdjustments[month];
              }
              
              updateBonusSummary();
            }
          }
        });

        // ç¶å®šç¸¾æ•ˆçé‡‘äº‹ä»¶
        yearBonusInput.addEventListener('change', loadYearlyBonus);
        btnSaveBonus.addEventListener('click', saveYearlyBonus);

        // ==================== å¹´çµ‚çé‡‘ç®¡ç†åŠŸèƒ½ ====================

        const tbodyYearend = document.getElementById('tbodyYearend');
        const yearendStats = document.getElementById('yearendStats');
        const yearInput = document.getElementById('yearInput');
        const btnSaveYearend = document.getElementById('btnSaveYearend');

        let yearendState = { employees: [], summary: { totalCents: 0, count: 0, averageCents: 0 } };

        // åŠ è¼‰å¹´åº¦å¹´çµ‚çé‡‘æ•¸æ“š
        async function loadYearEndBonus() {
          const year = yearInput.value;
          if (!year) return;

          try {
            const res = await fetch(`${apiBase}/admin/yearend/${year}`, { credentials: 'include' });
            if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
            const json = await res.json();
            yearendState.employees = json.data?.employees || [];
            yearendState.summary = json.data?.summary || { totalCents: 0, count: 0, averageCents: 0 };
            renderYearendTable();
          } catch (err) {
            console.error('loadYearEndBonus error:', err);
            tbodyYearend.innerHTML = '<tr><td colspan="5" class="muted">è¼‰å…¥å¤±æ•—</td></tr>';
          }
        }

        // æ¸²æŸ“å¹´çµ‚çé‡‘è¡¨æ ¼
        function renderYearendTable() {
          if (yearendState.employees.length === 0) {
            tbodyYearend.innerHTML = '<tr><td colspan="5" class="muted">ç„¡å“¡å·¥è³‡æ–™</td></tr>';
            return;
          }

          tbodyYearend.innerHTML = yearendState.employees.map((emp, index) => {
            const amount = (emp.amountCents / 100).toFixed(2);
            
            return `
              <tr>
                <td>${emp.name || emp.username}</td>
                <td>${emp.baseSalary.toLocaleString()}</td>
                <td>
                  <input type="number" class="yearend-amount" data-index="${index}" 
                         value="${amount > 0 ? amount : ''}" 
                         placeholder="0.00" 
                         min="0" step="0.01" 
                         style="width: 120px;" />
                </td>
                <td>
                  <input type="month" class="yearend-month" data-index="${index}" 
                         value="${emp.paymentMonth || ''}" 
                         placeholder="YYYY-MM"
                         style="width: 150px;" />
                </td>
                <td>
                  <input type="text" class="yearend-notes" data-index="${index}" 
                         value="${emp.notes || ''}" 
                         placeholder="å‚™è¨»" 
                         style="width: 200px;" />
                </td>
              </tr>
            `;
          }).join('');

          updateYearendStats();
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateYearendStats() {
          const total = (yearendState.summary.totalCents / 100).toLocaleString();
          const count = yearendState.summary.count;
          const average = (yearendState.summary.averageCents / 100).toLocaleString();
          
          yearendStats.innerHTML = `
            <span>ç¸½é¡ï¼š${total} å…ƒ</span>
            <span>äººæ•¸ï¼š${count}</span>
            <span>å¹³å‡ï¼š${average} å…ƒ</span>
          `;
        }

        // å„²å­˜å¹´çµ‚çé‡‘
        async function saveYearEndBonus() {
          const year = yearInput.value;
          if (!year) return;

          // æ”¶é›†çé‡‘æ•¸æ“š
          const bonuses = [];
          const amountInputs = tbodyYearend.querySelectorAll('.yearend-amount');
          const monthInputs = tbodyYearend.querySelectorAll('.yearend-month');
          const notesInputs = tbodyYearend.querySelectorAll('.yearend-notes');

          amountInputs.forEach((input, index) => {
            const emp = yearendState.employees[index];
            if (!emp) return;

            const amount = parseFloat(input.value) || 0;
            const paymentMonth = monthInputs[index].value || null;
            const notes = notesInputs[index].value.trim() || null;

            if (amount > 0) {
              bonuses.push({
                userId: emp.userId,
                amountCents: Math.round(amount * 100),
                paymentMonth,
                notes
              });
            }
          });

          try {
            const res = await fetch(`${apiBase}/admin/yearend/${year}`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ bonuses })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              alert('âœ… å„²å­˜æˆåŠŸ');
              // æ¸…é™¤è–ªèµ„é¢„è§ˆç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°è®¡ç®—
              console.log('[å¹´ç»ˆå¥–é‡‘] æ¸…é™¤è–ªèµ„é¢„è§ˆç¼“å­˜');
              payrollCache.clear();
              await loadYearEndBonus();
            } else {
              alert(json.message || 'å„²å­˜å¤±æ•—');
            }
          } catch (err) {
            console.error('saveYearEndBonus error:', err);
            alert('å„²å­˜å¤±æ•—');
          }
        }

        // ç¶å®šå¹´çµ‚çé‡‘äº‹ä»¶
        yearInput.addEventListener('change', loadYearEndBonus);
        btnSaveYearend.addEventListener('click', saveYearEndBonus);

        // ==================== ç³»çµ±è¨­å®šåŠŸèƒ½ ====================

        const btnSaveSettings = document.getElementById('btnSaveSettings');
        let systemSettings = [];

        // åŠ è¼‰ç³»çµ±è¨­å®š
        async function loadSystemSettings() {
          try {
            const res = await fetch(`${apiBase}/admin/payroll-settings`, { credentials: 'include' });
            if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
            const json = await res.json();
            systemSettings = json.data?.settings || [];
            renderSystemSettings();
          } catch (err) {
            console.error('loadSystemSettings error:', err);
            alert('è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—');
          }
        }

        // æ¸²æŸ“ç³»çµ±è¨­å®š
        function renderSystemSettings() {
          systemSettings.forEach(setting => {
            const inputId = `setting_${setting.settingKey}`;
            const input = document.getElementById(inputId);
            if (input) {
              input.value = setting.settingValue;
            }
          });
        }

        // å„²å­˜ç³»çµ±è¨­å®š
        async function saveSystemSettings() {
          if (!confirm('ç¢ºå®šè¦æ›´æ–°ç³»çµ±è¨­å®šå—ï¼Ÿ\n\né€™æœƒå½±éŸ¿æœªä¾†æ‰€æœ‰çš„è–ªè³‡è¨ˆç®—ã€‚')) return;

          const settings = [];
          systemSettings.forEach(setting => {
            const inputId = `setting_${setting.settingKey}`;
            const input = document.getElementById(inputId);
            if (input) {
              settings.push({
                settingKey: setting.settingKey,
                settingValue: input.value
              });
            }
          });

          try {
            const res = await fetch(`${apiBase}/admin/payroll-settings`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ settings })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              alert('âœ… è¨­å®šå·²æ›´æ–°');
              await loadSystemSettings();
            } else {
              alert(json.message || 'æ›´æ–°å¤±æ•—');
            }
          } catch (err) {
            console.error('saveSystemSettings error:', err);
            alert('æ›´æ–°å¤±æ•—');
          }
        }

        // ç¶å®šç³»çµ±è¨­å®šäº‹ä»¶
        btnSaveSettings.addEventListener('click', saveSystemSettings);

        // ==================== æ‰“å¡è¨˜éŒ„ä¸Šå‚³åŠŸèƒ½ ====================

        const punchFileInput = document.getElementById('punchFileInput');
        const btnSelectFile = document.getElementById('btnSelectFile');
        const uploadForm = document.getElementById('uploadForm');
        const selectedFileName = document.getElementById('selectedFileName');
        const punchMonth = document.getElementById('punchMonth');
        const punchNotes = document.getElementById('punchNotes');
        const btnUploadFile = document.getElementById('btnUploadFile');
        const btnCancelUpload = document.getElementById('btnCancelUpload');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const uploadStatus = document.getElementById('uploadStatus');
        const punchFilesList = document.getElementById('punchFilesList');
        const btnRefreshFiles = document.getElementById('btnRefreshFiles');
        const punchAdminTools = document.getElementById('punchAdminTools');
        const punchUserSelect = document.getElementById('punchUserSelect');

        let selectedFile = null;
        let currentUserId = null;
        let isAdminMode = false; // æ˜¯å¦ç‚ºç®¡ç†å“¡æ¨¡å¼

        // é¸æ“‡æª”æ¡ˆ
        btnSelectFile.addEventListener('click', () => {
          punchFileInput.click();
        });

        punchFileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;

          // æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆ10MBï¼‰
          if (file.size > 10 * 1024 * 1024) {
            alert('æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 10MB');
            punchFileInput.value = '';
            return;
          }

          selectedFile = file;
          selectedFileName.textContent = file.name;
          uploadForm.style.display = 'block';
          
          // è‡ªå‹•è¨­å®šæœˆä»½ç‚ºç•¶å‰æœˆä»½
          if (!punchMonth.value) {
            const now = new Date();
            punchMonth.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
          }
        });

        // å–æ¶ˆä¸Šå‚³
        btnCancelUpload.addEventListener('click', () => {
          selectedFile = null;
          punchFileInput.value = '';
          uploadForm.style.display = 'none';
          uploadProgress.style.display = 'none';
        });

        // é–‹å§‹ä¸Šå‚³
        btnUploadFile.addEventListener('click', async () => {
          if (!selectedFile) {
            alert('è«‹å…ˆé¸æ“‡æª”æ¡ˆ');
            return;
          }

          if (!punchMonth.value) {
            alert('è«‹é¸æ“‡æ‰€å±¬æœˆä»½');
            return;
          }

          try {
            btnUploadFile.disabled = true;
            btnCancelUpload.disabled = true;
            uploadProgress.style.display = 'block';
            uploadProgressBar.style.width = '50%';
            uploadStatus.textContent = 'æ­£åœ¨ä¸Šå‚³æª”æ¡ˆ...';

            // ä½¿ç”¨FormDataä¸Šå‚³
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('month', punchMonth.value);
            if (punchNotes.value) {
              formData.append('notes', punchNotes.value);
            }

            const uploadRes = await fetch(`${apiBase}/punch-records/upload`, {
              method: 'POST',
              credentials: 'include',
              body: formData
            });

            if (!uploadRes.ok) throw new Error('æª”æ¡ˆä¸Šå‚³å¤±æ•—');
            const json = await uploadRes.json();

            uploadProgressBar.style.width = '100%';
            uploadStatus.textContent = 'âœ… ä¸Šå‚³å®Œæˆï¼';

            // é‡ç½®è¡¨å–®
            setTimeout(() => {
              selectedFile = null;
              punchFileInput.value = '';
              punchNotes.value = '';
              uploadForm.style.display = 'none';
              uploadProgress.style.display = 'none';
              uploadProgressBar.style.width = '0%';
              btnUploadFile.disabled = false;
              btnCancelUpload.disabled = false;
              
              // é‡æ–°è¼‰å…¥åˆ—è¡¨
              loadPunchRecords(currentUserId);
            }, 1500);

          } catch (err) {
            console.error('ä¸Šå‚³å¤±æ•—:', err);
            alert('ä¸Šå‚³å¤±æ•—ï¼š' + err.message);
            uploadProgress.style.display = 'none';
            btnUploadFile.disabled = false;
            btnCancelUpload.disabled = false;
          }
        });

        // è¼‰å…¥æ‰“å¡è¨˜éŒ„åˆ—è¡¨
        async function loadPunchRecords(userId) {
          console.log('[æ‰“å¡è¨˜éŒ„] é–‹å§‹è¼‰å…¥ï¼Œç”¨æˆ¶ID:', userId);
          currentUserId = userId;
          
          // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
          punchFilesList.innerHTML = '<tr><td colspan="3" class="muted" style="padding: 2rem; text-align: center;">è¼‰å…¥ä¸­...</td></tr>';
          
          try {
            const res = await fetch(`${apiBase}/punch-records`, { credentials: 'include' });
            console.log('[æ‰“å¡è¨˜éŒ„] API å›æ‡‰ç‹€æ…‹:', res.status);
            if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—ï¼š' + res.status);
            const json = await res.json();
            console.log('[æ‰“å¡è¨˜éŒ„] æ”¶åˆ°è³‡æ–™:', json);
            const records = json.data?.records || [];
            console.log('[æ‰“å¡è¨˜éŒ„] è¨˜éŒ„æ•¸é‡:', records.length);
            renderPunchRecords(records);
          } catch (err) {
            console.error('[æ‰“å¡è¨˜éŒ„] è¼‰å…¥å¤±æ•—:', err);
            punchFilesList.innerHTML = '<tr><td colspan="3" class="muted" style="padding: 2rem; text-align: center;">è¼‰å…¥å¤±æ•—ï¼š' + err.message + '</td></tr>';
          }
        }

        // æ¸²æŸ“æ‰“å¡è¨˜éŒ„åˆ—è¡¨
        function renderPunchRecords(records) {
          if (records.length === 0) {
            punchFilesList.innerHTML = '<tr><td colspan="3" class="muted" style="padding: 2rem; text-align: center;">å°šç„¡ä¸Šå‚³è¨˜éŒ„</td></tr>';
            return;
          }

          punchFilesList.innerHTML = records.map(record => {
            const fileSize = (record.fileSizeBytes / 1024).toFixed(1) + ' KB';
            
            // åˆ¤æ–­æ–‡ä»¶ç±»å‹æ˜¯å¦å¯é¢„è§ˆ
            const fileType = record.fileType || '';
            const canPreview = fileType.includes('pdf') || 
                             fileType.includes('image') || 
                             fileType.startsWith('image/');
            
            // æ·»åŠ ç‚¹å‡»è¡Œé¢„è§ˆ
            const rowClass = canPreview ? 'style="cursor: pointer;"' : '';
            const rowClick = canPreview ? `onclick="previewPunchRecord(${record.recordId}, '${record.fileName}', '${fileType}')"` : '';

            return `
              <tr ${rowClass} ${rowClick}>
                <td style="padding: 0.75rem 0.5rem;">${record.month}</td>
                <td style="padding: 0.75rem 0.5rem;">
                  <div style="font-weight: 500; font-size: 0.875rem;">${record.fileName}</div>
                  <div style="font-size: 0.75rem; color: #6b7280; margin-top: 2px;">${fileSize}${record.notes ? ' â€¢ ' + record.notes : ''}</div>
                </td>
                <td style="padding: 0.75rem 0.5rem; white-space: nowrap;">
                  <button class="btn" onclick="event.stopPropagation(); downloadPunchRecord('${record.recordId}', '${record.fileName}')" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; margin-right: 0.25rem;">
                    â¬‡ï¸
                  </button>
                  <button class="btn" onclick="event.stopPropagation(); deletePunchRecord('${record.recordId}')" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; color: #dc2626;">
                    ğŸ—‘ï¸
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        }

        // ç”¨æ–¼é‡‹æ”¾blob URL
        let currentPreviewBlobUrl = null;

        // é è¦½æ‰“å¡è¨˜éŒ„ï¼ˆåœ¨ç•¶å‰é é¢é è¦½å€åŸŸé¡¯ç¤ºï¼‰
        window.previewPunchRecord = async function(recordId, fileName, fileType) {
          const previewArea = document.getElementById('punchPreviewArea');
          if (!previewArea) return;

          // æ¸…ç†ä¹‹å‰çš„ blob URL
          if (currentPreviewBlobUrl) {
            URL.revokeObjectURL(currentPreviewBlobUrl);
            currentPreviewBlobUrl = null;
          }

          // é¡¯ç¤ºè¼‰å…¥ä¸­
          previewArea.innerHTML = `
            <div style="text-align:center;padding:60px 20px;color:#6b7280;">
              <div style="font-size:48px;margin-bottom:16px;">â³</div>
              <div>è¼‰å…¥ä¸­...</div>
            </div>
          `;

          try {
            const previewUrl = `${apiBase}/punch-records/${recordId}/preview`;
            const res = await fetch(previewUrl, { credentials: 'include' });
            
            if (!res.ok) {
              throw new Error('ç„¡æ³•è¼‰å…¥æ–‡ä»¶');
            }
            
            const blob = await res.blob();
            const blobUrl = URL.createObjectURL(blob);
            currentPreviewBlobUrl = blobUrl;

            // æ ¹æ“šæ–‡ä»¶é¡å‹é¡¯ç¤ºé è¦½
            if (fileType.includes('pdf') || fileName.match(/\.pdf$/i)) {
              // PDFé è¦½ - å…¨å±æ˜¾ç¤º
              previewArea.innerHTML = `
                <iframe src="${blobUrl}#view=FitH" style="width:100%;height:85vh;border:none;background:white;"></iframe>
              `;
            } else if (fileType.includes('image') || fileName.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
              // åœ–ç‰‡é è¦½ - å…¨å±æ˜¾ç¤º
              previewArea.innerHTML = `
                <div style="width:100%;height:85vh;display:flex;align-items:center;justify-content:center;background:#f5f5f5;">
                  <img src="${blobUrl}" style="max-width:100%;max-height:100%;object-fit:contain;" />
                </div>
              `;
            } else {
              // å…¶ä»–æ–‡ä»¶é¡å‹ï¼Œé¡¯ç¤ºä¸‹è¼‰æç¤º
              previewArea.innerHTML = `
                <div style="text-align:center;padding:60px 20px;height:85vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f9fafb;">
                  <div style="font-size:64px;margin-bottom:20px;">ğŸ“„</div>
                  <h3 style="margin-bottom:12px;color:#374151;font-size:18px;">${fileName}</h3>
                  <p style="color:#9ca3af;margin-bottom:24px;font-size:13px;">æ­¤æ–‡ä»¶é¡å‹ä¸æ”¯æ´ç·šä¸Šé è¦½</p>
                  <button class="btn primary" onclick="downloadPunchRecord('${recordId}', '${fileName}')" style="text-decoration:none;">
                    <span>ğŸ’¾ ä¸‹è¼‰æ–‡ä»¶</span>
                  </button>
                </div>
              `;
            }
          } catch (err) {
            console.error('é è¦½æ–‡æª”å¤±æ•—:', err);
            previewArea.innerHTML = `
              <div style="text-align:center;padding:60px 20px;color:#c0392b;">
                <div style="font-size:48px;margin-bottom:16px;">âš ï¸</div>
                <div style="font-size:16px;font-weight:600;margin-bottom:8px;">è¼‰å…¥å¤±æ•—</div>
                <div style="font-size:13px;color:#6b7280;">${err.message}</div>
              </div>
            `;
          }
        };

        // ä¸‹è¼‰æ‰“å¡è¨˜éŒ„
        window.downloadPunchRecord = function(recordId, fileName) {
          // ç›´æ¥æ‰“é–‹ä¸‹è¼‰é€£çµ
          const downloadUrl = `${apiBase}/punch-records/${recordId}/download`;
          window.open(downloadUrl, '_blank');
        };

        // åˆªé™¤æ‰“å¡è¨˜éŒ„
        window.deletePunchRecord = async function(recordId) {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æª”æ¡ˆå—ï¼Ÿ')) return;

          try {
            const res = await fetch(`${apiBase}/punch-records/${recordId}`, {
              method: 'DELETE',
              credentials: 'include'
            });

            if (!res.ok) throw new Error('åˆªé™¤å¤±æ•—');

            alert('âœ… åˆªé™¤æˆåŠŸ');
            loadPunchRecords(currentUserId);
          } catch (err) {
            console.error('åˆªé™¤å¤±æ•—:', err);
            alert('åˆªé™¤å¤±æ•—ï¼š' + err.message);
          }
        };

        // åˆ·æ–°åˆ—è¡¨
        btnRefreshFiles.addEventListener('click', () => {
          if (currentUserId) {
            loadPunchRecords(currentUserId);
          }
        });

        // ç®¡ç†å“¡ï¼šåˆå§‹åŒ–å“¡å·¥é¸æ“‡å™¨
        async function initAdminPunchSelector() {
          console.log('[æ‰“å¡è¨˜éŒ„] åˆå§‹åŒ–ç®¡ç†å“¡æ¨¡å¼');
          isAdminMode = true;
          punchAdminTools.style.display = 'block';
          
          // æ›´æ–°å ä½æ–‡å­—
          punchFilesList.innerHTML = '<tr><td colspan="3" class="muted" style="padding: 2rem; text-align: center;">è«‹å…ˆé¸æ“‡å“¡å·¥</td></tr>';
          
          try {
            // ç²å–æ‰€æœ‰å“¡å·¥ï¼ˆå¾©ç”¨å…¨å±€çš„ empState.allUsers æˆ–é‡æ–°è¼‰å…¥ï¼‰
            let users = empState?.allUsers;
            if (!users || users.length === 0) {
              console.log('[æ‰“å¡è¨˜éŒ„] empState ç‚ºç©ºï¼Œé‡æ–°è¼‰å…¥å“¡å·¥åˆ—è¡¨');
              const res = await fetch(`${apiBase}/admin/users`, { credentials: 'include' });
              if (!res.ok) throw new Error('ç„¡æ³•è¼‰å…¥å“¡å·¥åˆ—è¡¨');
              const json = await res.json();
              users = json.data?.users || []; // æ³¨æ„ï¼šéœ€è¦å– .users
              console.log('[æ‰“å¡è¨˜éŒ„] API è¿”å›å“¡å·¥æ•¸æ“š:', users);
            }
            
            // å¡«å……é¸æ“‡å™¨ï¼ˆä½¿ç”¨æ­£ç¢ºçš„å­—æ®µåï¼šuserId å’Œ nameï¼‰
            punchUserSelect.innerHTML = '<option value="">è«‹é¸æ“‡å“¡å·¥...</option>';
            users.forEach(u => {
              const opt = document.createElement('option');
              opt.value = u.userId; // é©¼å³°å¼
              opt.textContent = `${u.name || u.username}`;
              punchUserSelect.appendChild(opt);
            });
            
            console.log('[æ‰“å¡è¨˜éŒ„] ç®¡ç†å“¡æ¨¡å¼å°±ç·’ï¼Œå…±', users.length, 'ä½å“¡å·¥');
          } catch (err) {
            console.error('[æ‰“å¡è¨˜éŒ„] åˆå§‹åŒ–å¤±æ•—:', err);
            alert('è¼‰å…¥å“¡å·¥åˆ—è¡¨å¤±æ•—ï¼š' + err.message);
            punchFilesList.innerHTML = '<tr><td colspan="3" class="muted" style="padding: 2rem; text-align: center; color: red;">è¼‰å…¥å¤±æ•—</td></tr>';
          }
        }

        // ç®¡ç†å“¡ï¼šé¸æ“‡å“¡å·¥æ™‚è¼‰å…¥å…¶æ‰“å¡è¨˜éŒ„
        punchUserSelect.addEventListener('change', (e) => {
          const userId = parseInt(e.target.value);
          if (userId) {
            console.log('[æ‰“å¡è¨˜éŒ„] ç®¡ç†å“¡é¸æ“‡å“¡å·¥:', userId);
            currentUserId = userId;
            loadPunchRecords(userId);
          } else {
            // æ¸…ç©ºåˆ—è¡¨
            punchFilesList.innerHTML = '<tr><td colspan="3" class="muted" style="padding: 2rem; text-align: center;">è«‹å…ˆé¸æ“‡å“¡å·¥</td></tr>';
          }
        });

        // é è¨­æœˆä»½ç‚ºæœ¬æœˆ
        const now = new Date();
        monthInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        const monthBonus = document.getElementById('monthBonus');
        if (monthBonus) monthBonus.value = monthInput.value;
        
        // é è¨­å¹´ä»½ç‚ºä»Šå¹´
        yearInput.value = now.getFullYear();

        // ç¶å®šäº‹ä»¶
        let timer = null;
        empSearchCalc.addEventListener('input', ()=>{ clearTimeout(timer); timer = setTimeout(applyCalcFilters, 300); });
        statusCalc.addEventListener('change', applyCalcFilters);
        monthInput.addEventListener('change', ()=>{ loadPreview(); checkFinalized(); });
        btnFinalize.addEventListener('click', finalizeMonth);
        
        // åˆ·æ–°æŒ‰éˆ•ï¼šå¼·åˆ¶é‡æ–°è¼‰å…¥è³‡æ–™
        document.getElementById('btnRefreshCalc').addEventListener('click', () => {
          console.log('[è–ªè³‡è¨ˆç®—] å¼·åˆ¶åˆ·æ–°è³‡æ–™');
          loadPreview(true); // forceRefresh = true
        });

        // åˆå§‹åŒ–ï¼ˆæ¥µç°¡ç‰ˆï¼‰
        switchTab('calc');
        
        ensureAdmin().then(result => { 
          if (result.isAdmin) {
            isAdminMode = true; // è¨­ç½®ç®¡ç†å“¡æ¨¡å¼
            loadPreview(); 
            checkFinalized(); 
            loadItems();
            loadUsers();
            
            // åˆå§‹åŒ–ç¸¾æ•ˆçé‡‘å¹´ä»½ä¸‹æ‹‰é¸å–®
            const currentYear = new Date().getFullYear();
            const yearOptions = [];
            for (let y = currentYear + 1; y >= currentYear - 5; y--) {
              yearOptions.push(`<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}å¹´</option>`);
            }
            yearBonusInput.innerHTML = yearOptions.join('');
            loadYearlyBonus(); // è¼‰å…¥å…¨å¹´ç¸¾æ•ˆçé‡‘
            
            loadYearEndBonus(); // è¼‰å…¥å¹´çµ‚çé‡‘
            loadSystemSettings(); // è¼‰å…¥ç³»çµ±è¨­å®š
            
            console.log('[åˆå§‹åŒ–] ç®¡ç†å“¡æ¨¡å¼å·²å•Ÿç”¨ï¼ˆæ‰“å¡è¨˜éŒ„å°‡åœ¨åˆ‡æ›åˆ°è©²TABæ™‚åˆå§‹åŒ–ï¼‰');
          } else if (result.userData) {
            // æ™®é€šå“¡å·¥ï¼šè¨­ç½®ç•¶å‰ç”¨æˆ¶IDï¼Œæ‰“å¡è¨˜éŒ„åœ¨åˆ‡æ›åˆ°è©²TABæ™‚è¼‰å…¥
            console.log('[åˆå§‹åŒ–] æ™®é€šå“¡å·¥ç™»å…¥');
            currentUserId = result.userData.user_id;
            isAdminMode = false;
          } 
        });
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


