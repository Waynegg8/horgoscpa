<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="薪資管理" />
    <title>薪資管理｜總覽</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/payroll-page.css" />
    
    <!-- ⚡ 預載入與快取系統 -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <!-- 預渲染系統已禁用（會干擾TAB切換） -->
    <!-- <script src="/assets/js/prerender.js"></script> -->
    <!-- <script src="/assets/js/page-prerender.js"></script> -->
  </head>
  <body class="payroll-page">
    <div style="padding:16px 20px;">
      <div id="infoBar" class="info-bar" style="display:none;" role="alert">您沒有權限存取此模組</div>
      <div class="payroll-toolbar" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
        <label for="month">月份</label>
        <input id="month" type="month" aria-label="月份" />
        <div class="toolbar-spacer" style="flex:1;"></div>
        <button id="btn-finalize" type="button" class="btn primary" disabled>產製月結</button>
      </div>
      <div id="finalizeMsg" class="info-bar" style="display:none;"></div>
      <nav class="payroll-tabs" role="tablist" aria-label="薪資管理分頁" style="display:flex;gap:8px;border-bottom:2px solid #e5e7eb;">
        <button class="tab active" role="tab" aria-selected="true" data-tab="calc" data-admin-only="true">薪資計算</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="items" data-admin-only="true">薪資項目設定</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="emp" data-admin-only="true">員工薪資設定</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="bonus" data-admin-only="true">績效獎金調整</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="yearend" data-admin-only="true">年終獎金</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="settings" data-admin-only="true">⚙️ 系統設定</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="punch">📁 打卡記錄上傳</button>
      </nav>
    </div>

    <main class="payroll-content">
      <!-- 薪資計算 -->
      <section id="panel-calc" class="panel" role="tabpanel" aria-labelledby="tab-calc">
        <div class="card">
          <div class="section-toolbar">
            <button id="btnRefreshCalc" class="btn btn-sm">
              🔄 刷新數據
            </button>
          </div>
          <table class="table" aria-label="薪資計算列表" style="font-size: 0.875rem;">
            <thead>
              <tr>
                <th rowspan="2" style="width: 40px;">明細</th>
                <th rowspan="2">姓名</th>
                <th rowspan="2">底薪</th>
                <th colspan="7" style="background: #f0fdf4; text-align: center;">收入明細</th>
                <th colspan="2" style="background: #fef2f2; text-align: center;">扣款明細</th>
                <th rowspan="2" style="background: #f0f9ff;">應發</th>
                <th rowspan="2" style="background: #dbeafe;">實發</th>
                <th rowspan="2" style="width: 80px;">打印</th>
              </tr>
              <tr>
                <th style="background: #f0fdf4;">津貼</th>
                <th style="background: #f0fdf4;">獎金</th>
                <th style="background: #f0fdf4;">全勤</th>
                <th style="background: #f0fdf4;">加班費<br><small style="font-weight:normal;font-size:0.75rem;">工時×時薪</small></th>
                <th style="background: #f0fdf4;">誤餐費<br><small style="font-weight:normal;font-size:0.75rem;">天數×單價</small></th>
                <th style="background: #f0fdf4;">交通<br><small style="font-weight:normal;font-size:0.75rem;">里程</small></th>
                <th style="background: #f0fdf4;">績效</th>
                <th style="background: #fef2f2;">固定<br><small style="font-weight:normal;font-size:0.75rem;">勞健保等</small></th>
                <th style="background: #fef2f2;">請假<br><small style="font-weight:normal;font-size:0.75rem;">病/事假</small></th>
              </tr>
            </thead>
            <tbody id="tbodyCalc">
              <tr><td colspan="14" class="muted">尚無資料</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- 薪資項目設定 -->
      <section id="panel-items" class="panel" role="tabpanel" aria-labelledby="tab-items">
        <div class="card">
          <div class="section-toolbar">
            <input id="itemSearch" type="search" placeholder="搜尋項目代碼/名稱…" />
            <button type="button" id="btnAddItem" class="btn primary">新增項目</button>
          </div>
          <table class="table" aria-label="薪資項目列表">
            <thead>
              <tr>
                <th>項目代碼</th>
                <th>項目名稱</th>
                <th>類別</th>
                <th>經常性給與</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="tbodyItems">
              <tr><td colspan="6" class="muted">載入中…</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- 新增/編輯薪資項目對話框 -->
      <dialog id="itemDialog" style="border-radius:12px;border:1px solid #e5e7eb;padding:0;width:90%;max-width:520px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);">
        <div style="padding:24px;border-bottom:1px solid #e5e7eb;background:#f9fafb;">
          <h3 id="itemDialogTitle" style="margin:0;font-size:20px;font-weight:600;color:#111827;">新增薪資項目</h3>
          <p style="margin:8px 0 0;font-size:14px;color:#6b7280;">設定薪資項目的基本資訊</p>
        </div>
        <form id="itemForm" style="padding:24px;">
          <input type="hidden" id="itemTypeId" />
          
          <input type="hidden" id="itemCode" />
          
          <div style="margin-bottom:20px;">
            <label for="itemName" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">
              項目名稱 <span style="color:#dc2626;">*</span>
            </label>
            <input id="itemName" type="text" required maxlength="50" placeholder="例如：伙食津貼、全勤獎金" 
              style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;" />
            <small style="color:#6b7280;display:block;margin-top:4px;">💡 輸入清楚易懂的名稱，方便員工識別</small>
          </div>

          <div style="margin-bottom:20px;">
            <label for="itemCategory" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">
              類別 <span style="color:#dc2626;">*</span>
            </label>
            <select id="itemCategory" required style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
              <option value="">-- 請選擇類別 --</option>
              <option value="allowance">💰 津貼（如：交通、伙食、電話）</option>
              <option value="bonus">🎁 獎金（如：全勤、績效、年終）</option>
              <option value="deduction">➖ 扣款（如：保費、遲到）</option>
            </select>
            <small style="color:#6b7280;display:block;margin-top:4px;">📋 依據項目性質選擇對應類別</small>
          </div>

          <div style="margin-bottom:20px;background:#f0f9ff;padding:16px;border-radius:8px;border:1px solid #bfdbfe;">
            <label style="display:flex;align-items:flex-start;cursor:pointer;margin-bottom:12px;">
              <input type="checkbox" id="itemIsRegular" style="margin-top:2px;margin-right:10px;width:18px;height:18px;" />
              <div>
                <span style="font-weight:500;color:#1e40af;">經常性給與（計入時薪基準）</span>
                <small style="color:#1e40af;display:block;margin-top:4px;line-height:1.5;">
                  ⚠️ <strong>重要：</strong>勾選後會計入時薪計算，影響加班費金額和成本分析<br>
                  ✓ 應勾選：固定津貼（伙食、交通）、全勤獎金<br>
                  ✗ 不勾選：績效獎金、年終獎金、三節獎金
                </small>
              </div>
            </label>
            
            <label style="display:flex;align-items:flex-start;cursor:pointer;padding-top:12px;border-top:1px solid #bfdbfe;">
              <input type="checkbox" id="itemIsPerformance" style="margin-top:2px;margin-right:10px;width:18px;height:18px;" />
              <div>
                <span style="font-weight:500;color:#1e40af;">用於績效獎金調整功能</span>
                <small style="color:#1e40af;display:block;margin-top:4px;line-height:1.5;">
                  📊 <strong>說明：</strong>勾選後，此項目會在「績效獎金調整」頁面顯示為預設值<br>
                  ✓ 建議用途：每月變動的績效獎金<br>
                  💡 只能有一個項目勾選此選項
                </small>
              </div>
            </label>
          </div>


          <div style="margin-bottom:20px;">
            <label for="itemDescription" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">說明（選填）</label>
            <textarea id="itemDescription" rows="3" maxlength="200" placeholder="例如：每月固定發放，用於補助員工伙食費用" 
              style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;resize:vertical;"></textarea>
            <small style="color:#6b7280;display:block;margin-top:4px;">可說明發放條件、計算方式等</small>
          </div>

          <div style="margin-bottom:20px;">
            <label for="itemDisplayOrder" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">顯示順序</label>
            <input id="itemDisplayOrder" type="number" min="0" value="99" 
              style="width:120px;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;" />
            <small style="color:#6b7280;display:block;margin-top:4px;">數字越小越靠前顯示，預設為 99</small>
          </div>

          <div id="itemErrorMsg" style="color:#dc2626;margin-bottom:16px;display:none;padding:12px;background:#fee;border-radius:6px;border:1px solid #fecaca;"></div>
          
          <div style="display:flex;gap:12px;justify-content:flex-end;padding-top:20px;border-top:1px solid #e5e7eb;">
            <button type="button" id="btnCancelItem" class="btn" style="min-width:100px;">取消</button>
            <button type="submit" class="btn primary" style="min-width:100px;">💾 儲存</button>
          </div>
        </form>
      </dialog>

      <!-- 員工薪資設定 -->
      <section id="panel-emp" class="panel" role="tabpanel" aria-labelledby="tab-emp">
        <div class="card grid">
          <div class="col">
            <div class="section-toolbar">
              <input id="empSearch" type="search" placeholder="搜尋員工…" />
            </div>
            <ul id="empList" class="list" aria-label="員工清單">
              <li class="muted">載入中...</li>
            </ul>
          </div>
          <div class="col">
            <div id="empFormContainer" style="display: none;">
              <h3 id="empFormTitle">請選擇員工</h3>
            <div class="form">
              <div class="row">
                  <label>底薪</label>
                  <input id="empBaseSalary" type="number" min="0" step="1" placeholder="例如 40000" />
                </div>
                <div class="row">
                  <label>備註</label>
                  <textarea id="empSalaryNotes" rows="2" placeholder="薪資備註"></textarea>
                </div>
                <hr />
                <div class="row">
                  <label>薪資項目</label>
                  <button id="btnAddEmpItem" class="btn btn-sm" type="button">➕ 新增項目</button>
                </div>
                <div id="empItemsList">
                  <small class="muted">尚無薪資項目</small>
                </div>
                <div class="row">
                  <small class="muted">💡 提示：勾選「經常性給與」將計入時薪，影響加班費與成本分析。</small>
              </div>
              <div class="actions">
                  <button id="btnCancelEmp" class="btn" type="button">取消</button>
                  <button id="btnSaveEmp" class="btn primary" type="button">💾 儲存</button>
              </div>
              </div>
            </div>
            <div id="empEmptyState" style="text-align: center; padding: 2rem; color: #999;">
              👈 請從左側選擇員工
            </div>
          </div>
        </div>
      </section>

      <!-- 績效獎金調整 -->
      <section id="panel-bonus" class="panel" role="tabpanel" aria-labelledby="tab-bonus">
        <div class="card" style="padding: 12px;">
          <div class="section-toolbar" style="margin-bottom: 10px;">
            <label for="yearBonus" style="font-size: 14px;">年度</label>
            <select id="yearBonus" style="width: 100px; padding: 4px 8px; font-size: 14px; border: 1px solid #d1d5db; border-radius: 4px;">
              <!-- 選項會由JS動態生成 -->
            </select>
            <div class="toolbar-spacer"></div>
            <div id="bonusSummary" class="stats" style="font-size: 13px;">
              <span>調整：<strong id="bonusAdjustedCount">0</strong> 人次</span>
          </div>
            <button id="btnSaveBonus" class="btn primary" style="font-size: 13px; padding: 5px 12px;">💾 儲存</button>
          </div>
          <div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 6px;">
            <table class="table" aria-label="績效獎金調整" style="margin: 0; font-size: 13px; width: 100%;">
            <thead>
              <tr>
                  <th rowspan="2" style="position: sticky; left: 0; background: white; z-index: 2; width: 80px; padding: 6px 8px;">姓名</th>
                  <th colspan="12" style="text-align: center; background: #f0f9ff; padding: 6px 8px;">各月份績效（元）</th>
                </tr>
                <tr>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">1月</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">2月</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">3月</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">4月</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">5月</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">6月</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">7月</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">8月</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">9月</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">10月</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">11月</th>
                  <th style="background: #f0f9ff; width: 80px; padding: 6px 8px; font-size: 12px;">12月</th>
              </tr>
            </thead>
              <tbody id="tbodyBonus">
                <tr><td colspan="13" class="muted" style="padding: 2rem; text-align: center;">載入中...</td></tr>
            </tbody>
          </table>
          </div>
          <div class="muted" style="margin-top: 8px; font-size: 12px;">
            💡 留空使用預設績效；輸入金額則使用調整後的金額
          </div>
        </div>
      </section>

      <!-- 年終獎金管理 -->
      <section id="panel-yearend" class="panel" role="tabpanel" aria-labelledby="tab-yearend">
        <div class="card">
          <div class="section-toolbar">
            <label for="yearInput">年度</label>
            <input id="yearInput" type="number" min="2000" max="2100" step="1" />
            <div class="toolbar-spacer"></div>
            <div id="yearendStats" class="stats">
              <span>總額：—</span><span>人數：—</span><span>平均：—</span>
            </div>
            <button id="btnSaveYearend" class="btn primary">💾 儲存</button>
          </div>
          <table class="table" aria-label="年終獎金">
            <thead>
              <tr>
                <th>姓名</th>
                <th>底薪</th>
                <th>年終金額</th>
                <th>發放月份</th>
                <th>備註</th>
              </tr>
            </thead>
            <tbody id="tbodyYearend">
              <tr><td colspan="5" class="muted">載入中...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- 系統設定 -->
      <section id="panel-settings" class="panel" role="tabpanel" aria-labelledby="tab-settings">
        <div class="card" style="max-width: 1000px; margin: 0 auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
              <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600;">⚙️ 薪資計算系統設定</h2>
              <p style="margin: 0.5rem 0 0; color: #666; font-size: 0.875rem;">調整薪資計算的核心參數</p>
            </div>
            <button id="btnSaveSettings" class="btn primary">💾 儲存所有設定</button>
          </div>

          <!-- 誤餐費設定 -->
          <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin: 0 0 1rem; font-size: 1.125rem; font-weight: 600; color: #166534;">🍱 誤餐費設定</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">誤餐費單價（元/次）</label>
                <input id="setting_meal_allowance_per_time" type="number" min="0" step="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">平日加班滿條件時發放的誤餐費金額</small>
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">最低加班時數（小時）</label>
                <input id="setting_meal_allowance_min_overtime_hours" type="number" min="0" step="0.5" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">達到此加班時數才發放誤餐費</small>
              </div>
            </div>
          </div>

          <!-- 交通補貼設定 -->
          <div style="background: #eff6ff; border: 1px solid #93c5fd; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin: 0 0 1rem; font-size: 1.125rem; font-weight: 600; color: #1e40af;">🚗 交通補貼設定（區間制）</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">每個區間公里數</label>
                <input id="setting_transport_km_per_interval" type="number" min="1" step="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">例如：5 公里為 1 個區間</small>
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">每個區間金額（元）</label>
                <input id="setting_transport_amount_per_interval" type="number" min="0" step="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">例如：每區間 60 元</small>
              </div>
              <div style="display: flex; align-items: center; color: #666;">
                <p style="margin: 0;">💡 範例：6-10公里 = 2個區間 = 120元</p>
              </div>
            </div>
          </div>

          <!-- 請假扣款設定 -->
          <div style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin: 0 0 1rem; font-size: 1.125rem; font-weight: 600; color: #991b1b;">📅 請假扣款設定</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">病假扣款比例</label>
                <input id="setting_sick_leave_deduction_rate" type="number" min="0" max="1" step="0.1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">1.0 = 全額扣除，0.5 = 扣除50%</small>
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">事假扣款比例</label>
                <input id="setting_personal_leave_deduction_rate" type="number" min="0" max="1" step="0.1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">通常為 1.0（全額扣除）</small>
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">日薪計算除數</label>
                <input id="setting_leave_daily_salary_divisor" type="number" min="1" step="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">日薪 = 底薪 ÷ 此數字（通常為30）</small>
              </div>
            </div>
          </div>

          <!-- 時薪計算設定 -->
          <div style="background: #f5f3ff; border: 1px solid #c4b5fd; border-radius: 8px; padding: 1.5rem;">
            <h3 style="margin: 0 0 1rem; font-size: 1.125rem; font-weight: 600; color: #5b21b6;">🧮 時薪計算設定</h3>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">時薪計算除數</label>
                <input id="setting_hourly_rate_divisor" type="number" min="1" step="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">依勞基法為 240 小時/月</small>
              </div>
              <div style="display: flex; align-items: center; color: #666;">
                <p style="margin: 0;">📌 時薪 = (底薪 + 經常性給與) ÷ 除數，用於計算加班費基準</p>
              </div>
            </div>
          </div>

          <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
            <p style="margin: 0; color: #92400e; font-size: 0.875rem;">
              ⚠️ <strong>重要提示：</strong>修改這些設定會影響所有未來的薪資計算。建議在月初或測試環境中調整，確認無誤後再套用。
            </p>
          </div>
        </div>
      </section>

      <!-- 打卡記錄上傳 -->
      <section id="panel-punch" class="panel" role="tabpanel" aria-labelledby="tab-punch">
        <!-- 左右分栏布局 -->
        <div style="display: grid; grid-template-columns: 450px 1fr; gap: 16px;">
          <!-- 左側：上傳表單和檔案列表 -->
          <div>
            <div class="card" style="padding: 1.5rem;">
              <div style="margin-bottom: 1.5rem;">
                <h2 style="margin: 0 0 0.5rem; font-size: 1.25rem; font-weight: 600;">📁 打卡記錄上傳</h2>
                <p style="margin: 0; color: #666; font-size: 0.875rem;">上傳每月打卡記錄</p>
              </div>

              <!-- 上傳區域 -->
              <div style="background: #f0f9ff; border: 2px dashed #3b82f6; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center;">
                <input type="file" id="punchFileInput" style="display: none;" accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png,.zip" />
                <button id="btnSelectFile" class="btn primary" style="font-size: 0.875rem; padding: 0.5rem 1.5rem;">
                  📎 選擇檔案
                </button>
                <p style="margin: 0.75rem 0 0; color: #666; font-size: 0.75rem;">
                  支援：PDF、Excel、圖片、ZIP<br/>單檔最大 10MB
                </p>
              </div>

              <!-- 上傳表單 -->
              <div id="uploadForm" style="display: none; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                <div style="margin-bottom: 0.75rem;">
                  <strong style="font-size: 0.875rem;">已選擇：</strong> <span id="selectedFileName" style="font-size: 0.875rem;"></span>
                </div>
                <div style="margin-bottom: 0.75rem;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">所屬月份 <span style="color: red;">*</span></label>
                  <input type="month" id="punchMonth" required style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;" />
                </div>
                <div style="margin-bottom: 1rem;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">備註</label>
                  <input type="text" id="punchNotes" placeholder="例如：補傳10月資料" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;" />
                </div>
                <div style="display: flex; gap: 0.75rem;">
                  <button id="btnUploadFile" class="btn primary" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                    ⬆️ 上傳
                  </button>
                  <button id="btnCancelUpload" class="btn" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                    取消
                  </button>
                </div>
                <div id="uploadProgress" style="display: none; margin-top: 0.75rem;">
                  <div style="background: #e5e7eb; border-radius: 4px; height: 6px; overflow: hidden;">
                    <div id="uploadProgressBar" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s;"></div>
                  </div>
                  <p style="margin: 0.5rem 0 0; color: #666; font-size: 0.75rem;" id="uploadStatus">上傳中...</p>
                </div>
              </div>

              <!-- 員工選擇器（管理員專用） -->
              <div id="punchAdminTools" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem; color: #1e40af;">
                  👤 選擇員工
                </label>
                <select id="punchUserSelect" style="width: 100%; padding: 0.5rem; border: 1px solid #93c5fd; border-radius: 6px; font-size: 0.875rem; background: white;">
                  <option value="">請選擇員工...</option>
                </select>
              </div>

              <!-- 已上傳檔案列表 -->
              <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                  <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">📋 已上傳記錄</h3>
                  <button id="btnRefreshFiles" class="btn" style="font-size: 0.75rem; padding: 0.375rem 0.75rem;">
                    🔄 刷新
                  </button>
                </div>
                <div style="max-height: 500px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                  <table class="table" aria-label="打卡記錄列表" style="margin: 0; font-size: 0.875rem;">
                    <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                      <tr>
                        <th style="padding: 0.5rem;">月份</th>
                        <th style="padding: 0.5rem;">檔案</th>
                        <th style="padding: 0.5rem; width: 100px;">操作</th>
                      </tr>
                    </thead>
                    <tbody id="punchFilesList">
                      <tr><td colspan="3" class="muted" style="padding: 2rem; text-align: center;">切換到此分頁後載入...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- 右側：預覽區域 -->
          <div>
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; height: 100%;">
              <div id="punchPreviewArea" style="min-height: 85vh; display: flex; align-items: center; justify-content: center; background: #f9fafb;">
                <div style="text-align: center; max-width: 400px; padding: 40px 20px; color: #6b7280;">
                  <div style="font-size: 64px; margin-bottom: 16px;">📄</div>
                  <p style="font-size: 18px; font-weight: 600; color: #374151; margin-bottom: 8px;">點擊左側檔案查看預覽</p>
                  <p style="font-size: 14px;">支援線上預覽 PDF、圖片等格式</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const infoBar = document.getElementById('infoBar');
        const finalizeMsg = document.getElementById('finalizeMsg');
        const tabs = Array.from(document.querySelectorAll('.payroll-tabs .tab'));
        const panels = {
          calc: document.getElementById('panel-calc'),
          items: document.getElementById('panel-items'),
          emp: document.getElementById('panel-emp'),
          bonus: document.getElementById('panel-bonus'),
          yearend: document.getElementById('panel-yearend'),
          settings: document.getElementById('panel-settings'),
          punch: document.getElementById('panel-punch'),
        };

        // 薪資項目設定相關 DOM
        const tbodyItems = document.getElementById('tbodyItems');
        const itemSearch = document.getElementById('itemSearch');
        const btnAddItem = document.getElementById('btnAddItem');
        const itemDialog = document.getElementById('itemDialog');
        const itemDialogTitle = document.getElementById('itemDialogTitle');
        const itemForm = document.getElementById('itemForm');
        const btnCancelItem = document.getElementById('btnCancelItem');
        const itemErrorMsg = document.getElementById('itemErrorMsg');

        // 薪資項目狀態
        const itemsState = { all: [], filtered: [] };

        // 員工薪資設定相關 DOM
        const empList = document.getElementById('empList');
        const empSearch = document.getElementById('empSearch');
        const empFormContainer = document.getElementById('empFormContainer');
        const empEmptyState = document.getElementById('empEmptyState');
        const empFormTitle = document.getElementById('empFormTitle');
        const empBaseSalary = document.getElementById('empBaseSalary');
        const empSalaryNotes = document.getElementById('empSalaryNotes');
        const empItemsList = document.getElementById('empItemsList');
        const btnAddEmpItem = document.getElementById('btnAddEmpItem');
        const btnCancelEmp = document.getElementById('btnCancelEmp');
        const btnSaveEmp = document.getElementById('btnSaveEmp');

        // 員工薪資狀態
        const empState = { 
          allUsers: [], 
          filteredUsers: [],
          selectedUserId: null,
          currentUserData: null,
          userSalaryItems: [] 
        };

        // 計算相關 DOM
        const tbodyCalc = document.getElementById('tbodyCalc');
        const monthInput = document.getElementById('month');
        const btnFinalize = document.getElementById('btn-finalize');

        // 計算狀態（移除分頁）
        const calcState = { all: [], filtered: [] };

        function setTabsEnabled(enabled){
          tabs.forEach(b=>{ b.disabled = !enabled; });
          // 只禁用特定的工具栏控制元素，不影响绩效奖金等功能的输入框
          document.querySelectorAll('.payroll-toolbar .btn, #month, #empSearch, #itemSearch').forEach(el=>{ el.disabled = !enabled; });
          // 注意：不禁用 .bonus-input 和 #yearBonus
        }

        // 打卡記錄是否已初始化（避免重複初始化）
        let punchRecordsInitialized = false;

        // TAB切換 - 最終方案（使用inline style，優先級最高）
        function switchTab(targetKey) {
          console.log('[TAB切換]', targetKey);
          
          // 更新TAB按鈕狀態
          tabs.forEach(btn => {
            const isActive = btn.getAttribute('data-tab') === targetKey;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-selected', isActive);
          });
          
          // 直接使用style.display切換面板（優先級最高，不會被覆蓋）
          panels.calc.style.display = (targetKey === 'calc') ? 'block' : 'none';
          panels.items.style.display = (targetKey === 'items') ? 'block' : 'none';
          panels.emp.style.display = (targetKey === 'emp') ? 'block' : 'none';
          panels.bonus.style.display = (targetKey === 'bonus') ? 'block' : 'none';
          panels.yearend.style.display = (targetKey === 'yearend') ? 'block' : 'none';
          panels.settings.style.display = (targetKey === 'settings') ? 'block' : 'none';
          panels.punch.style.display = (targetKey === 'punch') ? 'block' : 'none';
          
          // 當切換到打卡記錄TAB時，首次進行初始化
          if (targetKey === 'punch' && !punchRecordsInitialized) {
            console.log('[打卡記錄] 首次切換到此TAB，進行初始化');
            punchRecordsInitialized = true;
            
            if (isAdminMode) {
              // 管理員：初始化員工選擇器
              initAdminPunchSelector();
            } else if (currentUserId) {
              // 普通員工：直接載入記錄
              loadPunchRecords(currentUserId);
            }
          }
        }
        
        // 使用事件委託綁定TAB點擊
        document.querySelector('.payroll-tabs').addEventListener('click', (e) => {
          const tab = e.target.closest('.tab');
          if (tab && !tab.disabled) {
            switchTab(tab.getAttribute('data-tab'));
          }
        });
        
        // 初始化：默認顯示第一個TAB
        switchTab('calc');

        async function ensureAdmin(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { 
              console.log('[權限檢查] 未登入，重定向到登入頁');
              location.assign('/login?redirect=/internal/payroll'); 
              return { isAdmin: false, userData: null }; 
            }
            const json = await res.json();
            console.log('[權限檢查] API 回應:', json);
            
            if (!json || !json.ok || !json.data) {
              console.error('[權限檢查] API 回應失敗:', json);
              infoBar.textContent = 'API 回應失敗：' + (json?.message || '未知錯誤');
              infoBar.style.display = 'block';
              setTabsEnabled(false);
              return { isAdmin: false, userData: null };
            }
            
            const userData = json.data;
            const isAdmin = userData.isAdmin === true;
            
            console.log('[權限檢查] 用戶資料:', {
              username: userData.username,
              name: userData.name,
              isAdmin: isAdmin
            });
            
            // 根據權限控制TAB顯示
            tabs.forEach(tab => {
              const adminOnly = tab.getAttribute('data-admin-only') === 'true';
              if (adminOnly && !isAdmin) {
                tab.style.display = 'none'; // 隱藏管理員專用TAB
              } else {
                tab.style.display = ''; // 顯示TAB
              }
            });
            
            if (isAdmin) {
              console.log('[權限檢查] ✅ 管理員驗證通過');
            setTabsEnabled(true);
              return { isAdmin: true, userData };
            } else {
              console.log('[權限檢查] 👤 普通員工，只能存取打卡記錄上傳');
              // 普通員工：切換到打卡記錄TAB
              switchTab('punch');
              setTabsEnabled(true);
              return { isAdmin: false, userData };
            }
          } catch (err) {
            console.error('[權限檢查] 異常:', err);
            infoBar.textContent = '載入失敗：' + err.message;
            infoBar.style.display = 'block';
            setTabsEnabled(false);
            return { isAdmin: false, userData: null };
          }
        }
        function setFinalizeUIDisabled(disabled){
          btnFinalize.disabled = disabled;
        }

        function setFinalizeMsg(type, text){
          if (!text) { finalizeMsg.style.display='none'; return; }
          finalizeMsg.textContent = text;
          finalizeMsg.style.display = 'block';
        }

        async function checkFinalized(){
          setFinalizeMsg('', '');
          try {
            const m = monthInput.value;
            const res = await fetch(`${apiBase}/admin/payroll?month=${encodeURIComponent(m)}`, { credentials:'include' });
            if (res.status === 200){
              const json = await res.json();
              const runId = json?.data?.runId;
              setFinalizeMsg('info', `本月已產製（Run: ${runId}）`);
              setFinalizeUIDisabled(true);
              return true;
            }
            if (res.status === 404){
              setFinalizeMsg('', '');
              setFinalizeUIDisabled(false);
              return false;
            }
            // 其他錯誤
            setFinalizeMsg('error', '查詢月結狀態失敗');
            setFinalizeUIDisabled(false);
            return false;
          } catch(_){
            setFinalizeMsg('error', '查詢月結狀態失敗');
            setFinalizeUIDisabled(false);
            return false;
          }
        }

        function genIdk(){
          return 'idk_' + Date.now() + '_' + Math.random().toString(36).slice(2,10);
        }

        async function finalizeMonth(){
          setFinalizeMsg('', '');
          const m = monthInput.value;
          btnFinalize.disabled = true;
          try {
            const res = await fetch(`${apiBase}/admin/payroll/finalize`, {
              method:'POST', credentials:'include', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ month: m, idempotency_key: genIdk() })
            });
            const json = await res.json().catch(()=>({}));
            if (res.status === 201 && json?.ok){
              setFinalizeMsg('success', `已產製完成（Run: ${json.data?.runId}）`);
              btnFinalize.disabled = true;
              return;
            }
            if (res.status === 409){
              setFinalizeMsg('info', `該月份已產製（Run: ${json?.data?.runId || ''}）`);
              btnFinalize.disabled = true;
              return;
            }
            if (res.status === 401){ location.assign('/login?redirect=/internal/payroll'); return; }
            if (res.status === 403){ setTabsEnabled(false); setFinalizeMsg('error', '沒有權限'); return; }
            setFinalizeMsg('error', json?.message || '產製失敗');
            btnFinalize.disabled = false;
          } catch (_){
            setFinalizeMsg('error', '產製失敗');
            btnFinalize.disabled = false;
          }
        }


        function centsToTwd(n){
          const v = Number(n || 0) / 100;
          return 'NT$ ' + v.toLocaleString();
        }

        // 生成详细明细HTML
        function generateDetailRow(r, rowId) {
          const hourlyRate = centsToTwd(r.hourlyRateCents || 0).replace('NT$ ', '');
          const hourlyRateNum = (r.hourlyRateCents || 0) / 100;
          
          // 📚 加班費計算規則總覽（折疊式）
          let rulesHtml = `
            <details style="margin-bottom: 15px; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
              <summary style="cursor: pointer; font-weight: 700; font-size: 1.1em; user-select: none; padding: 8px;">
                📚 加班費計算規則總覽（點擊展開/收合）
              </summary>
              <div style="margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.95); border-radius: 6px; color: #1f2937; font-size: 0.9em; line-height: 1.6;">
                
                <div style="margin-bottom: 15px; padding: 10px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 4px;">
                  <strong style="color: #1e40af; font-size: 1.05em;">🧮 時薪計算公式</strong><br>
                  <span style="color: #1e3a8a;">時薪 = (基本薪資 + 經常性給付) ÷ 240小時</span><br>
                  <span style="color: #6b7280; font-size: 0.9em;">經常性給付：職務加給、伙食津貼等每月固定發放的項目</span>
                </div>
                
                <div style="margin-bottom: 12px;">
                  <strong style="color: #1e40af; font-size: 1.05em;">📋 加班類型與倍率</strong>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                  <thead>
                    <tr style="background: #f3f4f6;">
                      <th style="padding: 8px; text-align: left; border: 1px solid #d1d5db;">類型</th>
                      <th style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">倍率</th>
                      <th style="padding: 8px; text-align: left; border: 1px solid #d1d5db;">說明</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr style="background: #e0f2fe;">
                      <td style="padding: 8px; border: 1px solid #d1d5db;">平日加班（前2h）</td>
                      <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; font-weight: 600;">1.34倍</td>
                      <td style="padding: 8px; border: 1px solid #d1d5db;">勞基法第24條：加給1/3以上</td>
                    </tr>
                    <tr>
                      <td style="padding: 8px; border: 1px solid #d1d5db;">平日加班（後2h）</td>
                      <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; font-weight: 600;">1.67倍</td>
                      <td style="padding: 8px; border: 1px solid #d1d5db;">勞基法第24條：加給2/3以上</td>
                    </tr>
                    <tr style="background: #fef3c7;">
                      <td style="padding: 8px; border: 1px solid #d1d5db;">休息日（前2h）</td>
                      <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; font-weight: 600;">1.34倍</td>
                      <td style="padding: 8px; border: 1px solid #d1d5db;">勞基法第24條：加給1/3以上</td>
                    </tr>
                    <tr style="background: #fef3c7;">
                      <td style="padding: 8px; border: 1px solid #d1d5db;">休息日（3-8h）</td>
                      <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; font-weight: 600;">1.67倍</td>
                      <td style="padding: 8px; border: 1px solid #d1d5db;">勞基法第24條：加給2/3以上</td>
                    </tr>
                    <tr style="background: #fef3c7;">
                      <td style="padding: 8px; border: 1px solid #d1d5db;">休息日（9-12h）</td>
                      <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; font-weight: 600;">2.67倍</td>
                      <td style="padding: 8px; border: 1px solid #d1d5db;">勞基法第24條：加給5/3以上</td>
                    </tr>
                    <tr style="background: #fef2f2;">
                      <td style="padding: 8px; border: 1px solid #d1d5db;"><strong>國定假日（8h內）⭐</strong></td>
                      <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; font-weight: 600; color: #dc2626;">1.0倍</td>
                      <td style="padding: 8px; border: 1px solid #d1d5db;"><strong style="color: #dc2626;">不論工時，固定8h加權+8h補休</strong></td>
                    </tr>
                    <tr>
                      <td style="padding: 8px; border: 1px solid #d1d5db;">國定假日（9-10h）</td>
                      <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; font-weight: 600;">1.34倍</td>
                      <td style="padding: 8px; border: 1px solid #d1d5db;">按平日延長工時計算</td>
                    </tr>
                    <tr>
                      <td style="padding: 8px; border: 1px solid #d1d5db;">國定假日（11-12h）</td>
                      <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; font-weight: 600;">1.67倍</td>
                      <td style="padding: 8px; border: 1px solid #d1d5db;">按平日延長工時計算</td>
                    </tr>
                    <tr style="background: #fee2e2;">
                      <td style="padding: 8px; border: 1px solid #d1d5db;"><strong>例假日（8h內）⭐⭐</strong></td>
                      <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; font-weight: 600; color: #dc2626;">1.0倍</td>
                      <td style="padding: 8px; border: 1px solid #d1d5db;"><strong style="color: #dc2626;">固定8h加權+8h補休+8h補假</strong></td>
                    </tr>
                    <tr style="background: #fee2e2;">
                      <td style="padding: 8px; border: 1px solid #d1d5db;">例假日（9-12h）</td>
                      <td style="padding: 8px; text-align: center; border: 1px solid #d1d5db; font-weight: 600; color: #dc2626;">1.0倍</td>
                      <td style="padding: 8px; border: 1px solid #d1d5db;">每小時加倍發給</td>
                    </tr>
                  </tbody>
                </table>
                
                <div style="margin-top: 15px; padding: 10px; background: #fef2f2; border-left: 4px solid #dc2626; border-radius: 4px;">
                  <strong style="color: #991b1b;">⚠️ 重要說明</strong><br>
                  <ul style="margin: 8px 0; padding-left: 20px; color: #7f1d1d;">
                    <li><strong>"加倍發給"不是2倍加班費！</strong>是指總共給2日工資（原本1日+加班1日），但月薪已含原本1日，所以加班費只計算額外1日。</li>
                    <li><strong>國定假日/例假日8h內：</strong>即使只工作1小時，也必須給付完整8h加權+8h補休（保護勞工休息權）。</li>
                    <li><strong>例假日出勤：</strong>僅限天災、事變或突發事件，且必須額外給1日補假（共16h補休）。</li>
                    <li><strong>多客戶成本核算：</strong>同一天服務多個客戶時，雖然分多筆記錄，但固定8h加權按比例分配。</li>
                  </ul>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: #ecfdf5; border-left: 4px solid #10b981; border-radius: 4px;">
                  <strong style="color: #065f46;">💡 補休使用規則</strong><br>
                  <span style="color: #047857;">
                    • 補休採FIFO（先進先出）：從最早的加班記錄開始扣除<br>
                    • 使用補休的部分不計入加班費，未使用的轉換為加班費發放<br>
                    • 國定假日/例假日8h內類型，補休按比例分配給各筆記錄
                  </span>
                </div>
                
              </div>
            </details>
          `;
          
          // 時薪計算基礎
          let hourlyRateBaseHtml = rulesHtml + `<div style="margin-bottom: 10px;"><strong>時薪計算基礎：</strong></div>`;
          hourlyRateBaseHtml += `<div style="margin-left: 10px;">底薪: ${centsToTwd(r.baseSalaryCents)}</div>`;
          if (r.hourlyRateBaseItems && r.hourlyRateBaseItems.length > 0) {
            r.hourlyRateBaseItems.forEach(item => {
              hourlyRateBaseHtml += `<div style="margin-left: 10px;">${item.name}: ${centsToTwd(item.amountCents)}</div>`;
            });
          }
          const totalBase = r.baseSalaryCents + r.regularAllowanceCents;
          hourlyRateBaseHtml += `<div style="margin-left: 10px; margin-top: 5px; font-weight: 600;">合計: ${centsToTwd(totalBase)} ÷ 240 = ${hourlyRate}</div>`;
          
          // 津貼及獎金明細（本月發放）
          let allowancesHtml = '<div style="margin-bottom: 10px; margin-top: 15px;"><strong>津貼及獎金明細：</strong></div>';
          const allowanceItems = [];
          const bonusItems = [];
          
          // 分類津貼和獎金
          if (r.allowanceItems && r.allowanceItems.length > 0) {
            r.allowanceItems.forEach(item => {
              if (item.category === 'allowance') {
                allowanceItems.push(item);
              } else if (item.category === 'bonus') {
                bonusItems.push(item);
              }
            });
          }
          
          if (allowanceItems.length > 0 || bonusItems.length > 0) {
            allowancesHtml += '<div style="margin-left: 10px;">';
            
            let totalAllowancesCents = 0;
            
            if (allowanceItems.length > 0) {
              allowancesHtml += '<div style="margin-bottom: 8px;"><strong style="color: #059669;">📊 津貼：</strong></div>';
              allowanceItems.forEach(item => {
                const isRegular = item.isRegularPayment ? '<span style="color: #3b82f6; font-size: 0.85em;"> (經常性給與)</span>' : '';
                allowancesHtml += `<div style="margin-left: 20px;">• ${item.name}: ${centsToTwd(item.amountCents)}${isRegular}</div>`;
                totalAllowancesCents += item.amountCents || 0;
              });
            }
            
            if (bonusItems.length > 0) {
              allowancesHtml += '<div style="margin-bottom: 8px; margin-top: 8px;"><strong style="color: #f59e0b;">🎁 獎金：</strong></div>';
              bonusItems.forEach(item => {
                const isRegular = item.isRegularPayment ? '<span style="color: #3b82f6; font-size: 0.85em;"> (經常性給與)</span>' : '';
                const isFullAttendancePaid = !item.isFullAttendanceBonus || r.isFullAttendance; // 不是全勤奖金，或者全勤达标
                const fullAttendanceNote = item.isFullAttendanceBonus ? 
                  (r.isFullAttendance ? 
                    '<span style="color: #16a34a; font-size: 0.85em;"> ✓ 全勤達標，發放</span>' : 
                    '<span style="color: #dc2626; font-size: 0.85em;"> ✗ 未達全勤，不發放</span>') : '';
                allowancesHtml += `<div style="margin-left: 20px;">• ${item.name}: ${centsToTwd(item.amountCents)}${isRegular}${fullAttendanceNote}</div>`;
                
                // 只有发放的奖金才计入小计
                if (isFullAttendancePaid) {
                  totalAllowancesCents += item.amountCents || 0;
                }
              });
            }
            
            allowancesHtml += `<div style="margin-left: 10px; margin-top: 8px; font-weight: 600; color: #059669;">小計: ${centsToTwd(totalAllowancesCents)}</div>`;
            allowancesHtml += '</div>';
          } else {
            allowancesHtml += '<div style="margin-left: 10px; color: #9ca3af;">本月無津貼或獎金</div>';
          }
          
          // 加班費明細
          console.log('[DEBUG] 加班費詳細數據:', JSON.stringify(r.dailyOvertime, null, 2));
          let overtimeHtml = '<div style="margin-bottom: 10px; margin-top: 15px;"><strong>加班費明細：</strong></div>';
          if (r.dailyOvertime && r.dailyOvertime.length > 0) {
            overtimeHtml += '<div style="margin-left: 10px;">';
            r.dailyOvertime.forEach(day => {
              const dayDate = day.date;
              const dayOfWeek = day.dayOfWeek || '';
              const holidayName = day.holidayName || '';
              const dateDisplay = holidayName ? `${dayDate} (周${dayOfWeek}，${holidayName})` : `${dayDate} (周${dayOfWeek})`;
              
              if (day.items && day.items.length > 0) {
                overtimeHtml += `<div style="margin-bottom: 8px;"><strong>${dateDisplay}</strong></div>`;
                
                // 检查是否有fixed_8h类型的记录，如果有且有多条，显示合计说明
                const fixedTypeItems = day.items.filter(item => item.isFixedType);
                if (fixedTypeItems.length > 1 && fixedTypeItems[0].totalDailyHours) {
                  const totalDailyHours = fixedTypeItems[0].totalDailyHours;
                  const isRestDay = fixedTypeItems[0].workTypeId === 10; // 例假日
                  const compHours = isRestDay ? '16h' : '8h';
                  const lawArticle = isRestDay ? '第40條' : '第39條';
                  
                  overtimeHtml += `<div style="margin-left: 20px; margin-bottom: 10px; padding: 8px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 6px; font-size: 0.9em;">`;
                  overtimeHtml += `<strong style="color: #92400e;">⚠️ ${fixedTypeItems[0].workType}規則說明：</strong><br>`;
                  overtimeHtml += `<span style="color: #78350f;">當天共工作 <strong>${totalDailyHours}h</strong>（分${fixedTypeItems.length}筆記錄，用於客戶成本核算）<br>`;
                  overtimeHtml += `依勞基法${lawArticle}：不論實際工時，統一給付 <strong>2日工資</strong>（原本1日+加班1日）`;
                  if (isRestDay) {
                    overtimeHtml += ` + <strong style="color: #dc2626;">另給1日補休</strong>`;
                  }
                  overtimeHtml += `<br>`;
                  overtimeHtml += `月薪已含原本1日，加班費計算：<strong>8h×1倍=8h加權工時</strong> + <strong>${compHours}補休</strong><br>`;
                  overtimeHtml += `以下各筆記錄按比例分配補休時數</span>`;
                  overtimeHtml += `</div>`;
                }
                
                day.items.forEach(item => {
                  // 安全检查：确保所有必要字段存在
                  if (!item || !item.workType) {
                    console.warn('[加班費明細] 跳過無效記錄:', item);
                    return;
                  }
                  
                  // 根据工作类型ID获取规则说明
                  const ruleMap = {
                    2: '勞基法第24條：平日延長工時第1-2小時，加給1/3以上',
                    3: '勞基法第24條：平日延長工時第3-4小時，加給2/3以上',
                    4: '勞基法第24條：休息日前2小時，加給1/3以上',
                    5: '勞基法第24條：休息日第3-8小時，加給2/3以上',
                    6: '勞基法第24條：休息日第9-12小時，加給5/3以上',
                    7: '勞基法第39條：國定假日出勤，加倍發給工資（原本1日+加班1日=共2日），月薪已含原本1日，加班費計算額外1日',
                    8: '勞基法第24條：國定假日超過8h部分，按平日延長工時計算（1.34倍）',
                    9: '勞基法第24條：國定假日超過10h部分，按平日延長工時計算（1.67倍）',
                    10: '勞基法第40條：例假日出勤，加倍發給工資（原本1日+加班1日=共2日），月薪已含原本1日，加班費計算額外1日',
                    11: '勞基法第40條：例假日超過8h部分，每小時加倍發給（原本1+加班1=共2），月薪已含原本1，加班費計算額外1'
                  };
                  
                  const rule = ruleMap[item.workTypeId] || '';
                  const borderColor = item.workTypeId >= 10 ? '#dc2626' : (item.workTypeId >= 7 ? '#f59e0b' : '#3b82f6');
                  const multiplier = item.multiplier || 1.0;
                  const originalHours = item.originalHours || 0;
                  
                  overtimeHtml += `<div style="margin-left: 20px; margin-bottom: 8px; padding: 8px; background: #f9fafb; border-left: 3px solid ${borderColor}; font-size: 0.9em;">`;
                  
                  // 第一行：工作类型
                  overtimeHtml += `<div style="display: flex; justify-content: space-between; align-items: center;">`;
                  overtimeHtml += `<strong style="color: #1f2937;">${item.workType}</strong>`;
                  overtimeHtml += `<span style="background: ${borderColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.85em; font-weight: 600;">${multiplier}倍</span>`;
                  overtimeHtml += `</div>`;
                  
                  // 第二行：法规依据
                  if (rule) {
                    overtimeHtml += `<div style="color: #6b7280; font-size: 0.85em; margin-top: 3px; padding: 3px 0; border-bottom: 1px dashed #d1d5db;">`;
                    overtimeHtml += `📖 ${rule}`;
                    overtimeHtml += `</div>`;
                  }
                  
                  // 第三行：详细计算
                  overtimeHtml += `<div style="color: #374151; margin-top: 4px;">`;
                  overtimeHtml += `💼 實際工作: <strong>${originalHours}h</strong>`;
                  overtimeHtml += `</div>`;
                  
                  // 第四行：fixed_8h类型的特殊说明
                  if (item.isFixedType) {
                    overtimeHtml += `<div style="color: #374151; margin-top: 2px;">`;
                    overtimeHtml += `📋 法定給付: <strong style="color: #dc2626;">不論工時，固定8h加權</strong>`;
                    if (item.totalDailyHours && item.totalDailyHours > originalHours) {
                      // 有多条记录，显示比例分配
                      const ratio = (originalHours / item.totalDailyHours * 100).toFixed(1);
                      overtimeHtml += ` <span style="color: #6b7280;">（當天共${item.totalDailyHours}h，本筆佔${ratio}%）</span>`;
                    }
                    overtimeHtml += `</div>`;
                    
                    // 补休分配
                    overtimeHtml += `<div style="color: #059669; margin-top: 2px;">`;
                    const compHours = item.compHoursGenerated || 0;
                    overtimeHtml += `🎁 分配補休: <strong>${compHours}h</strong>`;
                    overtimeHtml += `</div>`;
                    
                    // 加权工时
                    overtimeHtml += `<div style="color: #374151; margin-top: 2px;">`;
                    const originalWeighted = item.originalWeighted || 0;
                    overtimeHtml += `💰 加班費: 固定分配 <strong style="color: #059669;">${originalWeighted.toFixed(2)}h</strong> 加權工時`;
                    if (originalWeighted !== originalHours) {
                      overtimeHtml += ` <span style="color: #dc2626;">（⚠️ 非按實際${originalHours}h計算）</span>`;
                    }
                    overtimeHtml += `</div>`;
                  } else {
                    // 一般类型：补休 = 实际工时
                    overtimeHtml += `<div style="color: #059669; margin-top: 2px;">`;
                    const compHours = item.compHoursGenerated || 0;
                    overtimeHtml += `🎁 累積補休: <strong>${compHours}h</strong>`;
                    overtimeHtml += `</div>`;
                    
                    // 加权工时
                    overtimeHtml += `<div style="color: #374151; margin-top: 2px;">`;
                    const originalWeighted = item.originalWeighted || 0;
                    overtimeHtml += `💰 加班費: ${originalHours}h × ${multiplier}倍 = <strong style="color: #059669;">${originalWeighted.toFixed(2)}h</strong> 加權工時`;
                    overtimeHtml += `</div>`;
                  }
                  
                  // 第五行：补休扣除（如果有）
                  if (item.compDeducted > 0) {
                    overtimeHtml += `<div style="color: #dc2626; margin-top: 3px; padding-top: 3px; border-top: 1px dashed #fecaca;">`;
                    const effectiveWeighted = item.effectiveWeighted || 0;
                    const compDeducted = item.compDeducted || 0;
                    const remainingHours = item.remainingHours || 0;
                    if (item.isFixedType) {
                      // fixed_8h类型，扣除的已经是加权时数
                      overtimeHtml += `⚠️ 扣除補休（加權）: ${compDeducted}h → 剩餘 <strong>${effectiveWeighted.toFixed(2)}h</strong> 有效加權`;
                    } else {
                      // 一般类型，需要乘以倍率
                      overtimeHtml += `⚠️ 扣除補休: ${compDeducted}h → 剩餘 ${remainingHours}h × ${multiplier}倍 = <strong>${effectiveWeighted.toFixed(2)}h</strong> 有效加權`;
                    }
                    overtimeHtml += `</div>`;
                  }
                  
                  overtimeHtml += `</div>`;
                });
              }
            });
            overtimeHtml += '</div>';
            
            const effectiveHours = r.effectiveWeightedHours || 0;
            const expiredComp = r.expiredCompPayCents || 0;
            const baseOvertimePay = Math.round(effectiveHours * hourlyRateNum * 100);
            
            overtimeHtml += `<div style="margin-left: 10px; margin-top: 8px; padding-top: 8px; border-top: 2px solid #e5e7eb;">`;
            overtimeHtml += `<div style="font-weight: 600; margin-bottom: 4px;">加班費合計：</div>`;
            overtimeHtml += `<div style="margin-left: 10px;">• 有效加權工時: ${effectiveHours.toFixed(2)}h × ${hourlyRate} = ${centsToTwd(baseOvertimePay)}</div>`;
            if (expiredComp > 0) {
              overtimeHtml += `<div style="margin-left: 10px; color: #dc2626;">• 上月到期補休轉加班費: ${centsToTwd(expiredComp)}</div>`;
            }
            const totalOvertimePay = baseOvertimePay + expiredComp;
            overtimeHtml += `<div style="margin-left: 10px; margin-top: 4px; font-weight: 600; color: #059669;">總計: ${centsToTwd(totalOvertimePay)}</div>`;
            overtimeHtml += `</div>`;
          } else {
            overtimeHtml += '<div style="margin-left: 10px; color: #9ca3af;">本月無加班記錄</div>';
          }
          
          // 補休使用情況明細
          let compLeaveHtml = '<div style="margin-bottom: 10px; margin-top: 15px;"><strong>補休使用情況：</strong></div>';
          compLeaveHtml += '<div style="margin-left: 10px;">';
          
          // 本月累積的補休
          const totalCompGenerated = r.dailyOvertime ? r.dailyOvertime.reduce((sum, day) => {
            return sum + (day.items || []).reduce((daySum, item) => daySum + (item.compHoursGenerated || 0), 0);
          }, 0) : 0;
          
          if (totalCompGenerated > 0) {
            compLeaveHtml += `<div style="color: #059669; margin-bottom: 4px;">`;
            compLeaveHtml += `➕ 本月加班累積補休: <strong>${totalCompGenerated.toFixed(2)}h</strong>`;
            compLeaveHtml += `</div>`;
          }
          
          // 本月使用的補休
          const totalCompUsed = r.totalCompHoursUsed || 0;
          if (totalCompUsed > 0) {
            compLeaveHtml += `<div style="color: #dc2626; margin-bottom: 4px;">`;
            compLeaveHtml += `➖ 本月使用補休: <strong>${totalCompUsed.toFixed(2)}h</strong>`;
            compLeaveHtml += `</div>`;
          }
          
          // 到期轉加班費的補休
          const expiredCompHours = r.expiredCompHours || 0;
          const expiredComp = r.expiredCompPayCents || 0;
          if (expiredCompHours > 0 || expiredComp > 0) {
            compLeaveHtml += `<div style="padding: 8px; margin-top: 8px; background: #fef2f2; border-left: 3px solid #dc2626; border-radius: 4px;">`;
            compLeaveHtml += `<div style="color: #991b1b; font-weight: 600; margin-bottom: 4px;">`;
            compLeaveHtml += `⏰ 上月到期未使用補休：`;
            compLeaveHtml += `</div>`;
            compLeaveHtml += `<div style="color: #7f1d1d; margin-left: 10px;">`;
            compLeaveHtml += `• 到期時數: <strong>${expiredCompHours.toFixed(2)}h</strong><br>`;
            compLeaveHtml += `• 轉為加班費: <strong>${centsToTwd(expiredComp)}</strong>`;
            compLeaveHtml += `</div>`;
            compLeaveHtml += `<div style="color: #991b1b; font-size: 0.85em; margin-top: 4px; margin-left: 10px;">`;
            compLeaveHtml += `💡 按原始加班倍率 × 時薪計算`;
            compLeaveHtml += `</div>`;
            compLeaveHtml += `</div>`;
          }
          
          // 淨變化
          const netChange = totalCompGenerated - totalCompUsed;
          if (totalCompGenerated > 0 || totalCompUsed > 0) {
            compLeaveHtml += `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #d1d5db;">`;
            const changeColor = netChange > 0 ? '#059669' : (netChange < 0 ? '#dc2626' : '#6b7280');
            const changeIcon = netChange > 0 ? '📈' : (netChange < 0 ? '📉' : '➡️');
            compLeaveHtml += `<div style="color: ${changeColor}; font-weight: 600;">`;
            compLeaveHtml += `${changeIcon} 本月補休淨變化: ${netChange > 0 ? '+' : ''}${netChange.toFixed(2)}h`;
            compLeaveHtml += `</div>`;
            compLeaveHtml += `<div style="color: #6b7280; font-size: 0.85em; margin-top: 4px;">`;
            compLeaveHtml += `補休於生成當月月底到期，未使用自動轉為加班費`;
            compLeaveHtml += `</div>`;
            compLeaveHtml += `</div>`;
          } else if (expiredCompHours === 0 && expiredComp === 0) {
            compLeaveHtml += '<div style="color: #9ca3af;">本月無補休變動</div>';
          }
          
          compLeaveHtml += '</div>';
          
          // 交通補貼明細（按單次計算區間）
          let transportHtml = '<div style="margin-bottom: 10px; margin-top: 15px;"><strong>交通補貼明細：</strong></div>';
          if (r.tripDetails && r.tripDetails.length > 0) {
            transportHtml += '<div style="margin-left: 10px;">';
            r.tripDetails.forEach(trip => {
              transportHtml += `<div>${trip.date}: ${trip.destination}, ${trip.distance}km → ${trip.intervals}區間 × NT$ ${trip.amount / trip.intervals} = NT$ ${trip.amount} - ${trip.purpose || ''}</div>`;
            });
            transportHtml += '</div>';
            transportHtml += `<div style="margin-left: 10px; margin-top: 5px; font-weight: 600;">`;
            transportHtml += `總計: ${r.totalKm || 0}km，${r.transportIntervals || 0}個區間 = ${centsToTwd(r.transportCents || 0)}`;
            transportHtml += `</div>`;
          } else {
            transportHtml += '<div style="margin-left: 10px; color: #9ca3af;">本月無外出記錄</div>';
          }
          
          // 請假扣款明細（包含病假、事假、生理假）- 顯示詳細日期
          let leaveHtml = '<div style="margin-bottom: 10px; margin-top: 15px;"><strong>請假扣款明細：</strong></div>';
          const dailyRate = r.dailySalaryCents || 0; // 使用後端計算的日薪
          
          if (r.leaveDetails && r.leaveDetails.length > 0) {
            const leaveTypeMap = { 'sick': '病假', 'personal': '事假', 'menstrual': '生理假' };
            const leavesByType = { 'sick': [], 'personal': [], 'menstrual': [] };
            
            // 按類型分組
            r.leaveDetails.forEach(leave => {
              if (leavesByType[leave.leaveType]) leavesByType[leave.leaveType].push(leave);
            });
            
            leaveHtml += '<div style="margin-left: 10px;">';
            
            // 顯示病假
            if (leavesByType.sick.length > 0) {
              leaveHtml += `<div style="margin-bottom: 8px;"><strong>病假 (扣50%)：</strong></div>`;
              leavesByType.sick.forEach(leave => {
                const dateRange = leave.startDate === leave.endDate ? leave.startDate : `${leave.startDate} ~ ${leave.endDate}`;
                const hours = leave.unit === 'day' ? leave.amount * 8 : leave.amount;
                leaveHtml += `<div style="margin-left: 20px;">• ${dateRange}: ${hours}小時${leave.reason ? ` (${leave.reason})` : ''}</div>`;
              });
              const sickHours = r.sickHours || 0;
              leaveHtml += `<div style="margin-left: 20px; margin-top: 4px; color: #666;">小計: ${sickHours}h × ${hourlyRate} × 50% = ${centsToTwd(Math.round(sickHours * hourlyRateNum * 0.5 * 100))}</div>`;
            }
            
            // 顯示事假
            if (leavesByType.personal.length > 0) {
              leaveHtml += `<div style="margin-bottom: 8px; margin-top: 8px;"><strong>事假 (扣100%)：</strong></div>`;
              leavesByType.personal.forEach(leave => {
                const dateRange = leave.startDate === leave.endDate ? leave.startDate : `${leave.startDate} ~ ${leave.endDate}`;
                const hours = leave.unit === 'day' ? leave.amount * 8 : leave.amount;
                leaveHtml += `<div style="margin-left: 20px;">• ${dateRange}: ${hours}小時${leave.reason ? ` (${leave.reason})` : ''}</div>`;
              });
              const personalHours = r.personalHours || 0;
              leaveHtml += `<div style="margin-left: 20px; margin-top: 4px; color: #666;">小計: ${personalHours}h × ${hourlyRate} × 100% = ${centsToTwd(Math.round(personalHours * hourlyRateNum * 100))}</div>`;
            }
            
            // 顯示生理假
            if (leavesByType.menstrual.length > 0) {
              leaveHtml += `<div style="margin-bottom: 8px; margin-top: 8px;"><strong>生理假 (扣50%)：</strong></div>`;
              leavesByType.menstrual.forEach(leave => {
                const dateRange = leave.startDate === leave.endDate ? leave.startDate : `${leave.startDate} ~ ${leave.endDate}`;
                const hours = leave.unit === 'day' ? leave.amount * 8 : leave.amount;
                leaveHtml += `<div style="margin-left: 20px;">• ${dateRange}: ${hours}小時</div>`;
              });
              const menstrualHours = r.menstrualHours || 0;
              leaveHtml += `<div style="margin-left: 20px; margin-top: 4px; color: #666;">小計: ${menstrualHours}h × ${hourlyRate} × 50% = ${centsToTwd(Math.round(menstrualHours * hourlyRateNum * 0.5 * 100))}</div>`;
              if (r.menstrualFreeDays > 0) {
                leaveHtml += `<div style="margin-left: 20px;"><small style="color:#16a34a;">（前${r.menstrualFreeDays}天獨立計算，不併入病假額度）</small></div>`;
              }
              if (r.menstrualMergedDays > 0) {
                leaveHtml += `<div style="margin-left: 20px;"><small style="color:#f59e0b;">（${r.menstrualMergedDays}天併入病假額度）</small></div>`;
              }
              leaveHtml += `<div style="margin-left: 20px;"><small style="color:#16a34a;">✓ 生理假不影響全勤</small></div>`;
            }
            
            leaveHtml += '</div>';
            leaveHtml += `<div style="margin-left: 10px; margin-top: 8px; font-weight: 600;">總扣款: ${centsToTwd(r.leaveDeductionCents || 0)}</div>`;
          } else {
            leaveHtml += '<div style="margin-left: 10px; color: #16a34a;">✓ 無請假記錄</div>';
          }
          
          // 固定扣款明細（劳保、健保等）
          let deductionHtml = '<div style="margin-bottom: 10px; margin-top: 15px;"><strong>固定扣款明細：</strong></div>';
          if (r.deductionItems && r.deductionItems.length > 0) {
            deductionHtml += '<div style="margin-left: 10px;">';
            r.deductionItems.forEach(item => {
              deductionHtml += `<div style="margin-bottom: 4px;">• ${item.name}: ${centsToTwd(item.amountCents)}</div>`;
            });
            deductionHtml += '</div>';
            deductionHtml += `<div style="margin-left: 10px; margin-top: 8px; font-weight: 600; color: #dc2626;">小計: ${centsToTwd(r.deductionCents)}</div>`;
          } else {
            deductionHtml += '<div style="margin-left: 10px; color: #16a34a;">✓ 無固定扣款</div>';
          }
          
          // 全勤獎金判斷
          let fullAttendanceHtml = '<div style="margin-bottom: 10px; margin-top: 15px;"><strong>全勤獎金判斷：</strong></div>';
          if (r.isFullAttendance) {
            fullAttendanceHtml += '<div style="margin-left: 10px; color: #16a34a;">';
            fullAttendanceHtml += '✓ 本月全勤<br>';
            fullAttendanceHtml += '<small>（無病假、事假）</small>';
            if (r.menstrualDays > 0) {
              fullAttendanceHtml += '<br><small style="color:#16a34a;">生理假不影響全勤</small>';
            }
            fullAttendanceHtml += '</div>';
          } else {
            fullAttendanceHtml += '<div style="margin-left: 10px; color: #dc2626;">';
            fullAttendanceHtml += '✗ 未達全勤標準<br>';
            fullAttendanceHtml += '<small>原因: ';
            const reasons = [];
            if (r.sickDays > 0) reasons.push('病假');
            if (r.personalDays > 0) reasons.push('事假');
            fullAttendanceHtml += reasons.join('、');
            fullAttendanceHtml += '</small></div>';
          }
          
          return `
            <tr class="detail-row" id="${rowId}-detail" style="display: none; background: #fafafa;">
              <td colspan="13" style="padding: 15px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div>
                    ${hourlyRateBaseHtml}
                    ${allowancesHtml}
                    ${overtimeHtml}
                    ${compLeaveHtml}
                  </div>
                  <div>
                    ${fullAttendanceHtml}
                    ${transportHtml}
                    ${deductionHtml}
                    ${leaveHtml}
                  </div>
                </div>
              </td>
            </tr>
          `;
        }

        function renderCalc(){
          // 移除分頁，直接顯示所有篩選後的資料
          const rows = calcState.filtered;
          console.log('[渲染] 显示', rows.length, '条记录');
          tbodyCalc.innerHTML = '';
          if (rows.length === 0){
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="14" class="muted">沒有符合條件的資料</td>';
            tbodyCalc.appendChild(tr);
          } else {
            rows.forEach((r, idx) => {
              const tr = document.createElement('tr');
              const rowId = `payroll-row-${idx}`;
              tr.id = rowId;
              
              // 计算时薪显示
              const hourlyRate = centsToTwd(r.hourlyRateCents || 0).replace('NT$ ', '');
              const effectiveHours = r.effectiveWeightedHours || 0;
              const overtimeDetail = r.overtimeCents > 0 ? `<br><small style="color:#059669;">${effectiveHours.toFixed(1)}h × $${hourlyRate}</small>` : '';
              
              // 误餐费明细
              const mealDays = r.overtimeDays || 0;
              const mealRate = r.mealAllowanceCents > 0 && mealDays > 0 ? Math.round((r.mealAllowanceCents / 100) / mealDays) : 0;
              const mealDetail = r.mealAllowanceCents > 0 ? `<br><small style="color:#059669;">${mealDays}天 × $${mealRate}</small>` : '';
              
              // 交通费明细
              const transportDetail = r.totalKm > 0 ? `<br><small style="color:#059669;">${r.totalKm}km (${r.transportIntervals || 0}区间)</small>` : '';
              
              // 请假扣款明细
              const leaveDetail = (r.sickDays || r.personalDays) ? `<br><small style="color:#dc2626;">病${r.sickDays || 0}天 事${r.personalDays || 0}天</small>` : '';
              
              // 全勤奖金
              const fullAttendanceBonus = r.isFullAttendance ? (r.bonusCents > 0 ? '含全勤' : '') : '';
              
              tr.innerHTML = `
                <td style="text-align: center;">
                  <button class="btn btn-sm" onclick="window.togglePayrollDetail('${rowId}')" style="padding: 2px 8px; font-size: 0.75rem;">▼</button>
                </td>
                <td><strong>${r.name || ''}</strong></td>
                <td>${centsToTwd(r.baseSalaryCents)}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.regularAllowanceCents)}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.bonusCents)}${fullAttendanceBonus ? `<br><small style="color:#059669;">${fullAttendanceBonus}</small>` : ''}</td>
                <td style="background: #f0fdf4;text-align:center;">${r.isFullAttendance ? '<span style="color:#16a34a;font-size:1.2em;">✓</span>' : '<span style="color:#dc2626;">✗</span>'}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.overtimeCents)}${overtimeDetail}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.mealAllowanceCents || 0)}${mealDetail}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.transportCents || 0)}${transportDetail}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.performanceBonusCents || 0)}</td>
                <td style="background: #fef2f2;color:#dc2626;">${r.deductionCents > 0 ? '-' + centsToTwd(r.deductionCents) : '0'}</td>
                <td style="background: #fef2f2;color:#dc2626;">${r.leaveDeductionCents > 0 ? '-' + centsToTwd(r.leaveDeductionCents) : '0'}${leaveDetail}</td>
                <td style="font-weight:600;background:#f0f9ff;">${centsToTwd(r.grossSalaryCents)}</td>
                <td style="font-weight:600;color:#16a34a;background:#dbeafe;font-size:1.05em;">${centsToTwd(r.netSalaryCents)}</td>
                <td style="text-align: center;">
                  <button class="btn btn-sm" onclick="window.printPayslip(${r.userId}, '${monthInput.value}')" style="padding: 4px 10px; font-size: 0.75rem; background: #3b82f6; color: white;">🖨️ 打印</button>
                </td>
              `;
              tbodyCalc.appendChild(tr);
              
              // 添加详细明细行
              tbodyCalc.insertAdjacentHTML('beforeend', generateDetailRow(r, rowId));
            });
          }
        }
        
        // 切换详细明细显示
        window.togglePayrollDetail = function(rowId) {
          const detailRow = document.getElementById(`${rowId}-detail`);
          const btn = document.querySelector(`#${rowId} button`);
          if (detailRow) {
            const isHidden = detailRow.style.display === 'none';
            detailRow.style.display = isHidden ? 'table-row' : 'none';
            if (btn) {
              btn.textContent = isHidden ? '▲' : '▼';
            }
          }
        };
        
        // 打印薪资条功能
        window.printPayslip = async function(userId, month) {
          if (!userId || !month) {
            alert('缺少必要参数');
            return;
          }
          
          const printWindow = window.open('', '_blank', 'width=800,height=1000');
          printWindow.document.write(`
            <!DOCTYPE html>
            <html lang="zh-Hant">
            <head>
              <meta charset="UTF-8">
              <title>薪資條 - ${month}</title>
              <style>
                @page { 
                  size: A4; 
                  margin: 15mm; 
                }
                * { 
                  margin: 0; 
                  padding: 0; 
                  box-sizing: border-box; 
                }
                body { 
                  font-family: "Microsoft JhengHei", "微軟正黑體", Arial, sans-serif;
                  line-height: 1.6;
                  padding: 20px;
                  max-width: 800px;
                  margin: 0 auto;
                }
                .header {
                  text-align: center;
                  margin-bottom: 30px;
                  border-bottom: 3px solid #1e40af;
                  padding-bottom: 15px;
                }
                .company-name {
                  font-size: 24pt;
                  font-weight: bold;
                  color: #1e40af;
                  margin-bottom: 8px;
                }
                .document-title {
                  font-size: 20pt;
                  font-weight: bold;
                  margin: 10px 0;
                }
                .employee-info {
                  display: flex;
                  justify-content: space-between;
                  margin: 20px 0;
                  padding: 15px;
                  background: #f0f9ff;
                  border-radius: 8px;
                  border: 2px solid #bfdbfe;
                }
                .info-item {
                  font-size: 12pt;
                }
                .info-label {
                  color: #1e40af;
                  font-weight: bold;
                  margin-right: 8px;
                }
                .section-title {
                  font-size: 14pt;
                  font-weight: bold;
                  color: #1e40af;
                  margin: 25px 0 12px 0;
                  padding-bottom: 5px;
                  border-bottom: 2px solid #1e40af;
                }
                table {
                  width: 100%;
                  border-collapse: collapse;
                  margin: 15px 0;
                }
                th, td {
                  border: 1.5px solid #666;
                  padding: 10px;
                  text-align: left;
                  font-size: 11pt;
                }
                th {
                  background: #dbeafe;
                  font-weight: bold;
                  text-align: center;
                }
                td.amount {
                  text-align: right;
                  font-family: "Courier New", monospace;
                }
                .income-row {
                  background: #f0fdf4;
                }
                .deduction-row {
                  background: #fef2f2;
                }
                .total-row {
                  background: #e0f2fe;
                  font-weight: bold;
                  font-size: 12pt;
                }
                .final-row {
                  background: #dbeafe;
                  font-weight: bold;
                  font-size: 13pt;
                  color: #16a34a;
                }
                .summary-box {
                  margin: 25px 0;
                  padding: 20px;
                  border: 3px solid #16a34a;
                  border-radius: 8px;
                  background: #f0fdf4;
                }
                .summary-item {
                  display: flex;
                  justify-content: space-between;
                  padding: 8px 0;
                  font-size: 13pt;
                }
                .summary-item.final {
                  border-top: 2px solid #16a34a;
                  margin-top: 10px;
                  padding-top: 15px;
                  font-size: 16pt;
                  font-weight: bold;
                  color: #16a34a;
                }
                .signature {
                  display: flex;
                  justify-content: space-around;
                  margin: 40px 0 20px 0;
                  padding-top: 20px;
                  border-top: 1px dashed #666;
                }
                .signature-item {
                  text-align: center;
                  font-size: 11pt;
                }
                .signature-line {
                  width: 200px;
                  border-bottom: 1px solid #000;
                  height: 40px;
                  margin: 10px auto;
                }
                .footer {
                  text-align: center;
                  margin-top: 30px;
                  padding-top: 15px;
                  border-top: 1px solid #ccc;
                  font-size: 9pt;
                  color: #666;
                }
                .note {
                  margin: 15px 0;
                  padding: 12px;
                  background: #fffbeb;
                  border-left: 4px solid #f59e0b;
                  font-size: 10pt;
                  color: #92400e;
                }
                @media print {
                  button { display: none !important; }
                  body { padding: 0; }
                }
              </style>
            </head>
            <body>
              <button onclick="window.print()" style="position:fixed;top:10px;right:10px;padding:10px 20px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;z-index:1000;font-size:14px;">🖨️ 列印薪資條</button>
              <div id="payslip-content">載入中...</div>
              <script>
                (async function() {
                  try {
                    const response = await fetch('/internal/api/v1/admin/payroll/calculate/${userId}?month=${month}', {
                      credentials: 'include'
                    });
                    const result = await response.json();
                    
                    if (!result.ok || !result.data) {
                      document.getElementById('payslip-content').innerHTML = '<p style="color:red;text-align:center;margin-top:50px;">無法載入薪資數據</p>';
                      return;
                    }
                    
                    const data = result.data;
                    const userName = data.name || '未知員工';
                    
                    // 格式化金额
                    const fmt = (cents) => {
                      const val = Math.abs(cents || 0) / 100;
                      return 'NT$ ' + val.toLocaleString('zh-TW', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    };
                    
                    // 格式化月份为民国年月
                    const formatMonth = (month) => {
                      const [y, m] = month.split('-');
                      const rocYear = parseInt(y) - 1911;
                      return rocYear + '年' + parseInt(m) + '月';
                    };
                    
                    // 构建收入明细
                    let incomeRows = '';
                    
                    // 基本薪资
                    incomeRows += '<tr class="income-row"><td>基本薪資</td><td class="amount">' + fmt(data.baseSalaryCents) + '</td><td>底薪</td></tr>';
                    
                    // 津贴
                    if (data.allowanceItems && data.allowanceItems.length > 0) {
                      data.allowanceItems.forEach(item => {
                        const regular = item.isRegularPayment ? ' <small>(經常性給與)</small>' : '';
                        incomeRows += '<tr class="income-row"><td>' + item.name + regular + '</td><td class="amount">' + fmt(item.amountCents) + '</td><td>津貼</td></tr>';
                      });
                    }
                    
                    // 奖金
                    if (data.bonusItems && data.bonusItems.length > 0) {
                      data.bonusItems.forEach(item => {
                        const regular = item.isRegularPayment ? ' <small>(經常性給與)</small>' : '';
                        let note = '獎金';
                        if (item.isFullAttendanceBonus) {
                          note = data.isFullAttendance ? '✓ 全勤達標，發放' : '✗ 未達全勤，不發放';
                        }
                        // 只显示实际发放的奖金
                        if (!item.isFullAttendanceBonus || data.isFullAttendance) {
                          incomeRows += '<tr class="income-row"><td>' + item.name + regular + '</td><td class="amount">' + fmt(item.amountCents) + '</td><td>' + note + '</td></tr>';
                        }
                      });
                    }
                    
                    // 加班费
                    if ((data.overtimeCents || 0) > 0 || (data.expiredCompPayCents || 0) > 0) {
                      const effectiveHours = data.effectiveWeightedHours || 0;
                      const hourlyRate = (data.hourlyRateCents || 0) / 100;
                      const overtimeFromHours = Math.round(effectiveHours * hourlyRate * 100);
                      const expiredComp = data.expiredCompPayCents || 0;
                      const total = overtimeFromHours + expiredComp;
                      
                      if (overtimeFromHours > 0) {
                        incomeRows += '<tr class="income-row"><td>加班費（有效加權工時）<br><small>' + effectiveHours.toFixed(1) + 'h × NT$ ' + hourlyRate.toFixed(2) + '</small></td><td class="amount">' + fmt(overtimeFromHours) + '</td><td>加班費</td></tr>';
                      }
                      if (expiredComp > 0) {
                        incomeRows += '<tr class="income-row"><td>上月到期補休轉加班費</td><td class="amount" style="color:#dc2626;">' + fmt(expiredComp) + '</td><td>加班費</td></tr>';
                      }
                    }
                    
                    // 误餐费
                    if ((data.mealAllowanceCents || 0) > 0) {
                      const days = data.overtimeDays || 0;
                      incomeRows += '<tr class="income-row"><td>誤餐費<br><small>' + days + '天</small></td><td class="amount">' + fmt(data.mealAllowanceCents) + '</td><td>津貼</td></tr>';
                    }
                    
                    // 交通费
                    if ((data.transportCents || 0) > 0) {
                      const km = data.totalKm || 0;
                      incomeRows += '<tr class="income-row"><td>交通補貼<br><small>' + km + ' km</small></td><td class="amount">' + fmt(data.transportCents) + '</td><td>津貼</td></tr>';
                    }
                    
                    // 绩效奖金调整
                    if ((data.performanceBonusCents || 0) > 0) {
                      incomeRows += '<tr class="income-row"><td>績效獎金（月度調整）</td><td class="amount">' + fmt(data.performanceBonusCents) + '</td><td>獎金</td></tr>';
                    }
                    
                    // 构建扣款明细
                    let deductionRows = '';
                    
                    // 固定扣款
                    if (data.deductionItems && data.deductionItems.length > 0) {
                      data.deductionItems.forEach(item => {
                        deductionRows += '<tr class="deduction-row"><td>' + item.name + '</td><td class="amount">-' + fmt(item.amountCents) + '</td><td>固定扣款</td></tr>';
                      });
                    }
                    
                    // 请假扣款
                    if ((data.leaveDeductionCents || 0) > 0) {
                      const sickH = data.sickHours || 0;
                      const personalH = data.personalHours || 0;
                      const menstrualH = data.menstrualHours || 0;
                      let leaveDetail = '';
                      if (sickH > 0) leaveDetail += '病假' + sickH + 'h ';
                      if (personalH > 0) leaveDetail += '事假' + personalH + 'h ';
                      if (menstrualH > 0) leaveDetail += '生理假' + menstrualH + 'h';
                      deductionRows += '<tr class="deduction-row"><td>請假扣款<br><small>' + leaveDetail + '</small></td><td class="amount">-' + fmt(data.leaveDeductionCents) + '</td><td>請假扣款</td></tr>';
                    }
                    
                    // 渲染HTML
                    const html = \`
                      <div class="header">
                        <div class="company-name">宏國聯合會計師事務所</div>
                        <div class="document-title">薪資條</div>
                      </div>
                      
                      <div class="employee-info">
                        <div class="info-item"><span class="info-label">員工姓名：</span>\${userName}</div>
                        <div class="info-item"><span class="info-label">薪資月份：</span>\${formatMonth('${month}')}</div>
                        <div class="info-item"><span class="info-label">列印日期：</span>\${new Date().toLocaleDateString('zh-TW')}</div>
                      </div>
                      
                      <div class="section-title">📈 收入明細</div>
                      <table>
                        <thead>
                          <tr>
                            <th style="width: 50%;">項目</th>
                            <th style="width: 30%;">金額</th>
                            <th style="width: 20%;">類別</th>
                          </tr>
                        </thead>
                        <tbody>
                          \${incomeRows}
                        </tbody>
                      </table>
                      
                      <div class="section-title">📉 扣款明細</div>
                      <table>
                        <thead>
                          <tr>
                            <th style="width: 50%;">項目</th>
                            <th style="width: 30%;">金額</th>
                            <th style="width: 20%;">類別</th>
                          </tr>
                        </thead>
                        <tbody>
                          \${deductionRows || '<tr><td colspan="3" style="text-align:center;color:#666;">本月無扣款</td></tr>'}
                        </tbody>
                      </table>
                      
                      <div class="summary-box">
                        <div class="summary-item">
                          <span>應發工資：</span>
                          <span style="font-weight:bold;">\${fmt(data.grossSalaryCents)}</span>
                        </div>
                        <div class="summary-item">
                          <span>總扣款：</span>
                          <span style="color:#dc2626;">-\${fmt((data.deductionCents || 0) + (data.leaveDeductionCents || 0))}</span>
                        </div>
                        <div class="summary-item final">
                          <span>實發工資：</span>
                          <span>\${fmt(data.netSalaryCents)}</span>
                        </div>
                      </div>
                      
                      <div class="note">
                        💡 <strong>說明：</strong><br>
                        • 時薪計算基準 = (底薪 + 經常性給與) ÷ 240小時<br>
                        • 加班費 = 有效加權工時 × 時薪<br>
                        • 本薪資條僅供參考，實際發放金額以公司財務部門為準
                      </div>
                      
                      <div class="signature">
                        <div class="signature-item">
                          <div>員工簽收</div>
                          <div class="signature-line"></div>
                          <div style="font-size:9pt;color:#666;">日期：____________</div>
                        </div>
                        <div class="signature-item">
                          <div>會計確認</div>
                          <div class="signature-line"></div>
                          <div style="font-size:9pt;color:#666;">日期：____________</div>
                        </div>
                      </div>
                      
                      <div class="footer">
                        <div>宏國聯合會計師事務所 | www.horgoscpa.com</div>
                        <div style="margin-top:5px;">本文件由系統自動產生，如有疑問請洽人事部門</div>
                      </div>
                    \`;
                    
                    document.getElementById('payslip-content').innerHTML = html;
                  } catch (error) {
                    console.error('載入薪資數據失敗:', error);
                    document.getElementById('payslip-content').innerHTML = '<p style="color:red;text-align:center;margin-top:50px;">載入失敗：' + error.message + '</p>';
                  }
                })();
              </script>
            </body>
            </html>
          `);
          printWindow.document.close();
        };

        // 不再需要筛选功能，直接显示所有数据
        function applyCalcFilters(){
          calcState.filtered = calcState.all.slice();
          renderCalc();
        }

        // 薪資預覽快取（按月份）
        const payrollCache = new Map(); // key: month, value: { data, timestamp }
        const CACHE_DURATION = 5 * 60 * 1000; // 5分鐘快取
        
        async function loadPreview(forceRefresh = false){
          const m = monthInput.value;
          
          // 檢查快取
          if (!forceRefresh && payrollCache.has(m)) {
            const cached = payrollCache.get(m);
            const now = Date.now();
            if (now - cached.timestamp < CACHE_DURATION) {
              console.log(`[薪資計算] ⚡ 使用快取資料 (${m})`);
              calcState.all = cached.data;
              applyCalcFilters();
              return;
            } else {
              console.log(`[薪資計算] 快取已過期 (${m})`);
              payrollCache.delete(m);
            }
          }
          
          tbodyCalc.innerHTML = '<tr><td colspan="13" class="muted">載入中…</td></tr>';
          try {
            const res = await fetch(`${apiBase}/admin/payroll/preview?month=${encodeURIComponent(m)}`, { credentials: 'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/payroll'); return; }
            if (res.status === 403) { infoBar.style.display = 'block'; setTabsEnabled(false); return; }
            const json = await res.json();
            if (!json || json.ok !== true) throw new Error('載入失敗');
            const users = (json.data && json.data.users) || [];
            console.log('[薪資計算] 🔄 從伺服器載入資料:', users.length, '筆記錄');
            
            // 存入快取
            payrollCache.set(m, {
              data: users,
              timestamp: Date.now()
            });
            
            calcState.all = users;
            applyCalcFilters();
          } catch (err) {
            console.error('[薪資計算] 載入失敗:', err);
            tbodyCalc.innerHTML = '<tr><td colspan="13" class="muted" style="color:#c0392b;">載入失敗</td></tr>';
          }
        }

        // ==================== 薪資項目設定功能 ====================

        function getCategoryLabel(cat) {
          const labels = { 'allowance': '津貼', 'bonus': '獎金', 'deduction': '扣款' };
          return labels[cat] || cat;
        }

        function renderItems() {
          tbodyItems.innerHTML = '';
          if (itemsState.filtered.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="7" class="muted">沒有符合條件的資料</td>';
            tbodyItems.appendChild(tr);
            return;
          }

          itemsState.filtered.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><code>${item.itemCode}</code></td>
              <td>${item.itemName}</td>
              <td>${getCategoryLabel(item.category)}</td>
              <td>${item.isRegularPayment ? '✓ 是' : '否'}</td>
              <td>${item.isActive ? '<span style="color:#16a34a;">啟用</span>' : '<span style="color:#9ca3af;">停用</span>'}</td>
              <td>
                <button class="btn btn-sm" onclick="window.editItem(${item.itemTypeId})">編輯</button>
                ${item.isActive ? 
                  `<button class="btn btn-sm" onclick="window.toggleItemStatus(${item.itemTypeId}, false)">停用</button>` :
                  `<button class="btn btn-sm" onclick="window.toggleItemStatus(${item.itemTypeId}, true)">啟用</button>`
                }
              </td>
            `;
            tbodyItems.appendChild(tr);
          });
        }

        async function loadItems() {
          tbodyItems.innerHTML = '<tr><td colspan="7" class="muted">載入中…</td></tr>';
          try {
            const res = await fetch(`${apiBase}/admin/salary-item-types`, { credentials: 'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/payroll'); return; }
            if (res.status === 403) { infoBar.style.display = 'block'; return; }
            const json = await res.json();
            if (!json || json.ok !== true) throw new Error('載入失敗');
            itemsState.all = json.data.items || [];
            applyItemFilters();
          } catch (err) {
            console.error('loadItems error:', err);
            tbodyItems.innerHTML = '<tr><td colspan="7" class="muted" style="color:#c0392b;">載入失敗</td></tr>';
          }
        }

        function applyItemFilters() {
          const kw = (itemSearch.value || '').trim().toLowerCase();
          let items = itemsState.all.slice();
          if (kw) {
            items = items.filter(item => 
              item.itemCode.toLowerCase().includes(kw) || 
              item.itemName.toLowerCase().includes(kw)
            );
          }
          itemsState.filtered = items;
          renderItems();
        }

        function generateItemCode() {
          // 自動生成項目代碼：ITEM_YYYYMMDDHHMMSS
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const hour = String(now.getHours()).padStart(2, '0');
          const minute = String(now.getMinutes()).padStart(2, '0');
          const second = String(now.getSeconds()).padStart(2, '0');
          return `ITEM_${year}${month}${day}${hour}${minute}${second}`;
        }

        function openItemDialog(item = null) {
          itemErrorMsg.style.display = 'none';
          itemErrorMsg.textContent = '';
          
          if (item) {
            // 編輯模式
            itemDialogTitle.innerHTML = '編輯薪資項目';
            document.getElementById('itemDialogTitle').nextElementSibling.textContent = '修改薪資項目的設定';
            document.getElementById('itemTypeId').value = item.itemTypeId;
            document.getElementById('itemCode').value = item.itemCode;
            document.getElementById('itemName').value = item.itemName;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemIsRegular').checked = item.isRegularPayment;
            document.getElementById('itemIsPerformance').checked = (item.itemCode === 'PERFORMANCE');
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('itemDisplayOrder').value = item.displayOrder || 0;
          } else {
            // 新增模式
            itemDialogTitle.innerHTML = '新增薪資項目';
            document.getElementById('itemDialogTitle').nextElementSibling.textContent = '設定薪資項目的基本資訊';
            itemForm.reset();
            document.getElementById('itemTypeId').value = '';
            document.getElementById('itemCode').value = '';
            document.getElementById('itemDisplayOrder').value = 99;
          }
          
          itemDialog.showModal();
        }

        async function saveItem(e) {
          e.preventDefault();
          itemErrorMsg.style.display = 'none';

          const itemTypeId = document.getElementById('itemTypeId').value;
          const isEdit = !!itemTypeId;
          const isPerformance = document.getElementById('itemIsPerformance').checked;

          // 自動設置項目代碼
          let itemCode = document.getElementById('itemCode').value.trim();
          if (isPerformance) {
            itemCode = 'PERFORMANCE';
          } else if (!itemCode || itemCode === 'PERFORMANCE') {
            // 如果沒有代碼，或原本是 PERFORMANCE 但現在取消勾選，則自動生成
            itemCode = generateItemCode();
          }

          const data = {
            itemCode: itemCode,
            itemName: document.getElementById('itemName').value.trim(),
            category: document.getElementById('itemCategory').value,
            isRegularPayment: document.getElementById('itemIsRegular').checked,
            description: document.getElementById('itemDescription').value.trim(),
            displayOrder: parseInt(document.getElementById('itemDisplayOrder').value) || 0
          };

          try {
            const url = isEdit 
              ? `${apiBase}/admin/salary-item-types/${itemTypeId}`
              : `${apiBase}/admin/salary-item-types`;
            const method = isEdit ? 'PUT' : 'POST';

            const res = await fetch(url, {
              method,
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });

            const json = await res.json();

            if (res.ok && json.ok) {
              itemDialog.close();
              await loadItems();
              alert(isEdit ? '更新成功！' : '新增成功！');
            } else {
              itemErrorMsg.textContent = json.message || '操作失敗';
              itemErrorMsg.style.display = 'block';
            }
          } catch (err) {
            console.error('saveItem error:', err);
            itemErrorMsg.textContent = '操作失敗，請稍後再試';
            itemErrorMsg.style.display = 'block';
          }
        }

        async function toggleItemStatus(itemTypeId, newStatus) {
          if (!confirm(`確定要${newStatus ? '啟用' : '停用'}此項目？`)) return;

          try {
            const res = await fetch(`${apiBase}/admin/salary-item-types/${itemTypeId}`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ isActive: newStatus })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              await loadItems();
            } else {
              alert(json.message || '操作失敗');
            }
          } catch (err) {
            console.error('toggleItemStatus error:', err);
            alert('操作失敗');
          }
        }

        // 全局函數供 onclick 使用
        window.editItem = function(itemTypeId) {
          const item = itemsState.all.find(i => i.itemTypeId === itemTypeId);
          if (item) openItemDialog(item);
        };

        window.toggleItemStatus = toggleItemStatus;

        // ==================== 員工薪資設定功能 ====================

        // 加載所有員工
        async function loadUsers() {
          try {
            const res = await fetch(`${apiBase}/admin/users`, { credentials: 'include' });
            if (!res.ok) throw new Error('載入失敗');
            const json = await res.json();
            empState.allUsers = json.data?.users || [];
            empState.filteredUsers = [...empState.allUsers];
            renderUserList();
          } catch (err) {
            console.error('loadUsers error:', err);
            empList.innerHTML = '<li class="muted">載入失敗</li>';
          }
        }

        // 渲染員工列表
        function renderUserList() {
          if (empState.filteredUsers.length === 0) {
            empList.innerHTML = '<li class="muted">無符合條件的員工</li>';
            return;
          }
          empList.innerHTML = empState.filteredUsers.map(u => `
            <li class="${empState.selectedUserId === u.userId ? 'active' : ''}" 
                onclick="selectUser(${u.userId})" 
                style="cursor: pointer; padding: 0.75rem;">
              <div style="font-weight: 500;">${u.name || u.username}</div>
              <div style="font-size: 0.875rem; color: #666;">底薪: ${u.baseSalary.toLocaleString()} 元</div>
            </li>
          `).join('');
        }

        // 搜尋員工
        function applyUserFilters() {
          const keyword = empSearch.value.toLowerCase().trim();
          if (!keyword) {
            empState.filteredUsers = [...empState.allUsers];
          } else {
            empState.filteredUsers = empState.allUsers.filter(u => 
              (u.name || '').toLowerCase().includes(keyword) ||
              (u.username || '').toLowerCase().includes(keyword)
            );
          }
          renderUserList();
        }

        // 選擇員工
        window.selectUser = async function(userId) {
          empState.selectedUserId = userId;
          renderUserList();
          await loadUserSalary(userId);
        };

        // 加載員工薪資設定
        async function loadUserSalary(userId) {
          try {
            const res = await fetch(`${apiBase}/admin/users/${userId}/salary`, { credentials: 'include' });
            if (!res.ok) throw new Error('載入失敗');
            const json = await res.json();
            empState.currentUserData = json.data;
            empState.userSalaryItems = json.data.salaryItems || [];
            renderUserSalaryForm();
          } catch (err) {
            console.error('loadUserSalary error:', err);
            alert('載入員工薪資失敗');
          }
        }

        // 渲染員工薪資表單
        function renderUserSalaryForm() {
          const data = empState.currentUserData;
          if (!data) {
            empFormContainer.style.display = 'none';
            empEmptyState.style.display = 'block';
            return;
          }

          empFormContainer.style.display = 'block';
          empEmptyState.style.display = 'none';
          empFormTitle.textContent = `${data.name} 的薪資設定`;
          empBaseSalary.value = data.baseSalary || 0;
          empSalaryNotes.value = data.salaryNotes || '';
          
          renderUserSalaryItems();
        }

        // 渲染員工薪資項目列表
        function renderUserSalaryItems() {
          if (empState.userSalaryItems.length === 0) {
            empItemsList.innerHTML = '<small class="muted">尚無薪資項目</small>';
            return;
          }

          empItemsList.innerHTML = empState.userSalaryItems.map((item, index) => {
            const recurringType = item.recurringType || 'monthly';
            let recurringMonths = [];
            if (item.recurringMonths) {
              try {
                recurringMonths = JSON.parse(item.recurringMonths);
              } catch (e) {
                console.error('Failed to parse recurring_months:', item.recurringMonths);
              }
            }
            const showMonthSelector = recurringType === 'yearly';
            
            return `
            <div class="salary-item-row" style="background: #f9fafb; border: 1px solid #e0e0e0; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem;">
              <div style="display: grid; grid-template-columns: 2fr 1fr 1.5fr auto; gap: 0.5rem; align-items: start; margin-bottom: 0.5rem;">
                <div>
                  <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.25rem;">項目</label>
                  <select class="item-type-select" data-index="${index}" style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    ${renderItemTypeOptions(item.itemTypeId)}
                  </select>
                </div>
                <div>
                  <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.25rem;">金額（元）</label>
                  <input type="number" class="item-amount" data-index="${index}" value="${item.amountCents / 100}" 
                         placeholder="0.00" min="0" step="0.01" style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;" />
                </div>
                <div>
                  <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.25rem;">發放週期</label>
                  <select class="item-recurring-type" data-index="${index}" onchange="toggleMonthSelector(${index})" style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    <option value="monthly" ${recurringType === 'monthly' ? 'selected' : ''}>每月發放</option>
                    <option value="yearly" ${recurringType === 'yearly' ? 'selected' : ''}>每年指定月份</option>
                    <option value="once" ${recurringType === 'once' ? 'selected' : ''}>僅發放一次</option>
                  </select>
                </div>
                <div style="padding-top: 1.25rem;">
                  <button type="button" class="btn btn-sm" onclick="removeUserSalaryItem(${index})" style="padding: 0.375rem 0.75rem;">❌</button>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                <div>
                  <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.25rem;">📅 生效日期</label>
                  <input type="date" class="item-effective-date" data-index="${index}" value="${item.effectiveDate || ''}" 
                         style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;" />
                </div>
                <div>
                  <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.25rem;">📅 失效日期（選填）</label>
                  <input type="date" class="item-expiry-date" data-index="${index}" value="${item.expiryDate || ''}" 
                         placeholder="留空表示永久有效"
                         style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;" />
                </div>
              </div>
              <div class="month-selector-${index}" style="display: ${showMonthSelector ? 'block' : 'none'};">
                <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.5rem;">📅 發放月份（可多選）</label>
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.25rem;">
                  ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `
                    <label style="display: flex; align-items: center; padding: 0.25rem; font-size: 0.875rem;">
                      <input type="checkbox" class="month-checkbox-${index}" value="${m}" ${recurringMonths.includes(m) ? 'checked' : ''} style="margin-right: 0.25rem;" />
                      ${m}月
                    </label>
                  `).join('')}
                </div>
              </div>
            </div>
          `;
          }).join('');
        }

        // 渲染薪資項目類型選項
        function renderItemTypeOptions(selectedId) {
          return itemsState.all
            .filter(t => t.isActive)
            .map(t => `<option value="${t.itemTypeId}" ${t.itemTypeId === selectedId ? 'selected' : ''}>
              ${t.itemName} (${t.category === 'allowance' ? '津貼' : t.category === 'bonus' ? '獎金' : '扣款'})
            </option>`)
            .join('');
        }

        // 切換月份選擇器顯示
        window.toggleMonthSelector = function(index) {
          const selector = document.querySelector(`.month-selector-${index}`);
          const recurringTypeSelect = document.querySelector(`.item-recurring-type[data-index="${index}"]`);
          if (selector && recurringTypeSelect) {
            selector.style.display = recurringTypeSelect.value === 'yearly' ? 'block' : 'none';
          }
        };

        // 新增員工薪資項目
        window.addUserSalaryItem = function() {
          if (itemsState.all.filter(t => t.isActive).length === 0) {
            alert('請先在「薪資項目設定」中新增可用的薪資項目');
            return;
          }
          const today = new Date().toISOString().split('T')[0];
          empState.userSalaryItems.push({
            itemTypeId: itemsState.all.filter(t => t.isActive)[0]?.itemTypeId || null,
            amountCents: 0,
            recurringType: 'monthly',
            recurringMonths: null,
            effectiveDate: today,
            expiryDate: null
          });
          renderUserSalaryItems();
        };

        // 移除員工薪資項目
        window.removeUserSalaryItem = function(index) {
          empState.userSalaryItems.splice(index, 1);
          renderUserSalaryItems();
        };

        // 儲存員工薪資設定
        async function saveUserSalary() {
          if (!empState.selectedUserId) return;

          const baseSalary = parseFloat(empBaseSalary.value) || 0;
          const salaryNotes = empSalaryNotes.value.trim();

          // 收集薪資項目
          const salaryItems = [];
          const itemRows = empItemsList.querySelectorAll('.salary-item-row');
          itemRows.forEach((row, index) => {
            const typeSelect = row.querySelector('.item-type-select');
            const amountInput = row.querySelector('.item-amount');
            const recurringTypeSelect = row.querySelector('.item-recurring-type');
            const effectiveDateInput = row.querySelector('.item-effective-date');
            const expiryDateInput = row.querySelector('.item-expiry-date');
            
            const itemTypeId = parseInt(typeSelect.value);
            const amount = parseFloat(amountInput.value) || 0;
            const recurringType = recurringTypeSelect.value;
            const effectiveDate = effectiveDateInput.value || new Date().toISOString().split('T')[0];
            const expiryDate = expiryDateInput.value || null;
            
            // 收集選中的月份
            let recurringMonths = null;
            if (recurringType === 'yearly') {
              const monthCheckboxes = row.querySelectorAll(`.month-checkbox-${index}:checked`);
              const selectedMonths = Array.from(monthCheckboxes).map(cb => parseInt(cb.value));
              if (selectedMonths.length > 0) {
                recurringMonths = JSON.stringify(selectedMonths);
              }
            }
            
            if (itemTypeId && amount > 0) {
              salaryItems.push({
                itemTypeId,
                amountCents: Math.round(amount * 100),
                effectiveDate,
                expiryDate,
                recurringType,
                recurringMonths
              });
            }
          });

          try {
            const res = await fetch(`${apiBase}/admin/users/${empState.selectedUserId}/salary`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ baseSalary, salaryNotes, salaryItems })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              alert('✅ 儲存成功');
              // 清除薪資預覽快取，強制重新計算
              console.log('[員工薪資] 清除薪資預覽快取');
              payrollCache.clear();
              await loadUsers(); // 重新加載員工列表
              await loadUserSalary(empState.selectedUserId); // 重新加載當前員工
            } else {
              alert(json.message || '儲存失敗');
            }
          } catch (err) {
            console.error('saveUserSalary error:', err);
            alert('儲存失敗');
          }
        }

        // 綁定薪資項目事件
        let searchTimer = null;
        itemSearch.addEventListener('input', () => {
          clearTimeout(searchTimer);
          searchTimer = setTimeout(applyItemFilters, 300);
        });
        btnAddItem.addEventListener('click', () => openItemDialog());
        btnCancelItem.addEventListener('click', () => itemDialog.close());
        itemForm.addEventListener('submit', saveItem);

        // 綁定員工薪資設定事件
        let empSearchTimer = null;
        empSearch.addEventListener('input', () => {
          clearTimeout(empSearchTimer);
          empSearchTimer = setTimeout(applyUserFilters, 300);
        });
        btnAddEmpItem.addEventListener('click', addUserSalaryItem);
        btnCancelEmp.addEventListener('click', () => {
          empState.selectedUserId = null;
          empFormContainer.style.display = 'none';
          empEmptyState.style.display = 'block';
          renderUserList();
        });
        btnSaveEmp.addEventListener('click', saveUserSalary);

        // ==================== 績效獎金調整功能 ====================

        const tbodyBonus = document.getElementById('tbodyBonus');
        const bonusAdjustedCount = document.getElementById('bonusAdjustedCount');
        const yearBonusInput = document.getElementById('yearBonus');
        const btnSaveBonus = document.getElementById('btnSaveBonus');

        // 狀態：存儲所有員工的全年12個月數據
        let bonusState = { employees: [] };

        // 加載年度績效數據（12個月）
        async function loadYearlyBonus() {
          const year = yearBonusInput.value;
          if (!year) return;

          try {
            const res = await fetch(`${apiBase}/admin/bonus/year/${year}`, { credentials: 'include' });
            if (!res.ok) throw new Error('載入失敗');
            const json = await res.json();
            bonusState.employees = json.data?.employees || [];
            renderBonusTable();
          } catch (err) {
            console.error('loadYearlyBonus error:', err);
            tbodyBonus.innerHTML = '<tr><td colspan="13" class="muted">載入失敗</td></tr>';
          }
        }

        // 渲染全年績效表格
        function renderBonusTable() {
          if (bonusState.employees.length === 0) {
            tbodyBonus.innerHTML = '<tr><td colspan="13" class="muted">無員工資料</td></tr>';
            return;
          }

          tbodyBonus.innerHTML = bonusState.employees.map((emp, empIndex) => {
            // 生成12個月的輸入框
            const monthInputs = [];
            for (let month = 1; month <= 12; month++) {
              // 獲取該月的預設績效（考慮生效日期）
              const monthDefault = emp.monthlyDefaults?.[month] || 0;
              const defaultAmount = (monthDefault / 100).toFixed(0);
              
              // 獲取該月的調整金額
              const monthData = emp.monthlyAdjustments?.[month] || null;
              const value = monthData ? (monthData.bonusAmountCents / 100).toFixed(0) : '';
              
              // 如果有調整金額，顯示調整後的金額；否則顯示預設金額作為placeholder
              monthInputs.push(`
                <td style="padding: 4px 6px;">
                  <input type="number" 
                         class="bonus-input" 
                         data-emp-index="${empIndex}" 
                         data-month="${month}" 
                         value="${value}" 
                         placeholder="${defaultAmount}" 
                         min="0" 
                         step="1" 
                         title="預設: ${defaultAmount} 元"
                         style="width: 75px; padding: 4px 6px; text-align: right; font-size: 13px; border: 1px solid #d1d5db; border-radius: 4px;" />
                </td>
              `);
            }
            
            return `
              <tr>
                <td style="position: sticky; left: 0; background: white; font-weight: 500; padding: 6px 8px; font-size: 13px;">
                  ${emp.name || emp.username}
                </td>
                ${monthInputs.join('')}
              </tr>
            `;
          }).join('');

          updateBonusSummary();
        }

        // 更新統計摘要
        function updateBonusSummary() {
          let totalAdjustments = 0;
          bonusState.employees.forEach(emp => {
            if (emp.monthlyAdjustments) {
              totalAdjustments += Object.keys(emp.monthlyAdjustments).length;
            }
          });
          bonusAdjustedCount.textContent = totalAdjustments;
        }

        // 儲存全年績效調整
        async function saveYearlyBonus() {
          const year = yearBonusInput.value;
          if (!year) {
            alert('請選擇年度');
            return;
          }

          // 收集所有月份的調整數據
          const allAdjustments = [];
          const inputs = tbodyBonus.querySelectorAll('.bonus-input');

          inputs.forEach(input => {
            const empIndex = parseInt(input.dataset.empIndex);
            const month = parseInt(input.dataset.month);
            const emp = bonusState.employees[empIndex];
            
            if (!emp) return;

            const value = input.value.trim();
            
            // 只保存有填寫金額的項目
            if (value !== '') {
              const monthStr = `${year}-${String(month).padStart(2, '0')}`;
              allAdjustments.push({
                userId: emp.userId,
                month: monthStr,
                bonusAmountCents: Math.round(parseFloat(value) * 100),
                notes: null
              });
            }
          });

          try {
            const res = await fetch(`${apiBase}/admin/bonus/year/${year}`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ adjustments: allAdjustments })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              alert('✅ 全年績效調整已儲存');
              // 清除薪資預覽快取
              console.log('[全年績效獎金] 清除薪資預覽快取');
              payrollCache.clear();
              await loadYearlyBonus();
            } else {
              alert(json.message || '儲存失敗');
            }
          } catch (err) {
            console.error('saveYearlyBonus error:', err);
            alert('儲存失敗');
          }
        }

        // 監聽績效獎金輸入框的變更（使用事件委託）
        tbodyBonus.addEventListener('input', (e) => {
          if (e.target.classList.contains('bonus-input')) {
            const empIndex = parseInt(e.target.dataset.empIndex);
            const month = parseInt(e.target.dataset.month);
            const value = e.target.value.trim();
            
            // 更新 bonusState
            if (bonusState.employees[empIndex]) {
              if (!bonusState.employees[empIndex].monthlyAdjustments) {
                bonusState.employees[empIndex].monthlyAdjustments = {};
              }
              
              if (value !== '') {
                bonusState.employees[empIndex].monthlyAdjustments[month] = {
                  bonusAmountCents: Math.round(parseFloat(value) * 100)
                };
              } else {
                delete bonusState.employees[empIndex].monthlyAdjustments[month];
              }
              
              updateBonusSummary();
            }
          }
        });

        // 綁定績效獎金事件
        yearBonusInput.addEventListener('change', loadYearlyBonus);
        btnSaveBonus.addEventListener('click', saveYearlyBonus);

        // ==================== 年終獎金管理功能 ====================

        const tbodyYearend = document.getElementById('tbodyYearend');
        const yearendStats = document.getElementById('yearendStats');
        const yearInput = document.getElementById('yearInput');
        const btnSaveYearend = document.getElementById('btnSaveYearend');

        let yearendState = { employees: [], summary: { totalCents: 0, count: 0, averageCents: 0 } };

        // 加載年度年終獎金數據
        async function loadYearEndBonus() {
          const year = yearInput.value;
          if (!year) return;

          try {
            const res = await fetch(`${apiBase}/admin/yearend/${year}`, { credentials: 'include' });
            if (!res.ok) throw new Error('載入失敗');
            const json = await res.json();
            yearendState.employees = json.data?.employees || [];
            yearendState.summary = json.data?.summary || { totalCents: 0, count: 0, averageCents: 0 };
            renderYearendTable();
          } catch (err) {
            console.error('loadYearEndBonus error:', err);
            tbodyYearend.innerHTML = '<tr><td colspan="5" class="muted">載入失敗</td></tr>';
          }
        }

        // 渲染年終獎金表格
        function renderYearendTable() {
          if (yearendState.employees.length === 0) {
            tbodyYearend.innerHTML = '<tr><td colspan="5" class="muted">無員工資料</td></tr>';
            return;
          }

          tbodyYearend.innerHTML = yearendState.employees.map((emp, index) => {
            const amount = (emp.amountCents / 100).toFixed(2);
            
            return `
              <tr>
                <td>${emp.name || emp.username}</td>
                <td>${emp.baseSalary.toLocaleString()}</td>
                <td>
                  <input type="number" class="yearend-amount" data-index="${index}" 
                         value="${amount > 0 ? amount : ''}" 
                         placeholder="0.00" 
                         min="0" step="0.01" 
                         style="width: 120px;" />
                </td>
                <td>
                  <input type="month" class="yearend-month" data-index="${index}" 
                         value="${emp.paymentMonth || ''}" 
                         placeholder="YYYY-MM"
                         style="width: 150px;" />
                </td>
                <td>
                  <input type="text" class="yearend-notes" data-index="${index}" 
                         value="${emp.notes || ''}" 
                         placeholder="備註" 
                         style="width: 200px;" />
                </td>
              </tr>
            `;
          }).join('');

          updateYearendStats();
        }

        // 更新統計資訊
        function updateYearendStats() {
          const total = (yearendState.summary.totalCents / 100).toLocaleString();
          const count = yearendState.summary.count;
          const average = (yearendState.summary.averageCents / 100).toLocaleString();
          
          yearendStats.innerHTML = `
            <span>總額：${total} 元</span>
            <span>人數：${count}</span>
            <span>平均：${average} 元</span>
          `;
        }

        // 儲存年終獎金
        async function saveYearEndBonus() {
          const year = yearInput.value;
          if (!year) return;

          // 收集獎金數據
          const bonuses = [];
          const amountInputs = tbodyYearend.querySelectorAll('.yearend-amount');
          const monthInputs = tbodyYearend.querySelectorAll('.yearend-month');
          const notesInputs = tbodyYearend.querySelectorAll('.yearend-notes');

          amountInputs.forEach((input, index) => {
            const emp = yearendState.employees[index];
            if (!emp) return;

            const amount = parseFloat(input.value) || 0;
            const paymentMonth = monthInputs[index].value || null;
            const notes = notesInputs[index].value.trim() || null;

            if (amount > 0) {
              bonuses.push({
                userId: emp.userId,
                amountCents: Math.round(amount * 100),
                paymentMonth,
                notes
              });
            }
          });

          try {
            const res = await fetch(`${apiBase}/admin/yearend/${year}`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ bonuses })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              alert('✅ 儲存成功');
              // 清除薪资预览缓存，强制重新计算
              console.log('[年终奖金] 清除薪资预览缓存');
              payrollCache.clear();
              await loadYearEndBonus();
            } else {
              alert(json.message || '儲存失敗');
            }
          } catch (err) {
            console.error('saveYearEndBonus error:', err);
            alert('儲存失敗');
          }
        }

        // 綁定年終獎金事件
        yearInput.addEventListener('change', loadYearEndBonus);
        btnSaveYearend.addEventListener('click', saveYearEndBonus);

        // ==================== 系統設定功能 ====================

        const btnSaveSettings = document.getElementById('btnSaveSettings');
        let systemSettings = [];

        // 加載系統設定
        async function loadSystemSettings() {
          try {
            const res = await fetch(`${apiBase}/admin/payroll-settings`, { credentials: 'include' });
            if (!res.ok) throw new Error('載入失敗');
            const json = await res.json();
            systemSettings = json.data?.settings || [];
            renderSystemSettings();
          } catch (err) {
            console.error('loadSystemSettings error:', err);
            alert('載入系統設定失敗');
          }
        }

        // 渲染系統設定
        function renderSystemSettings() {
          systemSettings.forEach(setting => {
            const inputId = `setting_${setting.settingKey}`;
            const input = document.getElementById(inputId);
            if (input) {
              input.value = setting.settingValue;
            }
          });
        }

        // 儲存系統設定
        async function saveSystemSettings() {
          if (!confirm('確定要更新系統設定嗎？\n\n這會影響未來所有的薪資計算。')) return;

          const settings = [];
          systemSettings.forEach(setting => {
            const inputId = `setting_${setting.settingKey}`;
            const input = document.getElementById(inputId);
            if (input) {
              settings.push({
                settingKey: setting.settingKey,
                settingValue: input.value
              });
            }
          });

          try {
            const res = await fetch(`${apiBase}/admin/payroll-settings`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ settings })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              alert('✅ 設定已更新');
              await loadSystemSettings();
            } else {
              alert(json.message || '更新失敗');
            }
          } catch (err) {
            console.error('saveSystemSettings error:', err);
            alert('更新失敗');
          }
        }

        // 綁定系統設定事件
        btnSaveSettings.addEventListener('click', saveSystemSettings);

        // ==================== 打卡記錄上傳功能 ====================

        const punchFileInput = document.getElementById('punchFileInput');
        const btnSelectFile = document.getElementById('btnSelectFile');
        const uploadForm = document.getElementById('uploadForm');
        const selectedFileName = document.getElementById('selectedFileName');
        const punchMonth = document.getElementById('punchMonth');
        const punchNotes = document.getElementById('punchNotes');
        const btnUploadFile = document.getElementById('btnUploadFile');
        const btnCancelUpload = document.getElementById('btnCancelUpload');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const uploadStatus = document.getElementById('uploadStatus');
        const punchFilesList = document.getElementById('punchFilesList');
        const btnRefreshFiles = document.getElementById('btnRefreshFiles');
        const punchAdminTools = document.getElementById('punchAdminTools');
        const punchUserSelect = document.getElementById('punchUserSelect');

        let selectedFile = null;
        let currentUserId = null;
        let isAdminMode = false; // 是否為管理員模式

        // 選擇檔案
        btnSelectFile.addEventListener('click', () => {
          punchFileInput.click();
        });

        punchFileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;

          // 檢查檔案大小（10MB）
          if (file.size > 10 * 1024 * 1024) {
            alert('檔案大小不能超過 10MB');
            punchFileInput.value = '';
            return;
          }

          selectedFile = file;
          selectedFileName.textContent = file.name;
          uploadForm.style.display = 'block';
          
          // 自動設定月份為當前月份
          if (!punchMonth.value) {
            const now = new Date();
            punchMonth.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
          }
        });

        // 取消上傳
        btnCancelUpload.addEventListener('click', () => {
          selectedFile = null;
          punchFileInput.value = '';
          uploadForm.style.display = 'none';
          uploadProgress.style.display = 'none';
        });

        // 開始上傳
        btnUploadFile.addEventListener('click', async () => {
          if (!selectedFile) {
            alert('請先選擇檔案');
            return;
          }

          if (!punchMonth.value) {
            alert('請選擇所屬月份');
            return;
          }

          try {
            btnUploadFile.disabled = true;
            btnCancelUpload.disabled = true;
            uploadProgress.style.display = 'block';
            uploadProgressBar.style.width = '50%';
            uploadStatus.textContent = '正在上傳檔案...';

            // 使用FormData上傳
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('month', punchMonth.value);
            if (punchNotes.value) {
              formData.append('notes', punchNotes.value);
            }

            const uploadRes = await fetch(`${apiBase}/punch-records/upload`, {
              method: 'POST',
              credentials: 'include',
              body: formData
            });

            if (!uploadRes.ok) throw new Error('檔案上傳失敗');
            const json = await uploadRes.json();

            uploadProgressBar.style.width = '100%';
            uploadStatus.textContent = '✅ 上傳完成！';

            // 重置表單
            setTimeout(() => {
              selectedFile = null;
              punchFileInput.value = '';
              punchNotes.value = '';
              uploadForm.style.display = 'none';
              uploadProgress.style.display = 'none';
              uploadProgressBar.style.width = '0%';
              btnUploadFile.disabled = false;
              btnCancelUpload.disabled = false;
              
              // 重新載入列表
              loadPunchRecords(currentUserId);
            }, 1500);

          } catch (err) {
            console.error('上傳失敗:', err);
            alert('上傳失敗：' + err.message);
            uploadProgress.style.display = 'none';
            btnUploadFile.disabled = false;
            btnCancelUpload.disabled = false;
          }
        });

        // 載入打卡記錄列表
        async function loadPunchRecords(userId) {
          console.log('[打卡記錄] 開始載入，用戶ID:', userId);
          currentUserId = userId;
          
          // 顯示載入中狀態
          punchFilesList.innerHTML = '<tr><td colspan="3" class="muted" style="padding: 2rem; text-align: center;">載入中...</td></tr>';
          
          try {
            const res = await fetch(`${apiBase}/punch-records`, { credentials: 'include' });
            console.log('[打卡記錄] API 回應狀態:', res.status);
            if (!res.ok) throw new Error('載入失敗：' + res.status);
            const json = await res.json();
            console.log('[打卡記錄] 收到資料:', json);
            const records = json.data?.records || [];
            console.log('[打卡記錄] 記錄數量:', records.length);
            renderPunchRecords(records);
          } catch (err) {
            console.error('[打卡記錄] 載入失敗:', err);
            punchFilesList.innerHTML = '<tr><td colspan="3" class="muted" style="padding: 2rem; text-align: center;">載入失敗：' + err.message + '</td></tr>';
          }
        }

        // 渲染打卡記錄列表
        function renderPunchRecords(records) {
          if (records.length === 0) {
            punchFilesList.innerHTML = '<tr><td colspan="3" class="muted" style="padding: 2rem; text-align: center;">尚無上傳記錄</td></tr>';
            return;
          }

          punchFilesList.innerHTML = records.map(record => {
            const fileSize = (record.fileSizeBytes / 1024).toFixed(1) + ' KB';
            
            // 判断文件类型是否可预览
            const fileType = record.fileType || '';
            const canPreview = fileType.includes('pdf') || 
                             fileType.includes('image') || 
                             fileType.startsWith('image/');
            
            // 添加点击行预览
            const rowClass = canPreview ? 'style="cursor: pointer;"' : '';
            const rowClick = canPreview ? `onclick="previewPunchRecord(${record.recordId}, '${record.fileName}', '${fileType}')"` : '';

            return `
              <tr ${rowClass} ${rowClick}>
                <td style="padding: 0.75rem 0.5rem;">${record.month}</td>
                <td style="padding: 0.75rem 0.5rem;">
                  <div style="font-weight: 500; font-size: 0.875rem;">${record.fileName}</div>
                  <div style="font-size: 0.75rem; color: #6b7280; margin-top: 2px;">${fileSize}${record.notes ? ' • ' + record.notes : ''}</div>
                </td>
                <td style="padding: 0.75rem 0.5rem; white-space: nowrap;">
                  <button class="btn" onclick="event.stopPropagation(); downloadPunchRecord('${record.recordId}', '${record.fileName}')" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; margin-right: 0.25rem;">
                    ⬇️
                  </button>
                  <button class="btn" onclick="event.stopPropagation(); deletePunchRecord('${record.recordId}')" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; color: #dc2626;">
                    🗑️
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        }

        // 用於釋放blob URL
        let currentPreviewBlobUrl = null;

        // 預覽打卡記錄（在當前頁面預覽區域顯示）
        window.previewPunchRecord = async function(recordId, fileName, fileType) {
          const previewArea = document.getElementById('punchPreviewArea');
          if (!previewArea) return;

          // 清理之前的 blob URL
          if (currentPreviewBlobUrl) {
            URL.revokeObjectURL(currentPreviewBlobUrl);
            currentPreviewBlobUrl = null;
          }

          // 顯示載入中
          previewArea.innerHTML = `
            <div style="text-align:center;padding:60px 20px;color:#6b7280;">
              <div style="font-size:48px;margin-bottom:16px;">⏳</div>
              <div>載入中...</div>
            </div>
          `;

          try {
            const previewUrl = `${apiBase}/punch-records/${recordId}/preview`;
            const res = await fetch(previewUrl, { credentials: 'include' });
            
            if (!res.ok) {
              throw new Error('無法載入文件');
            }
            
            const blob = await res.blob();
            const blobUrl = URL.createObjectURL(blob);
            currentPreviewBlobUrl = blobUrl;

            // 根據文件類型顯示預覽
            if (fileType.includes('pdf') || fileName.match(/\.pdf$/i)) {
              // PDF預覽 - 全屏显示
              previewArea.innerHTML = `
                <iframe src="${blobUrl}#view=FitH" style="width:100%;height:85vh;border:none;background:white;"></iframe>
              `;
            } else if (fileType.includes('image') || fileName.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
              // 圖片預覽 - 全屏显示
              previewArea.innerHTML = `
                <div style="width:100%;height:85vh;display:flex;align-items:center;justify-content:center;background:#f5f5f5;">
                  <img src="${blobUrl}" style="max-width:100%;max-height:100%;object-fit:contain;" />
                </div>
              `;
            } else {
              // 其他文件類型，顯示下載提示
              previewArea.innerHTML = `
                <div style="text-align:center;padding:60px 20px;height:85vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f9fafb;">
                  <div style="font-size:64px;margin-bottom:20px;">📄</div>
                  <h3 style="margin-bottom:12px;color:#374151;font-size:18px;">${fileName}</h3>
                  <p style="color:#9ca3af;margin-bottom:24px;font-size:13px;">此文件類型不支援線上預覽</p>
                  <button class="btn primary" onclick="downloadPunchRecord('${recordId}', '${fileName}')" style="text-decoration:none;">
                    <span>💾 下載文件</span>
                  </button>
                </div>
              `;
            }
          } catch (err) {
            console.error('預覽文檔失敗:', err);
            previewArea.innerHTML = `
              <div style="text-align:center;padding:60px 20px;color:#c0392b;">
                <div style="font-size:48px;margin-bottom:16px;">⚠️</div>
                <div style="font-size:16px;font-weight:600;margin-bottom:8px;">載入失敗</div>
                <div style="font-size:13px;color:#6b7280;">${err.message}</div>
              </div>
            `;
          }
        };

        // 下載打卡記錄
        window.downloadPunchRecord = function(recordId, fileName) {
          // 直接打開下載連結
          const downloadUrl = `${apiBase}/punch-records/${recordId}/download`;
          window.open(downloadUrl, '_blank');
        };

        // 刪除打卡記錄
        window.deletePunchRecord = async function(recordId) {
          if (!confirm('確定要刪除此檔案嗎？')) return;

          try {
            const res = await fetch(`${apiBase}/punch-records/${recordId}`, {
              method: 'DELETE',
              credentials: 'include'
            });

            if (!res.ok) throw new Error('刪除失敗');

            alert('✅ 刪除成功');
            loadPunchRecords(currentUserId);
          } catch (err) {
            console.error('刪除失敗:', err);
            alert('刪除失敗：' + err.message);
          }
        };

        // 刷新列表
        btnRefreshFiles.addEventListener('click', () => {
          if (currentUserId) {
            loadPunchRecords(currentUserId);
          }
        });

        // 管理員：初始化員工選擇器
        async function initAdminPunchSelector() {
          console.log('[打卡記錄] 初始化管理員模式');
          isAdminMode = true;
          punchAdminTools.style.display = 'block';
          
          // 更新占位文字
          punchFilesList.innerHTML = '<tr><td colspan="3" class="muted" style="padding: 2rem; text-align: center;">請先選擇員工</td></tr>';
          
          try {
            // 獲取所有員工（復用全局的 empState.allUsers 或重新載入）
            let users = empState?.allUsers;
            if (!users || users.length === 0) {
              console.log('[打卡記錄] empState 為空，重新載入員工列表');
              const res = await fetch(`${apiBase}/admin/users`, { credentials: 'include' });
              if (!res.ok) throw new Error('無法載入員工列表');
              const json = await res.json();
              users = json.data?.users || []; // 注意：需要取 .users
              console.log('[打卡記錄] API 返回員工數據:', users);
            }
            
            // 填充選擇器（使用正確的字段名：userId 和 name）
            punchUserSelect.innerHTML = '<option value="">請選擇員工...</option>';
            users.forEach(u => {
              const opt = document.createElement('option');
              opt.value = u.userId; // 驼峰式
              opt.textContent = `${u.name || u.username}`;
              punchUserSelect.appendChild(opt);
            });
            
            console.log('[打卡記錄] 管理員模式就緒，共', users.length, '位員工');
          } catch (err) {
            console.error('[打卡記錄] 初始化失敗:', err);
            alert('載入員工列表失敗：' + err.message);
            punchFilesList.innerHTML = '<tr><td colspan="3" class="muted" style="padding: 2rem; text-align: center; color: red;">載入失敗</td></tr>';
          }
        }

        // 管理員：選擇員工時載入其打卡記錄
        punchUserSelect.addEventListener('change', (e) => {
          const userId = parseInt(e.target.value);
          if (userId) {
            console.log('[打卡記錄] 管理員選擇員工:', userId);
            currentUserId = userId;
            loadPunchRecords(userId);
          } else {
            // 清空列表
            punchFilesList.innerHTML = '<tr><td colspan="3" class="muted" style="padding: 2rem; text-align: center;">請先選擇員工</td></tr>';
          }
        });

        // 預設月份為本月
        const now = new Date();
        monthInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        const monthBonus = document.getElementById('monthBonus');
        if (monthBonus) monthBonus.value = monthInput.value;
        
        // 預設年份為今年
        yearInput.value = now.getFullYear();

        // 綁定事件
        monthInput.addEventListener('change', ()=>{ loadPreview(); checkFinalized(); });
        btnFinalize.addEventListener('click', finalizeMonth);
        
        // 刷新按鈕：強制重新載入資料
        document.getElementById('btnRefreshCalc').addEventListener('click', () => {
          console.log('[薪資計算] 強制刷新資料');
          loadPreview(true); // forceRefresh = true
        });

        // 初始化（極簡版）
        switchTab('calc');
        
        ensureAdmin().then(result => { 
          if (result.isAdmin) {
            isAdminMode = true; // 設置管理員模式
            loadPreview(); 
            checkFinalized(); 
            loadItems();
            loadUsers();
            
            // 初始化績效獎金年份下拉選單
            const currentYear = new Date().getFullYear();
            const yearOptions = [];
            for (let y = currentYear + 1; y >= currentYear - 5; y--) {
              yearOptions.push(`<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}年</option>`);
            }
            yearBonusInput.innerHTML = yearOptions.join('');
            loadYearlyBonus(); // 載入全年績效獎金
            
            loadYearEndBonus(); // 載入年終獎金
            loadSystemSettings(); // 載入系統設定
            
            console.log('[初始化] 管理員模式已啟用（打卡記錄將在切換到該TAB時初始化）');
          } else if (result.userData) {
            // 普通員工：設置當前用戶ID，打卡記錄在切換到該TAB時載入
            console.log('[初始化] 普通員工登入');
            currentUserId = result.userData.user_id;
            isAdminMode = false;
          } 
        });
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


