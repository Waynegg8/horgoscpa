<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="è–ªè³‡ç®¡ç†" />
    <title>è–ªè³‡ç®¡ç†ï½œç¸½è¦½</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/payroll-page.css" />
    
    <!-- âš¡ é¢„åŠ è½½ä¸ç¼“å­˜ç³»ç»Ÿ -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <script src="/assets/js/prerender.js"></script>
    <script src="/assets/js/page-prerender.js"></script>
  </head>
  <body class="payroll-page">
    <div style="padding:16px 20px;">
      <div id="infoBar" class="info-bar" style="display:none;" role="alert">æ‚¨æ²’æœ‰æ¬Šé™å­˜å–æ­¤æ¨¡çµ„</div>
      <div class="payroll-toolbar" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
        <label for="month">æœˆä»½</label>
        <input id="month" type="month" aria-label="æœˆä»½" />
        <div class="toolbar-spacer" style="flex:1;"></div>
        <button id="btn-finalize" type="button" class="btn primary" disabled>ç”¢è£½æœˆçµ</button>
        <button id="btn-export-csv" type="button" class="btn" disabled>åŒ¯å‡º CSV</button>
        <button id="btn-export-pdf" type="button" class="btn" disabled>åŒ¯å‡º PDF</button>
      </div>
      <div id="finalizeMsg" class="info-bar" style="display:none;"></div>
      <nav class="payroll-tabs" role="tablist" aria-label="è–ªè³‡ç®¡ç†åˆ†é " style="display:flex;gap:8px;border-bottom:2px solid #e5e7eb;">
        <button class="tab active" role="tab" aria-selected="true" data-tab="calc">è–ªè³‡è¨ˆç®—</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="items">è–ªè³‡é …ç›®è¨­å®š</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="emp">å“¡å·¥è–ªè³‡è¨­å®š</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="bonus">ç¸¾æ•ˆçé‡‘èª¿æ•´</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="yearend">å¹´çµ‚çé‡‘</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="settings">âš™ï¸ ç³»çµ±è¨­å®š</button>
      </nav>
    </div>

    <main class="payroll-content">
      <!-- è–ªè³‡è¨ˆç®— -->
      <section id="panel-calc" class="panel show" role="tabpanel" aria-labelledby="tab-calc">
        <div class="card">
          <div class="section-toolbar">
            <input id="empSearchCalc" type="search" placeholder="æœå°‹å“¡å·¥â€¦" />
            <select id="statusCalc">
              <option value="all">å…¨éƒ¨</option>
              <option value="complete">å·²å®Œæˆ</option>
              <option value="pending">æœªå®Œæˆ</option>
            </select>
          </div>
          <table class="table" aria-label="è–ªè³‡è¨ˆç®—åˆ—è¡¨" style="font-size: 0.875rem;">
            <thead>
              <tr>
                <th rowspan="2">å§“å</th>
                <th rowspan="2">åº•è–ª</th>
                <th colspan="7" style="background: #f0fdf4; text-align: center;">æ”¶å…¥æ˜ç´°</th>
                <th colspan="2" style="background: #fef2f2; text-align: center;">æ‰£æ¬¾æ˜ç´°</th>
                <th rowspan="2" style="background: #f0f9ff;">æ‡‰ç™¼</th>
                <th rowspan="2" style="background: #dbeafe;">å¯¦ç™¼</th>
              </tr>
              <tr>
                <th style="background: #f0fdf4;">æ´¥è²¼</th>
                <th style="background: #f0fdf4;">çé‡‘</th>
                <th style="background: #f0fdf4;">å…¨å‹¤</th>
                <th style="background: #f0fdf4;">åŠ ç­è²»<br><small style="font-weight:normal;font-size:0.75rem;">å·¥æ™‚Ã—æ™‚è–ª</small></th>
                <th style="background: #f0fdf4;">èª¤é¤è²»<br><small style="font-weight:normal;font-size:0.75rem;">å¤©æ•¸Ã—å–®åƒ¹</small></th>
                <th style="background: #f0fdf4;">äº¤é€š<br><small style="font-weight:normal;font-size:0.75rem;">é‡Œç¨‹</small></th>
                <th style="background: #f0fdf4;">ç¸¾æ•ˆ</th>
                <th style="background: #fef2f2;">å›ºå®š<br><small style="font-weight:normal;font-size:0.75rem;">å‹å¥ä¿ç­‰</small></th>
                <th style="background: #fef2f2;">è«‹å‡<br><small style="font-weight:normal;font-size:0.75rem;">ç—…/äº‹å‡</small></th>
              </tr>
            </thead>
            <tbody id="tbodyCalc">
              <tr><td colspan="12" class="muted">å°šç„¡è³‡æ–™</td></tr>
            </tbody>
          </table>
          <div class="pagination">
            <button type="button" id="prevCalc">ä¸Šä¸€é </button>
            <button type="button" id="nextCalc">ä¸‹ä¸€é </button>
          </div>
        </div>
      </section>

      <!-- è–ªè³‡é …ç›®è¨­å®š -->
      <section id="panel-items" class="panel" role="tabpanel" aria-labelledby="tab-items">
        <div class="card">
          <div class="section-toolbar">
            <input id="itemSearch" type="search" placeholder="æœå°‹é …ç›®ä»£ç¢¼/åç¨±â€¦" />
            <button type="button" id="btnAddItem" class="btn primary">æ–°å¢é …ç›®</button>
          </div>
          <table class="table" aria-label="è–ªè³‡é …ç›®åˆ—è¡¨">
            <thead>
              <tr>
                <th>é …ç›®ä»£ç¢¼</th>
                <th>é …ç›®åç¨±</th>
                <th>é¡åˆ¥</th>
                <th>ç¶“å¸¸æ€§çµ¦èˆ‡</th>
                <th>é‡‘é¡å›ºå®š</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbodyItems">
              <tr><td colspan="7" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- æ–°å¢/ç·¨è¼¯è–ªè³‡é …ç›®å°è©±æ¡† -->
      <dialog id="itemDialog" style="border-radius:12px;border:1px solid #e5e7eb;padding:0;width:90%;max-width:520px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);">
        <div style="padding:24px;border-bottom:1px solid #e5e7eb;background:#f9fafb;">
          <h3 id="itemDialogTitle" style="margin:0;font-size:20px;font-weight:600;color:#111827;">æ–°å¢è–ªè³‡é …ç›®</h3>
          <p style="margin:8px 0 0;font-size:14px;color:#6b7280;">è¨­å®šè–ªè³‡é …ç›®çš„åŸºæœ¬è³‡è¨Š</p>
        </div>
        <form id="itemForm" style="padding:24px;">
          <input type="hidden" id="itemTypeId" />
          <input type="hidden" id="itemCode" />
          
          <div style="margin-bottom:20px;">
            <label for="itemName" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">
              é …ç›®åç¨± <span style="color:#dc2626;">*</span>
            </label>
            <input id="itemName" type="text" required maxlength="50" placeholder="ä¾‹å¦‚ï¼šä¼™é£Ÿæ´¥è²¼ã€å…¨å‹¤çé‡‘" 
              style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;" />
            <small style="color:#6b7280;display:block;margin-top:4px;">ğŸ’¡ è¼¸å…¥æ¸…æ¥šæ˜“æ‡‚çš„åç¨±ï¼Œæ–¹ä¾¿å“¡å·¥è­˜åˆ¥</small>
          </div>

          <div style="margin-bottom:20px;">
            <label for="itemCategory" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">
              é¡åˆ¥ <span style="color:#dc2626;">*</span>
            </label>
            <select id="itemCategory" required style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
              <option value="">-- è«‹é¸æ“‡é¡åˆ¥ --</option>
              <option value="allowance">ğŸ’° æ´¥è²¼ï¼ˆå¦‚ï¼šäº¤é€šã€ä¼™é£Ÿã€é›»è©±ï¼‰</option>
              <option value="bonus">ğŸ çé‡‘ï¼ˆå¦‚ï¼šå…¨å‹¤ã€ç¸¾æ•ˆã€å¹´çµ‚ï¼‰</option>
              <option value="deduction">â– æ‰£æ¬¾ï¼ˆå¦‚ï¼šä¿è²»ã€é²åˆ°ï¼‰</option>
            </select>
            <small style="color:#6b7280;display:block;margin-top:4px;">ğŸ“‹ ä¾æ“šé …ç›®æ€§è³ªé¸æ“‡å°æ‡‰é¡åˆ¥</small>
          </div>

          <div style="margin-bottom:20px;background:#f0f9ff;padding:16px;border-radius:8px;border:1px solid #bfdbfe;">
            <label style="display:flex;align-items:flex-start;cursor:pointer;">
              <input type="checkbox" id="itemIsRegular" style="margin-top:2px;margin-right:10px;width:18px;height:18px;" />
              <div>
                <span style="font-weight:500;color:#1e40af;">ç¶“å¸¸æ€§çµ¦èˆ‡ï¼ˆè¨ˆå…¥æ™‚è–ªåŸºæº–ï¼‰</span>
                <small style="color:#1e40af;display:block;margin-top:4px;line-height:1.5;">
                  âš ï¸ <strong>é‡è¦ï¼š</strong>å‹¾é¸å¾Œæœƒè¨ˆå…¥æ™‚è–ªè¨ˆç®—ï¼Œå½±éŸ¿åŠ ç­è²»é‡‘é¡å’Œæˆæœ¬åˆ†æ<br>
                  âœ“ æ‡‰å‹¾é¸ï¼šå›ºå®šæ´¥è²¼ï¼ˆä¼™é£Ÿã€äº¤é€šï¼‰ã€å…¨å‹¤çé‡‘ã€æ¯æœˆå›ºå®šç¸¾æ•ˆ<br>
                  âœ— ä¸å‹¾é¸ï¼šå¹´çµ‚çé‡‘ã€ä¸‰ç¯€çé‡‘ã€è‡¨æ™‚æ€§çé‡‘
                </small>
              </div>
            </label>
          </div>

          <div style="margin-bottom:20px;">
            <label style="display:flex;align-items:center;cursor:pointer;">
              <input type="checkbox" id="itemIsFixed" style="margin-right:10px;width:18px;height:18px;" />
              <span style="font-weight:500;color:#374151;">é‡‘é¡å›ºå®š</span>
            </label>
            <small style="color:#6b7280;display:block;margin-top:6px;margin-left:28px;">
              å‹¾é¸è¡¨ç¤ºæ¯å€‹æœˆé‡‘é¡å›ºå®šï¼ˆå¦‚å›ºå®š 2,400 å…ƒä¼™é£Ÿæ´¥è²¼ï¼‰<br>
              ä¸å‹¾é¸è¡¨ç¤ºé‡‘é¡å¯èƒ½è®Šå‹•ï¼ˆå¦‚ä¾è¡¨ç¾èª¿æ•´çš„ç¸¾æ•ˆçé‡‘ï¼‰
            </small>
          </div>

          <div style="margin-bottom:20px;">
            <label for="itemDescription" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
            <textarea id="itemDescription" rows="3" maxlength="200" placeholder="ä¾‹å¦‚ï¼šæ¯æœˆå›ºå®šç™¼æ”¾ï¼Œç”¨æ–¼è£œåŠ©å“¡å·¥ä¼™é£Ÿè²»ç”¨" 
              style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;resize:vertical;"></textarea>
            <small style="color:#6b7280;display:block;margin-top:4px;">å¯èªªæ˜ç™¼æ”¾æ¢ä»¶ã€è¨ˆç®—æ–¹å¼ç­‰</small>
          </div>

          <div style="margin-bottom:20px;">
            <label for="itemDisplayOrder" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">é¡¯ç¤ºé †åº</label>
            <input id="itemDisplayOrder" type="number" min="0" value="99" 
              style="width:120px;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;" />
            <small style="color:#6b7280;display:block;margin-top:4px;">æ•¸å­—è¶Šå°è¶Šé å‰é¡¯ç¤ºï¼Œé è¨­ç‚º 99</small>
          </div>

          <div id="itemErrorMsg" style="color:#dc2626;margin-bottom:16px;display:none;padding:12px;background:#fee;border-radius:6px;border:1px solid #fecaca;"></div>
          
          <div style="display:flex;gap:12px;justify-content:flex-end;padding-top:20px;border-top:1px solid #e5e7eb;">
            <button type="button" id="btnCancelItem" class="btn" style="min-width:100px;">å–æ¶ˆ</button>
            <button type="submit" class="btn primary" style="min-width:100px;">ğŸ’¾ å„²å­˜</button>
          </div>
        </form>
      </dialog>

      <!-- å“¡å·¥è–ªè³‡è¨­å®š -->
      <section id="panel-emp" class="panel" role="tabpanel" aria-labelledby="tab-emp">
        <div class="card grid">
          <div class="col">
            <div class="section-toolbar">
              <input id="empSearch" type="search" placeholder="æœå°‹å“¡å·¥â€¦" />
            </div>
            <ul id="empList" class="list" aria-label="å“¡å·¥æ¸…å–®">
              <li class="muted">è¼‰å…¥ä¸­...</li>
            </ul>
          </div>
          <div class="col">
            <div id="empFormContainer" style="display: none;">
              <h3 id="empFormTitle">è«‹é¸æ“‡å“¡å·¥</h3>
              <div class="form">
                <div class="row">
                  <label>åº•è–ª</label>
                  <input id="empBaseSalary" type="number" min="0" step="1" placeholder="ä¾‹å¦‚ 40000" />
                </div>
                <div class="row">
                  <label>å‚™è¨»</label>
                  <textarea id="empSalaryNotes" rows="2" placeholder="è–ªè³‡å‚™è¨»"></textarea>
                </div>
                <hr />
                <div class="row">
                  <label>è–ªè³‡é …ç›®</label>
                  <button id="btnAddEmpItem" class="btn btn-sm" type="button">â• æ–°å¢é …ç›®</button>
                </div>
                <div id="empItemsList">
                  <small class="muted">å°šç„¡è–ªè³‡é …ç›®</small>
                </div>
                <div class="row">
                  <small class="muted">ğŸ’¡ æç¤ºï¼šå‹¾é¸ã€Œç¶“å¸¸æ€§çµ¦èˆ‡ã€å°‡è¨ˆå…¥æ™‚è–ªï¼Œå½±éŸ¿åŠ ç­è²»èˆ‡æˆæœ¬åˆ†æã€‚</small>
                </div>
                <div class="actions">
                  <button id="btnCancelEmp" class="btn" type="button">å–æ¶ˆ</button>
                  <button id="btnSaveEmp" class="btn primary" type="button">ğŸ’¾ å„²å­˜</button>
                </div>
              </div>
            </div>
            <div id="empEmptyState" style="text-align: center; padding: 2rem; color: #999;">
              ğŸ‘ˆ è«‹å¾å·¦å´é¸æ“‡å“¡å·¥
            </div>
          </div>
        </div>
      </section>

      <!-- ç¸¾æ•ˆçé‡‘èª¿æ•´ -->
      <section id="panel-bonus" class="panel" role="tabpanel" aria-labelledby="tab-bonus">
        <div class="card">
          <div class="section-toolbar">
            <label for="monthBonus">æœˆä»½</label>
            <input id="monthBonus" type="month" />
            <div class="toolbar-spacer"></div>
            <button id="btnResetBonus" class="btn">ğŸ”„ å…¨éƒ¨æ¢å¾©é è¨­</button>
            <button id="btnSaveBonus" class="btn primary">ğŸ’¾ å„²å­˜æ‰€æœ‰èª¿æ•´</button>
          </div>
          <table class="table" aria-label="ç¸¾æ•ˆçé‡‘èª¿æ•´">
            <thead>
              <tr>
                <th>å§“å</th>
                <th>åº•è–ª</th>
                <th>é è¨­ç¸¾æ•ˆ</th>
                <th>æœ¬æœˆèª¿æ•´</th>
                <th>å‚™è¨»</th>
              </tr>
            </thead>
            <tbody id="tbodyBonus">
              <tr><td colspan="5" class="muted">è¼‰å…¥ä¸­...</td></tr>
            </tbody>
          </table>
          <div id="bonusSummary" class="summary muted">å·²èª¿æ•´äººæ•¸ 0</div>
        </div>
      </section>

      <!-- å¹´çµ‚çé‡‘ç®¡ç† -->
      <section id="panel-yearend" class="panel" role="tabpanel" aria-labelledby="tab-yearend">
        <div class="card">
          <div class="section-toolbar">
            <label for="yearInput">å¹´åº¦</label>
            <input id="yearInput" type="number" min="2000" max="2100" step="1" />
            <div class="toolbar-spacer"></div>
            <div id="yearendStats" class="stats">
              <span>ç¸½é¡ï¼šâ€”</span><span>äººæ•¸ï¼šâ€”</span><span>å¹³å‡ï¼šâ€”</span>
            </div>
            <button id="btnSaveYearend" class="btn primary">ğŸ’¾ å„²å­˜</button>
          </div>
          <table class="table" aria-label="å¹´çµ‚çé‡‘">
            <thead>
              <tr>
                <th>å§“å</th>
                <th>åº•è–ª</th>
                <th>å¹´çµ‚é‡‘é¡</th>
                <th>ç™¼æ”¾æ—¥æœŸ</th>
                <th>å‚™è¨»</th>
              </tr>
            </thead>
            <tbody id="tbodyYearend">
              <tr><td colspan="5" class="muted">è¼‰å…¥ä¸­...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- ç³»çµ±è¨­å®š -->
      <section id="panel-settings" class="panel" role="tabpanel" aria-labelledby="tab-settings">
        <div class="card" style="max-width: 1000px; margin: 0 auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
              <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600;">âš™ï¸ è–ªè³‡è¨ˆç®—ç³»çµ±è¨­å®š</h2>
              <p style="margin: 0.5rem 0 0; color: #666; font-size: 0.875rem;">èª¿æ•´è–ªè³‡è¨ˆç®—çš„æ ¸å¿ƒåƒæ•¸</p>
            </div>
            <button id="btnSaveSettings" class="btn primary">ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®š</button>
          </div>

          <!-- èª¤é¤è²»è¨­å®š -->
          <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin: 0 0 1rem; font-size: 1.125rem; font-weight: 600; color: #166534;">ğŸ± èª¤é¤è²»è¨­å®š</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">èª¤é¤è²»å–®åƒ¹ï¼ˆå…ƒ/æ¬¡ï¼‰</label>
                <input id="setting_meal_allowance_per_time" type="number" min="0" step="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">å¹³æ—¥åŠ ç­æ»¿æ¢ä»¶æ™‚ç™¼æ”¾çš„èª¤é¤è²»é‡‘é¡</small>
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æœ€ä½åŠ ç­æ™‚æ•¸ï¼ˆå°æ™‚ï¼‰</label>
                <input id="setting_meal_allowance_min_overtime_hours" type="number" min="0" step="0.5" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">é”åˆ°æ­¤åŠ ç­æ™‚æ•¸æ‰ç™¼æ”¾èª¤é¤è²»</small>
              </div>
            </div>
          </div>

          <!-- äº¤é€šè£œè²¼è¨­å®š -->
          <div style="background: #eff6ff; border: 1px solid #93c5fd; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin: 0 0 1rem; font-size: 1.125rem; font-weight: 600; color: #1e40af;">ğŸš— äº¤é€šè£œè²¼è¨­å®šï¼ˆå€é–“åˆ¶ï¼‰</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æ¯å€‹å€é–“å…¬é‡Œæ•¸</label>
                <input id="setting_transport_km_per_interval" type="number" min="1" step="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">ä¾‹å¦‚ï¼š5 å…¬é‡Œç‚º 1 å€‹å€é–“</small>
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æ¯å€‹å€é–“é‡‘é¡ï¼ˆå…ƒï¼‰</label>
                <input id="setting_transport_amount_per_interval" type="number" min="0" step="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">ä¾‹å¦‚ï¼šæ¯å€é–“ 60 å…ƒ</small>
              </div>
              <div style="display: flex; align-items: center; color: #666;">
                <p style="margin: 0;">ğŸ’¡ ç¯„ä¾‹ï¼š6-10å…¬é‡Œ = 2å€‹å€é–“ = 120å…ƒ</p>
              </div>
            </div>
          </div>

          <!-- è«‹å‡æ‰£æ¬¾è¨­å®š -->
          <div style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="margin: 0 0 1rem; font-size: 1.125rem; font-weight: 600; color: #991b1b;">ğŸ“… è«‹å‡æ‰£æ¬¾è¨­å®š</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ç—…å‡æ‰£æ¬¾æ¯”ä¾‹</label>
                <input id="setting_sick_leave_deduction_rate" type="number" min="0" max="1" step="0.1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">1.0 = å…¨é¡æ‰£é™¤ï¼Œ0.5 = æ‰£é™¤50%</small>
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">äº‹å‡æ‰£æ¬¾æ¯”ä¾‹</label>
                <input id="setting_personal_leave_deduction_rate" type="number" min="0" max="1" step="0.1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">é€šå¸¸ç‚º 1.0ï¼ˆå…¨é¡æ‰£é™¤ï¼‰</small>
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æ—¥è–ªè¨ˆç®—é™¤æ•¸</label>
                <input id="setting_leave_daily_salary_divisor" type="number" min="1" step="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">æ—¥è–ª = åº•è–ª Ã· æ­¤æ•¸å­—ï¼ˆé€šå¸¸ç‚º30ï¼‰</small>
              </div>
            </div>
          </div>

          <!-- æ™‚è–ªè¨ˆç®—è¨­å®š -->
          <div style="background: #f5f3ff; border: 1px solid #c4b5fd; border-radius: 8px; padding: 1.5rem;">
            <h3 style="margin: 0 0 1rem; font-size: 1.125rem; font-weight: 600; color: #5b21b6;">ğŸ§® æ™‚è–ªè¨ˆç®—è¨­å®š</h3>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æ™‚è–ªè¨ˆç®—é™¤æ•¸</label>
                <input id="setting_hourly_rate_divisor" type="number" min="1" step="1" 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;" />
                <small style="color: #666; display: block; margin-top: 0.25rem;">ä¾å‹åŸºæ³•ç‚º 240 å°æ™‚/æœˆ</small>
              </div>
              <div style="display: flex; align-items: center; color: #666;">
                <p style="margin: 0;">ğŸ“Œ æ™‚è–ª = (åº•è–ª + ç¶“å¸¸æ€§çµ¦èˆ‡) Ã· é™¤æ•¸ï¼Œç”¨æ–¼è¨ˆç®—åŠ ç­è²»åŸºæº–</p>
              </div>
            </div>
          </div>

          <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
            <p style="margin: 0; color: #92400e; font-size: 0.875rem;">
              âš ï¸ <strong>é‡è¦æç¤ºï¼š</strong>ä¿®æ”¹é€™äº›è¨­å®šæœƒå½±éŸ¿æ‰€æœ‰æœªä¾†çš„è–ªè³‡è¨ˆç®—ã€‚å»ºè­°åœ¨æœˆåˆæˆ–æ¸¬è©¦ç’°å¢ƒä¸­èª¿æ•´ï¼Œç¢ºèªç„¡èª¤å¾Œå†å¥—ç”¨ã€‚
            </p>
          </div>
        </div>
      </section>
    </main>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const infoBar = document.getElementById('infoBar');
        const finalizeMsg = document.getElementById('finalizeMsg');
        const tabs = Array.from(document.querySelectorAll('.payroll-tabs .tab'));
        const panels = {
          calc: document.getElementById('panel-calc'),
          items: document.getElementById('panel-items'),
          emp: document.getElementById('panel-emp'),
          bonus: document.getElementById('panel-bonus'),
          yearend: document.getElementById('panel-yearend'),
          settings: document.getElementById('panel-settings'),
        };

        // è–ªè³‡é …ç›®è¨­å®šç›¸é—œ DOM
        const tbodyItems = document.getElementById('tbodyItems');
        const itemSearch = document.getElementById('itemSearch');
        const btnAddItem = document.getElementById('btnAddItem');
        const itemDialog = document.getElementById('itemDialog');
        const itemDialogTitle = document.getElementById('itemDialogTitle');
        const itemForm = document.getElementById('itemForm');
        const btnCancelItem = document.getElementById('btnCancelItem');
        const itemErrorMsg = document.getElementById('itemErrorMsg');

        // è–ªè³‡é …ç›®ç‹€æ…‹
        const itemsState = { all: [], filtered: [] };

        // å“¡å·¥è–ªè³‡è¨­å®šç›¸é—œ DOM
        const empList = document.getElementById('empList');
        const empSearch = document.getElementById('empSearch');
        const empFormContainer = document.getElementById('empFormContainer');
        const empEmptyState = document.getElementById('empEmptyState');
        const empFormTitle = document.getElementById('empFormTitle');
        const empBaseSalary = document.getElementById('empBaseSalary');
        const empSalaryNotes = document.getElementById('empSalaryNotes');
        const empItemsList = document.getElementById('empItemsList');
        const btnAddEmpItem = document.getElementById('btnAddEmpItem');
        const btnCancelEmp = document.getElementById('btnCancelEmp');
        const btnSaveEmp = document.getElementById('btnSaveEmp');

        // å“¡å·¥è–ªè³‡ç‹€æ…‹
        const empState = { 
          allUsers: [], 
          filteredUsers: [],
          selectedUserId: null,
          currentUserData: null,
          userSalaryItems: [] 
        };

        // è¨ˆç®—åˆ†é  DOM
        const tbodyCalc = document.getElementById('tbodyCalc');
        const empSearchCalc = document.getElementById('empSearchCalc');
        const statusCalc = document.getElementById('statusCalc');
        const prevCalc = document.getElementById('prevCalc');
        const nextCalc = document.getElementById('nextCalc');
        const monthInput = document.getElementById('month');
        const btnFinalize = document.getElementById('btn-finalize');

        // è¨ˆç®—åˆ†é ç‹€æ…‹
        const calcState = { all: [], filtered: [], page: 1, perPage: 20 };

        function setTabsEnabled(enabled){
          tabs.forEach(b=>{ b.disabled = !enabled; });
          document.querySelectorAll('.payroll-toolbar .btn, .section-toolbar input, .section-toolbar select, .section-toolbar button').forEach(el=>{ el.disabled = !enabled; });
        }

        tabs.forEach(btn => {
          btn.addEventListener('click', ()=>{
            tabs.forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            const key = btn.getAttribute('data-tab');
            Object.entries(panels).forEach(([k,el])=>{
              if (k === key) el.classList.add('show'); else el.classList.remove('show');
            });
          });
        });

        async function ensureAdmin(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { 
              console.log('[æ¬Šé™æª¢æŸ¥] æœªç™»å…¥ï¼Œé‡å®šå‘åˆ°ç™»å…¥é ');
              location.assign('/login?redirect=/internal/payroll'); 
              return false; 
            }
            const json = await res.json();
            console.log('[æ¬Šé™æª¢æŸ¥] API å›æ‡‰:', json);
            
            if (!json || !json.ok) {
              console.error('[æ¬Šé™æª¢æŸ¥] API å›æ‡‰å¤±æ•—:', json);
              infoBar.textContent = 'API å›æ‡‰å¤±æ•—ï¼š' + (json?.message || 'æœªçŸ¥éŒ¯èª¤');
              infoBar.style.display = 'block';
              setTabsEnabled(false);
              return false;
            }
            
            if (!json.data) {
              console.error('[æ¬Šé™æª¢æŸ¥] æ²’æœ‰ data æ¬„ä½');
              infoBar.textContent = 'æ¬Šé™è³‡æ–™ç•°å¸¸ï¼ˆç¼ºå°‘ dataï¼‰';
              infoBar.style.display = 'block';
              setTabsEnabled(false);
              return false;
            }
            
            console.log('[æ¬Šé™æª¢æŸ¥] ç”¨æˆ¶è³‡æ–™:', {
              username: json.data.username,
              name: json.data.name,
              isAdmin: json.data.isAdmin
            });
            
            const isAdmin = json.data.isAdmin === true;
            if (!isAdmin) {
              console.warn('[æ¬Šé™æª¢æŸ¥] ç”¨æˆ¶ä¸æ˜¯ç®¡ç†å“¡');
              infoBar.innerHTML = `æ‚¨æ²’æœ‰æ¬Šé™å­˜å–æ­¤æ¨¡çµ„<br><small>ç•¶å‰ç”¨æˆ¶ï¼š${json.data.name || json.data.username}ï¼ˆis_admin = ${json.data.isAdmin}ï¼‰</small>`;
              infoBar.style.display = 'block';
              setTabsEnabled(false);
              return false;
            }
            
            console.log('[æ¬Šé™æª¢æŸ¥] âœ… ç®¡ç†å“¡é©—è­‰é€šé');
            setTabsEnabled(true);
            return true;
          } catch (err) {
            console.error('[æ¬Šé™æª¢æŸ¥] ç•°å¸¸:', err);
            infoBar.textContent = 'è¼‰å…¥å¤±æ•—ï¼š' + err.message;
            infoBar.style.display = 'block';
            setTabsEnabled(false);
            return false;
          }
        }
        function setFinalizeUIDisabled(disabled){
          btnFinalize.disabled = disabled;
        }

        function setFinalizeMsg(type, text){
          if (!text) { finalizeMsg.style.display='none'; return; }
          finalizeMsg.textContent = text;
          finalizeMsg.style.display = 'block';
        }

        async function checkFinalized(){
          setFinalizeMsg('', '');
          try {
            const m = monthInput.value;
            const res = await fetch(`${apiBase}/admin/payroll?month=${encodeURIComponent(m)}`, { credentials:'include' });
            if (res.status === 200){
              const json = await res.json();
              const runId = json?.data?.runId;
              setFinalizeMsg('info', `æœ¬æœˆå·²ç”¢è£½ï¼ˆRun: ${runId}ï¼‰`);
              setFinalizeUIDisabled(true);
              return true;
            }
            if (res.status === 404){
              setFinalizeMsg('', '');
              setFinalizeUIDisabled(false);
              return false;
            }
            // å…¶ä»–éŒ¯èª¤
            setFinalizeMsg('error', 'æŸ¥è©¢æœˆçµç‹€æ…‹å¤±æ•—');
            setFinalizeUIDisabled(false);
            return false;
          } catch(_){
            setFinalizeMsg('error', 'æŸ¥è©¢æœˆçµç‹€æ…‹å¤±æ•—');
            setFinalizeUIDisabled(false);
            return false;
          }
        }

        function genIdk(){
          return 'idk_' + Date.now() + '_' + Math.random().toString(36).slice(2,10);
        }

        async function finalizeMonth(){
          setFinalizeMsg('', '');
          const m = monthInput.value;
          btnFinalize.disabled = true;
          try {
            const res = await fetch(`${apiBase}/admin/payroll/finalize`, {
              method:'POST', credentials:'include', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ month: m, idempotency_key: genIdk() })
            });
            const json = await res.json().catch(()=>({}));
            if (res.status === 201 && json?.ok){
              setFinalizeMsg('success', `å·²ç”¢è£½å®Œæˆï¼ˆRun: ${json.data?.runId}ï¼‰`);
              btnFinalize.disabled = true;
              return;
            }
            if (res.status === 409){
              setFinalizeMsg('info', `è©²æœˆä»½å·²ç”¢è£½ï¼ˆRun: ${json?.data?.runId || ''}ï¼‰`);
              btnFinalize.disabled = true;
              return;
            }
            if (res.status === 401){ location.assign('/login?redirect=/internal/payroll'); return; }
            if (res.status === 403){ setTabsEnabled(false); setFinalizeMsg('error', 'æ²’æœ‰æ¬Šé™'); return; }
            setFinalizeMsg('error', json?.message || 'ç”¢è£½å¤±æ•—');
            btnFinalize.disabled = false;
          } catch (_){
            setFinalizeMsg('error', 'ç”¢è£½å¤±æ•—');
            btnFinalize.disabled = false;
          }
        }


        function centsToTwd(n){
          const v = Number(n || 0) / 100;
          return 'NT$ ' + v.toLocaleString();
        }

        function renderCalcPager(){
          const total = calcState.filtered.length;
          prevCalc.disabled = calcState.page <= 1;
          nextCalc.disabled = calcState.page * calcState.perPage >= total;
        }

        function renderCalc(){
          const start = (calcState.page - 1) * calcState.perPage;
          const end = start + calcState.perPage;
          const pageRows = calcState.filtered.slice(start, end);
          tbodyCalc.innerHTML = '';
          if (pageRows.length === 0){
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="12" class="muted">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td>';
            tbodyCalc.appendChild(tr);
          } else {
            pageRows.forEach(r => {
              const tr = document.createElement('tr');
              
              // è®¡ç®—æ—¶è–ªæ˜¾ç¤º
              const hourlyRate = centsToTwd(r.hourlyRateCents || 0).replace('NT$ ', '');
              const weightedHours = r.weightedHours || 0; // åŠ æƒå·¥æ—¶
              const overtimeDetail = r.overtimeCents > 0 ? `<br><small style="color:#059669;">${weightedHours.toFixed(1)}h Ã— $${hourlyRate}</small>` : '';
              
              // è¯¯é¤è´¹æ˜ç»†
              const mealDays = r.overtimeDays || 0; // æ»¡è¶³è¯¯é¤è´¹æ¡ä»¶çš„å¤©æ•°
              const mealRate = r.mealAllowanceCents > 0 && mealDays > 0 ? Math.round((r.mealAllowanceCents / 100) / mealDays) : 0;
              const mealDetail = r.mealAllowanceCents > 0 ? `<br><small style="color:#059669;">${mealDays}å¤© Ã— $${mealRate}</small>` : '';
              
              // äº¤é€šè´¹æ˜ç»†
              const transportDetail = r.totalKm > 0 ? `<br><small style="color:#059669;">${r.totalKm}km (${r.transportIntervals || 0}åŒºé—´)</small>` : '';
              
              // è¯·å‡æ‰£æ¬¾æ˜ç»†
              const leaveDetail = (r.sickDays || r.personalDays) ? `<br><small style="color:#dc2626;">ç—…${r.sickDays || 0}å¤© äº‹${r.personalDays || 0}å¤©</small>` : '';
              
              // å…¨å‹¤å¥–é‡‘ï¼ˆä»bonusCentsä¸­åˆ†ç¦»ï¼Œè¿™é‡Œæš‚æ—¶æ˜¾ç¤ºåœ¨bonusCentsä¸­ï¼‰
              const fullAttendanceBonus = r.isFullAttendance ? (r.bonusCents > 0 ? 'å«å…¨å‹¤' : '') : '';
              
              tr.innerHTML = `
                <td><strong>${r.name || ''}</strong></td>
                <td>${centsToTwd(r.baseSalaryCents)}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.regularAllowanceCents)}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.bonusCents)}${fullAttendanceBonus ? `<br><small style="color:#059669;">${fullAttendanceBonus}</small>` : ''}</td>
                <td style="background: #f0fdf4;text-align:center;">${r.isFullAttendance ? '<span style="color:#16a34a;font-size:1.2em;">âœ“</span>' : '<span style="color:#dc2626;">âœ—</span>'}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.overtimeCents)}${overtimeDetail}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.mealAllowanceCents || 0)}${mealDetail}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.transportCents || 0)}${transportDetail}</td>
                <td style="background: #f0fdf4;">${centsToTwd(r.performanceBonusCents || 0)}</td>
                <td style="background: #fef2f2;color:#dc2626;">${r.deductionCents > 0 ? '-' + centsToTwd(r.deductionCents) : '0'}</td>
                <td style="background: #fef2f2;color:#dc2626;">${r.leaveDeductionCents > 0 ? '-' + centsToTwd(r.leaveDeductionCents) : '0'}${leaveDetail}</td>
                <td style="font-weight:600;background:#f0f9ff;">${centsToTwd(r.grossSalaryCents)}</td>
                <td style="font-weight:600;color:#16a34a;background:#dbeafe;font-size:1.05em;">${centsToTwd(r.netSalaryCents)}</td>
              `;
              tbodyCalc.appendChild(tr);
            });
          }
          renderCalcPager();
        }

        function applyCalcFilters(){
          const kw = (empSearchCalc.value || '').trim().toLowerCase();
          const st = statusCalc.value;
          let rows = calcState.all.slice();
          if (kw) rows = rows.filter(r => (r.name || '').toLowerCase().includes(kw));
          if (st === 'complete') rows = rows.filter(r => r.isFullAttendance === true);
          if (st === 'pending') rows = rows.filter(r => r.isFullAttendance === false);
          calcState.filtered = rows;
          calcState.page = 1;
          renderCalc();
        }

        async function loadPreview(){
          const m = monthInput.value;
          tbodyCalc.innerHTML = '<tr><td colspan="7" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>';
          try {
            const res = await fetch(`${apiBase}/admin/payroll/preview?month=${encodeURIComponent(m)}`, { credentials: 'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/payroll'); return; }
            if (res.status === 403) { infoBar.style.display = 'block'; setTabsEnabled(false); return; }
            const json = await res.json();
            if (!json || json.ok !== true) throw new Error('è¼‰å…¥å¤±æ•—');
            const users = (json.data && json.data.users) || [];
            calcState.all = users;
            applyCalcFilters();
          } catch (_) {
            tbodyCalc.innerHTML = '<tr><td colspan="7" class="muted" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</td></tr>';
          }
        }

        // ==================== è–ªè³‡é …ç›®è¨­å®šåŠŸèƒ½ ====================

        function getCategoryLabel(cat) {
          const labels = { 'allowance': 'æ´¥è²¼', 'bonus': 'çé‡‘', 'deduction': 'æ‰£æ¬¾' };
          return labels[cat] || cat;
        }

        function renderItems() {
          tbodyItems.innerHTML = '';
          if (itemsState.filtered.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="7" class="muted">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td>';
            tbodyItems.appendChild(tr);
            return;
          }

          itemsState.filtered.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><code>${item.itemCode}</code></td>
              <td>${item.itemName}</td>
              <td>${getCategoryLabel(item.category)}</td>
              <td>${item.isRegularPayment ? 'âœ“ æ˜¯' : 'å¦'}</td>
              <td>${item.isFixed ? 'æ˜¯' : 'å¦'}</td>
              <td>${item.isActive ? '<span style="color:#16a34a;">å•Ÿç”¨</span>' : '<span style="color:#9ca3af;">åœç”¨</span>'}</td>
              <td>
                <button class="btn btn-sm" onclick="window.editItem(${item.itemTypeId})">ç·¨è¼¯</button>
                ${item.isActive ? 
                  `<button class="btn btn-sm" onclick="window.toggleItemStatus(${item.itemTypeId}, false)">åœç”¨</button>` :
                  `<button class="btn btn-sm" onclick="window.toggleItemStatus(${item.itemTypeId}, true)">å•Ÿç”¨</button>`
                }
              </td>
            `;
            tbodyItems.appendChild(tr);
          });
        }

        async function loadItems() {
          tbodyItems.innerHTML = '<tr><td colspan="7" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>';
          try {
            const res = await fetch(`${apiBase}/admin/salary-item-types`, { credentials: 'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/payroll'); return; }
            if (res.status === 403) { infoBar.style.display = 'block'; return; }
            const json = await res.json();
            if (!json || json.ok !== true) throw new Error('è¼‰å…¥å¤±æ•—');
            itemsState.all = json.data.items || [];
            applyItemFilters();
          } catch (err) {
            console.error('loadItems error:', err);
            tbodyItems.innerHTML = '<tr><td colspan="7" class="muted" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</td></tr>';
          }
        }

        function applyItemFilters() {
          const kw = (itemSearch.value || '').trim().toLowerCase();
          let items = itemsState.all.slice();
          if (kw) {
            items = items.filter(item => 
              item.itemCode.toLowerCase().includes(kw) || 
              item.itemName.toLowerCase().includes(kw)
            );
          }
          itemsState.filtered = items;
          renderItems();
        }

        function generateItemCode() {
          // è‡ªå‹•ç”Ÿæˆé …ç›®ä»£ç¢¼ï¼šITEM_YYYYMMDDHHMMSS
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const hour = String(now.getHours()).padStart(2, '0');
          const minute = String(now.getMinutes()).padStart(2, '0');
          const second = String(now.getSeconds()).padStart(2, '0');
          return `ITEM_${year}${month}${day}${hour}${minute}${second}`;
        }

        function openItemDialog(item = null) {
          itemErrorMsg.style.display = 'none';
          itemErrorMsg.textContent = '';
          
          if (item) {
            // ç·¨è¼¯æ¨¡å¼
            itemDialogTitle.innerHTML = 'ç·¨è¼¯è–ªè³‡é …ç›®';
            document.getElementById('itemDialogTitle').nextElementSibling.textContent = 'ä¿®æ”¹è–ªè³‡é …ç›®çš„è¨­å®š';
            document.getElementById('itemTypeId').value = item.itemTypeId;
            document.getElementById('itemCode').value = item.itemCode;
            document.getElementById('itemName').value = item.itemName;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemIsRegular').checked = item.isRegularPayment;
            document.getElementById('itemIsFixed').checked = item.isFixed;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('itemDisplayOrder').value = item.displayOrder || 0;
          } else {
            // æ–°å¢æ¨¡å¼
            itemDialogTitle.innerHTML = 'æ–°å¢è–ªè³‡é …ç›®';
            document.getElementById('itemDialogTitle').nextElementSibling.textContent = 'è¨­å®šè–ªè³‡é …ç›®çš„åŸºæœ¬è³‡è¨Š';
            itemForm.reset();
            document.getElementById('itemTypeId').value = '';
            // è‡ªå‹•ç”Ÿæˆé …ç›®ä»£ç¢¼
            document.getElementById('itemCode').value = generateItemCode();
            document.getElementById('itemDisplayOrder').value = 99;
          }
          
          itemDialog.showModal();
        }

        async function saveItem(e) {
          e.preventDefault();
          itemErrorMsg.style.display = 'none';

          const itemTypeId = document.getElementById('itemTypeId').value;
          const isEdit = !!itemTypeId;

          const data = {
            itemCode: document.getElementById('itemCode').value.trim(),
            itemName: document.getElementById('itemName').value.trim(),
            category: document.getElementById('itemCategory').value,
            isRegularPayment: document.getElementById('itemIsRegular').checked,
            isFixed: document.getElementById('itemIsFixed').checked,
            description: document.getElementById('itemDescription').value.trim(),
            displayOrder: parseInt(document.getElementById('itemDisplayOrder').value) || 0
          };

          try {
            const url = isEdit 
              ? `${apiBase}/admin/salary-item-types/${itemTypeId}`
              : `${apiBase}/admin/salary-item-types`;
            const method = isEdit ? 'PUT' : 'POST';

            const res = await fetch(url, {
              method,
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });

            const json = await res.json();

            if (res.ok && json.ok) {
              itemDialog.close();
              await loadItems();
              alert(isEdit ? 'æ›´æ–°æˆåŠŸï¼' : 'æ–°å¢æˆåŠŸï¼');
            } else {
              itemErrorMsg.textContent = json.message || 'æ“ä½œå¤±æ•—';
              itemErrorMsg.style.display = 'block';
            }
          } catch (err) {
            console.error('saveItem error:', err);
            itemErrorMsg.textContent = 'æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
            itemErrorMsg.style.display = 'block';
          }
        }

        async function toggleItemStatus(itemTypeId, newStatus) {
          if (!confirm(`ç¢ºå®šè¦${newStatus ? 'å•Ÿç”¨' : 'åœç”¨'}æ­¤é …ç›®ï¼Ÿ`)) return;

          try {
            const res = await fetch(`${apiBase}/admin/salary-item-types/${itemTypeId}`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ isActive: newStatus })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              await loadItems();
            } else {
              alert(json.message || 'æ“ä½œå¤±æ•—');
            }
          } catch (err) {
            console.error('toggleItemStatus error:', err);
            alert('æ“ä½œå¤±æ•—');
          }
        }

        // å…¨å±€å‡½æ•¸ä¾› onclick ä½¿ç”¨
        window.editItem = function(itemTypeId) {
          const item = itemsState.all.find(i => i.itemTypeId === itemTypeId);
          if (item) openItemDialog(item);
        };

        window.toggleItemStatus = toggleItemStatus;

        // ==================== å“¡å·¥è–ªè³‡è¨­å®šåŠŸèƒ½ ====================

        // åŠ è¼‰æ‰€æœ‰å“¡å·¥
        async function loadUsers() {
          try {
            const res = await fetch(`${apiBase}/admin/users`, { credentials: 'include' });
            if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
            const json = await res.json();
            empState.allUsers = json.data?.users || [];
            empState.filteredUsers = [...empState.allUsers];
            renderUserList();
          } catch (err) {
            console.error('loadUsers error:', err);
            empList.innerHTML = '<li class="muted">è¼‰å…¥å¤±æ•—</li>';
          }
        }

        // æ¸²æŸ“å“¡å·¥åˆ—è¡¨
        function renderUserList() {
          if (empState.filteredUsers.length === 0) {
            empList.innerHTML = '<li class="muted">ç„¡ç¬¦åˆæ¢ä»¶çš„å“¡å·¥</li>';
            return;
          }
          empList.innerHTML = empState.filteredUsers.map(u => `
            <li class="${empState.selectedUserId === u.userId ? 'active' : ''}" 
                onclick="selectUser(${u.userId})" 
                style="cursor: pointer; padding: 0.75rem;">
              <div style="font-weight: 500;">${u.name || u.username}</div>
              <div style="font-size: 0.875rem; color: #666;">åº•è–ª: ${u.baseSalary.toLocaleString()} å…ƒ</div>
            </li>
          `).join('');
        }

        // æœå°‹å“¡å·¥
        function applyUserFilters() {
          const keyword = empSearch.value.toLowerCase().trim();
          if (!keyword) {
            empState.filteredUsers = [...empState.allUsers];
          } else {
            empState.filteredUsers = empState.allUsers.filter(u => 
              (u.name || '').toLowerCase().includes(keyword) ||
              (u.username || '').toLowerCase().includes(keyword)
            );
          }
          renderUserList();
        }

        // é¸æ“‡å“¡å·¥
        window.selectUser = async function(userId) {
          empState.selectedUserId = userId;
          renderUserList();
          await loadUserSalary(userId);
        };

        // åŠ è¼‰å“¡å·¥è–ªè³‡è¨­å®š
        async function loadUserSalary(userId) {
          try {
            const res = await fetch(`${apiBase}/admin/users/${userId}/salary`, { credentials: 'include' });
            if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
            const json = await res.json();
            empState.currentUserData = json.data;
            empState.userSalaryItems = json.data.salaryItems || [];
            renderUserSalaryForm();
          } catch (err) {
            console.error('loadUserSalary error:', err);
            alert('è¼‰å…¥å“¡å·¥è–ªè³‡å¤±æ•—');
          }
        }

        // æ¸²æŸ“å“¡å·¥è–ªè³‡è¡¨å–®
        function renderUserSalaryForm() {
          const data = empState.currentUserData;
          if (!data) {
            empFormContainer.style.display = 'none';
            empEmptyState.style.display = 'block';
            return;
          }

          empFormContainer.style.display = 'block';
          empEmptyState.style.display = 'none';
          empFormTitle.textContent = `${data.name} çš„è–ªè³‡è¨­å®š`;
          empBaseSalary.value = data.baseSalary || 0;
          empSalaryNotes.value = data.salaryNotes || '';
          
          renderUserSalaryItems();
        }

        // æ¸²æŸ“å“¡å·¥è–ªè³‡é …ç›®åˆ—è¡¨
        function renderUserSalaryItems() {
          if (empState.userSalaryItems.length === 0) {
            empItemsList.innerHTML = '<small class="muted">å°šç„¡è–ªè³‡é …ç›®</small>';
            return;
          }

          empItemsList.innerHTML = empState.userSalaryItems.map((item, index) => {
            const recurringType = item.recurringType || 'monthly';
            let recurringMonths = [];
            if (item.recurringMonths) {
              try {
                recurringMonths = JSON.parse(item.recurringMonths);
              } catch (e) {
                console.error('Failed to parse recurring_months:', item.recurringMonths);
              }
            }
            const showMonthSelector = recurringType === 'yearly';
            
            return `
            <div class="salary-item-row" style="background: #f9fafb; border: 1px solid #e0e0e0; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem;">
              <div style="display: grid; grid-template-columns: 2fr 1fr 1.5fr auto; gap: 0.5rem; align-items: start; margin-bottom: 0.5rem;">
                <div>
                  <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.25rem;">é …ç›®</label>
                  <select class="item-type-select" data-index="${index}" style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    ${renderItemTypeOptions(item.itemTypeId)}
                  </select>
                </div>
                <div>
                  <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.25rem;">é‡‘é¡ï¼ˆå…ƒï¼‰</label>
                  <input type="number" class="item-amount" data-index="${index}" value="${item.amountCents / 100}" 
                         placeholder="0.00" min="0" step="0.01" style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;" />
                </div>
                <div>
                  <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.25rem;">ç™¼æ”¾é€±æœŸ</label>
                  <select class="item-recurring-type" data-index="${index}" onchange="toggleMonthSelector(${index})" style="width: 100%; padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    <option value="monthly" ${recurringType === 'monthly' ? 'selected' : ''}>æ¯æœˆç™¼æ”¾</option>
                    <option value="yearly" ${recurringType === 'yearly' ? 'selected' : ''}>æ¯å¹´æŒ‡å®šæœˆä»½</option>
                    <option value="once" ${recurringType === 'once' ? 'selected' : ''}>åƒ…ç™¼æ”¾ä¸€æ¬¡</option>
                  </select>
                </div>
                <div style="padding-top: 1.25rem;">
                  <button type="button" class="btn btn-sm" onclick="removeUserSalaryItem(${index})" style="padding: 0.375rem 0.75rem;">âŒ</button>
                </div>
              </div>
              <div class="month-selector-${index}" style="display: ${showMonthSelector ? 'block' : 'none'};">
                <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 0.5rem;">ğŸ“… ç™¼æ”¾æœˆä»½ï¼ˆå¯å¤šé¸ï¼‰</label>
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.25rem;">
                  ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `
                    <label style="display: flex; align-items: center; padding: 0.25rem; font-size: 0.875rem;">
                      <input type="checkbox" class="month-checkbox-${index}" value="${m}" ${recurringMonths.includes(m) ? 'checked' : ''} style="margin-right: 0.25rem;" />
                      ${m}æœˆ
                    </label>
                  `).join('')}
                </div>
              </div>
            </div>
          `;
          }).join('');
        }

        // æ¸²æŸ“è–ªè³‡é …ç›®é¡å‹é¸é …
        function renderItemTypeOptions(selectedId) {
          return itemsState.all
            .filter(t => t.isActive)
            .map(t => `<option value="${t.itemTypeId}" ${t.itemTypeId === selectedId ? 'selected' : ''}>
              ${t.itemName} (${t.category === 'allowance' ? 'æ´¥è²¼' : t.category === 'bonus' ? 'çé‡‘' : 'æ‰£æ¬¾'})
            </option>`)
            .join('');
        }

        // åˆ‡æ›æœˆä»½é¸æ“‡å™¨é¡¯ç¤º
        window.toggleMonthSelector = function(index) {
          const selector = document.querySelector(`.month-selector-${index}`);
          const recurringTypeSelect = document.querySelector(`.item-recurring-type[data-index="${index}"]`);
          if (selector && recurringTypeSelect) {
            selector.style.display = recurringTypeSelect.value === 'yearly' ? 'block' : 'none';
          }
        };

        // æ–°å¢å“¡å·¥è–ªè³‡é …ç›®
        window.addUserSalaryItem = function() {
          if (itemsState.all.filter(t => t.isActive).length === 0) {
            alert('è«‹å…ˆåœ¨ã€Œè–ªè³‡é …ç›®è¨­å®šã€ä¸­æ–°å¢å¯ç”¨çš„è–ªè³‡é …ç›®');
            return;
          }
          empState.userSalaryItems.push({
            itemTypeId: itemsState.all.filter(t => t.isActive)[0]?.itemTypeId || null,
            amountCents: 0,
            recurringType: 'monthly',
            recurringMonths: null
          });
          renderUserSalaryItems();
        };

        // ç§»é™¤å“¡å·¥è–ªè³‡é …ç›®
        window.removeUserSalaryItem = function(index) {
          empState.userSalaryItems.splice(index, 1);
          renderUserSalaryItems();
        };

        // å„²å­˜å“¡å·¥è–ªè³‡è¨­å®š
        async function saveUserSalary() {
          if (!empState.selectedUserId) return;

          const baseSalary = parseFloat(empBaseSalary.value) || 0;
          const salaryNotes = empSalaryNotes.value.trim();

          // æ”¶é›†è–ªè³‡é …ç›®
          const salaryItems = [];
          const itemRows = empItemsList.querySelectorAll('.salary-item-row');
          itemRows.forEach((row, index) => {
            const typeSelect = row.querySelector('.item-type-select');
            const amountInput = row.querySelector('.item-amount');
            const recurringTypeSelect = row.querySelector('.item-recurring-type');
            
            const itemTypeId = parseInt(typeSelect.value);
            const amount = parseFloat(amountInput.value) || 0;
            const recurringType = recurringTypeSelect.value;
            
            // æ”¶é›†é¸ä¸­çš„æœˆä»½
            let recurringMonths = null;
            if (recurringType === 'yearly') {
              const monthCheckboxes = row.querySelectorAll(`.month-checkbox-${index}:checked`);
              const selectedMonths = Array.from(monthCheckboxes).map(cb => parseInt(cb.value));
              if (selectedMonths.length > 0) {
                recurringMonths = JSON.stringify(selectedMonths);
              }
            }
            
            if (itemTypeId && amount > 0) {
              salaryItems.push({
                itemTypeId,
                amountCents: Math.round(amount * 100),
                effectiveDate: new Date().toISOString().split('T')[0],
                recurringType,
                recurringMonths
              });
            }
          });

          try {
            const res = await fetch(`${apiBase}/admin/users/${empState.selectedUserId}/salary`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ baseSalary, salaryNotes, salaryItems })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              alert('âœ… å„²å­˜æˆåŠŸ');
              await loadUsers(); // é‡æ–°åŠ è¼‰å“¡å·¥åˆ—è¡¨
              await loadUserSalary(empState.selectedUserId); // é‡æ–°åŠ è¼‰ç•¶å‰å“¡å·¥
            } else {
              alert(json.message || 'å„²å­˜å¤±æ•—');
            }
          } catch (err) {
            console.error('saveUserSalary error:', err);
            alert('å„²å­˜å¤±æ•—');
          }
        }

        // ç¶å®šè–ªè³‡é …ç›®äº‹ä»¶
        let searchTimer = null;
        itemSearch.addEventListener('input', () => {
          clearTimeout(searchTimer);
          searchTimer = setTimeout(applyItemFilters, 300);
        });
        btnAddItem.addEventListener('click', () => openItemDialog());
        btnCancelItem.addEventListener('click', () => itemDialog.close());
        itemForm.addEventListener('submit', saveItem);

        // ç¶å®šå“¡å·¥è–ªè³‡è¨­å®šäº‹ä»¶
        let empSearchTimer = null;
        empSearch.addEventListener('input', () => {
          clearTimeout(empSearchTimer);
          empSearchTimer = setTimeout(applyUserFilters, 300);
        });
        btnAddEmpItem.addEventListener('click', addUserSalaryItem);
        btnCancelEmp.addEventListener('click', () => {
          empState.selectedUserId = null;
          empFormContainer.style.display = 'none';
          empEmptyState.style.display = 'block';
          renderUserList();
        });
        btnSaveEmp.addEventListener('click', saveUserSalary);

        // ==================== ç¸¾æ•ˆçé‡‘èª¿æ•´åŠŸèƒ½ ====================

        const tbodyBonus = document.getElementById('tbodyBonus');
        const bonusSummary = document.getElementById('bonusSummary');
        const btnResetBonus = document.getElementById('btnResetBonus');
        const btnSaveBonus = document.getElementById('btnSaveBonus');

        let bonusState = { employees: [] };

        // åŠ è¼‰æœˆåº¦ç¸¾æ•ˆæ•¸æ“š
        async function loadMonthlyBonus() {
          const month = document.getElementById('monthBonus').value;
          if (!month) return;

          try {
            const res = await fetch(`${apiBase}/admin/bonus/month/${month}`, { credentials: 'include' });
            if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
            const json = await res.json();
            bonusState.employees = json.data?.employees || [];
            renderBonusTable();
          } catch (err) {
            console.error('loadMonthlyBonus error:', err);
            tbodyBonus.innerHTML = '<tr><td colspan="5" class="muted">è¼‰å…¥å¤±æ•—</td></tr>';
          }
        }

        // æ¸²æŸ“ç¸¾æ•ˆè¡¨æ ¼
        function renderBonusTable() {
          if (bonusState.employees.length === 0) {
            tbodyBonus.innerHTML = '<tr><td colspan="5" class="muted">ç„¡å“¡å·¥è³‡æ–™</td></tr>';
            return;
          }

          tbodyBonus.innerHTML = bonusState.employees.map((emp, index) => {
            const defaultAmount = (emp.defaultBonusCents / 100).toFixed(2);
            const adjustedAmount = emp.adjustedBonusCents !== null ? (emp.adjustedBonusCents / 100).toFixed(2) : '';
            
            return `
              <tr>
                <td>${emp.name || emp.username}</td>
                <td>${emp.baseSalary.toLocaleString()}</td>
                <td>${defaultAmount}</td>
                <td>
                  <input type="number" class="bonus-input" data-index="${index}" 
                         value="${adjustedAmount}" 
                         placeholder="${defaultAmount}" 
                         min="0" step="0.01" 
                         style="width: 120px;" />
                </td>
                <td>
                  <input type="text" class="bonus-notes" data-index="${index}" 
                         value="${emp.notes || ''}" 
                         placeholder="å‚™è¨»" 
                         style="width: 200px;" />
                </td>
              </tr>
            `;
          }).join('');

          updateBonusSummary();
        }

        // æ›´æ–°çµ±è¨ˆæ‘˜è¦
        function updateBonusSummary() {
          const adjustedCount = bonusState.employees.filter(e => e.adjustedBonusCents !== null).length;
          bonusSummary.textContent = `å·²èª¿æ•´äººæ•¸ ${adjustedCount}`;
        }

        // æ¢å¾©é è¨­
        function resetAllBonus() {
          if (!confirm('ç¢ºå®šè¦å°‡æ‰€æœ‰èª¿æ•´æ¢å¾©ç‚ºé è¨­å€¼å—ï¼Ÿ')) return;
          
          bonusState.employees.forEach(emp => {
            emp.adjustedBonusCents = null;
            emp.notes = '';
          });
          renderBonusTable();
        }

        // å„²å­˜ç¸¾æ•ˆèª¿æ•´
        async function saveMonthlyBonus() {
          const month = document.getElementById('monthBonus').value;
          if (!month) return;

          // æ”¶é›†èª¿æ•´æ•¸æ“š
          const adjustments = [];
          const inputs = tbodyBonus.querySelectorAll('.bonus-input');
          const notesInputs = tbodyBonus.querySelectorAll('.bonus-notes');

          inputs.forEach((input, index) => {
            const emp = bonusState.employees[index];
            if (!emp) return;

            const value = input.value.trim();
            const notes = notesInputs[index].value.trim();

            if (value !== '') {
              adjustments.push({
                userId: emp.userId,
                bonusAmountCents: Math.round(parseFloat(value) * 100),
                notes: notes || null
              });
            }
          });

          try {
            const res = await fetch(`${apiBase}/admin/bonus/month/${month}`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ adjustments })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              alert('âœ… å„²å­˜æˆåŠŸ');
              await loadMonthlyBonus();
            } else {
              alert(json.message || 'å„²å­˜å¤±æ•—');
            }
          } catch (err) {
            console.error('saveMonthlyBonus error:', err);
            alert('å„²å­˜å¤±æ•—');
          }
        }

        // ç¶å®šç¸¾æ•ˆçé‡‘äº‹ä»¶
        document.getElementById('monthBonus').addEventListener('change', loadMonthlyBonus);
        btnResetBonus.addEventListener('click', resetAllBonus);
        btnSaveBonus.addEventListener('click', saveMonthlyBonus);

        // ==================== å¹´çµ‚çé‡‘ç®¡ç†åŠŸèƒ½ ====================

        const tbodyYearend = document.getElementById('tbodyYearend');
        const yearendStats = document.getElementById('yearendStats');
        const yearInput = document.getElementById('yearInput');
        const btnSaveYearend = document.getElementById('btnSaveYearend');

        let yearendState = { employees: [], summary: { totalCents: 0, count: 0, averageCents: 0 } };

        // åŠ è¼‰å¹´åº¦å¹´çµ‚çé‡‘æ•¸æ“š
        async function loadYearEndBonus() {
          const year = yearInput.value;
          if (!year) return;

          try {
            const res = await fetch(`${apiBase}/admin/yearend/${year}`, { credentials: 'include' });
            if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
            const json = await res.json();
            yearendState.employees = json.data?.employees || [];
            yearendState.summary = json.data?.summary || { totalCents: 0, count: 0, averageCents: 0 };
            renderYearendTable();
          } catch (err) {
            console.error('loadYearEndBonus error:', err);
            tbodyYearend.innerHTML = '<tr><td colspan="5" class="muted">è¼‰å…¥å¤±æ•—</td></tr>';
          }
        }

        // æ¸²æŸ“å¹´çµ‚çé‡‘è¡¨æ ¼
        function renderYearendTable() {
          if (yearendState.employees.length === 0) {
            tbodyYearend.innerHTML = '<tr><td colspan="5" class="muted">ç„¡å“¡å·¥è³‡æ–™</td></tr>';
            return;
          }

          tbodyYearend.innerHTML = yearendState.employees.map((emp, index) => {
            const amount = (emp.amountCents / 100).toFixed(2);
            
            return `
              <tr>
                <td>${emp.name || emp.username}</td>
                <td>${emp.baseSalary.toLocaleString()}</td>
                <td>
                  <input type="number" class="yearend-amount" data-index="${index}" 
                         value="${amount > 0 ? amount : ''}" 
                         placeholder="0.00" 
                         min="0" step="0.01" 
                         style="width: 120px;" />
                </td>
                <td>
                  <input type="date" class="yearend-date" data-index="${index}" 
                         value="${emp.paymentDate || ''}" 
                         style="width: 150px;" />
                </td>
                <td>
                  <input type="text" class="yearend-notes" data-index="${index}" 
                         value="${emp.notes || ''}" 
                         placeholder="å‚™è¨»" 
                         style="width: 200px;" />
                </td>
              </tr>
            `;
          }).join('');

          updateYearendStats();
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateYearendStats() {
          const total = (yearendState.summary.totalCents / 100).toLocaleString();
          const count = yearendState.summary.count;
          const average = (yearendState.summary.averageCents / 100).toLocaleString();
          
          yearendStats.innerHTML = `
            <span>ç¸½é¡ï¼š${total} å…ƒ</span>
            <span>äººæ•¸ï¼š${count}</span>
            <span>å¹³å‡ï¼š${average} å…ƒ</span>
          `;
        }

        // å„²å­˜å¹´çµ‚çé‡‘
        async function saveYearEndBonus() {
          const year = yearInput.value;
          if (!year) return;

          // æ”¶é›†çé‡‘æ•¸æ“š
          const bonuses = [];
          const amountInputs = tbodyYearend.querySelectorAll('.yearend-amount');
          const dateInputs = tbodyYearend.querySelectorAll('.yearend-date');
          const notesInputs = tbodyYearend.querySelectorAll('.yearend-notes');

          amountInputs.forEach((input, index) => {
            const emp = yearendState.employees[index];
            if (!emp) return;

            const amount = parseFloat(input.value) || 0;
            const paymentDate = dateInputs[index].value || null;
            const notes = notesInputs[index].value.trim() || null;

            if (amount > 0) {
              bonuses.push({
                userId: emp.userId,
                amountCents: Math.round(amount * 100),
                paymentDate,
                notes
              });
            }
          });

          try {
            const res = await fetch(`${apiBase}/admin/yearend/${year}`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ bonuses })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              alert('âœ… å„²å­˜æˆåŠŸ');
              await loadYearEndBonus();
            } else {
              alert(json.message || 'å„²å­˜å¤±æ•—');
            }
          } catch (err) {
            console.error('saveYearEndBonus error:', err);
            alert('å„²å­˜å¤±æ•—');
          }
        }

        // ç¶å®šå¹´çµ‚çé‡‘äº‹ä»¶
        yearInput.addEventListener('change', loadYearEndBonus);
        btnSaveYearend.addEventListener('click', saveYearEndBonus);

        // ==================== ç³»çµ±è¨­å®šåŠŸèƒ½ ====================

        const btnSaveSettings = document.getElementById('btnSaveSettings');
        let systemSettings = [];

        // åŠ è¼‰ç³»çµ±è¨­å®š
        async function loadSystemSettings() {
          try {
            const res = await fetch(`${apiBase}/admin/payroll-settings`, { credentials: 'include' });
            if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
            const json = await res.json();
            systemSettings = json.data?.settings || [];
            renderSystemSettings();
          } catch (err) {
            console.error('loadSystemSettings error:', err);
            alert('è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—');
          }
        }

        // æ¸²æŸ“ç³»çµ±è¨­å®š
        function renderSystemSettings() {
          systemSettings.forEach(setting => {
            const inputId = `setting_${setting.settingKey}`;
            const input = document.getElementById(inputId);
            if (input) {
              input.value = setting.settingValue;
            }
          });
        }

        // å„²å­˜ç³»çµ±è¨­å®š
        async function saveSystemSettings() {
          if (!confirm('ç¢ºå®šè¦æ›´æ–°ç³»çµ±è¨­å®šå—ï¼Ÿ\n\né€™æœƒå½±éŸ¿æœªä¾†æ‰€æœ‰çš„è–ªè³‡è¨ˆç®—ã€‚')) return;

          const settings = [];
          systemSettings.forEach(setting => {
            const inputId = `setting_${setting.settingKey}`;
            const input = document.getElementById(inputId);
            if (input) {
              settings.push({
                settingKey: setting.settingKey,
                settingValue: input.value
              });
            }
          });

          try {
            const res = await fetch(`${apiBase}/admin/payroll-settings`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ settings })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              alert('âœ… è¨­å®šå·²æ›´æ–°');
              await loadSystemSettings();
            } else {
              alert(json.message || 'æ›´æ–°å¤±æ•—');
            }
          } catch (err) {
            console.error('saveSystemSettings error:', err);
            alert('æ›´æ–°å¤±æ•—');
          }
        }

        // ç¶å®šç³»çµ±è¨­å®šäº‹ä»¶
        btnSaveSettings.addEventListener('click', saveSystemSettings);

        // é è¨­æœˆä»½ç‚ºæœ¬æœˆ
        const now = new Date();
        monthInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        const monthBonus = document.getElementById('monthBonus');
        if (monthBonus) monthBonus.value = monthInput.value;
        
        // é è¨­å¹´ä»½ç‚ºä»Šå¹´
        yearInput.value = now.getFullYear();

        // ç¶å®šäº‹ä»¶
        let timer = null;
        empSearchCalc.addEventListener('input', ()=>{ clearTimeout(timer); timer = setTimeout(applyCalcFilters, 300); });
        statusCalc.addEventListener('change', applyCalcFilters);
        monthInput.addEventListener('change', ()=>{ calcState.page = 1; loadPreview(); checkFinalized(); });
        prevCalc.addEventListener('click', ()=>{ if (calcState.page>1){ calcState.page--; renderCalc(); } });
        nextCalc.addEventListener('click', ()=>{ calcState.page++; renderCalc(); });
        btnFinalize.addEventListener('click', finalizeMonth);

        // âš¡ é¢„æ¸²æŸ“åˆå§‹åŒ–
        if (window.PagePrerender) {
          window.PagePrerender.init('main');
        }

        ensureAdmin().then(isAdmin => { 
          if (isAdmin) { 
            loadPreview(); 
            checkFinalized();
            loadItems(); // è¼‰å…¥è–ªè³‡é …ç›®
            loadUsers(); // è¼‰å…¥å“¡å·¥åˆ—è¡¨
            loadMonthlyBonus(); // è¼‰å…¥ç¸¾æ•ˆçé‡‘
            loadYearEndBonus(); // è¼‰å…¥å¹´çµ‚çé‡‘
            loadSystemSettings(); // è¼‰å…¥ç³»çµ±è¨­å®š
            // âš¡ è‡ªåŠ¨ä¿å­˜é¢„æ¸²æŸ“
            if (window.PagePrerender) {
              setTimeout(() => window.PagePrerender.autoSave('main', 2000), 1000);
            }
          } 
        });
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


