<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="è–ªè³‡ç®¡ç†" />
    <title>è–ªè³‡ç®¡ç†ï½œç¸½è¦½</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/payroll-page.css" />
    
    <!-- âš¡ é¢„åŠ è½½ä¸ç¼“å­˜ç³»ç»Ÿ -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <script src="/assets/js/prerender.js"></script>
    <script src="/assets/js/page-prerender.js"></script>
  </head>
  <body class="payroll-page">
    <div style="padding:16px 20px;">
      <div id="infoBar" class="info-bar" style="display:none;" role="alert">æ‚¨æ²’æœ‰æ¬Šé™å­˜å–æ­¤æ¨¡çµ„</div>
      <div class="payroll-toolbar" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
        <label for="month">æœˆä»½</label>
        <input id="month" type="month" aria-label="æœˆä»½" />
        <div class="toolbar-spacer" style="flex:1;"></div>
        <button id="btn-finalize" type="button" class="btn primary" disabled>ç”¢è£½æœˆçµ</button>
        <button id="btn-export-csv" type="button" class="btn" disabled>åŒ¯å‡º CSV</button>
        <button id="btn-export-pdf" type="button" class="btn" disabled>åŒ¯å‡º PDF</button>
      </div>
      <div id="finalizeMsg" class="info-bar" style="display:none;"></div>
      <nav class="payroll-tabs" role="tablist" aria-label="è–ªè³‡ç®¡ç†åˆ†é " style="display:flex;gap:8px;border-bottom:2px solid #e5e7eb;">
        <button class="tab active" role="tab" aria-selected="true" data-tab="calc">è–ªè³‡è¨ˆç®—</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="items">è–ªè³‡é …ç›®è¨­å®š</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="emp">å“¡å·¥è–ªè³‡è¨­å®š</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="bonus">ç¸¾æ•ˆçé‡‘èª¿æ•´</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="yearend">å¹´çµ‚çé‡‘</button>
      </nav>
    </div>

    <main class="payroll-content">
      <!-- è–ªè³‡è¨ˆç®— -->
      <section id="panel-calc" class="panel show" role="tabpanel" aria-labelledby="tab-calc">
        <div class="card">
          <div class="section-toolbar">
            <input id="empSearchCalc" type="search" placeholder="æœå°‹å“¡å·¥â€¦" />
            <select id="statusCalc">
              <option value="all">å…¨éƒ¨</option>
              <option value="complete">å·²å®Œæˆ</option>
              <option value="pending">æœªå®Œæˆ</option>
            </select>
          </div>
          <table class="table" aria-label="è–ªè³‡è¨ˆç®—åˆ—è¡¨">
            <thead>
              <tr>
                <th>å§“å</th>
                <th>åº•è–ª</th>
                <th>æ´¥è²¼åˆè¨ˆ</th>
                <th>çé‡‘åˆè¨ˆ</th>
                <th>åŠ ç­è²»</th>
                <th>äº¤é€šè£œè²¼</th>
                <th>èª¤é¤è²»</th>
                <th>ç¸½è–ªè³‡</th>
                <th>å…¨å‹¤</th>
              </tr>
            </thead>
            <tbody id="tbodyCalc">
              <tr><td colspan="9" class="muted">å°šç„¡è³‡æ–™</td></tr>
            </tbody>
          </table>
          <div class="pagination">
            <button type="button" id="prevCalc">ä¸Šä¸€é </button>
            <button type="button" id="nextCalc">ä¸‹ä¸€é </button>
          </div>
        </div>
      </section>

      <!-- è–ªè³‡é …ç›®è¨­å®š -->
      <section id="panel-items" class="panel" role="tabpanel" aria-labelledby="tab-items">
        <div class="card">
          <div class="section-toolbar">
            <input id="itemSearch" type="search" placeholder="æœå°‹é …ç›®ä»£ç¢¼/åç¨±â€¦" />
            <button type="button" id="btnAddItem" class="btn primary">æ–°å¢é …ç›®</button>
          </div>
          <table class="table" aria-label="è–ªè³‡é …ç›®åˆ—è¡¨">
            <thead>
              <tr>
                <th>é …ç›®ä»£ç¢¼</th>
                <th>é …ç›®åç¨±</th>
                <th>é¡åˆ¥</th>
                <th>ç¶“å¸¸æ€§çµ¦èˆ‡</th>
                <th>é‡‘é¡å›ºå®š</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbodyItems">
              <tr><td colspan="7" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- æ–°å¢/ç·¨è¼¯è–ªè³‡é …ç›®å°è©±æ¡† -->
      <dialog id="itemDialog" style="border-radius:12px;border:1px solid #e5e7eb;padding:0;width:90%;max-width:520px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);">
        <div style="padding:24px;border-bottom:1px solid #e5e7eb;background:#f9fafb;">
          <h3 id="itemDialogTitle" style="margin:0;font-size:20px;font-weight:600;color:#111827;">æ–°å¢è–ªè³‡é …ç›®</h3>
          <p style="margin:8px 0 0;font-size:14px;color:#6b7280;">è¨­å®šè–ªè³‡é …ç›®çš„åŸºæœ¬è³‡è¨Š</p>
        </div>
        <form id="itemForm" style="padding:24px;">
          <input type="hidden" id="itemTypeId" />
          <input type="hidden" id="itemCode" />
          
          <div style="margin-bottom:20px;">
            <label for="itemName" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">
              é …ç›®åç¨± <span style="color:#dc2626;">*</span>
            </label>
            <input id="itemName" type="text" required maxlength="50" placeholder="ä¾‹å¦‚ï¼šä¼™é£Ÿæ´¥è²¼ã€å…¨å‹¤çé‡‘" 
              style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;" />
            <small style="color:#6b7280;display:block;margin-top:4px;">ğŸ’¡ è¼¸å…¥æ¸…æ¥šæ˜“æ‡‚çš„åç¨±ï¼Œæ–¹ä¾¿å“¡å·¥è­˜åˆ¥</small>
          </div>

          <div style="margin-bottom:20px;">
            <label for="itemCategory" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">
              é¡åˆ¥ <span style="color:#dc2626;">*</span>
            </label>
            <select id="itemCategory" required style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
              <option value="">-- è«‹é¸æ“‡é¡åˆ¥ --</option>
              <option value="allowance">ğŸ’° æ´¥è²¼ï¼ˆå¦‚ï¼šäº¤é€šã€ä¼™é£Ÿã€é›»è©±ï¼‰</option>
              <option value="bonus">ğŸ çé‡‘ï¼ˆå¦‚ï¼šå…¨å‹¤ã€ç¸¾æ•ˆã€å¹´çµ‚ï¼‰</option>
              <option value="deduction">â– æ‰£æ¬¾ï¼ˆå¦‚ï¼šä¿è²»ã€é²åˆ°ï¼‰</option>
            </select>
            <small style="color:#6b7280;display:block;margin-top:4px;">ğŸ“‹ ä¾æ“šé …ç›®æ€§è³ªé¸æ“‡å°æ‡‰é¡åˆ¥</small>
          </div>

          <div style="margin-bottom:20px;background:#f0f9ff;padding:16px;border-radius:8px;border:1px solid #bfdbfe;">
            <label style="display:flex;align-items:flex-start;cursor:pointer;">
              <input type="checkbox" id="itemIsRegular" style="margin-top:2px;margin-right:10px;width:18px;height:18px;" />
              <div>
                <span style="font-weight:500;color:#1e40af;">ç¶“å¸¸æ€§çµ¦èˆ‡ï¼ˆè¨ˆå…¥æ™‚è–ªåŸºæº–ï¼‰</span>
                <small style="color:#1e40af;display:block;margin-top:4px;line-height:1.5;">
                  âš ï¸ <strong>é‡è¦ï¼š</strong>å‹¾é¸å¾Œæœƒè¨ˆå…¥æ™‚è–ªè¨ˆç®—ï¼Œå½±éŸ¿åŠ ç­è²»é‡‘é¡å’Œæˆæœ¬åˆ†æ<br>
                  âœ“ æ‡‰å‹¾é¸ï¼šå›ºå®šæ´¥è²¼ï¼ˆä¼™é£Ÿã€äº¤é€šï¼‰ã€å…¨å‹¤çé‡‘ã€æ¯æœˆå›ºå®šç¸¾æ•ˆ<br>
                  âœ— ä¸å‹¾é¸ï¼šå¹´çµ‚çé‡‘ã€ä¸‰ç¯€çé‡‘ã€è‡¨æ™‚æ€§çé‡‘
                </small>
              </div>
            </label>
          </div>

          <div style="margin-bottom:20px;">
            <label style="display:flex;align-items:center;cursor:pointer;">
              <input type="checkbox" id="itemIsFixed" style="margin-right:10px;width:18px;height:18px;" />
              <span style="font-weight:500;color:#374151;">é‡‘é¡å›ºå®š</span>
            </label>
            <small style="color:#6b7280;display:block;margin-top:6px;margin-left:28px;">
              å‹¾é¸è¡¨ç¤ºæ¯å€‹æœˆé‡‘é¡å›ºå®šï¼ˆå¦‚å›ºå®š 2,400 å…ƒä¼™é£Ÿæ´¥è²¼ï¼‰<br>
              ä¸å‹¾é¸è¡¨ç¤ºé‡‘é¡å¯èƒ½è®Šå‹•ï¼ˆå¦‚ä¾è¡¨ç¾èª¿æ•´çš„ç¸¾æ•ˆçé‡‘ï¼‰
            </small>
          </div>

          <div style="margin-bottom:20px;">
            <label for="itemDescription" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
            <textarea id="itemDescription" rows="3" maxlength="200" placeholder="ä¾‹å¦‚ï¼šæ¯æœˆå›ºå®šç™¼æ”¾ï¼Œç”¨æ–¼è£œåŠ©å“¡å·¥ä¼™é£Ÿè²»ç”¨" 
              style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;resize:vertical;"></textarea>
            <small style="color:#6b7280;display:block;margin-top:4px;">å¯èªªæ˜ç™¼æ”¾æ¢ä»¶ã€è¨ˆç®—æ–¹å¼ç­‰</small>
          </div>

          <div style="margin-bottom:20px;">
            <label for="itemDisplayOrder" style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">é¡¯ç¤ºé †åº</label>
            <input id="itemDisplayOrder" type="number" min="0" value="99" 
              style="width:120px;padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;" />
            <small style="color:#6b7280;display:block;margin-top:4px;">æ•¸å­—è¶Šå°è¶Šé å‰é¡¯ç¤ºï¼Œé è¨­ç‚º 99</small>
          </div>

          <div id="itemErrorMsg" style="color:#dc2626;margin-bottom:16px;display:none;padding:12px;background:#fee;border-radius:6px;border:1px solid #fecaca;"></div>
          
          <div style="display:flex;gap:12px;justify-content:flex-end;padding-top:20px;border-top:1px solid #e5e7eb;">
            <button type="button" id="btnCancelItem" class="btn" style="min-width:100px;">å–æ¶ˆ</button>
            <button type="submit" class="btn primary" style="min-width:100px;">ğŸ’¾ å„²å­˜</button>
          </div>
        </form>
      </dialog>

      <!-- å“¡å·¥è–ªè³‡è¨­å®š -->
      <section id="panel-emp" class="panel" role="tabpanel" aria-labelledby="tab-emp">
        <div class="card grid">
          <div class="col">
            <div class="section-toolbar">
              <input id="empSearch" type="search" placeholder="æœå°‹å“¡å·¥â€¦" />
            </div>
            <ul class="list" aria-label="å“¡å·¥æ¸…å–®">
              <li class="muted">å°šç„¡è³‡æ–™</li>
            </ul>
          </div>
          <div class="col">
            <div class="form">
              <div class="row"><label>åº•è–ª</label><input type="number" min="0" step="1" placeholder="ä¾‹å¦‚ 40000" disabled /></div>
              <div class="row"><label>ç”Ÿæ•ˆæ—¥æœŸ</label><input type="date" disabled /></div>
              <div class="row"><label>è–ªè³‡é …ç›®</label><button class="btn" disabled>æ–°å¢</button></div>
              <div class="row">
                <small class="muted">æç¤ºï¼šå‹¾é¸ã€Œç¶“å¸¸æ€§çµ¦èˆ‡ã€å°‡è¨ˆå…¥æ™‚è–ªï¼Œå½±éŸ¿åŠ ç­è²»èˆ‡æˆæœ¬åˆ†æã€‚</small>
              </div>
              <div class="actions">
                <button class="btn" disabled>å–æ¶ˆ</button>
                <button class="btn primary" disabled>å„²å­˜</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ç¸¾æ•ˆçé‡‘èª¿æ•´ -->
      <section id="panel-bonus" class="panel" role="tabpanel" aria-labelledby="tab-bonus">
        <div class="card">
          <div class="section-toolbar">
            <label for="monthBonus">æœˆä»½</label>
            <input id="monthBonus" type="month" />
            <div class="toolbar-spacer"></div>
            <button class="btn" disabled>å…¨éƒ¨æ¢å¾©é è¨­</button>
            <button class="btn primary" disabled>å„²å­˜æ‰€æœ‰èª¿æ•´</button>
          </div>
          <table class="table" aria-label="ç¸¾æ•ˆçé‡‘èª¿æ•´">
            <thead>
              <tr>
                <th>å§“å</th>
                <th>é è¨­ç¸¾æ•ˆ</th>
                <th>èª¿æ•´å¾Œ</th>
                <th>æ™‚è–ªå½±éŸ¿</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4" class="muted">å°šç„¡è³‡æ–™</td></tr>
            </tbody>
          </table>
          <div class="summary muted">å·²èª¿æ•´äººæ•¸ 0ã€äººå‡å½±éŸ¿ 0 å…ƒ/æ™‚</div>
        </div>
      </section>

      <!-- å¹´çµ‚çé‡‘ç®¡ç† -->
      <section id="panel-yearend" class="panel" role="tabpanel" aria-labelledby="tab-yearend">
        <div class="card">
          <div class="section-toolbar">
            <label for="year">å¹´åº¦</label>
            <input id="year" type="number" min="2000" max="2100" step="1" />
            <div class="toolbar-spacer"></div>
            <div class="stats">
              <span>ç¸½é¡ï¼šâ€”</span><span>äººæ•¸ï¼šâ€”</span><span>å¹³å‡ï¼šâ€”</span>
            </div>
          </div>
          <table class="table" aria-label="å¹´çµ‚çé‡‘">
            <thead>
              <tr>
                <th>å§“å</th>
                <th>å¹´çµ‚é‡‘é¡</th>
                <th>ç™¼æ”¾æ—¥æœŸ</th>
                <th>ç‹€æ…‹</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4" class="muted">å°šç„¡è³‡æ–™</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const infoBar = document.getElementById('infoBar');
        const finalizeMsg = document.getElementById('finalizeMsg');
        const tabs = Array.from(document.querySelectorAll('.payroll-tabs .tab'));
        const panels = {
          calc: document.getElementById('panel-calc'),
          items: document.getElementById('panel-items'),
          emp: document.getElementById('panel-emp'),
          bonus: document.getElementById('panel-bonus'),
          yearend: document.getElementById('panel-yearend'),
        };

        // è–ªè³‡é …ç›®è¨­å®šç›¸é—œ DOM
        const tbodyItems = document.getElementById('tbodyItems');
        const itemSearch = document.getElementById('itemSearch');
        const btnAddItem = document.getElementById('btnAddItem');
        const itemDialog = document.getElementById('itemDialog');
        const itemDialogTitle = document.getElementById('itemDialogTitle');
        const itemForm = document.getElementById('itemForm');
        const btnCancelItem = document.getElementById('btnCancelItem');
        const itemErrorMsg = document.getElementById('itemErrorMsg');

        // è–ªè³‡é …ç›®ç‹€æ…‹
        const itemsState = { all: [], filtered: [] };

        // è¨ˆç®—åˆ†é  DOM
        const tbodyCalc = document.getElementById('tbodyCalc');
        const empSearchCalc = document.getElementById('empSearchCalc');
        const statusCalc = document.getElementById('statusCalc');
        const prevCalc = document.getElementById('prevCalc');
        const nextCalc = document.getElementById('nextCalc');
        const monthInput = document.getElementById('month');
        const btnFinalize = document.getElementById('btn-finalize');

        // è¨ˆç®—åˆ†é ç‹€æ…‹
        const calcState = { all: [], filtered: [], page: 1, perPage: 20 };

        function setTabsEnabled(enabled){
          tabs.forEach(b=>{ b.disabled = !enabled; });
          document.querySelectorAll('.payroll-toolbar .btn, .section-toolbar input, .section-toolbar select, .section-toolbar button').forEach(el=>{ el.disabled = !enabled; });
        }

        tabs.forEach(btn => {
          btn.addEventListener('click', ()=>{
            tabs.forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            const key = btn.getAttribute('data-tab');
            Object.entries(panels).forEach(([k,el])=>{
              if (k === key) el.classList.add('show'); else el.classList.remove('show');
            });
          });
        });

        async function ensureAdmin(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/payroll'); return false; }
            const json = await res.json();
            const isAdmin = !!(json && json.ok && json.data && json.data.isAdmin);
            if (!isAdmin) {
              infoBar.style.display = 'block';
              setTabsEnabled(false);
              return false;
            }
            setTabsEnabled(true);
            return true;
          } catch (_) {
            infoBar.textContent = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
            infoBar.style.display = 'block';
            setTabsEnabled(false);
            return false;
          }
        }
        function setFinalizeUIDisabled(disabled){
          btnFinalize.disabled = disabled;
        }

        function setFinalizeMsg(type, text){
          if (!text) { finalizeMsg.style.display='none'; return; }
          finalizeMsg.textContent = text;
          finalizeMsg.style.display = 'block';
        }

        async function checkFinalized(){
          setFinalizeMsg('', '');
          try {
            const m = monthInput.value;
            const res = await fetch(`${apiBase}/admin/payroll?month=${encodeURIComponent(m)}`, { credentials:'include' });
            if (res.status === 200){
              const json = await res.json();
              const runId = json?.data?.runId;
              setFinalizeMsg('info', `æœ¬æœˆå·²ç”¢è£½ï¼ˆRun: ${runId}ï¼‰`);
              setFinalizeUIDisabled(true);
              return true;
            }
            if (res.status === 404){
              setFinalizeMsg('', '');
              setFinalizeUIDisabled(false);
              return false;
            }
            // å…¶ä»–éŒ¯èª¤
            setFinalizeMsg('error', 'æŸ¥è©¢æœˆçµç‹€æ…‹å¤±æ•—');
            setFinalizeUIDisabled(false);
            return false;
          } catch(_){
            setFinalizeMsg('error', 'æŸ¥è©¢æœˆçµç‹€æ…‹å¤±æ•—');
            setFinalizeUIDisabled(false);
            return false;
          }
        }

        function genIdk(){
          return 'idk_' + Date.now() + '_' + Math.random().toString(36).slice(2,10);
        }

        async function finalizeMonth(){
          setFinalizeMsg('', '');
          const m = monthInput.value;
          btnFinalize.disabled = true;
          try {
            const res = await fetch(`${apiBase}/admin/payroll/finalize`, {
              method:'POST', credentials:'include', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ month: m, idempotency_key: genIdk() })
            });
            const json = await res.json().catch(()=>({}));
            if (res.status === 201 && json?.ok){
              setFinalizeMsg('success', `å·²ç”¢è£½å®Œæˆï¼ˆRun: ${json.data?.runId}ï¼‰`);
              btnFinalize.disabled = true;
              return;
            }
            if (res.status === 409){
              setFinalizeMsg('info', `è©²æœˆä»½å·²ç”¢è£½ï¼ˆRun: ${json?.data?.runId || ''}ï¼‰`);
              btnFinalize.disabled = true;
              return;
            }
            if (res.status === 401){ location.assign('/login?redirect=/internal/payroll'); return; }
            if (res.status === 403){ setTabsEnabled(false); setFinalizeMsg('error', 'æ²’æœ‰æ¬Šé™'); return; }
            setFinalizeMsg('error', json?.message || 'ç”¢è£½å¤±æ•—');
            btnFinalize.disabled = false;
          } catch (_){
            setFinalizeMsg('error', 'ç”¢è£½å¤±æ•—');
            btnFinalize.disabled = false;
          }
        }


        function centsToTwd(n){
          const v = Number(n || 0) / 100;
          return 'NT$ ' + v.toLocaleString();
        }

        function renderCalcPager(){
          const total = calcState.filtered.length;
          prevCalc.disabled = calcState.page <= 1;
          nextCalc.disabled = calcState.page * calcState.perPage >= total;
        }

        function renderCalc(){
          const start = (calcState.page - 1) * calcState.perPage;
          const end = start + calcState.perPage;
          const pageRows = calcState.filtered.slice(start, end);
          tbodyCalc.innerHTML = '';
          if (pageRows.length === 0){
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="9" class="muted">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td>';
            tbodyCalc.appendChild(tr);
          } else {
            pageRows.forEach(r => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${r.name || ''}</td>
                <td>${centsToTwd(r.baseSalaryCents)}</td>
                <td>${centsToTwd(r.regularAllowanceCents)}</td>
                <td>${centsToTwd(r.bonusCents)}</td>
                <td>${centsToTwd(r.overtimeCents)}</td>
                <td>${centsToTwd(r.transportSubsidyCents || 0)}</td>
                <td>${centsToTwd(r.mealAllowanceCents || 0)}</td>
                <td>${centsToTwd(r.totalCents)}</td>
                <td>${r.isFullAttendance ? 'æ˜¯' : 'å¦'}</td>
              `;
              tbodyCalc.appendChild(tr);
            });
          }
          renderCalcPager();
        }

        function applyCalcFilters(){
          const kw = (empSearchCalc.value || '').trim().toLowerCase();
          const st = statusCalc.value;
          let rows = calcState.all.slice();
          if (kw) rows = rows.filter(r => (r.name || '').toLowerCase().includes(kw));
          if (st === 'complete') rows = rows.filter(r => r.isFullAttendance === true);
          if (st === 'pending') rows = rows.filter(r => r.isFullAttendance === false);
          calcState.filtered = rows;
          calcState.page = 1;
          renderCalc();
        }

        async function loadPreview(){
          const m = monthInput.value;
          tbodyCalc.innerHTML = '<tr><td colspan="7" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>';
          try {
            const res = await fetch(`${apiBase}/admin/payroll/preview?month=${encodeURIComponent(m)}`, { credentials: 'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/payroll'); return; }
            if (res.status === 403) { infoBar.style.display = 'block'; setTabsEnabled(false); return; }
            const json = await res.json();
            if (!json || json.ok !== true) throw new Error('è¼‰å…¥å¤±æ•—');
            const users = (json.data && json.data.users) || [];
            calcState.all = users;
            applyCalcFilters();
          } catch (_) {
            tbodyCalc.innerHTML = '<tr><td colspan="7" class="muted" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</td></tr>';
          }
        }

        // ==================== è–ªè³‡é …ç›®è¨­å®šåŠŸèƒ½ ====================

        function getCategoryLabel(cat) {
          const labels = { 'allowance': 'æ´¥è²¼', 'bonus': 'çé‡‘', 'deduction': 'æ‰£æ¬¾' };
          return labels[cat] || cat;
        }

        function renderItems() {
          tbodyItems.innerHTML = '';
          if (itemsState.filtered.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="7" class="muted">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td>';
            tbodyItems.appendChild(tr);
            return;
          }

          itemsState.filtered.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><code>${item.itemCode}</code></td>
              <td>${item.itemName}</td>
              <td>${getCategoryLabel(item.category)}</td>
              <td>${item.isRegularPayment ? 'âœ“ æ˜¯' : 'å¦'}</td>
              <td>${item.isFixed ? 'æ˜¯' : 'å¦'}</td>
              <td>${item.isActive ? '<span style="color:#16a34a;">å•Ÿç”¨</span>' : '<span style="color:#9ca3af;">åœç”¨</span>'}</td>
              <td>
                <button class="btn btn-sm" onclick="window.editItem(${item.itemTypeId})">ç·¨è¼¯</button>
                ${item.isActive ? 
                  `<button class="btn btn-sm" onclick="window.toggleItemStatus(${item.itemTypeId}, false)">åœç”¨</button>` :
                  `<button class="btn btn-sm" onclick="window.toggleItemStatus(${item.itemTypeId}, true)">å•Ÿç”¨</button>`
                }
              </td>
            `;
            tbodyItems.appendChild(tr);
          });
        }

        async function loadItems() {
          tbodyItems.innerHTML = '<tr><td colspan="7" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>';
          try {
            const res = await fetch(`${apiBase}/admin/salary-item-types`, { credentials: 'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/payroll'); return; }
            if (res.status === 403) { infoBar.style.display = 'block'; return; }
            const json = await res.json();
            if (!json || json.ok !== true) throw new Error('è¼‰å…¥å¤±æ•—');
            itemsState.all = json.data.items || [];
            applyItemFilters();
          } catch (err) {
            console.error('loadItems error:', err);
            tbodyItems.innerHTML = '<tr><td colspan="7" class="muted" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</td></tr>';
          }
        }

        function applyItemFilters() {
          const kw = (itemSearch.value || '').trim().toLowerCase();
          let items = itemsState.all.slice();
          if (kw) {
            items = items.filter(item => 
              item.itemCode.toLowerCase().includes(kw) || 
              item.itemName.toLowerCase().includes(kw)
            );
          }
          itemsState.filtered = items;
          renderItems();
        }

        function generateItemCode() {
          // è‡ªå‹•ç”Ÿæˆé …ç›®ä»£ç¢¼ï¼šITEM_YYYYMMDDHHMMSS
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const hour = String(now.getHours()).padStart(2, '0');
          const minute = String(now.getMinutes()).padStart(2, '0');
          const second = String(now.getSeconds()).padStart(2, '0');
          return `ITEM_${year}${month}${day}${hour}${minute}${second}`;
        }

        function openItemDialog(item = null) {
          itemErrorMsg.style.display = 'none';
          itemErrorMsg.textContent = '';
          
          if (item) {
            // ç·¨è¼¯æ¨¡å¼
            itemDialogTitle.innerHTML = 'ç·¨è¼¯è–ªè³‡é …ç›®';
            document.getElementById('itemDialogTitle').nextElementSibling.textContent = 'ä¿®æ”¹è–ªè³‡é …ç›®çš„è¨­å®š';
            document.getElementById('itemTypeId').value = item.itemTypeId;
            document.getElementById('itemCode').value = item.itemCode;
            document.getElementById('itemName').value = item.itemName;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemIsRegular').checked = item.isRegularPayment;
            document.getElementById('itemIsFixed').checked = item.isFixed;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('itemDisplayOrder').value = item.displayOrder || 0;
          } else {
            // æ–°å¢æ¨¡å¼
            itemDialogTitle.innerHTML = 'æ–°å¢è–ªè³‡é …ç›®';
            document.getElementById('itemDialogTitle').nextElementSibling.textContent = 'è¨­å®šè–ªè³‡é …ç›®çš„åŸºæœ¬è³‡è¨Š';
            itemForm.reset();
            document.getElementById('itemTypeId').value = '';
            // è‡ªå‹•ç”Ÿæˆé …ç›®ä»£ç¢¼
            document.getElementById('itemCode').value = generateItemCode();
            document.getElementById('itemDisplayOrder').value = 99;
          }
          
          itemDialog.showModal();
        }

        async function saveItem(e) {
          e.preventDefault();
          itemErrorMsg.style.display = 'none';

          const itemTypeId = document.getElementById('itemTypeId').value;
          const isEdit = !!itemTypeId;

          const data = {
            itemCode: document.getElementById('itemCode').value.trim(),
            itemName: document.getElementById('itemName').value.trim(),
            category: document.getElementById('itemCategory').value,
            isRegularPayment: document.getElementById('itemIsRegular').checked,
            isFixed: document.getElementById('itemIsFixed').checked,
            description: document.getElementById('itemDescription').value.trim(),
            displayOrder: parseInt(document.getElementById('itemDisplayOrder').value) || 0
          };

          try {
            const url = isEdit 
              ? `${apiBase}/admin/salary-item-types/${itemTypeId}`
              : `${apiBase}/admin/salary-item-types`;
            const method = isEdit ? 'PUT' : 'POST';

            const res = await fetch(url, {
              method,
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });

            const json = await res.json();

            if (res.ok && json.ok) {
              itemDialog.close();
              await loadItems();
              alert(isEdit ? 'æ›´æ–°æˆåŠŸï¼' : 'æ–°å¢æˆåŠŸï¼');
            } else {
              itemErrorMsg.textContent = json.message || 'æ“ä½œå¤±æ•—';
              itemErrorMsg.style.display = 'block';
            }
          } catch (err) {
            console.error('saveItem error:', err);
            itemErrorMsg.textContent = 'æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
            itemErrorMsg.style.display = 'block';
          }
        }

        async function toggleItemStatus(itemTypeId, newStatus) {
          if (!confirm(`ç¢ºå®šè¦${newStatus ? 'å•Ÿç”¨' : 'åœç”¨'}æ­¤é …ç›®ï¼Ÿ`)) return;

          try {
            const res = await fetch(`${apiBase}/admin/salary-item-types/${itemTypeId}`, {
              method: 'PUT',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ isActive: newStatus })
            });

            const json = await res.json();
            if (res.ok && json.ok) {
              await loadItems();
            } else {
              alert(json.message || 'æ“ä½œå¤±æ•—');
            }
          } catch (err) {
            console.error('toggleItemStatus error:', err);
            alert('æ“ä½œå¤±æ•—');
          }
        }

        // å…¨å±€å‡½æ•¸ä¾› onclick ä½¿ç”¨
        window.editItem = function(itemTypeId) {
          const item = itemsState.all.find(i => i.itemTypeId === itemTypeId);
          if (item) openItemDialog(item);
        };

        window.toggleItemStatus = toggleItemStatus;

        // ç¶å®šè–ªè³‡é …ç›®äº‹ä»¶
        let searchTimer = null;
        itemSearch.addEventListener('input', () => {
          clearTimeout(searchTimer);
          searchTimer = setTimeout(applyItemFilters, 300);
        });
        btnAddItem.addEventListener('click', () => openItemDialog());
        btnCancelItem.addEventListener('click', () => itemDialog.close());
        itemForm.addEventListener('submit', saveItem);

        // é è¨­æœˆä»½ç‚ºæœ¬æœˆ
        const now = new Date();
        monthInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        const monthBonus = document.getElementById('monthBonus');
        if (monthBonus) monthBonus.value = monthInput.value;

        // ç¶å®šäº‹ä»¶
        let timer = null;
        empSearchCalc.addEventListener('input', ()=>{ clearTimeout(timer); timer = setTimeout(applyCalcFilters, 300); });
        statusCalc.addEventListener('change', applyCalcFilters);
        monthInput.addEventListener('change', ()=>{ calcState.page = 1; loadPreview(); checkFinalized(); });
        prevCalc.addEventListener('click', ()=>{ if (calcState.page>1){ calcState.page--; renderCalc(); } });
        nextCalc.addEventListener('click', ()=>{ calcState.page++; renderCalc(); });
        btnFinalize.addEventListener('click', finalizeMonth);

        // âš¡ é¢„æ¸²æŸ“åˆå§‹åŒ–
        if (window.PagePrerender) {
          window.PagePrerender.init('main');
        }

        ensureAdmin().then(isAdmin => { 
          if (isAdmin) { 
            loadPreview(); 
            checkFinalized();
            loadItems(); // è¼‰å…¥è–ªè³‡é …ç›®
            // âš¡ è‡ªåŠ¨ä¿å­˜é¢„æ¸²æŸ“
            if (window.PagePrerender) {
              setTimeout(() => window.PagePrerender.autoSave('main', 2000), 1000);
            }
          } 
        });
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


