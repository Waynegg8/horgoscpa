name: è‡ªå‹•ç”Ÿæˆå®¢æˆ¶æœå‹™ä»»å‹™

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 00:00 å°åŒ—æ™‚é–“åŸ·è¡Œ (UTC+8 = UTC 16:00å‰ä¸€å¤©)
    - cron: '0 16 * * *'
  
  workflow_dispatch:
    inputs:
      target_date:
        description: 'ç›®æ¨™æ—¥æœŸ (YYYY-MM-DDï¼Œé¸å¡«)'
        required: false
        type: string
      service_type:
        description: 'æœå‹™é¡å‹ç¯©é¸ (é¸å¡«)'
        required: false
        type: choice
        options:
          - ''
          - accounting
          - vat
          - income_tax
          - withholding
          - prepayment
      dry_run:
        description: 'æ¸¬è©¦æ¨¡å¼ï¼ˆåƒ…é è¦½ä¸å¯¦éš›ç”Ÿæˆï¼‰'
        required: false
        type: boolean
        default: false

jobs:
  generate-tasks:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: ğŸ”§ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: timesheet-api/package-lock.json
      
      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: |
          cd timesheet-api
          npm ci
      
      - name: ğŸ” é è¦½å°‡ç”Ÿæˆçš„ä»»å‹™
        if: ${{ github.event.inputs.dry_run == 'true' || github.event_name == 'workflow_dispatch' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd timesheet-api
          echo "ğŸ“‹ é è¦½æ¨¡å¼ï¼šæŸ¥çœ‹å°‡è¦ç”Ÿæˆçš„ä»»å‹™"
          node scripts/generate-tasks.js --preview --date "${{ github.event.inputs.target_date }}" --service-type "${{ github.event.inputs.service_type }}"
      
      - name: ğŸš€ åŸ·è¡Œä»»å‹™ç”Ÿæˆ
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd timesheet-api
          echo "ğŸ¯ é–‹å§‹ç”Ÿæˆä»»å‹™..."
          node scripts/generate-tasks.js --date "${{ github.event.inputs.target_date }}" --service-type "${{ github.event.inputs.service_type }}"
      
      - name: ğŸ“Š é¡¯ç¤ºåŸ·è¡Œçµæœ
        if: always()
        run: |
          echo "âœ… ä»»å‹™ç”Ÿæˆæµç¨‹åŸ·è¡Œå®Œæˆ"
          echo "ğŸ“… åŸ·è¡Œæ™‚é–“: $(date)"
      
      - name: ğŸ’¬ ç™¼é€é€šçŸ¥ (å¤±æ•—æ™‚)
        if: failure()
        run: |
          echo "âŒ ä»»å‹™ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ"
          # é€™è£¡å¯ä»¥æ•´åˆ Slack, Discord, Email ç­‰é€šçŸ¥æœå‹™
      
      - name: ğŸ“ˆ ä¸Šå‚³åŸ·è¡Œå ±å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: task-generation-report-${{ github.run_number }}
          path: timesheet-api/logs/
          retention-days: 30

# é¡å¤–çš„å®‰å…¨æ€§æª¢æŸ¥
concurrency:
  group: task-generation
  cancel-in-progress: false  # ä¸å–æ¶ˆæ­£åœ¨åŸ·è¡Œçš„ä»»å‹™

# æ¬Šé™è¨­å®š
permissions:
  contents: read
  actions: write
