name: 自動生成客戶服務任務

on:
  schedule:
    # 每天凌晨 00:00 (台北時間 UTC+8)
    # UTC 16:00 = 台北時間 00:00 (隔天)
    - cron: '0 16 * * *'
  
  workflow_dispatch:
    inputs:
      target_date:
        description: '目標日期 (YYYY-MM-DD，選填)'
        required: false
        type: string

jobs:
  generate-tasks:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout 代碼
        uses: actions/checkout@v4
      
      - name: 設置 Node.js 環境
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: 安裝依賴
        working-directory: ./timesheet-api
        run: npm ci
      
      - name: 生成任務
        working-directory: ./timesheet-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -n "${{ github.event.inputs.target_date }}" ]; then
            node scripts/generate-tasks.js --date "${{ github.event.inputs.target_date }}"
          else
            node scripts/generate-tasks.js
          fi
      
      - name: 發送通知（成功）
        if: success()
        run: |
          echo "✅ 任務生成成功"
          echo "時間: $(date)"
      
      - name: 發送通知（失敗）
        if: failure()
        run: |
          echo "❌ 任務生成失敗"
          echo "時間: $(date)"
