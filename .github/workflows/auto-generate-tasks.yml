name: è‡ªå‹•ç”Ÿæˆå®¢æˆ¶æœå‹™ä»»å‹™

on:
  # æ¯æ—¥å°åŒ—æ™‚é–“ 00:00 åŸ·è¡Œï¼ˆUTC 16:00ï¼‰
  schedule:
    - cron: '0 16 * * *'
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      date:
        description: 'ç›®æ¨™æ—¥æœŸ (YYYY-MM-DDï¼Œç•™ç©ºå‰‡ä½¿ç”¨ä»Šå¤©)'
        required: false
        type: string
      service_type:
        description: 'æœå‹™é¡å‹éæ¿¾ (é¸å¡«)'
        required: false
        type: choice
        options:
          - ''
          - accounting
          - vat
          - income_tax
          - withholding
          - prepayment
          - dividend
          - nhi
          - shareholder_tax
          - audit
          - company_setup

jobs:
  generate-tasks:
    runs-on: ubuntu-latest
    name: ç”Ÿæˆå®¢æˆ¶æœå‹™ä»»å‹™
    
    steps:
      - name: ğŸ“ è¨­å®šåŸ·è¡Œåƒæ•¸
        id: params
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            echo "date=${{ github.event.inputs.date }}" >> $GITHUB_OUTPUT
          else
            echo "date=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "${{ github.event.inputs.service_type }}" ]; then
            echo "service_type=${{ github.event.inputs.service_type }}" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸš€ å‘¼å« API ç”Ÿæˆä»»å‹™
        id: generate
        run: |
          # æº–å‚™ API è«‹æ±‚è³‡æ–™
          if [ -n "${{ steps.params.outputs.service_type }}" ]; then
            DATA="{\"date\":\"${{ steps.params.outputs.date }}\",\"service_type\":\"${{ steps.params.outputs.service_type }}\"}"
          else
            DATA="{\"date\":\"${{ steps.params.outputs.date }}\"}"
          fi
          
          # å‘¼å« Cloudflare Workers API
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" \
            -d "$DATA" \
            "${{ secrets.API_BASE_URL }}/api/automated-tasks/generate")
          
          echo "$RESPONSE" > response.json
          echo "response<<EOF" >> $GITHUB_OUTPUT
          cat response.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # æª¢æŸ¥æ˜¯å¦æˆåŠŸ
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" != "true" ]; then
            echo "âŒ ä»»å‹™ç”Ÿæˆå¤±æ•—"
            exit 1
          fi
      
      - name: ğŸ“Š é¡¯ç¤ºç”Ÿæˆçµæœ
        run: |
          echo "### ğŸ“‹ ä»»å‹™ç”Ÿæˆçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # è§£æçµæœ
          TOTAL=$(cat response.json | jq -r '.results.total')
          GENERATED=$(cat response.json | jq -r '.results.generated | length')
          SKIPPED=$(cat response.json | jq -r '.results.skipped | length')
          ERRORS=$(cat response.json | jq -r '.results.errors | length')
          
          echo "- ğŸ“Š ç¸½æœå‹™æ•¸: $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æˆåŠŸç”Ÿæˆ: $GENERATED" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸ è·³é: $SKIPPED" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ éŒ¯èª¤: $ERRORS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$GENERATED" -gt 0 ]; then
            echo "#### âœ… æˆåŠŸç”Ÿæˆçš„ä»»å‹™" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| å®¢æˆ¶ | æœå‹™é¡å‹ | è² è²¬äºº | åŸ·è¡ŒæœŸé–“ | æˆªæ­¢æ—¥æœŸ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|----------|--------|----------|----------|" >> $GITHUB_STEP_SUMMARY
            
            cat response.json | jq -r '.results.generated[] | "| \(.client_name) | \(.service_type) | \(.assigned_to) | \(.execution_period) | \(.due_date) |"' >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$ERRORS" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### âŒ éŒ¯èª¤åˆ—è¡¨" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat response.json | jq -r '.results.errors[] | "- Service ID \(.service_id): \(.error)"' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ’¬ ç™¼é€é€šçŸ¥ (å¦‚æœ‰éŒ¯èª¤)
        if: failure()
        run: |
          echo "âš ï¸ ä»»å‹™ç”Ÿæˆéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ"
          # é€™è£¡å¯ä»¥æ•´åˆ Slack, Discord, Email ç­‰é€šçŸ¥æœå‹™
