name: éƒ¨è½æ ¼è‡ªå‹•åŒ–è™•ç†

on:
  workflow_dispatch:
    inputs:
      process_word:
        description: 'è™•ç†Wordæ–‡æª”'
        required: true
        default: 'true'
        type: boolean
      update_json:
        description: 'æ›´æ–°JSONæ–‡ä»¶'
        required: true
        default: 'true'
        type: boolean
  push:
    branches:
      - main
    paths:
      - 'word-docs/*.docx'
  schedule:
    - cron: '0 1 * * *'

jobs:
  content-automation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: è¨­ç½® Git é…ç½®
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: è¨­ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: å®‰è£ä¾è³´
        run: |
          python -m pip install --upgrade pip
          pip install loguru python-docx beautifulsoup4 requests
      
      - name: å‰µå»ºç›®éŒ„çµæ§‹
        run: |
          mkdir -p blog assets/data assets/images/blog word-docs/processed logs
      
      - name: å‰µå»ºé…ç½®æ–‡ä»¶
        run: |
          echo '{"ç¨…å‹™": "tax", "ä¿éšª": "insurance", "æœƒè¨ˆ": "accounting"}' > assets/data/translation_dict.json
          echo '{"files": []}' > assets/data/processed_files.json
      
      - name: å‰µå»ºè™•ç†è…³æœ¬
        run: |
          python3 -c "
          import os
          
          script_content = '''#!/usr/bin/env python3
import os
import sys
import json
import glob
import shutil
from pathlib import Path
from datetime import datetime

def process_documents():
    processed_count = 0
    docx_files = glob.glob(\"word-docs/*.docx\")
    docx_files = [f for f in docx_files if not os.path.basename(f).startswith(\"~\")]
    
    print(f\"ç™¼ç¾ {len(docx_files)} å€‹Wordæ–‡æª”\")
    
    for docx_file in docx_files:
        basename = os.path.basename(docx_file).replace(\".docx\", \"\")
        clean_name = basename.lower().replace(\" \", \"-\").replace(\"_\", \"-\")
        
        import re
        clean_name = re.sub(r\"[^\\w\\-]\", \"\", clean_name)
        clean_name = re.sub(r\"-+\", \"-\", clean_name).strip(\"-\")
        
        date_str = datetime.now().strftime(\"%Y-%m-%d\")
        html_filename = f\"{date_str}-{clean_name}.html\"
        html_path = f\"blog/{html_filename}\"
        
        html_content = f\"\"\"<!DOCTYPE html>
<html lang=\"zh-TW\">
<head>
    <meta charset=\"utf-8\"/>
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"/>
    <title>{basename} | éœçˆ¾æœæ–¯æœƒè¨ˆå¸«äº‹å‹™æ‰€</title>
    <meta name=\"description\" content=\"{basename} çš„è©³ç´°èªªæ˜å’Œå°ˆæ¥­åˆ†æ\"/>
</head>
<body>
    <header>
        <h1>{basename}</h1>
        <time datetime=\"{date_str}\">{date_str}</time>
    </header>
    <main>
        <h2>æ–‡æª”æ¦‚è¿°</h2>
        <p>æœ¬æ–‡æª”ä¾†æºæ–¼ <strong>{basename}</strong>ï¼ŒåŒ…å«é‡è¦çš„è²¡ç¨…ç›¸é—œè³‡è¨Šã€‚</p>
        <h3>ä¸»è¦å…§å®¹</h3>
        <ul>
            <li>å°ˆæ¥­çš„ç¨…å‹™åˆ†æå’Œå»ºè­°</li>
            <li>ç›¸é—œæ³•è¦è§£è®€å’Œæ‡‰ç”¨</li>
            <li>å¯¦å‹™æ“ä½œæŒ‡å°</li>
        </ul>
        <p><em>è™•ç†æ™‚é–“: {datetime.now().strftime(\"%Yå¹´%mæœˆ%dæ—¥\")}</em></p>
    </main>
    <footer>
        <p>Â© 2025 éœçˆ¾æœæ–¯æœƒè¨ˆå¸«äº‹å‹™æ‰€. ç‰ˆæ¬Šæ‰€æœ‰.</p>
    </footer>
</body>
</html>\"\"\"
        
        with open(html_path, \"w\", encoding=\"utf-8\") as f:
            f.write(html_content)
        
        print(f\"âœ“ å‰µå»ºHTML: {html_path}\")
        
        processed_path = f\"word-docs/processed/{os.path.basename(docx_file)}\"
        if os.path.exists(docx_file):
            shutil.move(docx_file, processed_path)
            print(f\"âœ“ ç§»å‹•æ–‡ä»¶åˆ°: {processed_path}\")
        
        processed_count += 1
    
    return processed_count

def generate_json():
    blog_data = {
        \"posts\": [],
        \"categories\": [
            {\"name\": \"ç¨…å‹™ç›¸é—œ\", \"slug\": \"tax\", \"count\": 0}
        ],
        \"total_posts\": 0,
        \"last_updated\": datetime.now().isoformat()
    }
    
    html_files = glob.glob(\"blog/*.html\")
    
    for html_file in html_files:
        filename = os.path.basename(html_file).replace(\".html\", \"\")
        parts = filename.split(\"-\")
        
        if len(parts) >= 4:
            date_str = \"-\".join(parts[:3])
            title = \" \".join(parts[3:]).replace(\"-\", \" \").title()
        else:
            date_str = datetime.now().strftime(\"%Y-%m-%d\")
            title = filename.replace(\"-\", \" \").title()
        
        post = {
            \"title\": title,
            \"url\": filename,
            \"date\": date_str,
            \"summary\": f\"{title} çš„è©³ç´°èªªæ˜å’Œå°ˆæ¥­åˆ†æã€‚\",
            \"category\": \"tax\"
        }
        
        blog_data[\"posts\"].append(post)
        blog_data[\"categories\"][0][\"count\"] += 1
    
    blog_data[\"posts\"].sort(key=lambda x: x[\"date\"], reverse=True)
    blog_data[\"total_posts\"] = len(blog_data[\"posts\"])
    
    with open(\"assets/data/blog_posts.json\", \"w\", encoding=\"utf-8\") as f:
        json.dump(blog_data, f, ensure_ascii=False, indent=2)
    
    print(f\"âœ“ JSONç”Ÿæˆå®Œæˆ: {blog_data[\'total_posts\']} ç¯‡æ–‡ç« \")
    return blog_data

def generate_sitemap():
    sitemap = \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">
  <url>
    <loc>https://www.horgoscpa.com/</loc>
    <lastmod>{}</lastmod>
    <priority>1.0</priority>
  </url>
  <url>
    <loc>https://www.horgoscpa.com/blog.html</loc>
    <lastmod>{}</lastmod>
    <priority>0.9</priority>
  </url>\"\"\".format(datetime.now().strftime(\"%Y-%m-%d\"), datetime.now().strftime(\"%Y-%m-%d\"))
    
    html_files = glob.glob(\"blog/*.html\")
    for html_file in html_files:
        filename = os.path.basename(html_file)
        sitemap += f\"\"\"
  <url>
    <loc>https://www.horgoscpa.com/blog/{filename}</loc>
    <lastmod>{datetime.now().strftime(\"%Y-%m-%d\")}</lastmod>
    <priority>0.8</priority>
  </url>\"\"\"
    
    sitemap += \"\"\"
</urlset>\"\"\"
    
    with open(\"sitemap.xml\", \"w\", encoding=\"utf-8\") as f:
        f.write(sitemap)
    
    print(\"âœ“ ç¶²ç«™åœ°åœ–ç”Ÿæˆå®Œæˆ\")

def main():
    print(\"é–‹å§‹è™•ç†...\")
    
    processed_count = process_documents()
    
    if processed_count > 0:
        print(f\"è™•ç†äº† {processed_count} å€‹æ–‡æª”\")
        with open(os.environ.get(\"GITHUB_OUTPUT\", \"/dev/null\"), \"a\") as f:
            f.write(\"files_changed=true\\n\")
    else:
        print(\"æ²’æœ‰æ–‡æª”éœ€è¦è™•ç†\")
        with open(os.environ.get(\"GITHUB_OUTPUT\", \"/dev/null\"), \"a\") as f:
            f.write(\"files_changed=false\\n\")
    
    generate_json()
    generate_sitemap()
    
    print(\"è™•ç†å®Œæˆ\")

if __name__ == \"__main__\":
    main()
'''
          
          with open('process.py', 'w', encoding='utf-8') as f:
              f.write(script_content)
          
          print('è…³æœ¬å‰µå»ºå®Œæˆ')
          "

      - name: æª¢æŸ¥Wordæ–‡æª”
        id: check_docs
        run: |
          if [ -d "word-docs" ]; then
            COUNT=$(find word-docs -maxdepth 1 -name "*.docx" ! -name "~*" | wc -l)
            if [ "$COUNT" -gt 0 ]; then
              echo "has_docs=true" >> $GITHUB_OUTPUT
              echo "ç™¼ç¾ $COUNT å€‹Wordæ–‡æª”"
            else
              echo "has_docs=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_docs=false" >> $GITHUB_OUTPUT
          fi

      - name: åŸ·è¡Œè™•ç†
        id: process
        if: github.event.inputs.process_word == 'true' || steps.check_docs.outputs.has_docs == 'true' || github.event.inputs.update_json == 'true'
        run: |
          python process.py

      - name: æäº¤è®Šæ›´
        if: steps.process.outputs.files_changed == 'true' || github.event.inputs.update_json == 'true'
        run: |
          git add blog/*.html 2>/dev/null || true
          git add assets/data/*.json 2>/dev/null || true
          git add sitemap.xml 2>/dev/null || true
          git add word-docs/processed/*.docx 2>/dev/null || true
          
          if ! git diff --cached --quiet; then
            git commit -m "è‡ªå‹•åŒ–è™•ç†: æ›´æ–°æ–‡æª”å’Œæ•¸æ“š [$(date '+%Y-%m-%d %H:%M:%S')]"
            git push
            echo "è®Šæ›´å·²æäº¤"
          else
            echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
          fi

      - name: åŸ·è¡Œçµæœ
        run: |
          echo "=========================================="
          echo "           åŸ·è¡Œå®Œæˆ"
          echo "=========================================="
          echo "æ™‚é–“: $(date)"
          echo "HTMLæ–‡ä»¶: $(find blog -name "*.html" 2>/dev/null | wc -l) å€‹"
          echo "Wordæ–‡æª”: $(find word-docs -name "*.docx" 2>/dev/null | wc -l) å€‹"
          echo "å·²è™•ç†: $(find word-docs/processed -name "*.docx" 2>/dev/null | wc -l) å€‹"
          echo "ğŸ‰ è™•ç†å®Œæˆï¼"