<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="霍爾果斯會計師事務所內部管理系統登入" />
    <title>登入｜霍爾果斯會計師事務所內部管理系統</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/login.css" />
    <!-- 數據預加載系統 -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
  </head>
  <body>
    <main class="login">
      <div class="login__background">
        <div class="login__pattern"></div>
      </div>
      <section class="login__card">
        <div class="login__header">
          <img src="/assets/images/logo-white.png" alt="霍爾果斯會計師事務所" class="login__logo" />
          <h1 class="login__company">霍爾果斯會計師事務所</h1>
          <p class="login__subtitle">內部管理系統</p>
        </div>
        <form class="login__form" method="post" action="#" autocomplete="on" novalidate>
          <div class="login__field">
            <label for="username">帳號</label>
            <input id="username" name="username" type="text" inputmode="latin" required autocomplete="username" pattern="[a-zA-Z0-9_]+" title="帳號僅限英文字母、數字和底線" />
            <small class="login__hint-text">僅限英文字母、數字和底線</small>
          </div>
          <div class="login__field">
            <label for="password">密碼</label>
            <input id="password" name="password" type="password" required autocomplete="current-password" />
          </div>
          <button class="login__submit" type="submit">登入</button>
          <p id="login-error" class="login__error" aria-live="polite"></p>
          <p class="login__hint">此頁面僅供內部使用。</p>
        </form>
      </section>
    </main>
    <script>
      (function () {
        const form = document.querySelector('.login__form');
        const usernameEl = document.getElementById('username');
        const passwordEl = document.getElementById('password');
        const errorEl = document.getElementById('login-error');
        const submitBtn = document.querySelector('.login__submit');

        function setError(msg) {
          if (errorEl) errorEl.textContent = msg || '';
        }

        function setLoading(isLoading) {
          if (!submitBtn) return;
          submitBtn.disabled = !!isLoading;
          submitBtn.setAttribute('aria-busy', isLoading ? 'true' : 'false');
          submitBtn.textContent = isLoading ? '登入中…' : '登入';
        }

        function getRedirectTarget() {
          const url = new URL(location.href);
          const target = url.searchParams.get('redirect') || '';
          if (!target) return null;
          // 僅允許站內路徑，避免 open redirect
          if (target.startsWith('/internal/')) return target;
          if (target === '/' || target === '/internal') return '/internal/';
          return null;
        }

        form.addEventListener('submit', async function (e) {
          e.preventDefault();
          setError('');
          setLoading(true);
          const username = (usernameEl.value || '').trim();
          const password = passwordEl.value || '';
          if (!username) {
            setError('請輸入帳號');
            usernameEl.focus();
            setLoading(false);
            return;
          }
          if (!password) {
            setError('請輸入密碼');
            passwordEl.focus();
            setLoading(false);
            return;
          }
          const onProdHost = location.hostname.endsWith('horgoscpa.com');
          const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
          
          // 在發送登入請求的同時，準備預加載（但還不執行）
          let preloadPromise = null;
          
          try {
            // 發送登入請求
            const loginPromise = fetch(apiBase + '/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ username, password })
            });
            
            // 等待登入請求完成
            const res = await loginPromise;
            const json = await res.json().catch(() => null);
            
            if (!res.ok || !json || json.ok !== true) {
              let msg = (json && json.message) || '登入失敗，請稍後再試';
              if (json && json.code === 'UNAUTHORIZED') msg = '帳號或密碼錯誤';
              if (json && json.code === 'ACCOUNT_LOCKED') msg = '帳號已鎖定，請15分鐘後再試';
              if (res.status === 429) msg = '嘗試過多，請稍後再試';
              setError(msg);
              setLoading(false);
              return;
            }
            
            // 登入成功！立即跳轉（預加載在背景啟動）
            console.log('[Login] ✓ 登入成功');
            
            // 立即跳轉，不等待任何預加載
            const redirect = getRedirectTarget();
            const fallback = onProdHost ? '/internal/dashboard' : 'https://www.horgoscpa.com/internal/dashboard';
            
            // 在跳轉前啟動預加載（完全非阻塞）
            if (window.DataCache && window.DataCache.preloadAll) {
              // 預加載會在新頁面中繼續進行
              window.DataCache.preloadAll({ adminMode: true }).then(() => {
                console.log('[Login] ✓ 背景預加載完成');
              }).catch(err => {
                console.warn('[Login] ⚠ 背景預加載部分失敗', err);
              });
            }
            
            // 立即跳轉，無任何延遲
            location.assign(redirect || fallback);
          } catch (err) {
            setError('網路或伺服器異常，請稍後再試');
            setLoading(false);
          }
        });

        // 限制帳號輸入為英文字母、數字和底線
        usernameEl.addEventListener('input', function(e) {
          const cursorPos = this.selectionStart;
          const oldValue = this.value;
          const newValue = oldValue.replace(/[^a-zA-Z0-9_]/g, '');
          if (oldValue !== newValue) {
            this.value = newValue;
            this.setSelectionRange(cursorPos - 1, cursorPos - 1);
          }
          setError('');
        });
        
        passwordEl.addEventListener('input', () => setError(''));

        // ===== 頁面加載時的預優化 =====
        // 在用戶還沒登入時就開始準備，提升整體響應速度
        (function pageLoadOptimization() {
          console.log('[Login] 頁面加載優化啟動');
          
          // 1. 檢查是否已經有 session（用戶之前登入過且未過期）
          function checkExistingSession() {
            const onProdHost = location.hostname.endsWith('horgoscpa.com');
            const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
            
            // 靜默檢查 session，不阻塞頁面
            fetch(apiBase + '/auth/me', {
              method: 'GET',
              credentials: 'include'
            }).then(res => {
              if (res.ok) {
                return res.json();
              }
              return null;
            }).then(json => {
              if (json && json.ok && json.data) {
                console.log('[Login] 檢測到有效 session，開始管理員完整預加載');
                // 有效 session，立即啟動管理員完整預加載
                if (window.DataCache && window.DataCache.preloadAll) {
                  window.DataCache.preloadAll({ adminMode: true });
                }
                
                // 提示用戶可以直接進入系統
                const hint = document.createElement('div');
                hint.style.cssText = `
                  position: fixed;
                  top: 20px;
                  right: 20px;
                  background: #4A90E2;
                  color: white;
                  padding: 12px 20px;
                  border-radius: 6px;
                  font-size: 14px;
                  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                  z-index: 1000;
                  cursor: pointer;
                  transition: all 0.3s;
                `;
                hint.textContent = '✓ 已登入 - 點擊直接進入系統';
                hint.onclick = () => {
                  location.assign(onProdHost ? '/internal/dashboard' : 'https://www.horgoscpa.com/internal/dashboard');
                };
                hint.onmouseenter = () => {
                  hint.style.background = '#357ABD';
                  hint.style.transform = 'translateY(-2px)';
                };
                hint.onmouseleave = () => {
                  hint.style.background = '#4A90E2';
                  hint.style.transform = 'translateY(0)';
                };
                document.body.appendChild(hint);
              } else {
                console.log('[Login] 無有效 session');
              }
            }).catch(err => {
              console.log('[Login] Session 檢查失敗（正常，用戶未登入）');
            });
          }
          
          // 2. 預熱緩存系統，檢查是否有舊的有效緩存
          function checkCachedData() {
            if (window.DataCache) {
              const cacheKeys = ['me', 'users', 'clients', 'tags', 'settings'];
              let cachedCount = 0;
              
              cacheKeys.forEach(key => {
                try {
                  const cached = localStorage.getItem(`horgos_cache_1.0.0_${key}`);
                  if (cached) {
                    const data = JSON.parse(cached);
                    if (data.timestamp && (Date.now() - data.timestamp) < 300000) { // 5分鐘內
                      cachedCount++;
                    }
                  }
                } catch (e) {}
              });
              
              if (cachedCount > 0) {
                console.log(`[Login] 發現 ${cachedCount} 個有效緩存，系統加載將更快`);
              }
            }
          }
          
          // 3. 預加載關鍵靜態資源（CSS, JS）- 所有內部頁面需要的資源
          function preloadStaticResources() {
            const resources = [
              // 核心系統樣式
              { href: '/assets/css/internal-system.css', as: 'style' },
              { href: '/assets/css/internal-components.css', as: 'style' },
              { href: '/assets/css/navbar.css', as: 'style' },
              { href: '/assets/css/footer.css', as: 'style' },
              
              // 各頁面樣式（最常訪問的）
              { href: '/assets/css/dashboard-page.css', as: 'style' },
              { href: '/assets/css/clients-page.css', as: 'style' },
              { href: '/assets/css/tasks-page.css', as: 'style' },
              { href: '/assets/css/receipts-page.css', as: 'style' },
              { href: '/assets/css/timesheet-page.css', as: 'style' },
              { href: '/assets/css/knowledge-page.css', as: 'style' },
              { href: '/assets/css/payroll-page.css', as: 'style' },
              { href: '/assets/css/costs-page.css', as: 'style' },
              { href: '/assets/css/leaves-page.css', as: 'style' },
              { href: '/assets/css/settings-page.css', as: 'style' },
              { href: '/assets/css/reports-page.css', as: 'style' },
              
              // 核心 JavaScript（按優先級）
              { href: '/assets/js/data-cache.js', as: 'script' },
              { href: '/assets/js/fetch-interceptor.js', as: 'script' },
              { href: '/assets/js/data-helper.js', as: 'script' },
              { href: '/assets/js/components/bootstrap.js', as: 'script' }
            ];
            
            resources.forEach(res => {
              const link = document.createElement('link');
              link.rel = 'preload';
              link.href = res.href;
              link.as = res.as;
              document.head.appendChild(link);
            });
            
            console.log(`[Login] 已預加載 ${resources.length} 個關鍵靜態資源`);
          }
          
          // 4. DNS 預連接（加速 API 請求）
          function setupDNSPrefetch() {
            const link = document.createElement('link');
            link.rel = 'dns-prefetch';
            link.href = 'https://www.horgoscpa.com';
            document.head.appendChild(link);
            
            // 同時建立預連接（preconnect）以建立完整 TCP + TLS 連接
            const preconnect = document.createElement('link');
            preconnect.rel = 'preconnect';
            preconnect.href = 'https://www.horgoscpa.com';
            preconnect.crossOrigin = 'use-credentials';
            document.head.appendChild(preconnect);
            
            console.log('[Login] 已建立 DNS 預連接和 API 預連接');
          }
          
          // 5. 預熱 API 連接（發送輕量級請求建立連接池）
          function warmupAPIConnection() {
            const onProdHost = location.hostname.endsWith('horgoscpa.com');
            const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
            
            // 發送一個輕量級 OPTIONS 請求來建立連接
            // 即使失敗也沒關係，目的是建立 TCP/TLS 連接
            fetch(apiBase + '/auth/me', {
              method: 'HEAD',
              credentials: 'include',
              cache: 'no-store'
            }).then(() => {
              console.log('[Login] API 連接已預熱');
            }).catch(() => {
              console.log('[Login] API 連接預熱完成（建立連接）');
            });
          }
          
          // 6. 準備 localStorage 空間（清理過期緩存）
          function prepareLocalStorage() {
            try {
              // 清理超過 7 天的舊緩存
              const now = Date.now();
              const keysToRemove = [];
              
              for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('horgos_cache_')) {
                  try {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (data.timestamp && (now - data.timestamp) > 7 * 24 * 60 * 60 * 1000) {
                      keysToRemove.push(key);
                    }
                  } catch (e) {
                    keysToRemove.push(key);
                  }
                }
              }
              
              keysToRemove.forEach(key => localStorage.removeItem(key));
              
              if (keysToRemove.length > 0) {
                console.log(`[Login] 已清理 ${keysToRemove.length} 個過期緩存`);
              }
            } catch (e) {
              console.warn('[Login] 清理緩存失敗', e);
            }
          }
          
          // 執行優化步驟（立即執行，不延遲）
          // 無論用戶是否已登入，都積極準備
          checkExistingSession();      // 檢查現有 session 並可能啟動預加載
          checkCachedData();            // 檢查已有的緩存數據
          preloadStaticResources();     // 立即預加載所有靜態資源
          setupDNSPrefetch();           // 立即建立 DNS 和 API 連接
          prepareLocalStorage();        // 清理舊緩存，準備空間
          
          // 稍後預熱 API 連接（不阻塞頁面）
          setTimeout(() => {
            warmupAPIConnection();
          }, 50);
        })();
      })();
    </script>
  </body>
  </html>


