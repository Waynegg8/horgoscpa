<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="éœçˆ¾æœæ–¯æœƒè¨ˆå¸«äº‹å‹™æ‰€å…§éƒ¨ç®¡ç†ç³»çµ±ç™»å…¥" />
    <title>ç™»å…¥ï½œéœçˆ¾æœæ–¯æœƒè¨ˆå¸«äº‹å‹™æ‰€å…§éƒ¨ç®¡ç†ç³»çµ±</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/login.css" />
    <!-- æ•¸æ“šé åŠ è¼‰ç³»çµ± -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
  </head>
  <body>
    <main class="login">
      <div class="login__background">
        <div class="login__pattern"></div>
      </div>
      <section class="login__card">
        <div class="login__header">
          <img src="/assets/images/logo-white.png" alt="éœçˆ¾æœæ–¯æœƒè¨ˆå¸«äº‹å‹™æ‰€" class="login__logo" />
          <h1 class="login__company">éœçˆ¾æœæ–¯æœƒè¨ˆå¸«äº‹å‹™æ‰€</h1>
          <p class="login__subtitle">å…§éƒ¨ç®¡ç†ç³»çµ±</p>
        </div>
        <form class="login__form" method="post" action="#" autocomplete="on" novalidate>
          <div class="login__field">
            <label for="username">å¸³è™Ÿ</label>
            <input id="username" name="username" type="text" inputmode="latin" required autocomplete="username" pattern="[a-zA-Z0-9_]+" title="å¸³è™Ÿåƒ…é™è‹±æ–‡å­—æ¯ã€æ•¸å­—å’Œåº•ç·š" />
            <small class="login__hint-text">åƒ…é™è‹±æ–‡å­—æ¯ã€æ•¸å­—å’Œåº•ç·š</small>
          </div>
          <div class="login__field">
            <label for="password">å¯†ç¢¼</label>
            <input id="password" name="password" type="password" required autocomplete="current-password" />
          </div>
          <button class="login__submit" type="submit">ç™»å…¥</button>
          <p id="login-error" class="login__error" aria-live="polite"></p>
          <p class="login__hint">æ­¤é é¢åƒ…ä¾›å…§éƒ¨ä½¿ç”¨ã€‚</p>
        </form>
      </section>
    </main>
    <script>
      (function () {
        const form = document.querySelector('.login__form');
        const usernameEl = document.getElementById('username');
        const passwordEl = document.getElementById('password');
        const errorEl = document.getElementById('login-error');
        const submitBtn = document.querySelector('.login__submit');

        function setError(msg) {
          if (errorEl) errorEl.textContent = msg || '';
        }

        function setLoading(isLoading) {
          if (!submitBtn) return;
          submitBtn.disabled = !!isLoading;
          submitBtn.setAttribute('aria-busy', isLoading ? 'true' : 'false');
          submitBtn.textContent = isLoading ? 'ç™»å…¥ä¸­â€¦' : 'ç™»å…¥';
        }

        function getRedirectTarget() {
          const url = new URL(location.href);
          const target = url.searchParams.get('redirect') || '';
          if (!target) return null;
          // åƒ…å…è¨±ç«™å…§è·¯å¾‘ï¼Œé¿å… open redirect
          if (target.startsWith('/internal/')) return target;
          if (target === '/' || target === '/internal') return '/internal/';
          return null;
        }

        form.addEventListener('submit', async function (e) {
          e.preventDefault();
          setError('');
          setLoading(true);
          const username = (usernameEl.value || '').trim();
          const password = passwordEl.value || '';
          if (!username) {
            setError('è«‹è¼¸å…¥å¸³è™Ÿ');
            usernameEl.focus();
            setLoading(false);
            return;
          }
          if (!password) {
            setError('è«‹è¼¸å…¥å¯†ç¢¼');
            passwordEl.focus();
            setLoading(false);
            return;
          }
          const onProdHost = location.hostname.endsWith('horgoscpa.com');
          const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
          
          // åœ¨ç™¼é€ç™»å…¥è«‹æ±‚çš„åŒæ™‚ï¼Œæº–å‚™é åŠ è¼‰ï¼ˆä½†é‚„ä¸åŸ·è¡Œï¼‰
          let preloadPromise = null;
          
          try {
            // ç™¼é€ç™»å…¥è«‹æ±‚
            const loginPromise = fetch(apiBase + '/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ username, password })
            });
            
            // ç­‰å¾…ç™»å…¥è«‹æ±‚å®Œæˆ
            const res = await loginPromise;
            const json = await res.json().catch(() => null);
            
            if (!res.ok || !json || json.ok !== true) {
              let msg = (json && json.message) || 'ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
              if (json && json.code === 'UNAUTHORIZED') msg = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
              if (json && json.code === 'ACCOUNT_LOCKED') msg = 'å¸³è™Ÿå·²é–å®šï¼Œè«‹15åˆ†é˜å¾Œå†è©¦';
              if (res.status === 429) msg = 'å˜—è©¦éå¤šï¼Œè«‹ç¨å¾Œå†è©¦';
              setError(msg);
              setLoading(false);
              return;
            }
            
            // ç™»å…¥æˆåŠŸï¼ç«‹å³è·³è½‰
            console.log('[Login] âœ“ ç™»å…¥æˆåŠŸ');
            
            // ç«‹å³è·³è½‰ï¼Œä¸ç­‰å¾…ä»»ä½•é åŠ è¼‰ï¼ˆé åŠ è¼‰å·²åœ¨é é¢åŠ è¼‰æ™‚å•Ÿå‹•ï¼‰
            const redirect = getRedirectTarget();
            const fallback = onProdHost ? '/internal/dashboard' : 'https://www.horgoscpa.com/internal/dashboard';
            
            // ç«‹å³è·³è½‰ï¼Œç„¡ä»»ä½•å»¶é²ï¼ˆé åŠ è¼‰æœƒè‡ªå‹•ç¹¼çºŒï¼‰
            location.assign(redirect || fallback);
          } catch (err) {
            setError('ç¶²è·¯æˆ–ä¼ºæœå™¨ç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦');
            setLoading(false);
          }
        });

        // é™åˆ¶å¸³è™Ÿè¼¸å…¥ç‚ºè‹±æ–‡å­—æ¯ã€æ•¸å­—å’Œåº•ç·š
        usernameEl.addEventListener('input', function(e) {
          const cursorPos = this.selectionStart;
          const oldValue = this.value;
          const newValue = oldValue.replace(/[^a-zA-Z0-9_]/g, '');
          if (oldValue !== newValue) {
            this.value = newValue;
            this.setSelectionRange(cursorPos - 1, cursorPos - 1);
          }
          setError('');
        });
        
        passwordEl.addEventListener('input', () => setError(''));

        // ===== é é¢åŠ è¼‰æ™‚çš„é å„ªåŒ– =====
        // ğŸš€ é—œéµï¼šåœ¨ç™»å…¥é é¢å°±ç«‹å³é–‹å§‹é åŠ è¼‰æ‰€æœ‰å…§å®¹ï¼
        (function pageLoadOptimization() {
          console.log('[Login] ğŸš€ ç«‹å³å•Ÿå‹•å®Œæ•´é åŠ è¼‰ç³»çµ±');
          
          // ğŸ”¥ ç«‹å³å•Ÿå‹•é åŠ è¼‰ï¼ˆä¸ç­‰å¾… session æª¢æŸ¥ï¼‰
          function startImmediatePreload() {
            if (window.DataCache && window.DataCache.preloadAll) {
              console.log('[Login] é–‹å§‹é åŠ è¼‰æ‰€æœ‰å…§å®¹ï¼ˆç®¡ç†å“¡æ¨¡å¼ï¼‰...');
              window.DataCache.preloadAll({ adminMode: true }).then(() => {
                console.log('[Login] âœ… é åŠ è¼‰å®Œæˆï¼ç¾åœ¨ç™»å…¥å°‡æ¥µé€Ÿé€²å…¥ç³»çµ±');
              }).catch(err => {
                console.warn('[Login] âš  é åŠ è¼‰éƒ¨åˆ†å¤±æ•—ï¼ˆæ­£å¸¸ï¼ŒæŸäº› API éœ€è¦ç™»å…¥ï¼‰', err);
              });
            } else {
              console.warn('[Login] âš  DataCache å°šæœªå°±ç·’ï¼Œç­‰å¾…...');
              setTimeout(startImmediatePreload, 100);
            }
          }
          
          // 1. æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰ sessionï¼ˆç”¨æˆ¶ä¹‹å‰ç™»å…¥éä¸”æœªéæœŸï¼‰
          function checkExistingSession() {
            const onProdHost = location.hostname.endsWith('horgoscpa.com');
            const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
            
            // éœé»˜æª¢æŸ¥ sessionï¼ˆå®Œå…¨éœé»˜ï¼Œä¸è¨˜éŒ„ä»»ä½•æ—¥èªŒï¼‰
            fetch(apiBase + '/auth/me', {
              method: 'GET',
              credentials: 'include'
            }).then(res => {
              if (res.ok) {
                return res.json();
              }
              return null;
            }).then(json => {
              if (json && json.ok && json.data) {
                // æœ‰æ•ˆ sessionï¼Œé¡¯ç¤ºæç¤º
                const hint = document.createElement('div');
                hint.style.cssText = `
                  position: fixed;
                  top: 20px;
                  right: 20px;
                  background: #4A90E2;
                  color: white;
                  padding: 12px 20px;
                  border-radius: 6px;
                  font-size: 14px;
                  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                  z-index: 1000;
                  cursor: pointer;
                  transition: all 0.3s;
                `;
                hint.textContent = 'âœ“ å·²ç™»å…¥ - é»æ“Šç›´æ¥é€²å…¥ç³»çµ±';
                hint.onclick = () => {
                  location.assign(onProdHost ? '/internal/dashboard' : 'https://www.horgoscpa.com/internal/dashboard');
                };
                hint.onmouseenter = () => {
                  hint.style.background = '#357ABD';
                  hint.style.transform = 'translateY(-2px)';
                };
                hint.onmouseleave = () => {
                  hint.style.background = '#4A90E2';
                  hint.style.transform = 'translateY(0)';
                };
                document.body.appendChild(hint);
              }
            }).catch(() => {
              // å®Œå…¨éœé»˜è™•ç†éŒ¯èª¤ï¼ˆ401ç­‰æ­£å¸¸éŒ¯èª¤ï¼‰
            });
          }
          
          // 2. é ç†±ç·©å­˜ç³»çµ±ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰èˆŠçš„æœ‰æ•ˆç·©å­˜
          function checkCachedData() {
            if (window.DataCache) {
              const cacheKeys = ['me', 'users', 'clients', 'tags', 'settings'];
              let cachedCount = 0;
              
              cacheKeys.forEach(key => {
                try {
                  const cached = localStorage.getItem(`horgos_cache_1.0.0_${key}`);
                  if (cached) {
                    const data = JSON.parse(cached);
                    if (data.timestamp && (Date.now() - data.timestamp) < 300000) { // 5åˆ†é˜å…§
                      cachedCount++;
                    }
                  }
                } catch (e) {}
              });
              
              if (cachedCount > 0) {
                console.log(`[Login] ç™¼ç¾ ${cachedCount} å€‹æœ‰æ•ˆç·©å­˜ï¼Œç³»çµ±åŠ è¼‰å°‡æ›´å¿«`);
              }
            }
          }
          
          // 3. é åŠ è¼‰æ‰€æœ‰éœæ…‹è³‡æºï¼ˆå¿½ç•¥è­¦å‘Šï¼Œå°ˆæ³¨ç™»å…¥å¾Œæ¥µè‡´æµæš¢ï¼‰
          function preloadStaticResources() {
            const resources = [
              // === æ ¸å¿ƒç³»çµ±æ¨£å¼ï¼ˆå¿…é ˆï¼‰===
              { href: '/assets/css/common.css', as: 'style' },
              { href: '/assets/css/internal-system.css', as: 'style' },
              { href: '/assets/css/internal-components.css', as: 'style' },
              { href: '/assets/css/navbar.css', as: 'style' },
              { href: '/assets/css/footer.css', as: 'style' },
              { href: '/assets/css/mobile-navbar.css', as: 'style' },
              
              // === æ‰€æœ‰é é¢æ¨£å¼ï¼ˆå…¨é¢é åŠ è¼‰ï¼‰===
              { href: '/assets/css/dashboard-page.css', as: 'style' },
              { href: '/assets/css/clients-page.css', as: 'style' },
              { href: '/assets/css/client-detail-page.css', as: 'style' },
              { href: '/assets/css/tasks-page.css', as: 'style' },
              { href: '/assets/css/task-detail-page.css', as: 'style' },
              { href: '/assets/css/receipts-page.css', as: 'style' },
              { href: '/assets/css/timesheet-page.css', as: 'style' },
              { href: '/assets/css/leaves-page.css', as: 'style' },
              { href: '/assets/css/payroll-page.css', as: 'style' },
              { href: '/assets/css/costs-page.css', as: 'style' },
              { href: '/assets/css/knowledge-page.css', as: 'style' },
              { href: '/assets/css/settings-page.css', as: 'style' },
              { href: '/assets/css/reports-page.css', as: 'style' },
              { href: '/assets/css/lifecycle-page.css', as: 'style' },
              { href: '/assets/css/rules-page.css', as: 'style' },
              { href: '/assets/css/attachments-page.css', as: 'style' },
              { href: '/assets/css/content-editor-page.css', as: 'style' },
              
              // === æ ¸å¿ƒ JavaScriptï¼ˆæŒ‰è¼‰å…¥é †åºï¼‰===
              { href: '/assets/js/data-cache.js', as: 'script' },
              { href: '/assets/js/fetch-interceptor.js', as: 'script' },
              { href: '/assets/js/data-helper.js', as: 'script' },
              { href: '/assets/js/components/bootstrap.js', as: 'script' },
              { href: '/assets/js/components/timesheets.js', as: 'script' },
              
              // === ç¬¬ä¸‰æ–¹åº«ï¼ˆå¦‚æœéœ€è¦ï¼‰===
              { href: '/assets/vendor/quill-better-table.css', as: 'style' },
              { href: '/assets/vendor/quill-better-table.js', as: 'script' },
            ];
            
            resources.forEach(res => {
              const link = document.createElement('link');
              link.rel = 'preload';
              link.href = res.href;
              link.as = res.as;
              if (res.as === 'script') {
                link.crossOrigin = 'anonymous';
              }
              document.head.appendChild(link);
            });
            
            console.log(`[Login] âœ… å·²é åŠ è¼‰ ${resources.length} å€‹éœæ…‹è³‡æºï¼ˆç™»å…¥å¾Œæ¥µè‡´æµæš¢ï¼‰`);
          }
          
          // 4. DNS é é€£æ¥ï¼ˆåŠ é€Ÿ API è«‹æ±‚ï¼‰
          function setupDNSPrefetch() {
            const link = document.createElement('link');
            link.rel = 'dns-prefetch';
            link.href = 'https://www.horgoscpa.com';
            document.head.appendChild(link);
            
            // åŒæ™‚å»ºç«‹é é€£æ¥ï¼ˆpreconnectï¼‰ä»¥å»ºç«‹å®Œæ•´ TCP + TLS é€£æ¥
            const preconnect = document.createElement('link');
            preconnect.rel = 'preconnect';
            preconnect.href = 'https://www.horgoscpa.com';
            preconnect.crossOrigin = 'use-credentials';
            document.head.appendChild(preconnect);
            
            console.log('[Login] å·²å»ºç«‹ DNS é é€£æ¥å’Œ API é é€£æ¥');
          }
          
          // 5. é ç†± API é€£æ¥ï¼ˆéœé»˜å»ºç«‹é€£æ¥ï¼‰
          function warmupAPIConnection() {
            const onProdHost = location.hostname.endsWith('horgoscpa.com');
            const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
            
            // ä½¿ç”¨ GET è€Œä¸æ˜¯ HEADï¼Œé¿å… 405 éŒ¯èª¤
            // å®Œå…¨éœé»˜è™•ç†ï¼Œä¸è¨˜éŒ„ä»»ä½•æ—¥èªŒ
            fetch(apiBase + '/auth/me', {
              method: 'GET',
              credentials: 'include',
              cache: 'no-store'
            }).catch(() => {
              // éœé»˜è™•ç†éŒ¯èª¤ï¼ˆåŒ…æ‹¬401ã€405ç­‰ï¼‰
            });
          }
          
          // 6. æº–å‚™ localStorage ç©ºé–“ï¼ˆæ¸…ç†éæœŸç·©å­˜ï¼‰
          function prepareLocalStorage() {
            try {
              // æ¸…ç†è¶…é 7 å¤©çš„èˆŠç·©å­˜
              const now = Date.now();
              const keysToRemove = [];
              
              for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('horgos_cache_')) {
                  try {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (data.timestamp && (now - data.timestamp) > 7 * 24 * 60 * 60 * 1000) {
                      keysToRemove.push(key);
                    }
                  } catch (e) {
                    keysToRemove.push(key);
                  }
                }
              }
              
              keysToRemove.forEach(key => localStorage.removeItem(key));
              
              if (keysToRemove.length > 0) {
                console.log(`[Login] å·²æ¸…ç† ${keysToRemove.length} å€‹éæœŸç·©å­˜`);
              }
            } catch (e) {
              console.warn('[Login] æ¸…ç†ç·©å­˜å¤±æ•—', e);
            }
          }
          
          // ğŸš€ ç«‹å³åŸ·è¡Œæ‰€æœ‰å„ªåŒ–æ­¥é©Ÿï¼ˆä¸å»¶é²ï¼Œå…¨åŠ›é åŠ è¼‰ï¼‰
          startImmediatePreload();      // ğŸ”¥ æœ€å„ªå…ˆï¼šç«‹å³å•Ÿå‹•å®Œæ•´é åŠ è¼‰
          checkExistingSession();       // æª¢æŸ¥ç¾æœ‰ session
          checkCachedData();            // æª¢æŸ¥å·²æœ‰çš„ç·©å­˜æ•¸æ“š
          preloadStaticResources();     // ç«‹å³é åŠ è¼‰æ‰€æœ‰éœæ…‹è³‡æº
          setupDNSPrefetch();           // ç«‹å³å»ºç«‹ DNS å’Œ API é€£æ¥
          prepareLocalStorage();        // æ¸…ç†èˆŠç·©å­˜
          
          // ç¨å¾Œé ç†± API é€£æ¥
          setTimeout(() => {
            warmupAPIConnection();
          }, 50);
        })();
      })();
    </script>
  </body>
  </html>


