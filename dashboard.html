<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="å„€è¡¨æ¿" />
    <title>å„€è¡¨æ¿ï½œç¸½è¦½</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/dashboard-page.css" />
  </head>
  <body class="dashboard-page">
    <header class="dash-header">
      <div class="dash-top">
        <div class="dash-welcome">
          <span class="welcome-text">æ­¡è¿å›ä¾†ï¼Œ<span id="userName" class="user-name">â€”</span></span>
          <span class="separator">â€¢</span>
          <span id="today" class="dash-date">â€”</span>
        </div>
        <div id="noticeList" class="notice-list-inline" aria-label="é€šçŸ¥" style="display:none;"></div>
      </div>
      <div id="permBar" class="info-bar" style="display:none;" role="alert">æ‚¨æ²’æœ‰æ¬Šé™æª¢è¦–æ­¤å…§å®¹</div>
    </header>

    <main class="dash-content">
      <!-- è‡ªé©æ‡‰ç¶²æ ¼ï¼šä¾è§’è‰²é¡¯ç¤ºä¸åŒå°éƒ¨ä»¶ -->
      <section id="grid" class="dash-grid"></section>
    </main>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const userNameEl = document.getElementById('userName');
        const todayEl = document.getElementById('today');
        const grid = document.getElementById('grid');
        const permBar = document.getElementById('permBar');
        const noticeList = document.getElementById('noticeList');

        let me = null;
        let refreshTimer = null;
        let currentYm = null; // å½“å‰æŸ¥çœ‹çš„å¹´æœˆï¼Œæ ¼å¼ï¼šYYYY-MM
        let financeMode = 'month'; // 'month' æˆ– 'ytd'ï¼ˆæœ¬å¹´ç´¯è®¡ï¼‰
        let financeYm = null; // è´¢åŠ¡æŸ¥çœ‹çš„å¹´æœˆ
        let activityDays = 7; // æœ€è¿‘åŠ¨æ€å¤©æ•°
        let activityUserId = ''; // æœ€è¿‘åŠ¨æ€ç­›é€‰çš„å‘˜å·¥ID

        function formatLocalDate(d){
          try { return new Intl.DateTimeFormat('zh-TW', { dateStyle:'full', timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone }).format(d); } catch(_) { return d.toISOString().slice(0,10); }
        }

        function formatYm(ym){
          // "2025-10" => "2025å¹´10æœˆ"
          if (!ym) return '';
          const [y, m] = ym.split('-');
          return `${y}å¹´${parseInt(m)}æœˆ`;
        }

        function addMonth(ym, delta){
          // "2025-10" + 1 => "2025-11"
          const [y, m] = ym.split('-').map(Number);
          const d = new Date(y, m - 1 + delta, 1);
          const newY = d.getFullYear();
          const newM = d.getMonth() + 1;
          return `${newY}-${String(newM).padStart(2, '0')}`;
        }

        function getCurrentYm(){
          const now = new Date();
          return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        function showNotices(items){
          if (!Array.isArray(items) || items.length === 0) { noticeList.style.display='none'; noticeList.innerHTML = ''; return; }
          noticeList.innerHTML = '';
          items.forEach(n => {
            const div = document.createElement('div');
            const level = (n.level||'info');
            div.className = `notice ${level}`;
            div.innerHTML = `<span class="notice-label">${level==='warning'?'è­¦å‘Š':'è³‡è¨Š'}</span><span class="notice-text">${n.text||''}</span>${n.link?` <a class="link" href="${n.link}">æŸ¥çœ‹</a>`:''}`;
            noticeList.appendChild(div);
          });
          noticeList.style.display = 'block';
        }

        function statCard(title, value, meta){
          return `<div class="card stat"><div class="stat-label">${title}</div><div class="stat-value">${value}</div>${meta?`<div class="stat-meta muted">${meta}</div>`:''}</div>`;
        }

        function listCard(title, rowsHtml){
          return `<div class="card list"><div class="card-title">${title}</div><div class="list-body">${rowsHtml||'<div class=\"muted\">å°šç„¡è³‡æ–™</div>'}</div></div>`;
        }
        
        function listCardWithActivityFilter(title, rowsHtml, users){
          const userOptions = [
            '<option value="">å…¨éƒ¨å“¡å·¥</option>',
            ...users.map(u => `<option value="${u.userId}" ${activityUserId == u.userId ? 'selected' : ''}>${u.name}</option>`)
          ].join('');
          
          return `<div class="card list">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <div class="card-title">${title}</div>
              <div style="display:flex;gap:8px;align-items:center;">
                <select id="activityUserFilter" style="padding:4px 8px;font-size:13px;border:1px solid #e5e7eb;border-radius:4px;background:#fff;">
                  ${userOptions}
                </select>
                <select id="activityDaysFilter" style="padding:4px 8px;font-size:13px;border:1px solid #e5e7eb;border-radius:4px;background:#fff;">
                  <option value="3" ${activityDays == 3 ? 'selected' : ''}>3å¤©å…§</option>
                  <option value="7" ${activityDays == 7 ? 'selected' : ''}>7å¤©å…§</option>
                  <option value="14" ${activityDays == 14 ? 'selected' : ''}>14å¤©å…§</option>
                  <option value="30" ${activityDays == 30 ? 'selected' : ''}>30å¤©å…§</option>
                </select>
              </div>
            </div>
            <div class="list-body" style="max-height:600px;overflow-y:auto;">${rowsHtml||'<div class=\"muted\">å°šç„¡è³‡æ–™</div>'}</div>
          </div>`;
        }

        function generateMonthOptions(selectedYm) {
          // ç”Ÿæˆæœ€è¿‘12ä¸ªæœˆçš„é€‰é¡¹
          const options = [];
          const now = new Date();
          for (let i = 0; i < 12; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const ym = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            const label = formatYm(ym);
            const selected = ym === selectedYm ? ' selected' : '';
            options.push(`<option value="${ym}"${selected}>${label}</option>`);
          }
          return options.join('');
        }

        function listCardWithMonthDropdown(title, rowsHtml, currentYm){
          const options = generateMonthOptions(currentYm);
          return `<div class="card list"><div class="card-title" style="display:flex;align-items:center;justify-content:space-between;">
            <span>${title}</span>
            <select class="month-dropdown" style="padding:6px 12px;border:1px solid #ddd;border-radius:6px;background:#fff;font-size:14px;font-weight:500;cursor:pointer;outline:none;transition:border-color 0.2s;" onchange="this.style.borderColor='#3498db'" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">
              ${options}
            </select>
          </div><div class="list-body">${rowsHtml||'<div class=\"muted\">å°šç„¡è³‡æ–™</div>'}</div></div>`;
        }

        function listCardWithFinanceDropdown(title, rowsHtml, currentYm, mode){
          const options = generateMonthOptions(currentYm);
          return `<div class="card list"><div class="card-title" style="display:flex;align-items:center;justify-content:space-between;">
            <span>${title}</span>
            <div style="display:flex;align-items:center;gap:8px;">
              <select class="finance-month-dropdown" style="padding:6px 12px;border:1px solid #ddd;border-radius:6px;background:#fff;font-size:14px;font-weight:500;cursor:pointer;outline:none;transition:border-color 0.2s;${mode === 'ytd' ? 'opacity:0.5;pointer-events:none;' : ''}" onchange="this.style.borderColor='#3498db'" onfocus="this.style.borderColor='#3498db'" onblur="this.style.borderColor='#ddd'">
                ${options}
              </select>
              <button type="button" class="ytd-btn" style="padding:6px 14px;cursor:pointer;border:1px solid ${mode === 'ytd' ? '#3498db' : '#ddd'};background:${mode === 'ytd' ? '#3498db' : '#fff'};color:${mode === 'ytd' ? '#fff' : '#333'};border-radius:6px;font-weight:500;font-size:14px;transition:all 0.2s;white-space:nowrap;">æœ¬å¹´ç´¯è¨ˆ</button>
            </div>
          </div><div class="list-body">${rowsHtml||'<div class=\"muted\">å°šç„¡è³‡æ–™</div>'}</div></div>`;
        }

        // æ ¼å¼åŒ–æ•°å­—ï¼š0 æ˜¾ç¤ºä¸º "-"ï¼Œé0æ˜¾ç¤ºå¸¦åƒåˆ†å·
        function fmtNum(n){ 
          const val = Number(n||0); 
          if (val === 0) return '-';
          try { 
            return val.toLocaleString('zh-TW'); 
          } catch(_) { 
            return String(val); 
          } 
        }
        
        // æ ¼å¼åŒ–é‡‘é¢ï¼š0 æ˜¾ç¤ºä¸º "-"ï¼Œé0æ˜¾ç¤ºå¸¦åƒåˆ†å·
        function fmtTwd(n){ 
          const val = Number(n||0);
          if (val === 0) return '-';
          try {
            return val.toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
          } catch(_) {
            return String(val);
          }
        }
        
        // æ ¼å¼åŒ–ç™¾åˆ†æ¯”ï¼š0 æ˜¾ç¤ºä¸º "-"
        function fmtPct(n){ 
          const v = Number(n||0); 
          if (v === 0) return '-';
          return `${(Math.round(v*10)/10).toFixed(1)}%`;
        }

        function renderEmployeeDashboard(data){
          grid.innerHTML = '';
          const frag = document.createElement('div');
          const h = data?.myHours || { total:0, normal:0, overtime:0, completionRate:0 };
          const hoursMeta = `æ­£å¸¸ï¼š${fmtNum(h.normal)}ï½œåŠ ç­ï¼š${fmtNum(h.overtime)}ï½œé”æˆç‡ï¼š${fmtPct(h.completionRate)}`;
          const tasks = Array.isArray(data?.myTasks?.items) ? data.myTasks.items : [];
          const taskRows = tasks.length ? tasks.map(t => {
            const cls = t.urgency==='overdue' ? 'danger' : (t.urgency==='urgent' ? 'warn' : '');
            const badge = t.urgency==='overdue' ? '<span class="badge danger">é€¾æœŸ</span>' : (t.urgency==='urgent' ? '<span class="badge warn">æ€¥</span>' : '');
            const due = t.dueDate || 'â€”';
            
            // æ„å»ºçŠ¶æ€ä¿¡æ¯
            let statusInfo = '';
            if (t.blockerReason) {
              statusInfo = `<div style="margin-top:4px;padding:6px 8px;background:#fef2f2;border-left:3px solid #dc2626;font-size:13px;color:#991b1b;">ğŸš« ${t.blockerReason}</div>`;
            } else if (t.overdueReason) {
              statusInfo = `<div style="margin-top:4px;padding:6px 8px;background:#fef2f2;border-left:3px solid #dc2626;font-size:13px;color:#991b1b;">â° ${t.overdueReason}</div>`;
            } else if (t.statusNote) {
              statusInfo = `<div style="margin-top:4px;padding:6px 8px;background:#f0fdf4;border-left:3px solid #16a34a;font-size:13px;color:#166534;">ğŸ’¬ ${t.statusNote}</div>`;
            }
            
            return `<a href="/internal/task-detail?id=${t.id}" style="text-decoration:none;color:inherit;"><div class="task-row ${cls}">
              <div style="display:flex;flex-direction:column;">
                <div><span class="name">${t.name||''}</span><span class="muted" style="margin-left:8px;">åˆ°æœŸï¼š${due}</span> ${badge}</div>
                ${statusInfo}
              </div>
            </div></a>`;
          }).join('') : '<div class="muted">ç›®å‰æ²’æœ‰å¾…è¾¦ä»»å‹™</div>';
          const lv = data?.myLeaves || { balances:{ annual:0, sick:0, compHours:0 }, recent:[] };
          const leavesHtml = `
              <div class="kv"><span>ç‰¹ä¼‘å‰©é¤˜</span><b>${fmtNum(lv.balances?.annual||0)} å¤©</b></div>
              <div class="kv"><span>ç—…å‡å‰©é¤˜</span><b>${fmtNum(lv.balances?.sick||0)} å¤©</b></div>
              <div class="kv"><span>è£œä¼‘</span><b>${fmtNum(lv.balances?.compHours||0)} å°æ™‚</b></div>`;
          // æ”¶æ®å·²å¼€ä½†ä»»åŠ¡æœªå®Œæˆæé†’
          const receiptsPending = Array.isArray(data?.receiptsPendingTasks) ? data.receiptsPendingTasks : [];
          const receiptsHtml = receiptsPending.length ? receiptsPending.map(r => {
            return `<div class="task-row warn">
              <div style="display:flex;flex-direction:column;gap:4px;">
                <span class="name">${r.client_name} - ${r.service_name}</span>
                <div class="muted" style="font-size:12px;">æ”¶æ“š #${r.receipt_number} | åˆ°æœŸï¼š${r.receipt_due_date || 'â€”'}</div>
                <div style="font-size:13px;color:#d97706;">å¾…å®Œæˆä»»å‹™ï¼š${r.pending_tasks} / ${r.total_tasks}</div>
              </div>
            </div>`;
          }).join('') : '<div class="muted">ç„¡å¾…è™•ç†é …ç›®</div>';
          
          frag.innerHTML = [
            statCard('æœ¬æœˆç¸½å·¥æ™‚', fmtNum(h.total), hoursMeta),
            listCard('æˆ‘çš„ä»»å‹™ï¼ˆå¾…è¾¦/é€²è¡Œä¸­ï¼‰', taskRows),
            receiptsPending.length > 0 ? listCard('âš ï¸ æ”¶æ“šå·²é–‹ä½†ä»»å‹™æœªå®Œæˆ', receiptsHtml) : '',
            listCard('æˆ‘çš„å‡æœŸ', leavesHtml)
          ].filter(Boolean).join('');
          grid.appendChild(frag);
        }

        function renderAdminDashboard(data){
          grid.innerHTML = '';
          
          // å„å‘˜å·¥å·¥æ—¶
          const empHours = Array.isArray(data?.employeeHours) ? data.employeeHours : [];
          let hoursHtml = '';
          if (empHours.length > 0) {
            hoursHtml = empHours.map(e => {
              const totalStr = fmtNum(e.total || 0);
              const meta = (e.total && e.total > 0) ? `æ­£å¸¸ ${fmtNum(e.normal)} ï½œ åŠ ç­ ${fmtNum(e.overtime)}` : '';
              return `<div class="emp-row">
                <span class="name">${e.name || 'æœªå‘½å'}</span>
                <div style="display:flex;align-items:center;gap:16px;">
                  ${meta ? `<div class="muted" style="font-size:12px;">${meta}</div>` : ''}
                  <div class="hours-display">
                    <span class="hours-value">${totalStr}</span>
                    <span class="hours-unit">å°æ™‚</span>
                  </div>
                </div>
              </div>`;
            }).join('');
          } else {
            hoursHtml = '<div class="muted">å°šç„¡å“¡å·¥è³‡æ–™</div>';
          }
          
          // å„å‘˜å·¥ä»»åŠ¡çŠ¶æ€ - æ”¹ä¸ºåˆ—è¡¨å½¢å¼ï¼Œå¯ç‚¹å‡»è·³è½¬
          const empTasks = Array.isArray(data?.employeeTasks) ? data.employeeTasks : [];
          const tasksHtml = empTasks.length ? empTasks.map(e => {
            const total = e.completed + e.inProgress + e.overdue + e.pending;
            const activeCount = e.inProgress + e.overdue + e.pending;
            
            // æ„å»ºçŠ¶æ€æ‘˜è¦ - ä½¿ç”¨ badge æ ·å¼
            const badges = [];
            if (e.overdue > 0) badges.push(`<span class="task-badge task-badge-overdue">é€¾æœŸ ${e.overdue}</span>`);
            if (e.inProgress > 0) badges.push(`<span class="task-badge task-badge-progress">é€²è¡Œä¸­ ${e.inProgress}</span>`);
            if (e.pending > 0) badges.push(`<span class="task-badge task-badge-pending">å¾…è¾¦ ${e.pending}</span>`);
            if (e.completed > 0) badges.push(`<span class="task-badge task-badge-completed">å·²å®Œæˆ ${e.completed}</span>`);
            
            const summary = badges.length > 0 ? badges.join('') : '<span class="muted">ç„¡ä»»å‹™</span>';
            
            return `<a href="/internal/tasks?assignee=${e.userId}" class="emp-task-row">
              <span class="emp-task-name">${e.name || 'æœªå‘½å'}</span>
              <div class="emp-task-badges">${summary}</div>
            </a>`;
          }).join('') : '<div class="muted">å°šç„¡ä»»å‹™</div>';
          
          // è´¢åŠ¡çŠ¶å†µ - æ ¹æ®æ¨¡å¼æ˜¾ç¤ºæœˆåº¦æˆ–å¹´åº¦ç´¯è®¡
          const fs = data?.financialStatus || {};
          const emptyData = { period:'', revenue:0, cost:0, profit:0, margin:0, ar:0, paid:0, overdue:0, collectionRate:0 };
          
          // åç«¯åªè¿”å›å½“å‰æ¨¡å¼å¯¹åº”çš„æ•°æ®
          const currentFinData = (financeMode === 'ytd' ? fs.ytd : fs.month) || emptyData;
          
          const finHtml = `
            <div style="display:flex;flex-direction:column;gap:16px;">
              <!-- å¸é¢æ•°æ®ï¼šè¥æ”¶ã€æˆæœ¬ã€æ¯›åˆ©ã€æ¯›åˆ©ç‡ -->
              <div class="fin-row" style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;">
                <div class="fin-metric" data-type="revenue"><div class="fin-metric-label">ç‡Ÿæ”¶</div><div class="fin-metric-value">${fmtTwd(currentFinData.revenue)}</div></div>
                <div class="fin-metric" data-type="cost"><div class="fin-metric-label">æˆæœ¬</div><div class="fin-metric-value">${fmtTwd(currentFinData.cost)}</div></div>
                <div class="fin-metric" data-type="profit"><div class="fin-metric-label">æ¯›åˆ©</div><div class="fin-metric-value">${fmtTwd(currentFinData.profit)}</div></div>
                <div class="fin-metric" data-type="profit"><div class="fin-metric-label">æ¯›åˆ©ç‡</div><div class="fin-metric-value">${fmtPct(currentFinData.margin)}</div></div>
              </div>
              
              <!-- ç°é‡‘æµæ•°æ®ï¼šåº”æ”¶ã€æ”¶æ¬¾ã€é€¾æœŸã€æ”¶æ¬¾ç‡ -->
              <div class="fin-row" style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;">
                <div class="fin-metric" data-type="ar"><div class="fin-metric-label">æ‡‰æ”¶</div><div class="fin-metric-value">${fmtTwd(currentFinData.ar)}</div></div>
                <div class="fin-metric" data-type="paid"><div class="fin-metric-label">æ”¶æ¬¾</div><div class="fin-metric-value">${fmtTwd(currentFinData.paid)}</div></div>
                <div class="fin-metric" data-type="overdue"><div class="fin-metric-label">é€¾æœŸ</div><div class="fin-metric-value">${fmtTwd(currentFinData.overdue)}</div></div>
                <div class="fin-metric" data-type="rate"><div class="fin-metric-label">æ”¶æ¬¾ç‡</div><div class="fin-metric-value">${fmtPct(currentFinData.collectionRate)}</div></div>
              </div>
            </div>`;
          
          // 1. æ¸²æŸ“å„å‘˜å·¥å·¥æ—¶ï¼ˆå¸¦æœˆä»½ä¸‹æ‹‰é€‰å•ï¼‰
          const hoursFrag = document.createElement('div');
          hoursFrag.innerHTML = listCardWithMonthDropdown('å„å“¡å·¥å·¥æ™‚', hoursHtml, currentYm);
          grid.appendChild(hoursFrag.firstElementChild);
          
          // æ·»åŠ æœˆä»½ä¸‹æ‹‰é€‰å•äº‹ä»¶ç›‘å¬
          const hoursCard = Array.from(grid.querySelectorAll('.card.list')).find(c => c.textContent.includes('å„å“¡å·¥å·¥æ™‚'));
          if (hoursCard) {
            const dropdown = hoursCard.querySelector('.month-dropdown');
            if (dropdown) {
              dropdown.addEventListener('change', (e) => {
                currentYm = e.target.value;
                refresh();
              });
            }
          }
          
          // 2. æ¸²æŸ“å„å‘˜å·¥ä»»åŠ¡çŠ¶æ€ï¼ˆåˆ—è¡¨å½¢å¼ï¼‰
          const tasksFrag = document.createElement('div');
          tasksFrag.innerHTML = listCard('å„å“¡å·¥ä»»å‹™ç‹€æ…‹', tasksHtml);
          grid.appendChild(tasksFrag.firstElementChild);
          
          // 2.5 æ”¶æ®å·²å¼€ä½†ä»»åŠ¡æœªå®Œæˆæé†’
          const receiptsPending = Array.isArray(data?.receiptsPendingTasks) ? data.receiptsPendingTasks : [];
          if (receiptsPending.length > 0) {
            const receiptsHtml = receiptsPending.map(r => {
              return `<div class="task-row warn">
                <div style="display:flex;flex-direction:column;gap:4px;">
                  <span class="name">${r.client_name} - ${r.service_name}</span>
                  <div class="muted" style="font-size:12px;">æ”¶æ“š #${r.receipt_number} | åˆ°æœŸï¼š${r.receipt_due_date || 'â€”'}</div>
                  <div style="font-size:13px;color:#d97706;">å¾…å®Œæˆä»»å‹™ï¼š${r.pending_tasks} / ${r.total_tasks}</div>
                </div>
              </div>`;
            }).join('');
            const receiptsFrag = document.createElement('div');
            receiptsFrag.innerHTML = listCard('âš ï¸ æ”¶æ“šå·²é–‹ä½†ä»»å‹™æœªå®Œæˆ', receiptsHtml);
            grid.appendChild(receiptsFrag.firstElementChild);
          }
          
          // 2.7 æœ€è¿‘åŠ¨æ€ (ä»»åŠ¡è°ƒæ•´å’ŒçŠ¶æ€æ›´æ–°)
          const recentActivities = Array.isArray(data?.recentActivities) ? data.recentActivities : [];
          let activitiesHtml = '';
          if (recentActivities.length > 0) {
            activitiesHtml = recentActivities.map(act => {
              if (act.type === 'due_date_adjustment') {
                return `<a href="${act.link || '#'}" style="text-decoration:none;color:inherit;">
                  <div style="padding:10px;border-bottom:1px solid #f3f4f6;cursor:pointer;transition:background 0.15s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:4px;">
                      <div style="font-size:13px;font-weight:600;color:#1f2937;">ğŸ“… ${act.taskName}</div>
                      <div style="font-size:11px;color:#9ca3af;">${act.time}</div>
                    </div>
                    <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">${act.clientName} Â· ${act.serviceName}</div>
                    <div style="display:flex;align-items:center;gap:8px;font-size:12px;">
                      <span style="color:#3b82f6;font-weight:500;">${act.change}</span>
                      <span style="color:#6b7280;">${act.assigneeName}</span>
                    </div>
                    ${act.reason ? `<div style="font-size:12px;color:#6b7280;margin-top:4px;line-height:1.4;padding:6px;background:#fffbeb;border-radius:4px;">${act.reason}</div>` : ''}
                  </div>
                </a>`;
              } else if (act.type === 'status_update') {
                return `<a href="${act.link || '#'}" style="text-decoration:none;color:inherit;">
                  <div style="padding:10px;border-bottom:1px solid #f3f4f6;cursor:pointer;transition:background 0.15s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:4px;">
                      <div style="font-size:13px;font-weight:600;color:#1f2937;">ğŸ“ ${act.taskName}</div>
                      <div style="font-size:11px;color:#9ca3af;">${act.time}</div>
                    </div>
                    <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">${act.clientName} Â· ${act.serviceName}</div>
                    <div style="display:flex;align-items:center;gap:8px;font-size:12px;">
                      <span style="color:#10b981;font-weight:500;">${act.change}</span>
                      <span style="color:#6b7280;">${act.assigneeName}</span>
                    </div>
                    ${act.note ? `<div style="font-size:12px;color:#4b5563;margin-top:4px;line-height:1.4;padding:6px;background:${act.note.startsWith('ğŸš«') || act.note.startsWith('â°') ? '#fef2f2' : '#f0fdf4'};border-radius:4px;">${act.note}</div>` : ''}
                  </div>
                </a>`;
              } else if (act.type === 'leave_application') {
                const statusColor = act.leaveStatus === 'å·²æ ¸å‡†' ? '#10b981' : act.leaveStatus === 'å·²æ‹’çµ•' ? '#ef4444' : '#f59e0b';
                return `<a href="${act.link || '#'}" style="text-decoration:none;color:inherit;">
                  <div style="padding:10px;border-bottom:1px solid #f3f4f6;cursor:pointer;transition:background 0.15s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:4px;">
                      <div style="font-size:13px;font-weight:600;color:#1f2937;">ğŸ–ï¸ ${act.text}</div>
                      <div style="font-size:11px;color:#9ca3af;">${act.time}</div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;font-size:12px;margin-bottom:4px;">
                      <span style="color:#6b7280;">${act.period}</span>
                      <span style="padding:2px 6px;border-radius:3px;background:#f3f4f6;color:#1f2937;font-weight:500;">${act.leaveDays}å¤©</span>
                      <span style="padding:2px 6px;border-radius:3px;color:${statusColor};font-weight:500;">${act.leaveStatus}</span>
                    </div>
                    ${act.reason ? `<div style="font-size:12px;color:#6b7280;margin-top:4px;line-height:1.4;">${act.reason}</div>` : ''}
                  </div>
                </a>`;
              } else if (act.type === 'timesheet_reminder') {
                return `<a href="${act.link || '#'}" style="text-decoration:none;color:inherit;">
                  <div style="padding:10px;border-bottom:1px solid #f3f4f6;cursor:pointer;transition:background 0.15s;background:#fef2f2;" onmouseover="this.style.background='#fee2e2'" onmouseout="this.style.background='#fef2f2'">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:4px;">
                      <div style="font-size:13px;font-weight:600;color:#dc2626;">âš ï¸ ${act.text}</div>
                      <div style="font-size:11px;color:#9ca3af;">${act.time}</div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;font-size:12px;">
                      <span style="padding:2px 6px;border-radius:3px;background:#fee2e2;color:#dc2626;font-weight:500;">${act.missingCount}å¤©æœªå¡«</span>
                      <span style="color:#6b7280;font-size:11px;">${act.missingDates}</span>
                    </div>
                  </div>
                </a>`;
              }
              return '';
            }).join('');
          } else {
            activitiesHtml = `<div class="muted">æœ€è¿‘ ${activityDays} å¤©æ²’æœ‰å‹•æ…‹è¨˜éŒ„</div>`;
          }
          
          // è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ç”¨äºç­›é€‰
          const allUsers = Array.isArray(data?.teamMembers) ? data.teamMembers : [];
          
          const activitiesFrag = document.createElement('div');
          activitiesFrag.innerHTML = listCardWithActivityFilter('ğŸ“‹ æœ€è¿‘å‹•æ…‹ï¼ˆä»»å‹™Â·å‡æœŸÂ·å·¥æ™‚ï¼‰', activitiesHtml, allUsers);
          const activitiesCard = activitiesFrag.firstElementChild;
          grid.appendChild(activitiesCard);
          
          // æ·»åŠ ç­›é€‰äº‹ä»¶ç›‘å¬
          if (activitiesCard) {
            const userFilter = activitiesCard.querySelector('#activityUserFilter');
            const daysFilter = activitiesCard.querySelector('#activityDaysFilter');
            
            if (userFilter) {
              userFilter.addEventListener('change', (e) => {
                activityUserId = e.target.value;
                refresh();
              });
            }
            
            if (daysFilter) {
              daysFilter.addEventListener('change', (e) => {
                activityDays = parseInt(e.target.value, 10);
                refresh();
              });
            }
          }
          
          // 3. æœ€åæ¸²æŸ“è´¢åŠ¡çŠ¶å†µï¼ˆç‹¬å ä¸€è¡Œï¼Œåœ¨æœ€ä¸‹é¢ï¼‰
          const finFrag = document.createElement('div');
          finFrag.innerHTML = listCardWithFinanceDropdown('è²¡å‹™ç‹€æ³', finHtml, financeYm, financeMode);
          const finCard = finFrag.firstElementChild;
          finCard.classList.add('finance-card'); // æ·»åŠ ç±»ä»¥ç¡®ä¿å…¨å®½
          grid.appendChild(finCard);
          
          // æ·»åŠ è´¢åŠ¡æœˆä»½ä¸‹æ‹‰é€‰å•å’ŒæŒ‰é’®äº‹ä»¶ç›‘å¬
          if (finCard) {
            const dropdown = finCard.querySelector('.finance-month-dropdown');
            const ytdBtn = finCard.querySelector('.ytd-btn');
            
            if (dropdown) {
              dropdown.addEventListener('change', (e) => {
                financeYm = e.target.value;
                financeMode = 'month'; // é€‰æ‹©æœˆä»½æ—¶è‡ªåŠ¨åˆ‡æ¢å›æœˆåº¦æ¨¡å¼
                refresh();
              });
            }
            
            if (ytdBtn) {
              ytdBtn.addEventListener('click', () => {
                // åˆ‡æ¢åˆ°æœ¬å¹´ç´¯è®¡æ¨¡å¼
                financeMode = financeMode === 'ytd' ? 'month' : 'ytd';
                if (financeMode === 'ytd') {
                  // å¦‚æœåˆ‡æ¢åˆ°å¹´åº¦æ¨¡å¼ï¼Œç¡®ä¿financeYmæ˜¯å½“å¹´çš„12æœˆ
                  const currentYear = financeYm.split('-')[0];
                  financeYm = `${currentYear}-12`;
                }
                refresh();
              });
            }
          }
        }

        async function ensureUser(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/dashboard'); return false; }
            const json = await res.json();
            if (!json || json.ok !== true) throw new Error();
            me = json.data || null;
            userNameEl.textContent = me?.name || me?.username || 'â€”';
            return true;
          } catch (_) {
            permBar.textContent = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
            permBar.style.display = 'block';
            return false;
          }
        }

        function renderSkeleton(){
          grid.innerHTML = '<div class="card" style="padding:16px;">è¼‰å…¥ä¸­â€¦</div>';
        }

        async function refresh(){
          try {
            // åˆå§‹åŒ–æœˆä»½ï¼ˆå¦‚æœæœªè®¾ç½®ï¼‰
            if (!currentYm) {
              currentYm = getCurrentYm();
            }
            if (!financeYm) {
              financeYm = getCurrentYm();
            }
            
            // æ„å»ºæŸ¥è¯¢å‚æ•°
            const params = new URLSearchParams();
            if (me?.isAdmin) {
              if (currentYm) {
                params.set('ym', currentYm);
              }
              // ä¸ºè´¢åŠ¡çŠ¶å†µä¼ é€’æŸ¥è¯¢å‚æ•°
              if (financeYm) {
                params.set('financeYm', financeYm);
              }
              if (financeMode) {
                params.set('financeMode', financeMode);
              }
              // ä¸ºæœ€è¿‘åŠ¨æ€ä¼ é€’ç­›é€‰å‚æ•°
              if (activityDays) {
                params.set('activity_days', activityDays);
              }
              if (activityUserId) {
                params.set('activity_user_id', activityUserId);
              }
            }
            
            const url = `${apiBase}/dashboard${params.toString() ? '?' + params.toString() : ''}`;
            const res = await fetch(url, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/dashboard'); return; }
            const json = await res.json();
            console.log('=== DASHBOARD API RESPONSE ===');
            console.log('Full Response:', JSON.stringify(json, null, 2));
            console.log('employeeHours:', json.data?.admin?.employeeHours);
            console.log('==============================');
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const role = json.data?.role || (me?.isAdmin ? 'admin' : 'employee');
            if (role === 'admin') {
              const d = json.data?.admin || {};
              const empTasks = d.employeeTasks || [];
              const totalOverdue = empTasks.reduce((sum, e) => sum + (e.overdue || 0), 0);
              const notices = [];
              if (totalOverdue > 0) notices.push({ level:'warning', text:`å…¨å…¬å¸å…±æœ‰ ${totalOverdue} å€‹é€¾æœŸä»»å‹™`, link:'/internal/tasks' });
              showNotices(notices);
              renderAdminDashboard(d);
            } else {
              const d = json.data?.employee || {};
              const tasks = d.myTasks?.items || [];
              const urgent = tasks.filter(t => t.urgency==='urgent').length;
              const notices = urgent ? [{ level:'info', text:`ä»Šå¤©æœ‰ ${urgent} é …ä»»å‹™å³å°‡åˆ°æœŸ`, link:'/internal/tasks' }] : [];
              showNotices(notices);
              renderEmployeeDashboard(d);
            }
          } catch (_) {
            // fallback to placeholders
            if (me && me.isAdmin) renderAdminDashboard(null); else renderEmployeeDashboard(null);
          }
        }

        function startAutoRefresh(){
          clearInterval(refreshTimer); refreshTimer = setInterval(refresh, 5*60*1000);
          window.addEventListener('focus', refresh);
        }

        // åˆå§‹åŒ–
        todayEl.textContent = formatLocalDate(new Date());
        renderSkeleton();
        ensureUser().then(ok => { if (ok) { refresh(); startAutoRefresh(); } else { grid.innerHTML = '<div class="card" style="padding:16px;color:#c0392b;">è¼‰å…¥å¤±æ•—</div>'; } });
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


