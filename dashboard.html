<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="儀表板" />
    <title>儀表板｜總覽</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/dashboard-page.css" />
  </head>
  <body class="dashboard-page">
    <header class="dash-header">
      <div class="dash-top">
        <h1 class="dash-title">歡迎回來，<span id="userName">—</span></h1>
        <div id="today" class="dash-date">—</div>
      </div>
      <div id="permBar" class="info-bar" style="display:none;" role="alert">您沒有權限檢視此內容</div>
      <div id="noticeList" class="notice-list" aria-label="通知" style="display:none;"></div>
    </header>

    <main class="dash-content">
      <!-- 自適應網格：依角色顯示不同小部件 -->
      <section id="grid" class="dash-grid"></section>
    </main>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const userNameEl = document.getElementById('userName');
        const todayEl = document.getElementById('today');
        const grid = document.getElementById('grid');
        const permBar = document.getElementById('permBar');
        const noticeList = document.getElementById('noticeList');

        let me = null;
        let refreshTimer = null;

        function formatLocalDate(d){
          try { return new Intl.DateTimeFormat('zh-TW', { dateStyle:'full', timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone }).format(d); } catch(_) { return d.toISOString().slice(0,10); }
        }

        function showNotices(items){
          if (!Array.isArray(items) || items.length === 0) { noticeList.style.display='none'; noticeList.innerHTML = ''; return; }
          noticeList.innerHTML = '';
          items.forEach(n => {
            const div = document.createElement('div');
            const level = (n.level||'info');
            div.className = `notice ${level}`;
            div.innerHTML = `<span class="notice-label">${level==='warning'?'警告':'資訊'}</span><span class="notice-text">${n.text||''}</span>${n.link?` <a class="link" href="${n.link}">查看</a>`:''}`;
            noticeList.appendChild(div);
          });
          noticeList.style.display = 'block';
        }

        function statCard(title, value, meta){
          return `<div class="card stat"><div class="stat-label">${title}</div><div class="stat-value">${value}</div>${meta?`<div class="stat-meta muted">${meta}</div>`:''}</div>`;
        }

        function listCard(title, rowsHtml){
          return `<div class="card list"><div class="card-title">${title}</div><div class="list-body">${rowsHtml||'<div class=\"muted\">尚無資料</div>'}</div></div>`;
        }

        function fmtNum(n){ try { return Number(n||0).toLocaleString('zh-TW'); } catch(_) { return String(n||0); } }
        function fmtTwd(n){ return fmtNum(n); }
        function fmtPct(n){ const v = Number(n||0); return `${(Math.round(v*10)/10).toFixed(1)}%`; }

        function renderEmployeeDashboard(data){
          grid.innerHTML = '';
          const frag = document.createElement('div');
          const h = data?.myHours || { total:0, normal:0, overtime:0, completionRate:0 };
          const hoursMeta = `正常：${fmtNum(h.normal)}｜加班：${fmtNum(h.overtime)}｜達成率：${fmtPct(h.completionRate)}`;
          const tasks = Array.isArray(data?.myTasks?.items) ? data.myTasks.items : [];
          const taskRows = tasks.length ? tasks.map(t => {
            const cls = t.urgency==='overdue' ? 'danger' : (t.urgency==='urgent' ? 'warn' : '');
            const badge = t.urgency==='overdue' ? '<span class="badge danger">逾期</span>' : (t.urgency==='urgent' ? '<span class="badge warn">急</span>' : '');
            const due = t.dueDate || '—';
            return `<div class="task-row ${cls}"><span class="name">${t.name||''}</span><span class="muted" style="margin-left:8px;">到期：${due}</span> ${badge}</div>`;
          }).join('') : '<div class="muted">目前沒有待辦任務</div>';
          const lv = data?.myLeaves || { balances:{ annual:0, sick:0, compHours:0 }, recent:[] };
          const leavesHtml = `
              <div class="kv"><span>特休剩餘</span><b>${fmtNum(lv.balances?.annual||0)} 天</b></div>
              <div class="kv"><span>病假剩餘</span><b>${fmtNum(lv.balances?.sick||0)} 天</b></div>
              <div class="kv"><span>補休</span><b>${fmtNum(lv.balances?.compHours||0)} 小時</b></div>`;
          frag.innerHTML = [
            statCard('本月總工時', fmtNum(h.total), hoursMeta),
            listCard('我的任務（待辦/進行中）', taskRows),
            listCard('我的假期', leavesHtml),
            listCard('最近動態', (Array.isArray(data?.recentActivities) && data.recentActivities.length) ? data.recentActivities.map(a=>`<div class="activity">${a.text||''}</div>`).join('') : '<div class="muted">最近 7 天沒有活動</div>'),
          ].join('');
          grid.appendChild(frag);
        }

        function renderAdminDashboard(data){
          grid.innerHTML = '';
          const frag = document.createElement('div');
          
          // 各员工工时
          const empHours = Array.isArray(data?.employeeHours) ? data.employeeHours : [];
          const hoursHtml = empHours.length ? empHours.map(e => {
            const totalStr = fmtNum(e.total);
            const meta = e.total > 0 ? `正常：${fmtNum(e.normal)} ｜ 加班：${fmtNum(e.overtime)}` : '';
            return `<div class="emp-row"><span class="name">${e.name}</span><span class="hours"><b>${totalStr}</b> 小時</span>${meta ? `<div class="muted" style="font-size:12px;margin-top:4px;">${meta}</div>` : ''}</div>`;
          }).join('') : '<div class="muted">尚無工時記錄</div>';
          
          // 各员工任务状态
          const empTasks = Array.isArray(data?.employeeTasks) ? data.employeeTasks : [];
          const tasksHtml = empTasks.length ? empTasks.map(e => {
            const total = e.completed + e.inProgress + e.overdue + e.pending;
            if (total === 0) return `<div class="emp-task-row"><span class="name">${e.name}</span><span class="muted">無任務</span></div>`;
            const badges = [];
            if (e.overdue > 0) badges.push(`<span class="badge danger">逾期 ${e.overdue}</span>`);
            if (e.inProgress > 0) badges.push(`<span class="badge info">進行中 ${e.inProgress}</span>`);
            if (e.completed > 0) badges.push(`<span class="badge success">已完成 ${e.completed}</span>`);
            if (e.pending > 0) badges.push(`<span class="badge">待辦 ${e.pending}</span>`);
            return `<div class="emp-task-row"><span class="name">${e.name}</span><div class="badges">${badges.join(' ')}</div></div>`;
          }).join('') : '<div class="muted">尚無任務</div>';
          
          // 财务状况
          const fs = data?.financialStatus || { ar:0, paid:0, overdue:0, revenue:0, cost:0, profit:0, margin:0, collectionRate:0 };
          const finHtml = `
              <div class="kv"><span>應收</span><b class="num">${fmtTwd(fs.ar)}</b></div>
              <div class="kv"><span>收款</span><b class="num">${fmtTwd(fs.paid)}</b></div>
              <div class="kv"><span>逾期</span><b class="num">${fmtTwd(fs.overdue)}</b></div>
              <div class="kv"><span>收款率</span><b class="num">${fmtPct(fs.collectionRate)}</b></div>
              <div class="kv"><span>營收</span><b class="num">${fmtTwd(fs.revenue)}</b></div>
              <div class="kv"><span>成本</span><b class="num">${fmtTwd(fs.cost)}</b></div>
              <div class="kv"><span>毛利/率</span><b class="num">${fmtTwd(fs.profit)} / ${fmtPct(fs.margin)}</b></div>`;
          
          frag.innerHTML = [
            listCard('各員工本月工時', hoursHtml),
            listCard('各員工任務狀態', tasksHtml),
            listCard('財務狀況（本月）', finHtml),
          ].join('');
          grid.appendChild(frag);
        }

        async function ensureUser(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/dashboard'); return false; }
            const json = await res.json();
            if (!json || json.ok !== true) throw new Error();
            me = json.data || null;
            userNameEl.textContent = me?.name || me?.username || '—';
            return true;
          } catch (_) {
            permBar.textContent = '載入失敗，請稍後再試';
            permBar.style.display = 'block';
            return false;
          }
        }

        function renderSkeleton(){
          grid.innerHTML = '<div class="card" style="padding:16px;">載入中…</div>';
        }

        async function refresh(){
          try {
            const res = await fetch(`${apiBase}/dashboard`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/dashboard'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const role = json.data?.role || (me?.isAdmin ? 'admin' : 'employee');
            if (role === 'admin') {
              const d = json.data?.admin || {};
              const empTasks = d.employeeTasks || [];
              const totalOverdue = empTasks.reduce((sum, e) => sum + (e.overdue || 0), 0);
              const notices = [];
              if (totalOverdue > 0) notices.push({ level:'warning', text:`全公司共有 ${totalOverdue} 個逾期任務`, link:'/internal/tasks' });
              showNotices(notices);
              renderAdminDashboard(d);
            } else {
              const d = json.data?.employee || {};
              const tasks = d.myTasks?.items || [];
              const urgent = tasks.filter(t => t.urgency==='urgent').length;
              const notices = urgent ? [{ level:'info', text:`今天有 ${urgent} 項任務即將到期`, link:'/internal/tasks' }] : [];
              showNotices(notices);
              renderEmployeeDashboard(d);
            }
          } catch (_) {
            // fallback to placeholders
            if (me && me.isAdmin) renderAdminDashboard(null); else renderEmployeeDashboard(null);
          }
        }

        function startAutoRefresh(){
          clearInterval(refreshTimer); refreshTimer = setInterval(refresh, 5*60*1000);
          window.addEventListener('focus', refresh);
        }

        // 初始化
        todayEl.textContent = formatLocalDate(new Date());
        renderSkeleton();
        ensureUser().then(ok => { if (ok) { refresh(); startAutoRefresh(); } else { grid.innerHTML = '<div class="card" style="padding:16px;color:#c0392b;">載入失敗</div>'; } });
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


