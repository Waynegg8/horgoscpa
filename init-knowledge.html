<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>初始化知識庫</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }
        button:hover {
            background: #1d4ed8;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        #log {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .log-line {
            margin: 5px 0;
        }
        .success { color: #059669; }
        .error { color: #dc2626; }
        .info { color: #2563eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 初始化知識庫</h1>
        <p>此工具將創建以下內容：</p>
        <ul>
            <li>📊 記帳流程標準作業程序</li>
            <li>📋 營業稅申報標準作業程序</li>
            <li>👥 客戶資料建檔標準作業程序</li>
            <li>❓ 3個FAQ範例</li>
        </ul>
        <button id="startBtn" onclick="init()">開始初始化</button>
        <div id="log"></div>
    </div>

    <script>
        const API_BASE = '/internal/api/v1';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.textContent = message;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function createSOP(title, category, content, tags) {
            log(`📝 創建SOP: ${title}`, 'info');
            
            const response = await fetch(`${API_BASE}/sop`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ title, category, content, tags })
            });
            
            if (!response.ok) {
                const error = await response.text();
                throw new Error(error);
            }
            
            const result = await response.json();
            log(`✅ ${title} 創建成功 (ID: ${result.data.sop_id})`, 'success');
            return result.data;
        }

        async function createFAQ(question, category, answer, tags) {
            log(`❓ 創建FAQ: ${question}`, 'info');
            
            const response = await fetch(`${API_BASE}/faq`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ question, category, answer, tags })
            });
            
            if (!response.ok) {
                const error = await response.text();
                throw new Error(error);
            }
            
            const result = await response.json();
            log(`✅ ${question} 創建成功 (ID: ${result.data.faq_id})`, 'success');
            return result.data;
        }

        async function loadSOP(path) {
            const response = await fetch(path);
            return await response.text();
        }

        async function init() {
            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            document.getElementById('log').innerHTML = '';
            
            try {
                log('🚀 開始初始化知識庫...', 'info');
                log('', 'info');
                
                // 創建SOP
                log('📚 開始創建SOP...', 'info');
                
                const sop1 = await loadSOP('/templates/sop/記帳流程SOP.md');
                await createSOP('記帳流程標準作業程序', 'accounting', sop1, ['記帳', '作業流程', '月結']);
                
                const sop2 = await loadSOP('/templates/sop/營業稅申報SOP.md');
                await createSOP('營業稅申報標準作業程序', 'tax', sop2, ['稅務', '申報', '營業稅']);
                
                const sop3 = await loadSOP('/templates/sop/客戶資料建檔SOP.md');
                await createSOP('客戶資料建檔標準作業程序', 'internal', sop3, ['客戶管理', '建檔', '流程']);
                
                log('', 'info');
                log('❓ 開始創建FAQ...', 'info');
                
                // 創建FAQ
                await createFAQ(
                    '如何申請特別休假？',
                    'hr',
                    '<p>特別休假申請流程：</p><ol><li>填寫請假單</li><li>主管簽核</li><li>人事部門核准</li><li>系統登記</li></ol><p>注意事項：請假應提前3日申請，緊急情況請電話告知。</p>',
                    ['請假', '特休', '人事']
                );
                
                await createFAQ(
                    '營業稅申報期限是什麼時候？',
                    'tax',
                    '<p><strong>雙月制營業人：</strong>奇數月1-15日申報</p><p><strong>每月申報：</strong>次月15日前申報</p><p>建議提前準備資料，避免逾期受罰。</p>',
                    ['營業稅', '申報', '期限']
                );
                
                await createFAQ(
                    '如何查詢客戶的財務報表？',
                    'accounting',
                    '<p>查詢步驟：</p><ol><li>登入系統</li><li>進入「客戶管理」</li><li>選擇客戶</li><li>點選「財務報表」標籤</li><li>選擇年月查看</li></ol>',
                    ['客戶', '報表', '查詢']
                );
                
                log('', 'info');
                log('✅ 知識庫初始化完成！', 'success');
                log('📝 請前往 /internal/knowledge 查看結果', 'info');
                
            } catch (error) {
                log(`❌ 初始化失敗: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>

