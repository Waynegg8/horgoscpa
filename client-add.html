<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°å¢å®¢æˆ¶ - å…§éƒ¨ç³»çµ±</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
  <link rel="stylesheet" href="/assets/css/client-detail-page.css?v=30">
  
  <!-- âš¡ ç¦ç”¨ç·©å­˜ç³»çµ±ï¼ˆæ–°å¢å®¢æˆ¶å¾Œéœ€è¦æ›´æ–°åˆ—è¡¨ï¼‰ -->
  <script>
  // âŒ æ–°å¢å®¢æˆ¶é é¢ç¦ç”¨ç·©å­˜ç³»çµ±
  console.log('[Client-Add] â„¹ï¸ æ–°å¢å®¢æˆ¶é é¢å·²ç¦ç”¨æ‰€æœ‰ç·©å­˜åŠŸèƒ½');
  
  // ç¦ç”¨ DataCache é¢„åŠ è½½
  window.__DISABLE_DATA_CACHE__ = true;
  
  // ç¦ç”¨ fetch-interceptor æ‹¦æˆª
  window.__DISABLE_FETCH_INTERCEPTOR__ = true;
  
  // é¡µé¢åŠ è½½æ—¶æ¸…é™¤å®¢æˆ·åˆ—è¡¨ç¼“å­˜
  document.addEventListener('DOMContentLoaded', function() {
    const clientsCacheKeys = [
      'clients_page1', 'clients_page2', 'clients_page3', 
      'clients_page4', 'clients_page5', 'clients_all'
    ];
    
    clientsCacheKeys.forEach(key => {
      localStorage.removeItem(`cache_${key}`);
    });
    
    console.log('[Client-Add] âœ“ å·²æ¸…é™¤å®¢æˆ·åˆ—è¡¨ç¼“å­˜');
  });
  </script>
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container">
    <a href="/internal/clients" class="back-link" style="display:inline-block;margin-bottom:16px;">â† è¿”å›å®¢æˆ¶åˆ—è¡¨</a>

    <!-- å®¢æˆ¶åŸºæœ¬ä¿¡æ¯ - æ–°å¢è¡¨å–® -->
    <div class="content-card">
      <h2 class="card-title">æ–°å¢å®¢æˆ¶ - åŸºæœ¬ä¿¡æ¯</h2>
      <form id="clientForm" class="edit-form">
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputCompanyName">å…¬å¸åç¨±ï¼ˆå¿…å¡«ï¼‰</label>
            <input type="text" id="inputCompanyName" required />
            <span class="error-text" id="error_company_name"></span>
          </div>
          <div class="form-field">
            <label for="inputClientId">å®¢æˆ¶ç·¨è™Ÿï¼ˆå¿…å¡«ï¼Œ8ä½æ•¸å­—ï¼‰</label>
            <input type="text" id="inputClientId" maxlength="8" placeholder="8ä½æ•¸å­—" required />
            <span class="error-text" id="error_client_id"></span>
            <small class="form-help-text" style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
              <strong>å…¬å¸å®¢æˆ¶ï¼š</strong>ä½¿ç”¨çµ±ä¸€ç·¨è™Ÿ<br>
              <strong>å€‹äººå®¢æˆ¶ï¼š</strong>é»æ“Šä¸‹æ–¹æŒ‰éˆ•è‡ªå‹•ç”Ÿæˆï¼ˆæ™ºèƒ½é¿é–‹åˆæ³•çµ±ç·¨ï¼‰
            </small>
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputTaxId">çµ±ä¸€ç·¨è™Ÿï¼ˆé¸å¡«ï¼Œå€‹äººå®¢æˆ¶å¯ä¸å¡«ï¼‰</label>
            <input type="text" id="inputTaxId" maxlength="8" placeholder="8ä½æ•¸å­—" />
            <span class="error-text" id="error_tax_registration_number"></span>
            <small class="form-help-text" style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
              å¡«å¯«çµ±ç·¨æ™‚æœƒè‡ªå‹•åŒæ­¥åˆ°å®¢æˆ¶ç·¨è™Ÿ
            </small>
          </div>
          <div class="form-field">
            <label>&nbsp;</label>
            <button type="button" onclick="generatePersonalClientId()" class="btn-secondary" style="width: 100%; padding: 10px;">
              ğŸ”¢ ç”¢ç”Ÿå€‹äººå®¢æˆ¶ç·¨è™Ÿ
            </button>
            <small class="form-help-text" style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
              æ™ºèƒ½ç”Ÿæˆç·¨è™Ÿï¼ˆè‡ªå‹•é¿é–‹åˆæ³•çµ±ç·¨ï¼Œ100%ä¸è¡çªï¼‰
            </small>
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputContactPerson1">å…¬å¸è¯çµ¡äºº1</label>
            <input type="text" id="inputContactPerson1" placeholder="ä¾‹å¦‚ï¼šå¼µå…ˆç”Ÿ" />
          </div>
          <div class="form-field">
            <label for="inputContactPerson2">å…¬å¸è¯çµ¡äºº2</label>
            <input type="text" id="inputContactPerson2" placeholder="ä¾‹å¦‚ï¼šæå°å§" />
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputAssignee">è² è²¬äººå“¡</label>
            <select id="inputAssignee">
              <option value="">è¼‰å…¥ä¸­...</option>
            </select>
            <span class="error-text" id="error_assignee"></span>
          </div>
          <div class="form-field">
            <label for="inputPhone">è¯çµ¡é›»è©±</label>
            <input type="text" id="inputPhone" />
            <span class="error-text" id="error_phone"></span>
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputEmail">Email</label>
            <input type="email" id="inputEmail" />
            <span class="error-text" id="error_email"></span>
          </div>
          <div class="form-field">
            <label>æ¨™ç±¤ç®¡ç†</label>
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;" id="tagsDisplay">
              <span style="color: #9ca3af;">è¼‰å…¥ä¸­...</span>
            </div>
            <button type="button" class="btn btn-sm btn-secondary" onclick="showTagsModal()" style="margin-top: 8px;">+ ç®¡ç†æ¨™ç±¤</button>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputClientNotes">å®¢æˆ¶å‚™è¨»</label>
            <textarea id="inputClientNotes" rows="3"></textarea>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputPaymentNotes">æ”¶æ¬¾å‚™è¨»</label>
            <textarea id="inputPaymentNotes" rows="3"></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="cancelEdit()">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="saveClient()">æ–°å¢å®¢æˆ¶</button>
        </div>
      </form>
    </div>

    <!-- å®¢æˆ¶æœå‹™ -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">å®¢æˆ¶æœå‹™</h2>
        <button class="btn btn-primary" onclick="showAddServiceRow()">+ æ–°å¢æœå‹™</button>
      </div>
      <div class="table-wrapper">
        <table class="services-table" id="servicesTable">
          <thead>
            <tr>
              <th>æœå‹™åç¨±</th>
              <th>ç‹€æ…‹</th>
              <th>å¹´åº¦ç¸½é¡</th>
              <th>é–‹å§‹æ—¥æœŸ</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="servicesList">
            <tr>
              <td colspan="5" class="no-data">å°šæœªæ–°å¢æœå‹™</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- æ”¶è²»è¨­å®š -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">ğŸ’° æ”¶è²»è¨­å®š</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
          <select id="billing-service-filter" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
            <option value="">å…¨éƒ¨æœå‹™</option>
          </select>
          <button id="btn-billing-select-all" class="btn btn-secondary" onclick="toggleSelectAll(true)" title="é¸å–ç›®å‰æ¸…å–®å…¨éƒ¨">å…¨é¸</button>
          <button id="btn-billing-clear-all" class="btn btn-secondary" onclick="toggleSelectAll(false)" title="å–æ¶ˆç›®å‰æ¸…å–®å…¨éƒ¨">å…¨ä¸é¸</button>
          <button id="btn-batch-delete" class="btn btn-danger" onclick="batchDeleteBilling()" disabled>æ‰¹é‡åˆªé™¤</button>
          <button class="btn btn-primary" onclick="showAddBillingModal()">+ æ–°å¢æ”¶è²»</button>
        </div>
      </div>
      <div class="table-wrapper">
        <table class="billing-table" id="billingTable">
          <thead>
            <tr>
              <th style="width: 44px; text-align:center;"><input type="checkbox" id="billing-master" onchange="onMasterSelectChange(this)"></th>
              <th>æœå‹™åç¨±</th>
              <th style="width: 80px;">æœˆä»½</th>
              <th style="width: 120px;">é‡‘é¡</th>
              <th style="width: 100px;">ä»˜æ¬¾æœŸé™</th>
              <th>å‚™è¨»</th>
              <th style="width: 130px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="billingList">
            <tr>
              <td colspan="7" class="no-data">å°šæœªè¨­å®šæ”¶è²»</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <!-- æ–°å¢/ç·¨è¼¯æ”¶è²»å½ˆçª— -->
  <div id="billingModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 24px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;" id="billingModalTitle">æ–°å¢æ”¶è²»</h3>
        <button onclick="closeBillingModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      
      <!-- é€‰æ‹©æœåŠ¡ -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">é¸æ“‡æœå‹™ *</label>
        <select id="modal-service-select" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
          <option value="">è«‹é¸æ“‡æœå‹™</option>
        </select>
      </div>
      
      <!-- æ”¶è´¹ç±»å‹é€‰æ‹© -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">æ”¶è²»é¡å‹ *</label>
        <div style="display: flex; gap: 12px;">
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 10px 16px; border: 2px solid #d1d5db; border-radius: 6px; flex: 1;">
            <input type="radio" name="billing-type" value="monthly" checked onchange="switchBillingType('monthly')" style="cursor: pointer;" />
            <div>
              <div style="font-weight: 500; font-size: 14px;">æŒ‰æœˆæ”¶è²»</div>
              <div style="font-size: 12px; color: #6b7280;">æ¯æœˆå›ºå®šé‡‘é¡</div>
            </div>
          </label>
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 10px 16px; border: 2px solid #d1d5db; border-radius: 6px; flex: 1;">
            <input type="radio" name="billing-type" value="one-time" onchange="switchBillingType('one-time')" style="cursor: pointer;" />
            <div>
              <div style="font-weight: 500; font-size: 14px;">ä¸€æ¬¡æ€§æ”¶è²»</div>
              <div style="font-size: 12px; color: #6b7280;">è¨­ç«‹è²»ã€é¡§å•è²»ç­‰</div>
            </div>
          </label>
        </div>
      </div>
      
      <!-- æŒ‰æœˆæ”¶è´¹è¡¨å• -->
      <div id="monthly-billing-form" style="margin-bottom: 20px;">
        <h4 style="margin: 0 0 12px 0; font-size: 16px; color: #1f2937;">æ‰¹é‡è¨­å®šæ”¶è²»</h4>
        <p style="margin: 0 0 15px 0; font-size: 13px; color: #6b7280;">ä¸€æ¬¡è¨­å®šå¤šå€‹æœˆä»½çš„æ”¶è²»é‡‘é¡</p>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">æ¯æœˆé‡‘é¡ *</label>
            <input type="number" id="modal-batch-amount" placeholder="2000" step="0.01" min="0" required 
                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">ä»˜æ¬¾æœŸé™ï¼ˆå¤©ï¼‰</label>
            <input type="number" id="modal-batch-due" value="30" min="1" 
                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">æœˆä»½ç¯„åœ</label>
            <select id="modal-batch-range" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="all">å…¨å¹´ï¼ˆ1-12æœˆï¼‰</option>
              <option value="custom">è‡ªé¸æœˆä»½</option>
            </select>
          </div>
        </div>
        
        <div id="modal-month-checkboxes" style="display: none; margin-bottom: 15px;">
          <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:8px;">
            <label style="font-size: 13px; font-weight: 500;">é¸æ“‡æœˆä»½ï¼š</label>
            <div style="display:flex; gap:8px;">
              <button type="button" class="btn btn-sm btn-secondary" onclick="modalSelectAllMonths(true)">å…¨é¸</button>
              <button type="button" class="btn btn-sm btn-secondary" onclick="modalSelectAllMonths(false)">å…¨ä¸é¸</button>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="1" checked style="cursor: pointer;" /><span>1æœˆ</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="2" checked style="cursor: pointer;" /><span>2æœˆ</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="3" checked style="cursor: pointer;" /><span>3æœˆ</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="4" checked style="cursor: pointer;" /><span>4æœˆ</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="5" checked style="cursor: pointer;" /><span>5æœˆ</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="6" checked style="cursor: pointer;" /><span>6æœˆ</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="7" checked style="cursor: pointer;" /><span>7æœˆ</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="8" checked style="cursor: pointer;" /><span>8æœˆ</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="9" checked style="cursor: pointer;" /><span>9æœˆ</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="10" checked style="cursor: pointer;" /><span>10æœˆ</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="11" checked style="cursor: pointer;" /><span>11æœˆ</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="12" checked style="cursor: pointer;" /><span>12æœˆ</span></label>
          </div>
        </div>
      </div>
      
      <!-- ä¸€æ¬¡æ€§æ”¶è´¹è¡¨å• -->
      <div id="onetime-billing-form" style="display: none; margin-bottom: 20px;">
        <h4 style="margin: 0 0 12px 0; font-size: 16px; color: #1f2937;">è¨­å®šä¸€æ¬¡æ€§æ”¶è²»</h4>
        <p style="margin: 0 0 15px 0; font-size: 13px; color: #6b7280;">ä¾‹å¦‚ï¼šè¨­ç«‹è²»ã€é¡§å•è²»ã€å°ˆæ¡ˆè²»ç”¨ç­‰</p>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">é …ç›®åç¨± *</label>
            <input type="text" id="modal-onetime-description" placeholder="ä¾‹å¦‚ï¼šè¨­ç«‹è²»" maxlength="100"
                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
            <small style="display: block; margin-top: 4px; color: #6b7280; font-size: 12px;">ç”¨æ–¼è­˜åˆ¥é€™ç­†æ”¶è²»</small>
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">æ”¶è²»é‡‘é¡ *</label>
            <input type="number" id="modal-onetime-amount" placeholder="5000" step="0.01" min="0" required 
                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">æ”¶è²»æ—¥æœŸ *</label>
            <input type="date" id="modal-onetime-date" required 
                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">ä»˜æ¬¾æœŸé™ï¼ˆå¤©ï¼‰</label>
            <input type="number" id="modal-onetime-due" value="30" min="1" 
                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
        </div>
        
        <div>
          <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">å‚™è¨»</label>
          <textarea id="modal-onetime-notes" rows="3" placeholder="é¸å¡«ï¼šè£œå……èªªæ˜"
                    style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeBillingModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveBillingFromModal()">ç¢ºèªæ–°å¢</button>
      </div>
    </div>
  </div>

  <!-- æ¨™ç±¤ç®¡ç†å½ˆçª— -->
  <div id="tagsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">ç®¡ç†æ¨™ç±¤</h3>
        <button onclick="closeTagsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #6b7280;">å·²é¸æ¨™ç±¤</h4>
        <div id="selectedTagsList" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 40px; padding: 12px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
          <!-- å·²é€‰æ ‡ç­¾ -->
        </div>
      </div>
      
      <div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h4 style="margin: 0; font-size: 14px; color: #6b7280;">æ‰€æœ‰æ¨™ç±¤ï¼ˆé»æ“Šé¸æ“‡/å–æ¶ˆï¼‰</h4>
          <button class="btn btn-sm btn-secondary" onclick="toggleNewTagForm()" id="btnShowNewTag">+ æ–°å¢æ¨™ç±¤</button>
        </div>
        
        <!-- æ–°å¢æ¨™ç±¤è¡¨å–® -->
        <div id="newTagForm" style="display: none; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 16px; margin-bottom: 16px;">
          <div style="margin-bottom: 12px;">
            <label style="display: block; font-size: 14px; color: #374151; margin-bottom: 6px;">æ¨™ç±¤åç¨±</label>
            <input type="text" id="newTagName" placeholder="è«‹è¼¸å…¥æ¨™ç±¤åç¨±" maxlength="50" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" />
          </div>
          <div style="margin-bottom: 12px;">
            <label style="display: block; font-size: 14px; color: #374151; margin-bottom: 6px;">é¡è‰²</label>
            <select id="newTagColor" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
              <option value="#3b82f6" style="color: #3b82f6;">ğŸ”µ è—è‰²</option>
              <option value="#10b981" style="color: #10b981;">ğŸŸ¢ ç¶ è‰²</option>
              <option value="#f59e0b" style="color: #f59e0b;">ğŸŸ  æ©™è‰²</option>
              <option value="#ef4444" style="color: #ef4444;">ğŸ”´ ç´…è‰²</option>
              <option value="#8b5cf6" style="color: #8b5cf6;">ğŸŸ£ ç´«è‰²</option>
              <option value="#ec4899" style="color: #ec4899;">ğŸ©· ç²‰è‰²</option>
              <option value="#06b6d4" style="color: #06b6d4;">ğŸ”· é’è‰²</option>
              <option value="#84cc16" style="color: #84cc16;">ğŸŸ¢ é»ƒç¶ è‰²</option>
              <option value="#6b7280" style="color: #6b7280;">âš« ç°è‰²</option>
            </select>
          </div>
          <div style="display: flex; gap: 8px; justify-content: flex-end;">
            <button class="btn btn-sm btn-secondary" onclick="cancelNewTag()">å–æ¶ˆ</button>
            <button class="btn btn-sm btn-primary" onclick="saveNewTag()">å»ºç«‹</button>
          </div>
        </div>
        
        <div id="allTagsList" style="display: flex; flex-wrap: wrap; gap: 8px;">
          <span style="color: #9ca3af;">è¼‰å…¥ä¸­...</span>
        </div>
      </div>
      
      <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
        <button class="btn btn-secondary" onclick="closeTagsModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveTags()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <script src="/assets/js/components/bootstrap.js?v=3"></script>
  <script>
    let currentClientId = null; // æ–°å¢æ¨¡å¼ä¸‹ç‚º null
    let currentEditingServiceId = null;
    let currentBillingServiceId = null;
    let clientDetail = null;
    let allServices = [];
    let allServiceItems = [];
    let allTemplates = [];
    let allUsers = [];
    let allSOPs = [];
    let tempServices = []; // æš«å­˜çš„æœå‹™åˆ—è¡¨ï¼ˆå°šæœªä¿å­˜åˆ°æœå‹™å™¨ï¼‰
    
    // è¾…åŠ©å‡½æ•°ï¼šè·å–åˆ†ç±»æ–‡æœ¬
    function getCategoryText(category) {
      const categoryMap = {
        'accounting': 'è¨˜å¸³æµç¨‹',
        'tax': 'ç¨…å‹™æµç¨‹',
        'business': 'å·¥å•†ç™»è¨˜',
        'internal': 'å…§éƒ¨æµç¨‹'
      };
      return categoryMap[category] || category;
    }

    // ==================== å®¢æˆ¶ç·¨è™Ÿç®¡ç† ====================
    
    // è¨­ç½®çµ±ç·¨èˆ‡å®¢æˆ¶ç·¨è™Ÿçš„åŒæ­¥é‚è¼¯
    function setupClientIdSync() {
      const taxIdInput = document.getElementById('inputTaxId');
      const clientIdInput = document.getElementById('inputClientId');
      
      if (taxIdInput && clientIdInput) {
        // ç•¶çµ±ç·¨è¼¸å…¥æ™‚ï¼Œè‡ªå‹•åŒæ­¥åˆ°å®¢æˆ¶ç·¨è™Ÿ
        taxIdInput.addEventListener('input', function() {
          const taxId = this.value.trim();
          if (taxId.length > 0) {
            // å¦‚æœå¡«å¯«äº†çµ±ç·¨ï¼Œè‡ªå‹•åŒæ­¥åˆ°å®¢æˆ¶ç·¨è™Ÿ
            clientIdInput.value = taxId;
            // æ¸…é™¤å®¢æˆ¶ç·¨è™Ÿçš„éŒ¯èª¤æç¤º
            const errorEl = document.getElementById('error_client_id');
            if (errorEl) {
              errorEl.textContent = '';
              errorEl.style.display = 'none';
            }
          }
        });
        
        // ç•¶å®¢æˆ¶ç·¨è™Ÿæ”¹è®Šæ™‚ï¼Œæª¢æŸ¥æ˜¯å¦èˆ‡çµ±ç·¨ä¸€è‡´
        clientIdInput.addEventListener('blur', function() {
          const clientId = this.value.trim();
          const taxId = taxIdInput.value.trim();
          
          // å¦‚æœæœ‰çµ±ç·¨ä¸”å®¢æˆ¶ç·¨è™Ÿèˆ‡çµ±ç·¨ä¸ä¸€è‡´ï¼Œçµ¦å‡ºæç¤º
          if (taxId && clientId && clientId !== taxId && !clientId.startsWith('00')) {
            showFieldError('client_id', 'æç¤ºï¼šå…¬å¸å®¢æˆ¶å»ºè­°ä½¿ç”¨çµ±ä¸€ç·¨è™Ÿä½œç‚ºå®¢æˆ¶ç·¨è™Ÿ');
          }
        });
      }
    }
    
    // å°ç£çµ±ä¸€ç·¨è™Ÿé©—è­‰ï¼ˆ2023å¹´4æœˆ1æ—¥å¾Œæ–°è¦å‰‡ï¼‰
    function isValidTaxId(taxId) {
      if (!taxId || taxId.length !== 8 || !/^\d{8}$/.test(taxId)) {
        return false;
      }
      
      const weights = [1, 2, 1, 2, 1, 2, 4, 1];
      let sum = 0;
      
      for (let i = 0; i < 8; i++) {
        let product = parseInt(taxId[i]) * weights[i];
        // å¦‚æœä¹˜ç©æ˜¯å…©ä½æ•¸ï¼Œæ‹†åˆ†ç›¸åŠ 
        if (product >= 10) {
          product = Math.floor(product / 10) + (product % 10);
        }
        sum += product;
      }
      
      // èƒ½è¢«5æ•´é™¤å³ç‚ºæœ‰æ•ˆçµ±ç·¨
      return sum % 5 === 0;
    }
    
    // ç”¢ç”Ÿå€‹äººå®¢æˆ¶ç·¨è™Ÿï¼ˆæ–¹æ¡ˆCï¼šæ™ºèƒ½é¿é–‹åˆæ³•çµ±ç·¨ï¼‰
    async function generatePersonalClientId() {
      const clientIdInput = document.getElementById('inputClientId');
      if (!clientIdInput) return;
      
      try {
        // å˜—è©¦å¾APIç²å–ä¸‹ä¸€å€‹å¯ç”¨ç·¨è™Ÿ
        const res = await fetch('/internal/api/v1/clients/next-personal-id', {
          method: 'GET',
          credentials: 'include'
        });
        
        if (res.ok) {
          const json = await res.json();
          if (json.ok && json.data?.next_id) {
            clientIdInput.value = json.data.next_id;
            
            // æ¸…é™¤éŒ¯èª¤æç¤º
            const errorEl = document.getElementById('error_client_id');
            if (errorEl) {
              errorEl.textContent = '';
              errorEl.style.display = 'none';
            }
            
            alert('å·²ç”¢ç”Ÿå€‹äººå®¢æˆ¶ç·¨è™Ÿï¼š' + json.data.next_id + '\n\nâœ… ' + json.data.note);
            return;
          }
        }
      } catch (err) {
        console.warn('ç„¡æ³•å¾APIç²å–ç·¨è™Ÿï¼Œä½¿ç”¨æœ¬åœ°ç”Ÿæˆ', err);
      }
      
      // å¦‚æœAPIä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°ç”Ÿæˆï¼ˆæ™ºèƒ½é¿é–‹åˆæ³•çµ±ç·¨ï¼‰
      let personalId;
      let attempts = 0;
      
      // å˜—è©¦ç”Ÿæˆä¸ç¬¦åˆçµ±ç·¨é©—è­‰è¦å‰‡çš„ç·¨è™Ÿ
      do {
        const randomNum = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
        personalId = '00' + randomNum;
        attempts++;
      } while (isValidTaxId(personalId) && attempts < 10);
      
      // å¦‚æœ10æ¬¡å˜—è©¦éƒ½å¤±æ•—ï¼Œå¼·åˆ¶åŠ 1
      if (isValidTaxId(personalId)) {
        personalId = String(parseInt(personalId) + 1).padStart(8, '0');
      }
      
      clientIdInput.value = personalId;
      
      // æ¸…é™¤éŒ¯èª¤æç¤º
      const errorEl = document.getElementById('error_client_id');
      if (errorEl) {
        errorEl.textContent = '';
        errorEl.style.display = 'none';
      }
      
      const isSafe = !isValidTaxId(personalId);
      alert(
        'å·²ç”¢ç”Ÿå€‹äººå®¢æˆ¶ç·¨è™Ÿï¼š' + personalId + '\n\n' +
        (isSafe ? 'âœ… æ­¤ç·¨è™Ÿä¸ç¬¦åˆçµ±ç·¨é©—è­‰è¦å‰‡ï¼Œ100%ä¸æœƒèˆ‡çœŸå¯¦çµ±ç·¨è¡çªã€‚' : 'âš ï¸ è«‹å†æ¬¡é»æ“Šç”ŸæˆæŒ‰éˆ•ä»¥ç²å¾—æ›´å®‰å…¨çš„ç·¨è™Ÿã€‚') +
        '\nè«‹ç¢ºèªæ­¤ç·¨è™Ÿå°šæœªè¢«ä½¿ç”¨ã€‚'
      );
    }
    
    // é é¢åˆå§‹åŒ–
    async function init() {
      // æ–°å¢æ¨¡å¼ï¼šè¼‰å…¥åŸºç¤æ•¸æ“šï¼Œä½†ä¸è¼‰å…¥å®¢æˆ¶è©³æƒ…
      await Promise.all([
        loadServices(),
        loadServiceItems(),
        loadTemplates(),
        loadAllUsers(),
        loadAllSOPs()
      ]);
      
      // è¼‰å…¥å“¡å·¥åˆ—è¡¨åˆ°è¡¨å–®
      await loadEmployees();
      
      // è¼‰å…¥æ¨™ç±¤åˆ—è¡¨
      await loadAllTags();
      
      // åˆå§‹åŒ–ç©ºçš„æœå‹™åˆ—è¡¨
      renderServices(tempServices);
      
      // åˆå§‹åŒ–æ¨™ç±¤é¡¯ç¤º
      renderTagsDisplay();
      
      // è¨­ç½®çµ±ç·¨è¼¸å…¥æ¡†çš„è‡ªå‹•åŒæ­¥é‚è¼¯
      setupClientIdSync();
      
      // ç»‘å®šæ”¶è´¹æœåŠ¡ç­›é€‰äº‹ä»¶
      const billingServiceFilter = document.getElementById('billing-service-filter');
      if (billingServiceFilter) {
        billingServiceFilter.addEventListener('change', function() {
          renderBillingList(this.value);
        });
      }
      
      // åˆå§‹åŒ–æ”¶è²»åˆ—è¡¨
      refreshBillingFilterOptions();
      renderBillingList('');
    }

    // âŒ æ–°å¢æ¨¡å¼ä¸‹ä¸éœ€è¦è¼‰å…¥å®¢æˆ¶è©³æƒ…
    // è¼‰å…¥å®¢æˆ¶è©³æƒ…å‡½æ•¸å·²ç§»é™¤ï¼Œæ”¹ç‚ºä½¿ç”¨ç©ºç™½è¡¨å–®å’Œ tempServices
    
    // è¼‰å…¥å“¡å·¥åˆ—è¡¨
    async function loadEmployees() {
      try {
        const res = await fetch('/internal/api/v1/users');
        const json = await res.json();
        
        if (json.ok && json.data) {
          const select = document.getElementById('inputAssignee');
          select.innerHTML = '<option value="">è«‹é¸æ“‡è² è²¬äººå“¡</option>' +
            json.data.map(u => 
              `<option value="${u.user_id}">${u.name || u.username}</option>`
            ).join('');
        }
      } catch (err) {
        console.error('è¼‰å…¥å“¡å·¥åˆ—è¡¨å¤±æ•—:', err);
      }
    }

    // æ¸²æŸ“æœå‹™åˆ—è¡¨ï¼ˆæ–°å¢æ¨¡å¼ï¼šä½¿ç”¨ tempServicesï¼‰
    function renderServices(services) {
      const tbody = document.getElementById('servicesList');
      
      const serviceOptions = allServices && allServices.length > 0
        ? allServices.filter(s => s.is_active).map(s => 
            `<option value="${s.service_id}">${s.service_name}</option>`
          ).join('')
        : '';
      
      const addServiceRowHtml = `
        <tr id="add-service-row" style="display: none;">
          <td>
            <select id="new-service-id" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="">è«‹é¸æ“‡æœå‹™</option>
              ${serviceOptions}
            </select>
          </td>
          <td>
            <select id="new-service-status" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="active">ä½¿ç”¨ä¸­</option>
              <option value="suspended">æš«åœ</option>
              <option value="expired">å·²åˆ°æœŸ</option>
              <option value="cancelled">å·²å–æ¶ˆ</option>
            </select>
          </td>
          <td>-</td>
          <td>
            <input type="date" id="new-service-start-date" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </td>
          <td>
            <button class="table-btn-link" onclick="saveNewService()">å„²å­˜</button>
            <button class="table-btn-link danger" onclick="cancelAddService()">å–æ¶ˆ</button>
          </td>
        </tr>
      `;
      
      if (!services || services.length === 0) {
        tbody.innerHTML = addServiceRowHtml + '<tr><td colspan="5" class="no-data">å°šæœªæ–°å¢æœå‹™</td></tr>';
        return;
      }

      const serviceRows = services.map((svc, index) => {
        const statusClass = {
          'active': 'status-active',
          'suspended': 'status-suspended',
          'expired': 'status-expired',
          'cancelled': 'status-cancelled'
        }[svc.status] || '';
        
        const statusText = {
          'active': 'ä½¿ç”¨ä¸­',
          'suspended': 'æš«åœ',
          'expired': 'å·²åˆ°æœŸ',
          'cancelled': 'å·²å–æ¶ˆ'
        }[svc.status] || svc.status;
        
        // å¾ allServices æŸ¥æ‰¾æœå‹™åç¨±
        const service = allServices.find(s => s.service_id == svc.service_id);
        const serviceName = service ? service.service_name : '-';
        
        // è¨ˆç®—å¹´åº¦ç¸½é¡ï¼ˆå¾ billingsï¼‰
        const billings = svc.billings || [];
        const yearTotal = billings.reduce((sum, b) => sum + (parseFloat(b.billing_amount) || 0), 0);

        return `
          <tr class="service-main-row">
            <td><strong>${serviceName}</strong></td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td class="amount">$${yearTotal.toLocaleString('zh-TW')}</td>
            <td>${svc.start_date || '-'}</td>
            <td class="actions-cell">
              <button type="button" class="table-btn table-btn-primary" onclick="showComponentsSection(${index})">é…ç½®æœå‹™å…§å®¹</button>
              <button type="button" class="table-btn table-btn-secondary" onclick="editService(${index})">ç·¨è¼¯</button>
              <button type="button" class="table-btn table-btn-danger" onclick="deleteService(${index}, '${serviceName}')">åˆªé™¤</button>
            </td>
          </tr>
          <tr class="component-detail-row" id="components-row-${index}" style="display: none;">
            <td colspan="5" class="component-detail-cell">
              <div class="components-content" id="components-content-${index}"></div>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = addServiceRowHtml + serviceRows;
    }

    // ==================== æ”¶è²»é…ç½®ç®¡ç†ï¼ˆæ–°å¢æ¨¡å¼ï¼šä½¿ç”¨ tempServicesï¼‰====================
    
    window.selectedBillingIds = new Set();
    window.currentBillingFilter = '';
    window.__billingFilteredKeys = [];
    
    // æ›´æ–°æ”¶è²»æœå‹™ç¯©é¸é¸é …
    function refreshBillingFilterOptions() {
      const serviceFilter = document.getElementById('billing-service-filter');
      if (!serviceFilter) return;
      
      const current = serviceFilter.value;
      serviceFilter.innerHTML = '<option value="">å…¨éƒ¨æœå‹™</option>' +
        tempServices.map((svc, idx) => {
          const service = allServices.find(s => s.service_id == svc.service_id);
          const name = service ? service.service_name : `æœå‹™${idx+1}`;
          return `<option value="${idx}" ${String(current)===String(idx)?'selected':''}>${name}</option>`;
        }).join('');
    }
    
    // æ§‹å»ºæ‰€æœ‰æ”¶è²»æ•¸æ“šï¼ˆå¾ tempServicesï¼‰
    function buildAllBillingData() {
      const items = [];
      tempServices.forEach((svc, sIdx) => {
        const service = allServices.find(s => s.service_id == svc.service_id);
        const svcName = service ? service.service_name : `æœå‹™${sIdx+1}`;
        
        (svc.billings || []).forEach((b, bIdx) => {
          items.push({
            key: `${sIdx}:${bIdx}`,
            service_index: sIdx,
            billing_index: bIdx,
            service_name: svcName,
            billing_type: b.billing_type || (b.billing_month===0?'one-time':'monthly'),
            billing_month: b.billing_month || 0,
            billing_date: b.billing_date || null,
            description: b.description || '',
            billing_amount: parseFloat(b.billing_amount)||0,
            payment_due_days: parseInt(b.payment_due_days)||30,
            notes: b.notes || ''
          });
        });
      });
      return items;
    }
    
    // æ¸²æŸ“æ”¶è²»åˆ—è¡¨ï¼ˆæ–°å¢æ¨¡å¼ï¼‰
    function renderBillingList(filterServiceId = '') {
      const billingList = document.getElementById('billingList');
      if (!billingList) return;
      
      window.currentBillingFilter = filterServiceId || '';
      
      const items = buildAllBillingData().filter(it => {
        if (!window.currentBillingFilter) return true;
        return String(it.service_index) === String(window.currentBillingFilter);
      });
      
      window.__billingFilteredKeys = items.map(i => i.key);
      
      if (items.length === 0) {
        billingList.innerHTML = '<tr><td colspan="7" class="no-data">å°šæœªè¨­å®šæ”¶è²»</td></tr>';
        updateBatchDeleteButton();
        const master = document.getElementById('billing-master');
        if (master) master.checked = false;
        return;
      }
      
      const rows = items.map(it => {
        const isOT = it.billing_type === 'one-time' || it.billing_month === 0;
        const d = it.billing_date ? new Date(it.billing_date) : null;
        const monthText = isOT ? (d ? `${d.getMonth()+1}æœˆ` : `${it.billing_month||''}æœˆ`) : `${it.billing_month}æœˆ`;
        
        let notesDisplay = '-';
        if (isOT) {
          const y = d ? d.getFullYear() : '';
          const m2 = d ? String(d.getMonth()+1).padStart(2, '0') : '';
          const parts = [`[ä¸€æ¬¡æ€§] ${y}${y?'/':''}${m2}`.trim()];
          if (it.description) parts.push(it.description);
          if (it.notes) parts.push(it.notes);
          notesDisplay = parts.filter(Boolean).join(' - ');
        } else {
          notesDisplay = it.notes || '-';
        }
        
        const checked = window.selectedBillingIds.has(it.key) ? 'checked' : '';
        const deleteLabel = isOT ? `ä¸€æ¬¡æ€§æ”¶è²»ï¼ˆ${it.description || ''}ï¼‰` : `${it.billing_month}æœˆ`;
        
        return `
          <tr data-schedule-id="${it.key}">
            <td style="text-align:center;"><input type="checkbox" ${checked} onchange="toggleBillingSelect('${it.key}', this.checked)"></td>
            <td><strong>${it.service_name}</strong></td>
            <td>${monthText}</td>
            <td class="amount">$${it.billing_amount.toLocaleString('zh-TW')}</td>
            <td>${it.payment_due_days}å¤©</td>
            <td>${notesDisplay}</td>
            <td>
              <button class="table-btn-link" onclick="editBillingRow('${it.key}')">ç·¨è¼¯</button>
              <button class="table-btn-link danger" onclick="deleteBillingRow('${it.key}', '${it.service_name}', '${deleteLabel}')">åˆªé™¤</button>
            </td>
          </tr>
        `;
      }).join('');
      
      billingList.innerHTML = rows;
      
      // æ›´æ–°å…¨é¸æ¡†ç‹€æ…‹
      const allSelected = window.__billingFilteredKeys.length > 0 && window.__billingFilteredKeys.every(k => window.selectedBillingIds.has(k));
      const master = document.getElementById('billing-master');
      if (master) master.checked = allSelected;
      updateBatchDeleteButton();
    }
    
    // åˆ‡æ¢æ”¶è´¹ç±»å‹
    function switchBillingType(type) {
      const monthlyForm = document.getElementById('monthly-billing-form');
      const onetimeForm = document.getElementById('onetime-billing-form');
      
      if (type === 'monthly') {
        monthlyForm.style.display = 'block';
        onetimeForm.style.display = 'none';
      } else if (type === 'one-time') {
        monthlyForm.style.display = 'none';
        onetimeForm.style.display = 'block';
      }
    }
    
    // æ˜¾ç¤ºæ–°å¢æ”¶è´¹å¼¹çª—
    function showAddBillingModal() {
      const modal = document.getElementById('billingModal');
      const modalTitle = document.getElementById('billingModalTitle');
      const serviceSelect = document.getElementById('modal-service-select');
      const rangeSelect = document.getElementById('modal-batch-range');
      const monthCheckboxes = document.getElementById('modal-month-checkboxes');
      
      modalTitle.textContent = 'æ–°å¢æ”¶è²»';
      
      // é‡ç½®æ”¶è´¹ç±»å‹ä¸ºæŒ‰æœˆ
      document.querySelector('input[name="billing-type"][value="monthly"]').checked = true;
      switchBillingType('monthly');
      
      // è¼‰å…¥æœå‹™é¸é …ï¼ˆå¾ tempServicesï¼‰
      serviceSelect.innerHTML = '<option value="">è«‹é¸æ“‡æœå‹™</option>' +
        tempServices.map((svc, idx) => {
          const service = allServices.find(s => s.service_id == svc.service_id);
          const name = service ? service.service_name : `æœå‹™${idx+1}`;
          return `<option value="${idx}">${name}</option>`;
        }).join('');
      
      // è¨­ç½®ä»Šå¤©æ—¥æœŸç‚ºé è¨­å€¼
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('modal-onetime-date').value = today;
      
      // ç¶å®šæœˆä»½ç¯„åœåˆ‡æ›äº‹ä»¶
      rangeSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
          monthCheckboxes.style.display = 'block';
        } else {
          monthCheckboxes.style.display = 'none';
        }
      });
      
      modal.style.display = 'flex';
    }
    
    // å…³é—­æ”¶è´¹å¼¹çª—
    function closeBillingModal() {
      const modal = document.getElementById('billingModal');
      modal.style.display = 'none';
      
      // é‡ç½®æ”¶è´¹ç±»å‹
      document.querySelector('input[name="billing-type"][value="monthly"]').checked = true;
      switchBillingType('monthly');
      
      // é‡ç½®æŒ‰æœˆæ”¶è´¹è¡¨å•
      document.getElementById('modal-service-select').value = '';
      document.getElementById('modal-batch-amount').value = '';
      document.getElementById('modal-batch-due').value = '30';
      document.getElementById('modal-batch-range').value = 'all';
      document.getElementById('modal-month-checkboxes').style.display = 'none';
      document.querySelectorAll('.modal-month-checkbox').forEach(cb => cb.checked = true);
      
      // é‡ç½®ä¸€æ¬¡æ€§æ”¶è´¹è¡¨å•
      document.getElementById('modal-onetime-description').value = '';
      document.getElementById('modal-onetime-amount').value = '';
      document.getElementById('modal-onetime-date').value = '';
      document.getElementById('modal-onetime-due').value = '30';
      document.getElementById('modal-onetime-notes').value = '';
    }
    
    // å¾å¼¹çª—ä¿å­˜æ”¶è²»ï¼ˆæ–°å¢æ¨¡å¼ï¼‰
    function saveBillingFromModal() {
      const serviceIdxStr = document.getElementById('modal-service-select').value;
      const billingType = document.querySelector('input[name="billing-type"]:checked').value;
      
      if (!serviceIdxStr) {
        alert('è«‹é¸æ“‡æœå‹™');
        return;
      }
      
      const idx = parseInt(serviceIdxStr, 10);
      const svc = tempServices[idx];
      if (!svc) {
        alert('æœå‹™ä¸å­˜åœ¨');
        return;
      }
      
      svc.billings = svc.billings || [];
      
      if (billingType === 'monthly') {
        // æŒ‰æœˆæ”¶è²»
        const amount = parseFloat(document.getElementById('modal-batch-amount').value);
        const due = parseInt(document.getElementById('modal-batch-due').value);
        const range = document.getElementById('modal-batch-range').value;
        
        if (!amount || amount <= 0) {
          alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡');
          return;
        }
        
        let months = [];
        if (range === 'all') {
          months = Array.from({length: 12}, (_, i) => i + 1);
        } else {
          months = Array.from(document.querySelectorAll('.modal-month-checkbox:checked')).map(cb => parseInt(cb.value, 10));
        }
        
        if (months.length === 0) {
          alert('è«‹é¸æ“‡æœˆä»½');
          return;
        }
        
        months.forEach(m => {
          svc.billings.push({
            billing_type: 'monthly',
            billing_month: m,
            billing_amount: amount,
            payment_due_days: due || 30,
            notes: null
          });
        });
      } else if (billingType === 'one-time') {
        // ä¸€æ¬¡æ€§æ”¶è²»
        const desc = document.getElementById('modal-onetime-description').value.trim();
        const date = document.getElementById('modal-onetime-date').value;
        const amount = parseFloat(document.getElementById('modal-onetime-amount').value);
        const due = parseInt(document.getElementById('modal-onetime-due').value);
        const notes = document.getElementById('modal-onetime-notes').value.trim();
        
        if (!desc || !date || !amount) {
          alert('è«‹å¡«å¯«å®Œæ•´ä¸€æ¬¡æ€§æ”¶è²»è³‡æ–™');
          return;
        }
        
        svc.billings.push({
          billing_type: 'one-time',
          billing_date: date,
          description: desc,
          billing_amount: amount,
          payment_due_days: due || 30,
          notes: notes || null,
          billing_month: 0
        });
      }
      
      closeBillingModal();
      renderBillingList(window.currentBillingFilter || '');
      renderServices(tempServices);
    }

    // ===== æ‰¹é‡åˆªé™¤ =====
    function toggleBillingSelect(id, checked) {
      window.selectedBillingIds = window.selectedBillingIds || new Set();
      if (checked) window.selectedBillingIds.add(id); else window.selectedBillingIds.delete(id);
      updateBatchDeleteButton();
    }

    function onMasterSelectChange(el) {
      toggleSelectAll(el.checked);
    }

    function toggleSelectAll(selectAll) {
      const keys = window.__billingFilteredKeys || [];
      keys.forEach(k => { if (selectAll) window.selectedBillingIds.add(k); else window.selectedBillingIds.delete(k); });
      keys.forEach(k => {
        const row = document.querySelector(`tr[data-schedule-id="${k}"] input[type=checkbox]`);
        if (row) row.checked = !!selectAll;
      });
      const master = document.getElementById('billing-master');
      if (master) master.checked = !!selectAll && keys.length > 0;
      updateBatchDeleteButton();
    }

    function updateBatchDeleteButton() {
      const btn = document.getElementById('btn-batch-delete');
      if (!btn) return;
      btn.disabled = !(window.selectedBillingIds && window.selectedBillingIds.size > 0);
      btn.textContent = window.selectedBillingIds.size > 0 ? `æ‰¹é‡åˆªé™¤ï¼ˆ${window.selectedBillingIds.size}ï¼‰` : 'æ‰¹é‡åˆªé™¤';
    }

    function batchDeleteBilling() {
      if (!window.selectedBillingIds || window.selectedBillingIds.size === 0) return;
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤é¸å–çš„ ${window.selectedBillingIds.size} ç­†æ”¶è²»å—ï¼Ÿ`)) return;
      
      const keys = Array.from(window.selectedBillingIds);
      keys.forEach(k => {
        const [sIdx, bIdx] = k.split(':').map(n => parseInt(n, 10));
        if (!isNaN(sIdx) && !isNaN(bIdx) && tempServices[sIdx] && tempServices[sIdx].billings) {
          tempServices[sIdx].billings.splice(bIdx, 1);
        }
      });
      
      window.selectedBillingIds.clear();
      refreshBillingFilterOptions();
      renderBillingList(window.currentBillingFilter || '');
      renderServices(tempServices);
    }

    // ===== æœˆä»½å¤šé¸ï¼šå…¨é¸/å…¨ä¸é¸ =====
    function modalSelectAllMonths(selectAll) {
      document.querySelectorAll('.modal-month-checkbox').forEach(cb => cb.checked = !!selectAll);
    }
    
    // ä¿å­˜æŒ‰æœˆæ”¶è´¹ï¼ˆæ”¯æ´å…¨å¹´æ‰¹é‡èˆ‡é‡è¤‡æœˆä»½è·³éï¼‰
    async function saveMonthlyBilling(serviceId) {
      const amount = parseFloat(document.getElementById('modal-batch-amount').value);
      const dueDays = parseInt(document.getElementById('modal-batch-due').value);
      const range = document.getElementById('modal-batch-range').value;
      
      if (!amount || amount <= 0) {
        throw new Error('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
      }
      
      // ç¡®å®šè¦æ–°å¢çš„æœˆä»½
      let months = [];
      if (range === 'all') {
        months = Array.from({length: 12}, (_, i) => i + 1);
      } else {
        const checkboxes = document.querySelectorAll('.modal-month-checkbox:checked');
        months = Array.from(checkboxes).map(cb => parseInt(cb.value));
      }
      
      if (months.length === 0) {
        throw new Error('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æœˆä»½');
      }
      
      // æ‰¹é‡åˆ›å»ºæ”¶è´¹ï¼ˆçµ±è¨ˆæˆåŠŸ/è·³é/å¤±æ•—ï¼‰
      let okCount = 0, skipCount = 0, failCount = 0;
      const errors = [];
      for (const month of months) {
        try {
          const res = await fetch('/internal/api/v1/billing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              client_service_id: parseInt(serviceId),
              billing_type: 'monthly',
              billing_month: month,
              billing_amount: amount,
              payment_due_days: dueDays
            })
          });
          const json = await res.json().catch(() => ({ ok:false, message:'ç¶²è·¯éŒ¯èª¤' }));
          if (res.ok && json.ok) {
            okCount++;
          } else if (json.code === 'DUPLICATE') {
            skipCount++;
          } else {
            failCount++;
            errors.push(`${month}æœˆ: ${json.message || 'æœªçŸ¥éŒ¯èª¤'}`);
          }
        } catch (e) {
          failCount++;
          errors.push(`${month}æœˆ: ${e.message || e}`);
        }
      }
      alert(`æ‰¹é‡æ–°å¢å®Œæˆï¼šæˆåŠŸ ${okCount} å€‹ï¼Œè·³éï¼ˆå·²å­˜åœ¨ï¼‰${skipCount} å€‹ï¼Œå¤±æ•— ${failCount} å€‹${errors.length ? '\n\nè©³æƒ…ï¼š\n' + errors.join('\n') : ''}`);
    }
    
    // ä¿å­˜ä¸€æ¬¡æ€§æ”¶è´¹
    async function saveOneTimeBilling(serviceId) {
      const description = document.getElementById('modal-onetime-description').value.trim();
      const amount = parseFloat(document.getElementById('modal-onetime-amount').value);
      const date = document.getElementById('modal-onetime-date').value;
      const dueDays = parseInt(document.getElementById('modal-onetime-due').value);
      const notes = document.getElementById('modal-onetime-notes').value.trim();
      
      if (!description) {
        throw new Error('è«‹è¼¸å…¥é …ç›®åç¨±');
      }
      
      if (!amount || amount <= 0) {
        throw new Error('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
      }
      
      if (!date) {
        throw new Error('è«‹é¸æ“‡æ”¶è²»æ—¥æœŸ');
      }
      
      const res = await fetch('/internal/api/v1/billing', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          client_service_id: parseInt(serviceId),
          billing_type: 'one-time',
          billing_month: 0,  // ä¸€æ¬¡æ€§æ”¶è´¹ä¸ä½¿ç”¨æœˆä»½
          billing_amount: amount,
          payment_due_days: dueDays,
          billing_date: date,
          description: description,
          notes: notes || null
        })
      });
      
      const json = await res.json();
      
      if (!json.ok) {
        throw new Error(json.message || 'æ–°å¢ä¸€æ¬¡æ€§æ”¶è²»å¤±æ•—');
      }
      
      alert('å·²æˆåŠŸæ–°å¢ä¸€æ¬¡æ€§æ”¶è²»');
    }
    
    // ç¼–è¾‘æ”¶è´¹ï¼ˆè¡Œå…§ç·¨è¼¯ï¼‰
    function editBillingRow(key) {
      const row = document.querySelector(`tr[data-schedule-id="${key}"]`);
      if (!row) return;
      
      const [sIdx, bIdx] = key.split(':').map(n => parseInt(n, 10));
      const b = (tempServices[sIdx] || {}).billings?.[bIdx];
      if (!b) return;
      
      const isOT = b.billing_type === 'one-time' || b.billing_month === 0;
      const d = b.billing_date ? new Date(b.billing_date) : null;
      const monthText = isOT ? (d ? `${d.getMonth()+1}æœˆ` : `${b.billing_month||''}æœˆ`) : `${b.billing_month}æœˆ`;
      const notesStr = isOT ? `${(b.description||'')}${b.notes?(' - '+b.notes):''}` : (b.notes||'');
      const service = allServices.find(s => s.service_id == (tempServices[sIdx] || {}).service_id);
      const serviceName = service ? service.service_name : '';
      
      row.innerHTML = `
        <td style="text-align:center;"><input type="checkbox" disabled></td>
        <td><strong>${serviceName}</strong></td>
        <td>${monthText}</td>
        <td><input type="number" id="eb-amount-${sIdx}-${bIdx}" value="${parseFloat(b.billing_amount)||0}" step="0.01" min="0" style="width:120px"></td>
        <td><input type="number" id="eb-due-${sIdx}-${bIdx}" value="${parseInt(b.payment_due_days)||30}" min="1" style="width:80px"></td>
        <td><input type="text" id="eb-notes-${sIdx}-${bIdx}" value="${notesStr}" style="width:100%"></td>
        <td>
          <button class="table-btn-link" onclick="saveEditedBillingRow('${key}', ${isOT?1:0})">å„²å­˜</button>
          <button class="table-btn-link" onclick="renderBillingList(window.currentBillingFilter||'')">å–æ¶ˆ</button>
        </td>`;
    }

    function saveEditedBillingRow(key, isOT) {
      const [sIdx, bIdx] = key.split(':').map(n => parseInt(n, 10));
      const svc = tempServices[sIdx];
      if (!svc || !svc.billings || !svc.billings[bIdx]) return;
      
      const b = svc.billings[bIdx];
      const amount = parseFloat(document.getElementById(`eb-amount-${sIdx}-${bIdx}`).value);
      const due = parseInt(document.getElementById(`eb-due-${sIdx}-${bIdx}`).value);
      const notesStr = (document.getElementById(`eb-notes-${sIdx}-${bIdx}`).value || '').trim();
      
      if (!amount || amount <= 0) {
        alert('é‡‘é¡ç„¡æ•ˆ');
        return;
      }
      
      b.billing_amount = amount;
      b.payment_due_days = due || 30;
      if (b.billing_type === 'one-time' || isOT) {
        b.notes = notesStr || null;
      } else {
        b.notes = notesStr || null;
      }
      
      renderBillingList(window.currentBillingFilter || '');
      renderServices(tempServices);
    }
    
    // åˆªé™¤æ”¶è²»ï¼ˆæ–°å¢æ¨¡å¼ï¼‰
    function deleteBillingRow(key, serviceName, deleteLabel) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${serviceName}ã€çš„${deleteLabel}æ”¶è²»å—ï¼Ÿ`)) return;
      
      const [sIdx, bIdx] = key.split(':').map(n => parseInt(n, 10));
      if (!isNaN(sIdx) && !isNaN(bIdx) && tempServices[sIdx] && tempServices[sIdx].billings) {
        tempServices[sIdx].billings.splice(bIdx, 1);
      }
      
      window.selectedBillingIds.delete(key);
      renderBillingList(window.currentBillingFilter || '');
      renderServices(tempServices);
    }
    
    // æ—§ä»£ç ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
    async function loadBillingInline(index, clientServiceId) {
      const container = document.getElementById(`billing-content-${index}`);
      
      try {
        const res = await fetch(`/internal/api/v1/billing/service/${clientServiceId}`);
        const json = await res.json();
        
        if (!json.ok) {
          container.innerHTML = '<p class="error-text">è¼‰å…¥å¤±æ•—</p>';
          return;
        }

        const schedules = json.data.schedules || [];
        
        // æ’åºbyæœˆä»½
        schedules.sort((a, b) => a.billing_month - b.billing_month);

        container.innerHTML = `
          <div style="padding: 20px; background: #f9fafb; border-radius: 8px;">
            <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px;">
              <button class="table-btn table-btn-primary" onclick="showBatchBillingForm(${clientServiceId})">+ æ‰¹é‡æ–°å¢æ”¶è²»</button>
            </div>
            
            <!-- æ‰¹é‡æ–°å¢è¡¨å–® -->
            <div id="batch-billing-form-${clientServiceId}" style="display: none; background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #3b82f6;">
              <h5 style="margin-top: 0;">ğŸ’° æ‰¹é‡è¨­å®šæ”¶è²»</h5>
              <p style="margin: 0 0 15px 0; font-size: 13px; color: #6b7280;">ä¸€æ¬¡è¨­å®šå¤šå€‹æœˆä»½çš„æ”¶è²»é‡‘é¡</p>
              
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">æ¯æœˆé‡‘é¡ *</label>
                  <input type="number" id="batch-amount-${clientServiceId}" placeholder="2000" step="0.01" min="0" required 
                         style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
                </div>
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">ä»˜æ¬¾æœŸé™ï¼ˆå¤©ï¼‰</label>
                  <input type="number" id="batch-due-${clientServiceId}" value="30" min="1" 
                         style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
                </div>
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">æœˆä»½ç¯„åœ</label>
                  <select id="batch-range-${clientServiceId}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option value="all">å…¨å¹´ï¼ˆ1-12æœˆï¼‰</option>
                    <option value="custom">è‡ªé¸æœˆä»½</option>
                  </select>
                </div>
              </div>
              
              <div id="month-checkboxes-${clientServiceId}" style="display: none; margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500;">é¸æ“‡æœˆä»½ï¼š</label>
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                  ${Array.from({length: 12}, (_, i) => i + 1).map(month => `
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                      <input type="checkbox" class="month-checkbox-${clientServiceId}" value="${month}" checked 
                             style="cursor: pointer;" />
                      <span>${month}æœˆ</span>
                    </label>
                  `).join('')}
                </div>
              </div>
              
              <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="table-btn table-btn-secondary" onclick="closeBatchBillingForm(${clientServiceId})">å–æ¶ˆ</button>
                <button class="table-btn table-btn-primary" onclick="saveBatchBilling(${clientServiceId})">ç¢ºèªæ–°å¢</button>
              </div>
            </div>
            
            <!-- æ”¶è²»åˆ—è¡¨è¡¨æ ¼ -->
            ${schedules.length > 0 ? `
              <table class="billing-table" id="billing-table-${clientServiceId}" style="background: white;">
            <thead>
              <tr>
                <th style="width: 80px;">æœˆä»½</th>
                <th>é‡‘é¡</th>
                <th style="width: 100px;">æœŸé™</th>
                <th>å‚™è¨»</th>
                <th style="width: 130px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${schedules.map(s => `
                <tr data-schedule-id="${s.schedule_id}">
                  <td>${s.billing_month}æœˆ</td>
                  <td class="amount">$${s.billing_amount.toLocaleString('zh-TW')}</td>
                  <td>${s.payment_due_days}å¤©</td>
                  <td>${s.notes || '-'}</td>
                  <td>
                    <button class="table-btn-link" onclick="startEditBilling(${clientServiceId}, ${s.schedule_id}, ${s.billing_month}, ${s.billing_amount}, ${s.payment_due_days}, '${(s.notes || '').replace(/'/g, "\\'")}')">ç·¨è¼¯</button>
                    <button class="table-btn-link danger" onclick="deleteBillingInline(${clientServiceId}, ${s.schedule_id}, ${s.billing_month})">åˆªé™¤</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
            ` : '<p style="text-align: center; color: #9ca3af; padding: 40px 0; background: white; border-radius: 8px;">å°šæœªè¨­å®šæ”¶è²»ï¼Œè«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢</p>'}
          </div>
        `;
        
        // ç¶å®šæœˆä»½ç¯„åœåˆ‡æ›äº‹ä»¶
        const rangeSelect = document.getElementById(`batch-range-${clientServiceId}`);
        if (rangeSelect) {
          rangeSelect.addEventListener('change', function() {
            const checkboxesDiv = document.getElementById(`month-checkboxes-${clientServiceId}`);
            if (this.value === 'custom') {
              checkboxesDiv.style.display = 'block';
            } else {
              checkboxesDiv.style.display = 'none';
            }
          });
        }
        
      } catch (err) {
        console.error('è¼‰å…¥æ”¶è²»æ˜ç´°å¤±æ•—:', err);
        container.innerHTML = '<p class="error-text">è¼‰å…¥å¤±æ•—</p>';
      }
    }

    // é¡¯ç¤ºæ‰¹é‡æ–°å¢è¡¨å–®
    function showBatchBillingForm(clientServiceId) {
      const form = document.getElementById(`batch-billing-form-${clientServiceId}`);
      form.style.display = 'block';
    }
    
    // é—œé–‰æ‰¹é‡æ–°å¢è¡¨å–®
    function closeBatchBillingForm(clientServiceId) {
      const form = document.getElementById(`batch-billing-form-${clientServiceId}`);
      form.style.display = 'none';
      // é‡ç½®è¡¨å–®
      document.getElementById(`batch-amount-${clientServiceId}`).value = '';
      document.getElementById(`batch-due-${clientServiceId}`).value = '30';
      document.getElementById(`batch-range-${clientServiceId}`).value = 'all';
      document.getElementById(`month-checkboxes-${clientServiceId}`).style.display = 'none';
    }
    
    // å„²å­˜æ‰¹é‡æ”¶è²»
    async function saveBatchBilling(clientServiceId) {
      const amount = parseFloat(document.getElementById(`batch-amount-${clientServiceId}`).value);
      const dueDays = parseInt(document.getElementById(`batch-due-${clientServiceId}`).value);
      const range = document.getElementById(`batch-range-${clientServiceId}`).value;
      
      if (!amount || amount <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
        return;
      }
      
      // ç¢ºå®šè¦æ–°å¢çš„æœˆä»½
      let months = [];
      if (range === 'all') {
        months = Array.from({length: 12}, (_, i) => i + 1);
      } else {
        const checkboxes = document.querySelectorAll(`.month-checkbox-${clientServiceId}:checked`);
        months = Array.from(checkboxes).map(cb => parseInt(cb.value));
      }
      
      if (months.length === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æœˆä»½');
        return;
      }
      
      try {
        // æ‰¹é‡å‰µå»ºæ”¶è²»
        for (const month of months) {
          const res = await fetch('/internal/api/v1/billing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              client_service_id: clientServiceId,
              billing_month: month,
              billing_amount: amount,
              payment_due_days: dueDays
            })
          });
          
          if (!res.ok) {
            const json = await res.json();
            throw new Error(json.message || `${month}æœˆæ–°å¢å¤±æ•—`);
          }
        }
        
        alert('æ‰¹é‡æ–°å¢æˆåŠŸ');
        closeBatchBillingForm(clientServiceId);
        
        // é‡æ–°è¼‰å…¥æ”¶è²»åˆ—è¡¨
        const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
        const index = services.findIndex(s => s.client_service_id === clientServiceId);
        if (index !== -1) {
          await loadBillingInline(index, clientServiceId);
        }
        
        // é‡æ–°è¼‰å…¥æœå‹™åˆ—è¡¨ä»¥æ›´æ–°å¹´åº¦ç¸½é¡
        await loadClientDetail();
      } catch (err) {
        alert(err.message || 'æ‰¹é‡æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }


    // è¼‰å…¥æœå‹™é¡å‹é¸é …
    async function loadServices() {
      try {
        const res = await fetch('/internal/api/v1/services');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allServices = json.data;
          console.log('å·²è¼‰å…¥æœå‹™é¸é …:', allServices.length, 'é …');
        }
      } catch (err) {
        console.error('è¼‰å…¥æœå‹™é¸é …å¤±æ•—:', err);
      }
    }
    
    // è¼‰å…¥æœå‹™é …é¸é …
    async function loadServiceItems() {
      try {
        const res = await fetch('/internal/api/v1/services/items');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allServiceItems = json.data;
          console.log('å·²è¼‰å…¥æœå‹™é …:', allServiceItems.length, 'é …');
        }
      } catch (err) {
        console.error('è¼‰å…¥æœå‹™é …å¤±æ•—:', err);
      }
    }

    // è¼‰å…¥ä»»å‹™æ¨¡æ¿é¸é …
    async function loadTemplates() {
      try {
        const res = await fetch('/internal/api/v1/task-templates');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allTemplates = json.data;
          // ä¿å­˜åˆ°å…¨å±€ï¼Œä¾›æ¨¡æ¿é€‰æ‹©æ—¶ä½¿ç”¨
          window.taskTemplatesData = json.data;
        }
      } catch (err) {
        console.error('è¼‰å…¥æ¨¡æ¿é¸é …å¤±æ•—:', err);
      }
    }
    
    // è¼‰å…¥æ‰€æœ‰å“¡å·¥
    async function loadAllUsers() {
      try {
        const res = await fetch('/internal/api/v1/users');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allUsers = json.data;
          console.log('å·²è¼‰å…¥å“¡å·¥åˆ—è¡¨:', allUsers.length, 'äºº');
        }
      } catch (err) {
        console.error('è¼‰å…¥å“¡å·¥åˆ—è¡¨å¤±æ•—:', err);
      }
    }
    
    // è¼‰å…¥æ‰€æœ‰SOP
    async function loadAllSOPs() {
      try {
        const res = await fetch('/internal/api/v1/sop');
        const json = await res.json();
        
        if (json.ok && json.data) {
          // å†…éƒ¨çŸ¥è¯†åº“ä¸éœ€è¦å‘å¸ƒçŠ¶æ€ï¼Œæ‰€æœ‰SOPéƒ½å¯ç”¨
          // é‡è¦ï¼šAPIè¿”å›çš„å­—æ®µåæ˜¯idï¼Œéœ€è¦é‡å‘½åä¸ºsop_idä»¥ä¿æŒä¸€è‡´æ€§
          allSOPs = json.data.filter(sop => !sop.is_deleted).map(sop => ({
            ...sop,
            sop_id: sop.id  // å°†idé‡å‘½åä¸ºsop_id
          }));
          console.log('å·²è¼‰å…¥SOPåˆ—è¡¨:', allSOPs.length, 'ç¯‡');
        }
      } catch (err) {
        console.error('è¼‰å…¥SOPåˆ—è¡¨å¤±æ•—:', err);
      }
    }

    // é¡¯ç¤ºæ–°å¢æœå‹™è¡Œ
    function showAddServiceRow() {
      const addRow = document.getElementById('add-service-row');
      if (addRow) {
        addRow.style.display = 'table-row';
      }
    }

    // å–æ¶ˆæ–°å¢æœå‹™
    function cancelAddService() {
      const addRow = document.getElementById('add-service-row');
      if (addRow) {
        addRow.style.display = 'none';
      }
      const serviceIdInput = document.getElementById('new-service-id');
      const statusInput = document.getElementById('new-service-status');
      const startDateInput = document.getElementById('new-service-start-date');
      
      if (serviceIdInput) serviceIdInput.value = '';
      if (statusInput) statusInput.value = 'active';
      if (startDateInput) startDateInput.value = '';
    }

    // å„²å­˜æ–°æœå‹™ï¼ˆæ–°å¢æ¨¡å¼ï¼šæ·»åŠ åˆ° tempServicesï¼‰
    function saveNewService() {
      const serviceId = document.getElementById('new-service-id').value;
      const status = document.getElementById('new-service-status').value;
      const startDate = document.getElementById('new-service-start-date').value;

      if (!serviceId) {
        alert('è«‹é¸æ“‡æœå‹™');
        return;
      }

      const data = {
        service_id: parseInt(serviceId),
        status: status,
        start_date: startDate || null,
        billings: [],
        components: []
      };
      
      tempServices.push(data);
      renderServices(tempServices);
      refreshBillingFilterOptions();
      renderBillingList(window.currentBillingFilter || '');
      cancelAddService();
    }

    // ç·¨è¼¯æœå‹™ï¼ˆæ–°å¢æ¨¡å¼ï¼šä½¿ç”¨ç´¢å¼•ï¼‰
    function editService(index) {
      const service = tempServices[index];
      if (!service) {
        alert('æ‰¾ä¸åˆ°æœå‹™');
        return;
      }

      const serviceRow = document.querySelectorAll('.service-main-row')[index];
        
      serviceRow.innerHTML = `
        <td>
          <select id="edit-service-id-${index}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
            ${allServices.filter(s => s.is_active).map(s => 
              `<option value="${s.service_id}" ${s.service_id == service.service_id ? 'selected' : ''}>${s.service_name}</option>`
            ).join('')}
          </select>
        </td>
        <td>
          <select id="edit-service-status-${index}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
            <option value="active" ${service.status == 'active' ? 'selected' : ''}>ä½¿ç”¨ä¸­</option>
            <option value="suspended" ${service.status == 'suspended' ? 'selected' : ''}>æš«åœ</option>
            <option value="expired" ${service.status == 'expired' ? 'selected' : ''}>å·²åˆ°æœŸ</option>
            <option value="cancelled" ${service.status == 'cancelled' ? 'selected' : ''}>å·²å–æ¶ˆ</option>
          </select>
        </td>
        <td>-</td>
        <td>
          <input type="date" id="edit-service-start-date-${index}" value="${service.start_date || ''}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
        </td>
        <td>
          <button class="table-btn-link" onclick="saveEditService(${index})">å„²å­˜</button>
          <button class="table-btn-link danger" onclick="cancelEditService(${index})">å–æ¶ˆ</button>
        </td>
      `;
    }

    // å„²å­˜ç·¨è¼¯çš„æœå‹™ï¼ˆæ–°å¢æ¨¡å¼ï¼‰
    function saveEditService(index) {
      const serviceId = document.getElementById(`edit-service-id-${index}`).value;
      const status = document.getElementById(`edit-service-status-${index}`).value;
      const startDate = document.getElementById(`edit-service-start-date-${index}`).value;

      tempServices[index] = {
        ...tempServices[index],
        service_id: parseInt(serviceId),
        status: status,
        start_date: startDate || null
      };

      renderServices(tempServices);
      refreshBillingFilterOptions();
      renderBillingList(window.currentBillingFilter || '');
    }

    // å–æ¶ˆç·¨è¼¯æœå‹™ï¼ˆæ–°å¢æ¨¡å¼ï¼‰
    function cancelEditService(index) {
      renderServices(tempServices);
      refreshBillingFilterOptions();
      renderBillingList(window.currentBillingFilter || '');
    }

    // åˆªé™¤æœå‹™ï¼ˆæ–°å¢æ¨¡å¼ï¼‰
    function deleteService(index, serviceName) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤æœå‹™ã€Œ${serviceName}ã€å—ï¼Ÿ`)) return;
      
      tempServices.splice(index, 1);
      renderServices(tempServices);
      refreshBillingFilterOptions();
      renderBillingList(window.currentBillingFilter || '');
    }

    // é¡¯ç¤ºæ‰¹é‡æ–°å¢æ”¶è²»å°è©±æ¡†
    // é–‹å§‹ç·¨è¼¯æ”¶è²»æ˜ç´°
    function startEditBilling(clientServiceId, scheduleId, month, amount, dueDays, notes) {
      const row = document.querySelector(`[data-schedule-id="${scheduleId}"]`);
      row.innerHTML = `
        <td>
          <input type="number" id="edit-month-${scheduleId}" value="${month}" min="1" max="12" required />
        </td>
        <td>
          <input type="number" id="edit-amount-${scheduleId}" value="${amount}" step="0.01" min="0" required />
        </td>
        <td>
          <input type="number" id="edit-due-${scheduleId}" value="${dueDays}" min="1" required />
        </td>
        <td>
          <input type="text" id="edit-notes-${scheduleId}" value="${notes}" placeholder="å‚™è¨»" />
        </td>
        <td>
          <button class="table-btn-link" onclick="saveBilling(${clientServiceId}, ${scheduleId})">å„²å­˜</button>
          <button class="table-btn-link danger" onclick="cancelBillingEdit(${clientServiceId}, ${scheduleId})">å–æ¶ˆ</button>
        </td>
      `;
    }

    // å„²å­˜æ”¶è²»æ˜ç´°ï¼ˆæ–°å¢æˆ–ç·¨è¼¯ï¼‰
    async function saveBilling(clientServiceId, scheduleId) {
      const isEdit = scheduleId !== null;
      
      let month, amount, dueDays, notes;
      
      if (isEdit) {
        month = document.getElementById(`edit-month-${scheduleId}`).value;
        amount = document.getElementById(`edit-amount-${scheduleId}`).value;
        dueDays = document.getElementById(`edit-due-${scheduleId}`).value;
        notes = document.getElementById(`edit-notes-${scheduleId}`).value;
      } else {
        month = document.getElementById(`new-month-${clientServiceId}`).value;
        amount = document.getElementById(`new-amount-${clientServiceId}`).value;
        dueDays = document.getElementById(`new-due-${clientServiceId}`).value;
        notes = document.getElementById(`new-notes-${clientServiceId}`).value;
      }
      
      if (!month || !amount || !dueDays) {
        alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½');
        return;
      }
      
      const data = {
        billing_month: parseInt(month),
        billing_amount: parseFloat(amount),
        payment_due_days: parseInt(dueDays),
        notes: notes || null
      };
      
      try {
        const url = isEdit 
          ? `/internal/api/v1/billing/${scheduleId}`
          : `/internal/api/v1/billing/service/${clientServiceId}`;
        
        const res = await fetch(url, {
          method: isEdit ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || 'æ“ä½œå¤±æ•—');
          return;
        }

        alert(isEdit ? 'æ”¶è²»æ˜ç´°å·²æ›´æ–°' : 'æ”¶è²»æ˜ç´°å·²æ–°å¢');
        
        // é‡æ–°è¼‰å…¥è©²æœå‹™çš„æ”¶è²»æ˜ç´°
        const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
        const index = services.findIndex(s => s.client_service_id === clientServiceId);
        if (index !== -1) {
          await loadBillingInline(index, clientServiceId);
        }
        
        // é‡æ–°è¼‰å…¥å®¢æˆ¶ä»¥æ›´æ–°å¹´åº¦ç¸½é¡
        await loadClientDetail();
        
      } catch (err) {
        console.error('å„²å­˜æ”¶è²»æ˜ç´°å¤±æ•—:', err);
        alert('æ“ä½œå¤±æ•—');
      }
    }

    // å–æ¶ˆç·¨è¼¯æ”¶è²»æ˜ç´°
    async function cancelBillingEdit(clientServiceId, scheduleId) {
      // é‡æ–°è¼‰å…¥è©²æœå‹™çš„æ”¶è²»æ˜ç´°
      const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
      const index = services.findIndex(s => s.client_service_id === clientServiceId);
      if (index !== -1) {
        await loadBillingInline(index, clientServiceId);
      }
    }

    // åˆªé™¤æ”¶è²»æ˜ç´°ï¼ˆå…§åµŒï¼‰
    async function deleteBillingInline(clientServiceId, scheduleId, month) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤${month}æœˆçš„æ”¶è²»æ˜ç´°å—ï¼Ÿ`)) return;
      
      try {
        const res = await fetch(`/internal/api/v1/billing/${scheduleId}`, {
          method: 'DELETE'
        });
        
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || 'åˆªé™¤å¤±æ•—');
          return;
        }

        alert('æ”¶è²»æ˜ç´°å·²åˆªé™¤');
        
        // é‡æ–°è¼‰å…¥è©²æœå‹™çš„æ”¶è²»æ˜ç´°
        const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
        const index = services.findIndex(s => s.client_service_id === clientServiceId);
        if (index !== -1) {
          await loadBillingInline(index, clientServiceId);
        }
        
        // é‡æ–°è¼‰å…¥å®¢æˆ¶ä»¥æ›´æ–°å¹´åº¦ç¸½é¡
        await loadClientDetail();
        
      } catch (err) {
        console.error('åˆªé™¤æ”¶è²»æ˜ç´°å¤±æ•—:', err);
        alert('åˆªé™¤å¤±æ•—');
      }
    }

    // æš´éœ²å‡½æ•¸åˆ°å…¨å±€ï¼ˆæ–°çš„ç‹¬ç«‹æ”¶è´¹åŠŸèƒ½ï¼‰
    window.switchBillingType = switchBillingType;
    window.showAddBillingModal = showAddBillingModal;
    window.closeBillingModal = closeBillingModal;
    window.saveBillingFromModal = saveBillingFromModal;
    window.editBillingRow = editBillingRow;
    window.deleteBillingRow = deleteBillingRow;

    // ==================== æœå‹™çµ„æˆéƒ¨åˆ†ç®¡ç† ====================

    // é¡¯ç¤ºæœå‹™çµ„æˆéƒ¨åˆ†é…ç½®å€åŸŸ
    async function showComponentsSection(index, clientServiceId) {
      const componentRow = document.getElementById(`component-row-${index}`);
      
      if (componentRow.style.display === 'none') {
        componentRow.style.display = 'table-row';
        await loadComponentsInline(index, clientServiceId);
      } else {
        componentRow.style.display = 'none';
      }
    }

    // è¼‰å…¥æœå‹™çµ„æˆéƒ¨åˆ†åˆ—è¡¨
    async function loadComponentsInline(index, clientServiceId) {
      const container = document.getElementById(`component-content-${index}`);
      
      try {
        const res = await fetch(`/internal/api/v1/client-services/${clientServiceId}/components`);
        const json = await res.json();
        
        if (!json.ok) {
          console.error('è¼‰å…¥çµ„ä»¶å¤±æ•—:', json);
          container.innerHTML = `<p class="error-text">è¼‰å…¥å¤±æ•—: ${json.message || json.debug || 'æœªçŸ¥éŒ¯èª¤'}</p>`;
          return;
        }

        const components = json.data || [];
        
        // å¾clientDetailä¸­æ‰¾åˆ°ç•¶å‰æœå‹™ï¼Œç²å–å…¶service_id
        const currentService = clientDetail.services.find(s => s.client_service_id === clientServiceId);
        const currentServiceId = currentService?.service_id;
        
        if (!currentServiceId) {
          container.innerHTML = '<p class="error-text">ç„¡æ³•ç²å–æœå‹™ä¿¡æ¯</p>';
          return;
        }
        
        // åªé¡¯ç¤ºç•¶å‰æœå‹™ä¸‹çš„æœå‹™é …ç›®
        let serviceItemsHtml = '';
        const currentServiceItems = allServiceItems.filter(item => item.service_id === currentServiceId);
        
        if (currentServiceItems.length === 0) {
          serviceItemsHtml = '<option value="">æ­¤æœå‹™æš«ç„¡å¯ç”¨é …ç›®</option>';
        } else {
          currentServiceItems.forEach(item => {
            serviceItemsHtml += `<option value="${item.item_id}" data-service-id="${item.service_id}">${item.item_name}</option>`;
          });
        }

        container.innerHTML = `
          <div style="padding: 20px; background: #f9fafb; border-radius: 8px;">
            <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px;">
              <button class="table-btn table-btn-primary" onclick="showAddComponentForm(${clientServiceId})">+ é…ç½®ä»»å‹™</button>
            </div>
            
            <div id="add-component-form-${clientServiceId}" style="display: none; background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #3b82f6;">
              <h5 style="margin-top: 0;">é…ç½®æœå‹™ä»»å‹™</h5>
              
              <!-- éšè—å­—æ®µï¼šè‡ªåŠ¨å¡«å……é»˜è®¤å€¼ -->
              <input type="hidden" id="new-comp-name-${clientServiceId}" value="ä»»å‹™é…ç½®" />
              <input type="hidden" id="new-comp-service-item-${clientServiceId}" value="" />
              <input type="hidden" id="new-comp-freq-${clientServiceId}" value="monthly" />
              <input type="hidden" id="new-comp-hours-${clientServiceId}" value="" />
              <input type="hidden" id="new-comp-due-rule-${clientServiceId}" value="end_of_month" />
              <input type="hidden" id="new-comp-due-value-${clientServiceId}" value="" />
              <input type="hidden" id="new-comp-advance-${clientServiceId}" value="7" />
              <input type="hidden" id="new-comp-template-${clientServiceId}" value="" />
              
              <!-- ä»»åŠ¡é…ç½®åŒºåŸŸï¼ˆç»Ÿä¸€ç•Œé¢ï¼‰ -->
              <div id="tasks-config-${clientServiceId}" style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px solid #3b82f6;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <div>
                    <strong style="color: #1e40af; font-size: 15px;">ğŸ“‹ ä»»å‹™é…ç½®</strong>
                    <p style="margin: 5px 0 0 0; font-size: 13px; color: #3b82f6;">
                      <span id="template-hint-${clientServiceId}">å·²é¸æ“‡æ¨¡æ¿ï¼Œå¯è‡ªç”±ç·¨è¼¯æˆ–æ·»åŠ ä»»å‹™</span>
                    </p>
                  </div>
                  <button type="button" class="table-btn table-btn-primary" onclick="addCustomTask${clientServiceId}()">+ æ–°å¢ä»»å‹™</button>
                </div>
                
                <!-- æ‰¹é‡è®¾ç½®è´Ÿè´£äºº -->
                <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #3b82f6;">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <label style="font-size: 13px; font-weight: 500; color: #1e40af; white-space: nowrap;">ğŸ‘¥ æ‰¹é‡è¨­ç½®è² è²¬äººï¼š</label>
                    <select id="batch-assignee-${clientServiceId}" style="flex: 1; max-width: 200px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;">
                      <option value="">è«‹é¸æ“‡å“¡å·¥</option>
                      ${allUsers.map(u => `<option value="${u.user_id}">${u.username}</option>`).join('')}
                    </select>
                    <button type="button" class="table-btn" style="background: #3b82f6; color: white; padding: 6px 12px; font-size: 13px;" 
                            onclick="batchAssignTasks${clientServiceId}()">
                      å¥—ç”¨åˆ°æ‰€æœ‰ä»»å‹™
                    </button>
                    <small style="color: #6b7280; font-size: 12px;">ğŸ’¡ ä¹‹å¾Œå¯å–®ç¨ä¿®æ”¹å€‹åˆ¥ä»»å‹™</small>
                  </div>
                </div>
                
                <div id="tasks-list-${clientServiceId}">
                  <!-- ä»»åŠ¡åˆ—è¡¨ä¼šåŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
                </div>
              </div>
              
              <div class="form-field">
                <label>ğŸ“– æœå‹™SOPï¼ˆå¯é¸ï¼‰</label>
                
                <!-- å·²é€‰æ‹©çš„SOPæ ‡ç­¾ -->
                <div id="selected-comp-sops-${clientServiceId}" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; min-height: 28px;">
                  <span style="color: #9ca3af; font-size: 11px;">å°šæœªé¸æ“‡SOP</span>
                </div>
                
                <!-- æœç´¢æ¡† -->
                <input type="text" 
                       id="comp-sop-search-${clientServiceId}"
                       placeholder="ğŸ” æœå°‹SOP..." 
                       style="width: 100%; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; margin-bottom: 6px;"
                       onkeyup="filterCompSOPs${clientServiceId}(this.value)" />
                
                <!-- SOPåˆ—è¡¨ -->
                <div id="new-comp-sop-list-${clientServiceId}" style="max-height: 150px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 4px; padding: 6px; background: white;">
                  <div style="color: #9ca3af; text-align: center; padding: 20px;">è¼‰å…¥ä¸­...</div>
                </div>
                <small style="display: block; margin-top: 5px; color: #6b7280;">ğŸ’¡ é¸æ“‡SOPä½œç‚ºæœå‹™æµç¨‹åƒè€ƒï¼ˆå¯å¤šé¸ï¼‰</small>
              </div>
              
              <div style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="saveNewComponent(${clientServiceId})">å„²å­˜</button>
                <button class="btn btn-secondary" onclick="cancelAddComponent(${clientServiceId})">å–æ¶ˆ</button>
              </div>
            </div>
            
            ${components.map((comp, i) => `
              <div class="component-item" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #3b82f6;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div style="flex: 1;">
                    <h5 style="margin: 0 0 12px 0; color: #1f2937; font-size: 15px;">ä»»å‹™é…ç½® #${i + 1}</h5>
                    
                    ${comp.component_sops && comp.component_sops.length > 0 ? `
                      <div style="padding: 8px 12px; background: #f0f9ff; border-radius: 4px; border-left: 3px solid #3b82f6; margin-bottom: 12px;">
                        <div style="font-size: 12px; font-weight: 600; color: #1e40af; margin-bottom: 4px;">ğŸ“– æœå‹™å±¤ç´šSOPï¼ˆ${comp.component_sops.length}å€‹ï¼‰</div>
                        ${comp.component_sops.map(sop => `
                          <div style="font-size: 13px; color: #374151; padding: 2px 0;">
                            â€¢ ${sop.title}
                            ${sop.category ? `<span style="font-size: 11px; color: #6b7280; margin-left: 4px;">[${getCategoryText(sop.category)}]</span>` : ''}
                          </div>
                        `).join('')}
                      </div>
                    ` : ''}
                    
                    <!-- ä»»åŠ¡é…ç½®åŒºåŸŸ -->
                    ${comp.tasks && comp.tasks.length > 0 ? `
                      <div style="${comp.component_sops && comp.component_sops.length > 0 ? 'padding-top: 12px; border-top: 1px solid #e5e7eb;' : ''}">
                        <strong style="font-size: 13px; color: #374151;">ğŸ“‹ ä»»å‹™åˆ—è¡¨ï¼ˆ${comp.tasks.length}å€‹ï¼‰</strong>
                        <div style="margin-top: 8px;">
                          ${comp.tasks.map((task, taskIdx) => `
                            <div style="background: #f9fafb; padding: 10px; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid #10b981;">
                              <div style="font-size: 13px; color: #1f2937; font-weight: 500; margin-bottom: 4px;">
                                ${taskIdx + 1}. ${task.task_name || 'æœªå‘½åä»»å‹™'}
                              </div>
                              <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">
                                ${task.assignee_user_id ? `ğŸ‘¤ è² è²¬äººï¼š${allUsers.find(u => u.user_id === task.assignee_user_id)?.username || 'æœªçŸ¥'} â€¢ ` : ''}
                                ${task.estimated_hours ? `â±ï¸ é ä¼°ï¼š${task.estimated_hours}å°æ™‚` : ''}
                                ${task.notes ? ` â€¢ ğŸ’¡ ${task.notes}` : ''}
                              </div>
                              ${task.sops && task.sops.length > 0 ? `
                                <div style="margin-top: 6px; padding: 6px 8px; background: #ecfdf5; border-radius: 4px; border-left: 2px solid #10b981;">
                                  <div style="font-size: 11px; font-weight: 600; color: #047857; margin-bottom: 2px;">ğŸ“– ä»»å‹™SOPï¼š</div>
                                  ${task.sops.map(sop => `
                                    <div style="font-size: 12px; color: #065f46;">
                                      â€¢ ${sop.title}
                                    </div>
                                  `).join('')}
                                </div>
                              ` : ''}
                            </div>
                          `).join('')}
                        </div>
                      </div>
                    ` : `
                      <div style="padding: 12px; background: #fef3c7; border-radius: 6px; border-left: 3px solid #fbbf24;">
                        <div style="font-size: 13px; color: #92400e;">
                          âš ï¸ å°šæœªé…ç½®ä»»å‹™ï¼Œè«‹é»æ“Šã€Œç·¨è¼¯ã€æ·»åŠ ä»»å‹™
                        </div>
                      </div>
                    `}
                  </div>
                  <div style="display: flex; gap: 5px;">
                    <button class="table-btn-link" onclick="editComponent(${comp.component_id})">ç·¨è¼¯</button>
                    <button class="table-btn-link danger" onclick="deleteComponent(${comp.component_id}, '${comp.component_name}')">åˆªé™¤</button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        
      } catch (err) {
        console.error('è¼‰å…¥æœå‹™çµ„æˆéƒ¨åˆ†å¤±æ•—:', err);
        container.innerHTML = '<p class="error-text">è¼‰å…¥å¤±æ•—</p>';
      }
    }

    // è¼”åŠ©å‡½æ•¸ï¼šé »ç‡æ–‡å­—
    function getFrequencyText(freq) {
      const map = {
        'monthly': 'æ¯æœˆ',
        'bi-monthly': 'æ¯å…©å€‹æœˆ',
        'quarterly': 'æ¯å­£',
        'yearly': 'æ¯å¹´',
        'one-time': 'ä¸€æ¬¡æ€§'
      };
      return map[freq] || freq;
    }

    // è¼”åŠ©å‡½æ•¸ï¼šæœŸé™è¦å‰‡æ–‡å­—
    function getDueRuleText(rule) {
      const map = {
        'end_of_month': 'ç•¶æœˆæœˆåº•',
        'specific_day': 'ç•¶æœˆæŒ‡å®šæ—¥',
        'next_month_day': 'æ¬¡æœˆæŒ‡å®šæ—¥',
        'days_after_start': 'ç›¸å°å¤©æ•¸'
      };
      return map[rule] || '-';
    }

    // å±•é–‹/æ”¶èµ·çµ„ä»¶é…ç½®å€åŸŸï¼ˆæ–°å¢æ¨¡å¼ï¼‰
    function showComponentsSection(serviceIndex) {
      const componentRow = document.getElementById(`components-row-${serviceIndex}`);
      
      if (componentRow.style.display === 'none') {
        componentRow.style.display = 'table-row';
        loadComponentsInline(serviceIndex);
      } else {
        componentRow.style.display = 'none';
      }
    }
    
    // è¼‰å…¥çµ„ä»¶é…ç½®å€åŸŸï¼ˆæ–°å¢æ¨¡å¼ï¼šå¾ tempServices è®€å–ï¼‰
    function loadComponentsInline(serviceIndex) {
      const svc = tempServices[serviceIndex];
      const container = document.getElementById(`components-content-${serviceIndex}`);
      if (!svc || !container) return;
      
      const components = svc.components || [];
      const currentServiceId = svc.service_id;
      
      // åªé¡¯ç¤ºç•¶å‰æœå‹™ä¸‹çš„æœå‹™é …ç›®
      let serviceItemsHtml = '';
      const currentServiceItems = allServiceItems.filter(item => item.service_id === currentServiceId);
      
      if (currentServiceItems.length === 0) {
        serviceItemsHtml = '<option value="">æ­¤æœå‹™æš«ç„¡å¯ç”¨é …ç›®</option>';
      } else {
        currentServiceItems.forEach(item => {
          serviceItemsHtml += `<option value="${item.item_id}" data-service-id="${item.service_id}">${item.item_name}</option>`;
        });
      }
      
      container.innerHTML = `
        <div style="padding: 20px; background: #f9fafb; border-radius: 8px;">
          <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px;">
            <button class="table-btn table-btn-primary" onclick="showAddComponentForm(${serviceIndex})">+ é…ç½®ä»»å‹™</button>
          </div>
          
          <div id="add-component-form-${serviceIndex}" style="display: none; background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #3b82f6;">
            <h5 style="margin-top: 0;">é…ç½®æœå‹™ä»»å‹™</h5>
            
            <!-- éšè—å­—æ®µï¼šè‡ªåŠ¨å¡«å……é»˜è®¤å€¼ -->
            <input type="hidden" id="new-comp-name-${serviceIndex}" value="ä»»å‹™é…ç½®" />
            <input type="hidden" id="new-comp-service-item-${serviceIndex}" value="" />
            <input type="hidden" id="new-comp-freq-${serviceIndex}" value="monthly" />
            <input type="hidden" id="new-comp-hours-${serviceIndex}" value="" />
            <input type="hidden" id="new-comp-due-rule-${serviceIndex}" value="end_of_month" />
            <input type="hidden" id="new-comp-due-value-${serviceIndex}" value="" />
            <input type="hidden" id="new-comp-advance-${serviceIndex}" value="7" />
            <input type="hidden" id="new-comp-template-${serviceIndex}" value="" />
            
            <!-- ä»»åŠ¡é…ç½®åŒºåŸŸï¼ˆç»Ÿä¸€ç•Œé¢ï¼‰ -->
            <div id="tasks-config-${serviceIndex}" style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px solid #3b82f6;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                  <strong style="color: #1e40af; font-size: 15px;">ğŸ“‹ ä»»å‹™é…ç½®</strong>
                  <p style="margin: 5px 0 0 0; font-size: 13px; color: #3b82f6;">
                    <span id="template-hint-${serviceIndex}">å·²é¸æ“‡æ¨¡æ¿ï¼Œå¯è‡ªç”±ç·¨è¼¯æˆ–æ·»åŠ ä»»å‹™</span>
                  </p>
                </div>
                <button type="button" class="table-btn table-btn-primary" onclick="addCustomTask${serviceIndex}()">+ æ–°å¢ä»»å‹™</button>
              </div>
              
              <!-- æ‰¹é‡è®¾ç½®è´Ÿè´£äºº -->
              <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #3b82f6;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <label style="font-size: 13px; font-weight: 500; color: #1e40af; white-space: nowrap;">ğŸ‘¥ æ‰¹é‡è¨­ç½®è² è²¬äººï¼š</label>
                  <select id="batch-assignee-${serviceIndex}" style="flex: 1; max-width: 200px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;">
                    <option value="">è«‹é¸æ“‡å“¡å·¥</option>
                    ${allUsers.map(u => `<option value="${u.user_id}">${u.username}</option>`).join('')}
                  </select>
                  <button type="button" class="table-btn" style="background: #3b82f6; color: white; padding: 6px 12px; font-size: 13px;" 
                          onclick="batchAssignTasks${serviceIndex}()">
                    å¥—ç”¨åˆ°æ‰€æœ‰ä»»å‹™
                  </button>
                  <small style="color: #6b7280; font-size: 12px;">ğŸ’¡ ä¹‹å¾Œå¯å–®ç¨ä¿®æ”¹å€‹åˆ¥ä»»å‹™</small>
                </div>
              </div>
              
              <div id="tasks-list-${serviceIndex}">
                <!-- ä»»åŠ¡åˆ—è¡¨ä¼šåŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
              </div>
            </div>
            
            <div class="form-field">
              <label>ğŸ“– æœå‹™SOPï¼ˆå¯é¸ï¼‰</label>
              
              <!-- å·²é€‰æ‹©çš„SOPæ ‡ç­¾ -->
              <div id="selected-comp-sops-${serviceIndex}" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; min-height: 28px;">
                <span style="color: #9ca3af; font-size: 11px;">å°šæœªé¸æ“‡SOP</span>
              </div>
              
              <!-- æœç´¢æ¡† -->
              <input type="text" 
                     id="comp-sop-search-${serviceIndex}"
                     placeholder="ğŸ” æœå°‹SOP..." 
                     style="width: 100%; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; margin-bottom: 6px;"
                     onkeyup="filterCompSOPs${serviceIndex}(this.value)" />
              
              <!-- SOPåˆ—è¡¨ -->
              <div id="new-comp-sop-list-${serviceIndex}" style="max-height: 150px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 4px; padding: 6px; background: white;">
                <div style="color: #9ca3af; text-align: center; padding: 20px;">è¼‰å…¥ä¸­...</div>
              </div>
              <small style="display: block; margin-top: 5px; color: #6b7280;">ğŸ’¡ é¸æ“‡SOPä½œç‚ºæœå‹™æµç¨‹åƒè€ƒï¼ˆå¯å¤šé¸ï¼‰</small>
            </div>
            
            <div style="margin-top: 15px;">
              <button class="btn btn-primary" onclick="saveNewComponent(${serviceIndex})">å„²å­˜</button>
              <button class="btn btn-secondary" onclick="cancelAddComponent(${serviceIndex})">å–æ¶ˆ</button>
            </div>
          </div>
          
          ${components.map((comp, i) => `
            <div class="component-item" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #3b82f6;">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                  <h5 style="margin: 0 0 12px 0; color: #1f2937; font-size: 15px;">ä»»å‹™é…ç½® #${i + 1}</h5>
                  
                  ${comp.component_sops && comp.component_sops.length > 0 ? `
                    <div style="padding: 8px 12px; background: #f0f9ff; border-radius: 4px; border-left: 3px solid #3b82f6; margin-bottom: 12px;">
                      <div style="font-size: 12px; font-weight: 600; color: #1e40af; margin-bottom: 4px;">ğŸ“– æœå‹™å±¤ç´šSOPï¼ˆ${comp.component_sops.length}å€‹ï¼‰</div>
                      ${comp.component_sops.map(sop => `
                        <div style="font-size: 13px; color: #374151; padding: 2px 0;">
                          â€¢ ${sop.title || sop.sop_id}
                        </div>
                      `).join('')}
                    </div>
                  ` : ''}
                  
                  <!-- ä»»åŠ¡é…ç½®åŒºåŸŸ -->
                  ${comp.tasks && comp.tasks.length > 0 ? `
                    <div style="${comp.component_sops && comp.component_sops.length > 0 ? 'padding-top: 12px; border-top: 1px solid #e5e7eb;' : ''}">
                      <strong style="font-size: 13px; color: #374151;">ğŸ“‹ ä»»å‹™åˆ—è¡¨ï¼ˆ${comp.tasks.length}å€‹ï¼‰</strong>
                      <div style="margin-top: 8px;">
                        ${comp.tasks.map((task, taskIdx) => `
                          <div style="background: #f9fafb; padding: 10px; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid #10b981;">
                            <div style="font-size: 13px; color: #1f2937; font-weight: 500; margin-bottom: 4px;">
                              ${taskIdx + 1}. ${task.task_name || 'æœªå‘½åä»»å‹™'}
                            </div>
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">
                              ${task.assignee_user_id ? `ğŸ‘¤ è² è²¬äººï¼š${allUsers.find(u => u.user_id === task.assignee_user_id)?.username || 'æœªçŸ¥'} â€¢ ` : ''}
                              ${task.estimated_hours ? `â±ï¸ é ä¼°ï¼š${task.estimated_hours}å°æ™‚` : ''}
                              ${task.notes ? ` â€¢ ğŸ’¡ ${task.notes}` : ''}
                            </div>
                            ${task.sops && task.sops.length > 0 ? `
                              <div style="margin-top: 6px; padding: 6px 8px; background: #ecfdf5; border-radius: 4px; border-left: 2px solid #10b981;">
                                <div style="font-size: 11px; font-weight: 600; color: #047857; margin-bottom: 2px;">ğŸ“– ä»»å‹™SOPï¼š</div>
                                ${task.sops.map(sop => `
                                  <div style="font-size: 12px; color: #065f46;">
                                    â€¢ ${sop.title || sop.sop_id}
                                  </div>
                                `).join('')}
                              </div>
                            ` : ''}
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  ` : `
                    <div style="padding: 12px; background: #fef3c7; border-radius: 6px; border-left: 3px solid #fbbf24;">
                      <div style="font-size: 13px; color: #92400e;">
                        âš ï¸ å°šæœªé…ç½®ä»»å‹™ï¼Œè«‹é»æ“Šã€Œç·¨è¼¯ã€æ·»åŠ ä»»å‹™
                      </div>
                    </div>
                  `}
                </div>
                <div style="display: flex; gap: 5px;">
                  <button class="table-btn-link danger" onclick="deleteLocalComponent(${serviceIndex}, ${i})">åˆªé™¤</button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    // é¡¯ç¤ºæ–°å¢è¡¨å–®ï¼ˆæ–°å¢æ¨¡å¼ï¼‰
    function showAddComponentForm(serviceIndex) {
      const form = document.getElementById(`add-component-form-${serviceIndex}`);
      if (!form) return;
      form.style.display = 'block';
      
      // åˆ›å»ºåŠ è½½æ¨¡æ¿é˜¶æ®µçš„å‡½æ•°
      window[`loadTemplateStages${serviceIndex}`] = async function(templateId) {
        const tasksContainer = document.getElementById(`tasks-config-${serviceIndex}`);
        const tasksList = document.getElementById(`tasks-list-${serviceIndex}`);
        const templateHint = document.getElementById(`template-hint-${serviceIndex}`);
        
        // åˆå§‹åŒ–ä»»åŠ¡æ•°ç»„
        if (!window[`customTasks${serviceIndex}`]) {
          window[`customTasks${serviceIndex}`] = [];
        }
        
        if (!templateId) {
          // æ²¡æœ‰é€‰æ‹©æ¨¡æ¿
          templateHint.textContent = 'æœªä½¿ç”¨æ¨¡æ¿ï¼Œæ‰‹å‹•é…ç½®ä»»å‹™';
          window[`customTasks${serviceIndex}`] = [];
          // åˆå§‹åŒ–ä¸€ä¸ªç©ºä»»åŠ¡
          window[`addCustomTask${serviceIndex}`]();
          return;
        }
        
        // é€‰æ‹©äº†æ¨¡æ¿
        templateHint.innerHTML = '<strong>âœ¨ å·²é¸æ“‡æ¨¡æ¿</strong>ï¼Œä»¥ä¸‹ä»»å‹™ä¾†è‡ªæ¨¡æ¿ä¸¦å¯è‡ªç”±ç·¨è¼¯ï¼ˆä¸å½±éŸ¿åŸå§‹æ¨¡æ¿ï¼‰';
        
        tasksList.innerHTML = '<p style="color: #6b7280; font-size: 14px;">è¼‰å…¥ä¸­...</p>';
        
        try {
          const res = await fetch(`/internal/api/v1/task-templates/${templateId}/stages`);
          const json = await res.json();
          
          if (!json.ok || !json.data) {
            tasksList.innerHTML = '<p style="color: #ef4444; font-size: 14px;">è¼‰å…¥å¤±æ•—</p>';
            return;
          }
          
          const stages = json.data;
          
          if (stages.length === 0) {
            tasksList.innerHTML = '<p style="color: #6b7280; font-size: 14px;">æ­¤æ¨¡æ¿æš«ç„¡éšæ®µè¨­å®š</p>';
            window[`addCustomTask${serviceIndex}`]();
            return;
          }
          
          // å°†æ¨¡æ¿é˜¶æ®µè½¬æ¢ä¸ºå¯ç¼–è¾‘ä»»åŠ¡
          window[`customTasks${serviceIndex}`] = stages.map((stage, idx) => ({
            name: stage.stage_name,
            description: stage.description || '',
            due_rule: stage.due_date_rule || 'end_of_month',
            due_value: stage.due_date_value || '',
            estimated_hours: stage.estimated_hours || '',
            advance_days: stage.advance_days || 7,
            assignee_user_id: '',
            sop_ids: stage.sop_id ? [stage.sop_id] : [],  // å…¼å®¹æ—§çš„å•ä¸€SOP
            stage_order: stage.stage_order || (idx + 1),
            fromTemplate: true
          }));
          
          // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
          window[`renderTasksList${serviceIndex}`]();
          
        } catch (err) {
          console.error('è¼‰å…¥æ¨¡æ¿éšæ®µå¤±æ•—:', err);
          tasksList.innerHTML = '<p style="color: #ef4444; font-size: 14px;">è¼‰å…¥å¤±æ•—</p>';
        }
      };
      
      // åˆ›å»ºç»Ÿä¸€çš„ä»»åŠ¡åˆ—è¡¨æ¸²æŸ“å‡½æ•°
      window[`renderTasksList${serviceIndex}`] = function() {
        const tasksList = document.getElementById(`tasks-list-${serviceIndex}`);
        const tasks = window[`customTasks${serviceIndex}`] || [];
        
        if (tasks.length === 0) {
          tasksList.innerHTML = `
            <div style="padding: 20px; text-align: center; background: #fef3c7; border-radius: 8px; border: 2px dashed #fbbf24;">
              <p style="color: #92400e; font-size: 14px; margin: 0 0 10px 0; font-weight: 500;">
                âš ï¸ å°šæœªé…ç½®ä»»ä½•ä»»å‹™
              </p>
              <p style="color: #92400e; font-size: 13px; margin: 0;">
                é»æ“Šä¸Šæ–¹ã€Œ<strong>+ æ–°å¢ä»»å‹™</strong>ã€æŒ‰éˆ•é–‹å§‹é…ç½®
              </p>
            </div>
          `;
          return;
        }
        
        // è·å–å½“å‰æœåŠ¡çš„service_code
        const currentService = tempServices[serviceIndex];
        const currentServiceType = allServices.find(st => st.service_id === currentService?.service_id);
        const serviceCode = currentServiceType?.service_code || '';
        
        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        tasksList.innerHTML = tasks.map((task, idx) => `
          <div id="custom-task-${idx}-${serviceIndex}" style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid ${task.fromTemplate ? '#3b82f6' : '#d1d5db'};">
            <div style="display: flex; align-items: start; gap: 15px;">
              <div style="flex-shrink: 0; width: 30px; height: 30px; background: ${task.fromTemplate ? '#3b82f6' : '#6b7280'}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                ${task.stage_order || idx + 1}
              </div>
              <div style="flex: 1;">
                <div style="margin-bottom: 10px;">
                  <input type="text" placeholder="ä»»å‹™åç¨±" value="${task.name || ''}"
                         style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; font-weight: 500;"
                         onchange="window.customTasks${serviceIndex}[${idx}].name = this.value" />
                  ${task.description ? `<p style="margin: 4px 0 0 0; font-size: 12px; color: #6b7280;">${task.description}</p>` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ‘¤ è² è²¬äººå“¡</label>
                    <select style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                            onchange="window.customTasks${serviceIndex}[${idx}].assignee_user_id = this.value">
                      <option value="">æœªæŒ‡å®š</option>
                      ${allUsers.map(u => `<option value="${u.user_id}" ${task.assignee_user_id == u.user_id ? 'selected' : ''}>${u.username}</option>`).join('')}
                    </select>
                  </div>
                  <div style="grid-column: span 2;">
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“– ä»»å‹™SOPï¼ˆå¯é¸ï¼Œå¯å¤šé¸ï¼‰</label>
                    
                    <!-- å·²é€‰æ‹©çš„SOPæ ‡ç­¾ -->
                    <div id="selected-sops-${idx}-${serviceIndex}" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; min-height: 28px;">
                      <!-- åŠ¨æ€å¡«å……å·²é€‰æ‹©çš„SOPæ ‡ç­¾ -->
                    </div>
                    
                    <!-- æœç´¢æ¡† -->
                    <input type="text" 
                           id="sop-search-${idx}-${serviceIndex}"
                           placeholder="ğŸ” æœå°‹SOP..." 
                           style="width: 100%; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; margin-bottom: 6px;"
                           onkeyup="filterTaskSOPs${serviceIndex}(${idx}, this.value)" />
                    
                    <!-- SOPåˆ—è¡¨ -->
                    <div id="task-sop-list-${idx}-${serviceIndex}" style="max-height: 150px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 4px; padding: 6px; background: white;">
                      ${allSOPs.length > 0 ? (() => {
                        // ç­›é€‰ï¼šåªæ˜¾ç¤ºscope=taskä¸”categoryåŒ¹é…çš„SOP
                        const filteredSOPs = allSOPs.filter(sop => 
                          sop.scope === 'task' && 
                          serviceCode &&
                          (sop.category === serviceCode || sop.category === serviceCode.toLowerCase() || sop.category === serviceCode.toUpperCase())
                        );
                        
                        // æŒ‰æ ‡é¢˜æ’åºï¼ˆä¸éœ€è¦åˆ†ç±»ï¼‰
                        const sortedSOPs = filteredSOPs.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                        
                        if (sortedSOPs.length === 0) {
                          return '<div style="color: #9ca3af; font-size: 12px; text-align: center; padding: 10px;">æš«ç„¡é©ç”¨æ–¼æ­¤æœå‹™çš„ä»»å‹™å±¤ç´šSOP</div>';
                        }
                        
                        return sortedSOPs.map(sop => {
                          // ç¡®ä¿ç±»å‹åŒ¹é…ï¼šå°†sop_idsæ•°ç»„ä¸­çš„å€¼è½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒ
                          const isChecked = task.sop_ids && task.sop_ids.map(id => parseInt(id)).includes(parseInt(sop.sop_id));
                          return `
                            <label class="sop-option" data-sop-title="${sop.title.toLowerCase()}"
                                   style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; font-size: 13px; margin-bottom: 4px; border-radius: 4px; border: 1px solid ${isChecked ? '#3b82f6' : '#e5e7eb'}; background: ${isChecked ? '#eff6ff' : 'white'};" 
                                   onmouseover="if(!this.querySelector('input').checked) this.style.background='#f3f4f6'" 
                                   onmouseout="if(!this.querySelector('input').checked) this.style.background='white'">
                              <input type="checkbox" value="${sop.sop_id}" 
                                     ${isChecked ? 'checked' : ''}
                                     onchange="updateTaskSOPs${serviceIndex}(${idx}, this)"
                                     style="cursor: pointer; flex-shrink: 0; width: 16px; height: 16px;" />
                              <span style="color: #374151;">${sop.title}</span>
                            </label>
                          `;
                        }).join('');
                      })() : '<div style="color: #9ca3af; font-size: 12px; text-align: center; padding: 10px;">æš«ç„¡SOP</div>'}
                    </div>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">â±ï¸ é ä¼°å·¥æ™‚</label>
                    <input type="number" min="0" step="0.5" value="${task.estimated_hours || ''}" placeholder="ä¾‹å¦‚ï¼š2"
                           style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                           onchange="window.customTasks${serviceIndex}[${idx}].estimated_hours = this.value" />
                    <small style="display: block; margin-top: 3px; font-size: 11px; color: #6b7280;">å°æ™‚</small>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“† æå‰ç”Ÿæˆ</label>
                    <input type="number" min="0" value="${task.advance_days || 7}" placeholder="7"
                           style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                           onchange="window.customTasks${serviceIndex}[${idx}].advance_days = this.value" />
                    <small style="display: block; margin-top: 3px; font-size: 11px; color: #6b7280;">å¤©å‰ç”Ÿæˆ</small>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“… æœŸé™è¦å‰‡</label>
                    <select style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                            onchange="window.customTasks${serviceIndex}[${idx}].due_rule = this.value; window.updateCustomTaskDisplay${serviceIndex}(${idx})">
                      <option value="end_of_month" ${task.due_rule === 'end_of_month' ? 'selected' : ''}>æ¯æœˆæœ€å¾Œä¸€å¤©</option>
                      <option value="specific_day" ${task.due_rule === 'specific_day' ? 'selected' : ''}>æ¯æœˆå›ºå®šæ—¥æœŸ</option>
                      <option value="next_month_day" ${task.due_rule === 'next_month_day' ? 'selected' : ''}>æ¬¡æœˆå›ºå®šæ—¥æœŸ</option>
                      <option value="days_after_start" ${task.due_rule === 'days_after_start' ? 'selected' : ''}>å¾æœˆåˆèµ·ç®—å¤©æ•¸</option>
                    </select>
                    <small id="custom-task-display-${idx}-${serviceIndex}" style="display: block; margin-top: 3px; font-size: 11px; color: #3b82f6;"></small>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“Š æ—¥æœŸ/å¤©æ•¸</label>
                    <input type="number" min="1" max="31" placeholder="è«‹è¼¸å…¥" value="${task.due_value || ''}"
                           style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                           onchange="window.customTasks${serviceIndex}[${idx}].due_value = this.value; window.updateCustomTaskDisplay${serviceIndex}(${idx})" />
                  </div>
                </div>
                
                <div style="margin-top: 10px; display: flex; justify-content: flex-end;">
                  <button type="button" class="table-btn-link danger" onclick="removeCustomTask${serviceIndex}(${idx})">ğŸ—‘ï¸ åˆªé™¤æ­¤ä»»å‹™</button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
        // åˆå§‹åŒ–æœŸé™æ˜¾ç¤ºå’Œå·²é€‰æ‹©SOPæ ‡ç­¾
        tasks.forEach((task, idx) => {
          setTimeout(() => {
            window[`updateCustomTaskDisplay${serviceIndex}`](idx);
            window[`renderSelectedTaskSOPs${serviceIndex}`](idx);
          }, 50);
        });
      };
      
      // åˆ›å»ºæ‰‹åŠ¨æ·»åŠ ä»»åŠ¡çš„å‡½æ•°
      window[`addCustomTask${serviceIndex}`] = function() {
        if (!window[`customTasks${serviceIndex}`]) {
          window[`customTasks${serviceIndex}`] = [];
        }
        
        const tasks = window[`customTasks${serviceIndex}`];
        tasks.push({
          name: '',
          due_rule: 'end_of_month',
          due_value: '',
          estimated_hours: '',
          advance_days: 7,
          assignee_user_id: '',
          sop_ids: [],
          fromTemplate: false
        });
        
        // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        window[`renderTasksList${serviceIndex}`]();
      };
      
      // åˆ é™¤è‡ªå®šä¹‰ä»»åŠ¡
      window[`removeCustomTask${serviceIndex}`] = function(idx) {
        if (window[`customTasks${serviceIndex}`]) {
          window[`customTasks${serviceIndex}`].splice(idx, 1);
          // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
          window[`renderTasksList${serviceIndex}`]();
        }
      };
      
      // æ›´æ–°ä»»åŠ¡çš„SOPåˆ—è¡¨
      window[`updateTaskSOPs${serviceIndex}`] = function(idx, checkbox) {
        const task = window[`customTasks${serviceIndex}`]?.[idx];
        if (!task) return;
        
        if (!task.sop_ids) {
          task.sop_ids = [];
        }
        
        const sopId = parseInt(checkbox.value);
        if (checkbox.checked) {
          if (!task.sop_ids.includes(sopId)) {
            task.sop_ids.push(sopId);
          }
        } else {
          task.sop_ids = task.sop_ids.filter(id => id !== sopId);
        }
        
        // æ›´æ–°å·²é€‰æ‹©çš„SOPæ ‡ç­¾æ˜¾ç¤º
        window[`renderSelectedTaskSOPs${serviceIndex}`](idx);
      };
      
      // æ¸²æŸ“å·²é€‰æ‹©çš„ä»»åŠ¡SOPæ ‡ç­¾
      window[`renderSelectedTaskSOPs${serviceIndex}`] = function(idx) {
        const task = window[`customTasks${serviceIndex}`]?.[idx];
        if (!task) return;
        
        const container = document.getElementById(`selected-sops-${idx}-${serviceIndex}`);
        if (!container) return;
        
        if (!task.sop_ids || task.sop_ids.length === 0) {
          container.innerHTML = '<span style="color: #9ca3af; font-size: 11px;">å°šæœªé¸æ“‡SOP</span>';
          return;
        }
        
        // æ¸²æŸ“æ ‡ç­¾
        const tags = task.sop_ids.map(sopId => {
          const sop = allSOPs.find(s => s.sop_id === sopId);
          if (!sop) return '';
          
          return `
            <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 11px;">
              ${sop.title}
              <button type="button" 
                      onclick="removeTaskSOP${serviceIndex}(${idx}, ${sopId})"
                      style="border: none; background: none; color: #1e40af; cursor: pointer; padding: 0; font-size: 14px; line-height: 1;"
                      title="ç§»é™¤">Ã—</button>
            </span>
          `;
        }).join('');
        
        container.innerHTML = tags;
      };
      
      // ç§»é™¤ä»»åŠ¡SOP
      window[`removeTaskSOP${serviceIndex}`] = function(idx, sopId) {
        const task = window[`customTasks${serviceIndex}`]?.[idx];
        if (!task) return;
        
        task.sop_ids = task.sop_ids.filter(id => id !== sopId);
        
        // å–æ¶ˆå¯¹åº”çš„checkbox
        const listContainer = document.getElementById(`task-sop-list-${idx}-${serviceIndex}`);
        if (listContainer) {
          const checkbox = listContainer.querySelector(`input[value="${sopId}"]`);
          if (checkbox) checkbox.checked = false;
        }
        
        // æ›´æ–°æ ‡ç­¾æ˜¾ç¤º
        window[`renderSelectedTaskSOPs${serviceIndex}`](idx);
      };
      
      // è¿‡æ»¤ä»»åŠ¡SOPåˆ—è¡¨
      window[`filterTaskSOPs${serviceIndex}`] = function(idx, searchTerm) {
        const listContainer = document.getElementById(`task-sop-list-${idx}-${serviceIndex}`);
        if (!listContainer) return;
        
        const term = searchTerm.toLowerCase().trim();
        const options = listContainer.querySelectorAll('.sop-option');
        
        let visibleCount = 0;
        options.forEach(option => {
          const title = option.getAttribute('data-sop-title');
          if (!term || title.includes(term)) {
            option.style.display = 'flex';
            visibleCount++;
          } else {
            option.style.display = 'none';
          }
        });
      };
      
      // æ›´æ–°æœåŠ¡ç»„ä»¶SOPé€‰æ‹©ï¼ˆå¤šé€‰æ¨¡å¼ï¼‰
      window[`updateCompSOPSelection${serviceIndex}`] = function(clickedCheckbox) {
        const container = document.getElementById(`selected-comp-sops-${serviceIndex}`);
        if (!container) return;
        
        const checkboxes = document.querySelectorAll('.comp-sop-checkbox:checked');
        
        if (checkboxes.length === 0) {
          container.innerHTML = '<span style="color: #9ca3af; font-size: 11px;">å°šæœªé¸æ“‡SOP</span>';
          return;
        }
        
        // æ˜¾ç¤ºæ‰€æœ‰é€‰ä¸­çš„SOPæ ‡ç­¾
        const tags = Array.from(checkboxes).map(checkbox => {
          const sopId = parseInt(checkbox.value);
          const sop = allSOPs.find(s => s.sop_id === sopId);
          if (!sop) return '';
          
          return `
            <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 11px;">
              ${sop.title}
              <button type="button" 
                      onclick="removeCompSOP${serviceIndex}(${sopId})"
                      style="border: none; background: none; color: #1e40af; cursor: pointer; padding: 0; font-size: 14px; line-height: 1;"
                      title="ç§»é™¤">Ã—</button>
            </span>
          `;
        }).join('');
        
        container.innerHTML = tags;
      };
      
      // ç§»é™¤æœåŠ¡ç»„ä»¶SOP
      window[`removeCompSOP${serviceIndex}`] = function(sopId) {
        const checkbox = document.querySelector(`.comp-sop-checkbox[value="${sopId}"]`);
        if (checkbox) {
          checkbox.checked = false;
          window[`updateCompSOPSelection${serviceIndex}`](null);
        }
      };
      
      // è¿‡æ»¤æœåŠ¡ç»„ä»¶SOPåˆ—è¡¨
      window[`filterCompSOPs${serviceIndex}`] = function(searchTerm) {
        const listContainer = document.getElementById(`new-comp-sop-list-${serviceIndex}`);
        if (!listContainer) return;
        
        const term = searchTerm.toLowerCase().trim();
        const options = listContainer.querySelectorAll('.comp-sop-option');
        
        options.forEach(option => {
          const title = option.getAttribute('data-sop-title');
          if (!term || title.includes(term)) {
            option.style.display = 'flex';
          } else {
            option.style.display = 'none';
          }
        });
      };
      
      // æ‰¹é‡è®¾ç½®è´Ÿè´£äºº
      window[`batchAssignTasks${serviceIndex}`] = function() {
        const batchAssigneeSelect = document.getElementById(`batch-assignee-${serviceIndex}`);
        const assigneeUserId = batchAssigneeSelect.value;
        
        if (!assigneeUserId) {
          alert('è«‹å…ˆé¸æ“‡è² è²¬äººå“¡');
          return;
        }
        
        const tasks = window[`customTasks${serviceIndex}`];
        if (!tasks || tasks.length === 0) {
          alert('ç›®å‰æ²’æœ‰ä»»å‹™å¯ä»¥è¨­ç½®');
          return;
        }
        
        // è·å–é€‰ä¸­çš„å‘˜å·¥åç§°
        const selectedOption = batchAssigneeSelect.options[batchAssigneeSelect.selectedIndex];
        const assigneeName = selectedOption.textContent;
        
        if (confirm(`ç¢ºå®šè¦å°‡æ‰€æœ‰ ${tasks.length} å€‹ä»»å‹™çš„è² è²¬äººè¨­ç½®ç‚ºã€Œ${assigneeName}ã€å—ï¼Ÿ\n\nä¹‹å¾Œæ‚¨ä»å¯å–®ç¨ä¿®æ”¹å€‹åˆ¥ä»»å‹™çš„è² è²¬äººã€‚`)) {
          // æ‰¹é‡è®¾ç½®æ‰€æœ‰ä»»åŠ¡çš„è´Ÿè´£äºº
          tasks.forEach(task => {
            task.assignee_user_id = assigneeUserId;
          });
          
          // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
          window[`renderTasksList${serviceIndex}`]();
          
          alert(`å·²æˆåŠŸå°‡æ‰€æœ‰ä»»å‹™çš„è² è²¬äººè¨­ç½®ç‚ºã€Œ${assigneeName}ã€`);
        }
      };
      
      // æ›´æ–°è‡ªå®šä¹‰ä»»åŠ¡çš„æœŸé™æ˜¾ç¤º
      window[`updateCustomTaskDisplay${serviceIndex}`] = function(idx) {
        const task = window[`customTasks${serviceIndex}`]?.[idx];
        if (!task) return;
        
        const display = document.getElementById(`custom-task-display-${idx}-${serviceIndex}`);
        if (!display) return;
        
        let text = '';
        switch(task.due_rule) {
          case 'end_of_month':
            text = 'ä¾‹ï¼š1æœˆ31æ—¥ã€2æœˆ28æ—¥ã€3æœˆ31æ—¥';
            break;
          case 'specific_day':
            text = task.due_value ? `ä¾‹ï¼šæ¯æœˆ${task.due_value}æ—¥` : 'è«‹å¡«å¯«æ—¥æœŸ';
            break;
          case 'next_month_day':
            text = task.due_value ? `ä¾‹ï¼š1æœˆåŸ·è¡Œâ†’2/${task.due_value}ã€2æœˆåŸ·è¡Œâ†’3/${task.due_value}` : 'è«‹å¡«å¯«æ—¥æœŸ';
            break;
          case 'days_after_start':
            text = task.due_value ? `ä¾‹ï¼šæœˆåˆå¾Œç¬¬${task.due_value}å¤©` : 'è«‹å¡«å¯«å¤©æ•¸';
            break;
        }
        display.textContent = text;
      };
      
      // åˆå§‹åŒ–ä»»åŠ¡é…ç½®åŒºåŸŸï¼ˆé»˜è®¤æ‰‹åŠ¨æ¨¡å¼ï¼‰
      window[`loadTemplateStages${serviceIndex}`]('');
      
      // æ¸²æŸ“SOPåˆ—è¡¨ï¼ˆæœåŠ¡å±‚çº§SOPï¼‰
      const sopListContainer = document.getElementById(`new-comp-sop-list-${serviceIndex}`);
      if (sopListContainer && allSOPs && allSOPs.length > 0) {
        // è·å–å½“å‰æœåŠ¡çš„service_code
        const currentService = tempServices[serviceIndex];
        const currentServiceType = allServices.find(st => st.service_id === currentService?.service_id);
        const serviceCode = currentServiceType?.service_code || '';
        
        // ç­›é€‰ï¼šåªæ˜¾ç¤ºscope=serviceä¸”categoryåŒ¹é…çš„SOP
        const filteredSOPs = allSOPs.filter(sop => 
          sop.scope === 'service' && 
          serviceCode &&
          (sop.category === serviceCode || sop.category === serviceCode.toLowerCase() || sop.category === serviceCode.toUpperCase())
        );
        
        // æŒ‰æ ‡é¢˜æ’åºï¼ˆä¸éœ€è¦åˆ†ç±»ï¼‰
        const sortedSOPs = filteredSOPs.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
        
        let html = '';
        sortedSOPs.forEach(sop => {
          const sopTitle = sop.title || 'æœªå‘½å';
          html += '<label class="comp-sop-option" data-sop-title="' + sopTitle.toLowerCase() + '" style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; font-size: 13px; margin-bottom: 6px; border-radius: 4px; border: 1px solid #e5e7eb;" onmouseover="this.style.background=\'#f3f4f6\'" onmouseout="this.style.background=\'white\'">';
          html += '<input type="checkbox" class="comp-sop-checkbox" value="' + sop.sop_id + '" style="cursor: pointer; flex-shrink: 0; width: 16px; height: 16px; margin: 0; padding: 0;" onchange="updateCompSOPSelection' + serviceIndex + '(this)" />';
          html += '<span style="color: #374151; line-height: 1.3;">' + sopTitle + '</span>';
          html += '</label>';
        });
        
        sopListContainer.innerHTML = html || '<div style="color: #9ca3af; text-align: center; padding: 20px;">æš«ç„¡é©ç”¨æ–¼æ­¤æœå‹™çš„æœå‹™å±¤ç´šSOP</div>';
      } else {
        sopListContainer.innerHTML = '<div style="color: #9ca3af; text-align: center; padding: 20px;">æš«ç„¡SOP</div>';
      }
    }
    
    // å–æ¶ˆæ–°å¢ï¼ˆæ–°å¢æ¨¡å¼ï¼‰
    function cancelAddComponent(serviceIndex) {
      const form = document.getElementById(`add-component-form-${serviceIndex}`);
      if (!form) return;
      form.style.display = 'none';
      
      // æ¸…ç©ºè‡ªå®šä¹‰ä»»åŠ¡
      window[`customTasks${serviceIndex}`] = [];
      if (document.getElementById(`tasks-list-${serviceIndex}`)) {
        document.getElementById(`tasks-list-${serviceIndex}`).innerHTML = '';
      }
      
      // æ¸…ç©ºSOPé€‰æ‹©
      const sopCheckboxes = document.querySelectorAll(`#new-comp-sop-list-${serviceIndex} input[type="checkbox"]`);
      sopCheckboxes.forEach(cb => cb.checked = false);
    }

    // å„²å­˜æ–°æœå‹™çµ„æˆéƒ¨åˆ†ï¼ˆæ–°å¢æ¨¡å¼ï¼šä¿å­˜åˆ° tempServicesï¼‰
    function saveNewComponent(serviceIndex) {
      const svc = tempServices[serviceIndex];
      if (!svc) {
        alert('ç„¡æ³•ç²å–æœå‹™ä¿¡æ¯');
        return;
      }
      
      const serviceId = svc.service_id;
      if (!serviceId) {
        alert('ç„¡æ³•ç²å–æœå‹™ä¿¡æ¯ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢');
        return;
      }
      
      // ç²å–è‡ªå®šç¾©ä»»å‹™é…ç½®
      const tasks = window[`customTasks${serviceIndex}`] || [];
      
      // æ”¶é›†é€‰ä¸­çš„æœåŠ¡çº§åˆ«SOPï¼ˆæ”¯æŒå¤šé€‰ï¼‰
      const sopCheckboxes = document.querySelectorAll(`#new-comp-sop-list-${serviceIndex} .comp-sop-checkbox:checked`);
      const component_sop_ids = Array.from(sopCheckboxes)
        .map(cb => parseInt(cb.value))
        .filter(id => !isNaN(id) && id > 0);

      // éªŒè¯ï¼šè‡³å°‘è¦æœ‰ä»»åŠ¡é…ç½®
      if (tasks.length === 0) {
        alert('è«‹è‡³å°‘æ–°å¢ä¸€å€‹ä»»å‹™');
        return;
      }

      // ä¿å­˜åˆ° tempServicesï¼ˆåœ¨æ–°å¢å®¢æˆ¶æ™‚ä¸€ä½µæäº¤ï¼‰
      if (!svc.components) {
        svc.components = [];
      }
      
      svc.components.push({
        component_name: 'ä»»å‹™é…ç½®',
        service_id: parseInt(serviceId),
        service_item_id: null,
        delivery_frequency: 'monthly',
        task_template_id: null,
        due_date_rule: 'end_of_month',
        due_date_value: null,
        estimated_hours: null,
        advance_days: 7,
        component_sops: allSOPs.filter(sop => component_sop_ids.includes(sop.sop_id)),  // ä¿å­˜å®Œæ•´å°è±¡ä»¥ä¾¿é¡¯ç¤º
        component_sop_ids: component_sop_ids,
        auto_generate_task: true,
        tasks: tasks.map(task => ({
          task_name: task.name,
          due_rule: task.due_rule,
          due_value: task.due_value ? parseInt(task.due_value) : null,
          estimated_hours: task.estimated_hours ? parseFloat(task.estimated_hours) : null,
          advance_days: task.advance_days ? parseInt(task.advance_days) : 7,
          assignee_user_id: task.assignee_user_id ? parseInt(task.assignee_user_id) : null,
          sops: allSOPs.filter(sop => (task.sop_ids || []).includes(sop.sop_id)),  // ä¿å­˜å®Œæ•´å°è±¡ä»¥ä¾¿é¡¯ç¤º
          sop_ids: (task.sop_ids || []).filter(id => !isNaN(id) && id > 0),
          notes: task.notes || ''
        }))
      });

      alert('ä»»å‹™é…ç½®å·²å„²å­˜ï¼ˆå°‡åœ¨æ–°å¢å®¢æˆ¶æ™‚ä¸€ä½µæäº¤ï¼‰');
      cancelAddComponent(serviceIndex);
      
      // é‡æ–°è¼‰å…¥çµ„ä»¶å€åŸŸä»¥é¡¯ç¤ºæ–°å¢çš„é…ç½®
      loadComponentsInline(serviceIndex);
    }
    
    // åˆªé™¤æœ¬åœ°çµ„ä»¶é…ç½®ï¼ˆæ–°å¢æ¨¡å¼ï¼‰
    function deleteLocalComponent(serviceIndex, compIndex) {
      const svc = tempServices[serviceIndex];
      if (!svc || !Array.isArray(svc.components)) return;
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é…ç½®å—ï¼Ÿ')) return;
      svc.components.splice(compIndex, 1);
      // é‡æ–°è¼‰å…¥çµ„ä»¶å€åŸŸ
      loadComponentsInline(serviceIndex);
    }
    
    // âŒ ä»¥ä¸‹ç‚ºèˆŠçš„è©³æƒ…é ä»£ç¢¼ï¼Œä¿ç•™ä»¥é˜²è¬ä¸€
    function __oldShowAddComponentForm(clientServiceId) {
      const form = document.getElementById(`add-component-form-${clientServiceId}`);
      if (!form) return;
      form.style.display = 'block';
      
      // åˆ›å»ºæœåŠ¡é¡¹è¿‡æ»¤æ¨¡æ¿çš„å‡½æ•°
      window[`filterTemplatesByServiceItem${clientServiceId}`] = function() {
        const serviceItemSelect = document.getElementById(`new-comp-service-item-${clientServiceId}`);
        const templateSelect = document.getElementById(`new-comp-template-${clientServiceId}`);
        const selectedOption = serviceItemSelect.options[serviceItemSelect.selectedIndex];
        
        if (!selectedOption || !selectedOption.value) {
          // å¦‚æœæ²¡æœ‰é€‰æ‹©æœåŠ¡é¡¹ï¼Œæ¸…ç©ºæ¨¡æ¿é€‰é¡¹
          templateSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æœå‹™é …ç›®</option>';
          return;
        }
        
        // è·å–é€‰ä¸­æœåŠ¡é¡¹çš„ service_id
        const serviceId = selectedOption.getAttribute('data-service-id');
        
        // è¿‡æ»¤æ¨¡æ¿ï¼šåªæ˜¾ç¤ºåŒ¹é…çš„æœåŠ¡ç±»å‹æˆ–æ²¡æœ‰æŒ‡å®šæœåŠ¡ç±»å‹çš„æ¨¡æ¿
        const filteredTemplates = allTemplates.filter(t => !t.service_id || t.service_id == serviceId);
        
        // æ›´æ–°æ¨¡æ¿é€‰é¡¹
        templateSelect.innerHTML = '<option value="">ä¸ä½¿ç”¨æ¨¡æ¿ï¼ˆæ‰‹å‹•é…ç½®ï¼‰</option>';
        filteredTemplates.forEach(t => {
          const option = document.createElement('option');
          option.value = t.template_id;
          option.textContent = t.template_name;
          templateSelect.appendChild(option);
        });
      };
      
      // åˆ›å»ºæœŸé™æ—¥æœŸé¢„è§ˆå‡½æ•°
      window[`updateDueDatePreview${clientServiceId}`] = function() {
        const rule = document.getElementById(`new-comp-due-rule-${clientServiceId}`).value;
        const value = document.getElementById(`new-comp-due-value-${clientServiceId}`).value;
        const previewText = document.getElementById(`preview-text-${clientServiceId}`);
        const valueField = document.getElementById(`due-value-field-${clientServiceId}`);
        
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth() + 1;
        const nextMonth = currentMonth === 12 ? 1 : currentMonth + 1;
        
        let examples = [];
        
        switch(rule) {
          case 'end_of_month':
            valueField.style.display = 'none';
            examples = [
              `1æœˆåŸ·è¡Œ â†’ 1/31åˆ°æœŸ`,
              `2æœˆåŸ·è¡Œ â†’ 2/28åˆ°æœŸ`,
              `3æœˆåŸ·è¡Œ â†’ 3/31åˆ°æœŸ`
            ];
            previewText.innerHTML = examples.join('<br>');
            break;
            
          case 'specific_day':
            valueField.style.display = 'block';
            if (value && value >= 1 && value <= 31) {
              examples = [
                `1æœˆåŸ·è¡Œ â†’ 1/${value}åˆ°æœŸ`,
                `2æœˆåŸ·è¡Œ â†’ 2/${value}åˆ°æœŸ`,
                `${currentMonth}æœˆåŸ·è¡Œ â†’ ${currentMonth}/${value}åˆ°æœŸ`
              ];
              previewText.innerHTML = `<span style="color: #059669; font-weight: 600;">æ¯æœˆ${value}æ—¥åˆ°æœŸ</span><br><span style="font-size: 13px;">${examples.join(' | ')}</span>`;
            } else {
              previewText.innerHTML = 'è«‹è¼¸å…¥1-31çš„æ—¥æœŸï¼Œä¾‹å¦‚ï¼š5ï¼ˆä»£è¡¨æ¯æœˆ5æ—¥åˆ°æœŸï¼‰';
              previewText.style.color = '#9ca3af';
            }
            break;
            
          case 'next_month_day':
            valueField.style.display = 'block';
            if (value && value >= 1 && value <= 31) {
              examples = [
                `1æœˆåŸ·è¡Œ â†’ 2/${value}åˆ°æœŸ`,
                `2æœˆåŸ·è¡Œ â†’ 3/${value}åˆ°æœŸ`,
                `${currentMonth}æœˆåŸ·è¡Œ â†’ ${nextMonth}/${value}åˆ°æœŸ`
              ];
              previewText.innerHTML = `<span style="color: #059669; font-weight: 600;">æ¬¡æœˆ${value}æ—¥åˆ°æœŸ</span><br><span style="font-size: 13px;">${examples.join(' | ')}</span>`;
            } else {
              previewText.innerHTML = 'è«‹è¼¸å…¥1-31çš„æ—¥æœŸï¼Œä¾‹å¦‚ï¼š15ï¼ˆä»£è¡¨æ¬¡æœˆ15æ—¥åˆ°æœŸï¼‰';
              previewText.style.color = '#9ca3af';
            }
            break;
            
          case 'days_after_start':
            valueField.style.display = 'block';
            if (value && value >= 1) {
              const exampleDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
              exampleDate.setDate(exampleDate.getDate() + parseInt(value));
              examples = [
                `1æœˆ1æ—¥ + ${value}å¤© â†’ ${exampleDate.getMonth() === 0 ? '1' : exampleDate.getMonth() + 1}/${exampleDate.getDate()}`,
                `å¾æ¯æœˆ1æ—¥èµ·ç®—${value}å¤©å¾Œåˆ°æœŸ`
              ];
              previewText.innerHTML = `<span style="color: #059669; font-weight: 600;">æœˆåˆå¾Œ${value}å¤©åˆ°æœŸ</span><br><span style="font-size: 13px;">${examples.join('<br>')}</span>`;
            } else {
              previewText.innerHTML = 'è«‹è¼¸å…¥å¤©æ•¸ï¼Œä¾‹å¦‚ï¼š30ï¼ˆä»£è¡¨å¾æœˆåˆèµ·ç®—30å¤©å¾Œåˆ°æœŸï¼‰';
              previewText.style.color = '#9ca3af';
            }
            break;
        }
      };
      
      // åˆ›å»ºåŠ è½½æ¨¡æ¿é˜¶æ®µçš„å‡½æ•°
      window[`loadTemplateStages${clientServiceId}`] = async function(templateId) {
        const tasksContainer = document.getElementById(`tasks-config-${clientServiceId}`);
        const tasksList = document.getElementById(`tasks-list-${clientServiceId}`);
        const templateHint = document.getElementById(`template-hint-${clientServiceId}`);
        
        // åˆå§‹åŒ–ä»»åŠ¡æ•°ç»„
        if (!window[`customTasks${clientServiceId}`]) {
          window[`customTasks${clientServiceId}`] = [];
        }
        
        if (!templateId) {
          // æ²¡æœ‰é€‰æ‹©æ¨¡æ¿
          templateHint.textContent = 'æœªä½¿ç”¨æ¨¡æ¿ï¼Œæ‰‹å‹•é…ç½®ä»»å‹™';
          window[`customTasks${clientServiceId}`] = [];
          // åˆå§‹åŒ–ä¸€ä¸ªç©ºä»»åŠ¡
          window[`addCustomTask${clientServiceId}`]();
          return;
        }
        
        // é€‰æ‹©äº†æ¨¡æ¿
        templateHint.innerHTML = '<strong>âœ¨ å·²é¸æ“‡æ¨¡æ¿</strong>ï¼Œä»¥ä¸‹ä»»å‹™ä¾†è‡ªæ¨¡æ¿ä¸¦å¯è‡ªç”±ç·¨è¼¯ï¼ˆä¸å½±éŸ¿åŸå§‹æ¨¡æ¿ï¼‰';
        
        tasksList.innerHTML = '<p style="color: #6b7280; font-size: 14px;">è¼‰å…¥ä¸­...</p>';
        
        try {
          const res = await fetch(`/internal/api/v1/task-templates/${templateId}/stages`);
          const json = await res.json();
          
          if (!json.ok || !json.data) {
            tasksList.innerHTML = '<p style="color: #ef4444; font-size: 14px;">è¼‰å…¥å¤±æ•—</p>';
            return;
          }
          
          const stages = json.data;
          
          if (stages.length === 0) {
            tasksList.innerHTML = '<p style="color: #6b7280; font-size: 14px;">æ­¤æ¨¡æ¿æš«ç„¡éšæ®µè¨­å®š</p>';
            window[`addCustomTask${clientServiceId}`]();
            return;
          }
          
          // å°†æ¨¡æ¿é˜¶æ®µè½¬æ¢ä¸ºå¯ç¼–è¾‘ä»»åŠ¡
          window[`customTasks${clientServiceId}`] = stages.map((stage, idx) => ({
            name: stage.stage_name,
            description: stage.description || '',
            due_rule: stage.due_date_rule || 'end_of_month',
            due_value: stage.due_date_value || '',
            estimated_hours: stage.estimated_hours || '',
            advance_days: stage.advance_days || 7,
            assignee_user_id: '',
            sop_ids: stage.sop_id ? [stage.sop_id] : [],  // å…¼å®¹æ—§çš„å•ä¸€SOP
            stage_order: stage.stage_order || (idx + 1),
            fromTemplate: true
          }));
          
          // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
          window[`renderTasksList${clientServiceId}`]();
          
        } catch (err) {
          console.error('è¼‰å…¥æ¨¡æ¿éšæ®µå¤±æ•—:', err);
          tasksList.innerHTML = '<p style="color: #ef4444; font-size: 14px;">è¼‰å…¥å¤±æ•—</p>';
        }
      };
      
      // åˆ›å»ºç»Ÿä¸€çš„ä»»åŠ¡åˆ—è¡¨æ¸²æŸ“å‡½æ•°
      window[`renderTasksList${clientServiceId}`] = function() {
        const tasksList = document.getElementById(`tasks-list-${clientServiceId}`);
        const tasks = window[`customTasks${clientServiceId}`] || [];
        
        if (tasks.length === 0) {
          tasksList.innerHTML = `
            <div style="padding: 20px; text-align: center; background: #fef3c7; border-radius: 8px; border: 2px dashed #fbbf24;">
              <p style="color: #92400e; font-size: 14px; margin: 0 0 10px 0; font-weight: 500;">
                âš ï¸ å°šæœªé…ç½®ä»»ä½•ä»»å‹™
              </p>
              <p style="color: #92400e; font-size: 13px; margin: 0;">
                é»æ“Šä¸Šæ–¹ã€Œ<strong>+ æ–°å¢ä»»å‹™</strong>ã€æŒ‰éˆ•é–‹å§‹é…ç½®
              </p>
            </div>
          `;
          return;
        }
        
        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        tasksList.innerHTML = tasks.map((task, idx) => `
          <div id="custom-task-${idx}-${clientServiceId}" style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid ${task.fromTemplate ? '#3b82f6' : '#d1d5db'};">
            <div style="display: flex; align-items: start; gap: 15px;">
              <div style="flex-shrink: 0; width: 30px; height: 30px; background: ${task.fromTemplate ? '#3b82f6' : '#6b7280'}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                ${task.stage_order || idx + 1}
              </div>
              <div style="flex: 1;">
                <div style="margin-bottom: 10px;">
                  <input type="text" placeholder="ä»»å‹™åç¨±" value="${task.name || ''}"
                         style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; font-weight: 500;"
                         onchange="window.customTasks${clientServiceId}[${idx}].name = this.value" />
                  ${task.description ? `<p style="margin: 4px 0 0 0; font-size: 12px; color: #6b7280;">${task.description}</p>` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ‘¤ è² è²¬äººå“¡</label>
                    <select style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                            onchange="window.customTasks${clientServiceId}[${idx}].assignee_user_id = this.value">
                      <option value="">æœªæŒ‡å®š</option>
                      ${allUsers.map(u => `<option value="${u.user_id}" ${task.assignee_user_id == u.user_id ? 'selected' : ''}>${u.username}</option>`).join('')}
                    </select>
                  </div>
                  <div style="grid-column: span 2;">
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“– ä»»å‹™SOPï¼ˆå¯é¸ï¼Œå¯å¤šé¸ï¼‰</label>
                    
                    <!-- å·²é€‰æ‹©çš„SOPæ ‡ç­¾ -->
                    <div id="selected-sops-${idx}-${clientServiceId}" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; min-height: 28px;">
                      <!-- åŠ¨æ€å¡«å……å·²é€‰æ‹©çš„SOPæ ‡ç­¾ -->
                    </div>
                    
                    <!-- æœç´¢æ¡† -->
                    <input type="text" 
                           id="sop-search-${idx}-${clientServiceId}"
                           placeholder="ğŸ” æœå°‹SOP..." 
                           style="width: 100%; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; margin-bottom: 6px;"
                           onkeyup="filterTaskSOPs${clientServiceId}(${idx}, this.value)" />
                    
                    <!-- SOPåˆ—è¡¨ -->
                    <div id="task-sop-list-${idx}-${clientServiceId}" style="max-height: 150px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 4px; padding: 6px; background: white;">
                      ${allSOPs.length > 0 ? (() => {
                        // è·å–å½“å‰æœåŠ¡çš„service_code
                        const currentService = clientDetail.services.find(s => s.client_service_id === clientServiceId);
                        const currentServiceType = allServices.find(st => st.service_id === currentService?.service_id);
                        const serviceCode = currentServiceType?.service_code || '';
                        
                        // ç­›é€‰ï¼šåªæ˜¾ç¤ºscope=taskä¸”categoryåŒ¹é…çš„SOP
                        const filteredSOPs = allSOPs.filter(sop => 
                          sop.scope === 'task' && 
                          serviceCode &&
                          (sop.category === serviceCode || sop.category === serviceCode.toLowerCase() || sop.category === serviceCode.toUpperCase())
                        );
                        
                        // æŒ‰æ ‡é¢˜æ’åºï¼ˆä¸éœ€è¦åˆ†ç±»ï¼‰
                        const sortedSOPs = filteredSOPs.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                        
                        if (sortedSOPs.length === 0) {
                          return '<div style="color: #9ca3af; font-size: 12px; text-align: center; padding: 10px;">æš«ç„¡é©ç”¨æ–¼æ­¤æœå‹™çš„ä»»å‹™å±¤ç´šSOP</div>';
                        }
                        
                        return sortedSOPs.map(sop => {
                          // ç¡®ä¿ç±»å‹åŒ¹é…ï¼šå°†sop_idsæ•°ç»„ä¸­çš„å€¼è½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒ
                          const isChecked = task.sop_ids && task.sop_ids.map(id => parseInt(id)).includes(parseInt(sop.sop_id));
                          return `
                            <label class="sop-option" data-sop-title="${sop.title.toLowerCase()}"
                                   style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; font-size: 13px; margin-bottom: 4px; border-radius: 4px; border: 1px solid ${isChecked ? '#3b82f6' : '#e5e7eb'}; background: ${isChecked ? '#eff6ff' : 'white'};" 
                                   onmouseover="if(!this.querySelector('input').checked) this.style.background='#f3f4f6'" 
                                   onmouseout="if(!this.querySelector('input').checked) this.style.background='white'">
                              <input type="checkbox" value="${sop.sop_id}" 
                                     ${isChecked ? 'checked' : ''}
                                     onchange="updateTaskSOPs${clientServiceId}(${idx}, this)"
                                     style="cursor: pointer; flex-shrink: 0; width: 16px; height: 16px;" />
                              <span style="color: #374151;">${sop.title}</span>
                            </label>
                          `;
                        }).join('');
                      })() : '<div style="color: #9ca3af; font-size: 12px; text-align: center; padding: 10px;">æš«ç„¡SOP</div>'}
                    </div>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">â±ï¸ é ä¼°å·¥æ™‚</label>
                    <input type="number" min="0" step="0.5" value="${task.estimated_hours || ''}" placeholder="ä¾‹å¦‚ï¼š2"
                           style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                           onchange="window.customTasks${clientServiceId}[${idx}].estimated_hours = this.value" />
                    <small style="display: block; margin-top: 3px; font-size: 11px; color: #6b7280;">å°æ™‚</small>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“† æå‰ç”Ÿæˆ</label>
                    <input type="number" min="0" value="${task.advance_days || 7}" placeholder="7"
                           style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                           onchange="window.customTasks${clientServiceId}[${idx}].advance_days = this.value" />
                    <small style="display: block; margin-top: 3px; font-size: 11px; color: #6b7280;">å¤©å‰ç”Ÿæˆ</small>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“… æœŸé™è¦å‰‡</label>
                    <select style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                            onchange="window.customTasks${clientServiceId}[${idx}].due_rule = this.value; window.updateCustomTaskDisplay${clientServiceId}(${idx})">
                      <option value="end_of_month" ${task.due_rule === 'end_of_month' ? 'selected' : ''}>æ¯æœˆæœ€å¾Œä¸€å¤©</option>
                      <option value="specific_day" ${task.due_rule === 'specific_day' ? 'selected' : ''}>æ¯æœˆå›ºå®šæ—¥æœŸ</option>
                      <option value="next_month_day" ${task.due_rule === 'next_month_day' ? 'selected' : ''}>æ¬¡æœˆå›ºå®šæ—¥æœŸ</option>
                      <option value="days_after_start" ${task.due_rule === 'days_after_start' ? 'selected' : ''}>å¾æœˆåˆèµ·ç®—å¤©æ•¸</option>
                    </select>
                    <small id="custom-task-display-${idx}-${clientServiceId}" style="display: block; margin-top: 3px; font-size: 11px; color: #3b82f6;"></small>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“Š æ—¥æœŸ/å¤©æ•¸</label>
                    <input type="number" min="1" max="31" placeholder="è«‹è¼¸å…¥" value="${task.due_value || ''}"
                           style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                           onchange="window.customTasks${clientServiceId}[${idx}].due_value = this.value; window.updateCustomTaskDisplay${clientServiceId}(${idx})" />
                  </div>
                </div>
                
                <div style="margin-top: 10px; display: flex; justify-content: flex-end;">
                  <button type="button" class="table-btn-link danger" onclick="removeCustomTask${clientServiceId}(${idx})">ğŸ—‘ï¸ åˆªé™¤æ­¤ä»»å‹™</button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
        // åˆå§‹åŒ–æœŸé™æ˜¾ç¤ºå’Œå·²é€‰æ‹©SOPæ ‡ç­¾
        tasks.forEach((task, idx) => {
          setTimeout(() => {
            window[`updateCustomTaskDisplay${clientServiceId}`](idx);
            window[`renderSelectedTaskSOPs${clientServiceId}`](idx);
          }, 50);
        });
      };
      
      // åˆ›å»ºæ‰‹åŠ¨æ·»åŠ ä»»åŠ¡çš„å‡½æ•°
      window[`addCustomTask${clientServiceId}`] = function() {
        if (!window[`customTasks${clientServiceId}`]) {
          window[`customTasks${clientServiceId}`] = [];
        }
        
        const tasks = window[`customTasks${clientServiceId}`];
        tasks.push({
          name: '',
          due_rule: 'end_of_month',
          due_value: '',
          estimated_hours: '',
          advance_days: 7,
          assignee_user_id: '',
          sop_ids: [],
          fromTemplate: false
        });
        
        // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        window[`renderTasksList${clientServiceId}`]();
      };
      
      // åˆ é™¤è‡ªå®šä¹‰ä»»åŠ¡
      window[`removeCustomTask${clientServiceId}`] = function(idx) {
        if (window[`customTasks${clientServiceId}`]) {
          window[`customTasks${clientServiceId}`].splice(idx, 1);
          // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
          window[`renderTasksList${clientServiceId}`]();
        }
      };
      
      // æ›´æ–°ä»»åŠ¡çš„SOPåˆ—è¡¨
      window[`updateTaskSOPs${clientServiceId}`] = function(idx, checkbox) {
        const task = window[`customTasks${clientServiceId}`]?.[idx];
        if (!task) return;
        
        if (!task.sop_ids) {
          task.sop_ids = [];
        }
        
        const sopId = parseInt(checkbox.value);
        if (checkbox.checked) {
          if (!task.sop_ids.includes(sopId)) {
            task.sop_ids.push(sopId);
          }
        } else {
          task.sop_ids = task.sop_ids.filter(id => id !== sopId);
        }
        
        // æ›´æ–°å·²é€‰æ‹©çš„SOPæ ‡ç­¾æ˜¾ç¤º
        window[`renderSelectedTaskSOPs${clientServiceId}`](idx);
      };
      
      // æ¸²æŸ“å·²é€‰æ‹©çš„ä»»åŠ¡SOPæ ‡ç­¾
      window[`renderSelectedTaskSOPs${clientServiceId}`] = function(idx) {
        const task = window[`customTasks${clientServiceId}`]?.[idx];
        if (!task) return;
        
        const container = document.getElementById(`selected-sops-${idx}-${clientServiceId}`);
        if (!container) return;
        
        if (!task.sop_ids || task.sop_ids.length === 0) {
          container.innerHTML = '<span style="color: #9ca3af; font-size: 11px;">å°šæœªé¸æ“‡SOP</span>';
          return;
        }
        
        // æ¸²æŸ“æ ‡ç­¾
        const tags = task.sop_ids.map(sopId => {
          const sop = allSOPs.find(s => s.sop_id === sopId);
          if (!sop) return '';
          
          return `
            <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 11px;">
              ${sop.title}
              <button type="button" 
                      onclick="removeTaskSOP${clientServiceId}(${idx}, ${sopId})"
                      style="border: none; background: none; color: #1e40af; cursor: pointer; padding: 0; font-size: 14px; line-height: 1;"
                      title="ç§»é™¤">Ã—</button>
            </span>
          `;
        }).join('');
        
        container.innerHTML = tags;
      };
      
      // ç§»é™¤ä»»åŠ¡SOP
      window[`removeTaskSOP${clientServiceId}`] = function(idx, sopId) {
        const task = window[`customTasks${clientServiceId}`]?.[idx];
        if (!task) return;
        
        task.sop_ids = task.sop_ids.filter(id => id !== sopId);
        
        // å–æ¶ˆå¯¹åº”çš„checkbox
        const listContainer = document.getElementById(`task-sop-list-${idx}-${clientServiceId}`);
        if (listContainer) {
          const checkbox = listContainer.querySelector(`input[value="${sopId}"]`);
          if (checkbox) checkbox.checked = false;
        }
        
        // æ›´æ–°æ ‡ç­¾æ˜¾ç¤º
        window[`renderSelectedTaskSOPs${clientServiceId}`](idx);
      };
      
      // è¿‡æ»¤ä»»åŠ¡SOPåˆ—è¡¨
      window[`filterTaskSOPs${clientServiceId}`] = function(idx, searchTerm) {
        const listContainer = document.getElementById(`task-sop-list-${idx}-${clientServiceId}`);
        if (!listContainer) return;
        
        const term = searchTerm.toLowerCase().trim();
        const options = listContainer.querySelectorAll('.sop-option');
        
        let visibleCount = 0;
        options.forEach(option => {
          const title = option.getAttribute('data-sop-title');
          if (!term || title.includes(term)) {
            option.style.display = 'flex';
            visibleCount++;
          } else {
            option.style.display = 'none';
          }
        });
        
        // éšè—ç©ºåˆ†ç±»
        const categories = listContainer.querySelectorAll('div > div[style*="font-weight: 600"]');
        categories.forEach(catHeader => {
          const categoryDiv = catHeader.parentElement;
          const visibleOptions = Array.from(categoryDiv.querySelectorAll('.sop-option')).filter(o => o.style.display !== 'none');
          categoryDiv.style.display = visibleOptions.length > 0 ? 'block' : 'none';
        });
      };
      
      // æ›´æ–°æœåŠ¡ç»„ä»¶SOPé€‰æ‹©ï¼ˆå¤šé€‰æ¨¡å¼ï¼‰
      window[`updateCompSOPSelection${clientServiceId}`] = function(clickedCheckbox) {
        const container = document.getElementById(`selected-comp-sops-${clientServiceId}`);
        if (!container) return;
        
        const checkboxes = document.querySelectorAll('.comp-sop-checkbox:checked');
        
        if (checkboxes.length === 0) {
          container.innerHTML = '<span style="color: #9ca3af; font-size: 11px;">å°šæœªé¸æ“‡SOP</span>';
          return;
        }
        
        // æ˜¾ç¤ºæ‰€æœ‰é€‰ä¸­çš„SOPæ ‡ç­¾
        const tags = Array.from(checkboxes).map(checkbox => {
          const sopId = parseInt(checkbox.value);
          const sop = allSOPs.find(s => s.sop_id === sopId);
          if (!sop) return '';
          
          return `
            <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 11px;">
              ${sop.title}
              <button type="button" 
                      onclick="removeCompSOP${clientServiceId}(${sopId})"
                      style="border: none; background: none; color: #1e40af; cursor: pointer; padding: 0; font-size: 14px; line-height: 1;"
                      title="ç§»é™¤">Ã—</button>
            </span>
          `;
        }).join('');
        
        container.innerHTML = tags;
      };
      
      // ç§»é™¤æœåŠ¡ç»„ä»¶SOP
      window[`removeCompSOP${clientServiceId}`] = function(sopId) {
        const checkbox = document.querySelector(`.comp-sop-checkbox[value="${sopId}"]`);
        if (checkbox) {
          checkbox.checked = false;
          window[`updateCompSOPSelection${clientServiceId}`](null);
        }
      };
      
      // è¿‡æ»¤æœåŠ¡ç»„ä»¶SOPåˆ—è¡¨
      window[`filterCompSOPs${clientServiceId}`] = function(searchTerm) {
        const listContainer = document.getElementById(`new-comp-sop-list-${clientServiceId}`);
        if (!listContainer) return;
        
        const term = searchTerm.toLowerCase().trim();
        const options = listContainer.querySelectorAll('.comp-sop-option');
        
        options.forEach(option => {
          const title = option.getAttribute('data-sop-title');
          if (!term || title.includes(term)) {
            option.style.display = 'flex';
          } else {
            option.style.display = 'none';
          }
        });
        
        // éšè—ç©ºåˆ†ç±»
        const categories = listContainer.querySelectorAll('div > div[style*="font-weight: 600"]');
        categories.forEach(catHeader => {
          const categoryDiv = catHeader.parentElement;
          const visibleOptions = Array.from(categoryDiv.querySelectorAll('.comp-sop-option')).filter(o => o.style.display !== 'none');
          categoryDiv.style.display = visibleOptions.length > 0 ? 'block' : 'none';
        });
      };
      
      // æ‰¹é‡è®¾ç½®è´Ÿè´£äºº
      window[`batchAssignTasks${clientServiceId}`] = function() {
        const batchAssigneeSelect = document.getElementById(`batch-assignee-${clientServiceId}`);
        const assigneeUserId = batchAssigneeSelect.value;
        
        if (!assigneeUserId) {
          alert('è«‹å…ˆé¸æ“‡è² è²¬äººå“¡');
          return;
        }
        
        const tasks = window[`customTasks${clientServiceId}`];
        if (!tasks || tasks.length === 0) {
          alert('ç›®å‰æ²’æœ‰ä»»å‹™å¯ä»¥è¨­ç½®');
          return;
        }
        
        // è·å–é€‰ä¸­çš„å‘˜å·¥åç§°
        const selectedOption = batchAssigneeSelect.options[batchAssigneeSelect.selectedIndex];
        const assigneeName = selectedOption.textContent;
        
        if (confirm(`ç¢ºå®šè¦å°‡æ‰€æœ‰ ${tasks.length} å€‹ä»»å‹™çš„è² è²¬äººè¨­ç½®ç‚ºã€Œ${assigneeName}ã€å—ï¼Ÿ\n\nä¹‹å¾Œæ‚¨ä»å¯å–®ç¨ä¿®æ”¹å€‹åˆ¥ä»»å‹™çš„è² è²¬äººã€‚`)) {
          // æ‰¹é‡è®¾ç½®æ‰€æœ‰ä»»åŠ¡çš„è´Ÿè´£äºº
          tasks.forEach(task => {
            task.assignee_user_id = assigneeUserId;
          });
          
          // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
          window[`renderTasksList${clientServiceId}`]();
          
          alert(`å·²æˆåŠŸå°‡æ‰€æœ‰ä»»å‹™çš„è² è²¬äººè¨­ç½®ç‚ºã€Œ${assigneeName}ã€`);
        }
      };
      
      // æ›´æ–°è‡ªå®šä¹‰ä»»åŠ¡çš„æœŸé™æ˜¾ç¤º
      window[`updateCustomTaskDisplay${clientServiceId}`] = function(idx) {
        const task = window[`customTasks${clientServiceId}`]?.[idx];
        if (!task) return;
        
        const display = document.getElementById(`custom-task-display-${idx}-${clientServiceId}`);
        if (!display) return;
        
        let text = '';
        switch(task.due_rule) {
          case 'end_of_month':
            text = 'ä¾‹ï¼š1æœˆ31æ—¥ã€2æœˆ28æ—¥ã€3æœˆ31æ—¥';
            break;
          case 'specific_day':
            text = task.due_value ? `ä¾‹ï¼šæ¯æœˆ${task.due_value}æ—¥` : 'è«‹å¡«å¯«æ—¥æœŸ';
            break;
          case 'next_month_day':
            text = task.due_value ? `ä¾‹ï¼š1æœˆåŸ·è¡Œâ†’2/${task.due_value}ã€2æœˆåŸ·è¡Œâ†’3/${task.due_value}` : 'è«‹å¡«å¯«æ—¥æœŸ';
            break;
          case 'days_after_start':
            text = task.due_value ? `ä¾‹ï¼šæœˆåˆå¾Œç¬¬${task.due_value}å¤©` : 'è«‹å¡«å¯«å¤©æ•¸';
            break;
        }
        display.textContent = text;
      };
      
      // åˆ›å»ºæœŸé™æ˜¾ç¤ºæ›´æ–°å‡½æ•°
      window[`updateDueDateDisplay${clientServiceId}`] = function(idx) {
        const rule = document.getElementById(`stage-due-rule-${idx}-${clientServiceId}`)?.value;
        const value = document.getElementById(`stage-due-value-${idx}-${clientServiceId}`)?.value;
        const display = document.getElementById(`due-display-${idx}-${clientServiceId}`);
        
        if (!display) return;
        
        let text = '';
        switch(rule) {
          case 'end_of_month':
            text = 'ä¾‹ï¼š1æœˆ31æ—¥ã€2æœˆ28æ—¥ã€3æœˆ31æ—¥';
            break;
          case 'specific_day':
            if (value) {
              text = `ä¾‹ï¼šæ¯æœˆ${value}æ—¥`;
            } else {
              text = 'è«‹å¡«å¯«æ—¥æœŸ';
            }
            break;
          case 'next_month_day':
            if (value) {
              text = `ä¾‹ï¼š1æœˆåŸ·è¡Œâ†’2/${value}ã€2æœˆåŸ·è¡Œâ†’3/${value}`;
            } else {
              text = 'è«‹å¡«å¯«æ—¥æœŸ';
            }
            break;
          case 'days_after_start':
            if (value) {
              text = `ä¾‹ï¼šæœˆåˆå¾Œç¬¬${value}å¤©`;
            } else {
              text = 'è«‹å¡«å¯«å¤©æ•¸';
            }
            break;
        }
        display.textContent = text;
      };
      
      // åˆ›å»ºåŠ¨æ€å¸®åŠ©å‡½æ•°
      window[`updateDueDateHelp${clientServiceId}`] = function(rule) {
        const valueLabel = document.getElementById(`due-value-label-${clientServiceId}`);
        const valueHelp = document.getElementById(`due-value-help-${clientServiceId}`);
        const dueHelp = document.getElementById(`due-help-${clientServiceId}`);
        
        switch(rule) {
          case 'end_of_month':
            valueLabel.textContent = 'æœŸé™æ—¥æœŸå€¼ï¼ˆä¸éœ€è¦å¡«å¯«ï¼‰';
            valueHelp.textContent = 'ç³»çµ±æœƒè‡ªå‹•ä½¿ç”¨ç•¶æœˆæœ€å¾Œä¸€å¤©';
            dueHelp.innerHTML = 'âœ… ä¾‹å¦‚ï¼š1æœˆåŸ·è¡Œçš„ä»»å‹™ â†’ æˆªæ­¢æ—¥æœŸ 1/31';
            break;
          case 'specific_day':
            valueLabel.textContent = 'ğŸ“… æŒ‡å®šæ—¥æœŸï¼ˆå¿…å¡«ï¼‰';
            valueHelp.textContent = 'å¡«å¯«1-31ï¼Œè¡¨ç¤ºæ¯æœˆçš„å¹¾è™Ÿ';
            dueHelp.innerHTML = 'âœ… ä¾‹å¦‚ï¼šå¡«å¯« <strong>5</strong>ï¼Œ1æœˆåŸ·è¡Œ â†’ æˆªæ­¢æ—¥æœŸ 1/5';
            break;
          case 'next_month_day':
            valueLabel.textContent = 'ğŸ“… ä¸‹æœˆæ—¥æœŸï¼ˆå¿…å¡«ï¼‰';
            valueHelp.textContent = 'å¡«å¯«1-31ï¼Œè¡¨ç¤ºä¸‹å€‹æœˆçš„å¹¾è™Ÿ';
            dueHelp.innerHTML = 'âœ… ä¾‹å¦‚ï¼šå¡«å¯« <strong>15</strong>ï¼Œ1æœˆåŸ·è¡Œ â†’ æˆªæ­¢æ—¥æœŸ 2/15';
            break;
          case 'days_after_start':
            valueLabel.textContent = 'â±ï¸ å¤©æ•¸ï¼ˆå¿…å¡«ï¼‰';
            valueHelp.textContent = 'å¡«å¯«å¤©æ•¸ï¼Œå¾åŸ·è¡Œæœˆä»½1æ—¥é–‹å§‹è¨ˆç®—';
            dueHelp.innerHTML = 'âœ… ä¾‹å¦‚ï¼šå¡«å¯« <strong>30</strong>ï¼Œ1æœˆåŸ·è¡Œ â†’ æˆªæ­¢æ—¥æœŸ 1/31';
            break;
        }
      };
      
      // åˆå§‹åŒ–ä»»åŠ¡é…ç½®åŒºåŸŸï¼ˆé»˜è®¤æ‰‹åŠ¨æ¨¡å¼ï¼‰
      window[`loadTemplateStages${clientServiceId}`]('');
      
      // æ¸²æŸ“SOPåˆ—è¡¨ï¼ˆæœåŠ¡å±‚çº§SOPï¼‰
      const sopListContainer = document.getElementById(`new-comp-sop-list-${clientServiceId}`);
      if (sopListContainer && allSOPs && allSOPs.length > 0) {
        // è·å–å½“å‰æœåŠ¡çš„service_code
        const currentService = clientDetail.services.find(s => s.client_service_id === clientServiceId);
        const currentServiceType = allServices.find(st => st.service_id === currentService?.service_id);
        const serviceCode = currentServiceType?.service_code || '';
        
        console.log('[Service SOP] clientServiceId:', clientServiceId, 'serviceCode:', serviceCode);
        
        // ç­›é€‰ï¼šåªæ˜¾ç¤ºscope=serviceä¸”categoryåŒ¹é…çš„SOP
        const filteredSOPs = allSOPs.filter(sop => 
          sop.scope === 'service' && 
          serviceCode &&
          (sop.category === serviceCode || sop.category === serviceCode.toLowerCase() || sop.category === serviceCode.toUpperCase())
        );
        
        // æŒ‰æ ‡é¢˜æ’åºï¼ˆä¸éœ€è¦åˆ†ç±»ï¼‰
        const sortedSOPs = filteredSOPs.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
        
        console.log('[Service SOP] Filtered:', filteredSOPs.length, 'SOPs');
        
        let html = '';
        sortedSOPs.forEach(sop => {
          const sopTitle = sop.title || 'æœªå‘½å';
          html += '<label class="comp-sop-option" data-sop-title="' + sopTitle.toLowerCase() + '" style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; font-size: 13px; margin-bottom: 6px; border-radius: 4px; border: 1px solid #e5e7eb;" onmouseover="this.style.background=\'#f3f4f6\'" onmouseout="this.style.background=\'white\'">';
          html += '<input type="checkbox" class="comp-sop-checkbox" value="' + sop.sop_id + '" style="cursor: pointer; flex-shrink: 0; width: 16px; height: 16px; margin: 0; padding: 0;" onchange="updateCompSOPSelection' + clientServiceId + '(this)" />';
          html += '<span style="color: #374151; line-height: 1.3;">' + sopTitle + '</span>';
          html += '</label>';
        });
        
        sopListContainer.innerHTML = html || '<div style="color: #9ca3af; text-align: center; padding: 20px;">æš«ç„¡é©ç”¨æ–¼æ­¤æœå‹™çš„æœå‹™å±¤ç´šSOP</div>';
      } else {
        sopListContainer.innerHTML = '<div style="color: #9ca3af; text-align: center; padding: 20px;">æš«ç„¡SOP</div>';
      }
    }

    // å–æ¶ˆæ–°å¢
    function cancelAddComponent(clientServiceId) {
      const form = document.getElementById(`add-component-form-${clientServiceId}`);
      form.style.display = 'none';
      
      // æ¸…é™¤ç¼–è¾‘æ¨¡å¼æ ‡è®°
      form.removeAttribute('data-edit-id');
      form.querySelector('h5').textContent = 'é…ç½®æœå‹™ä»»å‹™';
      
      // æ¸…ç©ºè¡¨å–®
      document.getElementById(`new-comp-name-${clientServiceId}`).value = '';
      document.getElementById(`new-comp-service-item-${clientServiceId}`).value = '';
      document.getElementById(`new-comp-freq-${clientServiceId}`).value = 'monthly';
      document.getElementById(`new-comp-template-${clientServiceId}`).innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æœå‹™é …ç›®</option>';
      document.getElementById(`new-comp-hours-${clientServiceId}`).value = '';
      document.getElementById(`new-comp-due-rule-${clientServiceId}`).value = 'end_of_month';
      document.getElementById(`new-comp-due-value-${clientServiceId}`).value = '';
      document.getElementById(`new-comp-advance-${clientServiceId}`).value = '7';
      
      // æ¸…ç©ºSOPé€‰æ‹©
      const sopCheckboxes = document.querySelectorAll(`#new-comp-sop-list-${clientServiceId} input[type="checkbox"]`);
      sopCheckboxes.forEach(cb => cb.checked = false);
      
      // æ¸…ç©ºè‡ªå®šä¹‰ä»»åŠ¡
      window[`customTasks${clientServiceId}`] = [];
      if (document.getElementById(`tasks-list-${clientServiceId}`)) {
        document.getElementById(`tasks-list-${clientServiceId}`).innerHTML = '';
      }
    }


    // åˆªé™¤ä»»å‹™é…ç½®
    async function deleteComponent(componentId, componentName) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™é…ç½®å—ï¼Ÿ\n\né€™å°‡åˆªé™¤æ‰€æœ‰ç›¸é—œçš„ä»»å‹™è¨­å®šã€‚`)) return;

      try {
        const res = await fetch(`/internal/api/v1/service-components/${componentId}`, {
          method: 'DELETE'
        });

        const json = await res.json();

        if (!json.ok) {
          alert(json.message || 'åˆªé™¤å¤±æ•—');
          return;
        }

        alert('ä»»å‹™é…ç½®å·²åˆªé™¤');
        await loadClientDetail();

      } catch (err) {
        console.error('åˆªé™¤å¤±æ•—:', err);
        alert('åˆªé™¤å¤±æ•—');
      }
    }

    // ç·¨è¼¯æœå‹™çµ„æˆéƒ¨åˆ†
    async function editComponent(componentId) {
      try {
        // æ‰¾åˆ°å¯¹åº”çš„clientServiceId
        let clientServiceId = null;
        const allComponents = document.querySelectorAll('[id^="add-component-form-"]');
        for (const form of allComponents) {
          const id = form.id.match(/add-component-form-(\d+)/);
          if (id) {
            clientServiceId = parseInt(id[1]);
            break;
          }
        }
        
        if (!clientServiceId) {
          alert('ç„¡æ³•å®šä½æœå‹™');
          return;
        }
        
        // å…ˆåˆå§‹åŒ–è¡¨å•ï¼ˆåŒ…æ‹¬SOPåˆ—è¡¨å’Œä»»åŠ¡é…ç½®åŒºåŸŸï¼‰
        showAddComponentForm(clientServiceId);
        
        // ç­‰å¾…DOMæ›´æ–°
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // è·å–ç»„ä»¶å®Œæ•´æ•°æ®
        const res = await fetch(`/internal/api/v1/client-services/${clientServiceId}/components`);
        const json = await res.json();
        
        if (!json.ok) {
          alert('åŠ è¼‰æ•¸æ“šå¤±æ•—');
          return;
        }
        
        const component = json.data.find(c => c.component_id === componentId);
        if (!component) {
          alert('æ‰¾ä¸åˆ°è©²æœå‹™çµ„æˆéƒ¨åˆ†');
          return;
        }
        
        // è·å–è¡¨å•
        const form = document.getElementById(`add-component-form-${clientServiceId}`);
        
        // æ ‡è®°ä¸ºç¼–è¾‘æ¨¡å¼
        form.setAttribute('data-edit-id', componentId);
        form.querySelector('h5').textContent = 'ç·¨è¼¯ä»»å‹™é…ç½®';
        
        // å¡«å……æœåŠ¡å±‚çº§SOP
        if (component.component_sops && component.component_sops.length > 0) {
          component.component_sops.forEach(sop => {
            const checkbox = document.querySelector(`#new-comp-sop-list-${clientServiceId} input[value="${sop.sop_id}"]`);
            if (checkbox) {
              checkbox.checked = true;
            }
          });
          // æ›´æ–°å·²é€‰æ‹©çš„SOPæ ‡ç­¾æ˜¾ç¤º
          if (window[`updateCompSOPSelection${clientServiceId}`]) {
            window[`updateCompSOPSelection${clientServiceId}`]();
          }
        }
        
        // å¡«å……ä»»åŠ¡åˆ—è¡¨
        if (component.tasks && component.tasks.length > 0) {
          window[`customTasks${clientServiceId}`] = component.tasks.map(task => ({
            name: task.task_name,
            assignee_user_id: task.assignee_user_id,
            estimated_hours: task.estimated_hours,
            due_rule: task.due_rule || 'end_of_month',
            due_value: task.due_value,
            advance_days: task.advance_days || 7,
            notes: task.notes || '',
            sop_ids: task.sops ? task.sops.map(s => s.sop_id).filter(id => !isNaN(id) && id > 0) : []
          }));
          
          // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
          if (window[`renderTasksList${clientServiceId}`]) {
            window[`renderTasksList${clientServiceId}`]();
          }
        } else {
          // å¦‚æœæ²¡æœ‰ä»»åŠ¡ï¼Œæ¸…ç©ºä»»åŠ¡åˆ—è¡¨
          window[`customTasks${clientServiceId}`] = [];
          if (window[`renderTasksList${clientServiceId}`]) {
            window[`renderTasksList${clientServiceId}`]();
          }
        }
        
        // æ»šåŠ¨åˆ°è¡¨å•ä½ç½®
        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
      } catch (err) {
        console.error('ç·¨è¼¯å¤±æ•—:', err);
        alert('ç·¨è¼¯å¤±æ•—');
      }
    }

    // åˆ‡æ›ä»»å‹™åˆ—è¡¨é¡¯ç¤º
    async function toggleComponentTasks(componentId) {
      const tasksList = document.getElementById(`tasks-list-${componentId}`);
      const toggleText = document.getElementById(`tasks-toggle-${componentId}`);
      
      if (tasksList.style.display === 'none') {
        // å±•é–‹ä¸¦è¼‰å…¥ä»»å‹™
        tasksList.style.display = 'block';
        toggleText.textContent = 'æ”¶èµ·';
        await loadComponentTasks(componentId);
      } else {
        // æ”¶èµ·
        tasksList.style.display = 'none';
        toggleText.textContent = 'å±•é–‹';
      }
    }

    // è¼‰å…¥æœå‹™çµ„æˆçš„ä»»å‹™åˆ—è¡¨
    async function loadComponentTasks(componentId) {
      const container = document.getElementById(`tasks-list-${componentId}`);
      
      try {
        const res = await fetch(`/internal/api/v1/tasks?component_id=${componentId}`);
        const json = await res.json();
        
        if (!json.ok) {
          container.innerHTML = '<p style="color: #ef4444; font-size: 13px;">è¼‰å…¥å¤±æ•—</p>';
          return;
        }

        const tasks = json.data || [];
        
        if (tasks.length === 0) {
          container.innerHTML = '<p style="color: #6b7280; font-size: 13px;">å°šæœªç”Ÿæˆä»»å‹™ï¼ˆä»»å‹™æœƒåœ¨æ¥è¿‘æœŸé™æ™‚è‡ªå‹•ç”Ÿæˆï¼‰</p>';
          return;
        }

        // æ¸²æŸ“ä»»å‹™åˆ—è¡¨
        container.innerHTML = tasks.map(task => {
          const statusColors = {
            'pending': { bg: '#fef3c7', text: '#92400e', label: 'å¾…è™•ç†' },
            'in_progress': { bg: '#dbeafe', text: '#1e40af', label: 'é€²è¡Œä¸­' },
            'completed': { bg: '#d1fae5', text: '#065f46', label: 'å·²å®Œæˆ' },
            'cancelled': { bg: '#f3f4f6', text: '#6b7280', label: 'å·²å–æ¶ˆ' }
          };
          
          const statusStyle = statusColors[task.status] || statusColors['pending'];
          
          return `
            <div style="background: #f9fafb; padding: 10px; border-radius: 6px; margin-bottom: 6px; font-size: 13px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                  <strong style="color: #1f2937;">${task.task_name}</strong>
                  <div style="color: #6b7280; margin-top: 4px; display: flex; gap: 12px;">
                    <span>ğŸ“… æˆªæ­¢ï¼š${task.due_date || '-'}</span>
                    <span>ğŸ‘¤ è² è²¬ï¼š${task.assignee_name || 'æœªåˆ†é…'}</span>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="background: ${statusStyle.bg}; color: ${statusStyle.text}; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                    ${statusStyle.label}
                  </span>
                  <a href="/internal/tasks?task_id=${task.task_id}" class="table-btn-link" style="font-size: 12px;" target="_blank">æŸ¥çœ‹</a>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
      } catch (err) {
        console.error('è¼‰å…¥ä»»å‹™å¤±æ•—:', err);
        container.innerHTML = '<p style="color: #ef4444; font-size: 13px;">è¼‰å…¥å¤±æ•—</p>';
      }
    }

    // æš´éœ²å‡½æ•¸åˆ°å…¨å±€
    window.showComponentsSection = showComponentsSection;
    window.loadComponentsInline = loadComponentsInline;
    window.showAddComponentForm = showAddComponentForm;
    window.cancelAddComponent = cancelAddComponent;
    window.saveNewComponent = saveNewComponent;
    window.deleteComponent = deleteComponent;
    window.editComponent = editComponent;
    window.toggleComponentTasks = toggleComponentTasks;
    window.loadComponentTasks = loadComponentTasks;

    // å–æ¶ˆç·¨è¼¯
    function cancelEdit() {
      window.location.href = '/internal/clients';
    }
    
    // æ–°å¢å®¢æˆ¶ï¼ˆPOST è«‹æ±‚ï¼‰
    async function saveClient() {
      clearFormErrors();
      
      const assigneeValue = document.getElementById('inputAssignee').value;
      const assigneeUserId = assigneeValue ? parseInt(assigneeValue) : 0;
      
      const clientId = document.getElementById('inputClientId').value.trim();
      const taxId = document.getElementById('inputTaxId').value.trim();
      
      const payload = {
        client_id: clientId,
        company_name: document.getElementById('inputCompanyName').value.trim(),
        tax_registration_number: taxId || null,
        contact_person_1: document.getElementById('inputContactPerson1').value.trim() || null,
        contact_person_2: document.getElementById('inputContactPerson2').value.trim() || null,
        assignee_user_id: assigneeUserId,
        phone: document.getElementById('inputPhone').value.trim() || null,
        email: document.getElementById('inputEmail').value.trim() || null,
        client_notes: document.getElementById('inputClientNotes').value.trim() || null,
        payment_notes: document.getElementById('inputPaymentNotes').value.trim() || null,
        tag_ids: Array.from(window.selectedTagIds)
      };
      
      // é©—è­‰
      let hasError = false;
      
      // å®¢æˆ¶ç·¨è™Ÿé©—è­‰
      if (!clientId) {
        showFieldError('client_id', 'å®¢æˆ¶ç·¨è™Ÿç‚ºå¿…å¡«');
        hasError = true;
      } else if (clientId.length !== 8) {
        showFieldError('client_id', 'å®¢æˆ¶ç·¨è™Ÿå¿…é ˆç‚º8ä½æ•¸å­—');
        hasError = true;
      } else if (!/^\d+$/.test(clientId)) {
        showFieldError('client_id', 'å®¢æˆ¶ç·¨è™Ÿåªèƒ½åŒ…å«æ•¸å­—');
        hasError = true;
      }
      
      // å…¬å¸åç¨±é©—è­‰
      if (!payload.company_name) {
        showFieldError('company_name', 'å…¬å¸åç¨±ç‚ºå¿…å¡«');
        hasError = true;
      }
      
      // è² è²¬äººé©—è­‰
      if (!assigneeUserId || assigneeUserId <= 0) {
        showFieldError('assignee', 'è«‹é¸æ“‡è² è²¬äººå“¡');
        hasError = true;
      }
      
      // çµ±ç·¨é©—è­‰ï¼ˆå¦‚æœå¡«å¯«ï¼‰
      if (taxId && taxId.length !== 8) {
        showFieldError('tax_registration_number', 'çµ±ä¸€ç·¨è™Ÿå¿…é ˆç‚º8ä½æ•¸å­—');
        hasError = true;
      }
      if (taxId && !/^\d+$/.test(taxId)) {
        showFieldError('tax_registration_number', 'çµ±ä¸€ç·¨è™Ÿåªèƒ½åŒ…å«æ•¸å­—');
        hasError = true;
      }
      
      // é‚è¼¯ä¸€è‡´æ€§æª¢æŸ¥
      if (taxId && clientId && taxId !== clientId && !clientId.startsWith('00')) {
        const confirmed = confirm(
          'æé†’ï¼šæ‚¨çš„å®¢æˆ¶ç·¨è™Ÿèˆ‡çµ±ä¸€ç·¨è™Ÿä¸ä¸€è‡´ã€‚\n\n' +
          'å®¢æˆ¶ç·¨è™Ÿï¼š' + clientId + '\n' +
          'çµ±ä¸€ç·¨è™Ÿï¼š' + taxId + '\n\n' +
          'å»ºè­°å…¬å¸å®¢æˆ¶ä½¿ç”¨çµ±ä¸€ç·¨è™Ÿä½œç‚ºå®¢æˆ¶ç·¨è™Ÿã€‚\n' +
          'æ˜¯å¦ç¹¼çºŒï¼Ÿ'
        );
        if (!confirmed) return;
      }
      
      // é˜²æ­¢å€‹äººå®¢æˆ¶ç·¨è™Ÿèˆ‡çµ±ç·¨æ ¼å¼è¡çª
      if (clientId.startsWith('00') && taxId) {
        alert('éŒ¯èª¤ï¼šå€‹äººå®¢æˆ¶ç·¨è™Ÿï¼ˆ00é–‹é ­ï¼‰ä¸æ‡‰å¡«å¯«çµ±ä¸€ç·¨è™Ÿã€‚\n\nå¦‚æœæ˜¯å…¬å¸å®¢æˆ¶ï¼Œè«‹ä½¿ç”¨çµ±ä¸€ç·¨è™Ÿä½œç‚ºå®¢æˆ¶ç·¨è™Ÿã€‚');
        return;
      }
      
      if (hasError) return;
      
      try {
        console.log('æ–°å¢å®¢æˆ¶è«‹æ±‚æ•¸æ“š:', payload);
        
        // æ­¥é©Ÿ 1: å‰µå»ºå®¢æˆ¶
        const res = await fetch('/internal/api/v1/clients', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        
        const json = await res.json();
        console.log('æ–°å¢å®¢æˆ¶éŸ¿æ‡‰:', json);
        
        if (!res.ok || !json.ok) {
          if (json.errors && Array.isArray(json.errors)) {
            const errorMsg = json.errors.map(e => `${e.field}: ${e.message}`).join('\n');
            alert(`${json.message}\n\n${errorMsg}`);
            json.errors.forEach(err => {
              showFieldError(err.field, err.message);
            });
          } else {
            alert(json.message || 'æ–°å¢å¤±æ•—');
          }
          return;
        }
        
        // æ³¨æ„ï¼šå¾Œç«¯è¿”å›çš„å­—æ®µæ˜¯ clientIdï¼Œä¸æ˜¯ client_id
        const newClientId = json.data.clientId;
        console.log('æ–°å»ºå®¢æˆ¶ID:', newClientId);
        
        // æ­¥é©Ÿ 2: å¦‚æœæœ‰æœå‹™ï¼Œé€ä¸€æ–°å¢
        if (tempServices.length > 0) {
          console.log(`é–‹å§‹å‰µå»º ${tempServices.length} å€‹æœå‹™...`);
          for (let i = 0; i < tempServices.length; i++) {
            const svc = tempServices[i];
            console.log(`å‰µå»ºæœå‹™ ${i + 1}:`, {
              service_id: svc.service_id,
              service_name: svc.service_name,
              status: svc.status
            });
            
            const resSvc = await fetch(`/internal/api/v1/clients/${newClientId}/services`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                service_id: svc.service_id,
                status: svc.status,
                start_date: svc.start_date || null
              })
            });
            
            const jsonSvc = await resSvc.json().catch(() => null);
            console.log(`æœå‹™ ${i + 1} å‰µå»ºéŸ¿æ‡‰:`, jsonSvc);
            
            if (!resSvc.ok || !jsonSvc?.ok) {
              console.error(`æœå‹™ ${i + 1} å‰µå»ºå¤±æ•—:`, jsonSvc);
              alert(`è­¦å‘Šï¼šæœå‹™ã€Œ${svc.service_name}ã€å‰µå»ºå¤±æ•—ï¼š${jsonSvc?.message || 'æœªçŸ¥éŒ¯èª¤'}\n\nå°‡ç¹¼çºŒå‰µå»ºå…¶ä»–æœå‹™...`);
              continue;
            }
            
            const clientServiceId = jsonSvc?.data?.client_service_id;
            
            // æ­¥é©Ÿ 3: ç‚ºæœå‹™æ·»åŠ æ”¶è²»
            if (clientServiceId && Array.isArray(svc.billings) && svc.billings.length > 0) {
              console.log(`  ç‚ºæœå‹™ ${i + 1} å‰µå»º ${svc.billings.length} æ¢æ”¶è²»è¨˜éŒ„...`);
              for (let j = 0; j < svc.billings.length; j++) {
                const b = svc.billings[j];
                const payloadBilling = (b.billing_type === 'one-time') ? {
                  client_service_id: clientServiceId,
                  billing_type: 'one-time',
                  billing_date: b.billing_date,
                  description: b.description,
                  billing_amount: b.billing_amount,
                  payment_due_days: b.payment_due_days,
                  notes: b.notes || null,
                  billing_month: 0
                } : {
                  client_service_id: clientServiceId,
                  billing_type: 'monthly',
                  billing_month: b.billing_month,
                  billing_amount: b.billing_amount,
                  payment_due_days: b.payment_due_days,
                  notes: b.notes || null
                };
                
                console.log(`    å‰µå»ºæ”¶è²» ${j + 1}:`, payloadBilling);
                
                // æ·»åŠ é‡è©¦æ©Ÿåˆ¶
                let retryCount = 0;
                let success = false;
                while (retryCount < 3 && !success) {
                  try {
                    const resBilling = await fetch('/internal/api/v1/billing', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      credentials: 'include',
                      body: JSON.stringify(payloadBilling)
                    });
                    
                    const jsonBilling = await resBilling.json().catch(() => null);
                    console.log(`    æ”¶è²» ${j + 1} å‰µå»ºéŸ¿æ‡‰:`, jsonBilling);
                    
                    if (resBilling.ok && jsonBilling?.ok) {
                      success = true;
                    } else {
                      console.error(`    æ”¶è²» ${j + 1} å‰µå»ºå¤±æ•— (å˜—è©¦ ${retryCount + 1}/3):`, jsonBilling);
                      if (retryCount === 2) {
                        alert(`è­¦å‘Šï¼šæœå‹™ã€Œ${svc.service_name}ã€çš„æ”¶è²»è¨˜éŒ„ ${j + 1} å‰µå»ºå¤±æ•—ï¼š${jsonBilling?.message || 'æœªçŸ¥éŒ¯èª¤'}\n\nå°‡ç¹¼çºŒå‰µå»ºå…¶ä»–æ”¶è²»è¨˜éŒ„...`);
                      }
                    }
                  } catch (fetchError) {
                    console.error(`    æ”¶è²» ${j + 1} ç¶²çµ¡éŒ¯èª¤ (å˜—è©¦ ${retryCount + 1}/3):`, fetchError);
                    if (retryCount === 2) {
                      alert(`è­¦å‘Šï¼šæœå‹™ã€Œ${svc.service_name}ã€çš„æ”¶è²»è¨˜éŒ„ ${j + 1} å‰µå»ºå¤±æ•—ï¼šç¶²çµ¡éŒ¯èª¤\n\nå°‡ç¹¼çºŒå‰µå»ºå…¶ä»–æ”¶è²»è¨˜éŒ„...`);
                    }
                  }
                  
                  retryCount++;
                  if (!success && retryCount < 3) {
                    // ç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œé‡è©¦
                    await new Promise(resolve => setTimeout(resolve, 500));
                  }
                }
                
                // åœ¨è«‹æ±‚ä¹‹é–“æ·»åŠ çŸ­æš«å»¶é²ï¼Œé¿å…è«‹æ±‚éæ–¼é »ç¹
                if (j < svc.billings.length - 1) {
                  await new Promise(resolve => setTimeout(resolve, 100));
                }
              }
            }
            
            // æ­¥é©Ÿ 4: è‹¥æ‰‹å‹•é…ç½®äº†æœå‹™çµ„ä»¶ï¼Œé€ä¸€å»ºç«‹
            if (clientServiceId && Array.isArray(svc.components) && svc.components.length > 0) {
              console.log(`  ç‚ºæœå‹™ ${i + 1} å‰µå»º ${svc.components.length} å€‹çµ„ä»¶é…ç½®...`);
              for (let k = 0; k < svc.components.length; k++) {
                const comp = svc.components[k];
                const payloadComp = {
                  service_id: svc.service_id,
                  service_item_id: comp.service_item_id || null,
                  component_name: comp.component_name || 'ä»»å‹™é…ç½®',
                  delivery_frequency: comp.delivery_frequency || 'monthly',
                  delivery_months: comp.delivery_months || [],
                  task_template_id: null,
                  auto_generate_task: true,
                  advance_days: 7,
                  component_sop_ids: comp.component_sop_ids || [],
                  tasks: comp.tasks || []
                };
                
                console.log(`    å‰µå»ºçµ„ä»¶ ${k + 1}:`, payloadComp);
                
                // æ·»åŠ é‡è©¦æ©Ÿåˆ¶
                let retryCount = 0;
                let success = false;
                while (retryCount < 3 && !success) {
                  try {
                    const resComp = await fetch(`/internal/api/v1/client-services/${clientServiceId}/components`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      credentials: 'include',
                      body: JSON.stringify(payloadComp)
                    });
                    
                    const jsonComp = await resComp.json().catch(() => null);
                    console.log(`    çµ„ä»¶ ${k + 1} å‰µå»ºéŸ¿æ‡‰:`, jsonComp);
                    
                    if (resComp.ok && jsonComp?.ok) {
                      success = true;
                    } else {
                      console.error(`    çµ„ä»¶ ${k + 1} å‰µå»ºå¤±æ•— (å˜—è©¦ ${retryCount + 1}/3):`, jsonComp);
                      if (retryCount === 2) {
                        alert(`è­¦å‘Šï¼šæœå‹™ã€Œ${svc.service_name}ã€çš„çµ„ä»¶é…ç½®å‰µå»ºå¤±æ•—ï¼š${jsonComp?.message || 'æœªçŸ¥éŒ¯èª¤'}\n\nå°‡ç¹¼çºŒå‰µå»ºå…¶ä»–çµ„ä»¶...`);
                      }
                    }
                  } catch (fetchError) {
                    console.error(`    çµ„ä»¶ ${k + 1} ç¶²çµ¡éŒ¯èª¤ (å˜—è©¦ ${retryCount + 1}/3):`, fetchError);
                    if (retryCount === 2) {
                      alert(`è­¦å‘Šï¼šæœå‹™ã€Œ${svc.service_name}ã€çš„çµ„ä»¶é…ç½®å‰µå»ºå¤±æ•—ï¼šç¶²çµ¡éŒ¯èª¤\n\nå°‡ç¹¼çºŒå‰µå»ºå…¶ä»–çµ„ä»¶...`);
                    }
                  }
                  
                  retryCount++;
                  if (!success && retryCount < 3) {
                    // ç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œé‡è©¦
                    await new Promise(resolve => setTimeout(resolve, 500));
                  }
                }
                
                // åœ¨è«‹æ±‚ä¹‹é–“æ·»åŠ çŸ­æš«å»¶é²ï¼Œé¿å…è«‹æ±‚éæ–¼é »ç¹
                if (k < svc.components.length - 1) {
                  await new Promise(resolve => setTimeout(resolve, 100));
                }
              }
            }
          }
          console.log('æ‰€æœ‰æœå‹™ã€æ”¶è²»å’Œçµ„ä»¶å‰µå»ºå®Œæˆï¼');
        }
        
        alert('å®¢æˆ¶æ–°å¢æˆåŠŸï¼å³å°‡è·³è½‰è‡³å®¢æˆ¶è©³æƒ…é ã€‚');
        window.location.href = `/internal/client-detail?id=${newClientId}`;
        
      } catch (err) {
        console.error('æ–°å¢å¤±æ•—:', err);
        alert('æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // é¡¯ç¤ºæ¬„ä½éŒ¯èª¤
    function showFieldError(field, message) {
      const errorEl = document.getElementById(`error_${field}`);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
    }

    // æ¸…é™¤è¡¨å–®éŒ¯èª¤
    function clearFormErrors(formPrefix) {
      document.querySelectorAll('.error-message, .error-text').forEach(el => {
        el.textContent = '';
        el.style.display = 'none';
      });
    }

    // ==================== æ¨™ç±¤ç®¡ç† ====================
    
    let allTags = [];
    window.currentClientTags = [];
    window.selectedTagIds = new Set();
    
    // è¼‰å…¥æ‰€æœ‰æ¨™ç±¤
    async function loadAllTags() {
      try {
        const res = await fetch('/internal/api/v1/tags');
        const json = await res.json();
        if (json.ok && json.data) {
          allTags = json.data;
        }
      } catch (err) {
        console.error('è¼‰å…¥æ¨™ç±¤å¤±æ•—:', err);
      }
    }
    
    // æ¸²æŸ“æ¨™ç±¤é¡¯ç¤º
    function renderTagsDisplay() {
      const container = document.getElementById('tagsDisplay');
      if (!window.currentClientTags || window.currentClientTags.length === 0) {
        container.innerHTML = '<span style="color: #9ca3af;">å°šæœªè¨­å®šæ¨™ç±¤</span>';
      } else {
        container.innerHTML = window.currentClientTags.map(t => 
          `<span style="display: inline-flex; align-items: center; padding: 4px 12px; background: ${t.tag_color || '#6b7280'}; color: white; border-radius: 4px; font-size: 13px;">${t.tag_name}</span>`
        ).join('');
      }
    }
    
    // é¡¯ç¤ºæ¨™ç±¤ç®¡ç†å½ˆçª—
    function showTagsModal() {
      const modal = document.getElementById('tagsModal');
      modal.style.display = 'flex';
      
      // åˆå§‹åŒ–é¸ä¸­çš„æ¨™ç±¤
      window.selectedTagIds = new Set(window.currentClientTags.map(t => t.tag_id));
      
      // æ¸²æŸ“æ‰€æœ‰æ¨™ç±¤
      renderAllTags();
      renderSelectedTags();
    }
    
    // é—œé–‰æ¨™ç±¤ç®¡ç†å½ˆçª—
    function closeTagsModal() {
      document.getElementById('tagsModal').style.display = 'none';
      // é—œé–‰æ™‚é‡ç½®æ–°å¢è¡¨å–®
      const form = document.getElementById('newTagForm');
      if (form.style.display !== 'none') {
        cancelNewTag();
      }
    }
    
    // åˆ‡æ›æ–°å¢æ¨™ç±¤è¡¨å–®
    function toggleNewTagForm() {
      const form = document.getElementById('newTagForm');
      const btn = document.getElementById('btnShowNewTag');
      if (form.style.display === 'none') {
        form.style.display = 'block';
        btn.textContent = 'âˆ’ å–æ¶ˆæ–°å¢';
      } else {
        form.style.display = 'none';
        btn.textContent = '+ æ–°å¢æ¨™ç±¤';
        document.getElementById('newTagName').value = '';
        document.getElementById('newTagColor').value = '#3b82f6';
      }
    }
    
    // å–æ¶ˆæ–°å¢æ¨™ç±¤
    function cancelNewTag() {
      const form = document.getElementById('newTagForm');
      const btn = document.getElementById('btnShowNewTag');
      form.style.display = 'none';
      btn.textContent = '+ æ–°å¢æ¨™ç±¤';
      document.getElementById('newTagName').value = '';
      document.getElementById('newTagColor').value = '#3b82f6';
    }
    
    // å„²å­˜æ–°æ¨™ç±¤
    async function saveNewTag() {
      const name = document.getElementById('newTagName').value.trim();
      const color = document.getElementById('newTagColor').value;
      
      if (!name) {
        alert('è«‹è¼¸å…¥æ¨™ç±¤åç¨±');
        return;
      }
      
      if (name.length > 50) {
        alert('æ¨™ç±¤åç¨±ä¸èƒ½è¶…é50å­—');
        return;
      }
      
      try {
        const res = await fetch('/internal/api/v1/tags', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tag_name: name,
            tag_color: color
          })
        });
        
        const json = await res.json();
        if (!json.ok) {
          alert(json.message || 'å»ºç«‹å¤±æ•—');
          return;
        }
        
        alert('æ¨™ç±¤å·²å»ºç«‹');
        cancelNewTag();
        
        // é‡æ–°è¼‰å…¥æ‰€æœ‰æ¨™ç±¤
        await loadAllTags();
        renderAllTags();
      } catch (err) {
        console.error('å»ºç«‹æ¨™ç±¤å¤±æ•—:', err);
        alert('å»ºç«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }
    
    // æ¸²æŸ“æ‰€æœ‰æ¨™ç±¤åˆ—è¡¨
    function renderAllTags() {
      const container = document.getElementById('allTagsList');
      if (allTags.length === 0) {
        container.innerHTML = '<span style="color: #9ca3af;">æš«ç„¡æ¨™ç±¤</span>';
        return;
      }
      
      container.innerHTML = allTags.map(tag => {
        const isSelected = window.selectedTagIds.has(tag.tag_id);
        return `
          <button type="button" 
                  onclick="toggleTag(${tag.tag_id})"
                  style="display: inline-flex; align-items: center; padding: 6px 14px; 
                         background: ${isSelected ? tag.tag_color || '#3b82f6' : '#f3f4f6'}; 
                         color: ${isSelected ? 'white' : '#374151'}; 
                         border: ${isSelected ? 'none' : '1px solid #d1d5db'};
                         border-radius: 4px; font-size: 13px; cursor: pointer; 
                         transition: all 0.2s;">
            ${isSelected ? 'âœ“ ' : ''}${tag.tag_name}
          </button>
        `;
      }).join('');
    }
    
    // æ¸²æŸ“å·²é¸æ¨™ç±¤
    function renderSelectedTags() {
      const container = document.getElementById('selectedTagsList');
      const selectedTags = allTags.filter(t => window.selectedTagIds.has(t.tag_id));
      
      if (selectedTags.length === 0) {
        container.innerHTML = '<span style="color: #9ca3af;">å°šæœªé¸æ“‡æ¨™ç±¤</span>';
      } else {
        container.innerHTML = selectedTags.map(tag => 
          `<span style="display: inline-flex; align-items: center; padding: 4px 12px; 
                  background: ${tag.tag_color || '#6b7280'}; color: white; 
                  border-radius: 4px; font-size: 13px;">
            ${tag.tag_name}
          </span>`
        ).join('');
      }
    }
    
    // åˆ‡æ›æ¨™ç±¤é¸æ“‡ç‹€æ…‹
    function toggleTag(tagId) {
      if (window.selectedTagIds.has(tagId)) {
        window.selectedTagIds.delete(tagId);
      } else {
        window.selectedTagIds.add(tagId);
      }
      renderAllTags();
      renderSelectedTags();
    }
    
    // ç¢ºèªæ¨™ç±¤é¸æ“‡ï¼ˆæ–°å¢æ¨¡å¼ï¼šåªæ›´æ–°å‰ç«¯ç‹€æ…‹ï¼‰
    function saveTags() {
      // æ›´æ–°é¡¯ç¤ºå€åŸŸ
      renderTagsDisplay();
      closeTagsModal();
    }

    // é»æ“ŠModalå¤–éƒ¨é—œé–‰
    window.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });

    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>


