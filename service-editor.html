<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ç·¨è¼¯æœå‹™ä»‹ç´¹ï½œCMS</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    
    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    
    <style>
      * { box-sizing: border-box; }
      body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif; background: #f5f7fa; }
      
      .top-toolbar { background: white; border-bottom: 2px solid #e5e7eb; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
      .top-toolbar-left { display: flex; gap: 12px; align-items: center; }
      .top-toolbar-right { display: flex; gap: 12px; }
      
      .btn { padding: 10px 20px; border: 2px solid #e0e0e0; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 6px; }
      .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
      .btn.primary { background: linear-gradient(135deg, #2c5f7c 0%, #1e4a63 100%); color: white; border-color: #2c5f7c; }
      .btn.secondary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-color: #10b981; }
      
      .editor-layout { display: grid; grid-template-columns: 1fr 1fr; height: calc(100vh - 70px); gap: 0; }
      
      .editor-panel { background: white; display: flex; flex-direction: column; overflow: hidden; border-right: 2px solid #e5e7eb; }
      .editor-header { padding: 24px; border-bottom: 2px solid #f0f0f0; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); }
      .editor-header h2 { margin: 0 0 16px 0; color: #2c5f7c; font-size: 18px; display: flex; align-items: center; gap: 8px; }
      
      .form-group { margin-bottom: 16px; }
      .form-group label { display: block; font-weight: 600; margin-bottom: 6px; color: #374151; font-size: 14px; }
      .form-group input[type="text"], .form-group textarea { width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: all 0.3s; }
      .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #2c5f7c; box-shadow: 0 0 0 3px rgba(44, 95, 124, 0.1); }
      .form-group textarea { resize: vertical; min-height: 60px; font-family: inherit; }
      
      .image-upload-area { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; background: #f8fafc; }
      .image-upload-area:hover { border-color: #2c5f7c; background: #f0f9ff; }
      .image-upload-area.dragover { border-color: #2c5f7c; background: #dbeafe; }
      .image-preview { margin-top: 12px; max-width: 100%; border-radius: 8px; overflow: hidden; }
      .image-preview img { max-width: 100%; height: auto; display: block; }
      
      .editor-content { flex: 1; overflow: auto; padding: 24px; }
      #quill-editor { height: 100%; background: white; }
      .ql-container { font-size: 16px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif; }
      
      .preview-panel { background: #e5e7eb; display: flex; flex-direction: column; overflow: hidden; }
      .preview-header { padding: 16px 24px; background: white; border-bottom: 2px solid #e5e7eb; }
      .preview-header h2 { margin: 0; color: #2c5f7c; font-size: 18px; display: flex; align-items: center; gap: 8px; }
      .preview-content { flex: 1; overflow: auto; }
      .preview-iframe-wrapper { width: 100%; background: white; }
      #preview-frame { width: 100%; height: 100%; border: none; display: block; min-height: 800px; }
      
      .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }
      .loading-spinner { background: white; padding: 32px 48px; border-radius: 12px; text-align: center; }
      .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #2c5f7c; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      @media (max-width: 1200px) { .editor-layout { grid-template-columns: 1fr; } .preview-panel { display: none; } }
    </style>
  </head>
  <body>
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
      <div class="loading-spinner"><div class="spinner"></div><div>è™•ç†ä¸­...</div></div>
    </div>
    
    <div class="top-toolbar">
      <div class="top-toolbar-left">
        <button class="btn" onclick="goBack()">â† è¿”å›åˆ—è¡¨</button>
        <span id="serviceKey" style="font-weight: 600; color: #2c5f7c;"></span>
        <span id="serviceStatus" style="font-weight: 600; color: #6b7280;">è‰ç¨¿</span>
      </div>
      <div class="top-toolbar-right">
        <button class="btn" id="btnSave">ğŸ’¾ ä¿å­˜</button>
        <button class="btn secondary" id="btnPublish">âœ“ ç™¼å¸ƒ</button>
      </div>
    </div>
    
    <div class="editor-layout">
      <div class="editor-panel">
        <div class="editor-header">
          <h2>ğŸ¯ æœå‹™ä»‹ç´¹ç·¨è¼¯</h2>
          
          <div class="form-group">
            <label for="serviceTitle">æœå‹™æ¨™é¡Œ *</label>
            <input type="text" id="serviceTitle" placeholder="è¼¸å…¥æœå‹™æ¨™é¡Œ..." maxlength="100" required>
          </div>
          
          <div class="form-group">
            <label for="serviceSummary">ç°¡çŸ­æè¿°</label>
            <textarea id="serviceSummary" placeholder="ä¸€å¥è©±æè¿°æ­¤æœå‹™..." maxlength="200"></textarea>
          </div>
          
          <div class="form-group">
            <label>Hero åœ–ç‰‡</label>
            <div class="image-upload-area" id="imageUploadArea">
              <div>ğŸ“· é»æ“Šä¸Šå‚³æˆ–æ‹–æ‹½åœ–ç‰‡åˆ°é€™è£¡</div>
              <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">å»ºè­°å°ºå¯¸ï¼š1920x600pxï¼Œæœ€å¤§ 5MB</div>
              <input type="file" id="imageInput" accept="image/*" style="display: none;">
            </div>
            <div class="image-preview" id="imagePreview" style="display: none;"></div>
          </div>
        </div>
        
        <div class="editor-content">
          <div style="margin-bottom: 12px; font-weight: 600; color: #374151;">è©³ç´°å…§å®¹ *</div>
          <div id="quill-editor"></div>
        </div>
      </div>
      
      <div class="preview-panel">
        <div class="preview-header">
          <h2>ğŸ‘ï¸ å¯¦éš›ç¶²é é è¦½</h2>
        </div>
        <div class="preview-content">
          <div class="preview-iframe-wrapper">
            <iframe id="preview-frame" sandbox="allow-same-origin allow-scripts"></iframe>
          </div>
        </div>
      </div>
    </div>
    
    <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
    
    <script>
      const onProdHost = location.hostname.endsWith('horgoscpa.com');
      const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
      
      let quill = null;
      let currentServiceId = null;
      let serviceKey = '';
      let heroImageUrl = '';
      let previewUpdateTimer = null;
      
      const urlParams = new URLSearchParams(window.location.search);
      currentServiceId = urlParams.get('id');
      
      document.addEventListener('DOMContentLoaded', async () => {
        await checkAuth();
        initQuillEditor();
        initImageUpload();
        
        if (currentServiceId) {
          loadService(currentServiceId);
        } else {
          alert('è«‹å¾æœå‹™åˆ—è¡¨é¸æ“‡è¦ç·¨è¼¯çš„æœå‹™');
          location.assign('/internal/cms');
          return;
        }
        
        document.getElementById('btnSave').addEventListener('click', () => saveService(false));
        document.getElementById('btnPublish').addEventListener('click', () => saveService(true));
        
        document.getElementById('serviceTitle').addEventListener('input', schedulePreviewUpdate);
        document.getElementById('serviceSummary').addEventListener('input', schedulePreviewUpdate);
        quill.on('text-change', schedulePreviewUpdate);
      });
      
      async function checkAuth() {
        try {
          const res = await fetch(`${apiBase}/auth/me`, { credentials: 'include' });
          if (res.status === 401) {
            location.assign('/login?redirect=' + encodeURIComponent(location.pathname + location.search));
            return;
          }
          const json = await res.json();
          if (!json?.ok || !json?.data?.isAdmin) {
            alert('æ‚¨æ²’æœ‰æ¬Šé™å­˜å–æ­¤é é¢');
            location.assign('/internal/cms');
          }
        } catch (err) {
          alert('èªè­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥');
          location.assign('/login');
        }
      }
      
      function initQuillEditor() {
        quill = new Quill('#quill-editor', {
          theme: 'snow',
          modules: {
            toolbar: [
              [{ 'header': [2, 3, false] }],
              ['bold', 'italic', 'underline'],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              [{ 'indent': '-1'}, { 'indent': '+1' }],
              ['link', 'image'],
              [{ 'color': [] }],
              ['clean']
            ]
          },
          placeholder: 'é–‹å§‹æ’°å¯«æœå‹™è©³ç´°å…§å®¹...'
        });
        
        const toolbar = quill.getModule('toolbar');
        toolbar.addHandler('image', imageHandler);
      }
      
      function imageHandler() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();
        
        input.onchange = async () => {
          const file = input.files[0];
          if (!file) return;
          
          if (file.size > 5 * 1024 * 1024) {
            alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = (e) => {
            const range = quill.getSelection(true);
            quill.insertEmbed(range.index, 'image', e.target.result);
            quill.setSelection(range.index + 1);
          };
          reader.readAsDataURL(file);
        };
      }
      
      function initImageUpload() {
        const uploadArea = document.getElementById('imageUploadArea');
        const input = document.getElementById('imageInput');
        const preview = document.getElementById('imagePreview');
        
        uploadArea.addEventListener('click', () => input.click());
        
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
          uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadArea.classList.remove('dragover');
          const file = e.dataTransfer.files[0];
          if (file && file.type.startsWith('image/')) {
            handleImageUpload(file);
          }
        });
        
        input.addEventListener('change', () => {
          const file = input.files[0];
          if (file) handleImageUpload(file);
        });
      }
      
      function handleImageUpload(file) {
        if (file.size > 5 * 1024 * 1024) {
          alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          heroImageUrl = e.target.result;
          const preview = document.getElementById('imagePreview');
          preview.innerHTML = `<img src="${heroImageUrl}" alt="Hero åœ–ç‰‡">`;
          preview.style.display = 'block';
          schedulePreviewUpdate();
        };
        reader.readAsDataURL(file);
      }
      
      function schedulePreviewUpdate() {
        clearTimeout(previewUpdateTimer);
        previewUpdateTimer = setTimeout(updatePreview, 500);
      }
      
      function updatePreview() {
        const title = document.getElementById('serviceTitle').value || 'æœå‹™æ¨™é¡Œ';
        const summary = document.getElementById('serviceSummary').value || '';
        const content = quill.root.innerHTML;
        
        const previewHTML = `
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title}</title>
  <link rel="stylesheet" href="/assets/css/common.css">
  <style>
    body { margin: 0; padding: 0; }
    .preview-badge { position: fixed; top: 10px; right: 10px; background: #f59e0b; color: white; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 14px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
  </style>
</head>
<body>
  <div class="preview-badge">é è¦½æ¨¡å¼</div>
  
  <!-- å¯¼èˆªæ  -->
  <nav style="background: linear-gradient(135deg, #2c5f7c 0%, #1e4a63 100%); color: white; padding: 20px 0;">
    <div style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="font-size: 24px; font-weight: 700;">éœçˆ¾æœæ–¯æœƒè¨ˆå¸«äº‹å‹™æ‰€</div>
        <div style="display: flex; gap: 24px; font-size: 15px;">
          <a href="/" style="color: white; text-decoration: none;">é¦–é </a>
          <a href="/services.html" style="color: white; text-decoration: none; border-bottom: 2px solid white;">æœå‹™é …ç›®</a>
          <a href="/blog.html" style="color: white; text-decoration: none;">éƒ¨è½æ ¼</a>
          <a href="/team.html" style="color: white; text-decoration: none;">é—œæ–¼æˆ‘å€‘</a>
          <a href="/contact.html" style="color: white; text-decoration: none;">è¯çµ¡æˆ‘å€‘</a>
        </div>
      </div>
    </div>
  </nav>
  
  ${heroImageUrl ? `
  <div style="width: 100%; height: 400px; overflow: hidden; background: #f3f4f6;">
    <img src="${heroImageUrl}" alt="${title}" style="width: 100%; height: 100%; object-fit: cover;">
  </div>
  ` : ''}
  
  <!-- æœåŠ¡å†…å®¹ -->
  <div style="max-width: 1000px; margin: 60px auto; padding: 0 24px;">
    <header style="text-align: center; margin-bottom: 48px;">
      <h1 style="font-size: 42px; font-weight: 700; color: #1f2937; margin: 0 0 16px 0;">${title}</h1>
      ${summary ? `<p style="font-size: 20px; color: #6b7280; margin: 0;">${summary}</p>` : ''}
    </header>
    
    <div style="font-size: 18px; line-height: 1.8; color: #374151;">
      ${content || '<p style="color: #9ca3af; text-align: center; padding: 60px 0;">é–‹å§‹æ’°å¯«å…§å®¹...</p>'}
    </div>
  </div>
  
  <!-- é¡µè„š -->
  <footer style="background: #1f2937; color: white; padding: 60px 0 30px; margin-top: 80px;">
    <div style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
      <div style="text-align: center; color: #6b7280; padding-top: 24px;">
        Â© ${new Date().getFullYear()} éœçˆ¾æœæ–¯æœƒè¨ˆå¸«äº‹å‹™æ‰€ ç‰ˆæ¬Šæ‰€æœ‰
      </div>
    </div>
  </footer>
</body>
</html>
        `;
        
        const iframe = document.getElementById('preview-frame');
        iframe.srcdoc = previewHTML;
      }
      
      async function loadService(id) {
        try {
          showLoading();
          const res = await fetch(`${apiBase}/admin/services/${id}`, { credentials: 'include' });
          if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
          
          const json = await res.json();
          if (!json.ok) throw new Error(json.message || 'è¼‰å…¥å¤±æ•—');
          
          const service = json.data;
          serviceKey = service.key;
          document.getElementById('serviceKey').textContent = service.key;
          document.getElementById('serviceTitle').value = service.title || '';
          document.getElementById('serviceSummary').value = service.summary || '';
          quill.root.innerHTML = service.content || '';
          
          if (service.heroImage) {
            heroImageUrl = service.heroImage;
            document.getElementById('imagePreview').innerHTML = `<img src="${heroImageUrl}">`;
            document.getElementById('imagePreview').style.display = 'block';
          }
          
          if (service.isPublished) {
            document.getElementById('serviceStatus').textContent = 'å·²ç™¼å¸ƒ';
            document.getElementById('serviceStatus').style.color = '#10b981';
          }
          
          updatePreview();
        } catch (err) {
          alert('è¼‰å…¥æœå‹™å¤±æ•—ï¼š' + err.message);
          console.error(err);
          location.assign('/internal/cms');
        } finally {
          hideLoading();
        }
      }
      
      async function saveService(publish = false) {
        const title = document.getElementById('serviceTitle').value.trim();
        if (!title) {
          alert('è«‹è¼¸å…¥æœå‹™æ¨™é¡Œ');
          return;
        }
        
        const content = quill.root.innerHTML;
        if (!content || content === '<p><br></p>') {
          alert('è«‹è¼¸å…¥æœå‹™å…§å®¹');
          return;
        }
        
        const data = {
          title,
          summary: document.getElementById('serviceSummary').value.trim(),
          content,
          heroImage: heroImageUrl,
          isPublished: publish
        };
        
        try {
          showLoading();
          const res = await fetch(`${apiBase}/admin/services/${currentServiceId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
          });
          
          const json = await res.json();
          if (!res.ok || !json.ok) {
            throw new Error(json.message || 'ä¿å­˜å¤±æ•—');
          }
          
          alert(publish ? 'æœå‹™å·²ç™¼å¸ƒï¼' : 'æœå‹™å·²ä¿å­˜ï¼');
          
          if (publish) {
            document.getElementById('serviceStatus').textContent = 'å·²ç™¼å¸ƒ';
            document.getElementById('serviceStatus').style.color = '#10b981';
          }
        } catch (err) {
          alert('ä¿å­˜å¤±æ•—ï¼š' + err.message);
          console.error(err);
        } finally {
          hideLoading();
        }
      }
      
      function goBack() {
        if (confirm('ç¢ºå®šè¦é›¢é–‹ï¼Ÿæœªä¿å­˜çš„å…§å®¹å°‡æœƒä¸Ÿå¤±ã€‚')) {
          location.assign('/internal/cms');
        }
      }
      
      function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
      }
      
      function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
      }
    </script>
  </body>
</html>

