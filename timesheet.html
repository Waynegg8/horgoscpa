<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="霍爾果斯會計師事務所工時系統，管理員工工時與請假記錄。" />
  <title>工時系統 | 霍爾果斯會計師事務所</title>
  
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  
  <!-- Material Symbols 圖示庫 -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <!-- 樣式 -->
  <link rel="stylesheet" href="/assets/css/internal-system.css" />
  
  <style>
    /* 覆蓋內部系統樣式，工時表需要更大的空間 */
    .internal-main {
      padding: 15px;
      max-width: 100%;
    }

    .internal-container {
      max-width: 100%;
      padding: 0;
    }

    main {
      max-width: 98%;
      width: 98%;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 20px;
    }
    
    @media (max-width: 768px) {
      main {
        margin: 80px 15px 40px;
        padding: 20px;
      }
    }
    
    .page-header {
      margin-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 20px;
    }
    
    .page-header h2 {
      color: #1b65b8;
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .page-header p {
      color: #666;
      font-size: 15px;
    }
    
    .month-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #1b65b8 0%, #0f4f94 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .month-info h3 {
      margin: 0;
      font-size: 20px;
    }
    
    .month-info .total-hours {
      font-size: 16px;
      font-weight: 600;
    }
    
    .control-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-group label {
      font-weight: 500;
      color: #333;
      white-space: nowrap;
    }
    
    select, input {
      font-size: 15px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fff;
      transition: border-color 0.2s;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #1b65b8;
    }
    
    select:disabled, input:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
    }
    
    button {
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: #1b65b8;
      color: #fff;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #0f4f94;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(27, 101, 184, 0.3);
    }
    
    .btn-gray {
      background: #6c757d;
      color: #fff;
    }
    
    .btn-gray:hover:not(:disabled) {
      background: #5a6268;
    }
    
    .btn-success {
      background: #28a745;
      color: #fff;
    }
    
    .btn-success:hover:not(:disabled) {
      background: #218838;
    }
    
    .message-box {
      padding: 12px 16px;
      border-radius: 6px;
      margin: 15px 0;
      display: none;
      align-items: center;
      gap: 8px;
    }
    
    .message-box.show {
      display: flex;
    }
    
    .error-message {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      color: #856404;
    }
    
    .success-message {
      background: #d4edda;
      border-left: 4px solid #28a745;
      color: #155724;
    }
    
    .loading-message {
      background: #d1ecf1;
      border-left: 4px solid #17a2b8;
      color: #0c5460;
    }
    
    .table-container {
      overflow-x: visible;
      margin-top: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 100%;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
      table-layout: fixed;
      background: white;
    }
    
    th, td {
      border: 1px solid #e3e3e3;
      padding: 6px 3px;
      text-align: center;
      white-space: nowrap;
    }
    
    thead tr:first-child th {
      background: #1b65b8;
      color: #fff;
      font-weight: 600;
      font-size: 10px;
      padding: 8px 3px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    thead tr:nth-child(2) th {
      background: #3a7bc8;
      color: #fff;
      font-weight: 500;
      font-size: 9px;
      padding: 4px 3px;
      position: sticky;
      top: 32px;
      z-index: 10;
    }
    
    /* 固定左側欄位 */
    th:first-child,
    td:first-child {
      position: sticky;
      left: 0;
      z-index: 5;
      background: white;
      font-weight: 600;
      width: 140px;
      min-width: 140px;
      text-align: left;
      padding-left: 8px;
      white-space: normal;
      word-wrap: break-word;
      font-size: 10px;
    }
    
    th:nth-child(2),
    td:nth-child(2) {
      position: sticky;
      left: 140px;
      z-index: 5;
      background: white;
      width: 90px;
      min-width: 90px;
      text-align: left;
      padding-left: 8px;
      font-size: 10px;
    }
    
    th:nth-child(3),
    td:nth-child(3) {
      position: sticky;
      left: 230px;
      z-index: 5;
      background: white;
      width: 100px;
      min-width: 100px;
      text-align: left;
      padding-left: 8px;
      font-size: 10px;
    }
    
    thead th:first-child,
    thead th:nth-child(2),
    thead th:nth-child(3) {
      background: #1b65b8;
      z-index: 15;
    }
    
    /* 日期欄位 */
    .day-cell {
      width: 30px;
      min-width: 30px;
      max-width: 30px;
      font-size: 10px;
      font-weight: 500;
      padding: 4px 2px;
    }
    
    /* 週末標示 */
    .weekend {
      background: #fff3cd !important;
    }
    
    /* 國定假日標示 */
    .holiday {
      background: #fde4e4 !important;
    }
    
    tbody tr:nth-child(even) td {
      background: #f8f9fa;
    }
    
    tbody tr:nth-child(even) td:first-child,
    tbody tr:nth-child(even) td:nth-child(2),
    tbody tr:nth-child(even) td:nth-child(3) {
      background: #f8f9fa;
    }
    
    tbody tr:hover td {
      background: #e7f3ff !important;
    }
    
    /* 有數值的格子 */
    .has-value {
      background: #d4edda !important;
      font-weight: 600;
      color: #155724;
    }
    
    /* 可編輯的儲存格 */
    .day-cell.editable {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .day-cell.editable:hover {
      background: #fff9c4 !important;
      box-shadow: inset 0 0 0 2px #1b65b8;
    }
    
    .day-cell input {
      width: 100%;
      border: none;
      background: transparent;
      text-align: center;
      font-size: inherit;
      padding: 2px;
      outline: none;
    }
    
    .day-cell input:focus {
      background: #fff;
      box-shadow: inset 0 0 0 2px #1b65b8;
    }
    
    /* 請假標示 */
    .leave-cell {
      background: #d1ecf1 !important;
      font-weight: 600;
      color: #0c5460;
    }
    
    /* 刪除按鈕 */
    .delete-row-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.2s;
    }
    
    .delete-row-btn:hover {
      background: #c82333;
    }
    
    .delete-row-btn .material-symbols-rounded {
      font-size: 16px;
    }
    
    /* 對話框 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .modal-header h3 {
      margin: 0;
      color: #1b65b8;
      font-size: 22px;
    }
    
    .modal-body {
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #333;
    }
    
    .form-group select,
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 15px;
    }
    
    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #1b65b8;
      box-shadow: 0 0 0 3px rgba(27, 101, 184, 0.1);
    }
    
    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .btn-cancel {
      background: #6c757d;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      transition: background 0.2s;
    }
    
    .btn-cancel:hover {
      background: #5a6268;
    }
    
    .btn-confirm {
      background: #1b65b8;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      transition: background 0.2s;
    }
    
    .btn-confirm:hover {
      background: #0f4f94;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    
    .empty-state .material-symbols-rounded {
      font-size: 64px;
      color: #ddd;
      margin-bottom: 15px;
    }
    
    /* 月總計欄 */
    .total-cell {
      background: #1b65b8 !important;
      color: white !important;
      font-weight: 700;
      position: sticky;
      right: 0;
      z-index: 5;
      width: 60px;
      min-width: 60px;
      max-width: 60px;
      font-size: 10px;
    }
    
    @media (max-width: 1600px) {
      main {
        max-width: 99%;
        width: 99%;
      }
      
      .day-cell {
        width: 26px;
        min-width: 26px;
        max-width: 26px;
        font-size: 9px;
        padding: 3px 1px;
      }
      
      table {
        font-size: 9px;
      }
    }
    
    @media (max-width: 1400px) {
      .table-container {
        overflow-x: auto;
      }
      
      th:first-child,
      td:first-child {
        width: 120px;
        min-width: 120px;
        font-size: 9px;
      }
      
      th:nth-child(2),
      td:nth-child(2) {
        left: 120px;
        width: 80px;
        min-width: 80px;
        font-size: 9px;
      }
      
      th:nth-child(3),
      td:nth-child(3) {
        left: 200px;
        width: 90px;
        min-width: 90px;
        font-size: 9px;
      }
      
      .day-cell {
        width: 24px;
        min-width: 24px;
        max-width: 24px;
        font-size: 8px;
        padding: 2px 1px;
      }
    }
    
    @media (max-width: 768px) {
      .control-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .control-group {
        flex-direction: column;
        align-items: stretch;
        gap: 5px;
      }
      
      select, input, button {
        width: 100%;
      }
      
      .table-container {
        overflow-x: auto;
      }
      
      table {
        font-size: 8px;
      }
      
      th, td {
        padding: 3px 1px;
      }
      
      th:first-child,
      td:first-child {
        width: 100px;
        min-width: 100px;
        font-size: 8px;
      }
      
      th:nth-child(2),
      td:nth-child(2) {
        left: 100px;
        width: 70px;
        min-width: 70px;
        font-size: 8px;
      }
      
      th:nth-child(3),
      td:nth-child(3) {
        left: 170px;
        width: 75px;
        min-width: 75px;
        font-size: 8px;
      }
      
      .day-cell {
        width: 22px;
        min-width: 22px;
        max-width: 22px;
        font-size: 7px;
        padding: 2px 1px;
      }
      
      .total-cell {
        width: 50px;
        min-width: 50px;
        max-width: 50px;
        font-size: 8px;
      }
    }
  </style>
</head>

<body>
  <!-- 簡潔的內部導航欄 -->
  <nav class="internal-navbar">
    <div class="internal-nav-container">
      <a href="index.html" class="internal-nav-brand">
        <img src="assets/images/logo-white.png" alt="霍爾果斯">
        <span>工時管理系統</span>
      </a>
      
      <button class="internal-mobile-toggle" id="mobileToggle">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <div class="internal-nav-links" id="navLinks">
        <a href="timesheet.html" class="internal-nav-link active">
          <span class="material-symbols-rounded">calendar_month</span>
          工時表
        </a>
        <a href="reports.html" class="internal-nav-link">
          <span class="material-symbols-rounded">assessment</span>
          報表
        </a>
        <a href="settings.html" class="internal-nav-link">
          <span class="material-symbols-rounded">settings</span>
          設定
        </a>
        
        <div class="internal-nav-user">
          <div>
            <div class="internal-user-name" id="userName">載入中...</div>
            <div class="internal-user-role" id="userRole"></div>
          </div>
          <button class="internal-logout-btn" id="logoutBtn">登出</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="internal-main">
    <div class="internal-container">
  <main>
    <div class="page-header">
      <h2>工時與請假紀錄</h2>
      <p>管理員工工時記錄與請假資料</p>
    </div>

    <div class="control-row">
      <div class="control-group">
        <label>選擇員工：</label>
        <select id="employee" disabled>
          <option value="">載入中...</option>
        </select>
      </div>

      <div class="control-group">
        <label>年份：</label>
        <input type="number" id="year" value="2025" min="2020" max="2030">
      </div>

      <div class="control-group">
        <label>月份：</label>
        <select id="month">
          <option value="1">1月</option>
          <option value="2">2月</option>
          <option value="3">3月</option>
          <option value="4">4月</option>
          <option value="5">5月</option>
          <option value="6">6月</option>
          <option value="7">7月</option>
          <option value="8">8月</option>
          <option value="9">9月</option>
          <option value="10">10月</option>
          <option value="11">11月</option>
          <option value="12">12月</option>
        </select>
      </div>

      <button class="btn-gray" id="addWorkBtn">
        <span class="material-symbols-rounded">add</span>
        增加工時記錄
      </button>
      <button class="btn-gray" id="addLeaveBtn">
        <span class="material-symbols-rounded">event_note</span>
        增加請假記錄
      </button>
      <button class="btn-success" id="saveBtn">
        <span class="material-symbols-rounded">save</span>
        儲存本月變更
      </button>
    </div>

    <div id="errorMsg" class="message-box error-message"></div>
    <div id="loadingMsg" class="message-box loading-message">
      <span class="material-symbols-rounded">hourglass_empty</span>
      <span>正在載入資料...</span>
    </div>

    <div class="month-info" id="monthInfo" style="display:none;">
      <h3 id="monthTitle">2025年10月 - 員工名稱</h3>
      <div class="total-hours">
        總工時：<span id="totalHours">0</span> 小時
      </div>
    </div>

    <div class="table-container">
      <table id="dataTable">
        <thead id="tableHead">
          <tr>
            <th>客戶名稱</th>
            <th>業務類型</th>
            <th>工時類型</th>
            <th colspan="31">請選擇員工和日期</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="35" class="empty-state">
              <div class="material-symbols-rounded">inbox</div>
              <div>請選擇員工和日期</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>
    </div>
  </div>

  <!-- 增加工時記錄對話框 -->
  <div id="addWorkModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>增加工時記錄</h3>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>客戶名稱 *</label>
          <select id="workClient">
            <option value="">請選擇客戶</option>
          </select>
        </div>
        <div class="form-group">
          <label>業務類型 *</label>
          <select id="workBusinessType">
            <option value="">請選擇業務類型</option>
          </select>
        </div>
        <div class="form-group">
          <label>工時類型 *</label>
          <select id="workType">
            <option value="">請選擇工時類型</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" id="cancelWorkBtn">取消</button>
        <button class="btn-confirm" id="confirmWorkBtn">確定</button>
      </div>
    </div>
  </div>

  <!-- 增加請假記錄對話框 -->
  <div id="addLeaveModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>增加請假記錄</h3>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>假別 *</label>
          <select id="leaveType">
            <option value="">請選擇假別</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" id="cancelLeaveBtn">取消</button>
        <button class="btn-confirm" id="confirmLeaveBtn">確定</button>
      </div>
    </div>
  </div>

  <!-- 簡化的頁尾 -->
  <footer class="internal-footer">
    &copy; 2024 霍爾果斯會計師事務所 工時管理系統
  </footer>

  <!-- 導航欄腳本 -->
  <script>
    // 移動端選單切換
    const mobileToggle = document.getElementById('mobileToggle');
    const navLinks = document.getElementById('navLinks');
    
    if (mobileToggle && navLinks) {
      mobileToggle.addEventListener('click', () => {
        navLinks.classList.toggle('active');
      });
      
      // 點擊選單外部關閉選單
      document.addEventListener('click', (e) => {
        if (!mobileToggle.contains(e.target) && !navLinks.contains(e.target)) {
          navLinks.classList.remove('active');
        }
      });
    }
  </script>

  <!-- 工時系統主要功能腳本 -->
  <script>
    const WORKER_URL = 'https://timesheet-api.hergscpa.workers.dev';
    let holidaysCache = null;
    let currentUser = null;
    let sessionToken = null;
    
    // 編輯狀態
    let currentData = {
      workEntries: [],
      leaveEntries: []
    };
    let clientsCache = [];
    let businessTypesCache = [];
    let leaveTypesCache = [];
    let workTypesCache = [];
    let hasChanges = false;

    // 頁面載入時初始化
    document.addEventListener('DOMContentLoaded', async () => {
      // 檢查登入狀態
      if (!await checkAuth()) {
        window.location.href = '/login.html';
        return;
      }
      
      setCurrentMonth();
      await loadEmployees();
      setupEventListeners();
    });
    
    // 檢查認證狀態
    async function checkAuth() {
      sessionToken = localStorage.getItem('session_token');
      if (!sessionToken) {
        return false;
      }
      
      try {
        const response = await fetch(`${WORKER_URL}/api/verify`, {
          headers: {
            'Authorization': `Bearer ${sessionToken}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          currentUser = data.user;
          
          // 顯示使用者資訊
          updateUserInfo();
          return true;
        }
      } catch (err) {
        console.error('驗證失敗:', err);
      }
      
      return false;
    }
    
    // 更新使用者資訊顯示
    function updateUserInfo() {
      const userNameEl = document.getElementById('userName');
      const userRoleEl = document.getElementById('userRole');
      const employeeSelect = document.getElementById('employee');
      
      if (currentUser) {
        const displayName = currentUser.employee_name || currentUser.username;
        const roleText = currentUser.role === 'admin' ? '管理員' : '員工';
        userNameEl.textContent = displayName;
        userRoleEl.textContent = roleText;
        
        // 如果是管理員，不需要顯示額外的管理選單（已經在導航欄中有設定鏈接）
        if (currentUser.role === 'admin') {
          // 管理員可以選擇任何員工的工時表
        }
        
        // 如果是員工，只能看自己的資料
        if (currentUser.role === 'employee' && currentUser.employee_name) {
          // 員工載入後自動選擇自己
          setTimeout(() => {
            if (employeeSelect && employeeSelect.options.length > 0) {
              employeeSelect.value = currentUser.employee_name;
              // 觸發載入
              loadTimesheetData();
            }
          }, 100);
        }
      }
    }
    
    // 登出功能
    document.addEventListener('DOMContentLoaded', () => {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          
          try {
            await apiRequest(`${WORKER_URL}/api/logout`, {
              method: 'POST'
            });
          } catch (err) {
            console.error('登出錯誤:', err);
          }
          
          // 清除本地資料
          localStorage.removeItem('session_token');
          localStorage.removeItem('user_info');
          
          // 跳轉到登入頁
          window.location.href = '/login.html';
        });
      }
    });
    
    // API 請求包裝函數（自動加入認證標頭）
    async function apiRequest(url, options = {}) {
      const headers = {
        ...options.headers,
        'Authorization': `Bearer ${sessionToken}`
      };
      
      if (options.body && typeof options.body === 'object') {
        headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(options.body);
      }
      
      const response = await fetch(url, {
        ...options,
        headers
      });
      
      // 如果未授權，跳轉到登入頁面
      if (response.status === 401) {
        localStorage.removeItem('session_token');
        localStorage.removeItem('user_info');
        window.location.href = '/login.html';
        return null;
      }
      
      return response;
    }

    // 設定事件監聽器
    function setupEventListeners() {
      const employeeSelect = document.getElementById('employee');
      const yearInput = document.getElementById('year');
      const monthSelect = document.getElementById('month');

      // 當員工、年份或月份改變時自動載入資料
      employeeSelect.addEventListener('change', loadTimesheetData);
      yearInput.addEventListener('change', loadTimesheetData);
      monthSelect.addEventListener('change', loadTimesheetData);
      
      // 按鈕事件
      document.getElementById('addWorkBtn').addEventListener('click', showAddWorkModal);
      document.getElementById('addLeaveBtn').addEventListener('click', showAddLeaveModal);
      document.getElementById('saveBtn').addEventListener('click', saveTimesheet);
      
      // 對話框按鈕事件
      document.getElementById('cancelWorkBtn').addEventListener('click', hideAddWorkModal);
      document.getElementById('confirmWorkBtn').addEventListener('click', confirmAddWork);
      document.getElementById('cancelLeaveBtn').addEventListener('click', hideAddLeaveModal);
      document.getElementById('confirmLeaveBtn').addEventListener('click', confirmAddLeave);
      
      // 點擊對話框外部關閉
      document.getElementById('addWorkModal').addEventListener('click', (e) => {
        if (e.target.id === 'addWorkModal') hideAddWorkModal();
      });
      document.getElementById('addLeaveModal').addEventListener('click', (e) => {
        if (e.target.id === 'addLeaveModal') hideAddLeaveModal();
      });
    }

    // 載入員工列表
    async function loadEmployees() {
      const employeeSelect = document.getElementById('employee');
      
      try {
        const res = await apiRequest(`${WORKER_URL}/api/employees`);
        if (!res) return;
        const employees = await res.json();

        if (!res.ok || !Array.isArray(employees)) {
          throw new Error('無法載入員工列表');
        }

        // 清空並填充員工選項
        employeeSelect.innerHTML = '';
        
        if (employees.length === 0) {
          employeeSelect.innerHTML = '<option value="">無員工資料</option>';
          showError('資料庫中沒有員工資料');
          return;
        }

        employees.forEach(emp => {
          const option = document.createElement('option');
          option.value = emp.name;
          option.textContent = emp.name;
          employeeSelect.appendChild(option);
        });

        // 啟用控制項
        employeeSelect.disabled = false;

        // 自動載入第一個員工的資料
        if (employees.length > 0) {
          await loadTimesheetData();
        }

      } catch (err) {
        employeeSelect.innerHTML = '<option value="">載入失敗</option>';
        showError('載入員工列表失敗：' + err.message);
      }
    }

    // 設定當前月份
    function setCurrentMonth() {
      const now = new Date();
      const currentMonth = now.getMonth() + 1;
      const currentYear = now.getFullYear();
      const monthSelect = document.getElementById('month');
      const yearInput = document.getElementById('year');
      
      monthSelect.value = currentMonth;
      yearInput.value = currentYear;
    }

    // 載入國定假日
    async function loadHolidays(year) {
      try {
        const res = await apiRequest(`${WORKER_URL}/api/holidays?year=${year}`);
        if (!res) return [];
        const holidays = await res.json();
        holidaysCache = holidays || [];
        return holidaysCache;
      } catch (err) {
        console.error('載入假日失敗:', err);
        return [];
      }
    }
    
    // 載入客戶列表
    async function loadClients(employee) {
      try {
        const res = await apiRequest(`${WORKER_URL}/api/clients?employee=${encodeURIComponent(employee)}`);
        if (!res) return [];
        const clients = await res.json();
        clientsCache = clients || [];
        return clientsCache;
      } catch (err) {
        console.error('載入客戶失敗:', err);
        return [];
      }
    }
    
    // 載入業務類型
    async function loadBusinessTypes() {
      try {
        const res = await apiRequest(`${WORKER_URL}/api/business-types`);
        if (!res) return [];
        const types = await res.json();
        // API 現在返回完整對象，需要提取 name 欄位
        businessTypesCache = types.map(t => t.name || t.type_name || t) || [];
        return businessTypesCache;
      } catch (err) {
        console.error('載入業務類型失敗:', err);
        return [];
      }
    }
    
    // 載入請假類型
    async function loadLeaveTypes() {
      try {
        const res = await apiRequest(`${WORKER_URL}/api/leave-types`);
        if (!res) return [];
        const types = await res.json();
        // API 現在返回完整對象，需要提取 type_name 欄位
        leaveTypesCache = types.map(t => t.type_name || t.name || t) || [];
        return leaveTypesCache;
      } catch (err) {
        console.error('載入請假類型失敗:', err);
        return [];
      }
    }
    
    // 載入工時類型
    async function loadWorkTypes() {
      try {
        const res = await apiRequest(`${WORKER_URL}/api/work-types`);
        if (!res) return [];
        const types = await res.json();
        workTypesCache = types || [];
        return workTypesCache;
      } catch (err) {
        console.error('載入工時類型失敗:', err);
        return [];
      }
    }

    // 檢查是否為假日
    function isHoliday(dateStr) {
      return holidaysCache && holidaysCache.includes(dateStr);
    }

    // 檢查是否為週末
    function isWeekend(year, month, day) {
      const date = new Date(year, month - 1, day);
      const dayOfWeek = date.getDay();
      return dayOfWeek === 0 || dayOfWeek === 6; // 0=週日, 6=週六
    }

    // 取得星期文字
    function getWeekdayText(year, month, day) {
      const date = new Date(year, month - 1, day);
      const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
      return '週' + weekdays[date.getDay()];
    }

    // 載入工時資料
    async function loadTimesheetData() {
      const emp = document.getElementById('employee').value;
      const year = parseInt(document.getElementById('year').value);
      const month = parseInt(document.getElementById('month').value);
      const tableHead = document.getElementById('tableHead');
      const tableBody = document.getElementById('tableBody');
      const monthInfo = document.getElementById('monthInfo');

      if (!emp) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="35" class="empty-state">
              <div class="material-symbols-rounded">inbox</div>
              <div>請選擇員工</div>
            </td>
          </tr>
        `;
        monthInfo.style.display = 'none';
        return;
      }

      hideMessages();
      showLoading(true);

      try {
        // 並行載入所有必要資料
        await Promise.all([
          loadHolidays(year),
          loadClients(emp),
          loadBusinessTypes(),
          loadLeaveTypes(),
          loadWorkTypes()
        ]);
        
        const res = await apiRequest(`${WORKER_URL}/api/timesheet-data?employee=${encodeURIComponent(emp)}&year=${year}&month=${month}`);
        if (!res) return;
        const data = await res.json();

        showLoading(false);

        if (!res.ok || data.error) {
          showError(`載入資料失敗：${data.error || res.status}`);
          return;
        }

        // 更新月份資訊
        document.getElementById('monthTitle').textContent = `${year}年${month}月 - ${emp}`;
        monthInfo.style.display = 'flex';

        // 儲存當前資料
        currentData.workEntries = data.workEntries || [];
        currentData.leaveEntries = data.leaveEntries || [];
        hasChanges = false;

        // 計算該月天數
        const daysInMonth = new Date(year, month, 0).getDate();

        // 生成表頭
        generateTableHeader(year, month, daysInMonth);

        // 生成表格內容
        generateTableBody(year, month, daysInMonth);

      } catch (err) {
        showLoading(false);
        showError('載入資料時發生錯誤：' + err.message);
      }
    }

    // 生成表頭
    function generateTableHeader(year, month, daysInMonth) {
      const tableHead = document.getElementById('tableHead');
      
      // 第一行：日期
      let headerRow1 = '<tr><th>客戶名稱</th><th>業務類型</th><th>工時類型</th>';
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isHol = isHoliday(dateStr);
        const isWe = isWeekend(year, month, day);
        const className = isHol ? 'holiday' : (isWe ? 'weekend' : '');
        headerRow1 += `<th class="day-cell ${className}">${day}</th>`;
      }
      headerRow1 += '<th class="total-cell">月總計</th></tr>';

      // 第二行：星期
      let headerRow2 = '<tr><th></th><th></th><th></th>';
      for (let day = 1; day <= daysInMonth; day++) {
        const weekdayText = getWeekdayText(year, month, day);
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isHol = isHoliday(dateStr);
        const isWe = isWeekend(year, month, day);
        const className = isHol ? 'holiday' : (isWe ? 'weekend' : '');
        headerRow2 += `<th class="day-cell ${className}">${weekdayText}</th>`;
      }
      headerRow2 += '<th class="total-cell">小時</th></tr>';

      tableHead.innerHTML = headerRow1 + headerRow2;
    }

    // 生成表格內容
    function generateTableBody(year, month, daysInMonth) {
      const tableBody = document.getElementById('tableBody');
      
      // 合併工時和請假資料
      const allEntries = [];
      
      // 處理工時資料
      currentData.workEntries.forEach((entry, index) => {
        allEntries.push({
          type: 'work',
          index: index,
          clientName: entry.clientName || '-',
          businessType: entry.businessType || '-',
          workType: entry.workType || '-',
          hours: entry.hours || {}
        });
      });

      // 處理請假資料
      currentData.leaveEntries.forEach((entry, index) => {
        allEntries.push({
          type: 'leave',
          index: index,
          clientName: '-',
          businessType: '-',
          workType: entry.leaveType || '-',
          hours: entry.hours || {}
        });
      });

      // 如果沒有資料
      if (allEntries.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="${daysInMonth + 4}" class="empty-state">
              <div class="material-symbols-rounded">event_busy</div>
              <div>本月尚無工時或請假記錄，請點選上方按鈕新增</div>
            </td>
          </tr>
        `;
        document.getElementById('totalHours').textContent = '0';
        return;
      }

      // 生成表格行
      let totalAllHours = 0;
      tableBody.innerHTML = '';
      
      allEntries.forEach((entry, rowIndex) => {
        const tr = document.createElement('tr');
        
        // 第一欄：客戶名稱 + 刪除按鈕
        const firstCol = document.createElement('td');
        firstCol.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 5px;">
            <span>${entry.clientName}</span>
            <button class="delete-row-btn" onclick="deleteEntry('${entry.type}', ${entry.index})">
              <span class="material-symbols-rounded">delete</span>
            </button>
          </div>
        `;
        tr.appendChild(firstCol);
        
        // 第二欄：業務類型
        const secondCol = document.createElement('td');
        secondCol.textContent = entry.businessType;
        tr.appendChild(secondCol);
        
        // 第三欄：工時/假別類型
        const thirdCol = document.createElement('td');
        thirdCol.textContent = entry.workType;
        tr.appendChild(thirdCol);

        // 日期欄位（可編輯）
        let rowTotal = 0;
        for (let day = 1; day <= daysInMonth; day++) {
          const hours = entry.hours[day] || '';
          const td = document.createElement('td');
          td.className = 'day-cell editable';
          
          if (hours) {
            td.classList.add(entry.type === 'leave' ? 'leave-cell' : 'has-value');
          }
          
          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.max = '24';
          input.step = '0.5';
          input.value = hours;
          input.placeholder = '';
          input.addEventListener('input', (e) => {
            updateCellValue(entry.type, entry.index, day, e.target.value);
          });
          
          td.appendChild(input);
          tr.appendChild(td);
          
          if (hours) rowTotal += parseFloat(hours);
        }

        // 月總計欄
        const totalCol = document.createElement('td');
        totalCol.className = 'total-cell';
        totalCol.textContent = rowTotal.toFixed(1);
        totalCol.id = `total-${entry.type}-${entry.index}`;
        tr.appendChild(totalCol);
        
        tableBody.appendChild(tr);
        totalAllHours += rowTotal;
      });

      // 更新總工時
      document.getElementById('totalHours').textContent = totalAllHours.toFixed(1);
    }

    // 顯示錯誤訊息
    function showError(message) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.innerHTML = `<span class="material-symbols-rounded">error</span><span>${message}</span>`;
      errorMsg.classList.add('show');
      
      // 3秒後自動隱藏錯誤訊息
      setTimeout(() => {
        errorMsg.classList.remove('show');
      }, 3000);
    }

    // 顯示載入狀態
    function showLoading(show) {
      const loadingMsg = document.getElementById('loadingMsg');
      if (show) {
        loadingMsg.classList.add('show');
      } else {
        loadingMsg.classList.remove('show');
      }
    }

    // 隱藏所有訊息
    function hideMessages() {
      document.getElementById('errorMsg').classList.remove('show');
      document.getElementById('loadingMsg').classList.remove('show');
    }
    
    // 更新儲存格值
    function updateCellValue(type, index, day, value) {
      const numValue = value ? parseFloat(value) : 0;
      
      if (type === 'work') {
        if (!currentData.workEntries[index].hours) {
          currentData.workEntries[index].hours = {};
        }
        if (numValue > 0) {
          currentData.workEntries[index].hours[day] = numValue;
        } else {
          delete currentData.workEntries[index].hours[day];
        }
      } else if (type === 'leave') {
        if (!currentData.leaveEntries[index].hours) {
          currentData.leaveEntries[index].hours = {};
        }
        if (numValue > 0) {
          currentData.leaveEntries[index].hours[day] = numValue;
        } else {
          delete currentData.leaveEntries[index].hours[day];
        }
      }
      
      hasChanges = true;
      updateRowTotal(type, index);
      updateGrandTotal();
    }
    
    // 更新單行總計
    function updateRowTotal(type, index) {
      const entry = type === 'work' ? currentData.workEntries[index] : currentData.leaveEntries[index];
      let total = 0;
      for (const day in entry.hours) {
        total += entry.hours[day];
      }
      const totalEl = document.getElementById(`total-${type}-${index}`);
      if (totalEl) {
        totalEl.textContent = total.toFixed(1);
      }
    }
    
    // 更新總工時
    function updateGrandTotal() {
      let total = 0;
      
      currentData.workEntries.forEach(entry => {
        for (const day in entry.hours) {
          total += entry.hours[day];
        }
      });
      
      currentData.leaveEntries.forEach(entry => {
        for (const day in entry.hours) {
          total += entry.hours[day];
        }
      });
      
      document.getElementById('totalHours').textContent = total.toFixed(1);
    }
    
    // 刪除條目
    function deleteEntry(type, index) {
      if (!confirm('確定要刪除這筆記錄嗎？')) return;
      
      if (type === 'work') {
        currentData.workEntries.splice(index, 1);
      } else {
        currentData.leaveEntries.splice(index, 1);
      }
      
      hasChanges = true;
      
      // 重新生成表格
      const year = parseInt(document.getElementById('year').value);
      const month = parseInt(document.getElementById('month').value);
      const daysInMonth = new Date(year, month, 0).getDate();
      generateTableBody(year, month, daysInMonth);
    }
    
    // 顯示增加工時對話框
    function showAddWorkModal() {
      const emp = document.getElementById('employee').value;
      if (!emp) {
        showError('請先選擇員工');
        return;
      }
      
      // 填充客戶下拉選單
      const clientSelect = document.getElementById('workClient');
      clientSelect.innerHTML = '<option value="">請選擇客戶</option>';
      clientsCache.forEach(client => {
        const option = document.createElement('option');
        option.value = client;
        option.textContent = client;
        clientSelect.appendChild(option);
      });
      
      // 填充業務類型下拉選單
      const businessTypeSelect = document.getElementById('workBusinessType');
      businessTypeSelect.innerHTML = '<option value="">請選擇業務類型</option>';
      businessTypesCache.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        businessTypeSelect.appendChild(option);
      });
      
      // 填充工時類型下拉選單
      const workTypeSelect = document.getElementById('workType');
      workTypeSelect.innerHTML = '<option value="">請選擇工時類型</option>';
      workTypesCache.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        workTypeSelect.appendChild(option);
      });
      
      document.getElementById('addWorkModal').classList.add('show');
    }
    
    // 隱藏增加工時對話框
    function hideAddWorkModal() {
      document.getElementById('addWorkModal').classList.remove('show');
      document.getElementById('workClient').value = '';
      document.getElementById('workBusinessType').value = '';
      document.getElementById('workType').value = '';
    }
    
    // 確認增加工時
    function confirmAddWork() {
      const clientName = document.getElementById('workClient').value;
      const businessType = document.getElementById('workBusinessType').value;
      const workType = document.getElementById('workType').value;
      
      if (!clientName || !businessType || !workType) {
        alert('請填寫所有必填欄位');
        return;
      }
      
      // 檢查是否已存在相同的記錄
      const exists = currentData.workEntries.some(entry => 
        entry.clientName === clientName && 
        entry.businessType === businessType && 
        entry.workType === workType
      );
      
      if (exists) {
        alert('此工時記錄已存在，請直接在表格中編輯');
        return;
      }
      
      // 新增記錄
      currentData.workEntries.push({
        clientName,
        businessType,
        workType,
        hours: {}
      });
      
      hasChanges = true;
      hideAddWorkModal();
      
      // 重新生成表格
      const year = parseInt(document.getElementById('year').value);
      const month = parseInt(document.getElementById('month').value);
      const daysInMonth = new Date(year, month, 0).getDate();
      generateTableBody(year, month, daysInMonth);
    }
    
    // 顯示增加請假對話框
    function showAddLeaveModal() {
      const emp = document.getElementById('employee').value;
      if (!emp) {
        showError('請先選擇員工');
        return;
      }
      
      // 填充請假類型下拉選單
      const leaveTypeSelect = document.getElementById('leaveType');
      leaveTypeSelect.innerHTML = '<option value="">請選擇假別</option>';
      leaveTypesCache.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        leaveTypeSelect.appendChild(option);
      });
      
      document.getElementById('addLeaveModal').classList.add('show');
    }
    
    // 隱藏增加請假對話框
    function hideAddLeaveModal() {
      document.getElementById('addLeaveModal').classList.remove('show');
      document.getElementById('leaveType').value = '';
    }
    
    // 確認增加請假
    function confirmAddLeave() {
      const leaveType = document.getElementById('leaveType').value;
      
      if (!leaveType) {
        alert('請選擇假別');
        return;
      }
      
      // 檢查是否已存在相同的記錄
      const exists = currentData.leaveEntries.some(entry => entry.leaveType === leaveType);
      
      if (exists) {
        alert('此請假記錄已存在，請直接在表格中編輯');
        return;
      }
      
      // 新增記錄
      currentData.leaveEntries.push({
        leaveType,
        hours: {}
      });
      
      hasChanges = true;
      hideAddLeaveModal();
      
      // 重新生成表格
      const year = parseInt(document.getElementById('year').value);
      const month = parseInt(document.getElementById('month').value);
      const daysInMonth = new Date(year, month, 0).getDate();
      generateTableBody(year, month, daysInMonth);
    }
    
    // 儲存工時表
    async function saveTimesheet() {
      if (!hasChanges) {
        alert('沒有變更需要儲存');
        return;
      }
      
      const emp = document.getElementById('employee').value;
      const year = parseInt(document.getElementById('year').value);
      const month = parseInt(document.getElementById('month').value);
      
      if (!emp) {
        showError('請選擇員工');
        return;
      }
      
      if (!confirm('確定要儲存本月的工時記錄嗎？')) {
        return;
      }
      
      showLoading(true);
      
      try {
        const payload = {
          employee: emp,
          year: year,
          month: month,
          workEntries: currentData.workEntries,
          leaveEntries: currentData.leaveEntries
        };
        
        const res = await apiRequest(`${WORKER_URL}/api/save-timesheet`, {
          method: 'POST',
          body: payload
        });
        
        if (!res) return;
        
        const result = await res.json();
        
        showLoading(false);
        
        if (!res.ok || result.error) {
          showError(`儲存失敗：${result.error || res.status}`);
          return;
        }
        
        hasChanges = false;
        showSuccess('工時記錄已成功儲存');
        
        // 重新載入資料
        setTimeout(() => {
          loadTimesheetData();
        }, 1000);
        
      } catch (err) {
        showLoading(false);
        showError('儲存時發生錯誤：' + err.message);
      }
    }
    
    // 顯示成功訊息
    function showSuccess(message) {
      // 暫時使用 alert，之後可以改成更好的 UI
      alert(message);
    }
  </script>
</body>
</html>
