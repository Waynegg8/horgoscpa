<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="霍爾果斯會計師事務所工時系統，管理員工工時與請假記錄。" />
  <title>工時系統 | 霍爾果斯會計師事務所</title>
  
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  
  <!-- Material Symbols 圖示庫 -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <!-- 樣式 -->
  <link rel="stylesheet" href="/assets/css/internal-system.css" />
  
  <style>
    /* 覆蓋內部系統樣式，工時表需要更大的空間 */
    .internal-main {
      padding: 15px;
      max-width: 100%;
    }

    .internal-container {
      max-width: 100%;
      padding: 0;
    }

    main {
      max-width: 98%;
      width: 98%;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 20px;
    }
    
    @media (max-width: 768px) {
      main {
        margin: 80px 15px 40px;
        padding: 20px;
      }
    }
    
    .page-header {
      margin-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 20px;
    }
    
    .page-header h2 {
      color: #1b65b8;
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .page-header p {
      color: #666;
      font-size: 15px;
    }
    
    .month-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #1b65b8 0%, #0f4f94 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .month-info h3 {
      margin: 0;
      font-size: 20px;
    }
    
    .month-info .total-hours {
      font-size: 16px;
      font-weight: 600;
    }
    
    .control-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-group label {
      font-weight: 500;
      color: #333;
      white-space: nowrap;
    }
    
    select, input {
      font-size: 15px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fff;
      transition: border-color 0.2s;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #1b65b8;
    }
    
    select:disabled, input:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
    }
    
    button {
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: #1b65b8;
      color: #fff;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #0f4f94;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(27, 101, 184, 0.3);
    }
    
    .btn-gray {
      background: #6c757d;
      color: #fff;
    }
    
    .btn-gray:hover:not(:disabled) {
      background: #5a6268;
    }
    
    .btn-success {
      background: #28a745;
      color: #fff;
    }
    
    .btn-success:hover:not(:disabled) {
      background: #218838;
    }
    
    .message-box {
      padding: 12px 16px;
      border-radius: 6px;
      margin: 15px 0;
      display: none;
      align-items: center;
      gap: 8px;
    }
    
    .message-box.show {
      display: flex;
    }
    
    .error-message {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      color: #856404;
    }
    
    .success-message {
      background: #d4edda;
      border-left: 4px solid #28a745;
      color: #155724;
    }
    
    .loading-message {
      background: #d1ecf1;
      border-left: 4px solid #17a2b8;
      color: #0c5460;
    }
    
    .table-container {
      overflow-x: visible;
      margin-top: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 100%;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
      table-layout: fixed;
      background: white;
    }
    
    th, td {
      border: 1px solid #e3e3e3;
      padding: 6px 3px;
      text-align: center;
      white-space: nowrap;
    }
    
    thead tr:first-child th {
      background: #1b65b8;
      color: #fff;
      font-weight: 600;
      font-size: 10px;
      padding: 8px 3px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    thead tr:nth-child(2) th {
      background: #3a7bc8;
      color: #fff;
      font-weight: 500;
      font-size: 9px;
      padding: 4px 3px;
      position: sticky;
      top: 32px;
      z-index: 10;
    }
    
    /* 固定左側欄位 */
    th:first-child,
    td:first-child {
      position: sticky;
      left: 0;
      z-index: 5;
      background: white;
      font-weight: 600;
      width: 140px;
      min-width: 140px;
      text-align: left;
      padding-left: 8px;
      white-space: normal;
      word-wrap: break-word;
      font-size: 10px;
    }
    
    th:nth-child(2),
    td:nth-child(2) {
      position: sticky;
      left: 140px;
      z-index: 5;
      background: white;
      width: 90px;
      min-width: 90px;
      text-align: left;
      padding-left: 8px;
      font-size: 10px;
    }
    
    th:nth-child(3),
    td:nth-child(3) {
      position: sticky;
      left: 230px;
      z-index: 5;
      background: white;
      width: 100px;
      min-width: 100px;
      text-align: left;
      padding-left: 8px;
      font-size: 10px;
    }
    
    thead th:first-child,
    thead th:nth-child(2),
    thead th:nth-child(3) {
      background: #1b65b8;
      z-index: 15;
    }
    
    /* 日期欄位 */
    .day-cell {
      width: 30px;
      min-width: 30px;
      max-width: 30px;
      font-size: 10px;
      font-weight: 500;
      padding: 4px 2px;
    }
    
    /* 週末標示 */
    .weekend {
      background: #fff3cd !important;
    }
    
    /* 國定假日標示 */
    .holiday {
      background: #fde4e4 !important;
    }
    
    tbody tr:nth-child(even) td {
      background: #f8f9fa;
    }
    
    tbody tr:nth-child(even) td:first-child,
    tbody tr:nth-child(even) td:nth-child(2),
    tbody tr:nth-child(even) td:nth-child(3) {
      background: #f8f9fa;
    }
    
    tbody tr:hover td {
      background: #e7f3ff !important;
    }
    
    /* 有數值的格子 */
    .has-value {
      background: #d4edda !important;
      font-weight: 600;
      color: #155724;
    }
    
    /* 請假標示 */
    .leave-cell {
      background: #d1ecf1 !important;
      font-weight: 600;
      color: #0c5460;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    
    .empty-state .material-symbols-rounded {
      font-size: 64px;
      color: #ddd;
      margin-bottom: 15px;
    }
    
    /* 月總計欄 */
    .total-cell {
      background: #1b65b8 !important;
      color: white !important;
      font-weight: 700;
      position: sticky;
      right: 0;
      z-index: 5;
      width: 60px;
      min-width: 60px;
      max-width: 60px;
      font-size: 10px;
    }
    
    @media (max-width: 1600px) {
      main {
        max-width: 99%;
        width: 99%;
      }
      
      .day-cell {
        width: 26px;
        min-width: 26px;
        max-width: 26px;
        font-size: 9px;
        padding: 3px 1px;
      }
      
      table {
        font-size: 9px;
      }
    }
    
    @media (max-width: 1400px) {
      .table-container {
        overflow-x: auto;
      }
      
      th:first-child,
      td:first-child {
        width: 120px;
        min-width: 120px;
        font-size: 9px;
      }
      
      th:nth-child(2),
      td:nth-child(2) {
        left: 120px;
        width: 80px;
        min-width: 80px;
        font-size: 9px;
      }
      
      th:nth-child(3),
      td:nth-child(3) {
        left: 200px;
        width: 90px;
        min-width: 90px;
        font-size: 9px;
      }
      
      .day-cell {
        width: 24px;
        min-width: 24px;
        max-width: 24px;
        font-size: 8px;
        padding: 2px 1px;
      }
    }
    
    @media (max-width: 768px) {
      .control-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .control-group {
        flex-direction: column;
        align-items: stretch;
        gap: 5px;
      }
      
      select, input, button {
        width: 100%;
      }
      
      .table-container {
        overflow-x: auto;
      }
      
      table {
        font-size: 8px;
      }
      
      th, td {
        padding: 3px 1px;
      }
      
      th:first-child,
      td:first-child {
        width: 100px;
        min-width: 100px;
        font-size: 8px;
      }
      
      th:nth-child(2),
      td:nth-child(2) {
        left: 100px;
        width: 70px;
        min-width: 70px;
        font-size: 8px;
      }
      
      th:nth-child(3),
      td:nth-child(3) {
        left: 170px;
        width: 75px;
        min-width: 75px;
        font-size: 8px;
      }
      
      .day-cell {
        width: 22px;
        min-width: 22px;
        max-width: 22px;
        font-size: 7px;
        padding: 2px 1px;
      }
      
      .total-cell {
        width: 50px;
        min-width: 50px;
        max-width: 50px;
        font-size: 8px;
      }
    }
  </style>
</head>

<body>
  <!-- 簡潔的內部導航欄 -->
  <nav class="internal-navbar">
    <div class="internal-nav-container">
      <a href="index.html" class="internal-nav-brand">
        <img src="assets/images/logo-white.png" alt="霍爾果斯">
        <span>工時管理系統</span>
      </a>
      
      <button class="internal-mobile-toggle" id="mobileToggle">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <div class="internal-nav-links" id="navLinks">
        <a href="timesheet.html" class="internal-nav-link active">
          <span class="material-symbols-rounded">calendar_month</span>
          工時表
        </a>
        <a href="reports.html" class="internal-nav-link">
          <span class="material-symbols-rounded">assessment</span>
          報表
        </a>
        <a href="settings.html" class="internal-nav-link">
          <span class="material-symbols-rounded">settings</span>
          設定
        </a>
        
        <div class="internal-nav-user">
          <div>
            <div class="internal-user-name" id="userName">載入中...</div>
            <div class="internal-user-role" id="userRole"></div>
          </div>
          <button class="internal-logout-btn" id="logoutBtn">登出</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="internal-main">
    <div class="internal-container">
  <main>
    <div class="page-header">
      <h2>工時與請假紀錄</h2>
      <p>管理員工工時記錄與請假資料</p>
    </div>

    <div class="control-row">
      <div class="control-group">
        <label>選擇員工：</label>
        <select id="employee" disabled>
          <option value="">載入中...</option>
        </select>
      </div>

      <div class="control-group">
        <label>年份：</label>
        <input type="number" id="year" value="2025" min="2020" max="2030">
      </div>

      <div class="control-group">
        <label>月份：</label>
        <select id="month">
          <option value="1">1月</option>
          <option value="2">2月</option>
          <option value="3">3月</option>
          <option value="4">4月</option>
          <option value="5">5月</option>
          <option value="6">6月</option>
          <option value="7">7月</option>
          <option value="8">8月</option>
          <option value="9">9月</option>
          <option value="10">10月</option>
          <option value="11">11月</option>
          <option value="12">12月</option>
        </select>
      </div>

      <button class="btn-gray" disabled>
        <span class="material-symbols-rounded">add</span>
        增加工時記錄
      </button>
      <button class="btn-gray" disabled>
        <span class="material-symbols-rounded">event_note</span>
        增加請假記錄
      </button>
      <button class="btn-success" disabled>
        <span class="material-symbols-rounded">save</span>
        儲存本月變更
      </button>
    </div>

    <div id="errorMsg" class="message-box error-message"></div>
    <div id="loadingMsg" class="message-box loading-message">
      <span class="material-symbols-rounded">hourglass_empty</span>
      <span>正在載入資料...</span>
    </div>

    <div class="month-info" id="monthInfo" style="display:none;">
      <h3 id="monthTitle">2025年10月 - 員工名稱</h3>
      <div class="total-hours">
        總工時：<span id="totalHours">0</span> 小時
      </div>
    </div>

    <div class="table-container">
      <table id="dataTable">
        <thead id="tableHead">
          <tr>
            <th>客戶名稱</th>
            <th>業務類型</th>
            <th>工時類型</th>
            <th colspan="31">請選擇員工和日期</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="35" class="empty-state">
              <div class="material-symbols-rounded">inbox</div>
              <div>請選擇員工和日期</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>
    </div>
  </div>

  <!-- 簡化的頁尾 -->
  <footer class="internal-footer">
    &copy; 2024 霍爾果斯會計師事務所 工時管理系統
  </footer>

  <!-- 主腳本 -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const backToTopButton = document.querySelector('.back-to-top');
      
      backToTopButton.classList.remove('visible');
      
      window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
          backToTopButton.classList.add('visible');
        } else {
          backToTopButton.classList.remove('visible');
        }
      });
      
      backToTopButton.addEventListener('click', function() {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    });
  </script>

  <!-- 工時系統主要功能腳本 -->
  <script>
    const WORKER_URL = 'https://timesheet-api.hergscpa.workers.dev';
    let holidaysCache = null;
    let currentUser = null;
    let sessionToken = null;

    // 頁面載入時初始化
    document.addEventListener('DOMContentLoaded', async () => {
      // 檢查登入狀態
      if (!await checkAuth()) {
        window.location.href = '/login.html';
        return;
      }
      
      setCurrentMonth();
      await loadEmployees();
      setupEventListeners();
    });
    
    // 檢查認證狀態
    async function checkAuth() {
      sessionToken = localStorage.getItem('session_token');
      if (!sessionToken) {
        return false;
      }
      
      try {
        const response = await fetch(`${WORKER_URL}/api/verify`, {
          headers: {
            'Authorization': `Bearer ${sessionToken}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          currentUser = data.user;
          
          // 顯示使用者資訊
          updateUserInfo();
          return true;
        }
      } catch (err) {
        console.error('驗證失敗:', err);
      }
      
      return false;
    }
    
    // 更新使用者資訊顯示
    function updateUserInfo() {
      const userInfoEl = document.getElementById('userInfo');
      const adminMenuLink = document.getElementById('adminMenuLink');
      const employeeSelect = document.getElementById('employee');
      
      if (currentUser) {
        const displayName = currentUser.employee_name || currentUser.username;
        const roleText = currentUser.role === 'admin' ? '管理員' : '員工';
        userInfoEl.textContent = `${displayName} (${roleText})`;
        
        // 如果是管理員，顯示管理選單
        if (currentUser.role === 'admin') {
          adminMenuLink.style.display = 'block';
        }
        
        // 如果是員工，只能看自己的資料
        if (currentUser.role === 'employee' && currentUser.employee_name) {
          // 員工載入後自動選擇自己
          setTimeout(() => {
            if (employeeSelect && employeeSelect.options.length > 0) {
              employeeSelect.value = currentUser.employee_name;
              // 觸發載入
              loadTimesheetData();
            }
          }, 100);
        }
      }
    }
    
    // 登出功能
    document.addEventListener('DOMContentLoaded', () => {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          
          try {
            await apiRequest(`${WORKER_URL}/api/logout`, {
              method: 'POST'
            });
          } catch (err) {
            console.error('登出錯誤:', err);
          }
          
          // 清除本地資料
          localStorage.removeItem('session_token');
          localStorage.removeItem('user_info');
          
          // 跳轉到登入頁
          window.location.href = '/login.html';
        });
      }
    });
    
    // API 請求包裝函數（自動加入認證標頭）
    async function apiRequest(url, options = {}) {
      const headers = {
        ...options.headers,
        'Authorization': `Bearer ${sessionToken}`
      };
      
      if (options.body && typeof options.body === 'object') {
        headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(options.body);
      }
      
      const response = await fetch(url, {
        ...options,
        headers
      });
      
      // 如果未授權，跳轉到登入頁面
      if (response.status === 401) {
        localStorage.removeItem('session_token');
        localStorage.removeItem('user_info');
        window.location.href = '/login.html';
        return null;
      }
      
      return response;
    }

    // 設定事件監聽器
    function setupEventListeners() {
      const employeeSelect = document.getElementById('employee');
      const yearInput = document.getElementById('year');
      const monthSelect = document.getElementById('month');

      // 當員工、年份或月份改變時自動載入資料
      employeeSelect.addEventListener('change', loadTimesheetData);
      yearInput.addEventListener('change', loadTimesheetData);
      monthSelect.addEventListener('change', loadTimesheetData);
    }

    // 載入員工列表
    async function loadEmployees() {
      const employeeSelect = document.getElementById('employee');
      
      try {
        const res = await apiRequest(`${WORKER_URL}/api/employees`);
        if (!res) return;
        const employees = await res.json();

        if (!res.ok || !Array.isArray(employees)) {
          throw new Error('無法載入員工列表');
        }

        // 清空並填充員工選項
        employeeSelect.innerHTML = '';
        
        if (employees.length === 0) {
          employeeSelect.innerHTML = '<option value="">無員工資料</option>';
          showError('資料庫中沒有員工資料');
          return;
        }

        employees.forEach(emp => {
          const option = document.createElement('option');
          option.value = emp.name;
          option.textContent = emp.name;
          employeeSelect.appendChild(option);
        });

        // 啟用控制項
        employeeSelect.disabled = false;

        // 自動載入第一個員工的資料
        if (employees.length > 0) {
          await loadTimesheetData();
        }

      } catch (err) {
        employeeSelect.innerHTML = '<option value="">載入失敗</option>';
        showError('載入員工列表失敗：' + err.message);
      }
    }

    // 設定當前月份
    function setCurrentMonth() {
      const now = new Date();
      const currentMonth = now.getMonth() + 1;
      const currentYear = now.getFullYear();
      const monthSelect = document.getElementById('month');
      const yearInput = document.getElementById('year');
      
      monthSelect.value = currentMonth;
      yearInput.value = currentYear;
    }

    // 載入國定假日
    async function loadHolidays(year) {
      try {
        const res = await apiRequest(`${WORKER_URL}/api/holidays?year=${year}`);
        if (!res) return [];
        const holidays = await res.json();
        holidaysCache = holidays || [];
        return holidaysCache;
      } catch (err) {
        console.error('載入假日失敗:', err);
        return [];
      }
    }

    // 檢查是否為假日
    function isHoliday(dateStr) {
      return holidaysCache && holidaysCache.includes(dateStr);
    }

    // 檢查是否為週末
    function isWeekend(year, month, day) {
      const date = new Date(year, month - 1, day);
      const dayOfWeek = date.getDay();
      return dayOfWeek === 0 || dayOfWeek === 6; // 0=週日, 6=週六
    }

    // 取得星期文字
    function getWeekdayText(year, month, day) {
      const date = new Date(year, month - 1, day);
      const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
      return '週' + weekdays[date.getDay()];
    }

    // 載入工時資料
    async function loadTimesheetData() {
      const emp = document.getElementById('employee').value;
      const year = parseInt(document.getElementById('year').value);
      const month = parseInt(document.getElementById('month').value);
      const tableHead = document.getElementById('tableHead');
      const tableBody = document.getElementById('tableBody');
      const monthInfo = document.getElementById('monthInfo');

      if (!emp) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="35" class="empty-state">
              <div class="material-symbols-rounded">inbox</div>
              <div>請選擇員工</div>
            </td>
          </tr>
        `;
        monthInfo.style.display = 'none';
        return;
      }

      hideMessages();
      showLoading(true);

      try {
        // 載入假日和工時資料
        await loadHolidays(year);
        const res = await apiRequest(`${WORKER_URL}/api/timesheet-data?employee=${encodeURIComponent(emp)}&year=${year}&month=${month}`);
        if (!res) return;
        const data = await res.json();

        showLoading(false);

        if (!res.ok || data.error) {
          showError(`載入資料失敗：${data.error || res.status}`);
          return;
        }

        // 更新月份資訊
        document.getElementById('monthTitle').textContent = `${year}年${month}月 - ${emp}`;
        monthInfo.style.display = 'flex';

        const workEntries = data.workEntries || [];
        const leaveEntries = data.leaveEntries || [];

        // 計算該月天數
        const daysInMonth = new Date(year, month, 0).getDate();

        // 生成表頭
        generateTableHeader(year, month, daysInMonth);

        // 生成表格內容
        generateTableBody(workEntries, leaveEntries, year, month, daysInMonth);

      } catch (err) {
        showLoading(false);
        showError('載入資料時發生錯誤：' + err.message);
      }
    }

    // 生成表頭
    function generateTableHeader(year, month, daysInMonth) {
      const tableHead = document.getElementById('tableHead');
      
      // 第一行：日期
      let headerRow1 = '<tr><th>客戶名稱</th><th>業務類型</th><th>工時類型</th>';
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isHol = isHoliday(dateStr);
        const isWe = isWeekend(year, month, day);
        const className = isHol ? 'holiday' : (isWe ? 'weekend' : '');
        headerRow1 += `<th class="day-cell ${className}">${day}</th>`;
      }
      headerRow1 += '<th class="total-cell">月總計</th></tr>';

      // 第二行：星期
      let headerRow2 = '<tr><th></th><th></th><th></th>';
      for (let day = 1; day <= daysInMonth; day++) {
        const weekdayText = getWeekdayText(year, month, day);
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isHol = isHoliday(dateStr);
        const isWe = isWeekend(year, month, day);
        const className = isHol ? 'holiday' : (isWe ? 'weekend' : '');
        headerRow2 += `<th class="day-cell ${className}">${weekdayText}</th>`;
      }
      headerRow2 += '<th class="total-cell">小時</th></tr>';

      tableHead.innerHTML = headerRow1 + headerRow2;
    }

    // 生成表格內容
    function generateTableBody(workEntries, leaveEntries, year, month, daysInMonth) {
      const tableBody = document.getElementById('tableBody');
      
      // 合併工時和請假資料
      const allEntries = [];
      
      // 處理工時資料
      workEntries.forEach(entry => {
        allEntries.push({
          type: 'work',
          clientName: entry.clientName || '-',
          businessType: entry.businessType || '-',
          workType: entry.workType || '-',
          hours: entry.hours || {}
        });
      });

      // 處理請假資料
      leaveEntries.forEach(entry => {
        allEntries.push({
          type: 'leave',
          clientName: '-',
          businessType: '-',
          workType: entry.leaveType || '-',
          hours: entry.hours || {}
        });
      });

      // 如果沒有資料
      if (allEntries.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="${daysInMonth + 4}" class="empty-state">
              <div class="material-symbols-rounded">event_busy</div>
              <div>本月尚無工時或請假記錄</div>
            </td>
          </tr>
        `;
        document.getElementById('totalHours').textContent = '0';
        return;
      }

      // 生成表格行
      let totalAllHours = 0;
      tableBody.innerHTML = '';
      
      allEntries.forEach(entry => {
        const tr = document.createElement('tr');
        let rowHTML = `
          <td>${entry.clientName}</td>
          <td>${entry.businessType}</td>
          <td>${entry.workType}</td>
        `;

        let rowTotal = 0;
        for (let day = 1; day <= daysInMonth; day++) {
          const hours = entry.hours[day] || '';
          const cellClass = hours ? (entry.type === 'leave' ? 'leave-cell' : 'has-value') : '';
          rowHTML += `<td class="day-cell ${cellClass}">${hours}</td>`;
          if (hours) rowTotal += parseFloat(hours);
        }

        rowHTML += `<td class="total-cell">${rowTotal.toFixed(1)}</td>`;
        tr.innerHTML = rowHTML;
        tableBody.appendChild(tr);

        totalAllHours += rowTotal;
      });

      // 更新總工時
      document.getElementById('totalHours').textContent = totalAllHours.toFixed(1);
    }

    // 顯示錯誤訊息
    function showError(message) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.innerHTML = `<span class="material-symbols-rounded">error</span><span>${message}</span>`;
      errorMsg.classList.add('show');
      
      // 3秒後自動隱藏錯誤訊息
      setTimeout(() => {
        errorMsg.classList.remove('show');
      }, 3000);
    }

    // 顯示載入狀態
    function showLoading(show) {
      const loadingMsg = document.getElementById('loadingMsg');
      if (show) {
        loadingMsg.classList.add('show');
      } else {
        loadingMsg.classList.remove('show');
      }
    }

    // 隱藏所有訊息
    function hideMessages() {
      document.getElementById('errorMsg').classList.remove('show');
      document.getElementById('loadingMsg').classList.remove('show');
    }
  </script>
</body>
</html>
