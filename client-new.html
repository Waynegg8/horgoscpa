<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新增客戶 - 內部系統</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
  <link rel="stylesheet" href="/assets/css/client-detail-page.css?v=30">
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container">
    <div class="page-header-simple">
      <a href="/internal/clients" class="back-link">← 返回客戶列表</a>
      <h1 class="page-title">新增客戶</h1>
    </div>

    <!-- 客戶基本信息 -->
    <div class="content-card">
      <h2 class="card-title">基本信息</h2>
      <form id="clientForm" class="edit-form">
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputCompanyName">公司名稱（必填）</label>
            <input type="text" id="inputCompanyName" required />
            <span class="error-text" id="error_company_name"></span>
          </div>
          <div class="form-field">
            <label for="inputTaxId">統一編號</label>
            <input type="text" id="inputTaxId" maxlength="8" />
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputAssignee">負責人員</label>
            <select id="inputAssignee">
              <option value="">載入中...</option>
            </select>
            <span class="error-text" id="error_assignee"></span>
          </div>
          <div class="form-field">
            <label for="inputPhone">聯絡電話</label>
            <input type="text" id="inputPhone" />
            <span class="error-text" id="error_phone"></span>
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputEmail">Email</label>
            <input type="email" id="inputEmail" />
            <span class="error-text" id="error_email"></span>
          </div>
          <div class="form-field">
            <label>標籤</label>
            <div style="color: #9ca3af; font-size: 14px; padding: 12px 0;">儲存後可在客戶詳情頁設置</div>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputClientNotes">客戶備註</label>
            <textarea id="inputClientNotes" rows="3"></textarea>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputPaymentNotes">收款備註</label>
            <textarea id="inputPaymentNotes" rows="3"></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="cancelCreate()">取消</button>
          <button type="button" class="btn btn-primary" onclick="createClient()">新增客戶</button>
        </div>
      </form>
    </div>

    <!-- 客戶服務 -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">客戶服務</h2>
        <button class="btn btn-primary" onclick="openAddServiceModal()">+ 新增服務</button>
      </div>
      <div class="table-wrapper">
        <table class="services-table" id="servicesTable">
          <thead>
            <tr>
              <th style="width: 30px;"></th>
              <th>服務名稱</th>
              <th>狀態</th>
              <th>服務週期</th>
              <th>年度總額</th>
              <th>開始日期</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="servicesList">
            <tr>
              <td colspan="7" class="no-data">尚未新增服務</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 新增/編輯服務 Modal -->
  <div id="serviceModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="serviceModalTitle">新增服務</h3>
        <button class="modal-close" onclick="closeServiceModal()">&times;</button>
      </div>
      <form id="serviceForm" class="modal-form">
        <input type="hidden" id="editServiceIndex" />
        
        <div class="form-group">
          <label>服務項目 <span class="required">*</span></label>
          <select id="serviceServiceId" required>
            <option value="">載入中...</option>
          </select>
          <div class="error-message" id="error_service_id"></div>
        </div>

        <div class="form-group">
          <label>服務狀態</label>
          <select id="serviceStatus">
            <option value="active">使用中</option>
            <option value="suspended">暫停</option>
            <option value="expired">已過期</option>
            <option value="cancelled">已取消</option>
          </select>
        </div>

        <div class="form-group">
          <label>服務週期</label>
          <select id="serviceServiceCycle">
            <option value="monthly">每月</option>
            <option value="quarterly">每季</option>
            <option value="yearly">每年</option>
            <option value="one-time">單次</option>
          </select>
        </div>

        <div class="form-group">
          <label>任務模板</label>
          <select id="serviceTaskTemplateId">
            <option value="">載入中...</option>
          </select>
        </div>

        <div class="form-group">
          <label>服務開始日期</label>
          <input type="date" id="serviceStartDate" />
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" id="serviceAutoGenerateTasks" checked style="width: auto; margin-right: 8px;" />
            自動生成任務
          </label>
        </div>

        <div class="form-group">
          <label>服務備註</label>
          <textarea id="serviceServiceNotes" rows="3"></textarea>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeServiceModal()">取消</button>
          <button type="submit" class="btn btn-primary">儲存</button>
        </div>
      </form>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script src="/assets/js/components/bootstrap.js?v=3"></script>
  <script>
    const apiBase = '/internal/api/v1';
    let tempServices = []; // 暫存服務列表
    let allServices = [];
    let allTemplates = [];

    // 載入員工列表
    async function loadEmployees() {
      try {
        const res = await fetch('/internal/api/v1/users');
        const json = await res.json();
        
        if (json.ok && json.data) {
          const select = document.getElementById('inputAssignee');
          select.innerHTML = '<option value="">請選擇負責人員</option>' +
            json.data.map(u => 
              `<option value="${u.user_id}">${u.name || u.username}</option>`
            ).join('');
        }
      } catch (err) {
        console.error('載入員工列表失敗:', err);
        document.getElementById('inputAssignee').innerHTML = '<option value="">載入失敗</option>';
      }
    }

    // 載入服務類型選項
    async function loadServiceTypes() {
      try {
        const res = await fetch('/internal/api/v1/client-services/services');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allServices = json.data;
          const select = document.getElementById('serviceServiceId');
          select.innerHTML = '<option value="">請選擇服務</option>' +
            allServices.filter(s => s.is_active).map(s => 
              `<option value="${s.service_id}">${s.service_name}</option>`
            ).join('');
        }
      } catch (err) {
        console.error('載入服務選項失敗:', err);
      }
    }

    // 載入任務模板選項
    async function loadTemplates() {
      try {
        const res = await fetch('/internal/api/v1/task-templates');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allTemplates = json.data;
          const select = document.getElementById('serviceTaskTemplateId');
          select.innerHTML = '<option value="">無（手動建立任務）</option>' +
            allTemplates.map(t => 
              `<option value="${t.template_id}">${t.template_name}</option>`
            ).join('');
        }
      } catch (err) {
        console.error('載入任務模板失敗:', err);
      }
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      loadEmployees();
      loadServiceTypes();
      loadTemplates();
    });

    // 取消新增
    function cancelCreate() {
      window.location.href = '/internal/clients';
    }

    // 打開新增服務 Modal
    function openAddServiceModal() {
      document.getElementById('serviceModalTitle').textContent = '新增服務';
      document.getElementById('serviceForm').reset();
      document.getElementById('editServiceIndex').value = '';
      document.getElementById('serviceStatus').value = 'active';
      document.getElementById('serviceServiceCycle').value = 'monthly';
      document.getElementById('serviceAutoGenerateTasks').checked = true;
      document.getElementById('serviceModal').style.display = 'flex';
    }

    // 關閉服務 Modal
    function closeServiceModal() {
      document.getElementById('serviceModal').style.display = 'none';
    }

    // 渲染服務列表
    function renderServices() {
      const tbody = document.getElementById('servicesList');
      
      if (tempServices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="no-data">尚未新增服務</td></tr>';
        return;
      }

      tbody.innerHTML = tempServices.map((svc, index) => {
        const statusClass = {
          'active': 'status-active',
          'suspended': 'status-suspended',
          'expired': 'status-expired',
          'cancelled': 'status-cancelled'
        }[svc.status] || '';
        
        const statusText = {
          'active': '使用中',
          'suspended': '暫停',
          'expired': '已過期',
          'cancelled': '已取消'
        }[svc.status] || svc.status;

        const cycleText = {
          'monthly': '每月',
          'quarterly': '每季',
          'yearly': '每年',
          'one-time': '單次'
        }[svc.service_cycle] || svc.service_cycle;

        const serviceName = allServices.find(s => s.service_id == svc.service_id)?.service_name || '-';

        return `
          <tr>
            <td></td>
            <td><strong>${serviceName}</strong></td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${cycleText}</td>
            <td class="amount">-</td>
            <td>${svc.start_date || '-'}</td>
            <td class="actions-cell">
              <button type="button" class="table-btn table-btn-secondary" onclick="editTempService(${index})">編輯</button>
              <button type="button" class="table-btn table-btn-danger" onclick="deleteTempService(${index})">刪除</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // 編輯臨時服務
    function editTempService(index) {
      const svc = tempServices[index];
      document.getElementById('serviceModalTitle').textContent = '編輯服務';
      document.getElementById('editServiceIndex').value = index;
      document.getElementById('serviceServiceId').value = svc.service_id;
      document.getElementById('serviceStatus').value = svc.status;
      document.getElementById('serviceServiceCycle').value = svc.service_cycle;
      document.getElementById('serviceTaskTemplateId').value = svc.task_template_id || '';
      document.getElementById('serviceStartDate').value = svc.start_date || '';
      document.getElementById('serviceAutoGenerateTasks').checked = svc.auto_generate_tasks;
      document.getElementById('serviceServiceNotes').value = svc.service_notes || '';
      document.getElementById('serviceModal').style.display = 'flex';
    }

    // 刪除臨時服務
    function deleteTempService(index) {
      if (confirm('確定要刪除此服務嗎？')) {
        tempServices.splice(index, 1);
        renderServices();
      }
    }

    // 服務表單提交
    document.getElementById('serviceForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const editIndex = document.getElementById('editServiceIndex').value;
      const isEdit = editIndex !== '';
      
      const serviceData = {
        service_id: parseInt(document.getElementById('serviceServiceId').value),
        status: document.getElementById('serviceStatus').value,
        service_cycle: document.getElementById('serviceServiceCycle').value,
        task_template_id: parseInt(document.getElementById('serviceTaskTemplateId').value) || null,
        start_date: document.getElementById('serviceStartDate').value || null,
        auto_generate_tasks: document.getElementById('serviceAutoGenerateTasks').checked,
        service_notes: document.getElementById('serviceServiceNotes').value || null
      };

      if (isEdit) {
        tempServices[parseInt(editIndex)] = serviceData;
      } else {
        tempServices.push(serviceData);
      }

      renderServices();
      closeServiceModal();
    });

    // 新增客戶
    async function createClient() {
      const payload = {
        client_id: document.getElementById('inputTaxId').value.trim() || null,
        company_name: document.getElementById('inputCompanyName').value.trim(),
        assignee_user_id: parseInt(document.getElementById('inputAssignee').value) || null,
        phone: document.getElementById('inputPhone').value.trim() || null,
        email: document.getElementById('inputEmail').value.trim() || null,
        client_notes: document.getElementById('inputClientNotes').value.trim() || null,
        payment_notes: document.getElementById('inputPaymentNotes').value.trim() || null
      };

      if (!payload.company_name) {
        alert('請填寫公司名稱');
        return;
      }

      try {
        // 1. 創建客戶
        const res = await fetch('/internal/api/v1/clients', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const json = await res.json();

        if (!json.ok) {
          alert(json.message || '新增客戶失敗');
          return;
        }

        const newClientId = json.data.client_id;

        // 2. 如果有服務，逐一新增
        if (tempServices.length > 0) {
          for (const svc of tempServices) {
            await fetch(`/internal/api/v1/clients/${newClientId}/services`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(svc)
            });
          }
        }

        alert('客戶新增成功！');
        window.location.href = `/internal/client-detail?id=${newClientId}`;

      } catch (err) {
        console.error('新增客戶失敗:', err);
        alert('新增失敗');
      }
    }

    // 暴露函數到全局
    window.openAddServiceModal = openAddServiceModal;
    window.closeServiceModal = closeServiceModal;
    window.editTempService = editTempService;
    window.deleteTempService = deleteTempService;
    window.createClient = createClient;
    window.cancelCreate = cancelCreate;
  </script>
</body>
</html>

