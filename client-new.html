<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新增客戶 - 內部系統</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
  <link rel="stylesheet" href="/assets/css/client-detail-page.css?v=30">
  
  <!-- ⚡ 禁用緩存系統（新增客戶後需要更新列表） -->
  <script>
  // ❌ 新增客戶頁面禁用緩存系統
  console.log('[Client-New] ℹ️ 新增客戶頁面已禁用所有緩存功能');
  
  // 禁用 DataCache 预加载
  window.__DISABLE_DATA_CACHE__ = true;
  
  // 禁用 fetch-interceptor 拦截
  window.__DISABLE_FETCH_INTERCEPTOR__ = true;
  
  // 页面加载时清除客户列表缓存
  document.addEventListener('DOMContentLoaded', function() {
    const clientsCacheKeys = [
      'clients_page1', 'clients_page2', 'clients_page3', 
      'clients_page4', 'clients_page5', 'clients_all'
    ];
    
    clientsCacheKeys.forEach(key => {
      localStorage.removeItem(`cache_${key}`);
    });
    
    console.log('[Client-New] ✓ 已清除客户列表缓存');
  });
  </script>
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container">
    <a href="/internal/clients" class="back-link" style="display:inline-block;margin-bottom:16px;">← 返回客戶列表</a>

    <!-- 客戶基本信息 - 可編輯表單 -->
    <div class="content-card">
      <h2 class="card-title">基本信息</h2>
      <form id="clientForm" class="edit-form">
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputCompanyName">公司名稱（必填）</label>
            <input type="text" id="inputCompanyName" required />
            <span class="error-text" id="error_company_name"></span>
          </div>
          <div class="form-field">
            <label for="inputTaxId">統一編號</label>
            <input type="text" id="inputTaxId" maxlength="8" />
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputAssignee">負責人員</label>
            <select id="inputAssignee">
              <option value="">載入中...</option>
            </select>
            <span class="error-text" id="error_assignee"></span>
          </div>
          <div class="form-field">
            <label for="inputPhone">聯絡電話</label>
            <input type="text" id="inputPhone" />
            <span class="error-text" id="error_phone"></span>
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputContactPerson1">聯絡人一</label>
            <input type="text" id="inputContactPerson1" maxlength="50" />
          </div>
          <div class="form-field">
            <label for="inputContactPerson2">聯絡人二</label>
            <input type="text" id="inputContactPerson2" maxlength="50" />
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputEmail">Email</label>
            <input type="email" id="inputEmail" />
            <span class="error-text" id="error_email"></span>
          </div>
          <div class="form-field">
            <label>標籤</label>
            <div id="tagsDisplay" style="min-height:36px; display:flex; gap:8px; flex-wrap:wrap; padding: 8px 0;"></div>
            <div id="tagsSelectList" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;"></div>
            <div style="margin-top:8px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px; padding:10px;">
              <div style="display:flex; gap:8px; align-items:center;">
                <input type="text" id="newTagName" placeholder="新增標籤名稱" style="flex:1; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px;">
                <select id="newTagColor" style="padding:6px 10px; border:1px solid #d1d5db; border-radius:6px;">
                  <option value="#3b82f6">藍</option>
                  <option value="#10b981">綠</option>
                  <option value="#ef4444">紅</option>
                  <option value="#f59e0b">橙</option>
                  <option value="#6b7280">灰</option>
                </select>
                <button type="button" class="btn btn-secondary" onclick="createNewTag()">+ 建立標籤</button>
              </div>
            </div>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputClientNotes">客戶備註</label>
            <textarea id="inputClientNotes" rows="3"></textarea>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputPaymentNotes">收款備註</label>
            <textarea id="inputPaymentNotes" rows="3"></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="cancelEdit()">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveClient()">新增客戶</button>
        </div>
      </form>
    </div>

    <!-- 客戶服務 -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">客戶服務</h2>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn btn-secondary" onclick="showGlobalBillingModal()">集中新增收費</button>
          <button class="btn btn-primary" onclick="showAddServiceRow()">+ 新增服務</button>
        </div>
      </div>
      <div class="table-wrapper">
        <table class="services-table" id="servicesTable">
          <thead>
            <tr>
              <th style="width: 30px;"></th>
              <th>服務名稱</th>
              <th>狀態</th>
              <th>服務週期</th>
              <th>年度總額</th>
              <th>開始日期</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="servicesList">
            <tr>
              <td colspan="7" class="no-data">尚未新增服務</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script src="/assets/js/components/bootstrap.js?v=3"></script>
  
  <!-- 集中新增收費彈窗 -->
  <div id="globalBillingModal" style="display:none; position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div style="background:white; border-radius:8px; padding:20px; width:90%; max-width:780px; max-height:80vh; overflow:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">集中新增收費</h3>
        <button onclick="closeGlobalBillingModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#6b7280">×</button>
      </div>
      <div style="margin-top:12px; display:grid; grid-template-columns: 1fr 2fr; gap:12px;">
        <div>
          <label>選擇服務</label>
          <select id="gb-service-select" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px;"></select>
        </div>
        <div>
          <label>收費類型</label>
          <div style="display:flex; gap:12px; align-items:center;">
            <label style="display:flex; align-items:center; gap:6px;">
              <input type="radio" name="gb-type" value="monthly" checked> 按月
            </label>
            <label style="display:flex; align-items:center; gap:6px;">
              <input type="radio" name="gb-type" value="one-time"> 一次性
            </label>
          </div>
        </div>
      </div>
      <div id="gb-monthly" style="margin-top:10px;">
        <div style="display:grid; grid-template-columns: repeat(3,1fr); gap:12px;">
          <div><label>每月金額 *</label><input id="gb-amount" type="number" step="0.01" min="0" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px;"></div>
          <div><label>付款期限（天）</label><input id="gb-due" type="number" value="30" min="1" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px;"></div>
          <div><label>月份範圍</label>
            <select id="gb-range" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px;">
              <option value="all">全年（1-12月）</option>
              <option value="custom">自選月份</option>
            </select>
          </div>
        </div>
        <div id="gb-months" style="display:none; margin-top:8px;">
          ${Array.from({length:12},(_,i)=>`<label style=\"display:inline-flex;align-items:center;gap:6px;margin:4px 8px;\"><input type=\"checkbox\" class=\"gb-month\" value=\"${i+1}\" checked> ${i+1}月</label>`).join('')}
          <div style="margin-top:6px;"><button class="btn btn-sm btn-secondary" type="button" onclick="gbToggleMonths(true)">全選</button> <button class="btn btn-sm btn-secondary" type="button" onclick="gbToggleMonths(false)">全不選</button></div>
        </div>
      </div>
      <div id="gb-onetime" style="margin-top:10px; display:none;">
        <div style="display:grid; grid-template-columns: repeat(2,1fr); gap:12px;">
          <div><label>項目名稱 *</label><input id="gb-ot-desc" type="text" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px;"></div>
          <div><label>收費日期 *</label><input id="gb-ot-date" type="date" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px;"></div>
        </div>
        <div style="display:grid; grid-template-columns: repeat(3,1fr); gap:12px; margin-top:8px;">
          <div><label>金額 *</label><input id="gb-ot-amount" type="number" step="0.01" min="0" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px;"></div>
          <div><label>付款期限（天）</label><input id="gb-ot-due" type="number" value="30" min="1" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px;"></div>
          <div><label>備註</label><input id="gb-ot-notes" type="text" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px;"></div>
        </div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <label style="display:inline-flex; align-items:center; gap:6px; margin-right:auto;">
          <input type="checkbox" id="generate-now"> 保存後立即產生任務（管理員）
        </label>
        <button class="btn btn-secondary" onclick="closeGlobalBillingModal()">取消</button>
        <button class="btn btn-primary" onclick="saveGlobalBillingFromModal()">確認新增</button>
      </div>
    </div>
  </div>
  <script>
    let currentClientId = null;
    let currentEditingServiceId = null;
    let currentBillingServiceId = null;
    let allServices = [];
    let allTemplates = [];
    let tempServices = [];
    let allTags = [];
    let allServiceItems = [];
    let allSOPs = [];
    let employeesList = [];
    let selectedTagIds = new Set();

    // 頁面初始化
    async function init() {
      await Promise.all([
        loadEmployees(),
        loadServices(),
        loadTemplates(),
        loadServiceItems(),
        loadAllSOPs(),
        loadAllTags()
      ]);
      
      renderServices(tempServices);
      renderTagsDisplay();
      renderTagsSelect();
    }

    // 載入員工列表
    async function loadEmployees() {
      try {
        const res = await fetch('/internal/api/v1/users');
        const json = await res.json();
        
        if (json.ok && json.data) {
          employeesList = json.data;
          const select = document.getElementById('inputAssignee');
          select.innerHTML = '<option value="">請選擇負責人員</option>' +
            employeesList.map(u => 
              `<option value="${u.user_id}">${u.name || u.username}</option>`
            ).join('');
        }
      } catch (err) {
        console.error('載入員工列表失敗:', err);
      }
    }

    // 載入服務項
    async function loadServiceItems() {
      try {
        const res = await fetch('/internal/api/v1/services/items');
        const json = await res.json();
        if (json.ok && json.data) {
          allServiceItems = json.data;
        }
      } catch (err) {
        console.error('載入服務項目失敗:', err);
      }
    }

    // 載入 SOP 清單
    async function loadAllSOPs() {
      try {
        const res = await fetch('/internal/api/v1/sop');
        const json = await res.json();
        if (json.ok && json.data) {
          allSOPs = json.data.filter(s => !s.is_deleted).map(s => ({ ...s, sop_id: s.id }));
        }
      } catch (err) {
        console.error('載入 SOP 失敗:', err);
      }
    }

    // 載入標籤
    async function loadAllTags() {
      try {
        const res = await fetch('/internal/api/v1/tags');
        const json = await res.json();
        if (json.ok && json.data) {
          allTags = json.data;
        }
      } catch (e) {
        console.error('載入標籤失敗:', e);
      }
    }

    function renderTagsDisplay() {
      const container = document.getElementById('tagsDisplay');
      if (!container) return;
      const tags = allTags.filter(t => selectedTagIds.has(t.tag_id));
      if (tags.length === 0) {
        container.innerHTML = '<span style="color:#9ca3af;">尚未選擇標籤</span>';
        return;
      }
      container.innerHTML = tags.map(t => `<span class="chip" style="background:${t.tag_color || '#6b7280'}">${t.tag_name}</span>`).join('');
    }

    function renderTagsSelect() {
      const container = document.getElementById('tagsSelectList');
      if (!container) return;
      if (!allTags || allTags.length === 0) {
        container.innerHTML = '<span style="color:#9ca3af;">尚無標籤</span>';
        return;
      }
      container.innerHTML = allTags.map(tag => {
        const on = selectedTagIds.has(tag.tag_id);
        return `<button type="button" onclick="toggleTag(${tag.tag_id})" 
                style="display:inline-flex;align-items:center;padding:6px 12px;border-radius:6px;border:${on?'none':'1px solid #d1d5db'};background:${on?(tag.tag_color||'#3b82f6'):'#f3f4f6'};color:${on?'#fff':'#374151'};cursor:pointer;">${on?'✓ ':''}${tag.tag_name}</button>`;
      }).join('');
    }

    function toggleTag(tagId) {
      if (selectedTagIds.has(tagId)) selectedTagIds.delete(tagId); else selectedTagIds.add(tagId);
      renderTagsDisplay();
      renderTagsSelect();
    }
    window.toggleTag = toggleTag;

    // 渲染服務列表
    function renderServices(services) {
      const tbody = document.getElementById('servicesList');
      
      const serviceOptions = allServices && allServices.length > 0
        ? allServices.filter(s => s.is_active).map(s => 
            `<option value="${s.service_id}">${s.service_name}</option>`
          ).join('')
        : '';
      
      const addServiceRowHtml = `
        <tr id="add-service-row" style="display: none;">
          <td></td>
          <td>
            <select id="new-service-id" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="">請選擇服務</option>
              ${serviceOptions}
            </select>
          </td>
          <td>
            <select id="new-service-status" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="active">使用中</option>
              <option value="suspended">暫停</option>
              <option value="expired">已到期</option>
              <option value="cancelled">已取消</option>
            </select>
          </td>
          <td>
            <select id="new-service-cycle" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="monthly">每月</option>
              <option value="quarterly">每季</option>
              <option value="yearly">每年</option>
              <option value="one-time">一次性</option>
            </select>
          </td>
          <td>
            <select id="new-service-template" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="">不使用模板</option>
              ${(allTemplates||[]).map(t => `<option value="${t.template_id}">${t.template_name}</option>`).join('')}
            </select>
            <div style="margin-top:6px;">
              <label style="display:inline-flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="checkbox" id="new-service-autogen" checked> 自動產生任務
              </label>
            </div>
            <div style="margin-top:6px;">
              <label>服務備註</label>
              <input type="text" id="new-service-notes" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px;" />
            </div>
          </td>
          <td>
            <input type="date" id="new-service-start-date" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </td>
          <td>
            <button class="table-btn-link" onclick="saveNewService()">儲存</button>
            <button class="table-btn-link danger" onclick="cancelAddService()">取消</button>
          </td>
        </tr>
      `;
      
      if (!services || services.length === 0) {
        tbody.innerHTML = addServiceRowHtml + '<tr><td colspan="7" class="no-data">尚未新增服務</td></tr>';
        return;
      }

      const serviceRows = services.map((svc, index) => {
        const statusClass = {
          'active': 'status-active',
          'suspended': 'status-suspended',
          'expired': 'status-expired',
          'cancelled': 'status-cancelled'
        }[svc.status] || '';
        
        const statusText = {
          'active': '使用中',
          'suspended': '暫停',
          'expired': '已到期',
          'cancelled': '已取消'
        }[svc.status] || svc.status;

        const cycleText = {
          'monthly': '每月',
          'quarterly': '每季',
          'yearly': '每年',
          'one-time': '一次性'
        }[svc.service_cycle] || svc.service_cycle;

        const service = allServices.find(s => s.service_id == svc.service_id);
        const serviceName = service ? service.service_name : '-';

        const billings = svc.billings || [];
        const yearTotal = billings.reduce((sum, b) => sum + (parseFloat(b.billing_amount) || 0), 0);

        return `
          <tr class="service-main-row">
            <td class="expand-cell">
              <button class="expand-btn" onclick="toggleBilling(${index})">
                <span class="expand-icon" id="expand-icon-${index}">▶</span>
              </button>
            </td>
            <td><strong>${serviceName}</strong></td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${cycleText}</td>
            <td class="amount">$${yearTotal.toLocaleString('zh-TW')}</td>
            <td>${svc.start_date || '-'}</td>
            <td class="actions-cell">
              <button type="button" class="table-btn table-btn-primary" onclick="showAddBillingRow(${index})">新增收費</button>
              <button type="button" class="table-btn" onclick="showAddComponentForm(${index})">配置任務</button>
              <button type="button" class="table-btn table-btn-secondary" onclick="editService(${index})">編輯</button>
              <button type="button" class="table-btn table-btn-danger" onclick="deleteService(${index}, '${serviceName}')">刪除</button>
            </td>
          </tr>
          <tr class="billing-detail-row" id="billing-row-${index}" style="display: none;">
            <td colspan="7" class="billing-detail-cell">
              <div class="billing-content" id="billing-content-${index}">
                ${renderBillingTable(index)}
              </div>
              <div class="components-content" id="components-content-${index}" style="margin-top:14px;"></div>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = addServiceRowHtml + serviceRows;
    }

    // 渲染收費明細表格
    function renderBillingTable(serviceIndex) {
      const svc = tempServices[serviceIndex];
      const billings = svc.billings || [];
      
      const rows = billings.map((billing, billingIndex) => {
        const isOneTime = billing.billing_type === 'one-time' || billing.billing_month === 0;
        let monthDisplay = '';
        if (isOneTime) {
          const d = billing.billing_date ? new Date(billing.billing_date) : null;
          const m = d ? (d.getMonth() + 1) : (billing.billing_month || '—');
          monthDisplay = `${m}月`;
        } else {
          monthDisplay = `${billing.billing_month}月`;
        }
        let notesDisplay = billing.notes || '-';
        if (isOneTime) {
          const d = billing.billing_date ? new Date(billing.billing_date) : null;
          const y = d ? d.getFullYear() : '';
          const m2 = d ? String(d.getMonth() + 1).padStart(2, '0') : '';
          const parts = [];
          parts.push(`[一次性] ${y}${y?'/':''}${m2}`.trim());
          if (billing.description) parts.push(billing.description);
          if (billing.notes) parts.push(billing.notes);
          notesDisplay = parts.filter(Boolean).join(' - ');
        }
        return `
          <tr data-billing-index="${billingIndex}">
            <td>${monthDisplay}</td>
            <td class="amount">$${parseFloat(billing.billing_amount).toLocaleString('zh-TW')}</td>
            <td>${billing.payment_due_days}天</td>
            <td>${notesDisplay}</td>
            <td>
              <button class="table-btn-link" onclick="startEditBilling(${serviceIndex}, ${billingIndex})">編輯</button>
              <button class="table-btn-link danger" onclick="deleteBillingInline(${serviceIndex}, ${billingIndex}, ${billing.billing_month||0})">刪除</button>
            </td>
          </tr>`;
      }).join('');

      return `
        <div class="billing-header">
          <h4>收費明細</h4>
        </div>
        <table class="billing-table">
          <thead>
            <tr>
              <th>月份</th>
              <th>金額</th>
              <th>帳款天數</th>
              <th>備註</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <tr id="add-row-${serviceIndex}" style="display: none;"></tr>
            ${rows || `<tr><td colspan="5" class="no-data">尚未設定收費明細</td></tr>`}
          </tbody>
        </table>
      `;
    }

    // 服務組成部分（任務配置）
    function showAddComponentForm(serviceIndex) {
      const svc = tempServices[serviceIndex];
      const container = document.getElementById(`components-content-${serviceIndex}`);
      if (!svc || !container) return;
      const currentServiceId = svc.service_id;
      const items = allServiceItems.filter(it => String(it.service_id) === String(currentServiceId));
      const itemsOptions = items.length > 0
        ? items.map(it => `<option value="${it.item_id}">${it.item_name}</option>`).join('')
        : '<option value="">（此服務無可用項目）</option>';
      const sopOptions = (allSOPs||[]).map(s => `<label style=\"display:inline-flex;align-items:center;gap:6px;cursor:pointer;border:1px solid #e5e7eb;border-radius:6px;padding:4px 8px;\"><input type=\"checkbox\" class=\"comp-sop-${serviceIndex}\" value=\"${s.sop_id}\"> ${s.title}</label>`).join('');
      container.innerHTML = `
        <div id="add-component-form-${serviceIndex}" style="border:2px solid #10b981;border-radius:8px;background:#ecfdf5;padding:14px;">
          <h5 style="margin:0 0 10px 0;">配置服務任務</h5>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
            <div><label>組成名稱</label><input type="text" id="comp-name-${serviceIndex}" value="任務配置" /></div>
            <div><label>服務項目</label><select id="comp-item-${serviceIndex}"><option value="">（可選）</option>${itemsOptions}</select></div>
            <div><label>頻率</label><select id="comp-freq-${serviceIndex}"><option value="monthly" selected>每月</option><option value="quarterly">每季</option><option value="yearly">每年</option></select></div>
          </div>
          <div style="margin-top:10px;">
            <label>交付月份（每月制）</label>
            <div id="comp-months-${serviceIndex}" style="margin-top:6px;">
              ${Array.from({length:12},(_,i)=>`<label style=\"display:inline-flex;align-items:center;gap:6px;margin:4px 8px;\"><input type=\"checkbox\" class=\"comp-month-${serviceIndex}\" value=\"${i+1}\" checked> ${i+1}月</label>`).join('')}
              <div style="margin-top:6px;"><button type="button" class="table-btn" onclick="toggleMonths(${serviceIndex},true)">全選</button> <button type="button" class="table-btn" onclick="toggleMonths(${serviceIndex},false)">全不選</button></div>
            </div>
          </div>
          <div style="margin-top:10px;">
            <label>服務層級 SOP</label>
            <div id="comp-sops-${serviceIndex}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;">${sopOptions||'<span style=\"color:#9ca3af;\">尚無 SOP</span>'}</div>
          </div>
          <div style="margin-top:10px;">
            <label>任務列表</label>
            <div id="tasks-list-${serviceIndex}" style="margin-top:6px;"></div>
            <button type="button" class="table-btn" onclick="addComponentTask(${serviceIndex})">+ 新增任務</button>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
            <button type="button" class="table-btn table-btn-secondary" onclick="cancelComponentForm(${serviceIndex})">取消</button>
            <button type="button" class="table-btn table-btn-primary" onclick="saveComponentConfig(${serviceIndex})">儲存配置</button>
          </div>
        </div>`;
      // 預設一個任務
      window[`compTasks${serviceIndex}`] = [
        { task_name:'任務', assignee_user_id:null, notes:'', due_rule:'end_of_month', due_value:null, estimated_hours:null, advance_days:7, sop_ids:[] }
      ];
      renderComponentTasks(serviceIndex);
    }

    function toggleMonths(serviceIndex, on) {
      document.querySelectorAll(`.comp-month-${serviceIndex}`).forEach(cb => cb.checked = !!on);
    }

    function cancelComponentForm(serviceIndex) {
      const container = document.getElementById(`components-content-${serviceIndex}`);
      if (container) container.innerHTML = '';
    }

    function renderComponentTasks(serviceIndex) {
      const tasks = window[`compTasks${serviceIndex}`] || [];
      const el = document.getElementById(`tasks-list-${serviceIndex}`);
      if (!el) return;
      el.innerHTML = tasks.map((t, idx) => {
        const assigneeOptions = (Array.isArray(employeesList)?employeesList:[]).map(u=>`<option value="${u.user_id}" ${t.assignee_user_id==u.user_id?'selected':''}>${u.name||u.username}</option>`).join('');
        const sopOptions = (allSOPs||[]).map(s => {
          const checked = Array.isArray(t.sop_ids) && t.sop_ids.includes(s.sop_id) ? 'checked' : '';
          return `<label style=\"display:inline-flex;align-items:center;gap:6px;margin:4px 8px;\"><input type=\"checkbox\" ${checked} onchange=\"toggleTaskSOP(${serviceIndex},${idx},${s.sop_id},this.checked)\"> ${s.title}</label>`;
        }).join('');
        return `<div style=\"border:1px solid #e5e7eb;border-radius:6px;padding:8px;margin-bottom:8px;\">\n          <div style=\"display:grid;grid-template-columns:repeat(3,1fr);gap:8px;\">\n            <div><label>名稱</label><input type=\"text\" value=\"${t.task_name}\" oninput=\"updateTaskField(${serviceIndex},${idx},'task_name',this.value)\"></div>\n            <div><label>負責人</label><select onchange=\"updateTaskField(${serviceIndex},${idx},'assignee_user_id',this.value)\"><option value=\"\">（不指定）</option>${assigneeOptions}</select></div>\n            <div><label>預估時數</label><input type=\"number\" step=\"0.1\" min=\"0\" value=\"${t.estimated_hours||''}\" oninput=\"updateTaskField(${serviceIndex},${idx},'estimated_hours',this.value)\"></div>\n          </div>\n          <div style=\"display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:6px;\">\n            <div><label>到期規則</label><select onchange=\"updateTaskField(${serviceIndex},${idx},'due_rule',this.value)\"><option value=\"end_of_month\" ${t.due_rule==='end_of_month'?'selected':''}>月末</option><option value=\"fixed_day\" ${t.due_rule==='fixed_day'?'selected':''}>固定日</option><option value=\"days_after_month_start\" ${t.due_rule==='days_after_month_start'?'selected':''}>月初後N天</option><option value=\"days_before_month_end\" ${t.due_rule==='days_before_month_end'?'selected':''}>月末前N天</option></select></div>\n            <div><label>規則值</label><input type=\"text\" value=\"${t.due_value||''}\" oninput=\"updateTaskField(${serviceIndex},${idx},'due_value',this.value)\" placeholder=\"例如 20（固定每月20日）\"></div>\n            <div><label>提前天數</label><input type=\"number\" min=\"0\" value=\"${t.advance_days||7}\" oninput=\"updateTaskField(${serviceIndex},${idx},'advance_days',this.value)\"></div>\n          </div>\n          <div style=\"margin-top:6px;\"><label>備註</label><input type=\"text\" value=\"${t.notes||''}\" oninput=\"updateTaskField(${serviceIndex},${idx},'notes',this.value)\" style=\"width:100%\"></div>\n          <div style=\"margin-top:6px;\"><label>SOP（任務層級）</label><div>${sopOptions || '<span style=\\"color:#9ca3af;\\">尚無 SOP</span>'}</div></div>\n          <div style=\"margin-top:6px;\"><button type=\"button\" class=\"table-btn-link danger\" onclick=\"removeComponentTask(${serviceIndex},${idx})\">刪除此任務</button></div>\n        </div>`;
      }).join('');
    }

    function addComponentTask(serviceIndex) {
      const tasks = window[`compTasks${serviceIndex}`] || [];
      tasks.push({ task_name:'任務', assignee_user_id:null, notes:'', due_rule:'end_of_month', due_value:null, estimated_hours:null, advance_days:7, sop_ids:[] });
      window[`compTasks${serviceIndex}`] = tasks;
      renderComponentTasks(serviceIndex);
    }

    function updateTaskField(serviceIndex, idx, field, value) {
      const tasks = window[`compTasks${serviceIndex}`] || [];
      if (!tasks[idx]) return;
      if (field==='assignee_user_id') value = value ? parseInt(value,10) : null;
      if (field==='estimated_hours') value = value ? parseFloat(value) : null;
      if (['advance_days'].includes(field)) value = value ? parseInt(value,10) : 7;
      tasks[idx][field] = value;
    }
    function toggleTaskSOP(serviceIndex, idx, sopId, on) {
      const tasks = window[`compTasks${serviceIndex}`] || [];
      if (!tasks[idx]) return;
      tasks[idx].sop_ids = tasks[idx].sop_ids || [];
      if (on) { if (!tasks[idx].sop_ids.includes(sopId)) tasks[idx].sop_ids.push(sopId); }
      else { tasks[idx].sop_ids = tasks[idx].sop_ids.filter(id => id !== sopId); }
    }

    function removeComponentTask(serviceIndex, idx) {
      const tasks = window[`compTasks${serviceIndex}`] || [];
      tasks.splice(idx,1);
      window[`compTasks${serviceIndex}`] = tasks;
      renderComponentTasks(serviceIndex);
    }

    function saveComponentConfig(serviceIndex) {
      const svc = tempServices[serviceIndex];
      if (!svc) return;
      const name = document.getElementById(`comp-name-${serviceIndex}`).value.trim() || '任務配置';
      const itemId = document.getElementById(`comp-item-${serviceIndex}`).value || null;
      const freq = document.getElementById(`comp-freq-${serviceIndex}`).value || 'monthly';
      const months = Array.from(document.querySelectorAll(`.comp-month-${serviceIndex}:checked`)).map(cb=>parseInt(cb.value,10));
      const sopIds = Array.from(document.querySelectorAll(`.comp-sop-${serviceIndex}:checked`)).map(cb=>parseInt(cb.value,10));
      const tasks = window[`compTasks${serviceIndex}`] || [];
      if (tasks.length === 0) { alert('請至少新增一個任務'); return; }
      svc.components = svc.components || [];
      svc.components.push({
        component_name: name,
        service_item_id: itemId ? parseInt(itemId,10) : null,
        delivery_frequency: freq,
        delivery_months: freq==='monthly' ? months : [],
        component_sop_ids: sopIds,
        tasks: tasks.map(t => ({
          task_name: t.task_name,
          assignee_user_id: t.assignee_user_id || null,
          notes: t.notes || null,
          due_rule: t.due_rule || 'end_of_month',
          due_value: t.due_value || null,
          estimated_hours: t.estimated_hours || null,
          advance_days: t.advance_days || 7,
          sop_ids: t.sop_ids || []
        }))
      });
      cancelComponentForm(serviceIndex);
      alert('已儲存任務配置（組成部分）');
    }

    // 切換收費明細展開/收起
    function toggleBilling(serviceIndex) {
      const detailRow = document.getElementById(`billing-row-${serviceIndex}`);
      const icon = document.getElementById(`expand-icon-${serviceIndex}`);
      
      if (detailRow.style.display === 'none') {
        detailRow.style.display = 'table-row';
        icon.textContent = '▼';
      } else {
        detailRow.style.display = 'none';
        icon.textContent = '▶';
      }
    }

    // 暴露函數到全局
    window.toggleBilling = toggleBilling;

    // 集中新增收費 - 控制
    function showGlobalBillingModal() {
      const modal = document.getElementById('globalBillingModal');
      const sel = document.getElementById('gb-service-select');
      sel.innerHTML = tempServices.length > 0
        ? tempServices.map((svc, idx) => {
            const name = (allServices.find(s=>s.service_id==svc.service_id)||{}).service_name || `服務${idx+1}`;
            return `<option value="${idx}">${name}</option>`;
          }).join('')
        : '<option value="">（尚未新增服務）</option>';
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('gb-ot-date').value = today;
      modal.style.display = 'flex';
    }
    function closeGlobalBillingModal() { document.getElementById('globalBillingModal').style.display='none'; }
    function gbToggleMonths(on) { document.querySelectorAll('.gb-month').forEach(cb => cb.checked = !!on); }
    document.addEventListener('change', function(e){
      if (e.target && e.target.id === 'gb-range') {
        const v = e.target.value; const box = document.getElementById('gb-months');
        box.style.display = v==='custom' ? 'block' : 'none';
      }
      if (e.target && e.target.name === 'gb-type') {
        const v = e.target.value; document.getElementById('gb-monthly').style.display = v==='monthly' ? 'block' : 'none'; document.getElementById('gb-onetime').style.display = v==='one-time' ? 'block' : 'none';
      }
    });
    function saveGlobalBillingFromModal() {
      const type = (document.querySelector('input[name=gb-type]:checked')||{}).value;
      const idxStr = document.getElementById('gb-service-select').value;
      const idx = idxStr ? parseInt(idxStr,10) : -1;
      if (idx<0 || !tempServices[idx]) { alert('請先新增服務'); return; }
      const svc = tempServices[idx]; svc.billings = svc.billings || [];
      if (type==='one-time') {
        const desc = document.getElementById('gb-ot-desc').value.trim();
        const date = document.getElementById('gb-ot-date').value;
        const amount = parseFloat(document.getElementById('gb-ot-amount').value);
        const due = parseInt(document.getElementById('gb-ot-due').value);
        const notes = document.getElementById('gb-ot-notes').value.trim();
        if (!desc || !date || !amount) { alert('請填寫完整一次性收費'); return; }
        svc.billings.push({ billing_type:'one-time', billing_date:date, description:desc, billing_amount:amount, payment_due_days: due||30, notes: notes||null, billing_month: 0 });
      } else {
        const amount = parseFloat(document.getElementById('gb-amount').value);
        const due = parseInt(document.getElementById('gb-due').value);
        const range = document.getElementById('gb-range').value;
        if (!amount || amount<=0) { alert('請輸入有效金額'); return; }
        let months = [];
        if (range==='all') months = Array.from({length:12},(_,i)=>i+1); else months = Array.from(document.querySelectorAll('.gb-month:checked')).map(cb=>parseInt(cb.value,10));
        if (months.length===0) { alert('請選擇月份'); return; }
        months.forEach(m => svc.billings.push({ billing_type:'monthly', billing_month:m, billing_amount:amount, payment_due_days: due||30, notes: null }));
      }
      closeGlobalBillingModal();
      // 重新渲染目標服務的收費表
      const container = document.getElementById(`billing-content-${idx}`);
      if (container) container.innerHTML = renderBillingTable(idx);
    }

    // 載入服務類型選項
    async function loadServices() {
      try {
        const res = await fetch('/internal/api/v1/services');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allServices = json.data;
        }
      } catch (err) {
        console.error('載入服務選項失敗:', err);
      }
    }

    // 載入任務模板選項
    async function loadTemplates() {
      try {
        const res = await fetch('/internal/api/v1/task-templates');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allTemplates = json.data;
        }
      } catch (err) {
        console.error('載入模板選項失敗:', err);
      }
    }

    async function createNewTag() {
      const name = (document.getElementById('newTagName').value||'').trim();
      const color = document.getElementById('newTagColor').value||'#3b82f6';
      if (!name) { alert('請輸入標籤名稱'); return; }
      try {
        const res = await fetch('/internal/api/v1/tags', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tag_name: name, tag_color: color }) });
        const json = await res.json();
        if (!res.ok || !json.ok) { alert(json.message||'建立失敗'); return; }
        document.getElementById('newTagName').value='';
        await loadAllTags();
        renderTagsSelect();
      } catch (e) { alert('建立失敗，請稍後再試'); }
    }
    window.createNewTag = createNewTag;

    // 顯示新增服務行
    function showAddServiceRow() {
      const addRow = document.getElementById('add-service-row');
      addRow.style.display = 'table-row';
    }

    // 取消新增服務
    function cancelAddService() {
      const addRow = document.getElementById('add-service-row');
      addRow.style.display = 'none';
      document.getElementById('new-service-id').value = '';
      document.getElementById('new-service-status').value = 'active';
      document.getElementById('new-service-cycle').value = 'monthly';
      document.getElementById('new-service-start-date').value = '';
    }

    // 儲存新服務
    function saveNewService() {
      const serviceId = document.getElementById('new-service-id').value;
      const status = document.getElementById('new-service-status').value;
      const cycle = document.getElementById('new-service-cycle').value;
      const startDate = document.getElementById('new-service-start-date').value;
      const templateId = document.getElementById('new-service-template').value;
      const autogen = document.getElementById('new-service-autogen').checked;
      const serviceNotes = document.getElementById('new-service-notes').value.trim();

      if (!serviceId) {
        alert('請選擇服務');
        return;
      }

      const data = {
        service_id: parseInt(serviceId),
        status: status,
        service_cycle: cycle,
        start_date: startDate || null,
        task_template_id: templateId ? parseInt(templateId) : null,
        auto_generate_tasks: autogen,
        service_notes: serviceNotes || null,
        billings: []
      };

      tempServices.push(data);
      renderServices(tempServices);
      cancelAddService();
    }

    // 編輯服務（內嵌）
    async function editService(index) {
      const service = tempServices[index];
      if (!service) {
        alert('找不到服務');
        return;
      }

      const serviceRow = document.querySelectorAll('.service-main-row')[index];
      const serviceName = allServices.find(s => s.service_id == service.service_id)?.service_name || '';
      
      serviceRow.innerHTML = `
        <td></td>
        <td>
          <select id="edit-service-id-${index}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
            ${allServices.filter(s => s.is_active).map(s => 
              `<option value="${s.service_id}" ${s.service_id == service.service_id ? 'selected' : ''}>${s.service_name}</option>`
            ).join('')}
          </select>
        </td>
        <td>
          <select id="edit-service-status-${index}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
            <option value="active" ${service.status == 'active' ? 'selected' : ''}>使用中</option>
            <option value="suspended" ${service.status == 'suspended' ? 'selected' : ''}>暫停</option>
            <option value="expired" ${service.status == 'expired' ? 'selected' : ''}>已到期</option>
            <option value="cancelled" ${service.status == 'cancelled' ? 'selected' : ''}>已取消</option>
          </select>
        </td>
        <td>
          <select id="edit-service-cycle-${index}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
            <option value="monthly" ${service.service_cycle == 'monthly' ? 'selected' : ''}>每月</option>
            <option value="quarterly" ${service.service_cycle == 'quarterly' ? 'selected' : ''}>每季</option>
            <option value="yearly" ${service.service_cycle == 'yearly' ? 'selected' : ''}>每年</option>
            <option value="one-time" ${service.service_cycle == 'one-time' ? 'selected' : ''}>一次性</option>
          </select>
        </td>
        <td>
          <input type="text" id="edit-service-notes-${index}" value="${service.service_notes || ''}" placeholder="服務備註" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px;" />
        </td>
        <td>
          <input type="date" id="edit-service-start-date-${index}" value="${service.start_date || ''}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
        </td>
        <td>
          <button class="table-btn-link" onclick="saveEditService(${index})">儲存</button>
          <button class="table-btn-link danger" onclick="cancelEditService(${index})">取消</button>
        </td>
      `;
    }

    // 儲存編輯的服務
    function saveEditService(index) {
      const serviceId = document.getElementById(`edit-service-id-${index}`).value;
      const status = document.getElementById(`edit-service-status-${index}`).value;
      const cycle = document.getElementById(`edit-service-cycle-${index}`).value;
      const startDate = document.getElementById(`edit-service-start-date-${index}`).value;

      tempServices[index] = {
        ...tempServices[index],
        service_id: parseInt(serviceId),
        status: status,
        service_cycle: cycle,
        start_date: startDate || null,
        service_notes: (document.getElementById(`edit-service-notes-${index}`).value||'').trim() || null
      };

      renderServices(tempServices);
    }

    // 取消編輯服務
    function cancelEditService(index) {
      renderServices(tempServices);
    }

    // 刪除服務
    async function deleteService(index, serviceName) {
      if (!confirm(`確定要刪除服務「${serviceName}」嗎？`)) return;
      
      tempServices.splice(index, 1);
      renderServices(tempServices);
    }

    // 顯示新增收費行
  async function showAddBillingRow(serviceIndex) {
      const row = document.getElementById(`add-row-${serviceIndex}`);
      if (!row) return;
      row.style.display = '';
      row.innerHTML = `
        <td colspan="5">
          <div style="padding:12px;border:2px solid #3b82f6;border-radius:8px;background:#f0f9ff;">
            <div style="display:flex;gap:12px;margin-bottom:12px;">
              <label style="display:flex;align-items:center;gap:6px;">
                <input type="radio" name="type-${serviceIndex}" value="monthly" checked> 按月
              </label>
              <label style="display:flex;align-items:center;gap:6px;">
                <input type="radio" name="type-${serviceIndex}" value="one-time"> 一次性
              </label>
            </div>
            <div id="monthly-form-${serviceIndex}">
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:8px;">
                <div><label>每月金額 *</label><input type="number" id="batch-amount-${serviceIndex}" step="0.01" min="0"></div>
                <div><label>付款期限（天）</label><input type="number" id="batch-due-${serviceIndex}" value="30" min="1"></div>
                <div><label>月份範圍</label>
                  <select id="batch-range-${serviceIndex}"><option value="all">全年（1-12月）</option><option value="custom">自選月份</option></select>
                </div>
              </div>
              <div id="month-checkboxes-${serviceIndex}" style="display:none;margin-bottom:8px;">
                ${Array.from({length:12},(_,i)=>`<label style=\"display:inline-flex;align-items:center;gap:6px;margin:4px 8px;\"><input type=\"checkbox\" class=\"month-checkbox-${serviceIndex}\" value=\"${i+1}\" checked> ${i+1}月</label>`).join('')}
                <div style="margin-top:8px;">
                  <button class="table-btn table-btn-secondary" type="button" onclick="selectAllMonths(${serviceIndex},true)">全選</button>
                  <button class="table-btn table-btn-secondary" type="button" onclick="selectAllMonths(${serviceIndex},false)">全不選</button>
                </div>
              </div>
            </div>
            <div id="onetime-form-${serviceIndex}" style="display:none;">
              <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:8px;">
                <div><label>項目名稱 *</label><input type="text" id="ot-desc-${serviceIndex}"></div>
                <div><label>收費日期 *</label><input type="date" id="ot-date-${serviceIndex}"></div>
              </div>
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:8px;">
                <div><label>金額 *</label><input type="number" id="ot-amount-${serviceIndex}" step="0.01" min="0"></div>
                <div><label>付款期限（天）</label><input type="number" id="ot-due-${serviceIndex}" value="30" min="1"></div>
                <div><label>備註</label><input type="text" id="ot-notes-${serviceIndex}"></div>
              </div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
              <button class="table-btn table-btn-secondary" type="button" onclick="cancelAddBillingRow(${serviceIndex})">取消</button>
              <button class="table-btn table-btn-primary" type="button" onclick="saveNewBillingFromInline(${serviceIndex})">確認新增</button>
            </div>
          </div>
        </td>`;
      const rangeSelect = document.getElementById(`batch-range-${serviceIndex}`);
      rangeSelect.addEventListener('change', function(){
        const cb = document.getElementById(`month-checkboxes-${serviceIndex}`);
        cb.style.display = this.value==='custom' ? 'block' : 'none';
      });
      // 切換類型
      Array.from(document.querySelectorAll(`input[name=type-${serviceIndex}]`)).forEach(r=>{
        r.addEventListener('change', function(){
          document.getElementById(`monthly-form-${serviceIndex}`).style.display = this.value==='monthly' ? 'block' : 'none';
          document.getElementById(`onetime-form-${serviceIndex}`).style.display = this.value==='one-time' ? 'block' : 'none';
        });
      });
    }

    function selectAllMonths(serviceIndex, on) {
      document.querySelectorAll(`.month-checkbox-${serviceIndex}`).forEach(cb => cb.checked = !!on);
    }

    function cancelAddBillingRow(serviceIndex) {
      const row = document.getElementById(`add-row-${serviceIndex}`);
      if (row) { row.innerHTML=''; row.style.display='none'; }
    }

    function saveNewBillingFromInline(serviceIndex) {
      const type = (document.querySelector(`input[name=type-${serviceIndex}]:checked`)||{}).value;
      const svc = tempServices[serviceIndex];
      if (!svc) return;
      svc.billings = svc.billings || [];
      if (type === 'one-time') {
        const desc = document.getElementById(`ot-desc-${serviceIndex}`).value.trim();
        const date = document.getElementById(`ot-date-${serviceIndex}`).value;
        const amount = parseFloat(document.getElementById(`ot-amount-${serviceIndex}`).value);
        const due = parseInt(document.getElementById(`ot-due-${serviceIndex}`).value);
        const notes = document.getElementById(`ot-notes-${serviceIndex}`).value.trim();
        if (!desc || !date || !amount) { alert('請填寫完整一次性收費資料'); return; }
        svc.billings.push({ billing_type:'one-time', billing_date:date, description:desc, billing_amount:amount, payment_due_days: due||30, notes: notes||null, billing_month: 0 });
      } else {
        const amount = parseFloat(document.getElementById(`batch-amount-${serviceIndex}`).value);
        const due = parseInt(document.getElementById(`batch-due-${serviceIndex}`).value);
        const range = document.getElementById(`batch-range-${serviceIndex}`).value;
        if (!amount || amount<=0) { alert('請輸入有效金額'); return; }
        let months = [];
        if (range==='all') months = Array.from({length:12},(_,i)=>i+1); else months = Array.from(document.querySelectorAll(`.month-checkbox-${serviceIndex}:checked`)).map(cb=>parseInt(cb.value));
        if (months.length===0) { alert('請選擇月份'); return; }
        months.forEach(m => svc.billings.push({ billing_type:'monthly', billing_month:m, billing_amount:amount, payment_due_days: due||30, notes: null }));
      }
      cancelAddBillingRow(serviceIndex);
      document.getElementById(`billing-content-${serviceIndex}`).innerHTML = renderBillingTable(serviceIndex);
    }

    // 開始編輯收費明細
  function startEditBilling(serviceIndex, billingIndex) {
      const container = document.getElementById(`billing-content-${serviceIndex}`);
      const svc = tempServices[serviceIndex];
      if (!container || !svc) return;
      const b = svc.billings[billingIndex];
      const isOT = b.billing_type === 'one-time';
      const rowSelector = `#billing-content-${serviceIndex} tr[data-billing-index="${billingIndex}"]`;
      const row = container.querySelector(rowSelector);
      if (!row) return;
      row.innerHTML = `
        <td>${isOT ? (b.billing_date ? (new Date(b.billing_date).getMonth()+1)+'月' : '') : (b.billing_month+'月')}</td>
        <td><input type="number" id="eb-amount-${serviceIndex}-${billingIndex}" value="${b.billing_amount}" step="0.01" min="0" style="width:120px"></td>
        <td><input type="number" id="eb-due-${serviceIndex}-${billingIndex}" value="${b.payment_due_days||30}" min="1" style="width:80px"></td>
        <td>${isOT ? `<input type="text" id="eb-notes-${serviceIndex}-${billingIndex}" value="${(b.description||'') + (b.notes?(' - '+b.notes):'')}" style="width:100%">` : `<input type="text" id="eb-notes-${serviceIndex}-${billingIndex}" value="${b.notes||''}" style="width:100%">`}</td>
        <td>
          <button class="table-btn-link" onclick="saveEditedBilling(${serviceIndex}, ${billingIndex}, ${isOT?1:0})">儲存</button>
          <button class="table-btn-link" onclick="document.getElementById('billing-content-${serviceIndex}').innerHTML = renderBillingTable(${serviceIndex})">取消</button>
        </td>`;
    }

    // 儲存收費明細（新增或編輯）
  function saveEditedBilling(serviceIndex, billingIndex, isOT) {
      const svc = tempServices[serviceIndex];
      if (!svc) return;
      const b = svc.billings[billingIndex];
      const amount = parseFloat(document.getElementById(`eb-amount-${serviceIndex}-${billingIndex}`).value);
      const due = parseInt(document.getElementById(`eb-due-${serviceIndex}-${billingIndex}`).value);
      const notesStr = document.getElementById(`eb-notes-${serviceIndex}-${billingIndex}`).value.trim();
      if (!amount || amount<=0) { alert('金額無效'); return; }
      b.billing_amount = amount; b.payment_due_days = due||30;
      if (b.billing_type === 'one-time') {
        // 將 notesStr 不拆分，儲存在 notes；描述維持原值
        b.notes = notesStr || null;
      } else {
        b.notes = notesStr || null;
      }
      document.getElementById(`billing-content-${serviceIndex}`).innerHTML = renderBillingTable(serviceIndex);
    }

    // 取消編輯收費明細
    async function cancelBillingEdit(clientServiceId, scheduleId) {
      // 新增頁面不支持
    }

    // 刪除收費明細（內嵌）
  async function deleteBillingInline(serviceIndex, billingIndex) {
      const svc = tempServices[serviceIndex];
      if (!svc) return;
      svc.billings.splice(billingIndex, 1);
      document.getElementById(`billing-content-${serviceIndex}`).innerHTML = renderBillingTable(serviceIndex);
    }

    // 暴露函數到全局
    window.showAddBillingRow = showAddBillingRow;
    window.startEditBilling = startEditBilling;
    window.saveBilling = saveBilling;
    window.cancelBillingEdit = cancelBillingEdit;
    window.deleteBillingInline = deleteBillingInline;



    // 取消編輯
    function cancelEdit() {
      window.location.href = '/internal/clients';
    }
    
    // 儲存客戶資料
    async function saveClient() {
      clearFormErrors();
      
      const assigneeValue = document.getElementById('inputAssignee').value;
      const assigneeUserId = assigneeValue ? parseInt(assigneeValue) : 0;
      
      const payload = {
        client_id: document.getElementById('inputTaxId').value.trim() || null,
        company_name: document.getElementById('inputCompanyName').value.trim(),
        assignee_user_id: assigneeUserId,
        phone: document.getElementById('inputPhone').value.trim() || null,
        email: document.getElementById('inputEmail').value.trim() || null,
        contact_person_1: document.getElementById('inputContactPerson1').value.trim() || null,
        contact_person_2: document.getElementById('inputContactPerson2').value.trim() || null,
        client_notes: document.getElementById('inputClientNotes').value.trim() || null,
        payment_notes: document.getElementById('inputPaymentNotes').value.trim() || null,
        tag_ids: Array.from(selectedTagIds)
      };
      
      // 驗證
      let hasError = false;
      if (!payload.company_name) {
        showFieldError('company_name', '公司名稱為必填');
        hasError = true;
      }
      if (!assigneeUserId || assigneeUserId <= 0) {
        showFieldError('assignee', '請選擇負責人員');
        hasError = true;
      }
      
      if (hasError) return;
      
      try {
        console.log('新增客戶請求數據:', payload);
        
        const res = await fetch('/internal/api/v1/clients', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        
        const json = await res.json();
        console.log('新增客戶響應:', json);
        
        if (!res.ok || !json.ok) {
          if (json.errors && Array.isArray(json.errors)) {
            const errorMsg = json.errors.map(e => `${e.field}: ${e.message}`).join('\n');
            alert(`${json.message}\n\n${errorMsg}`);
            json.errors.forEach(err => {
              showFieldError(err.field, err.message);
            });
          } else {
            alert(json.message || '新增失敗');
          }
          return;
        }
        
        const newClientId = json.data.client_id;

        // 如果有服務，逐一新增
        if (tempServices.length > 0) {
          for (let i = 0; i < tempServices.length; i++) {
            const svc = tempServices[i];
            const resSvc = await fetch(`/internal/api/v1/clients/${newClientId}/services`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                service_id: svc.service_id,
                status: svc.status,
                service_cycle: svc.service_cycle,
                start_date: svc.start_date || null,
                task_template_id: svc.task_template_id || null,
                auto_generate_tasks: svc.auto_generate_tasks !== false
              })
            });
        const jsonSvc = await resSvc.json().catch(()=>null);
            const clientServiceId = jsonSvc?.data?.client_service_id;
            if (clientServiceId && Array.isArray(svc.billings)) {
              for (const b of svc.billings) {
                const payload = (b.billing_type === 'one-time') ? {
                  client_service_id: clientServiceId,
                  billing_type: 'one-time',
                  billing_date: b.billing_date,
                  description: b.description,
                  billing_amount: b.billing_amount,
                  payment_due_days: b.payment_due_days,
                  notes: b.notes || null,
                  billing_month: 0
                } : {
                  client_service_id: clientServiceId,
                  billing_type: 'monthly',
                  billing_month: b.billing_month,
                  billing_amount: b.billing_amount,
                  payment_due_days: b.payment_due_days,
                  notes: b.notes || null
                };
                await fetch('/internal/api/v1/billing', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify(payload)
                });
              }
            }

            // 若選了任務模板：建立服務組成部分（依模板階段自動生成任務）
            if (clientServiceId && svc.task_template_id) {
              try {
                const stagesRes = await fetch(`/internal/api/v1/task-templates/${svc.task_template_id}/stages`, { credentials:'include' });
                const stagesJson = await stagesRes.json().catch(()=>null);
                const stages = Array.isArray(stagesJson?.data) ? stagesJson.data : [];
                const tasks = stages.map((stage, idx) => ({
                  task_name: stage.stage_name,
                  assignee_user_id: null,
                  notes: stage.description || null,
                  due_rule: stage.due_date_rule || 'end_of_month',
                  due_value: stage.due_date_value || null,
                  estimated_hours: stage.estimated_hours || null,
                  advance_days: stage.advance_days || 7,
                  sop_ids: stage.sop_id ? [stage.sop_id] : []
                }));
                if (tasks.length > 0) {
                  await fetch(`/internal/api/v1/client-services/${clientServiceId}/components`, {
                    method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
                    body: JSON.stringify({
                      service_id: svc.service_id,
                      component_name: '任務配置',
                      delivery_frequency: 'monthly',
                      task_template_id: svc.task_template_id,
                      auto_generate_task: svc.auto_generate_tasks !== false,
                      advance_days: 7,
                      tasks
                    })
                  });
                }
              } catch (e) {
                console.warn('建立服務組成部分失敗（將在詳情頁再補）', e);
              }
            }

            // 若手動配置了組成部分，逐一建立
            if (clientServiceId && Array.isArray(svc.components) && svc.components.length > 0) {
              for (const comp of svc.components) {
                const payloadComp = {
                  service_id: svc.service_id,
                  service_item_id: comp.service_item_id || null,
                  component_name: comp.component_name || '任務配置',
                  delivery_frequency: comp.delivery_frequency || 'monthly',
                  delivery_months: comp.delivery_months || [],
                  task_template_id: svc.task_template_id || null,
                  auto_generate_task: svc.auto_generate_tasks !== false,
                  advance_days: 7,
                  component_sop_ids: comp.component_sop_ids || [],
                  tasks: comp.tasks || []
                };
                await fetch(`/internal/api/v1/client-services/${clientServiceId}/components`, {
                  method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payloadComp)
                });
              }
            }
          }
        }

        // 若選擇立即產生任務則嘗試觸發（非管理員會被忽略）
        const genNowEl = document.getElementById('generate-now');
        if (genNowEl && genNowEl.checked) {
          try {
            await fetch('/internal/api/v1/admin/tasks/generate-from-components', { method:'POST', credentials:'include' });
          } catch (_) {}
        }

        alert('客戶新增成功！');
        window.location.href = `/internal/client-detail?id=${newClientId}`;
        
      } catch (err) {
        console.error('新增失敗:', err);
        alert('新增失敗，請稍後再試');
      }
    }

    // 顯示欄位錯誤
    function showFieldError(field, message) {
      const errorEl = document.getElementById(`error_${field}`);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
    }

    // 清除表單錯誤
    function clearFormErrors(formPrefix) {
      document.querySelectorAll('.error-message, .error-text').forEach(el => {
        el.textContent = '';
        el.style.display = 'none';
      });
    }

    // 點擊Modal外部關閉
    window.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });

    // 初始化
    init();
  </script>
</body>
</html>
