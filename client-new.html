<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新增客戶 - 內部系統</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
  <link rel="stylesheet" href="/assets/css/client-detail-page.css?v=2">
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container">
    <div class="page-header">
      <div class="header-left">
        <a href="/internal/clients" class="back-link">← 返回客戶列表</a>
        <h1 class="page-title">新增客戶</h1>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="cancelCreate()">取消</button>
        <button class="btn btn-primary" onclick="createClient()">新增</button>
      </div>
    </div>

    <!-- 客戶基本信息表單 -->
    <div class="content-card">
      <h2 class="card-title">基本信息</h2>
      <form id="clientForm" class="edit-form">
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputClientId">統一編號（必填，8位數字）</label>
            <input type="text" id="inputClientId" required maxlength="8" placeholder="例如：12345678" />
            <span class="error-text" id="error_client_id"></span>
          </div>
          <div class="form-field">
            <label for="inputCompanyName">公司名稱（必填）</label>
            <input type="text" id="inputCompanyName" required placeholder="例如：台灣科技股份有限公司" />
            <span class="error-text" id="error_company_name"></span>
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputAssignee">負責人員（必填）</label>
            <select id="inputAssignee" required>
              <option value="">載入中...</option>
            </select>
            <span class="error-text" id="error_assignee"></span>
          </div>
          <div class="form-field">
            <label for="inputPhone">聯絡電話</label>
            <input type="text" id="inputPhone" placeholder="例如：02-1234-5678" />
            <span class="error-text" id="error_phone"></span>
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputEmail">Email</label>
            <input type="email" id="inputEmail" placeholder="例如：contact@example.com" />
            <span class="error-text" id="error_email"></span>
          </div>
          <div class="form-field">
            <label>標籤</label>
            <div style="color: #9ca3af; font-size: 14px; padding: 12px 0;">新增後可在客戶詳情頁設置</div>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputClientNotes">客戶備註</label>
            <textarea id="inputClientNotes" rows="3" placeholder="輸入客戶相關備註..."></textarea>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputPaymentNotes">收款備註</label>
            <textarea id="inputPaymentNotes" rows="3" placeholder="輸入收款相關備註..."></textarea>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="footer-placeholder"></div>
  
  <script type="module">
    import { loadNavbar, loadFooter } from '/assets/js/components/bootstrap.js';
    loadNavbar();
    loadFooter();
  </script>

  <script>
    const apiBase = '/internal/api/v1';

    // 載入員工列表
    async function loadEmployees() {
      try {
        const res = await fetch('/internal/api/v1/users');
        const json = await res.json();
        
        if (json.ok && json.data) {
          const select = document.getElementById('inputAssignee');
          select.innerHTML = '<option value="">請選擇負責人員</option>' +
            json.data.map(u => 
              `<option value="${u.user_id}">${u.username} (${u.display_name || u.username})</option>`
            ).join('');
        }
      } catch (err) {
        console.error('載入員工列表失敗:', err);
        document.getElementById('inputAssignee').innerHTML = '<option value="">載入失敗</option>';
      }
    }

    // 取消新增
    function cancelCreate() {
      if (confirm('確定要取消新增嗎？所有輸入的資料將會遺失。')) {
        window.location.href = '/internal/clients';
      }
    }

    // 新增客戶
    async function createClient() {
      clearFormErrors();
      
      const clientId = document.getElementById('inputClientId').value.trim();
      const companyName = document.getElementById('inputCompanyName').value.trim();
      const assigneeUserId = parseInt(document.getElementById('inputAssignee').value);
      const phone = document.getElementById('inputPhone').value.trim();
      const email = document.getElementById('inputEmail').value.trim();
      const clientNotes = document.getElementById('inputClientNotes').value.trim();
      const paymentNotes = document.getElementById('inputPaymentNotes').value.trim();
      
      // 驗證
      let hasError = false;
      
      if (!clientId || !/^\d{8}$/.test(clientId)) {
        showFieldError('client_id', '統一編號必須為8位數字');
        hasError = true;
      }
      
      if (!companyName) {
        showFieldError('company_name', '公司名稱為必填');
        hasError = true;
      }
      
      if (!assigneeUserId || assigneeUserId <= 0) {
        showFieldError('assignee', '請選擇負責人員');
        hasError = true;
      }
      
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showFieldError('email', 'Email格式不正確');
        hasError = true;
      }
      
      if (hasError) return;
      
      const payload = {
        client_id: clientId,
        company_name: companyName,
        assignee_user_id: assigneeUserId,
        phone: phone || null,
        email: email || null,
        client_notes: clientNotes || null,
        payment_notes: paymentNotes || null
      };
      
      try {
        const res = await fetch(`${apiBase}/clients`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        
        const json = await res.json();
        
        if (!res.ok || !json.ok) {
          if (json.errors && Array.isArray(json.errors)) {
            json.errors.forEach(err => {
              showFieldError(err.field, err.message);
            });
          } else {
            alert(json.message || '新增失敗');
          }
          return;
        }
        
        alert('客戶新增成功！');
        window.location.href = `/internal/client-detail?id=${clientId}`;
        
      } catch (err) {
        console.error('新增客戶失敗:', err);
        alert('新增失敗，請稍後再試');
      }
    }

    // 顯示欄位錯誤
    function showFieldError(field, message) {
      const errorEl = document.getElementById(`error_${field}`);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
    }

    // 清除表單錯誤
    function clearFormErrors() {
      document.querySelectorAll('.error-text').forEach(el => {
        el.textContent = '';
        el.style.display = 'none';
      });
    }

    // 暴露函數到全局
    window.cancelCreate = cancelCreate;
    window.createClient = createClient;

    // 初始化
    loadEmployees();
  </script>
</body>
</html>

