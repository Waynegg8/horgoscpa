<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°å¢å®¢æˆ¶ - å…§éƒ¨ç³»çµ±</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
  <link rel="stylesheet" href="/assets/css/client-detail-page.css?v=30">
  
  <!-- âš¡ ç¦ç”¨ç·©å­˜ç³»çµ±ï¼ˆæ–°å¢å®¢æˆ¶å¾Œéœ€è¦æ›´æ–°åˆ—è¡¨ï¼‰ -->
  <script>
  // âŒ æ–°å¢å®¢æˆ¶é é¢ç¦ç”¨ç·©å­˜ç³»çµ±
  console.log('[Client-New] â„¹ï¸ æ–°å¢å®¢æˆ¶é é¢å·²ç¦ç”¨æ‰€æœ‰ç·©å­˜åŠŸèƒ½');
  
  // ç¦ç”¨ DataCache é¢„åŠ è½½
  window.__DISABLE_DATA_CACHE__ = true;
  
  // ç¦ç”¨ fetch-interceptor æ‹¦æˆª
  window.__DISABLE_FETCH_INTERCEPTOR__ = true;
  
  // é¡µé¢åŠ è½½æ—¶æ¸…é™¤å®¢æˆ·åˆ—è¡¨ç¼“å­˜
  document.addEventListener('DOMContentLoaded', function() {
    const clientsCacheKeys = [
      'clients_page1', 'clients_page2', 'clients_page3', 
      'clients_page4', 'clients_page5', 'clients_all'
    ];
    
    clientsCacheKeys.forEach(key => {
      localStorage.removeItem(`cache_${key}`);
    });
    
    console.log('[Client-New] âœ“ å·²æ¸…é™¤å®¢æˆ·åˆ—è¡¨ç¼“å­˜');
  });
  </script>
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container">
    <a href="/internal/clients" class="back-link" style="display:inline-block;margin-bottom:16px;">â† è¿”å›å®¢æˆ¶åˆ—è¡¨</a>

    <!-- å®¢æˆ¶åŸºæœ¬ä¿¡æ¯ - å¯ç·¨è¼¯è¡¨å–® -->
    <div class="content-card">
      <h2 class="card-title">åŸºæœ¬ä¿¡æ¯</h2>
      <form id="clientForm" class="edit-form">
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputCompanyName">å…¬å¸åç¨±ï¼ˆå¿…å¡«ï¼‰</label>
            <input type="text" id="inputCompanyName" required />
            <span class="error-text" id="error_company_name"></span>
          </div>
          <div class="form-field">
            <label for="inputTaxId">çµ±ä¸€ç·¨è™Ÿ</label>
            <input type="text" id="inputTaxId" maxlength="8" />
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputAssignee">è² è²¬äººå“¡</label>
            <select id="inputAssignee">
              <option value="">è¼‰å…¥ä¸­...</option>
            </select>
            <span class="error-text" id="error_assignee"></span>
          </div>
          <div class="form-field">
            <label for="inputPhone">è¯çµ¡é›»è©±</label>
            <input type="text" id="inputPhone" />
            <span class="error-text" id="error_phone"></span>
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputContactPerson1">è¯çµ¡äººä¸€</label>
            <input type="text" id="inputContactPerson1" maxlength="50" />
          </div>
          <div class="form-field">
            <label for="inputContactPerson2">è¯çµ¡äººäºŒ</label>
            <input type="text" id="inputContactPerson2" maxlength="50" />
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputEmail">Email</label>
            <input type="email" id="inputEmail" />
            <span class="error-text" id="error_email"></span>
          </div>
          <div class="form-field">
            <label>æ¨™ç±¤ç®¡ç†</label>
            <div id="tagsDisplay" style="min-height:36px; display:flex; gap:8px; flex-wrap:wrap; padding:8px 0;"><span style="color:#9ca3af;">å°šæœªè¨­å®šæ¨™ç±¤</span></div>
            <button type="button" class="btn btn-sm btn-secondary" onclick="showTagsModal()">+ ç®¡ç†æ¨™ç±¤</button>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputClientNotes">å®¢æˆ¶å‚™è¨»</label>
            <textarea id="inputClientNotes" rows="3"></textarea>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputPaymentNotes">æ”¶æ¬¾å‚™è¨»</label>
            <textarea id="inputPaymentNotes" rows="3"></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="cancelEdit()">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="saveClient()">æ–°å¢å®¢æˆ¶</button>
        </div>
      </form>
    </div>

    <!-- å®¢æˆ¶æœå‹™ -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">å®¢æˆ¶æœå‹™</h2>
        <button class="btn btn-primary" onclick="showAddServiceRow()">+ æ–°å¢æœå‹™</button>
      </div>
      <div class="table-wrapper">
        <table class="services-table" id="servicesTable">
          <thead>
            <tr>
              <th>æœå‹™åç¨±</th>
              <th>ç‹€æ…‹</th>
              <th>å¹´åº¦ç¸½é¡</th>
              <th>é–‹å§‹æ—¥æœŸ</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="servicesList">
            <tr>
              <td colspan="5" class="no-data">å°šæœªæ–°å¢æœå‹™</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- æ”¶è²»è¨­å®š -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">ğŸ’° æ”¶è²»è¨­å®š</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
          <select id="billing-service-filter" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
            <option value="">å…¨éƒ¨æœå‹™</option>
          </select>
          <button id="btn-billing-select-all" class="btn btn-secondary" onclick="toggleSelectAll(true)" title="é¸å–ç›®å‰æ¸…å–®å…¨éƒ¨">å…¨é¸</button>
          <button id="btn-billing-clear-all" class="btn btn-secondary" onclick="toggleSelectAll(false)" title="å–æ¶ˆç›®å‰æ¸…å–®å…¨éƒ¨">å…¨ä¸é¸</button>
          <button id="btn-batch-delete" class="btn btn-danger" onclick="batchDeleteBilling()" disabled>æ‰¹é‡åˆªé™¤</button>
          <button class="btn btn-primary" onclick="showAddBillingModal()">+ æ–°å¢æ”¶è²»</button>
        </div>
      </div>
      <div class="table-wrapper">
        <table class="billing-table" id="billingTable">
          <thead>
            <tr>
              <th style="width: 44px; text-align:center;"><input type="checkbox" id="billing-master" onchange="onMasterSelectChange(this)"></th>
              <th>æœå‹™åç¨±</th>
              <th style="width: 80px;">æœˆä»½</th>
              <th style="width: 120px;">é‡‘é¡</th>
              <th style="width: 100px;">ä»˜æ¬¾æœŸé™</th>
              <th>å‚™è¨»</th>
              <th style="width: 130px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="billingList">
            <tr>
              <td colspan="7" class="no-data">å°šæœªè¨­å®šæ”¶è²»</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script src="/assets/js/components/bootstrap.js?v=3"></script>
  <!-- æ¨™ç±¤ç®¡ç†å½ˆçª—ï¼ˆèˆ‡è©³æƒ…é ä¸€è‡´ï¼‰ -->
  <div id="tagsModal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:8px; padding:20px; width:90%; max-width:600px; max-height:80vh; overflow:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3 style="margin:0;">ç®¡ç†æ¨™ç±¤</h3>
        <button onclick="closeTagsModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#6b7280">Ã—</button>
      </div>
      <div style="margin-bottom:12px;">
        <h4 style="margin:0 0 8px 0; font-size:14px; color:#6b7280;">å·²é¸æ¨™ç±¤</h4>
        <div id="selectedTagsList" style="display:flex; flex-wrap:wrap; gap:8px; min-height:36px; padding:10px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px;"></div>
      </div>
      <div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <h4 style="margin:0; font-size:14px; color:#6b7280;">æ‰€æœ‰æ¨™ç±¤ï¼ˆé»æ“Šé¸æ“‡/å–æ¶ˆï¼‰</h4>
          <button class="btn btn-sm btn-secondary" onclick="toggleNewTagForm()" id="btnShowNewTag">+ æ–°å¢æ¨™ç±¤</button>
        </div>
        <div id="newTagForm" style="display:none; background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px; padding:12px; margin-bottom:12px;">
          <div style="display:flex; gap:8px;">
            <input type="text" id="newTagName" placeholder="æ¨™ç±¤åç¨±" style="flex:1; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px;">
            <select id="newTagColor" style="padding:6px 10px; border:1px solid #d1d5db; border-radius:6px;">
              <option value="#3b82f6">è—</option>
              <option value="#10b981">ç¶ </option>
              <option value="#ef4444">ç´…</option>
              <option value="#f59e0b">æ©™</option>
              <option value="#6b7280">ç°</option>
            </select>
            <button class="btn btn-sm btn-secondary" onclick="cancelNewTag()">å–æ¶ˆ</button>
            <button class="btn btn-sm btn-primary" onclick="saveNewTag()">å»ºç«‹</button>
          </div>
        </div>
        <div id="allTagsList" style="display:flex; flex-wrap:wrap; gap:8px;"><span style="color:#9ca3af;">è¼‰å…¥ä¸­...</span></div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
        <button class="btn btn-secondary" onclick="closeTagsModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveTags()">å„²å­˜</button>
      </div>
    </div>
  </div>
  
  <!-- æ–°å¢/ç·¨è¼¯æ”¶è²»å½ˆçª—ï¼ˆèˆ‡è©³æƒ…é ä¸€è‡´ï¼‰ -->
  <div id="billingModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 24px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;" id="billingModalTitle">æ–°å¢æ”¶è²»</h3>
        <button onclick="closeBillingModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">é¸æ“‡æœå‹™ *</label>
        <select id="modal-service-select" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
          <option value="">è«‹é¸æ“‡æœå‹™</option>
        </select>
      </div>
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">æ”¶è²»é¡å‹ *</label>
        <div style="display: flex; gap: 12px;">
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 10px 16px; border: 2px solid #d1d5db; border-radius: 6px; flex: 1;">
            <input type="radio" name="billing-type" value="monthly" checked onchange="switchBillingType('monthly')" style="cursor: pointer;" />
            <div>
              <div style="font-weight: 500; font-size: 14px;">æŒ‰æœˆæ”¶è²»</div>
              <div style="font-size: 12px; color: #6b7280;">æ¯æœˆå›ºå®šé‡‘é¡</div>
            </div>
          </label>
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 10px 16px; border: 2px solid #d1d5db; border-radius: 6px; flex: 1;">
            <input type="radio" name="billing-type" value="one-time" onchange="switchBillingType('one-time')" style="cursor: pointer;" />
            <div>
              <div style="font-weight: 500; font-size: 14px;">ä¸€æ¬¡æ€§æ”¶è²»</div>
              <div style="font-size: 12px; color: #6b7280;">è¨­ç«‹è²»ã€é¡§å•è²»ç­‰</div>
            </div>
          </label>
        </div>
      </div>
      <div id="monthly-billing-form" style="margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div>
            <label style="display: block; margin-bottom: 8px;">æ¯æœˆé‡‘é¡ *</label>
            <input id="modal-batch-amount" type="number" step="0.01" min="0" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 8px;">ä»˜æ¬¾æœŸé™ï¼ˆå¤©ï¼‰</label>
            <input id="modal-batch-due" type="number" value="30" min="1" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 8px;">æœˆä»½ç¯„åœ</label>
            <select id="modal-batch-range" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="all">å…¨å¹´ï¼ˆ1-12æœˆï¼‰</option>
              <option value="custom">è‡ªé¸æœˆä»½</option>
            </select>
          </div>
        </div>
        <div id="modal-month-checkboxes" style="display: none; margin-top: 10px;">
          ${Array.from({length:12},(_,i)=>`<label style=\"display:inline-flex;align-items:center;gap:6px;margin:4px 8px;\"><input type=\"checkbox\" class=\"modal-month-checkbox\" value=\"${i+1}\" checked> ${i+1}æœˆ</label>`).join('')}
          <div style="margin-top: 8px;">
            <button class="btn btn-sm btn-secondary" onclick="modalSelectAllMonths(true)" type="button">å…¨é¸</button>
            <button class="btn btn-sm btn-secondary" onclick="modalSelectAllMonths(false)" type="button">å…¨ä¸é¸</button>
          </div>
        </div>
      </div>
      <div id="onetime-billing-form" style="display: none; margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label style="display: block; margin-bottom: 8px;">é …ç›®åç¨± *</label>
            <input id="modal-onetime-description" type="text" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 8px;">æ”¶è²»æ—¥æœŸ *</label>
            <input id="modal-onetime-date" type="date" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 10px;">
          <div>
            <label style="display: block; margin-bottom: 8px;">é‡‘é¡ *</label>
            <input id="modal-onetime-amount" type="number" step="0.01" min="0" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 8px;">ä»˜æ¬¾æœŸé™ï¼ˆå¤©ï¼‰</label>
            <input id="modal-onetime-due" type="number" value="30" min="1" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 8px;">å‚™è¨»</label>
            <input id="modal-onetime-notes" type="text" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
        </div>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeBillingModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveBillingFromModal()">ç¢ºèªæ–°å¢</button>
      </div>
    </div>
  </div>
  <script>
    let currentClientId = null;
    let currentEditingServiceId = null;
    let currentBillingServiceId = null;
    let allServices = [];
    let allTemplates = [];
    let tempServices = [];
    let allTags = [];
    let allServiceItems = [];
    let allSOPs = [];
    let employeesList = [];
    let selectedTagIds = new Set();

    // é é¢åˆå§‹åŒ–
    async function init() {
      await Promise.all([
        loadEmployees(),
        loadServices(),
        loadTemplates(),
        loadServiceItems(),
        loadAllSOPs(),
        loadAllTags()
      ]);
      
      renderServices(tempServices);
      renderTagsDisplay();
      renderTagsSelect();
      // åˆå§‹åŒ–æ”¶è²»è¨­å®šé¢æ¿
      refreshBillingFilterOptions();
      const billingServiceFilter = document.getElementById('billing-service-filter');
      if (billingServiceFilter) {
        billingServiceFilter.addEventListener('change', function(){
          renderBillingList(this.value);
        });
      }
      renderBillingList('');
    }

    // è¼‰å…¥å“¡å·¥åˆ—è¡¨
    async function loadEmployees() {
      try {
        const res = await fetch('/internal/api/v1/users');
        const json = await res.json();
        
        if (json.ok && json.data) {
          employeesList = json.data;
          const select = document.getElementById('inputAssignee');
          select.innerHTML = '<option value="">è«‹é¸æ“‡è² è²¬äººå“¡</option>' +
            employeesList.map(u => 
              `<option value="${u.user_id}">${u.name || u.username}</option>`
            ).join('');
        }
      } catch (err) {
        console.error('è¼‰å…¥å“¡å·¥åˆ—è¡¨å¤±æ•—:', err);
      }
    }

    // è¼‰å…¥æœå‹™é …
    async function loadServiceItems() {
      try {
        const res = await fetch('/internal/api/v1/services/items');
        const json = await res.json();
        if (json.ok && json.data) {
          allServiceItems = json.data;
        }
      } catch (err) {
        console.error('è¼‰å…¥æœå‹™é …ç›®å¤±æ•—:', err);
      }
    }

    // è¼‰å…¥ SOP æ¸…å–®
    async function loadAllSOPs() {
      try {
        const res = await fetch('/internal/api/v1/sop');
        const json = await res.json();
        if (json.ok && json.data) {
          allSOPs = json.data.filter(s => !s.is_deleted).map(s => ({ ...s, sop_id: s.id }));
        }
      } catch (err) {
        console.error('è¼‰å…¥ SOP å¤±æ•—:', err);
      }
    }

    // è¼‰å…¥æ¨™ç±¤
    async function loadAllTags() {
      try {
        const res = await fetch('/internal/api/v1/tags');
        const json = await res.json();
        if (json.ok && json.data) {
          allTags = json.data;
        }
      } catch (e) {
        console.error('è¼‰å…¥æ¨™ç±¤å¤±æ•—:', e);
      }
    }

    function renderTagsDisplay() {
      const container = document.getElementById('tagsDisplay');
      if (!container) return;
      const tags = allTags.filter(t => selectedTagIds.has(t.tag_id));
      if (tags.length === 0) {
        container.innerHTML = '<span style="color: #9ca3af;">å°šæœªè¨­å®šæ¨™ç±¤</span>';
        return;
      }
      container.innerHTML = tags.map(t => (
        `<span style="display:inline-flex;align-items:center;padding:4px 12px;background:${t.tag_color || '#6b7280'};color:#fff;border-radius:4px;font-size:13px;">${t.tag_name}</span>`
      )).join('');
    }

    function renderAllTags() {
      const container = document.getElementById('allTagsList');
      if (!container) return;
      if (!allTags || allTags.length === 0) { container.innerHTML = '<span style="color: #9ca3af;">æš«ç„¡æ¨™ç±¤</span>'; return; }
      container.innerHTML = allTags.map(tag => {
        const isSelected = selectedTagIds.has(tag.tag_id);
        return `
          <button type="button" onclick="toggleTag(${tag.tag_id})"
                  style="display:inline-flex;align-items:center;padding:6px 14px;background:${isSelected ? (tag.tag_color||'#3b82f6') : '#f3f4f6'};color:${isSelected ? '#fff' : '#374151'};border:${isSelected ? 'none' : '1px solid #d1d5db'};border-radius:4px;font-size:13px;cursor:pointer;transition:all .2s;">
            ${isSelected ? 'âœ“ ' : ''}${tag.tag_name}
          </button>`;
      }).join('');
    }

    function toggleTag(tagId) {
      if (selectedTagIds.has(tagId)) selectedTagIds.delete(tagId); else selectedTagIds.add(tagId);
      renderTagsDisplay();
      renderAllTags();
      renderSelectedTags();
    }
    window.toggleTag = toggleTag;

    // æ¸²æŸ“æœå‹™åˆ—è¡¨
    function renderServices(services) {
      const tbody = document.getElementById('servicesList');
      
      const serviceOptions = allServices && allServices.length > 0
        ? allServices.filter(s => s.is_active).map(s => 
            `<option value="${s.service_id}">${s.service_name}</option>`
          ).join('')
        : '';
      
      const addServiceRowHtml = `
        <tr id="add-service-row" style="display: none;">
          <td>
            <select id="new-service-id" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="">è«‹é¸æ“‡æœå‹™</option>
              ${serviceOptions}
            </select>
          </td>
          <td>
            <select id="new-service-status" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="active">ä½¿ç”¨ä¸­</option>
              <option value="suspended">æš«åœ</option>
              <option value="expired">å·²åˆ°æœŸ</option>
              <option value="cancelled">å·²å–æ¶ˆ</option>
            </select>
          </td>
          <td>
            <input type="date" id="new-service-start-date" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </td>
          <td>
            <button class="table-btn-link" onclick="saveNewService()">å„²å­˜</button>
            <button class="table-btn-link danger" onclick="cancelAddService()">å–æ¶ˆ</button>
          </td>
        </tr>
      `;
      
      if (!services || services.length === 0) {
        tbody.innerHTML = addServiceRowHtml + '<tr><td colspan="5" class="no-data">å°šæœªæ–°å¢æœå‹™</td></tr>';
        return;
      }

      const serviceRows = services.map((svc, index) => {
        const statusClass = {
          'active': 'status-active',
          'suspended': 'status-suspended',
          'expired': 'status-expired',
          'cancelled': 'status-cancelled'
        }[svc.status] || '';
        
        const statusText = {
          'active': 'ä½¿ç”¨ä¸­',
          'suspended': 'æš«åœ',
          'expired': 'å·²åˆ°æœŸ',
          'cancelled': 'å·²å–æ¶ˆ'
        }[svc.status] || svc.status;

        const cycleText = {
          'monthly': 'æ¯æœˆ',
          'quarterly': 'æ¯å­£',
          'yearly': 'æ¯å¹´',
          'one-time': 'ä¸€æ¬¡æ€§'
        }[svc.service_cycle] || svc.service_cycle;

        const service = allServices.find(s => s.service_id == svc.service_id);
        const serviceName = service ? service.service_name : '-';

        const billings = svc.billings || [];
        const yearTotal = billings.reduce((sum, b) => sum + (parseFloat(b.billing_amount) || 0), 0);

        return `
          <tr class="service-main-row">
            <td><strong>${serviceName}</strong></td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td class="amount">$${yearTotal.toLocaleString('zh-TW')}</td>
            <td>${svc.start_date || '-'}</td>
            <td class="actions-cell">
              <button type="button" class="table-btn table-btn-primary" onclick="showAddComponentForm(${index})">é…ç½®æœå‹™å…§å®¹</button>
              <button type="button" class="table-btn table-btn-secondary" onclick="editService(${index})">ç·¨è¼¯</button>
              <button type="button" class="table-btn table-btn-danger" onclick="deleteService(${index}, '${serviceName}')">åˆªé™¤</button>
            </td>
          </tr>
          <tr class="component-detail-row" id="components-row-${index}" style="display:none;">
            <td colspan="5" class="component-detail-cell">
              <div class="components-content" id="components-content-${index}"></div>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = addServiceRowHtml + serviceRows;
    }

    // æ¸²æŸ“æ”¶è²»æ˜ç´°è¡¨æ ¼
    function renderBillingTable(serviceIndex) {
      const svc = tempServices[serviceIndex];
      const billings = svc.billings || [];
      
      const rows = billings.map((billing, billingIndex) => {
        const isOneTime = billing.billing_type === 'one-time' || billing.billing_month === 0;
        let monthDisplay = '';
        if (isOneTime) {
          const d = billing.billing_date ? new Date(billing.billing_date) : null;
          const m = d ? (d.getMonth() + 1) : (billing.billing_month || 'â€”');
          monthDisplay = `${m}æœˆ`;
        } else {
          monthDisplay = `${billing.billing_month}æœˆ`;
        }
        let notesDisplay = billing.notes || '-';
        if (isOneTime) {
          const d = billing.billing_date ? new Date(billing.billing_date) : null;
          const y = d ? d.getFullYear() : '';
          const m2 = d ? String(d.getMonth() + 1).padStart(2, '0') : '';
          const parts = [];
          parts.push(`[ä¸€æ¬¡æ€§] ${y}${y?'/':''}${m2}`.trim());
          if (billing.description) parts.push(billing.description);
          if (billing.notes) parts.push(billing.notes);
          notesDisplay = parts.filter(Boolean).join(' - ');
        }
        return `
          <tr data-billing-index="${billingIndex}">
            <td>${monthDisplay}</td>
            <td class="amount">$${parseFloat(billing.billing_amount).toLocaleString('zh-TW')}</td>
            <td>${billing.payment_due_days}å¤©</td>
            <td>${notesDisplay}</td>
            <td>
              <button class="table-btn-link" onclick="startEditBilling(${serviceIndex}, ${billingIndex})">ç·¨è¼¯</button>
              <button class="table-btn-link danger" onclick="deleteBillingInline(${serviceIndex}, ${billingIndex}, ${billing.billing_month||0})">åˆªé™¤</button>
            </td>
          </tr>`;
      }).join('');

      return `
        <div class="billing-header">
          <h4>æ”¶è²»æ˜ç´°</h4>
        </div>
        <table class="billing-table">
          <thead>
            <tr>
              <th>æœˆä»½</th>
              <th>é‡‘é¡</th>
              <th>å¸³æ¬¾å¤©æ•¸</th>
              <th>å‚™è¨»</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <tr id="add-row-${serviceIndex}" style="display: none;"></tr>
            ${rows || `<tr><td colspan="5" class="no-data">å°šæœªè¨­å®šæ”¶è²»æ˜ç´°</td></tr>`}
          </tbody>
        </table>
      `;
    }

    // æœå‹™çµ„æˆéƒ¨åˆ†ï¼ˆä»»å‹™é…ç½®ï¼‰
    function showAddComponentForm(serviceIndex) {
      const svc = tempServices[serviceIndex];
      const container = document.getElementById(`components-content-${serviceIndex}`);
      if (!svc || !container) return;
      const row = document.getElementById(`components-row-${serviceIndex}`);
      if (row) row.style.display = 'table-row';
      const currentServiceId = svc.service_id;
      const items = allServiceItems.filter(it => String(it.service_id) === String(currentServiceId));
      const itemsOptions = items.length > 0
        ? items.map(it => `<option value="${it.item_id}">${it.item_name}</option>`).join('')
        : '<option value="">ï¼ˆæ­¤æœå‹™ç„¡å¯ç”¨é …ç›®ï¼‰</option>';
      const sopOptions = (allSOPs||[]).map(s => `<label style=\"display:inline-flex;align-items:center;gap:6px;cursor:pointer;border:1px solid #e5e7eb;border-radius:6px;padding:4px 8px;\"><input type=\"checkbox\" class=\"comp-sop-${serviceIndex}\" value=\"${s.sop_id}\"> ${s.title}</label>`).join('');
      container.innerHTML = `
        <div id="add-component-form-${serviceIndex}" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 12px; border: 2px solid #3b82f6;">
          <h5 style="margin:0 0 10px 0;">é…ç½®æœå‹™ä»»å‹™</h5>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
            <div><label>çµ„æˆåç¨±</label><input type="text" id="comp-name-${serviceIndex}" value="ä»»å‹™é…ç½®" /></div>
            <div><label>æœå‹™é …ç›®</label><select id="comp-item-${serviceIndex}"><option value="">ï¼ˆå¯é¸ï¼‰</option>${itemsOptions}</select></div>
            <div><label>é »ç‡</label><select id="comp-freq-${serviceIndex}"><option value="monthly" selected>æ¯æœˆ</option><option value="quarterly">æ¯å­£</option><option value="yearly">æ¯å¹´</option></select></div>
          </div>
          <div style="margin-top:10px;">
            <label>äº¤ä»˜æœˆä»½ï¼ˆæ¯æœˆåˆ¶ï¼‰</label>
            <div id="comp-months-${serviceIndex}" style="margin-top:6px;">
              ${Array.from({length:12},(_,i)=>`<label style=\"display:inline-flex;align-items:center;gap:6px;margin:4px 8px;\"><input type=\"checkbox\" class=\"comp-month-${serviceIndex}\" value=\"${i+1}\" checked> ${i+1}æœˆ</label>`).join('')}
              <div style="margin-top:6px;"><button type="button" class="table-btn" onclick="toggleMonths(${serviceIndex},true)">å…¨é¸</button> <button type="button" class="table-btn" onclick="toggleMonths(${serviceIndex},false)">å…¨ä¸é¸</button></div>
            </div>
          </div>
          <div style="margin-top:10px;">
            <label>æœå‹™å±¤ç´š SOP</label>
            <div id="comp-sops-${serviceIndex}" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;">${sopOptions||'<span style=\"color:#9ca3af;\">å°šç„¡ SOP</span>'}</div>
          </div>
          <div style="margin-top:10px;">
            <label>ä»»å‹™åˆ—è¡¨</label>
            <div id="tasks-list-${serviceIndex}" style="margin-top:6px;"></div>
            <button type="button" class="table-btn" onclick="addComponentTask(${serviceIndex})">+ æ–°å¢ä»»å‹™</button>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
            <button type="button" class="table-btn table-btn-secondary" onclick="cancelComponentForm(${serviceIndex})">å–æ¶ˆ</button>
            <button type="button" class="table-btn table-btn-primary" onclick="saveComponentConfig(${serviceIndex})">å„²å­˜é…ç½®</button>
          </div>
        </div>
        <div id="components-list-${serviceIndex}"></div>`;
      // é è¨­ä¸€å€‹ä»»å‹™
      window[`compTasks${serviceIndex}`] = [
        { task_name:'ä»»å‹™', assignee_user_id:null, notes:'', due_rule:'end_of_month', due_value:null, estimated_hours:null, advance_days:7, sop_ids:[] }
      ];
      renderComponentTasks(serviceIndex);
      renderComponentsList(serviceIndex);
    }

    function toggleMonths(serviceIndex, on) {
      document.querySelectorAll(`.comp-month-${serviceIndex}`).forEach(cb => cb.checked = !!on);
    }

    function cancelComponentForm(serviceIndex) {
      const container = document.getElementById(`components-content-${serviceIndex}`);
      if (container) container.innerHTML = '';
      const row = document.getElementById(`components-row-${serviceIndex}`);
      if (row) row.style.display = 'none';
    }

    function renderComponentTasks(serviceIndex) {
      const tasks = window[`compTasks${serviceIndex}`] || [];
      const el = document.getElementById(`tasks-list-${serviceIndex}`);
      if (!el) return;
      el.innerHTML = tasks.map((t, idx) => {
        const assigneeOptions = (Array.isArray(employeesList)?employeesList:[]).map(u=>`<option value="${u.user_id}" ${t.assignee_user_id==u.user_id?'selected':''}>${u.name||u.username}</option>`).join('');
        const sopOptions = (allSOPs||[]).map(s => {
          const checked = Array.isArray(t.sop_ids) && t.sop_ids.includes(s.sop_id) ? 'checked' : '';
          return `<label style=\"display:inline-flex;align-items:center;gap:6px;margin:4px 8px;\"><input type=\"checkbox\" ${checked} onchange=\"toggleTaskSOP(${serviceIndex},${idx},${s.sop_id},this.checked)\"> ${s.title}</label>`;
        }).join('');
        return `<div style=\"border:1px solid #e5e7eb;border-radius:6px;padding:8px;margin-bottom:8px;\">\n          <div style=\"display:grid;grid-template-columns:repeat(3,1fr);gap:8px;\">\n            <div><label>åç¨±</label><input type=\"text\" value=\"${t.task_name}\" oninput=\"updateTaskField(${serviceIndex},${idx},'task_name',this.value)\"></div>\n            <div><label>è² è²¬äºº</label><select onchange=\"updateTaskField(${serviceIndex},${idx},'assignee_user_id',this.value)\"><option value=\"\">ï¼ˆä¸æŒ‡å®šï¼‰</option>${assigneeOptions}</select></div>\n            <div><label>é ä¼°æ™‚æ•¸</label><input type=\"number\" step=\"0.1\" min=\"0\" value=\"${t.estimated_hours||''}\" oninput=\"updateTaskField(${serviceIndex},${idx},'estimated_hours',this.value)\"></div>\n          </div>\n          <div style=\"display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:6px;\">\n            <div><label>åˆ°æœŸè¦å‰‡</label><select onchange=\"updateTaskField(${serviceIndex},${idx},'due_rule',this.value)\"><option value=\"end_of_month\" ${t.due_rule==='end_of_month'?'selected':''}>æœˆæœ«</option><option value=\"fixed_day\" ${t.due_rule==='fixed_day'?'selected':''}>å›ºå®šæ—¥</option><option value=\"days_after_month_start\" ${t.due_rule==='days_after_month_start'?'selected':''}>æœˆåˆå¾ŒNå¤©</option><option value=\"days_before_month_end\" ${t.due_rule==='days_before_month_end'?'selected':''}>æœˆæœ«å‰Nå¤©</option></select></div>\n            <div><label>è¦å‰‡å€¼</label><input type=\"text\" value=\"${t.due_value||''}\" oninput=\"updateTaskField(${serviceIndex},${idx},'due_value',this.value)\" placeholder=\"ä¾‹å¦‚ 20ï¼ˆå›ºå®šæ¯æœˆ20æ—¥ï¼‰\"></div>\n            <div><label>æå‰å¤©æ•¸</label><input type=\"number\" min=\"0\" value=\"${t.advance_days||7}\" oninput=\"updateTaskField(${serviceIndex},${idx},'advance_days',this.value)\"></div>\n          </div>\n          <div style=\"margin-top:6px;\"><label>å‚™è¨»</label><input type=\"text\" value=\"${t.notes||''}\" oninput=\"updateTaskField(${serviceIndex},${idx},'notes',this.value)\" style=\"width:100%\"></div>\n          <div style=\"margin-top:6px;\"><label>SOPï¼ˆä»»å‹™å±¤ç´šï¼‰</label><div>${sopOptions || '<span style=\\"color:#9ca3af;\\">å°šç„¡ SOP</span>'}</div></div>\n          <div style=\"margin-top:6px;\"><button type=\"button\" class=\"table-btn-link danger\" onclick=\"removeComponentTask(${serviceIndex},${idx})\">åˆªé™¤æ­¤ä»»å‹™</button></div>\n        </div>`;
      }).join('');
    }

    function addComponentTask(serviceIndex) {
      const tasks = window[`compTasks${serviceIndex}`] || [];
      tasks.push({ task_name:'ä»»å‹™', assignee_user_id:null, notes:'', due_rule:'end_of_month', due_value:null, estimated_hours:null, advance_days:7, sop_ids:[] });
      window[`compTasks${serviceIndex}`] = tasks;
      renderComponentTasks(serviceIndex);
    }

    function updateTaskField(serviceIndex, idx, field, value) {
      const tasks = window[`compTasks${serviceIndex}`] || [];
      if (!tasks[idx]) return;
      if (field==='assignee_user_id') value = value ? parseInt(value,10) : null;
      if (field==='estimated_hours') value = value ? parseFloat(value) : null;
      if (['advance_days'].includes(field)) value = value ? parseInt(value,10) : 7;
      tasks[idx][field] = value;
    }
    function toggleTaskSOP(serviceIndex, idx, sopId, on) {
      const tasks = window[`compTasks${serviceIndex}`] || [];
      if (!tasks[idx]) return;
      tasks[idx].sop_ids = tasks[idx].sop_ids || [];
      if (on) { if (!tasks[idx].sop_ids.includes(sopId)) tasks[idx].sop_ids.push(sopId); }
      else { tasks[idx].sop_ids = tasks[idx].sop_ids.filter(id => id !== sopId); }
    }

    function removeComponentTask(serviceIndex, idx) {
      const tasks = window[`compTasks${serviceIndex}`] || [];
      tasks.splice(idx,1);
      window[`compTasks${serviceIndex}`] = tasks;
      renderComponentTasks(serviceIndex);
    }

    function saveComponentConfig(serviceIndex) {
      const svc = tempServices[serviceIndex];
      if (!svc) return;
      const name = document.getElementById(`comp-name-${serviceIndex}`).value.trim() || 'ä»»å‹™é…ç½®';
      const itemId = document.getElementById(`comp-item-${serviceIndex}`).value || null;
      const freq = document.getElementById(`comp-freq-${serviceIndex}`).value || 'monthly';
      const months = Array.from(document.querySelectorAll(`.comp-month-${serviceIndex}:checked`)).map(cb=>parseInt(cb.value,10));
      const sopIds = Array.from(document.querySelectorAll(`.comp-sop-${serviceIndex}:checked`)).map(cb=>parseInt(cb.value,10));
      const tasks = window[`compTasks${serviceIndex}`] || [];
      if (tasks.length === 0) { alert('è«‹è‡³å°‘æ–°å¢ä¸€å€‹ä»»å‹™'); return; }
      svc.components = svc.components || [];
      svc.components.push({
        component_name: name,
        service_item_id: itemId ? parseInt(itemId,10) : null,
        delivery_frequency: freq,
        delivery_months: freq==='monthly' ? months : [],
        component_sop_ids: sopIds,
        tasks: tasks.map(t => ({
          task_name: t.task_name,
          assignee_user_id: t.assignee_user_id || null,
          notes: t.notes || null,
          due_rule: t.due_rule || 'end_of_month',
          due_value: t.due_value || null,
          estimated_hours: t.estimated_hours || null,
          advance_days: t.advance_days || 7,
          sop_ids: t.sop_ids || []
        }))
      });
      alert('å·²å„²å­˜ä»»å‹™é…ç½®');
      renderComponentsList(serviceIndex);
    }

    function renderComponentsList(serviceIndex) {
      const list = document.getElementById(`components-list-${serviceIndex}`);
      const svc = tempServices[serviceIndex];
      if (!list || !svc) return;
      const comps = Array.isArray(svc.components) ? svc.components : [];
      if (comps.length === 0) { list.innerHTML = '<div style="color:#9ca3af">å°šæœªé…ç½®ä»»å‹™</div>'; return; }
      list.innerHTML = comps.map((comp, i) => {
        const sopTags = (comp.component_sop_ids||[]).map(id => {
          const sop = (allSOPs||[]).find(s=>s.sop_id===id);
          return sop ? `<div style=\"font-size:13px;color:#374151;padding:2px 0;\">â€¢ ${sop.title}</div>` : '';
        }).join('');
        const tasks = (comp.tasks||[]).map((t, idx) => {
          const assignee = (employeesList||[]).find(u=>u.user_id===t.assignee_user_id);
          const assigneeText = assignee ? `ğŸ‘¤ è² è²¬äººï¼š${assignee.name||assignee.username} â€¢ ` : '';
          const est = t.estimated_hours ? `â±ï¸ é ä¼°ï¼š${t.estimated_hours}å°æ™‚` : '';
          const notes = t.notes ? ` â€¢ ğŸ’¡ ${t.notes}` : '';
          return `<div style=\"background:#f9fafb;padding:10px;border-radius:6px;margin-bottom:6px;border-left:3px solid #10b981;\">\n            <div style=\"font-size:13px;color:#1f2937;font-weight:500;margin-bottom:4px;\">${idx+1}. ${t.task_name||'æœªå‘½åä»»å‹™'}</div>\n            <div style=\"font-size:12px;color:#6b7280;margin-bottom:4px;\">${assigneeText}${est}${notes}</div>\n          </div>`;
        }).join('');
        return `
          <div class=\"component-item\" style=\"background:white;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #3b82f6;\">\n            <div style=\"display:flex;justify-content:space-between;align-items:start;\">\n              <div style=\"flex:1;\">\n                <h5 style=\"margin:0 0 12px 0;color:#1f2937;font-size:15px;\">ä»»å‹™é…ç½® #${i+1}</h5>\n                ${comp.component_sop_ids && comp.component_sop_ids.length>0 ? `\n                  <div style=\\\"padding:8px 12px;background:#f0f9ff;border-radius:4px;border-left:3px solid #3b82f6;margin-bottom:12px;\\\">\n                    <div style=\\\"font-size:12px;font-weight:600;color:#1e40af;margin-bottom:4px;\\\">ğŸ“– æœå‹™å±¤ç´šSOPï¼ˆ${comp.component_sop_ids.length}å€‹ï¼‰</div>\n                    ${sopTags}\n                  </div>` : ''}\n                ${comp.tasks && comp.tasks.length>0 ? `\n                  <div>\n                    <strong style=\\\"font-size:13px;color:#374151;\\\">ğŸ“‹ ä»»å‹™åˆ—è¡¨ï¼ˆ${comp.tasks.length}å€‹ï¼‰</strong>\n                    <div style=\\\"margin-top:8px;\\\">${tasks}</div>\n                  </div>` : ''}\n              </div>\n              <div style=\"display:flex;gap:5px;\">\n                <button class=\"table-btn-link danger\" onclick=\"deleteLocalComponent(${serviceIndex},${i})\">åˆªé™¤</button>\n              </div>\n            </div>\n          </div>`;
      }).join('');
    }

    function deleteLocalComponent(serviceIndex, compIndex) {
      const svc = tempServices[serviceIndex];
      if (!svc || !Array.isArray(svc.components)) return;
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é…ç½®å—ï¼Ÿ')) return;
      svc.components.splice(compIndex, 1);
      renderComponentsList(serviceIndex);
    }

    // åˆ‡æ›æ”¶è²»æ˜ç´°å±•é–‹/æ”¶èµ·
    function toggleBilling(serviceIndex) {
      const detailRow = document.getElementById(`billing-row-${serviceIndex}`);
      const icon = document.getElementById(`expand-icon-${serviceIndex}`);
      
      if (detailRow.style.display === 'none') {
        detailRow.style.display = 'table-row';
        icon.textContent = 'â–¼';
      } else {
        detailRow.style.display = 'none';
        icon.textContent = 'â–¶';
      }
    }

    // æš´éœ²å‡½æ•¸åˆ°å…¨å±€
    window.toggleBilling = toggleBilling;

    // é›†ä¸­æ–°å¢æ”¶è²» - æ§åˆ¶
    function showGlobalBillingModal() {
      const modal = document.getElementById('globalBillingModal');
      const sel = document.getElementById('gb-service-select');
      sel.innerHTML = tempServices.length > 0
        ? tempServices.map((svc, idx) => {
            const name = (allServices.find(s=>s.service_id==svc.service_id)||{}).service_name || `æœå‹™${idx+1}`;
            return `<option value="${idx}">${name}</option>`;
          }).join('')
        : '<option value="">ï¼ˆå°šæœªæ–°å¢æœå‹™ï¼‰</option>';
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('gb-ot-date').value = today;
      // é è¨­ç‚ºæŒ‰æœˆä¸¦æ”¶èµ·è‡ªé¸æœˆä»½
      const monthlyRadio = document.querySelector('input[name="gb-type"][value="monthly"]');
      if (monthlyRadio) monthlyRadio.checked = true;
      document.getElementById('gb-monthly').style.display = 'block';
      document.getElementById('gb-onetime').style.display = 'none';
      const rangeSel = document.getElementById('gb-range');
      if (rangeSel) rangeSel.value = 'all';
      const monthsBox = document.getElementById('gb-months');
      if (monthsBox) monthsBox.style.display = 'none';
      modal.style.display = 'flex';
    }
    function closeGlobalBillingModal() { document.getElementById('globalBillingModal').style.display='none'; }
    function gbToggleMonths(on) { document.querySelectorAll('.gb-month').forEach(cb => cb.checked = !!on); }
    document.addEventListener('change', function(e){
      if (e.target && e.target.id === 'gb-range') {
        const v = e.target.value; const box = document.getElementById('gb-months');
        box.style.display = v==='custom' ? 'block' : 'none';
      }
      if (e.target && e.target.name === 'gb-type') {
        const v = e.target.value; document.getElementById('gb-monthly').style.display = v==='monthly' ? 'block' : 'none'; document.getElementById('gb-onetime').style.display = v==='one-time' ? 'block' : 'none';
      }
    });
    function saveGlobalBillingFromModal() {
      const type = (document.querySelector('input[name=gb-type]:checked')||{}).value;
      const idxStr = document.getElementById('gb-service-select').value;
      const idx = idxStr ? parseInt(idxStr,10) : -1;
      if (idx<0 || !tempServices[idx]) { alert('è«‹å…ˆæ–°å¢æœå‹™'); return; }
      const svc = tempServices[idx]; svc.billings = svc.billings || [];
      if (type==='one-time') {
        const desc = document.getElementById('gb-ot-desc').value.trim();
        const date = document.getElementById('gb-ot-date').value;
        const amount = parseFloat(document.getElementById('gb-ot-amount').value);
        const due = parseInt(document.getElementById('gb-ot-due').value);
        const notes = document.getElementById('gb-ot-notes').value.trim();
        if (!desc || !date || !amount) { alert('è«‹å¡«å¯«å®Œæ•´ä¸€æ¬¡æ€§æ”¶è²»'); return; }
        svc.billings.push({ billing_type:'one-time', billing_date:date, description:desc, billing_amount:amount, payment_due_days: due||30, notes: notes||null, billing_month: 0 });
      } else {
        const amount = parseFloat(document.getElementById('gb-amount').value);
        const due = parseInt(document.getElementById('gb-due').value);
        const range = document.getElementById('gb-range').value;
        if (!amount || amount<=0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡'); return; }
        let months = [];
        if (range==='all') months = Array.from({length:12},(_,i)=>i+1); else months = Array.from(document.querySelectorAll('.gb-month:checked')).map(cb=>parseInt(cb.value,10));
        if (months.length===0) { alert('è«‹é¸æ“‡æœˆä»½'); return; }
        months.forEach(m => svc.billings.push({ billing_type:'monthly', billing_month:m, billing_amount:amount, payment_due_days: due||30, notes: null }));
      }
      closeGlobalBillingModal();
      // é‡æ–°æ¸²æŸ“ç›®æ¨™æœå‹™çš„æ”¶è²»è¡¨
      const container = document.getElementById(`billing-content-${idx}`);
      if (container) container.innerHTML = renderBillingTable(idx);
      // åŒæ­¥æ›´æ–°ã€Œæ”¶è²»è¨­å®šã€åˆ—è¡¨èˆ‡æœå‹™å¹´ç¸½é¡
      refreshBillingFilterOptions();
      renderBillingList(window.currentBillingFilter || '');
      renderServices(tempServices);
    }

    // è¼‰å…¥æœå‹™é¡å‹é¸é …
    async function loadServices() {
      try {
        const res = await fetch('/internal/api/v1/services');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allServices = json.data;
        }
      } catch (err) {
        console.error('è¼‰å…¥æœå‹™é¸é …å¤±æ•—:', err);
      }
    }

    // ==================== æ”¶è²»è¨­å®šï¼ˆæœ¬é æš«å­˜ç‰ˆæœ¬ï¼‰ ====================
    window.selectedBillingIds = new Set();
    window.currentBillingFilter = '';
    window.__billingFilteredKeys = [];

    function refreshBillingFilterOptions() {
      const serviceFilter = document.getElementById('billing-service-filter');
      if (!serviceFilter) return;
      const current = serviceFilter.value;
      serviceFilter.innerHTML = '<option value="">å…¨éƒ¨æœå‹™</option>' +
        tempServices.map((svc, idx) => {
          const name = (allServices.find(s=>s.service_id==svc.service_id)||{}).service_name || `æœå‹™${idx+1}`;
          return `<option value="${idx}" ${String(current)===String(idx)?'selected':''}>${name}</option>`;
        }).join('');
    }

    function buildAllBillingData() {
      const items = [];
      tempServices.forEach((svc, sIdx) => {
        const svcName = (allServices.find(s=>s.service_id==svc.service_id)||{}).service_name || `æœå‹™${sIdx+1}`;
        (svc.billings||[]).forEach((b, bIdx) => {
          items.push({
            key: `${sIdx}:${bIdx}`,
            service_index: sIdx,
            billing_index: bIdx,
            service_name: svcName,
            billing_type: b.billing_type || (b.billing_month===0?'one-time':'monthly'),
            billing_month: b.billing_month || 0,
            billing_date: b.billing_date || null,
            description: b.description || '',
            billing_amount: parseFloat(b.billing_amount)||0,
            payment_due_days: parseInt(b.payment_due_days)||30,
            notes: b.notes || ''
          });
        });
      });
      return items;
    }

    function renderBillingList(filterServiceId = '') {
      const billingList = document.getElementById('billingList');
      if (!billingList) return;
      window.currentBillingFilter = filterServiceId || '';
      const items = buildAllBillingData().filter(it => {
        if (!window.currentBillingFilter) return true;
        return String(it.service_index) === String(window.currentBillingFilter);
      });
      window.__billingFilteredKeys = items.map(i => i.key);
      if (items.length === 0) {
        billingList.innerHTML = '<tr><td colspan="7" class="no-data">å°šæœªè¨­å®šæ”¶è²»</td></tr>';
        updateBatchDeleteButton();
        const master = document.getElementById('billing-master');
        if (master) master.checked = false;
        return;
      }
      const rows = items.map(it => {
        const isOT = it.billing_type === 'one-time' || it.billing_month === 0;
        const d = it.billing_date ? new Date(it.billing_date) : null;
        const monthText = isOT ? (d ? `${d.getMonth()+1}æœˆ` : `${it.billing_month||''}æœˆ`) : `${it.billing_month}æœˆ`;
        let notesDisplay = '-';
        if (isOT) {
          const y = d ? d.getFullYear() : '';
          const m2 = d ? String(d.getMonth()+1).padStart(2, '0') : '';
          const parts = [`[ä¸€æ¬¡æ€§] ${y}${y?'/':''}${m2}`.trim()];
          if (it.description) parts.push(it.description);
          if (it.notes) parts.push(it.notes);
          notesDisplay = parts.filter(Boolean).join(' - ');
        } else {
          notesDisplay = it.notes || '-';
        }
        const checked = window.selectedBillingIds.has(it.key) ? 'checked' : '';
        const deleteLabel = isOT ? `ä¸€æ¬¡æ€§æ”¶è²»ï¼ˆ${it.description || ''}ï¼‰` : `${it.billing_month}æœˆ`;
        return `
          <tr data-schedule-id="${it.key}">
            <td style="text-align:center;"><input type="checkbox" ${checked} onchange="toggleBillingSelect('${it.key}', this.checked)"></td>
            <td><strong>${it.service_name}</strong></td>
            <td>${monthText}</td>
            <td class="amount">$${it.billing_amount.toLocaleString('zh-TW')}</td>
            <td>${it.payment_due_days}å¤©</td>
            <td>${notesDisplay}</td>
            <td>
              <button class="table-btn-link" onclick="editBillingRow('${it.key}')">ç·¨è¼¯</button>
              <button class="table-btn-link danger" onclick="deleteBillingRow('${it.key}', '${it.service_name}', '${deleteLabel}')">åˆªé™¤</button>
            </td>
          </tr>`;
      }).join('');
      billingList.innerHTML = rows;
      const allSelected = window.__billingFilteredKeys.length > 0 && window.__billingFilteredKeys.every(k => window.selectedBillingIds.has(k));
      const master = document.getElementById('billing-master');
      if (master) master.checked = allSelected;
      updateBatchDeleteButton();
    }

    function updateBatchDeleteButton() {
      const btn = document.getElementById('btn-batch-delete');
      if (!btn) return;
      btn.disabled = !(window.selectedBillingIds && window.selectedBillingIds.size > 0);
      btn.textContent = window.selectedBillingIds.size > 0 ? `æ‰¹é‡åˆªé™¤ï¼ˆ${window.selectedBillingIds.size}ï¼‰` : 'æ‰¹é‡åˆªé™¤';
    }

    function toggleBillingSelect(key, checked) {
      if (!window.selectedBillingIds) window.selectedBillingIds = new Set();
      if (checked) window.selectedBillingIds.add(key); else window.selectedBillingIds.delete(key);
      updateBatchDeleteButton();
    }

    function onMasterSelectChange(el) {
      toggleSelectAll(el && el.checked);
    }

    function toggleSelectAll(selectAll) {
      const ids = window.__billingFilteredKeys || [];
      ids.forEach(k => { if (selectAll) window.selectedBillingIds.add(k); else window.selectedBillingIds.delete(k); });
      ids.forEach(k => {
        const row = document.querySelector(`tr[data-schedule-id="${k}"] input[type=checkbox]`);
        if (row) row.checked = !!selectAll;
      });
      const master = document.getElementById('billing-master');
      if (master) master.checked = !!selectAll && ids.length > 0;
      updateBatchDeleteButton();
    }

    function batchDeleteBilling() {
      if (!window.selectedBillingIds || window.selectedBillingIds.size === 0) return;
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤é¸å–çš„ ${window.selectedBillingIds.size} ç­†æ”¶è²»å—ï¼Ÿ`)) return;
      const keys = Array.from(window.selectedBillingIds);
      keys.forEach(k => {
        const [sIdx, bIdx] = k.split(':').map(n=>parseInt(n,10));
        if (!isNaN(sIdx) && !isNaN(bIdx) && tempServices[sIdx] && tempServices[sIdx].billings) {
          tempServices[sIdx].billings.splice(bIdx, 1);
        }
      });
      window.selectedBillingIds.clear();
      refreshBillingFilterOptions();
      renderBillingList(window.currentBillingFilter || '');
      renderServices(tempServices);
    }

    function editBillingRow(key) {
      const row = document.querySelector(`tr[data-schedule-id="${key}"]`);
      if (!row) return;
      const [sIdx, bIdx] = key.split(':').map(n=>parseInt(n,10));
      const b = (tempServices[sIdx]||{}).billings?.[bIdx];
      if (!b) return;
      const isOT = b.billing_type === 'one-time' || b.billing_month === 0;
      const d = b.billing_date ? new Date(b.billing_date) : null;
      const monthText = isOT ? (d ? `${d.getMonth()+1}æœˆ` : `${b.billing_month||''}æœˆ`) : `${b.billing_month}æœˆ`;
      const notesStr = isOT ? `${(b.description||'')}${b.notes?(' - '+b.notes):''}` : (b.notes||'');
      row.innerHTML = `
        <td style="text-align:center;"><input type="checkbox" disabled></td>
        <td><strong>${(allServices.find(s=>s.service_id==(tempServices[sIdx]||{}).service_id)||{}).service_name||''}</strong></td>
        <td>${monthText}</td>
        <td><input type="number" id="eb-amount-${sIdx}-${bIdx}" value="${parseFloat(b.billing_amount)||0}" step="0.01" min="0" style="width:120px"></td>
        <td><input type="number" id="eb-due-${sIdx}-${bIdx}" value="${parseInt(b.payment_due_days)||30}" min="1" style="width:80px"></td>
        <td><input type="text" id="eb-notes-${sIdx}-${bIdx}" value="${notesStr}" style="width:100%"></td>
        <td>
          <button class="table-btn-link" onclick="saveEditedBillingRow('${key}', ${isOT?1:0})">å„²å­˜</button>
          <button class="table-btn-link" onclick="renderBillingList(window.currentBillingFilter||'')">å–æ¶ˆ</button>
        </td>`;
    }

    function saveEditedBillingRow(key, isOT) {
      const [sIdx, bIdx] = key.split(':').map(n=>parseInt(n,10));
      const svc = tempServices[sIdx];
      if (!svc || !svc.billings || !svc.billings[bIdx]) return;
      const b = svc.billings[bIdx];
      const amount = parseFloat(document.getElementById(`eb-amount-${sIdx}-${bIdx}`).value);
      const due = parseInt(document.getElementById(`eb-due-${sIdx}-${bIdx}`).value);
      const notesStr = (document.getElementById(`eb-notes-${sIdx}-${bIdx}`).value||'').trim();
      if (!amount || amount<=0) { alert('é‡‘é¡ç„¡æ•ˆ'); return; }
      b.billing_amount = amount;
      b.payment_due_days = due||30;
      if (b.billing_type === 'one-time' || isOT) {
        b.notes = notesStr || null; // æè¿°ä»ç¶­æŒåŸå€¼
      } else {
        b.notes = notesStr || null;
      }
      renderBillingList(window.currentBillingFilter || '');
      renderServices(tempServices);
    }

    function deleteBillingRow(key, serviceName, deleteLabel) {
      if (!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${serviceName} - ${deleteLabel}ã€å—ï¼Ÿ`)) return;
      const [sIdx, bIdx] = key.split(':').map(n=>parseInt(n,10));
      if (!isNaN(sIdx) && !isNaN(bIdx) && tempServices[sIdx] && tempServices[sIdx].billings) {
        tempServices[sIdx].billings.splice(bIdx, 1);
      }
      window.selectedBillingIds.delete(key);
      renderBillingList(window.currentBillingFilter || '');
      renderServices(tempServices);
    }

    // èˆ‡è©³æƒ…é åŒåçš„åŒ…è£å‡½æ•¸ï¼Œç¶­æŒ UI è¡Œç‚ºä¸€è‡´
    function showAddBillingModal() { showGlobalBillingModal(); }
    function switchBillingType(type) {
      if (type === 'monthly') { document.getElementById('gb-monthly').style.display='block'; document.getElementById('gb-onetime').style.display='none'; }
      else { document.getElementById('gb-monthly').style.display='none'; document.getElementById('gb-onetime').style.display='block'; }
    }
    function modalSelectAllMonths(selectAll) { gbToggleMonths(!!selectAll); }
    function saveBillingFromModal() { saveGlobalBillingFromModal(); }

    // è¼‰å…¥ä»»å‹™æ¨¡æ¿é¸é …
    async function loadTemplates() {
      try {
        const res = await fetch('/internal/api/v1/task-templates');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allTemplates = json.data;
        }
      } catch (err) {
        console.error('è¼‰å…¥æ¨¡æ¿é¸é …å¤±æ•—:', err);
      }
    }

    // ===== æ¨™ç±¤ç®¡ç†ï¼ˆèˆ‡è©³æƒ…é ä¸€è‡´çš„è¡Œç‚ºï¼‰ =====
    function showTagsModal() {
      const modal = document.getElementById('tagsModal');
      renderAllTags();
      renderSelectedTags();
      modal.style.display = 'flex';
    }
    function closeTagsModal() {
      const modal = document.getElementById('tagsModal');
      modal.style.display = 'none';
      const form = document.getElementById('newTagForm');
      if (form) form.style.display = 'none';
      const btn = document.getElementById('btnShowNewTag');
      if (btn) btn.textContent = '+ æ–°å¢æ¨™ç±¤';
    }
    function toggleNewTagForm() {
      const form = document.getElementById('newTagForm');
      const btn = document.getElementById('btnShowNewTag');
      if (!form) return;
      const showing = form.style.display !== 'none';
      form.style.display = showing ? 'none' : 'block';
      if (btn) btn.textContent = showing ? '+ æ–°å¢æ¨™ç±¤' : 'å–æ¶ˆæ–°å¢';
    }
    function renderSelectedTags() {
      const container = document.getElementById('selectedTagsList');
      if (!container) return;
      const tags = allTags.filter(t => selectedTagIds.has(t.tag_id));
      container.innerHTML = tags.length === 0
        ? '<span style="color:#9ca3af;">å°šæœªé¸æ“‡æ¨™ç±¤</span>'
        : tags.map(t => `<span style=\"display:inline-flex;align-items:center;padding:4px 12px;background:${t.tag_color||'#6b7280'};color:#fff;border-radius:4px;font-size:13px;\">${t.tag_name}</span>`).join('');
    }
    function saveNewTag() { createNewTag(); }
    function saveTags() {
      renderTagsDisplay();
      closeTagsModal();
    }

    async function createNewTag() {
      const name = (document.getElementById('newTagName').value||'').trim();
      const color = document.getElementById('newTagColor').value||'#3b82f6';
      if (!name) { alert('è«‹è¼¸å…¥æ¨™ç±¤åç¨±'); return; }
      try {
        const res = await fetch('/internal/api/v1/tags', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tag_name: name, tag_color: color }) });
        const json = await res.json();
        if (!res.ok || !json.ok) { alert(json.message||'å»ºç«‹å¤±æ•—'); return; }
        document.getElementById('newTagName').value='';
        await loadAllTags();
        renderTagsSelect();
      } catch (e) { alert('å»ºç«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'); }
    }
    window.createNewTag = createNewTag;

    // é¡¯ç¤ºæ–°å¢æœå‹™è¡Œ
    function showAddServiceRow() {
      const addRow = document.getElementById('add-service-row');
      addRow.style.display = 'table-row';
    }

    // å–æ¶ˆæ–°å¢æœå‹™
    function cancelAddService() {
      const addRow = document.getElementById('add-service-row');
      addRow.style.display = 'none';
      document.getElementById('new-service-id').value = '';
      document.getElementById('new-service-status').value = 'active';
      document.getElementById('new-service-start-date').value = '';
    }

    // å„²å­˜æ–°æœå‹™
    function saveNewService() {
      const serviceId = document.getElementById('new-service-id').value;
      const status = document.getElementById('new-service-status').value;
      const startDate = document.getElementById('new-service-start-date').value;

      if (!serviceId) {
        alert('è«‹é¸æ“‡æœå‹™');
        return;
      }

      const data = {
        service_id: parseInt(serviceId),
        status: status,
        start_date: startDate || null,
        billings: []
      };

      tempServices.push(data);
      renderServices(tempServices);
      refreshBillingFilterOptions();
      renderBillingList(window.currentBillingFilter || '');
      cancelAddService();
    }

    // ç·¨è¼¯æœå‹™ï¼ˆå…§åµŒï¼‰
    async function editService(index) {
      const service = tempServices[index];
      if (!service) {
        alert('æ‰¾ä¸åˆ°æœå‹™');
        return;
      }

      const serviceRow = document.querySelectorAll('.service-main-row')[index];
      const serviceName = allServices.find(s => s.service_id == service.service_id)?.service_name || '';
      
      serviceRow.innerHTML = `
        <td>
          <select id="edit-service-id-${index}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
            ${allServices.filter(s => s.is_active).map(s => 
              `<option value="${s.service_id}" ${s.service_id == service.service_id ? 'selected' : ''}>${s.service_name}</option>`
            ).join('')}
          </select>
        </td>
        <td>
          <select id="edit-service-status-${index}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
            <option value="active" ${service.status == 'active' ? 'selected' : ''}>ä½¿ç”¨ä¸­</option>
            <option value="suspended" ${service.status == 'suspended' ? 'selected' : ''}>æš«åœ</option>
            <option value="expired" ${service.status == 'expired' ? 'selected' : ''}>å·²åˆ°æœŸ</option>
            <option value="cancelled" ${service.status == 'cancelled' ? 'selected' : ''}>å·²å–æ¶ˆ</option>
          </select>
        </td>
        <td>-</td>
        <td>
          <input type="date" id="edit-service-start-date-${index}" value="${service.start_date || ''}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
        </td>
        <td>
          <button class="table-btn-link" onclick="saveEditService(${index})">å„²å­˜</button>
          <button class="table-btn-link danger" onclick="cancelEditService(${index})">å–æ¶ˆ</button>
        </td>
      `;
    }

    // å„²å­˜ç·¨è¼¯çš„æœå‹™
    function saveEditService(index) {
      const serviceId = document.getElementById(`edit-service-id-${index}`).value;
      const status = document.getElementById(`edit-service-status-${index}`).value;
      const startDate = document.getElementById(`edit-service-start-date-${index}`).value;

      tempServices[index] = {
        ...tempServices[index],
        service_id: parseInt(serviceId),
        status: status,
        start_date: startDate || null
      };

      renderServices(tempServices);
      refreshBillingFilterOptions();
      renderBillingList(window.currentBillingFilter || '');
    }

    // å–æ¶ˆç·¨è¼¯æœå‹™
    function cancelEditService(index) {
      renderServices(tempServices);
      refreshBillingFilterOptions();
      renderBillingList(window.currentBillingFilter || '');
    }

    // åˆªé™¤æœå‹™
    async function deleteService(index, serviceName) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤æœå‹™ã€Œ${serviceName}ã€å—ï¼Ÿ`)) return;
      
      tempServices.splice(index, 1);
      renderServices(tempServices);
      refreshBillingFilterOptions();
      renderBillingList(window.currentBillingFilter || '');
    }

    // é¡¯ç¤ºæ–°å¢æ”¶è²»è¡Œ
  async function showAddBillingRow(serviceIndex) {
      const row = document.getElementById(`add-row-${serviceIndex}`);
      if (!row) return;
      row.style.display = '';
      row.innerHTML = `
        <td colspan="5">
          <div style="padding:12px;border:2px solid #3b82f6;border-radius:8px;background:#f0f9ff;">
            <div style="display:flex;gap:12px;margin-bottom:12px;">
              <label style="display:flex;align-items:center;gap:6px;">
                <input type="radio" name="type-${serviceIndex}" value="monthly" checked> æŒ‰æœˆ
              </label>
              <label style="display:flex;align-items:center;gap:6px;">
                <input type="radio" name="type-${serviceIndex}" value="one-time"> ä¸€æ¬¡æ€§
              </label>
            </div>
            <div id="monthly-form-${serviceIndex}">
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:8px;">
                <div><label>æ¯æœˆé‡‘é¡ *</label><input type="number" id="batch-amount-${serviceIndex}" step="0.01" min="0"></div>
                <div><label>ä»˜æ¬¾æœŸé™ï¼ˆå¤©ï¼‰</label><input type="number" id="batch-due-${serviceIndex}" value="30" min="1"></div>
                <div><label>æœˆä»½ç¯„åœ</label>
                  <select id="batch-range-${serviceIndex}"><option value="all">å…¨å¹´ï¼ˆ1-12æœˆï¼‰</option><option value="custom">è‡ªé¸æœˆä»½</option></select>
                </div>
              </div>
              <div id="month-checkboxes-${serviceIndex}" style="display:none;margin-bottom:8px;">
                ${Array.from({length:12},(_,i)=>`<label style=\"display:inline-flex;align-items:center;gap:6px;margin:4px 8px;\"><input type=\"checkbox\" class=\"month-checkbox-${serviceIndex}\" value=\"${i+1}\" checked> ${i+1}æœˆ</label>`).join('')}
                <div style="margin-top:8px;">
                  <button class="table-btn table-btn-secondary" type="button" onclick="selectAllMonths(${serviceIndex},true)">å…¨é¸</button>
                  <button class="table-btn table-btn-secondary" type="button" onclick="selectAllMonths(${serviceIndex},false)">å…¨ä¸é¸</button>
                </div>
              </div>
            </div>
            <div id="onetime-form-${serviceIndex}" style="display:none;">
              <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:8px;">
                <div><label>é …ç›®åç¨± *</label><input type="text" id="ot-desc-${serviceIndex}"></div>
                <div><label>æ”¶è²»æ—¥æœŸ *</label><input type="date" id="ot-date-${serviceIndex}"></div>
              </div>
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:8px;">
                <div><label>é‡‘é¡ *</label><input type="number" id="ot-amount-${serviceIndex}" step="0.01" min="0"></div>
                <div><label>ä»˜æ¬¾æœŸé™ï¼ˆå¤©ï¼‰</label><input type="number" id="ot-due-${serviceIndex}" value="30" min="1"></div>
                <div><label>å‚™è¨»</label><input type="text" id="ot-notes-${serviceIndex}"></div>
              </div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
              <button class="table-btn table-btn-secondary" type="button" onclick="cancelAddBillingRow(${serviceIndex})">å–æ¶ˆ</button>
              <button class="table-btn table-btn-primary" type="button" onclick="saveNewBillingFromInline(${serviceIndex})">ç¢ºèªæ–°å¢</button>
            </div>
          </div>
        </td>`;
      const rangeSelect = document.getElementById(`batch-range-${serviceIndex}`);
      rangeSelect.addEventListener('change', function(){
        const cb = document.getElementById(`month-checkboxes-${serviceIndex}`);
        cb.style.display = this.value==='custom' ? 'block' : 'none';
      });
      // åˆ‡æ›é¡å‹
      Array.from(document.querySelectorAll(`input[name=type-${serviceIndex}]`)).forEach(r=>{
        r.addEventListener('change', function(){
          document.getElementById(`monthly-form-${serviceIndex}`).style.display = this.value==='monthly' ? 'block' : 'none';
          document.getElementById(`onetime-form-${serviceIndex}`).style.display = this.value==='one-time' ? 'block' : 'none';
        });
      });
    }

    function selectAllMonths(serviceIndex, on) {
      document.querySelectorAll(`.month-checkbox-${serviceIndex}`).forEach(cb => cb.checked = !!on);
    }

    function cancelAddBillingRow(serviceIndex) {
      const row = document.getElementById(`add-row-${serviceIndex}`);
      if (row) { row.innerHTML=''; row.style.display='none'; }
    }

    function saveNewBillingFromInline(serviceIndex) {
      const type = (document.querySelector(`input[name=type-${serviceIndex}]:checked`)||{}).value;
      const svc = tempServices[serviceIndex];
      if (!svc) return;
      svc.billings = svc.billings || [];
      if (type === 'one-time') {
        const desc = document.getElementById(`ot-desc-${serviceIndex}`).value.trim();
        const date = document.getElementById(`ot-date-${serviceIndex}`).value;
        const amount = parseFloat(document.getElementById(`ot-amount-${serviceIndex}`).value);
        const due = parseInt(document.getElementById(`ot-due-${serviceIndex}`).value);
        const notes = document.getElementById(`ot-notes-${serviceIndex}`).value.trim();
        if (!desc || !date || !amount) { alert('è«‹å¡«å¯«å®Œæ•´ä¸€æ¬¡æ€§æ”¶è²»è³‡æ–™'); return; }
        svc.billings.push({ billing_type:'one-time', billing_date:date, description:desc, billing_amount:amount, payment_due_days: due||30, notes: notes||null, billing_month: 0 });
      } else {
        const amount = parseFloat(document.getElementById(`batch-amount-${serviceIndex}`).value);
        const due = parseInt(document.getElementById(`batch-due-${serviceIndex}`).value);
        const range = document.getElementById(`batch-range-${serviceIndex}`).value;
        if (!amount || amount<=0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡'); return; }
        let months = [];
        if (range==='all') months = Array.from({length:12},(_,i)=>i+1); else months = Array.from(document.querySelectorAll(`.month-checkbox-${serviceIndex}:checked`)).map(cb=>parseInt(cb.value));
        if (months.length===0) { alert('è«‹é¸æ“‡æœˆä»½'); return; }
        months.forEach(m => svc.billings.push({ billing_type:'monthly', billing_month:m, billing_amount:amount, payment_due_days: due||30, notes: null }));
      }
      cancelAddBillingRow(serviceIndex);
      document.getElementById(`billing-content-${serviceIndex}`).innerHTML = renderBillingTable(serviceIndex);
    }

    // é–‹å§‹ç·¨è¼¯æ”¶è²»æ˜ç´°
  function startEditBilling(serviceIndex, billingIndex) {
      const container = document.getElementById(`billing-content-${serviceIndex}`);
      const svc = tempServices[serviceIndex];
      if (!container || !svc) return;
      const b = svc.billings[billingIndex];
      const isOT = b.billing_type === 'one-time';
      const rowSelector = `#billing-content-${serviceIndex} tr[data-billing-index="${billingIndex}"]`;
      const row = container.querySelector(rowSelector);
      if (!row) return;
      row.innerHTML = `
        <td>${isOT ? (b.billing_date ? (new Date(b.billing_date).getMonth()+1)+'æœˆ' : '') : (b.billing_month+'æœˆ')}</td>
        <td><input type="number" id="eb-amount-${serviceIndex}-${billingIndex}" value="${b.billing_amount}" step="0.01" min="0" style="width:120px"></td>
        <td><input type="number" id="eb-due-${serviceIndex}-${billingIndex}" value="${b.payment_due_days||30}" min="1" style="width:80px"></td>
        <td>${isOT ? `<input type="text" id="eb-notes-${serviceIndex}-${billingIndex}" value="${(b.description||'') + (b.notes?(' - '+b.notes):'')}" style="width:100%">` : `<input type="text" id="eb-notes-${serviceIndex}-${billingIndex}" value="${b.notes||''}" style="width:100%">`}</td>
        <td>
          <button class="table-btn-link" onclick="saveEditedBilling(${serviceIndex}, ${billingIndex}, ${isOT?1:0})">å„²å­˜</button>
          <button class="table-btn-link" onclick="document.getElementById('billing-content-${serviceIndex}').innerHTML = renderBillingTable(${serviceIndex})">å–æ¶ˆ</button>
        </td>`;
    }

    // å„²å­˜æ”¶è²»æ˜ç´°ï¼ˆæ–°å¢æˆ–ç·¨è¼¯ï¼‰
  function saveEditedBilling(serviceIndex, billingIndex, isOT) {
      const svc = tempServices[serviceIndex];
      if (!svc) return;
      const b = svc.billings[billingIndex];
      const amount = parseFloat(document.getElementById(`eb-amount-${serviceIndex}-${billingIndex}`).value);
      const due = parseInt(document.getElementById(`eb-due-${serviceIndex}-${billingIndex}`).value);
      const notesStr = document.getElementById(`eb-notes-${serviceIndex}-${billingIndex}`).value.trim();
      if (!amount || amount<=0) { alert('é‡‘é¡ç„¡æ•ˆ'); return; }
      b.billing_amount = amount; b.payment_due_days = due||30;
      if (b.billing_type === 'one-time') {
        // å°‡ notesStr ä¸æ‹†åˆ†ï¼Œå„²å­˜åœ¨ notesï¼›æè¿°ç¶­æŒåŸå€¼
        b.notes = notesStr || null;
      } else {
        b.notes = notesStr || null;
      }
      document.getElementById(`billing-content-${serviceIndex}`).innerHTML = renderBillingTable(serviceIndex);
    }

    // å–æ¶ˆç·¨è¼¯æ”¶è²»æ˜ç´°
    async function cancelBillingEdit(clientServiceId, scheduleId) {
      // æ–°å¢é é¢ä¸æ”¯æŒ
    }

    // åˆªé™¤æ”¶è²»æ˜ç´°ï¼ˆå…§åµŒï¼‰
  async function deleteBillingInline(serviceIndex, billingIndex) {
      const svc = tempServices[serviceIndex];
      if (!svc) return;
      svc.billings.splice(billingIndex, 1);
      document.getElementById(`billing-content-${serviceIndex}`).innerHTML = renderBillingTable(serviceIndex);
    }

    // æš´éœ²å‡½æ•¸åˆ°å…¨å±€
    window.showAddBillingRow = showAddBillingRow;
    window.startEditBilling = startEditBilling;
    window.saveNewBillingFromInline = saveNewBillingFromInline;
    window.saveEditedBilling = saveEditedBilling;
    window.cancelAddBillingRow = cancelAddBillingRow;
    window.deleteBillingInline = deleteBillingInline;
    // çµ„æˆéƒ¨åˆ†ï¼ˆä»»å‹™é…ç½®ï¼‰
    window.showAddComponentForm = showAddComponentForm;
    window.toggleMonths = toggleMonths;
    window.cancelComponentForm = cancelComponentForm;
    window.addComponentTask = addComponentTask;
    window.updateTaskField = updateTaskField;
    window.removeComponentTask = removeComponentTask;
    window.saveComponentConfig = saveComponentConfig;
    window.toggleTaskSOP = toggleTaskSOP;
    // é›†ä¸­æ–°å¢æ”¶è²»
    window.showGlobalBillingModal = showGlobalBillingModal;
    window.closeGlobalBillingModal = closeGlobalBillingModal;
    window.gbToggleMonths = gbToggleMonths;
    window.saveGlobalBillingFromModal = saveGlobalBillingFromModal;
    // æ–°å¢/ç·¨è¼¯æœå‹™
    window.showAddServiceRow = showAddServiceRow;
    window.cancelAddService = cancelAddService;
    window.saveNewService = saveNewService;
    window.editService = editService;
    window.saveEditService = saveEditService;
    window.cancelEditService = cancelEditService;
    window.deleteService = deleteService;

    // æ”¶è²»è¨­å®šï¼ˆåˆ—è¡¨ï¼‰å°å‡º
    window.toggleSelectAll = toggleSelectAll;
    window.batchDeleteBilling = batchDeleteBilling;
    window.onMasterSelectChange = onMasterSelectChange;
    window.showAddBillingModal = showAddBillingModal;
    window.editBillingRow = editBillingRow;
    window.deleteBillingRow = deleteBillingRow;
    window.modalSelectAllMonths = modalSelectAllMonths;
    window.switchBillingType = switchBillingType;
    window.saveBillingFromModal = saveBillingFromModal;

    // æ¨™ç±¤ç®¡ç†å°å‡º
    window.showTagsModal = showTagsModal;
    window.closeTagsModal = closeTagsModal;
    window.toggleNewTagForm = toggleNewTagForm;
    window.saveNewTag = saveNewTag;
    window.saveTags = saveTags;


    // å–æ¶ˆç·¨è¼¯
    function cancelEdit() {
      window.location.href = '/internal/clients';
    }
    
    // å„²å­˜å®¢æˆ¶è³‡æ–™
    async function saveClient() {
      clearFormErrors();
      
      const assigneeValue = document.getElementById('inputAssignee').value;
      const assigneeUserId = assigneeValue ? parseInt(assigneeValue) : 0;
      
      const payload = {
        tax_registration_number: document.getElementById('inputTaxId').value.trim() || null,
        company_name: document.getElementById('inputCompanyName').value.trim(),
        assignee_user_id: assigneeUserId,
        phone: document.getElementById('inputPhone').value.trim() || null,
        email: document.getElementById('inputEmail').value.trim() || null,
        contact_person_1: document.getElementById('inputContactPerson1').value.trim() || null,
        contact_person_2: document.getElementById('inputContactPerson2').value.trim() || null,
        client_notes: document.getElementById('inputClientNotes').value.trim() || null,
        payment_notes: document.getElementById('inputPaymentNotes').value.trim() || null,
        tag_ids: Array.from(selectedTagIds)
      };
      
      // é©—è­‰
      let hasError = false;
      if (!payload.company_name) {
        showFieldError('company_name', 'å…¬å¸åç¨±ç‚ºå¿…å¡«');
        hasError = true;
      }
      if (!assigneeUserId || assigneeUserId <= 0) {
        showFieldError('assignee', 'è«‹é¸æ“‡è² è²¬äººå“¡');
        hasError = true;
      }
      
      if (hasError) return;
      
      try {
        console.log('æ–°å¢å®¢æˆ¶è«‹æ±‚æ•¸æ“š:', payload);
        
        const res = await fetch('/internal/api/v1/clients', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        
        const json = await res.json();
        console.log('æ–°å¢å®¢æˆ¶éŸ¿æ‡‰:', json);
        
        if (!res.ok || !json.ok) {
          if (json.errors && Array.isArray(json.errors)) {
            const errorMsg = json.errors.map(e => `${e.field}: ${e.message}`).join('\n');
            alert(`${json.message}\n\n${errorMsg}`);
            json.errors.forEach(err => {
              showFieldError(err.field, err.message);
            });
          } else {
            alert(json.message || 'æ–°å¢å¤±æ•—');
          }
          return;
        }
        
        const newClientId = json.data.client_id;

        // å¦‚æœæœ‰æœå‹™ï¼Œé€ä¸€æ–°å¢
        if (tempServices.length > 0) {
          for (let i = 0; i < tempServices.length; i++) {
            const svc = tempServices[i];
            const resSvc = await fetch(`/internal/api/v1/clients/${newClientId}/services`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                service_id: svc.service_id,
                status: svc.status,
                start_date: svc.start_date || null
              })
            });
        const jsonSvc = await resSvc.json().catch(()=>null);
            const clientServiceId = jsonSvc?.data?.client_service_id;
            if (clientServiceId && Array.isArray(svc.billings)) {
              for (const b of svc.billings) {
                const payload = (b.billing_type === 'one-time') ? {
                  client_service_id: clientServiceId,
                  billing_type: 'one-time',
                  billing_date: b.billing_date,
                  description: b.description,
                  billing_amount: b.billing_amount,
                  payment_due_days: b.payment_due_days,
                  notes: b.notes || null,
                  billing_month: 0
                } : {
                  client_service_id: clientServiceId,
                  billing_type: 'monthly',
                  billing_month: b.billing_month,
                  billing_amount: b.billing_amount,
                  payment_due_days: b.payment_due_days,
                  notes: b.notes || null
                };
                await fetch('/internal/api/v1/billing', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify(payload)
                });
              }
            }

            // è‹¥é¸äº†ä»»å‹™æ¨¡æ¿ï¼šå»ºç«‹æœå‹™çµ„æˆéƒ¨åˆ†ï¼ˆä¾æ¨¡æ¿éšæ®µè‡ªå‹•ç”Ÿæˆä»»å‹™ï¼‰
            if (clientServiceId && svc.task_template_id) {
              try {
                const stagesRes = await fetch(`/internal/api/v1/task-templates/${svc.task_template_id}/stages`, { credentials:'include' });
                const stagesJson = await stagesRes.json().catch(()=>null);
                const stages = Array.isArray(stagesJson?.data) ? stagesJson.data : [];
                const tasks = stages.map((stage, idx) => ({
                  task_name: stage.stage_name,
                  assignee_user_id: null,
                  notes: stage.description || null,
                  due_rule: stage.due_date_rule || 'end_of_month',
                  due_value: stage.due_date_value || null,
                  estimated_hours: stage.estimated_hours || null,
                  advance_days: stage.advance_days || 7,
                  sop_ids: stage.sop_id ? [stage.sop_id] : []
                }));
                if (tasks.length > 0) {
                  await fetch(`/internal/api/v1/client-services/${clientServiceId}/components`, {
                    method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
                    body: JSON.stringify({
                      service_id: svc.service_id,
                      component_name: 'ä»»å‹™é…ç½®',
                      delivery_frequency: 'monthly',
                      task_template_id: svc.task_template_id,
                      auto_generate_task: svc.auto_generate_tasks !== false,
                      advance_days: 7,
                      tasks
                    })
                  });
                }
              } catch (e) {
                console.warn('å»ºç«‹æœå‹™çµ„æˆéƒ¨åˆ†å¤±æ•—ï¼ˆå°‡åœ¨è©³æƒ…é å†è£œï¼‰', e);
              }
            }

            // è‹¥æ‰‹å‹•é…ç½®äº†çµ„æˆéƒ¨åˆ†ï¼Œé€ä¸€å»ºç«‹
            if (clientServiceId && Array.isArray(svc.components) && svc.components.length > 0) {
              for (const comp of svc.components) {
                const payloadComp = {
                  service_id: svc.service_id,
                  service_item_id: comp.service_item_id || null,
                  component_name: comp.component_name || 'ä»»å‹™é…ç½®',
                  delivery_frequency: comp.delivery_frequency || 'monthly',
                  delivery_months: comp.delivery_months || [],
                  task_template_id: svc.task_template_id || null,
                  auto_generate_task: svc.auto_generate_tasks !== false,
                  advance_days: 7,
                  component_sop_ids: comp.component_sop_ids || [],
                  tasks: comp.tasks || []
                };
                await fetch(`/internal/api/v1/client-services/${clientServiceId}/components`, {
                  method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payloadComp)
                });
              }
            }
          }
        }

        // è‹¥é¸æ“‡ç«‹å³ç”¢ç”Ÿä»»å‹™å‰‡å˜—è©¦è§¸ç™¼ï¼ˆéç®¡ç†å“¡æœƒè¢«å¿½ç•¥ï¼‰
        const genNowEl = document.getElementById('generate-now');
        if (genNowEl && genNowEl.checked) {
          try {
            await fetch('/internal/api/v1/admin/tasks/generate-from-components', { method:'POST', credentials:'include' });
          } catch (_) {}
        }

        alert('å®¢æˆ¶æ–°å¢æˆåŠŸï¼');
        window.location.href = `/internal/client-detail?id=${newClientId}`;
        
      } catch (err) {
        console.error('æ–°å¢å¤±æ•—:', err);
        alert('æ–°å¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // é¡¯ç¤ºæ¬„ä½éŒ¯èª¤
    function showFieldError(field, message) {
      const errorEl = document.getElementById(`error_${field}`);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
    }

    // æ¸…é™¤è¡¨å–®éŒ¯èª¤
    function clearFormErrors(formPrefix) {
      document.querySelectorAll('.error-message, .error-text').forEach(el => {
        el.textContent = '';
        el.style.display = 'none';
      });
    }

    // é»æ“ŠModalå¤–éƒ¨é—œé–‰
    window.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });

    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
