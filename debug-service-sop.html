<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœå‹™é …ç›® SOP ç¶å®šèª¿è©¦å·¥å…·</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        button.secondary {
            background: #2196F3;
        }
        button.secondary:hover {
            background: #0b7dda;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            border-left: 4px solid #4CAF50;
        }
        .error {
            color: #f44336;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #f44336;
        }
        .success {
            color: #4CAF50;
            background: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
        .warning {
            color: #ff9800;
            background: #fff3e0;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #ff9800;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f0f0f0;
            font-weight: 600;
        }
        .highlight {
            background: #fff9c4;
            font-weight: bold;
        }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-right: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” æœå‹™é …ç›® SOP ç¶å®šèª¿è©¦å·¥å…·</h1>
    
    <!-- æ­¥é©Ÿ 1: æª¢æŸ¥ç·©å­˜ç‹€æ…‹ -->
    <div class="panel">
        <h2>æ­¥é©Ÿ 1: æª¢æŸ¥ç·©å­˜ç‹€æ…‹</h2>
        <button onclick="checkCache()">æª¢æŸ¥ localStorage ç·©å­˜</button>
        <button class="danger" onclick="clearAllCache()">æ¸…é™¤æ‰€æœ‰ç·©å­˜</button>
        <div id="cacheResult" style="margin-top: 15px;"></div>
    </div>

    <!-- æ­¥é©Ÿ 2: ç›´æ¥æŸ¥è©¢ API -->
    <div class="panel">
        <h2>æ­¥é©Ÿ 2: ç›´æ¥æŸ¥è©¢æœå‹™åˆ—è¡¨ APIï¼ˆç¹éç·©å­˜ï¼‰</h2>
        <button onclick="fetchServicesAPI()">æŸ¥è©¢æœå‹™åˆ—è¡¨</button>
        <button class="secondary" onclick="fetchSingleService()">æŸ¥è©¢å–®å€‹æœå‹™</button>
        <input type="number" id="serviceIdInput" placeholder="è¼¸å…¥æœå‹™ID" style="width: 150px;">
        <div id="apiResult" style="margin-top: 15px;"></div>
    </div>

    <!-- æ­¥é©Ÿ 3: æ¸¬è©¦ä¿å­˜åŠŸèƒ½ -->
    <div class="panel">
        <h2>æ­¥é©Ÿ 3: æ¸¬è©¦ä¿å­˜æœå‹™é …ç›®ï¼ˆç¶å®š SOPï¼‰</h2>
        <div class="test-section">
            <label>é¸æ“‡æœå‹™ï¼š</label>
            <select id="testServiceSelect" onchange="loadServiceData()">
                <option value="">è«‹é¸æ“‡...</option>
            </select>
            <br><br>
            <label>æœå‹™åç¨±ï¼š</label>
            <input type="text" id="testServiceName" style="width: 250px;">
            <br><br>
            <label>ç¶å®š SOPï¼š</label>
            <select id="testSopSelect">
                <option value="">ç„¡</option>
            </select>
            <br><br>
            <button onclick="testSaveService()">ä¿å­˜ä¸¦æ¸¬è©¦</button>
        </div>
        <div id="saveResult" style="margin-top: 15px;"></div>
    </div>

    <!-- æ­¥é©Ÿ 4: æª¢æŸ¥æ•¸æ“šåº« -->
    <div class="panel">
        <h2>æ­¥é©Ÿ 4: é©—è­‰æ•¸æ“šåº«å¯¦éš›å€¼</h2>
        <p>æŸ¥è©¢æ•¸æ“šåº«ä¸­çš„å¯¦éš›æ•¸æ“šï¼ˆç¹éæ‰€æœ‰ç·©å­˜å’Œæ””æˆªå™¨ï¼‰</p>
        <button onclick="verifyDatabase()">é©—è­‰æ•¸æ“šåº«</button>
        <div id="dbResult" style="margin-top: 15px;"></div>
    </div>

    <!-- æ­¥é©Ÿ 5: Fetch æ””æˆªå™¨ç‹€æ…‹ -->
    <div class="panel">
        <h2>æ­¥é©Ÿ 5: Fetch æ””æˆªå™¨è¨ºæ–·</h2>
        <button onclick="checkInterceptor()">æª¢æŸ¥æ””æˆªå™¨ç‹€æ…‹</button>
        <button class="danger" onclick="disableInterceptor()">æš«æ™‚ç¦ç”¨æ””æˆªå™¨</button>
        <div id="interceptorResult" style="margin-top: 15px;"></div>
    </div>

    <script>
        const API_BASE = '/internal/api/v1';
        
        // æ­¥é©Ÿ 1: æª¢æŸ¥ç·©å­˜
        function checkCache() {
            const result = document.getElementById('cacheResult');
            let html = '<h3>localStorage ç·©å­˜å…§å®¹ï¼š</h3>';
            
            const cacheKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('cache') || key.includes('horgos')) {
                    cacheKeys.push(key);
                }
            }
            
            if (cacheKeys.length === 0) {
                html += '<p class="success">âœ… æ²’æœ‰ç™¼ç¾ç›¸é—œç·©å­˜</p>';
            } else {
                html += `<p class="warning">âš ï¸ ç™¼ç¾ ${cacheKeys.length} å€‹ç·©å­˜é …ï¼š</p>`;
                html += '<table><tr><th>ç·©å­˜éµ</th><th>å…§å®¹æ‘˜è¦</th><th>æ“ä½œ</th></tr>';
                cacheKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    let summary = 'ç„¡æ³•è§£æ';
                    try {
                        const data = JSON.parse(value);
                        summary = `æ™‚é–“: ${new Date(data.timestamp).toLocaleString()}<br>`;
                        summary += `æ•¸æ“šé …: ${data.data?.length || 'æœªçŸ¥'}`;
                    } catch (e) {
                        summary = value.substring(0, 100);
                    }
                    html += `<tr>
                        <td><code>${key}</code></td>
                        <td>${summary}</td>
                        <td><button onclick="localStorage.removeItem('${key}'); checkCache();">åˆªé™¤</button></td>
                    </tr>`;
                });
                html += '</table>';
            }
            
            result.innerHTML = html;
        }
        
        function clearAllCache() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç·©å­˜å—ï¼Ÿ')) return;
            
            // æ¸…é™¤ localStorage
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('cache') || key.includes('horgos'))) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            // æ¸…é™¤ DataCache
            if (window.DataCache) {
                window.DataCache.clearAll();
            }
            
            alert(`å·²æ¸…é™¤ ${keysToRemove.length} å€‹ç·©å­˜é …`);
            checkCache();
        }
        
        // æ­¥é©Ÿ 2: æŸ¥è©¢ API
        async function fetchServicesAPI() {
            const result = document.getElementById('apiResult');
            result.innerHTML = '<p>æŸ¥è©¢ä¸­...</p>';
            
            try {
                const timestamp = Date.now();
                const url = `${API_BASE}/services?_t=${timestamp}&_nocache=1`;
                console.log('ğŸ” è«‹æ±‚ URL:', url);
                
                const response = await fetch(url, {
                    credentials: 'include',
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                console.log('ğŸ“¥ éŸ¿æ‡‰ç‹€æ…‹:', response.status);
                console.log('ğŸ“¥ éŸ¿æ‡‰é ­:', [...response.headers.entries()]);
                
                const json = await response.json();
                console.log('ğŸ“¥ éŸ¿æ‡‰æ•¸æ“š:', json);
                
                let html = '<h3>API éŸ¿æ‡‰çµæœï¼š</h3>';
                
                if (json.ok && json.data) {
                    html += `<p class="success">âœ… æˆåŠŸç²å– ${json.data.length} å€‹æœå‹™é …ç›®</p>`;
                    html += '<table><tr><th>ID</th><th>æœå‹™åç¨±</th><th>Service SOP ID</th><th>ç‹€æ…‹</th></tr>';
                    
                    json.data.forEach(service => {
                        const sopStatus = service.service_sop_id 
                            ? `<span class="highlight">âœ… ${service.service_sop_id}</span>` 
                            : 'âŒ null';
                        
                        html += `<tr>
                            <td>${service.service_id}</td>
                            <td>${service.service_name}</td>
                            <td>${sopStatus}</td>
                            <td>${service.is_active ? 'å•Ÿç”¨' : 'åœç”¨'}</td>
                        </tr>`;
                    });
                    html += '</table>';
                    
                    // æ›´æ–°ä¸‹æ‹‰é¸å–®
                    updateServiceSelect(json.data);
                } else {
                    html += `<p class="error">âŒ API éŒ¯èª¤: ${json.message || 'æœªçŸ¥éŒ¯èª¤'}</p>`;
                }
                
                html += '<h4>å®Œæ•´éŸ¿æ‡‰ï¼š</h4><pre>' + JSON.stringify(json, null, 2) + '</pre>';
                result.innerHTML = html;
                
            } catch (error) {
                console.error('âŒ éŒ¯èª¤:', error);
                result.innerHTML = `<p class="error">âŒ è«‹æ±‚å¤±æ•—: ${error.message}</p>`;
            }
        }
        
        async function fetchSingleService() {
            const serviceId = document.getElementById('serviceIdInput').value;
            if (!serviceId) {
                alert('è«‹è¼¸å…¥æœå‹™ID');
                return;
            }
            
            const result = document.getElementById('apiResult');
            result.innerHTML = '<p>æŸ¥è©¢ä¸­...</p>';
            
            try {
                const timestamp = Date.now();
                const response = await fetch(`${API_BASE}/services/${serviceId}?_t=${timestamp}`, {
                    credentials: 'include',
                    cache: 'no-cache'
                });
                
                const json = await response.json();
                console.log('ğŸ“¥ å–®å€‹æœå‹™éŸ¿æ‡‰:', json);
                
                let html = '<h3>å–®å€‹æœå‹™è©³æƒ…ï¼š</h3>';
                
                if (json.ok && json.data) {
                    const s = json.data;
                    html += '<table>';
                    html += `<tr><th>å­—æ®µ</th><th>å€¼</th></tr>`;
                    html += `<tr><td>service_id</td><td>${s.service_id}</td></tr>`;
                    html += `<tr><td>service_name</td><td>${s.service_name}</td></tr>`;
                    html += `<tr><td class="highlight">service_sop_id</td><td class="highlight">${s.service_sop_id || 'null'}</td></tr>`;
                    html += `<tr><td>service_code</td><td>${s.service_code || 'null'}</td></tr>`;
                    html += `<tr><td>is_active</td><td>${s.is_active}</td></tr>`;
                    html += `<tr><td>created_at</td><td>${s.created_at}</td></tr>`;
                    html += `<tr><td>updated_at</td><td>${s.updated_at}</td></tr>`;
                    html += '</table>';
                } else {
                    html += `<p class="error">âŒ ${json.message || 'æœå‹™ä¸å­˜åœ¨'}</p>`;
                }
                
                html += '<h4>å®Œæ•´éŸ¿æ‡‰ï¼š</h4><pre>' + JSON.stringify(json, null, 2) + '</pre>';
                result.innerHTML = html;
                
            } catch (error) {
                result.innerHTML = `<p class="error">âŒ è«‹æ±‚å¤±æ•—: ${error.message}</p>`;
            }
        }
        
        // æ­¥é©Ÿ 3: æ¸¬è©¦ä¿å­˜
        async function loadServiceData() {
            const serviceId = document.getElementById('testServiceSelect').value;
            if (!serviceId) return;
            
            try {
                const response = await fetch(`${API_BASE}/services/${serviceId}?_t=${Date.now()}`, {
                    credentials: 'include',
                    cache: 'no-cache'
                });
                const json = await response.json();
                
                if (json.ok && json.data) {
                    document.getElementById('testServiceName').value = json.data.service_name;
                    document.getElementById('testSopSelect').value = json.data.service_sop_id || '';
                }
            } catch (error) {
                console.error('è¼‰å…¥æœå‹™æ•¸æ“šå¤±æ•—:', error);
            }
        }
        
        async function testSaveService() {
            const serviceId = document.getElementById('testServiceSelect').value;
            const serviceName = document.getElementById('testServiceName').value;
            const sopId = document.getElementById('testSopSelect').value;
            
            if (!serviceId || !serviceName) {
                alert('è«‹é¸æ“‡æœå‹™ä¸¦å¡«å¯«åç¨±');
                return;
            }
            
            const result = document.getElementById('saveResult');
            result.innerHTML = '<p>ä¿å­˜ä¸­...</p>';
            
            let html = '<h3>ä¿å­˜æ¸¬è©¦æµç¨‹ï¼š</h3>';
            
            try {
                // 1. ä¿å­˜
                html += '<p>ğŸ“ æ­¥é©Ÿ 1: ç™¼é€ PUT è«‹æ±‚...</p>';
                const saveResponse = await fetch(`${API_BASE}/services/${serviceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        service_name: serviceName,
                        service_sop_id: sopId ? parseInt(sopId) : null
                    })
                });
                
                const saveJson = await saveResponse.json();
                console.log('ğŸ’¾ ä¿å­˜éŸ¿æ‡‰:', saveJson);
                
                if (saveJson.ok) {
                    html += '<p class="success">âœ… ä¿å­˜æˆåŠŸ</p>';
                } else {
                    html += `<p class="error">âŒ ä¿å­˜å¤±æ•—: ${saveJson.message}</p>`;
                    result.innerHTML = html;
                    return;
                }
                
                // 2. ç­‰å¾…ä¸€ä¸‹
                html += '<p>â³ æ­¥é©Ÿ 2: ç­‰å¾… 500ms...</p>';
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 3. æ¸…é™¤ç·©å­˜
                html += '<p>ğŸ—‘ï¸ æ­¥é©Ÿ 3: æ¸…é™¤ç·©å­˜...</p>';
                if (window.DataCache) {
                    window.DataCache.clearCache('services_types');
                    window.DataCache.clearCache('services');
                }
                
                // 4. é‡æ–°æŸ¥è©¢
                html += '<p>ğŸ” æ­¥é©Ÿ 4: é‡æ–°æŸ¥è©¢æœå‹™...</p>';
                const verifyResponse = await fetch(`${API_BASE}/services/${serviceId}?_t=${Date.now()}`, {
                    credentials: 'include',
                    cache: 'no-cache'
                });
                
                const verifyJson = await verifyResponse.json();
                console.log('âœ… é©—è­‰éŸ¿æ‡‰:', verifyJson);
                
                if (verifyJson.ok && verifyJson.data) {
                    const actualSopId = verifyJson.data.service_sop_id;
                    const expectedSopId = sopId ? parseInt(sopId) : null;
                    
                    if (actualSopId === expectedSopId) {
                        html += `<p class="success">âœ… é©—è­‰æˆåŠŸï¼service_sop_id = ${actualSopId}</p>`;
                    } else {
                        html += `<p class="error">âŒ é©—è­‰å¤±æ•—ï¼é æœŸ: ${expectedSopId}, å¯¦éš›: ${actualSopId}</p>`;
                    }
                    
                    html += '<h4>é©—è­‰æ•¸æ“šï¼š</h4><pre>' + JSON.stringify(verifyJson.data, null, 2) + '</pre>';
                } else {
                    html += `<p class="error">âŒ é©—è­‰å¤±æ•—: ${verifyJson.message}</p>`;
                }
                
                result.innerHTML = html;
                
            } catch (error) {
                html += `<p class="error">âŒ éŒ¯èª¤: ${error.message}</p>`;
                result.innerHTML = html;
            }
        }
        
        // æ­¥é©Ÿ 4: é©—è­‰æ•¸æ“šåº«
        async function verifyDatabase() {
            const result = document.getElementById('dbResult');
            result.innerHTML = '<p>æŸ¥è©¢ä¸­...</p>';
            
            try {
                // ä½¿ç”¨è¶…é•·çš„æ™‚é–“æˆ³å’Œç‰¹æ®Šæ¨™è¨˜ï¼Œç¢ºä¿å®Œå…¨ç¹éç·©å­˜
                const timestamp = Date.now();
                const randomStr = Math.random().toString(36).substring(7);
                const url = `${API_BASE}/services?_t=${timestamp}&_nocache=${randomStr}&_force=1`;
                
                const response = await fetch(url, {
                    credentials: 'include',
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                const json = await response.json();
                
                let html = '<h3>æ•¸æ“šåº«å¯¦éš›æ•¸æ“šï¼š</h3>';
                
                if (json.ok && json.data) {
                    html += `<p class="success">âœ… æŸ¥è©¢æˆåŠŸï¼Œå…± ${json.data.length} æ¢è¨˜éŒ„</p>`;
                    
                    // çµ±è¨ˆ
                    const withSOP = json.data.filter(s => s.service_sop_id).length;
                    const withoutSOP = json.data.filter(s => !s.service_sop_id).length;
                    
                    html += `<p>ğŸ“Š çµ±è¨ˆï¼š${withSOP} å€‹å·²ç¶å®š SOPï¼Œ${withoutSOP} å€‹æœªç¶å®š</p>`;
                    
                    html += '<table><tr><th>ID</th><th>æœå‹™åç¨±</th><th>service_sop_id</th><th>æ›´æ–°æ™‚é–“</th></tr>';
                    json.data.forEach(s => {
                        const sopCell = s.service_sop_id 
                            ? `<span class="highlight">âœ… ${s.service_sop_id}</span>`
                            : '<span style="color:#999">null</span>';
                        
                        html += `<tr>
                            <td>${s.service_id}</td>
                            <td>${s.service_name}</td>
                            <td>${sopCell}</td>
                            <td>${s.updated_at || s.created_at || '-'}</td>
                        </tr>`;
                    });
                    html += '</table>';
                } else {
                    html += `<p class="error">âŒ æŸ¥è©¢å¤±æ•—: ${json.message}</p>`;
                }
                
                result.innerHTML = html;
                
            } catch (error) {
                result.innerHTML = `<p class="error">âŒ éŒ¯èª¤: ${error.message}</p>`;
            }
        }
        
        // æ­¥é©Ÿ 5: Fetch æ””æˆªå™¨
        function checkInterceptor() {
            const result = document.getElementById('interceptorResult');
            
            let html = '<h3>Fetch æ””æˆªå™¨ç‹€æ…‹ï¼š</h3>';
            
            if (window.__DISABLE_FETCH_INTERCEPTOR__) {
                html += '<p class="success">âœ… æ””æˆªå™¨å·²ç¦ç”¨</p>';
            } else {
                html += '<p class="warning">âš ï¸ æ””æˆªå™¨å•Ÿç”¨ä¸­ï¼ˆå¯èƒ½å½±éŸ¿çµæœï¼‰</p>';
            }
            
            if (window.DataCache) {
                html += '<p>âœ… DataCache æ¨¡å¡Šå·²åŠ è¼‰</p>';
                const status = window.DataCache.getPreloadStatus?.();
                if (status) {
                    html += `<p>é åŠ è¼‰ç‹€æ…‹: ${status.isPreloading ? 'é€²è¡Œä¸­' : 'é–’ç½®'}</p>`;
                    html += `<p>å·²å®Œæˆ: ${status.completed?.length || 0} é …</p>`;
                }
            } else {
                html += '<p class="error">âŒ DataCache æ¨¡å¡ŠæœªåŠ è¼‰</p>';
            }
            
            result.innerHTML = html;
        }
        
        function disableInterceptor() {
            window.__DISABLE_FETCH_INTERCEPTOR__ = true;
            alert('âœ… å·²ç¦ç”¨ Fetch æ””æˆªå™¨ï¼Œè«‹åˆ·æ–°é é¢ä½¿å…¶ç”Ÿæ•ˆ');
        }
        
        // æ›´æ–°ä¸‹æ‹‰é¸å–®
        function updateServiceSelect(services) {
            const select = document.getElementById('testServiceSelect');
            select.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
            services.forEach(s => {
                select.innerHTML += `<option value="${s.service_id}">${s.service_name} (ID: ${s.service_id})</option>`;
            });
        }
        
        // åŠ è¼‰ SOP é¸é …
        async function loadSOPOptions() {
            try {
                const response = await fetch(`${API_BASE}/sop?scope=service&_t=${Date.now()}`, {
                    credentials: 'include'
                });
                const json = await response.json();
                
                if (json.ok && json.data) {
                    const select = document.getElementById('testSopSelect');
                    select.innerHTML = '<option value="">ç„¡</option>';
                    json.data.forEach(sop => {
                        select.innerHTML += `<option value="${sop.sop_id}">${sop.title} (ID: ${sop.sop_id})</option>`;
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥ SOP å¤±æ•—:', error);
            }
        }
        
        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            console.log('ğŸ”§ èª¿è©¦å·¥å…·å·²å°±ç·’');
            loadSOPOptions();
        });
    </script>
</body>
</html>



