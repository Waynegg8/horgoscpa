<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>è³‡æºç®¡ç†ï½œCMS</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    
    <style>
      * { box-sizing: border-box; }
      body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif; background: #f5f7fa; }
      
      .top-toolbar { background: white; border-bottom: 2px solid #e5e7eb; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
      .top-toolbar-left { display: flex; gap: 12px; align-items: center; }
      .top-toolbar-right { display: flex; gap: 12px; }
      
      .btn { padding: 10px 20px; border: 2px solid #e0e0e0; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 6px; }
      .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
      .btn.primary { background: linear-gradient(135deg, #2c5f7c 0%, #1e4a63 100%); color: white; border-color: #2c5f7c; }
      
      .container { max-width: 800px; margin: 40px auto; padding: 0 24px; }
      
      .card { background: white; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); padding: 32px; }
      .card h2 { margin: 0 0 24px 0; color: #2c5f7c; font-size: 24px; display: flex; align-items: center; gap: 8px; }
      
      .form-group { margin-bottom: 20px; }
      .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #374151; font-size: 14px; }
      .form-group input[type="text"], .form-group select, .form-group textarea { width: 100%; padding: 12px 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s; }
      .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #2c5f7c; box-shadow: 0 0 0 3px rgba(44, 95, 124, 0.1); }
      .form-group textarea { resize: vertical; min-height: 80px; font-family: inherit; }
      
      .file-upload-area { border: 3px dashed #cbd5e1; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); }
      .file-upload-area:hover { border-color: #2c5f7c; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); }
      .file-upload-area.dragover { border-color: #2c5f7c; background: #dbeafe; transform: scale(1.02); }
      .file-upload-icon { font-size: 48px; margin-bottom: 12px; }
      .file-info { margin-top: 20px; padding: 16px; background: #f3f4f6; border-radius: 8px; display: none; }
      .file-info.show { display: block; }
      
      .image-upload-area { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; background: #f8fafc; }
      .image-upload-area:hover { border-color: #2c5f7c; background: #f0f9ff; }
      .image-preview { margin-top: 12px; max-width: 200px; border-radius: 8px; overflow: hidden; }
      .image-preview img { max-width: 100%; height: auto; display: block; }
      
      .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      
      .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }
      .loading-spinner { background: white; padding: 32px 48px; border-radius: 12px; text-align: center; }
      .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #2c5f7c; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
  </head>
  <body>
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
      <div class="loading-spinner"><div class="spinner"></div><div>ä¸Šå‚³ä¸­...</div></div>
    </div>
    
    <div class="top-toolbar">
      <div class="top-toolbar-left">
        <button class="btn" onclick="goBack()">â† è¿”å›åˆ—è¡¨</button>
      </div>
      <div class="top-toolbar-right">
        <button class="btn primary" id="btnSave">ğŸ’¾ ä¿å­˜è³‡æº</button>
      </div>
    </div>
    
    <div class="container">
      <div class="card">
        <h2>ğŸ“„ ä¸Šå‚³è³‡æºæ–‡ä»¶</h2>
        
        <!-- æ–‡ä»¶ä¸Šä¼  -->
        <div class="form-group">
          <label>é¸æ“‡æ–‡ä»¶ *</label>
          <div class="file-upload-area" id="fileUploadArea">
            <div class="file-upload-icon">ğŸ“</div>
            <div style="font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 8px;">é»æ“Šä¸Šå‚³æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°é€™è£¡</div>
            <div style="font-size: 14px; color: #6b7280;">æ”¯æ´ PDFã€Excelã€Wordã€ZIPã€åœ–ç‰‡ç­‰æ ¼å¼</div>
            <div style="font-size: 13px; color: #9ca3af; margin-top: 4px;">æœ€å¤§ 10MB</div>
            <input type="file" id="fileInput" style="display: none;">
          </div>
          <div class="file-info" id="fileInfo">
            <div style="font-weight: 600; margin-bottom: 4px;" id="fileName"></div>
            <div style="font-size: 13px; color: #6b7280;">
              é¡å‹ï¼š<span id="fileType"></span> | 
              å¤§å°ï¼š<span id="fileSize"></span>
            </div>
          </div>
        </div>
        
        <hr style="border: none; border-top: 2px solid #f0f0f0; margin: 32px 0;">
        
        <!-- èµ„æºä¿¡æ¯ -->
        <div class="form-group">
          <label for="resourceTitle">è³‡æºæ¨™é¡Œ *</label>
          <input type="text" id="resourceTitle" placeholder="è¼¸å…¥è³‡æºæ¨™é¡Œ..." maxlength="100" required>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="resourceCategory">åˆ†é¡</label>
            <select id="resourceCategory">
              <option value="">é¸æ“‡åˆ†é¡</option>
              <option value="è¡¨å–®ä¸‹è¼‰">è¡¨å–®ä¸‹è¼‰</option>
              <option value="ç¯„æœ¬æ–‡ä»¶">ç¯„æœ¬æ–‡ä»¶</option>
              <option value="èªªæ˜æ‰‹å†Š">èªªæ˜æ‰‹å†Š</option>
              <option value="æ³•è¦æ–‡ä»¶">æ³•è¦æ–‡ä»¶</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
          <div class="form-group">
            <label>ç‹€æ…‹</label>
            <select id="resourceStatus">
              <option value="published">å·²ç™¼å¸ƒ</option>
              <option value="draft">è‰ç¨¿</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="resourceDescription">ç°¡ä»‹</label>
          <textarea id="resourceDescription" placeholder="ç°¡çŸ­æè¿°æ­¤è³‡æº..."></textarea>
        </div>
        
        <!-- å°é¢å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰ -->
        <div class="form-group">
          <label>å°é¢åœ–ç‰‡ï¼ˆå¯é¸ï¼‰</label>
          <div class="image-upload-area" id="imageUploadArea">
            <div>ğŸ–¼ï¸ é»æ“Šä¸Šå‚³å°é¢åœ–ç‰‡</div>
            <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">å»ºè­°å°ºå¯¸ï¼š400x300px</div>
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
          </div>
          <div class="image-preview" id="imagePreview" style="display: none;"></div>
        </div>
      </div>
    </div>
    
    <script>
      const onProdHost = location.hostname.endsWith('horgoscpa.com');
      const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
      
      let uploadedFile = null;
      let fileUrl = '';
      let coverImageUrl = '';
      let currentResourceId = null;
      
      const urlParams = new URLSearchParams(window.location.search);
      currentResourceId = urlParams.get('id');
      
      document.addEventListener('DOMContentLoaded', async () => {
        await checkAuth();
        initFileUpload();
        initImageUpload();
        
        if (currentResourceId) {
          loadResource(currentResourceId);
        }
        
        document.getElementById('btnSave').addEventListener('click', saveResource);
      });
      
      async function checkAuth() {
        try {
          const res = await fetch(`${apiBase}/auth/me`, { credentials: 'include' });
          if (res.status === 401) {
            location.assign('/login?redirect=' + encodeURIComponent(location.pathname + location.search));
            return;
          }
          const json = await res.json();
          if (!json?.ok || !json?.data?.isAdmin) {
            alert('æ‚¨æ²’æœ‰æ¬Šé™å­˜å–æ­¤é é¢');
            location.assign('/internal/cms');
          }
        } catch (err) {
          alert('èªè­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥');
          location.assign('/login');
        }
      }
      
      function initFileUpload() {
        const uploadArea = document.getElementById('fileUploadArea');
        const input = document.getElementById('fileInput');
        
        uploadArea.addEventListener('click', () => input.click());
        
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
          uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadArea.classList.remove('dragover');
          const file = e.dataTransfer.files[0];
          if (file) handleFileUpload(file);
        });
        
        input.addEventListener('change', () => {
          const file = input.files[0];
          if (file) handleFileUpload(file);
        });
      }
      
      function handleFileUpload(file) {
        if (file.size > 10 * 1024 * 1024) {
          alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…é 10MB');
          return;
        }
        
        uploadedFile = file;
        
        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileType').textContent = file.type || 'æœªçŸ¥';
        document.getElementById('fileSize').textContent = formatBytes(file.size);
        document.getElementById('fileInfo').classList.add('show');
        
        // è‡ªåŠ¨å¡«å……æ ‡é¢˜ï¼ˆå¦‚æœä¸ºç©ºï¼‰
        const titleInput = document.getElementById('resourceTitle');
        if (!titleInput.value) {
          titleInput.value = file.name.replace(/\.[^/.]+$/, '');
        }
        
        // è½¬æ¢ä¸º Base64ï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰
        const reader = new FileReader();
        reader.onload = (e) => {
          fileUrl = e.target.result;
        };
        reader.readAsDataURL(file);
      }
      
      function initImageUpload() {
        const uploadArea = document.getElementById('imageUploadArea');
        const input = document.getElementById('imageInput');
        const preview = document.getElementById('imagePreview');
        
        uploadArea.addEventListener('click', () => input.click());
        
        input.addEventListener('change', () => {
          const file = input.files[0];
          if (file) handleImageUpload(file);
        });
      }
      
      function handleImageUpload(file) {
        if (file.size > 5 * 1024 * 1024) {
          alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          coverImageUrl = e.target.result;
          const preview = document.getElementById('imagePreview');
          preview.innerHTML = `<img src="${coverImageUrl}" alt="å°é¢">`;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
      
      async function loadResource(id) {
        try {
          showLoading();
          const res = await fetch(`${apiBase}/admin/resources/${id}`, { credentials: 'include' });
          if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
          
          const json = await res.json();
          if (!json.ok) throw new Error(json.message || 'è¼‰å…¥å¤±æ•—');
          
          const resource = json.data;
          document.getElementById('resourceTitle').value = resource.title || '';
          document.getElementById('resourceCategory').value = resource.category || '';
          document.getElementById('resourceDescription').value = resource.description || '';
          document.getElementById('resourceStatus').value = resource.isPublished ? 'published' : 'draft';
          
          fileUrl = resource.fileUrl;
          
          // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          if (resource.fileUrl) {
            document.getElementById('fileName').textContent = resource.title || 'å·²ä¸Šå‚³æ–‡ä»¶';
            document.getElementById('fileType').textContent = resource.fileType || 'æœªçŸ¥';
            document.getElementById('fileSize').textContent = formatBytes(resource.fileSize || 0);
            document.getElementById('fileInfo').classList.add('show');
          }
          
          if (resource.coverImage) {
            coverImageUrl = resource.coverImage;
            document.getElementById('imagePreview').innerHTML = `<img src="${coverImageUrl}">`;
            document.getElementById('imagePreview').style.display = 'block';
          }
        } catch (err) {
          alert('è¼‰å…¥è³‡æºå¤±æ•—ï¼š' + err.message);
          console.error(err);
        } finally {
          hideLoading();
        }
      }
      
      async function saveResource() {
        const title = document.getElementById('resourceTitle').value.trim();
        if (!title) {
          alert('è«‹è¼¸å…¥è³‡æºæ¨™é¡Œ');
          return;
        }
        
        if (!fileUrl && !currentResourceId) {
          alert('è«‹ä¸Šå‚³æ–‡ä»¶');
          return;
        }
        
        const fileType = uploadedFile ? uploadedFile.type : '';
        const fileSize = uploadedFile ? uploadedFile.size : 0;
        
        const data = {
          title,
          description: document.getElementById('resourceDescription').value.trim(),
          fileUrl,
          fileType,
          fileSize,
          category: document.getElementById('resourceCategory').value,
          coverImage: coverImageUrl,
          isPublished: document.getElementById('resourceStatus').value === 'published'
        };
        
        try {
          showLoading();
          const url = currentResourceId 
            ? `${apiBase}/admin/resources/${currentResourceId}` 
            : `${apiBase}/admin/resources`;
          const method = currentResourceId ? 'PUT' : 'POST';
          
          const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
          });
          
          const json = await res.json();
          if (!res.ok || !json.ok) {
            throw new Error(json.message || 'ä¿å­˜å¤±æ•—');
          }
          
          alert('è³‡æºå·²ä¿å­˜ï¼');
          location.assign('/internal/cms');
        } catch (err) {
          alert('ä¿å­˜å¤±æ•—ï¼š' + err.message);
          console.error(err);
        } finally {
          hideLoading();
        }
      }
      
      function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }
      
      function goBack() {
        if (confirm('ç¢ºå®šè¦é›¢é–‹ï¼Ÿæœªä¿å­˜çš„å…§å®¹å°‡æœƒä¸Ÿå¤±ã€‚')) {
          location.assign('/internal/cms');
        }
      }
      
      function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
      }
      
      function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
      }
    </script>
  </body>
</html>

