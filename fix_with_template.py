#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
ä½¿ç”¨contact.htmlä½œç‚ºæ¨¡æ¿ä¿®å¾©å°èˆªæ¬„ (ä¿®å¾©ç‰ˆ)

æ­¤è…³æœ¬æœƒ:
1. ä½¿ç”¨æä¾›çš„contact.htmlä½œç‚ºæ¨¡æ¿
2. æå–å…¶ä¸­çš„å°èˆªæ¬„HTMLèˆ‡æ¨£å¼
3. å°‡é€™äº›å…ƒç´ æ‡‰ç”¨åˆ°æ‰€æœ‰å…¶ä»–HTMLæ–‡ä»¶ä¸­

ä½¿ç”¨æ–¹æ³•:
python fix_with_template.py <template_file> [project_directory]

åƒæ•¸:
- template_file: æ¨¡æ¿æ–‡ä»¶è·¯å¾‘ (contact.html)
- project_directory: é …ç›®ç›®éŒ„ (å¯é¸ï¼Œé»˜èªç‚ºç•¶å‰ç›®éŒ„)
"""

import os
import sys
import re
import shutil
from pathlib import Path
import html

def extract_template_parts(template_path):
    """å¾æ¨¡æ¿ä¸­æå–å°èˆªæ¬„ã€CSSæ¨£å¼å’ŒJSä»£ç¢¼"""
    
    try:
        with open(template_path, 'r', encoding='utf-8') as f:
            template_content = f.read()
    except Exception as e:
        print(f"âŒ ç„¡æ³•è®€å–æ¨¡æ¿æ–‡ä»¶: {str(e)}")
        sys.exit(1)
    
    # æå–å°èˆªæ¬„æ¨£å¼
    nav_style_pattern = r'<!-- å°èˆªæ¬„ä¿®æ­£æ¨£å¼ -->\s*<style>(.*?)</style>'
    nav_style_match = re.search(nav_style_pattern, template_content, re.DOTALL)
    nav_style = nav_style_match.group(1).strip() if nav_style_match else ""
    
    # æå–å°èˆªæ¬„HTML
    navbar_pattern = r'<!-- å°èˆªæ¬„ -->\s*<nav class="site-nav">(.*?)</nav>'
    navbar_match = re.search(navbar_pattern, template_content, re.DOTALL)
    navbar = navbar_match.group(0).strip() if navbar_match else ""
    
    # æå–JavaScript
    js_pattern = r'<!-- ä¸‹æ‹‰é¸å–®èˆ‡ç‡Ÿæ¥­æ™‚é–“ JavaScript -->\s*<script>(.*?)</script>'
    js_match = re.search(js_pattern, template_content, re.DOTALL)
    js_code = js_match.group(1).strip() if js_match else ""
    
    return {
        "nav_style": nav_style,
        "navbar_html": navbar,
        "navbar_js": js_code
    }

def find_html_files(project_dir, exclude_files=None):
    """æ‰¾åˆ°é …ç›®ä¸­æ‰€æœ‰HTMLæ–‡ä»¶ï¼Œæ’é™¤ç‰¹å®šæ–‡ä»¶"""
    if exclude_files is None:
        exclude_files = []
    
    exclude_files = [os.path.abspath(f) for f in exclude_files]
    
    html_files = []
    for root, _, files in os.walk(project_dir):
        for file in files:
            if file.endswith('.html'):
                full_path = os.path.abspath(os.path.join(root, file))
                if full_path not in exclude_files:
                    html_files.append(full_path)
    return html_files

def fix_html_file(html_file, template_parts):
    """ä½¿ç”¨æ¨¡æ¿éƒ¨åˆ†ä¿®å¾©HTMLæ–‡ä»¶"""
    try:
        with open(html_file, 'r', encoding='utf-8') as f:
            content = f.read()
    except Exception as e:
        print(f"âŒ ç„¡æ³•è®€å– {html_file}: {str(e)}")
        return False
    
    # å‰µå»ºä¿®å¾©å‰çš„å‚™ä»½
    backup_file = html_file + '.template-fix.bak'
    try:
        with open(backup_file, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"  âœ“ å‰µå»ºå‚™ä»½: {backup_file}")
    except Exception as e:
        print(f"  âš ï¸ ç„¡æ³•å‰µå»ºå‚™ä»½: {str(e)}")
    
    # æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰å°èˆªæ¬„æ¨£å¼
    nav_style_pattern = r'<!-- å°èˆªæ¬„ä¿®æ­£æ¨£å¼ -->\s*<style>(.*?)</style>'
    has_nav_style = re.search(nav_style_pattern, content, re.DOTALL)
    
    # æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰ç›¸åŒçš„å°èˆªæ¬„
    if template_parts["navbar_html"] in content and has_nav_style:
        print(f"  âœ“ æ–‡ä»¶å·²åŒ…å«æ­£ç¢ºçš„å°èˆªæ¬„ï¼Œç„¡éœ€ä¿®æ”¹")
        return True
    
    # æ›¿æ›æˆ–æ·»åŠ å°èˆªæ¬„æ¨£å¼
    if has_nav_style:
        content = re.sub(
            nav_style_pattern,
            f'<!-- å°èˆªæ¬„ä¿®æ­£æ¨£å¼ -->\n<style>{template_parts["nav_style"]}</style>',
            content,
            flags=re.DOTALL
        )
    else:
        # åœ¨</head>å‰æ·»åŠ æ¨£å¼
        head_end_pattern = r'</head>'
        if re.search(head_end_pattern, content):
            content = re.sub(
                head_end_pattern,
                f'<!-- å°èˆªæ¬„ä¿®æ­£æ¨£å¼ -->\n<style>{template_parts["nav_style"]}</style>\n</head>',
                content
            )
    
    # æ›¿æ›å°èˆªæ¬„
    patterns = [
        r'<!-- å°èˆªæ¬„.*?</nav>\s*',
        r'<nav class="site-nav">.*?</nav>\s*',
        r'<!--\s*#include virtual="/includes/navbar\.html"\s*-->',
        r'<div id="navbar-container"></div>'
    ]
    
    replaced = False
    for pattern in patterns:
        if re.search(pattern, content, re.DOTALL):
            content = re.sub(pattern, template_parts["navbar_html"], content, flags=re.DOTALL, count=1)
            replaced = True
            break
    
    # å¦‚æœæ‰¾ä¸åˆ°å°èˆªæ¬„ï¼Œå‰‡åœ¨<body>æ¨™ç±¤å¾Œæ’å…¥
    if not replaced:
        body_pattern = r'<body.*?>'
        if re.search(body_pattern, content):
            content = re.sub(body_pattern, lambda m: m.group(0) + '\n' + template_parts["navbar_html"], content)
            replaced = True
        else:
            print(f"  âŒ åœ¨ {html_file} ä¸­æ‰¾ä¸åˆ°åˆé©çš„ä½ç½®æ’å…¥å°èˆªæ¬„")
            return False
    
    # æ›¿æ›æˆ–æ·»åŠ JavaScript
    js_pattern = r'<!-- ä¸‹æ‹‰é¸å–®èˆ‡ç‡Ÿæ¥­æ™‚é–“ JavaScript -->\s*<script>.*?</script>'
    end_body_pattern = r'</body>'
    
    if re.search(js_pattern, content, re.DOTALL):
        content = re.sub(
            js_pattern,
            f'<!-- ä¸‹æ‹‰é¸å–®èˆ‡ç‡Ÿæ¥­æ™‚é–“ JavaScript -->\n<script>{template_parts["navbar_js"]}</script>',
            content,
            flags=re.DOTALL
        )
    elif re.search(end_body_pattern, content):
        # æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰ä¸‹æ‹‰é¸å–®çš„JSä»£ç¢¼
        has_dropdown_js = "dropdownLinks.forEach" in content
        if not has_dropdown_js:
            js_block = f'''<!-- ä¸‹æ‹‰é¸å–®èˆ‡ç‡Ÿæ¥­æ™‚é–“ JavaScript -->
<script>{template_parts["navbar_js"]}</script>
</body>'''
            content = content.replace('</body>', js_block)
    
    # ä¿®å¾©ï¼šç§»é™¤æ‰€æœ‰ç¾æœ‰çš„activeé¡ (ä¿®æ­£æ­£å‰‡è¡¨é”å¼)
    content = re.sub(r'(<li><a href="[^"]*) class="active"', r'\1', content)
    
    # ç‚ºç•¶å‰é é¢æ·»åŠ activeé¡
    current_page = os.path.basename(html_file)
    
    # è™•ç†ä¸åŒé é¢çš„activeç‹€æ…‹
    if 'index.html' in html_file:
        content = content.replace('<a href="/index.html">', '<a href="/index.html" class="active">')
    elif 'services.html' in html_file and 'services/' not in html_file:
        content = content.replace('<a href="/services.html">', '<a href="/services.html" class="active">')
    elif 'services/tax.html' in html_file:
        content = content.replace('<a href="/services/tax.html">', '<a href="/services/tax.html" class="active">')
    elif 'services/accounting.html' in html_file:
        content = content.replace('<a href="/services/accounting.html">', '<a href="/services/accounting.html" class="active">')
    elif 'services/consulting.html' in html_file:
        content = content.replace('<a href="/services/consulting.html">', '<a href="/services/consulting.html" class="active">')
    elif 'team.html' in html_file:
        content = content.replace('<a href="/team.html">', '<a href="/team.html" class="active">')
    elif 'blog.html' in html_file:
        content = content.replace('<a href="/blog.html">', '<a href="/blog.html" class="active">')
    elif 'faq.html' in html_file:
        content = content.replace('<a href="/faq.html">', '<a href="/faq.html" class="active">')
    elif 'video.html' in html_file:
        content = content.replace('<a href="/video.html">', '<a href="/video.html" class="active">')
    elif 'contact.html' in html_file:
        content = content.replace('<a href="/contact.html">', '<a href="/contact.html" class="active">')
    elif 'booking.html' in html_file:
        content = content.replace('<a href="/booking.html">', '<a href="/booking.html" class="active">')
    
    # å¯«å›æ–‡ä»¶
    try:
        with open(html_file, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"  âœ… æˆåŠŸä¿®å¾©")
        return True
    except Exception as e:
        print(f"  âŒ å¯«å…¥å¤±æ•—: {str(e)}")
        return False

def main():
    """ä¸»å‡½æ•¸"""
    if len(sys.argv) < 2:
        print("âŒ è«‹æä¾›æ¨¡æ¿æ–‡ä»¶è·¯å¾‘")
        print("ä½¿ç”¨æ–¹æ³•: python fix_with_template.py <template_file> [project_directory]")
        sys.exit(1)
    
    template_path = sys.argv[1]
    
    if not os.path.exists(template_path) or not os.path.isfile(template_path):
        print(f"âŒ æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨: {template_path}")
        sys.exit(1)
    
    # ç²å–é …ç›®ç›®éŒ„
    if len(sys.argv) > 2:
        project_dir = sys.argv[2]
    else:
        project_dir = os.getcwd()
    
    print(f"ğŸ” ä½¿ç”¨æ¨¡æ¿æ–‡ä»¶: {template_path}")
    print(f"ğŸ” ä½¿ç”¨é …ç›®ç›®éŒ„: {project_dir}")
    
    # æå–æ¨¡æ¿éƒ¨åˆ†
    template_parts = extract_template_parts(template_path)
    
    if not template_parts["navbar_html"]:
        print("âŒ ç„¡æ³•å¾æ¨¡æ¿ä¸­æå–å°èˆªæ¬„HTML")
        sys.exit(1)
    
    # æ‰¾åˆ°æ‰€æœ‰HTMLæ–‡ä»¶ï¼Œæ’é™¤æ¨¡æ¿æ–‡ä»¶
    html_files = find_html_files(project_dir, [template_path])
    print(f"ğŸ” æ‰¾åˆ° {len(html_files)} å€‹HTMLæ–‡ä»¶éœ€è¦ä¿®å¾©")
    
    # ç¢ºèªæ˜¯å¦ç¹¼çºŒ
    if len(html_files) > 0:
        confirm = input(f"ç¢ºèªä½¿ç”¨æ¨¡æ¿ä¿®å¾© {len(html_files)} å€‹HTMLæ–‡ä»¶? (y/n): ")
        if confirm.lower() != 'y':
            print("âŒ æ“ä½œå–æ¶ˆ")
            sys.exit(0)
    else:
        print("âŒ æœªæ‰¾åˆ°éœ€è¦ä¿®å¾©çš„HTMLæ–‡ä»¶")
        sys.exit(1)
    
    # è™•ç†æ¯å€‹HTMLæ–‡ä»¶
    success_count = 0
    for html_file in html_files:
        print(f"\nğŸ”„ è™•ç†: {html_file}")
        if fix_html_file(html_file, template_parts):
            success_count += 1
    
    # å®Œæˆæç¤º
    print("\nâœ… ä¿®å¾©å®Œæˆ!")
    print(f"âœ… æˆåŠŸä¿®å¾©äº† {success_count}/{len(html_files)} å€‹HTMLæ–‡ä»¶")
    print(f"âœ… æ¯å€‹æ–‡ä»¶éƒ½å‰µå»ºäº†å‚™ä»½ (.template-fix.bak)")
    
    print("\nğŸ“‹ å¾ŒçºŒæ­¥é©Ÿ:")
    print("1. æª¢æŸ¥ç¶²ç«™çš„å°èˆªæ¬„æ˜¯å¦æ­£ç¢ºé¡¯ç¤º")
    print("2. å¦‚æœæœ‰å•é¡Œï¼Œå¯ä»¥é€šéå‚™ä»½æ–‡ä»¶é‚„åŸ: .template-fix.bak")
    print("3. è«‹ç¢ºèªstyle.cssæ–‡ä»¶è·¯å¾‘æ­£ç¢ºï¼Œå…§å®¹å®Œæ•´")

if __name__ == "__main__":
    main()