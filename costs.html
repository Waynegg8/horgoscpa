<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="管理成本" />
    <title>管理成本｜設定與分析</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/costs-page.css" />
    
    <!-- ⚡ 预加载与缓存系统 -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <script src="/assets/js/prerender.js"></script>
    <script src="/assets/js/page-prerender.js"></script>
    <script src="/assets/js/tab-cache.js"></script>
  </head>
  <body class="costs-page">
    <div style="padding:16px 20px;">
      <div id="infoBar" class="info-bar" style="display:none;" role="alert">您沒有權限存取此模組</div>
      <div class="costs-toolbar" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
        <div class="toolbar-spacer" style="flex:1;"></div>
        <button id="btn-export-csv" type="button" class="btn" disabled>匯出 CSV</button>
        <button id="btn-export-pdf" type="button" class="btn" disabled>匯出 PDF</button>
      </div>
      <nav class="costs-tabs" role="tablist" aria-label="管理成本分頁" style="display:flex;gap:8px;border-bottom:2px solid #e5e7eb;">
        <button class="tab active" role="tab" aria-selected="true" data-tab="items">成本項目設定</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="employee">員工成本分析</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="client">客戶任務成本</button>
      </nav>
    </div>

    <main class="costs-content">
      <!-- 成本項目設定 -->
      <section id="panel-items" class="panel show" role="tabpanel" aria-labelledby="tab-items">
        <div class="card">
          <div class="section-toolbar">
            <div class="toolbar-spacer"></div>
            <button id="btn-add-item" type="button" class="btn primary" disabled>新增項目</button>
          </div>
          <table class="table" aria-label="成本項目列表">
            <thead>
              <tr>
                <th>成本名稱</th>
                <th>類別</th>
                <th>分攤方式</th>
                <th>描述</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="tbody-items">
              <tr><td colspan="6" class="muted">尚無資料</td></tr>
            </tbody>
          </table>
        </div>
        
        <div class="card" style="margin-top: 16px;">
          <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">月度管理費用記錄</h3>
          <div class="section-toolbar">
            <label for="month">月份</label>
            <input id="month" type="month" aria-label="月份" />
            <div class="toolbar-spacer"></div>
            <button id="btn-generate-month" type="button" class="btn" disabled>本月自動生成</button>
            <button id="btn-add-record" type="button" class="btn primary" disabled>新增記錄</button>
          </div>
          <div class="stats-cards">
            <div class="stat">
              <div class="stat-label">本月總管理費用</div>
              <div class="stat-value" id="stat-total">—</div>
              <div class="stat-meta muted" id="stat-breakdown">固定：—｜變動：—</div>
            </div>
          </div>
          <table class="table" aria-label="月度管理費用記錄">
            <thead>
              <tr>
                <th>項目名稱</th>
                <th>金額</th>
                <th>備註</th>
                <th>錄入人</th>
                <th>錄入時間</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="tbody-records">
              <tr><td colspan="6" class="muted">尚無資料</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- 員工成本分析 -->
      <section id="panel-employee" class="panel" role="tabpanel" aria-labelledby="tab-employee">
        <div class="card">
          <div class="section-toolbar">
            <div class="toolbar-spacer"></div>
            <button type="button" class="btn" id="btn-refresh-emp" disabled>刷新</button>
          </div>
          <div class="info-box" style="margin-bottom: 12px; padding: 10px 12px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; font-size: 14px; color: #1e40af;">
            <strong>計算說明：</strong><br>
            • <strong>月工時基準</strong> = (2080小時 - 特休時數) ÷ 12個月<br>
            • <strong>員工時薪</strong> = 月薪 ÷ 月工時基準<br>
            • <strong>加權工時</strong> = 考慮加班費倍率的等效工時<br>
            &nbsp;&nbsp;- 平日加班：實際工時 × 倍率（1.34或1.67）<br>
            &nbsp;&nbsp;- <span style="color:#dc2626;">國定假日/例假日（8小時內）：16.0加權工時（含加班費8小時+強制補休8小時）</span><br>
            • <strong>薪資成本</strong> = 員工時薪 × 加權工時 + 補休到期轉加班費<br>
            • <strong>總成本</strong> = 薪資成本 + 分攤管理費用
          </div>
          <table class="table" aria-label="員工成本列表">
            <thead>
              <tr>
                <th>姓名</th>
                <th>月薪</th>
                <th>月工時基準</th>
                <th>員工時薪</th>
                <th>本月工時</th>
                <th>加權工時</th>
                <th>工時成本</th>
                <th>補休轉加班費</th>
                <th>薪資小計</th>
                <th>分攤管理費</th>
                <th>本月總成本</th>
              </tr>
            </thead>
            <tbody id="tbody-employee">
              <tr><td colspan="11" class="muted">載入中…</td></tr>
            </tbody>
          </table>
          <div class="summary-row" style="margin-top: 12px; padding: 12px; background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; font-weight: 600;">
              <span>本月總計：</span>
              <span id="emp-total-cost">—</span>
            </div>
          </div>
        </div>
      </section>

      <!-- 客戶任務成本 -->
      <section id="panel-client" class="panel" role="tabpanel" aria-labelledby="tab-client">
        <div class="card">
          <div class="section-toolbar">
            <select id="viewType">
              <option value="client">按客戶彙總</option>
              <option value="task">按任務明細</option>
            </select>
            <div class="toolbar-spacer"></div>
            <button type="button" class="btn" id="btn-refresh-client" disabled>刷新</button>
          </div>
          
          <div id="client-view">
            <table class="table" aria-label="客戶成本彙總">
              <thead>
                <tr>
                  <th>客戶名稱</th>
                  <th>任務數</th>
                  <th>總工時</th>
                  <th>加權工時</th>
                  <th>人力成本</th>
                  <th>分攤管理費</th>
                  <th>總成本</th>
                  <th>本月收入</th>
                  <th>利潤</th>
                  <th>利潤率</th>
                </tr>
              </thead>
              <tbody id="tbody-clients">
                <tr><td colspan="10" class="muted">載入中…</td></tr>
              </tbody>
            </table>
          </div>

          <div id="task-view" style="display: none;">
            <table class="table" aria-label="任務成本明細">
              <thead>
                <tr>
                  <th>客戶名稱</th>
                  <th>任務標題</th>
                  <th>負責人</th>
                  <th>工時</th>
                  <th>加權工時</th>
                  <th>人力成本</th>
                  <th>分攤管理費</th>
                  <th>總成本</th>
                </tr>
              </thead>
              <tbody id="tbody-tasks">
                <tr><td colspan="8" class="muted">載入中…</td></tr>
              </tbody>
            </table>
          </div>

          <div class="summary-row" style="margin-top: 12px; padding: 12px; background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
              <div>
                <div style="font-size: 12px; color: #64748b;">總成本</div>
                <div style="font-size: 18px; font-weight: 600;" id="client-total-cost">—</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #64748b;">總收入</div>
                <div style="font-size: 18px; font-weight: 600;" id="client-total-revenue">—</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #64748b;">總利潤</div>
                <div style="font-size: 18px; font-weight: 600;" id="client-total-profit">—</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #64748b;">平均利潤率</div>
                <div style="font-size: 18px; font-weight: 600;" id="client-avg-margin">—</div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const infoBar = document.getElementById('infoBar');
        const tabs = Array.from(document.querySelectorAll('.costs-tabs .tab'));
        const panels = {
          items: document.getElementById('panel-items'),
          employee: document.getElementById('panel-employee'),
          client: document.getElementById('panel-client'),
        };

        const monthInput = document.getElementById('month');

        // 成本項目設定
        const tbodyItems = document.getElementById('tbody-items');

        // 月度管理費用記錄
        const tbodyRecords = document.getElementById('tbody-records');
        const statTotal = document.getElementById('stat-total');
        const statBreakdown = document.getElementById('stat-breakdown');

        // 員工成本分析
        const tbodyEmployee = document.getElementById('tbody-employee');
        const empTotalCost = document.getElementById('emp-total-cost');

        // 客戶任務成本
        const viewType = document.getElementById('viewType');
        const clientView = document.getElementById('client-view');
        const taskView = document.getElementById('task-view');
        const tbodyClients = document.getElementById('tbody-clients');
        const tbodyTasks = document.getElementById('tbody-tasks');

        function setTabsEnabled(enabled){
          tabs.forEach(b=>{ b.disabled = !enabled; });
          document.querySelectorAll('.costs-toolbar .btn, .section-toolbar input, .section-toolbar select, .section-toolbar button').forEach(el=>{ el.disabled = !enabled; });
        }

        // ⚡ Tab 缓存系统初始化
        let currentCostsTab = 'items';
        if (window.TabCache) {
          window.TabCache.init(['items', 'employee', 'client']);
        }

        tabs.forEach(btn => {
          btn.addEventListener('click', ()=>{
            const key = btn.getAttribute('data-tab');
            
            // ⚡ 检查是否需要加载（使用缓存）
            const shouldLoad = window.TabCache ? window.TabCache.shouldLoad(currentCostsTab, key) : true;
            currentCostsTab = key;
            
            tabs.forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            Object.entries(panels).forEach(([k,el])=>{
              if (k === key) el.classList.add('show'); else el.classList.remove('show');
            });
            
            // ⚡ 只在需要时载入对应资料
            if (shouldLoad) {
              if (key === 'employee') loadEmployeeCosts();
              if (key === 'client') loadClientCosts();
              
              // ⚡ 标记为已加载
              if (window.TabCache) {
                window.TabCache.markLoaded(key);
              }
            }
          });
        });

        function parseYearMonth(){
          const v = String(monthInput.value || '');
          const m = v.match(/^(\d{4})-(\d{2})$/);
          if (!m) return null;
          const year = parseInt(m[1], 10);
          const month = parseInt(m[2], 10);
          if (!Number.isFinite(year) || !Number.isFinite(month) || month < 1 || month > 12) return null;
          return { year, month };
        }

        function formatCurrency(val){
          return 'NT$ ' + Number(val || 0).toLocaleString();
        }

        // ============ 成本項目設定 ============
        async function loadItems(){
          const params = new URLSearchParams();
          try {
            tbodyItems.innerHTML = '<tr><td colspan="6" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/admin/overhead-types?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const items = json.data || [];
            if (items.length === 0) {
              tbodyItems.innerHTML = '<tr><td colspan="6" class="muted">尚無資料</td></tr>';
              return;
            }
            tbodyItems.innerHTML = '';
            items.forEach(item => {
              const tr = document.createElement('tr');
              const allocationText = { per_employee: '按員工數', per_hour: '按工時', per_revenue: '按收入' }[item.allocationMethod] || item.allocationMethod;
              tr.innerHTML = `
                <td>${item.name||''}</td>
                <td>${item.category === 'fixed' ? '固定' : '變動'}</td>
                <td>${allocationText}</td>
                <td>${item.description||''}</td>
                <td>${item.isActive ? '啟用' : '停用'}</td>
                <td><button class="btn-link" data-edit-id="${item.id}">編輯</button></td>
              `;
              tbodyItems.appendChild(tr);
            });
            // 綁定編輯：設定每月自動生成模板
            tbodyItems.querySelectorAll('button[data-edit-id]').forEach(btn => {
              btn.addEventListener('click', ()=> openEditTemplateModal(parseInt(btn.getAttribute('data-edit-id'),10)) );
            });
          } catch (_) {
            tbodyItems.innerHTML = '<tr><td colspan="6" style="color:#c0392b;">載入失敗</td></tr>';
          }
        }
        async function openEditTemplateModal(costTypeId){
          // 讀目前模板（若需要可擴充：目前直接新建/覆蓋）
          const form = document.createElement('div');
          const enableChk = document.createElement('input'); enableChk.type='checkbox'; enableChk.id='tplEnable'; enableChk.checked = true;
          const enableLbl = document.createElement('label'); enableLbl.htmlFor='tplEnable'; enableLbl.textContent='啟用每月自動生成'; enableLbl.style.marginLeft='6px';
          const enWrap = document.createElement('div'); enWrap.appendChild(enableChk); enWrap.appendChild(enableLbl); enWrap.style.marginBottom='8px';
          const amountInput = document.createElement('input'); amountInput.type='number'; amountInput.placeholder='預設金額'; amountInput.min='1';
          const effInput = document.createElement('input'); effInput.type='month';
          form.appendChild(enWrap);
          form.appendChild(buildField('預設金額', amountInput));
          form.appendChild(buildField('生效起始月', effInput));
          openModal('自動生成設定', form, async (close)=>{
            const is_active = enableChk.checked;
            const amount = Number(amountInput.value||0);
            const efv = String(effInput.value||'');
            const body = { is_active };
            if (amount>0) body.amount = amount;
            if (/^\d{4}-\d{2}$/.test(efv)) body.effective_from = efv;
            const res = await fetch(`${apiBase}/admin/overhead-templates/by-type/${costTypeId}`, { method:'PUT', credentials:'include', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
            const json = await res.json().catch(()=>({}));
            if (!res.ok || !json || json.ok !== true) { alert(json?.message||'儲存失敗'); return; }
            close();
            alert('已儲存');
          });
        }

        async function loadRecords(){
          const ym = parseYearMonth();
          if (!ym) return;
          const params = new URLSearchParams();
          params.set('year', String(ym.year));
          params.set('month', String(ym.month));
          try {
            tbodyRecords.innerHTML = '<tr><td colspan="6" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/admin/overhead-costs?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || {};
            const items = data.items || [];
            if (items.length === 0) {
              tbodyRecords.innerHTML = '<tr><td colspan="6" class="muted">尚無資料</td></tr>';
            } else {
              tbodyRecords.innerHTML = '';
              items.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${r.costName||''}</td>
                  <td>${formatCurrency(r.amount)}</td>
                  <td>${r.notes||''}</td>
                  <td>${r.recordedBy||''}</td>
                  <td>${r.recordedAt||''}</td>
                  <td><button class="btn-link" disabled>編輯</button></td>
                `;
                tbodyRecords.appendChild(tr);
              });
            }
            const total = Number(data.total||0);
            const totalFixed = Number(data.totalFixed||0);
            const totalVariable = Number(data.totalVariable||0);
            statTotal.textContent = formatCurrency(total);
            statBreakdown.textContent = `固定：${formatCurrency(totalFixed)}｜變動：${formatCurrency(totalVariable)}`;
          } catch (_) {
            tbodyRecords.innerHTML = '<tr><td colspan="6" style="color:#c0392b;">載入失敗</td></tr>';
            statTotal.textContent = '—';
            statBreakdown.textContent = '固定：—｜變動：—';
          }
        }

        // ============ 員工成本分析 ============
        async function loadEmployeeCosts(){
          const ym = parseYearMonth();
          if (!ym) return;
          const params = new URLSearchParams();
          params.set('year', String(ym.year));
          params.set('month', String(ym.month));
          try {
            tbodyEmployee.innerHTML = '<tr><td colspan="11" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/admin/costs/employee?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            if (res.status === 501) {
              tbodyEmployee.innerHTML = '<tr><td colspan="11" class="muted">功能尚未實作，敬請期待</td></tr>';
              empTotalCost.textContent = '—';
              return;
            }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || {};
            const employees = data.employees || [];
            if (employees.length === 0) {
              tbodyEmployee.innerHTML = '<tr><td colspan="11" class="muted">尚無資料</td></tr>';
              empTotalCost.textContent = formatCurrency(0);
              return;
            }
            tbodyEmployee.innerHTML = '';
            let totalCost = 0;
            employees.forEach(emp => {
              const tr = document.createElement('tr');
              const annualSalary = Number(emp.annualSalary || 0);
              const annualHours = Number(emp.annualHours || 0);
              const annualLeaveHours = Number(emp.annualLeaveHours || 0);
              const actualHours = annualHours - annualLeaveHours;
              
              // 用月薪和月工時基準計算時薪（更直觀）
              const monthlySalary = annualSalary / 12;
              const monthlyBaseHours = actualHours / 12;
              const hourlyRate = monthlyBaseHours > 0 ? monthlySalary / monthlyBaseHours : 0;
              
              const monthHours = Number(emp.monthHours || 0);
              const weightedHours = Number(emp.weightedHours || 0);
              const laborCost = Number(emp.laborCost || 0);
              const expiredCompCost = Number(emp.expiredCompCost || 0);
              const overheadAllocation = Number(emp.overheadAllocation || 0);
              const empTotalCost = laborCost + overheadAllocation;
              const workTimeCost = laborCost - expiredCompCost;
              totalCost += empTotalCost;
              tr.innerHTML = `
                <td>${emp.name||''}</td>
                <td>${formatCurrency(monthlySalary)}</td>
                <td>${monthlyBaseHours.toFixed(1)} hrs</td>
                <td style="font-weight:600;">${formatCurrency(hourlyRate)}</td>
                <td>${monthHours.toFixed(1)}</td>
                <td style="font-weight:600;color:#0ea5e9;">${weightedHours.toFixed(1)}</td>
                <td>${formatCurrency(workTimeCost)}</td>
                <td style="color:#dc2626;">${formatCurrency(expiredCompCost)}</td>
                <td style="font-weight:600;">${formatCurrency(laborCost)}</td>
                <td>${formatCurrency(overheadAllocation)}</td>
                <td style="font-weight:600;color:#16a34a;">${formatCurrency(empTotalCost)}</td>
              `;
              tbodyEmployee.appendChild(tr);
            });
            empTotalCost.textContent = formatCurrency(totalCost);
          } catch (err) {
            tbodyEmployee.innerHTML = '<tr><td colspan="11" style="color:#c0392b;">載入失敗</td></tr>';
            empTotalCost.textContent = '—';
          }
        }

        // ============ 客戶任務成本 ============
        async function loadClientCosts(){
          const view = viewType.value;
          if (view === 'client') {
            clientView.style.display = 'block';
            taskView.style.display = 'none';
            await loadClientSummary();
          } else {
            clientView.style.display = 'none';
            taskView.style.display = 'block';
            await loadTaskDetails();
          }
        }

        async function loadClientSummary(){
          const ym = parseYearMonth();
          if (!ym) return;
          const params = new URLSearchParams();
          params.set('year', String(ym.year));
          params.set('month', String(ym.month));
          try {
            tbodyClients.innerHTML = '<tr><td colspan="10" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/admin/costs/client?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            if (res.status === 501) {
              tbodyClients.innerHTML = '<tr><td colspan="10" class="muted">功能尚未實作，敬請期待</td></tr>';
              return;
            }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || {};
            const clients = data.clients || [];
            if (clients.length === 0) {
              tbodyClients.innerHTML = '<tr><td colspan="10" class="muted">尚無資料</td></tr>';
              updateClientSummary(0, 0, 0, 0);
              return;
            }
            tbodyClients.innerHTML = '';
            let totalCost = 0, totalRevenue = 0, totalProfit = 0;
            clients.forEach(client => {
              const tr = document.createElement('tr');
              const cost = Number(client.totalCost || 0);
              const revenue = Number(client.revenue || 0);
              const profit = revenue - cost;
              const margin = revenue > 0 ? (profit / revenue * 100) : 0;
              totalCost += cost;
              totalRevenue += revenue;
              totalProfit += profit;
              tr.innerHTML = `
                <td>${client.clientName||''}</td>
                <td>${client.taskCount||0}</td>
                <td>${Number(client.totalHours||0).toFixed(1)}</td>
                <td>${Number(client.weightedHours||0).toFixed(1)}</td>
                <td>${formatCurrency(client.laborCost)}</td>
                <td>${formatCurrency(client.overheadAllocation)}</td>
                <td>${formatCurrency(cost)}</td>
                <td>${formatCurrency(revenue)}</td>
                <td style="color:${profit >= 0 ? '#16a34a' : '#dc2626'};">${formatCurrency(profit)}</td>
                <td>${margin.toFixed(1)}%</td>
              `;
              tbodyClients.appendChild(tr);
            });
            const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0;
            updateClientSummary(totalCost, totalRevenue, totalProfit, avgMargin);
          } catch (_) {
            tbodyClients.innerHTML = '<tr><td colspan="10" style="color:#c0392b;">載入失敗</td></tr>';
          }
        }

        async function loadTaskDetails(){
          const ym = parseYearMonth();
          if (!ym) return;
          const params = new URLSearchParams();
          params.set('year', String(ym.year));
          params.set('month', String(ym.month));
          try {
            tbodyTasks.innerHTML = '<tr><td colspan="8" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/admin/costs/task?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            if (res.status === 501) {
              tbodyTasks.innerHTML = '<tr><td colspan="8" class="muted">功能尚未實作，敬請期待</td></tr>';
              return;
            }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || {};
            const tasks = data.tasks || [];
            if (tasks.length === 0) {
              tbodyTasks.innerHTML = '<tr><td colspan="8" class="muted">尚無資料</td></tr>';
              return;
            }
            tbodyTasks.innerHTML = '';
            tasks.forEach(task => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${task.clientName||''}</td>
                <td>${task.taskTitle||''}</td>
                <td>${task.assigneeName||''}</td>
                <td>${Number(task.hours||0).toFixed(1)}</td>
                <td>${Number(task.weightedHours||0).toFixed(1)}</td>
                <td>${formatCurrency(task.laborCost)}</td>
                <td>${formatCurrency(task.overheadAllocation)}</td>
                <td>${formatCurrency(task.totalCost)}</td>
              `;
              tbodyTasks.appendChild(tr);
            });
          } catch (_) {
            tbodyTasks.innerHTML = '<tr><td colspan="8" style="color:#c0392b;">載入失敗</td></tr>';
          }
        }

        function updateClientSummary(cost, revenue, profit, margin){
          document.getElementById('client-total-cost').textContent = formatCurrency(cost);
          document.getElementById('client-total-revenue').textContent = formatCurrency(revenue);
          document.getElementById('client-total-profit').textContent = formatCurrency(profit);
          document.getElementById('client-avg-margin').textContent = margin.toFixed(1) + '%';
        }

        async function ensureAdmin(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return false; }
            const json = await res.json();
            const isAdmin = !!(json && json.ok && json.data && json.data.isAdmin);
            if (!isAdmin) {
              infoBar.style.display = 'block';
              setTabsEnabled(false);
              return false;
            }
            setTabsEnabled(true);
            return true;
          } catch (_) {
            infoBar.textContent = '載入失敗，請稍後再試';
            infoBar.style.display = 'block';
            setTabsEnabled(false);
            return false;
          }
        }

        // 預設月份為本月
        const now = new Date();
        monthInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

        // 事件
        let searchTimer = null;
        viewType.addEventListener('change', loadClientCosts);
        monthInput.addEventListener('change', ()=>{ 
          loadItems(); 
          loadRecords(); 
          if (currentCostsTab === 'employee') loadEmployeeCosts();
          if (currentCostsTab === 'client') loadClientCosts();
        });

        document.getElementById('btn-refresh-emp')?.addEventListener('click', loadEmployeeCosts);
        document.getElementById('btn-refresh-client')?.addEventListener('click', loadClientCosts);

        // ============ 新增/匯出功能（改用表單與下拉選單） ============
        function openModal(title, contentEl, onSubmit){
          const overlay = document.createElement('div');
          overlay.style.position = 'fixed';
          overlay.style.inset = '0';
          overlay.style.background = 'rgba(0,0,0,0.3)';
          overlay.style.display = 'flex';
          overlay.style.alignItems = 'center';
          overlay.style.justifyContent = 'center';
          overlay.style.zIndex = '1000';
          const modal = document.createElement('div');
          modal.style.background = '#fff';
          modal.style.border = '1px solid #e5e7eb';
          modal.style.borderRadius = '10px';
          modal.style.boxShadow = '0 10px 30px rgba(0,0,0,0.15)';
          modal.style.width = 'min(520px, 92vw)';
          modal.style.maxHeight = '85vh';
          modal.style.display = 'flex';
          modal.style.flexDirection = 'column';
          const header = document.createElement('div');
          header.style.padding = '14px 16px';
          header.style.borderBottom = '1px solid #eee';
          header.style.fontWeight = '600';
          header.textContent = title;
          const body = document.createElement('div');
          body.style.padding = '14px 16px';
          body.appendChild(contentEl);
          const footer = document.createElement('div');
          footer.style.display = 'flex';
          footer.style.gap = '8px';
          footer.style.justifyContent = 'flex-end';
          footer.style.padding = '12px 16px';
          footer.style.borderTop = '1px solid #eee';
          const btnCancel = document.createElement('button');
          btnCancel.className = 'btn';
          btnCancel.textContent = '取消';
          const btnOk = document.createElement('button');
          btnOk.className = 'btn primary';
          btnOk.textContent = '儲存';
          footer.appendChild(btnCancel); footer.appendChild(btnOk);
          modal.appendChild(header); modal.appendChild(body); modal.appendChild(footer);
          overlay.appendChild(modal);
          function close(){ document.body.removeChild(overlay); }
          btnCancel.addEventListener('click', close);
          btnOk.addEventListener('click', async ()=>{ await onSubmit?.(close); });
          document.body.appendChild(overlay);
        }

        function buildField(labelText, inputEl){
          const wrap = document.createElement('div');
          wrap.style.marginBottom = '10px';
          const label = document.createElement('label');
          label.style.display = 'block';
          label.style.fontSize = '12px';
          label.style.color = '#64748b';
          label.style.marginBottom = '6px';
          label.textContent = labelText;
          inputEl.style.width = '100%';
          inputEl.style.boxSizing = 'border-box';
          inputEl.style.padding = '8px 10px';
          inputEl.style.border = '1px solid #e5e7eb';
          inputEl.style.borderRadius = '8px';
          wrap.appendChild(label); wrap.appendChild(inputEl);
          return wrap;
        }

        function openAddTypeModal(){
          const form = document.createElement('div');
          const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.placeholder = '例如：辦公室租金';
          const catSel = document.createElement('select'); catSel.innerHTML = '<option value="fixed">固定</option><option value="variable">變動</option>';
          const allocSel = document.createElement('select'); allocSel.innerHTML = '<option value="per_employee">按員工數</option><option value="per_hour">按工時</option><option value="per_revenue">按收入</option>';
          const descInput = document.createElement('input'); descInput.type = 'text'; descInput.placeholder = '描述（可留空）';
          
          // 自動生成設定
          const divider = document.createElement('div'); 
          divider.style.borderTop = '1px solid #e5e7eb'; 
          divider.style.margin = '16px 0 12px 0';
          const sectionTitle = document.createElement('div');
          sectionTitle.style.fontSize = '14px';
          sectionTitle.style.fontWeight = '600';
          sectionTitle.style.marginBottom = '12px';
          sectionTitle.style.color = '#374151';
          sectionTitle.textContent = '自動生成設定';
          const enableChk = document.createElement('input'); enableChk.type='checkbox'; enableChk.id='tplEnableNew';
          const enableLbl = document.createElement('label'); enableLbl.htmlFor='tplEnableNew'; enableLbl.textContent='啟用每月自動生成'; enableLbl.style.marginLeft='6px';
          const enWrap = document.createElement('div'); enWrap.appendChild(enableChk); enWrap.appendChild(enableLbl); enWrap.style.marginBottom='8px';
          const amountInput = document.createElement('input'); amountInput.type='number'; amountInput.placeholder='預設金額'; amountInput.min='1';
          const effInput = document.createElement('input'); effInput.type='month';
          
          form.appendChild(buildField('成本名稱', nameInput));
          form.appendChild(buildField('類別', catSel));
          form.appendChild(buildField('分攤方式', allocSel));
          form.appendChild(buildField('描述', descInput));
          form.appendChild(divider);
          form.appendChild(sectionTitle);
          form.appendChild(enWrap);
          form.appendChild(buildField('預設金額', amountInput));
          form.appendChild(buildField('生效起始月', effInput));
          
          openModal('新增成本項目', form, async (close)=>{
            const name = nameInput.value.trim();
            const category = catSel.value;
            const allocationMethod = allocSel.value;
            const description = descInput.value.trim();
            if (!name) { alert('請輸入成本名稱'); return; }
            const res = await fetch(`${apiBase}/admin/overhead-types`, {
              method: 'POST', credentials: 'include', headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ cost_name: name, category, allocation_method: allocationMethod, description })
            });
            const json = await res.json().catch(()=>({}));
            if (!res.ok || !json || json.ok !== true) { alert(json?.message||'建立失敗'); return; }
            
            // 若勾選自動生成，建立模板
            const costTypeId = json.data?.id;
            if (enableChk.checked && costTypeId) {
              const is_active = true;
              const amount = Number(amountInput.value||0);
              const efv = String(effInput.value||'');
              const tplBody = { is_active };
              if (amount>0) tplBody.amount = amount;
              if (/^\d{4}-\d{2}$/.test(efv)) tplBody.effective_from = efv;
              try {
                await fetch(`${apiBase}/admin/overhead-templates/by-type/${costTypeId}`, { 
                  method:'PUT', 
                  credentials:'include', 
                  headers:{'content-type':'application/json'}, 
                  body: JSON.stringify(tplBody) 
                });
              } catch (_) {}
            }
            
            close();
            if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
            loadItems();
          });
        }

        async function openAddRecordModal(){
          const ym = parseYearMonth();
          if (!ym) { alert('請先選擇有效月份'); return; }
          const typesRes = await fetch(`${apiBase}/admin/overhead-types?is_active=1&perPage=200`, { credentials:'include' });
          if (typesRes.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
          const typesJson = await typesRes.json();
          const types = (typesJson?.data)||[];
          if (!Array.isArray(types) || types.length === 0) { alert('尚無啟用的成本項目，請先建立'); return; }
          const form = document.createElement('div');
          const monthSel = document.createElement('input'); monthSel.type = 'month'; monthSel.value = `${String(ym.year)}-${String(ym.month).padStart(2,'0')}`;
          const typeSel = document.createElement('select');
          typeSel.innerHTML = types.map(t => `<option value="${t.id}">${t.name}（${t.category==='fixed'?'固定':'變動'}）</option>`).join('');
          const amtInput = document.createElement('input'); amtInput.type = 'number'; amtInput.placeholder = '請輸入金額'; amtInput.min = '1';
          const notesInput = document.createElement('input'); notesInput.type = 'text'; notesInput.placeholder = '備註（可留空）';
          form.appendChild(buildField('月份', monthSel));
          form.appendChild(buildField('成本項目', typeSel));
          form.appendChild(buildField('金額', amtInput));
          form.appendChild(buildField('備註', notesInput));
          openModal('新增月度記錄', form, async (close)=>{
            const cost_type_id = parseInt(typeSel.value, 10);
            const amount = Number(amtInput.value);
            const notes = notesInput.value.trim();
            if (!Number.isFinite(amount) || amount <= 0) { alert('金額無效'); return; }
            const mVal = String(monthSel.value||'');
            const mMatch = mVal.match(/^(\d{4})-(\d{2})$/);
            if (!mMatch) { alert('月份無效'); return; }
            const y = parseInt(mMatch[1], 10); const m = parseInt(mMatch[2], 10);
            const res = await fetch(`${apiBase}/admin/overhead-costs`, {
              method: 'POST', credentials: 'include', headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ cost_type_id, year: y, month: m, amount, notes })
            });
            const json = await res.json().catch(()=>({}));
            if (!res.ok || !json || json.ok !== true) { alert(json?.message||'建立失敗'); return; }
            close();
            if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
            loadRecords();
          });
        }

        function exportActiveTableToCsv(){
          let table;
          if (currentCostsTab === 'items') {
            table = tbodyItems?.parentElement;
          } else if (currentCostsTab === 'employee') {
            table = tbodyEmployee?.parentElement;
          } else if (currentCostsTab === 'client') {
            table = (viewType.value === 'client') ? tbodyClients?.parentElement : tbodyTasks?.parentElement;
          }
          if (!table) { alert('沒有可匯出的資料'); return; }
          const rows = Array.from(table.querySelectorAll('tr')).map(tr => {
            const cells = Array.from(tr.querySelectorAll('th,td')).map(td => {
              const text = (td.textContent||'').replace(/\s+/g,' ').trim();
              return '"' + text.replace(/"/g,'""') + '"';
            });
            return cells.join(',');
          });
          const csv = rows.join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          const fnYm = String(monthInput.value||'').replace('-','');
          a.download = `costs_${currentCostsTab}_${fnYm||'current'}.csv`;
          document.body.appendChild(a);
          a.click();
          setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
        }

        document.getElementById('btn-add-item')?.addEventListener('click', openAddTypeModal);
        document.getElementById('btn-add-record')?.addEventListener('click', openAddRecordModal);
        document.getElementById('btn-generate-month')?.addEventListener('click', generateCurrentMonth);
        document.getElementById('btn-export-csv')?.addEventListener('click', exportActiveTableToCsv);
        document.getElementById('btn-export-pdf')?.addEventListener('click', ()=>{
          alert('PDF 匯出尚未實作，請先使用 CSV 匯出');
        });

        // 一鍵生成：按模板生成本月記錄
        async function generateCurrentMonth(){
          const ym = parseYearMonth();
          if (!ym) { alert('請先選擇有效月份'); return; }
          try {
            // 先預覽
            const prevRes = await fetch(`${apiBase}/admin/overhead-costs/generate/preview?year=${ym.year}&month=${ym.month}`, { credentials:'include' });
            const prevJson = await prevRes.json();
            if (!prevRes.ok || !prevJson || prevJson.ok !== true) throw new Error(prevJson?.message||'預覽失敗');
            const items = (prevJson.data?.items)||[];
            if (items.length === 0) { alert('沒有可生成的項目'); return; }
            // 彈窗勾選
            const form = document.createElement('div');
            const list = document.createElement('div');
            list.style.maxHeight = '50vh'; list.style.overflow='auto'; list.style.border='1px solid #e5e7eb'; list.style.borderRadius='8px'; list.style.padding='8px';
            items.forEach(it => {
              const row = document.createElement('label');
              row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px 4px';
              const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !it.alreadyExists; cb.value = String(it.templateId);
              const span = document.createElement('span'); span.textContent = `${it.costName}：${formatCurrency(it.amount)}${it.alreadyExists?'（本月已存在）':''}`;
              row.appendChild(cb); row.appendChild(span); list.appendChild(row);
            });
            form.appendChild(list);
            openModal('本月自動生成（預覽）', form, async (close)=>{
              const selected = Array.from(list.querySelectorAll('input[type="checkbox"]')).filter(x=>x.checked).map(x=>parseInt(x.value,10));
              if (selected.length === 0) { alert('請至少勾選一項'); return; }
              const res = await fetch(`${apiBase}/admin/overhead-costs/generate?year=${ym.year}&month=${ym.month}` , { method:'POST', credentials:'include', headers:{'content-type':'application/json'}, body: JSON.stringify({ template_ids: selected }) });
              const json = await res.json().catch(()=>({}));
              if (!res.ok || !json || json.ok !== true) { alert(json?.message||'自動生成失敗'); return; }
              close();
              if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
              loadRecords();
              alert('已自動生成');
            });
          } catch (err) {
            alert('自動生成失敗：' + (err?.message||String(err)));
          }
        }

        // ⚡ 预渲染初始化
        if (window.PagePrerender) {
          window.PagePrerender.init('main');
        }

        // 初始化
        ensureAdmin().then(ok => { 
          if (ok) { 
            loadItems(); 
            loadRecords(); 
            // ⚡ 自动保存预渲染
            if (window.PagePrerender) {
              setTimeout(() => window.PagePrerender.autoSave('main', 2000), 1000);
            }
          } 
        });
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>



