<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="管理成本" />
    <title>管理成本｜設定與分析</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/costs-page.css" />
    
    <!-- ⚡ 预加载与缓存系统 -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <script src="/assets/js/prerender.js"></script>
    <script src="/assets/js/page-prerender.js"></script>
    <script src="/assets/js/tab-cache.js"></script>
  </head>
  <body class="costs-page">
    <div style="padding:16px 20px;">
      <div id="infoBar" class="info-bar" style="display:none;" role="alert">您沒有權限存取此模組</div>
      <div class="costs-toolbar" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
        <div class="toolbar-spacer" style="flex:1;"></div>
      </div>
      <nav class="costs-tabs" role="tablist" aria-label="管理成本分頁" style="display:flex;gap:8px;border-bottom:2px solid #e5e7eb;">
        <button class="tab active" role="tab" aria-selected="true" data-tab="items">成本項目設定</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="employee">員工成本分析</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="client">客戶任務成本</button>
      </nav>
    </div>

    <main class="costs-content">
      <!-- 成本項目設定 -->
      <section id="panel-items" class="panel show" role="tabpanel" aria-labelledby="tab-items">
        <div class="card">
          <div class="section-toolbar">
            <div class="toolbar-spacer"></div>
            <button id="btn-add-item" type="button" class="btn primary" disabled>新增項目</button>
          </div>
          <table class="table" aria-label="成本項目列表">
            <thead>
              <tr>
                <th>成本名稱</th>
                <th>類別</th>
                <th>分攤方式</th>
                <th>描述</th>
                <th>狀態</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="tbody-items">
              <tr><td colspan="6" class="muted">尚無資料</td></tr>
            </tbody>
          </table>
        </div>
        
        <div class="card" style="margin-top: 16px;">
          <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">月度管理費用記錄</h3>
          <div class="section-toolbar">
            <label for="month">月份</label>
            <input id="month" type="month" aria-label="月份" />
            <div class="toolbar-spacer"></div>
            <button id="btn-generate-month" type="button" class="btn" disabled>本月自動生成</button>
            <button id="btn-add-record" type="button" class="btn primary" disabled>新增記錄</button>
          </div>
          <div class="stats-cards">
            <div class="stat">
              <div class="stat-label">本月總管理費用</div>
              <div class="stat-value" id="stat-total">—</div>
              <div class="stat-meta muted" id="stat-breakdown">固定：—｜變動：—</div>
            </div>
          </div>
          <table class="table" aria-label="月度管理費用記錄">
            <thead>
              <tr>
                <th>項目名稱</th>
                <th>金額</th>
                <th>備註</th>
                <th>錄入人</th>
                <th>錄入時間</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="tbody-records">
              <tr><td colspan="6" class="muted">尚無資料</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- 員工成本分析 -->
      <section id="panel-employee" class="panel" role="tabpanel" aria-labelledby="tab-employee">
        <div class="card">
          <div class="section-toolbar">
            <label for="month-emp">月份</label>
            <input id="month-emp" type="month" aria-label="員工成本月份" />
            <div class="toolbar-spacer"></div>
            <button type="button" class="btn" id="btn-refresh-emp" disabled>刷新</button>
          </div>
          <div class="info-box" style="margin-bottom: 12px; padding: 10px 12px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; font-size: 14px; color: #1e40af;">
            <strong>計算說明（完全成本法）：</strong><br>
            • <strong>薪資成本</strong> = 應發工資（底薪 + 固定津貼 + 非固定津貼 + 固定獎金 + 績效獎金 + 年終獎金 + 加班費 + 伙食津貼 + 交通補貼）<br>
            • <strong>分攤管理費</strong>：根據各成本項目設定的分攤方式（按員工數/按工時/按營收）計算<br>
            • <strong>總成本</strong> = 薪資成本 + 分攤管理費用<br>
            • <strong style="color:#0ea5e9;">實際時薪</strong> = 總成本 ÷ 實際工時（含直接成本+間接成本，用於任務成本分析）<br>
            <hr style="margin: 8px 0; border: none; border-top: 1px solid #bfdbfe;">
            • <strong>補休規則</strong>：加班先全部轉為補休，本月未使用的補休才轉為加班費<br>
            • <strong>產生補休</strong>：一般加班 1:1 產生補休；國定假日/例假日（8小時內）產生8小時補休並支付雙倍工資，超過8小時部分按平日加班倍率<br>
            • <strong>未使用補休</strong> = 本月產生補休 - 本月使用補休
          </div>
          <table class="table" aria-label="員工成本列表">
            <thead>
              <tr>
                <th>姓名</th>
                <th>底薪</th>
                <th>本月工時</th>
                <th>產生補休</th>
                <th>使用補休</th>
                <th>未使用補休</th>
                <th>補休轉加班費</th>
                <th>薪資成本</th>
                <th>分攤管理費</th>
                <th>本月總成本</th>
                <th>實際時薪</th>
              </tr>
            </thead>
            <tbody id="tbody-employee">
              <tr><td colspan="11" class="muted">載入中…</td></tr>
            </tbody>
          </table>
          <div class="summary-row" style="margin-top: 12px; padding: 12px; background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; font-weight: 600;">
              <span>本月總計：</span>
              <span id="emp-total-cost">—</span>
            </div>
          </div>
        </div>
      </section>

      <!-- 客戶任務成本 -->
      <section id="panel-client" class="panel" role="tabpanel" aria-labelledby="tab-client">
        <div class="card">
          <div class="section-toolbar">
            <label for="month-client">月份</label>
            <input id="month-client" type="month" aria-label="客戶成本月份" />
            <select id="viewType">
              <option value="client">按客戶彙總</option>
              <option value="task">按任務明細</option>
            </select>
            <div class="toolbar-spacer"></div>
            <button type="button" class="btn" id="btn-refresh-client" disabled>刷新</button>
          </div>
          
          <div id="client-view">
            <div class="info-box" style="margin-bottom: 12px; padding: 10px 12px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; font-size: 14px; color: #1e40af;">
              <strong>計算說明：</strong><br>
              • <strong>客戶總成本</strong> = Σ(每位員工在該客戶的加權工時 × 該員工的實際時薪)<br>
              • <strong>實際時薪</strong>：已包含薪資成本 + 管理費分攤（與員工成本分析一致）<br>
              • <strong>利潤</strong> = 本月收入 - 總成本<br>
              • <strong>利潤率</strong> = 利潤 ÷ 本月收入 × 100%
            </div>
            <table class="table" aria-label="客戶成本彙總">
              <thead>
                <tr>
                  <th>客戶名稱</th>
                  <th>總工時</th>
                  <th>加權工時</th>
                  <th>平均時薪</th>
                  <th>總成本</th>
                  <th>本月收入</th>
                  <th>利潤</th>
                  <th>利潤率</th>
                </tr>
              </thead>
              <tbody id="tbody-clients">
                <tr><td colspan="8" class="muted">載入中…</td></tr>
              </tbody>
            </table>
          </div>

          <div id="task-view" style="display: none;">
            <div class="info-box" style="margin-bottom: 12px; padding: 10px 12px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; font-size: 14px; color: #1e40af;">
              <strong>計算說明：</strong><br>
              • <strong>總成本</strong> = 加權工時 × 實際時薪（實際時薪已包含薪資成本 + 管理費分攤）
            </div>
            <table class="table" aria-label="任務成本明細">
              <thead>
                <tr>
                  <th>客戶名稱</th>
                  <th>服務項目</th>
                  <th>任務標題</th>
                  <th>負責人</th>
                  <th>工時</th>
                  <th>加權工時</th>
                  <th>總成本</th>
                </tr>
              </thead>
              <tbody id="tbody-tasks">
                <tr><td colspan="7" class="muted">載入中…</td></tr>
              </tbody>
            </table>
          </div>

          <div class="summary-row" style="margin-top: 12px; padding: 12px; background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
              <div>
                <div style="font-size: 12px; color: #64748b;">總成本</div>
                <div style="font-size: 18px; font-weight: 600;" id="client-total-cost">—</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #64748b;">總收入</div>
                <div style="font-size: 18px; font-weight: 600;" id="client-total-revenue">—</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #64748b;">總利潤</div>
                <div style="font-size: 18px; font-weight: 600;" id="client-total-profit">—</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #64748b;">平均利潤率</div>
                <div style="font-size: 18px; font-weight: 600;" id="client-avg-margin">—</div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const infoBar = document.getElementById('infoBar');
        const tabs = Array.from(document.querySelectorAll('.costs-tabs .tab'));
        const panels = {
          items: document.getElementById('panel-items'),
          employee: document.getElementById('panel-employee'),
          client: document.getElementById('panel-client'),
        };

        const monthInput = document.getElementById('month');
        const monthInputEmp = document.getElementById('month-emp');
        const monthInputClient = document.getElementById('month-client');

        // 成本項目設定
        const tbodyItems = document.getElementById('tbody-items');

        // 月度管理費用記錄
        const tbodyRecords = document.getElementById('tbody-records');
        const statTotal = document.getElementById('stat-total');
        const statBreakdown = document.getElementById('stat-breakdown');

        // 員工成本分析
        const tbodyEmployee = document.getElementById('tbody-employee');
        const empTotalCost = document.getElementById('emp-total-cost');

        // 客戶任務成本
        const viewType = document.getElementById('viewType');
        const clientView = document.getElementById('client-view');
        const taskView = document.getElementById('task-view');
        const tbodyClients = document.getElementById('tbody-clients');
        const tbodyTasks = document.getElementById('tbody-tasks');

        function setTabsEnabled(enabled){
          tabs.forEach(b=>{ b.disabled = !enabled; });
          document.querySelectorAll('.costs-toolbar .btn, .section-toolbar input, .section-toolbar select, .section-toolbar button').forEach(el=>{ el.disabled = !enabled; });
        }

        // ⚡ Tab 缓存系统初始化
        let currentCostsTab = 'items';
        if (window.TabCache) {
          window.TabCache.init(['items', 'employee', 'client']);
        }

        tabs.forEach(btn => {
          btn.addEventListener('click', ()=>{
            const key = btn.getAttribute('data-tab');
            
            // ⚡ 检查是否需要加载（使用缓存）
            const shouldLoad = window.TabCache ? window.TabCache.shouldLoad(currentCostsTab, key) : true;
            currentCostsTab = key;
            
            tabs.forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            Object.entries(panels).forEach(([k,el])=>{
              if (k === key) el.classList.add('show'); else el.classList.remove('show');
            });
            
            // ⚡ 只在需要时载入对应资料
            if (shouldLoad) {
              if (key === 'employee') loadEmployeeCosts();
              if (key === 'client') loadClientCosts();
              
              // ⚡ 标记为已加载
              if (window.TabCache) {
                window.TabCache.markLoaded(key);
              }
            }
          });
        });

        function parseYearMonth(){
          // 根据当前标签页选择对应的月份输入框
          let input;
          if (currentCostsTab === 'employee') {
            input = monthInputEmp;
          } else if (currentCostsTab === 'client') {
            input = monthInputClient;
          } else {
            input = monthInput;
          }
          
          const v = String(input?.value || '');
          const m = v.match(/^(\d{4})-(\d{2})$/);
          if (!m) return null;
          const year = parseInt(m[1], 10);
          const month = parseInt(m[2], 10);
          if (!Number.isFinite(year) || !Number.isFinite(month) || month < 1 || month > 12) return null;
          return { year, month };
        }

        function formatCurrency(val){
          return 'NT$ ' + Number(val || 0).toLocaleString();
        }

        // ============ 成本項目設定 ============
        async function loadItems(){
          const params = new URLSearchParams();
          params.set('_t', String(Date.now())); // 强制绕过缓存
          try {
            console.log('[loadItems] 開始加載成本項目...');
            tbodyItems.innerHTML = '<tr><td colspan="6" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/admin/overhead-types?${params.toString()}`, { credentials:'include', cache: 'no-store' });
            console.log('[loadItems] API 回應狀態:', res.status);
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            const json = await res.json();
            console.log('[loadItems] 收到數據:', json);
            if (!res.ok || !json || json.ok !== true) throw new Error('API 返回錯誤');
            const items = json.data || [];
            console.log('[loadItems] 項目數量:', items.length);
            if (items.length === 0) {
              tbodyItems.innerHTML = '<tr><td colspan="6" class="muted">尚無資料</td></tr>';
              return;
            }
            tbodyItems.innerHTML = '';
            items.forEach((item, index) => {
              try {
                console.log(`[loadItems] 渲染項目 ${index}:`, item);
                const tr = document.createElement('tr');
                const allocationText = { per_employee: '按員工數', per_hour: '按工時', per_revenue: '按收入' }[item.allocationMethod] || item.allocationMethod;
                tr.innerHTML = `
                  <td>${item.name||''}</td>
                  <td>${item.category === 'fixed' ? '固定' : '變動'}</td>
                  <td>${allocationText}</td>
                  <td>${item.description||''}</td>
                  <td>${item.isActive ? '啟用' : '停用'}</td>
                  <td>
                    <button class="btn-link" data-edit-item-id="${item.id}">編輯</button>
                    <button class="btn-link" data-template-id="${item.id}">自動生成</button>
                    <button class="btn-link" style="color:#dc2626;" data-delete-id="${item.id}">刪除</button>
                  </td>
                `;
                tbodyItems.appendChild(tr);
              } catch (itemErr) {
                console.error(`[loadItems] 渲染項目 ${index} 失敗:`, itemErr, item);
              }
            });
            console.log('[loadItems] 渲染完成，已添加', items.length, '個項目');
            // 綁定編輯成本項目
            tbodyItems.querySelectorAll('button[data-edit-item-id]').forEach(btn => {
              btn.addEventListener('click', ()=> {
                const id = parseInt(btn.getAttribute('data-edit-item-id'),10);
                const item = items.find(x => x.id === id);
                openEditItemModal(item);
              });
            });
            // 綁定自動生成設定
            tbodyItems.querySelectorAll('button[data-template-id]').forEach(btn => {
              btn.addEventListener('click', ()=> openEditTemplateModal(parseInt(btn.getAttribute('data-template-id'),10)) );
            });
            // 綁定刪除
            tbodyItems.querySelectorAll('button[data-delete-id]').forEach(btn => {
              btn.addEventListener('click', async ()=> {
                const id = parseInt(btn.getAttribute('data-delete-id'),10);
                if (!confirm('確定要刪除此成本項目嗎？')) return;
                try {
                  const res = await fetch(`${apiBase}/admin/overhead-types/${id}`, { method: 'DELETE', credentials:'include' });
                  const json = await res.json().catch(()=>({}));
                  if (!res.ok || !json || json.ok !== true) { alert(json?.message||'刪除失敗'); return; }
                  // 刷新数据
                  if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
                  await loadItems();
                } catch (err) {
                  alert('刪除失敗：' + String(err));
                }
              });
            });
          } catch (err) {
            console.error('[loadItems] 載入失敗:', err);
            tbodyItems.innerHTML = '<tr><td colspan="6" style="color:#c0392b;">載入失敗</td></tr>';
          }
        }
        async function openEditItemModal(item){
          const form = document.createElement('div');
          const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.value = item.name||'';
          const catSel = document.createElement('select'); 
          catSel.innerHTML = '<option value="fixed">固定</option><option value="variable">變動</option>';
          catSel.value = item.category;
          const allocSel = document.createElement('select'); 
          allocSel.innerHTML = '<option value="per_employee">按員工數</option><option value="per_hour">按工時</option><option value="per_revenue">按收入</option>';
          allocSel.value = item.allocationMethod;
          const descInput = document.createElement('input'); descInput.type = 'text'; descInput.value = item.description||'';
          const activeChk = document.createElement('input'); activeChk.type='checkbox'; activeChk.id='editActive'; activeChk.checked = item.isActive;
          const activeLbl = document.createElement('label'); activeLbl.htmlFor='editActive'; activeLbl.textContent='啟用'; activeLbl.style.marginLeft='6px';
          const activeWrap = document.createElement('div'); activeWrap.style.marginTop='10px'; activeWrap.appendChild(activeChk); activeWrap.appendChild(activeLbl);
          
          form.appendChild(buildField('成本名稱', nameInput));
          form.appendChild(buildField('類別', catSel));
          form.appendChild(buildField('分攤方式', allocSel));
          form.appendChild(buildField('描述', descInput));
          form.appendChild(activeWrap);
          
          openModal('編輯成本項目', form, async (close)=>{
            const name = nameInput.value.trim();
            const category = catSel.value;
            const allocationMethod = allocSel.value;
            const description = descInput.value.trim();
            const isActive = activeChk.checked ? 1 : 0;
            if (!name) { alert('請輸入成本名稱'); return; }
            try {
              const res = await fetch(`${apiBase}/admin/overhead-types/${item.id}`, {
                method: 'PUT', credentials: 'include', headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ cost_name: name, category, allocation_method: allocationMethod, description, is_active: isActive })
              });
              const json = await res.json().catch(()=>({}));
              if (!res.ok || !json || json.ok !== true) { alert(json?.message||'更新失敗'); return; }
              
              // 先刷新数据
              if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
              await loadItems();
              
              // 再关闭对话框
              close();
            } catch (err) {
              console.error('更新項目失敗:', err);
              alert('更新失敗：' + (err?.message || String(err)));
            }
          });
        }
        
        async function openEditRecordModal(record){
          const form = document.createElement('div');
          const amountInput = document.createElement('input'); amountInput.type = 'number'; amountInput.value = record.amount||''; amountInput.min = '1';
          const notesInput = document.createElement('input'); notesInput.type = 'text'; notesInput.value = record.notes||'';
          
          form.appendChild(buildField('金額', amountInput));
          form.appendChild(buildField('備註', notesInput));
          
          openModal('編輯月度記錄', form, async (close)=>{
            const amount = Number(amountInput.value);
            const notes = notesInput.value.trim();
            if (!Number.isFinite(amount) || amount <= 0) { alert('金額無效'); return; }
            try {
              const res = await fetch(`${apiBase}/admin/overhead-costs/${record.id}`, {
                method: 'PUT', credentials: 'include', headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ amount, notes })
              });
              const json = await res.json().catch(()=>({}));
              if (!res.ok || !json || json.ok !== true) { alert(json?.message||'更新失敗'); return; }
              
              // 先刷新数据
              if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
              await loadRecords();
              
              // 再关闭对话框
              close();
            } catch (err) {
              console.error('更新記錄失敗:', err);
              alert('更新失敗：' + (err?.message || String(err)));
            }
          });
        }
        
        async function openEditTemplateModal(costTypeId){
          try {
            // 读取现有模板数据
            console.log('[EditTemplate] 加載模板數據，cost_type_id:', costTypeId);
            const res = await fetch(`${apiBase}/admin/overhead-templates/by-type/${costTypeId}?_t=${Date.now()}`, { 
              credentials:'include',
              cache: 'no-store'
            });
            let existingTemplate = null;
            if (res.ok) {
              const json = await res.json();
              console.log('[EditTemplate] 模板數據:', json);
              if (json.ok && json.data) {
                existingTemplate = json.data;
              }
            } else {
              console.log('[EditTemplate] 模板不存在或加載失敗:', res.status);
            }
            
            const form = document.createElement('div');
            const enableChk = document.createElement('input'); 
            enableChk.type='checkbox'; 
            enableChk.id='tplEnable'; 
            enableChk.checked = existingTemplate ? (existingTemplate.isActive !== false) : true;
            
            const enableLbl = document.createElement('label'); 
            enableLbl.htmlFor='tplEnable'; 
            enableLbl.textContent='啟用每月自動生成'; 
            enableLbl.style.marginLeft='6px';
            
            const enWrap = document.createElement('div'); 
            enWrap.appendChild(enableChk); 
            enWrap.appendChild(enableLbl); 
            enWrap.style.marginBottom='8px';
            
            const amountInput = document.createElement('input'); 
            amountInput.type='number'; 
            amountInput.placeholder='預設金額'; 
            amountInput.min='1';
            if (existingTemplate && existingTemplate.amount) {
              amountInput.value = existingTemplate.amount;
            }
            
            const effInput = document.createElement('input'); 
            effInput.type='month';
            if (existingTemplate && existingTemplate.effectiveFrom) {
              effInput.value = existingTemplate.effectiveFrom;
            }
            
            form.appendChild(enWrap);
            form.appendChild(buildField('預設金額', amountInput));
            form.appendChild(buildField('生效起始月', effInput));
          openModal('自動生成設定', form, async (close)=>{
            const is_active = enableChk.checked;
            const amount = Number(amountInput.value||0);
            const efv = String(effInput.value||'');
            const body = { is_active };
            if (amount>0) body.amount = amount;
            if (/^\d{4}-\d{2}$/.test(efv)) body.effective_from = efv;
            try {
              const res = await fetch(`${apiBase}/admin/overhead-templates/by-type/${costTypeId}`, { method:'PUT', credentials:'include', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
              const json = await res.json().catch(()=>({}));
              if (!res.ok || !json || json.ok !== true) { alert(json?.message||'儲存失敗'); return; }
              close();
              alert('已儲存');
            } catch (err) {
              console.error('儲存模板失敗:', err);
              alert('儲存失敗：' + (err?.message || String(err)));
            }
          });
          } catch (err) {
            console.error('[EditTemplate] 加載模板失敗:', err);
            alert('加載模板失敗：' + (err?.message || String(err)));
          }
        }

        async function loadRecords(){
          const ym = parseYearMonth();
          if (!ym) {
            console.warn('[loadRecords] 無效月份，monthInput.value:', monthInput?.value);
            tbodyRecords.innerHTML = '<tr><td colspan="6" class="muted">請選擇月份</td></tr>';
            statTotal.textContent = '—';
            statBreakdown.textContent = '固定：—｜變動：—';
            return;
          }
          console.log('[loadRecords] 加載數據:', ym);
          const params = new URLSearchParams();
          params.set('year', String(ym.year));
          params.set('month', String(ym.month));
          params.set('_t', String(Date.now())); // 强制绕过缓存
          try {
            tbodyRecords.innerHTML = '<tr><td colspan="6" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/admin/overhead-costs?${params.toString()}`, { credentials:'include', cache: 'no-store' });
            console.log('[loadRecords] API 回應狀態:', res.status);
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            const json = await res.json();
            console.log('[loadRecords] 收到數據:', json);
            if (!res.ok || !json || json.ok !== true) throw new Error('API 返回錯誤');
            const data = json.data || {};
            const items = data.items || [];
            console.log('[loadRecords] 記錄數量:', items.length);
            if (items.length === 0) {
              tbodyRecords.innerHTML = '<tr><td colspan="6" class="muted">尚無資料</td></tr>';
            } else {
              tbodyRecords.innerHTML = '';
              items.forEach((r, index) => {
                try {
                  console.log(`[loadRecords] 渲染記錄 ${index}:`, r);
                  const tr = document.createElement('tr');
                  tr.innerHTML = `
                    <td>${r.costName||''}</td>
                    <td>${formatCurrency(r.amount)}</td>
                    <td>${r.notes||''}</td>
                    <td>${r.recordedBy||''}</td>
                    <td>${r.recordedAt||''}</td>
                    <td>
                      <button class="btn-link" data-edit-record-id="${r.id}">編輯</button>
                      <button class="btn-link" style="color:#dc2626;" data-delete-record-id="${r.id}">刪除</button>
                    </td>
                  `;
                  tbodyRecords.appendChild(tr);
                } catch (itemErr) {
                  console.error(`[loadRecords] 渲染記錄 ${index} 失敗:`, itemErr, r);
                }
              });
              console.log('[loadRecords] 渲染完成，已添加', items.length, '筆記錄');
              // 綁定編輯月度記錄
              tbodyRecords.querySelectorAll('button[data-edit-record-id]').forEach(btn => {
                btn.addEventListener('click', ()=> {
                  const id = parseInt(btn.getAttribute('data-edit-record-id'),10);
                  const record = items.find(x => x.id === id);
                  openEditRecordModal(record);
                });
              });
              // 綁定刪除月度記錄
              tbodyRecords.querySelectorAll('button[data-delete-record-id]').forEach(btn => {
                btn.addEventListener('click', async ()=> {
                  const id = parseInt(btn.getAttribute('data-delete-record-id'),10);
                  if (!confirm('確定要刪除此記錄嗎？')) return;
                  try {
                    const res = await fetch(`${apiBase}/admin/overhead-costs/${id}`, { method: 'DELETE', credentials:'include' });
                    const json = await res.json().catch(()=>({}));
                    if (!res.ok || !json || json.ok !== true) { alert(json?.message||'刪除失敗'); return; }
                    // 刷新数据
                    if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
                    await loadRecords();
                  } catch (err) {
                    alert('刪除失敗：' + String(err));
                  }
                });
              });
            }
            const total = Number(data.total||0);
            const totalFixed = Number(data.totalFixed||0);
            const totalVariable = Number(data.totalVariable||0);
            console.log('[loadRecords] 統計資料:', { total, totalFixed, totalVariable });
            statTotal.textContent = formatCurrency(total);
            statBreakdown.textContent = `固定：${formatCurrency(totalFixed)}｜變動：${formatCurrency(totalVariable)}`;
          } catch (err) {
            console.error('[loadRecords] 載入失敗:', err);
            tbodyRecords.innerHTML = '<tr><td colspan="6" style="color:#c0392b;">載入失敗</td></tr>';
            statTotal.textContent = '—';
            statBreakdown.textContent = '固定：—｜變動：—';
          }
        }

        // ============ 員工成本分析 ============
        async function loadEmployeeCosts(){
          const ym = parseYearMonth();
          if (!ym) return;
          const params = new URLSearchParams();
          params.set('year', String(ym.year));
          params.set('month', String(ym.month));
          params.set('_t', String(Date.now())); // 强制绕过缓存
          try {
            tbodyEmployee.innerHTML = '<tr><td colspan="11" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/admin/costs/employee?${params.toString()}`, { credentials:'include', cache: 'no-store' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            if (res.status === 501) {
              tbodyEmployee.innerHTML = '<tr><td colspan="11" class="muted">功能尚未實作，敬請期待</td></tr>';
              empTotalCost.textContent = '—';
              return;
            }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || {};
            const employees = data.employees || [];
            if (employees.length === 0) {
              tbodyEmployee.innerHTML = '<tr><td colspan="11" class="muted">尚無資料</td></tr>';
              empTotalCost.textContent = formatCurrency(0);
              return;
            }
            tbodyEmployee.innerHTML = '';
            let totalCost = 0;
            employees.forEach(emp => {
              const tr = document.createElement('tr');
              
              const baseSalary = Number(emp.baseSalary || 0);
              const salaryItemsAmount = Number(emp.salaryItemsAmount || 0);
              const expiredCompPay = Number(emp.expiredCompPay || 0);
              const leaveDeduction = Number(emp.leaveDeduction || 0);
              const monthHours = Number(emp.monthHours || 0);
              const totalCompHoursGenerated = Number(emp.totalCompHoursGenerated || 0);
              const totalCompHoursUsed = Number(emp.totalCompHoursUsed || 0);
              const unusedCompHours = Number(emp.unusedCompHours || 0);
              const laborCost = Number(emp.laborCost || 0);
              const overheadAllocation = Number(emp.overheadAllocation || 0);
              const empTotalCost = Number(emp.totalCost || 0);
              const actualHourlyRate = Number(emp.actualHourlyRate || 0);
              
              // 計算說明
              const calcDetail = `底薪 ${formatCurrency(baseSalary)} + 津貼獎金 ${formatCurrency(salaryItemsAmount)} + 補休轉加班費 ${formatCurrency(expiredCompPay)}${leaveDeduction > 0 ? ` - 請假扣款 ${formatCurrency(leaveDeduction)}` : ''} = ${formatCurrency(laborCost)}`;
              
              totalCost += empTotalCost;
              tr.innerHTML = `
                <td>${emp.name||''}</td>
                <td>${formatCurrency(baseSalary)}</td>
                <td>${monthHours.toFixed(1)}</td>
                <td>${totalCompHoursGenerated.toFixed(1)}</td>
                <td>${totalCompHoursUsed.toFixed(1)}</td>
                <td style="color:#dc2626;">${unusedCompHours.toFixed(1)}</td>
                <td style="color:#dc2626;">${formatCurrency(expiredCompPay)}</td>
                <td style="font-weight:600;" title="${calcDetail}">${formatCurrency(laborCost)}</td>
                <td>${formatCurrency(overheadAllocation)}</td>
                <td style="font-weight:600;color:#16a34a;">${formatCurrency(empTotalCost)}</td>
                <td style="font-weight:600;color:#0ea5e9;">${formatCurrency(actualHourlyRate)}</td>
              `;
              tbodyEmployee.appendChild(tr);
            });
            empTotalCost.textContent = formatCurrency(totalCost);
          } catch (err) {
            tbodyEmployee.innerHTML = '<tr><td colspan="11" style="color:#c0392b;">載入失敗</td></tr>';
            empTotalCost.textContent = '—';
          }
        }

        // ============ 客戶任務成本 ============
        async function loadClientCosts(){
          const view = viewType.value;
          if (view === 'client') {
            clientView.style.display = 'block';
            taskView.style.display = 'none';
            await loadClientSummary();
          } else {
            clientView.style.display = 'none';
            taskView.style.display = 'block';
            await loadTaskDetails();
          }
        }

        async function loadClientSummary(){
          const ym = parseYearMonth();
          if (!ym) return;
          const params = new URLSearchParams();
          params.set('year', String(ym.year));
          params.set('month', String(ym.month));
          params.set('_t', String(Date.now())); // 强制绕过缓存
          try {
            tbodyClients.innerHTML = '<tr><td colspan="10" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/admin/costs/client?${params.toString()}`, { credentials:'include', cache: 'no-store' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            if (res.status === 501) {
              tbodyClients.innerHTML = '<tr><td colspan="10" class="muted">功能尚未實作，敬請期待</td></tr>';
              return;
            }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || {};
            const clients = data.clients || [];
            if (clients.length === 0) {
              tbodyClients.innerHTML = '<tr><td colspan="10" class="muted">尚無資料</td></tr>';
              updateClientSummary(0, 0, 0, 0);
              return;
            }
            tbodyClients.innerHTML = '';
            let totalCost = 0, totalRevenue = 0, totalProfit = 0;
            clients.forEach(client => {
              const tr = document.createElement('tr');
              const cost = Number(client.totalCost || 0);
              const revenue = Number(client.revenue || 0);
              const profit = Number(client.profit || 0);
              const margin = revenue > 0 ? (profit / revenue * 100) : 0;
              const weightedHours = Number(client.weightedHours || 0);
              const avgHourlyRate = Number(client.avgHourlyRate || 0);
              totalCost += cost;
              totalRevenue += revenue;
              totalProfit += profit;
              tr.innerHTML = `
                <td>${client.clientName||''}</td>
                <td>${Number(client.totalHours||0).toFixed(1)}</td>
                <td>${weightedHours.toFixed(1)}</td>
                <td style="color:#0ea5e9;font-weight:600;">${formatCurrency(avgHourlyRate)}</td>
                <td style="font-weight:600;">${formatCurrency(cost)}</td>
                <td>${formatCurrency(revenue)}</td>
                <td style="color:${profit >= 0 ? '#16a34a' : '#dc2626'};font-weight:600;">${formatCurrency(profit)}</td>
                <td style="font-weight:600;">${margin.toFixed(1)}%</td>
              `;
              tbodyClients.appendChild(tr);
            });
            const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0;
            updateClientSummary(totalCost, totalRevenue, totalProfit, avgMargin);
          } catch (_) {
            tbodyClients.innerHTML = '<tr><td colspan="8" style="color:#c0392b;">載入失敗</td></tr>';
          }
        }

        async function loadTaskDetails(){
          const ym = parseYearMonth();
          if (!ym) return;
          const params = new URLSearchParams();
          params.set('year', String(ym.year));
          params.set('month', String(ym.month));
          params.set('_t', String(Date.now())); // 强制绕过缓存
          try {
            tbodyTasks.innerHTML = '<tr><td colspan="7" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/admin/costs/task?${params.toString()}`, { credentials:'include', cache: 'no-store' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            if (res.status === 501) {
              tbodyTasks.innerHTML = '<tr><td colspan="7" class="muted">功能尚未實作，敬請期待</td></tr>';
              return;
            }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || {};
            const tasks = data.tasks || [];
            if (tasks.length === 0) {
              tbodyTasks.innerHTML = '<tr><td colspan="7" class="muted">尚無資料</td></tr>';
              return;
            }
            tbodyTasks.innerHTML = '';
            tasks.forEach(task => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${task.clientName||''}</td>
                <td>${task.serviceName||''}</td>
                <td>${task.taskTitle||''}</td>
                <td>${task.assigneeName||''}</td>
                <td>${Number(task.hours||0).toFixed(1)}</td>
                <td>${Number(task.weightedHours||0).toFixed(1)}</td>
                <td style="font-weight:600;color:#16a34a;">${formatCurrency(task.totalCost)}</td>
              `;
              tbodyTasks.appendChild(tr);
            });
          } catch (_) {
            tbodyTasks.innerHTML = '<tr><td colspan="7" style="color:#c0392b;">載入失敗</td></tr>';
          }
        }

        function updateClientSummary(cost, revenue, profit, margin){
          document.getElementById('client-total-cost').textContent = formatCurrency(cost);
          document.getElementById('client-total-revenue').textContent = formatCurrency(revenue);
          document.getElementById('client-total-profit').textContent = formatCurrency(profit);
          document.getElementById('client-avg-margin').textContent = margin.toFixed(1) + '%';
        }

        async function ensureAdmin(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return false; }
            const json = await res.json();
            const isAdmin = !!(json && json.ok && json.data && json.data.isAdmin);
            if (!isAdmin) {
              infoBar.style.display = 'block';
              setTabsEnabled(false);
              return false;
            }
            setTabsEnabled(true);
            return true;
          } catch (_) {
            infoBar.textContent = '載入失敗，請稍後再試';
            infoBar.style.display = 'block';
            setTabsEnabled(false);
            return false;
          }
        }

        // 預設月份為本月
        const now = new Date();
        const currentMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        monthInput.value = currentMonth;
        monthInputEmp.value = currentMonth;
        monthInputClient.value = currentMonth;

        // 事件
        let searchTimer = null;
        viewType.addEventListener('change', loadClientCosts);
        
        // 各标签页的月份选择器变化事件
        monthInput.addEventListener('change', ()=>{ 
          loadItems(); 
          loadRecords();
          updateButtonState();
        });
        
        monthInputEmp.addEventListener('change', ()=>{
          loadEmployeeCosts();
        });
        
        monthInputClient.addEventListener('change', ()=>{
          loadClientCosts();
        });

        document.getElementById('btn-refresh-emp')?.addEventListener('click', loadEmployeeCosts);
        document.getElementById('btn-refresh-client')?.addEventListener('click', loadClientCosts);

        // ============ 新增/匯出功能（改用表單與下拉選單） ============
        function openModal(title, contentEl, onSubmit){
          const overlay = document.createElement('div');
          overlay.style.position = 'fixed';
          overlay.style.inset = '0';
          overlay.style.background = 'rgba(0,0,0,0.3)';
          overlay.style.display = 'flex';
          overlay.style.alignItems = 'center';
          overlay.style.justifyContent = 'center';
          overlay.style.zIndex = '1000';
          const modal = document.createElement('div');
          modal.style.background = '#fff';
          modal.style.border = '1px solid #e5e7eb';
          modal.style.borderRadius = '10px';
          modal.style.boxShadow = '0 10px 30px rgba(0,0,0,0.15)';
          modal.style.width = 'min(520px, 92vw)';
          modal.style.maxHeight = '85vh';
          modal.style.display = 'flex';
          modal.style.flexDirection = 'column';
          const header = document.createElement('div');
          header.style.padding = '14px 16px';
          header.style.borderBottom = '1px solid #eee';
          header.style.fontWeight = '600';
          header.textContent = title;
          const body = document.createElement('div');
          body.style.padding = '14px 16px';
          body.style.overflow = 'auto';
          body.style.flex = '1';
          body.appendChild(contentEl);
          const footer = document.createElement('div');
          footer.style.display = 'flex';
          footer.style.gap = '8px';
          footer.style.justifyContent = 'flex-end';
          footer.style.padding = '12px 16px';
          footer.style.borderTop = '1px solid #eee';
          footer.style.flexShrink = '0';
          const btnCancel = document.createElement('button');
          btnCancel.className = 'btn';
          btnCancel.textContent = '取消';
          const btnOk = document.createElement('button');
          btnOk.className = 'btn primary';
          btnOk.textContent = '儲存';
          footer.appendChild(btnCancel); footer.appendChild(btnOk);
          modal.appendChild(header); modal.appendChild(body); modal.appendChild(footer);
          overlay.appendChild(modal);
          function close(){ document.body.removeChild(overlay); }
          btnCancel.addEventListener('click', close);
          btnOk.addEventListener('click', async ()=>{ await onSubmit?.(close); });
          document.body.appendChild(overlay);
        }

        function buildField(labelText, inputEl){
          const wrap = document.createElement('div');
          wrap.style.marginBottom = '10px';
          const label = document.createElement('label');
          label.style.display = 'block';
          label.style.fontSize = '12px';
          label.style.color = '#64748b';
          label.style.marginBottom = '6px';
          label.textContent = labelText;
          inputEl.style.width = '100%';
          inputEl.style.boxSizing = 'border-box';
          inputEl.style.padding = '8px 10px';
          inputEl.style.border = '1px solid #e5e7eb';
          inputEl.style.borderRadius = '8px';
          wrap.appendChild(label); wrap.appendChild(inputEl);
          return wrap;
        }

        function openAddTypeModal(){
          const form = document.createElement('div');
          const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.placeholder = '例如：辦公室租金';
          const catSel = document.createElement('select'); catSel.innerHTML = '<option value="fixed">固定</option><option value="variable">變動</option>';
          const allocSel = document.createElement('select'); allocSel.innerHTML = '<option value="per_employee">按員工數</option><option value="per_hour">按工時</option><option value="per_revenue">按收入</option>';
          const descInput = document.createElement('input'); descInput.type = 'text'; descInput.placeholder = '描述（可留空）';
          
          // 自動生成設定
          const divider = document.createElement('div'); 
          divider.style.borderTop = '1px solid #e5e7eb'; 
          divider.style.margin = '16px 0 12px 0';
          const sectionTitle = document.createElement('div');
          sectionTitle.style.fontSize = '14px';
          sectionTitle.style.fontWeight = '600';
          sectionTitle.style.marginBottom = '12px';
          sectionTitle.style.color = '#374151';
          sectionTitle.textContent = '自動生成設定';
          const enableChk = document.createElement('input'); enableChk.type='checkbox'; enableChk.id='tplEnableNew';
          const enableLbl = document.createElement('label'); enableLbl.htmlFor='tplEnableNew'; enableLbl.textContent='啟用每月自動生成'; enableLbl.style.marginLeft='6px';
          const enWrap = document.createElement('div'); enWrap.appendChild(enableChk); enWrap.appendChild(enableLbl); enWrap.style.marginBottom='8px';
          const amountInput = document.createElement('input'); amountInput.type='number'; amountInput.placeholder='預設金額'; amountInput.min='1';
          const effInput = document.createElement('input'); effInput.type='month';
          
          form.appendChild(buildField('成本名稱', nameInput));
          form.appendChild(buildField('類別', catSel));
          form.appendChild(buildField('分攤方式', allocSel));
          form.appendChild(buildField('描述', descInput));
          form.appendChild(divider);
          form.appendChild(sectionTitle);
          form.appendChild(enWrap);
          form.appendChild(buildField('預設金額', amountInput));
          form.appendChild(buildField('生效起始月', effInput));
          
          openModal('新增成本項目', form, async (close)=>{
            const name = nameInput.value.trim();
            const category = catSel.value;
            const allocationMethod = allocSel.value;
            const description = descInput.value.trim();
            if (!name) { alert('請輸入成本名稱'); return; }
            try {
              const res = await fetch(`${apiBase}/admin/overhead-types`, {
                method: 'POST', credentials: 'include', headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ cost_name: name, category, allocation_method: allocationMethod, description })
              });
              const json = await res.json().catch(()=>({}));
              if (!res.ok || !json || json.ok !== true) { alert(json?.message||'建立失敗'); return; }
              
              // 若勾選自動生成，建立模板
              const costTypeId = json.data?.id;
              if (enableChk.checked && costTypeId) {
                const is_active = true;
                const amount = Number(amountInput.value||0);
                const efv = String(effInput.value||'');
                const tplBody = { is_active };
                if (amount>0) tplBody.amount = amount;
                if (/^\d{4}-\d{2}$/.test(efv)) tplBody.effective_from = efv;
                try {
                  await fetch(`${apiBase}/admin/overhead-templates/by-type/${costTypeId}`, { 
                    method:'PUT', 
                    credentials:'include', 
                    headers:{'content-type':'application/json'}, 
                    body: JSON.stringify(tplBody) 
                  });
                } catch (err) {
                  console.error('建立模板失敗:', err);
                }
              }
              
              // 先刷新数据
              if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
              await loadItems();
              
              // 再关闭对话框
              close();
            } catch (err) {
              console.error('新增項目失敗:', err);
              alert('新增失敗：' + (err?.message || String(err)));
            }
          });
        }

        async function openAddRecordModal(){
          const ym = parseYearMonth();
          if (!ym) { alert('請先選擇有效月份'); return; }
          const typesRes = await fetch(`${apiBase}/admin/overhead-types?is_active=1&perPage=200&_t=${Date.now()}`, { credentials:'include', cache: 'no-store' });
          if (typesRes.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
          const typesJson = await typesRes.json();
          const types = (typesJson?.data)||[];
          if (!Array.isArray(types) || types.length === 0) { alert('尚無啟用的成本項目，請先建立'); return; }
          const form = document.createElement('div');
          const monthSel = document.createElement('input'); monthSel.type = 'month'; monthSel.value = `${String(ym.year)}-${String(ym.month).padStart(2,'0')}`;
          const typeSel = document.createElement('select');
          typeSel.innerHTML = types.map(t => `<option value="${t.id}">${t.name}（${t.category==='fixed'?'固定':'變動'}）</option>`).join('');
          const amtInput = document.createElement('input'); amtInput.type = 'number'; amtInput.placeholder = '請輸入金額'; amtInput.min = '1';
          const notesInput = document.createElement('input'); notesInput.type = 'text'; notesInput.placeholder = '備註（可留空）';
          form.appendChild(buildField('月份', monthSel));
          form.appendChild(buildField('成本項目', typeSel));
          form.appendChild(buildField('金額', amtInput));
          form.appendChild(buildField('備註', notesInput));
          openModal('新增月度記錄', form, async (close)=>{
            const cost_type_id = parseInt(typeSel.value, 10);
            const amount = Number(amtInput.value);
            const notes = notesInput.value.trim();
            if (!Number.isFinite(amount) || amount <= 0) { alert('金額無效'); return; }
            const mVal = String(monthSel.value||'');
            const mMatch = mVal.match(/^(\d{4})-(\d{2})$/);
            if (!mMatch) { alert('月份無效'); return; }
            const y = parseInt(mMatch[1], 10); const m = parseInt(mMatch[2], 10);
            try {
              const res = await fetch(`${apiBase}/admin/overhead-costs`, {
                method: 'POST', credentials: 'include', headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ cost_type_id, year: y, month: m, amount, notes })
              });
              const json = await res.json().catch(()=>({}));
              if (!res.ok || !json || json.ok !== true) { alert(json?.message||'建立失敗'); return; }
              
              // 先刷新数据
              if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
              await loadRecords();
              
              // 再关闭对话框
              close();
            } catch (err) {
              console.error('新增記錄失敗:', err);
              alert('新增失敗：' + (err?.message || String(err)));
            }
          });
        }

        document.getElementById('btn-add-item')?.addEventListener('click', openAddTypeModal);
        document.getElementById('btn-add-record')?.addEventListener('click', openAddRecordModal);
        document.getElementById('btn-generate-month')?.addEventListener('click', generateCurrentMonth);

        // 一鍵生成：按模板生成本月記錄
        async function generateCurrentMonth(){
          const ym = parseYearMonth();
          if (!ym) { alert('請先選擇有效月份'); return; }
          try {
            // 先預覽
            const prevRes = await fetch(`${apiBase}/admin/overhead-costs/generate/preview?year=${ym.year}&month=${ym.month}&_t=${Date.now()}`, { credentials:'include', cache: 'no-store' });
            const prevJson = await prevRes.json();
            if (!prevRes.ok || !prevJson || prevJson.ok !== true) throw new Error(prevJson?.message||'預覽失敗');
            const items = (prevJson.data?.items)||[];
            if (items.length === 0) { alert('沒有可生成的項目'); return; }
            // 彈窗勾選
            const form = document.createElement('div');
            const list = document.createElement('div');
            list.style.maxHeight = '50vh'; list.style.overflow='auto'; list.style.border='1px solid #e5e7eb'; list.style.borderRadius='8px'; list.style.padding='8px';
            items.forEach(it => {
              const row = document.createElement('label');
              row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px 4px';
              const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !it.alreadyExists; cb.value = String(it.templateId);
              const span = document.createElement('span'); span.textContent = `${it.costName}：${formatCurrency(it.amount)}${it.alreadyExists?'（本月已存在）':''}`;
              row.appendChild(cb); row.appendChild(span); list.appendChild(row);
            });
            form.appendChild(list);
            openModal('本月自動生成（預覽）', form, async (close)=>{
              const selected = Array.from(list.querySelectorAll('input[type="checkbox"]')).filter(x=>x.checked).map(x=>parseInt(x.value,10));
              if (selected.length === 0) { alert('請至少勾選一項'); return; }
              try {
                console.log('[Generate] 開始生成，年月:', ym, '模板ID:', selected);
                const res = await fetch(`${apiBase}/admin/overhead-costs/generate?year=${ym.year}&month=${ym.month}` , { method:'POST', credentials:'include', headers:{'content-type':'application/json'}, body: JSON.stringify({ template_ids: selected }) });
                const json = await res.json().catch(()=>({}));
                console.log('[Generate] API 回應:', json);
                if (!res.ok || !json || json.ok !== true) { 
                  alert(json?.message||'自動生成失敗'); 
                  return; 
                }
                
                console.log('[Generate] 生成成功，創建了', json.data?.created, '筆記錄');
                console.log('[Generate] 重複:', json.data?.duplicates, '已跳過:', json.data?.skipped);
                console.log('[Generate] 生成的記錄詳情:', json.data?.records);
                
                const created = json.data?.created || 0;
                const duplicates = json.data?.duplicates || 0;
                const skipped = json.data?.skipped || 0;
                
                if (created === 0 && duplicates > 0) {
                  alert(`本月記錄已存在（${duplicates} 筆），無需重複生成`);
                  close();
                  return;
                }
                
                if (created === 0 && skipped > 0) {
                  alert(`所選模板不符合本月生成條件（已跳過 ${skipped} 筆）`);
                  close();
                  return;
                }
                
                if (created === 0) {
                  alert('未生成任何記錄，請檢查模板設定');
                  close();
                  return;
                }
                
                // 1. 先使缓存失效
                if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
                
                // 2. 延迟一下再刷新（等待数据库提交）
                console.log('[Generate] 等待 500ms 後刷新...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 3. 等待数据刷新完成
                console.log('[Generate] 開始刷新記錄列表...');
                await loadRecords();
                console.log('[Generate] 記錄列表刷新完成');
                
                // 4. 关闭对话框
                close();
                
                // 5. 显示成功消息
                let message = `已自動生成 ${created} 筆記錄`;
                if (duplicates > 0) message += `（${duplicates} 筆已存在）`;
                if (skipped > 0) message += `（${skipped} 筆已跳過）`;
                alert(message);
              } catch (err) {
                console.error('生成失敗:', err);
                alert('自動生成失敗：' + (err?.message || String(err)));
              }
            });
          } catch (err) {
            alert('自動生成失敗：' + (err?.message||String(err)));
          }
        }

        // 初始化月份选择器为当前月份
        function initMonthSelector() {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const value = `${year}-${month}`;
          
          // 初始化所有三个月份选择器
          if (monthInput) {
            monthInput.value = value;
          } else {
            console.error('[initMonthSelector] monthInput 不存在！');
          }
          
          if (monthInputEmp) {
            monthInputEmp.value = value;
          } else {
            console.error('[initMonthSelector] monthInputEmp 不存在！');
          }
          
          if (monthInputClient) {
            monthInputClient.value = value;
          } else {
            console.error('[initMonthSelector] monthInputClient 不存在！');
          }
          
          console.log('[initMonthSelector] 已設置所有月份選擇器:', value);
        }

        // 更新按钮状态
        function updateButtonState() {
          const ym = parseYearMonth();
          const isValid = !!ym;
          document.getElementById('btn-generate-month').disabled = !isValid;
          document.getElementById('btn-add-record').disabled = !isValid;
          console.log('[updateButtonState] 月份有效:', isValid, '值:', monthInput?.value);
        }

        // 监听月份变化（已在上面统一设置）

        // ⚡ 清除 costs 页面的预渲染缓存（排查问题）
        if (window.PagePrerender && window.PagePrerender.clear) {
          window.PagePrerender.clear('costs');
          console.log('[Init] 已清除 costs 預渲染緩存');
        }
        
        // ⚡ 预渲染初始化（暂时禁用以排查问题）
        // if (window.PagePrerender) {
        //   window.PagePrerender.init('main');
        // }

        // 初始化
        console.log('[Init] 開始初始化成本頁面...');
        ensureAdmin().then(ok => { 
          if (ok) {
            console.log('[Init] 權限驗證通過，開始加載頁面...');
            // 1. 初始化月份
            initMonthSelector();
            // 2. 加载数据
            loadItems(); 
            loadRecords();
            // 3. 更新按钮状态
            updateButtonState();
            // ⚡ 自动保存预渲染（暂时禁用）
            // if (window.PagePrerender) {
            //   setTimeout(() => window.PagePrerender.autoSave('main', 2000), 1000);
            // }
          } else {
            console.warn('[Init] 權限驗證失敗');
          }
        }).catch(err => {
          console.error('[Init] 初始化失敗:', err);
        });
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>



