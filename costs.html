<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="ç®¡ç†æˆæœ¬" />
    <title>ç®¡ç†æˆæœ¬ï½œè¨­å®šèˆ‡åˆ†æ</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/costs-page.css" />
    
    <!-- âš¡ é¢„åŠ è½½ä¸ç¼“å­˜ç³»ç»Ÿ -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <script src="/assets/js/prerender.js"></script>
    <script src="/assets/js/page-prerender.js"></script>
    <script src="/assets/js/tab-cache.js"></script>
  </head>
  <body class="costs-page">
    <div style="padding:16px 20px;">
      <div id="infoBar" class="info-bar" style="display:none;" role="alert">æ‚¨æ²’æœ‰æ¬Šé™å­˜å–æ­¤æ¨¡çµ„</div>
      <div class="costs-toolbar" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
        <div class="toolbar-spacer" style="flex:1;"></div>
      </div>
      <nav class="costs-tabs" role="tablist" aria-label="ç®¡ç†æˆæœ¬åˆ†é " style="display:flex;gap:8px;border-bottom:2px solid #e5e7eb;">
        <button class="tab active" role="tab" aria-selected="true" data-tab="items">æˆæœ¬é …ç›®è¨­å®š</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="employee">å“¡å·¥æˆæœ¬åˆ†æ</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="client">å®¢æˆ¶ä»»å‹™æˆæœ¬</button>
      </nav>
    </div>

    <main class="costs-content">
      <!-- æˆæœ¬é …ç›®è¨­å®š -->
      <section id="panel-items" class="panel show" role="tabpanel" aria-labelledby="tab-items">
        <div class="card">
          <div class="section-toolbar">
            <div class="toolbar-spacer"></div>
            <button id="btn-add-item" type="button" class="btn primary" disabled>æ–°å¢é …ç›®</button>
          </div>
          <table class="table" aria-label="æˆæœ¬é …ç›®åˆ—è¡¨">
            <thead>
              <tr>
                <th>æˆæœ¬åç¨±</th>
                <th>é¡åˆ¥</th>
                <th>åˆ†æ”¤æ–¹å¼</th>
                <th>æè¿°</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbody-items">
              <tr><td colspan="6" class="muted">å°šç„¡è³‡æ–™</td></tr>
            </tbody>
          </table>
        </div>
        
        <div class="card" style="margin-top: 16px;">
          <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">æœˆåº¦ç®¡ç†è²»ç”¨è¨˜éŒ„</h3>
          <div class="section-toolbar">
            <label for="month">æœˆä»½</label>
            <input id="month" type="month" aria-label="æœˆä»½" />
            <div class="toolbar-spacer"></div>
            <button id="btn-generate-month" type="button" class="btn" disabled>æœ¬æœˆè‡ªå‹•ç”Ÿæˆ</button>
            <button id="btn-add-record" type="button" class="btn primary" disabled>æ–°å¢è¨˜éŒ„</button>
          </div>
          <div class="stats-cards">
            <div class="stat">
              <div class="stat-label">æœ¬æœˆç¸½ç®¡ç†è²»ç”¨</div>
              <div class="stat-value" id="stat-total">â€”</div>
              <div class="stat-meta muted" id="stat-breakdown">å›ºå®šï¼šâ€”ï½œè®Šå‹•ï¼šâ€”</div>
            </div>
          </div>
          <table class="table" aria-label="æœˆåº¦ç®¡ç†è²»ç”¨è¨˜éŒ„">
            <thead>
              <tr>
                <th>é …ç›®åç¨±</th>
                <th>é‡‘é¡</th>
                <th>å‚™è¨»</th>
                <th>éŒ„å…¥äºº</th>
                <th>éŒ„å…¥æ™‚é–“</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbody-records">
              <tr><td colspan="6" class="muted">å°šç„¡è³‡æ–™</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- å“¡å·¥æˆæœ¬åˆ†æ -->
      <section id="panel-employee" class="panel" role="tabpanel" aria-labelledby="tab-employee">
        <div class="card">
          <div class="section-toolbar">
            <label for="month-emp">æœˆä»½</label>
            <input id="month-emp" type="month" aria-label="å“¡å·¥æˆæœ¬æœˆä»½" />
            <div class="toolbar-spacer"></div>
            <button type="button" class="btn" id="btn-refresh-emp" disabled>åˆ·æ–°</button>
          </div>
          <div class="info-box" style="margin-bottom: 12px; padding: 10px 12px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; font-size: 14px; color: #1e40af;">
            <strong>è¨ˆç®—èªªæ˜ï¼ˆå®Œå…¨æˆæœ¬æ³•ï¼‰ï¼š</strong><br>
            â€¢ <strong>è–ªè³‡æˆæœ¬</strong> = æ‡‰ç™¼å·¥è³‡ï¼ˆåº•è–ª + å›ºå®šæ´¥è²¼ + éå›ºå®šæ´¥è²¼ + å›ºå®šçé‡‘ + ç¸¾æ•ˆçé‡‘ + å¹´çµ‚çé‡‘ + åŠ ç­è²» + ä¼™é£Ÿæ´¥è²¼ + äº¤é€šè£œè²¼ï¼‰<br>
            â€¢ <strong>åˆ†æ”¤ç®¡ç†è²»</strong>ï¼šæ ¹æ“šå„æˆæœ¬é …ç›®è¨­å®šçš„åˆ†æ”¤æ–¹å¼ï¼ˆæŒ‰å“¡å·¥æ•¸/æŒ‰å·¥æ™‚/æŒ‰ç‡Ÿæ”¶ï¼‰è¨ˆç®—<br>
            â€¢ <strong>ç¸½æˆæœ¬</strong> = è–ªè³‡æˆæœ¬ + åˆ†æ”¤ç®¡ç†è²»ç”¨<br>
            â€¢ <strong style="color:#0ea5e9;">å¯¦éš›æ™‚è–ª</strong> = ç¸½æˆæœ¬ Ã· å¯¦éš›å·¥æ™‚ï¼ˆå«ç›´æ¥æˆæœ¬+é–“æ¥æˆæœ¬ï¼Œç”¨æ–¼ä»»å‹™æˆæœ¬åˆ†æï¼‰<br>
            <hr style="margin: 8px 0; border: none; border-top: 1px solid #bfdbfe;">
            â€¢ <strong>è£œä¼‘è¦å‰‡</strong>ï¼šåŠ ç­å…ˆå…¨éƒ¨è½‰ç‚ºè£œä¼‘ï¼Œæœ¬æœˆæœªä½¿ç”¨çš„è£œä¼‘æ‰è½‰ç‚ºåŠ ç­è²»<br>
            â€¢ <strong>ç”¢ç”Ÿè£œä¼‘</strong>ï¼šä¸€èˆ¬åŠ ç­ 1:1 ç”¢ç”Ÿè£œä¼‘ï¼›åœ‹å®šå‡æ—¥/ä¾‹å‡æ—¥ï¼ˆ8å°æ™‚å…§ï¼‰ç”¢ç”Ÿ8å°æ™‚è£œä¼‘ä¸¦æ”¯ä»˜é›™å€å·¥è³‡ï¼Œè¶…é8å°æ™‚éƒ¨åˆ†æŒ‰å¹³æ—¥åŠ ç­å€ç‡<br>
            â€¢ <strong>æœªä½¿ç”¨è£œä¼‘</strong> = æœ¬æœˆç”¢ç”Ÿè£œä¼‘ - æœ¬æœˆä½¿ç”¨è£œä¼‘
          </div>
          <table class="table" aria-label="å“¡å·¥æˆæœ¬åˆ—è¡¨">
            <thead>
              <tr>
                <th>å§“å</th>
                <th>åº•è–ª</th>
                <th>æœ¬æœˆå·¥æ™‚</th>
                <th>ç”¢ç”Ÿè£œä¼‘</th>
                <th>ä½¿ç”¨è£œä¼‘</th>
                <th>æœªä½¿ç”¨è£œä¼‘</th>
                <th>è£œä¼‘è½‰åŠ ç­è²»</th>
                <th>è–ªè³‡æˆæœ¬</th>
                <th>åˆ†æ”¤ç®¡ç†è²»</th>
                <th>æœ¬æœˆç¸½æˆæœ¬</th>
                <th>å¯¦éš›æ™‚è–ª</th>
              </tr>
            </thead>
            <tbody id="tbody-employee">
              <tr><td colspan="11" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>
            </tbody>
          </table>
          <div class="summary-row" style="margin-top: 12px; padding: 12px; background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; font-weight: 600;">
              <span>æœ¬æœˆç¸½è¨ˆï¼š</span>
              <span id="emp-total-cost">â€”</span>
            </div>
          </div>
        </div>
      </section>

      <!-- å®¢æˆ¶ä»»å‹™æˆæœ¬ -->
      <section id="panel-client" class="panel" role="tabpanel" aria-labelledby="tab-client">
        <div class="card">
          <div class="section-toolbar">
            <label for="month-client">æœˆä»½</label>
            <input id="month-client" type="month" aria-label="å®¢æˆ¶æˆæœ¬æœˆä»½" />
            <select id="viewType">
              <option value="client">æŒ‰å®¢æˆ¶å½™ç¸½</option>
              <option value="task">æŒ‰ä»»å‹™æ˜ç´°</option>
            </select>
            <div class="toolbar-spacer"></div>
            <button type="button" class="btn" id="btn-refresh-client" disabled>åˆ·æ–°</button>
          </div>
          
          <div id="client-view">
            <div class="info-box" style="margin-bottom: 12px; padding: 10px 12px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; font-size: 14px; color: #1e40af;">
              <strong>è¨ˆç®—èªªæ˜ï¼š</strong><br>
              â€¢ <strong>å®¢æˆ¶ç¸½æˆæœ¬</strong> = Î£(æ¯ä½å“¡å·¥åœ¨è©²å®¢æˆ¶çš„åŠ æ¬Šå·¥æ™‚ Ã— è©²å“¡å·¥çš„å¯¦éš›æ™‚è–ª)<br>
              â€¢ <strong>å¯¦éš›æ™‚è–ª</strong>ï¼šå·²åŒ…å«è–ªè³‡æˆæœ¬ + ç®¡ç†è²»åˆ†æ”¤ï¼ˆèˆ‡å“¡å·¥æˆæœ¬åˆ†æä¸€è‡´ï¼‰<br>
              â€¢ <strong>åˆ©æ½¤</strong> = æœ¬æœˆæ”¶å…¥ - ç¸½æˆæœ¬<br>
              â€¢ <strong>åˆ©æ½¤ç‡</strong> = åˆ©æ½¤ Ã· æœ¬æœˆæ”¶å…¥ Ã— 100%<br>
              â€¢ ğŸ’¡ é»æ“Šå®¢æˆ¶åç¨±å¯å±•é–‹/æ”¶èµ·å“¡å·¥æ˜ç´°
            </div>
            <table class="table" aria-label="å®¢æˆ¶æˆæœ¬å½™ç¸½">
              <thead>
                <tr>
                  <th>å®¢æˆ¶åç¨±</th>
                  <th>ç¸½å·¥æ™‚</th>
                  <th>åŠ æ¬Šå·¥æ™‚</th>
                  <th>å¹³å‡æ™‚è–ª</th>
                  <th>ç¸½æˆæœ¬</th>
                  <th>æœ¬æœˆæ”¶å…¥</th>
                  <th>åˆ©æ½¤</th>
                  <th>åˆ©æ½¤ç‡</th>
                </tr>
              </thead>
              <tbody id="tbody-clients">
                <tr><td colspan="8" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>
              </tbody>
            </table>
          </div>

          <div id="task-view" style="display: none;">
            <div class="info-box" style="margin-bottom: 12px; padding: 10px 12px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; font-size: 14px; color: #1e40af;">
              <strong>è¨ˆç®—èªªæ˜ï¼š</strong><br>
              â€¢ <strong>å¯¦éš›æ™‚è–ª</strong>ï¼šå·²åŒ…å«è–ªè³‡æˆæœ¬ + ç®¡ç†è²»åˆ†æ”¤ï¼ˆèˆ‡å“¡å·¥æˆæœ¬åˆ†æä¸€è‡´ï¼‰<br>
              â€¢ <strong>ç¸½æˆæœ¬</strong> = åŠ æ¬Šå·¥æ™‚ Ã— å¯¦éš›æ™‚è–ª
            </div>
            <table class="table" aria-label="ä»»å‹™æˆæœ¬æ˜ç´°">
              <thead>
                <tr>
                  <th>å®¢æˆ¶åç¨±</th>
                  <th>æœå‹™é …ç›®</th>
                  <th>ä»»å‹™æ¨™é¡Œ</th>
                  <th>è² è²¬äºº</th>
                  <th>å·¥æ™‚</th>
                  <th>åŠ æ¬Šå·¥æ™‚</th>
                  <th>å¯¦éš›æ™‚è–ª</th>
                  <th>ç¸½æˆæœ¬</th>
                </tr>
              </thead>
              <tbody id="tbody-tasks">
                <tr><td colspan="8" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>
              </tbody>
            </table>
          </div>

          <div class="summary-row" style="margin-top: 12px; padding: 12px; background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
              <div>
                <div style="font-size: 12px; color: #64748b;">ç¸½æˆæœ¬</div>
                <div style="font-size: 18px; font-weight: 600;" id="client-total-cost">â€”</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #64748b;">ç¸½æ”¶å…¥</div>
                <div style="font-size: 18px; font-weight: 600;" id="client-total-revenue">â€”</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #64748b;">ç¸½åˆ©æ½¤</div>
                <div style="font-size: 18px; font-weight: 600;" id="client-total-profit">â€”</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #64748b;">å¹³å‡åˆ©æ½¤ç‡</div>
                <div style="font-size: 18px; font-weight: 600;" id="client-avg-margin">â€”</div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const infoBar = document.getElementById('infoBar');
        const tabs = Array.from(document.querySelectorAll('.costs-tabs .tab'));
        const panels = {
          items: document.getElementById('panel-items'),
          employee: document.getElementById('panel-employee'),
          client: document.getElementById('panel-client'),
        };

        const monthInput = document.getElementById('month');
        const monthInputEmp = document.getElementById('month-emp');
        const monthInputClient = document.getElementById('month-client');

        // æˆæœ¬é …ç›®è¨­å®š
        const tbodyItems = document.getElementById('tbody-items');

        // æœˆåº¦ç®¡ç†è²»ç”¨è¨˜éŒ„
        const tbodyRecords = document.getElementById('tbody-records');
        const statTotal = document.getElementById('stat-total');
        const statBreakdown = document.getElementById('stat-breakdown');

        // å“¡å·¥æˆæœ¬åˆ†æ
        const tbodyEmployee = document.getElementById('tbody-employee');
        const empTotalCost = document.getElementById('emp-total-cost');

        // å®¢æˆ¶ä»»å‹™æˆæœ¬
        const viewType = document.getElementById('viewType');
        const clientView = document.getElementById('client-view');
        const taskView = document.getElementById('task-view');
        const tbodyClients = document.getElementById('tbody-clients');
        const tbodyTasks = document.getElementById('tbody-tasks');

        function setTabsEnabled(enabled){
          tabs.forEach(b=>{ b.disabled = !enabled; });
          document.querySelectorAll('.costs-toolbar .btn, .section-toolbar input, .section-toolbar select, .section-toolbar button').forEach(el=>{ el.disabled = !enabled; });
        }

        // âš¡ Tab ç¼“å­˜ç³»ç»Ÿåˆå§‹åŒ–
        let currentCostsTab = 'items';
        if (window.TabCache) {
          window.TabCache.init(['items', 'employee', 'client']);
        }

        tabs.forEach(btn => {
          btn.addEventListener('click', ()=>{
            const key = btn.getAttribute('data-tab');
            
            // âš¡ æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
            const shouldLoad = window.TabCache ? window.TabCache.shouldLoad(currentCostsTab, key) : true;
            currentCostsTab = key;
            
            tabs.forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            Object.entries(panels).forEach(([k,el])=>{
              if (k === key) el.classList.add('show'); else el.classList.remove('show');
            });
            
            // âš¡ åªåœ¨éœ€è¦æ—¶è½½å…¥å¯¹åº”èµ„æ–™
            if (shouldLoad) {
              if (key === 'employee') loadEmployeeCosts();
              if (key === 'client') loadClientCosts();
              
              // âš¡ æ ‡è®°ä¸ºå·²åŠ è½½
              if (window.TabCache) {
                window.TabCache.markLoaded(key);
              }
            }
          });
        });

        function parseYearMonth(){
          // æ ¹æ®å½“å‰æ ‡ç­¾é¡µé€‰æ‹©å¯¹åº”çš„æœˆä»½è¾“å…¥æ¡†
          let input;
          if (currentCostsTab === 'employee') {
            input = monthInputEmp;
          } else if (currentCostsTab === 'client') {
            input = monthInputClient;
          } else {
            input = monthInput;
          }
          
          const v = String(input?.value || '');
          const m = v.match(/^(\d{4})-(\d{2})$/);
          if (!m) return null;
          const year = parseInt(m[1], 10);
          const month = parseInt(m[2], 10);
          if (!Number.isFinite(year) || !Number.isFinite(month) || month < 1 || month > 12) return null;
          return { year, month };
        }

        function formatCurrency(val){
          return 'NT$ ' + Number(val || 0).toLocaleString();
        }

        // ============ æˆæœ¬é …ç›®è¨­å®š ============
        async function loadItems(){
          const params = new URLSearchParams();
          params.set('_t', String(Date.now())); // å¼ºåˆ¶ç»•è¿‡ç¼“å­˜
          try {
            console.log('[loadItems] é–‹å§‹åŠ è¼‰æˆæœ¬é …ç›®...');
            tbodyItems.innerHTML = '<tr><td colspan="6" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>';
            const res = await fetch(`${apiBase}/admin/overhead-types?${params.toString()}`, { credentials:'include', cache: 'no-store' });
            console.log('[loadItems] API å›æ‡‰ç‹€æ…‹:', res.status);
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            const json = await res.json();
            console.log('[loadItems] æ”¶åˆ°æ•¸æ“š:', json);
            if (!res.ok || !json || json.ok !== true) throw new Error('API è¿”å›éŒ¯èª¤');
            const items = json.data || [];
            console.log('[loadItems] é …ç›®æ•¸é‡:', items.length);
            if (items.length === 0) {
              tbodyItems.innerHTML = '<tr><td colspan="6" class="muted">å°šç„¡è³‡æ–™</td></tr>';
              return;
            }
            tbodyItems.innerHTML = '';
            items.forEach((item, index) => {
              try {
                console.log(`[loadItems] æ¸²æŸ“é …ç›® ${index}:`, item);
                const tr = document.createElement('tr');
                const allocationText = { per_employee: 'æŒ‰å“¡å·¥æ•¸', per_hour: 'æŒ‰å·¥æ™‚', per_revenue: 'æŒ‰æ”¶å…¥' }[item.allocationMethod] || item.allocationMethod;
                tr.innerHTML = `
                  <td>${item.name||''}</td>
                  <td>${item.category === 'fixed' ? 'å›ºå®š' : 'è®Šå‹•'}</td>
                  <td>${allocationText}</td>
                  <td>${item.description||''}</td>
                  <td>${item.isActive ? 'å•Ÿç”¨' : 'åœç”¨'}</td>
                  <td>
                    <button class="btn-link" data-edit-item-id="${item.id}">ç·¨è¼¯</button>
                    <button class="btn-link" data-template-id="${item.id}">è‡ªå‹•ç”Ÿæˆ</button>
                    <button class="btn-link" style="color:#dc2626;" data-delete-id="${item.id}">åˆªé™¤</button>
                  </td>
                `;
                tbodyItems.appendChild(tr);
              } catch (itemErr) {
                console.error(`[loadItems] æ¸²æŸ“é …ç›® ${index} å¤±æ•—:`, itemErr, item);
              }
            });
            console.log('[loadItems] æ¸²æŸ“å®Œæˆï¼Œå·²æ·»åŠ ', items.length, 'å€‹é …ç›®');
            // ç¶å®šç·¨è¼¯æˆæœ¬é …ç›®
            tbodyItems.querySelectorAll('button[data-edit-item-id]').forEach(btn => {
              btn.addEventListener('click', ()=> {
                const id = parseInt(btn.getAttribute('data-edit-item-id'),10);
                const item = items.find(x => x.id === id);
                openEditItemModal(item);
              });
            });
            // ç¶å®šè‡ªå‹•ç”Ÿæˆè¨­å®š
            tbodyItems.querySelectorAll('button[data-template-id]').forEach(btn => {
              btn.addEventListener('click', ()=> openEditTemplateModal(parseInt(btn.getAttribute('data-template-id'),10)) );
            });
            // ç¶å®šåˆªé™¤
            tbodyItems.querySelectorAll('button[data-delete-id]').forEach(btn => {
              btn.addEventListener('click', async ()=> {
                const id = parseInt(btn.getAttribute('data-delete-id'),10);
                if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æˆæœ¬é …ç›®å—ï¼Ÿ')) return;
                try {
                  const res = await fetch(`${apiBase}/admin/overhead-types/${id}`, { method: 'DELETE', credentials:'include' });
                  const json = await res.json().catch(()=>({}));
                  if (!res.ok || !json || json.ok !== true) { alert(json?.message||'åˆªé™¤å¤±æ•—'); return; }
                  // åˆ·æ–°æ•°æ®
                  if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
                  await loadItems();
                } catch (err) {
                  alert('åˆªé™¤å¤±æ•—ï¼š' + String(err));
                }
              });
            });
          } catch (err) {
            console.error('[loadItems] è¼‰å…¥å¤±æ•—:', err);
            tbodyItems.innerHTML = '<tr><td colspan="6" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</td></tr>';
          }
        }
        async function openEditItemModal(item){
          const form = document.createElement('div');
          const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.value = item.name||'';
          const catSel = document.createElement('select'); 
          catSel.innerHTML = '<option value="fixed">å›ºå®š</option><option value="variable">è®Šå‹•</option>';
          catSel.value = item.category;
          const allocSel = document.createElement('select'); 
          allocSel.innerHTML = '<option value="per_employee">æŒ‰å“¡å·¥æ•¸</option><option value="per_hour">æŒ‰å·¥æ™‚</option><option value="per_revenue">æŒ‰æ”¶å…¥</option>';
          allocSel.value = item.allocationMethod;
          const descInput = document.createElement('input'); descInput.type = 'text'; descInput.value = item.description||'';
          const activeChk = document.createElement('input'); activeChk.type='checkbox'; activeChk.id='editActive'; activeChk.checked = item.isActive;
          const activeLbl = document.createElement('label'); activeLbl.htmlFor='editActive'; activeLbl.textContent='å•Ÿç”¨'; activeLbl.style.marginLeft='6px';
          const activeWrap = document.createElement('div'); activeWrap.style.marginTop='10px'; activeWrap.appendChild(activeChk); activeWrap.appendChild(activeLbl);
          
          form.appendChild(buildField('æˆæœ¬åç¨±', nameInput));
          form.appendChild(buildField('é¡åˆ¥', catSel));
          form.appendChild(buildField('åˆ†æ”¤æ–¹å¼', allocSel));
          form.appendChild(buildField('æè¿°', descInput));
          form.appendChild(activeWrap);
          
          openModal('ç·¨è¼¯æˆæœ¬é …ç›®', form, async (close)=>{
            const name = nameInput.value.trim();
            const category = catSel.value;
            const allocationMethod = allocSel.value;
            const description = descInput.value.trim();
            const isActive = activeChk.checked ? 1 : 0;
            if (!name) { alert('è«‹è¼¸å…¥æˆæœ¬åç¨±'); return; }
            try {
              const res = await fetch(`${apiBase}/admin/overhead-types/${item.id}`, {
                method: 'PUT', credentials: 'include', headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ cost_name: name, category, allocation_method: allocationMethod, description, is_active: isActive })
              });
              const json = await res.json().catch(()=>({}));
              if (!res.ok || !json || json.ok !== true) { alert(json?.message||'æ›´æ–°å¤±æ•—'); return; }
              
              // å…ˆåˆ·æ–°æ•°æ®
              if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
              await loadItems();
              
              // å†å…³é—­å¯¹è¯æ¡†
              close();
            } catch (err) {
              console.error('æ›´æ–°é …ç›®å¤±æ•—:', err);
              alert('æ›´æ–°å¤±æ•—ï¼š' + (err?.message || String(err)));
            }
          });
        }
        
        async function openEditRecordModal(record){
          const form = document.createElement('div');
          const amountInput = document.createElement('input'); amountInput.type = 'number'; amountInput.value = record.amount||''; amountInput.min = '1';
          const notesInput = document.createElement('input'); notesInput.type = 'text'; notesInput.value = record.notes||'';
          
          form.appendChild(buildField('é‡‘é¡', amountInput));
          form.appendChild(buildField('å‚™è¨»', notesInput));
          
          openModal('ç·¨è¼¯æœˆåº¦è¨˜éŒ„', form, async (close)=>{
            const amount = Number(amountInput.value);
            const notes = notesInput.value.trim();
            if (!Number.isFinite(amount) || amount <= 0) { alert('é‡‘é¡ç„¡æ•ˆ'); return; }
            try {
              const res = await fetch(`${apiBase}/admin/overhead-costs/${record.id}`, {
                method: 'PUT', credentials: 'include', headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ amount, notes })
              });
              const json = await res.json().catch(()=>({}));
              if (!res.ok || !json || json.ok !== true) { alert(json?.message||'æ›´æ–°å¤±æ•—'); return; }
              
              // å…ˆåˆ·æ–°æ•°æ®
              if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
              await loadRecords();
              
              // å†å…³é—­å¯¹è¯æ¡†
              close();
            } catch (err) {
              console.error('æ›´æ–°è¨˜éŒ„å¤±æ•—:', err);
              alert('æ›´æ–°å¤±æ•—ï¼š' + (err?.message || String(err)));
            }
          });
        }
        
        async function openEditTemplateModal(costTypeId){
          try {
            // è¯»å–ç°æœ‰æ¨¡æ¿æ•°æ®
            console.log('[EditTemplate] åŠ è¼‰æ¨¡æ¿æ•¸æ“šï¼Œcost_type_id:', costTypeId);
            const res = await fetch(`${apiBase}/admin/overhead-templates/by-type/${costTypeId}?_t=${Date.now()}`, { 
              credentials:'include',
              cache: 'no-store'
            });
            let existingTemplate = null;
            if (res.ok) {
              const json = await res.json();
              console.log('[EditTemplate] æ¨¡æ¿æ•¸æ“š:', json);
              if (json.ok && json.data) {
                existingTemplate = json.data;
              }
            } else {
              console.log('[EditTemplate] æ¨¡æ¿ä¸å­˜åœ¨æˆ–åŠ è¼‰å¤±æ•—:', res.status);
            }
            
            const form = document.createElement('div');
            const enableChk = document.createElement('input'); 
            enableChk.type='checkbox'; 
            enableChk.id='tplEnable'; 
            enableChk.checked = existingTemplate ? (existingTemplate.isActive !== false) : true;
            
            const enableLbl = document.createElement('label'); 
            enableLbl.htmlFor='tplEnable'; 
            enableLbl.textContent='å•Ÿç”¨æ¯æœˆè‡ªå‹•ç”Ÿæˆ'; 
            enableLbl.style.marginLeft='6px';
            
            const enWrap = document.createElement('div'); 
            enWrap.appendChild(enableChk); 
            enWrap.appendChild(enableLbl); 
            enWrap.style.marginBottom='8px';
            
            const amountInput = document.createElement('input'); 
            amountInput.type='number'; 
            amountInput.placeholder='é è¨­é‡‘é¡'; 
            amountInput.min='1';
            if (existingTemplate && existingTemplate.amount) {
              amountInput.value = existingTemplate.amount;
            }
            
            const effInput = document.createElement('input'); 
            effInput.type='month';
            if (existingTemplate && existingTemplate.effectiveFrom) {
              effInput.value = existingTemplate.effectiveFrom;
            }
            
            form.appendChild(enWrap);
            form.appendChild(buildField('é è¨­é‡‘é¡', amountInput));
            form.appendChild(buildField('ç”Ÿæ•ˆèµ·å§‹æœˆ', effInput));
          openModal('è‡ªå‹•ç”Ÿæˆè¨­å®š', form, async (close)=>{
            const is_active = enableChk.checked;
            const amount = Number(amountInput.value||0);
            const efv = String(effInput.value||'');
            const body = { is_active };
            if (amount>0) body.amount = amount;
            if (/^\d{4}-\d{2}$/.test(efv)) body.effective_from = efv;
            try {
              const res = await fetch(`${apiBase}/admin/overhead-templates/by-type/${costTypeId}`, { method:'PUT', credentials:'include', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
              const json = await res.json().catch(()=>({}));
              if (!res.ok || !json || json.ok !== true) { alert(json?.message||'å„²å­˜å¤±æ•—'); return; }
              close();
              alert('å·²å„²å­˜');
            } catch (err) {
              console.error('å„²å­˜æ¨¡æ¿å¤±æ•—:', err);
              alert('å„²å­˜å¤±æ•—ï¼š' + (err?.message || String(err)));
            }
          });
          } catch (err) {
            console.error('[EditTemplate] åŠ è¼‰æ¨¡æ¿å¤±æ•—:', err);
            alert('åŠ è¼‰æ¨¡æ¿å¤±æ•—ï¼š' + (err?.message || String(err)));
          }
        }

        async function loadRecords(){
          const ym = parseYearMonth();
          if (!ym) {
            console.warn('[loadRecords] ç„¡æ•ˆæœˆä»½ï¼ŒmonthInput.value:', monthInput?.value);
            tbodyRecords.innerHTML = '<tr><td colspan="6" class="muted">è«‹é¸æ“‡æœˆä»½</td></tr>';
            statTotal.textContent = 'â€”';
            statBreakdown.textContent = 'å›ºå®šï¼šâ€”ï½œè®Šå‹•ï¼šâ€”';
            return;
          }
          console.log('[loadRecords] åŠ è¼‰æ•¸æ“š:', ym);
          const params = new URLSearchParams();
          params.set('year', String(ym.year));
          params.set('month', String(ym.month));
          params.set('_t', String(Date.now())); // å¼ºåˆ¶ç»•è¿‡ç¼“å­˜
          try {
            tbodyRecords.innerHTML = '<tr><td colspan="6" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>';
            const res = await fetch(`${apiBase}/admin/overhead-costs?${params.toString()}`, { credentials:'include', cache: 'no-store' });
            console.log('[loadRecords] API å›æ‡‰ç‹€æ…‹:', res.status);
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            const json = await res.json();
            console.log('[loadRecords] æ”¶åˆ°æ•¸æ“š:', json);
            if (!res.ok || !json || json.ok !== true) throw new Error('API è¿”å›éŒ¯èª¤');
            const data = json.data || {};
            const items = data.items || [];
            console.log('[loadRecords] è¨˜éŒ„æ•¸é‡:', items.length);
            if (items.length === 0) {
              tbodyRecords.innerHTML = '<tr><td colspan="6" class="muted">å°šç„¡è³‡æ–™</td></tr>';
            } else {
              tbodyRecords.innerHTML = '';
              items.forEach((r, index) => {
                try {
                  console.log(`[loadRecords] æ¸²æŸ“è¨˜éŒ„ ${index}:`, r);
                  const tr = document.createElement('tr');
                  tr.innerHTML = `
                    <td>${r.costName||''}</td>
                    <td>${formatCurrency(r.amount)}</td>
                    <td>${r.notes||''}</td>
                    <td>${r.recordedBy||''}</td>
                    <td>${r.recordedAt||''}</td>
                    <td>
                      <button class="btn-link" data-edit-record-id="${r.id}">ç·¨è¼¯</button>
                      <button class="btn-link" style="color:#dc2626;" data-delete-record-id="${r.id}">åˆªé™¤</button>
                    </td>
                  `;
                  tbodyRecords.appendChild(tr);
                } catch (itemErr) {
                  console.error(`[loadRecords] æ¸²æŸ“è¨˜éŒ„ ${index} å¤±æ•—:`, itemErr, r);
                }
              });
              console.log('[loadRecords] æ¸²æŸ“å®Œæˆï¼Œå·²æ·»åŠ ', items.length, 'ç­†è¨˜éŒ„');
              // ç¶å®šç·¨è¼¯æœˆåº¦è¨˜éŒ„
              tbodyRecords.querySelectorAll('button[data-edit-record-id]').forEach(btn => {
                btn.addEventListener('click', ()=> {
                  const id = parseInt(btn.getAttribute('data-edit-record-id'),10);
                  const record = items.find(x => x.id === id);
                  openEditRecordModal(record);
                });
              });
              // ç¶å®šåˆªé™¤æœˆåº¦è¨˜éŒ„
              tbodyRecords.querySelectorAll('button[data-delete-record-id]').forEach(btn => {
                btn.addEventListener('click', async ()=> {
                  const id = parseInt(btn.getAttribute('data-delete-record-id'),10);
                  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨˜éŒ„å—ï¼Ÿ')) return;
                  try {
                    const res = await fetch(`${apiBase}/admin/overhead-costs/${id}`, { method: 'DELETE', credentials:'include' });
                    const json = await res.json().catch(()=>({}));
                    if (!res.ok || !json || json.ok !== true) { alert(json?.message||'åˆªé™¤å¤±æ•—'); return; }
                    // åˆ·æ–°æ•°æ®
                    if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
                    await loadRecords();
                  } catch (err) {
                    alert('åˆªé™¤å¤±æ•—ï¼š' + String(err));
                  }
                });
              });
            }
            const total = Number(data.total||0);
            const totalFixed = Number(data.totalFixed||0);
            const totalVariable = Number(data.totalVariable||0);
            console.log('[loadRecords] çµ±è¨ˆè³‡æ–™:', { total, totalFixed, totalVariable });
            statTotal.textContent = formatCurrency(total);
            statBreakdown.textContent = `å›ºå®šï¼š${formatCurrency(totalFixed)}ï½œè®Šå‹•ï¼š${formatCurrency(totalVariable)}`;
          } catch (err) {
            console.error('[loadRecords] è¼‰å…¥å¤±æ•—:', err);
            tbodyRecords.innerHTML = '<tr><td colspan="6" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</td></tr>';
            statTotal.textContent = 'â€”';
            statBreakdown.textContent = 'å›ºå®šï¼šâ€”ï½œè®Šå‹•ï¼šâ€”';
          }
        }

        // ============ å“¡å·¥æˆæœ¬åˆ†æ ============
        async function loadEmployeeCosts(){
          const ym = parseYearMonth();
          if (!ym) return;
          const params = new URLSearchParams();
          params.set('year', String(ym.year));
          params.set('month', String(ym.month));
          params.set('_t', String(Date.now())); // å¼ºåˆ¶ç»•è¿‡ç¼“å­˜
          try {
            tbodyEmployee.innerHTML = '<tr><td colspan="11" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>';
            const res = await fetch(`${apiBase}/admin/costs/employee?${params.toString()}`, { credentials:'include', cache: 'no-store' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            if (res.status === 501) {
              tbodyEmployee.innerHTML = '<tr><td colspan="11" class="muted">åŠŸèƒ½å°šæœªå¯¦ä½œï¼Œæ•¬è«‹æœŸå¾…</td></tr>';
              empTotalCost.textContent = 'â€”';
              return;
            }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || {};
            const employees = data.employees || [];
            if (employees.length === 0) {
              tbodyEmployee.innerHTML = '<tr><td colspan="11" class="muted">å°šç„¡è³‡æ–™</td></tr>';
              empTotalCost.textContent = formatCurrency(0);
              return;
            }
            tbodyEmployee.innerHTML = '';
            let totalCost = 0;
            employees.forEach(emp => {
              const tr = document.createElement('tr');
              
              const baseSalary = Number(emp.baseSalary || 0);
              const salaryItemsAmount = Number(emp.salaryItemsAmount || 0);
              const expiredCompPay = Number(emp.expiredCompPay || 0);
              const leaveDeduction = Number(emp.leaveDeduction || 0);
              const monthHours = Number(emp.monthHours || 0);
              const totalCompHoursGenerated = Number(emp.totalCompHoursGenerated || 0);
              const totalCompHoursUsed = Number(emp.totalCompHoursUsed || 0);
              const unusedCompHours = Number(emp.unusedCompHours || 0);
              const laborCost = Number(emp.laborCost || 0);
              const overheadAllocation = Number(emp.overheadAllocation || 0);
              const empTotalCost = Number(emp.totalCost || 0);
              const actualHourlyRate = Number(emp.actualHourlyRate || 0);
              
              // è¨ˆç®—èªªæ˜
              const calcDetail = `åº•è–ª ${formatCurrency(baseSalary)} + æ´¥è²¼çé‡‘ ${formatCurrency(salaryItemsAmount)} + è£œä¼‘è½‰åŠ ç­è²» ${formatCurrency(expiredCompPay)}${leaveDeduction > 0 ? ` - è«‹å‡æ‰£æ¬¾ ${formatCurrency(leaveDeduction)}` : ''} = ${formatCurrency(laborCost)}`;
              
              totalCost += empTotalCost;
              tr.innerHTML = `
                <td>${emp.name||''}</td>
                <td>${formatCurrency(baseSalary)}</td>
                <td>${monthHours.toFixed(1)}</td>
                <td>${totalCompHoursGenerated.toFixed(1)}</td>
                <td>${totalCompHoursUsed.toFixed(1)}</td>
                <td style="color:#dc2626;">${unusedCompHours.toFixed(1)}</td>
                <td style="color:#dc2626;">${formatCurrency(expiredCompPay)}</td>
                <td style="font-weight:600;" title="${calcDetail}">${formatCurrency(laborCost)}</td>
                <td>${formatCurrency(overheadAllocation)}</td>
                <td style="font-weight:600;color:#16a34a;">${formatCurrency(empTotalCost)}</td>
                <td style="font-weight:600;color:#0ea5e9;">${formatCurrency(actualHourlyRate)}</td>
              `;
              tbodyEmployee.appendChild(tr);
            });
            empTotalCost.textContent = formatCurrency(totalCost);
          } catch (err) {
            tbodyEmployee.innerHTML = '<tr><td colspan="11" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</td></tr>';
            empTotalCost.textContent = 'â€”';
          }
        }

        // ============ å®¢æˆ¶ä»»å‹™æˆæœ¬ ============
        async function loadClientCosts(){
          const view = viewType.value;
          if (view === 'client') {
            clientView.style.display = 'block';
            taskView.style.display = 'none';
            await loadClientSummary();
          } else {
            clientView.style.display = 'none';
            taskView.style.display = 'block';
            await loadTaskDetails();
          }
        }

        async function loadClientSummary(){
          const ym = parseYearMonth();
          if (!ym) return;
          const params = new URLSearchParams();
          params.set('year', String(ym.year));
          params.set('month', String(ym.month));
          params.set('_t', String(Date.now())); // å¼ºåˆ¶ç»•è¿‡ç¼“å­˜
          try {
            tbodyClients.innerHTML = '<tr><td colspan="8" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>';
            const res = await fetch(`${apiBase}/admin/costs/client?${params.toString()}`, { credentials:'include', cache: 'no-store' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            if (res.status === 501) {
              tbodyClients.innerHTML = '<tr><td colspan="8" class="muted">åŠŸèƒ½å°šæœªå¯¦ä½œï¼Œæ•¬è«‹æœŸå¾…</td></tr>';
              return;
            }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || {};
            const clients = data.clients || [];
            if (clients.length === 0) {
              tbodyClients.innerHTML = '<tr><td colspan="8" class="muted">å°šç„¡è³‡æ–™</td></tr>';
              updateClientSummary(0, 0, 0, 0);
              return;
            }
            tbodyClients.innerHTML = '';
            let totalCost = 0, totalRevenue = 0, totalProfit = 0;
            clients.forEach((client, index) => {
              const cost = Number(client.totalCost || 0);
              const revenue = Number(client.revenue || 0);
              const profit = Number(client.profit || 0);
              const margin = revenue > 0 ? (profit / revenue * 100) : 0;
              const weightedHours = Number(client.weightedHours || 0);
              const avgHourlyRate = Number(client.avgHourlyRate || 0);
              totalCost += cost;
              totalRevenue += revenue;
              totalProfit += profit;
              
              const empList = Array.isArray(client.employeeDetails) ? client.employeeDetails : (client.employees || []);
              const hasEmp = Array.isArray(empList) && empList.length > 0;
              // å®¢æˆ·ä¸»è¡Œï¼ˆå¯ç‚¹å‡»å±•å¼€ï¼‰
              const tr = document.createElement('tr');
              tr.className = 'client-row';
              tr.style.cursor = 'pointer';
              tr.dataset.clientIndex = index;
              tr.innerHTML = `
                <td>
                  <span class="toggle-icon" style="display:inline-block;width:16px;margin-right:4px;">â–¶</span>
                  <strong>${client.clientName||''}</strong>
                </td>
                <td>${Number(client.totalHours||0).toFixed(1)}</td>
                <td>${weightedHours.toFixed(1)}</td>
                <td style="color:#0ea5e9;font-weight:600;">${formatCurrency(avgHourlyRate)}</td>
                <td style="font-weight:600;">${formatCurrency(cost)}</td>
                <td>${formatCurrency(revenue)}</td>
                <td style="color:${profit >= 0 ? '#16a34a' : '#dc2626'};font-weight:600;">${formatCurrency(profit)}</td>
                <td style="font-weight:600;">${margin.toFixed(1)}%</td>
              `;
              tbodyClients.appendChild(tr);
              
              // é å…ˆå»ºç«‹å“¡å·¥æ˜ç´°åˆ—ï¼ˆåˆå§‹éš±è—ï¼‰ï¼Œç¢ºä¿é»æ“Šå¯ç›´æ¥å±•é–‹
              if (hasEmp) {
                empList.forEach(emp => {
                  const empTr = document.createElement('tr');
                  empTr.className = 'employee-detail-row';
                  empTr.dataset.clientIndex = index;
                  empTr.style.display = 'none';
                  empTr.style.backgroundColor = '#f8fafc';
                  empTr.innerHTML = `
                    <td style="padding-left:32px;color:#64748b;">
                      â”” ${emp.userName||'æœªçŸ¥å“¡å·¥'}
                    </td>
                    <td>${Number(emp.hours||0).toFixed(1)}</td>
                    <td>${Number(emp.weightedHours||0).toFixed(1)}</td>
                    <td style="color:#0ea5e9;">${formatCurrency(emp.actualHourlyRate)}</td>
                    <td style="color:#16a34a;">${formatCurrency(emp.totalCost)}</td>
                    <td colspan="3" style="color:#94a3b8;font-size:12px;">åŠ æ¬Šå·¥æ™‚ Ã— å¯¦éš›æ™‚è–ª = ${Number(emp.weightedHours||0).toFixed(1)} Ã— ${formatCurrency(emp.actualHourlyRate)}</td>
                  `;
                  tbodyClients.appendChild(empTr);
                });
              }
              
              // ç»‘å®šç‚¹å‡»äº‹ä»¶
              tr.addEventListener('click', () => {
                let detailRows = tbodyClients.querySelectorAll(`tr.employee-detail-row[data-client-index="${index}"]`);
                // æ‡¶è¼‰å…¥ï¼šè‹¥å°šæœªå»ºç«‹æ˜ç´°åˆ—ä½†æœ‰è³‡æ–™ï¼Œç¾å ´å»ºç«‹
                if ((!detailRows || detailRows.length === 0) && Array.isArray(empList) && empList.length > 0) {
                  empList.forEach(emp => {
                    const empTr = document.createElement('tr');
                    empTr.className = 'employee-detail-row';
                    empTr.dataset.clientIndex = index;
                    empTr.style.display = 'none';
                    empTr.style.backgroundColor = '#f8fafc';
                    empTr.innerHTML = `
                      <td style="padding-left:32px;color:#64748b;">
                        â”” ${emp.userName||'æœªçŸ¥å“¡å·¥'}
                      </td>
                      <td>${Number(emp.hours||0).toFixed(1)}</td>
                      <td>${Number(emp.weightedHours||0).toFixed(1)}</td>
                      <td style="color:#0ea5e9;">${formatCurrency(emp.actualHourlyRate)}</td>
                      <td style="color:#16a34a;">${formatCurrency(emp.totalCost)}</td>
                      <td colspan="3" style="color:#94a3b8;font-size:12px;">åŠ æ¬Šå·¥æ™‚ Ã— å¯¦éš›æ™‚è–ª = ${Number(emp.weightedHours||0).toFixed(1)} Ã— ${formatCurrency(emp.actualHourlyRate)}</td>
                    `;
                    // æ’åœ¨ä¸»è¡Œä¹‹å¾Œ
                    tbodyClients.insertBefore(empTr, tr.nextSibling);
                  });
                  detailRows = tbodyClients.querySelectorAll(`tr.employee-detail-row[data-client-index="${index}"]`);
                }
                if (!detailRows || detailRows.length === 0) return;
                const toggleIcon = tr.querySelector('.toggle-icon');
                const isExpanded = detailRows[0]?.style.display === 'table-row';
                
                detailRows.forEach(row => {
                  row.style.display = isExpanded ? 'none' : 'table-row';
                });
                
                if (toggleIcon) {
                  toggleIcon.textContent = isExpanded ? 'â–¶' : 'â–¼';
                }
              });
            });
            const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0;
            updateClientSummary(totalCost, totalRevenue, totalProfit, avgMargin);
          } catch (_) {
            tbodyClients.innerHTML = '<tr><td colspan="8" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</td></tr>';
          }
        }

        async function loadTaskDetails(){
          const ym = parseYearMonth();
          if (!ym) return;
          const params = new URLSearchParams();
          params.set('year', String(ym.year));
          params.set('month', String(ym.month));
          params.set('_t', String(Date.now())); // å¼ºåˆ¶ç»•è¿‡ç¼“å­˜
          try {
            tbodyTasks.innerHTML = '<tr><td colspan="8" class="muted">è¼‰å…¥ä¸­â€¦</td></tr>';
            const res = await fetch(`${apiBase}/admin/costs/task?${params.toString()}`, { credentials:'include', cache: 'no-store' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            if (res.status === 501) {
              tbodyTasks.innerHTML = '<tr><td colspan="8" class="muted">åŠŸèƒ½å°šæœªå¯¦ä½œï¼Œæ•¬è«‹æœŸå¾…</td></tr>';
              return;
            }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || {};
            const tasks = data.tasks || [];
            if (tasks.length === 0) {
              tbodyTasks.innerHTML = '<tr><td colspan="8" class="muted">å°šç„¡è³‡æ–™</td></tr>';
              return;
            }
            tbodyTasks.innerHTML = '';
            tasks.forEach(task => {
              // å®‰å…¨å›é€€ï¼šè‹¥ API æœªæä¾›æ™‚è–ªï¼Œæ”¹ç”¨ ç¸½æˆæœ¬ Ã· åŠ æ¬Šå·¥æ™‚
              const serviceText = task.serviceName ?? task.service ?? task.service_name_full ?? 'æœªåˆ†é¡';
              const hourlyRaw = (task.avgActualHourlyRate ?? task.avgHourlyRate ?? task.actualHourlyRate);
              let hourly = Number(hourlyRaw);
              if (!Number.isFinite(hourly) || hourly <= 0) {
                const wh = Number(task.weightedHours || 0);
                const tc = Number(task.totalCost || 0);
                hourly = wh > 0 ? Math.round(tc / wh) : 0;
              }
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${task.clientName||''}</td>
                <td>${serviceText}</td>
                <td>${task.taskTitle||''}</td>
                <td>${task.assigneeName||''}</td>
                <td>${Number(task.hours||0).toFixed(1)}</td>
                <td>${Number(task.weightedHours||0).toFixed(1)}</td>
                <td style="color:#0ea5e9;font-weight:600;">${formatCurrency(hourly)}</td>
                <td style="font-weight:600;color:#16a34a;">${formatCurrency(task.totalCost)}</td>
              `;
              tbodyTasks.appendChild(tr);
            });
          } catch (_) {
            tbodyTasks.innerHTML = '<tr><td colspan="8" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</td></tr>';
          }
        }

        function updateClientSummary(cost, revenue, profit, margin){
          document.getElementById('client-total-cost').textContent = formatCurrency(cost);
          document.getElementById('client-total-revenue').textContent = formatCurrency(revenue);
          document.getElementById('client-total-profit').textContent = formatCurrency(profit);
          document.getElementById('client-avg-margin').textContent = margin.toFixed(1) + '%';
        }

        async function ensureAdmin(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return false; }
            const json = await res.json();
            const isAdmin = !!(json && json.ok && json.data && json.data.isAdmin);
            if (!isAdmin) {
              infoBar.style.display = 'block';
              setTabsEnabled(false);
              return false;
            }
            setTabsEnabled(true);
            return true;
          } catch (_) {
            infoBar.textContent = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
            infoBar.style.display = 'block';
            setTabsEnabled(false);
            return false;
          }
        }

        // é è¨­æœˆä»½ç‚ºæœ¬æœˆ
        const now = new Date();
        const currentMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        monthInput.value = currentMonth;
        monthInputEmp.value = currentMonth;
        monthInputClient.value = currentMonth;

        // äº‹ä»¶
        let searchTimer = null;
        viewType.addEventListener('change', loadClientCosts);
        
        // å„æ ‡ç­¾é¡µçš„æœˆä»½é€‰æ‹©å™¨å˜åŒ–äº‹ä»¶
        monthInput.addEventListener('change', ()=>{ 
          loadItems(); 
          loadRecords();
          updateButtonState();
        });
        
        monthInputEmp.addEventListener('change', ()=>{
          loadEmployeeCosts();
        });
        
        monthInputClient.addEventListener('change', ()=>{
          loadClientCosts();
        });

        document.getElementById('btn-refresh-emp')?.addEventListener('click', loadEmployeeCosts);
        document.getElementById('btn-refresh-client')?.addEventListener('click', loadClientCosts);

        // ============ æ–°å¢/åŒ¯å‡ºåŠŸèƒ½ï¼ˆæ”¹ç”¨è¡¨å–®èˆ‡ä¸‹æ‹‰é¸å–®ï¼‰ ============
        function openModal(title, contentEl, onSubmit){
          const overlay = document.createElement('div');
          overlay.style.position = 'fixed';
          overlay.style.inset = '0';
          overlay.style.background = 'rgba(0,0,0,0.3)';
          overlay.style.display = 'flex';
          overlay.style.alignItems = 'center';
          overlay.style.justifyContent = 'center';
          overlay.style.zIndex = '1000';
          const modal = document.createElement('div');
          modal.style.background = '#fff';
          modal.style.border = '1px solid #e5e7eb';
          modal.style.borderRadius = '10px';
          modal.style.boxShadow = '0 10px 30px rgba(0,0,0,0.15)';
          modal.style.width = 'min(520px, 92vw)';
          modal.style.maxHeight = '85vh';
          modal.style.display = 'flex';
          modal.style.flexDirection = 'column';
          const header = document.createElement('div');
          header.style.padding = '14px 16px';
          header.style.borderBottom = '1px solid #eee';
          header.style.fontWeight = '600';
          header.textContent = title;
          const body = document.createElement('div');
          body.style.padding = '14px 16px';
          body.style.overflow = 'auto';
          body.style.flex = '1';
          body.appendChild(contentEl);
          const footer = document.createElement('div');
          footer.style.display = 'flex';
          footer.style.gap = '8px';
          footer.style.justifyContent = 'flex-end';
          footer.style.padding = '12px 16px';
          footer.style.borderTop = '1px solid #eee';
          footer.style.flexShrink = '0';
          const btnCancel = document.createElement('button');
          btnCancel.className = 'btn';
          btnCancel.textContent = 'å–æ¶ˆ';
          const btnOk = document.createElement('button');
          btnOk.className = 'btn primary';
          btnOk.textContent = 'å„²å­˜';
          footer.appendChild(btnCancel); footer.appendChild(btnOk);
          modal.appendChild(header); modal.appendChild(body); modal.appendChild(footer);
          overlay.appendChild(modal);
          function close(){ document.body.removeChild(overlay); }
          btnCancel.addEventListener('click', close);
          btnOk.addEventListener('click', async ()=>{ await onSubmit?.(close); });
          document.body.appendChild(overlay);
        }

        function buildField(labelText, inputEl){
          const wrap = document.createElement('div');
          wrap.style.marginBottom = '10px';
          const label = document.createElement('label');
          label.style.display = 'block';
          label.style.fontSize = '12px';
          label.style.color = '#64748b';
          label.style.marginBottom = '6px';
          label.textContent = labelText;
          inputEl.style.width = '100%';
          inputEl.style.boxSizing = 'border-box';
          inputEl.style.padding = '8px 10px';
          inputEl.style.border = '1px solid #e5e7eb';
          inputEl.style.borderRadius = '8px';
          wrap.appendChild(label); wrap.appendChild(inputEl);
          return wrap;
        }

        function openAddTypeModal(){
          const form = document.createElement('div');
          const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.placeholder = 'ä¾‹å¦‚ï¼šè¾¦å…¬å®¤ç§Ÿé‡‘';
          const catSel = document.createElement('select'); catSel.innerHTML = '<option value="fixed">å›ºå®š</option><option value="variable">è®Šå‹•</option>';
          const allocSel = document.createElement('select'); allocSel.innerHTML = '<option value="per_employee">æŒ‰å“¡å·¥æ•¸</option><option value="per_hour">æŒ‰å·¥æ™‚</option><option value="per_revenue">æŒ‰æ”¶å…¥</option>';
          const descInput = document.createElement('input'); descInput.type = 'text'; descInput.placeholder = 'æè¿°ï¼ˆå¯ç•™ç©ºï¼‰';
          
          // è‡ªå‹•ç”Ÿæˆè¨­å®š
          const divider = document.createElement('div'); 
          divider.style.borderTop = '1px solid #e5e7eb'; 
          divider.style.margin = '16px 0 12px 0';
          const sectionTitle = document.createElement('div');
          sectionTitle.style.fontSize = '14px';
          sectionTitle.style.fontWeight = '600';
          sectionTitle.style.marginBottom = '12px';
          sectionTitle.style.color = '#374151';
          sectionTitle.textContent = 'è‡ªå‹•ç”Ÿæˆè¨­å®š';
          const enableChk = document.createElement('input'); enableChk.type='checkbox'; enableChk.id='tplEnableNew';
          const enableLbl = document.createElement('label'); enableLbl.htmlFor='tplEnableNew'; enableLbl.textContent='å•Ÿç”¨æ¯æœˆè‡ªå‹•ç”Ÿæˆ'; enableLbl.style.marginLeft='6px';
          const enWrap = document.createElement('div'); enWrap.appendChild(enableChk); enWrap.appendChild(enableLbl); enWrap.style.marginBottom='8px';
          const amountInput = document.createElement('input'); amountInput.type='number'; amountInput.placeholder='é è¨­é‡‘é¡'; amountInput.min='1';
          const effInput = document.createElement('input'); effInput.type='month';
          
          form.appendChild(buildField('æˆæœ¬åç¨±', nameInput));
          form.appendChild(buildField('é¡åˆ¥', catSel));
          form.appendChild(buildField('åˆ†æ”¤æ–¹å¼', allocSel));
          form.appendChild(buildField('æè¿°', descInput));
          form.appendChild(divider);
          form.appendChild(sectionTitle);
          form.appendChild(enWrap);
          form.appendChild(buildField('é è¨­é‡‘é¡', amountInput));
          form.appendChild(buildField('ç”Ÿæ•ˆèµ·å§‹æœˆ', effInput));
          
          openModal('æ–°å¢æˆæœ¬é …ç›®', form, async (close)=>{
            const name = nameInput.value.trim();
            const category = catSel.value;
            const allocationMethod = allocSel.value;
            const description = descInput.value.trim();
            if (!name) { alert('è«‹è¼¸å…¥æˆæœ¬åç¨±'); return; }
            try {
              const res = await fetch(`${apiBase}/admin/overhead-types`, {
                method: 'POST', credentials: 'include', headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ cost_name: name, category, allocation_method: allocationMethod, description })
              });
              const json = await res.json().catch(()=>({}));
              if (!res.ok || !json || json.ok !== true) { alert(json?.message||'å»ºç«‹å¤±æ•—'); return; }
              
              // è‹¥å‹¾é¸è‡ªå‹•ç”Ÿæˆï¼Œå»ºç«‹æ¨¡æ¿
              const costTypeId = json.data?.id;
              if (enableChk.checked && costTypeId) {
                const is_active = true;
                const amount = Number(amountInput.value||0);
                const efv = String(effInput.value||'');
                const tplBody = { is_active };
                if (amount>0) tplBody.amount = amount;
                if (/^\d{4}-\d{2}$/.test(efv)) tplBody.effective_from = efv;
                try {
                  await fetch(`${apiBase}/admin/overhead-templates/by-type/${costTypeId}`, { 
                    method:'PUT', 
                    credentials:'include', 
                    headers:{'content-type':'application/json'}, 
                    body: JSON.stringify(tplBody) 
                  });
                } catch (err) {
                  console.error('å»ºç«‹æ¨¡æ¿å¤±æ•—:', err);
                }
              }
              
              // å…ˆåˆ·æ–°æ•°æ®
              if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
              await loadItems();
              
              // å†å…³é—­å¯¹è¯æ¡†
              close();
            } catch (err) {
              console.error('æ–°å¢é …ç›®å¤±æ•—:', err);
              alert('æ–°å¢å¤±æ•—ï¼š' + (err?.message || String(err)));
            }
          });
        }

        async function openAddRecordModal(){
          const ym = parseYearMonth();
          if (!ym) { alert('è«‹å…ˆé¸æ“‡æœ‰æ•ˆæœˆä»½'); return; }
          const typesRes = await fetch(`${apiBase}/admin/overhead-types?is_active=1&perPage=200&_t=${Date.now()}`, { credentials:'include', cache: 'no-store' });
          if (typesRes.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
          const typesJson = await typesRes.json();
          const types = (typesJson?.data)||[];
          if (!Array.isArray(types) || types.length === 0) { alert('å°šç„¡å•Ÿç”¨çš„æˆæœ¬é …ç›®ï¼Œè«‹å…ˆå»ºç«‹'); return; }
          const form = document.createElement('div');
          const monthSel = document.createElement('input'); monthSel.type = 'month'; monthSel.value = `${String(ym.year)}-${String(ym.month).padStart(2,'0')}`;
          const typeSel = document.createElement('select');
          typeSel.innerHTML = types.map(t => `<option value="${t.id}">${t.name}ï¼ˆ${t.category==='fixed'?'å›ºå®š':'è®Šå‹•'}ï¼‰</option>`).join('');
          const amtInput = document.createElement('input'); amtInput.type = 'number'; amtInput.placeholder = 'è«‹è¼¸å…¥é‡‘é¡'; amtInput.min = '1';
          const notesInput = document.createElement('input'); notesInput.type = 'text'; notesInput.placeholder = 'å‚™è¨»ï¼ˆå¯ç•™ç©ºï¼‰';
          form.appendChild(buildField('æœˆä»½', monthSel));
          form.appendChild(buildField('æˆæœ¬é …ç›®', typeSel));
          form.appendChild(buildField('é‡‘é¡', amtInput));
          form.appendChild(buildField('å‚™è¨»', notesInput));
          openModal('æ–°å¢æœˆåº¦è¨˜éŒ„', form, async (close)=>{
            const cost_type_id = parseInt(typeSel.value, 10);
            const amount = Number(amtInput.value);
            const notes = notesInput.value.trim();
            if (!Number.isFinite(amount) || amount <= 0) { alert('é‡‘é¡ç„¡æ•ˆ'); return; }
            const mVal = String(monthSel.value||'');
            const mMatch = mVal.match(/^(\d{4})-(\d{2})$/);
            if (!mMatch) { alert('æœˆä»½ç„¡æ•ˆ'); return; }
            const y = parseInt(mMatch[1], 10); const m = parseInt(mMatch[2], 10);
            try {
              const res = await fetch(`${apiBase}/admin/overhead-costs`, {
                method: 'POST', credentials: 'include', headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ cost_type_id, year: y, month: m, amount, notes })
              });
              const json = await res.json().catch(()=>({}));
              if (!res.ok || !json || json.ok !== true) { alert(json?.message||'å»ºç«‹å¤±æ•—'); return; }
              
              // å…ˆåˆ·æ–°æ•°æ®
              if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
              await loadRecords();
              
              // å†å…³é—­å¯¹è¯æ¡†
              close();
            } catch (err) {
              console.error('æ–°å¢è¨˜éŒ„å¤±æ•—:', err);
              alert('æ–°å¢å¤±æ•—ï¼š' + (err?.message || String(err)));
            }
          });
        }

        document.getElementById('btn-add-item')?.addEventListener('click', openAddTypeModal);
        document.getElementById('btn-add-record')?.addEventListener('click', openAddRecordModal);
        document.getElementById('btn-generate-month')?.addEventListener('click', generateCurrentMonth);

        // ä¸€éµç”Ÿæˆï¼šæŒ‰æ¨¡æ¿ç”Ÿæˆæœ¬æœˆè¨˜éŒ„
        async function generateCurrentMonth(){
          const ym = parseYearMonth();
          if (!ym) { alert('è«‹å…ˆé¸æ“‡æœ‰æ•ˆæœˆä»½'); return; }
          try {
            // å…ˆé è¦½
            const prevRes = await fetch(`${apiBase}/admin/overhead-costs/generate/preview?year=${ym.year}&month=${ym.month}&_t=${Date.now()}`, { credentials:'include', cache: 'no-store' });
            const prevJson = await prevRes.json();
            if (!prevRes.ok || !prevJson || prevJson.ok !== true) throw new Error(prevJson?.message||'é è¦½å¤±æ•—');
            const items = (prevJson.data?.items)||[];
            if (items.length === 0) { alert('æ²’æœ‰å¯ç”Ÿæˆçš„é …ç›®'); return; }
            // å½ˆçª—å‹¾é¸
            const form = document.createElement('div');
            const list = document.createElement('div');
            list.style.maxHeight = '50vh'; list.style.overflow='auto'; list.style.border='1px solid #e5e7eb'; list.style.borderRadius='8px'; list.style.padding='8px';
            items.forEach(it => {
              const row = document.createElement('label');
              row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px 4px';
              const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !it.alreadyExists; cb.value = String(it.templateId);
              const span = document.createElement('span'); span.textContent = `${it.costName}ï¼š${formatCurrency(it.amount)}${it.alreadyExists?'ï¼ˆæœ¬æœˆå·²å­˜åœ¨ï¼‰':''}`;
              row.appendChild(cb); row.appendChild(span); list.appendChild(row);
            });
            form.appendChild(list);
            openModal('æœ¬æœˆè‡ªå‹•ç”Ÿæˆï¼ˆé è¦½ï¼‰', form, async (close)=>{
              const selected = Array.from(list.querySelectorAll('input[type="checkbox"]')).filter(x=>x.checked).map(x=>parseInt(x.value,10));
              if (selected.length === 0) { alert('è«‹è‡³å°‘å‹¾é¸ä¸€é …'); return; }
              try {
                console.log('[Generate] é–‹å§‹ç”Ÿæˆï¼Œå¹´æœˆ:', ym, 'æ¨¡æ¿ID:', selected);
                const res = await fetch(`${apiBase}/admin/overhead-costs/generate?year=${ym.year}&month=${ym.month}` , { method:'POST', credentials:'include', headers:{'content-type':'application/json'}, body: JSON.stringify({ template_ids: selected }) });
                const json = await res.json().catch(()=>({}));
                console.log('[Generate] API å›æ‡‰:', json);
                if (!res.ok || !json || json.ok !== true) { 
                  alert(json?.message||'è‡ªå‹•ç”Ÿæˆå¤±æ•—'); 
                  return; 
                }
                
                console.log('[Generate] ç”ŸæˆæˆåŠŸï¼Œå‰µå»ºäº†', json.data?.created, 'ç­†è¨˜éŒ„');
                console.log('[Generate] é‡è¤‡:', json.data?.duplicates, 'å·²è·³é:', json.data?.skipped);
                console.log('[Generate] ç”Ÿæˆçš„è¨˜éŒ„è©³æƒ…:', json.data?.records);
                
                const created = json.data?.created || 0;
                const duplicates = json.data?.duplicates || 0;
                const skipped = json.data?.skipped || 0;
                
                if (created === 0 && duplicates > 0) {
                  alert(`æœ¬æœˆè¨˜éŒ„å·²å­˜åœ¨ï¼ˆ${duplicates} ç­†ï¼‰ï¼Œç„¡éœ€é‡è¤‡ç”Ÿæˆ`);
                  close();
                  return;
                }
                
                if (created === 0 && skipped > 0) {
                  alert(`æ‰€é¸æ¨¡æ¿ä¸ç¬¦åˆæœ¬æœˆç”Ÿæˆæ¢ä»¶ï¼ˆå·²è·³é ${skipped} ç­†ï¼‰`);
                  close();
                  return;
                }
                
                if (created === 0) {
                  alert('æœªç”Ÿæˆä»»ä½•è¨˜éŒ„ï¼Œè«‹æª¢æŸ¥æ¨¡æ¿è¨­å®š');
                  close();
                  return;
                }
                
                // 1. å…ˆä½¿ç¼“å­˜å¤±æ•ˆ
                if (window.DataInvalidation) window.DataInvalidation.invalidate('costs');
                
                // 2. å»¶è¿Ÿä¸€ä¸‹å†åˆ·æ–°ï¼ˆç­‰å¾…æ•°æ®åº“æäº¤ï¼‰
                console.log('[Generate] ç­‰å¾… 500ms å¾Œåˆ·æ–°...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 3. ç­‰å¾…æ•°æ®åˆ·æ–°å®Œæˆ
                console.log('[Generate] é–‹å§‹åˆ·æ–°è¨˜éŒ„åˆ—è¡¨...');
                await loadRecords();
                console.log('[Generate] è¨˜éŒ„åˆ—è¡¨åˆ·æ–°å®Œæˆ');
                
                // 4. å…³é—­å¯¹è¯æ¡†
                close();
                
                // 5. æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                let message = `å·²è‡ªå‹•ç”Ÿæˆ ${created} ç­†è¨˜éŒ„`;
                if (duplicates > 0) message += `ï¼ˆ${duplicates} ç­†å·²å­˜åœ¨ï¼‰`;
                if (skipped > 0) message += `ï¼ˆ${skipped} ç­†å·²è·³éï¼‰`;
                alert(message);
              } catch (err) {
                console.error('ç”Ÿæˆå¤±æ•—:', err);
                alert('è‡ªå‹•ç”Ÿæˆå¤±æ•—ï¼š' + (err?.message || String(err)));
              }
            });
          } catch (err) {
            alert('è‡ªå‹•ç”Ÿæˆå¤±æ•—ï¼š' + (err?.message||String(err)));
          }
        }

        // åˆå§‹åŒ–æœˆä»½é€‰æ‹©å™¨ä¸ºå½“å‰æœˆä»½
        function initMonthSelector() {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const value = `${year}-${month}`;
          
          // åˆå§‹åŒ–æ‰€æœ‰ä¸‰ä¸ªæœˆä»½é€‰æ‹©å™¨
          if (monthInput) {
            monthInput.value = value;
          } else {
            console.error('[initMonthSelector] monthInput ä¸å­˜åœ¨ï¼');
          }
          
          if (monthInputEmp) {
            monthInputEmp.value = value;
          } else {
            console.error('[initMonthSelector] monthInputEmp ä¸å­˜åœ¨ï¼');
          }
          
          if (monthInputClient) {
            monthInputClient.value = value;
          } else {
            console.error('[initMonthSelector] monthInputClient ä¸å­˜åœ¨ï¼');
          }
          
          console.log('[initMonthSelector] å·²è¨­ç½®æ‰€æœ‰æœˆä»½é¸æ“‡å™¨:', value);
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonState() {
          const ym = parseYearMonth();
          const isValid = !!ym;
          document.getElementById('btn-generate-month').disabled = !isValid;
          document.getElementById('btn-add-record').disabled = !isValid;
          console.log('[updateButtonState] æœˆä»½æœ‰æ•ˆ:', isValid, 'å€¼:', monthInput?.value);
        }

        // ç›‘å¬æœˆä»½å˜åŒ–ï¼ˆå·²åœ¨ä¸Šé¢ç»Ÿä¸€è®¾ç½®ï¼‰

        // âš¡ æ¸…é™¤ costs é¡µé¢çš„é¢„æ¸²æŸ“ç¼“å­˜ï¼ˆæ’æŸ¥é—®é¢˜ï¼‰
        if (window.PagePrerender && window.PagePrerender.clear) {
          window.PagePrerender.clear('costs');
          console.log('[Init] å·²æ¸…é™¤ costs é æ¸²æŸ“ç·©å­˜');
        }
        
        // âš¡ é¢„æ¸²æŸ“åˆå§‹åŒ–ï¼ˆæš‚æ—¶ç¦ç”¨ä»¥æ’æŸ¥é—®é¢˜ï¼‰
        // if (window.PagePrerender) {
        //   window.PagePrerender.init('main');
        // }

        // åˆå§‹åŒ–
        console.log('[Init] é–‹å§‹åˆå§‹åŒ–æˆæœ¬é é¢...');
        ensureAdmin().then(ok => { 
          if (ok) {
            console.log('[Init] æ¬Šé™é©—è­‰é€šéï¼Œé–‹å§‹åŠ è¼‰é é¢...');
            // 1. åˆå§‹åŒ–æœˆä»½
            initMonthSelector();
            // 2. åŠ è½½æ•°æ®
            loadItems(); 
            loadRecords();
            // 3. æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateButtonState();
            // âš¡ è‡ªåŠ¨ä¿å­˜é¢„æ¸²æŸ“ï¼ˆæš‚æ—¶ç¦ç”¨ï¼‰
            // if (window.PagePrerender) {
            //   setTimeout(() => window.PagePrerender.autoSave('main', 2000), 1000);
            // }
          } else {
            console.warn('[Init] æ¬Šé™é©—è­‰å¤±æ•—');
          }
        }).catch(err => {
          console.error('[Init] åˆå§‹åŒ–å¤±æ•—:', err);
        });
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>



