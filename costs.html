<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="管理成本" />
    <title>管理成本｜設定與分析</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/costs-page.css" />
  </head>
  <body class="costs-page">
    <header class="costs-header">
      <h1 class="costs-title">管理成本</h1>
      <div id="infoBar" class="info-bar" style="display:none;" role="alert">您沒有權限存取此模組</div>
      <div class="costs-toolbar">
        <label for="month">月份</label>
        <input id="month" type="month" aria-label="月份" />
        <div class="toolbar-spacer"></div>
        <button id="btn-export-csv" type="button" class="btn" disabled>匯出 CSV</button>
        <button id="btn-export-pdf" type="button" class="btn" disabled>匯出 PDF</button>
      </div>
      <nav class="costs-tabs" role="tablist" aria-label="管理成本分頁">
        <button class="tab" role="tab" aria-selected="false" data-tab="items">成本項目設定</button>
        <button class="tab active" role="tab" aria-selected="true" data-tab="records">月度成本記錄</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="analysis">成本分析</button>
      </nav>
    </header>

    <main class="costs-content">
      <!-- 成本項目設定 -->
      <section id="panel-items" class="panel" role="tabpanel" aria-labelledby="tab-items">
        <div class="card">
          <div class="section-toolbar">
            <input id="itemSearch" type="search" placeholder="搜尋代碼/名稱…" />
            <select id="itemCategory">
              <option value="all">全部類別</option>
              <option value="fixed">固定</option>
              <option value="variable">變動</option>
            </select>
            <div class="toolbar-spacer"></div>
            <button class="btn primary" disabled>新增項目</button>
          </div>
          <table class="table" aria-label="成本項目列表">
            <thead>
              <tr>
                <th>成本代碼</th>
                <th>成本名稱</th>
                <th>類別</th>
                <th>分攤方式</th>
                <th>描述</th>
                <th>狀態</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="muted">尚無資料</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- 月度成本記錄 -->
      <section id="panel-records" class="panel show" role="tabpanel" aria-labelledby="tab-records">
        <div class="card">
          <div class="section-toolbar">
            <input id="recordSearch" type="search" placeholder="搜尋項目/備註…" />
            <div class="toolbar-spacer"></div>
            <button class="btn primary" disabled>新增記錄</button>
          </div>
          <div class="stats-cards">
            <div class="stat">
              <div class="stat-label">本月總管理成本</div>
              <div class="stat-value">—</div>
              <div class="stat-meta muted">固定：—｜變動：—</div>
            </div>
          </div>
          <table class="table" aria-label="月度成本記錄">
            <thead>
              <tr>
                <th>項目名稱</th>
                <th>金額</th>
                <th>備註</th>
                <th>錄入人</th>
                <th>錄入時間</th>
                <th>更新時間</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="muted">尚無資料</td></tr>
            </tbody>
          </table>
          <div class="pagination">
            <button type="button" id="prev">上一頁</button>
            <button type="button" id="next">下一頁</button>
          </div>
        </div>
      </section>

      <!-- 成本分析 -->
      <section id="panel-analysis" class="panel" role="tabpanel" aria-labelledby="tab-analysis">
        <div class="card">
          <div class="section-toolbar">
            <div class="toolbar-spacer"></div>
            <button class="btn" disabled>刷新</button>
          </div>
          <div class="analysis-grid">
            <div class="analysis-card">
              <div class="analysis-title">類別結構（固定 vs 變動）</div>
              <div class="placeholder muted">圓餅圖占位</div>
            </div>
            <div class="analysis-card">
              <div class="analysis-title">項目拆分表</div>
              <table class="table">
                <thead><tr><th>項目</th><th>金額</th><th>占比</th></tr></thead>
                <tbody>
                  <tr><td colspan="3" class="muted">尚無資料</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div id="analysisNotice" class="info-bar" style="display:none;">本月份未輸入管理成本，報表僅顯示薪資成本</div>
        </div>
      </section>
    </main>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const infoBar = document.getElementById('infoBar');
        const tabs = Array.from(document.querySelectorAll('.costs-tabs .tab'));
        const panels = {
          items: document.getElementById('panel-items'),
          records: document.getElementById('panel-records'),
          analysis: document.getElementById('panel-analysis'),
        };

        const monthInput = document.getElementById('month');
        const recordSearch = document.getElementById('recordSearch');
        const recordsPanel = panels.records;
        const recordsTbody = recordsPanel.querySelector('tbody');
        const statValueEl = recordsPanel.querySelector('.stat-value');
        const statMetaEl = recordsPanel.querySelector('.stat-meta');
        const analysisPanel = panels.analysis;
        const analysisTableBody = analysisPanel.querySelector('table tbody');
        const analysisNotice = document.getElementById('analysisNotice');

        function setTabsEnabled(enabled){
          tabs.forEach(b=>{ b.disabled = !enabled; });
          document.querySelectorAll('.costs-toolbar .btn, .section-toolbar input, .section-toolbar select, .section-toolbar button').forEach(el=>{ el.disabled = !enabled; });
        }

        tabs.forEach(btn => {
          btn.addEventListener('click', ()=>{
            tabs.forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            const key = btn.getAttribute('data-tab');
            Object.entries(panels).forEach(([k,el])=>{
              if (k === key) el.classList.add('show'); else el.classList.remove('show');
            });
          });
        });

        function parseYearMonth(){
          const v = String(monthInput.value || '');
          const m = v.match(/^(\d{4})-(\d{2})$/);
          if (!m) return null;
          const year = parseInt(m[1], 10);
          const month = parseInt(m[2], 10);
          if (!Number.isFinite(year) || !Number.isFinite(month) || month < 1 || month > 12) return null;
          return { year, month };
        }

        function renderRecords(items){
          recordsTbody.innerHTML = '';
          if (!items || items.length === 0) {
            recordsTbody.innerHTML = '<tr><td colspan="6" class="muted">尚無資料</td></tr>';
            return;
          }
          items.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.costName||''}</td>
              <td>${Number(r.amount||0).toLocaleString()}</td>
              <td>${r.notes||''}</td>
              <td>${r.recordedBy||''}</td>
              <td>${r.recordedAt||''}</td>
              <td>${r.updatedAt||''}</td>
            `;
            recordsTbody.appendChild(tr);
          });
        }

        async function loadRecords(){
          const ym = parseYearMonth();
          if (!ym) return;
          const params = new URLSearchParams();
          params.set('year', String(ym.year));
          params.set('month', String(ym.month));
          const q = recordSearch.value.trim();
          if (q) params.set('q', q);
          try {
            recordsTbody.innerHTML = '<tr><td colspan="6" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/admin/overhead-costs?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || {};
            const items = data.items || [];
            renderRecords(items);
            const total = Number(data.total||0);
            const totalFixed = Number(data.totalFixed||0);
            const totalVariable = Number(data.totalVariable||0);
            statValueEl.textContent = total.toLocaleString();
            statMetaEl.textContent = `固定：${totalFixed.toLocaleString()}｜變動：${totalVariable.toLocaleString()}`;
          } catch (_) {
            recordsTbody.innerHTML = '<tr><td colspan="6" style="color:#c0392b;">載入失敗</td></tr>';
            statValueEl.textContent = '—';
            statMetaEl.textContent = '固定：—｜變動：—';
          }
        }

        function renderAnalysis(data){
          // 類別結構占位更新
          const fixed = Number((data && data.breakdown_by_category && data.breakdown_by_category.fixed) || 0);
          const variable = Number((data && data.breakdown_by_category && data.breakdown_by_category.variable) || 0);
          const placeholder = analysisPanel.querySelector('.placeholder');
          if (placeholder) placeholder.textContent = `固定 ${fixed.toLocaleString()} ｜ 變動 ${variable.toLocaleString()}`;

          // 項目拆分表
          const list = (data && data.breakdown_by_type) || [];
          analysisTableBody.innerHTML = '';
          if (!list.length) {
            analysisTableBody.innerHTML = '<tr><td colspan="3" class="muted">尚無資料</td></tr>';
          } else {
            list.forEach(x => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${x.costName||''}</td>
                <td>${Number(x.amount||0).toLocaleString()}</td>
                <td>${Number(x.percentage||0).toFixed(1)}%</td>
              `;
              analysisTableBody.appendChild(tr);
            });
          }
        }

        async function loadAnalysis(){
          const ym = parseYearMonth();
          if (!ym) return;
          const params = new URLSearchParams();
          params.set('year', String(ym.year));
          params.set('month', String(ym.month));
          try {
            analysisTableBody.innerHTML = '<tr><td colspan="3" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/admin/overhead-summary?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || {};
            const total = Number(data.total_overhead||0);
            analysisNotice.style.display = total > 0 ? 'none' : 'block';
            renderAnalysis(data);
          } catch (_) {
            analysisTableBody.innerHTML = '<tr><td colspan="3" style="color:#c0392b;">載入失敗</td></tr>';
            analysisNotice.style.display = 'none';
          }
        }

        async function ensureAdmin(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/costs'); return false; }
            const json = await res.json();
            const isAdmin = !!(json && json.ok && json.data && json.data.isAdmin);
            if (!isAdmin) {
              infoBar.style.display = 'block';
              setTabsEnabled(false);
              return false;
            }
            setTabsEnabled(true);
            return true;
          } catch (_) {
            infoBar.textContent = '載入失敗，請稍後再試';
            infoBar.style.display = 'block';
            setTabsEnabled(false);
            return false;
          }
        }

        // 預設月份為本月
        const now = new Date();
        monthInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

        // 事件
        let searchTimer = null;
        recordSearch.addEventListener('input', ()=>{ clearTimeout(searchTimer); searchTimer = setTimeout(()=>{ loadRecords(); }, 300); });
        monthInput.addEventListener('change', ()=>{ loadRecords(); loadAnalysis(); });

        // 初始化
        ensureAdmin().then(ok => { if (ok) { loadRecords(); loadAnalysis(); } });
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>



