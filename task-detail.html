<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»»å‹™è©³æƒ… - å…§éƒ¨ç³»çµ±</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
  <link rel="stylesheet" href="/assets/css/client-detail-page.css?v=30">
  <link rel="stylesheet" href="/assets/css/task-detail-page.css?v=1">
  <style>
    /* æ—¥æœŸé¸æ“‡å™¨ - æ•´æ¡†å¯é»æ“Š */
    input[type="date"] {
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      cursor: pointer !important;
      position: relative !important;
    }
    
    /* è®“æ—¥æ›†åœ–æ¨™è¦†è“‹æ•´å€‹è¼¸å…¥æ¡†ï¼Œä½¿æ•´å€‹å€åŸŸéƒ½å¯ä»¥é»æ“Š */
    input[type="date"]::-webkit-calendar-picker-indicator {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100% !important;
      height: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      opacity: 0 !important;
      cursor: pointer !important;
    }
    
    input[type="date"]::-webkit-inner-spin-button {
      display: none !important;
    }
    
    input[type="date"]::-webkit-datetime-edit {
      padding: 0 !important;
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container">
    <div class="page-header-simple">
      <a href="/internal/tasks" class="back-link">â† è¿”å›ä»»å‹™åˆ—è¡¨</a>
      <h1 class="page-title" id="taskTitle">ä»»å‹™è©³æƒ…</h1>
    </div>

    <!-- ä»»å‹™åŸºæœ¬ä¿¡æ¯ -->
    <div class="content-card">
      <h2 class="card-title">åŸºæœ¬ä¿¡æ¯</h2>
      <div class="form-row-2col">
        <div class="form-field">
          <label for="taskName">ä»»å‹™åç¨±</label>
          <input type="text" id="taskName" readonly style="background:#f3f4f6;" />
        </div>
        <div class="form-field">
          <label for="taskStatus">ç‹€æ…‹</label>
          <select id="taskStatus">
            <option value="pending">å¾…é–‹å§‹</option>
            <option value="in_progress">é€²è¡Œä¸­</option>
            <option value="completed">å·²å®Œæˆ</option>
            <option value="cancelled">å·²å–æ¶ˆ</option>
          </select>
          <button type="button" class="btn btn-sm btn-secondary" onclick="showUpdateStatusModal()" style="margin-top:8px;">æ›´æ–°ç‹€æ…‹èªªæ˜</button>
        </div>
      </div>
      <div class="form-row-2col">
        <div class="form-field">
          <label for="clientName">å®¢æˆ¶</label>
          <input type="text" id="clientName" readonly style="background:#f3f4f6;" />
        </div>
        <div class="form-field">
          <label for="assigneeUser">è² è²¬äºº</label>
          <select id="assigneeUser">
            <option value="">è¼‰å…¥ä¸­...</option>
          </select>
        </div>
      </div>
      <div class="form-row-2col">
        <div class="form-field">
          <label for="prerequisiteTask">å‰ç½®ä»»å‹™</label>
          <input type="text" id="prerequisiteTask" readonly style="background:#f3f4f6;" placeholder="ç„¡å‰ç½®ä»»å‹™" />
          <p style="font-size:12px;color:#6b7280;margin-top:4px;">æ­¤ä»»å‹™ä¾è³´çš„å‰ç½®ä»»å‹™</p>
        </div>
        <div class="form-field">
          <label>é€²åº¦</label>
          <div style="display: flex; align-items: center; gap: 12px; padding: 10px 0;">
            <div class="progress-bar" style="flex: 1;">
              <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <span id="progressText" style="font-weight: 600; font-size: 14px; color: #1f2937;">0/0</span>
          </div>
        </div>
      </div>
      <div class="form-row-2col">
        <div class="form-field">
          <label for="dueDate">åˆ°æœŸæ—¥</label>
          <input type="date" id="dueDate" readonly style="background:#f3f4f6;cursor:pointer;" />
          <div id="dueDateAdjustmentInfo" style="font-size:12px;color:#6b7280;margin-top:4px;display:none;">
            <span id="adjustmentBadge" style="background:#fef3c7;color:#92400e;padding:2px 6px;border-radius:3px;font-size:11px;font-weight:500;">å·²èª¿æ•´</span>
            <span id="adjustmentText"></span>
          </div>
          <button type="button" class="btn btn-sm btn-secondary" onclick="showAdjustDueDateModal()" style="margin-top:8px;">èª¿æ•´åˆ°æœŸæ—¥</button>
          <button type="button" class="btn btn-sm btn-link" onclick="showAdjustmentHistory()" style="margin-top:8px;margin-left:8px;">æŸ¥çœ‹èª¿æ•´æ­·å²</button>
        </div>
        <div class="form-field">
          <label for="originalDueDate">åŸå§‹åˆ°æœŸæ—¥</label>
          <input type="date" id="originalDueDate" readonly style="background:#f3f4f6;" />
          <p style="font-size:12px;color:#6b7280;margin-top:4px;">ç³»çµ±æœ€åˆè¨­å®šçš„åˆ°æœŸæ—¥</p>
        </div>
      </div>
      <div class="form-row-1col">
        <div class="form-field">
          <label for="taskNotes">å‚™è¨»</label>
          <textarea id="taskNotes" rows="3"></textarea>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-primary" onclick="saveTaskInfo()">å„²å­˜è®Šæ›´</button>
      </div>
    </div>

    <!-- é—œè¯çš„ SOP -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">ğŸ“– é—œè¯çš„ SOP</h2>
        <button class="btn btn-primary btn-sm" onclick="showManageSOPModal()">ç®¡ç† SOP</button>
      </div>
      <div id="sopList" class="sop-list">
        <p style="color: #9ca3af;">è¼‰å…¥ä¸­...</p>
      </div>
    </div>

    <!-- ä»»å‹™æ–‡æª” -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">ğŸ“ ä»»å‹™æ–‡æª”</h2>
        <button class="btn btn-primary btn-sm" onclick="uploadTaskDocument()">+ ä¸Šå‚³æ–‡æª”</button>
      </div>
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>æ–‡ä»¶åç¨±</th>
              <th>æ–‡ä»¶é¡å‹</th>
              <th style="width: 120px;">å¤§å°</th>
              <th style="width: 150px;">ä¸Šå‚³æ™‚é–“</th>
              <th style="width: 100px;">ä¸Šå‚³è€…</th>
              <th style="width: 120px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="documentsList">
            <tr>
              <td colspan="6" class="loading-text">è¼‰å…¥ä¸­...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <!-- ç®¡ç† SOP å½ˆçª— -->
  <div id="sopModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">ç®¡ç†ä»»å‹™ SOP</h3>
        <button onclick="closeSOPModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <p style="color: #6b7280; font-size: 14px; margin-bottom: 12px;">é¸æ“‡è¦é—œè¯åˆ°æ­¤ä»»å‹™çš„ SOPï¼ˆå¯å¤šé¸ï¼‰</p>
        <div id="sopCheckboxList" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px;">
          <p style="color: #9ca3af;">è¼‰å…¥ä¸­...</p>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeSOPModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveSOPLinks()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- æ›´æ–°ç‹€æ…‹èªªæ˜å½ˆçª— -->
  <div id="statusModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">æ›´æ–°ç‹€æ…‹èªªæ˜</h3>
        <button onclick="closeStatusModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">æ–°ç‹€æ…‹</label>
        <select id="modal_status" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;">
          <option value="pending">å¾…é–‹å§‹</option>
          <option value="in_progress">é€²è¡Œä¸­</option>
          <option value="completed">å·²å®Œæˆ</option>
          <option value="cancelled">å·²å–æ¶ˆ</option>
        </select>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">é€²åº¦èªªæ˜</label>
        <textarea id="modal_progress_note" rows="3" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" placeholder="æè¿°ç•¶å‰é€²åº¦..."></textarea>
      </div>
      
      <div id="overdue_reason_section" style="margin-bottom: 16px; display:none;">
        <label style="display:block;margin-bottom:6px;font-weight:500;color:#dc2626;">é€¾æœŸåŸå›  *</label>
        <textarea id="modal_overdue_reason" rows="3" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" placeholder="ä»»å‹™å·²é€¾æœŸï¼Œè«‹èªªæ˜åŸå› ..."></textarea>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">é˜»å¡åŸå› </label>
        <textarea id="modal_blocker_reason" rows="2" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" placeholder="å¦‚æœä»»å‹™è¢«é˜»å¡ï¼Œè«‹èªªæ˜åŸå› ..."></textarea>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">é è¨ˆå®Œæˆæ—¥æœŸ</label>
        <input type="date" id="modal_expected_date" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeStatusModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitStatusUpdate()">æ›´æ–°ç‹€æ…‹</button>
      </div>
    </div>
  </div>

  <!-- èª¿æ•´åˆ°æœŸæ—¥å½ˆçª— -->
  <div id="dueDateModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 24px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">èª¿æ•´åˆ°æœŸæ—¥</h3>
        <button onclick="closeDueDateModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">ç•¶å‰åˆ°æœŸæ—¥</label>
        <input type="text" id="modal_current_due_date" readonly style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;background:#f3f4f6;" />
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">æ–°åˆ°æœŸæ—¥ *</label>
        <input type="date" id="modal_new_due_date" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;color:#dc2626;">èª¿æ•´åŸå›  *</label>
        <textarea id="modal_adjustment_reason" rows="4" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" placeholder="è«‹èªªæ˜ç‚ºä½•éœ€è¦èª¿æ•´åˆ°æœŸæ—¥..."></textarea>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeDueDateModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitDueDateAdjustment()">ç¢ºèªèª¿æ•´</button>
      </div>
    </div>
  </div>

  <!-- æ–‡ä»¶ä¸Šå‚³éš±è— input -->
  <input type="file" id="fileInput" style="display: none;" accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls,.docx,.doc" />

  <script src="/assets/js/components/bootstrap.js?v=3"></script>
  <script>
    const onProdHost = location.hostname.endsWith('horgoscpa.com');
    const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
    
    let currentTaskId = null;
    let currentTask = null;
    let allUsers = [];
    let allSOPs = [];
    let taskSOPs = [];

    // åˆå§‹åŒ–
    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      currentTaskId = urlParams.get('id');
      
      if (!currentTaskId) {
        alert('ç¼ºå°‘ä»»å‹™ID');
        window.location.href = '/internal/tasks';
        return;
      }

      await Promise.all([
        loadUsers(),
        loadAllSOPs(),
        loadTaskDetail(),
        loadTaskSOPs(),
        loadTaskDocuments()
      ]);
    }

    // è¼‰å…¥å“¡å·¥åˆ—è¡¨
    async function loadUsers() {
      try {
        const res = await fetch(`${apiBase}/users`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        if (json.ok && json.data) {
          allUsers = json.data;
          const select = document.getElementById('assigneeUser');
          select.innerHTML = '<option value="">æœªåˆ†é…</option>' +
            allUsers.map(u => 
              `<option value="${u.user_id}">${u.name || u.username}</option>`
            ).join('');
        }
      } catch (err) {
        console.error('è¼‰å…¥å“¡å·¥åˆ—è¡¨å¤±æ•—:', err);
      }
    }

    // è¼‰å…¥æ‰€æœ‰ SOP
    async function loadAllSOPs() {
      try {
        const res = await fetch(`${apiBase}/sop?perPage=100`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        if (json.ok && json.data) {
          allSOPs = json.data;
        }
      } catch (err) {
        console.error('è¼‰å…¥ SOP åˆ—è¡¨å¤±æ•—:', err);
      }
    }

    // è¼‰å…¥ä»»å‹™è©³æƒ…
    async function loadTaskDetail() {
      try {
        const url = `${apiBase}/tasks/${currentTaskId}`;
        console.log('è¼‰å…¥ä»»å‹™è©³æƒ… URL:', url);
        
        const res = await fetch(url, { credentials: 'include' });
        console.log('ä»»å‹™è©³æƒ…éŸ¿æ‡‰ç‹€æ…‹:', res.status);
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        if (res.status === 404) {
          alert('ä»»å‹™ä¸å­˜åœ¨');
          window.location.href = '/internal/tasks';
          return;
        }
        
        const json = await res.json();
        console.log('ä»»å‹™è©³æƒ…æ•¸æ“š:', json);
        
        if (!json.ok) {
          alert(json.message || 'è¼‰å…¥å¤±æ•—');
          return;
        }

        currentTask = json.data;
        console.log('ç•¶å‰ä»»å‹™:', currentTask);
        
        // æ›´æ–°é é¢
        document.getElementById('taskTitle').textContent = currentTask.task_name || 'ä»»å‹™è©³æƒ…';
        document.getElementById('taskName').value = currentTask.task_name || '';
        document.getElementById('taskStatus').value = currentTask.status || 'pending';
        document.getElementById('clientName').value = currentTask.client_name || '';
        document.getElementById('assigneeUser').value = currentTask.assignee_user_id || '';
        document.getElementById('dueDate').value = currentTask.due_date || '';
        document.getElementById('originalDueDate').value = currentTask.original_due_date || currentTask.due_date || '';
        document.getElementById('taskNotes').value = currentTask.notes || '';
        
        // å‰ç½®ä»»å‹™
        if (currentTask.prerequisite_task_name) {
          document.getElementById('prerequisiteTask').value = currentTask.prerequisite_task_name;
        }
        
        // åˆ°æœŸæ—¥èª¿æ•´è³‡è¨Š
        if (currentTask.due_date_adjusted) {
          const infoDiv = document.getElementById('dueDateAdjustmentInfo');
          const textSpan = document.getElementById('adjustmentText');
          textSpan.textContent = `å·²èª¿æ•´ ${currentTask.adjustment_count || 1} æ¬¡`;
          if (currentTask.last_adjustment_date) {
            textSpan.textContent += ` â€¢ æœ€å¾Œèª¿æ•´ï¼š${currentTask.last_adjustment_date}`;
          }
          infoDiv.style.display = 'block';
        }
        
        console.log('å·²å¡«å……è¡¨å–®å­—æ®µ');
        
        // æ›´æ–°é€²åº¦
        updateProgress(currentTask.completed_stages || 0, currentTask.total_stages || 0);
        
      } catch (err) {
        console.error('è¼‰å…¥ä»»å‹™è©³æƒ…å¤±æ•—:', err);
        alert('è¼‰å…¥å¤±æ•—: ' + err.message);
      }
    }

    // æ›´æ–°é€²åº¦
    function updateProgress(completed, total) {
      const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
      document.getElementById('progressFill').style.width = percentage + '%';
      document.getElementById('progressText').textContent = `${completed}/${total}`;
    }

    // è¼‰å…¥ä»»å‹™é—œè¯çš„ SOP
    async function loadTaskSOPs() {
      try {
        const res = await fetch(`${apiBase}/tasks/${currentTaskId}/sops`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        
        const json = await res.json();
        console.log('è¼‰å…¥ SOP æ•¸æ“š:', json);
        
        const container = document.getElementById('sopList');
        
        if (!json.ok || !json.data || json.data.length === 0) {
          container.innerHTML = '<p style="color: #9ca3af;">æ­¤ä»»å‹™å°šæœªé—œè¯ä»»ä½• SOP</p>';
          taskSOPs = [];
          return;
        }

        taskSOPs = json.data;
        console.log('SOP åˆ—è¡¨:', taskSOPs);
        console.log('ç¬¬ä¸€å€‹ SOP è©³æƒ…:', JSON.stringify(taskSOPs[0], null, 2));
        
        container.innerHTML = taskSOPs.map(sop => {
          console.log('æ¸²æŸ“ SOP:', sop);
          return `
            <div class="sop-item">
              <div>
                <div class="sop-title">${sop.title || 'æœªå‘½å'}</div>
                <div class="sop-meta">${getCategoryText(sop.category)} â€¢ v${sop.version || '1'}</div>
              </div>
              <a href="/internal/knowledge?id=${sop.id}" target="_blank" class="btn btn-sm btn-secondary">æŸ¥çœ‹</a>
            </div>
          `;
        }).join('');
        
      } catch (err) {
        console.error('è¼‰å…¥ä»»å‹™ SOP å¤±æ•—:', err);
        document.getElementById('sopList').innerHTML = '<p style="color: #ef4444;">è¼‰å…¥å¤±æ•—</p>';
      }
    }

    // è¼‰å…¥ä»»å‹™æ–‡æª”
    async function loadTaskDocuments() {
      try {
        const url = `${apiBase}/attachments?entity_type=task&entity_id=${currentTaskId}`;
        console.log('è¼‰å…¥é™„ä»¶ URL:', url);
        
        const res = await fetch(url, { credentials: 'include' });
        console.log('é™„ä»¶éŸ¿æ‡‰ç‹€æ…‹:', res.status);
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        
        const json = await res.json();
        console.log('é™„ä»¶æ•¸æ“š:', json);
        
        const tbody = document.getElementById('documentsList');
        
        if (!json.ok || !json.data || json.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #9ca3af;">å°šç„¡æ–‡æª”</td></tr>';
          return;
        }

        tbody.innerHTML = json.data.map(doc => `
          <tr>
            <td>${doc.filename || 'æœªçŸ¥æ–‡ä»¶'}</td>
            <td>${doc.contentType || '-'}</td>
            <td>${formatFileSize(doc.sizeBytes || 0)}</td>
            <td>${formatDateTime(doc.uploadedAt)}</td>
            <td>${doc.uploaderName || 'æœªçŸ¥'}</td>
            <td>
              <button class="table-btn-link" onclick="downloadDocument(${doc.id}, '${(doc.filename || 'file').replace(/'/g, "\\'")}')">ä¸‹è¼‰</button>
              <button class="table-btn-link danger" onclick="deleteDocument(${doc.id})">åˆªé™¤</button>
            </td>
          </tr>
        `).join('');
        
      } catch (err) {
        console.error('è¼‰å…¥ä»»å‹™æ–‡æª”å¤±æ•—:', err);
        document.getElementById('documentsList').innerHTML = '<tr><td colspan="6" style="color: #ef4444;">è¼‰å…¥å¤±æ•—: ' + err.message + '</td></tr>';
      }
    }

    // å„²å­˜ä»»å‹™ä¿¡æ¯
    async function saveTaskInfo() {
      const data = {
        assignee_user_id: document.getElementById('assigneeUser').value ? parseInt(document.getElementById('assigneeUser').value) : null,
        notes: document.getElementById('taskNotes').value.trim()
      };

      try {
        const res = await fetch(`${apiBase}/tasks/${currentTaskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || 'å„²å­˜å¤±æ•—');
          return;
        }

        alert('å·²å„²å­˜');
        await loadTaskDetail();
        
      } catch (err) {
        console.error('å„²å­˜ä»»å‹™ä¿¡æ¯å¤±æ•—:', err);
        alert('å„²å­˜å¤±æ•—');
      }
    }
    
    // é¡¯ç¤ºæ›´æ–°ç‹€æ…‹æ¨¡æ…‹æ¡†
    function showUpdateStatusModal() {
      const modal = document.getElementById('statusModal');
      const currentStatus = document.getElementById('taskStatus').value;
      document.getElementById('modal_status').value = currentStatus;
      
      // æª¢æŸ¥æ˜¯å¦é€¾æœŸ
      const dueDate = document.getElementById('dueDate').value;
      const today = new Date().toISOString().split('T')[0];
      const isOverdue = dueDate && dueDate < today && currentTask.status !== 'completed';
      
      document.getElementById('overdue_reason_section').style.display = isOverdue ? 'block' : 'none';
      modal.style.display = 'flex';
    }
    
    function closeStatusModal() {
      document.getElementById('statusModal').style.display = 'none';
    }
    
    async function submitStatusUpdate() {
      const status = document.getElementById('modal_status').value;
      const progress_note = document.getElementById('modal_progress_note').value.trim();
      const overdue_reason = document.getElementById('modal_overdue_reason').value.trim();
      const blocker_reason = document.getElementById('modal_blocker_reason').value.trim();
      const expected_date = document.getElementById('modal_expected_date').value;
      
      // æª¢æŸ¥æ˜¯å¦é€¾æœŸä¸”éœ€è¦å¡«å¯«åŸå› 
      const overdueSection = document.getElementById('overdue_reason_section');
      if (overdueSection.style.display !== 'none' && !overdue_reason) {
        alert('ä»»å‹™å·²é€¾æœŸï¼Œå¿…é ˆå¡«å¯«é€¾æœŸåŸå› ');
        return;
      }
      
      const data = {
        status,
        progress_note,
        overdue_reason,
        blocker_reason,
        expected_completion_date: expected_date || null
      };
      
      try {
        const res = await fetch(`${apiBase}/tasks/${currentTaskId}/update-status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || 'æ›´æ–°å¤±æ•—');
          return;
        }
        
        alert('ç‹€æ…‹å·²æ›´æ–°');
        closeStatusModal();
        await loadTaskDetail();
        
      } catch (err) {
        console.error('æ›´æ–°ç‹€æ…‹å¤±æ•—:', err);
        alert('æ›´æ–°å¤±æ•—');
      }
    }
    
    // é¡¯ç¤ºèª¿æ•´åˆ°æœŸæ—¥æ¨¡æ…‹æ¡†
    function showAdjustDueDateModal() {
      const modal = document.getElementById('dueDateModal');
      const currentDueDate = document.getElementById('dueDate').value;
      document.getElementById('modal_current_due_date').value = currentDueDate || 'æœªè¨­å®š';
      document.getElementById('modal_new_due_date').value = currentDueDate;
      document.getElementById('modal_adjustment_reason').value = '';
      modal.style.display = 'flex';
    }
    
    function closeDueDateModal() {
      document.getElementById('dueDateModal').style.display = 'none';
    }
    
    async function submitDueDateAdjustment() {
      const new_due_date = document.getElementById('modal_new_due_date').value;
      const reason = document.getElementById('modal_adjustment_reason').value.trim();
      
      if (!new_due_date) {
        alert('è«‹é¸æ“‡æ–°çš„åˆ°æœŸæ—¥');
        return;
      }
      
      if (!reason) {
        alert('å¿…é ˆå¡«å¯«èª¿æ•´åŸå› ');
        return;
      }
      
      const data = { new_due_date, reason };
      
      try {
        const res = await fetch(`${apiBase}/tasks/${currentTaskId}/adjust-due-date`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || 'èª¿æ•´å¤±æ•—');
          return;
        }
        
        alert('åˆ°æœŸæ—¥å·²èª¿æ•´');
        closeDueDateModal();
        await loadTaskDetail();
        
      } catch (err) {
        console.error('èª¿æ•´åˆ°æœŸæ—¥å¤±æ•—:', err);
        alert('èª¿æ•´å¤±æ•—');
      }
    }
    
    // é¡¯ç¤ºèª¿æ•´æ­·å²
    async function showAdjustmentHistory() {
      try {
        const res = await fetch(`${apiBase}/tasks/${currentTaskId}/adjustment-history`, {
          credentials: 'include'
        });
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        if (!json.ok || !json.data) {
          alert('è¼‰å…¥å¤±æ•—');
          return;
        }
        
        const history = json.data;
        if (history.length === 0) {
          alert('æ²’æœ‰èª¿æ•´æ­·å²');
          return;
        }
        
        let html = '<h3 style="margin-bottom:16px;">åˆ°æœŸæ—¥èª¿æ•´æ­·å²</h3>';
        html += '<div style="max-height:500px;overflow-y:auto;">';
        history.forEach(adj => {
          const typeLabels = {
            'initial_create': 'åˆå§‹å‰µå»º',
            'manual_adjust': 'æ‰‹å‹•èª¿æ•´',
            'system_auto': 'ç³»çµ±è‡ªå‹•',
            'overdue_adjust': 'é€¾æœŸèª¿æ•´'
          };
          
          // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
          const formatDateTime = (dt) => {
            if (!dt) return '-';
            try {
              const d = new Date(dt);
              return d.toLocaleString('zh-TW', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
              });
            } catch {
              return dt;
            }
          };
          
          const daysChanged = Number(adj.days_changed || 0);
          
          html += `
            <div style="border:1px solid #e5e7eb;border-radius:6px;padding:12px;margin-bottom:12px;">
              <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                <span style="font-weight:600;">${typeLabels[adj.adjustment_type] || adj.adjustment_type || 'æœªçŸ¥'}</span>
                <span style="color:#6b7280;font-size:13px;">${formatDateTime(adj.requested_at)}</span>
              </div>
              <div style="font-size:14px;margin-bottom:6px;">
                <span style="color:#6b7280;">åŸåˆ°æœŸæ—¥:</span> ${adj.old_due_date || '-'}
                <span style="margin:0 8px;">â†’</span>
                <span style="color:#6b7280;">æ–°åˆ°æœŸæ—¥:</span> ${adj.new_due_date || '-'}
                <span style="margin-left:12px;color:${daysChanged > 0 ? '#dc2626' : '#059669'};">
                  ${daysChanged > 0 ? '+' : ''}${daysChanged} å¤©
                </span>
              </div>
              <div style="font-size:14px;color:#4b5563;">
                <strong>åŸå› :</strong> ${adj.adjustment_reason || 'ç„¡'}
              </div>
              <div style="font-size:13px;color:#6b7280;margin-top:4px;">
                ç”± ${adj.requested_by_name || 'ç³»çµ±'} èª¿æ•´
              </div>
            </div>
          `;
        });
        html += '</div>';
        
        const modal = document.createElement('div');
        modal.style.cssText = 'display:flex;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;';
        modal.innerHTML = `
          <div style="background:white;border-radius:8px;padding:24px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto;">
            ${html}
            <div style="margin-top:20px;text-align:right;">
              <button class="btn btn-secondary" onclick="this.closest('div[style*=fixed]').remove()">é—œé–‰</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
      } catch (err) {
        console.error('è¼‰å…¥èª¿æ•´æ­·å²å¤±æ•—:', err);
        alert('è¼‰å…¥å¤±æ•—');
      }
    }

    // é¡¯ç¤ºç®¡ç† SOP å½ˆçª—
    function showManageSOPModal() {
      const modal = document.getElementById('sopModal');
      const container = document.getElementById('sopCheckboxList');
      
      // ç²å–ç•¶å‰ä»»å‹™å·²é—œè¯çš„ SOP ID
      const linkedSOPIds = taskSOPs.map(s => s.id);
      console.log('ç•¶å‰å·²é—œè¯çš„ SOP IDs:', linkedSOPIds);
      console.log('æ‰€æœ‰å¯ç”¨çš„ SOP:', allSOPs.length);
      
      // æŒ‰åˆ†é¡åˆ†çµ„ SOP
      const sopByCategory = {};
      allSOPs.forEach(sop => {
        const cat = sop.category || 'other';
        if (!sopByCategory[cat]) sopByCategory[cat] = [];
        sopByCategory[cat].push(sop);
      });
      
      let html = '';
      Object.keys(sopByCategory).forEach(cat => {
        html += `<div style="margin-bottom: 16px;">
          <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">${getCategoryText(cat)}</div>`;
        
        sopByCategory[cat].forEach(sop => {
          const isLinked = linkedSOPIds.includes(sop.id);
          const checked = isLinked ? 'checked' : '';
          console.log(`SOP ${sop.id} (${sop.title}): å·²é—œè¯=${isLinked}, checked="${checked}"`);
          
          html += `
            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 4px;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='transparent'">
              <input type="checkbox" value="${sop.id}" ${checked} style="cursor: pointer;" />
              <span style="flex: 1;">${sop.title}</span>
              <span style="font-size: 12px; color: #9ca3af;">v${sop.version}</span>
            </label>
          `;
        });
        
        html += '</div>';
      });
      
      if (allSOPs.length === 0) {
        html = '<p style="color: #9ca3af;">å°šç„¡å¯ç”¨çš„ SOP</p>';
      }
      
      container.innerHTML = html;
      modal.style.display = 'flex';
      
      console.log('å½ˆçª—å·²é–‹å•Ÿï¼ŒHTML å·²ç”Ÿæˆ');
    }

    // é—œé–‰ SOP å½ˆçª—
    function closeSOPModal() {
      document.getElementById('sopModal').style.display = 'none';
    }

    // å„²å­˜ SOP é—œè¯
    async function saveSOPLinks() {
      const checkboxes = document.querySelectorAll('#sopCheckboxList input[type="checkbox"]:checked');
      const sopIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
      
      console.log('æº–å‚™å„²å­˜ SOP é—œè¯:', sopIds);

      try {
        const url = `${apiBase}/tasks/${currentTaskId}/sops`;
        console.log('API URL:', url);
        
        const res = await fetch(url, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ sop_ids: sopIds })
        });
        
        console.log('éŸ¿æ‡‰ç‹€æ…‹:', res.status);
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        console.log('éŸ¿æ‡‰æ•¸æ“š:', json);
        
        if (!json.ok) {
          alert(json.message || 'å„²å­˜å¤±æ•—');
          return;
        }

        alert('SOP é—œè¯å·²æ›´æ–°');
        closeSOPModal();
        await loadTaskSOPs();
        
      } catch (err) {
        console.error('å„²å­˜ SOP é—œè¯å¤±æ•—:', err);
        alert('å„²å­˜å¤±æ•—: ' + err.message);
      }
    }

    // ä¸Šå‚³ä»»å‹™æ–‡æª”
    function uploadTaskDocument() {
      const fileInput = document.getElementById('fileInput');
      fileInput.onchange = async function() {
        if (!this.files || this.files.length === 0) return;
        
        const file = this.files[0];
        
        // é©—è­‰æ–‡ä»¶å¤§å°
        if (file.size > 10 * 1024 * 1024) {
          alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…é 10MB');
          return;
        }
        
        try {
          // ç²å–ä¸Šå‚³ç°½å
          const signRes = await fetch(`${apiBase}/attachments/upload-sign`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              entity_type: 'task',
              entity_id: currentTaskId,
              filename: file.name,
              content_type: file.type || 'application/octet-stream',
              content_length: file.size
            })
          });
          
          if (signRes.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
          const signJson = await signRes.json();
          
          if (!signJson.ok) {
            alert(signJson.message || 'ç²å–ä¸Šå‚³ç°½åå¤±æ•—');
            return;
          }
          
          // ä¸Šå‚³æ–‡ä»¶
          const uploadRes = await fetch(signJson.data.uploadUrl, {
            method: 'PUT',
            headers: signJson.data.headers,
            body: file
          });
          
          if (!uploadRes.ok) {
            alert('ä¸Šå‚³å¤±æ•—');
            return;
          }
          
          alert('ä¸Šå‚³æˆåŠŸ');
          await loadTaskDocuments();
          
        } catch (err) {
          console.error('ä¸Šå‚³æ–‡æª”å¤±æ•—:', err);
          alert('ä¸Šå‚³å¤±æ•—');
        } finally {
          this.value = ''; // é‡ç½®æ–‡ä»¶è¼¸å…¥
        }
      };
      
      fileInput.click();
    }

    // ä¸‹è¼‰æ–‡æª”
    async function downloadDocument(attachmentId, filename) {
      try {
        const res = await fetch(`${apiBase}/attachments/${attachmentId}/download`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        if (!res.ok) {
          alert('ä¸‹è¼‰å¤±æ•—');
          return;
        }
        
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
      } catch (err) {
        console.error('ä¸‹è¼‰æ–‡æª”å¤±æ•—:', err);
        alert('ä¸‹è¼‰å¤±æ•—');
      }
    }

    // åˆªé™¤æ–‡æª”
    async function deleteDocument(attachmentId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ–‡æª”å—ï¼Ÿ')) return;
      
      try {
        const res = await fetch(`${apiBase}/attachments/${attachmentId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || 'åˆªé™¤å¤±æ•—');
          return;
        }

        await loadTaskDocuments();
        
      } catch (err) {
        console.error('åˆªé™¤æ–‡æª”å¤±æ•—:', err);
        alert('åˆªé™¤å¤±æ•—');
      }
    }

    // è¼”åŠ©å‡½æ•¸
    function getCategoryText(category) {
      const categoryMap = {
        'accounting': 'è¨˜å¸³æµç¨‹',
        'tax': 'ç¨…å‹™æµç¨‹',
        'business': 'å·¥å•†ç™»è¨˜',
        'internal': 'å…§éƒ¨æµç¨‹',
        'other': 'å…¶ä»–'
      };
      return categoryMap[category] || category;
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleString('zh-TW', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
    init();
  </script>
</body>
</html>

