<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»»å‹™è©³æƒ… - å…§éƒ¨ç³»çµ±</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
  <link rel="stylesheet" href="/assets/css/client-detail-page.css?v=30">
  <link rel="stylesheet" href="/assets/css/task-detail-page.css?v=1">
  <style>
    /* æ—¥æœŸé¸æ“‡å™¨ - æ•´æ¡†å¯é»æ“Š */
    input[type="date"] {
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      cursor: pointer !important;
      position: relative !important;
    }
    
    /* è®“æ—¥æ›†åœ–æ¨™è¦†è“‹æ•´å€‹è¼¸å…¥æ¡†ï¼Œä½¿æ•´å€‹å€åŸŸéƒ½å¯ä»¥é»æ“Š */
    input[type="date"]::-webkit-calendar-picker-indicator {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100% !important;
      height: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      opacity: 0 !important;
      cursor: pointer !important;
    }
    
    input[type="date"]::-webkit-inner-spin-button {
      display: none !important;
    }
    
    input[type="date"]::-webkit-datetime-edit {
      padding: 0 !important;
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container">
    <div class="page-header-simple">
      <a href="/internal/tasks" class="back-link">â† è¿”å›ä»»å‹™åˆ—è¡¨</a>
      <h1 class="page-title" id="taskTitle">ä»»å‹™è©³æƒ…</h1>
    </div>

    <!-- ä»»å‹™åŸºæœ¬ä¿¡æ¯ -->
    <div class="content-card">
      <h2 class="card-title">åŸºæœ¬ä¿¡æ¯</h2>
      <div class="form-row-2col">
        <div class="form-field">
          <label for="taskName">ä»»å‹™åç¨±</label>
          <input type="text" id="taskName" readonly style="background:#f3f4f6;" />
        </div>
        <div class="form-field">
          <label for="taskStatus">ç‹€æ…‹</label>
          <select id="taskStatus" disabled style="background:#f3f4f6;cursor:not-allowed;">
            <option value="pending">å¾…é–‹å§‹</option>
            <option value="in_progress">é€²è¡Œä¸­</option>
            <option value="completed">å·²å®Œæˆ</option>
            <option value="cancelled">å·²å–æ¶ˆ</option>
          </select>
          <p style="font-size:12px;color:#6b7280;margin-top:4px;">âœ‹ ç‹€æ…‹ç‚ºå”¯è®€ï¼Œè«‹ä½¿ç”¨ä¸‹æ–¹æŒ‰éˆ•æ›´æ–°</p>
        </div>
      </div>
      <div class="form-row-2col">
        <div class="form-field">
          <label for="clientName">å®¢æˆ¶</label>
          <input type="text" id="clientName" readonly style="background:#f3f4f6;" />
        </div>
        <div class="form-field">
          <label for="assigneeUser">è² è²¬äºº</label>
          <select id="assigneeUser">
            <option value="">è¼‰å…¥ä¸­...</option>
          </select>
        </div>
      </div>
      <div class="form-row-2col">
        <div class="form-field">
          <label for="prerequisiteTask">å‰ç½®ä»»å‹™</label>
          <input type="text" id="prerequisiteTask" readonly style="background:#f3f4f6;" placeholder="ç„¡å‰ç½®ä»»å‹™" />
          <p style="font-size:12px;color:#6b7280;margin-top:4px;">æ­¤ä»»å‹™ä¾è³´çš„å‰ç½®ä»»å‹™</p>
        </div>
        <div class="form-field">
          <label>é€²åº¦</label>
          <div style="display: flex; align-items: center; gap: 12px; padding: 10px 0;">
            <div class="progress-bar" style="flex: 1;">
              <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <span id="progressText" style="font-weight: 600; font-size: 14px; color: #1f2937;">0/0</span>
          </div>
        </div>
      </div>
      <div class="form-row-2col">
        <div class="form-field">
          <label for="dueDate">åˆ°æœŸæ—¥</label>
          <input type="date" id="dueDate" readonly style="background:#f3f4f6;cursor:pointer;" />
          <div id="dueDateAdjustmentInfo" style="font-size:12px;color:#6b7280;margin-top:4px;display:none;">
            <span id="adjustmentBadge" style="background:#fef3c7;color:#92400e;padding:2px 6px;border-radius:3px;font-size:11px;font-weight:500;">å·²èª¿æ•´</span>
            <span id="adjustmentText"></span>
          </div>
        </div>
        <div class="form-field">
          <label for="originalDueDate">åŸå§‹åˆ°æœŸæ—¥</label>
          <input type="date" id="originalDueDate" readonly style="background:#f3f4f6;" />
          <p style="font-size:12px;color:#6b7280;margin-top:4px;">ç³»çµ±æœ€åˆè¨­å®šçš„åˆ°æœŸæ—¥</p>
        </div>
      </div>
      <div class="form-row-1col">
        <div class="form-field">
          <label for="statusNote">ğŸ’¬ æœ€æ–°ç‹€æ…‹èªªæ˜</label>
          <textarea id="statusNote" rows="3" readonly style="background:#f9fafb;cursor:default;"></textarea>
          <p style="font-size:12px;color:#6b7280;margin-top:4px;">æ­¤å…§å®¹é€éã€Œæ›´æ–°ç‹€æ…‹èªªæ˜ã€æŒ‰éˆ•ä¾†æ›´æ–°</p>
        </div>
      </div>
      
      <div id="blockerReasonSection" class="form-row-1col" style="display:none;">
        <div class="form-field">
          <label for="blockerReason" style="color:#dc2626;">ğŸš« é˜»ç¤™åŸå› </label>
          <textarea id="blockerReason" rows="2" readonly style="background:#fef2f2;cursor:default;border:1px solid #fecaca;"></textarea>
        </div>
      </div>
      
      <div id="overdueReasonSection" class="form-row-1col" style="display:none;">
        <div class="form-field">
          <label for="overdueReason" style="color:#dc2626;">â° é€¾æœŸåŸå› </label>
          <textarea id="overdueReason" rows="2" readonly style="background:#fef2f2;cursor:default;border:1px solid #fecaca;"></textarea>
        </div>
      </div>
      
      <div class="form-actions" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <button type="button" class="btn btn-primary" onclick="showUpdateStatusModal()" style="background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);box-shadow:0 2px 4px rgba(59,130,246,0.3);">
          ğŸ“ æ›´æ–°ç‹€æ…‹èªªæ˜
        </button>
        <button type="button" class="btn" onclick="showAdjustmentHistory()" style="background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);color:#fff;box-shadow:0 2px 4px rgba(139,92,246,0.3);border:none;">
          ğŸ“… æŸ¥çœ‹èª¿æ•´æ­·å²
        </button>
      </div>
    </div>

    <!-- é—œè¯çš„ SOP -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">ğŸ“– é—œè¯çš„ SOP</h2>
        <button class="btn btn-primary btn-sm" onclick="showManageSOPModal()">ç®¡ç† SOP</button>
      </div>
      <div id="sopList" class="sop-list">
        <p style="color: #9ca3af;">è¼‰å…¥ä¸­...</p>
      </div>
    </div>

    <!-- ä»»å‹™æ–‡æª” -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">ğŸ“ ä»»å‹™æ–‡æª”</h2>
        <button class="btn btn-primary btn-sm" onclick="uploadTaskDocument()">+ ä¸Šå‚³æ–‡æª”</button>
      </div>
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>æ–‡ä»¶åç¨±</th>
              <th>æ–‡ä»¶é¡å‹</th>
              <th style="width: 120px;">å¤§å°</th>
              <th style="width: 150px;">ä¸Šå‚³æ™‚é–“</th>
              <th style="width: 100px;">ä¸Šå‚³è€…</th>
              <th style="width: 120px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="documentsList">
            <tr>
              <td colspan="6" class="loading-text">è¼‰å…¥ä¸­...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <!-- ç®¡ç† SOP å½ˆçª— -->
  <div id="sopModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">ç®¡ç†ä»»å‹™ SOP</h3>
        <button onclick="closeSOPModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <p style="color: #6b7280; font-size: 14px; margin-bottom: 12px;">é¸æ“‡è¦é—œè¯åˆ°æ­¤ä»»å‹™çš„ SOPï¼ˆå¯å¤šé¸ï¼‰</p>
        <div id="sopCheckboxList" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px;">
          <p style="color: #9ca3af;">è¼‰å…¥ä¸­...</p>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeSOPModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveSOPLinks()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- æ›´æ–°ç‹€æ…‹èªªæ˜å½ˆçª— -->
  <div id="statusModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">æ›´æ–°ç‹€æ…‹</h3>
        <button onclick="closeStatusModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      
      <!-- é€¾æœŸè­¦å‘Š -->
      <div id="overdue_warning" style="display:none;background:#fef2f2;border:1px solid #fecaca;border-radius:6px;padding:12px;margin-bottom:16px;">
        <div style="display:flex;align-items:start;gap:8px;">
          <span style="color:#dc2626;font-size:20px;">âš ï¸</span>
          <div>
            <div style="font-weight:600;color:#dc2626;margin-bottom:4px;">æ­¤ä»»å‹™å·²é€¾æœŸ</div>
            <div style="font-size:13px;color:#991b1b;">åˆ°æœŸæ—¥ï¼š<span id="overdue_date_text"></span></div>
            <div style="font-size:13px;color:#991b1b;">è«‹åœ¨ä¸‹æ–¹èªªæ˜é€¾æœŸåŸå› </div>
          </div>
        </div>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">ä»»å‹™ç‹€æ…‹ <span style="color:#dc2626;">*</span></label>
        <select id="modal_status" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
          <option value="pending">â¸ï¸ å¾…é–‹å§‹ - ä»»å‹™å·²åˆ†é…ä½†å°šæœªé–‹å·¥</option>
          <option value="in_progress">â–¶ï¸ é€²è¡Œä¸­ - æ­£åœ¨è™•ç†æ­¤ä»»å‹™</option>
          <option value="completed">âœ… å·²å®Œæˆ - ä»»å‹™å·²ç¶“å®Œæˆ</option>
          <option value="cancelled">âŒ å·²å–æ¶ˆ - ä¸å†åŸ·è¡Œæ­¤ä»»å‹™</option>
        </select>
        <p style="font-size:12px;color:#6b7280;margin-top:6px;">ğŸ’¡ é¸æ“‡ä»»å‹™çš„ç•¶å‰ç‹€æ…‹</p>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">é€²åº¦èªªæ˜ <span style="color:#9ca3af;font-weight:400;">(é¸å¡«)</span></label>
        <textarea id="modal_progress_note" rows="3" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" placeholder="ä¾‹å¦‚ï¼šå·²å®Œæˆ 80%ï¼Œé è¨ˆæ˜å¤©å®Œæˆ..."></textarea>
      </div>
      
      <div id="overdue_reason_section" style="margin-bottom: 16px; display:none;">
        <label style="display:block;margin-bottom:6px;font-weight:500;color:#dc2626;">é€¾æœŸåŸå›  <span style="color:#dc2626;">*</span></label>
        <textarea id="modal_overdue_reason" rows="3" style="width:100%;padding:10px;border:1px solid #dc2626;border-radius:6px;" placeholder="èªªæ˜ç‚ºä½•ç„¡æ³•åœ¨åŸå®šæœŸé™å…§å®Œæˆ..."></textarea>
        <p style="font-size:12px;color:#991b1b;margin-top:4px;">âš ï¸ ä»»å‹™å·²é€¾æœŸï¼Œæ­¤æ¬„ä½ç‚ºå¿…å¡«</p>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">é‡åˆ°é˜»ç¤™äº†å—ï¼Ÿ <span style="color:#9ca3af;font-weight:400;">(é¸å¡«)</span></label>
        <textarea id="modal_blocker_reason" rows="2" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" placeholder="ä¾‹å¦‚ï¼šç­‰å¾…å®¢æˆ¶å›è¦†æ–‡ä»¶ã€ç³»çµ±å•é¡Œç­‰..."></textarea>
        <p style="font-size:12px;color:#6b7280;margin-top:4px;">ğŸ’¡ å¦‚æœä»»å‹™è¢«å¤–éƒ¨å› ç´ é˜»å¡ï¼Œè«‹åœ¨æ­¤èªªæ˜</p>
      </div>
      
      <!-- æ­£å¼åˆ°æœŸæ—¥ -->
      <div style="border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin-bottom:16px;background:#fafafa;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
          <span style="font-size:18px;">ğŸ“…</span>
          <h4 style="margin:0;font-size:15px;font-weight:600;color:#374151;">æ­£å¼åˆ°æœŸæ—¥</h4>
        </div>
        
        <div style="margin-bottom: 12px;">
          <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:500;color:#6b7280;">ç•¶å‰åˆ°æœŸæ—¥</label>
          <div style="padding:8px 12px;background:white;border:1px solid #d1d5db;border-radius:6px;font-weight:500;color:#1f2937;" id="current_due_date_display">-</div>
        </div>
        
        <div style="margin-bottom: 12px;">
          <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:500;">èª¿æ•´åˆ°æœŸæ—¥ <span style="color:#9ca3af;font-weight:400;">(é¸å¡«)</span></label>
          <input type="date" id="modal_due_date" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
          <p style="font-size:11px;color:#6b7280;margin-top:4px;">ğŸ’¡ é€™æ˜¯æ­£å¼æ‰¿è«¾çš„å®ŒæˆæœŸé™</p>
        </div>
        
        <div id="due_date_change_reason_section" style="display:none;">
          <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:500;color:#dc2626;">èª¿æ•´åŸå›  <span style="color:#dc2626;">*</span></label>
          <textarea id="modal_due_date_reason" rows="2" style="width:100%;padding:10px;border:1px solid #dc2626;border-radius:6px;" placeholder="å¿…é ˆèªªæ˜ç‚ºä½•éœ€è¦èª¿æ•´æ­£å¼åˆ°æœŸæ—¥..."></textarea>
          <p style="font-size:11px;color:#991b1b;margin-top:4px;">âš ï¸ æª¢æ¸¬åˆ°åˆ°æœŸæ—¥è®Šæ›´ï¼Œæ­¤æ¬„ä½ç‚ºå¿…å¡«</p>
        </div>
      </div>
      
      <!-- é è¨ˆå®Œæˆæ—¥æœŸ -->
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">å€‹äººé è¨ˆå®Œæˆæ—¥æœŸ <span style="color:#9ca3af;font-weight:400;">(é¸å¡«)</span></label>
        <input type="date" id="modal_expected_date" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
        <div id="expected_date_current" style="font-size:12px;color:#6b7280;margin-top:4px;display:none;">
          ç›®å‰é è¨ˆï¼š<span id="current_expected_date_text"></span>
        </div>
        <p style="font-size:12px;color:#6b7280;margin-top:4px;">ğŸ’¡ ä½ è‡ªå·±å…§éƒ¨ä¼°è¨ˆçš„å®Œæˆæ™‚é–“ï¼ˆä¸å½±éŸ¿æ­£å¼åˆ°æœŸæ—¥ï¼‰</p>
      </div>
      
      <div id="expected_date_change_reason_section" style="margin-bottom: 16px; display:none;">
        <label style="display:block;margin-bottom:6px;font-weight:500;color:#d97706;">è®Šæ›´åŸå›  <span style="color:#9ca3af;font-weight:400;">(å»ºè­°å¡«å¯«)</span></label>
        <textarea id="modal_expected_date_reason" rows="2" style="width:100%;padding:10px;border:1px solid #f59e0b;border-radius:6px;" placeholder="èªªæ˜ç‚ºä½•èª¿æ•´é è¨ˆå®Œæˆæ—¥æœŸ..."></textarea>
        <p style="font-size:12px;color:#92400e;margin-top:4px;">âš ï¸ æª¢æ¸¬åˆ°é è¨ˆæ—¥æœŸè®Šæ›´ï¼Œå»ºè­°èªªæ˜åŸå› </p>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeStatusModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitStatusUpdate()">ç¢ºèªæ›´æ–°</button>
      </div>
    </div>
  </div>


  <!-- æ–‡ä»¶ä¸Šå‚³éš±è— input -->
  <input type="file" id="fileInput" style="display: none;" accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls,.docx,.doc" />

  <script src="/assets/js/components/bootstrap.js?v=3"></script>
  <script>
    const onProdHost = location.hostname.endsWith('horgoscpa.com');
    const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
    
    let currentTaskId = null;
    let currentTask = null;
    let allUsers = [];
    let allSOPs = [];
    let taskSOPs = [];

    // åˆå§‹åŒ–
    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      currentTaskId = urlParams.get('id');
      
      if (!currentTaskId) {
        alert('ç¼ºå°‘ä»»å‹™ID');
        window.location.href = '/internal/tasks';
        return;
      }

      await Promise.all([
        loadUsers(),
        loadAllSOPs(),
        loadTaskDetail(),
        loadTaskSOPs(),
        loadTaskDocuments()
      ]);
    }

    // è¼‰å…¥å“¡å·¥åˆ—è¡¨
    async function loadUsers() {
      try {
        const res = await fetch(`${apiBase}/users`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        if (json.ok && json.data) {
          allUsers = json.data;
          const select = document.getElementById('assigneeUser');
          select.innerHTML = '<option value="">æœªåˆ†é…</option>' +
            allUsers.map(u => 
              `<option value="${u.user_id}">${u.name || u.username}</option>`
            ).join('');
        }
      } catch (err) {
        console.error('è¼‰å…¥å“¡å·¥åˆ—è¡¨å¤±æ•—:', err);
      }
    }

    // è¼‰å…¥æ‰€æœ‰ SOP
    async function loadAllSOPs() {
      try {
        const res = await fetch(`${apiBase}/sop?perPage=100`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        if (json.ok && json.data) {
          allSOPs = json.data;
        }
      } catch (err) {
        console.error('è¼‰å…¥ SOP åˆ—è¡¨å¤±æ•—:', err);
      }
    }

    // è¼‰å…¥ä»»å‹™è©³æƒ…
    async function loadTaskDetail() {
      try {
        const url = `${apiBase}/tasks/${currentTaskId}`;
        console.log('è¼‰å…¥ä»»å‹™è©³æƒ… URL:', url);
        
        const res = await fetch(url, { credentials: 'include' });
        console.log('ä»»å‹™è©³æƒ…éŸ¿æ‡‰ç‹€æ…‹:', res.status);
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        if (res.status === 404) {
          alert('ä»»å‹™ä¸å­˜åœ¨');
          window.location.href = '/internal/tasks';
          return;
        }
        
        const json = await res.json();
        console.log('ä»»å‹™è©³æƒ…æ•¸æ“š:', json);
        
        if (!json.ok) {
          alert(json.message || 'è¼‰å…¥å¤±æ•—');
          return;
        }

        currentTask = json.data;
        console.log('ç•¶å‰ä»»å‹™:', currentTask);
        
        // æ›´æ–°é é¢
        document.getElementById('taskTitle').textContent = currentTask.task_name || 'ä»»å‹™è©³æƒ…';
        document.getElementById('taskName').value = currentTask.task_name || '';
        document.getElementById('taskStatus').value = currentTask.status || 'pending';
        document.getElementById('clientName').value = currentTask.client_name || '';
        document.getElementById('assigneeUser').value = currentTask.assignee_user_id || '';
        document.getElementById('dueDate').value = currentTask.due_date || '';
        document.getElementById('originalDueDate').value = currentTask.original_due_date || currentTask.due_date || '';
        
        // ç‹€æ…‹èªªæ˜
        document.getElementById('statusNote').value = currentTask.status_note || 'å°šæœªå¡«å¯«ç‹€æ…‹èªªæ˜';
        
        // é˜»ç¤™åŸå› ï¼ˆå¦‚æœæœ‰ï¼‰
        const blockerReasonSection = document.getElementById('blockerReasonSection');
        const blockerReasonEl = document.getElementById('blockerReason');
        if (currentTask.blocker_reason) {
          blockerReasonEl.value = currentTask.blocker_reason;
          blockerReasonSection.style.display = 'block';
        } else {
          blockerReasonSection.style.display = 'none';
        }
        
        // é€¾æœŸåŸå› ï¼ˆå¦‚æœæœ‰ï¼‰
        const overdueReasonSection = document.getElementById('overdueReasonSection');
        const overdueReasonEl = document.getElementById('overdueReason');
        if (currentTask.overdue_reason) {
          overdueReasonEl.value = currentTask.overdue_reason;
          overdueReasonSection.style.display = 'block';
        } else {
          overdueReasonSection.style.display = 'none';
        }
        
        // å‰ç½®ä»»å‹™
        if (currentTask.prerequisite_task_name) {
          document.getElementById('prerequisiteTask').value = currentTask.prerequisite_task_name;
        }
        
        // åˆ°æœŸæ—¥èª¿æ•´è³‡è¨Š
        if (currentTask.due_date_adjusted) {
          const infoDiv = document.getElementById('dueDateAdjustmentInfo');
          const textSpan = document.getElementById('adjustmentText');
          textSpan.textContent = `å·²èª¿æ•´ ${currentTask.adjustment_count || 1} æ¬¡`;
          if (currentTask.last_adjustment_date) {
            textSpan.textContent += ` â€¢ æœ€å¾Œèª¿æ•´ï¼š${currentTask.last_adjustment_date}`;
          }
          infoDiv.style.display = 'block';
        }
        
        console.log('å·²å¡«å……è¡¨å–®å­—æ®µ');
        
        // æ›´æ–°é€²åº¦
        updateProgress(currentTask.completed_stages || 0, currentTask.total_stages || 0);
        
      } catch (err) {
        console.error('è¼‰å…¥ä»»å‹™è©³æƒ…å¤±æ•—:', err);
        alert('è¼‰å…¥å¤±æ•—: ' + err.message);
      }
    }

    // æ›´æ–°é€²åº¦
    function updateProgress(completed, total) {
      const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
      document.getElementById('progressFill').style.width = percentage + '%';
      document.getElementById('progressText').textContent = `${completed}/${total}`;
    }

    // è¼‰å…¥ä»»å‹™é—œè¯çš„ SOP
    async function loadTaskSOPs() {
      try {
        const res = await fetch(`${apiBase}/tasks/${currentTaskId}/sops`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        
        const json = await res.json();
        console.log('è¼‰å…¥ SOP æ•¸æ“š:', json);
        
        const container = document.getElementById('sopList');
        
        if (!json.ok || !json.data || json.data.length === 0) {
          container.innerHTML = '<p style="color: #9ca3af;">æ­¤ä»»å‹™å°šæœªé—œè¯ä»»ä½• SOP</p>';
          taskSOPs = [];
          return;
        }

        taskSOPs = json.data;
        console.log('SOP åˆ—è¡¨:', taskSOPs);
        console.log('ç¬¬ä¸€å€‹ SOP è©³æƒ…:', JSON.stringify(taskSOPs[0], null, 2));
        
        container.innerHTML = taskSOPs.map(sop => {
          console.log('æ¸²æŸ“ SOP:', sop);
          return `
            <div class="sop-item">
              <div>
                <div class="sop-title">${sop.title || 'æœªå‘½å'}</div>
                <div class="sop-meta">${getCategoryText(sop.category)} â€¢ v${sop.version || '1'}</div>
              </div>
              <a href="/internal/knowledge?id=${sop.id}" target="_blank" class="btn btn-sm btn-secondary">æŸ¥çœ‹</a>
            </div>
          `;
        }).join('');
        
      } catch (err) {
        console.error('è¼‰å…¥ä»»å‹™ SOP å¤±æ•—:', err);
        document.getElementById('sopList').innerHTML = '<p style="color: #ef4444;">è¼‰å…¥å¤±æ•—</p>';
      }
    }

    // è¼‰å…¥ä»»å‹™æ–‡æª”
    async function loadTaskDocuments() {
      try {
        const url = `${apiBase}/attachments?entity_type=task&entity_id=${currentTaskId}`;
        console.log('è¼‰å…¥é™„ä»¶ URL:', url);
        
        const res = await fetch(url, { credentials: 'include' });
        console.log('é™„ä»¶éŸ¿æ‡‰ç‹€æ…‹:', res.status);
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        
        const json = await res.json();
        console.log('é™„ä»¶æ•¸æ“š:', json);
        
        const tbody = document.getElementById('documentsList');
        
        if (!json.ok || !json.data || json.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #9ca3af;">å°šç„¡æ–‡æª”</td></tr>';
          return;
        }

        tbody.innerHTML = json.data.map(doc => `
          <tr>
            <td>${doc.filename || 'æœªçŸ¥æ–‡ä»¶'}</td>
            <td>${doc.contentType || '-'}</td>
            <td>${formatFileSize(doc.sizeBytes || 0)}</td>
            <td>${formatDateTime(doc.uploadedAt)}</td>
            <td>${doc.uploaderName || 'æœªçŸ¥'}</td>
            <td>
              <button class="table-btn-link" onclick="downloadDocument(${doc.id}, '${(doc.filename || 'file').replace(/'/g, "\\'")}')">ä¸‹è¼‰</button>
              <button class="table-btn-link danger" onclick="deleteDocument(${doc.id})">åˆªé™¤</button>
            </td>
          </tr>
        `).join('');
        
      } catch (err) {
        console.error('è¼‰å…¥ä»»å‹™æ–‡æª”å¤±æ•—:', err);
        document.getElementById('documentsList').innerHTML = '<tr><td colspan="6" style="color: #ef4444;">è¼‰å…¥å¤±æ•—: ' + err.message + '</td></tr>';
      }
    }

    // é¡¯ç¤ºæ›´æ–°ç‹€æ…‹æ¨¡æ…‹æ¡†
    function showUpdateStatusModal() {
      const modal = document.getElementById('statusModal');
      const currentStatus = document.getElementById('taskStatus').value;
      document.getElementById('modal_status').value = currentStatus;
      
      // æ¸…ç©ºæ‰€æœ‰å­—æ®µ
      document.getElementById('modal_progress_note').value = '';
      document.getElementById('modal_overdue_reason').value = '';
      document.getElementById('modal_blocker_reason').value = '';
      document.getElementById('modal_expected_date_reason').value = '';
      document.getElementById('modal_due_date_reason').value = '';
      
      // è¨­ç½®ç•¶å‰åˆ°æœŸæ—¥
      const currentDueDate = document.getElementById('dueDate').value;
      document.getElementById('current_due_date_display').textContent = currentDueDate || 'æœªè¨­å®š';
      document.getElementById('modal_due_date').value = currentDueDate;
      
      // éš±è—åˆ°æœŸæ—¥è®Šæ›´åŸå› å€å¡Š
      document.getElementById('due_date_change_reason_section').style.display = 'none';
      
      // ç›£è½åˆ°æœŸæ—¥è®Šæ›´
      const dueDateInput = document.getElementById('modal_due_date');
      dueDateInput.onchange = function() {
        const newDate = this.value;
        const originalDate = currentDueDate;
        
        // å¦‚æœæ—¥æœŸæ”¹è®Šäº†ï¼Œé¡¯ç¤ºè®Šæ›´åŸå› æ¬„ä½ï¼ˆå¿…å¡«ï¼‰
        if (newDate && newDate !== originalDate) {
          document.getElementById('due_date_change_reason_section').style.display = 'block';
        } else {
          document.getElementById('due_date_change_reason_section').style.display = 'none';
        }
      };
      
      // è¨­ç½®ç•¶å‰é è¨ˆå®Œæˆæ—¥æœŸ
      const currentExpectedDate = currentTask?.expected_completion_date || '';
      document.getElementById('modal_expected_date').value = currentExpectedDate;
      
      // é¡¯ç¤ºç•¶å‰é è¨ˆæ—¥æœŸ
      if (currentExpectedDate) {
        document.getElementById('expected_date_current').style.display = 'block';
        document.getElementById('current_expected_date_text').textContent = currentExpectedDate;
      } else {
        document.getElementById('expected_date_current').style.display = 'none';
      }
      
      // éš±è—é è¨ˆæ—¥æœŸè®Šæ›´åŸå› å€å¡Š
      document.getElementById('expected_date_change_reason_section').style.display = 'none';
      
      // ç›£è½é è¨ˆå®Œæˆæ—¥æœŸè®Šæ›´
      const expectedDateInput = document.getElementById('modal_expected_date');
      expectedDateInput.onchange = function() {
        const newDate = this.value;
        const originalDate = currentTask?.expected_completion_date || '';
        
        // å¦‚æœæ—¥æœŸæ”¹è®Šäº†ï¼Œé¡¯ç¤ºè®Šæ›´åŸå› æ¬„ä½
        if (newDate && newDate !== originalDate) {
          document.getElementById('expected_date_change_reason_section').style.display = 'block';
        } else {
          document.getElementById('expected_date_change_reason_section').style.display = 'none';
        }
      };
      
      // æª¢æŸ¥æ˜¯å¦é€¾æœŸ
      const today = new Date().toISOString().split('T')[0];
      const isOverdue = currentDueDate && currentDueDate < today && currentTask.status !== 'completed';
      
      // é¡¯ç¤º/éš±è—é€¾æœŸç›¸é—œå€å¡Š
      const overdueWarning = document.getElementById('overdue_warning');
      const overdueSection = document.getElementById('overdue_reason_section');
      
      if (isOverdue) {
        overdueWarning.style.display = 'block';
        overdueSection.style.display = 'block';
        document.getElementById('overdue_date_text').textContent = currentDueDate;
      } else {
        overdueWarning.style.display = 'none';
        overdueSection.style.display = 'none';
      }
      
      modal.style.display = 'flex';
    }
    
    function closeStatusModal() {
      document.getElementById('statusModal').style.display = 'none';
    }
    
    async function submitStatusUpdate() {
      const status = document.getElementById('modal_status').value;
      let progress_note = document.getElementById('modal_progress_note').value.trim();
      const overdue_reason = document.getElementById('modal_overdue_reason').value.trim();
      const blocker_reason = document.getElementById('modal_blocker_reason').value.trim();
      const expected_date = document.getElementById('modal_expected_date').value;
      const expected_date_reason = document.getElementById('modal_expected_date_reason').value.trim();
      
      // åˆ°æœŸæ—¥èª¿æ•´
      const originalDueDate = document.getElementById('dueDate').value;
      const new_due_date = document.getElementById('modal_due_date').value;
      const due_date_reason = document.getElementById('modal_due_date_reason').value.trim();
      const dueDateChanged = new_due_date && new_due_date !== originalDueDate;
      
      console.log('[å‰ç«¯] æº–å‚™æäº¤ç‹€æ…‹æ›´æ–°:', { 
        status, progress_note, overdue_reason, blocker_reason, expected_date, expected_date_reason,
        dueDateChanged, originalDueDate, new_due_date, due_date_reason
      });
      
      // æª¢æŸ¥æ˜¯å¦é€¾æœŸä¸”éœ€è¦å¡«å¯«åŸå› 
      const overdueSection = document.getElementById('overdue_reason_section');
      const isOverdueVisible = overdueSection.style.display !== 'none';
      
      if (isOverdueVisible && !overdue_reason) {
        alert('âš ï¸ æ­¤ä»»å‹™å·²é€¾æœŸ\n\nè«‹åœ¨ã€Œé€¾æœŸåŸå› ã€æ¬„ä½èªªæ˜ç‚ºä½•ç„¡æ³•åœ¨æœŸé™å…§å®Œæˆã€‚');
        document.getElementById('modal_overdue_reason').focus();
        return;
      }
      
      // æª¢æŸ¥åˆ°æœŸæ—¥è®Šæ›´æ˜¯å¦æœ‰å¡«å¯«åŸå› 
      if (dueDateChanged && !due_date_reason) {
        alert('âš ï¸ æª¢æ¸¬åˆ°åˆ°æœŸæ—¥è®Šæ›´\n\nè«‹åœ¨ã€Œèª¿æ•´åŸå› ã€æ¬„ä½èªªæ˜ç‚ºä½•éœ€è¦èª¿æ•´æ­£å¼åˆ°æœŸæ—¥ã€‚');
        document.getElementById('modal_due_date_reason').focus();
        return;
      }
      
      // å¦‚æœé è¨ˆæ—¥æœŸè®Šæ›´ä¸”æœ‰å¡«å¯«åŸå› ï¼Œé™„åŠ åˆ°é€²åº¦èªªæ˜ä¸­
      const originalExpectedDate = currentTask?.expected_completion_date || '';
      if (expected_date && expected_date !== originalExpectedDate && expected_date_reason) {
        const dateChangeNote = `\n[é è¨ˆå®Œæˆæ—¥æœŸèª¿æ•´: ${originalExpectedDate || 'ç„¡'} â†’ ${expected_date}ï¼ŒåŸå› ï¼š${expected_date_reason}]`;
        progress_note = (progress_note + dateChangeNote).trim();
      }
      
      try {
        // 1. å¦‚æœåˆ°æœŸæ—¥æœ‰è®Šæ›´ï¼Œå…ˆèª¿æ•´åˆ°æœŸæ—¥
        if (dueDateChanged) {
          console.log('[å‰ç«¯] å…ˆèª¿æ•´åˆ°æœŸæ—¥...');
          const adjustRes = await fetch(`${apiBase}/tasks/${currentTaskId}/adjust-due-date`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ new_due_date, reason: due_date_reason })
          });
          
          if (adjustRes.status === 401) { 
            window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); 
            return; 
          }
          
          const adjustJson = await adjustRes.json();
          console.log('[å‰ç«¯] èª¿æ•´åˆ°æœŸæ—¥å›æ‡‰:', adjustJson);
          
          if (!adjustJson.ok) {
            let errorMsg = adjustJson.message || 'èª¿æ•´åˆ°æœŸæ—¥å¤±æ•—';
            if (adjustJson.errors && Array.isArray(adjustJson.errors)) {
              const errorDetails = adjustJson.errors.map(e => `â€¢ ${e.field}: ${e.message}`).join('\n');
              errorMsg = `${errorMsg}\n\n${errorDetails}`;
            }
            alert(errorMsg);
            return;
          }
        }
        
        // 2. æ›´æ–°ç‹€æ…‹
        const data = {
          status,
          progress_note: progress_note || null,
          overdue_reason: overdue_reason || null,
          blocker_reason: blocker_reason || null,
          expected_completion_date: expected_date || null
        };
        
        console.log('[å‰ç«¯] ç™¼é€ç‹€æ…‹æ›´æ–°æ•¸æ“š:', data);
        
        const res = await fetch(`${apiBase}/tasks/${currentTaskId}/update-status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        console.log('[å‰ç«¯] API å›æ‡‰ç‹€æ…‹:', res.status);
        
        if (res.status === 401) { 
          window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); 
          return; 
        }
        
        const json = await res.json();
        console.log('[å‰ç«¯] API å›æ‡‰æ•¸æ“š:', json);
        
        if (!json.ok) {
          let errorMsg = json.message || 'æ›´æ–°å¤±æ•—';
          
          // å¦‚æœæœ‰è©³ç´°éŒ¯èª¤ï¼Œé¡¯ç¤ºå‡ºä¾†
          if (json.errors && Array.isArray(json.errors)) {
            const errorDetails = json.errors.map(e => `â€¢ ${e.field}: ${e.message}`).join('\n');
            errorMsg = `${errorMsg}\n\n${errorDetails}`;
          }
          
          alert(errorMsg);
          console.error('[å‰ç«¯] æ›´æ–°å¤±æ•—è©³æƒ…:', json);
          return;
        }
        
        let successMsg = 'âœ… ç‹€æ…‹å·²æˆåŠŸæ›´æ–°';
        if (dueDateChanged) {
          successMsg += '\nğŸ“… åˆ°æœŸæ—¥å·²èª¿æ•´';
        }
        alert(successMsg);
        closeStatusModal();
        await loadTaskDetail();
        
      } catch (err) {
        console.error('[å‰ç«¯] æ›´æ–°ç‹€æ…‹å¤±æ•—:', err);
        alert('âŒ æ›´æ–°å¤±æ•—\n\n' + err.message);
      }
    }
    
    // é¡¯ç¤ºèª¿æ•´æ­·å²
    async function showAdjustmentHistory() {
      try {
        const res = await fetch(`${apiBase}/tasks/${currentTaskId}/adjustment-history`, {
          credentials: 'include'
        });
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        if (!json.ok || !json.data) {
          alert('è¼‰å…¥å¤±æ•—');
          return;
        }
        
        const history = json.data;
        if (history.length === 0) {
          alert('æ²’æœ‰èª¿æ•´æ­·å²');
          return;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        const formatDate = (dateStr) => {
          if (!dateStr) return '-';
          try {
            const d = new Date(dateStr);
            return d.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
          } catch {
            return dateStr;
          }
        };
        
        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        const formatDateTime = (dt) => {
          if (!dt) return '-';
          try {
            const d = new Date(dt);
            return d.toLocaleString('zh-TW', { 
              year: 'numeric', 
              month: '2-digit', 
              day: '2-digit', 
              hour: '2-digit', 
              minute: '2-digit' 
            });
          } catch {
            return dt;
          }
        };
        
        let html = `
          <div style="background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);padding:20px 24px;border-radius:8px 8px 0 0;margin:-24px -24px 20px -24px;">
            <h3 style="margin:0;color:#fff;font-size:20px;font-weight:600;">ğŸ“… åˆ°æœŸæ—¥èª¿æ•´æ­·å²</h3>
            <p style="margin:8px 0 0 0;color:rgba(255,255,255,0.9);font-size:14px;">å…± ${history.length} ç­†èª¿æ•´è¨˜éŒ„</p>
          </div>
          <div style="max-height:500px;overflow-y:auto;">
        `;
        
        history.forEach((adj, index) => {
          const typeLabels = {
            'initial_create': { icon: 'ğŸ†•', label: 'åˆå§‹å‰µå»º', color: '#3b82f6', bg: '#eff6ff' },
            'manual_adjust': { icon: 'âœï¸', label: 'æ‰‹å‹•èª¿æ•´', color: '#10b981', bg: '#f0fdf4' },
            'system_auto': { icon: 'ğŸ¤–', label: 'ç³»çµ±è‡ªå‹•', color: '#f59e0b', bg: '#fffbeb' },
            'overdue_adjust': { icon: 'âš ï¸', label: 'é€¾æœŸèª¿æ•´', color: '#ef4444', bg: '#fef2f2' }
          };
          
          const typeInfo = typeLabels[adj.adjustment_type] || { icon: 'ğŸ“', label: 'æœªçŸ¥é¡å‹', color: '#6b7280', bg: '#f9fafb' };
          const daysChanged = Number(adj.days_changed || 0);
          const isSystemAuto = adj.adjustment_type === 'system_auto';
          
          html += `
            <div style="border:2px solid ${typeInfo.color};border-radius:8px;padding:16px;margin-bottom:${index === history.length - 1 ? '0' : '16px'};background:${typeInfo.bg};position:relative;">
              <div style="position:absolute;top:-12px;left:16px;background:${typeInfo.color};color:#fff;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                ${typeInfo.icon} ${typeInfo.label}
              </div>
              
              <div style="margin-top:12px;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                  <div style="flex:1;">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                      <div style="background:#fff;padding:8px 12px;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                        <span style="font-size:12px;color:#6b7280;display:block;margin-bottom:2px;">åŸåˆ°æœŸæ—¥</span>
                        <span style="font-size:15px;font-weight:600;color:#1f2937;">${formatDate(adj.old_due_date)}</span>
                      </div>
                      <div style="color:${typeInfo.color};font-size:20px;font-weight:bold;">â†’</div>
                      <div style="background:#fff;padding:8px 12px;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                        <span style="font-size:12px;color:#6b7280;display:block;margin-bottom:2px;">æ–°åˆ°æœŸæ—¥</span>
                        <span style="font-size:15px;font-weight:600;color:#1f2937;">${formatDate(adj.new_due_date)}</span>
                      </div>
                      <div style="background:${daysChanged > 0 ? '#fef2f2' : '#f0fdf4'};color:${daysChanged > 0 ? '#dc2626' : '#059669'};padding:8px 12px;border-radius:6px;border:1px solid ${daysChanged > 0 ? '#fecaca' : '#bbf7d0'};font-weight:600;">
                        ${daysChanged > 0 ? 'å»¶å¾Œ' : 'æå‰'} ${Math.abs(daysChanged)} å¤©
                      </div>
                    </div>
                  </div>
                </div>
                
                ${isSystemAuto ? '<div style="background:rgba(245,158,11,0.1);border-left:3px solid #f59e0b;color:#92400e;padding:10px 12px;border-radius:4px;font-size:13px;margin-bottom:12px;">ğŸ’¡ ç³»çµ±æª¢æ¸¬åˆ°å‰ç½®ä»»å‹™å»¶é²å®Œæˆï¼Œå·²è‡ªå‹•èª¿æ•´å¾ŒçºŒä»»å‹™æœŸé™</div>' : ''}
                
                <div style="background:#fff;padding:12px;border-radius:6px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                  <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ğŸ“ èª¿æ•´åŸå› </div>
                  <div style="font-size:14px;color:#1f2937;line-height:1.5;">${adj.adjustment_reason || 'ç„¡èªªæ˜'}</div>
                </div>
                
                <div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;color:#6b7280;">
                  <span>ğŸ‘¤ ${isSystemAuto ? 'ç³»çµ±è‡ªå‹•èª¿æ•´' : `ç”± ${adj.requested_by_name || 'ç³»çµ±'} èª¿æ•´`}</span>
                  <span>ğŸ• ${formatDateTime(adj.requested_at)}</span>
                </div>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        
        const modal = document.createElement('div');
        modal.style.cssText = 'display:flex;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(2px);';
        modal.innerHTML = `
          <div style="background:white;border-radius:12px;padding:24px;max-width:800px;width:90%;max-height:85vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            ${html}
            <div style="margin-top:20px;text-align:center;">
              <button class="btn" onclick="this.closest('div[style*=fixed]').remove()" style="background:linear-gradient(135deg, #6b7280 0%, #4b5563 100%);color:#fff;padding:10px 32px;border:none;box-shadow:0 2px 4px rgba(0,0,0,0.2);min-width:120px;">é—œé–‰</button>
            </div>
          </div>
        `;
        modal.onclick = (e) => {
          if (e.target === modal) modal.remove();
        };
        document.body.appendChild(modal);
        
      } catch (err) {
        console.error('è¼‰å…¥èª¿æ•´æ­·å²å¤±æ•—:', err);
        alert('è¼‰å…¥å¤±æ•—');
      }
    }

    // é¡¯ç¤ºç®¡ç† SOP å½ˆçª—
    function showManageSOPModal() {
      const modal = document.getElementById('sopModal');
      const container = document.getElementById('sopCheckboxList');
      
      // ç²å–ç•¶å‰ä»»å‹™å·²é—œè¯çš„ SOP ID
      const linkedSOPIds = taskSOPs.map(s => s.id);
      console.log('ç•¶å‰å·²é—œè¯çš„ SOP IDs:', linkedSOPIds);
      console.log('æ‰€æœ‰å¯ç”¨çš„ SOP:', allSOPs.length);
      
      // æŒ‰åˆ†é¡åˆ†çµ„ SOP
      const sopByCategory = {};
      allSOPs.forEach(sop => {
        const cat = sop.category || 'other';
        if (!sopByCategory[cat]) sopByCategory[cat] = [];
        sopByCategory[cat].push(sop);
      });
      
      let html = '';
      Object.keys(sopByCategory).forEach(cat => {
        html += `<div style="margin-bottom: 16px;">
          <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">${getCategoryText(cat)}</div>`;
        
        sopByCategory[cat].forEach(sop => {
          const isLinked = linkedSOPIds.includes(sop.id);
          const checked = isLinked ? 'checked' : '';
          console.log(`SOP ${sop.id} (${sop.title}): å·²é—œè¯=${isLinked}, checked="${checked}"`);
          
          html += `
            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 4px;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='transparent'">
              <input type="checkbox" value="${sop.id}" ${checked} style="cursor: pointer;" />
              <span style="flex: 1;">${sop.title}</span>
              <span style="font-size: 12px; color: #9ca3af;">v${sop.version}</span>
            </label>
          `;
        });
        
        html += '</div>';
      });
      
      if (allSOPs.length === 0) {
        html = '<p style="color: #9ca3af;">å°šç„¡å¯ç”¨çš„ SOP</p>';
      }
      
      container.innerHTML = html;
      modal.style.display = 'flex';
      
      console.log('å½ˆçª—å·²é–‹å•Ÿï¼ŒHTML å·²ç”Ÿæˆ');
    }

    // é—œé–‰ SOP å½ˆçª—
    function closeSOPModal() {
      document.getElementById('sopModal').style.display = 'none';
    }

    // å„²å­˜ SOP é—œè¯
    async function saveSOPLinks() {
      const checkboxes = document.querySelectorAll('#sopCheckboxList input[type="checkbox"]:checked');
      const sopIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
      
      console.log('æº–å‚™å„²å­˜ SOP é—œè¯:', sopIds);

      try {
        const url = `${apiBase}/tasks/${currentTaskId}/sops`;
        console.log('API URL:', url);
        
        const res = await fetch(url, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ sop_ids: sopIds })
        });
        
        console.log('éŸ¿æ‡‰ç‹€æ…‹:', res.status);
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        console.log('éŸ¿æ‡‰æ•¸æ“š:', json);
        
        if (!json.ok) {
          alert(json.message || 'å„²å­˜å¤±æ•—');
          return;
        }

        alert('SOP é—œè¯å·²æ›´æ–°');
        closeSOPModal();
        await loadTaskSOPs();
        
      } catch (err) {
        console.error('å„²å­˜ SOP é—œè¯å¤±æ•—:', err);
        alert('å„²å­˜å¤±æ•—: ' + err.message);
      }
    }

    // ä¸Šå‚³ä»»å‹™æ–‡æª”
    function uploadTaskDocument() {
      const fileInput = document.getElementById('fileInput');
      fileInput.onchange = async function() {
        if (!this.files || this.files.length === 0) return;
        
        const file = this.files[0];
        
        // é©—è­‰æ–‡ä»¶å¤§å°
        if (file.size > 10 * 1024 * 1024) {
          alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…é 10MB');
          return;
        }
        
        try {
          // ç²å–ä¸Šå‚³ç°½å
          const signRes = await fetch(`${apiBase}/attachments/upload-sign`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              entity_type: 'task',
              entity_id: currentTaskId,
              filename: file.name,
              content_type: file.type || 'application/octet-stream',
              content_length: file.size
            })
          });
          
          if (signRes.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
          const signJson = await signRes.json();
          
          if (!signJson.ok) {
            alert(signJson.message || 'ç²å–ä¸Šå‚³ç°½åå¤±æ•—');
            return;
          }
          
          // ä¸Šå‚³æ–‡ä»¶
          const uploadRes = await fetch(signJson.data.uploadUrl, {
            method: 'PUT',
            headers: signJson.data.headers,
            body: file
          });
          
          if (!uploadRes.ok) {
            alert('ä¸Šå‚³å¤±æ•—');
            return;
          }
          
          alert('ä¸Šå‚³æˆåŠŸ');
          await loadTaskDocuments();
          
        } catch (err) {
          console.error('ä¸Šå‚³æ–‡æª”å¤±æ•—:', err);
          alert('ä¸Šå‚³å¤±æ•—');
        } finally {
          this.value = ''; // é‡ç½®æ–‡ä»¶è¼¸å…¥
        }
      };
      
      fileInput.click();
    }

    // ä¸‹è¼‰æ–‡æª”
    async function downloadDocument(attachmentId, filename) {
      try {
        const res = await fetch(`${apiBase}/attachments/${attachmentId}/download`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        if (!res.ok) {
          alert('ä¸‹è¼‰å¤±æ•—');
          return;
        }
        
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
      } catch (err) {
        console.error('ä¸‹è¼‰æ–‡æª”å¤±æ•—:', err);
        alert('ä¸‹è¼‰å¤±æ•—');
      }
    }

    // åˆªé™¤æ–‡æª”
    async function deleteDocument(attachmentId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ–‡æª”å—ï¼Ÿ')) return;
      
      try {
        const res = await fetch(`${apiBase}/attachments/${attachmentId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || 'åˆªé™¤å¤±æ•—');
          return;
        }

        await loadTaskDocuments();
        
      } catch (err) {
        console.error('åˆªé™¤æ–‡æª”å¤±æ•—:', err);
        alert('åˆªé™¤å¤±æ•—');
      }
    }

    // è¼”åŠ©å‡½æ•¸
    function getCategoryText(category) {
      const categoryMap = {
        'accounting': 'è¨˜å¸³æµç¨‹',
        'tax': 'ç¨…å‹™æµç¨‹',
        'business': 'å·¥å•†ç™»è¨˜',
        'internal': 'å…§éƒ¨æµç¨‹',
        'other': 'å…¶ä»–'
      };
      return categoryMap[category] || category;
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleString('zh-TW', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
    init();
  </script>
</body>
</html>

