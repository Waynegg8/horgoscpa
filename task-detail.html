<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>任務詳情 - 內部系統</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
  <link rel="stylesheet" href="/assets/css/client-detail-page.css?v=30">
  <link rel="stylesheet" href="/assets/css/task-detail-page.css?v=1">
  <style>
    /* 日期選擇器 - 整框可點擊 */
    input[type="date"] {
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      cursor: pointer !important;
      position: relative !important;
    }
    
    /* 讓日曆圖標覆蓋整個輸入框，使整個區域都可以點擊 */
    input[type="date"]::-webkit-calendar-picker-indicator {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100% !important;
      height: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      opacity: 0 !important;
      cursor: pointer !important;
    }
    
    input[type="date"]::-webkit-inner-spin-button {
      display: none !important;
    }
    
    input[type="date"]::-webkit-datetime-edit {
      padding: 0 !important;
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container">
    <div class="page-header-simple">
      <a href="/internal/tasks" class="back-link">← 返回任務列表</a>
      <h1 class="page-title" id="taskTitle">任務詳情</h1>
    </div>

    <!-- 任務基本信息 -->
    <div class="content-card">
      <h2 class="card-title">基本信息</h2>
      <div class="form-row-2col">
        <div class="form-field">
          <label for="taskName">任務名稱</label>
          <input type="text" id="taskName" readonly style="background:#f3f4f6;" />
        </div>
        <div class="form-field">
          <label for="taskStatus">狀態</label>
          <select id="taskStatus">
            <option value="pending">待開始</option>
            <option value="in_progress">進行中</option>
            <option value="completed">已完成</option>
            <option value="cancelled">已取消</option>
          </select>
          <button type="button" class="btn btn-sm btn-secondary" onclick="showUpdateStatusModal()" style="margin-top:8px;">更新狀態說明</button>
        </div>
      </div>
      <div class="form-row-2col">
        <div class="form-field">
          <label for="clientName">客戶</label>
          <input type="text" id="clientName" readonly style="background:#f3f4f6;" />
        </div>
        <div class="form-field">
          <label for="assigneeUser">負責人</label>
          <select id="assigneeUser">
            <option value="">載入中...</option>
          </select>
        </div>
      </div>
      <div class="form-row-2col">
        <div class="form-field">
          <label for="dueDate">到期日</label>
          <input type="date" id="dueDate" readonly style="background:#f3f4f6;cursor:pointer;" />
          <button type="button" class="btn btn-sm btn-secondary" onclick="showAdjustDueDateModal()" style="margin-top:8px;">調整到期日</button>
          <button type="button" class="btn btn-sm btn-link" onclick="showAdjustmentHistory()" style="margin-top:8px;margin-left:8px;">查看調整歷史</button>
        </div>
        <div class="form-field">
          <label>進度</label>
          <div style="display: flex; align-items: center; gap: 12px; padding: 10px 0;">
            <div class="progress-bar" style="flex: 1;">
              <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <span id="progressText" style="font-weight: 600; font-size: 14px; color: #1f2937;">0/0</span>
          </div>
        </div>
      </div>
      <div class="form-row-1col">
        <div class="form-field">
          <label for="taskNotes">備註</label>
          <textarea id="taskNotes" rows="3"></textarea>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-primary" onclick="saveTaskInfo()">儲存變更</button>
      </div>
    </div>

    <!-- 關聯的 SOP -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">📖 關聯的 SOP</h2>
        <button class="btn btn-primary btn-sm" onclick="showManageSOPModal()">管理 SOP</button>
      </div>
      <div id="sopList" class="sop-list">
        <p style="color: #9ca3af;">載入中...</p>
      </div>
    </div>

    <!-- 任務文檔 -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">📎 任務文檔</h2>
        <button class="btn btn-primary btn-sm" onclick="uploadTaskDocument()">+ 上傳文檔</button>
      </div>
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>文件名稱</th>
              <th>文件類型</th>
              <th style="width: 120px;">大小</th>
              <th style="width: 150px;">上傳時間</th>
              <th style="width: 100px;">上傳者</th>
              <th style="width: 120px;">操作</th>
            </tr>
          </thead>
          <tbody id="documentsList">
            <tr>
              <td colspan="6" class="loading-text">載入中...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <!-- 管理 SOP 彈窗 -->
  <div id="sopModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">管理任務 SOP</h3>
        <button onclick="closeSOPModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <p style="color: #6b7280; font-size: 14px; margin-bottom: 12px;">選擇要關聯到此任務的 SOP（可多選）</p>
        <div id="sopCheckboxList" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px;">
          <p style="color: #9ca3af;">載入中...</p>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeSOPModal()">取消</button>
        <button class="btn btn-primary" onclick="saveSOPLinks()">儲存</button>
      </div>
    </div>
  </div>

  <!-- 更新狀態說明彈窗 -->
  <div id="statusModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 24px; max-width: 600px; width: 90%;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">更新狀態說明</h3>
        <button onclick="closeStatusModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">新狀態</label>
        <select id="modal_status" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;">
          <option value="pending">待開始</option>
          <option value="in_progress">進行中</option>
          <option value="completed">已完成</option>
          <option value="cancelled">已取消</option>
        </select>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">進度說明</label>
        <textarea id="modal_progress_note" rows="3" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" placeholder="描述當前進度..."></textarea>
      </div>
      
      <div id="overdue_reason_section" style="margin-bottom: 16px; display:none;">
        <label style="display:block;margin-bottom:6px;font-weight:500;color:#dc2626;">逾期原因 *</label>
        <textarea id="modal_overdue_reason" rows="3" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" placeholder="任務已逾期，請說明原因..."></textarea>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">阻塞原因</label>
        <textarea id="modal_blocker_reason" rows="2" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" placeholder="如果任務被阻塞，請說明原因..."></textarea>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">預計完成日期</label>
        <input type="date" id="modal_expected_date" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeStatusModal()">取消</button>
        <button class="btn btn-primary" onclick="submitStatusUpdate()">更新狀態</button>
      </div>
    </div>
  </div>

  <!-- 調整到期日彈窗 -->
  <div id="dueDateModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 24px; max-width: 500px; width: 90%;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">調整到期日</h3>
        <button onclick="closeDueDateModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">當前到期日</label>
        <input type="text" id="modal_current_due_date" readonly style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;background:#f3f4f6;" />
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;">新到期日 *</label>
        <input type="date" id="modal_new_due_date" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
      </div>
      
      <div style="margin-bottom: 16px;">
        <label style="display:block;margin-bottom:6px;font-weight:500;color:#dc2626;">調整原因 *</label>
        <textarea id="modal_adjustment_reason" rows="4" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" placeholder="請說明為何需要調整到期日..."></textarea>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeDueDateModal()">取消</button>
        <button class="btn btn-primary" onclick="submitDueDateAdjustment()">確認調整</button>
      </div>
    </div>
  </div>

  <!-- 文件上傳隱藏 input -->
  <input type="file" id="fileInput" style="display: none;" accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls,.docx,.doc" />

  <script src="/assets/js/components/bootstrap.js?v=3"></script>
  <script>
    const onProdHost = location.hostname.endsWith('horgoscpa.com');
    const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
    
    let currentTaskId = null;
    let currentTask = null;
    let allUsers = [];
    let allSOPs = [];
    let taskSOPs = [];

    // 初始化
    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      currentTaskId = urlParams.get('id');
      
      if (!currentTaskId) {
        alert('缺少任務ID');
        window.location.href = '/internal/tasks';
        return;
      }

      await Promise.all([
        loadUsers(),
        loadAllSOPs(),
        loadTaskDetail(),
        loadTaskSOPs(),
        loadTaskDocuments()
      ]);
    }

    // 載入員工列表
    async function loadUsers() {
      try {
        const res = await fetch(`${apiBase}/users`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        if (json.ok && json.data) {
          allUsers = json.data;
          const select = document.getElementById('assigneeUser');
          select.innerHTML = '<option value="">未分配</option>' +
            allUsers.map(u => 
              `<option value="${u.user_id}">${u.name || u.username}</option>`
            ).join('');
        }
      } catch (err) {
        console.error('載入員工列表失敗:', err);
      }
    }

    // 載入所有 SOP
    async function loadAllSOPs() {
      try {
        const res = await fetch(`${apiBase}/sop?perPage=100`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        if (json.ok && json.data) {
          allSOPs = json.data;
        }
      } catch (err) {
        console.error('載入 SOP 列表失敗:', err);
      }
    }

    // 載入任務詳情
    async function loadTaskDetail() {
      try {
        const url = `${apiBase}/tasks/${currentTaskId}`;
        console.log('載入任務詳情 URL:', url);
        
        const res = await fetch(url, { credentials: 'include' });
        console.log('任務詳情響應狀態:', res.status);
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        if (res.status === 404) {
          alert('任務不存在');
          window.location.href = '/internal/tasks';
          return;
        }
        
        const json = await res.json();
        console.log('任務詳情數據:', json);
        
        if (!json.ok) {
          alert(json.message || '載入失敗');
          return;
        }

        currentTask = json.data;
        console.log('當前任務:', currentTask);
        
        // 更新頁面
        document.getElementById('taskTitle').textContent = currentTask.task_name || '任務詳情';
        document.getElementById('taskName').value = currentTask.task_name || '';
        document.getElementById('taskStatus').value = currentTask.status || 'pending';
        document.getElementById('clientName').value = currentTask.client_name || '';
        document.getElementById('assigneeUser').value = currentTask.assignee_user_id || '';
        document.getElementById('dueDate').value = currentTask.due_date || '';
        document.getElementById('taskNotes').value = currentTask.notes || '';
        
        console.log('已填充表單字段');
        
        // 更新進度
        updateProgress(currentTask.completed_stages || 0, currentTask.total_stages || 0);
        
      } catch (err) {
        console.error('載入任務詳情失敗:', err);
        alert('載入失敗: ' + err.message);
      }
    }

    // 更新進度
    function updateProgress(completed, total) {
      const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
      document.getElementById('progressFill').style.width = percentage + '%';
      document.getElementById('progressText').textContent = `${completed}/${total}`;
    }

    // 載入任務關聯的 SOP
    async function loadTaskSOPs() {
      try {
        const res = await fetch(`${apiBase}/tasks/${currentTaskId}/sops`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        
        const json = await res.json();
        console.log('載入 SOP 數據:', json);
        
        const container = document.getElementById('sopList');
        
        if (!json.ok || !json.data || json.data.length === 0) {
          container.innerHTML = '<p style="color: #9ca3af;">此任務尚未關聯任何 SOP</p>';
          taskSOPs = [];
          return;
        }

        taskSOPs = json.data;
        console.log('SOP 列表:', taskSOPs);
        console.log('第一個 SOP 詳情:', JSON.stringify(taskSOPs[0], null, 2));
        
        container.innerHTML = taskSOPs.map(sop => {
          console.log('渲染 SOP:', sop);
          return `
            <div class="sop-item">
              <div>
                <div class="sop-title">${sop.title || '未命名'}</div>
                <div class="sop-meta">${getCategoryText(sop.category)} • v${sop.version || '1'}</div>
              </div>
              <a href="/internal/knowledge?id=${sop.id}" target="_blank" class="btn btn-sm btn-secondary">查看</a>
            </div>
          `;
        }).join('');
        
      } catch (err) {
        console.error('載入任務 SOP 失敗:', err);
        document.getElementById('sopList').innerHTML = '<p style="color: #ef4444;">載入失敗</p>';
      }
    }

    // 載入任務文檔
    async function loadTaskDocuments() {
      try {
        const url = `${apiBase}/attachments?entity_type=task&entity_id=${currentTaskId}`;
        console.log('載入附件 URL:', url);
        
        const res = await fetch(url, { credentials: 'include' });
        console.log('附件響應狀態:', res.status);
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        
        const json = await res.json();
        console.log('附件數據:', json);
        
        const tbody = document.getElementById('documentsList');
        
        if (!json.ok || !json.data || json.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #9ca3af;">尚無文檔</td></tr>';
          return;
        }

        tbody.innerHTML = json.data.map(doc => `
          <tr>
            <td>${doc.filename || '未知文件'}</td>
            <td>${doc.contentType || '-'}</td>
            <td>${formatFileSize(doc.sizeBytes || 0)}</td>
            <td>${formatDateTime(doc.uploadedAt)}</td>
            <td>${doc.uploaderName || '未知'}</td>
            <td>
              <button class="table-btn-link" onclick="downloadDocument(${doc.id}, '${(doc.filename || 'file').replace(/'/g, "\\'")}')">下載</button>
              <button class="table-btn-link danger" onclick="deleteDocument(${doc.id})">刪除</button>
            </td>
          </tr>
        `).join('');
        
      } catch (err) {
        console.error('載入任務文檔失敗:', err);
        document.getElementById('documentsList').innerHTML = '<tr><td colspan="6" style="color: #ef4444;">載入失敗: ' + err.message + '</td></tr>';
      }
    }

    // 儲存任務信息
    async function saveTaskInfo() {
      const data = {
        assignee_user_id: document.getElementById('assigneeUser').value ? parseInt(document.getElementById('assigneeUser').value) : null,
        notes: document.getElementById('taskNotes').value.trim()
      };

      try {
        const res = await fetch(`${apiBase}/tasks/${currentTaskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '儲存失敗');
          return;
        }

        alert('已儲存');
        await loadTaskDetail();
        
      } catch (err) {
        console.error('儲存任務信息失敗:', err);
        alert('儲存失敗');
      }
    }
    
    // 顯示更新狀態模態框
    function showUpdateStatusModal() {
      const modal = document.getElementById('statusModal');
      const currentStatus = document.getElementById('taskStatus').value;
      document.getElementById('modal_status').value = currentStatus;
      
      // 檢查是否逾期
      const dueDate = document.getElementById('dueDate').value;
      const today = new Date().toISOString().split('T')[0];
      const isOverdue = dueDate && dueDate < today && currentTask.status !== 'completed';
      
      document.getElementById('overdue_reason_section').style.display = isOverdue ? 'block' : 'none';
      modal.style.display = 'flex';
    }
    
    function closeStatusModal() {
      document.getElementById('statusModal').style.display = 'none';
    }
    
    async function submitStatusUpdate() {
      const status = document.getElementById('modal_status').value;
      const progress_note = document.getElementById('modal_progress_note').value.trim();
      const overdue_reason = document.getElementById('modal_overdue_reason').value.trim();
      const blocker_reason = document.getElementById('modal_blocker_reason').value.trim();
      const expected_date = document.getElementById('modal_expected_date').value;
      
      // 檢查是否逾期且需要填寫原因
      const overdueSection = document.getElementById('overdue_reason_section');
      if (overdueSection.style.display !== 'none' && !overdue_reason) {
        alert('任務已逾期，必須填寫逾期原因');
        return;
      }
      
      const data = {
        status,
        progress_note,
        overdue_reason,
        blocker_reason,
        expected_completion_date: expected_date || null
      };
      
      try {
        const res = await fetch(`${apiBase}/tasks/${currentTaskId}/update-status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '更新失敗');
          return;
        }
        
        alert('狀態已更新');
        closeStatusModal();
        await loadTaskDetail();
        
      } catch (err) {
        console.error('更新狀態失敗:', err);
        alert('更新失敗');
      }
    }
    
    // 顯示調整到期日模態框
    function showAdjustDueDateModal() {
      const modal = document.getElementById('dueDateModal');
      const currentDueDate = document.getElementById('dueDate').value;
      document.getElementById('modal_current_due_date').value = currentDueDate || '未設定';
      document.getElementById('modal_new_due_date').value = currentDueDate;
      document.getElementById('modal_adjustment_reason').value = '';
      modal.style.display = 'flex';
    }
    
    function closeDueDateModal() {
      document.getElementById('dueDateModal').style.display = 'none';
    }
    
    async function submitDueDateAdjustment() {
      const new_due_date = document.getElementById('modal_new_due_date').value;
      const reason = document.getElementById('modal_adjustment_reason').value.trim();
      
      if (!new_due_date) {
        alert('請選擇新的到期日');
        return;
      }
      
      if (!reason) {
        alert('必須填寫調整原因');
        return;
      }
      
      const data = { new_due_date, reason };
      
      try {
        const res = await fetch(`${apiBase}/tasks/${currentTaskId}/adjust-due-date`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '調整失敗');
          return;
        }
        
        alert('到期日已調整');
        closeDueDateModal();
        await loadTaskDetail();
        
      } catch (err) {
        console.error('調整到期日失敗:', err);
        alert('調整失敗');
      }
    }
    
    // 顯示調整歷史
    async function showAdjustmentHistory() {
      try {
        const res = await fetch(`${apiBase}/tasks/${currentTaskId}/adjustment-history`, {
          credentials: 'include'
        });
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        if (!json.ok || !json.data) {
          alert('載入失敗');
          return;
        }
        
        const history = json.data;
        if (history.length === 0) {
          alert('沒有調整歷史');
          return;
        }
        
        let html = '<h3 style="margin-bottom:16px;">到期日調整歷史</h3>';
        html += '<div style="max-height:500px;overflow-y:auto;">';
        history.forEach(adj => {
          const typeLabels = {
            'initial_create': '初始創建',
            'manual_adjust': '手動調整',
            'system_auto': '系統自動',
            'overdue_adjust': '逾期調整'
          };
          html += `
            <div style="border:1px solid #e5e7eb;border-radius:6px;padding:12px;margin-bottom:12px;">
              <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                <span style="font-weight:600;">${typeLabels[adj.adjustment_type] || adj.adjustment_type}</span>
                <span style="color:#6b7280;font-size:13px;">${adj.requested_at}</span>
              </div>
              <div style="font-size:14px;margin-bottom:6px;">
                <span style="color:#6b7280;">原到期日:</span> ${adj.old_due_date}
                <span style="margin:0 8px;">→</span>
                <span style="color:#6b7280;">新到期日:</span> ${adj.new_due_date}
                <span style="margin-left:12px;color:${adj.days_changed > 0 ? '#dc2626' : '#059669'};">
                  ${adj.days_changed > 0 ? '+' : ''}${adj.days_changed} 天
                </span>
              </div>
              <div style="font-size:14px;color:#4b5563;">
                <strong>原因:</strong> ${adj.adjustment_reason || '無'}
              </div>
              <div style="font-size:13px;color:#6b7280;margin-top:4px;">
                由 ${adj.requested_by_name} 調整
              </div>
            </div>
          `;
        });
        html += '</div>';
        
        const modal = document.createElement('div');
        modal.style.cssText = 'display:flex;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;';
        modal.innerHTML = `
          <div style="background:white;border-radius:8px;padding:24px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto;">
            ${html}
            <div style="margin-top:20px;text-align:right;">
              <button class="btn btn-secondary" onclick="this.closest('div[style*=fixed]').remove()">關閉</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
      } catch (err) {
        console.error('載入調整歷史失敗:', err);
        alert('載入失敗');
      }
    }

    // 顯示管理 SOP 彈窗
    function showManageSOPModal() {
      const modal = document.getElementById('sopModal');
      const container = document.getElementById('sopCheckboxList');
      
      // 獲取當前任務已關聯的 SOP ID
      const linkedSOPIds = taskSOPs.map(s => s.id);
      console.log('當前已關聯的 SOP IDs:', linkedSOPIds);
      console.log('所有可用的 SOP:', allSOPs.length);
      
      // 按分類分組 SOP
      const sopByCategory = {};
      allSOPs.forEach(sop => {
        const cat = sop.category || 'other';
        if (!sopByCategory[cat]) sopByCategory[cat] = [];
        sopByCategory[cat].push(sop);
      });
      
      let html = '';
      Object.keys(sopByCategory).forEach(cat => {
        html += `<div style="margin-bottom: 16px;">
          <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">${getCategoryText(cat)}</div>`;
        
        sopByCategory[cat].forEach(sop => {
          const isLinked = linkedSOPIds.includes(sop.id);
          const checked = isLinked ? 'checked' : '';
          console.log(`SOP ${sop.id} (${sop.title}): 已關聯=${isLinked}, checked="${checked}"`);
          
          html += `
            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 4px;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='transparent'">
              <input type="checkbox" value="${sop.id}" ${checked} style="cursor: pointer;" />
              <span style="flex: 1;">${sop.title}</span>
              <span style="font-size: 12px; color: #9ca3af;">v${sop.version}</span>
            </label>
          `;
        });
        
        html += '</div>';
      });
      
      if (allSOPs.length === 0) {
        html = '<p style="color: #9ca3af;">尚無可用的 SOP</p>';
      }
      
      container.innerHTML = html;
      modal.style.display = 'flex';
      
      console.log('彈窗已開啟，HTML 已生成');
    }

    // 關閉 SOP 彈窗
    function closeSOPModal() {
      document.getElementById('sopModal').style.display = 'none';
    }

    // 儲存 SOP 關聯
    async function saveSOPLinks() {
      const checkboxes = document.querySelectorAll('#sopCheckboxList input[type="checkbox"]:checked');
      const sopIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
      
      console.log('準備儲存 SOP 關聯:', sopIds);

      try {
        const url = `${apiBase}/tasks/${currentTaskId}/sops`;
        console.log('API URL:', url);
        
        const res = await fetch(url, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ sop_ids: sopIds })
        });
        
        console.log('響應狀態:', res.status);
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        console.log('響應數據:', json);
        
        if (!json.ok) {
          alert(json.message || '儲存失敗');
          return;
        }

        alert('SOP 關聯已更新');
        closeSOPModal();
        await loadTaskSOPs();
        
      } catch (err) {
        console.error('儲存 SOP 關聯失敗:', err);
        alert('儲存失敗: ' + err.message);
      }
    }

    // 上傳任務文檔
    function uploadTaskDocument() {
      const fileInput = document.getElementById('fileInput');
      fileInput.onchange = async function() {
        if (!this.files || this.files.length === 0) return;
        
        const file = this.files[0];
        
        // 驗證文件大小
        if (file.size > 10 * 1024 * 1024) {
          alert('文件大小不能超過 10MB');
          return;
        }
        
        try {
          // 獲取上傳簽名
          const signRes = await fetch(`${apiBase}/attachments/upload-sign`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              entity_type: 'task',
              entity_id: currentTaskId,
              filename: file.name,
              content_type: file.type || 'application/octet-stream',
              content_length: file.size
            })
          });
          
          if (signRes.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
          const signJson = await signRes.json();
          
          if (!signJson.ok) {
            alert(signJson.message || '獲取上傳簽名失敗');
            return;
          }
          
          // 上傳文件
          const uploadRes = await fetch(signJson.data.uploadUrl, {
            method: 'PUT',
            headers: signJson.data.headers,
            body: file
          });
          
          if (!uploadRes.ok) {
            alert('上傳失敗');
            return;
          }
          
          alert('上傳成功');
          await loadTaskDocuments();
          
        } catch (err) {
          console.error('上傳文檔失敗:', err);
          alert('上傳失敗');
        } finally {
          this.value = ''; // 重置文件輸入
        }
      };
      
      fileInput.click();
    }

    // 下載文檔
    async function downloadDocument(attachmentId, filename) {
      try {
        const res = await fetch(`${apiBase}/attachments/${attachmentId}/download`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        if (!res.ok) {
          alert('下載失敗');
          return;
        }
        
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
      } catch (err) {
        console.error('下載文檔失敗:', err);
        alert('下載失敗');
      }
    }

    // 刪除文檔
    async function deleteDocument(attachmentId) {
      if (!confirm('確定要刪除此文檔嗎？')) return;
      
      try {
        const res = await fetch(`${apiBase}/attachments/${attachmentId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '刪除失敗');
          return;
        }

        await loadTaskDocuments();
        
      } catch (err) {
        console.error('刪除文檔失敗:', err);
        alert('刪除失敗');
      }
    }

    // 輔助函數
    function getCategoryText(category) {
      const categoryMap = {
        'accounting': '記帳流程',
        'tax': '稅務流程',
        'business': '工商登記',
        'internal': '內部流程',
        'other': '其他'
      };
      return categoryMap[category] || category;
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleString('zh-TW', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // 頁面加載時初始化
    init();
  </script>
</body>
</html>

