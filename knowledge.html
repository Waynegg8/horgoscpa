<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="å…§éƒ¨çŸ¥è­˜åº«" />
    <title>çŸ¥è­˜åº«ï½œSOP / FAQ / è³‡æºä¸­å¿ƒ</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/knowledge-page.css" />
    <!-- Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <style>
      .tabs {
        display: flex;
        gap: 8px;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 20px;
      }
      .tab-button {
        padding: 12px 24px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        color: #6b7280;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
      }
      .tab-button:hover {
        color: #1f2937;
        background: #f9fafb;
      }
      .tab-button.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        overflow-y: auto;
      }
      .modal.show {
        display: block;
      }
      .modal-content {
        background-color: white;
        margin: 50px auto;
        padding: 30px;
        border-radius: 12px;
        max-width: 800px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e5e7eb;
      }
      .modal-header h2 {
        margin: 0;
        font-size: 22px;
        font-weight: 700;
        color: #1f2937;
      }
      .close-modal {
        font-size: 28px;
        font-weight: bold;
        color: #9ca3af;
        cursor: pointer;
        border: none;
        background: none;
        padding: 0;
        line-height: 1;
      }
      .close-modal:hover {
        color: #4b5563;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
        font-size: 14px;
      }
      .form-group input[type="text"],
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
      }
      .form-group textarea {
        min-height: 100px;
        font-family: inherit;
      }
      #editor-container {
        min-height: 300px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
      }
      .file-upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }
      .file-upload-area:hover {
        border-color: #2563eb;
        background: #f0f7ff;
      }
      .file-upload-area.dragover {
        border-color: #2563eb;
        background: #dbeafe;
      }
      .uploaded-file-info {
        margin-top: 16px;
        padding: 12px;
        background: #f0f7ff;
        border-radius: 6px;
        display: none;
      }
      .uploaded-file-info.show {
        display: block;
      }
    </style>
  </head>
  <body class="knowledge-page">
    <header class="page-header" style="padding:16px 20px;display:flex;align-items:center;gap:12px;">
      <h1 class="page-title" style="margin:0;font-size:24px;font-weight:800;color:var(--text-primary);">å…§éƒ¨çŸ¥è­˜åº«</h1>
      <div id="permBar" class="info-bar" style="display:none;" role="alert">æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œ</div>
    </header>

    <!-- Tabåˆ‡æ¢ -->
    <section style="padding:0 20px;">
      <div class="tabs">
        <button class="tab-button active" data-tab="sop">ğŸ“– SOP æµç¨‹æ–‡æª”</button>
        <button class="tab-button" data-tab="faq">â“ FAQ å¸¸è¦‹å•ç­”</button>
        <button class="tab-button" data-tab="resources">ğŸ“ è³‡æºä¸­å¿ƒ</button>
      </div>
    </section>

    <!-- ç­›é€‰åŒºåŸŸ -->
    <section class="filters" style="padding:0 20px 16px 20px;display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;">
      <div style="flex:1;min-width:220px;">
        <label for="q" style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px;">æœå°‹</label>
        <input id="q" type="search" placeholder="æœå°‹æ¨™é¡Œ/å…§å®¹â€¦" aria-label="æœå°‹" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;width:100%;" />
      </div>
      <div>
        <label for="category" style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px;">åˆ†é¡</label>
        <select id="category" aria-label="åˆ†é¡" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;min-width:160px;">
          <option value="all">å…¨éƒ¨</option>
          <option value="accounting">è¨˜å¸³æµç¨‹</option>
          <option value="tax">ç¨…å‹™æµç¨‹</option>
          <option value="business">å·¥å•†ç™»è¨˜</option>
          <option value="hr">äººäº‹ç®¡ç†</option>
          <option value="finance">è²¡å‹™ç®¡ç†</option>
          <option value="contract">åˆåŒç¯„æœ¬</option>
          <option value="internal">å…§éƒ¨æµç¨‹</option>
          <option value="other">å…¶ä»–</option>
        </select>
      </div>
      <div style="flex:1;min-width:220px;">
        <label for="tags" style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px;">æ¨™ç±¤ï¼ˆä»¥é€—è™Ÿåˆ†éš”ï¼‰</label>
        <input id="tags" type="text" placeholder="ä¾‹å¦‚ï¼šå ±ç¨…, æœˆçµ, æé†’" aria-label="æ¨™ç±¤" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;width:100%;" />
      </div>
      <div class="toolbar-spacer" style="flex:1;"></div>
      <div>
        <button id="btn-new" class="btn primary" type="button">+ æ–°å¢</button>
      </div>
    </section>

    <!-- åˆ—è¡¨åŒºåŸŸ -->
    <main class="content" style="padding:0 20px 24px 20px;">
      <!-- SOP Tab -->
      <div id="sop-content" class="tab-content active">
      <section class="list-card" style="background:white;border:1px solid rgba(15,23,42,0.08);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.04);padding:16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 6px 12px 6px;border-bottom:1px solid #f0f0f0;margin-bottom:10px;">
          <div style="font-weight:800;color:var(--text-primary);">SOP åˆ—è¡¨</div>
            <div id="sopListInfo" class="muted">â€”</div>
        </div>
        <div id="sopsList"></div>
        <div class="pagination" style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;">
            <button id="sop-prev" type="button" class="btn">ä¸Šä¸€é </button>
            <button id="sop-next" type="button" class="btn">ä¸‹ä¸€é </button>
          </div>
        </section>
      </div>

      <!-- FAQ Tab -->
      <div id="faq-content" class="tab-content">
        <section class="list-card" style="background:white;border:1px solid rgba(15,23,42,0.08);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.04);padding:16px;">
          <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 6px 12px 6px;border-bottom:1px solid #f0f0f0;margin-bottom:10px;">
            <div style="font-weight:800;color:var(--text-primary);">FAQ åˆ—è¡¨</div>
            <div id="faqListInfo" class="muted">â€”</div>
          </div>
          <div id="faqsList"></div>
          <div class="pagination" style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;">
            <button id="faq-prev" type="button" class="btn">ä¸Šä¸€é </button>
            <button id="faq-next" type="button" class="btn">ä¸‹ä¸€é </button>
          </div>
        </section>
      </div>

      <!-- èµ„æºä¸­å¿ƒ Tab -->
      <div id="resources-content" class="tab-content">
        <!-- ä¸Šå‚³å€åŸŸ -->
        <section class="list-card" style="background:white;border:1px solid rgba(15,23,42,0.08);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.04);padding:20px;margin-bottom:20px;">
          <h3 style="margin:0 0 16px 0;font-size:16px;font-weight:700;color:var(--text-primary);">ğŸ“¤ ä¸Šå‚³æ–‡æª”</h3>
          
          <form id="resourceFormInline">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
              <div class="form-group" style="margin:0;">
                <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-secondary);">æ–‡æª”æ¨™é¡Œ *</label>
                <input type="text" id="resource-title-inline" required style="width:100%;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;" placeholder="è«‹è¼¸å…¥æ–‡æª”æ¨™é¡Œ" />
              </div>
              
              <div class="form-group" style="margin:0;">
                <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-secondary);">åˆ†é¡</label>
                <select id="resource-category-inline" style="width:100%;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
                  <option value="">è«‹é¸æ“‡</option>
                  <option value="contract">åˆåŒç¯„æœ¬</option>
                  <option value="finance">è²¡å‹™è¡¨æ ¼</option>
                  <option value="hr">äººäº‹æ–‡æª”</option>
                  <option value="tax">ç¨…å‹™åƒè€ƒ</option>
                  <option value="other">å…¶ä»–</option>
                </select>
              </div>
            </div>
            
            <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:16px;">
              <div class="form-group" style="margin:0;">
                <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-secondary);">æè¿°</label>
                <textarea id="resource-description-inline" rows="2" style="width:100%;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;resize:vertical;" placeholder="æ–‡æª”ç°¡ä»‹ï¼ˆå¯é¸ï¼‰"></textarea>
              </div>
              
              <div class="form-group" style="margin:0;">
                <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-secondary);">æ¨™ç±¤</label>
                <input type="text" id="resource-tags-inline" style="width:100%;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;" placeholder="ç¯„æœ¬, é‡è¦" />
                <div style="font-size:11px;color:#6b7280;margin-top:4px;">ä»¥é€—è™Ÿåˆ†éš”</div>
              </div>
            </div>
            
            <div class="form-group" style="margin:0 0 16px 0;">
              <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-secondary);">é¸æ“‡æ–‡ä»¶ *</label>
              <div class="file-upload-area" id="fileUploadAreaInline" style="border:2px dashed rgba(15,23,42,0.2);border-radius:12px;padding:32px;text-align:center;cursor:pointer;background:#f9fafb;transition:all 0.2s;">
                <div style="font-size:48px;margin-bottom:12px;">ğŸ“</div>
                <div style="font-weight:600;margin-bottom:8px;color:var(--text-primary);">é»æ“Šæˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤è™•</div>
                <div style="font-size:13px;color:#6b7280;">æ”¯æŒ PDF, Word, Excel, PowerPoint, åœ–ç‰‡ç­‰æ ¼å¼</div>
                <input type="file" id="file-input-inline" style="display:none;" />
              </div>
              <div class="uploaded-file-info" id="uploadedFileInfoInline" style="display:none;margin-top:12px;padding:12px;background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;">
                <div style="font-weight:600;margin-bottom:4px;color:#0369a1;">å·²é¸æ“‡æ–‡ä»¶ï¼š</div>
                <div id="fileNameInline" style="color:#0c4a6e;"></div>
                <div id="fileSizeInline" style="font-size:12px;color:#075985;margin-top:4px;"></div>
              </div>
            </div>
            
            <div style="display:flex;gap:10px;justify-content:flex-end;">
              <button type="button" class="btn" onclick="resetUploadForm()">æ¸…ç©º</button>
              <button type="submit" class="btn primary" id="resourceSubmitBtnInline">
                <span>ğŸ“¤ ä¸Šå‚³æ–‡æª”</span>
              </button>
            </div>
          </form>
        </section>
        
        <!-- æ–‡æª”åˆ—è¡¨ -->
        <section class="list-card" style="background:white;border:1px solid rgba(15,23,42,0.08);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.04);padding:16px;">
          <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 6px 12px 6px;border-bottom:1px solid #f0f0f0;margin-bottom:16px;">
            <div style="font-weight:800;color:var(--text-primary);">ğŸ“ å·²ä¸Šå‚³æ–‡æª”</div>
            <div id="resourcesListInfo" class="muted">â€”</div>
          </div>
          
          <!-- æœç´¢å’Œç¯©é¸ -->
          <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-bottom:16px;">
            <div>
              <input type="text" id="resources-search" placeholder="ğŸ” æœç´¢æ–‡æª”æ¨™é¡Œ..." 
                style="width:100%;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;font-size:14px;" />
            </div>
            <div>
              <select id="resources-category-filter" 
                style="width:100%;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;font-size:14px;">
                <option value="">ğŸ“‚ å…¨éƒ¨åˆ†é¡</option>
                <option value="contract">ğŸ“„ åˆåŒç¯„æœ¬</option>
                <option value="finance">ğŸ’° è²¡å‹™è¡¨æ ¼</option>
                <option value="hr">ğŸ‘¥ äººäº‹æ–‡æª”</option>
                <option value="tax">ğŸ“Š ç¨…å‹™åƒè€ƒ</option>
                <option value="other">ğŸ“‹ å…¶ä»–</option>
              </select>
            </div>
          </div>
          
          <div id="resourcesList"></div>
          <div class="pagination" style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;">
            <button id="resources-prev" type="button" class="btn">ä¸Šä¸€é </button>
            <button id="resources-next" type="button" class="btn">ä¸‹ä¸€é </button>
        </div>
      </section>
      </div>
    </main>

    <!-- SOPæ¨¡æ€æ¡† -->
    <div id="sopModal" class="modal" onclick="if(event.target === this) closeSopModal()">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="sopModalTitle">æ–°å¢ SOP</h2>
          <button class="close-modal" onclick="event.stopPropagation(); closeSopModal();">&times;</button>
        </div>
        <form id="sopForm">
          <input type="hidden" id="sop-id" />
          
          <div class="form-group">
            <label for="sop-title">æ¨™é¡Œ *</label>
            <input type="text" id="sop-title" required />
          </div>
          
          <div class="form-group">
            <label for="sop-category">åˆ†é¡</label>
            <select id="sop-category">
              <option value="">è«‹é¸æ“‡</option>
              <option value="accounting">è¨˜å¸³æµç¨‹</option>
              <option value="tax">ç¨…å‹™æµç¨‹</option>
              <option value="business">å·¥å•†ç™»è¨˜</option>
              <option value="hr">äººäº‹ç®¡ç†</option>
              <option value="internal">å…§éƒ¨æµç¨‹</option>
              <option value="other">å…¶ä»–</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="sop-tags">æ¨™ç±¤ï¼ˆä»¥é€—è™Ÿåˆ†éš”ï¼‰</label>
            <input type="text" id="sop-tags" placeholder="ä¾‹å¦‚ï¼šæœˆçµ, å ±ç¨…, å°å¸³" />
          </div>
          
          <div class="form-group">
            <label>å…§å®¹ *</label>
            <div id="sop-editor-container"></div>
          </div>
          
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:24px;">
            <button type="button" class="btn" onclick="closeSopModal()">å–æ¶ˆ</button>
            <button type="submit" class="btn primary">å„²å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <!-- FAQæ¨¡æ€æ¡† -->
    <div id="faqModal" class="modal" onclick="if(event.target === this) closeFaqModal()">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="faqModalTitle">æ–°å¢ FAQ</h2>
          <button class="close-modal" onclick="event.stopPropagation(); closeFaqModal();">&times;</button>
        </div>
        <form id="faqForm">
          <input type="hidden" id="faq-id" />
          
          <div class="form-group">
            <label for="faq-question">å•é¡Œ *</label>
            <input type="text" id="faq-question" required />
          </div>
          
          <div class="form-group">
            <label for="faq-category">åˆ†é¡</label>
            <select id="faq-category">
              <option value="">è«‹é¸æ“‡</option>
              <option value="accounting">è¨˜å¸³æµç¨‹</option>
              <option value="tax">ç¨…å‹™æµç¨‹</option>
              <option value="business">å·¥å•†ç™»è¨˜</option>
              <option value="hr">äººäº‹ç®¡ç†</option>
              <option value="finance">è²¡å‹™ç®¡ç†</option>
              <option value="internal">å…§éƒ¨æµç¨‹</option>
              <option value="other">å…¶ä»–</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="faq-tags">æ¨™ç±¤ï¼ˆä»¥é€—è™Ÿåˆ†éš”ï¼‰</label>
            <input type="text" id="faq-tags" placeholder="ä¾‹å¦‚ï¼šæ–°æ‰‹, å¸¸è¦‹, é‡è¦" />
          </div>
          
          <div class="form-group">
            <label>ç­”æ¡ˆ *</label>
            <div id="faq-editor-container"></div>
          </div>
          
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:24px;">
            <button type="button" class="btn" onclick="closeFaqModal()">å–æ¶ˆ</button>
            <button type="submit" class="btn primary">å„²å­˜</button>
          </div>
        </form>
      </div>
    </div>


    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        let me = null;
        let currentTab = 'sop';
        let sopEditor = null;
        let faqEditor = null;
        
        let sopState = { page:1, perPage:12, total:0 };
        let faqState = { page:1, perPage:12, total:0 };
        let resourcesState = { page:1, perPage:12, total:0, q:'', category:'' };

        // åˆå§‹åŒ–å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼Œåœ¨Modalæ‰“å¼€æ—¶ï¼‰
        function initSopEditor() {
          if (sopEditor) return; // å·²åˆå§‹åŒ–åˆ™è·³è¿‡
          
          sopEditor = new Quill('#sop-editor-container', {
            theme: 'snow',
            modules: {
              toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'indent': '-1'}, { 'indent': '+1' }],
                ['link', 'image'],
                [{ 'color': [] }, { 'background': [] }],
                ['clean']
              ]
            },
            placeholder: 'è«‹è¼¸å…¥SOPå…§å®¹...'
          });
        }
        
        function initFaqEditor() {
          if (faqEditor) return; // å·²åˆå§‹åŒ–åˆ™è·³è¿‡
          
          faqEditor = new Quill('#faq-editor-container', {
            theme: 'snow',
            modules: {
              toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link'],
                [{ 'color': [] }],
                ['clean']
              ]
            },
            placeholder: 'è«‹è¼¸å…¥FAQç­”æ¡ˆ...'
          });
        }

        async function ensureSession(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/knowledge'); return false; }
            const json = await res.json();
            me = (json && json.ok && json.data) ? json.data : null;
            return true;
          } catch (_) {
            return false;
          }
        }

        // Tabåˆ‡æ¢
        function switchTab(tabName) {
          currentTab = tabName;
          
          // æ›´æ–°tabæŒ‰é’®çŠ¶æ€
          document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tabName);
          });
          
          // æ›´æ–°å†…å®¹åŒºåŸŸ
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(`${tabName}-content`).classList.add('active');
          
          // åŠ è½½å¯¹åº”æ•°æ®
          if (tabName === 'sop') loadSOPs();
          else if (tabName === 'faq') loadFAQs();
          else if (tabName === 'resources') loadResources();
        }

        // SOPç›¸å…³å‡½æ•°
        async function loadSOPs(){
          try {
            const sopsList = document.getElementById('sopsList');
            sopsList.innerHTML = '<div class="doc-card"><div class="doc-title">è¼‰å…¥ä¸­â€¦</div></div>';
            
            const params = buildParams(sopState);
            const res = await fetch(`${apiBase}/sop?${params}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/knowledge'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            
            const items = Array.isArray(json.data) ? json.data : [];
            sopState.total = (json.meta && json.meta.total) || items.length;
          sopsList.innerHTML = '';
            
            if (!items.length) {
              renderEmpty(sopsList, 'sop');
              document.getElementById('sopListInfo').textContent = '0 ç­†';
              return;
            }
            
            items.forEach(it => sopsList.appendChild(createSopCard(it)));
            updatePager('sop', sopState);
          } catch (_) {
            document.getElementById('sopsList').innerHTML = '<div class="doc-card"><div class="doc-title" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</div></div>';
          }
        }

        function createSopCard(item){
          const el = document.createElement('div');
          el.className = 'doc-card';
          const v = `<span class="badge" style="margin-left:8px;background:#e7f0ff;color:#1d4ed8;padding:2px 6px;border-radius:6px;">v${item.version||1}</span>`;
          const tagsTxt = Array.isArray(item.tags) ? item.tags.join(', ') : '';
          const catText = getCategoryText(item.category);
          
          el.innerHTML = `
            <div class="doc-title">${item.title||''} ${v}</div>
            <div class="doc-excerpt">åˆ†é¡ï¼š${catText}${tagsTxt ? `ï½œæ¨™ç±¤ï¼š${tagsTxt}` : ''}</div>
            <div class="doc-meta">
              <div class="doc-meta-item">æ›´æ–°ï¼š${item.updatedAt||''}</div>
            </div>
            <div class="doc-footer">
              <div>ä½œè€…ï¼š${item.createdBy||''}</div>
              <div>
                <button type="button" class="btn" onclick="viewSOP(${item.sop_id})">æŸ¥çœ‹</button>
                <button type="button" class="btn" onclick="editSOP(${item.sop_id})">ç·¨è¼¯</button>
                <button type="button" class="btn danger" onclick="deleteSOP(${item.sop_id})">åˆªé™¤</button>
              </div>
            </div>
          `;
          return el;
        }

        // FAQç›¸å…³å‡½æ•°
        async function loadFAQs(){
          try {
            const faqsList = document.getElementById('faqsList');
            faqsList.innerHTML = '<div class="doc-card"><div class="doc-title">è¼‰å…¥ä¸­â€¦</div></div>';
            
            const params = buildParams(faqState);
            const res = await fetch(`${apiBase}/faq?${params}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/knowledge'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            
            const items = Array.isArray(json.data) ? json.data : [];
            faqState.total = (json.meta && json.meta.total) || items.length;
            faqsList.innerHTML = '';
            
            if (!items.length) {
              renderEmpty(faqsList, 'faq');
              document.getElementById('faqListInfo').textContent = '0 ç­†';
              return;
            }
            
            items.forEach(it => faqsList.appendChild(createFaqCard(it)));
            updatePager('faq', faqState);
          } catch (_) {
            document.getElementById('faqsList').innerHTML = '<div class="doc-card"><div class="doc-title" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</div></div>';
          }
        }

        function createFaqCard(item){
          const el = document.createElement('div');
          el.className = 'doc-card';
          const tagsTxt = Array.isArray(item.tags) ? item.tags.join(', ') : '';
          const catText = getCategoryText(item.category);
          
          el.innerHTML = `
            <div class="doc-title">â“ ${item.question||''}</div>
            <div class="doc-excerpt">åˆ†é¡ï¼š${catText}${tagsTxt ? `ï½œæ¨™ç±¤ï¼š${tagsTxt}` : ''}</div>
            <div class="doc-meta">
              <div class="doc-meta-item">æ›´æ–°ï¼š${item.updatedAt||''}</div>
            </div>
            <div class="doc-footer">
              <div>ä½œè€…ï¼š${item.createdBy||''}</div>
              <div>
                <button type="button" class="btn" onclick="viewFAQ(${item.faq_id})">æŸ¥çœ‹</button>
                <button type="button" class="btn" onclick="editFAQ(${item.faq_id})">ç·¨è¼¯</button>
                <button type="button" class="btn danger" onclick="deleteFAQ(${item.faq_id})">åˆªé™¤</button>
              </div>
            </div>
          `;
          return el;
        }

        // èµ„æºä¸­å¿ƒç›¸å…³å‡½æ•°
        async function loadResources(){
          try {
            const resourcesList = document.getElementById('resourcesList');
            resourcesList.innerHTML = '<div class="doc-card"><div class="doc-title">è¼‰å…¥ä¸­â€¦</div></div>';
            
            const params = buildResourceParams(resourcesState);
            const res = await fetch(`${apiBase}/documents?${params}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/knowledge'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            
            const items = Array.isArray(json.data) ? json.data : [];
            resourcesState.total = (json.meta && json.meta.total) || items.length;
            resourcesList.innerHTML = '';
            
            if (!items.length) {
              renderEmpty(resourcesList, 'resources');
              document.getElementById('resourcesListInfo').textContent = '0 ç­†';
              return;
            }
            
            items.forEach(it => resourcesList.appendChild(createResourceCard(it)));
            updatePager('resources', resourcesState);
          } catch (_) {
            document.getElementById('resourcesList').innerHTML = '<div class="doc-card"><div class="doc-title" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</div></div>';
          }
        }

        function createResourceCard(item){
          const el = document.createElement('div');
          el.className = 'doc-card';
          const tagsTxt = Array.isArray(item.tags) ? item.tags.join(', ') : '';
          
          // åˆ†é¡åœ–æ¨™å’Œæ–‡å­—
          const categoryMap = {
            contract: { icon: 'ğŸ“„', text: 'åˆåŒç¯„æœ¬' },
            finance: { icon: 'ğŸ’°', text: 'è²¡å‹™è¡¨æ ¼' },
            hr: { icon: 'ğŸ‘¥', text: 'äººäº‹æ–‡æª”' },
            tax: { icon: 'ğŸ“Š', text: 'ç¨…å‹™åƒè€ƒ' },
            other: { icon: 'ğŸ“‹', text: 'å…¶ä»–' }
          };
          const cat = categoryMap[item.category] || { icon: 'ğŸ“', text: 'æ–‡æª”' };
          
          // æ–‡ä»¶é¡å‹åœ–æ¨™
          const fileName = item.fileName || item.title || '';
          let fileIcon = 'ğŸ“„';
          if (fileName.match(/\.(pdf)$/i)) fileIcon = 'ğŸ“•';
          else if (fileName.match(/\.(doc|docx)$/i)) fileIcon = 'ğŸ“˜';
          else if (fileName.match(/\.(xls|xlsx)$/i)) fileIcon = 'ğŸ“—';
          else if (fileName.match(/\.(ppt|pptx)$/i)) fileIcon = 'ğŸ“™';
          else if (fileName.match(/\.(jpg|jpeg|png|gif)$/i)) fileIcon = 'ğŸ–¼ï¸';
          
          const fileSize = item.fileSize ? `${(item.fileSize / 1024).toFixed(1)} KB` : 'â€”';
          
          el.innerHTML = `
            <div class="doc-title">
              <span style="margin-right:8px;">${fileIcon}</span>
              ${item.title || 'æœªå‘½åæ–‡æª”'}
              <span style="margin-left:8px;padding:2px 8px;background:#f0f9ff;color:#0369a1;border-radius:4px;font-size:11px;font-weight:600;">
                ${cat.icon} ${cat.text}
              </span>
            </div>
            <div class="doc-excerpt" style="margin-top:8px;">${item.description || 'ç„¡æè¿°'}</div>
            ${tagsTxt ? `<div class="doc-excerpt" style="margin-top:4px;color:#6b7280;">ğŸ·ï¸ ${tagsTxt}</div>` : ''}
            <div class="doc-meta" style="margin-top:8px;">
              <div class="doc-meta-item">ğŸ“… ${item.uploadedAt || item.createdAt || 'â€”'}</div>
              <div class="doc-meta-item">ğŸ‘¤ ${item.uploaderName || 'â€”'}</div>
              <div class="doc-meta-item">ğŸ“¦ ${fileSize}</div>
            </div>
            <div class="doc-footer" style="margin-top:12px;">
              <div style="font-size:12px;color:#6b7280;">${fileName}</div>
              <div style="display:flex;gap:8px;">
                <a href="${item.fileUrl}" target="_blank" class="btn" style="font-size:13px;">â¬‡ï¸ ä¸‹è¼‰</a>
                <button type="button" class="btn danger" onclick="deleteResource(${item.document_id})" style="font-size:13px;">ğŸ—‘ï¸ åˆªé™¤</button>
              </div>
            </div>
          `;
          return el;
        }

        // é€šç”¨å‡½æ•°
        function renderEmpty(container, type){
          const messages = {
            sop: 'å°šç„¡ SOPï¼Œè«‹é»æ“Šå³ä¸Šè§’ã€Œ+ æ–°å¢ã€æŒ‰éˆ•å»ºç«‹',
            faq: 'å°šç„¡ FAQï¼Œè«‹é»æ“Šå³ä¸Šè§’ã€Œ+ æ–°å¢ã€æŒ‰éˆ•å»ºç«‹',
            resources: 'å°šç„¡æ–‡æª”ï¼Œè«‹é»æ“Šå³ä¸Šè§’ã€Œ+ æ–°å¢ã€æŒ‰éˆ•ä¸Šå‚³'
          };
          container.innerHTML = `<div class="doc-card"><div class="doc-title">æš«ç„¡è³‡æ–™</div><div class="doc-excerpt">${messages[type]}</div></div>`;
        }

        function updatePager(type, state){
          const prevBtn = document.getElementById(`${type}-prev`);
          const nextBtn = document.getElementById(`${type}-next`);
          const listInfo = document.getElementById(`${type}ListInfo`);
          
          prevBtn.disabled = state.page <= 1;
          const lastPage = Math.max(1, Math.ceil(state.total / state.perPage));
          nextBtn.disabled = state.page >= lastPage;
          listInfo.textContent = `${state.total} ç­†ï½œç¬¬ ${state.page}/${lastPage} é `;
        }

        function buildParams(state){
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          
          const q = document.getElementById('q').value.trim();
          if (q) params.set('q', q);
          
          const cat = document.getElementById('category').value;
          if (cat && cat !== 'all') params.set('category', cat);
          
          const t = document.getElementById('tags').value.split(',').map(s=>s.trim()).filter(Boolean).join(',');
          if (t) params.set('tags', t);
          
          return params.toString();
        }
        
        function buildResourceParams(state){
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          
          if (state.q) params.set('q', state.q);
          if (state.category) params.set('category', state.category);
          
          return params.toString();
        }

        function getCategoryText(cat) {
          const map = {
            accounting: 'è¨˜å¸³æµç¨‹',
            tax: 'ç¨…å‹™æµç¨‹',
            business: 'å·¥å•†ç™»è¨˜',
            hr: 'äººäº‹ç®¡ç†',
            finance: 'è²¡å‹™ç®¡ç†',
            contract: 'åˆåŒç¯„æœ¬',
            internal: 'å…§éƒ¨æµç¨‹',
            other: 'å…¶ä»–'
          };
          return map[cat] || 'æœªåˆ†é¡';
        }

        // Modalå‡½æ•°
        window.closeSopModal = function() {
          document.getElementById('sopModal').classList.remove('show');
          document.getElementById('sopForm').reset();
          document.getElementById('sop-id').value = '';
          if (sopEditor) {
            sopEditor.setContents([]);
          }
        };

        window.closeFaqModal = function() {
          document.getElementById('faqModal').classList.remove('show');
          document.getElementById('faqForm').reset();
          document.getElementById('faq-id').value = '';
          if (faqEditor) {
            faqEditor.setContents([]);
          }
        };


        // SOP CRUD functions
        window.viewSOP = async function(id) {
          try {
            const res = await fetch(`${apiBase}/sop/${id}`, { credentials:'include' });
            const json = await res.json();
            if (json.ok && json.data) {
              alert(`SOP: ${json.data.title}\n\n${json.data.content || 'ç„¡å…§å®¹'}`);
            }
          } catch (err) {
            alert('è¼‰å…¥SOPå¤±æ•—');
          }
        };
        
        window.editSOP = async function(id) {
          try {
            const res = await fetch(`${apiBase}/sop/${id}`, { credentials:'include' });
            const json = await res.json();
            if (json.ok && json.data) {
              const sop = json.data;
              document.getElementById('sop-id').value = sop.sop_id;
              document.getElementById('sop-title').value = sop.title || '';
              document.getElementById('sop-category').value = sop.category || '';
              document.getElementById('sop-tags').value = Array.isArray(sop.tags) ? sop.tags.join(', ') : '';
              document.getElementById('sopModalTitle').textContent = 'ç·¨è¼¯ SOP';
              document.getElementById('sopModal').classList.add('show');
              
              // åˆå§‹åŒ–ç¼–è¾‘å™¨å¹¶è®¾ç½®å†…å®¹
              setTimeout(() => {
                initSopEditor();
                if (sopEditor) {
                  sopEditor.root.innerHTML = sop.content || '';
                }
              }, 100);
            }
          } catch (err) {
            alert('è¼‰å…¥SOPå¤±æ•—');
          }
        };
        
        window.deleteSOP = async function(id) {
          if(!confirm('ç¢ºå®šåˆªé™¤æ­¤SOPï¼Ÿ')) return;
          try {
            const res = await fetch(`${apiBase}/sop/${id}`, { 
              method: 'DELETE',
              credentials:'include'
            });
            const json = await res.json();
            if (json.ok) {
              alert('åˆªé™¤æˆåŠŸ');
              loadSOPs();
            } else {
              alert('åˆªé™¤å¤±æ•—ï¼š' + (json.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
          } catch (err) {
            alert('åˆªé™¤å¤±æ•—');
          }
        };
        
        // FAQ CRUD functions
        window.viewFAQ = async function(id) {
          try {
            const res = await fetch(`${apiBase}/faq/${id}`, { credentials:'include' });
            const json = await res.json();
            if (json.ok && json.data) {
              alert(`å•é¡Œ: ${json.data.question}\n\nç­”æ¡ˆ: ${json.data.answer || 'ç„¡ç­”æ¡ˆ'}`);
            }
          } catch (err) {
            alert('è¼‰å…¥FAQå¤±æ•—');
          }
        };
        
        window.editFAQ = async function(id) {
          try {
            const res = await fetch(`${apiBase}/faq/${id}`, { credentials:'include' });
            const json = await res.json();
            if (json.ok && json.data) {
              const faq = json.data;
              document.getElementById('faq-id').value = faq.faq_id;
              document.getElementById('faq-question').value = faq.question || '';
              document.getElementById('faq-category').value = faq.category || '';
              document.getElementById('faq-tags').value = Array.isArray(faq.tags) ? faq.tags.join(', ') : '';
              document.getElementById('faqModalTitle').textContent = 'ç·¨è¼¯ FAQ';
              document.getElementById('faqModal').classList.add('show');
              
              // åˆå§‹åŒ–ç¼–è¾‘å™¨å¹¶è®¾ç½®å†…å®¹
              setTimeout(() => {
                initFaqEditor();
                if (faqEditor) {
                  faqEditor.root.innerHTML = faq.answer || '';
                }
              }, 100);
            }
          } catch (err) {
            alert('è¼‰å…¥FAQå¤±æ•—');
          }
        };
        
        window.deleteFAQ = async function(id) {
          if(!confirm('ç¢ºå®šåˆªé™¤æ­¤FAQï¼Ÿ')) return;
          try {
            const res = await fetch(`${apiBase}/faq/${id}`, { 
              method: 'DELETE',
              credentials:'include'
            });
            const json = await res.json();
            if (json.ok) {
              alert('åˆªé™¤æˆåŠŸ');
              loadFAQs();
            } else {
              alert('åˆªé™¤å¤±æ•—ï¼š' + (json.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
          } catch (err) {
            alert('åˆªé™¤å¤±æ•—');
          }
        };
        
        // Resource CRUD functions
        window.deleteResource = async function(id) {
          if(!confirm('ç¢ºå®šåˆªé™¤æ­¤æ–‡æª”ï¼Ÿ')) return;
          try {
            const res = await fetch(`${apiBase}/documents/${id}`, { 
              method: 'DELETE',
              credentials:'include'
            });
            const json = await res.json();
            if (json.ok) {
              alert('åˆªé™¤æˆåŠŸ');
              loadResources();
            } else {
              alert('åˆªé™¤å¤±æ•—ï¼š' + (json.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
          } catch (err) {
            alert('åˆªé™¤å¤±æ•—');
          }
        };

        // äº‹ä»¶ç»‘å®š
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });

        document.getElementById('btn-new').addEventListener('click', () => {
          if (currentTab === 'sop') {
            document.getElementById('sopModalTitle').textContent = 'æ–°å¢ SOP';
            document.getElementById('sopModal').classList.add('show');
            // å»¶è¿Ÿåˆå§‹åŒ–ç¼–è¾‘å™¨ï¼Œç¡®ä¿Modalå·²æ˜¾ç¤º
            setTimeout(() => initSopEditor(), 100);
          } else if (currentTab === 'faq') {
            document.getElementById('faqModalTitle').textContent = 'æ–°å¢ FAQ';
            document.getElementById('faqModal').classList.add('show');
            // å»¶è¿Ÿåˆå§‹åŒ–ç¼–è¾‘å™¨ï¼Œç¡®ä¿Modalå·²æ˜¾ç¤º
            setTimeout(() => initFaqEditor(), 100);
          } else if (currentTab === 'resources') {
            // è³‡æºä¸­å¿ƒä½¿ç”¨å…§è¯è¡¨å–®ï¼Œæ»¾å‹•åˆ°ä¸Šå‚³å€åŸŸ
            document.getElementById('resourceFormInline').scrollIntoView({ behavior: 'smooth', block: 'start' });
            document.getElementById('resource-title-inline').focus();
          }
        });

        // æœç´¢å’Œç­›é€‰
        let timer=null;
        document.getElementById('q').addEventListener('input', ()=>{ 
          clearTimeout(timer); 
          timer=setTimeout(()=>{ 
            sopState.page=1; 
            faqState.page=1; 
            resourcesState.page=1; 
            if (currentTab === 'sop') loadSOPs();
            else if (currentTab === 'faq') loadFAQs();
            else if (currentTab === 'resources') loadResources();
          }, 300); 
        });
        
        document.getElementById('category').addEventListener('change', ()=>{ 
          sopState.page=1; 
          faqState.page=1; 
          resourcesState.page=1; 
          if (currentTab === 'sop') loadSOPs();
          else if (currentTab === 'faq') loadFAQs();
          else if (currentTab === 'resources') loadResources();
        });
        
        document.getElementById('tags').addEventListener('change', ()=>{ 
          sopState.page=1; 
          faqState.page=1; 
          resourcesState.page=1; 
          if (currentTab === 'sop') loadSOPs();
          else if (currentTab === 'faq') loadFAQs();
          else if (currentTab === 'resources') loadResources();
        });

        // åˆ†é¡µæŒ‰é’®
        document.getElementById('sop-prev').addEventListener('click', ()=>{ if (sopState.page>1){ sopState.page--; loadSOPs(); } });
        document.getElementById('sop-next').addEventListener('click', ()=>{ sopState.page++; loadSOPs(); });
        document.getElementById('faq-prev').addEventListener('click', ()=>{ if (faqState.page>1){ faqState.page--; loadFAQs(); } });
        document.getElementById('faq-next').addEventListener('click', ()=>{ faqState.page++; loadFAQs(); });
        document.getElementById('resources-prev').addEventListener('click', ()=>{ if (resourcesState.page>1){ resourcesState.page--; loadResources(); } });
        document.getElementById('resources-next').addEventListener('click', ()=>{ resourcesState.page++; loadResources(); });

        // è³‡æºæœç´¢å’Œç¯©é¸
        let resourcesSearchTimer = null;
        document.getElementById('resources-search').addEventListener('input', (e) => {
          clearTimeout(resourcesSearchTimer);
          resourcesSearchTimer = setTimeout(() => {
            resourcesState.q = e.target.value.trim();
            resourcesState.page = 1;
            loadResources();
          }, 300);
        });
        
        document.getElementById('resources-category-filter').addEventListener('change', (e) => {
          resourcesState.category = e.target.value;
          resourcesState.page = 1;
          loadResources();
        });

        // æ–‡ä»¶ä¸Šä¼ 
        const fileUploadAreaInline = document.getElementById('fileUploadAreaInline');
        const fileInputInline = document.getElementById('file-input-inline');
        let selectedFile = null;

        fileUploadAreaInline.addEventListener('click', () => fileInputInline.click());
        
        fileInputInline.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            selectedFile = e.target.files[0];
            displayFileInfo(selectedFile);
          }
        });

        fileUploadAreaInline.addEventListener('dragover', (e) => {
          e.preventDefault();
          fileUploadAreaInline.style.borderColor = '#2563eb';
          fileUploadAreaInline.style.background = '#eff6ff';
        });

        fileUploadAreaInline.addEventListener('dragleave', () => {
          fileUploadAreaInline.style.borderColor = '';
          fileUploadAreaInline.style.background = '';
        });

        fileUploadAreaInline.addEventListener('drop', (e) => {
          e.preventDefault();
          fileUploadAreaInline.style.borderColor = '';
          fileUploadAreaInline.style.background = '';
          if (e.dataTransfer.files.length > 0) {
            selectedFile = e.dataTransfer.files[0];
            fileInputInline.files = e.dataTransfer.files;
            displayFileInfo(selectedFile);
          }
        });

        function displayFileInfo(file) {
          document.getElementById('fileNameInline').textContent = file.name;
          document.getElementById('fileSizeInline').textContent = `å¤§å°ï¼š${(file.size / 1024).toFixed(1)} KB`;
          document.getElementById('uploadedFileInfoInline').style.display = 'block';
          
          // è‡ªåŠ¨å¡«å……æ ‡é¢˜ï¼ˆå¦‚æœä¸ºç©ºï¼‰
          if (!document.getElementById('resource-title-inline').value) {
            document.getElementById('resource-title-inline').value = file.name.split('.')[0];
          }
        }
        
        window.resetUploadForm = function() {
          document.getElementById('resourceFormInline').reset();
          selectedFile = null;
          document.getElementById('uploadedFileInfoInline').style.display = 'none';
        };

        // Formæäº¤ï¼ˆplaceholderï¼‰
        // SOP Formæäº¤
        document.getElementById('sopForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          if (!sopEditor) {
            alert('ç·¨è¼¯å™¨æœªåˆå§‹åŒ–ï¼Œè«‹é‡è©¦');
            return;
          }
          
          const sopId = document.getElementById('sop-id').value;
          const title = document.getElementById('sop-title').value;
          const category = document.getElementById('sop-category').value;
          const tags = document.getElementById('sop-tags').value.split(',').map(t => t.trim()).filter(Boolean);
          const content = sopEditor.root.innerHTML;
          
          try {
            const method = sopId ? 'PUT' : 'POST';
            const url = sopId ? `${apiBase}/sop/${sopId}` : `${apiBase}/sop`;
            
            const res = await fetch(url, {
              method,
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ title, category, tags, content })
            });
            
            const json = await res.json();
            if (json.ok) {
              alert(sopId ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
              closeSopModal();
              loadSOPs();
            } else {
              alert('ä¿å­˜å¤±æ•—ï¼š' + (json.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
          } catch (err) {
            alert('ä¿å­˜å¤±æ•—');
          }
        });

        // FAQ Formæäº¤
        document.getElementById('faqForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          if (!faqEditor) {
            alert('ç·¨è¼¯å™¨æœªåˆå§‹åŒ–ï¼Œè«‹é‡è©¦');
            return;
          }
          
          const faqId = document.getElementById('faq-id').value;
          const question = document.getElementById('faq-question').value;
          const category = document.getElementById('faq-category').value;
          const tags = document.getElementById('faq-tags').value.split(',').map(t => t.trim()).filter(Boolean);
          const answer = faqEditor.root.innerHTML;
          
          try {
            const method = faqId ? 'PUT' : 'POST';
            const url = faqId ? `${apiBase}/faq/${faqId}` : `${apiBase}/faq`;
            
            const res = await fetch(url, {
              method,
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ question, category, tags, answer })
            });
            
            const json = await res.json();
            if (json.ok) {
              alert(faqId ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
              closeFaqModal();
              loadFAQs();
            } else {
              alert('ä¿å­˜å¤±æ•—ï¼š' + (json.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
          } catch (err) {
            alert('ä¿å­˜å¤±æ•—');
          }
        });

        // èµ„æºä¸Šä¼ Formæäº¤
        document.getElementById('resourceFormInline').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          if (!selectedFile) {
            alert('è«‹é¸æ“‡è¦ä¸Šå‚³çš„æ–‡ä»¶');
            return;
          }
          
          const submitBtn = document.getElementById('resourceSubmitBtnInline');
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span>â³ ä¸Šå‚³ä¸­...</span>';
          
          const title = document.getElementById('resource-title-inline').value;
          const description = document.getElementById('resource-description-inline').value;
          const category = document.getElementById('resource-category-inline').value;
          const tags = document.getElementById('resource-tags-inline').value.split(',').map(t => t.trim()).filter(Boolean);
          
          try {
            // Step 1: è·å–ä¸Šä¼ ç­¾å
            const signRes = await fetch(`${apiBase}/attachments/upload-sign`, {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                entity_type: 'sop',
                entity_id: 'temp_' + Date.now(),
                filename: selectedFile.name,
                content_type: selectedFile.type,
                content_length: selectedFile.size
              })
            });
            
            const signJson = await signRes.json();
            if (!signJson.ok || !signJson.data) {
              throw new Error('ç²å–ä¸Šå‚³URLå¤±æ•—');
            }
            
            // Step 2: ä¸Šä¼ æ–‡ä»¶åˆ°R2
            const uploadRes = await fetch(signJson.data.uploadUrl, {
              method: 'PUT',
              body: selectedFile,
              headers: signJson.data.headers,
              credentials: 'include'
            });
            
            if (!uploadRes.ok) {
              const errorText = await uploadRes.text();
              throw new Error(`æ–‡ä»¶ä¸Šå‚³å¤±æ•—: ${errorText}`);
            }
            
            const uploadJson = await uploadRes.json();
            if (!uploadJson.ok) {
              throw new Error(uploadJson.message || 'æ–‡ä»¶ä¸Šå‚³å¤±æ•—');
            }
            
            // Step 3: åˆ›å»ºæ–‡æ¡£è®°å½•
            const docRes = await fetch(`${apiBase}/documents`, {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                title,
                description,
                file_name: selectedFile.name,
                file_url: uploadJson.data.object_key,
                file_size: selectedFile.size,
                file_type: selectedFile.type,
                category,
                tags
              })
            });
            
            const docJson = await docRes.json();
            if (docJson.ok) {
              alert('ä¸Šå‚³æˆåŠŸï¼');
              resetUploadForm();
              loadResources();
            } else {
              alert('å‰µå»ºæ–‡æª”è¨˜éŒ„å¤±æ•—ï¼š' + (docJson.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
          } catch (err) {
            alert('ä¸Šå‚³å¤±æ•—ï¼š' + err.message);
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>ğŸ“¤ ä¸Šå‚³æ–‡æª”</span>';
          }
        });

        // åˆå§‹åŒ–
        ensureSession().then(ok => { 
          if (ok) { 
            // ç¡®ä¿æ‰€æœ‰æ¨¡æ€æ¡†éƒ½æ˜¯å…³é—­çŠ¶æ€
            document.getElementById('sopModal').classList.remove('show');
            document.getElementById('faqModal').classList.remove('show');
            // ç¼–è¾‘å™¨ä¼šåœ¨æ‰“å¼€Modalæ—¶æŒ‰éœ€åˆå§‹åŒ–
            switchTab('sop');
          }
        });
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>
