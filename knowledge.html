<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="å…§éƒ¨çŸ¥è­˜åº«" />
    <title>çŸ¥è­˜åº«ï½œSOP / FAQ / è³‡æºä¸­å¿ƒ</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/knowledge-page.css" />
    
    <!-- âš¡ é åŠ è¼‰ç³»çµ±ï¼ˆå¿…é ˆåœ¨æ‰€æœ‰å…¶ä»–è…³æœ¬ä¹‹å‰åŠ è¼‰ï¼‰ -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <script src="/assets/js/prerender.js"></script>
    <script src="/assets/js/page-prerender.js"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Quill 2.0 å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ + Better Table æ’ä»¶ -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-dev.3/dist/quill.snow.css" rel="stylesheet">
    <link href="https://unpkg.com/quill-better-table@1.2.10/dist/quill-better-table.css" rel="stylesheet">
    <style>
      .tabs {
        display: flex;
        gap: 8px;
        border-bottom: 2px solid #e5e7eb;
      }
      .tab-button {
        padding: 12px 24px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        color: #6b7280;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
      }
      .tab-button:hover {
        color: #1f2937;
        background: #f9fafb;
      }
      .tab-button.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      
      /* å·¦å³ä½ˆå±€å„ªåŒ– - ç¸®å°å·¦å´æ¬„ï¼Œè®“é è¦½å€åŸŸæ›´å¤§ */
      .kb-layout {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 16px;
        transition: all 0.3s ease;
        position: relative;
      }
      /* FAQ åˆ—è¡¨æ¬„åŠ å€å¯¬åº¦ */
      #faq-layout {
        grid-template-columns: 360px 1fr;
      }
      #faq-layout.collapsed {
        grid-template-columns: 0 1fr;
      }
      /* è³‡æºä¸­å¿ƒï¼ˆDocumentsï¼‰åˆ—è¡¨æ¬„åŠ å€å¯¬åº¦ */
      #resources-layout {
        grid-template-columns: 400px 1fr;
      }
      #resources-layout.collapsed {
        grid-template-columns: 0 1fr;
      }
      .kb-layout.collapsed {
        grid-template-columns: 0 1fr;
        gap: 0;
      }
      .kb-layout.collapsed .right-panel {
        max-width: 100%;
        width: 100%;
      }
      .left-panel {
        background: white;
        border: 1px solid rgba(15,23,42,0.08);
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.04);
        padding: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
        position: relative;
      }
      .kb-layout.collapsed .left-panel {
        padding: 0;
        border: none;
        box-shadow: none;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        left: 0;
        top: 0;
        width: auto;
      }
      .right-panel {
        transition: all 0.3s ease;
      }
      .kb-layout.collapsed .panel-content {
        display: none;
      }
      .toggle-panel-btn {
        position: absolute;
        right: -20px;
        top: 20px;
        width: 32px;
        height: 48px;
        cursor: pointer;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 0 8px 8px 0;
        box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        color: #2563eb;
        transition: all 0.2s;
        z-index: 100;
      }
      .toggle-panel-btn::after {
        content: 'â—€';
        font-weight: bold;
      }
      .toggle-panel-btn:hover {
        background: #eff6ff;
        color: #1d4ed8;
        box-shadow: 2px 0 12px rgba(37, 99, 235, 0.2);
      }
      .kb-layout.collapsed .left-panel {
        width: 0;
        min-width: 0;
        padding: 0;
        border: none;
        overflow: visible;
        position: relative;
      }
      .kb-layout.collapsed .toggle-panel-btn {
        position: fixed;
        left: 20px;
        top: 120px;
        right: auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 1000;
      }
      .kb-layout.collapsed .toggle-panel-btn::after {
        content: 'â–¶';
      }
      .kb-layout.collapsed .toggle-panel-btn:hover {
        background: #eff6ff;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        transform: scale(1.05);
      }
      .doc-card {
        cursor: pointer;
        transition: all 0.2s;
      }
      .doc-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      /* æ¨™ç±¤æŒ‰éˆ•æ¨£å¼ */
      .tag-btn {
        padding: 4px 10px;
        font-size: 12px;
        border: 1px solid #d1d5db;
        border-radius: 16px;
        background: white;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }
      .tag-btn:hover {
        border-color: #2563eb;
        color: #2563eb;
        background: #eff6ff;
      }
      .tag-btn.selected {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
      }
      .tag-btn.selected:hover {
        background: #1d4ed8;
        border-color: #1d4ed8;
      }
      
      /* SOP/FAQ å…§å®¹æ’ç‰ˆå„ªåŒ– */
      .ql-editor h1 {
        font-size: 24px;
        font-weight: 700;
        margin: 24px 0 16px 0;
        color: #1f2937;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 8px;
      }
      .ql-editor h2 {
        font-size: 20px;
        font-weight: 600;
        margin: 20px 0 12px 0;
        color: #374151;
      }
      .ql-editor h3 {
        font-size: 16px;
        font-weight: 600;
        margin: 16px 0 10px 0;
        color: #4b5563;
      }
      .ql-editor p {
        margin: 8px 0;
        line-height: 1.8;
      }
      .ql-editor ul, .ql-editor ol {
        margin: 12px 0;
        padding-left: 24px;
      }
      .ql-editor li {
        margin: 6px 0;
        line-height: 1.7;
      }
      .ql-editor blockquote {
        border-left: 4px solid #2563eb;
        padding-left: 16px;
        margin: 16px 0;
        color: #6b7280;
        font-style: italic;
      }
      .ql-editor pre {
        background: #f3f4f6;
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
        margin: 12px 0;
      }
      .ql-editor table {
        border-collapse: collapse;
        width: 100%;
        margin: 16px 0;
      }
      .ql-editor table td,
      .ql-editor table th {
        border: 1px solid #d1d5db;
        padding: 8px 12px;
      }
      .ql-editor table th {
        background: #f3f4f6;
        font-weight: 600;
      }
      .ql-editor strong {
        font-weight: 600;
        color: #1f2937;
      }
      .ql-editor em {
        color: #6b7280;
      }
      
      /* è¡¨æ ¼æ“ä½œæŒ‰éˆ• */
      .table-controls {
        position: absolute;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: none;
        z-index: 1000;
        gap: 4px;
      }
      .table-controls button {
        padding: 4px 8px;
        font-size: 11px;
        border: 1px solid #e5e7eb;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        white-space: nowrap;
      }
      .table-controls button:hover {
        background: #f3f4f6;
      }
      
      /* å´é‚ŠæŠ½å±œå¼é¢æ¿ */
      .drawer {
        position: fixed;
        top: 0;
        right: -900px;
        width: 900px;
        height: 100vh;
        background: white;
        box-shadow: -4px 0 24px rgba(0,0,0,0.15);
        z-index: 9999;
        transition: right 0.3s ease;
        overflow-y: auto;
      }
      .drawer.show {
        right: 0;
      }
      .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }
      .drawer-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      /* ä¿ç•™æ¨¡æ…‹æ¡†æ¨£å¼çµ¦å…¶ä»–å¯èƒ½çš„ç”¨é€” */
      .modal {
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.2s, visibility 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal.show {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }
      .modal-content {
        background-color: white;
        margin: auto;
        padding: 30px;
        border-radius: 12px;
        max-width: 800px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        position: relative;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e5e7eb;
      }
      .modal-header h2 {
        margin: 0;
        font-size: 22px;
        font-weight: 700;
        color: #1f2937;
      }
      .close-modal {
        font-size: 28px;
        font-weight: bold;
        color: #9ca3af;
        cursor: pointer;
        border: none;
        background: none;
        padding: 0;
        line-height: 1;
      }
      .close-modal:hover {
        color: #4b5563;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
        font-size: 14px;
      }
      .form-group input[type="text"],
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
      }
      .form-group textarea {
        min-height: 100px;
        font-family: inherit;
      }
      /* Quill ç·¨è¼¯å™¨å®¹å™¨æ¨£å¼ */
      .ql-container {
        font-size: 14px;
        min-height: 350px;
      }
      .ql-editor {
        min-height: 320px;
      }
      .ql-toolbar {
        border-radius: 6px 6px 0 0;
      }
      #sop-editor-inline .ql-container,
      #faq-editor-inline .ql-container {
        border-radius: 0 0 6px 6px;
      }
      .file-upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }
      .file-upload-area:hover {
        border-color: #2563eb;
        background: #f0f7ff;
      }
      .file-upload-area.dragover {
        border-color: #2563eb;
        background: #dbeafe;
      }
      .uploaded-file-info {
        margin-top: 16px;
        padding: 12px;
        background: #f0f7ff;
        border-radius: 6px;
        display: none;
      }
      .uploaded-file-info.show {
        display: block;
      }
      
      /* è³‡æºé è¦½å¡ç‰‡æ¨£å¼ - ç§»é™¤è¾¹æ¡†ï¼Œå…¨å±æ˜¾ç¤º */
      .resource-preview-card {
        background: white;
        border: none;
        border-radius: 0;
        box-shadow: none;
        overflow: hidden;
        height: 100%;
        transition: all 0.3s ease;
      }
      
      .resource-preview-card:hover {
        box-shadow: none;
      }
      
      .resource-preview-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px 24px;
        border-bottom: 1px solid rgba(15,23,42,0.08);
      }
      
      .resource-preview-title {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: white;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .resource-preview-content {
        padding: 0;
        min-height: 90vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .resource-preview-empty {
        text-align: center;
        max-width: 400px;
        padding: 40px 20px;
      }
      
      .empty-icon {
        font-size: 80px;
        margin-bottom: 20px;
        animation: float 3s ease-in-out infinite;
        opacity: 0.8;
      }
      
      @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
      }
      
      .empty-text {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 8px 0;
      }
      
      .empty-hint {
        font-size: 13px;
        color: var(--text-secondary);
        margin: 0;
        opacity: 0.7;
      }
    </style>
  </head>
  <body class="knowledge-page">
    <!-- Tabåˆ‡æ¢ -->
    <section style="padding:12px 20px 0 20px;">
      <div class="tabs" style="margin-bottom:0;">
        <button class="tab-button active" data-tab="sop">ğŸ“– SOP æµç¨‹æ–‡æª”</button>
        <button class="tab-button" data-tab="faq">â“ FAQ å¸¸è¦‹å•ç­”</button>
        <button class="tab-button" data-tab="resources">ğŸ“ è³‡æºä¸­å¿ƒ</button>
        <button class="tab-button" data-tab="attachments">ğŸ“ é™„ä»¶</button>
      </div>
    </section>

    <!-- ç­›é€‰åŒºåŸŸï¼ˆSOP/FAQ/è³‡æºä¸­å¿ƒå°ˆç”¨ï¼Œé™„ä»¶æ¨™ç±¤éš±è—ï¼‰ -->
    <section class="filters" id="main-filters" style="padding:12px 20px;display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;">
      <div style="flex:1;min-width:180px;max-width:240px;">
        <label for="q" style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px;">æœå°‹</label>
        <input id="q" type="search" placeholder="æœå°‹æ¨™é¡Œ/å…§å®¹â€¦" aria-label="æœå°‹" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;width:100%;" />
      </div>
      <div style="width:150px;">
        <label for="category" style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px;">æœå‹™é¡å‹</label>
        <select id="category" aria-label="åˆ†é¡" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;width:100%;">
          <option value="all">å…¨éƒ¨</option>
          <!-- å‹•æ…‹åŠ è¼‰æœå‹™é¡å‹ -->
        </select>
      </div>
      <div style="width:115px;">
        <label for="scope" style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px;">å±¤ç´š</label>
        <select id="scope" aria-label="æœå‹™å±¤ç´š" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;width:100%;">
          <option value="">å…¨éƒ¨å±¤ç´š</option>
          <option value="service">ğŸ”· æœå‹™</option>
          <option value="task">ğŸ“‹ ä»»å‹™</option>
        </select>
      </div>
      <div style="width:150px;">
        <label for="client" style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px;">å®¢æˆ¶</label>
        <select id="client" aria-label="å®¢æˆ¶" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;width:100%;">
          <option value="all">å…¨éƒ¨å®¢æˆ¶</option>
          <!-- å‹•æ…‹åŠ è¼‰å®¢æˆ¶æ¸…å–® -->
        </select>
      </div>
      <div style="width:95px;">
        <label for="year" style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px;">å¹´åº¦</label>
        <select id="year" aria-label="å¹´åº¦" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;width:100%;">
          <option value="all">å…¨éƒ¨</option>
          <option value="2026">2026</option>
          <option value="2025">2025</option>
          <option value="2024">2024</option>
          <option value="2023">2023</option>
        </select>
      </div>
      <div style="width:95px;">
        <label for="month" style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px;">æœˆä»½</label>
        <select id="month" aria-label="æœˆä»½" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;width:100%;">
          <option value="all">å…¨éƒ¨</option>
          <option value="1">1æœˆ</option>
          <option value="2">2æœˆ</option>
          <option value="3">3æœˆ</option>
          <option value="4">4æœˆ</option>
          <option value="5">5æœˆ</option>
          <option value="6">6æœˆ</option>
          <option value="7">7æœˆ</option>
          <option value="8">8æœˆ</option>
          <option value="9">9æœˆ</option>
          <option value="10">10æœˆ</option>
          <option value="11">11æœˆ</option>
          <option value="12">12æœˆ</option>
        </select>
      </div>
      <div style="width:140px;">
        <label for="tags" style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px;">æ¨™ç±¤</label>
        <select id="tags" aria-label="æ¨™ç±¤" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;width:100%;">
          <option value="">å…¨éƒ¨</option>
          <!-- æ¨™ç±¤é¸é …æœƒå‹•æ…‹è¼‰å…¥ -->
        </select>
      </div>
      <div>
        <label style="display:block;margin-bottom:6px;color:transparent;font-size:12px;">â€‹</label>
        <button type="button" onclick="openTagManager()" class="btn" style="padding:10px 14px;background:#f3f4f6;color:#374151;border:1px solid #d1d5db;white-space:nowrap;">
          ğŸ·ï¸ ç®¡ç†æ¨™ç±¤
        </button>
      </div>
      <div style="flex:1;"></div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="btn-edit" class="btn" type="button" style="display:none;background:#eff6ff;color:#2563eb;border:1px solid #bfdbfe;">âœï¸ ç·¨è¼¯</button>
        <button id="btn-delete" class="btn" type="button" style="display:none;background:#fee;color:#dc2626;border:1px solid #fca;">ğŸ—‘ï¸ åˆªé™¤</button>
        <button id="btn-new" class="btn primary" type="button">+ æ–°å¢</button>
      </div>
    </section>

    <!-- åˆ—è¡¨åŒºåŸŸ -->
    <main class="content" style="padding:0 20px 24px 20px;margin-top:-8px;">
      <!-- SOP Tab -->
      <div id="sop-content" class="tab-content active">
        <div class="kb-layout" id="sop-layout">
          <!-- å·¦å´ï¼šSOP åˆ—è¡¨ -->
          <div class="left-panel">
            <div class="toggle-panel-btn" onclick="togglePanel('sop')" title="æ”¶åˆ/å±•é–‹"></div>
            <div class="panel-content">
              <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 6px 8px 6px;border-bottom:1px solid #f0f0f0;margin-bottom:8px;">
                <div style="font-weight:700;font-size:13px;color:var(--text-secondary);">ğŸ“– SOP</div>
                <div id="sopListInfo" style="font-size:11px;color:#9ca3af;">â€”</div>
        </div>
              <div id="sopsList" style="max-height: calc(100vh - 280px); overflow-y: auto; overflow-x: hidden;"></div>
              <div class="pagination" style="display:none;gap:10px;justify-content:flex-end;margin-top:12px;">
                <button id="sop-prev" type="button" class="btn">ä¸Šä¸€é </button>
                <button id="sop-next" type="button" class="btn">ä¸‹ä¸€é </button>
              </div>
            </div>
          </div>
          
          <!-- å³å´ï¼šSOP é è¦½å€åŸŸ -->
          <div class="right-panel">
            <section class="resource-preview-card" style="padding:0;">
              <div id="sopPreviewArea" class="resource-preview-content" style="min-height:90vh;">
                <div class="resource-preview-empty">
                  <div class="empty-icon">ğŸ“–</div>
                  <p class="empty-text">é»æ“Šå·¦å´ SOP æŸ¥çœ‹å…§å®¹</p>
                  <p class="empty-hint">é»æ“Šã€Œæ–°å¢ã€æŒ‰éˆ•å»ºç«‹æ–°çš„ SOP</p>
                </div>
        </div>
      </section>
          </div>
        </div>
      </div>

      <!-- FAQ Tab -->
      <div id="faq-content" class="tab-content">
        <div class="kb-layout" id="faq-layout">
          <!-- å·¦å´ï¼šFAQ åˆ—è¡¨ -->
          <div class="left-panel">
            <div class="toggle-panel-btn" onclick="togglePanel('faq')" title="æ”¶åˆ/å±•é–‹"></div>
            <div class="panel-content">
              <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 6px 8px 6px;border-bottom:1px solid #f0f0f0;margin-bottom:8px;">
                <div style="font-weight:700;font-size:13px;color:var(--text-secondary);">â“ FAQ</div>
                <div id="faqListInfo" style="font-size:11px;color:#9ca3af;">â€”</div>
        </div>
              <div id="faqsList" style="max-height: calc(100vh - 280px); overflow-y: auto; overflow-x: hidden;"></div>
              <div class="pagination" style="display:none;gap:10px;justify-content:flex-end;margin-top:12px;">
                <button id="faq-prev" type="button" class="btn">ä¸Šä¸€é </button>
                <button id="faq-next" type="button" class="btn">ä¸‹ä¸€é </button>
        </div>
            </div>
          </div>
          
          <!-- å³å´ï¼šFAQ é è¦½å€åŸŸ -->
          <div class="right-panel">
            <section class="resource-preview-card" style="padding:0;">
              <div id="faqPreviewArea" class="resource-preview-content" style="min-height:90vh;">
                <div class="resource-preview-empty">
                  <div class="empty-icon">â“</div>
                  <p class="empty-text">é»æ“Šå·¦å´ FAQ æŸ¥çœ‹å…§å®¹</p>
                  <p class="empty-hint">é»æ“Šã€Œæ–°å¢ã€æŒ‰éˆ•å»ºç«‹æ–°çš„ FAQ</p>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>

      <!-- èµ„æºä¸­å¿ƒ Tab -->
      <div id="resources-content" class="tab-content">
        <div class="kb-layout" id="resources-layout">
          <!-- å·¦å´ï¼šæ–‡æª”åˆ—è¡¨ -->
          <div class="left-panel">
            <div class="toggle-panel-btn" onclick="togglePanel('resources')" title="æ”¶åˆ/å±•é–‹"></div>
            <div class="panel-content">
              <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 6px 8px 6px;border-bottom:1px solid #f0f0f0;margin-bottom:8px;">
                <div style="font-weight:700;font-size:13px;color:var(--text-secondary);">ğŸ“ æ–‡æª”</div>
                <div id="resourcesListInfo" style="font-size:11px;color:#9ca3af;">â€”</div>
              </div>
              
              <div id="resourcesList" style="max-height: calc(100vh - 280px); overflow-y: auto; overflow-x: hidden;"></div>
              <div class="pagination" style="display:none;gap:10px;justify-content:flex-end;margin-top:12px;">
                <button id="resources-prev" type="button" class="btn">ä¸Šä¸€é </button>
                <button id="resources-next" type="button" class="btn">ä¸‹ä¸€é </button>
              </div>
            </div>
          </div>
          
          <!-- å³å´ï¼šæ–‡æª”é è¦½å€åŸŸ -->
          <div class="right-panel">
            <section class="resource-preview-card" style="padding:0;">
              <div id="documentPreviewArea" class="resource-preview-content" style="min-height:90vh;">
                <div class="resource-preview-empty">
                  <div class="empty-icon">ğŸ“‚</div>
                  <p class="empty-text">é»æ“Šå·¦å´æ–‡æª”æŸ¥çœ‹è©³æƒ…</p>
                  <p class="empty-hint">æ”¯æ´ç·šä¸Šé è¦½ PDFã€åœ–ç‰‡ç­‰æ ¼å¼</p>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>

      <!-- é™„ä»¶ Tab -->
      <div id="attachments-content" class="tab-content">
        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <div style="padding:20px;max-width:1400px;margin:0 auto;">
          <!-- ç¯©é¸å’Œæ“ä½œå€åŸŸ -->
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:16px;">
            <div style="flex:1;display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
              <input type="search" id="attachment-search" placeholder="ğŸ” æœå°‹æ¨™é¡Œ..." 
                     style="flex:1;min-width:200px;max-width:240px;padding:10px 14px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px;" />
              <select id="attachment-filter-client" 
                      style="padding:10px 14px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px;min-width:140px;">
                <option value="">å…¨éƒ¨å®¢æˆ¶</option>
                <!-- å‹•æ…‹åŠ è¼‰å®¢æˆ¶æ¸…å–® -->
              </select>
              <select id="attachment-filter-type" 
                      style="padding:10px 14px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px;min-width:120px;">
                <option value="">å…¨éƒ¨é¡å‹</option>
                <option value="task">ä»»å‹™é™„ä»¶</option>
                <option value="client">å®¢æˆ¶é™„ä»¶</option>
                <option value="receipt">æ”¶æ“šé™„ä»¶</option>
              </select>
              <button onclick="window.resetAttachmentFilters()" 
                      style="padding:10px 16px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;font-size:14px;cursor:pointer;font-weight:500;color:#374151;">
                ğŸ”„ é‡ç½®
              </button>
            </div>
            <button onclick="window.openAttachmentUploadDrawer()" 
                    style="padding:10px 20px;background:#3b82f6;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;white-space:nowrap;">
              <span>â•</span><span>ä¸Šå‚³é™„ä»¶</span>
            </button>
          </div>
          
          <!-- çµ±è¨ˆè³‡è¨Š -->
          <div style="margin-bottom:16px;padding:12px 16px;background:#f9fafb;border-radius:8px;display:flex;align-items:center;gap:8px;">
            <div style="font-weight:600;font-size:14px;color:#374151;">ğŸ“ é™„ä»¶</div>
            <div id="attachmentsListInfo" style="font-size:13px;color:#6b7280;">â€”</div>
          </div>
          
          <!-- é™„ä»¶ç¶²æ ¼åˆ—è¡¨ -->
          <div id="attachmentsList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;min-height:400px;">
            <!-- å‹•æ…‹åŠ è¼‰ -->
          </div>
          
          <!-- åˆ†é  -->
          <div class="pagination" style="display:none;gap:8px;justify-content:center;margin-top:24px;padding-top:24px;border-top:1px solid #e5e7eb;">
            <button id="attachments-prev" type="button" style="padding:8px 16px;border:1px solid #e5e7eb;border-radius:6px;background:white;cursor:pointer;font-size:14px;" disabled>â† ä¸Šä¸€é </button>
            <button id="attachments-next" type="button" style="padding:8px 16px;border:1px solid #e5e7eb;border-radius:6px;background:white;cursor:pointer;font-size:14px;">ä¸‹ä¸€é  â†’</button>
          </div>
        </div>
      </div>
    </main>

    <!-- é™„ä»¶ä¸Šå‚³æŠ½å±œ -->
    <div id="attachmentUploadDrawer" class="drawer-overlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:10000;align-items:center;justify-content:center;">
      <div class="drawer-panel" style="background:white;width:90%;max-width:600px;border-radius:12px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.2);max-height:90vh;display:flex;flex-direction:column;">
        <div class="drawer-header" style="padding:20px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;">
          <h2 style="margin:0;font-size:18px;font-weight:600;color:#1f2937;">ğŸ“¤ ä¸Šå‚³é™„ä»¶</h2>
          <button onclick="window.closeAttachmentUploadDrawer()" class="drawer-close-btn" style="background:none;border:none;font-size:28px;cursor:pointer;color:#6b7280;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:4px;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">âœ•</button>
        </div>
        <div class="drawer-body" style="padding:24px;overflow-y:auto;flex:1;">
          <form id="attachmentUploadForm">
            <div class="form-group" style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:8px;font-weight:500;color:#374151;">æ–‡ä»¶ *</label>
              <input type="file" id="attachment-file" required style="width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;" />
              <small style="color:#6b7280;font-size:12px;">æœ€å¤§ 25MB</small>
            </div>
            <div class="form-group" style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:8px;font-weight:500;color:#374151;">æ¨™é¡Œ</label>
              <input type="text" id="attachment-title" placeholder="ç•™ç©ºå‰‡è‡ªå‹•ä½¿ç”¨æª”å" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:6px;" />
              <small style="color:#6b7280;font-size:12px;">ç•™ç©ºå‰‡ä½¿ç”¨æª”åä½œç‚ºæ¨™é¡Œ</small>
            </div>
            <div class="form-group" style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:8px;font-weight:500;color:#374151;">æè¿°ï¼ˆé¸å¡«ï¼‰</label>
              <textarea id="attachment-description" rows="3" placeholder="è«‹è¼¸å…¥æ–‡ä»¶æè¿°" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:6px;"></textarea>
            </div>
            <div style="padding:16px;background:#f0f9ff;border:1px solid #bfdbfe;border-radius:8px;margin-bottom:20px;">
              <div style="font-size:14px;color:#1e40af;margin-bottom:8px;font-weight:600;">ğŸ’¡ é—œè¯æç¤º</div>
              <div style="font-size:13px;color:#1e40af;line-height:1.6;">
                â€¢ å¾ä»»å‹™/å®¢æˆ¶é é¢ä¸Šå‚³æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•é—œè¯<br/>
                â€¢ åœ¨æ­¤é é¢ä¸Šå‚³çš„é™„ä»¶ç‚ºã€Œæœªé—œè¯ã€ç‹€æ…‹<br/>
                â€¢ å»ºè­°ç›´æ¥åœ¨å°æ‡‰é é¢ï¼ˆä»»å‹™è©³æƒ…ç­‰ï¼‰ä¸Šå‚³é™„ä»¶
              </div>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end;">
              <button type="button" onclick="closeAttachmentUploadDrawer()" style="padding:10px 20px;border:1px solid #e5e7eb;background:white;border-radius:8px;cursor:pointer;font-weight:500;">å–æ¶ˆ</button>
              <button type="submit" style="padding:10px 20px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">ä¸Šå‚³</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- æŠ½å±œé®ç½© -->
    <div id="drawerOverlay" class="drawer-overlay"></div>
    
    <!-- æ¨™ç±¤ç®¡ç†å½ˆçª— -->
    <div id="tagManagerModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;">
      <div style="background:white;border-radius:12px;width:90%;max-width:600px;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);">
        <div style="padding:20px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;">
          <h3 style="margin:0;font-size:18px;font-weight:600;">ğŸ·ï¸ æ¨™ç±¤ç®¡ç†</h3>
          <button onclick="closeTagManager()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#6b7280;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:4px;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">Ã—</button>
        </div>
        <div style="padding:16px;overflow-y:auto;flex:1;">
          <div style="margin-bottom:16px;padding:12px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;font-size:13px;color:#1e40af;">
            ğŸ’¡ æç¤ºï¼šç·¨è¼¯æˆ–åˆªé™¤æ¨™ç±¤ä¸æœƒå½±éŸ¿å·²å­˜åœ¨çš„SOP/FAQï¼Œåƒ…å½±éŸ¿æ–°å¢æ™‚çš„æ¨™ç±¤é¸é …
          </div>
          <div id="tagManagerList" style="display:flex;flex-direction:column;gap:8px;">
            <!-- æ¨™ç±¤åˆ—è¡¨å°‡å‹•æ…‹æ·»åŠ  -->
          </div>
        </div>
        <div style="padding:16px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
          <div style="font-size:13px;color:#6b7280;">
            å…± <span id="tagCount">0</span> å€‹æ¨™ç±¤
          </div>
          <button onclick="closeTagManager()" class="btn btn-secondary">é—œé–‰</button>
        </div>
      </div>
    </div>
    
    <!-- SOP ç·¨è¼¯æŠ½å±œ -->
    <div id="sopEditDrawer" class="drawer">
      <div style="padding:24px;border-bottom:1px solid #e5e7eb;background:#f9fafb;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2 style="margin:0;font-size:20px;font-weight:700;color:#1f2937;">ğŸ“ ç·¨è¼¯ SOP</h2>
          <button onclick="closeSopDrawer()" style="font-size:32px;color:#9ca3af;background:none;border:none;cursor:pointer;padding:0;line-height:1;">&times;</button>
        </div>
        <p style="margin:8px 0 0 0;font-size:13px;color:#6b7280;">å»ºç«‹æˆ–ç·¨è¼¯æ¨™æº–ä½œæ¥­æµç¨‹æ–‡æª”</p>
      </div>
      
      <div style="padding:24px;">
        <form id="sopFormDrawer">
          <input type="hidden" id="sop-id-drawer" />
          
          <div class="form-group">
            <label>æ¨™é¡Œ *</label>
            <input type="text" id="sop-title-drawer" required placeholder="è«‹è¼¸å…¥ SOP æ¨™é¡Œ" />
          </div>

          <div class="form-group">
            <label>æœå‹™é¡å‹åˆ†é¡ *</label>
            <select id="sop-category-drawer" required>
              <option value="">è«‹é¸æ“‡æœå‹™é¡å‹...</option>
              <!-- å‹•æ…‹åŠ è¼‰æœå‹™é¡å‹ -->
            </select>
            <div style="margin-top:6px;font-size:11px;color:#64748b;line-height:1.4;">
              ğŸ’¡ é¸æ“‡å°æ‡‰çš„æœå‹™é¡å‹ï¼Œå‰µå»ºä»»å‹™æ™‚æœƒè‡ªå‹•ç¯©é¸ç›¸é—œSOP
            </div>
          </div>

          <div class="form-group">
            <label>å®¢æˆ¶</label>
            <select id="sop-client-drawer">
              <option value="">ä¸æŒ‡å®šï¼ˆé€šç”¨ï¼‰</option>
              <!-- å‹•æ…‹åŠ è¼‰å®¢æˆ¶æ¸…å–® -->
            </select>
            <div style="margin-top:6px;font-size:11px;color:#64748b;line-height:1.4;">
              ğŸ’¡ é¸å¡«ï¼šæŒ‡å®šç‰¹å®šå®¢æˆ¶å°ˆç”¨çš„SOPï¼Œè‹¥ä¸é¸æ“‡å‰‡ç‚ºé€šç”¨SOP
            </div>
          </div>

          <div class="form-group">
            <label>SOP é©ç”¨å±¤ç´š *</label>
            <select id="sop-scope-drawer" required>
              <option value="">è«‹é¸æ“‡é©ç”¨å±¤ç´š...</option>
              <option value="service">ğŸ¢ æœå‹™å±¤ç´šï¼ˆæ•´å€‹æœå‹™çš„é€šç”¨æµç¨‹ï¼‰</option>
              <option value="task">ğŸ“‹ ä»»å‹™å±¤ç´šï¼ˆç‰¹å®šä»»å‹™çš„è©³ç´°æ­¥é©Ÿï¼‰</option>
            </select>
            <div style="margin-top:6px;font-size:11px;color:#64748b;line-height:1.4;">
              <div style="margin-bottom:4px;">ğŸ“Œ <strong>æœå‹™å±¤ç´šï¼š</strong>é©ç”¨æ–¼æ•´å€‹æœå‹™çš„é€šç”¨æµç¨‹ï¼ˆå¦‚ã€Œè¨˜å¸³æœå‹™æ¨™æº–ä½œæ¥­æµç¨‹ã€ï¼‰ï¼Œæœƒè‡ªå‹•é—œè¯åˆ°è©²æœå‹™çš„æ‰€æœ‰ä»»å‹™</div>
              <div>ğŸ“Œ <strong>ä»»å‹™å±¤ç´šï¼š</strong>é©ç”¨æ–¼ç‰¹å®šä»»å‹™çš„è©³ç´°æ­¥é©Ÿï¼ˆå¦‚ã€Œæœˆçµä½œæ¥­ç¬¬3æ­¥é©Ÿã€ï¼‰ï¼Œç”±ç”¨æˆ¶åœ¨å‰µå»ºä»»å‹™æ™‚æ‰‹å‹•é¸æ“‡</div>
            </div>
          </div>
          
          <div class="form-group">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
              <label style="margin:0;">æ¨™ç±¤</label>
              <button type="button" onclick="event.preventDefault();event.stopPropagation();addNewTag('sop')" class="btn" style="padding:2px 8px;font-size:11px;background:#f3f4f6;color:#374151;border:1px solid #d1d5db;" title="æ–°å¢æ¨™ç±¤é¸é …">
                â• æ–°å¢
              </button>
            </div>
            <div id="sop-tags-checkboxes" style="display:flex;flex-wrap:wrap;gap:6px;padding:8px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;background:#fafbfc;max-height:120px;overflow-y:auto;">
              <!-- æ¨™ç±¤æŒ‰éˆ•æœƒå‹•æ…‹è¼‰å…¥ -->
            </div>
          </div>
          
          <div class="form-group">
            <label>å…§å®¹ *</label>
            <div id="sop-editor-drawer" style="min-height:400px;background:white;border:1px solid #d1d5db;border-radius:6px;"></div>
          </div>
          
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:24px;">
            <button type="button" class="btn" onclick="closeSopDrawer()">å–æ¶ˆ</button>
            <button type="submit" class="btn primary" id="sopSubmitBtnDrawer">
              <span>ğŸ’¾ å„²å­˜ SOP</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- FAQ ç·¨è¼¯æŠ½å±œ -->
    <div id="faqEditDrawer" class="drawer">
      <div style="padding:24px;border-bottom:1px solid #e5e7eb;background:#f9fafb;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2 style="margin:0;font-size:20px;font-weight:700;color:#1f2937;">â“ ç·¨è¼¯ FAQ</h2>
          <button onclick="closeFaqDrawer()" style="font-size:32px;color:#9ca3af;background:none;border:none;cursor:pointer;padding:0;line-height:1;">&times;</button>
        </div>
        <p style="margin:8px 0 0 0;font-size:13px;color:#6b7280;">å»ºç«‹æˆ–ç·¨è¼¯å¸¸è¦‹å•é¡Œè§£ç­”</p>
      </div>
      
      <div style="padding:24px;">
        <form id="faqFormDrawer">
          <input type="hidden" id="faq-id-drawer" />
          
          <div class="form-group">
            <label>å•é¡Œ *</label>
            <input type="text" id="faq-question-drawer" required placeholder="è«‹è¼¸å…¥å•é¡Œ" />
          </div>

          <div class="form-group">
            <label>æœå‹™é¡å‹åˆ†é¡ *</label>
            <select id="faq-category-drawer" required>
              <option value="">è«‹é¸æ“‡æœå‹™é¡å‹...</option>
              <!-- å‹•æ…‹åŠ è¼‰æœå‹™é¡å‹ -->
            </select>
            <div style="font-size:12px;color:#6b7280;margin-top:6px;">
              ğŸ’¡ é¸æ“‡æ­¤FAQæ‰€å±¬çš„æœå‹™é¡å‹ï¼Œæ–¹ä¾¿æŒ‰æœå‹™åˆ†é¡ç®¡ç†
            </div>
          </div>
          
          <div class="form-group">
            <label>å®¢æˆ¶</label>
            <select id="faq-client-drawer">
              <option value="">ä¸æŒ‡å®šï¼ˆé€šç”¨ï¼‰</option>
              <!-- å‹•æ…‹åŠ è¼‰å®¢æˆ¶æ¸…å–® -->
            </select>
            <div style="margin-top:6px;font-size:11px;color:#64748b;line-height:1.4;">
              ğŸ’¡ é¸å¡«ï¼šæŒ‡å®šç‰¹å®šå®¢æˆ¶å°ˆç”¨çš„FAQï¼Œè‹¥ä¸é¸æ“‡å‰‡ç‚ºé€šç”¨FAQ
            </div>
          </div>
          
          <div class="form-group">
            <label>FAQ é©ç”¨å±¤ç´š *</label>
            <select id="faq-scope-drawer" required style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
              <option value="">è«‹é¸æ“‡é©ç”¨å±¤ç´š...</option>
              <option value="service">ğŸ”· æœå‹™å±¤ç´šï¼ˆé©ç”¨æ–¼æ•´å€‹æœå‹™çš„é€šç”¨FAQï¼‰</option>
              <option value="task">ğŸ“‹ ä»»å‹™å±¤ç´šï¼ˆé©ç”¨æ–¼ç‰¹å®šä»»å‹™çš„FAQï¼‰</option>
            </select>
            <div style="font-size:12px;color:#6b7280;margin-top:6px;line-height:1.5;">
              ğŸ’¡ <strong>æœå‹™å±¤ç´šï¼š</strong>é¸æ“‡æŸæœå‹™æ™‚ï¼Œè©²æœå‹™æ‰€æœ‰ä»»å‹™éƒ½å¯æŸ¥çœ‹æ­¤FAQ<br>
              ğŸ’¡ <strong>ä»»å‹™å±¤ç´šï¼š</strong>åƒ…ç‰¹å®šä»»å‹™å¯é—œè¯æ­¤FAQ
            </div>
          </div>
          
          <div class="form-group">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
              <label style="margin:0;">æ¨™ç±¤</label>
              <button type="button" onclick="event.preventDefault();event.stopPropagation();addNewTag('faq')" class="btn" style="padding:2px 8px;font-size:11px;background:#f3f4f6;color:#374151;border:1px solid #d1d5db;" title="æ–°å¢æ¨™ç±¤é¸é …">
                â• æ–°å¢
              </button>
            </div>
            <div id="faq-tags-checkboxes" style="display:flex;flex-wrap:wrap;gap:6px;padding:8px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;background:#fafbfc;max-height:120px;overflow-y:auto;">
              <!-- æ¨™ç±¤æŒ‰éˆ•æœƒå‹•æ…‹è¼‰å…¥ -->
            </div>
          </div>
          
          <div class="form-group">
            <label>å›ç­” *</label>
            <div id="faq-editor-drawer" style="min-height:300px;background:white;border:1px solid #d1d5db;border-radius:6px;"></div>
          </div>
          
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:24px;">
            <button type="button" class="btn" onclick="closeFaqDrawer()">å–æ¶ˆ</button>
            <button type="submit" class="btn primary" id="faqSubmitBtnDrawer">
              <span>ğŸ’¾ å„²å­˜ FAQ</span>
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- ä¸Šå‚³æ–‡æª”æŠ½å±œ -->
    <div id="uploadDocModal" class="drawer">
      <div style="padding:24px;border-bottom:1px solid #e5e7eb;background:#f9fafb;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2 style="margin:0;font-size:20px;font-weight:700;color:#1f2937;">ğŸ“¤ ä¸Šå‚³æ–‡æª”</h2>
          <button class="close-modal" onclick="closeUploadDocModal()" style="font-size:32px;color:#9ca3af;background:none;border:none;cursor:pointer;padding:0;line-height:1;">&times;</button>
        </div>
        <p style="margin:8px 0 0 0;font-size:13px;color:#6b7280;">ä¸Šå‚³æ–‡æª”åˆ°è³‡æºä¸­å¿ƒï¼Œæ”¯æ´PDFã€Wordã€Excelç­‰æ ¼å¼</p>
      </div>
      
      <div style="padding:24px;">
          
          <form id="resourceFormModal">
            <div class="form-group" style="margin:0 0 16px 0;">
              <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-secondary);">æ–‡æª”æ¨™é¡Œ *</label>
              <input type="text" id="resource-title-modal" required style="width:100%;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;" placeholder="è«‹è¼¸å…¥æ–‡æª”æ¨™é¡Œ" />
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
              <div class="form-group" style="margin:0;">
                <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-secondary);">æœå‹™é¡å‹åˆ†é¡ *</label>
                <select id="resource-category-modal" required style="width:100%;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
                  <option value="">è«‹é¸æ“‡æœå‹™é¡å‹...</option>
                  <!-- å‹•æ…‹åŠ è¼‰æœå‹™é¡å‹ -->
                </select>
              </div>
              
              <div class="form-group" style="margin:0;">
                <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-secondary);">è³‡æºé©ç”¨å±¤ç´š *</label>
                <select id="resource-scope-modal" required style="width:100%;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
                  <option value="">è«‹é¸æ“‡é©ç”¨å±¤ç´š...</option>
                  <option value="service">ğŸ”· æœå‹™å±¤ç´š</option>
                  <option value="task">ğŸ“‹ ä»»å‹™å±¤ç´š</option>
                </select>
              </div>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
              <div class="form-group" style="margin:0;">
                <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-secondary);">å®¢æˆ¶</label>
                <select id="resource-client-modal" style="width:100%;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
                  <option value="">ä¸æŒ‡å®šï¼ˆé€šç”¨ï¼‰</option>
                  <!-- å‹•æ…‹åŠ è¼‰å®¢æˆ¶æ¸…å–® -->
                </select>
                <div style="margin-top:6px;font-size:11px;color:#64748b;line-height:1.4;">
                  ğŸ’¡ é¸å¡«ï¼šæŒ‡å®šç‰¹å®šå®¢æˆ¶å°ˆç”¨çš„æ–‡æª”
                </div>
              </div>
              
              <div class="form-group" style="margin:0;">
                <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-secondary);">å¹´æœˆ</label>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                  <select id="resource-year-modal" style="width:100%;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
                    <option value="">ä¸æŒ‡å®š</option>
                    <option value="2026">2026å¹´</option>
                    <option value="2025">2025å¹´</option>
                    <option value="2024">2024å¹´</option>
                    <option value="2023">2023å¹´</option>
                  </select>
                  <select id="resource-month-modal" style="width:100%;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
                    <option value="">ä¸æŒ‡å®š</option>
                    <option value="1">1æœˆ</option>
                    <option value="2">2æœˆ</option>
                    <option value="3">3æœˆ</option>
                    <option value="4">4æœˆ</option>
                    <option value="5">5æœˆ</option>
                    <option value="6">6æœˆ</option>
                    <option value="7">7æœˆ</option>
                    <option value="8">8æœˆ</option>
                    <option value="9">9æœˆ</option>
                    <option value="10">10æœˆ</option>
                    <option value="11">11æœˆ</option>
                    <option value="12">12æœˆ</option>
                  </select>
                </div>
                <div style="margin-top:6px;font-size:11px;color:#64748b;line-height:1.4;">
                  ğŸ’¡ é¸å¡«ï¼šæ­¸æª”åˆ°æŒ‡å®šå¹´æœˆ
                </div>
              </div>
            </div>
            
            <div class="form-group" style="margin:0 0 16px 0;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <label style="margin:0;font-size:13px;font-weight:600;color:var(--text-secondary);">æ¨™ç±¤</label>
                <button type="button" onclick="event.preventDefault();event.stopPropagation();addNewTag('resource')" class="btn" style="padding:2px 8px;font-size:11px;background:#f3f4f6;color:#374151;border:1px solid #d1d5db;" title="æ–°å¢æ¨™ç±¤é¸é …">
                  â• æ–°å¢
                </button>
              </div>
              <div id="resource-tags-checkboxes" style="display:flex;flex-wrap:wrap;gap:6px;padding:8px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;background:#fafbfc;max-height:120px;overflow-y:auto;">
                <!-- æ¨™ç±¤æŒ‰éˆ•æœƒå‹•æ…‹è¼‰å…¥ -->
              </div>
            </div>
            
            <div class="form-group" style="margin:0 0 16px 0;">
              <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-secondary);">é¸æ“‡æ–‡ä»¶ *</label>
              <div class="file-upload-area" id="fileUploadAreaModal" style="border:2px dashed rgba(15,23,42,0.2);border-radius:12px;padding:32px;text-align:center;cursor:pointer;background:#f9fafb;transition:all 0.2s;">
                <div style="font-size:48px;margin-bottom:12px;">ğŸ“</div>
                <div style="font-weight:600;margin-bottom:8px;color:var(--text-primary);">é»æ“Šæˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤è™•</div>
                <div style="font-size:13px;color:#6b7280;">æ”¯æŒ PDF, Word, Excel, PowerPoint, åœ–ç‰‡ç­‰æ ¼å¼</div>
                <input type="file" id="file-input-modal" style="display:none;" />
              </div>
              <div class="uploaded-file-info" id="uploadedFileInfoModal" style="display:none;margin-top:12px;padding:12px;background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;">
                <div style="font-weight:600;margin-bottom:4px;color:#0369a1;">å·²é¸æ“‡æ–‡ä»¶ï¼š</div>
                <div id="fileNameModal" style="color:#0c4a6e;"></div>
                <div id="fileSizeModal" style="font-size:12px;color:#075985;margin-top:4px;"></div>
              </div>
            </div>
            
            <div style="display:flex;gap:10px;justify-content:flex-end;">
              <button type="button" class="btn" onclick="closeUploadDocModal()">å–æ¶ˆ</button>
              <button type="submit" class="btn primary" id="resourceSubmitBtnModal">
                <span>ğŸ“¤ ä¸Šå‚³æ–‡æª”</span>
              </button>
            </div>
          </form>
      </div>
    </div>
    </main>

    <!-- SOPæ¨¡æ€æ¡† (å·²æ£„ç”¨ï¼Œæ”¹ç”¨å…§è¯è¡¨å–®) -->
    <div id="sopModal" class="modal" style="display:none;" onclick="if(event.target === this) closeSopModal()">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="sopModalTitle">æ–°å¢ SOP</h2>
          <button class="close-modal" onclick="event.stopPropagation(); closeSopModal();">&times;</button>
        </div>
        <form id="sopForm">
          <input type="hidden" id="sop-id" />
          
          <div class="form-group">
            <label for="sop-title">æ¨™é¡Œ *</label>
            <input type="text" id="sop-title" required />
          </div>
          
          <div class="form-group">
            <label for="sop-category">æœå‹™é¡å‹åˆ†é¡</label>
            <select id="sop-category">
              <option value="">è«‹é¸æ“‡</option>
              <!-- å‹•æ…‹åŠ è¼‰æœå‹™é¡å‹ -->
            </select>
          </div>
          
          <div class="form-group">
            <label for="sop-tags">æ¨™ç±¤ï¼ˆä»¥é€—è™Ÿåˆ†éš”ï¼‰</label>
            <input type="text" id="sop-tags" placeholder="ä¾‹å¦‚ï¼šæœˆçµ, å ±ç¨…, å°å¸³" />
          </div>
          
          <div class="form-group">
            <label>å…§å®¹ *</label>
            <div id="sop-editor-container"></div>
          </div>
          
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:24px;">
            <button type="button" class="btn" onclick="closeSopModal()">å–æ¶ˆ</button>
            <button type="submit" class="btn primary">å„²å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <!-- FAQæ¨¡æ€æ¡† (å·²æ£„ç”¨ï¼Œæ”¹ç”¨å…§è¯è¡¨å–®) -->
    <div id="faqModal" class="modal" style="display:none;" onclick="if(event.target === this) closeFaqModal()">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="faqModalTitle">æ–°å¢ FAQ</h2>
          <button class="close-modal" onclick="event.stopPropagation(); closeFaqModal();">&times;</button>
        </div>
        <form id="faqForm">
          <input type="hidden" id="faq-id" />
          
          <div class="form-group">
            <label for="faq-question">å•é¡Œ *</label>
            <input type="text" id="faq-question" required />
          </div>
          
          <div class="form-group">
            <label for="faq-category">åˆ†é¡</label>
            <select id="faq-category">
              <option value="">è«‹é¸æ“‡</option>
              <option value="accounting">è¨˜å¸³æµç¨‹</option>
              <option value="tax">ç¨…å‹™æµç¨‹</option>
              <option value="business">å·¥å•†ç™»è¨˜</option>
              <option value="hr">äººäº‹ç®¡ç†</option>
              <option value="finance">è²¡å‹™ç®¡ç†</option>
              <option value="internal">å…§éƒ¨æµç¨‹</option>
              <option value="other">å…¶ä»–</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="faq-tags">æ¨™ç±¤ï¼ˆä»¥é€—è™Ÿåˆ†éš”ï¼‰</label>
            <input type="text" id="faq-tags" placeholder="ä¾‹å¦‚ï¼šæ–°æ‰‹, å¸¸è¦‹, é‡è¦" />
          </div>
          
          <div class="form-group">
            <label>ç­”æ¡ˆ *</label>
            <div id="faq-editor-container"></div>
          </div>
          
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:24px;">
            <button type="button" class="btn" onclick="closeFaqModal()">å–æ¶ˆ</button>
            <button type="submit" class="btn primary">å„²å­˜</button>
          </div>
        </form>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-dev.3/dist/quill.min.js"></script>
    <script src="https://unpkg.com/quill-better-table@1.2.10/dist/quill-better-table.js"></script>
    <script>
      // ç­‰å¾…æ‰€æœ‰è…³æœ¬è¼‰å…¥å¾Œè¨»å†Š Better Table æ¨¡çµ„
      window.addEventListener('load', function() {
        const BetterTable = window.quillBetterTable;
        
        if (window.Quill && BetterTable) {
          try {
            console.log('ğŸ” Better Table çµæ§‹:', BetterTable);
            console.log('ğŸ” register æ–¹æ³•:', typeof BetterTable.register);
            
            // èª¿ç”¨ Better Table çš„éœæ…‹ register() æ–¹æ³•ä¾†è¨»å†Šæ‰€æœ‰ blots
            if (typeof BetterTable.register === 'function') {
              BetterTable.register();
              console.log('âœ… Better Table blots å·²è¨»å†Š');
            }
            
            // è¨»å†Šæ¨¡çµ„æœ¬èº«
            Quill.register({
              'modules/better-table': BetterTable
            }, true);
            console.log('âœ… Quill 1.3.7 + Better Table æ¨¡çµ„å·²è¨»å†Š');
            window.quillModulesReady = true;
          } catch (e) {
            console.error('âŒ Better Table è¨»å†Šå¤±æ•—:', e);
            window.quillModulesReady = false;
          }
        } else {
          console.error('âŒ Quill æˆ– Better Table è¼‰å…¥å¤±æ•—');
          console.log('Quill:', typeof window.Quill);
          console.log('quillBetterTable:', typeof window.quillBetterTable);
          window.quillModulesReady = false;
        }
      });
      
      window.quillModulesReady = false;
      
      // æ·»åŠ è¡¨æ ¼æ¨£å¼å„ªåŒ–
      const style = document.createElement('style');
      style.textContent = `
        .ql-editor table {
          border-collapse: collapse;
          width: 100%;
          margin: 12px 0;
        }
        .ql-editor table td,
        .ql-editor table th {
          border: 1px solid #ddd;
          padding: 4px 8px; /* æ¸›å°‘ä¸Šä¸‹ padding */
          min-width: 50px;
          line-height: 1.4; /* æ¸›å°‘è¡Œé«˜ */
          vertical-align: top; /* å…§å®¹å¾é ‚éƒ¨å°é½Š */
        }
        .ql-editor table th {
          background: #f5f5f5;
          font-weight: 600;
        }
        .ql-editor table tr:hover {
          background: #fafafa;
        }
        
        /* å…è¨±ç”¨æˆ¶æ‰‹å‹•èª¿æ•´è¡Œé«˜ï¼ˆé€šéåœ¨å–®å…ƒæ ¼å…§æ·»åŠ å…§å®¹ï¼‰ */
        .ql-editor table td p,
        .ql-editor table th p {
          margin: 0;
          min-height: 1.5em;
        }
      `;
      document.head.appendChild(style);
    </script>
    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        let me = null;
        let currentTab = 'sop';
        let sopEditor = null;
        let faqEditor = null;
        let isQuillReady = false;
        
        // ç­‰å¾… Quill å’Œ Better Table è¼‰å…¥å®Œæˆ
        function waitForQuillAndTable() {
          return new Promise((resolve, reject) => {
            let attempts = 0;
            const maxAttempts = 100; // æœ€å¤šç­‰å¾… 10 ç§’
            
            const checkInterval = setInterval(() => {
              attempts++;
              
              // æª¢æŸ¥å…¨å±€æ¨™èªŒ
              if (window.quillModulesReady === true) {
                clearInterval(checkInterval);
                console.log('âœ… æ¨¡çµ„å·²å°±ç·’ï¼Œå¯ä»¥åˆå§‹åŒ–ç·¨è¼¯å™¨');
                isQuillReady = true;
                resolve();
              } else if (window.quillModulesReady === false && attempts > 30) {
                // çµ¦äºˆè¶³å¤ æ™‚é–“è¼‰å…¥ï¼Œä½†å¦‚æœæ˜ç¢ºå¤±æ•—å‰‡æå‰å ±éŒ¯
                clearInterval(checkInterval);
                console.error('âŒ æ¨¡çµ„è¼‰å…¥å¤±æ•—');
                console.log('è«‹æª¢æŸ¥ï¼š');
                console.log('1. /assets/vendor/quill-better-table.js æ˜¯å¦å­˜åœ¨');
                console.log('2. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸ï¼ˆQuill CDNï¼‰');
                console.log('3. ç€è¦½å™¨æ§åˆ¶å°æ˜¯å¦æœ‰å…¶ä»–éŒ¯èª¤');
                reject(new Error('æ¨¡çµ„è¼‰å…¥å¤±æ•—'));
              } else if (attempts >= maxAttempts) {
                clearInterval(checkInterval);
                console.error('âŒ æ¨¡çµ„è¼‰å…¥è¶…æ™‚');
                reject(new Error('æ¨¡çµ„è¼‰å…¥è¶…æ™‚'));
              }
            }, 100);
          });
        }
        
        // åœ–ç‰‡ä¸Šå‚³è™•ç†å™¨
        function imageHandler() {
          const input = document.createElement('input');
          input.setAttribute('type', 'file');
          input.setAttribute('accept', 'image/*');
          input.click();
          
          input.onchange = async () => {
            const file = input.files[0];
            if (!file) return;
            
            // æª¢æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ 5MBï¼‰
            if (file.size > 5 * 1024 * 1024) {
              alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB');
              return;
            }
            
            try {
              // è½‰æ›ç‚º Base64
              const reader = new FileReader();
              reader.onload = (e) => {
                const range = this.quill.getSelection(true);
                this.quill.insertEmbed(range.index, 'image', e.target.result);
                this.quill.setSelection(range.index + 1);
              };
              reader.readAsDataURL(file);
            } catch (error) {
              console.error('åœ–ç‰‡æ’å…¥å¤±æ•—:', error);
              alert('åœ–ç‰‡æ’å…¥å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
          };
        }
        
        // å·¥å…·å‡½æ•¸ï¼šå–å¾—åˆ†é¡åç¨±ï¼ˆå‹•æ…‹å¾æœå‹™é¡å‹ä¸­æŸ¥æ‰¾ï¼‰
        function getCategoryName(category, type = 'sop') {
          if (!category) return 'æœªåˆ†é¡';
          
          // å¾æœå‹™é¡å‹åˆ—è¡¨ä¸­æŸ¥æ‰¾
          const service = serviceTypes.find(s => s.service_code === category);
          if (service) return service.service_name;
          
          // å¾Œå‚™æ–¹æ¡ˆï¼šä½¿ç”¨éœæ…‹æ˜ å°„
          const categoryMap = {
            'accounting': 'è¨˜å¸³æµç¨‹',
            'tax': 'ç¨…å‹™æµç¨‹',
            'consulting': 'é¡§å•è«®è©¢',
            'business': 'å·¥å•†ç™»è¨˜',
            'hr': 'äººäº‹ç®¡ç†',
            'finance': 'è²¡å‹™ç®¡ç†',
            'contract': 'åˆåŒç¯„æœ¬',
            'internal': 'å…§éƒ¨æµç¨‹',
            'other': 'å…¶ä»–'
          };
          return categoryMap[category] || category;
        }
        
        let sopState = { page:1, perPage:12, total:0 };
        let faqState = { page:1, perPage:12, total:0 };
        let resourcesState = { page:1, perPage:12, total:0, q:'', category:'' };
        let serviceTypes = []; // å­˜å„²æœå‹™é¡å‹åˆ—è¡¨

        // åˆå§‹åŒ–å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆé é¢åŠ è¼‰æ™‚åˆå§‹åŒ–ï¼‰
        function initSopEditor() {
          if (sopEditor) return; // å·²åˆå§‹åŒ–åˆ™è·³è¿‡
          
          const container = document.getElementById('sop-editor-inline');
          if (!container) {
            console.error('SOP ç·¨è¼¯å™¨å®¹å™¨æœªæ‰¾åˆ°');
            return;
          }
          
          sopEditor = new Quill('#sop-editor-inline', {
            theme: 'snow',
            modules: {
              toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'indent': '-1'}, { 'indent': '+1' }],
                ['link', 'image'],
                [{ 'color': [] }, { 'background': [] }],
              ]
            },
            placeholder: 'è«‹è¼¸å…¥SOPå…§å®¹...'
          });
          
          console.log('SOP ç·¨è¼¯å™¨å·²åˆå§‹åŒ–');
        }
        
        function initFaqEditor() {
          if (faqEditor) return; // å·²åˆå§‹åŒ–åˆ™è·³è¿‡
          
          const container = document.getElementById('faq-editor-inline');
          if (!container) {
            console.error('FAQ ç·¨è¼¯å™¨å®¹å™¨æœªæ‰¾åˆ°');
            return;
          }
          
          faqEditor = new Quill('#faq-editor-inline', {
            theme: 'snow',
            modules: {
              toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link'],
                [{ 'color': [] }],
              ]
            },
            placeholder: 'è«‹è¼¸å…¥FAQç­”æ¡ˆ...'
          });
          
          console.log('FAQ ç·¨è¼¯å™¨å·²åˆå§‹åŒ–');
        }
        
        // æª¢æŸ¥ Better Table æ¨¡çµ„æ˜¯å¦å·²è¨»å†Š
        function registerTableModule() {
          if (!window.Quill) {
            console.error('âŒ Quill å°šæœªè¼‰å…¥');
            return false;
          }
          
          if (!window.quillBetterTable) {
            console.error('âŒ Better Table æ¨¡çµ„å°šæœªè¼‰å…¥');
            return false;
          }
          
          console.log('âœ… Better Table æ¨¡çµ„å·²å°±ç·’');
          return true;
        }
        
        // åˆå§‹åŒ–æŠ½å±œä¸­çš„ SOP ç·¨è¼¯å™¨
        async function initSopDrawerEditor() {
          if (window.sopDrawerEditor) return; // å·²åˆå§‹åŒ–åˆ™è·³è¿‡
          
          // ç¢ºä¿ Quill å·²è¼‰å…¥
          if (!isQuillReady) {
            try {
              await waitForQuillAndTable();
            } catch (e) {
              alert('âŒ ç·¨è¼¯å™¨è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦');
              console.error(e);
              return;
            }
          }
          
          const container = document.getElementById('sop-editor-drawer');
          if (!container) {
            console.error('SOP æŠ½å±œç·¨è¼¯å™¨å®¹å™¨æœªæ‰¾åˆ°');
            return;
          }
          
          // å…ˆå˜—è©¦è¨»å†Šè¡¨æ ¼æ¨¡çµ„
          const hasTable = registerTableModule();
          
          if (!hasTable) {
            alert('âŒ è¡¨æ ¼æ¨¡çµ„è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦');
            return;
          }
          
          // é…ç½®ï¼ˆQuill 1.3.7 + Better Table å®Œæ•´é…ç½®ï¼‰
          // æ³¨æ„ï¼šå¿…é ˆå…ˆåˆå§‹åŒ–ä¸€å€‹åŸºç¤ Quill å¯¦ä¾‹ï¼Œè®“ keyboard æ¨¡çµ„æ­£ç¢ºè¨­ç½®
          const tempConfig = {
            theme: 'snow',
            modules: {
              toolbar: false
            }
          };
          
          // å…ˆå‰µå»ºè‡¨æ™‚å¯¦ä¾‹ä»¥åˆå§‹åŒ– keyboard ç¶å®š
          const temp = new Quill('#sop-editor-drawer', tempConfig);
          
          // æª¢æŸ¥ä¸¦ç¢ºä¿ Backspace ç¶å®šå­˜åœ¨
          if (!temp.keyboard.bindings['Backspace'] || !Array.isArray(temp.keyboard.bindings['Backspace'])) {
            console.warn('âš ï¸ Backspace ç¶å®šä¸å­˜åœ¨ï¼Œæ‰‹å‹•å‰µå»º');
            temp.keyboard.bindings['Backspace'] = [];
          }
          
          console.log('âœ… Keyboard ç¶å®šå·²åˆå§‹åŒ–:', temp.keyboard.bindings['Backspace']);
          
          // éŠ·æ¯€è‡¨æ™‚å¯¦ä¾‹
          delete temp;
          
          // æ¸…ç©ºå®¹å™¨
          document.getElementById('sop-editor-drawer').innerHTML = '';
          
          // ç¾åœ¨å‰µå»ºçœŸæ­£çš„ç·¨è¼¯å™¨ï¼ŒåŒ…å« Better Table
          const config = {
            theme: 'snow',
            modules: {
              'better-table': {
                operationMenu: {
                  items: {
                    unmergeCells: {
                      text: 'å–æ¶ˆåˆä½µå–®å…ƒæ ¼'
                    },
                    mergeCells: {
                      text: 'åˆä½µå–®å…ƒæ ¼'
                    },
                    insertColumnRight: {
                      text: 'å‘å³æ’å…¥åˆ—'
                    },
                    insertColumnLeft: {
                      text: 'å‘å·¦æ’å…¥åˆ—'
                    },
                    insertRowUp: {
                      text: 'å‘ä¸Šæ’å…¥è¡Œ'
                    },
                    insertRowDown: {
                      text: 'å‘ä¸‹æ’å…¥è¡Œ'
                    },
                    removeCol: {
                      text: 'åˆªé™¤ç•¶å‰åˆ—'
                    },
                    removeRow: {
                      text: 'åˆªé™¤ç•¶å‰è¡Œ'
                    },
                    removeTable: {
                      text: 'åˆªé™¤è¡¨æ ¼'
                    }
                  },
                  color: {
                    colors: ['#ffffff', '#e0e0e0', '#f3f3f3', '#fef2e8', '#e8f4fd'],
                    text: 'èƒŒæ™¯é¡è‰²ï¼š'
                  }
                }
              },
              toolbar: [
                [{ 'header': [2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['image'],
                [{ 'color': [] }],
              ]
            },
            placeholder: 'è«‹è¼¸å…¥SOPå…§å®¹...'
          };
          
          window.sopDrawerEditor = new Quill('#sop-editor-drawer', config);
          
          // è‡ªå®šç¾©åœ–ç‰‡è™•ç†å™¨
          const toolbar = window.sopDrawerEditor.getModule('toolbar');
          toolbar.addHandler('image', function() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();
            
            input.onchange = () => {
              const file = input.files[0];
              if (!file) return;
              
              if (file.size > 5 * 1024 * 1024) {
                alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB');
                return;
              }
              
              const reader = new FileReader();
              reader.onload = (e) => {
                const range = window.sopDrawerEditor.getSelection(true);
                window.sopDrawerEditor.insertEmbed(range.index, 'image', e.target.result);
                window.sopDrawerEditor.setSelection(range.index + 1);
              };
              reader.readAsDataURL(file);
            };
          });
          
          // åœ¨å·¥å…·æ¬„æœ€å¾Œæ·»åŠ è¡¨æ ¼æ’å…¥æŒ‰éˆ•
          const toolbarContainer = document.querySelector('#sop-editor-drawer').previousElementSibling;
          
          const tableBtn = document.createElement('button');
          tableBtn.type = 'button'; // é˜²æ­¢è§¸ç™¼è¡¨å–®æäº¤
          tableBtn.className = 'ql-table-insert';
          tableBtn.innerHTML = `<span class="material-icons" style="font-size: 18px;">table_chart</span>`;
          tableBtn.title = 'æ’å…¥è¡¨æ ¼'; // ä½¿ç”¨ tooltip è€Œä¸æ˜¯æ–‡å­—
          tableBtn.onclick = (e) => {
            e.preventDefault(); // é˜²æ­¢è§¸ç™¼è¡¨å–®æäº¤
            e.stopPropagation();
            
            // é¡¯ç¤ºè¡¨æ ¼å°ºå¯¸é¸æ“‡å™¨
            const rows = prompt('è«‹è¼¸å…¥è¡¨æ ¼è¡Œæ•¸ï¼ˆ1-10ï¼‰:', '3');
            if (!rows) return;
            const cols = prompt('è«‹è¼¸å…¥è¡¨æ ¼åˆ—æ•¸ï¼ˆ1-10ï¼‰:', '3');
            if (!cols) return;
            
            const rowNum = parseInt(rows);
            const colNum = parseInt(cols);
            
            if (isNaN(rowNum) || isNaN(colNum) || rowNum < 1 || rowNum > 10 || colNum < 1 || colNum > 10) {
              alert('è«‹è¼¸å…¥ 1-10 ä¹‹é–“çš„æ•¸å­—');
              return;
            }
            
            try {
              const tableModule = window.sopDrawerEditor.getModule('better-table');
              if (tableModule && tableModule.insertTable) {
                console.log(`ğŸ”§ å˜—è©¦æ’å…¥ ${rowNum}x${colNum} è¡¨æ ¼...`);
                tableModule.insertTable(rowNum, colNum);
                console.log('âœ… è¡¨æ ¼æ’å…¥æˆåŠŸ');
              } else {
                console.error('âŒ Better Table æ¨¡çµ„æˆ– insertTable æ–¹æ³•æœªæ‰¾åˆ°');
                alert('è¡¨æ ¼åŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨');
              }
            } catch (error) {
              console.error('âŒ æ’å…¥è¡¨æ ¼æ™‚å‡ºéŒ¯:', error);
              alert('æ’å…¥è¡¨æ ¼å¤±æ•—: ' + error.message);
            }
          };
          toolbarContainer.appendChild(tableBtn);
          
          console.log('âœ… SOP ç·¨è¼¯å™¨å·²åˆå§‹åŒ–ï¼ˆå«è¡¨æ ¼èˆ‡åœ–ç‰‡åŠŸèƒ½ï¼‰');
        }
        
        // åˆå§‹åŒ–æŠ½å±œä¸­çš„ FAQ ç·¨è¼¯å™¨
        async function initFaqDrawerEditor() {
          if (window.faqDrawerEditor) return; // å·²åˆå§‹åŒ–åˆ™è·³è¿‡
          
          // ç¢ºä¿ Quill å·²è¼‰å…¥
          if (!isQuillReady) {
            try {
              await waitForQuillAndTable();
            } catch (e) {
              alert('âŒ ç·¨è¼¯å™¨è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦');
              console.error(e);
              return;
            }
          }
          
          const container = document.getElementById('faq-editor-drawer');
          if (!container) {
            console.error('FAQ æŠ½å±œç·¨è¼¯å™¨å®¹å™¨æœªæ‰¾åˆ°');
            return;
          }
          
          // å…ˆå˜—è©¦è¨»å†Šè¡¨æ ¼æ¨¡çµ„
          const hasTable = registerTableModule();
          
          if (!hasTable) {
            alert('âŒ è¡¨æ ¼æ¨¡çµ„è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦');
            return;
          }
          
          // é…ç½®ï¼ˆQuill 1.3.7 + Better Table å®Œæ•´é…ç½®ï¼‰
          // å…ˆå‰µå»ºè‡¨æ™‚å¯¦ä¾‹ä»¥åˆå§‹åŒ– keyboard ç¶å®š
          const tempConfig = {
            theme: 'snow',
            modules: {
              toolbar: false
            }
          };
          
          const temp = new Quill('#faq-editor-drawer', tempConfig);
          
          // æª¢æŸ¥ä¸¦ç¢ºä¿ Backspace ç¶å®šå­˜åœ¨
          if (!temp.keyboard.bindings['Backspace'] || !Array.isArray(temp.keyboard.bindings['Backspace'])) {
            console.warn('âš ï¸ FAQ Backspace ç¶å®šä¸å­˜åœ¨ï¼Œæ‰‹å‹•å‰µå»º');
            temp.keyboard.bindings['Backspace'] = [];
          }
          
          // éŠ·æ¯€è‡¨æ™‚å¯¦ä¾‹
          delete temp;
          
          // æ¸…ç©ºå®¹å™¨
          document.getElementById('faq-editor-drawer').innerHTML = '';
          
          // ç¾åœ¨å‰µå»ºçœŸæ­£çš„ç·¨è¼¯å™¨ï¼ŒåŒ…å« Better Table
          const config = {
            theme: 'snow',
            modules: {
              'better-table': {
                operationMenu: {
                  items: {
                    unmergeCells: {
                      text: 'å–æ¶ˆåˆä½µå–®å…ƒæ ¼'
                    },
                    mergeCells: {
                      text: 'åˆä½µå–®å…ƒæ ¼'
                    },
                    insertColumnRight: {
                      text: 'å‘å³æ’å…¥åˆ—'
                    },
                    insertColumnLeft: {
                      text: 'å‘å·¦æ’å…¥åˆ—'
                    },
                    insertRowUp: {
                      text: 'å‘ä¸Šæ’å…¥è¡Œ'
                    },
                    insertRowDown: {
                      text: 'å‘ä¸‹æ’å…¥è¡Œ'
                    },
                    removeCol: {
                      text: 'åˆªé™¤ç•¶å‰åˆ—'
                    },
                    removeRow: {
                      text: 'åˆªé™¤ç•¶å‰è¡Œ'
                    },
                    removeTable: {
                      text: 'åˆªé™¤è¡¨æ ¼'
                    }
                  },
                  color: {
                    colors: ['#ffffff', '#e0e0e0', '#f3f3f3', '#fef2e8', '#e8f4fd'],
                    text: 'èƒŒæ™¯é¡è‰²ï¼š'
                  }
                }
              },
              toolbar: [
                [{ 'header': [2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['image'],
                [{ 'color': [] }],
              ]
            },
            placeholder: 'è«‹è¼¸å…¥FAQç­”æ¡ˆ...'
          };
          
          window.faqDrawerEditor = new Quill('#faq-editor-drawer', config);
          
          // è‡ªå®šç¾©åœ–ç‰‡è™•ç†å™¨
          const toolbar = window.faqDrawerEditor.getModule('toolbar');
          toolbar.addHandler('image', function() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();
            
            input.onchange = () => {
              const file = input.files[0];
              if (!file) return;
              
              if (file.size > 5 * 1024 * 1024) {
                alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB');
                return;
              }
              
              const reader = new FileReader();
              reader.onload = (e) => {
                const range = window.faqDrawerEditor.getSelection(true);
                window.faqDrawerEditor.insertEmbed(range.index, 'image', e.target.result);
                window.faqDrawerEditor.setSelection(range.index + 1);
              };
              reader.readAsDataURL(file);
            };
          });
          
          // åœ¨å·¥å…·æ¬„æœ€å¾Œæ·»åŠ è¡¨æ ¼æŒ‰éˆ•
          const toolbarContainer = document.querySelector('#faq-editor-drawer').previousElementSibling;
          
          const tableBtn = document.createElement('button');
          tableBtn.type = 'button'; // é˜²æ­¢è§¸ç™¼è¡¨å–®æäº¤
          tableBtn.className = 'ql-table-insert';
          tableBtn.innerHTML = `<span class="material-icons" style="font-size: 18px;">table_chart</span>`;
          tableBtn.title = 'æ’å…¥è¡¨æ ¼'; // ä½¿ç”¨ tooltip è€Œä¸æ˜¯æ–‡å­—
          tableBtn.onclick = (e) => {
            e.preventDefault(); // é˜²æ­¢è§¸ç™¼è¡¨å–®æäº¤
            e.stopPropagation();
            
            // é¡¯ç¤ºè¡¨æ ¼å°ºå¯¸é¸æ“‡å™¨
            const rows = prompt('è«‹è¼¸å…¥è¡¨æ ¼è¡Œæ•¸ï¼ˆ1-10ï¼‰:', '3');
            if (!rows) return;
            const cols = prompt('è«‹è¼¸å…¥è¡¨æ ¼åˆ—æ•¸ï¼ˆ1-10ï¼‰:', '3');
            if (!cols) return;
            
            const rowNum = parseInt(rows);
            const colNum = parseInt(cols);
            
            if (isNaN(rowNum) || isNaN(colNum) || rowNum < 1 || rowNum > 10 || colNum < 1 || colNum > 10) {
              alert('è«‹è¼¸å…¥ 1-10 ä¹‹é–“çš„æ•¸å­—');
              return;
            }
            
            try {
              const tableModule = window.faqDrawerEditor.getModule('better-table');
              if (tableModule && tableModule.insertTable) {
                console.log(`ğŸ”§ å˜—è©¦æ’å…¥ ${rowNum}x${colNum} è¡¨æ ¼...`);
                tableModule.insertTable(rowNum, colNum);
                console.log('âœ… è¡¨æ ¼æ’å…¥æˆåŠŸ');
              } else {
                console.error('âŒ Better Table æ¨¡çµ„æˆ– insertTable æ–¹æ³•æœªæ‰¾åˆ°');
                alert('è¡¨æ ¼åŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨');
              }
            } catch (error) {
              console.error('âŒ æ’å…¥è¡¨æ ¼æ™‚å‡ºéŒ¯:', error);
              alert('æ’å…¥è¡¨æ ¼å¤±æ•—: ' + error.message);
            }
          };
          toolbarContainer.appendChild(tableBtn);
          
          console.log('âœ… FAQ ç·¨è¼¯å™¨å·²åˆå§‹åŒ–ï¼ˆå«è¡¨æ ¼èˆ‡åœ–ç‰‡åŠŸèƒ½ï¼‰');
        }
        
        // æ¸…ç©º SOP è¡¨å–®ï¼ˆå·²å»¢æ£„ï¼Œä¿ç•™ä»¥é˜²å¼•ç”¨ï¼‰
        function resetSopForm() {
          document.getElementById('sop-id-inline').value = '';
          document.getElementById('sop-title-inline').value = '';
          document.getElementById('sop-category-inline').value = '';
          document.getElementById('sop-tags-inline').value = '';
          if (sopEditor) sopEditor.setText('');
          document.getElementById('sopSubmitBtnInline').querySelector('span').textContent = 'ğŸ’¾ å„²å­˜ SOP';
        }
        
        // æ¸…ç©º FAQ è¡¨å–®
        function resetFaqForm() {
          document.getElementById('faq-id-inline').value = '';
          document.getElementById('faq-question-inline').value = '';
          document.getElementById('faq-category-inline').value = '';
          document.getElementById('faq-tags-inline').value = '';
          if (faqEditor) faqEditor.setText('');
          document.getElementById('faqSubmitBtnInline').querySelector('span').textContent = 'ğŸ’¾ å„²å­˜ FAQ';
        }

        async function ensureSession(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/knowledge'); return false; }
            const json = await res.json();
            me = (json && json.ok && json.data) ? json.data : null;
            return true;
          } catch (_) {
            return false;
          }
        }
        
        // è¼‰å…¥æœå‹™é¡å‹åˆ—è¡¨
        async function loadServices() {
          try {
            const res = await fetch(`${apiBase}/services`, { credentials: 'include' });
            if (!res.ok) return;
            const json = await res.json();
            
            if (json.ok && Array.isArray(json.data)) {
              serviceTypes = json.data;
              
              // å¡«å……ç¯©é¸å™¨ä¸‹æ‹‰æ¡†
              const categoryFilter = document.getElementById('category');
              if (categoryFilter) {
                const optionsHTML = serviceTypes.map(s => 
                  `<option value="${s.service_code}">${s.service_name}</option>`
                ).join('');
                categoryFilter.innerHTML = '<option value="all">å…¨éƒ¨</option>' + optionsHTML;
              }
              
              // å¡«å……SOPæŠ½å±œçš„ä¸‹æ‹‰æ¡†
              const sopCategoryDrawer = document.getElementById('sop-category-drawer');
              if (sopCategoryDrawer) {
                const optionsHTML = serviceTypes.map(s => 
                  `<option value="${s.service_code}">${s.service_name}</option>`
                ).join('');
                sopCategoryDrawer.innerHTML = '<option value="">è«‹é¸æ“‡æœå‹™é¡å‹...</option>' + optionsHTML;
              }
              
              // å¡«å……èˆŠçš„SOPæ¨¡æ…‹æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              const sopCategory = document.getElementById('sop-category');
              if (sopCategory) {
                const optionsHTML = serviceTypes.map(s => 
                  `<option value="${s.service_code}">${s.service_name}</option>`
                ).join('');
                sopCategory.innerHTML = '<option value="">è«‹é¸æ“‡</option>' + optionsHTML;
              }
              
              // å¡«å……FAQæŠ½å±œçš„ä¸‹æ‹‰æ¡†
              const faqCategoryDrawer = document.getElementById('faq-category-drawer');
              if (faqCategoryDrawer) {
                const optionsHTML = serviceTypes.map(s => 
                  `<option value="${s.service_code}">${s.service_name}</option>`
                ).join('');
                faqCategoryDrawer.innerHTML = '<option value="">è«‹é¸æ“‡æœå‹™é¡å‹...</option>' + optionsHTML;
              }
              
              // å¡«å……è³‡æºä¸Šå‚³çš„ä¸‹æ‹‰æ¡†
              const resourceCategoryModal = document.getElementById('resource-category-modal');
              if (resourceCategoryModal) {
                const optionsHTML = serviceTypes.map(s => 
                  `<option value="${s.service_code}">${s.service_name}</option>`
                ).join('');
                resourceCategoryModal.innerHTML = '<option value="">è«‹é¸æ“‡æœå‹™é¡å‹...</option>' + optionsHTML;
              }
              
              console.log('âœ… æœå‹™é¡å‹å·²è¼‰å…¥:', serviceTypes.length, 'å€‹');
            }
          } catch (err) {
            console.error('è¼‰å…¥æœå‹™é¡å‹å¤±æ•—:', err);
          }
        }

        // è¼‰å…¥å®¢æˆ¶åˆ—è¡¨
        async function loadClients() {
          try {
            const res = await fetch(`${apiBase}/clients`, { credentials: 'include' });
            if (!res.ok) return;
            const json = await res.json();
            
            if (json.ok && Array.isArray(json.data)) {
              const clients = json.data;
              
              // å¡«å……ç¯©é¸å™¨ä¸‹æ‹‰æ¡†
              const clientFilter = document.getElementById('client');
              if (clientFilter) {
                const optionsHTML = clients.map(c => 
                  `<option value="${c.clientId}">${c.companyName}</option>`
                ).join('');
                clientFilter.innerHTML = '<option value="all">å…¨éƒ¨å®¢æˆ¶</option>' + optionsHTML;
              }
              
              // å¡«å……SOPæŠ½å±œçš„ä¸‹æ‹‰æ¡†
              const sopClientDrawer = document.getElementById('sop-client-drawer');
              if (sopClientDrawer) {
                const optionsHTML = clients.map(c => 
                  `<option value="${c.clientId}">${c.companyName}</option>`
                ).join('');
                sopClientDrawer.innerHTML = '<option value="">ä¸æŒ‡å®šï¼ˆé€šç”¨ï¼‰</option>' + optionsHTML;
              }
              
              // å¡«å……FAQæŠ½å±œçš„ä¸‹æ‹‰æ¡†
              const faqClientDrawer = document.getElementById('faq-client-drawer');
              if (faqClientDrawer) {
                const optionsHTML = clients.map(c => 
                  `<option value="${c.clientId}">${c.companyName}</option>`
                ).join('');
                faqClientDrawer.innerHTML = '<option value="">ä¸æŒ‡å®šï¼ˆé€šç”¨ï¼‰</option>' + optionsHTML;
              }
              
              // å¡«å……è³‡æºä¸Šå‚³çš„ä¸‹æ‹‰æ¡†
              const resourceClientModal = document.getElementById('resource-client-modal');
              if (resourceClientModal) {
                const optionsHTML = clients.map(c => 
                  `<option value="${c.clientId}">${c.companyName}</option>`
                ).join('');
                resourceClientModal.innerHTML = '<option value="">ä¸æŒ‡å®šï¼ˆé€šç”¨ï¼‰</option>' + optionsHTML;
              }
              
              // è¨­ç½®å…¨å±€å®¢æˆ¶åˆ—è¡¨è®Šé‡ï¼Œä¾›é™„ä»¶é é¢ä½¿ç”¨
              window.allClients = clients;
              console.log('âœ… å®¢æˆ¶åˆ—è¡¨å·²è¼‰å…¥:', clients.length, 'å€‹');
              
              // é€šçŸ¥é™„ä»¶é é¢å®¢æˆ¶åˆ—è¡¨å·²å°±ç·’
              if (typeof window.populateAttachmentClientFilter === 'function') {
                window.populateAttachmentClientFilter();
              }
            }
          } catch (err) {
            console.error('è¼‰å…¥å®¢æˆ¶åˆ—è¡¨å¤±æ•—:', err);
          }
        }

        // éš±è—å·¥å…·æ¬„ç·¨è¼¯/åˆªé™¤æŒ‰éˆ•
        function hideToolbarButtons() {
          const editBtn = document.getElementById('btn-edit');
          const deleteBtn = document.getElementById('btn-delete');
          if (editBtn) editBtn.style.display = 'none';
          if (deleteBtn) deleteBtn.style.display = 'none';
        }
        
        // Tabåˆ‡æ¢
        // âš¡ Tab ç¼“å­˜æ ‡è®°ï¼ˆé¿å…é‡å¤åŠ è½½ï¼‰
        const tabLoaded = {
          sop: false,
          faq: false,
          resources: false
        };
        
        // âš¡ å¼ºåˆ¶åˆ·æ–°æŒ‡å®š tabï¼ˆç”¨äºåˆ›å»º/ç¼–è¾‘/åˆ é™¤åï¼‰
        function forceRefreshTab(tabName) {
          tabLoaded[tabName] = false;
          if (tabName === 'sop') loadSOPs();
          else if (tabName === 'faq') loadFAQs();
          else if (tabName === 'resources') loadResources();
          tabLoaded[tabName] = true;
        }
        
        function switchTab(tabName, forceRefresh = false) {
          // âš¡ å¦‚æœç‚¹å‡»å½“å‰å·²æ¿€æ´»çš„ tabï¼Œå¼ºåˆ¶åˆ·æ–°
          const isCurrentTab = currentTab === tabName;
          if (isCurrentTab && !forceRefresh) {
            console.log(`[Knowledge] ğŸ”„ ç‚¹å‡»å½“å‰ tabï¼Œå¼ºåˆ¶åˆ·æ–°`);
            forceRefresh = true;
          }
          
          currentTab = tabName;
          
          // éš±è—å·¥å…·æ¬„æŒ‰éˆ•
          hideToolbarButtons();
          
          // æ›´æ–°tabæŒ‰é’®çŠ¶æ€
          document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tabName);
          });
          
          // æ§åˆ¶ä¸»ç¯©é¸å™¨é¡¯ç¤ºï¼ˆé™„ä»¶æ¨™ç±¤éš±è—ï¼Œå…¶ä»–æ¨™ç±¤é¡¯ç¤ºï¼‰
          const mainFilters = document.getElementById('main-filters');
          if (mainFilters) {
            mainFilters.style.display = (tabName === 'attachments') ? 'none' : 'flex';
          }
          
          // æ›´æ–°å†…å®¹åŒºåŸŸ
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(`${tabName}-content`).classList.add('active');
          
          // âš¡ åŠ è½½æ•°æ®é€»è¾‘ï¼ˆæ”¯æŒå¼ºåˆ¶åˆ·æ–°ï¼‰
          if (tabName === 'sop') {
            if (!tabLoaded.sop || forceRefresh) {
              loadSOPs();
              tabLoaded.sop = true;
            } else {
              console.log(`[Knowledge] âš¡ ä½¿ç”¨ SOP ç¼“å­˜å†…å®¹`);
            }
          } else if (tabName === 'faq') {
            if (!tabLoaded.faq || forceRefresh) {
              loadFAQs();
              tabLoaded.faq = true;
            } else {
              console.log(`[Knowledge] âš¡ ä½¿ç”¨ FAQ ç¼“å­˜å†…å®¹`);
            }
          } else if (tabName === 'resources') {
            if (!tabLoaded.resources || forceRefresh) {
              loadResources();
              tabLoaded.resources = true;
            } else {
              console.log(`[Knowledge] âš¡ ä½¿ç”¨èµ„æºç¼“å­˜å†…å®¹`);
            }
          } else if (tabName === 'attachments') {
            // å¡«å……å®¢æˆ¶ä¸‹æ‹‰æ¡†ï¼ˆé¦–æ¬¡æˆ–å¼·åˆ¶åˆ·æ–°æ™‚ï¼‰
            if (!tabLoaded.attachments || forceRefresh) {
              populateAttachmentClientFilter();
              loadAttachments();
              tabLoaded.attachments = true;
            } else {
              console.log(`[Knowledge] âš¡ ä½¿ç”¨é™„ä»¶ç¼“å­˜å†…å®¹`);
            }
          }
        }

        // SOPç›¸å…³å‡½æ•°
        async function loadSOPs(){
          try {
            const sopsList = document.getElementById('sopsList');
            sopsList.innerHTML = '<div class="doc-card"><div class="doc-title">è¼‰å…¥ä¸­â€¦</div></div>';
            
            const params = buildParams(sopState);
            const res = await fetch(`${apiBase}/sop?${params}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/knowledge'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            
            const items = Array.isArray(json.data) ? json.data : [];
            sopState.total = (json.meta && json.meta.total) || items.length;
          sopsList.innerHTML = '';
            
            if (!items.length) {
              renderEmpty(sopsList, 'sop');
              document.getElementById('sopListInfo').textContent = '0 ç­†';
              return;
            }
            
            items.forEach(it => sopsList.appendChild(createSopCard(it)));
            updatePager('sop', sopState);
          } catch (_) {
            document.getElementById('sopsList').innerHTML = '<div class="doc-card"><div class="doc-title" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</div></div>';
          }
        }

        function createSopCard(item){
          const el = document.createElement('div');
          el.className = 'doc-card';
          el.style.padding = '8px 10px';
          el.style.fontSize = '13px';
          const v = `<span class="badge" style="margin-left:6px;background:#e7f0ff;color:#1d4ed8;padding:1px 4px;border-radius:4px;font-size:10px;">v${item.version||1}</span>`;
          const id = item.id || item.sop_id;
          
          el.innerHTML = `
            <div class="doc-title" style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.title||''} ${v}</div>
          `;
          
          // é»æ“Šå¡ç‰‡é è¦½
          el.addEventListener('click', () => viewSOP(id));
          
          return el;
        }

        // FAQç›¸å…³å‡½æ•°
        async function loadFAQs(){
          try {
            const faqsList = document.getElementById('faqsList');
            faqsList.innerHTML = '<div class="doc-card"><div class="doc-title">è¼‰å…¥ä¸­â€¦</div></div>';
            
            const params = buildParams(faqState);
            const res = await fetch(`${apiBase}/faq?${params}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/knowledge'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            
            const items = Array.isArray(json.data) ? json.data : [];
            faqState.total = (json.meta && json.meta.total) || items.length;
            faqsList.innerHTML = '';
            
            if (!items.length) {
              renderEmpty(faqsList, 'faq');
              document.getElementById('faqListInfo').textContent = '0 ç­†';
              return;
            }
            
            items.forEach(it => faqsList.appendChild(createFaqCard(it)));
            updatePager('faq', faqState);
          } catch (_) {
            document.getElementById('faqsList').innerHTML = '<div class="doc-card"><div class="doc-title" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</div></div>';
          }
        }

        function createFaqCard(item){
          const el = document.createElement('div');
          el.className = 'doc-card';
          el.style.padding = '8px 10px';
          const id = item.faq_id;
          
          el.innerHTML = `
            <div class="doc-title" style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">â“ ${item.question||''}</div>
          `;
          
          // é»æ“Šå¡ç‰‡é è¦½
          el.addEventListener('click', () => viewFAQ(id));
          
          return el;
        }

        // èµ„æºä¸­å¿ƒç›¸å…³å‡½æ•°
        async function loadResources(){
          try {
            const resourcesList = document.getElementById('resourcesList');
            if (!resourcesList) {
              console.error('[Resources] resourcesList å…ƒç´ ä¸å­˜åœ¨');
              return;
            }
            
            resourcesList.innerHTML = '<div class="doc-card"><div class="doc-title">è¼‰å…¥ä¸­â€¦</div></div>';
            
            const params = buildResourceParams(resourcesState);
            console.log('[Resources] è«‹æ±‚åƒæ•¸:', params);
            const res = await fetch(`${apiBase}/documents?${params}`, { 
              credentials: 'include',
              headers: { 'Accept': 'application/json' }
            });
            console.log('[Resources] å›æ‡‰ç‹€æ…‹:', res.status, res.statusText);
            
            if (res.status === 401) { 
              location.assign('/login?redirect=/internal/knowledge'); 
              return; 
            }
            
            let json;
            try {
              const text = await res.text();
              console.log('[Resources] åŸå§‹å›æ‡‰:', text.substring(0, 500));
              json = JSON.parse(text);
            } catch (parseErr) {
              console.error('[Resources] JSONè§£æå¤±æ•—:', parseErr);
              throw new Error('ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤');
            }
            
            console.log('[Resources] å›æ‡‰è³‡æ–™:', json);
            
            if (!json || json.ok !== true) {
              throw new Error(json?.error || json?.message || `HTTP ${res.status}: ${res.statusText}`);
            }
            
            const items = Array.isArray(json.data) ? json.data : [];
            resourcesState.total = (json.meta && json.meta.total) || items.length;
            resourcesList.innerHTML = '';
            
            if (!items.length) {
              renderEmpty(resourcesList, 'resources');
              const infoEl = document.getElementById('resourcesListInfo');
              if (infoEl) infoEl.textContent = '0 ç­†';
              return;
            }
            
            items.forEach(it => resourcesList.appendChild(createResourceCard(it)));
            updatePager('resources', resourcesState);
          } catch (err) {
            console.error('[Resources] è¼‰å…¥å¤±æ•—:', err);
            const resourcesList = document.getElementById('resourcesList');
            if (resourcesList) {
              resourcesList.innerHTML = `<div class="doc-card"><div class="doc-title" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</div><div class="doc-excerpt" style="font-size:11px;color:#666;">${err.message}</div></div>`;
            }
          }
        }

        function createResourceCard(item){
          const el = document.createElement('div');
          el.className = 'doc-card';
          el.style.cssText = 'padding:8px 10px;position:relative;';
          
          // æ–‡ä»¶é¡å‹åœ–æ¨™
          const fileName = item.fileName || item.title || '';
          let fileIcon = 'ğŸ“„';
          if (fileName.match(/\.(pdf)$/i)) fileIcon = 'ğŸ“•';
          else if (fileName.match(/\.(doc|docx)$/i)) fileIcon = 'ğŸ“˜';
          else if (fileName.match(/\.(xls|xlsx)$/i)) fileIcon = 'ğŸ“—';
          else if (fileName.match(/\.(ppt|pptx)$/i)) fileIcon = 'ğŸ“™';
          else if (fileName.match(/\.(jpg|jpeg|png|gif)$/i)) fileIcon = 'ğŸ–¼ï¸';
          
          // å»ºç«‹æ¨™ç±¤é¡¯ç¤º
          const badges = [];
          
          // å¹´æœˆæ¨™ç±¤
          if (item.docYear || item.docMonth) {
            const yearStr = item.docYear || '?';
            const monthStr = item.docMonth ? String(item.docMonth).padStart(2, '0') : '?';
            badges.push(`<span style="background:#e7f0ff;color:#1d4ed8;padding:1px 6px;border-radius:3px;font-size:10px;margin-right:4px;">ğŸ“… ${yearStr}-${monthStr}</span>`);
          }
          
          // æœå‹™é¡å‹æ¨™ç±¤
          if (item.category) {
            const categoryMap = {
              'ACCT': 'è¨˜å¸³',
              'TAX_BT': 'ç‡Ÿæ¥­ç¨…',
              'TAX_IT': 'æ‰€å¾—ç¨…',
              'PAYROLL': 'è–ªè³‡',
              'AUDIT': 'å¯©è¨ˆ',
              'CONSULT': 'è«®è©¢'
            };
            const categoryLabel = categoryMap[item.category] || item.category;
            badges.push(`<span style="background:#fef3c7;color:#92400e;padding:1px 6px;border-radius:3px;font-size:10px;margin-right:4px;">ğŸ·ï¸ ${categoryLabel}</span>`);
          }
          
          // ä»»å‹™é™„ä»¶æ¨™ç±¤
          if (item.taskId) {
            badges.push(`<span style="background:#dcfce7;color:#166534;padding:1px 6px;border-radius:3px;font-size:10px;margin-right:4px;">ğŸ“‹ ä»»å‹™é™„ä»¶</span>`);
          }
          
          const badgesHtml = badges.length > 0 ? `<div style="margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${badges.join('')}</div>` : '';
          
          el.innerHTML = `
            <div class="doc-title" style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
              <span style="margin-right:6px;">${fileIcon}</span>
              ${item.title || 'æœªå‘½åæ–‡æª”'}
            </div>
            ${badgesHtml}
          `;
          
          // é»æ“Šå¡ç‰‡é è¦½
          el.addEventListener('click', () => {
            previewDocument(item);
          });
          
          return el;
        }

        // æ–‡æª”é è¦½åŠŸèƒ½ï¼ˆåœ¨å³å´é è¦½å€åŸŸé¡¯ç¤ºï¼‰
        let currentPreviewBlobUrl = null;
        
        window.previewDocument = async function(doc) {
          const previewArea = document.getElementById('documentPreviewArea');
          if (!previewArea) return;
          
          // é¡¯ç¤ºå·¥å…·æ¬„çš„ç·¨è¼¯å’Œåˆªé™¤æŒ‰éˆ•
          const editBtn = document.getElementById('btn-edit');
          const deleteBtn = document.getElementById('btn-delete');
          if (editBtn) {
            editBtn.style.display = 'none'; // è³‡æºä¸­å¿ƒä¸éœ€è¦ç·¨è¼¯æŒ‰éˆ•
          }
          if (deleteBtn) {
            deleteBtn.style.display = 'block';
            deleteBtn.onclick = () => deleteDocument(doc.document_id);
          }
          
          // æ¸…ç†ä¹‹å‰çš„ blob URL
          if (currentPreviewBlobUrl) {
            URL.revokeObjectURL(currentPreviewBlobUrl);
            currentPreviewBlobUrl = null;
          }
          
          // é¡¯ç¤ºè¼‰å…¥ä¸­
          previewArea.innerHTML = `
            <div style="text-align:center;padding:60px 20px;color:#6b7280;">
              <div style="font-size:48px;margin-bottom:16px;">â³</div>
              <div>è¼‰å…¥ä¸­...</div>
            </div>
          `;
          
          try {
            // æ§‹å»ºæ–‡ä»¶URL
            const fileUrl = `${apiBase}/documents/${doc.document_id}/download`;
            
            // ç²å–æ–‡ä»¶
            const res = await fetch(fileUrl, { credentials: 'include' });
            if (!res.ok) {
              throw new Error('ç„¡æ³•è¼‰å…¥æ–‡ä»¶');
            }
            
            const blob = await res.blob();
            const blobUrl = URL.createObjectURL(blob);
            currentPreviewBlobUrl = blobUrl;
            
            // æ ¹æ“šæ–‡ä»¶é¡å‹é¡¯ç¤ºé è¦½
            const fileType = doc.fileType || '';
            const fileName = doc.fileName || '';
            
            // å»ºç«‹å…ƒæ•¸æ“šå¡ç‰‡
            const categoryMap = {
              'ACCT': 'è¨˜å¸³',
              'TAX_BT': 'ç‡Ÿæ¥­ç¨…',
              'TAX_IT': 'æ‰€å¾—ç¨…',
              'PAYROLL': 'è–ªè³‡',
              'AUDIT': 'å¯©è¨ˆ',
              'CONSULT': 'è«®è©¢'
            };
            const categoryLabel = doc.category ? (categoryMap[doc.category] || doc.category) : 'æœªåˆ†é¡';
            
            const scopeMap = {
              'service': 'ğŸ”· æœå‹™å±¤ç´š',
              'task': 'ğŸ“‹ ä»»å‹™å±¤ç´š'
            };
            const scopeLabel = doc.scope ? (scopeMap[doc.scope] || doc.scope) : 'æœªè¨­å®š';
            
            let metaItems = [];
            
            if (doc.category) {
              metaItems.push(`<div style="padding:6px 0;border-bottom:1px solid #f0f0f0;"><span style="color:#9ca3af;font-size:12px;">æœå‹™é¡å‹ï¼š</span><span style="color:#374151;font-size:12px;font-weight:500;">${categoryLabel}</span></div>`);
            }
            
            if (doc.scope) {
              metaItems.push(`<div style="padding:6px 0;border-bottom:1px solid #f0f0f0;"><span style="color:#9ca3af;font-size:12px;">é©ç”¨å±¤ç´šï¼š</span><span style="color:#374151;font-size:12px;font-weight:500;">${scopeLabel}</span></div>`);
            }
            
            if (doc.docYear || doc.docMonth) {
              const yearStr = doc.docYear || '?';
              const monthStr = doc.docMonth || '?';
              metaItems.push(`<div style="padding:6px 0;border-bottom:1px solid #f0f0f0;"><span style="color:#9ca3af;font-size:12px;">æ­¸æª”å¹´æœˆï¼š</span><span style="color:#374151;font-size:12px;font-weight:500;">${yearStr}å¹´${monthStr}æœˆ</span></div>`);
            }
            
            if (doc.taskId) {
              metaItems.push(`<div style="padding:6px 0;border-bottom:1px solid #f0f0f0;"><span style="color:#9ca3af;font-size:12px;">é—œè¯ä»»å‹™ï¼š</span><span style="color:#374151;font-size:12px;font-weight:500;">ä»»å‹™ #${doc.taskId}</span></div>`);
            }
            
            if (doc.description) {
              metaItems.push(`<div style="padding:6px 0;"><span style="color:#9ca3af;font-size:12px;">èªªæ˜ï¼š</span><span style="color:#6b7280;font-size:11px;line-height:1.5;">${doc.description}</span></div>`);
            }
            
            // âš¡ ç§»é™¤æ–‡æ¡£èµ„è®¯æ¡†ï¼Œè®©é¢„è§ˆåŒºåŸŸå æ»¡å…¨å±
            if (fileType.includes('pdf') || fileName.match(/\.pdf$/i)) {
              // PDFé è¦½ - å…¨å±æ˜¾ç¤ºï¼Œæ— æ¡†
              previewArea.innerHTML = `
                <iframe src="${blobUrl}#view=FitH" style="width:100%;height:90vh;border:none;background:white;"></iframe>
              `;
            } else if (fileType.includes('image') || fileName.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
              // åœ–ç‰‡é è¦½ - å…¨å±æ˜¾ç¤ºï¼Œæ— æ¡†
              previewArea.innerHTML = `
                <div style="width:100%;height:90vh;display:flex;align-items:center;justify-content:center;background:#f5f5f5;">
                  <img src="${blobUrl}" style="max-width:100%;max-height:100%;object-fit:contain;" />
                </div>
              `;
            } else {
              // å…¶ä»–æ–‡ä»¶é¡å‹ï¼Œé¡¯ç¤ºä¸‹è¼‰æç¤º
              previewArea.innerHTML = `
                <div style="text-align:center;padding:60px 20px;height:90vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f9fafb;">
                  <div style="font-size:64px;margin-bottom:20px;">ğŸ“„</div>
                  <h3 style="margin-bottom:12px;color:#374151;font-size:18px;">${doc.title}</h3>
                  <p style="color:#6b7280;margin-bottom:8px;font-size:13px;">${doc.fileName || ''}</p>
                  <p style="color:#9ca3af;margin-bottom:24px;font-size:13px;">æ­¤æ–‡ä»¶é¡å‹ä¸æ”¯æ´ç·šä¸Šé è¦½</p>
                  <a href="${blobUrl}" download="${doc.fileName || 'document'}" class="btn primary" style="text-decoration:none;">
                    <span>ğŸ’¾ ä¸‹è¼‰æ–‡ä»¶</span>
                  </a>
                </div>
              `;
            }
          } catch (err) {
            console.error('é è¦½æ–‡æª”å¤±æ•—:', err);
            previewArea.innerHTML = `
              <div style="text-align:center;padding:60px 20px;color:#c0392b;">
                <div style="font-size:48px;margin-bottom:16px;">âš ï¸</div>
                <div style="font-size:16px;font-weight:600;margin-bottom:8px;">è¼‰å…¥å¤±æ•—</div>
                <div style="font-size:13px;color:#6b7280;">${err.message}</div>
              </div>
            `;
          }
        };

        // é€šç”¨å‡½æ•°
        function renderEmpty(container, type){
          const messages = {
            sop: 'å°šç„¡ SOPï¼Œè«‹é»æ“Šå³ä¸Šè§’ã€Œ+ æ–°å¢ã€æŒ‰éˆ•å»ºç«‹',
            faq: 'å°šç„¡ FAQï¼Œè«‹é»æ“Šå³ä¸Šè§’ã€Œ+ æ–°å¢ã€æŒ‰éˆ•å»ºç«‹',
            resources: 'å°šç„¡æ–‡æª”ï¼Œè«‹é»æ“Šå³ä¸Šè§’ã€Œ+ æ–°å¢ã€æŒ‰éˆ•ä¸Šå‚³'
          };
          container.innerHTML = `<div class="doc-card"><div class="doc-title">æš«ç„¡è³‡æ–™</div><div class="doc-excerpt">${messages[type]}</div></div>`;
        }

        function updatePager(type, state){
          const listInfo = document.getElementById(`${type}ListInfo`);
          if(!listInfo) return;
          listInfo.textContent = `${state.total} ç­†`;
        }

        function buildParams(state){
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          
          const q = document.getElementById('q').value.trim();
          if (q) params.set('q', q);
          
          const cat = document.getElementById('category').value;
          if (cat && cat !== 'all') params.set('category', cat);
          
          const scope = document.getElementById('scope').value;
          if (scope) params.set('scope', scope);
          
          const client = document.getElementById('client').value;
          if (client && client !== 'all') params.set('client_id', client);
          
          const year = document.getElementById('year').value;
          if (year && year !== 'all') params.set('year', year);
          
          const month = document.getElementById('month').value;
          if (month && month !== 'all') params.set('month', month);
          
          const t = document.getElementById('tags').value.split(',').map(s=>s.trim()).filter(Boolean).join(',');
          if (t) params.set('tags', t);
          
          return params.toString();
        }
        
        function buildResourceParams(state){
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          
          if (state.q) params.set('q', state.q);
          if (state.category) params.set('category', state.category);
          
          return params.toString();
        }

        function getCategoryText(cat) {
          const map = {
            accounting: 'è¨˜å¸³æµç¨‹',
            tax: 'ç¨…å‹™æµç¨‹',
            business: 'å·¥å•†ç™»è¨˜',
            hr: 'äººäº‹ç®¡ç†',
            finance: 'è²¡å‹™ç®¡ç†',
            contract: 'åˆåŒç¯„æœ¬',
            internal: 'å…§éƒ¨æµç¨‹',
            other: 'å…¶ä»–'
          };
          return map[cat] || 'æœªåˆ†é¡';
        }

        // Modalå‡½æ•°
        // å·²æ£„ç”¨ï¼šæ”¹ç”¨å…§è¯è¡¨å–®
        window.closeSopModal = function() {
          document.getElementById('sopModal').classList.remove('show');
        };

        // å·²æ£„ç”¨ï¼šæ”¹ç”¨å…§è¯è¡¨å–®
        window.closeFaqModal = function() {
          document.getElementById('faqModal').classList.remove('show');
        };


        // é¢æ¿æ”¶åˆåŠŸèƒ½
        window.togglePanel = function(tab) {
          const layout = document.getElementById(`${tab}-layout`);
          if (layout) {
            layout.classList.toggle('collapsed');
          }
        };
        
        // æ¨¡æ…‹æ¡†æ§åˆ¶å‡½æ•¸æœƒåœ¨ selectedFile è²æ˜å¾Œå®šç¾©
        
        // SOP CRUD functionsï¼ˆç§»é™¤viewSOPï¼Œç›´æ¥ä½¿ç”¨editSOPï¼‰
        
        // é è¦½ SOPï¼ˆé»æ“Šåˆ—è¡¨æ™‚ï¼‰
        window.viewSOP = async function(id) {
          try {
            const res = await fetch(`${apiBase}/sop/${id}`, { credentials:'include' });
            const json = await res.json();
            if (json.ok && json.data) {
              const sop = json.data;
              const previewArea = document.getElementById('sopPreviewArea');
              if (!previewArea) return;
              
              // é¡¯ç¤ºå·¥å…·æ¬„çš„ç·¨è¼¯å’Œåˆªé™¤æŒ‰éˆ•
              const editBtn = document.getElementById('btn-edit');
              const deleteBtn = document.getElementById('btn-delete');
              if (editBtn) {
                editBtn.style.display = 'block';
                editBtn.onclick = () => editSOP(id);
              }
              if (deleteBtn) {
                deleteBtn.style.display = 'block';
                deleteBtn.onclick = () => deleteSOP(id);
              }
              
              previewArea.innerHTML = `
                <div style="padding:20px 24px;max-width:900px;margin:0 auto;">
                  <div style="margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e5e7eb;">
                    <h1 style="margin:0 0 8px 0;font-size:18px;font-weight:600;color:#1f2937;">${sop.title || 'æœªå‘½å'}</h1>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;font-size:12px;color:#6b7280;">
                      <span style="padding:2px 8px;background:#f3f4f6;border-radius:8px;font-size:11px;">${getCategoryName(sop.category, 'sop')}</span>
                      ${sop.tags && sop.tags.length ? 
                        (Array.isArray(sop.tags) ? sop.tags : sop.tags.split(',')).map(tag => 
                          `<span style="padding:2px 6px;background:#eff6ff;color:#2563eb;border-radius:6px;font-size:10px;">${tag.trim()}</span>`
                        ).join('') : ''
                      }
                    </div>
                  </div>
                  <div class="ql-editor" style="padding:0;font-size:14px;line-height:1.7;color:#374151;">
                    ${sop.content || '<p style="color:#9ca3af;">æš«ç„¡å…§å®¹</p>'}
                  </div>
                </div>
              `;
            }
          } catch (err) {
            console.error('è¼‰å…¥SOPå¤±æ•—:', err);
            const previewArea = document.getElementById('sopPreviewArea');
            if (previewArea) {
              previewArea.innerHTML = `
                <div class="resource-preview-empty">
                  <div style="font-size:48px;margin-bottom:16px;color:#c0392b;">âš ï¸</div>
                  <p class="empty-text" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</p>
                  <p class="empty-hint">${err.message}</p>
                </div>
              `;
            }
          }
        };
        
        // ç·¨è¼¯ SOPï¼ˆæ‰“é–‹æŠ½å±œï¼‰
        window.editSOP = async function(id) {
          try {
            const res = await fetch(`${apiBase}/sop/${id}`, { credentials:'include' });
            const json = await res.json();
            if (json.ok && json.data) {
              openSopDrawer(json.data);
            }
          } catch (err) {
            alert('è¼‰å…¥SOPå¤±æ•—');
          }
        };
        
        window.deleteSOP = async function(id) {
          if(!confirm('ç¢ºå®šåˆªé™¤æ­¤SOPï¼Ÿ')) return;
          try {
            const res = await fetch(`${apiBase}/sop/${id}`, { 
              method: 'DELETE',
              credentials:'include'
            });
            const json = await res.json();
            if (json.ok) {
              alert('åˆªé™¤æˆåŠŸ');
              forceRefreshTab('sop');
            } else {
              alert('åˆªé™¤å¤±æ•—ï¼š' + (json.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
          } catch (err) {
            alert('åˆªé™¤å¤±æ•—');
          }
        };
        
        // FAQ CRUD functions
        window.viewFAQ = async function(id) {
          try {
            const res = await fetch(`${apiBase}/faq/${id}`, { credentials:'include' });
            const json = await res.json();
            if (json.ok && json.data) {
              const faq = json.data;
              
              // å¡«å……è¡¨å–®ç‚ºåªè®€æ¨¡å¼
              document.getElementById('faq-id-inline').value = faq.faq_id;
              document.getElementById('faq-question-inline').value = faq.question || '';
              document.getElementById('faq-category-inline').value = faq.category || '';
              document.getElementById('faq-tags-inline').value = Array.isArray(faq.tags) ? faq.tags.join(', ') : '';
              
              // è¨­ç½®ç·¨è¼¯å™¨å…§å®¹ä¸¦ç¦ç”¨
              if (faqEditor) {
                faqEditor.root.innerHTML = faq.answer || '<p>ç„¡ç­”æ¡ˆ</p>';
                faqEditor.enable(false);  // è¨­ç‚ºåªè®€
              }
              
              // ç¦ç”¨è¼¸å…¥æ¬„ä½
              document.getElementById('faq-question-inline').disabled = true;
              document.getElementById('faq-category-inline').disabled = true;
              document.getElementById('faq-tags-inline').disabled = true;
              
              // éš±è—æäº¤æŒ‰éˆ•ï¼Œé¡¯ç¤ºç·¨è¼¯æŒ‰éˆ•
              const submitBtn = document.getElementById('faqSubmitBtnInline');
              submitBtn.style.display = 'none';
              
              // æ·»åŠ ç·¨è¼¯å’Œè¿”å›æŒ‰éˆ•
              let actionDiv = document.getElementById('faq-view-actions');
              if (!actionDiv) {
                actionDiv = document.createElement('div');
                actionDiv.id = 'faq-view-actions';
                actionDiv.style.display = 'flex';
                actionDiv.style.gap = '8px';
                actionDiv.innerHTML = `
                  <button type="button" class="btn btn-primary" onclick="editFAQ(${faq.faq_id})">
                    <span>âœï¸ ç·¨è¼¯</span>
                  </button>
                  <button type="button" class="btn" onclick="resetFaqForm()">
                    <span>â†©ï¸ è¿”å›æ–°å¢</span>
                  </button>
                `;
                submitBtn.parentNode.insertBefore(actionDiv, submitBtn);
              } else {
                actionDiv.style.display = 'flex';
                actionDiv.innerHTML = `
                  <button type="button" class="btn btn-primary" onclick="editFAQ(${faq.faq_id})">
                    <span>âœï¸ ç·¨è¼¯</span>
                  </button>
                  <button type="button" class="btn" onclick="resetFaqForm()">
                    <span>â†©ï¸ è¿”å›æ–°å¢</span>
                  </button>
                `;
              }
              
              // èšç„¦åˆ°å•é¡Œæ¬„ä½ï¼ˆé›–ç„¶ç¦ç”¨ï¼Œä½†å¯ä»¥çœ‹åˆ°å…§å®¹ï¼‰
              document.getElementById('faq-question-inline').focus();
            } else {
              alert('è¼‰å…¥å¤±æ•—ï¼š' + (json.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
          } catch (err) {
            alert('è¼‰å…¥FAQå¤±æ•—ï¼šæœªçŸ¥éŒ¯èª¤');
          }
        };
        
        // é è¦½ FAQï¼ˆé»æ“Šåˆ—è¡¨æ™‚ï¼‰
        window.viewFAQ = async function(id) {
          try {
            const res = await fetch(`${apiBase}/faq/${id}`, { credentials:'include' });
            const json = await res.json();
            if (json.ok && json.data) {
              const faq = json.data;
              const previewArea = document.getElementById('faqPreviewArea');
              if (!previewArea) return;
              
              // é¡¯ç¤ºå·¥å…·æ¬„çš„ç·¨è¼¯å’Œåˆªé™¤æŒ‰éˆ•
              const editBtn = document.getElementById('btn-edit');
              const deleteBtn = document.getElementById('btn-delete');
              if (editBtn) {
                editBtn.style.display = 'block';
                editBtn.onclick = () => editFAQ(id);
              }
              if (deleteBtn) {
                deleteBtn.style.display = 'block';
                deleteBtn.onclick = () => deleteFAQ(id);
              }
              
              previewArea.innerHTML = `
                <div style="padding:20px 24px;max-width:900px;margin:0 auto;">
                  <div style="margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e5e7eb;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
                      <span style="font-size:20px;line-height:1;">â“</span>
                      <h1 style="margin:0;font-size:18px;font-weight:600;color:#1f2937;flex:1;">${faq.question || 'æœªå‘½åå•é¡Œ'}</h1>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;font-size:12px;color:#6b7280;margin-left:30px;">
                      <span style="padding:2px 8px;background:#f3f4f6;border-radius:8px;font-size:11px;">${getCategoryName(faq.category, 'faq')}</span>
                      ${faq.tags && faq.tags.length ? 
                        (Array.isArray(faq.tags) ? faq.tags : faq.tags.split(',')).map(tag => 
                          `<span style="padding:2px 6px;background:#fef3c7;color:#d97706;border-radius:6px;font-size:10px;">${tag.trim()}</span>`
                        ).join('') : ''
                      }
                    </div>
                  </div>
                  <div style="margin-left:30px;">
                    <h3 style="margin:0 0 10px 0;font-size:14px;font-weight:600;color:#059669;">ğŸ’¡ å›ç­”</h3>
                    <div class="ql-editor" style="padding:0;font-size:14px;line-height:1.7;color:#374151;">
                      ${faq.answer || '<p style="color:#9ca3af;">æš«ç„¡å›ç­”</p>'}
                    </div>
                  </div>
                </div>
              `;
            }
          } catch (err) {
            console.error('è¼‰å…¥FAQå¤±æ•—:', err);
            const previewArea = document.getElementById('faqPreviewArea');
            if (previewArea) {
              previewArea.innerHTML = `
                <div class="resource-preview-empty">
                  <div style="font-size:48px;margin-bottom:16px;color:#c0392b;">âš ï¸</div>
                  <p class="empty-text" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</p>
                  <p class="empty-hint">${err.message}</p>
                </div>
              `;
            }
          }
        };
        
        // ç·¨è¼¯ FAQï¼ˆæ‰“é–‹æŠ½å±œï¼‰
        window.editFAQ = async function(id) {
          try {
            const res = await fetch(`${apiBase}/faq/${id}`, { credentials:'include' });
            const json = await res.json();
            if (json.ok && json.data) {
              openFaqDrawer(json.data);
            }
          } catch (err) {
            alert('è¼‰å…¥FAQå¤±æ•—');
          }
        };
        
        window.deleteFAQ = async function(id) {
          if(!confirm('ç¢ºå®šåˆªé™¤æ­¤FAQï¼Ÿ')) return;
          try {
            const res = await fetch(`${apiBase}/faq/${id}`, { 
              method: 'DELETE',
              credentials:'include'
            });
            const json = await res.json();
            if (json.ok) {
              alert('åˆªé™¤æˆåŠŸ');
              forceRefreshTab('faq');
            } else {
              alert('åˆªé™¤å¤±æ•—ï¼š' + (json.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
          } catch (err) {
            alert('åˆªé™¤å¤±æ•—');
          }
        };
        
        // Resource CRUD functions
        window.deleteResource = async function(id) {
          if(!confirm('ç¢ºå®šåˆªé™¤æ­¤æ–‡æª”ï¼Ÿåˆªé™¤å¾Œå°‡ç„¡æ³•æ¢å¾©ã€‚')) return;
          try {
            const res = await fetch(`${apiBase}/documents/${id}`, { 
              method: 'DELETE',
              credentials:'include'
            });
            const json = await res.json();
            if (json.ok) {
              alert('åˆªé™¤æˆåŠŸ');
              
              // æ¸…ç©ºé è¦½å€åŸŸ
              const previewArea = document.getElementById('documentPreviewArea');
              if (previewArea) {
                previewArea.innerHTML = `
                  <div class="resource-preview-empty">
                    <div class="empty-icon">ğŸ“‚</div>
                    <p class="empty-text">é»æ“Šå·¦å´æ–‡æª”æŸ¥çœ‹è©³æƒ…</p>
                    <p class="empty-hint">æ”¯æ´ç·šä¸Šé è¦½ PDFã€åœ–ç‰‡ç­‰æ ¼å¼</p>
                  </div>
                `;
              }
              
              // æ¸…ç† blob URL
              if (currentPreviewBlobUrl) {
                URL.revokeObjectURL(currentPreviewBlobUrl);
                currentPreviewBlobUrl = null;
              }
              
              // é‡æ–°è¼‰å…¥åˆ—è¡¨
              loadResources();
            } else {
              alert('åˆªé™¤å¤±æ•—ï¼š' + (json.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
          } catch (err) {
            alert('åˆªé™¤å¤±æ•—');
          }
        };
        
        // deleteDocument åˆ¥åï¼ˆç”¨æ–¼é è¦½é é¢ï¼‰
        window.deleteDocument = window.deleteResource;

        // äº‹ä»¶ç»‘å®š
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });

        document.getElementById('btn-new').addEventListener('click', () => {
          if (currentTab === 'sop') {
            // æ‰“é–‹ SOP ç·¨è¼¯æŠ½å±œï¼ˆæ–°å¢æ¨¡å¼ï¼‰
            openSopDrawer(null);
          } else if (currentTab === 'faq') {
            // æ‰“é–‹ FAQ ç·¨è¼¯æŠ½å±œï¼ˆæ–°å¢æ¨¡å¼ï¼‰
            openFaqDrawer(null);
          } else if (currentTab === 'resources') {
            // æ‰“é–‹ä¸Šå‚³æŠ½å±œ
            openUploadDocModal();
          }
        });

        // æœç´¢å’Œç­›é€‰
        let timer=null;
        document.getElementById('q').addEventListener('input', ()=>{ 
          clearTimeout(timer); 
          timer=setTimeout(()=>{ 
            sopState.page=1; 
            faqState.page=1; 
            resourcesState.page=1; 
            if (currentTab === 'sop') loadSOPs();
            else if (currentTab === 'faq') loadFAQs();
            else if (currentTab === 'resources') loadResources();
          }, 300); 
        });
        
        document.getElementById('category').addEventListener('change', ()=>{ 
          sopState.page=1; 
          faqState.page=1; 
          resourcesState.page=1; 
          if (currentTab === 'sop') loadSOPs();
          else if (currentTab === 'faq') loadFAQs();
          else if (currentTab === 'resources') loadResources();
        });
        
        document.getElementById('scope').addEventListener('change', ()=>{ 
          sopState.page=1; 
          faqState.page=1; 
          if (currentTab === 'sop') loadSOPs();
          else if (currentTab === 'faq') loadFAQs();
        });
        
        document.getElementById('tags').addEventListener('change', ()=>{ 
          sopState.page=1; 
          faqState.page=1; 
          resourcesState.page=1; 
          if (currentTab === 'sop') loadSOPs();
          else if (currentTab === 'faq') loadFAQs();
          else if (currentTab === 'resources') loadResources();
        });
        
        document.getElementById('client').addEventListener('change', ()=>{ 
          sopState.page=1; 
          faqState.page=1; 
          resourcesState.page=1; 
          if (currentTab === 'sop') loadSOPs();
          else if (currentTab === 'faq') loadFAQs();
          else if (currentTab === 'resources') loadResources();
        });
        
        document.getElementById('year').addEventListener('change', ()=>{ 
          resourcesState.page=1; 
          if (currentTab === 'resources') loadResources();
        });
        
        document.getElementById('month').addEventListener('change', ()=>{ 
          resourcesState.page=1; 
          if (currentTab === 'resources') loadResources();
        });

        // åˆ†é¡µæŒ‰é’®
        document.getElementById('sop-prev').addEventListener('click', ()=>{ if (sopState.page>1){ sopState.page--; loadSOPs(); } });
        document.getElementById('sop-next').addEventListener('click', ()=>{ sopState.page++; loadSOPs(); });
        document.getElementById('faq-prev').addEventListener('click', ()=>{ if (faqState.page>1){ faqState.page--; loadFAQs(); } });
        document.getElementById('faq-next').addEventListener('click', ()=>{ faqState.page++; loadFAQs(); });
        document.getElementById('resources-prev').addEventListener('click', ()=>{ if (resourcesState.page>1){ resourcesState.page--; loadResources(); } });
        document.getElementById('resources-next').addEventListener('click', ()=>{ resourcesState.page++; loadResources(); });

        // è³‡æºæœç´¢å’Œç¯©é¸
        let resourcesSearchTimer = null;
        const resourcesSearchEl = document.getElementById('resources-search');
        const resourcesCategoryFilterEl = document.getElementById('resources-category-filter');
        
        if (resourcesSearchEl) {
          resourcesSearchEl.addEventListener('input', (e) => {
            clearTimeout(resourcesSearchTimer);
            resourcesSearchTimer = setTimeout(() => {
              resourcesState.q = e.target.value.trim();
              resourcesState.page = 1;
              loadResources();
            }, 300);
          });
        }
        
        if (resourcesCategoryFilterEl) {
          resourcesCategoryFilterEl.addEventListener('change', (e) => {
            resourcesState.category = e.target.value;
            resourcesState.page = 1;
            loadResources();
          });
        }

        // æ–‡ä»¶ä¸Šä¼  - selectedFile å¿…é ˆåœ¨é€™è£¡è²æ˜
        let selectedFile = null;
        const fileUploadAreaModal = document.getElementById('fileUploadAreaModal');
        const fileInputModal = document.getElementById('file-input-modal');

        // æ¨¡æ…‹æ¡†æ§åˆ¶å‡½æ•¸ï¼ˆç¾åœ¨å¯ä»¥å®‰å…¨è¨ªå• selectedFileï¼‰
        window.resetUploadForm = function() {
          const form = document.getElementById('resourceFormModal');
          if (form) form.reset();
          selectedFile = null;
          const info = document.getElementById('uploadedFileInfoModal');
          if (info) info.style.display = 'none';
        };
        
        window.closeUploadDocModal = function() {
          const drawer = document.getElementById('uploadDocModal');
          const overlay = document.getElementById('drawerOverlay');
          if (drawer) drawer.classList.remove('show');
          if (overlay) overlay.classList.remove('show');
          setTimeout(() => resetUploadForm(), 300);
        };
        
        // æ¨™ç±¤åº«ï¼ˆå¯æ“´å±•ï¼‰
        let availableTags = [
          'é‡è¦', 'ç¯„æœ¬', 'åƒè€ƒ', 'å…§éƒ¨', 'å®¢æˆ¶',
          'è²¡å‹™', 'ç¨…å‹™', 'äººäº‹', 'åˆåŒ', 'æ³•è¦',
          'å¸¸è¦‹', 'ç·Šæ€¥', 'æœˆçµ', 'å ±ç¨…', 'è¨˜å¸³'
        ];
        
        // å¾ localStorage è¼‰å…¥è‡ªè¨‚æ¨™ç±¤
        function loadCustomTags() {
          const saved = localStorage.getItem('customTags');
          if (saved) {
            try {
              const customTags = JSON.parse(saved);
              // åˆä½µä¸¦å»é‡
              availableTags = [...new Set([...availableTags, ...customTags])];
            } catch (e) {
              console.error('è¼‰å…¥è‡ªè¨‚æ¨™ç±¤å¤±æ•—:', e);
            }
          }
          availableTags.sort(); // æ’åº
        }
        
        // è¼‰å…¥æ¨™ç±¤æŒ‰éˆ•ï¼ˆæŒ‰éˆ•å¼æ¨™ç±¤é¸æ“‡å™¨ï¼‰
        function loadTagCheckboxes(containerId, selectedTags = []) {
          const container = document.getElementById(containerId);
          if (!container) return;
          
          container.innerHTML = '';
          availableTags.forEach(tag => {
            const button = document.createElement('button');
            button.type = 'button';
            button.textContent = tag;
            button.dataset.tag = tag;
            
            const isSelected = selectedTags.includes(tag);
            button.className = isSelected ? 'tag-btn selected' : 'tag-btn';
            
            // é»æ“Šåˆ‡æ›é¸ä¸­ç‹€æ…‹
            button.onclick = function(e) {
              e.preventDefault();
              e.stopPropagation();
              this.classList.toggle('selected');
            };
            
            container.appendChild(button);
          });
        }
        
        // è¼‰å…¥ç¯©é¸ä¸‹æ‹‰é¸å–®çš„æ¨™ç±¤é¸é …
        function loadFilterTagOptions() {
          const select = document.getElementById('tags');
          if (!select) return;
          
          // ä¿ç•™ç¬¬ä¸€å€‹ã€Œå…¨éƒ¨æ¨™ç±¤ã€é¸é …
          const currentValue = select.value;
          select.innerHTML = '<option value="">å…¨éƒ¨æ¨™ç±¤</option>';
          
          availableTags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            option.textContent = tag;
            select.appendChild(option);
          });
          
          select.value = currentValue;
        }
        
        // æ–°å¢æ¨™ç±¤
        window.addNewTag = function(type) {
          const newTag = prompt('è«‹è¼¸å…¥æ–°æ¨™ç±¤åç¨±ï¼š');
          if (!newTag || !newTag.trim()) return;
          
          const tagName = newTag.trim();
          
          // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
          if (availableTags.includes(tagName)) {
            alert('æ­¤æ¨™ç±¤å·²å­˜åœ¨ï¼');
            return;
          }
          
          // æ·»åŠ åˆ°æ¨™ç±¤åº«
          availableTags.push(tagName);
          availableTags.sort();
          
          // ä¿å­˜åˆ° localStorage
          localStorage.setItem('customTags', JSON.stringify(availableTags));
          
          // é‡æ–°è¼‰å…¥å°æ‡‰çš„è¤‡é¸æ¡†ï¼Œä¸¦è‡ªå‹•é¸ä¸­æ–°æ¨™ç±¤
          if (type === 'resource') {
            loadTagCheckboxes('resource-tags-checkboxes', [tagName]);
          } else if (type === 'sop') {
            const currentChecked = getCheckedTags('sop-tags-checkboxes');
            loadTagCheckboxes('sop-tags-checkboxes', [...currentChecked, tagName]);
          } else if (type === 'faq') {
            const currentChecked = getCheckedTags('faq-tags-checkboxes');
            loadTagCheckboxes('faq-tags-checkboxes', [...currentChecked, tagName]);
          }
          
          // æ›´æ–°ç¯©é¸ä¸‹æ‹‰é¸å–®
          loadFilterTagOptions();
        };
        
        // æ‰“é–‹æ¨™ç±¤ç®¡ç†å™¨
        window.openTagManager = function() {
          const modal = document.getElementById('tagManagerModal');
          if (!modal) return;
          
          modal.style.display = 'flex';
          renderTagManagerList();
        };
        
        // é—œé–‰æ¨™ç±¤ç®¡ç†å™¨
        window.closeTagManager = function() {
          const modal = document.getElementById('tagManagerModal');
          if (modal) modal.style.display = 'none';
        };
        
        // æ¸²æŸ“æ¨™ç±¤ç®¡ç†åˆ—è¡¨
        function renderTagManagerList() {
          const list = document.getElementById('tagManagerList');
          const countSpan = document.getElementById('tagCount');
          
          if (!list) return;
          
          countSpan.textContent = availableTags.length;
          
          if (availableTags.length === 0) {
            list.innerHTML = `
              <div style="text-align:center;padding:40px;color:#9ca3af;">
                <div style="font-size:48px;margin-bottom:16px;">ğŸ·ï¸</div>
                <div style="font-size:14px;">å°šç„¡æ¨™ç±¤</div>
                <div style="font-size:12px;margin-top:8px;">é»æ“Šã€Œâ• æ–°å¢ã€æŒ‰éˆ•æ·»åŠ ç¬¬ä¸€å€‹æ¨™ç±¤</div>
              </div>
            `;
            return;
          }
          
          list.innerHTML = availableTags.map(tag => `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;transition:all 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#f9fafb'">
              <div style="display:flex;align-items:center;gap:12px;flex:1;">
                <span style="font-size:20px;">ğŸ·ï¸</span>
                <span style="font-weight:500;font-size:14px;color:#1f2937;">${tag}</span>
              </div>
              <div style="display:flex;gap:8px;">
                <button onclick="editTag('${tag.replace(/'/g, "\\'")}'); event.stopPropagation();" class="btn" style="padding:6px 12px;font-size:12px;background:white;color:#2563eb;border:1px solid #bfdbfe;" title="ç·¨è¼¯æ¨™ç±¤">
                  âœï¸ ç·¨è¼¯
                </button>
                <button onclick="deleteTag('${tag.replace(/'/g, "\\'")}'); event.stopPropagation();" class="btn" style="padding:6px 12px;font-size:12px;background:white;color:#dc2626;border:1px solid #fca5a5;" title="åˆªé™¤æ¨™ç±¤">
                  ğŸ—‘ï¸ åˆªé™¤
                </button>
              </div>
            </div>
          `).join('');
        }
        
        // ç·¨è¼¯æ¨™ç±¤
        window.editTag = function(oldTag) {
          const newTag = prompt('è«‹è¼¸å…¥æ–°çš„æ¨™ç±¤åç¨±ï¼š', oldTag);
          if (!newTag || !newTag.trim()) return;
          
          const tagName = newTag.trim();
          
          // æª¢æŸ¥æ˜¯å¦èˆ‡å…¶ä»–æ¨™ç±¤é‡è¤‡
          if (tagName !== oldTag && availableTags.includes(tagName)) {
            alert('æ­¤æ¨™ç±¤åç¨±å·²å­˜åœ¨ï¼');
            return;
          }
          
          // æ›´æ–°æ¨™ç±¤
          const index = availableTags.indexOf(oldTag);
          if (index !== -1) {
            availableTags[index] = tagName;
            availableTags.sort();
            
            // ä¿å­˜åˆ° localStorage
            localStorage.setItem('customTags', JSON.stringify(availableTags));
            
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            renderTagManagerList();
            
            // æ›´æ–°ç¯©é¸ä¸‹æ‹‰é¸å–®
            loadFilterTagOptions();
            
            // é‡æ–°è¼‰å…¥ç•¶å‰æ‰“é–‹çš„æ¨™ç±¤è¤‡é¸æ¡†ï¼ˆå¦‚æœæœ‰ï¼‰
            refreshAllTagCheckboxes();
            
            alert('æ¨™ç±¤å·²æ›´æ–°ï¼');
          }
        };
        
        // åˆªé™¤æ¨™ç±¤
        window.deleteTag = function(tag) {
          if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ¨™ç±¤ã€Œ${tag}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œä¸æœƒå½±éŸ¿å·²å­˜åœ¨çš„SOP/FAQã€‚`)) {
            return;
          }
          
          // å¾æ¨™ç±¤åº«ä¸­ç§»é™¤
          const index = availableTags.indexOf(tag);
          if (index !== -1) {
            availableTags.splice(index, 1);
            
            // ä¿å­˜åˆ° localStorage
            localStorage.setItem('customTags', JSON.stringify(availableTags));
            
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            renderTagManagerList();
            
            // æ›´æ–°ç¯©é¸ä¸‹æ‹‰é¸å–®
            loadFilterTagOptions();
            
            // é‡æ–°è¼‰å…¥ç•¶å‰æ‰“é–‹çš„æ¨™ç±¤è¤‡é¸æ¡†ï¼ˆå¦‚æœæœ‰ï¼‰
            refreshAllTagCheckboxes();
            
            alert('æ¨™ç±¤å·²åˆªé™¤ï¼');
          }
        };
        
        // åˆ·æ–°æ‰€æœ‰æ¨™ç±¤è¤‡é¸æ¡†
        function refreshAllTagCheckboxes() {
          // SOPæŠ½å±œ
          const sopContainer = document.getElementById('sop-tags-checkboxes');
          if (sopContainer && sopContainer.children.length > 0) {
            const currentChecked = getCheckedTags('sop-tags-checkboxes');
            loadTagCheckboxes('sop-tags-checkboxes', currentChecked);
          }
          
          // FAQæŠ½å±œ
          const faqContainer = document.getElementById('faq-tags-checkboxes');
          if (faqContainer && faqContainer.children.length > 0) {
            const currentChecked = getCheckedTags('faq-tags-checkboxes');
            loadTagCheckboxes('faq-tags-checkboxes', currentChecked);
          }
          
          // è³‡æºä¸Šå‚³
          const resourceContainer = document.getElementById('resource-tags-checkboxes');
          if (resourceContainer && resourceContainer.children.length > 0) {
            const currentChecked = getCheckedTags('resource-tags-checkboxes');
            loadTagCheckboxes('resource-tags-checkboxes', currentChecked);
          }
        }
        
        // ç²å–å·²é¸ä¸­çš„æ¨™ç±¤
        function getCheckedTags(containerId) {
          const container = document.getElementById(containerId);
          if (!container) return [];
          
          const selectedButtons = container.querySelectorAll('.tag-btn.selected');
          return Array.from(selectedButtons).map(btn => btn.dataset.tag);
        }
        
        window.openUploadDocModal = function() {
          const drawer = document.getElementById('uploadDocModal');
          const overlay = document.getElementById('drawerOverlay');
          if (drawer) drawer.classList.add('show');
          if (overlay) overlay.classList.add('show');
          
          // è¼‰å…¥æ¨™ç±¤é¸é …
          loadCustomTags();
          loadTagCheckboxes('resource-tags-checkboxes');
        };
        
        // SOP å›ºå®šæ¨¡æ¿
        const SOP_TEMPLATE = `
          <h2>ğŸ“‹ ä½œæ¥­ç›®çš„</h2>
          <p>èªªæ˜æ­¤æµç¨‹çš„ç›®æ¨™èˆ‡é‡è¦æ€§...</p>
          
          <h2>ğŸ‘¥ é©ç”¨å°è±¡</h2>
          <p>æ­¤æµç¨‹é©ç”¨æ–¼ï¼šæœƒè¨ˆéƒ¨é–€å…¨é«”åŒä» / ç‰¹å®šè·ä½...</p>
          
          <h2>ğŸ“ ä½œæ¥­æµç¨‹</h2>
          <h3>æ­¥é©Ÿä¸€ï¼šæº–å‚™éšæ®µ</h3>
          <ul>
            <li>æª¢æŸ¥æ‰€éœ€æ–‡ä»¶æ˜¯å¦é½Šå…¨</li>
            <li>ç¢ºèªç³»çµ±æ¬Šé™èˆ‡å·¥å…·</li>
            <li>é ä¼°æ‰€éœ€æ™‚é–“ï¼šç´„ XX åˆ†é˜</li>
          </ul>
          
          <h3>æ­¥é©ŸäºŒï¼šåŸ·è¡Œéšæ®µ</h3>
          <ol>
            <li>ç™»å…¥ç³»çµ±ä¸¦é¸æ“‡å°æ‡‰åŠŸèƒ½</li>
            <li>ä¾åºå¡«å¯«å¿…å¡«æ¬„ä½</li>
            <li>æª¢æŸ¥è³‡æ–™æ­£ç¢ºæ€§</li>
            <li>æäº¤ä¸¦ä¿å­˜è¨˜éŒ„</li>
          </ol>
          
          <h3>æ­¥é©Ÿä¸‰ï¼šç¢ºèªéšæ®µ</h3>
          <ul>
            <li>æ ¸å°çµæœæ˜¯å¦ç¬¦åˆé æœŸ</li>
            <li>é€šçŸ¥ç›¸é—œäººå“¡</li>
            <li>æ­¸æª”ç›¸é—œæ–‡ä»¶</li>
          </ul>
          
          <h2>âš ï¸ æ³¨æ„äº‹é …</h2>
          <ul>
            <li><strong>é‡è¦ï¼š</strong>å‹™å¿…åœ¨æ¯æœˆ X æ—¥å‰å®Œæˆ</li>
            <li>è‹¥é‡åˆ°éŒ¯èª¤ï¼Œè«‹è¯ç¹« XXXï¼ˆåˆ†æ©Ÿ XXXï¼‰</li>
            <li>ç›¸é—œè¡¨å–®å­˜æ”¾ä½ç½®ï¼šå…±äº«è³‡æ–™å¤¾ / XXX è·¯å¾‘</li>
          </ul>
          
          <h2>ğŸ“ ç›¸é—œè¯çµ¡äºº</h2>
          <p>è² è²¬äººï¼šXXXï¼ˆåˆ†æ©Ÿ XXXï¼‰<br>è¦†æ ¸äººï¼šXXXï¼ˆåˆ†æ©Ÿ XXXï¼‰</p>
          
          <h2>ğŸ“ ç›¸é—œæ–‡ä»¶</h2>
          <ul>
            <li>è¡¨å–®ç¯„æœ¬é€£çµ</li>
            <li>ç³»çµ±æ“ä½œæ‰‹å†Šé€£çµ</li>
          </ul>
        `.trim();
        
        // SOP æŠ½å±œæ§åˆ¶
        window.openSopDrawer = function(sopData = null) {
          const drawer = document.getElementById('sopEditDrawer');
          const overlay = document.getElementById('drawerOverlay');
          if (!drawer || !overlay) return;
          
          // å¦‚æœæ˜¯æ–°å¢æ¨¡å¼ï¼ˆsopData ç‚º nullï¼‰ï¼Œä½¿ç”¨æ¨¡æ¿
          if (!sopData) {
            document.getElementById('sop-id-drawer').value = '';
            document.getElementById('sop-title-drawer').value = 'ã€è«‹å¡«å¯«æ¨™é¡Œã€‘ä¾‹å¦‚ï¼šæœˆåº¦è¨˜å¸³æµç¨‹';
            document.getElementById('sop-category-drawer').value = '';
            document.getElementById('sop-client-drawer').value = '';
            document.getElementById('sop-scope-drawer').value = ''; // å¿…é ˆæ‰‹å‹•é¸æ“‡
            
            if (window.sopDrawerEditor) {
              window.sopDrawerEditor.root.innerHTML = SOP_TEMPLATE;
            }
            
            // è¼‰å…¥æ¨™ç±¤è¤‡é¸æ¡†ï¼ˆæ–°å¢æ™‚ä¸é¸ä¸­ä»»ä½•æ¨™ç±¤ï¼‰
            loadCustomTags();
            loadTagCheckboxes('sop-tags-checkboxes', []);
          } else {
            // ç·¨è¼¯æ¨¡å¼ï¼šå¡«å……ç¾æœ‰æ•¸æ“š
            document.getElementById('sop-id-drawer').value = sopData.sop_id || '';
            document.getElementById('sop-title-drawer').value = sopData.title || '';
            document.getElementById('sop-category-drawer').value = sopData.category || '';
            document.getElementById('sop-client-drawer').value = sopData.clientId || sopData.client_id || '';
            document.getElementById('sop-scope-drawer').value = sopData.scope || '';
            
            if (window.sopDrawerEditor) {
              window.sopDrawerEditor.root.innerHTML = sopData.content || '';
            }
            
            // è¼‰å…¥æ¨™ç±¤è¤‡é¸æ¡†ï¼ˆç·¨è¼¯æ™‚é¸ä¸­å·²æœ‰æ¨™ç±¤ï¼‰
            const existingTags = Array.isArray(sopData.tags) ? sopData.tags : (sopData.tags ? sopData.tags.split(',').map(t => t.trim()) : []);
            loadCustomTags();
            loadTagCheckboxes('sop-tags-checkboxes', existingTags);
          }
          
          drawer.classList.add('show');
          overlay.classList.add('show');
          overlay.onclick = closeSopDrawer;
        };
        
        window.closeSopDrawer = function() {
          const drawer = document.getElementById('sopEditDrawer');
          const overlay = document.getElementById('drawerOverlay');
          if (drawer) drawer.classList.remove('show');
          if (overlay) {
            overlay.classList.remove('show');
            overlay.onclick = null;
          }
        };
        
        // FAQ å›ºå®šæ¨¡æ¿
        const FAQ_TEMPLATE = `
          <h3>ğŸ’¡ ç°¡çŸ­å›ç­”</h3>
          <p>ç”¨ä¸€åˆ°å…©å¥è©±ç°¡å–®å›ç­”é€™å€‹å•é¡Œ...</p>
          
          <h3>ğŸ“– è©³ç´°èªªæ˜</h3>
          <p><strong>æƒ…å¢ƒèªªæ˜ï¼š</strong></p>
          <p>é€™å€‹å•é¡Œé€šå¸¸ç™¼ç”Ÿåœ¨ä»€éº¼æƒ…æ³ä¸‹...</p>
          
          <p><strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong></p>
          <ol>
            <li>ç¬¬ä¸€æ­¥ï¼šå…·é«”æ“ä½œæ­¥é©Ÿ</li>
            <li>ç¬¬äºŒæ­¥ï¼šç›¸é—œè¨­å®šæˆ–ç¢ºèªäº‹é …</li>
            <li>ç¬¬ä¸‰æ­¥ï¼šé©—è­‰çµæœ</li>
          </ol>
          
          <h3>ğŸ’¼ å¯¦éš›æ¡ˆä¾‹</h3>
          <p><em>ä¾‹å¦‚ï¼š</em>æŸå®¢æˆ¶åœ¨å ±ç¨…æ™‚é‡åˆ° XXX å•é¡Œï¼Œæˆ‘å€‘é€é YYY æ–¹å¼è§£æ±º...</p>
          
          <h3>âš ï¸ æ³¨æ„äº‹é …</h3>
          <ul>
            <li>ç‰¹åˆ¥æé†’ï¼šXXX æƒ…æ³ä¸‹éœ€è¦é¡å¤–æ³¨æ„...</li>
            <li>å¸¸è¦‹éŒ¯èª¤ï¼šé¿å… XXX æ“ä½œ</li>
          </ul>
          
          <h3>ğŸ”— ç›¸é—œè³‡æº</h3>
          <ul>
            <li>ç›¸é—œ SOP é€£çµæˆ–æ–‡ä»¶</li>
            <li>æ³•è¦åƒè€ƒæˆ–å®˜æ–¹ç¶²ç«™</li>
            <li>å…§éƒ¨è¯çµ¡äººï¼šXXXï¼ˆåˆ†æ©Ÿ XXXï¼‰</li>
          </ul>
          
          <hr>
          <p style="color:#6b7280;font-size:14px;"><em>æœ€å¾Œæ›´æ–°ï¼šè«‹åœ¨å„²å­˜å‰å¡«å¯«ç•¶å‰æ—¥æœŸ</em></p>
        `.trim();
        
        // FAQ æŠ½å±œæ§åˆ¶
        window.openFaqDrawer = function(faqData = null) {
          const drawer = document.getElementById('faqEditDrawer');
          const overlay = document.getElementById('drawerOverlay');
          if (!drawer || !overlay) return;
          
          // å¦‚æœæ˜¯æ–°å¢æ¨¡å¼ï¼ˆfaqData ç‚º nullï¼‰ï¼Œä½¿ç”¨æ¨¡æ¿
          if (!faqData) {
            document.getElementById('faq-id-drawer').value = '';
            document.getElementById('faq-question-drawer').value = 'ã€è«‹å¡«å¯«å•é¡Œã€‘ä¾‹å¦‚ï¼šå¦‚ä½•è™•ç†è·¨æœˆä»½çš„ç™¼ç¥¨ï¼Ÿ';
            document.getElementById('faq-category-drawer').value = '';
            document.getElementById('faq-client-drawer').value = '';
            document.getElementById('faq-scope-drawer').value = '';
            
            if (window.faqDrawerEditor) {
              window.faqDrawerEditor.root.innerHTML = FAQ_TEMPLATE;
            }
            
            // è¼‰å…¥æ¨™ç±¤è¤‡é¸æ¡†ï¼ˆæ–°å¢æ™‚é é¸ã€Œå¸¸è¦‹ã€å’Œã€Œé‡è¦ã€ï¼‰
            loadCustomTags();
            loadTagCheckboxes('faq-tags-checkboxes', ['å¸¸è¦‹', 'é‡è¦']);
          } else {
            // ç·¨è¼¯æ¨¡å¼ï¼šå¡«å……ç¾æœ‰æ•¸æ“š
            document.getElementById('faq-id-drawer').value = faqData.faq_id || '';
            document.getElementById('faq-question-drawer').value = faqData.question || '';
            document.getElementById('faq-category-drawer').value = faqData.category || '';
            document.getElementById('faq-client-drawer').value = faqData.clientId || faqData.client_id || '';
            document.getElementById('faq-scope-drawer').value = faqData.scope || '';
            
            if (window.faqDrawerEditor) {
              window.faqDrawerEditor.root.innerHTML = faqData.answer || '';
            }
            
            // è¼‰å…¥æ¨™ç±¤è¤‡é¸æ¡†ï¼ˆç·¨è¼¯æ™‚é¸ä¸­å·²æœ‰æ¨™ç±¤ï¼‰
            const existingTags = Array.isArray(faqData.tags) ? faqData.tags : (faqData.tags ? faqData.tags.split(',').map(t => t.trim()) : []);
            loadCustomTags();
            loadTagCheckboxes('faq-tags-checkboxes', existingTags);
          }
          
          drawer.classList.add('show');
          overlay.classList.add('show');
          overlay.onclick = closeFaqDrawer;
        };
        
        window.closeFaqDrawer = function() {
          const drawer = document.getElementById('faqEditDrawer');
          const overlay = document.getElementById('drawerOverlay');
          if (drawer) drawer.classList.remove('show');
          if (overlay) {
            overlay.classList.remove('show');
            overlay.onclick = null;
          }
        };

        if (fileUploadAreaModal && fileInputModal) {
          fileUploadAreaModal.addEventListener('click', () => fileInputModal.click());
          
          fileInputModal.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
              selectedFile = e.target.files[0];
              displayFileInfo(selectedFile);
            }
          });

          fileUploadAreaModal.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadAreaModal.style.borderColor = '#2563eb';
            fileUploadAreaModal.style.background = '#eff6ff';
          });

          fileUploadAreaModal.addEventListener('dragleave', () => {
            fileUploadAreaModal.style.borderColor = '';
            fileUploadAreaModal.style.background = '';
          });

          fileUploadAreaModal.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadAreaModal.style.borderColor = '';
            fileUploadAreaModal.style.background = '';
            if (e.dataTransfer.files.length > 0) {
              selectedFile = e.dataTransfer.files[0];
              fileInputModal.files = e.dataTransfer.files;
              displayFileInfo(selectedFile);
            }
          });
        }

        function displayFileInfo(file) {
          document.getElementById('fileNameModal').textContent = file.name;
          document.getElementById('fileSizeModal').textContent = `å¤§å°ï¼š${(file.size / 1024).toFixed(1)} KB`;
          document.getElementById('uploadedFileInfoModal').style.display = 'block';
          
          // è‡ªåŠ¨å¡«å……æ ‡é¢˜ï¼ˆå¦‚æœä¸ºç©ºï¼‰
          if (!document.getElementById('resource-title-modal').value) {
            document.getElementById('resource-title-modal').value = file.name.split('.')[0];
          }
        }

        // Formæäº¤ï¼ˆplaceholderï¼‰
        // SOP Formæäº¤
        // SOP æŠ½å±œè¡¨å–®æäº¤
        document.getElementById('sopFormDrawer').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          if (!window.sopDrawerEditor) {
            alert('ç·¨è¼¯å™¨æœªåˆå§‹åŒ–ï¼Œè«‹é‡è©¦');
            return;
          }
          
          const sopId = document.getElementById('sop-id-drawer').value;
          const title = document.getElementById('sop-title-drawer').value;
          const category = document.getElementById('sop-category-drawer').value;
          const client_id = document.getElementById('sop-client-drawer').value || null;
          const scope = document.getElementById('sop-scope-drawer').value;
          const tags = getCheckedTags('sop-tags-checkboxes');
          const content = window.sopDrawerEditor.root.innerHTML;
          
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span>è™•ç†ä¸­...</span>';
          
          try {
            const method = sopId ? 'PUT' : 'POST';
            const url = sopId ? `${apiBase}/sop/${sopId}` : `${apiBase}/sop`;
            
            const res = await fetch(url, {
              method,
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ title, category, client_id, scope, tags, content })
            });
            
            const json = await res.json();
            if (json.ok) {
              alert(sopId ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
              closeSopDrawer();
              forceRefreshTab('sop');
              // å¦‚æœæ˜¯æ–°å¢æˆ–å·²æœ‰é è¦½ï¼Œè‡ªå‹•é è¦½æ–°å…§å®¹
              if (json.data && json.data.sop_id) {
                viewSOP(json.data.sop_id);
              }
            } else {
              alert('ä¿å­˜å¤±æ•—ï¼š' + (json.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
          } catch (err) {
            alert('ä¿å­˜å¤±æ•—');
            console.error(err);
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        });

        // FAQ æŠ½å±œè¡¨å–®æäº¤
        document.getElementById('faqFormDrawer').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          if (!window.faqDrawerEditor) {
            alert('ç·¨è¼¯å™¨æœªåˆå§‹åŒ–ï¼Œè«‹é‡è©¦');
            return;
          }
          
          const faqId = document.getElementById('faq-id-drawer').value;
          const question = document.getElementById('faq-question-drawer').value;
          const category = document.getElementById('faq-category-drawer').value;
          const client_id = document.getElementById('faq-client-drawer').value || null;
          const scope = document.getElementById('faq-scope-drawer').value;
          const tags = getCheckedTags('faq-tags-checkboxes');
          const answer = window.faqDrawerEditor.root.innerHTML;
          
          if (!scope) {
            alert('è«‹é¸æ“‡FAQé©ç”¨å±¤ç´š');
            return;
          }
          
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span>è™•ç†ä¸­...</span>';
          
          try {
            const method = faqId ? 'PUT' : 'POST';
            const url = faqId ? `${apiBase}/faq/${faqId}` : `${apiBase}/faq`;
            
            const res = await fetch(url, {
              method,
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ question, category, client_id, scope, tags, answer })
            });
            
            const json = await res.json();
            if (json.ok) {
              alert(faqId ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
              closeFaqDrawer();
              loadFAQs();
              // å¦‚æœæ˜¯æ–°å¢æˆ–å·²æœ‰é è¦½ï¼Œè‡ªå‹•é è¦½æ–°å…§å®¹
              if (json.data && json.data.faq_id) {
                viewFAQ(json.data.faq_id);
              }
            } else {
              alert('ä¿å­˜å¤±æ•—ï¼š' + (json.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
          } catch (err) {
            alert('ä¿å­˜å¤±æ•—');
            console.error(err);
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        });

        // èµ„æºä¸Šä¼ Formæäº¤
        document.getElementById('resourceFormModal').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          if (!selectedFile) {
            alert('è«‹é¸æ“‡è¦ä¸Šå‚³çš„æ–‡ä»¶');
            return;
          }
          
          // é©—è­‰æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§ 25MBï¼‰
          if (selectedFile.size > 25 * 1024 * 1024) {
            alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…é 25MB');
            return;
          }
          
          const submitBtn = document.getElementById('resourceSubmitBtnModal');
          submitBtn.disabled = true;
          
          const title = document.getElementById('resource-title-modal').value;
          const category = document.getElementById('resource-category-modal').value;
          const scope = document.getElementById('resource-scope-modal').value;
          const client_id = document.getElementById('resource-client-modal').value || '';
          const doc_year = document.getElementById('resource-year-modal').value || '';
          const doc_month = document.getElementById('resource-month-modal').value || '';
          
          if (!scope) {
            alert('è«‹é¸æ“‡è³‡æºé©ç”¨å±¤ç´š');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>ğŸ“¤ ä¸Šå‚³æ–‡æª”</span>';
            return;
          }
          
          // å¾è¤‡é¸æ¡†ç²å–é¸ä¸­çš„æ¨™ç±¤
          const selectedTags = getCheckedTags('resource-tags-checkboxes');
          const tags = selectedTags.join(',');
          
          // å‰µå»ºé€²åº¦æç¤º
          const progressDiv = document.createElement('div');
          progressDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:24px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,0.2);z-index:10001;min-width:300px;';
          progressDiv.innerHTML = `
            <div style="text-align:center;">
              <div style="font-size:16px;font-weight:600;margin-bottom:12px;color:#1f2937;">ä¸Šå‚³ä¸­...</div>
              <div style="background:#e5e7eb;height:8px;border-radius:4px;overflow:hidden;margin-bottom:8px;">
                <div id="resourceUploadProgressBar" style="background:#3b82f6;height:100%;width:0%;transition:width 0.3s;"></div>
              </div>
              <div id="resourceUploadProgressText" style="font-size:13px;color:#6b7280;">æº–å‚™ä¸Šå‚³...</div>
            </div>
          `;
          document.body.appendChild(progressDiv);
          
          try {
            // ä½¿ç”¨ FormData ä¸€æ­¥å®Œæˆä¸Šä¼ 
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('title', title);
            formData.append('category', category);
            formData.append('scope', scope);
            if (client_id) formData.append('client_id', client_id);
            if (doc_year) formData.append('doc_year', doc_year);
            if (doc_month) formData.append('doc_month', doc_month);
            formData.append('tags', tags);
            
            // ä½¿ç”¨ XMLHttpRequest ä»¥æ”¯æŒé€²åº¦æ¢
            await new Promise((resolve, reject) => {
              const xhr = new XMLHttpRequest();
              
              xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                  const percent = Math.round((e.loaded / e.total) * 100);
                  document.getElementById('resourceUploadProgressBar').style.width = percent + '%';
                  document.getElementById('resourceUploadProgressText').textContent = `å·²ä¸Šå‚³ ${percent}%`;
                }
              });
              
              xhr.addEventListener('load', () => {
                if (xhr.status === 401) {
                  location.assign('/login?redirect=/internal/knowledge');
                  reject(new Error('æœªæˆæ¬Š'));
                  return;
                }
                
                try {
                  const json = JSON.parse(xhr.responseText);
                  if (json.ok) {
                    resolve(json);
                  } else {
                    reject(new Error(json.error || json.message || 'ä¸Šå‚³å¤±æ•—'));
                  }
                } catch (e) {
                  reject(new Error('è§£æéŸ¿æ‡‰å¤±æ•—'));
                }
              });
              
              xhr.addEventListener('error', () => reject(new Error('ç¶²è·¯éŒ¯èª¤')));
              xhr.addEventListener('abort', () => reject(new Error('ä¸Šå‚³å·²å–æ¶ˆ')));
              
              xhr.open('POST', `${apiBase}/documents/upload`);
              xhr.withCredentials = true;
              xhr.send(formData);
            });
            
            document.body.removeChild(progressDiv);
            alert('ä¸Šå‚³æˆåŠŸï¼');
            closeUploadDocModal();
            loadResources();
          } catch (err) {
            if (document.body.contains(progressDiv)) {
              document.body.removeChild(progressDiv);
            }
            alert('ä¸Šå‚³å¤±æ•—ï¼š' + err.message);
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>ğŸ“¤ ä¸Šå‚³æ–‡æª”</span>';
          }
        });

        // åˆå§‹åŒ–
        ensureSession().then(async ok => { 
          if (ok) {
            // ç¢ºä¿æ‰€æœ‰æ¨¡æ…‹æ¡†åˆå§‹ç‹€æ…‹ç‚ºéš±è—
            document.querySelectorAll('.modal').forEach(modal => {
              modal.classList.remove('show');
            });
            
            // å…ˆç­‰å¾… Quill å’Œè¡¨æ ¼æ¨¡çµ„è¼‰å…¥
            try {
              await waitForQuillAndTable();
              console.log('âœ… æ‰€æœ‰ç·¨è¼¯å™¨è³‡æºè¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–ç·¨è¼¯å™¨');
              
              // ç«‹å³åˆå§‹åŒ–ç·¨è¼¯å™¨ï¼ˆé é¢æ¨¡å¼å·²ç§»é™¤ï¼Œç¾åœ¨åªåˆå§‹åŒ–æŠ½å±œç·¨è¼¯å™¨ï¼‰
              await Promise.all([
                initSopDrawerEditor(),
                initFaqDrawerEditor()
              ]);
              
              console.log('âœ… ç·¨è¼¯å™¨åˆå§‹åŒ–å®Œæˆ');
            } catch (e) {
              console.error('âŒ ç·¨è¼¯å™¨åˆå§‹åŒ–å¤±æ•—:', e);
              
              // é¡¯ç¤ºè©³ç´°éŒ¯èª¤è¨Šæ¯
              const errorMsg = `ç·¨è¼¯å™¨è¼‰å…¥å¤±æ•—\n\nå¯èƒ½åŸå› ï¼š\n1. ç¶²è·¯é€£ç·šå•é¡Œ\n2. CDN æœå‹™æš«æ™‚ç„¡æ³•è¨ªå•\n3. é˜²ç«ç‰†æˆ–å»£å‘Šæ””æˆªå™¨\n\nå»ºè­°ï¼š\n1. æª¢æŸ¥ç¶²è·¯é€£ç·š\n2. é—œé–‰å»£å‘Šæ””æˆªå™¨\n3. åˆ·æ–°é é¢é‡è©¦\n\næŠ€è¡“è©³æƒ…ï¼š${e.message}`;
              alert(errorMsg);
            }
            
            // è¼‰å…¥æœå‹™é¡å‹å’Œæ¨™ç±¤åº«
            await loadServices();
            await loadClients();
            loadCustomTags();
            loadFilterTagOptions();
            
            // åˆ‡æ›åˆ° SOP æ¨™ç±¤
            switchTab('sop');
          }
        });
        
        // ==================== é™„ä»¶ç®¡ç†åŠŸèƒ½ ====================
        
        // é™„ä»¶ç‹€æ…‹ç®¡ç†
        const attachmentState = {
          page: 1,
          perPage: 20,
          total: 0,
          clientId: ''
        };
        
        // æ‰“é–‹ä¸Šå‚³æŠ½å±œ
        window.openAttachmentUploadDrawer = function() {
          console.log('[Attachments] ğŸš€ æ‰“é–‹ä¸Šå‚³æŠ½å±œ');
          const drawer = document.getElementById('attachmentUploadDrawer');
          if (!drawer) {
            console.error('[Attachments] âŒ æ‰¾ä¸åˆ°ä¸Šå‚³æŠ½å±œå…ƒç´ ');
            return;
          }
          
          drawer.style.display = 'flex';
          drawer.classList.add('show'); // æ·»åŠ  show ç±»ä»¥æ˜¾ç¤ºæŠ½å±‰ï¼ˆvisibility: visibleï¼‰
          
          console.log('[Attachments] âœ… æŠ½å±œå·²æ‰“é–‹');
          
          document.getElementById('attachment-file').value = '';
          document.getElementById('attachment-title').value = '';
          document.getElementById('attachment-description').value = '';
        };
        console.log('[Attachments] âœ… openAttachmentUploadDrawer å·²æ›è¼‰åˆ°å…¨å±€');
        
        // é—œé–‰ä¸Šå‚³æŠ½å±œ
        window.closeAttachmentUploadDrawer = function() {
          const drawer = document.getElementById('attachmentUploadDrawer');
          drawer.classList.remove('show'); // ç§»é™¤ show ç±»
          // ç­‰å¾…è¿‡æ¸¡åŠ¨ç”»å®Œæˆåå†éšè—
          setTimeout(() => {
            drawer.style.display = 'none';
          }, 300);
        };
        
        // è¼‰å…¥é™„ä»¶åˆ—è¡¨
        async function loadAttachments() {
          try {
            const list = document.getElementById('attachmentsList');
            list.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px;color:#9ca3af;">è¼‰å…¥ä¸­...</div>';
            
            const search = document.getElementById('attachment-search').value.trim();
            const entityType = document.getElementById('attachment-filter-type').value;
            const clientId = document.getElementById('attachment-filter-client').value;
            
            const params = new URLSearchParams();
            params.append('page', attachmentState.page);
            params.append('perPage', attachmentState.perPage);
            params.append('category', 'attachment');
            if (search) params.append('q', search);
            if (entityType) params.append('related_entity_type', entityType);
            if (clientId) params.append('related_entity_id', clientId);
            
            const res = await fetch(`${apiBase}/documents?${params}`, { 
              credentials: 'include' 
            });
            
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/knowledge');
              return;
            }
            
            const json = await res.json();
            if (!res.ok || !json.ok) {
              throw new Error(json.message || 'è¼‰å…¥å¤±æ•—');
            }
            
            const items = json.items || json.data || [];
            attachmentState.total = json.meta?.total || 0;
            
            // æ›´æ–°è³‡è¨Š
            document.getElementById('attachmentsListInfo').textContent = `å…± ${attachmentState.total} å€‹é™„ä»¶`;
            
            // æ¸²æŸ“åˆ—è¡¨
            list.innerHTML = '';
            if (items.length === 0) {
              list.innerHTML = `
                <div style="text-align:center;padding:60px 20px;color:#9ca3af;">
                  <div style="font-size:48px;margin-bottom:12px;">ğŸ“</div>
                  <div style="font-size:14px;margin-bottom:8px;">æš«ç„¡é™„ä»¶</div>
                  <div style="font-size:12px;">è«‹ä½¿ç”¨ä¸Šæ–¹è¡¨å–®ä¸Šå‚³é™„ä»¶</div>
                </div>
              `;
              return;
            }
            
            items.forEach(item => {
              const card = createAttachmentCard(item);
              list.appendChild(card);
            });
            
            // æ›´æ–°åˆ†é æŒ‰éˆ•
            updateAttachmentPagination();
            
          } catch (err) {
            console.error('è¼‰å…¥é™„ä»¶å¤±æ•—:', err);
            document.getElementById('attachmentsList').innerHTML = `
              <div style="text-align:center;padding:40px;color:#c0392b;">
                è¼‰å…¥å¤±æ•—ï¼š${err.message}
              </div>
            `;
          }
        }
        
        // å‰µå»ºé™„ä»¶å¡ç‰‡ï¼ˆç¶²æ ¼æ¨£å¼ï¼‰
        function createAttachmentCard(item) {
          const div = document.createElement('div');
          div.style.cssText = 'background:white;border:1px solid #e5e7eb;border-radius:12px;padding:20px;transition:all 0.2s;cursor:default;';
          div.onmouseenter = function() { this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)'; this.style.borderColor = '#3b82f6'; };
          div.onmouseleave = function() { this.style.boxShadow = 'none'; this.style.borderColor = '#e5e7eb'; };
          
          const fileIcon = getFileIcon(item.fileType || item.file_type);
          const fileSize = formatFileSize(item.fileSize || item.file_size);
          const entityBadge = item.relatedEntityType || item.related_entity_type 
            ? `<span style="background:#dbeafe;color:#1e40af;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">${getEntityTypeLabel(item.relatedEntityType || item.related_entity_type)} #${item.relatedEntityId || item.related_entity_id}</span>`
            : '<span style="background:#f3f4f6;color:#6b7280;padding:2px 8px;border-radius:4px;font-size:11px;">æœªé—œè¯</span>';
          
          const documentId = item.document_id || item.documentId;
          const fileUrl = (item.fileUrl || item.file_url || '').replace(/'/g, "\\'");
          const fileName = escapeHtml(item.fileName || item.file_name || 'file');
          
          div.innerHTML = `
            <div style="display:flex;align-items:start;gap:12px;margin-bottom:16px;">
              <div style="font-size:36px;flex-shrink:0;">${fileIcon}</div>
              <div style="flex:1;min-width:0;">
                <h4 style="margin:0 0 8px 0;font-size:15px;font-weight:600;color:#1f2937;word-break:break-word;line-height:1.4;">
                  ${escapeHtml(item.title)}
                </h4>
                <div style="font-size:12px;color:#6b7280;margin-bottom:8px;">
                  ${fileSize} â€¢ ${formatDateTime(item.createdAt || item.created_at)}
                </div>
                <div>${entityBadge}</div>
              </div>
            </div>
            <div style="display:flex;gap:8px;padding-top:12px;border-top:1px solid #f0f0f0;">
              <button onclick="downloadAttachment('${fileUrl}', '${fileName}')" 
                      style="flex:1;padding:8px 12px;background:#3b82f6;color:white;border:none;border-radius:6px;font-size:13px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;"
                      onmouseover="this.style.background='#2563eb'" 
                      onmouseout="this.style.background='#3b82f6'">
                <span>ğŸ“¥</span> ä¸‹è¼‰
              </button>
              <button onclick="deleteAttachment(${documentId})" 
                      style="flex:1;padding:8px 12px;background:#ef4444;color:white;border:none;border-radius:6px;font-size:13px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;"
                      onmouseover="this.style.background='#dc2626'" 
                      onmouseout="this.style.background='#ef4444'">
                <span>ğŸ—‘ï¸</span> åˆªé™¤
              </button>
            </div>
          `;
          
          return div;
        }
        
        // é¡¯ç¤ºé™„ä»¶è©³æƒ…
        function viewAttachmentDetail(item) {
          // å¯ä»¥åœ¨å³å´é¢æ¿é¡¯ç¤ºè©³ç´°è³‡è¨Š
          const detailArea = document.querySelector('#attachments-content .right-panel');
          if (!detailArea) return;
          
          const fileIcon = getFileIcon(item.fileType || item.file_type);
          const fileSize = formatFileSize(item.fileSize || item.file_size);
          
          detailArea.innerHTML = `
            <section class="resource-preview-card" style="padding:20px;">
              <div style="display:flex;align-items:start;gap:16px;margin-bottom:20px;">
                <div style="font-size:48px;flex-shrink:0;">${fileIcon}</div>
                <div style="flex:1;min-width:0;">
                  <h3 style="margin:0 0 8px 0;font-size:18px;font-weight:600;color:#1f2937;word-break:break-word;">
                    ${escapeHtml(item.title)}
                  </h3>
                  ${item.description ? `<p style="margin:0 0 12px 0;font-size:13px;color:#6b7280;line-height:1.6;">${escapeHtml(item.description)}</p>` : ''}
                  <div style="display:grid;grid-template-columns:auto 1fr;gap:8px 12px;font-size:13px;color:#6b7280;">
                    <span style="font-weight:500;">æ–‡ä»¶åç¨±ï¼š</span>
                    <span>${escapeHtml(item.fileName || item.file_name)}</span>
                    
                    <span style="font-weight:500;">æ–‡ä»¶å¤§å°ï¼š</span>
                    <span>${fileSize}</span>
                    
                    <span style="font-weight:500;">ä¸Šå‚³è€…ï¼š</span>
                    <span>${escapeHtml(item.uploaderName || item.uploader_name || 'æœªçŸ¥')}</span>
                    
                    <span style="font-weight:500;">ä¸Šå‚³æ™‚é–“ï¼š</span>
                    <span>${formatDateTime(item.createdAt || item.created_at)}</span>
                    
                    ${item.relatedEntityType || item.related_entity_type ? `
                      <span style="font-weight:500;">é—œè¯ï¼š</span>
                      <span>${getEntityTypeLabel(item.relatedEntityType || item.related_entity_type)} #${item.relatedEntityId || item.related_entity_id}</span>
                    ` : `
                      <span style="font-weight:500;">é—œè¯ï¼š</span>
                      <span style="color:#9ca3af;">æœªé—œè¯</span>
                    `}
                  </div>
                </div>
              </div>
              
              <div style="display:flex;gap:12px;padding-top:16px;border-top:1px solid #e5e7eb;">
                <button onclick="downloadAttachment('${(item.fileUrl || item.file_url).replace(/'/g, "\\'")}', '${escapeHtml(item.fileName || item.file_name)}')" 
                        class="btn btn-primary" style="flex:1;">
                  ğŸ“¥ ä¸‹è¼‰æ–‡ä»¶
                </button>
                <button onclick="deleteAttachment(${item.document_id})" 
                        class="btn btn-danger" style="flex:1;">
                  ğŸ—‘ï¸ åˆªé™¤
                </button>
              </div>
            </section>
            
            <!-- èªªæ˜å€åŸŸ -->
            <section class="resource-preview-card" style="margin-top:16px;padding:20px;">
              <h3 style="margin:0 0 12px 0;font-size:15px;font-weight:600;color:#1f2937;">ğŸ“Œ ä½¿ç”¨èªªæ˜</h3>
              <div style="font-size:13px;color:#6b7280;line-height:1.8;">
                <p style="margin:0 0 12px 0;"><strong>é™„ä»¶èˆ‡è³‡æºä¸­å¿ƒçš„å€åˆ¥ï¼š</strong></p>
                <ul style="margin:0;padding-left:20px;">
                  <li style="margin-bottom:8px;"><strong>ğŸ“ é™„ä»¶</strong>ï¼šç‰¹å®šä»»å‹™/å®¢æˆ¶/æ”¶æ“šçš„å°ˆå±¬æ–‡ä»¶</li>
                  <li style="margin-bottom:8px;"><strong>ğŸ“ è³‡æºä¸­å¿ƒ</strong>ï¼šå¯é‡è¤‡ä½¿ç”¨çš„ç¯„æœ¬ã€æ³•è¦ç­‰</li>
                </ul>
                <p style="margin:16px 0 0 0;"><strong>æ¨è–¦åšæ³•ï¼š</strong></p>
                <ul style="margin:8px 0 0 0;padding-left:20px;">
                  <li style="margin-bottom:8px;">ç›´æ¥åœ¨ä»»å‹™è©³æƒ…é é¢ä¸Šå‚³é™„ä»¶</li>
                  <li style="margin-bottom:8px;">ç¯„æœ¬æª”æ¡ˆè«‹ä¸Šå‚³åˆ°è³‡æºä¸­å¿ƒ</li>
                </ul>
              </div>
            </section>
          `;
        }
        
        // å·¥å…·å‡½æ•¸
        function getFileIcon(fileType) {
          if (!fileType) return 'ğŸ“„';
          if (fileType.includes('pdf')) return 'ğŸ“•';
          if (fileType.includes('image')) return 'ğŸ–¼ï¸';
          if (fileType.includes('word') || fileType.includes('document')) return 'ğŸ“˜';
          if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'ğŸ“—';
          if (fileType.includes('zip') || fileType.includes('rar')) return 'ğŸ“¦';
          return 'ğŸ“„';
        }
        
        function formatFileSize(bytes) {
          if (!bytes) return 'â€”';
          if (bytes < 1024) return bytes + ' B';
          if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
          return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function getEntityTypeLabel(type) {
          const labels = {
            'client': 'å®¢æˆ¶',
            'task': 'ä»»å‹™',
            'receipt': 'æ”¶æ“š'
          };
          return labels[type] || type;
        }
        
        function formatDateTime(isoString) {
          if (!isoString) return 'â€”';
          try {
            const date = new Date(isoString);
            return date.toLocaleString('zh-TW', { 
              year: 'numeric', 
              month: '2-digit', 
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            });
          } catch {
            return isoString;
          }
        }
        
        function escapeHtml(text) {
          if (!text) return '';
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
        
        // ä¸‹è¼‰é™„ä»¶
        window.downloadAttachment = async function(fileUrl, fileName) {
          try {
            const res = await fetch(`${apiBase}/documents/download?file_url=${encodeURIComponent(fileUrl)}`, {
              credentials: 'include'
            });
            
            if (!res.ok) throw new Error('ä¸‹è¼‰å¤±æ•—');
            
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
          } catch (err) {
            alert('ä¸‹è¼‰å¤±æ•—ï¼š' + err.message);
          }
        }
        
        // åˆªé™¤é™„ä»¶
        window.deleteAttachment = async function(documentId) {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é™„ä»¶å—ï¼Ÿ')) return;
          
          try {
            const res = await fetch(`${apiBase}/documents/${documentId}`, {
              method: 'DELETE',
              credentials: 'include'
            });
            
            const json = await res.json();
            if (!res.ok || !json.ok) {
              throw new Error(json.message || 'åˆªé™¤å¤±æ•—');
            }
            
            alert('åˆªé™¤æˆåŠŸ');
            loadAttachments();
          } catch (err) {
            alert('åˆªé™¤å¤±æ•—ï¼š' + err.message);
          }
        }
        
        // æ›´æ–°åˆ†é 
        function updateAttachmentPagination() {
          const pagination = document.querySelector('#attachments-content .pagination');
          const prevBtn = document.getElementById('attachments-prev');
          const nextBtn = document.getElementById('attachments-next');
          
          const totalPages = Math.ceil(attachmentState.total / attachmentState.perPage);
          
          if (totalPages <= 1) {
            pagination.style.display = 'none';
            return;
          }
          
          pagination.style.display = 'flex';
          prevBtn.disabled = attachmentState.page <= 1;
          nextBtn.disabled = attachmentState.page >= totalPages;
          
          prevBtn.onclick = () => {
            if (attachmentState.page > 1) {
              attachmentState.page--;
              loadAttachments();
            }
          };
          
          nextBtn.onclick = () => {
            if (attachmentState.page < totalPages) {
              attachmentState.page++;
              loadAttachments();
            }
          };
        }
        
        // é‡ç½®ç¯©é¸
        window.resetAttachmentFilters = function() {
          document.getElementById('attachment-search').value = '';
          document.getElementById('attachment-filter-type').value = '';
          document.getElementById('attachment-filter-client').value = '';
          attachmentState.page = 1;
          loadAttachments();
        };
        
        // å¡«å……å®¢æˆ¶ä¸‹æ‹‰æ¡†ï¼ˆå¸¶é‡è©¦æ©Ÿåˆ¶ï¼‰
        window.populateAttachmentClientFilter = async function(retryCount = 0) {
          try {
            const select = document.getElementById('attachment-filter-client');
            if (!select) {
              console.warn('[Attachments] âš ï¸ æ‰¾ä¸åˆ°å®¢æˆ¶ä¸‹æ‹‰æ¡†');
              return;
            }
            
            // å·²å¡«å……å‰‡è·³é
            if (select.children.length > 1) {
              console.log('[Attachments] â„¹ï¸ å®¢æˆ¶ä¸‹æ‹‰æ¡†å·²å¡«å……ï¼Œè·³é');
              return;
            }
            
            // ä½¿ç”¨å·²è¼‰å…¥çš„å®¢æˆ¶åˆ—è¡¨ (allClients å…¨å±€è®Šé‡)
            if (window.allClients && window.allClients.length > 0) {
              window.allClients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.clientId;
                option.textContent = client.companyName;
                select.appendChild(option);
              });
              console.log('[Attachments] âœ… å®¢æˆ¶ä¸‹æ‹‰æ¡†å·²å¡«å……:', window.allClients.length, 'å€‹å®¢æˆ¶');
            } else {
              // allClients é‚„æ²’æº–å‚™å¥½ï¼Œé‡è©¦æœ€å¤š 5 æ¬¡
              if (retryCount < 5) {
                console.log('[Attachments] â³ å®¢æˆ¶æ•¸æ“šå°šæœªè¼‰å…¥ï¼Œ500ms å¾Œé‡è©¦...', retryCount + 1, '/5');
                setTimeout(() => window.populateAttachmentClientFilter(retryCount + 1), 500);
              } else {
                console.warn('[Attachments] âš ï¸ ç„¡æ³•è¼‰å…¥å®¢æˆ¶åˆ—è¡¨ï¼ˆé‡è©¦æ¬¡æ•¸å·²é”ä¸Šé™ï¼‰');
              }
            }
          } catch (e) {
            console.error('[Attachments] âŒ å¡«å……å®¢æˆ¶ä¸‹æ‹‰æ¡†å¤±æ•—:', e);
          }
        };
        console.log('[Attachments] âœ… populateAttachmentClientFilter å·²æ›è¼‰åˆ°å…¨å±€');
        
        // åˆå§‹åŒ–é™„ä»¶äº‹ä»¶ç›£è½å™¨
        function initAttachmentEventListeners() {
          const form = document.getElementById('attachmentUploadForm');
          const searchInput = document.getElementById('attachment-search');
          const filterTypeSelect = document.getElementById('attachment-filter-type');
          const filterClientSelect = document.getElementById('attachment-filter-client');
          
          if (!form || !searchInput || !filterTypeSelect || !filterClientSelect) {
            console.warn('[Attachments] å…ƒç´ æœªæ‰¾åˆ°ï¼Œå»¶é²ç¶å®šäº‹ä»¶');
            setTimeout(initAttachmentEventListeners, 100);
            return;
          }
          
          // ä¸Šå‚³è¡¨å–®è™•ç†ï¼ˆç°¡åŒ–ç‰ˆï¼Œå¸¶é€²åº¦æ¢ï¼Œ25MBé™åˆ¶ï¼‰
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
          
          const file = document.getElementById('attachment-file').files[0];
          if (!file) {
            alert('è«‹é¸æ“‡æ–‡ä»¶');
            return;
          }
          
          // é©—è­‰æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§ 25MBï¼‰
          if (file.size > 25 * 1024 * 1024) {
            alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…é 25MB');
            return;
          }
          
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.disabled = true;
          
          // å‰µå»ºé€²åº¦æç¤º
          const progressDiv = document.createElement('div');
          progressDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:24px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,0.2);z-index:10000;min-width:300px;';
          progressDiv.innerHTML = `
            <div style="text-align:center;">
              <div style="font-size:16px;font-weight:600;margin-bottom:12px;color:#1f2937;">ä¸Šå‚³ä¸­...</div>
              <div style="background:#e5e7eb;height:8px;border-radius:4px;overflow:hidden;margin-bottom:8px;">
                <div id="attachmentUploadProgressBar" style="background:#3b82f6;height:100%;width:0%;transition:width 0.3s;"></div>
              </div>
              <div id="attachmentUploadProgressText" style="font-size:13px;color:#6b7280;">æº–å‚™ä¸Šå‚³...</div>
            </div>
          `;
          document.body.appendChild(progressDiv);
          
          try {
            // æ¨™é¡Œç‚ºç©ºæ™‚ä½¿ç”¨æª”å
            let title = document.getElementById('attachment-title').value.trim();
            if (!title) {
              title = file.name;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('title', title);
            formData.append('description', document.getElementById('attachment-description').value || '');
            formData.append('category', 'attachment');
            formData.append('scope', 'task');
            // æ³¨æ„ï¼šä¸æ·»åŠ  related_entity_type å’Œ related_entity_idï¼Œè¡¨ç¤ºæœªé—œè¯
            
            // ä½¿ç”¨ XMLHttpRequest ä»¥æ”¯æŒé€²åº¦æ¢
            await new Promise((resolve, reject) => {
              const xhr = new XMLHttpRequest();
              
              xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                  const percent = Math.round((e.loaded / e.total) * 100);
                  document.getElementById('attachmentUploadProgressBar').style.width = percent + '%';
                  document.getElementById('attachmentUploadProgressText').textContent = `å·²ä¸Šå‚³ ${percent}%`;
                }
              });
              
              xhr.addEventListener('load', () => {
                if (xhr.status === 401) {
                  location.assign('/login?redirect=/internal/knowledge');
                  reject(new Error('æœªæˆæ¬Š'));
                  return;
                }
                
                try {
                  const json = JSON.parse(xhr.responseText);
                  if (json.ok) {
                    resolve(json);
                  } else {
                    reject(new Error(json.message || 'ä¸Šå‚³å¤±æ•—'));
                  }
                } catch (e) {
                  reject(new Error('è§£æéŸ¿æ‡‰å¤±æ•—'));
                }
              });
              
              xhr.addEventListener('error', () => reject(new Error('ç¶²è·¯éŒ¯èª¤')));
              xhr.addEventListener('abort', () => reject(new Error('ä¸Šå‚³å·²å–æ¶ˆ')));
              
              xhr.open('POST', `${apiBase}/documents/upload`);
              xhr.withCredentials = true;
              xhr.send(formData);
            });
            
            document.body.removeChild(progressDiv);
            closeAttachmentUploadDrawer();
            alert('ä¸Šå‚³æˆåŠŸï¼');
            
            // é‡æ–°è¼‰å…¥åˆ—è¡¨
            attachmentState.page = 1;
            loadAttachments();
            
          } catch (err) {
            if (document.body.contains(progressDiv)) {
              document.body.removeChild(progressDiv);
            }
            console.error('ä¸Šå‚³å¤±æ•—:', err);
            alert('ä¸Šå‚³å¤±æ•—ï¼š' + err.message);
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        });
        
          // æœå°‹è¼¸å…¥è™•ç†ï¼ˆEnter éµæœç´¢ï¼‰
          searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              attachmentState.page = 1;
              loadAttachments();
            }
          });
          
          // é¡å‹ç¯©é¸è®ŠåŒ–æ™‚è‡ªå‹•æœç´¢
          filterTypeSelect.addEventListener('change', () => {
            attachmentState.page = 1;
            loadAttachments();
          });
          
          // å®¢æˆ¶ç¯©é¸è®ŠåŒ–æ™‚è‡ªå‹•æœç´¢
          filterClientSelect.addEventListener('change', () => {
            attachmentState.page = 1;
            loadAttachments();
          });
          
          console.log('[Attachments] âœ… äº‹ä»¶ç›£è½å™¨å·²ç¶å®š');
        }
        
        // èª¿ç”¨åˆå§‹åŒ–å‡½æ•¸
        initAttachmentEventListeners();
        
        // ç«‹å³å˜—è©¦å¡«å……å®¢æˆ¶ä¸‹æ‹‰æ¡†ï¼ˆå¸¶é‡è©¦æ©Ÿåˆ¶ï¼‰
        populateAttachmentClientFilter();
        
        // æ¸¬è©¦å…¨å±€å‡½æ•¸æ˜¯å¦å¯è¨ªå•ï¼ˆåƒ…é–‹ç™¼ç’°å¢ƒï¼‰
        console.log('[Attachments] ğŸ” æ¸¬è©¦å…¨å±€å‡½æ•¸:', {
          openDrawer: typeof window.openAttachmentUploadDrawer,
          closeDrawer: typeof window.closeAttachmentUploadDrawer,
          resetFilters: typeof window.resetAttachmentFilters
        });
        
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
    
    <!-- âš¡ é¢„æ¸²æŸ“åˆå§‹åŒ– -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (window.PagePrerender) {
        // å°è¯•åŠ è½½é¢„æ¸²æŸ“ HTML
        window.PagePrerender.init('main.internal-container', function(isBackgroundUpdate) {
          if (isBackgroundUpdate) {
            console.log('[Knowledge] ğŸ”„ åå°æ›´æ–°æ•°æ®');
          }
        });
        
        // å¯ç”¨è‡ªåŠ¨ä¿å­˜
        window.PagePrerender.autoSave('main.internal-container');
      }
    });
    </script>
  </body>
  </html>
