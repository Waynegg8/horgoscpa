<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="內部知識庫" />
    <title>知識庫｜SOP / FAQ / 資源中心</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/knowledge-page.css" />
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Quill 2.0 富文本编辑器 + Better Table 插件 -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-dev.3/dist/quill.snow.css" rel="stylesheet">
    <link href="https://unpkg.com/quill-better-table@1.2.10/dist/quill-better-table.css" rel="stylesheet">
    <style>
      .tabs {
        display: flex;
        gap: 8px;
        border-bottom: 2px solid #e5e7eb;
      }
      .tab-button {
        padding: 12px 24px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        color: #6b7280;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
      }
      .tab-button:hover {
        color: #1f2937;
        background: #f9fafb;
      }
      .tab-button.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      
      /* 左右佈局優化 */
      .kb-layout {
        display: grid;
        grid-template-columns: 240px 1fr;
        gap: 24px;
        transition: all 0.3s ease;
        position: relative;
      }
      /* FAQ 列表欄加倍寬度 */
      #faq-layout {
        grid-template-columns: 480px 1fr;
      }
      #faq-layout.collapsed {
        grid-template-columns: 0 1fr;
      }
      .kb-layout.collapsed {
        grid-template-columns: 0 1fr;
        gap: 0;
      }
      .kb-layout.collapsed .right-panel {
        max-width: 100%;
        width: 100%;
      }
      .left-panel {
        background: white;
        border: 1px solid rgba(15,23,42,0.08);
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.04);
        padding: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
        position: relative;
      }
      .kb-layout.collapsed .left-panel {
        padding: 0;
        border: none;
        box-shadow: none;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        left: 0;
        top: 0;
        width: auto;
      }
      .right-panel {
        transition: all 0.3s ease;
      }
      .kb-layout.collapsed .panel-content {
        display: none;
      }
      .toggle-panel-btn {
        position: absolute;
        right: -20px;
        top: 20px;
        width: 32px;
        height: 48px;
        cursor: pointer;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 0 8px 8px 0;
        box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        color: #2563eb;
        transition: all 0.2s;
        z-index: 100;
      }
      .toggle-panel-btn::after {
        content: '◀';
        font-weight: bold;
      }
      .toggle-panel-btn:hover {
        background: #eff6ff;
        color: #1d4ed8;
        box-shadow: 2px 0 12px rgba(37, 99, 235, 0.2);
      }
      .kb-layout.collapsed .left-panel {
        width: 0;
        min-width: 0;
        padding: 0;
        border: none;
        overflow: visible;
        position: relative;
      }
      .kb-layout.collapsed .toggle-panel-btn {
        position: fixed;
        left: 20px;
        top: 120px;
        right: auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 1000;
      }
      .kb-layout.collapsed .toggle-panel-btn::after {
        content: '▶';
      }
      .kb-layout.collapsed .toggle-panel-btn:hover {
        background: #eff6ff;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        transform: scale(1.05);
      }
      .doc-card {
        cursor: pointer;
        transition: all 0.2s;
      }
      .doc-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      /* 標籤按鈕樣式 */
      .tag-btn {
        padding: 4px 10px;
        font-size: 12px;
        border: 1px solid #d1d5db;
        border-radius: 16px;
        background: white;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }
      .tag-btn:hover {
        border-color: #2563eb;
        color: #2563eb;
        background: #eff6ff;
      }
      .tag-btn.selected {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
      }
      .tag-btn.selected:hover {
        background: #1d4ed8;
        border-color: #1d4ed8;
      }
      
      /* SOP/FAQ 內容排版優化 */
      .ql-editor h1 {
        font-size: 24px;
        font-weight: 700;
        margin: 24px 0 16px 0;
        color: #1f2937;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 8px;
      }
      .ql-editor h2 {
        font-size: 20px;
        font-weight: 600;
        margin: 20px 0 12px 0;
        color: #374151;
      }
      .ql-editor h3 {
        font-size: 16px;
        font-weight: 600;
        margin: 16px 0 10px 0;
        color: #4b5563;
      }
      .ql-editor p {
        margin: 8px 0;
        line-height: 1.8;
      }
      .ql-editor ul, .ql-editor ol {
        margin: 12px 0;
        padding-left: 24px;
      }
      .ql-editor li {
        margin: 6px 0;
        line-height: 1.7;
      }
      .ql-editor blockquote {
        border-left: 4px solid #2563eb;
        padding-left: 16px;
        margin: 16px 0;
        color: #6b7280;
        font-style: italic;
      }
      .ql-editor pre {
        background: #f3f4f6;
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
        margin: 12px 0;
      }
      .ql-editor table {
        border-collapse: collapse;
        width: 100%;
        margin: 16px 0;
      }
      .ql-editor table td,
      .ql-editor table th {
        border: 1px solid #d1d5db;
        padding: 8px 12px;
      }
      .ql-editor table th {
        background: #f3f4f6;
        font-weight: 600;
      }
      .ql-editor strong {
        font-weight: 600;
        color: #1f2937;
      }
      .ql-editor em {
        color: #6b7280;
      }
      
      /* 表格操作按鈕 */
      .table-controls {
        position: absolute;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: none;
        z-index: 1000;
        gap: 4px;
      }
      .table-controls button {
        padding: 4px 8px;
        font-size: 11px;
        border: 1px solid #e5e7eb;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        white-space: nowrap;
      }
      .table-controls button:hover {
        background: #f3f4f6;
      }
      
      /* 側邊抽屜式面板 */
      .drawer {
        position: fixed;
        top: 0;
        right: -900px;
        width: 900px;
        height: 100vh;
        background: white;
        box-shadow: -4px 0 24px rgba(0,0,0,0.15);
        z-index: 9999;
        transition: right 0.3s ease;
        overflow-y: auto;
      }
      .drawer.show {
        right: 0;
      }
      .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }
      .drawer-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      /* 保留模態框樣式給其他可能的用途 */
      .modal {
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.2s, visibility 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal.show {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }
      .modal-content {
        background-color: white;
        margin: auto;
        padding: 30px;
        border-radius: 12px;
        max-width: 800px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        position: relative;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e5e7eb;
      }
      .modal-header h2 {
        margin: 0;
        font-size: 22px;
        font-weight: 700;
        color: #1f2937;
      }
      .close-modal {
        font-size: 28px;
        font-weight: bold;
        color: #9ca3af;
        cursor: pointer;
        border: none;
        background: none;
        padding: 0;
        line-height: 1;
      }
      .close-modal:hover {
        color: #4b5563;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
        font-size: 14px;
      }
      .form-group input[type="text"],
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
      }
      .form-group textarea {
        min-height: 100px;
        font-family: inherit;
      }
      /* Quill 編輯器容器樣式 */
      .ql-container {
        font-size: 14px;
        min-height: 350px;
      }
      .ql-editor {
        min-height: 320px;
      }
      .ql-toolbar {
        border-radius: 6px 6px 0 0;
      }
      #sop-editor-inline .ql-container,
      #faq-editor-inline .ql-container {
        border-radius: 0 0 6px 6px;
      }
      .file-upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }
      .file-upload-area:hover {
        border-color: #2563eb;
        background: #f0f7ff;
      }
      .file-upload-area.dragover {
        border-color: #2563eb;
        background: #dbeafe;
      }
      .uploaded-file-info {
        margin-top: 16px;
        padding: 12px;
        background: #f0f7ff;
        border-radius: 6px;
        display: none;
      }
      .uploaded-file-info.show {
        display: block;
      }
      
      /* 資源預覽卡片樣式 */
      .resource-preview-card {
        background: white;
        border: 1px solid rgba(15,23,42,0.08);
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        overflow: hidden;
        position: sticky;
        top: 20px;
        transition: all 0.3s ease;
      }
      
      .resource-preview-card:hover {
        box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      }
      
      .resource-preview-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px 24px;
        border-bottom: 1px solid rgba(15,23,42,0.08);
      }
      
      .resource-preview-title {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: white;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .resource-preview-content {
        padding: 32px 24px;
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .resource-preview-empty {
        text-align: center;
        max-width: 400px;
        padding: 40px 20px;
      }
      
      .empty-icon {
        font-size: 80px;
        margin-bottom: 20px;
        animation: float 3s ease-in-out infinite;
        opacity: 0.8;
      }
      
      @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
      }
      
      .empty-text {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 8px 0;
      }
      
      .empty-hint {
        font-size: 13px;
        color: var(--text-secondary);
        margin: 0;
        opacity: 0.7;
      }
    </style>
  </head>
  <body class="knowledge-page">
    <!-- Tab切换 -->
    <section style="padding:12px 20px 0 20px;">
      <div class="tabs" style="margin-bottom:0;">
        <button class="tab-button active" data-tab="sop">📖 SOP 流程文檔</button>
        <button class="tab-button" data-tab="faq">❓ FAQ 常見問答</button>
        <button class="tab-button" data-tab="resources">📁 資源中心</button>
      </div>
    </section>

    <!-- 筛选区域 -->
    <section class="filters" style="padding:12px 20px;display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;">
      <div style="flex:1;min-width:220px;">
        <label for="q" style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px;">搜尋</label>
        <input id="q" type="search" placeholder="搜尋標題/內容…" aria-label="搜尋" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;width:100%;" />
      </div>
      <div>
        <label for="category" style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px;">分類</label>
        <select id="category" aria-label="分類" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;min-width:160px;">
          <option value="all">全部</option>
          <option value="accounting">記帳流程</option>
          <option value="tax">稅務流程</option>
          <option value="business">工商登記</option>
          <option value="hr">人事管理</option>
          <option value="finance">財務管理</option>
          <option value="contract">合同範本</option>
          <option value="internal">內部流程</option>
          <option value="other">其他</option>
        </select>
      </div>
      <div style="flex:1;min-width:220px;">
        <label for="tags" style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px;">篩選標籤</label>
        <select id="tags" aria-label="標籤" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;width:100%;">
          <option value="">全部標籤</option>
          <!-- 標籤選項會動態載入 -->
        </select>
      </div>
      <div class="toolbar-spacer" style="flex:1;"></div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="btn-edit" class="btn" type="button" style="display:none;background:#eff6ff;color:#2563eb;border:1px solid #bfdbfe;">✏️ 編輯</button>
        <button id="btn-delete" class="btn" type="button" style="display:none;background:#fee;color:#dc2626;border:1px solid #fca;">🗑️ 刪除</button>
        <button id="btn-new" class="btn primary" type="button">+ 新增</button>
      </div>
    </section>

    <!-- 列表区域 -->
    <main class="content" style="padding:0 20px 24px 20px;margin-top:-8px;">
      <!-- SOP Tab -->
      <div id="sop-content" class="tab-content active">
        <div class="kb-layout" id="sop-layout">
          <!-- 左側：SOP 列表 -->
          <div class="left-panel">
            <div class="toggle-panel-btn" onclick="togglePanel('sop')" title="收合/展開"></div>
            <div class="panel-content">
              <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 6px 8px 6px;border-bottom:1px solid #f0f0f0;margin-bottom:8px;">
                <div style="font-weight:700;font-size:13px;color:var(--text-secondary);">📖 SOP</div>
                <div id="sopListInfo" style="font-size:11px;color:#9ca3af;">—</div>
        </div>
              <div id="sopsList" style="max-height: calc(100vh - 280px); overflow-y: auto; overflow-x: hidden;"></div>
              <div class="pagination" style="display:none;gap:10px;justify-content:flex-end;margin-top:12px;">
                <button id="sop-prev" type="button" class="btn">上一頁</button>
                <button id="sop-next" type="button" class="btn">下一頁</button>
              </div>
            </div>
          </div>
          
          <!-- 右側：SOP 預覽區域 -->
          <div class="right-panel">
            <section class="resource-preview-card" style="padding:0;">
              <div id="sopPreviewArea" class="resource-preview-content" style="min-height:90vh;">
                <div class="resource-preview-empty">
                  <div class="empty-icon">📖</div>
                  <p class="empty-text">點擊左側 SOP 查看內容</p>
                  <p class="empty-hint">點擊「新增」按鈕建立新的 SOP</p>
                </div>
        </div>
      </section>
          </div>
        </div>
      </div>

      <!-- FAQ Tab -->
      <div id="faq-content" class="tab-content">
        <div class="kb-layout" id="faq-layout">
          <!-- 左側：FAQ 列表 -->
          <div class="left-panel">
            <div class="toggle-panel-btn" onclick="togglePanel('faq')" title="收合/展開"></div>
            <div class="panel-content">
              <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 6px 8px 6px;border-bottom:1px solid #f0f0f0;margin-bottom:8px;">
                <div style="font-weight:700;font-size:13px;color:var(--text-secondary);">❓ FAQ</div>
                <div id="faqListInfo" style="font-size:11px;color:#9ca3af;">—</div>
        </div>
              <div id="faqsList" style="max-height: calc(100vh - 280px); overflow-y: auto; overflow-x: hidden;"></div>
              <div class="pagination" style="display:none;gap:10px;justify-content:flex-end;margin-top:12px;">
                <button id="faq-prev" type="button" class="btn">上一頁</button>
                <button id="faq-next" type="button" class="btn">下一頁</button>
        </div>
            </div>
          </div>
          
          <!-- 右側：FAQ 預覽區域 -->
          <div class="right-panel">
            <section class="resource-preview-card" style="padding:0;">
              <div id="faqPreviewArea" class="resource-preview-content" style="min-height:90vh;">
                <div class="resource-preview-empty">
                  <div class="empty-icon">❓</div>
                  <p class="empty-text">點擊左側 FAQ 查看內容</p>
                  <p class="empty-hint">點擊「新增」按鈕建立新的 FAQ</p>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>

      <!-- 资源中心 Tab -->
      <div id="resources-content" class="tab-content">
        <div class="kb-layout" id="resources-layout">
          <!-- 左側：文檔列表 -->
          <div class="left-panel">
            <div class="toggle-panel-btn" onclick="togglePanel('resources')" title="收合/展開"></div>
            <div class="panel-content">
              <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 6px 8px 6px;border-bottom:1px solid #f0f0f0;margin-bottom:8px;">
                <div style="font-weight:700;font-size:13px;color:var(--text-secondary);">📁 文檔</div>
                <div id="resourcesListInfo" style="font-size:11px;color:#9ca3af;">—</div>
              </div>
              
              <div id="resourcesList" style="max-height: calc(100vh - 280px); overflow-y: auto; overflow-x: hidden;"></div>
              <div class="pagination" style="display:none;gap:10px;justify-content:flex-end;margin-top:12px;">
                <button id="resources-prev" type="button" class="btn">上一頁</button>
                <button id="resources-next" type="button" class="btn">下一頁</button>
              </div>
            </div>
          </div>
          
          <!-- 右側：文檔預覽區域 -->
          <div class="right-panel">
            <section class="resource-preview-card" style="padding:0;">
              <div id="documentPreviewArea" class="resource-preview-content" style="min-height:90vh;">
                <div class="resource-preview-empty">
                  <div class="empty-icon">📂</div>
                  <p class="empty-text">點擊左側文檔查看詳情</p>
                  <p class="empty-hint">支援線上預覽 PDF、圖片等格式</p>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>
    </main>

    <!-- 抽屜遮罩 -->
    <div id="drawerOverlay" class="drawer-overlay"></div>
    
    <!-- SOP 編輯抽屜 -->
    <div id="sopEditDrawer" class="drawer">
      <div style="padding:24px;border-bottom:1px solid #e5e7eb;background:#f9fafb;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2 style="margin:0;font-size:20px;font-weight:700;color:#1f2937;">📝 編輯 SOP</h2>
          <button onclick="closeSopDrawer()" style="font-size:32px;color:#9ca3af;background:none;border:none;cursor:pointer;padding:0;line-height:1;">&times;</button>
        </div>
        <p style="margin:8px 0 0 0;font-size:13px;color:#6b7280;">建立或編輯標準作業流程文檔</p>
      </div>
      
      <div style="padding:24px;">
        <form id="sopFormDrawer">
          <input type="hidden" id="sop-id-drawer" />
          
          <div class="form-group">
            <label>標題 *</label>
            <input type="text" id="sop-title-drawer" required placeholder="請輸入 SOP 標題" />
          </div>

          <div class="form-group">
            <label>分類 *</label>
            <select id="sop-category-drawer" required>
              <option value="">請選擇</option>
              <option value="accounting">記帳流程</option>
              <option value="tax">稅務流程</option>
              <option value="business">工商登記</option>
              <option value="hr">人事管理</option>
              <option value="finance">財務管理</option>
              <option value="internal">內部流程</option>
              <option value="other">其他</option>
            </select>
          </div>
          
          <div class="form-group">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
              <label style="margin:0;">標籤</label>
              <button type="button" onclick="event.preventDefault();event.stopPropagation();addNewTag('sop')" class="btn" style="padding:2px 8px;font-size:11px;background:#f3f4f6;color:#374151;border:1px solid #d1d5db;" title="新增標籤選項">
                ➕ 新增
              </button>
            </div>
            <div id="sop-tags-checkboxes" style="display:flex;flex-wrap:wrap;gap:6px;padding:8px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;background:#fafbfc;max-height:120px;overflow-y:auto;">
              <!-- 標籤按鈕會動態載入 -->
            </div>
          </div>
          
          <div class="form-group">
            <label>內容 *</label>
            <div id="sop-editor-drawer" style="min-height:400px;background:white;border:1px solid #d1d5db;border-radius:6px;"></div>
          </div>
          
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:24px;">
            <button type="button" class="btn" onclick="closeSopDrawer()">取消</button>
            <button type="submit" class="btn primary" id="sopSubmitBtnDrawer">
              <span>💾 儲存 SOP</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- FAQ 編輯抽屜 -->
    <div id="faqEditDrawer" class="drawer">
      <div style="padding:24px;border-bottom:1px solid #e5e7eb;background:#f9fafb;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2 style="margin:0;font-size:20px;font-weight:700;color:#1f2937;">❓ 編輯 FAQ</h2>
          <button onclick="closeFaqDrawer()" style="font-size:32px;color:#9ca3af;background:none;border:none;cursor:pointer;padding:0;line-height:1;">&times;</button>
        </div>
        <p style="margin:8px 0 0 0;font-size:13px;color:#6b7280;">建立或編輯常見問題解答</p>
      </div>
      
      <div style="padding:24px;">
        <form id="faqFormDrawer">
          <input type="hidden" id="faq-id-drawer" />
          
          <div class="form-group">
            <label>問題 *</label>
            <input type="text" id="faq-question-drawer" required placeholder="請輸入問題" />
          </div>

          <div class="form-group">
            <label>分類 *</label>
            <select id="faq-category-drawer" required>
              <option value="">請選擇</option>
              <option value="accounting">記帳相關</option>
              <option value="tax">稅務相關</option>
              <option value="hr">人事相關</option>
              <option value="system">系統操作</option>
              <option value="other">其他</option>
            </select>
          </div>
          
          <div class="form-group">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
              <label style="margin:0;">標籤</label>
              <button type="button" onclick="event.preventDefault();event.stopPropagation();addNewTag('faq')" class="btn" style="padding:2px 8px;font-size:11px;background:#f3f4f6;color:#374151;border:1px solid #d1d5db;" title="新增標籤選項">
                ➕ 新增
              </button>
            </div>
            <div id="faq-tags-checkboxes" style="display:flex;flex-wrap:wrap;gap:6px;padding:8px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;background:#fafbfc;max-height:120px;overflow-y:auto;">
              <!-- 標籤按鈕會動態載入 -->
            </div>
          </div>
          
          <div class="form-group">
            <label>回答 *</label>
            <div id="faq-editor-drawer" style="min-height:300px;background:white;border:1px solid #d1d5db;border-radius:6px;"></div>
          </div>
          
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:24px;">
            <button type="button" class="btn" onclick="closeFaqDrawer()">取消</button>
            <button type="submit" class="btn primary" id="faqSubmitBtnDrawer">
              <span>💾 儲存 FAQ</span>
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- 上傳文檔抽屜 -->
    <div id="uploadDocModal" class="drawer">
      <div style="padding:24px;border-bottom:1px solid #e5e7eb;background:#f9fafb;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2 style="margin:0;font-size:20px;font-weight:700;color:#1f2937;">📤 上傳文檔</h2>
          <button class="close-modal" onclick="closeUploadDocModal()" style="font-size:32px;color:#9ca3af;background:none;border:none;cursor:pointer;padding:0;line-height:1;">&times;</button>
        </div>
        <p style="margin:8px 0 0 0;font-size:13px;color:#6b7280;">上傳文檔到資源中心，支援PDF、Word、Excel等格式</p>
      </div>
      
      <div style="padding:24px;">
          
          <form id="resourceFormModal">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
              <div class="form-group" style="margin:0;">
                <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-secondary);">文檔標題 *</label>
                <input type="text" id="resource-title-modal" required style="width:100%;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;" placeholder="請輸入文檔標題" />
              </div>
              
              <div class="form-group" style="margin:0;">
                <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-secondary);">分類</label>
                <select id="resource-category-modal" style="width:100%;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
                  <option value="">請選擇</option>
                  <option value="contract">合同範本</option>
                  <option value="finance">財務表格</option>
                  <option value="hr">人事文檔</option>
                  <option value="tax">稅務參考</option>
                  <option value="other">其他</option>
                </select>
              </div>
            </div>
            
            <div class="form-group" style="margin:0 0 16px 0;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <label style="margin:0;font-size:13px;font-weight:600;color:var(--text-secondary);">標籤</label>
                <button type="button" onclick="event.preventDefault();event.stopPropagation();addNewTag('resource')" class="btn" style="padding:2px 8px;font-size:11px;background:#f3f4f6;color:#374151;border:1px solid #d1d5db;" title="新增標籤選項">
                  ➕ 新增
                </button>
              </div>
              <div id="resource-tags-checkboxes" style="display:flex;flex-wrap:wrap;gap:6px;padding:8px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;background:#fafbfc;max-height:120px;overflow-y:auto;">
                <!-- 標籤按鈕會動態載入 -->
              </div>
            </div>
            
            <div class="form-group" style="margin:0 0 16px 0;">
              <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-secondary);">選擇文件 *</label>
              <div class="file-upload-area" id="fileUploadAreaModal" style="border:2px dashed rgba(15,23,42,0.2);border-radius:12px;padding:32px;text-align:center;cursor:pointer;background:#f9fafb;transition:all 0.2s;">
                <div style="font-size:48px;margin-bottom:12px;">📎</div>
                <div style="font-weight:600;margin-bottom:8px;color:var(--text-primary);">點擊或拖拽文件到此處</div>
                <div style="font-size:13px;color:#6b7280;">支持 PDF, Word, Excel, PowerPoint, 圖片等格式</div>
                <input type="file" id="file-input-modal" style="display:none;" />
              </div>
              <div class="uploaded-file-info" id="uploadedFileInfoModal" style="display:none;margin-top:12px;padding:12px;background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;">
                <div style="font-weight:600;margin-bottom:4px;color:#0369a1;">已選擇文件：</div>
                <div id="fileNameModal" style="color:#0c4a6e;"></div>
                <div id="fileSizeModal" style="font-size:12px;color:#075985;margin-top:4px;"></div>
              </div>
            </div>
            
            <div style="display:flex;gap:10px;justify-content:flex-end;">
              <button type="button" class="btn" onclick="closeUploadDocModal()">取消</button>
              <button type="submit" class="btn primary" id="resourceSubmitBtnModal">
                <span>📤 上傳文檔</span>
              </button>
            </div>
          </form>
      </div>
    </div>
    </main>

    <!-- SOP模态框 (已棄用，改用內聯表單) -->
    <div id="sopModal" class="modal" style="display:none;" onclick="if(event.target === this) closeSopModal()">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="sopModalTitle">新增 SOP</h2>
          <button class="close-modal" onclick="event.stopPropagation(); closeSopModal();">&times;</button>
        </div>
        <form id="sopForm">
          <input type="hidden" id="sop-id" />
          
          <div class="form-group">
            <label for="sop-title">標題 *</label>
            <input type="text" id="sop-title" required />
          </div>
          
          <div class="form-group">
            <label for="sop-category">分類</label>
            <select id="sop-category">
              <option value="">請選擇</option>
              <option value="accounting">記帳流程</option>
              <option value="tax">稅務流程</option>
              <option value="business">工商登記</option>
              <option value="hr">人事管理</option>
              <option value="internal">內部流程</option>
              <option value="other">其他</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="sop-tags">標籤（以逗號分隔）</label>
            <input type="text" id="sop-tags" placeholder="例如：月結, 報稅, 對帳" />
          </div>
          
          <div class="form-group">
            <label>內容 *</label>
            <div id="sop-editor-container"></div>
          </div>
          
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:24px;">
            <button type="button" class="btn" onclick="closeSopModal()">取消</button>
            <button type="submit" class="btn primary">儲存</button>
          </div>
        </form>
      </div>
    </div>

    <!-- FAQ模态框 (已棄用，改用內聯表單) -->
    <div id="faqModal" class="modal" style="display:none;" onclick="if(event.target === this) closeFaqModal()">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="faqModalTitle">新增 FAQ</h2>
          <button class="close-modal" onclick="event.stopPropagation(); closeFaqModal();">&times;</button>
        </div>
        <form id="faqForm">
          <input type="hidden" id="faq-id" />
          
          <div class="form-group">
            <label for="faq-question">問題 *</label>
            <input type="text" id="faq-question" required />
          </div>
          
          <div class="form-group">
            <label for="faq-category">分類</label>
            <select id="faq-category">
              <option value="">請選擇</option>
              <option value="accounting">記帳流程</option>
              <option value="tax">稅務流程</option>
              <option value="business">工商登記</option>
              <option value="hr">人事管理</option>
              <option value="finance">財務管理</option>
              <option value="internal">內部流程</option>
              <option value="other">其他</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="faq-tags">標籤（以逗號分隔）</label>
            <input type="text" id="faq-tags" placeholder="例如：新手, 常見, 重要" />
          </div>
          
          <div class="form-group">
            <label>答案 *</label>
            <div id="faq-editor-container"></div>
          </div>
          
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:24px;">
            <button type="button" class="btn" onclick="closeFaqModal()">取消</button>
            <button type="submit" class="btn primary">儲存</button>
          </div>
        </form>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-dev.3/dist/quill.min.js"></script>
    <script src="https://unpkg.com/quill-better-table@1.2.10/dist/quill-better-table.js"></script>
    <script>
      // 等待所有腳本載入後註冊 Better Table 模組
      window.addEventListener('load', function() {
        const BetterTable = window.quillBetterTable;
        
        if (window.Quill && BetterTable) {
          try {
            console.log('🔍 Better Table 結構:', BetterTable);
            console.log('🔍 register 方法:', typeof BetterTable.register);
            
            // 調用 Better Table 的靜態 register() 方法來註冊所有 blots
            if (typeof BetterTable.register === 'function') {
              BetterTable.register();
              console.log('✅ Better Table blots 已註冊');
            }
            
            // 註冊模組本身
            Quill.register({
              'modules/better-table': BetterTable
            }, true);
            console.log('✅ Quill 1.3.7 + Better Table 模組已註冊');
            window.quillModulesReady = true;
          } catch (e) {
            console.error('❌ Better Table 註冊失敗:', e);
            window.quillModulesReady = false;
          }
        } else {
          console.error('❌ Quill 或 Better Table 載入失敗');
          console.log('Quill:', typeof window.Quill);
          console.log('quillBetterTable:', typeof window.quillBetterTable);
          window.quillModulesReady = false;
        }
      });
      
      window.quillModulesReady = false;
      
      // 添加表格樣式優化
      const style = document.createElement('style');
      style.textContent = `
        .ql-editor table {
          border-collapse: collapse;
          width: 100%;
          margin: 12px 0;
        }
        .ql-editor table td,
        .ql-editor table th {
          border: 1px solid #ddd;
          padding: 4px 8px; /* 減少上下 padding */
          min-width: 50px;
          line-height: 1.4; /* 減少行高 */
          vertical-align: top; /* 內容從頂部對齊 */
        }
        .ql-editor table th {
          background: #f5f5f5;
          font-weight: 600;
        }
        .ql-editor table tr:hover {
          background: #fafafa;
        }
        
        /* 允許用戶手動調整行高（通過在單元格內添加內容） */
        .ql-editor table td p,
        .ql-editor table th p {
          margin: 0;
          min-height: 1.5em;
        }
      `;
      document.head.appendChild(style);
    </script>
    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        let me = null;
        let currentTab = 'sop';
        let sopEditor = null;
        let faqEditor = null;
        let isQuillReady = false;
        
        // 等待 Quill 和 Better Table 載入完成
        function waitForQuillAndTable() {
          return new Promise((resolve, reject) => {
            let attempts = 0;
            const maxAttempts = 100; // 最多等待 10 秒
            
            const checkInterval = setInterval(() => {
              attempts++;
              
              // 檢查全局標誌
              if (window.quillModulesReady === true) {
                clearInterval(checkInterval);
                console.log('✅ 模組已就緒，可以初始化編輯器');
                isQuillReady = true;
                resolve();
              } else if (window.quillModulesReady === false && attempts > 30) {
                // 給予足夠時間載入，但如果明確失敗則提前報錯
                clearInterval(checkInterval);
                console.error('❌ 模組載入失敗');
                console.log('請檢查：');
                console.log('1. /assets/vendor/quill-better-table.js 是否存在');
                console.log('2. 網路連線是否正常（Quill CDN）');
                console.log('3. 瀏覽器控制台是否有其他錯誤');
                reject(new Error('模組載入失敗'));
              } else if (attempts >= maxAttempts) {
                clearInterval(checkInterval);
                console.error('❌ 模組載入超時');
                reject(new Error('模組載入超時'));
              }
            }, 100);
          });
        }
        
        // 圖片上傳處理器
        function imageHandler() {
          const input = document.createElement('input');
          input.setAttribute('type', 'file');
          input.setAttribute('accept', 'image/*');
          input.click();
          
          input.onchange = async () => {
            const file = input.files[0];
            if (!file) return;
            
            // 檢查文件大小（限制 5MB）
            if (file.size > 5 * 1024 * 1024) {
              alert('圖片大小不能超過 5MB');
              return;
            }
            
            try {
              // 轉換為 Base64
              const reader = new FileReader();
              reader.onload = (e) => {
                const range = this.quill.getSelection(true);
                this.quill.insertEmbed(range.index, 'image', e.target.result);
                this.quill.setSelection(range.index + 1);
              };
              reader.readAsDataURL(file);
            } catch (error) {
              console.error('圖片插入失敗:', error);
              alert('圖片插入失敗，請重試');
            }
          };
        }
        
        // 工具函數：取得分類名稱
        function getCategoryName(category, type = 'sop') {
          const categoryMap = {
            'accounting': '記帳流程',
            'tax': '稅務流程',
            'business': '工商登記',
            'hr': '人事管理',
            'finance': '財務管理',
            'contract': '合同範本',
            'internal': '內部流程',
            'other': '其他'
          };
          return categoryMap[category] || category || '未分類';
        }
        
        let sopState = { page:1, perPage:12, total:0 };
        let faqState = { page:1, perPage:12, total:0 };
        let resourcesState = { page:1, perPage:12, total:0, q:'', category:'' };

        // 初始化富文本编辑器（頁面加載時初始化）
        function initSopEditor() {
          if (sopEditor) return; // 已初始化则跳过
          
          const container = document.getElementById('sop-editor-inline');
          if (!container) {
            console.error('SOP 編輯器容器未找到');
            return;
          }
          
          sopEditor = new Quill('#sop-editor-inline', {
            theme: 'snow',
            modules: {
              toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'indent': '-1'}, { 'indent': '+1' }],
                ['link', 'image'],
                [{ 'color': [] }, { 'background': [] }],
              ]
            },
            placeholder: '請輸入SOP內容...'
          });
          
          console.log('SOP 編輯器已初始化');
        }
        
        function initFaqEditor() {
          if (faqEditor) return; // 已初始化则跳过
          
          const container = document.getElementById('faq-editor-inline');
          if (!container) {
            console.error('FAQ 編輯器容器未找到');
            return;
          }
          
          faqEditor = new Quill('#faq-editor-inline', {
            theme: 'snow',
            modules: {
              toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link'],
                [{ 'color': [] }],
              ]
            },
            placeholder: '請輸入FAQ答案...'
          });
          
          console.log('FAQ 編輯器已初始化');
        }
        
        // 檢查 Better Table 模組是否已註冊
        function registerTableModule() {
          if (!window.Quill) {
            console.error('❌ Quill 尚未載入');
            return false;
          }
          
          if (!window.quillBetterTable) {
            console.error('❌ Better Table 模組尚未載入');
            return false;
          }
          
          console.log('✅ Better Table 模組已就緒');
          return true;
        }
        
        // 初始化抽屜中的 SOP 編輯器
        async function initSopDrawerEditor() {
          if (window.sopDrawerEditor) return; // 已初始化则跳过
          
          // 確保 Quill 已載入
          if (!isQuillReady) {
            try {
              await waitForQuillAndTable();
            } catch (e) {
              alert('❌ 編輯器載入失敗，請刷新頁面重試');
              console.error(e);
              return;
            }
          }
          
          const container = document.getElementById('sop-editor-drawer');
          if (!container) {
            console.error('SOP 抽屜編輯器容器未找到');
            return;
          }
          
          // 先嘗試註冊表格模組
          const hasTable = registerTableModule();
          
          if (!hasTable) {
            alert('❌ 表格模組載入失敗，請刷新頁面重試');
            return;
          }
          
          // 配置（Quill 1.3.7 + Better Table 完整配置）
          // 注意：必須先初始化一個基礎 Quill 實例，讓 keyboard 模組正確設置
          const tempConfig = {
            theme: 'snow',
            modules: {
              toolbar: false
            }
          };
          
          // 先創建臨時實例以初始化 keyboard 綁定
          const temp = new Quill('#sop-editor-drawer', tempConfig);
          
          // 檢查並確保 Backspace 綁定存在
          if (!temp.keyboard.bindings['Backspace'] || !Array.isArray(temp.keyboard.bindings['Backspace'])) {
            console.warn('⚠️ Backspace 綁定不存在，手動創建');
            temp.keyboard.bindings['Backspace'] = [];
          }
          
          console.log('✅ Keyboard 綁定已初始化:', temp.keyboard.bindings['Backspace']);
          
          // 銷毀臨時實例
          delete temp;
          
          // 清空容器
          document.getElementById('sop-editor-drawer').innerHTML = '';
          
          // 現在創建真正的編輯器，包含 Better Table
          const config = {
            theme: 'snow',
            modules: {
              'better-table': {
                operationMenu: {
                  items: {
                    unmergeCells: {
                      text: '取消合併單元格'
                    },
                    mergeCells: {
                      text: '合併單元格'
                    },
                    insertColumnRight: {
                      text: '向右插入列'
                    },
                    insertColumnLeft: {
                      text: '向左插入列'
                    },
                    insertRowUp: {
                      text: '向上插入行'
                    },
                    insertRowDown: {
                      text: '向下插入行'
                    },
                    removeCol: {
                      text: '刪除當前列'
                    },
                    removeRow: {
                      text: '刪除當前行'
                    },
                    removeTable: {
                      text: '刪除表格'
                    }
                  },
                  color: {
                    colors: ['#ffffff', '#e0e0e0', '#f3f3f3', '#fef2e8', '#e8f4fd'],
                    text: '背景顏色：'
                  }
                }
              },
              toolbar: [
                [{ 'header': [2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['image'],
                [{ 'color': [] }],
              ]
            },
            placeholder: '請輸入SOP內容...'
          };
          
          window.sopDrawerEditor = new Quill('#sop-editor-drawer', config);
          
          // 自定義圖片處理器
          const toolbar = window.sopDrawerEditor.getModule('toolbar');
          toolbar.addHandler('image', function() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();
            
            input.onchange = () => {
              const file = input.files[0];
              if (!file) return;
              
              if (file.size > 5 * 1024 * 1024) {
                alert('圖片大小不能超過 5MB');
                return;
              }
              
              const reader = new FileReader();
              reader.onload = (e) => {
                const range = window.sopDrawerEditor.getSelection(true);
                window.sopDrawerEditor.insertEmbed(range.index, 'image', e.target.result);
                window.sopDrawerEditor.setSelection(range.index + 1);
              };
              reader.readAsDataURL(file);
            };
          });
          
          // 在工具欄最後添加表格插入按鈕
          const toolbarContainer = document.querySelector('#sop-editor-drawer').previousElementSibling;
          
          const tableBtn = document.createElement('button');
          tableBtn.type = 'button'; // 防止觸發表單提交
          tableBtn.className = 'ql-table-insert';
          tableBtn.innerHTML = `<span class="material-icons" style="font-size: 18px;">table_chart</span>`;
          tableBtn.title = '插入表格'; // 使用 tooltip 而不是文字
          tableBtn.onclick = (e) => {
            e.preventDefault(); // 防止觸發表單提交
            e.stopPropagation();
            
            // 顯示表格尺寸選擇器
            const rows = prompt('請輸入表格行數（1-10）:', '3');
            if (!rows) return;
            const cols = prompt('請輸入表格列數（1-10）:', '3');
            if (!cols) return;
            
            const rowNum = parseInt(rows);
            const colNum = parseInt(cols);
            
            if (isNaN(rowNum) || isNaN(colNum) || rowNum < 1 || rowNum > 10 || colNum < 1 || colNum > 10) {
              alert('請輸入 1-10 之間的數字');
              return;
            }
            
            try {
              const tableModule = window.sopDrawerEditor.getModule('better-table');
              if (tableModule && tableModule.insertTable) {
                console.log(`🔧 嘗試插入 ${rowNum}x${colNum} 表格...`);
                tableModule.insertTable(rowNum, colNum);
                console.log('✅ 表格插入成功');
              } else {
                console.error('❌ Better Table 模組或 insertTable 方法未找到');
                alert('表格功能暫時無法使用');
              }
            } catch (error) {
              console.error('❌ 插入表格時出錯:', error);
              alert('插入表格失敗: ' + error.message);
            }
          };
          toolbarContainer.appendChild(tableBtn);
          
          console.log('✅ SOP 編輯器已初始化（含表格與圖片功能）');
        }
        
        // 初始化抽屜中的 FAQ 編輯器
        async function initFaqDrawerEditor() {
          if (window.faqDrawerEditor) return; // 已初始化则跳过
          
          // 確保 Quill 已載入
          if (!isQuillReady) {
            try {
              await waitForQuillAndTable();
            } catch (e) {
              alert('❌ 編輯器載入失敗，請刷新頁面重試');
              console.error(e);
              return;
            }
          }
          
          const container = document.getElementById('faq-editor-drawer');
          if (!container) {
            console.error('FAQ 抽屜編輯器容器未找到');
            return;
          }
          
          // 先嘗試註冊表格模組
          const hasTable = registerTableModule();
          
          if (!hasTable) {
            alert('❌ 表格模組載入失敗，請刷新頁面重試');
            return;
          }
          
          // 配置（Quill 1.3.7 + Better Table 完整配置）
          // 先創建臨時實例以初始化 keyboard 綁定
          const tempConfig = {
            theme: 'snow',
            modules: {
              toolbar: false
            }
          };
          
          const temp = new Quill('#faq-editor-drawer', tempConfig);
          
          // 檢查並確保 Backspace 綁定存在
          if (!temp.keyboard.bindings['Backspace'] || !Array.isArray(temp.keyboard.bindings['Backspace'])) {
            console.warn('⚠️ FAQ Backspace 綁定不存在，手動創建');
            temp.keyboard.bindings['Backspace'] = [];
          }
          
          // 銷毀臨時實例
          delete temp;
          
          // 清空容器
          document.getElementById('faq-editor-drawer').innerHTML = '';
          
          // 現在創建真正的編輯器，包含 Better Table
          const config = {
            theme: 'snow',
            modules: {
              'better-table': {
                operationMenu: {
                  items: {
                    unmergeCells: {
                      text: '取消合併單元格'
                    },
                    mergeCells: {
                      text: '合併單元格'
                    },
                    insertColumnRight: {
                      text: '向右插入列'
                    },
                    insertColumnLeft: {
                      text: '向左插入列'
                    },
                    insertRowUp: {
                      text: '向上插入行'
                    },
                    insertRowDown: {
                      text: '向下插入行'
                    },
                    removeCol: {
                      text: '刪除當前列'
                    },
                    removeRow: {
                      text: '刪除當前行'
                    },
                    removeTable: {
                      text: '刪除表格'
                    }
                  },
                  color: {
                    colors: ['#ffffff', '#e0e0e0', '#f3f3f3', '#fef2e8', '#e8f4fd'],
                    text: '背景顏色：'
                  }
                }
              },
              toolbar: [
                [{ 'header': [2, 3, false] }],
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['image'],
                [{ 'color': [] }],
              ]
            },
            placeholder: '請輸入FAQ答案...'
          };
          
          window.faqDrawerEditor = new Quill('#faq-editor-drawer', config);
          
          // 自定義圖片處理器
          const toolbar = window.faqDrawerEditor.getModule('toolbar');
          toolbar.addHandler('image', function() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();
            
            input.onchange = () => {
              const file = input.files[0];
              if (!file) return;
              
              if (file.size > 5 * 1024 * 1024) {
                alert('圖片大小不能超過 5MB');
                return;
              }
              
              const reader = new FileReader();
              reader.onload = (e) => {
                const range = window.faqDrawerEditor.getSelection(true);
                window.faqDrawerEditor.insertEmbed(range.index, 'image', e.target.result);
                window.faqDrawerEditor.setSelection(range.index + 1);
              };
              reader.readAsDataURL(file);
            };
          });
          
          // 在工具欄最後添加表格按鈕
          const toolbarContainer = document.querySelector('#faq-editor-drawer').previousElementSibling;
          
          const tableBtn = document.createElement('button');
          tableBtn.type = 'button'; // 防止觸發表單提交
          tableBtn.className = 'ql-table-insert';
          tableBtn.innerHTML = `<span class="material-icons" style="font-size: 18px;">table_chart</span>`;
          tableBtn.title = '插入表格'; // 使用 tooltip 而不是文字
          tableBtn.onclick = (e) => {
            e.preventDefault(); // 防止觸發表單提交
            e.stopPropagation();
            
            // 顯示表格尺寸選擇器
            const rows = prompt('請輸入表格行數（1-10）:', '3');
            if (!rows) return;
            const cols = prompt('請輸入表格列數（1-10）:', '3');
            if (!cols) return;
            
            const rowNum = parseInt(rows);
            const colNum = parseInt(cols);
            
            if (isNaN(rowNum) || isNaN(colNum) || rowNum < 1 || rowNum > 10 || colNum < 1 || colNum > 10) {
              alert('請輸入 1-10 之間的數字');
              return;
            }
            
            try {
              const tableModule = window.faqDrawerEditor.getModule('better-table');
              if (tableModule && tableModule.insertTable) {
                console.log(`🔧 嘗試插入 ${rowNum}x${colNum} 表格...`);
                tableModule.insertTable(rowNum, colNum);
                console.log('✅ 表格插入成功');
              } else {
                console.error('❌ Better Table 模組或 insertTable 方法未找到');
                alert('表格功能暫時無法使用');
              }
            } catch (error) {
              console.error('❌ 插入表格時出錯:', error);
              alert('插入表格失敗: ' + error.message);
            }
          };
          toolbarContainer.appendChild(tableBtn);
          
          console.log('✅ FAQ 編輯器已初始化（含表格與圖片功能）');
        }
        
        // 清空 SOP 表單（已廢棄，保留以防引用）
        function resetSopForm() {
          document.getElementById('sop-id-inline').value = '';
          document.getElementById('sop-title-inline').value = '';
          document.getElementById('sop-category-inline').value = '';
          document.getElementById('sop-tags-inline').value = '';
          if (sopEditor) sopEditor.setText('');
          document.getElementById('sopSubmitBtnInline').querySelector('span').textContent = '💾 儲存 SOP';
        }
        
        // 清空 FAQ 表單
        function resetFaqForm() {
          document.getElementById('faq-id-inline').value = '';
          document.getElementById('faq-question-inline').value = '';
          document.getElementById('faq-category-inline').value = '';
          document.getElementById('faq-tags-inline').value = '';
          if (faqEditor) faqEditor.setText('');
          document.getElementById('faqSubmitBtnInline').querySelector('span').textContent = '💾 儲存 FAQ';
        }

        async function ensureSession(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/knowledge'); return false; }
            const json = await res.json();
            me = (json && json.ok && json.data) ? json.data : null;
            return true;
          } catch (_) {
            return false;
          }
        }

        // 隱藏工具欄編輯/刪除按鈕
        function hideToolbarButtons() {
          const editBtn = document.getElementById('btn-edit');
          const deleteBtn = document.getElementById('btn-delete');
          if (editBtn) editBtn.style.display = 'none';
          if (deleteBtn) deleteBtn.style.display = 'none';
        }
        
        // Tab切换
        function switchTab(tabName) {
          currentTab = tabName;
          
          // 隱藏工具欄按鈕
          hideToolbarButtons();
          
          // 更新tab按钮状态
          document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tabName);
          });
          
          // 更新内容区域
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(`${tabName}-content`).classList.add('active');
          
          // 加载对应数据
          if (tabName === 'sop') loadSOPs();
          else if (tabName === 'faq') loadFAQs();
          else if (tabName === 'resources') loadResources();
        }

        // SOP相关函数
        async function loadSOPs(){
          try {
            const sopsList = document.getElementById('sopsList');
            sopsList.innerHTML = '<div class="doc-card"><div class="doc-title">載入中…</div></div>';
            
            const params = buildParams(sopState);
            const res = await fetch(`${apiBase}/sop?${params}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/knowledge'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            
            const items = Array.isArray(json.data) ? json.data : [];
            sopState.total = (json.meta && json.meta.total) || items.length;
          sopsList.innerHTML = '';
            
            if (!items.length) {
              renderEmpty(sopsList, 'sop');
              document.getElementById('sopListInfo').textContent = '0 筆';
              return;
            }
            
            items.forEach(it => sopsList.appendChild(createSopCard(it)));
            updatePager('sop', sopState);
          } catch (_) {
            document.getElementById('sopsList').innerHTML = '<div class="doc-card"><div class="doc-title" style="color:#c0392b;">載入失敗</div></div>';
          }
        }

        function createSopCard(item){
          const el = document.createElement('div');
          el.className = 'doc-card';
          el.style.padding = '8px 10px';
          el.style.fontSize = '13px';
          const v = `<span class="badge" style="margin-left:6px;background:#e7f0ff;color:#1d4ed8;padding:1px 4px;border-radius:4px;font-size:10px;">v${item.version||1}</span>`;
          const id = item.id || item.sop_id;
          
          el.innerHTML = `
            <div class="doc-title" style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.title||''} ${v}</div>
          `;
          
          // 點擊卡片預覽
          el.addEventListener('click', () => viewSOP(id));
          
          return el;
        }

        // FAQ相关函数
        async function loadFAQs(){
          try {
            const faqsList = document.getElementById('faqsList');
            faqsList.innerHTML = '<div class="doc-card"><div class="doc-title">載入中…</div></div>';
            
            const params = buildParams(faqState);
            const res = await fetch(`${apiBase}/faq?${params}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/knowledge'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            
            const items = Array.isArray(json.data) ? json.data : [];
            faqState.total = (json.meta && json.meta.total) || items.length;
            faqsList.innerHTML = '';
            
            if (!items.length) {
              renderEmpty(faqsList, 'faq');
              document.getElementById('faqListInfo').textContent = '0 筆';
              return;
            }
            
            items.forEach(it => faqsList.appendChild(createFaqCard(it)));
            updatePager('faq', faqState);
          } catch (_) {
            document.getElementById('faqsList').innerHTML = '<div class="doc-card"><div class="doc-title" style="color:#c0392b;">載入失敗</div></div>';
          }
        }

        function createFaqCard(item){
          const el = document.createElement('div');
          el.className = 'doc-card';
          el.style.padding = '8px 10px';
          const id = item.faq_id;
          
          el.innerHTML = `
            <div class="doc-title" style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">❓ ${item.question||''}</div>
          `;
          
          // 點擊卡片預覽
          el.addEventListener('click', () => viewFAQ(id));
          
          return el;
        }

        // 资源中心相关函数
        async function loadResources(){
          try {
            const resourcesList = document.getElementById('resourcesList');
            if (!resourcesList) {
              console.error('[Resources] resourcesList 元素不存在');
              return;
            }
            
            resourcesList.innerHTML = '<div class="doc-card"><div class="doc-title">載入中…</div></div>';
            
            const params = buildResourceParams(resourcesState);
            console.log('[Resources] 請求參數:', params);
            const res = await fetch(`${apiBase}/documents?${params}`, { 
              credentials: 'include',
              headers: { 'Accept': 'application/json' }
            });
            console.log('[Resources] 回應狀態:', res.status, res.statusText);
            
            if (res.status === 401) { 
              location.assign('/login?redirect=/internal/knowledge'); 
              return; 
            }
            
            let json;
            try {
              const text = await res.text();
              console.log('[Resources] 原始回應:', text.substring(0, 500));
              json = JSON.parse(text);
            } catch (parseErr) {
              console.error('[Resources] JSON解析失敗:', parseErr);
              throw new Error('伺服器回應格式錯誤');
            }
            
            console.log('[Resources] 回應資料:', json);
            
            if (!json || json.ok !== true) {
              throw new Error(json?.error || json?.message || `HTTP ${res.status}: ${res.statusText}`);
            }
            
            const items = Array.isArray(json.data) ? json.data : [];
            resourcesState.total = (json.meta && json.meta.total) || items.length;
            resourcesList.innerHTML = '';
            
            if (!items.length) {
              renderEmpty(resourcesList, 'resources');
              const infoEl = document.getElementById('resourcesListInfo');
              if (infoEl) infoEl.textContent = '0 筆';
              return;
            }
            
            items.forEach(it => resourcesList.appendChild(createResourceCard(it)));
            updatePager('resources', resourcesState);
          } catch (err) {
            console.error('[Resources] 載入失敗:', err);
            const resourcesList = document.getElementById('resourcesList');
            if (resourcesList) {
              resourcesList.innerHTML = `<div class="doc-card"><div class="doc-title" style="color:#c0392b;">載入失敗</div><div class="doc-excerpt" style="font-size:11px;color:#666;">${err.message}</div></div>`;
            }
          }
        }

        function createResourceCard(item){
          const el = document.createElement('div');
          el.className = 'doc-card';
          el.style.cssText = 'padding:8px 10px;position:relative;';
          
          // 文件類型圖標
          const fileName = item.fileName || item.title || '';
          let fileIcon = '📄';
          if (fileName.match(/\.(pdf)$/i)) fileIcon = '📕';
          else if (fileName.match(/\.(doc|docx)$/i)) fileIcon = '📘';
          else if (fileName.match(/\.(xls|xlsx)$/i)) fileIcon = '📗';
          else if (fileName.match(/\.(ppt|pptx)$/i)) fileIcon = '📙';
          else if (fileName.match(/\.(jpg|jpeg|png|gif)$/i)) fileIcon = '🖼️';
          
          el.innerHTML = `
            <div class="doc-title" style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
              <span style="margin-right:6px;">${fileIcon}</span>
              ${item.title || '未命名文檔'}
            </div>
          `;
          
          // 點擊卡片預覽
          el.addEventListener('click', () => {
            previewDocument(item);
          });
          
          return el;
        }

        // 文檔預覽功能（在右側預覽區域顯示）
        let currentPreviewBlobUrl = null;
        
        window.previewDocument = async function(doc) {
          const previewArea = document.getElementById('documentPreviewArea');
          if (!previewArea) return;
          
          // 顯示工具欄的編輯和刪除按鈕
          const editBtn = document.getElementById('btn-edit');
          const deleteBtn = document.getElementById('btn-delete');
          if (editBtn) {
            editBtn.style.display = 'none'; // 資源中心不需要編輯按鈕
          }
          if (deleteBtn) {
            deleteBtn.style.display = 'block';
            deleteBtn.onclick = () => deleteDocument(doc.document_id);
          }
          
          // 清理之前的 blob URL
          if (currentPreviewBlobUrl) {
            URL.revokeObjectURL(currentPreviewBlobUrl);
            currentPreviewBlobUrl = null;
          }
          
          // 顯示載入中
          previewArea.innerHTML = `
            <div style="text-align:center;padding:60px 20px;color:#6b7280;">
              <div style="font-size:48px;margin-bottom:16px;">⏳</div>
              <div>載入中...</div>
            </div>
          `;
          
          try {
            // 構建文件URL
            const fileUrl = `${apiBase}/documents/${doc.document_id}/download`;
            
            // 獲取文件
            const res = await fetch(fileUrl, { credentials: 'include' });
            if (!res.ok) {
              throw new Error('無法載入文件');
            }
            
            const blob = await res.blob();
            const blobUrl = URL.createObjectURL(blob);
            currentPreviewBlobUrl = blobUrl;
            
            // 根據文件類型顯示預覽
            const fileType = doc.fileType || '';
            const fileName = doc.fileName || '';
            
            if (fileType.includes('pdf') || fileName.match(/\.pdf$/i)) {
              // PDF預覽 - 使用 iframe 原生控制
              previewArea.innerHTML = `
                <iframe src="${blobUrl}#view=FitH" style="width:100%;height:100%;min-height:85vh;border:none;background:white;"></iframe>
              `;
            } else if (fileType.includes('image') || fileName.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
              // 圖片預覽 - 直接顯示，使用原生右鍵功能
              previewArea.innerHTML = `
                <div style="width:100%;height:100%;min-height:85vh;display:flex;align-items:center;justify-content:center;background:#f5f5f5;">
                  <img src="${blobUrl}" style="max-width:100%;max-height:100%;object-fit:contain;" />
                </div>
              `;
            } else {
              // 其他文件類型，顯示下載提示
              previewArea.innerHTML = `
                <div style="text-align:center;padding:60px 20px;">
                  <div style="font-size:64px;margin-bottom:20px;">📄</div>
                  <h3 style="margin-bottom:12px;color:#374151;font-size:18px;">${doc.title}</h3>
                  <p style="color:#6b7280;margin-bottom:8px;font-size:13px;">${doc.fileName || ''}</p>
                  <p style="color:#9ca3af;margin-bottom:24px;font-size:13px;">此文件類型不支援線上預覽</p>
                  <a href="${blobUrl}" download="${doc.fileName || 'document'}" class="btn primary" style="text-decoration:none;">
                    <span>💾 下載文件</span>
                  </a>
                </div>
              `;
            }
          } catch (err) {
            console.error('預覽文檔失敗:', err);
            previewArea.innerHTML = `
              <div style="text-align:center;padding:60px 20px;color:#c0392b;">
                <div style="font-size:48px;margin-bottom:16px;">⚠️</div>
                <div style="font-size:16px;font-weight:600;margin-bottom:8px;">載入失敗</div>
                <div style="font-size:13px;color:#6b7280;">${err.message}</div>
              </div>
            `;
          }
        };

        // 通用函数
        function renderEmpty(container, type){
          const messages = {
            sop: '尚無 SOP，請點擊右上角「+ 新增」按鈕建立',
            faq: '尚無 FAQ，請點擊右上角「+ 新增」按鈕建立',
            resources: '尚無文檔，請點擊右上角「+ 新增」按鈕上傳'
          };
          container.innerHTML = `<div class="doc-card"><div class="doc-title">暫無資料</div><div class="doc-excerpt">${messages[type]}</div></div>`;
        }

        function updatePager(type, state){
          const listInfo = document.getElementById(`${type}ListInfo`);
          if(!listInfo) return;
          listInfo.textContent = `${state.total} 筆`;
        }

        function buildParams(state){
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          
          const q = document.getElementById('q').value.trim();
          if (q) params.set('q', q);
          
          const cat = document.getElementById('category').value;
          if (cat && cat !== 'all') params.set('category', cat);
          
          const t = document.getElementById('tags').value.split(',').map(s=>s.trim()).filter(Boolean).join(',');
          if (t) params.set('tags', t);
          
          return params.toString();
        }
        
        function buildResourceParams(state){
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          
          if (state.q) params.set('q', state.q);
          if (state.category) params.set('category', state.category);
          
          return params.toString();
        }

        function getCategoryText(cat) {
          const map = {
            accounting: '記帳流程',
            tax: '稅務流程',
            business: '工商登記',
            hr: '人事管理',
            finance: '財務管理',
            contract: '合同範本',
            internal: '內部流程',
            other: '其他'
          };
          return map[cat] || '未分類';
        }

        // Modal函数
        // 已棄用：改用內聯表單
        window.closeSopModal = function() {
          document.getElementById('sopModal').classList.remove('show');
        };

        // 已棄用：改用內聯表單
        window.closeFaqModal = function() {
          document.getElementById('faqModal').classList.remove('show');
        };


        // 面板收合功能
        window.togglePanel = function(tab) {
          const layout = document.getElementById(`${tab}-layout`);
          if (layout) {
            layout.classList.toggle('collapsed');
          }
        };
        
        // 模態框控制函數會在 selectedFile 聲明後定義
        
        // SOP CRUD functions（移除viewSOP，直接使用editSOP）
        
        // 預覽 SOP（點擊列表時）
        window.viewSOP = async function(id) {
          try {
            const res = await fetch(`${apiBase}/sop/${id}`, { credentials:'include' });
            const json = await res.json();
            if (json.ok && json.data) {
              const sop = json.data;
              const previewArea = document.getElementById('sopPreviewArea');
              if (!previewArea) return;
              
              // 顯示工具欄的編輯和刪除按鈕
              const editBtn = document.getElementById('btn-edit');
              const deleteBtn = document.getElementById('btn-delete');
              if (editBtn) {
                editBtn.style.display = 'block';
                editBtn.onclick = () => editSOP(id);
              }
              if (deleteBtn) {
                deleteBtn.style.display = 'block';
                deleteBtn.onclick = () => deleteSOP(id);
              }
              
              previewArea.innerHTML = `
                <div style="padding:20px 24px;max-width:900px;margin:0 auto;">
                  <div style="margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e5e7eb;">
                    <h1 style="margin:0 0 8px 0;font-size:18px;font-weight:600;color:#1f2937;">${sop.title || '未命名'}</h1>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;font-size:12px;color:#6b7280;">
                      <span style="padding:2px 8px;background:#f3f4f6;border-radius:8px;font-size:11px;">${getCategoryName(sop.category, 'sop')}</span>
                      ${sop.tags && sop.tags.length ? 
                        (Array.isArray(sop.tags) ? sop.tags : sop.tags.split(',')).map(tag => 
                          `<span style="padding:2px 6px;background:#eff6ff;color:#2563eb;border-radius:6px;font-size:10px;">${tag.trim()}</span>`
                        ).join('') : ''
                      }
                    </div>
                  </div>
                  <div class="ql-editor" style="padding:0;font-size:14px;line-height:1.7;color:#374151;">
                    ${sop.content || '<p style="color:#9ca3af;">暫無內容</p>'}
                  </div>
                </div>
              `;
            }
          } catch (err) {
            console.error('載入SOP失敗:', err);
            const previewArea = document.getElementById('sopPreviewArea');
            if (previewArea) {
              previewArea.innerHTML = `
                <div class="resource-preview-empty">
                  <div style="font-size:48px;margin-bottom:16px;color:#c0392b;">⚠️</div>
                  <p class="empty-text" style="color:#c0392b;">載入失敗</p>
                  <p class="empty-hint">${err.message}</p>
                </div>
              `;
            }
          }
        };
        
        // 編輯 SOP（打開抽屜）
        window.editSOP = async function(id) {
          try {
            const res = await fetch(`${apiBase}/sop/${id}`, { credentials:'include' });
            const json = await res.json();
            if (json.ok && json.data) {
              openSopDrawer(json.data);
            }
          } catch (err) {
            alert('載入SOP失敗');
          }
        };
        
        window.deleteSOP = async function(id) {
          if(!confirm('確定刪除此SOP？')) return;
          try {
            const res = await fetch(`${apiBase}/sop/${id}`, { 
              method: 'DELETE',
              credentials:'include'
            });
            const json = await res.json();
            if (json.ok) {
              alert('刪除成功');
              loadSOPs();
            } else {
              alert('刪除失敗：' + (json.error || '未知錯誤'));
            }
          } catch (err) {
            alert('刪除失敗');
          }
        };
        
        // FAQ CRUD functions
        window.viewFAQ = async function(id) {
          try {
            const res = await fetch(`${apiBase}/faq/${id}`, { credentials:'include' });
            const json = await res.json();
            if (json.ok && json.data) {
              const faq = json.data;
              
              // 填充表單為只讀模式
              document.getElementById('faq-id-inline').value = faq.faq_id;
              document.getElementById('faq-question-inline').value = faq.question || '';
              document.getElementById('faq-category-inline').value = faq.category || '';
              document.getElementById('faq-tags-inline').value = Array.isArray(faq.tags) ? faq.tags.join(', ') : '';
              
              // 設置編輯器內容並禁用
              if (faqEditor) {
                faqEditor.root.innerHTML = faq.answer || '<p>無答案</p>';
                faqEditor.enable(false);  // 設為只讀
              }
              
              // 禁用輸入欄位
              document.getElementById('faq-question-inline').disabled = true;
              document.getElementById('faq-category-inline').disabled = true;
              document.getElementById('faq-tags-inline').disabled = true;
              
              // 隱藏提交按鈕，顯示編輯按鈕
              const submitBtn = document.getElementById('faqSubmitBtnInline');
              submitBtn.style.display = 'none';
              
              // 添加編輯和返回按鈕
              let actionDiv = document.getElementById('faq-view-actions');
              if (!actionDiv) {
                actionDiv = document.createElement('div');
                actionDiv.id = 'faq-view-actions';
                actionDiv.style.display = 'flex';
                actionDiv.style.gap = '8px';
                actionDiv.innerHTML = `
                  <button type="button" class="btn btn-primary" onclick="editFAQ(${faq.faq_id})">
                    <span>✏️ 編輯</span>
                  </button>
                  <button type="button" class="btn" onclick="resetFaqForm()">
                    <span>↩️ 返回新增</span>
                  </button>
                `;
                submitBtn.parentNode.insertBefore(actionDiv, submitBtn);
              } else {
                actionDiv.style.display = 'flex';
                actionDiv.innerHTML = `
                  <button type="button" class="btn btn-primary" onclick="editFAQ(${faq.faq_id})">
                    <span>✏️ 編輯</span>
                  </button>
                  <button type="button" class="btn" onclick="resetFaqForm()">
                    <span>↩️ 返回新增</span>
                  </button>
                `;
              }
              
              // 聚焦到問題欄位（雖然禁用，但可以看到內容）
              document.getElementById('faq-question-inline').focus();
            } else {
              alert('載入失敗：' + (json.error || '未知錯誤'));
            }
          } catch (err) {
            alert('載入FAQ失敗：未知錯誤');
          }
        };
        
        // 預覽 FAQ（點擊列表時）
        window.viewFAQ = async function(id) {
          try {
            const res = await fetch(`${apiBase}/faq/${id}`, { credentials:'include' });
            const json = await res.json();
            if (json.ok && json.data) {
              const faq = json.data;
              const previewArea = document.getElementById('faqPreviewArea');
              if (!previewArea) return;
              
              // 顯示工具欄的編輯和刪除按鈕
              const editBtn = document.getElementById('btn-edit');
              const deleteBtn = document.getElementById('btn-delete');
              if (editBtn) {
                editBtn.style.display = 'block';
                editBtn.onclick = () => editFAQ(id);
              }
              if (deleteBtn) {
                deleteBtn.style.display = 'block';
                deleteBtn.onclick = () => deleteFAQ(id);
              }
              
              previewArea.innerHTML = `
                <div style="padding:20px 24px;max-width:900px;margin:0 auto;">
                  <div style="margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e5e7eb;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
                      <span style="font-size:20px;line-height:1;">❓</span>
                      <h1 style="margin:0;font-size:18px;font-weight:600;color:#1f2937;flex:1;">${faq.question || '未命名問題'}</h1>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;font-size:12px;color:#6b7280;margin-left:30px;">
                      <span style="padding:2px 8px;background:#f3f4f6;border-radius:8px;font-size:11px;">${getCategoryName(faq.category, 'faq')}</span>
                      ${faq.tags && faq.tags.length ? 
                        (Array.isArray(faq.tags) ? faq.tags : faq.tags.split(',')).map(tag => 
                          `<span style="padding:2px 6px;background:#fef3c7;color:#d97706;border-radius:6px;font-size:10px;">${tag.trim()}</span>`
                        ).join('') : ''
                      }
                    </div>
                  </div>
                  <div style="margin-left:30px;">
                    <h3 style="margin:0 0 10px 0;font-size:14px;font-weight:600;color:#059669;">💡 回答</h3>
                    <div class="ql-editor" style="padding:0;font-size:14px;line-height:1.7;color:#374151;">
                      ${faq.answer || '<p style="color:#9ca3af;">暫無回答</p>'}
                    </div>
                  </div>
                </div>
              `;
            }
          } catch (err) {
            console.error('載入FAQ失敗:', err);
            const previewArea = document.getElementById('faqPreviewArea');
            if (previewArea) {
              previewArea.innerHTML = `
                <div class="resource-preview-empty">
                  <div style="font-size:48px;margin-bottom:16px;color:#c0392b;">⚠️</div>
                  <p class="empty-text" style="color:#c0392b;">載入失敗</p>
                  <p class="empty-hint">${err.message}</p>
                </div>
              `;
            }
          }
        };
        
        // 編輯 FAQ（打開抽屜）
        window.editFAQ = async function(id) {
          try {
            const res = await fetch(`${apiBase}/faq/${id}`, { credentials:'include' });
            const json = await res.json();
            if (json.ok && json.data) {
              openFaqDrawer(json.data);
            }
          } catch (err) {
            alert('載入FAQ失敗');
          }
        };
        
        window.deleteFAQ = async function(id) {
          if(!confirm('確定刪除此FAQ？')) return;
          try {
            const res = await fetch(`${apiBase}/faq/${id}`, { 
              method: 'DELETE',
              credentials:'include'
            });
            const json = await res.json();
            if (json.ok) {
              alert('刪除成功');
              loadFAQs();
            } else {
              alert('刪除失敗：' + (json.error || '未知錯誤'));
            }
          } catch (err) {
            alert('刪除失敗');
          }
        };
        
        // Resource CRUD functions
        window.deleteResource = async function(id) {
          if(!confirm('確定刪除此文檔？刪除後將無法恢復。')) return;
          try {
            const res = await fetch(`${apiBase}/documents/${id}`, { 
              method: 'DELETE',
              credentials:'include'
            });
            const json = await res.json();
            if (json.ok) {
              alert('刪除成功');
              
              // 清空預覽區域
              const previewArea = document.getElementById('documentPreviewArea');
              if (previewArea) {
                previewArea.innerHTML = `
                  <div class="resource-preview-empty">
                    <div class="empty-icon">📂</div>
                    <p class="empty-text">點擊左側文檔查看詳情</p>
                    <p class="empty-hint">支援線上預覽 PDF、圖片等格式</p>
                  </div>
                `;
              }
              
              // 清理 blob URL
              if (currentPreviewBlobUrl) {
                URL.revokeObjectURL(currentPreviewBlobUrl);
                currentPreviewBlobUrl = null;
              }
              
              // 重新載入列表
              loadResources();
            } else {
              alert('刪除失敗：' + (json.error || '未知錯誤'));
            }
          } catch (err) {
            alert('刪除失敗');
          }
        };
        
        // deleteDocument 別名（用於預覽頁面）
        window.deleteDocument = window.deleteResource;

        // 事件绑定
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });

        document.getElementById('btn-new').addEventListener('click', () => {
          if (currentTab === 'sop') {
            // 打開 SOP 編輯抽屜（新增模式）
            openSopDrawer(null);
          } else if (currentTab === 'faq') {
            // 打開 FAQ 編輯抽屜（新增模式）
            openFaqDrawer(null);
          } else if (currentTab === 'resources') {
            // 打開上傳抽屜
            openUploadDocModal();
          }
        });

        // 搜索和筛选
        let timer=null;
        document.getElementById('q').addEventListener('input', ()=>{ 
          clearTimeout(timer); 
          timer=setTimeout(()=>{ 
            sopState.page=1; 
            faqState.page=1; 
            resourcesState.page=1; 
            if (currentTab === 'sop') loadSOPs();
            else if (currentTab === 'faq') loadFAQs();
            else if (currentTab === 'resources') loadResources();
          }, 300); 
        });
        
        document.getElementById('category').addEventListener('change', ()=>{ 
          sopState.page=1; 
          faqState.page=1; 
          resourcesState.page=1; 
          if (currentTab === 'sop') loadSOPs();
          else if (currentTab === 'faq') loadFAQs();
          else if (currentTab === 'resources') loadResources();
        });
        
        document.getElementById('tags').addEventListener('change', ()=>{ 
          sopState.page=1; 
          faqState.page=1; 
          resourcesState.page=1; 
          if (currentTab === 'sop') loadSOPs();
          else if (currentTab === 'faq') loadFAQs();
          else if (currentTab === 'resources') loadResources();
        });

        // 分页按钮
        document.getElementById('sop-prev').addEventListener('click', ()=>{ if (sopState.page>1){ sopState.page--; loadSOPs(); } });
        document.getElementById('sop-next').addEventListener('click', ()=>{ sopState.page++; loadSOPs(); });
        document.getElementById('faq-prev').addEventListener('click', ()=>{ if (faqState.page>1){ faqState.page--; loadFAQs(); } });
        document.getElementById('faq-next').addEventListener('click', ()=>{ faqState.page++; loadFAQs(); });
        document.getElementById('resources-prev').addEventListener('click', ()=>{ if (resourcesState.page>1){ resourcesState.page--; loadResources(); } });
        document.getElementById('resources-next').addEventListener('click', ()=>{ resourcesState.page++; loadResources(); });

        // 資源搜索和篩選
        let resourcesSearchTimer = null;
        const resourcesSearchEl = document.getElementById('resources-search');
        const resourcesCategoryFilterEl = document.getElementById('resources-category-filter');
        
        if (resourcesSearchEl) {
          resourcesSearchEl.addEventListener('input', (e) => {
            clearTimeout(resourcesSearchTimer);
            resourcesSearchTimer = setTimeout(() => {
              resourcesState.q = e.target.value.trim();
              resourcesState.page = 1;
              loadResources();
            }, 300);
          });
        }
        
        if (resourcesCategoryFilterEl) {
          resourcesCategoryFilterEl.addEventListener('change', (e) => {
            resourcesState.category = e.target.value;
            resourcesState.page = 1;
            loadResources();
          });
        }

        // 文件上传 - selectedFile 必須在這裡聲明
        let selectedFile = null;
        const fileUploadAreaModal = document.getElementById('fileUploadAreaModal');
        const fileInputModal = document.getElementById('file-input-modal');

        // 模態框控制函數（現在可以安全訪問 selectedFile）
        window.resetUploadForm = function() {
          const form = document.getElementById('resourceFormModal');
          if (form) form.reset();
          selectedFile = null;
          const info = document.getElementById('uploadedFileInfoModal');
          if (info) info.style.display = 'none';
        };
        
        window.closeUploadDocModal = function() {
          const drawer = document.getElementById('uploadDocModal');
          const overlay = document.getElementById('drawerOverlay');
          if (drawer) drawer.classList.remove('show');
          if (overlay) overlay.classList.remove('show');
          setTimeout(() => resetUploadForm(), 300);
        };
        
        // 標籤庫（可擴展）
        let availableTags = [
          '重要', '範本', '參考', '內部', '客戶',
          '財務', '稅務', '人事', '合同', '法規',
          '常見', '緊急', '月結', '報稅', '記帳'
        ];
        
        // 從 localStorage 載入自訂標籤
        function loadCustomTags() {
          const saved = localStorage.getItem('customTags');
          if (saved) {
            try {
              const customTags = JSON.parse(saved);
              // 合併並去重
              availableTags = [...new Set([...availableTags, ...customTags])];
            } catch (e) {
              console.error('載入自訂標籤失敗:', e);
            }
          }
          availableTags.sort(); // 排序
        }
        
        // 載入標籤按鈕（按鈕式標籤選擇器）
        function loadTagCheckboxes(containerId, selectedTags = []) {
          const container = document.getElementById(containerId);
          if (!container) return;
          
          container.innerHTML = '';
          availableTags.forEach(tag => {
            const button = document.createElement('button');
            button.type = 'button';
            button.textContent = tag;
            button.dataset.tag = tag;
            
            const isSelected = selectedTags.includes(tag);
            button.className = isSelected ? 'tag-btn selected' : 'tag-btn';
            
            // 點擊切換選中狀態
            button.onclick = function(e) {
              e.preventDefault();
              e.stopPropagation();
              this.classList.toggle('selected');
            };
            
            container.appendChild(button);
          });
        }
        
        // 載入篩選下拉選單的標籤選項
        function loadFilterTagOptions() {
          const select = document.getElementById('tags');
          if (!select) return;
          
          // 保留第一個「全部標籤」選項
          const currentValue = select.value;
          select.innerHTML = '<option value="">全部標籤</option>';
          
          availableTags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            option.textContent = tag;
            select.appendChild(option);
          });
          
          select.value = currentValue;
        }
        
        // 新增標籤
        window.addNewTag = function(type) {
          const newTag = prompt('請輸入新標籤名稱：');
          if (!newTag || !newTag.trim()) return;
          
          const tagName = newTag.trim();
          
          // 檢查是否已存在
          if (availableTags.includes(tagName)) {
            alert('此標籤已存在！');
            return;
          }
          
          // 添加到標籤庫
          availableTags.push(tagName);
          availableTags.sort();
          
          // 保存到 localStorage
          localStorage.setItem('customTags', JSON.stringify(availableTags));
          
          // 重新載入對應的複選框，並自動選中新標籤
          if (type === 'resource') {
            loadTagCheckboxes('resource-tags-checkboxes', [tagName]);
          } else if (type === 'sop') {
            const currentChecked = getCheckedTags('sop-tags-checkboxes');
            loadTagCheckboxes('sop-tags-checkboxes', [...currentChecked, tagName]);
          } else if (type === 'faq') {
            const currentChecked = getCheckedTags('faq-tags-checkboxes');
            loadTagCheckboxes('faq-tags-checkboxes', [...currentChecked, tagName]);
          }
          
          // 更新篩選下拉選單
          loadFilterTagOptions();
        };
        
        // 獲取已選中的標籤
        function getCheckedTags(containerId) {
          const container = document.getElementById(containerId);
          if (!container) return [];
          
          const selectedButtons = container.querySelectorAll('.tag-btn.selected');
          return Array.from(selectedButtons).map(btn => btn.dataset.tag);
        }
        
        window.openUploadDocModal = function() {
          const drawer = document.getElementById('uploadDocModal');
          const overlay = document.getElementById('drawerOverlay');
          if (drawer) drawer.classList.add('show');
          if (overlay) overlay.classList.add('show');
          
          // 載入標籤選項
          loadCustomTags();
          loadTagCheckboxes('resource-tags-checkboxes');
        };
        
        // SOP 固定模板
        const SOP_TEMPLATE = `
          <h2>📋 作業目的</h2>
          <p>說明此流程的目標與重要性...</p>
          
          <h2>👥 適用對象</h2>
          <p>此流程適用於：會計部門全體同仁 / 特定職位...</p>
          
          <h2>📝 作業流程</h2>
          <h3>步驟一：準備階段</h3>
          <ul>
            <li>檢查所需文件是否齊全</li>
            <li>確認系統權限與工具</li>
            <li>預估所需時間：約 XX 分鐘</li>
          </ul>
          
          <h3>步驟二：執行階段</h3>
          <ol>
            <li>登入系統並選擇對應功能</li>
            <li>依序填寫必填欄位</li>
            <li>檢查資料正確性</li>
            <li>提交並保存記錄</li>
          </ol>
          
          <h3>步驟三：確認階段</h3>
          <ul>
            <li>核對結果是否符合預期</li>
            <li>通知相關人員</li>
            <li>歸檔相關文件</li>
          </ul>
          
          <h2>⚠️ 注意事項</h2>
          <ul>
            <li><strong>重要：</strong>務必在每月 X 日前完成</li>
            <li>若遇到錯誤，請聯繫 XXX（分機 XXX）</li>
            <li>相關表單存放位置：共享資料夾 / XXX 路徑</li>
          </ul>
          
          <h2>📞 相關聯絡人</h2>
          <p>負責人：XXX（分機 XXX）<br>覆核人：XXX（分機 XXX）</p>
          
          <h2>📎 相關文件</h2>
          <ul>
            <li>表單範本連結</li>
            <li>系統操作手冊連結</li>
          </ul>
        `.trim();
        
        // SOP 抽屜控制
        window.openSopDrawer = function(sopData = null) {
          const drawer = document.getElementById('sopEditDrawer');
          const overlay = document.getElementById('drawerOverlay');
          if (!drawer || !overlay) return;
          
          // 如果是新增模式（sopData 為 null），使用模板
          if (!sopData) {
            document.getElementById('sop-id-drawer').value = '';
            document.getElementById('sop-title-drawer').value = '【請填寫標題】例如：月度記帳流程';
            document.getElementById('sop-category-drawer').value = '';
            
            if (window.sopDrawerEditor) {
              window.sopDrawerEditor.root.innerHTML = SOP_TEMPLATE;
            }
            
            // 載入標籤複選框（新增時不選中任何標籤）
            loadCustomTags();
            loadTagCheckboxes('sop-tags-checkboxes', []);
          } else {
            // 編輯模式：填充現有數據
            document.getElementById('sop-id-drawer').value = sopData.sop_id || '';
            document.getElementById('sop-title-drawer').value = sopData.title || '';
            document.getElementById('sop-category-drawer').value = sopData.category || '';
            
            if (window.sopDrawerEditor) {
              window.sopDrawerEditor.root.innerHTML = sopData.content || '';
            }
            
            // 載入標籤複選框（編輯時選中已有標籤）
            const existingTags = Array.isArray(sopData.tags) ? sopData.tags : (sopData.tags ? sopData.tags.split(',').map(t => t.trim()) : []);
            loadCustomTags();
            loadTagCheckboxes('sop-tags-checkboxes', existingTags);
          }
          
          drawer.classList.add('show');
          overlay.classList.add('show');
          overlay.onclick = closeSopDrawer;
        };
        
        window.closeSopDrawer = function() {
          const drawer = document.getElementById('sopEditDrawer');
          const overlay = document.getElementById('drawerOverlay');
          if (drawer) drawer.classList.remove('show');
          if (overlay) {
            overlay.classList.remove('show');
            overlay.onclick = null;
          }
        };
        
        // FAQ 固定模板
        const FAQ_TEMPLATE = `
          <h3>💡 簡短回答</h3>
          <p>用一到兩句話簡單回答這個問題...</p>
          
          <h3>📖 詳細說明</h3>
          <p><strong>情境說明：</strong></p>
          <p>這個問題通常發生在什麼情況下...</p>
          
          <p><strong>解決方案：</strong></p>
          <ol>
            <li>第一步：具體操作步驟</li>
            <li>第二步：相關設定或確認事項</li>
            <li>第三步：驗證結果</li>
          </ol>
          
          <h3>💼 實際案例</h3>
          <p><em>例如：</em>某客戶在報稅時遇到 XXX 問題，我們透過 YYY 方式解決...</p>
          
          <h3>⚠️ 注意事項</h3>
          <ul>
            <li>特別提醒：XXX 情況下需要額外注意...</li>
            <li>常見錯誤：避免 XXX 操作</li>
          </ul>
          
          <h3>🔗 相關資源</h3>
          <ul>
            <li>相關 SOP 連結或文件</li>
            <li>法規參考或官方網站</li>
            <li>內部聯絡人：XXX（分機 XXX）</li>
          </ul>
          
          <hr>
          <p style="color:#6b7280;font-size:14px;"><em>最後更新：請在儲存前填寫當前日期</em></p>
        `.trim();
        
        // FAQ 抽屜控制
        window.openFaqDrawer = function(faqData = null) {
          const drawer = document.getElementById('faqEditDrawer');
          const overlay = document.getElementById('drawerOverlay');
          if (!drawer || !overlay) return;
          
          // 如果是新增模式（faqData 為 null），使用模板
          if (!faqData) {
            document.getElementById('faq-id-drawer').value = '';
            document.getElementById('faq-question-drawer').value = '【請填寫問題】例如：如何處理跨月份的發票？';
            document.getElementById('faq-category-drawer').value = '';
            
            if (window.faqDrawerEditor) {
              window.faqDrawerEditor.root.innerHTML = FAQ_TEMPLATE;
            }
            
            // 載入標籤複選框（新增時預選「常見」和「重要」）
            loadCustomTags();
            loadTagCheckboxes('faq-tags-checkboxes', ['常見', '重要']);
          } else {
            // 編輯模式：填充現有數據
            document.getElementById('faq-id-drawer').value = faqData.faq_id || '';
            document.getElementById('faq-question-drawer').value = faqData.question || '';
            document.getElementById('faq-category-drawer').value = faqData.category || '';
            
            if (window.faqDrawerEditor) {
              window.faqDrawerEditor.root.innerHTML = faqData.answer || '';
            }
            
            // 載入標籤複選框（編輯時選中已有標籤）
            const existingTags = Array.isArray(faqData.tags) ? faqData.tags : (faqData.tags ? faqData.tags.split(',').map(t => t.trim()) : []);
            loadCustomTags();
            loadTagCheckboxes('faq-tags-checkboxes', existingTags);
          }
          
          drawer.classList.add('show');
          overlay.classList.add('show');
          overlay.onclick = closeFaqDrawer;
        };
        
        window.closeFaqDrawer = function() {
          const drawer = document.getElementById('faqEditDrawer');
          const overlay = document.getElementById('drawerOverlay');
          if (drawer) drawer.classList.remove('show');
          if (overlay) {
            overlay.classList.remove('show');
            overlay.onclick = null;
          }
        };

        if (fileUploadAreaModal && fileInputModal) {
          fileUploadAreaModal.addEventListener('click', () => fileInputModal.click());
          
          fileInputModal.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
              selectedFile = e.target.files[0];
              displayFileInfo(selectedFile);
            }
          });

          fileUploadAreaModal.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadAreaModal.style.borderColor = '#2563eb';
            fileUploadAreaModal.style.background = '#eff6ff';
          });

          fileUploadAreaModal.addEventListener('dragleave', () => {
            fileUploadAreaModal.style.borderColor = '';
            fileUploadAreaModal.style.background = '';
          });

          fileUploadAreaModal.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadAreaModal.style.borderColor = '';
            fileUploadAreaModal.style.background = '';
            if (e.dataTransfer.files.length > 0) {
              selectedFile = e.dataTransfer.files[0];
              fileInputModal.files = e.dataTransfer.files;
              displayFileInfo(selectedFile);
            }
          });
        }

        function displayFileInfo(file) {
          document.getElementById('fileNameModal').textContent = file.name;
          document.getElementById('fileSizeModal').textContent = `大小：${(file.size / 1024).toFixed(1)} KB`;
          document.getElementById('uploadedFileInfoModal').style.display = 'block';
          
          // 自动填充标题（如果为空）
          if (!document.getElementById('resource-title-modal').value) {
            document.getElementById('resource-title-modal').value = file.name.split('.')[0];
          }
        }

        // Form提交（placeholder）
        // SOP Form提交
        // SOP 抽屜表單提交
        document.getElementById('sopFormDrawer').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          if (!window.sopDrawerEditor) {
            alert('編輯器未初始化，請重試');
            return;
          }
          
          const sopId = document.getElementById('sop-id-drawer').value;
          const title = document.getElementById('sop-title-drawer').value;
          const category = document.getElementById('sop-category-drawer').value;
          const tags = getCheckedTags('sop-tags-checkboxes');
          const content = window.sopDrawerEditor.root.innerHTML;
          
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span>處理中...</span>';
          
          try {
            const method = sopId ? 'PUT' : 'POST';
            const url = sopId ? `${apiBase}/sop/${sopId}` : `${apiBase}/sop`;
            
            const res = await fetch(url, {
              method,
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ title, category, tags, content })
            });
            
            const json = await res.json();
            if (json.ok) {
              alert(sopId ? '更新成功' : '新增成功');
              closeSopDrawer();
              loadSOPs();
              // 如果是新增或已有預覽，自動預覽新內容
              if (json.data && json.data.sop_id) {
                viewSOP(json.data.sop_id);
              }
            } else {
              alert('保存失敗：' + (json.error || '未知錯誤'));
            }
          } catch (err) {
            alert('保存失敗');
            console.error(err);
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        });

        // FAQ 抽屜表單提交
        document.getElementById('faqFormDrawer').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          if (!window.faqDrawerEditor) {
            alert('編輯器未初始化，請重試');
            return;
          }
          
          const faqId = document.getElementById('faq-id-drawer').value;
          const question = document.getElementById('faq-question-drawer').value;
          const category = document.getElementById('faq-category-drawer').value;
          const tags = getCheckedTags('faq-tags-checkboxes');
          const answer = window.faqDrawerEditor.root.innerHTML;
          
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span>處理中...</span>';
          
          try {
            const method = faqId ? 'PUT' : 'POST';
            const url = faqId ? `${apiBase}/faq/${faqId}` : `${apiBase}/faq`;
            
            const res = await fetch(url, {
              method,
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ question, category, tags, answer })
            });
            
            const json = await res.json();
            if (json.ok) {
              alert(faqId ? '更新成功' : '新增成功');
              closeFaqDrawer();
              loadFAQs();
              // 如果是新增或已有預覽，自動預覽新內容
              if (json.data && json.data.faq_id) {
                viewFAQ(json.data.faq_id);
              }
            } else {
              alert('保存失敗：' + (json.error || '未知錯誤'));
            }
          } catch (err) {
            alert('保存失敗');
            console.error(err);
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
          }
        });

        // 资源上传Form提交
        document.getElementById('resourceFormModal').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          if (!selectedFile) {
            alert('請選擇要上傳的文件');
            return;
          }
          
          const submitBtn = document.getElementById('resourceSubmitBtnModal');
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span>⏳ 上傳中...</span>';
          
          const title = document.getElementById('resource-title-modal').value;
          const category = document.getElementById('resource-category-modal').value;
          
          // 從複選框獲取選中的標籤
          const selectedTags = getCheckedTags('resource-tags-checkboxes');
          const tags = selectedTags.join(',');
          
          try {
            // 使用 FormData 一步完成上传
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('title', title);
            formData.append('category', category);
            formData.append('tags', tags);
            
            const uploadRes = await fetch(`${apiBase}/documents/upload`, {
              method: 'POST',
              credentials: 'include',
              body: formData
            });
            
            const uploadJson = await uploadRes.json();
            if (uploadJson.ok) {
              alert('上傳成功！');
              closeUploadDocModal();
              loadResources();
            } else {
              alert('上傳失敗：' + (uploadJson.error || '未知錯誤'));
            }
          } catch (err) {
            alert('上傳失敗：' + err.message);
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>📤 上傳文檔</span>';
          }
        });

        // 初始化
        ensureSession().then(async ok => { 
          if (ok) {
            // 確保所有模態框初始狀態為隱藏
            document.querySelectorAll('.modal').forEach(modal => {
              modal.classList.remove('show');
            });
            
            // 先等待 Quill 和表格模組載入
            try {
              await waitForQuillAndTable();
              console.log('✅ 所有編輯器資源載入完成，開始初始化編輯器');
              
              // 立即初始化編輯器（頁面模式已移除，現在只初始化抽屜編輯器）
              await Promise.all([
                initSopDrawerEditor(),
                initFaqDrawerEditor()
              ]);
              
              console.log('✅ 編輯器初始化完成');
            } catch (e) {
              console.error('❌ 編輯器初始化失敗:', e);
              
              // 顯示詳細錯誤訊息
              const errorMsg = `編輯器載入失敗\n\n可能原因：\n1. 網路連線問題\n2. CDN 服務暫時無法訪問\n3. 防火牆或廣告攔截器\n\n建議：\n1. 檢查網路連線\n2. 關閉廣告攔截器\n3. 刷新頁面重試\n\n技術詳情：${e.message}`;
              alert(errorMsg);
            }
            
            // 載入標籤庫並初始化篩選下拉選單
            loadCustomTags();
            loadFilterTagOptions();
            
            // 切換到 SOP 標籤
            switchTab('sop');
          }
        });
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>
