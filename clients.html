<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="å®¢æˆ¶ç®¡ç†åˆ—è¡¨" />
    <title>å®¢æˆ¶ç®¡ç†ï½œåˆ—è¡¨</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/internal-system.css?v=3" />
    <link rel="stylesheet" href="/assets/css/internal-components.css?v=3" />
    <link rel="stylesheet" href="/assets/css/clients-page.css?v=9" />
    
    <!-- âš¡ é åŠ è¼‰ç³»çµ±ï¼ˆå®¢æˆ·é¡µé¢ç¦ç”¨ç¼“å­˜ï¼‰ -->
    <script>
    // âŒ å®¢æˆ·åˆ—è¡¨é¡µé¢å®Œå…¨ç¦ç”¨ç¼“å­˜ç³»ç»Ÿ
    // åŸå› ï¼šå®¢æˆ·æ•°æ®ç»å¸¸å˜æ›´ï¼Œç¼“å­˜ä¼šå¯¼è‡´çœ‹ä¸åˆ°æœ€æ–°æ•°æ®
    console.log('[Clients] â„¹ï¸ å®¢æˆ·åˆ—è¡¨é¡µé¢å·²ç¦ç”¨æ‰€æœ‰ç¼“å­˜åŠŸèƒ½');
    
    // ç¦ç”¨ DataCache é¢„åŠ è½½
    window.__DISABLE_DATA_CACHE__ = true;
    
    // ç¦ç”¨ fetch-interceptor æ‹¦æˆª
    window.__DISABLE_FETCH_INTERCEPTOR__ = true;
    
    // é¡µé¢åŠ è½½æ—¶æ¸…é™¤æ‰€æœ‰å®¢æˆ·ç›¸å…³ç¼“å­˜
    document.addEventListener('DOMContentLoaded', function() {
      const clientsCacheKeys = [
        'clients_page1', 'clients_page2', 'clients_page3', 
        'clients_page4', 'clients_page5', 'clients_all'
      ];
      
      clientsCacheKeys.forEach(key => {
        localStorage.removeItem(`cache_${key}`);
      });
      
      console.log('[Clients] âœ“ å·²æ¸…é™¤æ‰€æœ‰å®¢æˆ·ç¼“å­˜');
    });
    </script>
  </head>
  <body class="clients-page">
    <main class="clients-content" style="padding: 20px;">
      <section class="clients-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 16px; flex-wrap: wrap;">
          <div style="display: flex; gap: 12px; align-items: center; flex: 1;">
            <div class="clients-search" style="flex: 1; max-width: 400px;">
              <input id="q" type="search" placeholder="æœå°‹å…¬å¸åç¨±æˆ–çµ±ç·¨â€¦" aria-label="æœå°‹" />
            </div>
            <select id="tag-filter" style="padding: 10px 14px; border: 1px solid rgba(15,23,42,0.15); border-radius: 8px; font-size: 14px; background: white; color: #374151; cursor: pointer;">
              <option value="">å…¨éƒ¨æ¨™ç±¤</option>
            </select>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <div id="batch-actions" style="display:none;gap:8px;">
              <button id="btn-batch-assign" class="clients-btn btn-secondary" type="button">æ‰¹é‡åˆ†é…è² è²¬äºº</button>
              <button id="btn-cancel-select" class="clients-btn btn-secondary" type="button">å–æ¶ˆé¸æ“‡</button>
            </div>
          <button id="btn-debug-toggle" class="clients-btn btn-secondary" type="button">ğŸ§ª èª¿è©¦</button>
            <button onclick="window.location.href='/internal/client-new'" class="clients-btn" type="button">+ æ–°å¢å®¢æˆ¶</button>
          </div>
        </div>
        
        <p id="clients-error" style="color:#c0392b;min-height:1.25rem;margin:0 0 8px 0;"></p>
        <!-- ğŸ§ª èª¿è©¦é¢æ¿ï¼ˆé è¨­éš±è—ï¼‰ -->
        <div id="debug-panel" hidden style="margin:8px 0 16px 0;padding:12px 14px;border:1px dashed #c9a227;border-radius:8px;background:#fff8e1;color:#4d3b00;">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
            <div style="font-weight:600;">ğŸ§ª èª¿è©¦è³‡è¨Š</div>
            <button id="btn-debug-clear" class="clients-btn btn-secondary" type="button">æ¸…é™¤æœå‹™ç«¯å®¢æˆ¶å¿«å–</button>
            <button id="btn-debug-dbcheck" class="clients-btn btn-secondary" type="button">è³‡æ–™åº«æª¢æŸ¥</button>
            <button id="btn-debug-reload" class="clients-btn btn-secondary" type="button">é‡æ–°è¼‰å…¥</button>
          </div>
          <div id="debug-summary" style="font-size:13px;line-height:1.6;white-space:pre-wrap;"></div>
          <div id="debug-list" style="margin-top:8px;max-height:200px;overflow:auto;font-size:13px;background:#fff;border:1px solid #ecd9a3;border-radius:6px;padding:8px;"></div>
        </div>
        <div id="empty" class="clients-empty" hidden>
          <p>å°šç„¡å®¢æˆ¶</p>
          <p><button onclick="window.location.href='/internal/client-new'" class="clients-btn" type="button">æ–°å¢å®¢æˆ¶</button></p>
        </div>
        <div class="clients-table-wrap">
          <table class="clients-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="select-all" aria-label="å…¨é¸" /></th>
                <th>å…¬å¸åç¨±</th>
                <th>çµ±ä¸€ç·¨è™Ÿ</th>
                <th>è¯çµ¡äºº</th>
                <th>è² è²¬äºº</th>
                <th>æ¨™ç±¤</th>
                <th>æœå‹™æ•¸é‡</th>
                <th>å…¨å¹´æ”¶è²»ç¸½é¡</th>
                <th>é›»è©±</th>
                <th>Email</th>
                <th>å»ºç«‹æ™‚é–“</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- å‹•æ…‹è¼‰å…¥ -->
            </tbody>
          </table>
        </div>
        <div class="clients-pagination" id="pager" hidden>
          <button type="button" id="prev">ä¸Šä¸€é </button>
          <button type="button" id="next">ä¸‹ä¸€é </button>
        </div>
      </section>
    </main>

    <!-- æ‰¹é‡åˆ†é…è² è²¬äººå½ˆçª— -->
    <div class="modal-overlay" id="batchAssignModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal" role="document">
        <div class="modal__header">
          <h2 class="modal__title">æ‰¹é‡åˆ†é…è² è²¬äºº</h2>
          <button class="modal__close" type="button" id="btn-batch-assign-close">âœ•</button>
        </div>
        <div class="modal__body">
          <form id="batchAssignForm" class="form-grid">
            <div class="field" style="grid-column:1 / -1;">
              <label>å·²é¸æ“‡ <strong id="batch-count">0</strong> å€‹å®¢æˆ¶</label>
              <div id="batch-clients-list" style="margin-top:8px;padding:12px;background:#f8f9fa;border-radius:6px;max-height:200px;overflow-y:auto;"></div>
            </div>
            <div class="field" style="grid-column:1 / -1;">
              <label for="batch_assignee">æ–°çš„è² è²¬äººå“¡ï¼ˆå¿…å¡«ï¼‰</label>
              <select id="batch_assignee" name="assignee_user_id" required>
                <option value="1">1 ç®¡ç†å“¡</option>
              </select>
              <div class="field__error" id="batch_e_assignee"></div>
            </div>
            <div class="modal__actions" style="grid-column:1 / -1;">
              <button class="clients-btn btn-secondary" type="button" id="btn-batch-assign-cancel">å–æ¶ˆ</button>
              <button class="clients-btn" type="submit" id="btn-batch-assign-submit">æ‰¹é‡åˆ†é…</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
        const qEl = document.getElementById('q');
        const tbody = document.getElementById('tbody');
        const emptyEl = document.getElementById('empty');
        const pager = document.getElementById('pager');
        const errEl = document.getElementById('clients-error');
        const debugPanel = document.getElementById('debug-panel');
        const debugSummaryEl = document.getElementById('debug-summary');
        const debugListEl = document.getElementById('debug-list');
        const debugClearBtn = document.getElementById('btn-debug-clear');
        const debugReloadBtn = document.getElementById('btn-debug-reload');
        const debugDbCheckBtn = document.getElementById('btn-debug-dbcheck');

        function setError(msg){ if (errEl) errEl.textContent = msg || ''; }

        // ğŸ§ª èª¿è©¦è³‡è¨Šç‹€æ…‹
        let lastDebug = { loadedAt: '', durationMs: 0, cacheSource: '', requestId: '', total: 0, list: [] };

        let lastDbDiagMap = {};

        function renderDebugPanel() {
          if (!debugPanel) return;
          const { loadedAt, durationMs, cacheSource, requestId, total, list } = lastDebug;
          const cacheText = cacheSource ? cacheSource : 'db';
          const totalYear = list.reduce((s, i) => s + (Number(i.year_total || 0) || 0), 0);
          const totalSvc = list.reduce((s, i) => s + (Number(i.services_count || 0) || 0), 0);
          debugSummaryEl.textContent = `è¼‰å…¥æ™‚é–“: ${loadedAt}\nè€—æ™‚: ${durationMs} ms\nä¾†æº: ${cacheText}${requestId ? `\nè«‹æ±‚ID: ${requestId}` : ''}\nç­†æ•¸: ${total}\nåˆè¨ˆæœå‹™æ•¸: ${totalSvc}\nå…¨å¹´æ”¶è²»åˆè¨ˆ: ${totalYear.toLocaleString()}`;
          const lines = list.map(item => {
            const tags = Array.isArray(item.tags) ? item.tags.filter(Boolean).join(', ') : '';
            const db = lastDbDiagMap[item.clientId];
            const dbPart = db ? ` || DB: æ¨™ç±¤:${db.tag_count} æœå‹™:${db.services_count} å¹´é¡:${Number(db.year_total||0).toLocaleString()}` : '';
            return `â€¢ ${item.companyName}ï¼ˆ${item.clientId}ï¼‰â†’ ${item.assigneeName || 'æœªåˆ†é…'} | æ¨™ç±¤: ${tags || 'ç„¡'} | æœå‹™: ${item.services_count || 0} | å¹´é¡: ${Number(item.year_total||0).toLocaleString()}${dbPart}`;
          });
          debugListEl.textContent = lines.join('\n');
        }

        // åŠ è½½å‘˜å·¥åˆ—è¡¨å¹¶å¡«å……ä¸‹æ‹‰é€‰å•
        let employeesList = [];
        async function loadEmployees() {
          try {
            const res = await fetch(`${apiBase}/users`, {
              method: 'GET',
              credentials: 'include'
            });
            const json = await res.json();
            console.log('[Clients][API meta]:', json.meta);
            if (json.ok && Array.isArray(json.data)) {
              employeesList = json.data;
              populateEmployeeSelects();
            }
          } catch (err) {
            console.error('åŠ è½½å‘˜å·¥åˆ—è¡¨å¤±è´¥', err);
          }
        }
        
        // åŠ è½½æ ‡ç­¾åˆ—è¡¨å¹¶å¡«å……ç­›é€‰ä¸‹æ‹‰é€‰å•
        let allTags = [];
        async function loadTags() {
          try {
            const res = await fetch(`${apiBase}/tags`, {
              method: 'GET',
              credentials: 'include'
            });
            const json = await res.json();
            if (json.ok && Array.isArray(json.data)) {
              allTags = json.data;
              populateTagFilter();
            }
          } catch (err) {
            console.error('åŠ è½½æ ‡ç­¾åˆ—è¡¨å¤±è´¥', err);
          }
        }
        
        function populateTagFilter() {
          const tagFilter = document.getElementById('tag-filter');
          if (!tagFilter) return;
          
          tagFilter.innerHTML = '<option value="">å…¨éƒ¨æ¨™ç±¤</option>';
          allTags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag.tag_id;
            option.textContent = tag.tag_name;
            tagFilter.appendChild(option);
          });
        }
        
        function populateEmployeeSelects() {
          const selects = [
            document.getElementById('f_assignee'),          // æ–°å¢å®¢æˆ·
            document.getElementById('edit_assignee'),       // ç¼–è¾‘å®¢æˆ·
            document.getElementById('batch_assignee')       // æ‰¹é‡åˆ†é…
          ];
          
          selects.forEach(select => {
            if (!select) return;
            select.innerHTML = '';
            employeesList.forEach(emp => {
              const option = document.createElement('option');
              option.value = emp.user_id;
              option.textContent = `${emp.name}${emp.is_admin ? ' (ç®¡ç†å“¡)' : ''}`;
              select.appendChild(option);
            });
          });
        }

        function renderRows(rows) {
          tbody.innerHTML = '';
          if (!rows || rows.length === 0) {
            emptyEl.hidden = false;
            pager.hidden = true;
            return;
          }
          emptyEl.hidden = true;
          pager.hidden = false;
          rows.forEach((r) => {
            const tr = document.createElement('tr');
            // ä¿®å¾©ï¼šè² è²¬äººé¡¯ç¤ºï¼ˆä½¿ç”¨ assigneeNameï¼Œè‹¥ç„¡å‰‡é¡¯ç¤ºã€Œæœªåˆ†é…ã€ï¼‰
            const assigneeName = r.assigneeName || r.assignee_name || 'æœªåˆ†é…';
            // ä¿®å¾©ï¼šæ¨™ç±¤é¡¯ç¤ºï¼ˆå…¼å®¹é™£åˆ—æˆ–GROUP_CONCATå­—ä¸²ï¼‰
            let tagsHtml = '';
            let tagsArr = [];
            if (Array.isArray(r.tags)) {
              tagsArr = r.tags.map(t => {
                if (typeof t === 'string') return { tag_name: t, tag_color: '#999' };
                return { tag_name: t.tag_name || t.tagName || '', tag_color: t.tag_color || t.tagColor || '#999' };
              });
            } else if (typeof r.tags === 'string' && r.tags.trim() !== '') {
              // å…¼å®¹å¾Œç«¯ä»¥ "id:name:color|id:name:color" å‚³å›çš„æ ¼å¼
              tagsArr = r.tags.split('|').map(part => {
                const [id, name, color] = part.split(':');
                return { tag_name: name || '', tag_color: color || '#999' };
              });
            }
            if (tagsArr.length > 0) {
              tagsHtml = tagsArr.slice(0, 3).map(t => `<span class="chip" style="background:${t.tag_color}">${t.tag_name}</span>`).join('');
              if (tagsArr.length > 3) tagsHtml += `<span class="chip" style="background:#ccc">+${tagsArr.length - 3}</span>`;
            }
            
            const serviceCount = Number(r.services_count || r.servicesCount || (Array.isArray(r.services) ? r.services.length : 0)) || 0;
            const serviceCountHtml = serviceCount > 0 
              ? `<span class="service-count" style="background:#2563eb;color:#fff;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;">${serviceCount}</span>`
              : '<span class="text-muted">ç„¡</span>';
            
            // å…¨å¹´æ”¶è´¹æ€»é¢ï¼ˆéœ€è¦ä»åç«¯APIè¿”å›ï¼‰
            const yearTotal = Number(r.year_total || r.yearTotal || 0) || 0;
            const yearTotalHtml = yearTotal > 0 
              ? `<span class="text-success">NT$ ${yearTotal.toLocaleString()}</span>`
              : '<span class="text-muted">-</span>';
            
            // è”ç»œäººæ˜¾ç¤ºï¼ˆæ˜¾ç¤ºç¬¬ä¸€ä¸ªè”ç»œäººï¼‰
            const contactPerson = r.contact_person_1 || r.contactPerson1 || '';
            
            // å»ºç«‹æ—¶é—´æ ¼å¼åŒ–ï¼ˆåªæ˜¾ç¤ºåˆ°æ—¥æœŸï¼‰
            const createdDate = r.createdAt ? r.createdAt.split('T')[0].split(' ')[0] : '';
            
            tr.innerHTML = `
              <td><input type="checkbox" class="client-checkbox" data-client-id="${r.clientId}" /></td>
              <td><a href="/internal/client-detail?id=${r.clientId}" class="client-name-link">${r.companyName}</a></td>
              <td>${r.taxId||''}</td>
              <td>${contactPerson}</td>
              <td>${assigneeName}</td>
              <td>${tagsHtml}</td>
              <td>${serviceCountHtml}</td>
              <td>${yearTotalHtml}</td>
              <td>${r.phone||''}</td>
              <td>${r.email||''}</td>
              <td>${createdDate}</td>
              <td>
                <button type="button" class="btn btn-sm btn-secondary" data-act="view" data-id="${r.clientId}">æŸ¥çœ‹</button>
                <button type="button" class="btn btn-sm btn-danger" data-act="del" data-id="${r.clientId}">åˆªé™¤</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }

        let state = { page: 1, perPage: 50, total: 0, q: '', tag_id: '' };

        async function load() {
          setError('');
          const t0 = performance.now();
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          // ä¼ºæœå™¨ç«¯ç¦ç”¨å¿«å–
          params.set('no_cache', '1');
          // æœç´¢æ”¯æŒå…¬å¸åç¨±å’Œçµ±ä¸€ç·¨è™Ÿ
          if (state.q) {
            params.set('q', state.q);
          }
          // æ ‡ç­¾ç­›é€‰
          if (state.tag_id) {
            params.set('tag_id', state.tag_id);
          }
          try {
            const res = await fetch(`${apiBase}/clients?${params.toString()}`, { 
              credentials: 'include',
              headers: { 'X-No-Cache': '1' }
            });
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) {
              throw new Error((json && json.message) || 'è¼‰å…¥å¤±æ•—');
            }
            const rows = json.data || [];
            renderRows(rows);
            const meta = json.meta || {};
            state.total = meta.total || 0;
            renderPager();

            // ğŸ§ª æ§‹é€ èª¿è©¦è³‡è¨Š
            const t1 = performance.now();
            lastDebug = {
              loadedAt: new Date().toLocaleString(),
              durationMs: (t1 - t0).toFixed(1),
              cacheSource: meta.cache_source || '',
              requestId: meta.requestId || '',
              total: rows.length,
              list: rows.map(r => ({ 
                clientId: r.clientId, 
                companyName: r.companyName, 
                assigneeName: r.assigneeName || r.assignee_name || 'æœªåˆ†é…',
                tags: (Array.isArray(r.tags)
                  ? r.tags.map(t => typeof t === 'string' ? t : (t.tag_name || t.tagName || ''))
                  : (typeof r.tags === 'string' ? r.tags.split('|').map(p => (p.split(':')[1] || '')) : [])),
                services_count: Number(r.services_count || r.servicesCount || 0) || 0,
                year_total: Number(r.year_total || r.yearTotal || 0) || 0
              }))
            };
            console.log('[Clients][ğŸ§ª èª¿è©¦] è¼‰å…¥å®Œæˆ:', lastDebug);
            if (!debugPanel.hidden) renderDebugPanel();
          } catch (err) {
            setError('è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
        }

        function renderPager() {
          const hasNext = state.page * state.perPage < state.total;
          const prevBtn = document.getElementById('prev');
          const nextBtn = document.getElementById('next');
          prevBtn.disabled = state.page <= 1;
          nextBtn.disabled = !hasNext;
        }

        function applySearch() {
          state.q = (qEl.value||'').trim();
          state.page = 1;
          load();
        }

        function applyTagFilter() {
          const tagFilter = document.getElementById('tag-filter');
          state.tag_id = tagFilter.value;
          state.page = 1;
          load();
        }

        // å®æ—¶æœç´¢
        let timer = null;
        qEl.addEventListener('input', function () {
          clearTimeout(timer);
          timer = setTimeout(applySearch, 300);
        });
        
        // æ ‡ç­¾ç­›é€‰
        document.getElementById('tag-filter').addEventListener('change', applyTagFilter);
        
        document.getElementById('prev').addEventListener('click', function(){ if (state.page>1) { state.page--; load(); } });
        document.getElementById('next').addEventListener('click', function(){ state.page++; load(); });

        // åˆå§‹åŒ–è¼‰å…¥
        loadEmployees(); // åŠ è½½å‘˜å·¥åˆ—è¡¨
        loadTags(); // åŠ è½½æ ‡ç­¾åˆ—è¡¨
        load();
        // èª¿è©¦é¢æ¿é–‹é—œ
        document.getElementById('btn-debug-toggle').addEventListener('click', function(){
          if (!debugPanel) return;
          debugPanel.hidden = !debugPanel.hidden;
          if (!debugPanel.hidden) renderDebugPanel();
        });

        // æ¸…é™¤æœå‹™ç«¯å¿«å–ï¼ˆclients_listï¼‰
        if (debugClearBtn) {
          debugClearBtn.addEventListener('click', async function(){
            try {
              const res = await fetch(`${apiBase}/cache-clear`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ cache_type: 'clients_list' })
              });
              const json = await res.json().catch(()=>null);
              if (res.ok && json && json.ok) {
                alert('å·²æ¸…é™¤å®¢æˆ¶åˆ—è¡¨å¿«å–');
                load();
              } else {
                alert((json && json.message) || 'æ¸…é™¤å¤±æ•—');
              }
            } catch (e) {
              alert('æ¸…é™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
          });
        }

        // é‡æ–°è¼‰å…¥
        if (debugReloadBtn) {
          debugReloadBtn.addEventListener('click', function(){ load(); });
        }

        // è³‡æ–™åº«æª¢æŸ¥
        if (debugDbCheckBtn) {
          debugDbCheckBtn.addEventListener('click', async function(){
            try {
              const ids = (lastDebug.list || []).map(i => i.clientId);
              const res = await fetch(`${apiBase}/clients/diagnose`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ client_ids: ids })
              });
              const json = await res.json().catch(()=>null);
              if (!res.ok || !json || json.ok !== true) {
                alert((json && json.message) || 'è¨ºæ–·å¤±æ•—');
                return;
              }
              const diag = (json.data && json.data.clients) || [];
              lastDbDiagMap = {};
              diag.forEach(r => { lastDbDiagMap[r.client_id] = r; });
              renderDebugPanel();
              alert('è³‡æ–™åº«æª¢æŸ¥å®Œæˆ');
            } catch (e) {
              alert('è¨ºæ–·å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
          });
        }
        
        // ç¶å®šæ“ä½œæŒ‰éˆ•äº‹ä»¶ï¼ˆå…¨å±€ç»‘å®šä¸€æ¬¡ï¼Œé¿å…é‡å¤ï¼‰
        tbody.addEventListener('click', function(e) {
          const btn = e.target.closest('button[data-act]');
          if (!btn) return;
          const action = btn.getAttribute('data-act');
          const clientId = btn.getAttribute('data-id');
          if (action === 'view') viewClient(clientId);
          if (action === 'del') deleteClient(clientId);
        });

        // â€”â€” æŸ¥çœ‹å®¢æˆ¶è©³æƒ… â€”â€”
        async function viewClient(clientId) {
          // è·³è½‰åˆ°å®¢æˆ¶è©³æƒ…é 
          window.location.href = `/internal/client-detail?id=${clientId}`;
        }
        
        // â€”â€” åˆªé™¤å®¢æˆ¶ â€”â€”
        async function deleteClient(clientId) {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å®¢æˆ¶å—ï¼Ÿåˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸã€‚')) {
            return;
          }
          
          try {
            const res = await fetch(`${apiBase}/clients/${clientId}`, {
              method: 'DELETE',
              credentials: 'include'
            });
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/clients');
              return;
            }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) {
              throw new Error((json && json.message) || 'åˆªé™¤å¤±æ•—');
            }
            alert('å·²åˆªé™¤');
            
            // æ¸…é™¤å®¢æˆ·åˆ—è¡¨ç¼“å­˜
            if (window.DataCache) {
              ['clients_page1', 'clients_page2', 'clients_page3', 'clients_all'].forEach(key => {
                localStorage.removeItem(`cache_${key}`);
              });
            }
            
            // åˆ·æ–°é¡µé¢
            location.reload();
          } catch (err) {
            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
        }
        

        // ========== æ‰¹é‡åˆ†é…è² è²¬äºº ==========

        const batchAssignModal = document.getElementById('batchAssignModal');
        const batchAssignForm = document.getElementById('batchAssignForm');
        const batchAssignCloseBtn = document.getElementById('btn-batch-assign-close');
        const batchAssignCancelBtn = document.getElementById('btn-batch-assign-cancel');
        const batchActionsDiv = document.getElementById('batch-actions');
        const selectAllCheckbox = document.getElementById('select-all');
        let selectedClientIds = [];

        // å…¨é¸/å–æ¶ˆå…¨é¸
        selectAllCheckbox.addEventListener('change', function() {
          const checkboxes = document.querySelectorAll('.client-checkbox');
          checkboxes.forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
          });
          updateSelectedClients();
        });

        // ç›£è½å¤šé¸æ¡†è®ŠåŒ–
        tbody.addEventListener('change', function(e) {
          if (e.target.classList.contains('client-checkbox')) {
            updateSelectedClients();
          }
        });

        // æ›´æ–°å·²é¸æ“‡çš„å®¢æˆ¶
        function updateSelectedClients() {
          const checkboxes = document.querySelectorAll('.client-checkbox:checked');
          selectedClientIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-client-id'));
          
          if (selectedClientIds.length > 0) {
            batchActionsDiv.style.display = 'flex';
            document.getElementById('batch-count').textContent = selectedClientIds.length;
          } else {
            batchActionsDiv.style.display = 'none';
          }
          
          // æ›´æ–°å…¨é¸æ¡†ç‹€æ…‹
          const allCheckboxes = document.querySelectorAll('.client-checkbox');
          selectAllCheckbox.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
        }

        // å–æ¶ˆé¸æ“‡
        document.getElementById('btn-cancel-select').addEventListener('click', function() {
          const checkboxes = document.querySelectorAll('.client-checkbox');
          checkboxes.forEach(cb => cb.checked = false);
          selectAllCheckbox.checked = false;
          updateSelectedClients();
        });

        // æ‰“é–‹æ‰¹é‡åˆ†é… Modal
        document.getElementById('btn-batch-assign').addEventListener('click', function() {
          if (selectedClientIds.length === 0) {
            alert('è«‹å…ˆé¸æ“‡å®¢æˆ¶');
            return;
          }
          if (selectedClientIds.length > 100) {
            alert('ä¸€æ¬¡æœ€å¤šåˆ†é… 100 å€‹å®¢æˆ¶');
            return;
          }
          document.getElementById('batch-count').textContent = selectedClientIds.length;
          
          // æ˜¾ç¤ºé€‰ä¸­å®¢æˆ·çš„åˆ—è¡¨å’Œå½“å‰è´Ÿè´£äºº
          const clientsList = document.getElementById('batch-clients-list');
          clientsList.innerHTML = '';
          
          selectedClientIds.forEach(clientId => {
            const checkbox = document.querySelector(`.client-checkbox[data-client-id="${clientId}"]`);
            if (checkbox) {
              const row = checkbox.closest('tr');
              const companyName = row.cells[1]?.textContent?.trim() || '';
              const currentAssignee = row.cells[4]?.textContent?.trim() || 'æœªåˆ†é…';
              
              const item = document.createElement('div');
              item.style.cssText = 'padding:6px 0;border-bottom:1px solid #e0e0e0;';
              item.innerHTML = `
                <div style="font-weight:500;color:#1a1a1a;">${companyName}</div>
                <div style="font-size:13px;color:#666;margin-top:2px;">ç•¶å‰è² è²¬äººï¼š<span style="color:#2563eb;">${currentAssignee}</span></div>
              `;
              clientsList.appendChild(item);
            }
          });
          
          openBatchAssignModal();
        });

        function openBatchAssignModal() { batchAssignModal.classList.add('active'); batchAssignModal.setAttribute('aria-hidden','false'); }
        function closeBatchAssignModal() { batchAssignModal.classList.remove('active'); batchAssignModal.setAttribute('aria-hidden','true'); batchAssignForm.reset(); clearBatchAssignErrors(); }
        batchAssignCloseBtn.addEventListener('click', closeBatchAssignModal);
        batchAssignCancelBtn.addEventListener('click', closeBatchAssignModal);

        function clearBatchAssignErrors() {
          const el = document.getElementById('batch_e_assignee');
          if (el) el.textContent = '';
        }

        // æ‰¹é‡åˆ†é…è¡¨å–®æäº¤
        batchAssignForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          clearBatchAssignErrors();
          const assignee_user_id = parseInt(document.getElementById('batch_assignee').value, 10);

          if (!Number.isInteger(assignee_user_id) || assignee_user_id <= 0) {
            document.getElementById('batch_e_assignee').textContent = 'è«‹é¸æ“‡è² è²¬äººå“¡';
            return;
          }

          const payload = { client_ids: selectedClientIds, assignee_user_id };
          console.log('[æ‰¹é‡åˆ†é…] ç™¼é€è«‹æ±‚:', payload);
          console.log('[æ‰¹é‡åˆ†é…] selectedClientIds è¯¦ç»†å€¼:', selectedClientIds);
          console.log('[æ‰¹é‡åˆ†é…] ç¬¬ä¸€ä¸ªIDçš„ç±»å‹:', typeof selectedClientIds[0], 'å€¼:', selectedClientIds[0]);
          
          const submitBtn = document.getElementById('btn-batch-assign-submit');
          submitBtn.disabled = true;
          submitBtn.textContent = 'åˆ†é…ä¸­â€¦';

          try {
            const res = await fetch(`${apiBase}/clients/batch-assign`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload)
            });
            console.log('[æ‰¹é‡åˆ†é…] éŸ¿æ‡‰ç‹€æ…‹:', res.status);
            const json = await res.json().catch(() => null);
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/clients');
              return;
            }
            if (res.status === 403) {
              alert('æ¬Šé™ä¸è¶³ï¼Œåƒ…ç®¡ç†å“¡å¯åŸ·è¡Œæ‰¹é‡åˆ†é…');
              return;
            }
            console.log('[æ‰¹é‡åˆ†é…] APIéŸ¿æ‡‰:', json);
            
            if (!res.ok || !json || json.ok !== true) {
              const msg = (json && json.message) || 'åˆ†é…å¤±æ•—';
              console.error('[æ‰¹é‡åˆ†é…] å¤±æ•—:', msg, json);
              alert(msg);
              return;
            }
            
            console.log('[æ‰¹é‡åˆ†é…] æˆåŠŸï¼æ›´æ–°æ•¸é‡:', json.data?.updated_count);
            console.log('[æ‰¹é‡åˆ†é…] å®Œæ•´éŸ¿æ‡‰:', JSON.stringify(json, null, 2));
            
            // æš‚æ—¶ä¸è‡ªåŠ¨åˆ·æ–°ï¼Œè®©ç”¨æˆ·èƒ½çœ‹åˆ°æ—¥å¿—
            closeBatchAssignModal();
            
            // æ¸…é™¤å®¢æˆ·åˆ—è¡¨ç¼“å­˜ï¼ˆç¡®ä¿æ˜¾ç¤ºæœ€æ–°æ•°æ®ï¼‰
            if (window.DataCache) {
              ['clients_page1', 'clients_page2', 'clients_page3', 'clients_all'].forEach(key => {
                localStorage.removeItem(`cache_${key}`);
              });
              console.log('[Clients] âœ“ å·²æ¸…é™¤å®¢æˆ·åˆ—è¡¨ç¼“å­˜');
            }
            
            // æ˜¾ç¤ºæç¤ºï¼Œè®©ç”¨æˆ·æŸ¥çœ‹æ—¥å¿—åæ‰‹åŠ¨åˆ·æ–°
            alert(`âœ… ${json.message || 'å·²å®Œæˆæ‰¹é‡åˆ†é…'}\n\nğŸ“Š æ›´æ–°æ•¸é‡: ${json.data?.updated_count}\n\nâš ï¸ è«‹æŸ¥çœ‹ Console æ—¥å¿—ï¼Œç„¶å¾Œæ‰‹å‹•åˆ·æ–°é é¢ï¼ˆæŒ‰F5ï¼‰`);
            
            console.log('='.repeat(50));
            console.log('âœ… æ‰¹é‡åˆ†é…å®Œæˆï¼');
            console.log('ğŸ“Š è«‹æª¢æŸ¥ä¸Šé¢çš„æ—¥å¿—ï¼Œç‰¹åˆ¥æ˜¯ï¼š');
            console.log('   1. [æ‰¹é‡åˆ†é…] ç™¼é€è«‹æ±‚ - ç¢ºèª client_ids æ˜¯å¦æ­£ç¢º');
            console.log('   2. [æ‰¹é‡åˆ†é…] APIéŸ¿æ‡‰ - ç¢ºèª updated_count çš„å€¼');
            console.log('   3. å¦‚æœ updated_count = 0ï¼Œèªªæ˜æ•¸æ“šåº«æ›´æ–°å¤±æ•—');
            console.log('âš ï¸ æŸ¥çœ‹å®Œæ—¥å¿—å¾Œï¼Œè«‹æŒ‰ F5 åˆ·æ–°é é¢');
            console.log('='.repeat(50));
          } catch (err) {
            alert('åˆ†é…å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'æ‰¹é‡åˆ†é…';
          }
        });

      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


