<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="客戶管理列表" />
    <title>客戶管理｜列表</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/internal-system.css?v=3" />
    <link rel="stylesheet" href="/assets/css/internal-components.css?v=3" />
    <link rel="stylesheet" href="/assets/css/clients-page.css?v=9" />
    
    <!-- ⚡ 預加載系統（客户页面禁用缓存） -->
    <script>
    // ❌ 客户列表页面完全禁用缓存系统
    // 原因：客户数据经常变更，缓存会导致看不到最新数据
    console.log('[Clients] ℹ️ 客户列表页面已禁用所有缓存功能');
    
    // 禁用 DataCache 预加载
    window.__DISABLE_DATA_CACHE__ = true;
    
    // 禁用 fetch-interceptor 拦截
    window.__DISABLE_FETCH_INTERCEPTOR__ = true;
    
    // 页面加载时清除所有客户相关缓存
    document.addEventListener('DOMContentLoaded', function() {
      const clientsCacheKeys = [
        'clients_page1', 'clients_page2', 'clients_page3', 
        'clients_page4', 'clients_page5', 'clients_all'
      ];
      
      clientsCacheKeys.forEach(key => {
        localStorage.removeItem(`cache_${key}`);
      });
      
      console.log('[Clients] ✓ 已清除所有客户缓存');
    });
    </script>
  </head>
  <body class="clients-page">
    <main class="clients-content" style="padding: 20px;">
      <section class="clients-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 16px; flex-wrap: wrap;">
          <div style="display: flex; gap: 12px; align-items: center; flex: 1;">
            <div class="clients-search" style="flex: 1; max-width: 400px;">
              <input id="q" type="search" placeholder="搜尋公司名稱或統編…" aria-label="搜尋" />
            </div>
            <select id="tag-filter" style="padding: 10px 14px; border: 1px solid rgba(15,23,42,0.15); border-radius: 8px; font-size: 14px; background: white; color: #374151; cursor: pointer;">
              <option value="">全部標籤</option>
            </select>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <div id="batch-actions" style="display:none;gap:8px;">
              <button id="btn-batch-assign" class="clients-btn btn-secondary" type="button">批量分配負責人</button>
              <button id="btn-cancel-select" class="clients-btn btn-secondary" type="button">取消選擇</button>
            </div>
            <button onclick="window.location.href='/internal/client-new'" class="clients-btn" type="button">+ 新增客戶</button>
          </div>
        </div>
        
        <p id="clients-error" style="color:#c0392b;min-height:1.25rem;margin:0 0 8px 0;"></p>
        <div id="empty" class="clients-empty" hidden>
          <p>尚無客戶</p>
          <p><button onclick="window.location.href='/internal/client-new'" class="clients-btn" type="button">新增客戶</button></p>
        </div>
        <div class="clients-table-wrap">
          <table class="clients-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="select-all" aria-label="全選" /></th>
                <th>公司名稱</th>
                <th>統一編號</th>
                <th>聯絡人</th>
                <th>負責人</th>
                <th>標籤</th>
                <th>服務數量</th>
                <th>全年收費總額</th>
                <th>電話</th>
                <th>Email</th>
                <th>建立時間</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- 動態載入 -->
            </tbody>
          </table>
        </div>
        <div class="clients-pagination" id="pager" hidden>
          <button type="button" id="prev">上一頁</button>
          <button type="button" id="next">下一頁</button>
        </div>
      </section>
    </main>

    <!-- 批量分配負責人彈窗 -->
    <div class="modal-overlay" id="batchAssignModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal" role="document">
        <div class="modal__header">
          <h2 class="modal__title">批量分配負責人</h2>
          <button class="modal__close" type="button" id="btn-batch-assign-close">✕</button>
        </div>
        <div class="modal__body">
          <form id="batchAssignForm" class="form-grid">
            <div class="field" style="grid-column:1 / -1;">
              <label>已選擇 <strong id="batch-count">0</strong> 個客戶</label>
              <div id="batch-clients-list" style="margin-top:8px;padding:12px;background:#f8f9fa;border-radius:6px;max-height:200px;overflow-y:auto;"></div>
            </div>
            <div class="field" style="grid-column:1 / -1;">
              <label for="batch_assignee">新的負責人員（必填）</label>
              <select id="batch_assignee" name="assignee_user_id" required>
                <option value="1">1 管理員</option>
              </select>
              <div class="field__error" id="batch_e_assignee"></div>
            </div>
            <div class="modal__actions" style="grid-column:1 / -1;">
              <button class="clients-btn btn-secondary" type="button" id="btn-batch-assign-cancel">取消</button>
              <button class="clients-btn" type="submit" id="btn-batch-assign-submit">批量分配</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
        const qEl = document.getElementById('q');
        const tbody = document.getElementById('tbody');
        const emptyEl = document.getElementById('empty');
        const pager = document.getElementById('pager');
        const errEl = document.getElementById('clients-error');

        function setError(msg){ if (errEl) errEl.textContent = msg || ''; }

        // 加载员工列表并填充下拉选单
        let employeesList = [];
        async function loadEmployees() {
          try {
            const res = await fetch(`${apiBase}/users`, {
              method: 'GET',
              credentials: 'include'
            });
            const json = await res.json();
            if (json.ok && Array.isArray(json.data)) {
              employeesList = json.data;
              populateEmployeeSelects();
            }
          } catch (err) {
            console.error('加载员工列表失败', err);
          }
        }
        
        // 加载标签列表并填充筛选下拉选单
        let allTags = [];
        async function loadTags() {
          try {
            const res = await fetch(`${apiBase}/tags`, {
              method: 'GET',
              credentials: 'include'
            });
            const json = await res.json();
            if (json.ok && Array.isArray(json.data)) {
              allTags = json.data;
              populateTagFilter();
            }
          } catch (err) {
            console.error('加载标签列表失败', err);
          }
        }
        
        function populateTagFilter() {
          const tagFilter = document.getElementById('tag-filter');
          if (!tagFilter) return;
          
          tagFilter.innerHTML = '<option value="">全部標籤</option>';
          allTags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag.tag_id;
            option.textContent = tag.tag_name;
            tagFilter.appendChild(option);
          });
        }
        
        function populateEmployeeSelects() {
          const selects = [
            document.getElementById('f_assignee'),          // 新增客户
            document.getElementById('edit_assignee'),       // 编辑客户
            document.getElementById('batch_assignee')       // 批量分配
          ];
          
          selects.forEach(select => {
            if (!select) return;
            select.innerHTML = '';
            employeesList.forEach(emp => {
              const option = document.createElement('option');
              option.value = emp.user_id;
              option.textContent = `${emp.name}${emp.is_admin ? ' (管理員)' : ''}`;
              select.appendChild(option);
            });
          });
        }

        function renderRows(rows) {
          tbody.innerHTML = '';
          if (!rows || rows.length === 0) {
            emptyEl.hidden = false;
            pager.hidden = true;
            return;
          }
          emptyEl.hidden = true;
          pager.hidden = false;
          rows.forEach((r) => {
            const tr = document.createElement('tr');
            // 修復：負責人顯示（使用 assigneeName，若無則顯示「未分配」）
            const assigneeName = r.assigneeName || r.assignee_name || '未分配';
            // 修復：標籤顯示（檢查是否為字串或陣列）
            let tagsHtml = '';
            if (r.tags && Array.isArray(r.tags) && r.tags.length > 0) {
              tagsHtml = r.tags.slice(0,3).map(t => {
                const tagName = typeof t === 'string' ? t : (t.tag_name || t.tagName || '');
                const tagColor = typeof t === 'object' ? (t.tag_color || t.tagColor || '#999') : '#999';
                return `<span class="chip" style="background:${tagColor}">${tagName}</span>`;
              }).join('');
              if (r.tags.length > 3) {
                tagsHtml += `<span class="chip" style="background:#ccc">+${r.tags.length - 3}</span>`;
              }
            }
            
            const serviceCount = (r.services && Array.isArray(r.services)) ? r.services.length : 0;
            const serviceCountHtml = serviceCount > 0 
              ? `<span class="service-count" style="background:#2563eb;color:#fff;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;">${serviceCount}</span>`
              : '<span class="text-muted">無</span>';
            
            // 全年收费总额（需要从后端API返回）
            const yearTotal = r.year_total || r.yearTotal || 0;
            const yearTotalHtml = yearTotal > 0 
              ? `<span class="text-success">NT$ ${yearTotal.toLocaleString()}</span>`
              : '<span class="text-muted">-</span>';
            
            // 联络人显示（显示第一个联络人）
            const contactPerson = r.contact_person_1 || r.contactPerson1 || '';
            
            // 建立时间格式化（只显示到日期）
            const createdDate = r.createdAt ? r.createdAt.split('T')[0].split(' ')[0] : '';
            
            tr.innerHTML = `
              <td><input type="checkbox" class="client-checkbox" data-client-id="${r.clientId}" /></td>
              <td><a href="/internal/client-detail?id=${r.clientId}" class="client-name-link">${r.companyName}</a></td>
              <td>${r.taxId||''}</td>
              <td>${contactPerson}</td>
              <td>${assigneeName}</td>
              <td>${tagsHtml}</td>
              <td>${serviceCountHtml}</td>
              <td>${yearTotalHtml}</td>
              <td>${r.phone||''}</td>
              <td>${r.email||''}</td>
              <td>${createdDate}</td>
              <td>
                <button type="button" class="btn btn-sm btn-secondary" data-act="view" data-id="${r.clientId}">查看</button>
                <button type="button" class="btn btn-sm btn-danger" data-act="del" data-id="${r.clientId}">刪除</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }

        let state = { page: 1, perPage: 50, total: 0, q: '', tag_id: '' };

        async function load() {
          setError('');
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          // 搜索支持公司名稱和統一編號
          if (state.q) {
            params.set('q', state.q);
          }
          // 标签筛选
          if (state.tag_id) {
            params.set('tag_id', state.tag_id);
          }
          try {
            const res = await fetch(`${apiBase}/clients?${params.toString()}`, { credentials: 'include' });
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) {
              throw new Error((json && json.message) || '載入失敗');
            }
            const rows = json.data || [];
            renderRows(rows);
            const meta = json.meta || {};
            state.total = meta.total || 0;
            renderPager();
          } catch (err) {
            setError('載入失敗，請稍後再試');
          }
        }

        function renderPager() {
          const hasNext = state.page * state.perPage < state.total;
          const prevBtn = document.getElementById('prev');
          const nextBtn = document.getElementById('next');
          prevBtn.disabled = state.page <= 1;
          nextBtn.disabled = !hasNext;
        }

        function applySearch() {
          state.q = (qEl.value||'').trim();
          state.page = 1;
          load();
        }

        function applyTagFilter() {
          const tagFilter = document.getElementById('tag-filter');
          state.tag_id = tagFilter.value;
          state.page = 1;
          load();
        }

        // 实时搜索
        let timer = null;
        qEl.addEventListener('input', function () {
          clearTimeout(timer);
          timer = setTimeout(applySearch, 300);
        });
        
        // 标签筛选
        document.getElementById('tag-filter').addEventListener('change', applyTagFilter);
        
        document.getElementById('prev').addEventListener('click', function(){ if (state.page>1) { state.page--; load(); } });
        document.getElementById('next').addEventListener('click', function(){ state.page++; load(); });

        // 初始化載入
        loadEmployees(); // 加载员工列表
        loadTags(); // 加载标签列表
        load();
        
        // 綁定操作按鈕事件（全局绑定一次，避免重复）
        tbody.addEventListener('click', function(e) {
          const btn = e.target.closest('button[data-act]');
          if (!btn) return;
          const action = btn.getAttribute('data-act');
          const clientId = btn.getAttribute('data-id');
          if (action === 'view') viewClient(clientId);
          if (action === 'del') deleteClient(clientId);
        });

        // —— 查看客戶詳情 ——
        async function viewClient(clientId) {
          // 跳轉到客戶詳情頁
          window.location.href = `/internal/client-detail?id=${clientId}`;
        }
        
        // —— 刪除客戶 ——
        async function deleteClient(clientId) {
          if (!confirm('確定要刪除此客戶嗎？刪除後將無法復原。')) {
            return;
          }
          
          try {
            const res = await fetch(`${apiBase}/clients/${clientId}`, {
              method: 'DELETE',
              credentials: 'include'
            });
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/clients');
              return;
            }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) {
              throw new Error((json && json.message) || '刪除失敗');
            }
            alert('已刪除');
            
            // 清除客户列表缓存
            if (window.DataCache) {
              ['clients_page1', 'clients_page2', 'clients_page3', 'clients_all'].forEach(key => {
                localStorage.removeItem(`cache_${key}`);
              });
            }
            
            // 刷新页面
            location.reload();
          } catch (err) {
            alert('刪除失敗，請稍後再試');
          }
        }
        

        // ========== 批量分配負責人 ==========

        const batchAssignModal = document.getElementById('batchAssignModal');
        const batchAssignForm = document.getElementById('batchAssignForm');
        const batchAssignCloseBtn = document.getElementById('btn-batch-assign-close');
        const batchAssignCancelBtn = document.getElementById('btn-batch-assign-cancel');
        const batchActionsDiv = document.getElementById('batch-actions');
        const selectAllCheckbox = document.getElementById('select-all');
        let selectedClientIds = [];

        // 全選/取消全選
        selectAllCheckbox.addEventListener('change', function() {
          const checkboxes = document.querySelectorAll('.client-checkbox');
          checkboxes.forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
          });
          updateSelectedClients();
        });

        // 監聽多選框變化
        tbody.addEventListener('change', function(e) {
          if (e.target.classList.contains('client-checkbox')) {
            updateSelectedClients();
          }
        });

        // 更新已選擇的客戶
        function updateSelectedClients() {
          const checkboxes = document.querySelectorAll('.client-checkbox:checked');
          selectedClientIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-client-id'));
          
          if (selectedClientIds.length > 0) {
            batchActionsDiv.style.display = 'flex';
            document.getElementById('batch-count').textContent = selectedClientIds.length;
          } else {
            batchActionsDiv.style.display = 'none';
          }
          
          // 更新全選框狀態
          const allCheckboxes = document.querySelectorAll('.client-checkbox');
          selectAllCheckbox.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
        }

        // 取消選擇
        document.getElementById('btn-cancel-select').addEventListener('click', function() {
          const checkboxes = document.querySelectorAll('.client-checkbox');
          checkboxes.forEach(cb => cb.checked = false);
          selectAllCheckbox.checked = false;
          updateSelectedClients();
        });

        // 打開批量分配 Modal
        document.getElementById('btn-batch-assign').addEventListener('click', function() {
          if (selectedClientIds.length === 0) {
            alert('請先選擇客戶');
            return;
          }
          if (selectedClientIds.length > 100) {
            alert('一次最多分配 100 個客戶');
            return;
          }
          document.getElementById('batch-count').textContent = selectedClientIds.length;
          
          // 显示选中客户的列表和当前负责人
          const clientsList = document.getElementById('batch-clients-list');
          clientsList.innerHTML = '';
          
          selectedClientIds.forEach(clientId => {
            const checkbox = document.querySelector(`.client-checkbox[data-client-id="${clientId}"]`);
            if (checkbox) {
              const row = checkbox.closest('tr');
              const companyName = row.cells[1]?.textContent?.trim() || '';
              const currentAssignee = row.cells[4]?.textContent?.trim() || '未分配';
              
              const item = document.createElement('div');
              item.style.cssText = 'padding:6px 0;border-bottom:1px solid #e0e0e0;';
              item.innerHTML = `
                <div style="font-weight:500;color:#1a1a1a;">${companyName}</div>
                <div style="font-size:13px;color:#666;margin-top:2px;">當前負責人：<span style="color:#2563eb;">${currentAssignee}</span></div>
              `;
              clientsList.appendChild(item);
            }
          });
          
          openBatchAssignModal();
        });

        function openBatchAssignModal() { batchAssignModal.classList.add('active'); batchAssignModal.setAttribute('aria-hidden','false'); }
        function closeBatchAssignModal() { batchAssignModal.classList.remove('active'); batchAssignModal.setAttribute('aria-hidden','true'); batchAssignForm.reset(); clearBatchAssignErrors(); }
        batchAssignCloseBtn.addEventListener('click', closeBatchAssignModal);
        batchAssignCancelBtn.addEventListener('click', closeBatchAssignModal);

        function clearBatchAssignErrors() {
          const el = document.getElementById('batch_e_assignee');
          if (el) el.textContent = '';
        }

        // 批量分配表單提交
        batchAssignForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          clearBatchAssignErrors();
          const assignee_user_id = parseInt(document.getElementById('batch_assignee').value, 10);

          if (!Number.isInteger(assignee_user_id) || assignee_user_id <= 0) {
            document.getElementById('batch_e_assignee').textContent = '請選擇負責人員';
            return;
          }

          const payload = { client_ids: selectedClientIds, assignee_user_id };
          console.log('[批量分配] 發送請求:', payload);
          
          const submitBtn = document.getElementById('btn-batch-assign-submit');
          submitBtn.disabled = true;
          submitBtn.textContent = '分配中…';

          try {
            const res = await fetch(`${apiBase}/clients/batch-assign`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload)
            });
            console.log('[批量分配] 響應狀態:', res.status);
            const json = await res.json().catch(() => null);
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/clients');
              return;
            }
            if (res.status === 403) {
              alert('權限不足，僅管理員可執行批量分配');
              return;
            }
            console.log('[批量分配] API響應:', json);
            
            if (!res.ok || !json || json.ok !== true) {
              const msg = (json && json.message) || '分配失敗';
              console.error('[批量分配] 失敗:', msg, json);
              alert(msg);
              return;
            }
            
            console.log('[批量分配] 成功！更新數量:', json.data?.updated_count);
            alert(json.message || '已完成批量分配');
            closeBatchAssignModal();
            
            // 清除客户列表缓存（确保显示最新数据）
            if (window.DataCache) {
              // 清除所有客户列表相关的缓存
              ['clients_page1', 'clients_page2', 'clients_page3', 'clients_all'].forEach(key => {
                localStorage.removeItem(`cache_${key}`);
              });
              console.log('[Clients] ✓ 已清除客户列表缓存');
            }
            
            // 刷新页面以显示最新数据
            location.reload();
          } catch (err) {
            alert('分配失敗，請稍後再試');
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = '批量分配';
          }
        });

      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


