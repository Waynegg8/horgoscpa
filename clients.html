<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="客戶管理列表" />
    <title>客戶管理｜列表</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/internal-system.css?v=3" />
    <link rel="stylesheet" href="/assets/css/internal-components.css?v=3" />
    <link rel="stylesheet" href="/assets/css/clients-page.css" />
  </head>
  <body class="clients-page">
    <header class="clients-header">
      <h1 class="clients-title">客戶</h1>
      <div class="clients-toolbar">
        <div class="clients-search">
          <input id="q" type="search" placeholder="搜尋公司名稱…" aria-label="搜尋客戶" />
          <button id="btn-search" class="clients-btn" type="button">搜尋</button>
        </div>
        <div id="batch-actions" style="display:none;gap:8px;">
          <button id="btn-batch-assign" class="clients-btn btn-secondary" type="button">批量分配負責人</button>
          <button id="btn-cancel-select" class="clients-btn btn-secondary" type="button">取消選擇</button>
        </div>
        <button id="btn-tags" class="clients-btn btn-secondary" type="button">標籤管理</button>
        <button onclick="window.location.href='/internal/client-new'" class="clients-btn" type="button">新增客戶</button>
      </div>
    </header>
    <main class="clients-content">
      <section class="clients-card" aria-labelledby="list-title">
        <h2 id="list-title" class="sr-only">客戶列表</h2>
        <p id="clients-error" style="color:#c0392b;min-height:1.25rem;margin:0 0 8px 0;"></p>
        <div id="empty" class="clients-empty" hidden>
          <p>尚無客戶</p>
          <p><button onclick="window.location.href='/internal/client-new'" class="clients-btn" type="button">新增客戶</button></p>
        </div>
        <div class="clients-table-wrap">
          <table class="clients-table" aria-describedby="list-title">
            <thead>
              <tr>
                <th><input type="checkbox" id="select-all" aria-label="全選" /></th>
                <th>公司名稱</th>
                <th>統一編號</th>
                <th>負責人</th>
                <th>標籤</th>
                <th>服務數量</th>
                <th>電話</th>
                <th>Email</th>
                <th>建立時間</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- 骨架：預設 3 筆範例，後續任務 22 會串 API -->
            </tbody>
          </table>
        </div>
        <div class="clients-pagination" id="pager" hidden>
          <button type="button" id="prev">上一頁</button>
          <button type="button" id="next">下一頁</button>
        </div>
      </section>
    </main>

    <!-- 批量分配負責人彈窗 -->
    <div class="modal-overlay" id="batchAssignModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal" role="document">
        <div class="modal__header">
          <h2 class="modal__title">批量分配負責人</h2>
          <button class="modal__close" type="button" id="btn-batch-assign-close">✕</button>
        </div>
        <div class="modal__body">
          <form id="batchAssignForm" class="form-grid">
            <div class="field" style="grid-column:1 / -1;">
              <label>已選擇 <strong id="batch-count">0</strong> 個客戶</label>
            </div>
            <div class="field" style="grid-column:1 / -1;">
              <label for="batch_assignee">新的負責人員（必填）</label>
              <select id="batch_assignee" name="assignee_user_id" required>
                <option value="1">1 管理員</option>
              </select>
              <div class="field__error" id="batch_e_assignee"></div>
            </div>
            <div class="modal__actions" style="grid-column:1 / -1;">
              <button class="clients-btn btn-secondary" type="button" id="btn-batch-assign-cancel">取消</button>
              <button class="clients-btn" type="submit" id="btn-batch-assign-submit">批量分配</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 標籤管理彈窗 -->
    <div class="modal-overlay" id="tagsModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal" role="document" style="max-width:800px;">
        <div class="modal__header">
          <h2 class="modal__title">標籤管理</h2>
          <button class="modal__close" type="button" id="btn-tags-close">✕</button>
        </div>
        <div class="modal__body">
          <div style="margin-bottom:16px;">
            <button class="clients-btn" type="button" id="btn-tag-new">新增標籤</button>
          </div>
          <div id="tags-list" style="display:flex;flex-direction:column;gap:8px;">
            <!-- 標籤列表將動態載入 -->
          </div>
        </div>
      </div>
    </div>

    <!-- 新增/編輯標籤彈窗 -->
    <div class="modal-overlay" id="tagFormModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal" role="document">
        <div class="modal__header">
          <h2 class="modal__title" id="tag-form-title">新增標籤</h2>
          <button class="modal__close" type="button" id="btn-tag-form-close">✕</button>
        </div>
        <div class="modal__body">
          <form id="tagForm" class="form-grid">
            <input type="hidden" id="tag_form_id" />
            <div class="field" style="grid-column:1 / -1;">
              <label for="tag_form_name">標籤名稱（必填）</label>
              <input id="tag_form_name" name="tag_name" type="text" maxlength="50" required />
              <div class="field__error" id="tag_e_name"></div>
            </div>
            <div class="field" style="grid-column:1 / -1;">
              <label for="tag_form_color">顏色碼（選填，格式：#RRGGBB）</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <input id="tag_form_color" name="tag_color" type="text" maxlength="7" placeholder="#3498db" style="flex:1;" />
                <input type="color" id="tag_color_picker" style="width:60px;height:40px;border:1px solid #ddd;border-radius:4px;" />
              </div>
              <div class="field__error" id="tag_e_color"></div>
            </div>
            <div class="modal__actions" style="grid-column:1 / -1;">
              <button class="clients-btn btn-secondary" type="button" id="btn-tag-form-cancel">取消</button>
              <button class="clients-btn" type="submit" id="btn-tag-form-submit">儲存</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
        const qEl = document.getElementById('q');
        const tbody = document.getElementById('tbody');
        const emptyEl = document.getElementById('empty');
        const pager = document.getElementById('pager');
        const errEl = document.getElementById('clients-error');
        const tagsModal = document.getElementById('tagsModal');
        const tagsCloseBtn = document.getElementById('btn-tags-close');
        const tagFormModal = document.getElementById('tagFormModal');
        const tagForm = document.getElementById('tagForm');
        const tagFormCloseBtn = document.getElementById('btn-tag-form-close');
        const tagFormCancelBtn = document.getElementById('btn-tag-form-cancel');

        function setError(msg){ if (errEl) errEl.textContent = msg || ''; }

        // 加载员工列表并填充下拉选单
        let employeesList = [];
        async function loadEmployees() {
          try {
            const res = await fetch(`${apiBase}/users`, {
              method: 'GET',
              credentials: 'include'
            });
            const json = await res.json();
            if (json.ok && Array.isArray(json.data)) {
              employeesList = json.data;
              populateEmployeeSelects();
            }
          } catch (err) {
            console.error('加载员工列表失败', err);
          }
        }
        
        function populateEmployeeSelects() {
          const selects = [
            document.getElementById('f_assignee'),          // 新增客户
            document.getElementById('edit_assignee'),       // 编辑客户
            document.getElementById('batch_assignee')       // 批量分配
          ];
          
          selects.forEach(select => {
            if (!select) return;
            select.innerHTML = '';
            employeesList.forEach(emp => {
              const option = document.createElement('option');
              option.value = emp.user_id;
              option.textContent = `${emp.name}${emp.is_admin ? ' (管理員)' : ''}`;
              select.appendChild(option);
            });
          });
        }

        function renderRows(rows) {
          tbody.innerHTML = '';
          if (!rows || rows.length === 0) {
            emptyEl.hidden = false;
            pager.hidden = true;
            return;
          }
          emptyEl.hidden = true;
          pager.hidden = false;
          rows.forEach((r) => {
            const tr = document.createElement('tr');
            // 修復：負責人顯示（使用 assigneeName，若無則顯示「未分配」）
            const assigneeName = r.assigneeName || r.assignee_name || '未分配';
            // 修復：標籤顯示（檢查是否為字串或陣列）
            let tagsHtml = '';
            if (r.tags && Array.isArray(r.tags) && r.tags.length > 0) {
              tagsHtml = r.tags.slice(0,3).map(t => {
                const tagName = typeof t === 'string' ? t : (t.tag_name || t.tagName || '');
                const tagColor = typeof t === 'object' ? (t.tag_color || t.tagColor || '#999') : '#999';
                return `<span class="chip" style="background:${tagColor}">${tagName}</span>`;
              }).join('');
              if (r.tags.length > 3) {
                tagsHtml += `<span class="chip" style="background:#ccc">+${r.tags.length - 3}</span>`;
              }
            }
            
            const serviceCount = (r.services && Array.isArray(r.services)) ? r.services.length : 0;
            const serviceCountHtml = serviceCount > 0 
              ? `<span class="service-count" style="background:#2563eb;color:#fff;padding:4px 10px;border-radius:12px;font-size:13px;font-weight:600;">${serviceCount} 個服務</span>`
              : '<span style="color:#9ca3af;">無</span>';
            
            tr.innerHTML = `
              <td><input type="checkbox" class="client-checkbox" data-client-id="${r.clientId}" /></td>
              <td><a href="/internal/client-detail?id=${r.clientId}" class="client-name-link" style="color:#2563eb;text-decoration:none;font-weight:600;">${r.companyName}</a></td>
              <td>${r.taxId||''}</td>
              <td>${assigneeName}</td>
              <td>${tagsHtml}</td>
              <td>${serviceCountHtml}</td>
              <td>${r.phone||''}</td>
              <td>${r.email||''}</td>
              <td>${r.createdAt||''}</td>
              <td>
                <button type="button" class="btn btn-sm btn-secondary" data-act="view" data-id="${r.clientId}">查看</button> 
                <button type="button" class="btn btn-sm btn-danger" data-act="del" data-id="${r.clientId}">刪除</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
          
          // 綁定操作按鈕事件
          tbody.addEventListener('click', function(e) {
            const btn = e.target.closest('button[data-act]');
            if (!btn) return;
            const action = btn.getAttribute('data-act');
            const clientId = btn.getAttribute('data-id');
            if (action === 'view') viewClient(clientId);
            if (action === 'del') deleteClient(clientId);
          });
        }

        let state = { page: 1, perPage: 50, total: 0, q: '' };

        async function load() {
          setError('');
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          // 修復：搜索支持公司名稱和統一編號
          if (state.q) {
            // 如果搜索詞是8位數字，則搜索統編；否則搜索公司名稱
            if (/^\d{8}$/.test(state.q)) {
              params.set('client_id', state.q);
            } else {
              params.set('company_name', state.q);
            }
          }
          try {
            const res = await fetch(`${apiBase}/clients?${params.toString()}`, { credentials: 'include' });
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) {
              throw new Error((json && json.message) || '載入失敗');
            }
            const rows = json.data || [];
            renderRows(rows);
            const meta = json.meta || {};
            state.total = meta.total || 0;
            renderPager();
          } catch (err) {
            setError('載入失敗，請稍後再試');
          }
        }

        function renderPager() {
          const hasNext = state.page * state.perPage < state.total;
          const prevBtn = document.getElementById('prev');
          const nextBtn = document.getElementById('next');
          prevBtn.disabled = state.page <= 1;
          nextBtn.disabled = !hasNext;
        }

        function applySearch() {
          state.q = (qEl.value||'').trim();
          state.page = 1;
          load();
        }

        let timer = null;
        qEl.addEventListener('input', function () {
          clearTimeout(timer);
          timer = setTimeout(applySearch, 300);
        });
        document.getElementById('btn-search').addEventListener('click', applySearch);
        document.getElementById('prev').addEventListener('click', function(){ if (state.page>1) { state.page--; load(); } });
        document.getElementById('next').addEventListener('click', function(){ state.page++; load(); });

        // 初始化載入
        loadEmployees(); // 加载员工列表
        load();

        // —— 查看客戶詳情 ——
        async function viewClient(clientId) {
          // 跳轉到客戶詳情頁
          window.location.href = `/internal/client-detail?id=${clientId}`;
        }
        
        // —— 刪除客戶 ——
        async function deleteClient(clientId) {
          if (!confirm('確定要刪除此客戶嗎？刪除後將無法復原。')) {
            return;
          }
          
          try {
            const res = await fetch(`${apiBase}/clients/${clientId}`, {
              method: 'DELETE',
              credentials: 'include'
            });
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/clients');
              return;
            }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) {
              throw new Error((json && json.message) || '刪除失敗');
            }
            alert('已刪除');
            load(); // 重新載入列表
          } catch (err) {
            alert('刪除失敗，請稍後再試');
          }
        }
        

        // ========== 標籤管理 ==========

        let allTags = [];

        // 打開標籤管理 Modal
        document.getElementById('btn-tags').addEventListener('click', function() {
          openTagsModal();
          loadTags();
        });

        function openTagsModal() { tagsModal.classList.add('active'); tagsModal.setAttribute('aria-hidden','false'); }
        function closeTagsModal() { tagsModal.classList.remove('active'); tagsModal.setAttribute('aria-hidden','true'); }
        tagsCloseBtn.addEventListener('click', closeTagsModal);

        // 載入標籤列表
        async function loadTags() {
          try {
            const res = await fetch(`${apiBase}/tags`, { credentials: 'include' });
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/clients');
              return;
            }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) {
              throw new Error((json && json.message) || '載入失敗');
            }
            allTags = json.data || [];
            renderTags();
          } catch (err) {
            console.error('載入標籤失敗', err);
          }
        }

        // 渲染標籤列表
        function renderTags() {
          const container = document.getElementById('tags-list');
          if (allTags.length === 0) {
            container.innerHTML = '<p style="color:#999;text-align:center;padding:24px 0;">尚無標籤</p>';
            return;
          }
          container.innerHTML = allTags.map(tag => {
            const color = tag.tag_color || '#999';
            return `
              <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;border:1px solid #e0e0e0;border-radius:8px;background:#fff;">
                <div style="display:flex;align-items:center;gap:12px;">
                  <span class="chip" style="background:${color};padding:6px 12px;border-radius:4px;color:#fff;font-weight:500;">${tag.tag_name}</span>
                  <span style="color:#999;font-size:0.875rem;">${color}</span>
                </div>
                <div style="display:flex;gap:8px;">
                  <button class="clients-btn btn-secondary" type="button" onclick="editTag(${tag.tag_id})" style="padding:6px 12px;font-size:0.875rem;">編輯</button>
                  <button class="clients-btn" type="button" onclick="deleteTag(${tag.tag_id})" style="padding:6px 12px;font-size:0.875rem;background:#e74c3c;border-color:#e74c3c;">刪除</button>
                </div>
              </div>
            `;
          }).join('');
        }

        // 打開新增標籤 Modal
        document.getElementById('btn-tag-new').addEventListener('click', function() {
          document.getElementById('tag-form-title').textContent = '新增標籤';
          document.getElementById('tag_form_id').value = '';
          tagForm.reset();
          clearTagFormErrors();
          openTagFormModal();
        });

        function openTagFormModal() { tagFormModal.classList.add('active'); tagFormModal.setAttribute('aria-hidden','false'); }
        function closeTagFormModal() { tagFormModal.classList.remove('active'); tagFormModal.setAttribute('aria-hidden','true'); tagForm.reset(); clearTagFormErrors(); }
        tagFormCloseBtn.addEventListener('click', closeTagFormModal);
        tagFormCancelBtn.addEventListener('click', closeTagFormModal);

        function clearTagFormErrors() {
          ['name','color'].forEach(k => { 
            const el = document.getElementById('tag_e_'+k); 
            if (el) el.textContent=''; 
          });
        }

        // 顏色選擇器同步
        const colorInput = document.getElementById('tag_form_color');
        const colorPicker = document.getElementById('tag_color_picker');
        colorPicker.addEventListener('input', function() {
          colorInput.value = colorPicker.value;
        });
        colorInput.addEventListener('input', function() {
          if (/^#[0-9A-Fa-f]{6}$/.test(colorInput.value)) {
            colorPicker.value = colorInput.value;
          }
        });

        // 編輯標籤（全域函數）
        window.editTag = async function(tagId) {
          const tag = allTags.find(t => t.tag_id === tagId);
          if (!tag) {
            alert('標籤不存在');
            return;
          }
          document.getElementById('tag-form-title').textContent = '編輯標籤';
          document.getElementById('tag_form_id').value = tag.tag_id;
          document.getElementById('tag_form_name').value = tag.tag_name;
          document.getElementById('tag_form_color').value = tag.tag_color || '';
          if (tag.tag_color && /^#[0-9A-Fa-f]{6}$/.test(tag.tag_color)) {
            document.getElementById('tag_color_picker').value = tag.tag_color;
          }
          clearTagFormErrors();
          openTagFormModal();
        };

        // 刪除標籤（全域函數）
        window.deleteTag = async function(tagId) {
          if (!confirm('確定要刪除此標籤嗎？\n若有客戶使用此標籤，將無法刪除。')) {
            return;
          }
          try {
            const res = await fetch(`${apiBase}/tags/${tagId}`, {
              method: 'DELETE',
              credentials: 'include'
            });
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/clients');
              return;
            }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) {
              throw new Error((json && json.message) || '刪除失敗');
            }
            alert('已刪除');
            loadTags();
          } catch (err) {
            alert(err.message || '刪除失敗，請稍後再試');
          }
        };

        // 標籤表單提交
        tagForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          clearTagFormErrors();
          const tagId = document.getElementById('tag_form_id').value;
          const tag_name = document.getElementById('tag_form_name').value.trim();
          const tag_color = document.getElementById('tag_form_color').value.trim();

          let hasErr = false;
          if (!tag_name || tag_name.length < 1 || tag_name.length > 50) {
            document.getElementById('tag_e_name').textContent = '標籤名稱為必填（1-50字）';
            hasErr = true;
          }
          if (tag_color && !/^#[0-9A-Fa-f]{6}$/.test(tag_color)) {
            document.getElementById('tag_e_color').textContent = '顏色碼格式錯誤（需為 #RRGGBB）';
            hasErr = true;
          }
          if (hasErr) return;

          const payload = { tag_name, tag_color: tag_color || null };
          const submitBtn = document.getElementById('btn-tag-form-submit');
          submitBtn.disabled = true;
          submitBtn.textContent = '儲存中…';

          try {
            const isEdit = tagId !== '';
            const url = isEdit ? `${apiBase}/tags/${tagId}` : `${apiBase}/tags`;
            const method = isEdit ? 'PUT' : 'POST';
            const res = await fetch(url, {
              method,
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload)
            });
            const json = await res.json().catch(() => null);
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/clients');
              return;
            }
            if (!res.ok || !json || json.ok !== true) {
              const msg = (json && json.message) || '儲存失敗';
              if (json && Array.isArray(json.errors) && json.errors.length > 0) {
                const e = json.errors[0];
                const field = e.field === 'tag_name' ? 'name' : e.field === 'tag_color' ? 'color' : '';
                const el = document.getElementById('tag_e_' + field);
                if (el) el.textContent = e.message || msg;
                else alert(msg);
              } else {
                alert(msg);
              }
              return;
            }
            alert(isEdit ? '已更新' : '已新增');
            closeTagFormModal();
            loadTags();
          } catch (err) {
            alert('儲存失敗，請稍後再試');
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = '儲存';
          }
        });

        // ========== 批量分配負責人 ==========

        const batchAssignModal = document.getElementById('batchAssignModal');
        const batchAssignForm = document.getElementById('batchAssignForm');
        const batchAssignCloseBtn = document.getElementById('btn-batch-assign-close');
        const batchAssignCancelBtn = document.getElementById('btn-batch-assign-cancel');
        const batchActionsDiv = document.getElementById('batch-actions');
        const selectAllCheckbox = document.getElementById('select-all');
        let selectedClientIds = [];

        // 全選/取消全選
        selectAllCheckbox.addEventListener('change', function() {
          const checkboxes = document.querySelectorAll('.client-checkbox');
          checkboxes.forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
          });
          updateSelectedClients();
        });

        // 監聽多選框變化
        tbody.addEventListener('change', function(e) {
          if (e.target.classList.contains('client-checkbox')) {
            updateSelectedClients();
          }
        });

        // 更新已選擇的客戶
        function updateSelectedClients() {
          const checkboxes = document.querySelectorAll('.client-checkbox:checked');
          selectedClientIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-client-id'));
          
          if (selectedClientIds.length > 0) {
            batchActionsDiv.style.display = 'flex';
            document.getElementById('batch-count').textContent = selectedClientIds.length;
          } else {
            batchActionsDiv.style.display = 'none';
          }
          
          // 更新全選框狀態
          const allCheckboxes = document.querySelectorAll('.client-checkbox');
          selectAllCheckbox.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
        }

        // 取消選擇
        document.getElementById('btn-cancel-select').addEventListener('click', function() {
          const checkboxes = document.querySelectorAll('.client-checkbox');
          checkboxes.forEach(cb => cb.checked = false);
          selectAllCheckbox.checked = false;
          updateSelectedClients();
        });

        // 打開批量分配 Modal
        document.getElementById('btn-batch-assign').addEventListener('click', function() {
          if (selectedClientIds.length === 0) {
            alert('請先選擇客戶');
            return;
          }
          if (selectedClientIds.length > 100) {
            alert('一次最多分配 100 個客戶');
            return;
          }
          document.getElementById('batch-count').textContent = selectedClientIds.length;
          openBatchAssignModal();
        });

        function openBatchAssignModal() { batchAssignModal.classList.add('active'); batchAssignModal.setAttribute('aria-hidden','false'); }
        function closeBatchAssignModal() { batchAssignModal.classList.remove('active'); batchAssignModal.setAttribute('aria-hidden','true'); batchAssignForm.reset(); clearBatchAssignErrors(); }
        batchAssignCloseBtn.addEventListener('click', closeBatchAssignModal);
        batchAssignCancelBtn.addEventListener('click', closeBatchAssignModal);

        function clearBatchAssignErrors() {
          const el = document.getElementById('batch_e_assignee');
          if (el) el.textContent = '';
        }

        // 批量分配表單提交
        batchAssignForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          clearBatchAssignErrors();
          const assignee_user_id = parseInt(document.getElementById('batch_assignee').value, 10);

          if (!Number.isInteger(assignee_user_id) || assignee_user_id <= 0) {
            document.getElementById('batch_e_assignee').textContent = '請選擇負責人員';
            return;
          }

          const payload = { client_ids: selectedClientIds, assignee_user_id };
          const submitBtn = document.getElementById('btn-batch-assign-submit');
          submitBtn.disabled = true;
          submitBtn.textContent = '分配中…';

          try {
            const res = await fetch(`${apiBase}/clients/batch-assign`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload)
            });
            const json = await res.json().catch(() => null);
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/clients');
              return;
            }
            if (res.status === 403) {
              alert('權限不足，僅管理員可執行批量分配');
              return;
            }
            if (!res.ok || !json || json.ok !== true) {
              const msg = (json && json.message) || '分配失敗';
              alert(msg);
              return;
            }
            alert(json.message || '已完成批量分配');
            closeBatchAssignModal();
            // 清除選擇
            const checkboxes = document.querySelectorAll('.client-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            selectAllCheckbox.checked = false;
            updateSelectedClients();
            // 重新載入列表
            load();
          } catch (err) {
            alert('分配失敗，請稍後再試');
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = '批量分配';
          }
        });

      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


