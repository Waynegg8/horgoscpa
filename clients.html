<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="å®¢æˆ¶ç®¡ç†åˆ—è¡¨" />
    <title>å®¢æˆ¶ç®¡ç†ï½œåˆ—è¡¨</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/internal-system.css?v=3" />
    <link rel="stylesheet" href="/assets/css/internal-components.css?v=3" />
    <link rel="stylesheet" href="/assets/css/clients-page.css?v=9" />
    
    <!-- âš¡ é åŠ è¼‰ç³»çµ±ï¼ˆå¿…é ˆåœ¨æ‰€æœ‰å…¶ä»–è…³æœ¬ä¹‹å‰åŠ è¼‰ï¼‰ -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <script src="/assets/js/prerender.js"></script>
    <script src="/assets/js/page-prerender.js"></script>
    <script>
    // ç«‹å³å•Ÿå‹•é åŠ è¼‰ï¼ˆå¦‚æœå°šæœªå•Ÿå‹•ï¼‰
    if (window.DataCache && !window.DataCache.getPreloadStatus().isPreloading) {
      const status = window.DataCache.getPreloadStatus();
      if (status.completed.length === 0) {
        console.log('[Clients] ğŸš€ å•Ÿå‹•èƒŒæ™¯é åŠ è¼‰');
        window.DataCache.preloadAll({ adminMode: true });
      } else {
        console.log(`[Clients] âœ… é åŠ è¼‰å·²å®Œæˆ ${status.completed.length}/${status.total} é …`);
      }
    }
    
    // âš¡ é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–é¢„æ¸²æŸ“
    document.addEventListener('DOMContentLoaded', function() {
      if (window.PagePrerender) {
        // å°è¯•åŠ è½½é¢„æ¸²æŸ“ HTML
        window.PagePrerender.init('.clients-card', function(isBackgroundUpdate) {
          if (isBackgroundUpdate) {
            console.log('[Clients] ğŸ”„ åå°æ›´æ–°æ•°æ®');
          }
        });
        
        // å¯ç”¨è‡ªåŠ¨ä¿å­˜
        window.PagePrerender.autoSave('.clients-card');
      }
    });
    </script>
  </head>
  <body class="clients-page">
    <main class="clients-content" style="padding: 20px;">
      <section class="clients-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 16px; flex-wrap: wrap;">
          <div style="display: flex; gap: 12px; align-items: center; flex: 1;">
            <div class="clients-search" style="flex: 1; max-width: 400px;">
              <input id="q" type="search" placeholder="æœå°‹å…¬å¸åç¨±æˆ–çµ±ç·¨â€¦" aria-label="æœå°‹" />
            </div>
            <select id="tag-filter" style="padding: 10px 14px; border: 1px solid rgba(15,23,42,0.15); border-radius: 8px; font-size: 14px; background: white; color: #374151; cursor: pointer;">
              <option value="">å…¨éƒ¨æ¨™ç±¤</option>
            </select>
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <div id="batch-actions" style="display:none;gap:8px;">
              <button id="btn-batch-assign" class="clients-btn btn-secondary" type="button">æ‰¹é‡åˆ†é…è² è²¬äºº</button>
              <button id="btn-cancel-select" class="clients-btn btn-secondary" type="button">å–æ¶ˆé¸æ“‡</button>
            </div>
            <button onclick="window.location.href='/internal/client-new'" class="clients-btn" type="button">+ æ–°å¢å®¢æˆ¶</button>
          </div>
        </div>
        
        <p id="clients-error" style="color:#c0392b;min-height:1.25rem;margin:0 0 8px 0;"></p>
        <div id="empty" class="clients-empty" hidden>
          <p>å°šç„¡å®¢æˆ¶</p>
          <p><button onclick="window.location.href='/internal/client-new'" class="clients-btn" type="button">æ–°å¢å®¢æˆ¶</button></p>
        </div>
        <div class="clients-table-wrap">
          <table class="clients-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="select-all" aria-label="å…¨é¸" /></th>
                <th>å…¬å¸åç¨±</th>
                <th>çµ±ä¸€ç·¨è™Ÿ</th>
                <th>è¯çµ¡äºº</th>
                <th>è² è²¬äºº</th>
                <th>æ¨™ç±¤</th>
                <th>æœå‹™æ•¸é‡</th>
                <th>å…¨å¹´æ”¶è²»ç¸½é¡</th>
                <th>é›»è©±</th>
                <th>Email</th>
                <th>å»ºç«‹æ™‚é–“</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- å‹•æ…‹è¼‰å…¥ -->
            </tbody>
          </table>
        </div>
        <div class="clients-pagination" id="pager" hidden>
          <button type="button" id="prev">ä¸Šä¸€é </button>
          <button type="button" id="next">ä¸‹ä¸€é </button>
        </div>
      </section>
    </main>

    <!-- æ‰¹é‡åˆ†é…è² è²¬äººå½ˆçª— -->
    <div class="modal-overlay" id="batchAssignModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal" role="document">
        <div class="modal__header">
          <h2 class="modal__title">æ‰¹é‡åˆ†é…è² è²¬äºº</h2>
          <button class="modal__close" type="button" id="btn-batch-assign-close">âœ•</button>
        </div>
        <div class="modal__body">
          <form id="batchAssignForm" class="form-grid">
            <div class="field" style="grid-column:1 / -1;">
              <label>å·²é¸æ“‡ <strong id="batch-count">0</strong> å€‹å®¢æˆ¶</label>
            </div>
            <div class="field" style="grid-column:1 / -1;">
              <label for="batch_assignee">æ–°çš„è² è²¬äººå“¡ï¼ˆå¿…å¡«ï¼‰</label>
              <select id="batch_assignee" name="assignee_user_id" required>
                <option value="1">1 ç®¡ç†å“¡</option>
              </select>
              <div class="field__error" id="batch_e_assignee"></div>
            </div>
            <div class="modal__actions" style="grid-column:1 / -1;">
              <button class="clients-btn btn-secondary" type="button" id="btn-batch-assign-cancel">å–æ¶ˆ</button>
              <button class="clients-btn" type="submit" id="btn-batch-assign-submit">æ‰¹é‡åˆ†é…</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
        const qEl = document.getElementById('q');
        const tbody = document.getElementById('tbody');
        const emptyEl = document.getElementById('empty');
        const pager = document.getElementById('pager');
        const errEl = document.getElementById('clients-error');

        function setError(msg){ if (errEl) errEl.textContent = msg || ''; }

        // åŠ è½½å‘˜å·¥åˆ—è¡¨å¹¶å¡«å……ä¸‹æ‹‰é€‰å•
        let employeesList = [];
        async function loadEmployees() {
          try {
            const res = await fetch(`${apiBase}/users`, {
              method: 'GET',
              credentials: 'include'
            });
            const json = await res.json();
            if (json.ok && Array.isArray(json.data)) {
              employeesList = json.data;
              populateEmployeeSelects();
            }
          } catch (err) {
            console.error('åŠ è½½å‘˜å·¥åˆ—è¡¨å¤±è´¥', err);
          }
        }
        
        // åŠ è½½æ ‡ç­¾åˆ—è¡¨å¹¶å¡«å……ç­›é€‰ä¸‹æ‹‰é€‰å•
        let allTags = [];
        async function loadTags() {
          try {
            const res = await fetch(`${apiBase}/tags`, {
              method: 'GET',
              credentials: 'include'
            });
            const json = await res.json();
            if (json.ok && Array.isArray(json.data)) {
              allTags = json.data;
              populateTagFilter();
            }
          } catch (err) {
            console.error('åŠ è½½æ ‡ç­¾åˆ—è¡¨å¤±è´¥', err);
          }
        }
        
        function populateTagFilter() {
          const tagFilter = document.getElementById('tag-filter');
          if (!tagFilter) return;
          
          tagFilter.innerHTML = '<option value="">å…¨éƒ¨æ¨™ç±¤</option>';
          allTags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag.tag_id;
            option.textContent = tag.tag_name;
            tagFilter.appendChild(option);
          });
        }
        
        function populateEmployeeSelects() {
          const selects = [
            document.getElementById('f_assignee'),          // æ–°å¢å®¢æˆ·
            document.getElementById('edit_assignee'),       // ç¼–è¾‘å®¢æˆ·
            document.getElementById('batch_assignee')       // æ‰¹é‡åˆ†é…
          ];
          
          selects.forEach(select => {
            if (!select) return;
            select.innerHTML = '';
            employeesList.forEach(emp => {
              const option = document.createElement('option');
              option.value = emp.user_id;
              option.textContent = `${emp.name}${emp.is_admin ? ' (ç®¡ç†å“¡)' : ''}`;
              select.appendChild(option);
            });
          });
        }

        function renderRows(rows) {
          tbody.innerHTML = '';
          if (!rows || rows.length === 0) {
            emptyEl.hidden = false;
            pager.hidden = true;
            return;
          }
          emptyEl.hidden = true;
          pager.hidden = false;
          rows.forEach((r) => {
            const tr = document.createElement('tr');
            // ä¿®å¾©ï¼šè² è²¬äººé¡¯ç¤ºï¼ˆä½¿ç”¨ assigneeNameï¼Œè‹¥ç„¡å‰‡é¡¯ç¤ºã€Œæœªåˆ†é…ã€ï¼‰
            const assigneeName = r.assigneeName || r.assignee_name || 'æœªåˆ†é…';
            // ä¿®å¾©ï¼šæ¨™ç±¤é¡¯ç¤ºï¼ˆæª¢æŸ¥æ˜¯å¦ç‚ºå­—ä¸²æˆ–é™£åˆ—ï¼‰
            let tagsHtml = '';
            if (r.tags && Array.isArray(r.tags) && r.tags.length > 0) {
              tagsHtml = r.tags.slice(0,3).map(t => {
                const tagName = typeof t === 'string' ? t : (t.tag_name || t.tagName || '');
                const tagColor = typeof t === 'object' ? (t.tag_color || t.tagColor || '#999') : '#999';
                return `<span class="chip" style="background:${tagColor}">${tagName}</span>`;
              }).join('');
              if (r.tags.length > 3) {
                tagsHtml += `<span class="chip" style="background:#ccc">+${r.tags.length - 3}</span>`;
              }
            }
            
            const serviceCount = (r.services && Array.isArray(r.services)) ? r.services.length : 0;
            const serviceCountHtml = serviceCount > 0 
              ? `<span class="service-count" style="background:#2563eb;color:#fff;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;">${serviceCount}</span>`
              : '<span class="text-muted">ç„¡</span>';
            
            // å…¨å¹´æ”¶è´¹æ€»é¢ï¼ˆéœ€è¦ä»åç«¯APIè¿”å›ï¼‰
            const yearTotal = r.year_total || r.yearTotal || 0;
            const yearTotalHtml = yearTotal > 0 
              ? `<span class="text-success">NT$ ${yearTotal.toLocaleString()}</span>`
              : '<span class="text-muted">-</span>';
            
            // è”ç»œäººæ˜¾ç¤ºï¼ˆæ˜¾ç¤ºç¬¬ä¸€ä¸ªè”ç»œäººï¼‰
            const contactPerson = r.contact_person_1 || r.contactPerson1 || '';
            
            // å»ºç«‹æ—¶é—´æ ¼å¼åŒ–ï¼ˆåªæ˜¾ç¤ºåˆ°æ—¥æœŸï¼‰
            const createdDate = r.createdAt ? r.createdAt.split('T')[0].split(' ')[0] : '';
            
            tr.innerHTML = `
              <td><input type="checkbox" class="client-checkbox" data-client-id="${r.clientId}" /></td>
              <td><a href="/internal/client-detail?id=${r.clientId}" class="client-name-link">${r.companyName}</a></td>
              <td>${r.taxId||''}</td>
              <td>${contactPerson}</td>
              <td>${assigneeName}</td>
              <td>${tagsHtml}</td>
              <td>${serviceCountHtml}</td>
              <td>${yearTotalHtml}</td>
              <td>${r.phone||''}</td>
              <td>${r.email||''}</td>
              <td>${createdDate}</td>
              <td>
                <button type="button" class="btn btn-sm btn-secondary" data-act="view" data-id="${r.clientId}">æŸ¥çœ‹</button>
                <button type="button" class="btn btn-sm btn-danger" data-act="del" data-id="${r.clientId}">åˆªé™¤</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }

        let state = { page: 1, perPage: 50, total: 0, q: '', tag_id: '' };

        async function load() {
          setError('');
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          // æœç´¢æ”¯æŒå…¬å¸åç¨±å’Œçµ±ä¸€ç·¨è™Ÿ
          if (state.q) {
            params.set('q', state.q);
          }
          // æ ‡ç­¾ç­›é€‰
          if (state.tag_id) {
            params.set('tag_id', state.tag_id);
          }
          try {
            const res = await fetch(`${apiBase}/clients?${params.toString()}`, { credentials: 'include' });
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) {
              throw new Error((json && json.message) || 'è¼‰å…¥å¤±æ•—');
            }
            const rows = json.data || [];
            renderRows(rows);
            const meta = json.meta || {};
            state.total = meta.total || 0;
            renderPager();
          } catch (err) {
            setError('è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
        }

        function renderPager() {
          const hasNext = state.page * state.perPage < state.total;
          const prevBtn = document.getElementById('prev');
          const nextBtn = document.getElementById('next');
          prevBtn.disabled = state.page <= 1;
          nextBtn.disabled = !hasNext;
        }

        function applySearch() {
          state.q = (qEl.value||'').trim();
          state.page = 1;
          load();
        }

        function applyTagFilter() {
          const tagFilter = document.getElementById('tag-filter');
          state.tag_id = tagFilter.value;
          state.page = 1;
          load();
        }

        // å®æ—¶æœç´¢
        let timer = null;
        qEl.addEventListener('input', function () {
          clearTimeout(timer);
          timer = setTimeout(applySearch, 300);
        });
        
        // æ ‡ç­¾ç­›é€‰
        document.getElementById('tag-filter').addEventListener('change', applyTagFilter);
        
        document.getElementById('prev').addEventListener('click', function(){ if (state.page>1) { state.page--; load(); } });
        document.getElementById('next').addEventListener('click', function(){ state.page++; load(); });

        // åˆå§‹åŒ–è¼‰å…¥
        loadEmployees(); // åŠ è½½å‘˜å·¥åˆ—è¡¨
        loadTags(); // åŠ è½½æ ‡ç­¾åˆ—è¡¨
        load();
        
        // ç¶å®šæ“ä½œæŒ‰éˆ•äº‹ä»¶ï¼ˆå…¨å±€ç»‘å®šä¸€æ¬¡ï¼Œé¿å…é‡å¤ï¼‰
        tbody.addEventListener('click', function(e) {
          const btn = e.target.closest('button[data-act]');
          if (!btn) return;
          const action = btn.getAttribute('data-act');
          const clientId = btn.getAttribute('data-id');
          if (action === 'view') viewClient(clientId);
          if (action === 'del') deleteClient(clientId);
        });

        // â€”â€” æŸ¥çœ‹å®¢æˆ¶è©³æƒ… â€”â€”
        async function viewClient(clientId) {
          // è·³è½‰åˆ°å®¢æˆ¶è©³æƒ…é 
          window.location.href = `/internal/client-detail?id=${clientId}`;
        }
        
        // â€”â€” åˆªé™¤å®¢æˆ¶ â€”â€”
        async function deleteClient(clientId) {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å®¢æˆ¶å—ï¼Ÿåˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸã€‚')) {
            return;
          }
          
          try {
            const res = await fetch(`${apiBase}/clients/${clientId}`, {
              method: 'DELETE',
              credentials: 'include'
            });
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/clients');
              return;
            }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) {
              throw new Error((json && json.message) || 'åˆªé™¤å¤±æ•—');
            }
            alert('å·²åˆªé™¤');
            load(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
          } catch (err) {
            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
        }
        

        // ========== æ‰¹é‡åˆ†é…è² è²¬äºº ==========

        const batchAssignModal = document.getElementById('batchAssignModal');
        const batchAssignForm = document.getElementById('batchAssignForm');
        const batchAssignCloseBtn = document.getElementById('btn-batch-assign-close');
        const batchAssignCancelBtn = document.getElementById('btn-batch-assign-cancel');
        const batchActionsDiv = document.getElementById('batch-actions');
        const selectAllCheckbox = document.getElementById('select-all');
        let selectedClientIds = [];

        // å…¨é¸/å–æ¶ˆå…¨é¸
        selectAllCheckbox.addEventListener('change', function() {
          const checkboxes = document.querySelectorAll('.client-checkbox');
          checkboxes.forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
          });
          updateSelectedClients();
        });

        // ç›£è½å¤šé¸æ¡†è®ŠåŒ–
        tbody.addEventListener('change', function(e) {
          if (e.target.classList.contains('client-checkbox')) {
            updateSelectedClients();
          }
        });

        // æ›´æ–°å·²é¸æ“‡çš„å®¢æˆ¶
        function updateSelectedClients() {
          const checkboxes = document.querySelectorAll('.client-checkbox:checked');
          selectedClientIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-client-id'));
          
          if (selectedClientIds.length > 0) {
            batchActionsDiv.style.display = 'flex';
            document.getElementById('batch-count').textContent = selectedClientIds.length;
          } else {
            batchActionsDiv.style.display = 'none';
          }
          
          // æ›´æ–°å…¨é¸æ¡†ç‹€æ…‹
          const allCheckboxes = document.querySelectorAll('.client-checkbox');
          selectAllCheckbox.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
        }

        // å–æ¶ˆé¸æ“‡
        document.getElementById('btn-cancel-select').addEventListener('click', function() {
          const checkboxes = document.querySelectorAll('.client-checkbox');
          checkboxes.forEach(cb => cb.checked = false);
          selectAllCheckbox.checked = false;
          updateSelectedClients();
        });

        // æ‰“é–‹æ‰¹é‡åˆ†é… Modal
        document.getElementById('btn-batch-assign').addEventListener('click', function() {
          if (selectedClientIds.length === 0) {
            alert('è«‹å…ˆé¸æ“‡å®¢æˆ¶');
            return;
          }
          if (selectedClientIds.length > 100) {
            alert('ä¸€æ¬¡æœ€å¤šåˆ†é… 100 å€‹å®¢æˆ¶');
            return;
          }
          document.getElementById('batch-count').textContent = selectedClientIds.length;
          openBatchAssignModal();
        });

        function openBatchAssignModal() { batchAssignModal.classList.add('active'); batchAssignModal.setAttribute('aria-hidden','false'); }
        function closeBatchAssignModal() { batchAssignModal.classList.remove('active'); batchAssignModal.setAttribute('aria-hidden','true'); batchAssignForm.reset(); clearBatchAssignErrors(); }
        batchAssignCloseBtn.addEventListener('click', closeBatchAssignModal);
        batchAssignCancelBtn.addEventListener('click', closeBatchAssignModal);

        function clearBatchAssignErrors() {
          const el = document.getElementById('batch_e_assignee');
          if (el) el.textContent = '';
        }

        // æ‰¹é‡åˆ†é…è¡¨å–®æäº¤
        batchAssignForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          clearBatchAssignErrors();
          const assignee_user_id = parseInt(document.getElementById('batch_assignee').value, 10);

          if (!Number.isInteger(assignee_user_id) || assignee_user_id <= 0) {
            document.getElementById('batch_e_assignee').textContent = 'è«‹é¸æ“‡è² è²¬äººå“¡';
            return;
          }

          const payload = { client_ids: selectedClientIds, assignee_user_id };
          const submitBtn = document.getElementById('btn-batch-assign-submit');
          submitBtn.disabled = true;
          submitBtn.textContent = 'åˆ†é…ä¸­â€¦';

          try {
            const res = await fetch(`${apiBase}/clients/batch-assign`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload)
            });
            const json = await res.json().catch(() => null);
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/clients');
              return;
            }
            if (res.status === 403) {
              alert('æ¬Šé™ä¸è¶³ï¼Œåƒ…ç®¡ç†å“¡å¯åŸ·è¡Œæ‰¹é‡åˆ†é…');
              return;
            }
            if (!res.ok || !json || json.ok !== true) {
              const msg = (json && json.message) || 'åˆ†é…å¤±æ•—';
              alert(msg);
              return;
            }
            alert(json.message || 'å·²å®Œæˆæ‰¹é‡åˆ†é…');
            closeBatchAssignModal();
            // æ¸…é™¤é¸æ“‡
            const checkboxes = document.querySelectorAll('.client-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            selectAllCheckbox.checked = false;
            updateSelectedClients();
            // é‡æ–°è¼‰å…¥åˆ—è¡¨
            load();
          } catch (err) {
            alert('åˆ†é…å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'æ‰¹é‡åˆ†é…';
          }
        });

      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


