<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ç·¨è¼¯ FAQï½œCMS</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    
    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    
    <style>
      * { box-sizing: border-box; }
      body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif; background: #f5f7fa; }
      
      .top-toolbar { background: white; border-bottom: 2px solid #e5e7eb; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
      .top-toolbar-left { display: flex; gap: 12px; align-items: center; }
      .top-toolbar-right { display: flex; gap: 12px; }
      
      .btn { padding: 10px 20px; border: 2px solid #e0e0e0; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 6px; }
      .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
      .btn.primary { background: linear-gradient(135deg, #2c5f7c 0%, #1e4a63 100%); color: white; border-color: #2c5f7c; }
      .btn.secondary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-color: #10b981; }
      
      .editor-layout { display: grid; grid-template-columns: 1fr 1fr; height: calc(100vh - 70px); gap: 0; }
      
      .editor-panel { background: white; display: flex; flex-direction: column; overflow: hidden; border-right: 2px solid #e5e7eb; }
      .editor-header { padding: 24px; border-bottom: 2px solid #f0f0f0; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); }
      .editor-header h2 { margin: 0 0 16px 0; color: #2c5f7c; font-size: 18px; display: flex; align-items: center; gap: 8px; }
      
      .form-group { margin-bottom: 16px; }
      .form-group label { display: block; font-weight: 600; margin-bottom: 6px; color: #374151; font-size: 14px; }
      .form-group input[type="text"], .form-group input[type="number"], .form-group select { width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: all 0.3s; }
      .form-group input:focus, .form-group select:focus { outline: none; border-color: #2c5f7c; box-shadow: 0 0 0 3px rgba(44, 95, 124, 0.1); }
      
      .form-row { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; }
      
      .editor-content { flex: 1; overflow: auto; padding: 24px; }
      #quill-editor { height: 100%; background: white; }
      .ql-container { font-size: 16px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif; }
      
      .preview-panel { background: #e5e7eb; display: flex; flex-direction: column; overflow: hidden; }
      .preview-header { padding: 16px 24px; background: white; border-bottom: 2px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
      .preview-header h2 { margin: 0; color: #2c5f7c; font-size: 18px; display: flex; align-items: center; gap: 8px; }
      .preview-content { flex: 1; overflow: auto; padding: 24px; }
      .preview-card { background: white; max-width: 800px; margin: 0 auto; padding: 32px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); }
      
      .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }
      .loading-spinner { background: white; padding: 32px 48px; border-radius: 12px; text-align: center; }
      .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #2c5f7c; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      @media (max-width: 1200px) { .editor-layout { grid-template-columns: 1fr; } .preview-panel { display: none; } }
    </style>
  </head>
  <body>
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
      <div class="loading-spinner"><div class="spinner"></div><div>è™•ç†ä¸­...</div></div>
    </div>
    
    <div class="top-toolbar">
      <div class="top-toolbar-left">
        <button class="btn" onclick="goBack()">â† è¿”å›åˆ—è¡¨</button>
        <span id="faqStatus" style="font-weight: 600; color: #6b7280;">è‰ç¨¿</span>
      </div>
      <div class="top-toolbar-right">
        <button class="btn" id="btnSaveDraft">ğŸ’¾ ä¿å­˜è‰ç¨¿</button>
        <button class="btn secondary" id="btnPublish">âœ“ ç™¼å¸ƒ FAQ</button>
      </div>
    </div>
    
    <div class="editor-layout">
      <div class="editor-panel">
        <div class="editor-header">
          <h2>â“ FAQ ç·¨è¼¯</h2>
          
          <div class="form-row">
            <div class="form-group">
              <label for="faqCategory">åˆ†é¡ *</label>
              <select id="faqCategory" required>
                <option value="">é¸æ“‡åˆ†é¡</option>
                <option value="ç¨…å‹™è«®è©¢">ç¨…å‹™è«®è©¢</option>
                <option value="æœƒè¨ˆæœå‹™">æœƒè¨ˆæœå‹™</option>
                <option value="å…¬å¸ç™»è¨˜">å…¬å¸ç™»è¨˜</option>
                <option value="å¯©è¨ˆæœå‹™">å¯©è¨ˆæœå‹™</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
              </select>
            </div>
            <div class="form-group">
              <label for="faqSortOrder">æ’åº</label>
              <input type="number" id="faqSortOrder" value="0" min="0" max="999">
            </div>
          </div>
          
          <div class="form-group">
            <label for="faqQuestion">å•é¡Œ *</label>
            <input type="text" id="faqQuestion" placeholder="è¼¸å…¥å¸¸è¦‹å•é¡Œ..." maxlength="200" required>
          </div>
        </div>
        
        <div class="editor-content">
          <div style="margin-bottom: 12px; font-weight: 600; color: #374151;">ç­”æ¡ˆ *</div>
          <div id="quill-editor"></div>
        </div>
      </div>
      
      <div class="preview-panel">
        <div class="preview-header">
          <h2>ğŸ‘ï¸ é è¦½æ•ˆæœ</h2>
        </div>
        <div class="preview-content">
          <div class="preview-card">
            <div id="faq-preview">
              <div style="color: #6b7280; text-align: center; padding: 60px 0;">é–‹å§‹è¼¸å…¥å…§å®¹...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
    
    <script>
      const onProdHost = location.hostname.endsWith('horgoscpa.com');
      const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
      
      let quill = null;
      let currentFaqId = null;
      let previewUpdateTimer = null;
      
      const urlParams = new URLSearchParams(window.location.search);
      currentFaqId = urlParams.get('id');
      
      document.addEventListener('DOMContentLoaded', async () => {
        await checkAuth();
        initQuillEditor();
        
        if (currentFaqId) {
          loadFAQ(currentFaqId);
        } else {
          updatePreview();
        }
        
        document.getElementById('btnSaveDraft').addEventListener('click', () => saveFAQ(false));
        document.getElementById('btnPublish').addEventListener('click', () => saveFAQ(true));
        
        document.getElementById('faqCategory').addEventListener('change', schedulePreviewUpdate);
        document.getElementById('faqQuestion').addEventListener('input', schedulePreviewUpdate);
        quill.on('text-change', schedulePreviewUpdate);
      });
      
      async function checkAuth() {
        try {
          const res = await fetch(`${apiBase}/auth/me`, { credentials: 'include' });
          if (res.status === 401) {
            location.assign('/login?redirect=' + encodeURIComponent(location.pathname + location.search));
            return;
          }
          const json = await res.json();
          if (!json?.ok || !json?.data?.isAdmin) {
            alert('æ‚¨æ²’æœ‰æ¬Šé™å­˜å–æ­¤é é¢');
            location.assign('/internal/cms');
          }
        } catch (err) {
          alert('èªè­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥');
          location.assign('/login');
        }
      }
      
      function initQuillEditor() {
        quill = new Quill('#quill-editor', {
          theme: 'snow',
          modules: {
            toolbar: [
              [{ 'header': [3, false] }],
              ['bold', 'italic', 'underline'],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              ['link'],
              [{ 'color': [] }],
              ['clean']
            ]
          },
          placeholder: 'è¼¸å…¥ FAQ ç­”æ¡ˆ...'
        });
      }
      
      function schedulePreviewUpdate() {
        clearTimeout(previewUpdateTimer);
        previewUpdateTimer = setTimeout(updatePreview, 300);
      }
      
      function updatePreview() {
        const category = document.getElementById('faqCategory').value || 'æœªåˆ†é¡';
        const question = document.getElementById('faqQuestion').value || 'å•é¡Œæ¨™é¡Œ';
        const answer = quill.root.innerHTML;
        
        const previewHTML = `
          <div style="border-left: 4px solid #2c5f7c; padding-left: 16px; margin-bottom: 24px;">
            <div style="color: #2c5f7c; font-weight: 600; font-size: 13px; margin-bottom: 8px;">ğŸ“ ${category}</div>
            <h3 style="font-size: 20px; font-weight: 700; color: #1f2937; margin: 0 0 12px 0;">${question}</h3>
            <div style="font-size: 16px; line-height: 1.8; color: #374151;">
              ${answer || '<p style="color: #9ca3af;">é–‹å§‹è¼¸å…¥ç­”æ¡ˆ...</p>'}
            </div>
          </div>
        `;
        
        document.getElementById('faq-preview').innerHTML = previewHTML;
      }
      
      async function loadFAQ(id) {
        try {
          showLoading();
          const res = await fetch(`${apiBase}/admin/faq/${id}`, { credentials: 'include' });
          if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
          
          const json = await res.json();
          if (!json.ok) throw new Error(json.message || 'è¼‰å…¥å¤±æ•—');
          
          const faq = json.data;
          document.getElementById('faqCategory').value = faq.category || '';
          document.getElementById('faqQuestion').value = faq.question || '';
          document.getElementById('faqSortOrder').value = faq.sortOrder || 0;
          quill.root.innerHTML = faq.answer || '';
          
          if (faq.isPublished) {
            document.getElementById('faqStatus').textContent = 'å·²ç™¼å¸ƒ';
            document.getElementById('faqStatus').style.color = '#10b981';
          }
          
          updatePreview();
        } catch (err) {
          alert('è¼‰å…¥ FAQ å¤±æ•—ï¼š' + err.message);
          console.error(err);
        } finally {
          hideLoading();
        }
      }
      
      async function saveFAQ(publish = false) {
        const category = document.getElementById('faqCategory').value.trim();
        const question = document.getElementById('faqQuestion').value.trim();
        const answer = quill.root.innerHTML;
        
        if (!category) {
          alert('è«‹é¸æ“‡åˆ†é¡');
          return;
        }
        
        if (!question) {
          alert('è«‹è¼¸å…¥å•é¡Œ');
          return;
        }
        
        if (!answer || answer === '<p><br></p>') {
          alert('è«‹è¼¸å…¥ç­”æ¡ˆ');
          return;
        }
        
        const data = {
          category,
          question,
          answer,
          sortOrder: parseInt(document.getElementById('faqSortOrder').value) || 0,
          isPublished: publish
        };
        
        try {
          showLoading();
          const url = currentFaqId 
            ? `${apiBase}/admin/faq/${currentFaqId}` 
            : `${apiBase}/admin/faq`;
          const method = currentFaqId ? 'PUT' : 'POST';
          
          const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
          });
          
          const json = await res.json();
          if (!res.ok || !json.ok) {
            throw new Error(json.message || 'ä¿å­˜å¤±æ•—');
          }
          
          alert(publish ? 'FAQ å·²ç™¼å¸ƒï¼' : 'FAQ å·²ä¿å­˜ï¼');
          
          if (!currentFaqId && json.data?.id) {
            currentFaqId = json.data.id;
            history.replaceState(null, '', `?id=${currentFaqId}`);
          }
          
          if (publish) {
            document.getElementById('faqStatus').textContent = 'å·²ç™¼å¸ƒ';
            document.getElementById('faqStatus').style.color = '#10b981';
          }
        } catch (err) {
          alert('ä¿å­˜å¤±æ•—ï¼š' + err.message);
          console.error(err);
        } finally {
          hideLoading();
        }
      }
      
      function goBack() {
        if (confirm('ç¢ºå®šè¦é›¢é–‹ï¼Ÿæœªä¿å­˜çš„å…§å®¹å°‡æœƒä¸Ÿå¤±ã€‚')) {
          location.assign('/internal/cms');
        }
      }
      
      function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
      }
      
      function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
      }
    </script>
  </body>
</html>

