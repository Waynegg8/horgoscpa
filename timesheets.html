<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="工時管理" />
    <title>工時管理｜列表</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/timesheet-page.css" />
  </head>
  <body class="internal-container">
    <main>
      <section class="month-info">
        <h3 id="monthTitle">本月：2025-10</h3>
        <div class="total-hours">本月累計：<span id="sumHours">0</span> 小時</div>
      </section>

      <section class="control-row" aria-label="篩選器">
        <div class="control-group">
          <label for="dateFrom">起日</label>
          <input id="dateFrom" type="date" />
          <label for="dateTo">迄日</label>
          <input id="dateTo" type="date" />
        </div>
        <div class="control-group">
          <label for="kw">關鍵字</label>
          <input id="kw" type="search" placeholder="客戶/服務/備註…" />
        </div>
        <div class="control-group">
          <label for="type">工作類型</label>
          <select id="type">
            <option value="">全部</option>
            <option value="normal">正常工時</option>
            <option value="ot-weekday">平日加班</option>
            <option value="ot-rest">休息日加班</option>
            <option value="holiday">國定/例假日</option>
          </select>
        </div>
        <div class="control-group" style="margin-left:auto;">
          <button class="btn-primary" id="btnNew">新增工時</button>
        </div>
      </section>

      <div class="message-box error-message" id="msg" role="alert"></div>

      <section class="table-container">
        <table aria-label="工時列表">
          <thead>
            <tr>
              <th>日期</th>
              <th>客戶</th>
              <th>服務</th>
              <th>工作類型</th>
              <th>工時</th>
              <th>備註</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- 骨架：mock 資料，任務 42 會改為串 API -->
          </tbody>
        </table>
      </section>

      <div class="clients-pagination" id="pager" style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px;">
        <button type="button" id="prev">上一頁</button>
        <button type="button" id="next">下一頁</button>
      </div>

      <div class="empty-state" id="empty" style="display:none;">
        <span class="material-symbols-rounded">hourglass_empty</span>
        <p>目前沒有工時記錄</p>
      </div>
    </main>

    <!-- 新增工時彈窗（骨架，未串 API）-->
    <div class="ts-modal" id="tsModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="ts-modal-content" role="document">
        <div class="ts-modal-header"><h3>新增工時</h3></div>
        <div class="ts-modal-body">
          <div class="form-group"><label for="f_date">日期</label><input id="f_date" type="date" /></div>
          <div class="form-group"><label for="f_client">客戶</label><input id="f_client" type="text" placeholder="輸入客戶名稱（骨架）" /></div>
          <div class="form-group"><label for="f_service">服務</label><input id="f_service" type="text" placeholder="輸入服務（骨架）" /></div>
          <div class="form-group"><label for="f_type">工作類型</label>
            <select id="f_type">
              <option value="normal">正常工時</option>
              <option value="ot-weekday">平日加班</option>
              <option value="ot-rest">休息日加班</option>
              <option value="holiday">國定/例假日</option>
            </select>
          </div>
          <div class="form-group"><label for="f_hours">工時（0.5 的倍數）</label><input id="f_hours" type="number" step="0.5" min="0.5" max="12" value="1.0" /></div>
          <div class="form-group"><label for="f_note">備註</label><input id="f_note" type="text" maxlength="100" /></div>
        </div>
        <div class="ts-modal-footer">
          <button class="btn-cancel" id="btnCancel">取消</button>
          <button class="btn-confirm" id="btnSave">儲存（骨架）</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
        const tbody = document.getElementById('tbody');
        const emptyEl = document.getElementById('empty');
        const msg = document.getElementById('msg');
        const kw = document.getElementById('kw');
        const type = document.getElementById('type');
        const dateFromEl = document.getElementById('dateFrom');
        const dateToEl = document.getElementById('dateTo');
        const monthTitle = document.getElementById('monthTitle');
        const btnNew = document.getElementById('btnNew');
        const modal = document.getElementById('tsModal');
        const btnCancel = document.getElementById('btnCancel');
        const btnSave = document.getElementById('btnSave');
        const sumHours = document.getElementById('sumHours');
        const prevBtn = document.getElementById('prev');
        const nextBtn = document.getElementById('next');

        let state = { page:1, perPage:50, total:0 };

        function setMsg(text, ok){
          if (!text) { msg.classList.remove('show'); return; }
          msg.textContent = text;
          msg.classList.add('show');
          msg.classList.toggle('success-message', !!ok);
          msg.classList.toggle('error-message', !ok);
        }

        function render(rows){
          tbody.innerHTML = '';
          if (!rows || rows.length===0) { emptyEl.style.display='block'; renderPager(); sumHours.textContent = '0.0'; return; }
          emptyEl.style.display='none';
          let total = 0;
          rows.forEach(r => {
            total += Number(r.hours||0);
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.date}</td>
              <td>${r.clientName||''}</td>
              <td>${r.service||''}</td>
              <td>${r.type}</td>
              <td>${r.hours}</td>
              <td>${r.note||''}</td>
              <td><button class="btn-gray" type="button">編輯</button></td>
            `;
            tbody.appendChild(tr);
          });
          sumHours.textContent = total.toFixed(1);
          renderPager();
        }

        function renderPager(){
          prevBtn.disabled = state.page <= 1;
          nextBtn.disabled = state.page * state.perPage >= state.total;
        }

        async function load(){
          setMsg('', false);
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          if (dateFromEl.value) params.set('dateFrom', dateFromEl.value);
          if (dateToEl.value) params.set('dateTo', dateToEl.value);
          if (kw.value.trim()) params.set('q', kw.value.trim());
          if (type.value) params.set('type', type.value);
          try {
            const res = await fetch(`${apiBase}/timesheets?${params.toString()}`, { credentials: 'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/timesheets'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error((json && json.message) || '載入失敗');
            state.total = (json.meta && json.meta.total) || 0;
            render(json.data || []);
          } catch (e) {
            setMsg('載入失敗，請稍後再試', false);
          }
        }

        let timer = null;
        kw.addEventListener('input', ()=>{ clearTimeout(timer); timer = setTimeout(()=>{ state.page=1; load(); }, 300); });
        type.addEventListener('change', ()=>{ state.page=1; load(); });
        dateFromEl.addEventListener('change', ()=>{ state.page=1; load(); });
        dateToEl.addEventListener('change', ()=>{ state.page=1; load(); });
        document.getElementById('prev').addEventListener('click', ()=>{ if (state.page>1) { state.page--; load(); } });
        document.getElementById('next').addEventListener('click', ()=>{ state.page++; load(); });

        // Modal controls (骨架)
        btnNew.addEventListener('click', ()=>{ 
          // 預設日期為今日
          const today = new Date();
          const y = today.getFullYear();
          const m = String(today.getMonth()+1).padStart(2,'0');
          const d = String(today.getDate()).padStart(2,'0');
          document.getElementById('f_date').value = `${y}-${m}-${d}`;
          modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); 
        });
        btnCancel.addEventListener('click', ()=>{ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); msg.classList.remove('show'); });
        btnSave.addEventListener('click', async ()=>{ 
          setMsg('', false);
          const work_date = document.getElementById('f_date').value.trim();
          const client_id = document.getElementById('f_client').value.trim();
          const service_name = document.getElementById('f_service').value.trim();
          const work_type = document.getElementById('f_type').value.trim();
          let hours = parseFloat(document.getElementById('f_hours').value);
          const note = document.getElementById('f_note').value.trim();
          if (!/^\d{4}-\d{2}-\d{2}$/.test(work_date)) { setMsg('請選擇有效日期。', false); return; }
          if (!client_id) { setMsg('請輸入客戶（暫以文字/ID）。', false); return; }
          if (!service_name) { setMsg('請輸入服務名稱。', false); return; }
          if (!work_type) { setMsg('請選擇工作類型。', false); return; }
          if (!Number.isFinite(hours) || hours <= 0) { setMsg('工時需大於 0。', false); return; }
          const rounded = Math.round(hours * 2) / 2; 
          if (Math.abs(hours - rounded) > 1e-9) { hours = rounded; setMsg('已自動將工時修正為最接近的 0.5 倍數。', true); }
          if (hours > 12) { setMsg('每日單筆不可超過 12 小時。', false); return; }
          const payload = { work_date, client_id, service_name, work_type, hours, note };
          btnSave.disabled = true; btnSave.textContent = '儲存中…';
          try {
            const res = await fetch(`${apiBase}/timesheets`, { method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify(payload) });
            if (res.status === 401) { location.assign('/login?redirect=/internal/timesheets'); return; }
            const json = await res.json().catch(()=>null);
            if (!res.ok || !json || json.ok !== true) {
              const msgText = (json && json.message) || '建立失敗，請稍後再試';
              setMsg(msgText, false);
              return;
            }
            setMsg('已儲存工時。', true);
            modal.classList.remove('show'); modal.setAttribute('aria-hidden','true');
            state.page = 1; await load();
          } catch (_) {
            setMsg('建立失敗，請稍後再試', false);
          } finally {
            btnSave.disabled = false; btnSave.textContent = '儲存（骨架）';
          }
        });

        // init
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth()+1).padStart(2,'0');
        const first = `${y}-${m}-01`;
        const lastDay = new Date(y, now.getMonth()+1, 0).getDate();
        const last = `${y}-${m}-${String(lastDay).padStart(2,'0')}`;
        dateFromEl.value = first; dateToEl.value = last;
        monthTitle.textContent = `本月：${y}-${m}`;
        load();
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


