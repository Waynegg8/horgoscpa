<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ç³»çµ±è¨­å®šï½œç®¡ç†å“¡</title>
    <link rel="stylesheet" href="/assets/css/common.css">
    <link rel="stylesheet" href="/assets/css/internal-system.css">
    <link rel="stylesheet" href="/assets/css/internal-components.css">
    <link rel="stylesheet" href="/assets/css/settings-page.css?v=203">
    
    <!-- âš¡ é¢„åŠ è½½ä¸ç¼“å­˜ç³»ç»Ÿ -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <script src="/assets/js/prerender.js"></script>
    <script src="/assets/js/page-prerender.js"></script>
    <script src="/assets/js/tab-cache.js"></script>
  </head>
<body>
    <div id="permBar" class="alert alert-danger" style="display:none">æ‚¨æ²’æœ‰æ¬Šé™</div>
    
    <nav class="settings-nav">
        <button class="nav-tab active" data-tab="services">æœå‹™é …ç›®</button>
        <button class="nav-tab" data-tab="templates">ä»»å‹™æ¨¡æ¿</button>
        <button class="nav-tab" data-tab="users">ç”¨æˆ¶</button>
        <button class="nav-tab" data-tab="company">å…¬å¸è³‡è¨Š</button>
        <button class="nav-tab" data-tab="automation">è‡ªå‹•åŒ–è¦å‰‡</button>
        <button class="nav-tab" data-tab="holidays">åœ‹å®šå‡æ—¥</button>
    </nav>

    <main class="settings-content">
        
        <!-- æœåŠ¡é¡¹ç›® -->
        <div class="tab-panel active" id="tab-services">
            <div class="search-bar">
                <button class="btn btn-primary" id="btnAddService">+ æ–°å¢</button>
        </div>

            <div class="card hidden" id="addServiceForm">
                <div class="card-header"><h3 id="serviceFormTitle">æ–°å¢æœå‹™é …ç›®</h3></div>
        <div class="card-body">
                    <input type="hidden" id="editServiceId">
          <div class="form-group">
                        <label>æœå‹™åç¨± *</label>
                        <input type="text" id="newServiceName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>æœå‹™å±¤ç´š SOPï¼ˆå¯é¸ï¼‰</label>
                        <select id="newServiceSOP" class="form-control">
                            <option value="">ç„¡</option>
                        </select>
                        <small style="color:#666;font-size:12px;display:block;margin-top:4px;">
                            ğŸ’¡ æœå‹™å±¤ç´š SOP ä»£è¡¨æ•´å€‹æœå‹™çš„é€šç”¨æµç¨‹ï¼Œä½¿ç”¨æ­¤æœå‹™çš„ä»»å‹™æ¨¡æ¿æœƒè‡ªå‹•ç¹¼æ‰¿ã€‚
                        </small>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveService()">å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="cancelService()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="servicesTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>æœå‹™åç¨±</th>
                                    <th>æœå‹™å±¤ç´š SOP</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="4" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡æ¨¡æ¿ -->
        <div class="tab-panel" id="tab-templates">
            <div class="search-bar">
                <button class="btn btn-primary" id="btnAddTemplate">+ æ–°å¢æ¨¡æ¿</button>
            </div>
            
            <!-- æ–°å¢æ¨¡æ¿è¡¨å• -->
            <div class="card hidden" id="addTemplateForm">
                <div class="card-header"><h3>æ–°å¢ä»»å‹™æ¨¡æ¿</h3></div>
                <div class="card-body">
                    <div class="form-group">
                        <label>æ¨¡æ¿åç¨± *</label>
                        <input type="text" id="newTemplateName" class="form-control" placeholder="ä¾‹å¦‚ï¼šè¨˜å¸³æœå‹™æ¨™æº–æµç¨‹">
                    </div>
                    <div class="form-group">
                        <label>æœå‹™é …ç›® *</label>
                        <select id="newTemplateService" class="form-control" onchange="onTemplateServiceChange()">
                            <option value="">è«‹é¸æ“‡æœå‹™é …ç›®</option>
                        </select>
                    </div>
                    <div id="serviceSOPDisplay" class="form-group" style="display:none;">
                        <label>æœå‹™å±¤ç´š SOPï¼ˆè‡ªå‹•ç¹¼æ‰¿è‡ªæœå‹™é …ç›®ï¼‰</label>
                        <div style="background:#f0f9ff;border:1px solid #bae6fd;padding:12px;border-radius:6px;">
                            <span id="serviceSOPText" style="color:#0369a1;font-weight:500;">-</span>
                        </div>
                        <small style="color:#666;font-size:12px;display:block;margin-top:4px;">
                            ğŸ’¡ æ­¤ SOP å¾æœå‹™é …ç›®è‡ªå‹•ç¹¼æ‰¿ã€‚å¦‚éœ€ä¿®æ”¹ï¼Œè«‹åˆ°æœå‹™é …ç›®è¨­å®šä¸­ç·¨è¼¯ã€‚
                        </small>
                    </div>
                    <div class="form-group">
                        <label>ç¶å®šå®¢æˆ¶ï¼ˆå¯é¸ï¼‰</label>
                        <select id="newTemplateClient" class="form-control">
                            <option value="">é€šç”¨æ¨¡æ¿ï¼ˆä¸ç¶å®šå®¢æˆ¶ï¼‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>èªªæ˜</label>
                        <textarea id="newTemplateDesc" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveTemplate()">å„²å­˜æ¨¡æ¿</button>
                        <button class="btn btn-secondary" onclick="cancelTemplate()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ¿åˆ—è¡¨ -->
            <div id="templatesList"></div>
        </div>

        <!-- ç”¨æˆ· -->
        <div class="tab-panel" id="tab-users">
            <div class="search-bar">
                <button class="btn btn-primary" onclick="showAddUserForm()">+ æ–°å¢</button>
            </div>
            
            <!-- æ–°å¢/ç¼–è¾‘ç”¨æˆ·è¡¨å• -->
            <div class="card hidden" id="userForm">
                <div class="card-header">
                    <h3 id="userFormTitle">æ–°å¢ç”¨æˆ¶</h3>
                </div>
                <div class="card-body">
                    <input type="hidden" id="edit_user_id">
                    <div class="form-group">
                        <label>å§“å *</label>
                        <input type="text" id="user_name" class="form-control" placeholder="è«‹è¼¸å…¥å§“å" required>
                    </div>
                    <div class="form-group">
                        <label>å¸³è™Ÿï¼ˆç”¨æˆ¶åï¼‰*</label>
                        <input type="text" id="user_username" class="form-control" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" required>
                    </div>
                    <div class="form-group" id="passwordGroup">
                        <label>å¯†ç¢¼ *</label>
                        <input type="password" id="user_password" class="form-control" placeholder="è‡³å°‘6å€‹å­—å…ƒ" required>
                    </div>
                    <div class="form-group">
                        <label>è§’è‰²</label>
                        <select id="user_is_admin" class="form-control">
                            <option value="0">å“¡å·¥</option>
                            <option value="1">ç®¡ç†å“¡</option>
                        </select>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveUser()">å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="cancelUserForm()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>å§“å</th>
                                    <th>å¸³è™Ÿ</th>
                                    <th>è§’è‰²</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å…¬å¸è³‡è¨Š -->
        <div class="tab-panel" id="tab-company">
            <div class="card">
                <div class="card-header">
                    <h2>å…¬å¸è³‡è¨Šè¨­å®š</h2>
                    <p style="color:#666;font-size:14px;margin:8px 0 0 0;">è¨­å®šå…¬å¸åŸºæœ¬è³‡è¨Šï¼Œç”¨æ–¼æ”¶æ“šã€å ±è¡¨ç­‰æ–‡ä»¶</p>
                </div>
                <div class="card-body">
                    <!-- å…¬å¸è³‡æ–™åˆ‡æ› -->
                    <div style="margin-bottom:32px;background:#f9fafb;padding:8px;border-radius:12px;display:inline-flex;gap:8px;">
                        <button class="company-tab-btn active" onclick="switchCompanyTab(1)" id="companyTab1">
                            ğŸ¢ å…¬å¸è³‡æ–™ 1
                        </button>
                        <button class="company-tab-btn" onclick="switchCompanyTab(2)" id="companyTab2">
                            ğŸ¢ å…¬å¸è³‡æ–™ 2
                        </button>
                    </div>

                    <input type="hidden" id="current_company_set" value="1">

                    <div class="form-group">
                        <label>å…¬å¸ä¸­æ–‡åç¨± *</label>
                        <input type="text" id="company_name" class="form-control" placeholder="ä¾‹å¦‚ï¼šéœçˆ¾æœæ–¯æœƒè¨ˆå¸«äº‹å‹™æ‰€">
                    </div>
                    <div class="form-group">
                        <label>å…¬å¸è‹±æ–‡åç¨±</label>
                        <input type="text" id="company_name_en" class="form-control" placeholder="ä¾‹å¦‚ï¼šHorgosCPA">
                    </div>
                    <div class="form-group">
                        <label>çµ±ä¸€ç·¨è™Ÿ *</label>
                        <input type="text" id="company_tax_id" class="form-control" placeholder="ä¾‹å¦‚ï¼š92254178">
                    </div>
                    <div class="form-group">
                        <label>å…¬å¸åœ°å€ï¼ˆç¬¬ä¸€è¡Œï¼‰*</label>
                        <input type="text" id="company_address" class="form-control" placeholder="ä¾‹å¦‚ï¼šè‡ºä¸­å¸‚è¥¿å€å»ºåœ‹è·¯21è™Ÿ">
                    </div>
                    <div class="form-group">
                        <label>å…¬å¸åœ°å€ï¼ˆç¬¬äºŒè¡Œï¼‰</label>
                        <input type="text" id="company_address_line2" class="form-control" placeholder="ä¾‹å¦‚ï¼š3æ¨“ä¹‹1">
                    </div>
                    <div class="form-group">
                        <label>è¯çµ¡é›»è©± *</label>
                        <input type="text" id="company_phone" class="form-control" placeholder="ä¾‹å¦‚ï¼š04-22205606">
                    </div>
                    <div class="form-group">
                        <label>éŠ€è¡Œåç¨± *</label>
                        <input type="text" id="company_bank" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ°¸è±éŠ€è¡Œå°ä¸­åˆ†è¡Œ">
                    </div>
                    <div class="form-group">
                        <label>éŠ€è¡Œä»£è™Ÿ *</label>
                        <input type="text" id="company_bank_code" class="form-control" placeholder="ä¾‹å¦‚ï¼š807">
                    </div>
                    <div class="form-group">
                        <label>éŠ€è¡Œå¸³è™Ÿ *</label>
                        <input type="text" id="company_account_number" class="form-control" placeholder="ä¾‹å¦‚ï¼š003-018-0019011-7">
                    </div>
                    
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveCompanyInfo()">å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è‡ªåŠ¨åŒ–è§„åˆ™ -->
        <div class="tab-panel" id="tab-automation">
            <div class="search-bar">
                <button class="btn btn-primary" id="btnAddAutomation">+ æ–°å¢</button>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="automationTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>è¦å‰‡åç¨±</th>
                                    <th>è§¸ç™¼æ¢ä»¶</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
          </div>
          </div>

        <!-- å›½å®šå‡æ—¥ -->
        <div class="tab-panel" id="tab-holidays">
            <div class="search-bar">
                <button class="btn btn-primary" onclick="showAddHolidayForm()">+ æ–°å¢å‡æ—¥</button>
                <button class="btn btn-success" onclick="showBatchUploadForm()">ğŸ“¤ æ‰¹é‡ä¸Šå‚³</button>
                <button class="btn btn-secondary" onclick="downloadSampleCSV()">â¬‡ï¸ ä¸‹è¼‰ç¯„ä¾‹</button>
          </div>
          
            <!-- æ‰¹é‡ä¸Šå‚³è¡¨å–® -->
            <div class="card hidden" id="batchUploadForm">
                <div class="card-header">
                    <h3>æ‰¹é‡ä¸Šå‚³å‡æ—¥</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>ä¸Šå‚³æ–¹å¼</label>
                        <div style="margin-bottom:12px">
                            <label style="margin-right:20px;font-weight:normal">
                                <input type="radio" name="uploadMethod" value="csv" checked onchange="toggleUploadMethod()"> CSV æª”æ¡ˆ
                            </label>
                            <label style="font-weight:normal">
                                <input type="radio" name="uploadMethod" value="text" onchange="toggleUploadMethod()"> æ–‡å­—è²¼ä¸Š
                            </label>
                        </div>
                    </div>
                    
                    <!-- CSV ä¸Šå‚³ -->
                    <div id="csvUploadArea">
                        <div class="form-group">
                            <label>é¸æ“‡ CSV æª”æ¡ˆ</label>
                            <input type="file" id="csvFile" accept=".csv" class="form-control">
                        </div>
                    </div>
                    
                    <!-- æ–‡å­—è²¼ä¸Š -->
                    <div id="textUploadArea" style="display:none">
                        <div class="form-group">
                            <label>è²¼ä¸Š CSV å…§å®¹ï¼ˆæ¯è¡Œä¸€ç­†ï¼Œæ ¼å¼ï¼šæ—¥æœŸ,åç¨±ï¼‰</label>
                            <textarea id="csvText" class="form-control" rows="10" placeholder="2025-01-01,å…ƒæ—¦&#10;2025-01-27,è¾²æ›†é™¤å¤•è£œå‡&#10;2025-01-28,è¾²æ›†é™¤å¤•"></textarea>
                        </div>
                    </div>
                    
                    <div style="background:#f0f9ff;border:1px solid #bfdbfe;padding:12px;border-radius:6px;margin:16px 0;font-size:13px">
                        <strong>ğŸ“‹ æ ¼å¼èªªæ˜ï¼š</strong><br>
                        <code>æ—¥æœŸ,åç¨±</code><br>
                        æ‰€æœ‰ä¸Šå‚³çš„å‡æ—¥å°‡è‡ªå‹•è¨­å®šç‚ºåœ‹å®šå‡æ—¥<br><br>
                        <strong>ç¯„ä¾‹ï¼š</strong><br>
                        <code>2025-01-01,å…ƒæ—¦</code><br>
                        <code>2025-02-28,å’Œå¹³ç´€å¿µæ—¥</code><br>
                        <code>2025-04-04,å…’ç«¥ç¯€</code>
                    </div>
                    
                    <div class="action-btns">
                        <button class="btn btn-success" onclick="processBatchUpload()">é–‹å§‹ä¸Šå‚³</button>
                        <button class="btn btn-secondary" onclick="cancelBatchUpload()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
          
          <!-- æ–°å¢/ç·¨è¼¯å‡æ—¥è¡¨å–® -->
            <div class="card hidden" id="holidayForm">
                <div class="card-header">
                    <h3 id="holidayFormTitle">æ–°å¢åœ‹å®šå‡æ—¥</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>æ—¥æœŸ *</label>
                        <input type="date" id="holiday_date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>å‡æ—¥åç¨± *</label>
                        <input type="text" id="holiday_name" class="form-control" placeholder="ä¾‹å¦‚ï¼šå…ƒæ—¦ã€æ˜¥ç¯€ã€å…’ç«¥ç¯€" required>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveHoliday()">å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="cancelHolidayForm()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
          
            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="holidaysTable">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>å‡æ—¥åç¨±</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="3" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
          </div>
          </div>
          </div>
        </div>

    </main>

    <script src="/assets/js/components/bootstrap.js?v=3"></script>
    <script>
        // âš¡ Tab ç¼“å­˜ç³»ç»Ÿåˆå§‹åŒ–
        let currentSettingsTab = 'services';
        if (window.TabCache) {
            window.TabCache.init(['services', 'templates', 'users', 'company', 'automation', 'holidays']);
        }
        
        // Tabåˆ‡æ¢
        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.onclick = () => {
                const tab = btn.dataset.tab;
                
                // âš¡ æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
                const shouldLoad = window.TabCache ? window.TabCache.shouldLoad(currentSettingsTab, tab) : true;
                currentSettingsTab = tab;
                
                document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tab-' + tab).classList.add('active');
                
                // âš¡ åªåœ¨éœ€è¦æ—¶åŠ è½½æ•°æ®
                if (shouldLoad) {
                    // åŠ è½½å¯¹åº”æ•°æ®
                    if (tab === 'services') loadServices();
                    else if (tab === 'templates') { loadTemplates(); loadTemplateOptions(); }
                    else if (tab === 'users') loadUsers();
                    else if (tab === 'company') loadCompanyInfo();
                    else if (tab === 'automation') loadAutomation();
                    else if (tab === 'holidays') loadHolidays();
                    
                    // âš¡ æ ‡è®°ä¸ºå·²åŠ è½½
                    if (window.TabCache) {
                        window.TabCache.markLoaded(tab);
                    }
                }
            };
        });
        
        // ä»»åŠ¡æ¨¡æ¿ - æ–°å¢
        document.getElementById('btnAddTemplate')?.addEventListener('click', () => {
            editingTemplateId = null;
            document.getElementById('newTemplateName').value = '';
            document.getElementById('newTemplateService').value = '';
            document.getElementById('newTemplateClient').value = '';
            document.getElementById('newTemplateDesc').value = '';
            document.getElementById('serviceSOPDisplay').style.display = 'none';
            document.querySelector('#addTemplateForm .card-header h3').textContent = 'æ–°å¢ä»»å‹™æ¨¡æ¿';
            document.getElementById('addTemplateForm').classList.remove('hidden');
            loadTemplateOptions();
        });

        // ç”¨æˆ·ç®¡ç†åŠŸèƒ½å·²ç§»è‡³å‡½æ•°ä¸­

        // è‡ªåŠ¨åŒ– - æ–°å¢
        document.getElementById('btnAddAutomation')?.addEventListener('click', () => alert('æ­¤åŠŸèƒ½é–‹ç™¼ä¸­'));

        // æ–°å¢æœåŠ¡
        document.getElementById('btnAddService').onclick = async () => {
            document.getElementById('editServiceId').value = '';
            document.getElementById('newServiceName').value = '';
            document.getElementById('newServiceSOP').value = '';
            document.getElementById('serviceFormTitle').textContent = 'æ–°å¢æœå‹™é …ç›®';
            document.getElementById('addServiceForm').classList.remove('hidden');
            await loadServiceSOPOptions();
        };

        // åŠ è½½æœåŠ¡SOPé€‰é¡¹
        async function loadServiceSOPOptions() {
            try {
                const sopRes = await fetch('/internal/api/v1/sop?scope=service', { credentials: 'include' });
                const sops = await sopRes.json();
                
                const sopSelect = document.getElementById('newServiceSOP');
                if (sops.data && sops.data.length > 0) {
                    sopSelect.innerHTML = '<option value="">ç„¡</option>' + 
                        sops.data.map(s => `<option value="${s.sop_id}">${s.title}</option>`).join('');
                } else {
                    sopSelect.innerHTML = '<option value="">ç„¡</option>';
                }
            } catch (e) {
                console.error('åŠ è¼‰SOPå¤±æ•—:', e);
            }
        }

        // ç¼–è¾‘æœåŠ¡
        async function editService(serviceId) {
            try {
                const res = await fetch(`/internal/api/v1/services/${serviceId}`, { credentials: 'include' });
                const json = await res.json();
                
                if (!json.ok || !json.data) {
                    throw new Error('è¼‰å…¥æœå‹™å¤±æ•—');
                }
                
                const service = json.data;
                
                await loadServiceSOPOptions();
                
                document.getElementById('editServiceId').value = service.service_id;
                document.getElementById('newServiceName').value = service.service_name || '';
                document.getElementById('newServiceSOP').value = service.service_sop_id || '';
                document.getElementById('serviceFormTitle').textContent = 'ç·¨è¼¯æœå‹™é …ç›®';
                document.getElementById('addServiceForm').classList.remove('hidden');
                document.getElementById('addServiceForm').scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                console.error('è¼‰å…¥æœå‹™å¤±æ•—:', e);
                alert('è¼‰å…¥æœå‹™å¤±æ•—: ' + e.message);
            }
        }

        function cancelService() {
            document.getElementById('addServiceForm').classList.add('hidden');
            document.getElementById('editServiceId').value = '';
            document.getElementById('newServiceName').value = '';
            document.getElementById('newServiceSOP').value = '';
            document.getElementById('serviceFormTitle').textContent = 'æ–°å¢æœå‹™é …ç›®';
        }

        async function saveService() {
            const serviceId = document.getElementById('editServiceId').value;
            const name = document.getElementById('newServiceName').value;
            const sopId = document.getElementById('newServiceSOP').value;
            
            if (!name) return alert('è«‹è¼¸å…¥æœå‹™åç¨±');
            
            try {
                const url = serviceId 
                    ? `/internal/api/v1/services/${serviceId}`
                    : '/internal/api/v1/services';
                const method = serviceId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        service_name: name,
                        service_sop_id: sopId ? parseInt(sopId) : null
                    })
                });
                if (!res.ok) throw new Error('å¤±æ•—');
                alert(serviceId ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
                cancelService();
                loadServices();
            } catch (e) {
                alert('å¤±æ•—: ' + e.message);
            }
        }

        // åŠ è½½æœåŠ¡
        async function loadServices() {
            const tbody = document.querySelector('#servicesTable tbody');
            try {
                const res = await fetch('/internal/api/v1/services', { credentials: 'include' });
            const json = await res.json();
                
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                
                tbody.innerHTML = json.data.map(s => {
                    const sopDisplay = s.service_sop_id ? `ğŸ“– SOP #${s.service_sop_id}` : '-';
                    return `
                    <tr>
                        <td>${s.service_id}</td>
                        <td>${s.service_name}</td>
                        <td>${sopDisplay}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editService(${s.service_id})">ç·¨è¼¯</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteService(${s.service_id})">åˆªé™¤</button>
                        </td>
                    </tr>
                `}).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="4" class="loading">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }

        async function deleteService(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            try {
                await fetch('/internal/api/v1/services/' + id, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                loadServices();
            } catch (e) {
                alert('åˆªé™¤å¤±æ•—');
            }
        }

        // å…¨å±€å­˜å‚¨SOPã€é™„ä»¶å’ŒæœåŠ¡åˆ—è¡¨
        let allSOPs = [];
        let allAttachments = [];
        let allServices = [];

        // ä»»åŠ¡æ¨¡æ¿ - åŠ è½½æœåŠ¡ã€å®¢æˆ·ã€SOPã€é™„ä»¶ä¸‹æ‹‰é€‰é¡¹
        async function loadTemplateOptions() {
            try {
                const [servicesRes, clientsRes, sopRes, attachmentRes] = await Promise.all([
                    fetch('/internal/api/v1/services', { credentials: 'include' }),
                    fetch('/internal/api/v1/clients?perPage=200', { credentials: 'include' }),
                    fetch('/internal/api/v1/sop?scope=task', { credentials: 'include' }).catch(() => ({json: () => ({data:[]})})),
                    fetch('/internal/api/v1/attachments', { credentials: 'include' }).catch(() => ({json: () => ({data:[]})}))
                ]);
                const services = await servicesRes.json();
                const clients = await clientsRes.json();
                const sops = await sopRes.json();
                const attachments = await attachmentRes.json();
                
                // ä¿å­˜åˆ°å…¨å±€
                allServices = services.data || [];
                allSOPs = sops.data || [];
                allAttachments = attachments.data || [];
                
                const serviceSelect = document.getElementById('newTemplateService');
                if (services.data) {
                    serviceSelect.innerHTML = '<option value="">è«‹é¸æ“‡æœå‹™é …ç›®</option>' + 
                        services.data.map(s => `<option value="${s.service_id}">${s.service_name}</option>`).join('');
                }
                
                const clientSelect = document.getElementById('newTemplateClient');
                if (clients.data) {
                    clientSelect.innerHTML = '<option value="">é€šç”¨æ¨¡æ¿ï¼ˆä¸ç¶å®šå®¢æˆ¶ï¼‰</option>' + 
                        clients.data.map(c => `<option value="${c.clientId}">${c.companyName}</option>`).join('');
                }
            } catch (e) {}
        }
        
        // å½“é€‰æ‹©æœåŠ¡é¡¹ç›®æ—¶ï¼Œè‡ªåŠ¨æ˜¾ç¤ºè¯¥æœåŠ¡çš„æœåŠ¡å±‚çº§SOP
        function onTemplateServiceChange() {
            const serviceId = parseInt(document.getElementById('newTemplateService').value);
            const displayDiv = document.getElementById('serviceSOPDisplay');
            const sopText = document.getElementById('serviceSOPText');
            
            if (!serviceId) {
                displayDiv.style.display = 'none';
                return;
            }
            
            const service = allServices.find(s => s.service_id === serviceId);
            if (service && service.service_sop_id) {
                sopText.textContent = `ğŸ“– SOP #${service.service_sop_id}`;
                displayDiv.style.display = 'block';
            } else {
                sopText.textContent = 'æ­¤æœå‹™å°šæœªè¨­å®šæœå‹™å±¤ç´š SOP';
                displayDiv.style.display = 'block';
            }
        }
        
        // å¡«å……SOPå’Œé™„ä»¶ä¸‹æ‹‰é€‰å•
        function populateSOPAndAttachments(templateId) {
            const sopSelect = document.getElementById(`task-sop-${templateId}`);
            const attachmentSelect = document.getElementById(`task-attachment-${templateId}`);
            
            if (sopSelect && allSOPs.length > 0) {
                sopSelect.innerHTML = '<option value="">ç„¡</option>' + 
                    allSOPs.map(s => `<option value="${s.sop_id}">${s.title}</option>`).join('');
            }
            
            if (attachmentSelect && allAttachments.length > 0) {
                attachmentSelect.innerHTML = '<option value="">ç„¡</option>' + 
                    allAttachments.map(a => `<option value="${a.attachment_id}">${a.file_name || a.attachment_id}</option>`).join('');
            }
        }

        // ä»»åŠ¡æ¨¡æ¿ - åŠ è½½åˆ—è¡¨
        async function loadTemplates() {
            const container = document.getElementById('templatesList');
            try {
                const res = await fetch('/internal/api/v1/task-templates', { credentials: 'include' });
                const json = await res.json();
                
                if (!json.data || json.data.length === 0) {
                    container.innerHTML = '<div class="card"><div class="card-body" style="text-align:center;color:#999">æš«ç„¡æ¨¡æ¿</div></div>';
                    return;
                }
                
                container.innerHTML = json.data.map(t => `
                    <div class="card" style="margin-bottom:24px">
                        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <h3 style="margin:0;font-size:16px">${t.template_name}</h3>
                                <div style="font-size:13px;color:#666;margin-top:4px">
                                    æœå‹™ï¼š${t.service_name || '-'} | å®¢æˆ¶ï¼š${t.client_name || 'é€šç”¨'} | ${t.stages_count || 0} å€‹ä»»å‹™
                                </div>
                            </div>
                            <div style="display:flex;gap:8px">
                                <button class="btn btn-sm btn-primary" onclick="editTemplate(${t.template_id})">ç·¨è¼¯</button>
                                <button class="btn btn-sm btn-secondary" onclick="toggleTasks(${t.template_id})">â–¼ ä»»å‹™</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${t.template_id})">åˆªé™¤</button>
                            </div>
                        </div>
                        <div class="card-body hidden" id="tasks-${t.template_id}">
                            <button class="btn btn-sm btn-primary" onclick="showAddTask(${t.template_id})" style="margin-bottom:16px">+ æ–°å¢ä»»å‹™</button>
                            <div id="task-form-${t.template_id}" class="hidden" style="background:#f9f9f9;padding:16px;border-radius:8px;margin-bottom:16px">
                                <div class="form-group">
                                    <label>ä»»å‹™åç¨± *</label>
                                    <input type="text" id="task-name-${t.template_id}" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>æ’åºé †åº</label>
                                    <input type="number" id="task-order-${t.template_id}" class="form-control" value="1">
                                </div>
                                <div class="form-group">
                                    <label>ä»»å‹™å±¤ç´š SOPï¼ˆå¯é¸ï¼‰</label>
                                    <select id="task-sop-${t.template_id}" class="form-control">
                                        <option value="">ç„¡</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>ä»»å‹™å±¤ç´šé™„ä»¶ï¼ˆå¯é¸ï¼‰</label>
                                    <select id="task-attachment-${t.template_id}" class="form-control">
                                        <option value="">ç„¡</option>
                                    </select>
                                </div>
                                <div class="action-btns">
                                    <button class="btn btn-sm btn-primary" onclick="saveTask(${t.template_id})">å„²å­˜</button>
                                    <button class="btn btn-sm btn-secondary" onclick="cancelTask(${t.template_id})">å–æ¶ˆ</button>
                                </div>
                            </div>
                            <div id="task-list-${t.template_id}">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<div class="card"><div class="card-body" style="text-align:center;color:#f44">è¼‰å…¥å¤±æ•—</div></div>';
            }
        }

        // åˆ‡æ¢ä»»åŠ¡åˆ—è¡¨æ˜¾ç¤º
        async function toggleTasks(templateId) {
            const tasksDiv = document.getElementById(`tasks-${templateId}`);
            if (tasksDiv.classList.contains('hidden')) {
                tasksDiv.classList.remove('hidden');
                await loadTasksForTemplate(templateId);
            } else {
                tasksDiv.classList.add('hidden');
            }
        }

        // åŠ è½½æŸä¸ªæ¨¡æ¿çš„ä»»åŠ¡
        async function loadTasksForTemplate(templateId) {
            const listDiv = document.getElementById(`task-list-${templateId}`);
            try {
                const res = await fetch(`/internal/api/v1/task-templates/${templateId}/stages`, { credentials: 'include' });
                const json = await res.json();
                
                if (!json.data || json.data.length === 0) {
                    listDiv.innerHTML = '<div style="color:#999;font-size:13px">å°šç„¡ä»»å‹™</div>';
                    return;
                }
                
                listDiv.innerHTML = '<table class="data-table"><thead><tr><th>é †åº</th><th>ä»»å‹™åç¨±</th><th>ä»»å‹™å±¤ç´š SOP</th><th>ä»»å‹™å±¤ç´šé™„ä»¶</th><th>æ“ä½œ</th></tr></thead><tbody>' +
                    json.data.map(task => {
                        const sopDisplay = task.sop_id ? `ğŸ“– SOP #${task.sop_id}` : '-';
                        const attachmentDisplay = task.attachment_id ? `ğŸ“ é™„ä»¶ #${task.attachment_id}` : '-';
                        return `
                        <tr>
                            <td>${task.stage_order}</td>
                            <td>${task.stage_name || 'æœªå‘½å'}</td>
                            <td>${sopDisplay}</td>
                            <td>${attachmentDisplay}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="editTask(${templateId}, ${JSON.stringify(task).replace(/"/g, '&quot;')})">ç·¨è¼¯</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTask(${templateId}, ${task.stage_id})">åˆªé™¤</button>
                            </td>
                        </tr>
                    `}).join('') + '</tbody></table>';
            } catch (e) {
                listDiv.innerHTML = '<div style="color:#f44">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        // æ˜¾ç¤ºæ–°å¢ä»»åŠ¡è¡¨å•
        let editingStageId = null;
        
        function showAddTask(templateId) {
            editingStageId = null;
            document.getElementById(`task-form-${templateId}`).classList.remove('hidden');
            document.getElementById(`task-name-${templateId}`).value = '';
            document.getElementById(`task-order-${templateId}`).value = '1';
            populateSOPAndAttachments(templateId);
        }
        
        function editTask(templateId, task) {
            editingStageId = task.stage_id;
            const form = document.getElementById(`task-form-${templateId}`);
            form.classList.remove('hidden');
            
            document.getElementById(`task-name-${templateId}`).value = task.stage_name || '';
            document.getElementById(`task-order-${templateId}`).value = task.stage_order || 1;
            
            populateSOPAndAttachments(templateId);
            
            // è®¾ç½®SOPå’Œé™„ä»¶çš„å€¼
            setTimeout(() => {
                const sopSelect = document.getElementById(`task-sop-${templateId}`);
                const attachmentSelect = document.getElementById(`task-attachment-${templateId}`);
                if (sopSelect) sopSelect.value = task.sop_id || '';
                if (attachmentSelect) attachmentSelect.value = task.attachment_id || '';
            }, 100);
            
            form.scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelTask(templateId) {
            editingStageId = null;
            document.getElementById(`task-form-${templateId}`).classList.add('hidden');
        }

        // ä¿å­˜ä»»åŠ¡
        async function saveTask(templateId) {
            const name = document.getElementById(`task-name-${templateId}`).value;
            const order = document.getElementById(`task-order-${templateId}`).value;
            const sopId = document.getElementById(`task-sop-${templateId}`).value;
            const attachmentId = document.getElementById(`task-attachment-${templateId}`).value;
            
            if (!name) return alert('è«‹è¼¸å…¥ä»»å‹™åç¨±');
            
            try {
                const url = editingStageId 
                    ? `/internal/api/v1/task-templates/${templateId}/stages/${editingStageId}`
                    : `/internal/api/v1/task-templates/${templateId}/stages`;
                const method = editingStageId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        stage_name: name,
                        stage_order: parseInt(order) || 1,
                        sop_id: sopId ? parseInt(sopId) : null,
                        attachment_id: attachmentId ? parseInt(attachmentId) : null
                    })
                });
                
                if (!res.ok) throw new Error();
                
                alert(editingStageId ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
                cancelTask(templateId);
                loadTasksForTemplate(templateId);
            } catch (e) {
                console.error('ä¿å­˜ä»»å‹™å¤±æ•—:', e);
                alert(editingStageId ? 'æ›´æ–°å¤±æ•—' : 'æ–°å¢å¤±æ•—');
            }
        }

        // åˆ é™¤ä»»åŠ¡
        async function deleteTask(templateId, stageId) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ä»»å‹™ï¼Ÿ')) return;
            try {
                await fetch(`/internal/api/v1/task-templates/${templateId}/stages/${stageId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                loadTasksForTemplate(templateId);
            } catch (e) {
                alert('åˆªé™¤å¤±æ•—');
            }
        }

        // åˆ é™¤æ¨¡æ¿
        async function deleteTemplate(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨¡æ¿ï¼Ÿæ‰€æœ‰ä»»å‹™ä¹Ÿæœƒè¢«åˆªé™¤')) return;
            try {
                await fetch('/internal/api/v1/task-templates/' + id, { method: 'DELETE', credentials: 'include' });
                loadTemplates();
            } catch (e) {
                alert('åˆªé™¤å¤±æ•—');
            }
        }

        // å…¨å±€å˜é‡ï¼šè®°å½•å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ¨¡æ¿ID
        let editingTemplateId = null;

        // ç¼–è¾‘æ¨¡æ¿
        async function editTemplate(templateId) {
            editingTemplateId = templateId;
            
            // åŠ è½½æ¨¡æ¿æ•°æ®
            try {
                const res = await fetch(`/internal/api/v1/task-templates/${templateId}`, { credentials: 'include' });
                const json = await res.json();
                
                if (!json.ok || !json.data) {
                    throw new Error('è¼‰å…¥æ¨¡æ¿å¤±æ•—');
                }
                
                const template = json.data;
                
                // å…ˆåŠ è½½é€‰é¡¹
                await loadTemplateOptions();
                
                // å¡«å……è¡¨å•
                document.getElementById('newTemplateName').value = template.template_name || '';
                document.getElementById('newTemplateService').value = template.service_id || '';
                document.getElementById('newTemplateClient').value = template.client_id || '';
                document.getElementById('newTemplateDesc').value = template.description || '';
                
                // è§¦å‘æœåŠ¡å˜æ›´ï¼Œæ˜¾ç¤ºæœåŠ¡å±‚çº§SOP
                onTemplateServiceChange();
                
                // ä¿®æ”¹è¡¨å•æ ‡é¢˜
                document.querySelector('#addTemplateForm .card-header h3').textContent = 'ç·¨è¼¯ä»»å‹™æ¨¡æ¿';
                
                // æ˜¾ç¤ºè¡¨å•
                document.getElementById('addTemplateForm').classList.remove('hidden');
                document.getElementById('addTemplateForm').scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                console.error('è¼‰å…¥æ¨¡æ¿å¤±æ•—:', e);
                alert('è¼‰å…¥æ¨¡æ¿å¤±æ•—: ' + e.message);
            }
        }

        // ä¿å­˜æ¨¡æ¿ï¼ˆæ–°å¢æˆ–ç¼–è¾‘ï¼‰
        async function saveTemplate() {
            const name = document.getElementById('newTemplateName').value;
            const serviceId = document.getElementById('newTemplateService').value;
            const clientId = document.getElementById('newTemplateClient').value;
            const desc = document.getElementById('newTemplateDesc').value;
            
            if (!name || !serviceId) return alert('è«‹è¼¸å…¥æ¨¡æ¿åç¨±ä¸¦é¸æ“‡æœå‹™é …ç›®');
            
            try {
                const url = editingTemplateId 
                    ? `/internal/api/v1/task-templates/${editingTemplateId}`
                    : '/internal/api/v1/task-templates';
                const method = editingTemplateId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        template_name: name,
                        service_id: parseInt(serviceId),
                        client_id: clientId ? parseInt(clientId) : null,
                        description: desc
                    })
                });
                
                if (!res.ok) throw new Error();
                
                alert(editingTemplateId ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
                cancelTemplate();
                loadTemplates();
            } catch (e) {
                alert(editingTemplateId ? 'æ›´æ–°å¤±æ•—' : 'æ–°å¢å¤±æ•—');
            }
        }

        function cancelTemplate() {
            editingTemplateId = null;
            document.getElementById('addTemplateForm').classList.add('hidden');
            document.getElementById('newTemplateName').value = '';
            document.getElementById('newTemplateService').value = '';
            document.getElementById('newTemplateClient').value = '';
            document.getElementById('newTemplateDesc').value = '';
            document.getElementById('serviceSOPDisplay').style.display = 'none';
            // æ¢å¤è¡¨å•æ ‡é¢˜
            document.querySelector('#addTemplateForm .card-header h3').textContent = 'æ–°å¢ä»»å‹™æ¨¡æ¿';
        }

        // ç”¨æˆ·ç®¡ç†
        async function loadUsers() {
            const tbody = document.querySelector('#usersTable tbody');
            try {
                const res = await fetch('/internal/api/v1/users', { credentials: 'include' });
                const json = await res.json();
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                tbody.innerHTML = json.data.map(u => `
                    <tr>
                        <td>${u.user_id}</td>
                        <td>${u.name}</td>
                        <td>${u.username}</td>
                        <td>${u.is_admin ? 'ç®¡ç†å“¡' : 'å“¡å·¥'}</td>
                        <td><span class="status-badge status-active">å•Ÿç”¨</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="window.location.href='/internal/profile?user_id=${u.user_id}'">æª¢è¦–</button>
                            <button class="btn btn-sm btn-primary" onclick="editUser(${JSON.stringify(u).replace(/"/g, '&quot;')})">ç·¨è¼¯</button>
                            <button class="btn btn-sm btn-warning" onclick="resetUserPassword(${u.user_id}, '${u.name}')">é‡ç½®å¯†ç¢¼</button>
                            ${u.user_id !== 1 ? `<button class="btn btn-sm btn-danger" onclick="deleteUser(${u.user_id}, '${u.name}')">åˆªé™¤</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }
        
        function showAddUserForm() {
            document.getElementById('edit_user_id').value = '';
            document.getElementById('userFormTitle').textContent = 'æ–°å¢ç”¨æˆ¶';
            document.getElementById('user_name').value = '';
            document.getElementById('user_username').value = '';
            document.getElementById('user_password').value = '';
            document.getElementById('user_is_admin').value = '0';
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('userForm').classList.remove('hidden');
        }
        
        function editUser(user) {
            document.getElementById('edit_user_id').value = user.user_id;
            document.getElementById('userFormTitle').textContent = 'ç·¨è¼¯ç”¨æˆ¶';
            document.getElementById('user_name').value = user.name || '';
            document.getElementById('user_username').value = user.username || '';
            document.getElementById('user_is_admin').value = user.is_admin ? '1' : '0';
            document.getElementById('passwordGroup').style.display = 'none';
            document.getElementById('userForm').classList.remove('hidden');
            document.getElementById('userForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelUserForm() {
            document.getElementById('userForm').classList.add('hidden');
        }
        
        async function saveUser() {
            const userId = document.getElementById('edit_user_id').value;
            const name = document.getElementById('user_name').value.trim();
            const username = document.getElementById('user_username').value.trim();
            const password = document.getElementById('user_password').value;
            const isAdmin = document.getElementById('user_is_admin').value === '1';
            
            if (!name || !username) {
                alert('è«‹å¡«å¯«å§“åå’Œå¸³è™Ÿ');
                return;
            }
            
            if (!userId && (!password || password.length < 6)) {
                alert('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ');
                return;
            }
            
            try {
                const payload = {
                    name: name,
                    username: username,
                    is_admin: isAdmin
                };
                
                if (!userId) {
                    // æ–°å¢ç”¨æˆ·
                    payload.password = password;
                }
                
                const url = userId 
                    ? `/internal/api/v1/admin/users/${userId}`
                    : '/internal/api/v1/admin/users';
                const method = userId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'æ“ä½œå¤±æ•—');
                }
                
                alert(userId ? 'âœ… æ›´æ–°æˆåŠŸï¼' : 'âœ… æ–°å¢æˆåŠŸï¼');
                cancelUserForm();
                loadUsers();
            } catch (e) {
                console.error('å„²å­˜ç”¨æˆ¶å¤±æ•—:', e);
                alert('âŒ å„²å­˜å¤±æ•—: ' + e.message);
            }
        }
        
        async function deleteUser(userId, userName) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç”¨æˆ¶ã€Œ${userName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                return;
            }
            
            try {
                const res = await fetch(`/internal/api/v1/admin/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'åˆªé™¤å¤±æ•—');
                }
                
                alert('âœ… åˆªé™¤æˆåŠŸï¼');
                loadUsers();
            } catch (e) {
                console.error('åˆªé™¤ç”¨æˆ¶å¤±æ•—:', e);
                alert('âŒ åˆªé™¤å¤±æ•—: ' + e.message);
            }
        }
        
        async function resetUserPassword(userId, userName) {
            const newPassword = prompt(`è«‹è¼¸å…¥ ${userName} çš„æ–°å¯†ç¢¼ï¼š`);
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                alert('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦å°‡ ${userName} çš„å¯†ç¢¼é‡ç½®ç‚ºæ–°å¯†ç¢¼å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const res = await fetch(`/internal/api/v1/admin/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ new_password: newPassword })
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'é‡ç½®å¤±æ•—');
                }
                
                alert(`âœ… å¯†ç¢¼é‡ç½®æˆåŠŸï¼\nç”¨æˆ¶ï¼š${userName}\nè«‹é€šçŸ¥è©²ç”¨æˆ¶ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥ã€‚`);
            } catch (e) {
                console.error('é‡ç½®å¯†ç¢¼å¤±æ•—:', e);
                alert('âŒ é‡ç½®å¯†ç¢¼å¤±æ•—: ' + e.message);
            }
        }

        // å…¬å¸è³‡è¨Šç®¡ç†
        function switchCompanyTab(setNumber) {
            document.getElementById('current_company_set').value = setNumber;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.getElementById('companyTab1').classList.toggle('active', setNumber === 1);
            document.getElementById('companyTab2').classList.toggle('active', setNumber === 2);
            
            // åŠ è½½å¯¹åº”çš„å…¬å¸èµ„æ–™
            loadCompanyInfo();
        }
        
        async function loadCompanyInfo() {
            const setNumber = document.getElementById('current_company_set').value;
            const category = `company${setNumber}`;
            
            try {
                const res = await fetch(`/internal/api/v1/settings?category=${category}`, { credentials: 'include' });
                const json = await res.json();
                
                // æ¸…ç©ºæ‰€æœ‰å­—æ®µ
                document.getElementById('company_name').value = '';
                document.getElementById('company_name_en').value = '';
                document.getElementById('company_tax_id').value = '';
                document.getElementById('company_address').value = '';
                document.getElementById('company_address_line2').value = '';
                document.getElementById('company_phone').value = '';
                document.getElementById('company_bank').value = '';
                document.getElementById('company_bank_code').value = '';
                document.getElementById('company_account_number').value = '';
                
                if (json.ok && json.data) {
                    json.data.forEach(setting => {
                        // ç§»é™¤å‰ç¼€æ¥åŒ¹é…è¡¨å•å­—æ®µ
                        const key = setting.settingKey.replace(`${category}_`, '');
                        const input = document.getElementById(`company_${key}`);
                        if (input) {
                            input.value = setting.settingValue || '';
                        }
                    });
                }
            } catch (e) {
                console.error('è¼‰å…¥å…¬å¸è³‡è¨Šå¤±æ•—:', e);
            }
        }
        
        async function saveCompanyInfo() {
            const setNumber = document.getElementById('current_company_set').value;
            const category = `company${setNumber}`;
            
            // ä½¿ç”¨categoryä½œä¸ºå‰ç¼€æ¥ç¡®ä¿setting_keyçš„å”¯ä¸€æ€§
            const settings = [
                { settingKey: `${category}_name`, settingValue: document.getElementById('company_name').value },
                { settingKey: `${category}_name_en`, settingValue: document.getElementById('company_name_en').value },
                { settingKey: `${category}_tax_id`, settingValue: document.getElementById('company_tax_id').value },
                { settingKey: `${category}_address`, settingValue: document.getElementById('company_address').value },
                { settingKey: `${category}_address_line2`, settingValue: document.getElementById('company_address_line2').value },
                { settingKey: `${category}_phone`, settingValue: document.getElementById('company_phone').value },
                { settingKey: `${category}_bank`, settingValue: document.getElementById('company_bank').value },
                { settingKey: `${category}_bank_code`, settingValue: document.getElementById('company_bank_code').value },
                { settingKey: `${category}_account_number`, settingValue: document.getElementById('company_account_number').value }
            ];
            
            if (!settings[0].settingValue) {
                alert('å…¬å¸ä¸­æ–‡åç¨±ç‚ºå¿…å¡«é …');
                return;
            }
            
            try {
                const res = await fetch('/internal/api/v1/settings/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        category: category,
                        settings: settings
                    })
                });
                
                // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await res.text();
                    console.error('éJSONéŸ¿æ‡‰:', text);
                    throw new Error('æœå‹™å™¨è¿”å›äº†éJSONéŸ¿æ‡‰ï¼Œè«‹æª¢æŸ¥å¾Œç«¯é…ç½®');
                }
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'å„²å­˜å¤±æ•—');
                }
                
                alert(`âœ… å…¬å¸è³‡æ–™ ${setNumber} å„²å­˜æˆåŠŸï¼`);
            } catch (e) {
                console.error('å„²å­˜å…¬å¸è³‡è¨Šå¤±æ•—:', e);
                alert('âŒ å„²å­˜å¤±æ•—: ' + e.message);
            }
        }

        // è‡ªåŠ¨åŒ–è§„åˆ™
        async function loadAutomation() {
            const tbody = document.querySelector('#automationTable tbody');
            try {
                const res = await fetch('/internal/api/v1/automation/rules', { credentials: 'include' });
                const json = await res.json();
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                tbody.innerHTML = json.data.map(r => `
                    <tr>
                        <td>${r.rule_id}</td>
                        <td>${r.rule_name}</td>
                        <td>${r.trigger_event || '-'}</td>
                        <td>${r.is_active ? 'å•Ÿç”¨' : 'åœç”¨'}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRule(${r.rule_id})">åˆªé™¤</button></td>
                    </tr>
                `).join('');
          } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }
        async function deleteRule(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            await fetch('/internal/api/v1/automation/rules/' + id, { method: 'DELETE', credentials: 'include' });
            loadAutomation();
        }

        // å›½å®šå‡æ—¥
        let editingHolidayDate = null; // ç”¨æ–¼è¨˜éŒ„æ­£åœ¨ç·¨è¼¯çš„å‡æ—¥æ—¥æœŸ
        
        async function loadHolidays() {
            const tbody = document.querySelector('#holidaysTable tbody');
            try {
                const res = await fetch(`/internal/api/v1/holidays`, { credentials: 'include' });
                const json = await res.json();
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                tbody.innerHTML = json.data.map(h => {
                    return `
                        <tr>
                            <td>${h.holiday_date}</td>
                            <td>${h.name || 'æœªå‘½å'}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick='editHoliday(${JSON.stringify(h)})'>ç·¨è¼¯</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteHoliday('${h.holiday_date}')">åˆªé™¤</button>
                            </td>
                        </tr>
                    `;
                }).join('');
          } catch (e) {
                console.error('è¼‰å…¥å‡æ—¥å¤±æ•—:', e);
                tbody.innerHTML = '<tr><td colspan="3" class="loading">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }
        
        function showAddHolidayForm() {
            editingHolidayDate = null;
            document.getElementById('holidayFormTitle').textContent = 'æ–°å¢åœ‹å®šå‡æ—¥';
            document.getElementById('holiday_date').value = '';
            document.getElementById('holiday_date').disabled = false;
            document.getElementById('holiday_name').value = '';
            document.getElementById('holidayForm').classList.remove('hidden');
        }
        
        function editHoliday(holiday) {
            editingHolidayDate = holiday.holiday_date;
            document.getElementById('holidayFormTitle').textContent = 'ç·¨è¼¯åœ‹å®šå‡æ—¥';
            document.getElementById('holiday_date').value = holiday.holiday_date;
            document.getElementById('holiday_date').disabled = true; // ç·¨è¼¯æ™‚ä¸èƒ½ä¿®æ”¹æ—¥æœŸï¼ˆä¸»éµï¼‰
            document.getElementById('holiday_name').value = holiday.name || '';
            
            document.getElementById('holidayForm').classList.remove('hidden');
            document.getElementById('holidayForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelHolidayForm() {
            document.getElementById('holidayForm').classList.add('hidden');
            editingHolidayDate = null;
        }
        
        async function saveHoliday() {
            const date = document.getElementById('holiday_date').value;
            const name = document.getElementById('holiday_name').value;
            
            if (!date || !name) {
                alert('è«‹å¡«å¯«æ—¥æœŸå’Œåç¨±');
                return;
            }
            
            const holidayData = {
                holiday_date: date,
                name: name,
                is_national_holiday: true,
                is_weekly_restday: false,
                is_makeup_workday: false
            };
            
            try {
                const method = editingHolidayDate ? 'PUT' : 'POST';
                const res = await fetch('/internal/api/v1/holidays', {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(holidayData)
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'æ“ä½œå¤±æ•—');
                }
                
                alert(editingHolidayDate ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
                cancelHolidayForm();
                loadHolidays();
            } catch (e) {
                console.error('å„²å­˜å‡æ—¥å¤±æ•—:', e);
                alert('å„²å­˜å¤±æ•—: ' + e.message);
            }
        }
        
        async function deleteHoliday(date) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${date} çš„å‡æ—¥å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const res = await fetch(`/internal/api/v1/holidays?holiday_date=${date}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'åˆªé™¤å¤±æ•—');
                }
                
                alert('åˆªé™¤æˆåŠŸ');
                loadHolidays();
            } catch (e) {
                console.error('åˆªé™¤å‡æ—¥å¤±æ•—:', e);
                alert('åˆªé™¤å¤±æ•—: ' + e.message);
            }
        }
        
        // æ‰¹é‡ä¸Šå‚³åŠŸèƒ½
        function showBatchUploadForm() {
            document.getElementById('batchUploadForm').classList.remove('hidden');
            document.getElementById('batchUploadForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelBatchUpload() {
            document.getElementById('batchUploadForm').classList.add('hidden');
            document.getElementById('csvFile').value = '';
            document.getElementById('csvText').value = '';
        }
        
        function toggleUploadMethod() {
            const method = document.querySelector('input[name="uploadMethod"]:checked').value;
            if (method === 'csv') {
                document.getElementById('csvUploadArea').style.display = 'block';
                document.getElementById('textUploadArea').style.display = 'none';
            } else {
                document.getElementById('csvUploadArea').style.display = 'none';
                document.getElementById('textUploadArea').style.display = 'block';
            }
        }
        
        function parseCSVLine(line) {
            const parts = line.split(',').map(p => p.trim());
            if (parts.length < 2) return null;
            
            const [date, name] = parts;
            if (!date || !name) return null;
            
            return {
                holiday_date: date,
                name: name,
                is_national_holiday: true,
                is_weekly_restday: false,
                is_makeup_workday: false
            };
        }
        
        function downloadSampleCSV() {
            const sampleData = `æ—¥æœŸ,åç¨±
2025-01-01,å…ƒæ—¦
2025-02-28,å’Œå¹³ç´€å¿µæ—¥
2025-04-04,å…’ç«¥ç¯€
2025-04-05,æ¸…æ˜ç¯€
2025-05-01,å‹å‹•ç¯€
2025-06-10,ç«¯åˆç¯€
2025-09-17,ä¸­ç§‹ç¯€
2025-10-10,åœ‹æ…¶æ—¥`;
            
            const blob = new Blob(['\uFEFF' + sampleData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'åœ‹å®šå‡æ—¥ç¯„ä¾‹.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function processBatchUpload() {
            const method = document.querySelector('input[name="uploadMethod"]:checked').value;
            let csvContent = '';
            
            if (method === 'csv') {
                const fileInput = document.getElementById('csvFile');
                if (!fileInput.files || !fileInput.files[0]) {
                    alert('è«‹é¸æ“‡ CSV æª”æ¡ˆ');
                    return;
                }
                
                try {
                    csvContent = await fileInput.files[0].text();
                } catch (e) {
                    alert('è®€å–æª”æ¡ˆå¤±æ•—');
                    return;
                }
            } else {
                csvContent = document.getElementById('csvText').value;
            }
            
            if (!csvContent.trim()) {
                alert('è«‹è¼¸å…¥å…§å®¹');
                return;
            }
            
            // è§£æ CSV
            const lines = csvContent.split('\n').filter(line => line.trim());
            const holidays = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // è·³éæ¨™é¡Œè¡Œï¼ˆå¦‚æœæœ‰ï¼‰
                if (i === 0 && (line.includes('æ—¥æœŸ') || line.includes('date'))) {
                    continue;
                }
                
                const holiday = parseCSVLine(line);
                if (holiday) {
                    holidays.push(holiday);
                }
            }
            
            if (holidays.length === 0) {
                alert('æ²’æœ‰æœ‰æ•ˆçš„å‡æ—¥è³‡æ–™');
                return;
            }
            
            if (!confirm(`å³å°‡ä¸Šå‚³ ${holidays.length} ç­†å‡æ—¥è³‡æ–™ï¼Œç¢ºå®šç¹¼çºŒï¼Ÿ`)) {
                return;
            }
            
            try {
                const res = await fetch('/internal/api/v1/holidays', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(holidays)
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'ä¸Šå‚³å¤±æ•—');
                }
                
                let message = json.message || 'ä¸Šå‚³æˆåŠŸ';
                if (json.data && json.data.errors && json.data.errors.length > 0) {
                    message += '\n\néƒ¨åˆ†éŒ¯èª¤ï¼š\n' + json.data.errors.join('\n');
                }
                
                alert(message);
                cancelBatchUpload();
                loadHolidays();
            } catch (e) {
                console.error('æ‰¹é‡ä¸Šå‚³å¤±æ•—:', e);
                alert('æ‰¹é‡ä¸Šå‚³å¤±æ•—: ' + e.message);
            }
        }

        // ç™»å‡º
        async function logout() {
            if (!confirm('ç¢ºå®šç™»å‡ºï¼Ÿ')) return;
            await fetch('/internal/api/v1/auth/logout', { method: 'POST', credentials: 'include' });
            window.location.href = '/login.html';
        }

        // Tab åˆ‡æ¢åŠŸèƒ½
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰ active class
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            
            // æ·»åŠ  active class
            const targetBtn = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
            const targetPanel = document.getElementById(`tab-${tabName}`);
            
            if (targetBtn) targetBtn.classList.add('active');
            if (targetPanel) targetPanel.classList.add('active');
            
            // æ ¹æ®tabåŠ è½½å¯¹åº”æ•°æ®
            switch(tabName) {
                case 'services':
                    loadServices();
                    break;
                case 'templates':
                    loadTemplates();
                    loadTemplateOptions();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'company':
                    loadCompanyInfo();
                    break;
                case 'automation':
                    loadAutomation();
                    break;
                case 'holidays':
                    loadHolidays();
                    break;
            }
        }
        
        // ç»‘å®šæ‰€æœ‰tabæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        // åˆå§‹åŒ–
        (async () => {
            const res = await fetch('/internal/api/v1/auth/me', { credentials: 'include' });
            if (!res.ok) {
                document.getElementById('permBar').style.display = 'block';
                return;
            }
            // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªtabçš„æ•°æ®
            switchTab('services');
        })();
    </script>
  </body>
  </html>
