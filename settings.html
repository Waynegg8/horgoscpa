<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="系統設定（管理員）" />
    <title>系統設定｜管理員</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/settings-page.css" />
  </head>
  <body class="internal-container">
    <header class="settings-header">
      <h1 class="settings-title">系統設定</h1>
      <div id="permBar" class="info-bar" style="display:none;" role="alert">您沒有權限檢視此頁面</div>
      <div id="msgBar" class="info-bar" style="display:none;" role="status"></div>
    </header>

    <main class="settings-content">
      <section class="card" aria-labelledby="danger-title">
        <div class="card-header">
          <h2 id="danger-title">危險設定</h2>
          <div class="subtitle">變更前請確認風險，非管理員不可操作</div>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="rule_comp_hours_expiry">補休有效期規則</label>
            <select id="rule_comp_hours_expiry" disabled>
              <option value="current_month">當月到期</option>
              <option value="next_month">次月到期</option>
              <option value="3_months">3 個月</option>
              <option value="6_months">6 個月</option>
            </select>
          </div>
          <div class="form-group">
            <label>每日工時上限（唯讀）</label>
            <input type="text" value="12" readonly />
          </div>
          <div class="form-group">
            <label>月薪制換算時數（唯讀）</label>
            <input type="text" value="240" readonly />
          </div>
          <div>
            <button id="btnSaveDanger" class="btn btn-danger" type="button" disabled>儲存危險設定</button>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="general-title" style="margin-top:20px;">
        <div class="card-header">
          <h2 id="general-title">一般設定</h2>
          <div class="subtitle">公司資訊等一般參數</div>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="company_name">公司名稱</label>
            <input id="company_name" type="text" placeholder="範例：霍爾果斯會計師事務所" disabled />
          </div>
          <div class="form-group">
            <label for="contact_email">聯絡信箱</label>
            <input id="contact_email" type="email" placeholder="contact@horgoscpa.com" disabled />
          </div>
          <div>
            <button id="btnSaveGeneral" class="btn btn-primary" type="button" disabled>儲存一般設定</button>
          </div>
        </div>
      </section>
    </main>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const permBar = document.getElementById('permBar');
        const dangerControls = [
          document.getElementById('rule_comp_hours_expiry'),
          document.getElementById('btnSaveDanger'),
        ];
        const generalControls = [
          document.getElementById('company_name'),
          document.getElementById('contact_email'),
          document.getElementById('btnSaveGeneral'),
        ];

        function setControlsEnabled(arr, enabled){
          arr.forEach(el => { if (el) { el.disabled = !enabled; } });
        }

        function setMsg(text, isOk){
          const bar = document.getElementById('msgBar');
          if (!bar) return;
          if (!text){ bar.style.display='none'; bar.textContent=''; return; }
          bar.textContent = text;
          bar.style.display = 'block';
          bar.style.color = isOk ? '#1b5e20' : '#c0392b';
        }

        async function loadSettings(){
          try {
            const res = await fetch(`${apiBase}/admin/settings`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/settings'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const map = json.data?.map || {};
            const company = document.getElementById('company_name');
            const email = document.getElementById('contact_email');
            const rule = document.getElementById('rule_comp_hours_expiry');
            if (company) company.value = map.company_name || '';
            if (email) email.value = map.contact_email || '';
            if (rule && map.rule_comp_hours_expiry) rule.value = map.rule_comp_hours_expiry;
          } catch (_) {
            setMsg('載入設定失敗，請稍後再試', false);
          }
        }

        async function putSetting(key, payload){
          const res = await fetch(`${apiBase}/admin/settings/${encodeURIComponent(key)}`, {
            method:'PUT', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify(payload||{})
          });
          const json = await res.json().catch(()=>null);
          if (!res.ok || !json || json.ok !== true) {
            const msg = (json && json.message) || '更新失敗';
            throw new Error(msg);
          }
          return json;
        }

        async function ensureAdmin(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/settings'); return false; }
            const json = await res.json();
            if (!json || json.ok !== true) throw new Error();
            const isAdmin = !!json.data?.isAdmin;
            if (!isAdmin) {
              permBar.style.display = 'block';
              setControlsEnabled(dangerControls, false);
              setControlsEnabled(generalControls, false);
              return false;
            }
            setControlsEnabled(dangerControls, true);
            setControlsEnabled(generalControls, true);
            await loadSettings();
            return true;
          } catch (_) {
            permBar.textContent = '載入失敗，請稍後再試';
            permBar.style.display = 'block';
            return false;
          }
        }

        // 綁定儲存事件
        document.getElementById('btnSaveDanger').addEventListener('click', async function(){
          setMsg('', true);
          const rule = document.getElementById('rule_comp_hours_expiry').value;
          this.disabled = true; this.textContent = '儲存中…';
          try {
            await putSetting('rule_comp_hours_expiry', { value: rule, confirmed: true });
            setMsg('已更新危險設定。', true);
          } catch (e) {
            setMsg(String(e && e.message || '更新失敗'), false);
          } finally {
            this.disabled = false; this.textContent = '儲存危險設定';
          }
        });

        document.getElementById('btnSaveGeneral').addEventListener('click', async function(){
          setMsg('', true);
          const company = document.getElementById('company_name').value.trim();
          const email = document.getElementById('contact_email').value.trim();
          if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { setMsg('Email 格式錯誤', false); return; }
          this.disabled = true; this.textContent = '儲存中…';
          try {
            await putSetting('company_name', { value: company });
            await putSetting('contact_email', { value: email });
            setMsg('已更新一般設定。', true);
          } catch (e) {
            setMsg(String(e && e.message || '更新失敗'), false);
          } finally {
            this.disabled = false; this.textContent = '儲存一般設定';
          }
        });

        ensureAdmin();
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


