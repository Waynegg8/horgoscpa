<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ç³»çµ±è¨­å®šï½œç®¡ç†å“¡</title>
    <link rel="stylesheet" href="/assets/css/common.css">
    <link rel="stylesheet" href="/assets/css/internal-system.css">
    <link rel="stylesheet" href="/assets/css/internal-components.css">
    <link rel="stylesheet" href="/assets/css/settings-page.css?v=205">
    
    <!-- âš¡ é¢„åŠ è½½ä¸ç¼“å­˜ç³»ç»Ÿ -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <script src="/assets/js/prerender.js"></script>
    <script src="/assets/js/page-prerender.js"></script>
    <script src="/assets/js/tab-cache.js"></script>
  </head>
<body>
    <div id="permBar" class="alert alert-danger" style="display:none">æ‚¨æ²’æœ‰æ¬Šé™</div>
    
    <nav class="settings-nav">
        <button class="nav-tab active" data-tab="services">æœå‹™é …ç›®</button>
        <button class="nav-tab" data-tab="templates">ä»»å‹™æ¨¡æ¿</button>
        <button class="nav-tab" data-tab="users">ç”¨æˆ¶</button>
        <button class="nav-tab" data-tab="company">å…¬å¸è³‡è¨Š</button>
        <button class="nav-tab" data-tab="automation">è‡ªå‹•åŒ–è¦å‰‡</button>
        <button class="nav-tab" data-tab="holidays">åœ‹å®šå‡æ—¥</button>
    </nav>

    <main class="settings-content">
        
        <!-- æœåŠ¡é¡¹ç›® -->
        <div class="tab-panel active" id="tab-services">
            <div class="search-bar">
                <button class="btn btn-primary" id="btnAddService">+ æ–°å¢</button>
            </div>

            <div class="card hidden" id="addServiceForm">
                <div class="card-header"><h3 id="serviceFormTitle">æ–°å¢æœå‹™é …ç›®</h3></div>
                <div class="card-body">
                    <input type="hidden" id="editServiceId">
                    <div class="form-group">
                        <label>æœå‹™åç¨± *</label>
                        <input type="text" id="newServiceName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>æœå‹™å±¤ç´š SOPï¼ˆå¯é¸ï¼‰</label>
                        <select id="newServiceSOP" class="form-control">
                            <option value="">ç„¡</option>
                        </select>
                        <small style="color:#666;font-size:12px;display:block;margin-top:4px;">
                            ğŸ’¡ æœå‹™å±¤ç´š SOP ä»£è¡¨æ•´å€‹æœå‹™çš„é€šç”¨æµç¨‹ï¼Œä½¿ç”¨æ­¤æœå‹™çš„ä»»å‹™æ¨¡æ¿æœƒè‡ªå‹•ç¹¼æ‰¿ã€‚
                        </small>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveService()">å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="cancelService()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="servicesTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>æœå‹™åç¨±</th>
                                    <th>æœå‹™å±¤ç´š SOP</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="4" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡æ¨¡æ¿ -->
        <div class="tab-panel" id="tab-templates">
            <div class="search-bar">
                <button class="btn btn-primary" id="btnAddTemplate">+ æ–°å¢æ¨¡æ¿</button>
            </div>
            
            <!-- æ–°å¢æ¨¡æ¿è¡¨å• -->
            <div class="card hidden" id="addTemplateForm">
                <div class="card-header"><h3>æ–°å¢ä»»å‹™æ¨¡æ¿</h3></div>
                <div class="card-body">
                    <div class="form-group">
                        <label>æ¨¡æ¿åç¨± *</label>
                        <input type="text" id="newTemplateName" class="form-control" placeholder="ä¾‹å¦‚ï¼šè¨˜å¸³æœå‹™æ¨™æº–æµç¨‹">
                    </div>
                    <div class="form-group">
                        <label>æœå‹™é …ç›® *</label>
                        <select id="newTemplateService" class="form-control" onchange="onTemplateServiceChange()">
                            <option value="">è«‹é¸æ“‡æœå‹™é …ç›®</option>
                        </select>
                    </div>
                    <div id="serviceSOPDisplay" class="form-group" style="display:none;">
                        <label>æœå‹™å±¤ç´š SOPï¼ˆè‡ªå‹•ç¹¼æ‰¿è‡ªæœå‹™é …ç›®ï¼‰</label>
                        <div style="background:#f0f9ff;border:1px solid #bae6fd;padding:12px;border-radius:6px;">
                            <span id="serviceSOPText" style="color:#0369a1;font-weight:500;">-</span>
                        </div>
                        <small style="color:#666;font-size:12px;display:block;margin-top:4px;">
                            ğŸ’¡ æ­¤ SOP å¾æœå‹™é …ç›®è‡ªå‹•ç¹¼æ‰¿ã€‚å¦‚éœ€ä¿®æ”¹ï¼Œè«‹åˆ°æœå‹™é …ç›®è¨­å®šä¸­ç·¨è¼¯ã€‚
                        </small>
                    </div>
                    <div class="form-group">
                        <label>ç¶å®šå®¢æˆ¶ï¼ˆå¯é¸ï¼‰</label>
                        <select id="newTemplateClient" class="form-control">
                            <option value="">é€šç”¨æ¨¡æ¿ï¼ˆä¸ç¶å®šå®¢æˆ¶ï¼‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>èªªæ˜</label>
                        <textarea id="newTemplateDesc" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveTemplate()">å„²å­˜æ¨¡æ¿</button>
                        <button class="btn btn-secondary" onclick="cancelTemplate()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ¿åˆ—è¡¨ -->
            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="templatesTable">
                            <thead>
                                <tr>
                                    <th style="width:25%;">æ¨¡æ¿åç¨±</th>
                                    <th style="width:15%;">æœå‹™é¡å‹</th>
                                    <th style="width:15%;">ç¶å®šå®¢æˆ¶</th>
                                    <th style="width:10%;">ä»»å‹™éšæ®µæ•¸</th>
                                    <th style="width:35%;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="templatesList">
                                <tr><td colspan="5" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ· -->
        <div class="tab-panel" id="tab-users">
            <div class="search-bar">
                <button class="btn btn-primary" onclick="showAddUserForm()">+ æ–°å¢</button>
            </div>
            
            <!-- æ–°å¢/ç¼–è¾‘ç”¨æˆ·è¡¨å• -->
            <div class="card hidden" id="userForm">
                <div class="card-header">
                    <h3 id="userFormTitle">æ–°å¢ç”¨æˆ¶</h3>
                </div>
                <div class="card-body">
                    <input type="hidden" id="edit_user_id">
                    <div class="form-group">
                        <label>å§“å *</label>
                        <input type="text" id="user_name" class="form-control" placeholder="è«‹è¼¸å…¥å§“å" required>
                    </div>
                    <div class="form-group">
                        <label>å¸³è™Ÿï¼ˆç”¨æˆ¶åï¼‰*</label>
                        <input type="text" id="user_username" class="form-control" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" required>
                    </div>
                    <div class="form-group" id="passwordGroup">
                        <label>å¯†ç¢¼ *</label>
                        <input type="password" id="user_password" class="form-control" placeholder="è‡³å°‘6å€‹å­—å…ƒ" required>
                    </div>
                    <div class="form-group">
                        <label>è§’è‰²</label>
                        <select id="user_is_admin" class="form-control">
                            <option value="0">å“¡å·¥</option>
                            <option value="1">ç®¡ç†å“¡</option>
                        </select>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveUser()">å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="cancelUserForm()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>å§“å</th>
                                    <th>å¸³è™Ÿ</th>
                                    <th>è§’è‰²</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å…¬å¸è³‡è¨Š -->
        <div class="tab-panel" id="tab-company">
            <div class="card">
                <div class="card-header">
                    <h2>å…¬å¸è³‡è¨Šè¨­å®š</h2>
                    <p style="color:#666;font-size:14px;margin:8px 0 0 0;">è¨­å®šå…¬å¸åŸºæœ¬è³‡è¨Šï¼Œç”¨æ–¼æ”¶æ“šã€å ±è¡¨ç­‰æ–‡ä»¶</p>
                </div>
                <div class="card-body">
                    <!-- å…¬å¸è³‡æ–™åˆ‡æ› -->
                    <div style="margin-bottom:32px;background:#f9fafb;padding:8px;border-radius:12px;display:inline-flex;gap:8px;">
                        <button class="company-tab-btn active" onclick="switchCompanyTab(1)" id="companyTab1">
                            ğŸ¢ å…¬å¸è³‡æ–™ 1
                        </button>
                        <button class="company-tab-btn" onclick="switchCompanyTab(2)" id="companyTab2">
                            ğŸ¢ å…¬å¸è³‡æ–™ 2
                        </button>
                    </div>

                    <input type="hidden" id="current_company_set" value="1">

                    <div class="form-group">
                        <label>å…¬å¸ä¸­æ–‡åç¨± *</label>
                        <input type="text" id="company_name" class="form-control" placeholder="ä¾‹å¦‚ï¼šéœçˆ¾æœæ–¯æœƒè¨ˆå¸«äº‹å‹™æ‰€">
                    </div>
                    <div class="form-group">
                        <label>å…¬å¸è‹±æ–‡åç¨±</label>
                        <input type="text" id="company_name_en" class="form-control" placeholder="ä¾‹å¦‚ï¼šHorgosCPA">
                    </div>
                    <div class="form-group">
                        <label>çµ±ä¸€ç·¨è™Ÿ *</label>
                        <input type="text" id="company_tax_id" class="form-control" placeholder="ä¾‹å¦‚ï¼š92254178">
                    </div>
                    <div class="form-group">
                        <label>å…¬å¸åœ°å€ï¼ˆç¬¬ä¸€è¡Œï¼‰*</label>
                        <input type="text" id="company_address" class="form-control" placeholder="ä¾‹å¦‚ï¼šè‡ºä¸­å¸‚è¥¿å€å»ºåœ‹è·¯21è™Ÿ">
                    </div>
                    <div class="form-group">
                        <label>å…¬å¸åœ°å€ï¼ˆç¬¬äºŒè¡Œï¼‰</label>
                        <input type="text" id="company_address_line2" class="form-control" placeholder="ä¾‹å¦‚ï¼š3æ¨“ä¹‹1">
                    </div>
                    <div class="form-group">
                        <label>è¯çµ¡é›»è©± *</label>
                        <input type="text" id="company_phone" class="form-control" placeholder="ä¾‹å¦‚ï¼š04-22205606">
                    </div>
                    <div class="form-group">
                        <label>éŠ€è¡Œåç¨± *</label>
                        <input type="text" id="company_bank" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ°¸è±éŠ€è¡Œå°ä¸­åˆ†è¡Œ">
                    </div>
                    <div class="form-group">
                        <label>éŠ€è¡Œä»£è™Ÿ *</label>
                        <input type="text" id="company_bank_code" class="form-control" placeholder="ä¾‹å¦‚ï¼š807">
                    </div>
                    <div class="form-group">
                        <label>éŠ€è¡Œå¸³è™Ÿ *</label>
                        <input type="text" id="company_account_number" class="form-control" placeholder="ä¾‹å¦‚ï¼š003-018-0019011-7">
                    </div>
                    
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveCompanyInfo()">å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è‡ªåŠ¨åŒ–è§„åˆ™ - ä»»åŠ¡è‡ªåŠ¨ç”Ÿæˆæ¦‚è§ˆ -->
        <div class="tab-panel" id="tab-automation">
            <div style="background:#f0f9ff;border:1px solid #bfdbfe;padding:16px;border-radius:8px;margin-bottom:20px;">
                <h3 style="margin:0 0 8px 0;font-size:16px;color:#1e40af;">ğŸ’¡ é—œæ–¼è‡ªå‹•åŒ–ä»»å‹™ç”Ÿæˆ</h3>
                <p style="margin:0;font-size:14px;color:#1e40af;line-height:1.6;">
                    ç³»çµ±æ¯æœˆåˆæœƒè‡ªå‹•æª¢æŸ¥æ‰€æœ‰å®¢æˆ¶çš„æœå‹™è¨­å®šï¼Œç‚ºå•Ÿç”¨äº†ã€Œè‡ªå‹•ç”Ÿæˆä»»å‹™ã€çš„æœå‹™å‰µå»ºç•¶æœˆä»»å‹™ã€‚<br>
                    æ‚¨å¯ä»¥åœ¨ã€Œ<strong>å®¢æˆ¶è©³æƒ…é </strong>ã€ä¸­ç‚ºæ¯å€‹æœå‹™è¨­å®šæ˜¯å¦è‡ªå‹•ç”Ÿæˆä»»å‹™åŠä»»å‹™å…§å®¹ã€‚
                </p>
            </div>
            
            <!-- é…ç½®æ¦‚è§ˆ -->
                <div class="search-bar" style="margin-bottom:20px;">
                    <input type="text" id="autoSearchClient" class="form-control" placeholder="æœå°‹å®¢æˆ¶åç¨±..." style="max-width:300px;margin-right:12px;">
                    <button class="btn btn-primary" onclick="loadAutoTasksOverview()">ğŸ”„ é‡æ–°æ•´ç†</button>
                    <button class="btn btn-success" onclick="previewNextMonthTasks()">ğŸ‘ï¸ é è¦½ä¸‹æœˆä»»å‹™</button>
                </div>
                
                <!-- è‡ªåŠ¨ç”Ÿæˆä»»åŠ¡æ¦‚è§ˆ -->
                <div class="card">
                    <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="margin:0;">å·²å•Ÿç”¨è‡ªå‹•ç”Ÿæˆä»»å‹™çš„æœå‹™</h3>
                        <span id="autoTaskCount" style="font-size:14px;color:#6b7280;">è¼‰å…¥ä¸­...</span>
                    </div>
                    <div class="card-body">
                        <div class="data-table-container">
                            <table class="data-table" id="autoTasksTable">
                                <thead>
                                    <tr>
                                        <th style="width:180px;">å®¢æˆ¶åç¨±</th>
                                        <th style="width:150px;">æœå‹™åç¨±</th>
                                        <th style="width:200px;">çµ„æˆéƒ¨åˆ†</th>
                                        <th>å°‡ç”Ÿæˆçš„ä»»å‹™</th>
                                        <th style="width:120px;">ç”Ÿæˆè¦å‰‡</th>
                                        <th style="width:100px;">è² è²¬äºº</th>
                                        <th style="width:120px;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="autoTasksBody">
                                    <tr><td colspan="7" class="loading">è¼‰å…¥ä¸­...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top:20px;padding:16px;background:#f9fafb;border-radius:8px;text-align:center;">
                    <p style="margin:0 0 12px 0;font-size:14px;color:#6b7280;">
                        æƒ³æŸ¥çœ‹æŒ‰å®¢æˆ¶å’Œæœå‹™åˆ†çµ„çš„ä»»å‹™ç¸½è¦½ï¼Ÿ
                    </p>
                    <a href="/internal/task-overview" class="btn btn-primary">
                        ğŸ“Š å‰å¾€ä»»å‹™ç¸½è¦½é é¢
                    </a>
                </div>
            </div>
          </div>

        <!-- å›½å®šå‡æ—¥ -->
        <div class="tab-panel" id="tab-holidays">
            <div class="search-bar">
                <button class="btn btn-primary" onclick="showAddHolidayForm()">+ æ–°å¢å‡æ—¥</button>
                <button class="btn btn-success" onclick="showBatchUploadForm()">ğŸ“¤ æ‰¹é‡ä¸Šå‚³</button>
                <button class="btn btn-secondary" onclick="downloadSampleCSV()">â¬‡ï¸ ä¸‹è¼‰ç¯„ä¾‹</button>
          </div>
          
            <!-- æ‰¹é‡ä¸Šå‚³è¡¨å–® -->
            <div class="card hidden" id="batchUploadForm">
                <div class="card-header">
                    <h3>æ‰¹é‡ä¸Šå‚³å‡æ—¥</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>ä¸Šå‚³æ–¹å¼</label>
                        <div style="margin-bottom:12px">
                            <label style="margin-right:20px;font-weight:normal">
                                <input type="radio" name="uploadMethod" value="csv" checked onchange="toggleUploadMethod()"> CSV æª”æ¡ˆ
                            </label>
                            <label style="font-weight:normal">
                                <input type="radio" name="uploadMethod" value="text" onchange="toggleUploadMethod()"> æ–‡å­—è²¼ä¸Š
                            </label>
                        </div>
                    </div>
                    
                    <!-- CSV ä¸Šå‚³ -->
                    <div id="csvUploadArea">
                        <div class="form-group">
                            <label>é¸æ“‡ CSV æª”æ¡ˆ</label>
                            <input type="file" id="csvFile" accept=".csv" class="form-control">
                        </div>
                    </div>
                    
                    <!-- æ–‡å­—è²¼ä¸Š -->
                    <div id="textUploadArea" style="display:none">
                        <div class="form-group">
                            <label>è²¼ä¸Š CSV å…§å®¹ï¼ˆæ¯è¡Œä¸€ç­†ï¼Œæ ¼å¼ï¼šæ—¥æœŸ,åç¨±ï¼‰</label>
                            <textarea id="csvText" class="form-control" rows="10" placeholder="2025-01-01,å…ƒæ—¦&#10;2025-01-27,è¾²æ›†é™¤å¤•è£œå‡&#10;2025-01-28,è¾²æ›†é™¤å¤•"></textarea>
                        </div>
                    </div>
                    
                    <div style="background:#f0f9ff;border:1px solid #bfdbfe;padding:12px;border-radius:6px;margin:16px 0;font-size:13px">
                        <strong>ğŸ“‹ æ ¼å¼èªªæ˜ï¼š</strong><br>
                        <code>æ—¥æœŸ,åç¨±</code><br>
                        æ‰€æœ‰ä¸Šå‚³çš„å‡æ—¥å°‡è‡ªå‹•è¨­å®šç‚ºåœ‹å®šå‡æ—¥<br><br>
                        <strong>ç¯„ä¾‹ï¼š</strong><br>
                        <code>2025-01-01,å…ƒæ—¦</code><br>
                        <code>2025-02-28,å’Œå¹³ç´€å¿µæ—¥</code><br>
                        <code>2025-04-04,å…’ç«¥ç¯€</code>
                    </div>
                    
                    <div class="action-btns">
                        <button class="btn btn-success" onclick="processBatchUpload()">é–‹å§‹ä¸Šå‚³</button>
                        <button class="btn btn-secondary" onclick="cancelBatchUpload()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
          
          <!-- æ–°å¢/ç·¨è¼¯å‡æ—¥è¡¨å–® -->
            <div class="card hidden" id="holidayForm">
                <div class="card-header">
                    <h3 id="holidayFormTitle">æ–°å¢åœ‹å®šå‡æ—¥</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>æ—¥æœŸ *</label>
                        <input type="date" id="holiday_date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>å‡æ—¥åç¨± *</label>
                        <input type="text" id="holiday_name" class="form-control" placeholder="ä¾‹å¦‚ï¼šå…ƒæ—¦ã€æ˜¥ç¯€ã€å…’ç«¥ç¯€" required>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveHoliday()">å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="cancelHolidayForm()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
          
            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="holidaysTable">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>å‡æ—¥åç¨±</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="3" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
          </div>
          </div>
          </div>
        </div>

    </main>

    <script src="/assets/js/components/bootstrap.js?v=3"></script>
    <script>
        // âš¡ Tab ç¼“å­˜ç³»ç»Ÿåˆå§‹åŒ–
        let currentSettingsTab = 'services';
        if (window.TabCache) {
            window.TabCache.init(['services', 'templates', 'users', 'company', 'automation', 'holidays']);
        }
        
        // Tabåˆ‡æ¢
        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.onclick = () => {
                const tab = btn.dataset.tab;
                
                // âš¡ æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
                const shouldLoad = window.TabCache ? window.TabCache.shouldLoad(currentSettingsTab, tab) : true;
                currentSettingsTab = tab;
                
                document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tab-' + tab).classList.add('active');
                
                // âš¡ åªåœ¨éœ€è¦æ—¶åŠ è½½æ•°æ®
                if (shouldLoad) {
                    // åŠ è½½å¯¹åº”æ•°æ®
                    if (tab === 'services') loadServices();
                    else if (tab === 'templates') { loadTemplates(); loadTemplateOptions(); }
                    else if (tab === 'users') loadUsers();
                    else if (tab === 'company') loadCompanyInfo();
                    else if (tab === 'automation') loadAutoTasksOverview();
                    else if (tab === 'holidays') loadHolidays();
                    
                    // âš¡ æ ‡è®°ä¸ºå·²åŠ è½½
                    if (window.TabCache) {
                        window.TabCache.markLoaded(tab);
                    }
                }
            };
        });
        
        // ä»»åŠ¡æ¨¡æ¿ - æ–°å¢
        document.getElementById('btnAddTemplate')?.addEventListener('click', () => {
            editingTemplateId = null;
            document.getElementById('newTemplateName').value = '';
            document.getElementById('newTemplateService').value = '';
            document.getElementById('newTemplateClient').value = '';
            document.getElementById('newTemplateDesc').value = '';
            document.getElementById('serviceSOPDisplay').style.display = 'none';
            document.querySelector('#addTemplateForm .card-header h3').textContent = 'æ–°å¢ä»»å‹™æ¨¡æ¿';
            document.getElementById('addTemplateForm').classList.remove('hidden');
            loadTemplateOptions();
        });

        // ç”¨æˆ·ç®¡ç†åŠŸèƒ½å·²ç§»è‡³å‡½æ•°ä¸­

        // è‡ªåŠ¨åŒ–è§„åˆ™åŠŸèƒ½å·²ç§»è‡³å‡½æ•°ä¸­

        // æ–°å¢æœåŠ¡
        document.getElementById('btnAddService').onclick = async () => {
            document.getElementById('editServiceId').value = '';
            document.getElementById('newServiceName').value = '';
            document.getElementById('newServiceSOP').value = '';
            document.getElementById('serviceFormTitle').textContent = 'æ–°å¢æœå‹™é …ç›®';
            document.getElementById('addServiceForm').classList.remove('hidden');
            await loadServiceSOPOptions();
        };

        // åŠ è½½æœåŠ¡SOPé€‰é¡¹
        async function loadServiceSOPOptions() {
            try {
                const sopRes = await fetch('/internal/api/v1/sop?scope=service', { credentials: 'include' });
                const sops = await sopRes.json();
                
                console.log('ğŸ“‹ è¼‰å…¥çš„ SOP æ•¸æ“š:', sops);
                
                const sopSelect = document.getElementById('newServiceSOP');
                if (sops.ok && sops.data && sops.data.length > 0) {
                    // âš¡ ä¿®å¾©ï¼šAPI è¿”å›çš„å­—æ®µæ˜¯ idï¼Œä¸æ˜¯ sop_id
                    sopSelect.innerHTML = '<option value="">ç„¡</option>' + 
                        sops.data.map(s => `<option value="${s.id}">${s.title}</option>`).join('');
                } else {
                    sopSelect.innerHTML = '<option value="">ç„¡</option>';
                }
            } catch (e) {
                console.error('âŒ åŠ è¼‰SOPå¤±æ•—:', e);
            }
        }

        // ç¼–è¾‘æœåŠ¡
        async function editService(serviceId) {
            try {
                // âš¡ æ·»åŠ æ™‚é–“æˆ³åƒæ•¸ç¢ºä¿ç²å–æœ€æ–°æ•¸æ“š
                const timestamp = Date.now();
                const res = await fetch(`/internal/api/v1/services/${serviceId}?_t=${timestamp}`, { 
                    credentials: 'include',
                    cache: 'no-cache'
                });
                const json = await res.json();
                
                if (!json.ok || !json.data) {
                    throw new Error('è¼‰å…¥æœå‹™å¤±æ•—');
                }
                
                const service = json.data;
                
                await loadServiceSOPOptions();
                
                document.getElementById('editServiceId').value = service.service_id;
                document.getElementById('newServiceName').value = service.service_name || '';
                document.getElementById('newServiceSOP').value = service.service_sop_id || '';
                document.getElementById('serviceFormTitle').textContent = 'ç·¨è¼¯æœå‹™é …ç›®';
                document.getElementById('addServiceForm').classList.remove('hidden');
                document.getElementById('addServiceForm').scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                console.error('è¼‰å…¥æœå‹™å¤±æ•—:', e);
                alert('è¼‰å…¥æœå‹™å¤±æ•—: ' + e.message);
            }
        }

        function cancelService() {
            document.getElementById('addServiceForm').classList.add('hidden');
            document.getElementById('editServiceId').value = '';
            document.getElementById('newServiceName').value = '';
            document.getElementById('newServiceSOP').value = '';
            document.getElementById('serviceFormTitle').textContent = 'æ–°å¢æœå‹™é …ç›®';
        }

        async function saveService() {
            const serviceId = document.getElementById('editServiceId').value;
            const name = document.getElementById('newServiceName').value;
            const sopIdStr = document.getElementById('newServiceSOP').value;
            
            if (!name) return alert('è«‹è¼¸å…¥æœå‹™åç¨±');
            
            // âš¡ ä¿®å¾©ï¼šæ­£ç¢ºè™•ç† SOP ID è½‰æ›ï¼Œé¿å… NaN
            let sopId = null;
            if (sopIdStr && sopIdStr.trim() !== '') {
                const parsed = parseInt(sopIdStr, 10);
                if (!isNaN(parsed) && parsed > 0) {
                    sopId = parsed;
                }
            }
            
            console.log('ğŸ”§ æº–å‚™ä¿å­˜çš„ SOP ID:', { åŸå§‹å€¼: sopIdStr, è§£æå¾Œ: sopId });
            
            try {
                const url = serviceId 
                    ? `/internal/api/v1/services/${serviceId}`
                    : '/internal/api/v1/services';
                const method = serviceId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        service_name: name,
                        service_sop_id: sopId
                    })
                });
                if (!res.ok) throw new Error('å¤±æ•—');
                
                // âš¡ æ¸…é™¤æœå‹™åˆ—è¡¨ç·©å­˜ï¼Œç¢ºä¿ç²å–æœ€æ–°æ•¸æ“š
                if (window.DataCache) {
                    window.DataCache.clearCache('services_types');
                    window.DataCache.clearCache('services');
                    console.log('[Settings] å·²æ¸…é™¤æœå‹™åˆ—è¡¨ç·©å­˜');
                }
                
                alert(serviceId ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
                cancelService();
                
                // é‡æ–°åŠ è¼‰æœå‹™åˆ—è¡¨
                await loadServices();
                
                // âš¡ å¦‚æœ allServices å·²è¢«åˆå§‹åŒ–ï¼ˆç”¨æˆ¶è¨ªå•éä»»å‹™æ¨¡æ¿æ¨™ç±¤ï¼‰ï¼Œä¹Ÿæ›´æ–°å®ƒ
                if (allServices && allServices.length > 0) {
                    const timestamp = Date.now();
                    const res = await fetch(`/internal/api/v1/services?_t=${timestamp}`, { 
                        credentials: 'include',
                        cache: 'no-cache'
                    });
                    const json = await res.json();
                    if (json.ok && json.data) {
                        allServices = json.data;
                        console.log('[Settings] å·²æ›´æ–°å…¨å±€æœå‹™åˆ—è¡¨');
                    }
                }
            } catch (e) {
                alert('å¤±æ•—: ' + e.message);
            }
        }

        // å…¨å±€å­˜å„² SOP æ˜ å°„è¡¨
        let sopMap = {};
        
        // åŠ è½½æœåŠ¡
        async function loadServices() {
            const tbody = document.querySelector('#servicesTable tbody');
            try {
                // âš¡ åŒæ™‚åŠ è¼‰æœå‹™å’Œ SOP åˆ—è¡¨
                const timestamp = Date.now();
                const [servicesRes, sopsRes] = await Promise.all([
                    fetch(`/internal/api/v1/services?_t=${timestamp}`, { 
                        credentials: 'include',
                        cache: 'no-cache'
                    }),
                    fetch(`/internal/api/v1/sop?scope=service&_t=${timestamp}`, {
                        credentials: 'include',
                        cache: 'no-cache'
                    })
                ]);
                
                const json = await servicesRes.json();
                const sopsJson = await sopsRes.json();
                
                console.log('æœå‹™é …ç›®APIéŸ¿æ‡‰:', json);
                
                // å»ºç«‹ SOP ID -> åç¨±çš„æ˜ å°„
                if (sopsJson.ok && sopsJson.data) {
                    sopMap = {};
                    sopsJson.data.forEach(sop => {
                        sopMap[sop.id] = sop.title;
                    });
                }
                
                if (!servicesRes.ok) {
                    console.error('APIéŒ¯èª¤:', json);
                    tbody.innerHTML = `<tr><td colspan="4" class="loading">è¼‰å…¥å¤±æ•—: ${json.message || 'æœªçŸ¥éŒ¯èª¤'}</td></tr>`;
                    return;
                }
                
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                
                tbody.innerHTML = json.data.map(s => {
                    let sopDisplay = '-';
                    if (s.service_sop_id) {
                        const sopName = sopMap[s.service_sop_id];
                        sopDisplay = sopName ? `ğŸ“– ${sopName}` : `ğŸ“– SOP #${s.service_sop_id}`;
                    }
                    return `
                    <tr>
                        <td>${s.service_id}</td>
                        <td>${s.service_name}</td>
                        <td>${sopDisplay}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editService(${s.service_id})">ç·¨è¼¯</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteService(${s.service_id})">åˆªé™¤</button>
                        </td>
                    </tr>
                `}).join('');
            } catch (e) {
                console.error('è¼‰å…¥æœå‹™å¤±æ•—:', e);
                tbody.innerHTML = `<tr><td colspan="4" class="loading">è¼‰å…¥å¤±æ•—: ${e.message}</td></tr>`;
            }
        }

        async function deleteService(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            try {
                await fetch('/internal/api/v1/services/' + id, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                // âš¡ æ¸…é™¤æœå‹™åˆ—è¡¨ç·©å­˜ï¼Œç¢ºä¿ç²å–æœ€æ–°æ•¸æ“š
                if (window.DataCache) {
                    window.DataCache.clearCache('services_types');
                    window.DataCache.clearCache('services');
                    console.log('[Settings] å·²æ¸…é™¤æœå‹™åˆ—è¡¨ç·©å­˜');
                }
                
                loadServices();
            } catch (e) {
                alert('åˆªé™¤å¤±æ•—');
            }
        }

        // å…¨å±€å­˜å‚¨SOPã€è³‡æºæ–‡æª”å’ŒæœåŠ¡åˆ—è¡¨
        let allSOPs = [];
        let allResourceDocuments = [];
        let allServices = [];

        // ä»»åŠ¡æ¨¡æ¿ - åŠ è½½æœåŠ¡ã€å®¢æˆ·ã€SOPã€é™„ä»¶ä¸‹æ‹‰é€‰é¡¹
        async function loadTemplateOptions() {
            try {
                // âš¡ æ·»åŠ æ™‚é–“æˆ³åƒæ•¸ç¹éç·©å­˜ï¼Œç¢ºä¿ç²å–æœ€æ–°æ•¸æ“š
                const timestamp = Date.now();
                const [servicesRes, clientsRes, sopRes, resourcesRes] = await Promise.all([
                    fetch(`/internal/api/v1/services?_t=${timestamp}`, { 
                        credentials: 'include',
                        cache: 'no-cache'
                    }),
                    fetch('/internal/api/v1/clients?perPage=200', { credentials: 'include' }),
                    fetch('/internal/api/v1/sop?scope=task', { credentials: 'include' }).catch(() => ({json: () => ({data:[]})})),
                    fetch('/internal/api/v1/documents?category=resource&perPage=200', { credentials: 'include' }).catch(() => ({json: () => ({items:[]})}))
                ]);
                const services = await servicesRes.json();
                const clients = await clientsRes.json();
                const sops = await sopRes.json();
                const resources = await resourcesRes.json();
                
                // ä¿å­˜åˆ°å…¨å±€
                allServices = services.data || [];
                allSOPs = sops.data || [];
                allResourceDocuments = resources.items || resources.data || [];
                
                const serviceSelect = document.getElementById('newTemplateService');
                if (services.data) {
                    serviceSelect.innerHTML = '<option value="">è«‹é¸æ“‡æœå‹™é …ç›®</option>' + 
                        services.data.map(s => `<option value="${s.service_id}">${s.service_name}</option>`).join('');
                }
                
                const clientSelect = document.getElementById('newTemplateClient');
                if (clients.data) {
                    clientSelect.innerHTML = '<option value="">é€šç”¨æ¨¡æ¿ï¼ˆä¸ç¶å®šå®¢æˆ¶ï¼‰</option>' + 
                        clients.data.map(c => `<option value="${c.clientId}">${c.companyName}</option>`).join('');
                }
            } catch (e) {}
        }
        
        // å½“é€‰æ‹©æœåŠ¡é¡¹ç›®æ—¶ï¼Œè‡ªåŠ¨æ˜¾ç¤ºè¯¥æœåŠ¡çš„æœåŠ¡å±‚çº§SOP
        function onTemplateServiceChange() {
            const serviceId = parseInt(document.getElementById('newTemplateService').value);
            const displayDiv = document.getElementById('serviceSOPDisplay');
            const sopText = document.getElementById('serviceSOPText');
            
            if (!serviceId) {
                displayDiv.style.display = 'none';
                return;
            }
            
            const service = allServices.find(s => s.service_id === serviceId);
            if (service && service.service_sop_id) {
                sopText.textContent = `ğŸ“– SOP #${service.service_sop_id}`;
                displayDiv.style.display = 'block';
            } else {
                sopText.textContent = 'æ­¤æœå‹™å°šæœªè¨­å®šæœå‹™å±¤ç´š SOP';
                displayDiv.style.display = 'block';
            }
        }
        
        // å­˜å‚¨æ¯ä¸ªæ¨¡æ¿ä»»åŠ¡è¡¨å•çš„å·²é€‰SOP
        const templateTaskSelectedSOPs = {};
        
        // å¡«å……SOPå¤é€‰æ¡†åˆ—è¡¨å’Œè³‡æºæ–‡æª”ä¸‹æ‹‰é€‰å•ï¼ˆæ ¹æ®æœåŠ¡ç±»å‹è¿‡æ»¤ï¼‰
        function populateSOPAndAttachments(templateId, serviceId, existingSOPIds = []) {
            const sopListContainer = document.getElementById(`task-sop-list-${templateId}`);
            const resourceSelect = document.getElementById(`task-attachment-${templateId}`);
            
            // åˆå§‹åŒ–å·²é€‰SOP
            if (!templateTaskSelectedSOPs[templateId]) {
                templateTaskSelectedSOPs[templateId] = [];
            }
            templateTaskSelectedSOPs[templateId] = existingSOPIds;
            
            if (sopListContainer && allSOPs.length > 0) {
                // æ ¹æ®æœåŠ¡ç±»å‹è¿‡æ»¤SOP
                let filteredSOPs = allSOPs;
                
                if (serviceId) {
                    // æ‰¾åˆ°å½“å‰æœåŠ¡çš„service_code
                    const currentService = allServices.find(s => s.service_id === serviceId);
                    const serviceCode = currentService?.service_code || '';
                    
                    console.log('[Task SOP Filter] serviceId:', serviceId, 'serviceCode:', serviceCode);
                    
                    if (serviceCode) {
                        // ç­›é€‰ï¼šåªæ˜¾ç¤ºscope=taskä¸”categoryåŒ¹é…çš„SOP
                        filteredSOPs = allSOPs.filter(sop => 
                            sop.scope === 'task' && 
                            (sop.category === serviceCode || 
                             sop.category === serviceCode.toLowerCase() || 
                             sop.category === serviceCode.toUpperCase())
                        );
                        
                        console.log('[Task SOP Filter] Filtered SOPs:', filteredSOPs.length, '/', allSOPs.length);
                    }
                }
                
                // æŒ‰æ ‡é¢˜æ’åº
                const sortedSOPs = filteredSOPs.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                
                // å­˜å‚¨è¿‡æ»¤åçš„SOPsä¾›æœç´¢ä½¿ç”¨
                window[`filteredSOPs${templateId}`] = sortedSOPs;
                
                // æ¸²æŸ“SOPå¤é€‰æ¡†
                renderSOPCheckboxes(templateId, sortedSOPs, existingSOPIds);
                
                // æ›´æ–°å·²é€‰æ ‡ç­¾æ˜¾ç¤º
                updateSelectedSOPTags(templateId);
                
                if (serviceId && sortedSOPs.length === 0) {
                    sopListContainer.innerHTML = '<div style="color:#9ca3af;text-align:center;padding:20px;font-size:13px;">æš«ç„¡é©ç”¨æ–¼æ­¤æœå‹™çš„ä»»å‹™å±¤ç´šSOP</div>';
                }
            }
            
            if (resourceSelect && allResourceDocuments.length > 0) {
                resourceSelect.innerHTML = '<option value="">ç„¡</option>' + 
                    allResourceDocuments.map(doc => `<option value="${doc.document_id}">${doc.title || doc.fileName || doc.file_name}</option>`).join('');
            }
        }
        
        // æ¸²æŸ“SOPå¤é€‰æ¡†
        function renderSOPCheckboxes(templateId, sops, selectedIds = []) {
            const sopListContainer = document.getElementById(`task-sop-list-${templateId}`);
            if (!sopListContainer) return;
            
            if (sops.length === 0) {
                sopListContainer.innerHTML = '<div style="color:#9ca3af;text-align:center;padding:20px;font-size:13px;">æš«ç„¡SOP</div>';
                return;
            }
            
            const html = sops.map(sop => {
                const isChecked = selectedIds.includes(parseInt(sop.sop_id));
                return `
                    <label class="sop-option" data-sop-id="${sop.sop_id}" data-sop-title="${(sop.title || '').toLowerCase()}"
                           style="display:flex;align-items:center;gap:8px;padding:8px;cursor:pointer;font-size:13px;margin-bottom:4px;border-radius:4px;border:1px solid ${isChecked ? '#3b82f6' : '#e5e7eb'};background:${isChecked ? '#eff6ff' : 'white'};" 
                           onmouseover="if(!this.querySelector('input').checked) this.style.background='#f3f4f6'" 
                           onmouseout="if(!this.querySelector('input').checked) this.style.background='white'">
                        <input type="checkbox" value="${sop.sop_id}" 
                               ${isChecked ? 'checked' : ''}
                               onchange="updateTaskSOPs${templateId}(this)"
                               style="cursor:pointer;flex-shrink:0;width:16px;height:16px;" />
                        <span style="color:#374151;">${sop.title}</span>
                    </label>
                `;
            }).join('');
            
            sopListContainer.innerHTML = html;
        }
        
        // æ›´æ–°å·²é€‰SOPæ ‡ç­¾æ˜¾ç¤º
        function updateSelectedSOPTags(templateId) {
            const selectedContainer = document.getElementById(`selected-sops-${templateId}`);
            if (!selectedContainer) return;
            
            const selectedIds = templateTaskSelectedSOPs[templateId] || [];
            
            if (selectedIds.length === 0) {
                selectedContainer.innerHTML = '<span style="color:#9ca3af;font-size:12px;">å°šæœªé¸æ“‡SOP</span>';
                return;
            }
            
            const html = selectedIds.map(sopId => {
                const sop = allSOPs.find(s => parseInt(s.sop_id) === parseInt(sopId));
                if (!sop) return '';
                
                return `
                    <span style="display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:#3b82f6;color:white;border-radius:4px;font-size:12px;">
                        ğŸ“– ${sop.title}
                        <button type="button" onclick="removeSOPFromTask${templateId}(${sopId})" 
                                style="background:none;border:none;color:white;cursor:pointer;padding:0;margin-left:4px;font-size:14px;">Ã—</button>
                    </span>
                `;
            }).join('');
            
            selectedContainer.innerHTML = html;
        }
        
        // ä¸ºæ¯ä¸ªæ¨¡æ¿åŠ¨æ€åˆ›å»ºæ›´æ–°å’Œç§»é™¤å‡½æ•°
        function createTaskSOPFunctions(templateId) {
            // æ›´æ–°SOPé€‰æ‹©
            window[`updateTaskSOPs${templateId}`] = function(checkbox) {
                const sopId = parseInt(checkbox.value);
                
                if (!templateTaskSelectedSOPs[templateId]) {
                    templateTaskSelectedSOPs[templateId] = [];
                }
                
                if (checkbox.checked) {
                    if (!templateTaskSelectedSOPs[templateId].includes(sopId)) {
                        templateTaskSelectedSOPs[templateId].push(sopId);
                    }
                    // æ›´æ–°å¤é€‰æ¡†æ ·å¼
                    checkbox.parentElement.style.border = '1px solid #3b82f6';
                    checkbox.parentElement.style.background = '#eff6ff';
                } else {
                    templateTaskSelectedSOPs[templateId] = templateTaskSelectedSOPs[templateId].filter(id => id !== sopId);
                    // æ›´æ–°å¤é€‰æ¡†æ ·å¼
                    checkbox.parentElement.style.border = '1px solid #e5e7eb';
                    checkbox.parentElement.style.background = 'white';
                }
                
                updateSelectedSOPTags(templateId);
            };
            
            // ä»æ ‡ç­¾ä¸­ç§»é™¤SOP
            window[`removeSOPFromTask${templateId}`] = function(sopId) {
                templateTaskSelectedSOPs[templateId] = templateTaskSelectedSOPs[templateId].filter(id => id !== sopId);
                
                // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
                const checkbox = document.querySelector(`#task-sop-list-${templateId} input[value="${sopId}"]`);
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.parentElement.style.border = '1px solid #e5e7eb';
                    checkbox.parentElement.style.background = 'white';
                }
                
                updateSelectedSOPTags(templateId);
            };
            
            // æœç´¢è¿‡æ»¤SOP
            window[`filterTaskSOPs${templateId}`] = function(searchText) {
                const searchLower = searchText.toLowerCase().trim();
                const sopOptions = document.querySelectorAll(`#task-sop-list-${templateId} .sop-option`);
                
                sopOptions.forEach(option => {
                    const title = option.getAttribute('data-sop-title') || '';
                    if (title.includes(searchLower)) {
                        option.style.display = 'flex';
                    } else {
                        option.style.display = 'none';
                    }
                });
            };
        }

        // ä»»åŠ¡æ¨¡æ¿ - åŠ è½½åˆ—è¡¨ï¼ˆæŒ‰æœåŠ¡ç±»å‹åˆ†ç»„ï¼‰
        async function loadTemplates() {
            const tbody = document.getElementById('templatesList');
            try {
                const res = await fetch('/internal/api/v1/task-templates', { credentials: 'include' });
                const json = await res.json();
                
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">æš«ç„¡æ¨¡æ¿</td></tr>';
                    return;
                }
                
                // æŒ‰æœåŠ¡ç±»å‹åˆ†ç»„
                const groupedByService = {};
                json.data.forEach(t => {
                    const serviceKey = t.service_id || 'unknown';
                    const serviceName = t.service_name || 'æœªåˆ†é¡æœå‹™';
                    
                    if (!groupedByService[serviceKey]) {
                        groupedByService[serviceKey] = {
                            serviceName: serviceName,
                            templates: []
                        };
                    }
                    groupedByService[serviceKey].templates.push(t);
                });
                
                // ç”Ÿæˆåˆ†ç»„HTML
                let html = '';
                let globalIndex = 0;
                
                Object.keys(groupedByService).forEach((serviceKey, groupIndex) => {
                    const group = groupedByService[serviceKey];
                    const groupId = `service-group-${groupIndex}`;
                    
                    // æœåŠ¡ç±»å‹åˆ†ç»„æ ‡é¢˜è¡Œ
                    html += `
                        <tr class="service-group-header" style="background:#f0f9ff;cursor:pointer;" onclick="toggleServiceGroup('${groupId}')">
                            <td colspan="5" style="padding:12px 16px;font-weight:600;color:#1e40af;font-size:15px;">
                                <span id="${groupId}-icon">â–¼</span> ${group.serviceName} (${group.templates.length} å€‹æ¨¡æ¿)
                            </td>
                        </tr>
                    `;
                    
                    // è¯¥æœåŠ¡ä¸‹çš„æ‰€æœ‰æ¨¡æ¿
                    group.templates.forEach(t => {
                        const service = allServices.find(s => s.service_id === t.service_id);
                        const serviceSopId = service?.service_sop_id;
                        const templateIndex = globalIndex++;
                        
                        html += `
                            <tr class="${groupId}-row service-main-row" data-template-id="${t.template_id}" data-service-id="${t.service_id || ''}" data-service-sop-id="${serviceSopId || ''}">
                                <td style="padding-left:32px;"><strong>${t.template_name}</strong></td>
                                <td>${t.service_name || '-'}</td>
                                <td>${t.client_name || 'é€šç”¨'}</td>
                                <td style="text-align:center;">${t.stages_count || 0}</td>
                                <td class="actions-cell">
                                    <button type="button" class="table-btn table-btn-primary" onclick="toggleTasks(${templateIndex}, ${t.template_id})">é…ç½®ä»»å‹™éšæ®µ</button>
                                    <button type="button" class="table-btn table-btn-secondary" onclick="editTemplate(${t.template_id})">ç·¨è¼¯</button>
                                    <button type="button" class="table-btn table-btn-danger" onclick="deleteTemplate(${t.template_id})">åˆªé™¤</button>
                                </td>
                            </tr>
                            <tr class="${groupId}-row component-detail-row" id="template-detail-row-${templateIndex}" style="display:none;">
                                <td colspan="5" class="component-detail-cell">
                                    <div class="component-content">
                                        <div style="padding:20px;background:#f9fafb;border-radius:8px;">
                                            <div style="display:flex;justify-content:flex-end;margin-bottom:15px;">
                                                <button class="btn btn-sm btn-primary" onclick="showAddTask(${t.template_id})">+ æ–°å¢ä»»å‹™</button>
                                            </div>
                                            
                                            <!-- ä»»å‹™è¡¨å–® -->
                                            <div id="task-form-${t.template_id}" class="hidden" style="background:white;padding:20px;border-radius:8px;margin-bottom:15px;border:2px solid #3b82f6;">
                                                <h5 style="margin-top:0;color:#1e40af;">ğŸ“ é…ç½®ä»»å‹™éšæ®µ</h5>
                                                
                                                <div style="display:grid;grid-template-columns:3fr 1fr;gap:15px;margin-bottom:15px;">
                                                    <div>
                                                        <label style="display:block;margin-bottom:4px;font-size:13px;color:#374151;">ä»»å‹™åç¨± *</label>
                                                        <input type="text" id="task-name-${t.template_id}" 
                                                               style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px;"
                                                               placeholder="è«‹è¼¸å…¥ä»»å‹™åç¨±">
                                                    </div>
                                                    <div>
                                                        <label style="display:block;margin-bottom:4px;font-size:13px;color:#374151;">æ’åºé †åº</label>
                                                        <input type="number" id="task-order-${t.template_id}" 
                                                               style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px;"
                                                               value="1" min="1">
                                                    </div>
                                                </div>
                                                
                                                <div style="margin-bottom:15px;">
                                                    <label style="display:block;margin-bottom:6px;font-size:13px;color:#374151;">
                                                        ğŸ“– ä»»å‹™å±¤ç´š SOPï¼ˆå¯é¸ï¼Œå¯å¤šé¸ï¼‰
                                                        <small style="color:#6b7280;margin-left:8px;">åƒ…é¡¯ç¤ºé©ç”¨æ–¼æ­¤æœå‹™çš„SOP</small>
                                                    </label>
                                                    
                                                    <div id="selected-sops-${t.template_id}" 
                                                         style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;min-height:32px;padding:8px;background:#f9fafb;border:1px solid #d1d5db;border-radius:4px;">
                                                        <span style="color:#9ca3af;font-size:11px;">å°šæœªé¸æ“‡SOP</span>
                                                    </div>
                                                    
                                                    <input type="text" 
                                                           id="sop-search-${t.template_id}"
                                                           placeholder="ğŸ” æœå°‹SOP..." 
                                                           style="width:100%;padding:6px 10px;border:1px solid #d1d5db;border-radius:4px;font-size:12px;margin-bottom:6px;"
                                                           onkeyup="filterTaskSOPs${t.template_id}(this.value)" />
                                                    
                                                    <div id="task-sop-list-${t.template_id}" 
                                                         style="max-height:150px;overflow-y:auto;border:1px solid #d1d5db;border-radius:4px;padding:6px;background:white;">
                                                        <div style="color:#9ca3af;text-align:center;padding:20px;font-size:12px;">è¼‰å…¥ä¸­...</div>
                                                    </div>
                                                    <small style="display:block;margin-top:5px;color:#6b7280;font-size:11px;">ğŸ’¡ é¸æ“‡SOPä½œç‚ºä»»å‹™åƒè€ƒæ–‡ä»¶ï¼ˆå¯å¤šé¸ï¼‰</small>
                                                </div>
                                                
                                                <div style="margin-bottom:15px;">
                                                    <label style="display:block;margin-bottom:4px;font-size:13px;color:#374151;">ğŸ“ ä»»å‹™å±¤ç´šè³‡æºæ–‡æª”ï¼ˆå¯é¸ï¼‰</label>
                                                    <select id="task-attachment-${t.template_id}" 
                                                            style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:13px;">
                                                        <option value="">ç„¡</option>
                                                    </select>
                                                    <p style="font-size:11px;color:#6b7280;margin-top:4px;">ğŸ’¡ å¾çŸ¥è­˜åº«è³‡æºä¸­å¿ƒé¸æ“‡ç¯„æœ¬æˆ–åƒè€ƒæ–‡æª”</p>
                                                </div>
                                                
                                                <div style="display:flex;gap:10px;margin-top:20px;">
                                                    <button class="btn btn-primary" onclick="saveTask(${t.template_id})">å„²å­˜</button>
                                                    <button class="btn btn-secondary" onclick="cancelTask(${t.template_id})">å–æ¶ˆ</button>
                                                </div>
                                            </div>
                                            
                                            <!-- ä»»å‹™åˆ—è¡¨ -->
                                            <div id="task-list-${t.template_id}">
                                                <p class="loading-text">è¼‰å…¥ä¸­...</p>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                });
                
                tbody.innerHTML = html;
                
                // ä¸ºæ¯ä¸ªæ¨¡æ¿åˆ›å»ºSOPç®¡ç†å‡½æ•°
                json.data.forEach(t => {
                    createTaskSOPFunctions(t.template_id);
                });
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }
        
        // åˆ‡æ¢æœåŠ¡åˆ†ç»„çš„å±•å¼€/æŠ˜å 
        function toggleServiceGroup(groupId) {
            const rows = document.querySelectorAll(`.${groupId}-row`);
            const icon = document.getElementById(`${groupId}-icon`);
            const isHidden = rows[0]?.style.display === 'none';
            
            rows.forEach(row => {
                row.style.display = isHidden ? '' : 'none';
            });
            
            if (icon) {
                icon.textContent = isHidden ? 'â–¼' : 'â–¶';
            }
        }

        // åˆ‡æ¢ä»»åŠ¡åˆ—è¡¨æ˜¾ç¤ºï¼ˆè¡¨æ ¼å±•å¼€æ¨¡å¼ï¼‰
        async function toggleTasks(index, templateId) {
            const detailRow = document.getElementById(`template-detail-row-${index}`);
            
            if (!detailRow) return;
            
            if (detailRow.style.display === 'none') {
                // å±•å¼€
                detailRow.style.display = '';
                await loadTasksForTemplate(templateId);
            } else {
                // æŠ˜å 
                detailRow.style.display = 'none';
            }
        }

        // åŠ è½½æŸä¸ªæ¨¡æ¿çš„ä»»åŠ¡ï¼ˆç±»ä¼¼æœåŠ¡ç»„æˆéƒ¨åˆ†çš„å±•ç¤ºï¼‰
        async function loadTasksForTemplate(templateId) {
            const listDiv = document.getElementById(`task-list-${templateId}`);
            try {
                const res = await fetch(`/internal/api/v1/task-templates/${templateId}/stages`, { credentials: 'include' });
                const json = await res.json();
                
                // è·å–æœåŠ¡å±‚çº§SOP
                const templateCard = document.querySelector(`[data-template-id="${templateId}"]`);
                const serviceSopId = templateCard ? templateCard.getAttribute('data-service-sop-id') : null;
                let serviceSOP = null;
                if (serviceSopId) {
                    serviceSOP = allSOPs.find(s => parseInt(s.sop_id) === parseInt(serviceSopId));
                }
                
                if (!json.data || json.data.length === 0) {
                    // ä»ç„¶æ˜¾ç¤ºæœåŠ¡å±‚çº§SOPï¼ˆå¦‚æœæœ‰ï¼‰
                    let html = '';
                    
                    if (serviceSOP) {
                        html += `
                            <div style="background:white;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #3b82f6;">
                                <div style="padding:8px 12px;background:#f0f9ff;border-radius:4px;border-left:3px solid #3b82f6;">
                                    <div style="font-size:12px;font-weight:600;color:#1e40af;margin-bottom:4px;">ğŸ“– æœå‹™å±¤ç´šSOPï¼ˆè‡ªå‹•ç¹¼æ‰¿ï¼‰</div>
                                    <div style="font-size:13px;color:#374151;padding:2px 0;">
                                        â€¢ ${serviceSOP.title}
                                        ${serviceSOP.category ? `<span style="font-size:11px;color:#6b7280;margin-left:4px;">[${serviceSOP.category}]</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `
                        <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:2px dashed #fbbf24;">
                            <p style="color:#92400e;font-size:14px;margin:0 0 10px 0;font-weight:500;">âš ï¸ å°šæœªé…ç½®ä»»ä½•ä»»å‹™éšæ®µ</p>
                            <p style="color:#92400e;font-size:13px;margin:0;">é»æ“Šä¸Šæ–¹ã€Œ<strong>+ æ–°å¢ä»»å‹™</strong>ã€æŒ‰éˆ•é–‹å§‹é…ç½®</p>
                        </div>
                    `;
                    
                    listDiv.innerHTML = html;
                    return;
                }
                
                // æ˜¾ç¤ºå®Œæ•´çš„ä»»åŠ¡é…ç½®ï¼ˆç±»ä¼¼æœåŠ¡ç»„æˆéƒ¨åˆ†ï¼‰
                let html = `
                    <div style="background:white;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #3b82f6;">
                        <div style="flex:1;">
                            <h5 style="margin:0 0 12px 0;color:#1f2937;font-size:15px;">æ¨¡æ¿é…ç½®</h5>
                            
                            ${serviceSOP ? `
                                <div style="padding:8px 12px;background:#f0f9ff;border-radius:4px;border-left:3px solid #3b82f6;margin-bottom:12px;">
                                    <div style="font-size:12px;font-weight:600;color:#1e40af;margin-bottom:4px;">ğŸ“– æœå‹™å±¤ç´šSOPï¼ˆè‡ªå‹•ç¹¼æ‰¿ï¼‰</div>
                                    <div style="font-size:13px;color:#374151;padding:2px 0;">
                                        â€¢ ${serviceSOP.title}
                                        ${serviceSOP.category ? `<span style="font-size:11px;color:#6b7280;margin-left:4px;">[${serviceSOP.category}]</span>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="${serviceSOP ? 'padding-top:12px;border-top:1px solid #e5e7eb;' : ''}">
                                <strong style="font-size:13px;color:#374151;">ğŸ“‹ ä»»å‹™éšæ®µåˆ—è¡¨ï¼ˆ${json.data.length}å€‹ï¼‰</strong>
                                <div style="margin-top:8px;">
                                    ${json.data.map((task, taskIdx) => {
                                        // å¤„ç†å¤šä¸ªSOPæ˜¾ç¤ºï¼ˆå…¼å®¹æ—§çš„å•ä¸€SOPï¼‰
                                        let sopIds = [];
                                        if (task.sop_ids && Array.isArray(task.sop_ids)) {
                                            sopIds = task.sop_ids;
                                        } else if (task.sop_id) {
                                            sopIds = [task.sop_id];
                                        }
                                        
                                        return `
                                            <div style="background:#f9fafb;padding:10px;border-radius:6px;margin-bottom:6px;border-left:3px solid #10b981;">
                                                <div style="display:flex;justify-content:space-between;align-items:start;">
                                                    <div style="flex:1;">
                                                        <div style="font-size:13px;color:#1f2937;font-weight:500;margin-bottom:4px;">
                                                            ${task.stage_order}. ${task.stage_name || 'æœªå‘½åä»»å‹™'}
                                                        </div>
                                                        ${sopIds.length > 0 ? `
                                                            <div style="margin-top:6px;padding:6px 8px;background:#ecfdf5;border-radius:4px;border-left:2px solid #10b981;">
                                                                <div style="font-size:11px;font-weight:600;color:#047857;margin-bottom:2px;">ğŸ“– ä»»å‹™SOPï¼š</div>
                                                                ${sopIds.map(sopId => {
                                                                    const sop = allSOPs.find(s => parseInt(s.sop_id) === parseInt(sopId));
                                                                    const sopTitle = sop ? sop.title : `SOP #${sopId}`;
                                                                    return `
                                                                        <div style="font-size:12px;color:#065f46;">
                                                                            â€¢ ${sopTitle}
                                                                        </div>
                                                                    `;
                                                                }).join('')}
                                                            </div>
                                                        ` : ''}
                                                        ${task.document_id || task.attachment_id ? `
                                                            <div style="margin-top:6px;padding:6px 8px;background:#f0f9ff;border-radius:4px;border-left:2px solid #3b82f6;">
                                                                <div style="font-size:11px;color:#1e40af;">
                                                                    ğŸ“ è³‡æºæ–‡æª” #${task.document_id || task.attachment_id}
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                    <div style="display:flex;gap:5px;margin-left:10px;">
                                                        <button class="table-btn-link" onclick="editTask(${templateId}, ${JSON.stringify(task).replace(/"/g, '&quot;')})">ç·¨è¼¯</button>
                                                        <button class="table-btn-link danger" onclick="deleteTask(${templateId}, ${task.stage_id})">åˆªé™¤</button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                listDiv.innerHTML = html;
            } catch (e) {
                listDiv.innerHTML = '<div style="color:#ef4444;padding:20px;text-align:center;">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        // æ˜¾ç¤ºæ–°å¢ä»»åŠ¡è¡¨å•
        let editingStageId = null;
        
        // è·å–æ¨¡æ¿çš„serviceId
        function getTemplateServiceId(templateId) {
            const templateCard = document.querySelector(`[data-template-id="${templateId}"]`);
            return templateCard ? parseInt(templateCard.getAttribute('data-service-id')) : null;
        }
        
        function showAddTask(templateId) {
            editingStageId = null;
            document.getElementById(`task-form-${templateId}`).classList.remove('hidden');
            document.getElementById(`task-name-${templateId}`).value = '';
            document.getElementById(`task-order-${templateId}`).value = '1';
            document.getElementById(`sop-search-${templateId}`).value = '';
            
            const serviceId = getTemplateServiceId(templateId);
            populateSOPAndAttachments(templateId, serviceId, []);
        }
        
        function editTask(templateId, task) {
            editingStageId = task.stage_id;
            const form = document.getElementById(`task-form-${templateId}`);
            form.classList.remove('hidden');
            
            document.getElementById(`task-name-${templateId}`).value = task.stage_name || '';
            document.getElementById(`task-order-${templateId}`).value = task.stage_order || 1;
            document.getElementById(`sop-search-${templateId}`).value = '';
            
            const serviceId = getTemplateServiceId(templateId);
            
            // å…¼å®¹æ—§çš„å•ä¸€SOPå­—æ®µå’Œæ–°çš„å¤šSOPå­—æ®µ
            let existingSOPIds = [];
            if (task.sop_ids && Array.isArray(task.sop_ids)) {
                existingSOPIds = task.sop_ids.map(id => parseInt(id));
            } else if (task.sop_id) {
                existingSOPIds = [parseInt(task.sop_id)];
            }
            
            populateSOPAndAttachments(templateId, serviceId, existingSOPIds);
            
            // è®¾ç½®è³‡æºæ–‡æª”çš„å€¼
            setTimeout(() => {
                const resourceSelect = document.getElementById(`task-attachment-${templateId}`);
                if (resourceSelect) resourceSelect.value = task.document_id || task.attachment_id || '';
            }, 100);
            
            form.scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelTask(templateId) {
            editingStageId = null;
            document.getElementById(`task-form-${templateId}`).classList.add('hidden');
        }

        // ä¿å­˜ä»»åŠ¡ï¼ˆæ”¯æŒå¤šä¸ªSOPï¼‰
        async function saveTask(templateId) {
            const name = document.getElementById(`task-name-${templateId}`).value;
            const order = document.getElementById(`task-order-${templateId}`).value;
            const documentId = document.getElementById(`task-attachment-${templateId}`).value;
            
            if (!name) return alert('è«‹è¼¸å…¥ä»»å‹™åç¨±');
            
            // è·å–å·²é€‰æ‹©çš„SOP IDs
            const selectedSOPIds = templateTaskSelectedSOPs[templateId] || [];
            
            try {
                const url = editingStageId 
                    ? `/internal/api/v1/task-templates/${templateId}/stages/${editingStageId}`
                    : `/internal/api/v1/task-templates/${templateId}/stages`;
                const method = editingStageId ? 'PUT' : 'POST';
                
                const payload = {
                    stage_name: name,
                    stage_order: parseInt(order) || 1,
                    document_id: documentId ? parseInt(documentId) : null
                };
                
                // å…¼å®¹åç«¯ï¼šå¦‚æœæœ‰å¤šä¸ªSOPï¼Œä½¿ç”¨sop_idsæ•°ç»„ï¼›å¦‚æœåªæœ‰ä¸€ä¸ªï¼Œä½¿ç”¨sop_idå­—æ®µ
                if (selectedSOPIds.length > 1) {
                    payload.sop_ids = selectedSOPIds;
                } else if (selectedSOPIds.length === 1) {
                    payload.sop_id = selectedSOPIds[0];
                } else {
                    payload.sop_id = null;
                }
                
                console.log('[Save Task] Payload:', payload);
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'ä¿å­˜å¤±æ•—');
                }
                
                alert(editingStageId ? 'âœ… æ›´æ–°æˆåŠŸ' : 'âœ… æ–°å¢æˆåŠŸ');
                cancelTask(templateId);
                loadTasksForTemplate(templateId);
            } catch (e) {
                console.error('ä¿å­˜ä»»å‹™å¤±æ•—:', e);
                alert((editingStageId ? 'âŒ æ›´æ–°å¤±æ•—: ' : 'âŒ æ–°å¢å¤±æ•—: ') + e.message);
            }
        }

        // åˆ é™¤ä»»åŠ¡
        async function deleteTask(templateId, stageId) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ä»»å‹™ï¼Ÿ')) return;
            try {
                await fetch(`/internal/api/v1/task-templates/${templateId}/stages/${stageId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                loadTasksForTemplate(templateId);
            } catch (e) {
                alert('åˆªé™¤å¤±æ•—');
            }
        }

        // åˆ é™¤æ¨¡æ¿
        async function deleteTemplate(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨¡æ¿ï¼Ÿæ‰€æœ‰ä»»å‹™ä¹Ÿæœƒè¢«åˆªé™¤')) return;
            try {
                await fetch('/internal/api/v1/task-templates/' + id, { method: 'DELETE', credentials: 'include' });
                loadTemplates();
            } catch (e) {
                alert('åˆªé™¤å¤±æ•—');
            }
        }

        // å…¨å±€å˜é‡ï¼šè®°å½•å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ¨¡æ¿ID
        let editingTemplateId = null;

        // ç¼–è¾‘æ¨¡æ¿
        async function editTemplate(templateId) {
            editingTemplateId = templateId;
            
            // åŠ è½½æ¨¡æ¿æ•°æ®
            try {
                const res = await fetch(`/internal/api/v1/task-templates/${templateId}`, { credentials: 'include' });
                const json = await res.json();
                
                if (!json.ok || !json.data) {
                    throw new Error('è¼‰å…¥æ¨¡æ¿å¤±æ•—');
                }
                
                const template = json.data;
                
                // å…ˆåŠ è½½é€‰é¡¹
                await loadTemplateOptions();
                
                // å¡«å……è¡¨å•
                document.getElementById('newTemplateName').value = template.template_name || '';
                document.getElementById('newTemplateService').value = template.service_id || '';
                document.getElementById('newTemplateClient').value = template.client_id || '';
                document.getElementById('newTemplateDesc').value = template.description || '';
                
                // è§¦å‘æœåŠ¡å˜æ›´ï¼Œæ˜¾ç¤ºæœåŠ¡å±‚çº§SOP
                onTemplateServiceChange();
                
                // ä¿®æ”¹è¡¨å•æ ‡é¢˜
                document.querySelector('#addTemplateForm .card-header h3').textContent = 'ç·¨è¼¯ä»»å‹™æ¨¡æ¿';
                
                // æ˜¾ç¤ºè¡¨å•
                document.getElementById('addTemplateForm').classList.remove('hidden');
                document.getElementById('addTemplateForm').scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                console.error('è¼‰å…¥æ¨¡æ¿å¤±æ•—:', e);
                alert('è¼‰å…¥æ¨¡æ¿å¤±æ•—: ' + e.message);
            }
        }

        // ä¿å­˜æ¨¡æ¿ï¼ˆæ–°å¢æˆ–ç¼–è¾‘ï¼‰
        async function saveTemplate() {
            const name = document.getElementById('newTemplateName').value;
            const serviceId = document.getElementById('newTemplateService').value;
            const clientId = document.getElementById('newTemplateClient').value;
            const desc = document.getElementById('newTemplateDesc').value;
            
            if (!name || !serviceId) return alert('è«‹è¼¸å…¥æ¨¡æ¿åç¨±ä¸¦é¸æ“‡æœå‹™é …ç›®');
            
            try {
                const url = editingTemplateId 
                    ? `/internal/api/v1/task-templates/${editingTemplateId}`
                    : '/internal/api/v1/task-templates';
                const method = editingTemplateId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        template_name: name,
                        service_id: parseInt(serviceId),
                        client_id: clientId ? parseInt(clientId) : null,
                        description: desc
                    })
                });
                
                if (!res.ok) throw new Error();
                
                alert(editingTemplateId ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
                cancelTemplate();
                loadTemplates();
            } catch (e) {
                alert(editingTemplateId ? 'æ›´æ–°å¤±æ•—' : 'æ–°å¢å¤±æ•—');
            }
        }

        function cancelTemplate() {
            editingTemplateId = null;
            document.getElementById('addTemplateForm').classList.add('hidden');
            document.getElementById('newTemplateName').value = '';
            document.getElementById('newTemplateService').value = '';
            document.getElementById('newTemplateClient').value = '';
            document.getElementById('newTemplateDesc').value = '';
            document.getElementById('serviceSOPDisplay').style.display = 'none';
            // æ¢å¤è¡¨å•æ ‡é¢˜
            document.querySelector('#addTemplateForm .card-header h3').textContent = 'æ–°å¢ä»»å‹™æ¨¡æ¿';
        }

        // ç”¨æˆ·ç®¡ç†
        async function loadUsers() {
            const tbody = document.querySelector('#usersTable tbody');
            try {
                const res = await fetch('/internal/api/v1/users', { credentials: 'include' });
                const json = await res.json();
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                tbody.innerHTML = json.data.map(u => `
                    <tr>
                        <td>${u.user_id}</td>
                        <td>${u.name}</td>
                        <td>${u.username}</td>
                        <td>${u.is_admin ? 'ç®¡ç†å“¡' : 'å“¡å·¥'}</td>
                        <td><span class="status-badge status-active">å•Ÿç”¨</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="window.location.href='/internal/profile?user_id=${u.user_id}'">æª¢è¦–</button>
                            <button class="btn btn-sm btn-primary" onclick="editUser(${JSON.stringify(u).replace(/"/g, '&quot;')})">ç·¨è¼¯</button>
                            <button class="btn btn-sm btn-warning" onclick="resetUserPassword(${u.user_id}, '${u.name}')">é‡ç½®å¯†ç¢¼</button>
                            ${u.user_id !== 1 ? `<button class="btn btn-sm btn-danger" onclick="deleteUser(${u.user_id}, '${u.name}')">åˆªé™¤</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }
        
        function showAddUserForm() {
            document.getElementById('edit_user_id').value = '';
            document.getElementById('userFormTitle').textContent = 'æ–°å¢ç”¨æˆ¶';
            document.getElementById('user_name').value = '';
            document.getElementById('user_username').value = '';
            document.getElementById('user_password').value = '';
            document.getElementById('user_is_admin').value = '0';
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('userForm').classList.remove('hidden');
        }
        
        function editUser(user) {
            document.getElementById('edit_user_id').value = user.user_id;
            document.getElementById('userFormTitle').textContent = 'ç·¨è¼¯ç”¨æˆ¶';
            document.getElementById('user_name').value = user.name || '';
            document.getElementById('user_username').value = user.username || '';
            document.getElementById('user_is_admin').value = user.is_admin ? '1' : '0';
            document.getElementById('passwordGroup').style.display = 'none';
            document.getElementById('userForm').classList.remove('hidden');
            document.getElementById('userForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelUserForm() {
            document.getElementById('userForm').classList.add('hidden');
        }
        
        async function saveUser() {
            const userId = document.getElementById('edit_user_id').value;
            const name = document.getElementById('user_name').value.trim();
            const username = document.getElementById('user_username').value.trim();
            const password = document.getElementById('user_password').value;
            const isAdmin = document.getElementById('user_is_admin').value === '1';
            
            if (!name || !username) {
                alert('è«‹å¡«å¯«å§“åå’Œå¸³è™Ÿ');
                return;
            }
            
            if (!userId && (!password || password.length < 6)) {
                alert('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ');
                return;
            }
            
            try {
                const payload = {
                    name: name,
                    username: username,
                    is_admin: isAdmin
                };
                
                if (!userId) {
                    // æ–°å¢ç”¨æˆ·
                    payload.password = password;
                }
                
                const url = userId 
                    ? `/internal/api/v1/admin/users/${userId}`
                    : '/internal/api/v1/admin/users';
                const method = userId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'æ“ä½œå¤±æ•—');
                }
                
                alert(userId ? 'âœ… æ›´æ–°æˆåŠŸï¼' : 'âœ… æ–°å¢æˆåŠŸï¼');
                cancelUserForm();
                loadUsers();
            } catch (e) {
                console.error('å„²å­˜ç”¨æˆ¶å¤±æ•—:', e);
                alert('âŒ å„²å­˜å¤±æ•—: ' + e.message);
            }
        }
        
        async function deleteUser(userId, userName) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç”¨æˆ¶ã€Œ${userName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                return;
            }
            
            try {
                const res = await fetch(`/internal/api/v1/admin/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'åˆªé™¤å¤±æ•—');
                }
                
                alert('âœ… åˆªé™¤æˆåŠŸï¼');
                loadUsers();
            } catch (e) {
                console.error('åˆªé™¤ç”¨æˆ¶å¤±æ•—:', e);
                alert('âŒ åˆªé™¤å¤±æ•—: ' + e.message);
            }
        }
        
        async function resetUserPassword(userId, userName) {
            const newPassword = prompt(`è«‹è¼¸å…¥ ${userName} çš„æ–°å¯†ç¢¼ï¼š`);
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                alert('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦å°‡ ${userName} çš„å¯†ç¢¼é‡ç½®ç‚ºæ–°å¯†ç¢¼å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const res = await fetch(`/internal/api/v1/admin/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ new_password: newPassword })
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'é‡ç½®å¤±æ•—');
                }
                
                alert(`âœ… å¯†ç¢¼é‡ç½®æˆåŠŸï¼\nç”¨æˆ¶ï¼š${userName}\nè«‹é€šçŸ¥è©²ç”¨æˆ¶ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥ã€‚`);
            } catch (e) {
                console.error('é‡ç½®å¯†ç¢¼å¤±æ•—:', e);
                alert('âŒ é‡ç½®å¯†ç¢¼å¤±æ•—: ' + e.message);
            }
        }

        // å…¬å¸è³‡è¨Šç®¡ç†
        function switchCompanyTab(setNumber) {
            document.getElementById('current_company_set').value = setNumber;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.getElementById('companyTab1').classList.toggle('active', setNumber === 1);
            document.getElementById('companyTab2').classList.toggle('active', setNumber === 2);
            
            // åŠ è½½å¯¹åº”çš„å…¬å¸èµ„æ–™
            loadCompanyInfo();
        }
        
        async function loadCompanyInfo() {
            const setNumber = document.getElementById('current_company_set').value;
            const category = `company${setNumber}`;
            
            try {
                const res = await fetch(`/internal/api/v1/settings?category=${category}`, { credentials: 'include' });
                const json = await res.json();
                
                // æ¸…ç©ºæ‰€æœ‰å­—æ®µ
                document.getElementById('company_name').value = '';
                document.getElementById('company_name_en').value = '';
                document.getElementById('company_tax_id').value = '';
                document.getElementById('company_address').value = '';
                document.getElementById('company_address_line2').value = '';
                document.getElementById('company_phone').value = '';
                document.getElementById('company_bank').value = '';
                document.getElementById('company_bank_code').value = '';
                document.getElementById('company_account_number').value = '';
                
                if (json.ok && json.data) {
                    json.data.forEach(setting => {
                        // ç§»é™¤å‰ç¼€æ¥åŒ¹é…è¡¨å•å­—æ®µ
                        const key = setting.settingKey.replace(`${category}_`, '');
                        const input = document.getElementById(`company_${key}`);
                        if (input) {
                            input.value = setting.settingValue || '';
                        }
                    });
                }
            } catch (e) {
                console.error('è¼‰å…¥å…¬å¸è³‡è¨Šå¤±æ•—:', e);
            }
        }
        
        async function saveCompanyInfo() {
            const setNumber = document.getElementById('current_company_set').value;
            const category = `company${setNumber}`;
            
            // ä½¿ç”¨categoryä½œä¸ºå‰ç¼€æ¥ç¡®ä¿setting_keyçš„å”¯ä¸€æ€§
            const settings = [
                { settingKey: `${category}_name`, settingValue: document.getElementById('company_name').value },
                { settingKey: `${category}_name_en`, settingValue: document.getElementById('company_name_en').value },
                { settingKey: `${category}_tax_id`, settingValue: document.getElementById('company_tax_id').value },
                { settingKey: `${category}_address`, settingValue: document.getElementById('company_address').value },
                { settingKey: `${category}_address_line2`, settingValue: document.getElementById('company_address_line2').value },
                { settingKey: `${category}_phone`, settingValue: document.getElementById('company_phone').value },
                { settingKey: `${category}_bank`, settingValue: document.getElementById('company_bank').value },
                { settingKey: `${category}_bank_code`, settingValue: document.getElementById('company_bank_code').value },
                { settingKey: `${category}_account_number`, settingValue: document.getElementById('company_account_number').value }
            ];
            
            if (!settings[0].settingValue) {
                alert('å…¬å¸ä¸­æ–‡åç¨±ç‚ºå¿…å¡«é …');
                return;
            }
            
            try {
                const res = await fetch('/internal/api/v1/settings/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        category: category,
                        settings: settings
                    })
                });
                
                // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await res.text();
                    console.error('éJSONéŸ¿æ‡‰:', text);
                    throw new Error('æœå‹™å™¨è¿”å›äº†éJSONéŸ¿æ‡‰ï¼Œè«‹æª¢æŸ¥å¾Œç«¯é…ç½®');
                }
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'å„²å­˜å¤±æ•—');
                }
                
                alert(`âœ… å…¬å¸è³‡æ–™ ${setNumber} å„²å­˜æˆåŠŸï¼`);
            } catch (e) {
                console.error('å„²å­˜å…¬å¸è³‡è¨Šå¤±æ•—:', e);
                alert('âŒ å„²å­˜å¤±æ•—: ' + e.message);
            }
        }

        // è‡ªåŠ¨åŒ–è§„åˆ™ç®¡ç†
        let editingRuleId = null;
        
        // è‡ªå‹•åŒ–ä»»å‹™æ¦‚è¦½ - é¡¯ç¤ºæ‰€æœ‰å•Ÿç”¨è‡ªå‹•ç”Ÿæˆçš„æœå‹™
        async function loadAutoTasksOverview() {
            const tbody = document.getElementById('autoTasksBody');
            const countEl = document.getElementById('autoTaskCount');
            const searchQuery = document.getElementById('autoSearchClient').value.trim().toLowerCase();
            
            tbody.innerHTML = '<tr><td colspan="7" class="loading">è¼‰å…¥ä¸­...</td></tr>';
            
            try {
                // ç²å–æ‰€æœ‰å•Ÿç”¨è‡ªå‹•ç”Ÿæˆçš„æœå‹™çµ„æˆéƒ¨åˆ†
                const res = await fetch('/internal/api/v1/service-components?auto_generate=1', { 
                    credentials: 'include' 
                });
                const json = await res.json();
                
                // è°ƒè¯•ï¼šæ‰“å°APIè¿”å›çš„æ•°æ®
                console.log('API å›æ‡‰:', json);
                console.log('æ•¸æ“šæ•¸é‡:', json.data?.length);
                console.log('è©³ç´°æ•¸æ“š:', json.data);
                
                if (!json.ok || !json.data || json.data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;color:#6b7280;">
                        å°šæœªè¨­å®šä»»ä½•è‡ªå‹•ç”Ÿæˆä»»å‹™çš„æœå‹™<br>
                        <small style="font-size:12px;margin-top:8px;display:block;">è«‹å‰å¾€ã€Œå®¢æˆ¶è©³æƒ…é ã€ç‚ºæœå‹™å•Ÿç”¨è‡ªå‹•ç”Ÿæˆä»»å‹™</small>
                        <br><small style="font-size:11px;margin-top:8px;display:block;color:#ef4444;">
                            èª¿è©¦ä¿¡æ¯ï¼šAPI ok=${json.ok}, æ•¸æ“šé•·åº¦=${json.data?.length || 0}
                        </small>
                    </td></tr>`;
                    countEl.textContent = 'å…± 0 å€‹æœå‹™';
                    return;
                }
                
                // éæ¿¾æœå°‹çµæœ
                let filteredData = json.data;
                if (searchQuery) {
                    filteredData = json.data.filter(item => 
                        (item.company_name || '').toLowerCase().includes(searchQuery)
                    );
                }
                
                if (filteredData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:#6b7280;">æ‰¾ä¸åˆ°ç¬¦åˆçš„å®¢æˆ¶</td></tr>';
                    countEl.textContent = `å…± 0 å€‹æœå‹™ï¼ˆæœå°‹ï¼š${searchQuery}ï¼‰`;
                    return;
                }
                
                countEl.textContent = `å…± ${filteredData.length} å€‹æœå‹™${searchQuery ? 'ï¼ˆå·²éæ¿¾ï¼‰' : ''}`;
                
                tbody.innerHTML = filteredData.map(item => {
                    const frequency = item.delivery_frequency === 'monthly' ? 'æ¯æœˆ' : 
                                    item.delivery_frequency === 'quarterly' ? 'æ¯å­£' : 
                                    item.delivery_frequency === 'yearly' ? 'æ¯å¹´' : 'è‡ªè¨‚';
                    
                    const dueDateRule = item.due_date_rule === 'end_of_month' ? 'æœˆåº•' : 
                                       item.due_date_rule === 'day_of_month' ? `æ¯æœˆ${item.due_date_value}è™Ÿ` :
                                       item.due_date_rule === 'days_from_start' ? `æœå‹™é–‹å§‹å¾Œ${item.due_date_value}å¤©` : '-';
                    
                    const assigneeName = item.assignee_name || 'æœªæŒ‡æ´¾';
                    
                    return `
                        <tr>
                            <td>
                                <a href="/internal/client-detail?id=${item.client_id}" style="color:#2563eb;text-decoration:none;font-weight:500;">
                                    ${item.company_name || 'æœªå‘½å'}
                                </a>
                            </td>
                            <td>${item.service_name || '-'}</td>
                            <td>
                                <div style="font-weight:500;">${item.component_name}</div>
                                <small style="color:#6b7280;">${frequency}</small>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="viewComponentTasks(${item.component_id}, '${item.component_name}', '${item.company_name}')">
                                    æª¢è¦–ä»»å‹™é…ç½®
                                </button>
                            </td>
                            <td>
                                <div>${dueDateRule}</div>
                                <small style="color:#6b7280;">æå‰${item.advance_days || 7}å¤©</small>
                            </td>
                            <td>${assigneeName}</td>
                            <td>
                                <a href="/internal/client-detail?id=${item.client_id}" class="btn btn-sm btn-primary">å‰å¾€è¨­å®š</a>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('è¼‰å…¥è‡ªå‹•ä»»å‹™æ¦‚è¦½å¤±æ•—:', e);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:#ef4444;">è¼‰å…¥å¤±æ•—</td></tr>';
                countEl.textContent = 'è¼‰å…¥å¤±æ•—';
            }
        }
        
        // æŸ¥çœ‹çµ„æˆéƒ¨åˆ†çš„ä»»å‹™é…ç½®
        async function viewComponentTasks(componentId, componentName, companyName) {
            try {
                const res = await fetch(`/internal/api/v1/service-components/${componentId}/tasks`, { 
                    credentials: 'include' 
                });
                const json = await res.json();
                
                const tasks = json.ok && json.data ? json.data : [];
                
                let content = `
                    <div style="padding:20px;">
                        <h3 style="margin:0 0 8px 0;font-size:18px;">
                            ${companyName} - ${componentName}
                        </h3>
                        <p style="margin:0 0 20px 0;color:#6b7280;font-size:14px;">
                            å°‡ç”Ÿæˆçš„ä»»å‹™åˆ—è¡¨ï¼š
                        </p>
                `;
                
                if (tasks.length === 0) {
                    content += `
                        <div style="padding:20px;background:#f9fafb;border-radius:8px;text-align:center;color:#6b7280;">
                            æ­¤æœå‹™çµ„æˆéƒ¨åˆ†ä½¿ç”¨é è¨­ä»»å‹™ç”Ÿæˆ<br>
                            <small style="font-size:12px;margin-top:4px;display:block;">å°‡æ ¹æ“šçµ„æˆéƒ¨åˆ†åç¨±è‡ªå‹•ç”Ÿæˆä¸€å€‹ä»»å‹™</small>
                        </div>
                    `;
                } else {
                    content += '<div style="display:flex;flex-direction:column;gap:12px;">';
                    tasks.forEach((task, idx) => {
                        const dueRuleText = task.due_rule === 'end_of_month' ? 'æœˆåº•' : 
                                          task.due_rule === 'day_of_month' ? `æ¯æœˆ${task.due_value}è™Ÿ` :
                                          task.due_rule === 'days_from_start' ? `é–‹å§‹å¾Œ${task.due_value}å¤©` : '-';
                        
                        content += `
                            <div style="padding:16px;background:#f9fafb;border-radius:8px;border-left:4px solid #3b82f6;">
                                <div style="font-weight:600;margin-bottom:4px;">
                                    ${idx + 1}. ${task.task_name}
                                </div>
                                <div style="font-size:13px;color:#6b7280;">
                                    åˆ°æœŸï¼š${dueRuleText} | 
                                    è² è²¬äººï¼š${task.assignee_name || 'æœªæŒ‡æ´¾'} | 
                                    é ä¼°æ™‚æ•¸ï¼š${task.estimated_hours || '-'}
                                </div>
                                ${task.notes ? `<div style="font-size:12px;color:#6b7280;margin-top:4px;">å‚™è¨»ï¼š${task.notes}</div>` : ''}
                            </div>
                        `;
                    });
                    content += '</div>';
                }
                
                content += `
                        <div style="margin-top:20px;text-align:right;">
                            <button class="btn btn-primary" onclick="closeModal()">é—œé–‰</button>
                        </div>
                    </div>
                `;
                
                showModal(content);
                } catch (e) {
                console.error('è¼‰å…¥ä»»å‹™é…ç½®å¤±æ•—:', e);
                alert('è¼‰å…¥ä»»å‹™é…ç½®å¤±æ•—');
            }
        }
        
        // é è¦½ä¸‹æœˆä»»å‹™
        async function previewNextMonthTasks() {
            const now = new Date();
            const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            const yearMonth = `${nextMonth.getFullYear()}-${String(nextMonth.getMonth() + 1).padStart(2, '0')}`;
            
            try {
                const res = await fetch(`/internal/api/v1/tasks/preview?target_month=${yearMonth}`, { 
                    credentials: 'include' 
                });
                const json = await res.json();
                
                if (!json.ok) {
                    throw new Error(json.message || 'é è¦½å¤±æ•—');
                }
                
                const tasks = json.data || [];
                
                let content = `
                    <div style="padding:20px;">
                        <h3 style="margin:0 0 8px 0;font-size:18px;">
                            ${yearMonth} é è¨ˆç”Ÿæˆä»»å‹™é è¦½
                        </h3>
                        <p style="margin:0 0 20px 0;color:#6b7280;font-size:14px;">
                            å…±å°‡ç”Ÿæˆ <strong style="color:#2563eb;">${tasks.length}</strong> å€‹ä»»å‹™
                        </p>
                `;
                
                if (tasks.length === 0) {
                    content += `
                        <div style="padding:40px;background:#f9fafb;border-radius:8px;text-align:center;color:#6b7280;">
                            ä¸‹å€‹æœˆä¸æœƒç”Ÿæˆä»»ä½•ä»»å‹™<br>
                            <small style="font-size:12px;margin-top:4px;display:block;">è«‹æª¢æŸ¥æœå‹™è¨­å®š</small>
                        </div>
                    `;
                } else {
                    // æŒ‰å®¢æˆ¶åˆ†çµ„
                    const byClient = {};
                    tasks.forEach(task => {
                        if (!byClient[task.company_name]) {
                            byClient[task.company_name] = [];
                        }
                        byClient[task.company_name].push(task);
                    });
                    
                    content += '<div style="display:flex;flex-direction:column;gap:16px;max-height:500px;overflow-y:auto;">';
                    
                    Object.keys(byClient).forEach(companyName => {
                        const clientTasks = byClient[companyName];
                        content += `
                            <div style="padding:16px;background:#f9fafb;border-radius:8px;">
                                <div style="font-weight:600;margin-bottom:12px;color:#1e40af;font-size:15px;">
                                    ${companyName} (${clientTasks.length} å€‹ä»»å‹™)
                                </div>
                                <div style="display:flex;flex-direction:column;gap:8px;">
                        `;
                        
                        clientTasks.forEach(task => {
                            content += `
                                <div style="padding:12px;background:white;border-radius:6px;border:1px solid #e5e7eb;">
                                    <div style="font-weight:500;margin-bottom:4px;">${task.task_name}</div>
                                    <div style="font-size:12px;color:#6b7280;">
                                        åˆ°æœŸï¼š${task.due_date} | 
                                        è² è²¬äººï¼š${task.assignee_name || 'æœªæŒ‡æ´¾'}
                                    </div>
                                </div>
                            `;
                        });
                        
                        content += `
                                </div>
                            </div>
                        `;
                    });
                    
                    content += '</div>';
                }
                
                content += `
                        <div style="margin-top:20px;text-align:right;">
                            <button class="btn btn-primary" onclick="closeModal()">é—œé–‰</button>
                        </div>
                    </div>
                `;
                
                showModal(content);
            } catch (e) {
                console.error('é è¦½ä¸‹æœˆä»»å‹™å¤±æ•—:', e);
                alert('é è¦½å¤±æ•—: ' + e.message);
            }
        }
        
        // æœå°‹åŠŸèƒ½
        document.getElementById('autoSearchClient')?.addEventListener('input', function() {
            // å»¶é²æœå°‹ï¼Œé¿å…è¼¸å…¥æ™‚éæ–¼é »ç¹
            clearTimeout(window.autoSearchTimeout);
            window.autoSearchTimeout = setTimeout(() => {
                loadAutoTasksOverview();
            }, 300);
        });
        
        // ç°¡å–®çš„æ¨¡æ…‹æ¡†åŠŸèƒ½
        function showModal(content) {
            let modal = document.getElementById('taskPreviewModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'taskPreviewModal';
                modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;max-width:800px;width:90%;max-height:90vh;overflow:auto;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);">
                    ${content}
                </div>
            `;
            modal.style.display = 'flex';
            modal.onclick = function(e) {
                if (e.target === modal) closeModal();
            };
        }
        
        function closeModal() {
            const modal = document.getElementById('taskPreviewModal');
            if (modal) modal.style.display = 'none';
        }

        // å›½å®šå‡æ—¥
        let editingHolidayDate = null; // ç”¨æ–¼è¨˜éŒ„æ­£åœ¨ç·¨è¼¯çš„å‡æ—¥æ—¥æœŸ
        
        async function loadHolidays() {
            const tbody = document.querySelector('#holidaysTable tbody');
            try {
                const res = await fetch(`/internal/api/v1/holidays`, { credentials: 'include' });
                const json = await res.json();
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                tbody.innerHTML = json.data.map(h => {
                    return `
                        <tr>
                            <td>${h.holiday_date}</td>
                            <td>${h.name || 'æœªå‘½å'}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick='editHoliday(${JSON.stringify(h)})'>ç·¨è¼¯</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteHoliday('${h.holiday_date}')">åˆªé™¤</button>
                            </td>
                        </tr>
                    `;
                }).join('');
          } catch (e) {
                console.error('è¼‰å…¥å‡æ—¥å¤±æ•—:', e);
                tbody.innerHTML = '<tr><td colspan="3" class="loading">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }
        
        function showAddHolidayForm() {
            editingHolidayDate = null;
            document.getElementById('holidayFormTitle').textContent = 'æ–°å¢åœ‹å®šå‡æ—¥';
            document.getElementById('holiday_date').value = '';
            document.getElementById('holiday_date').disabled = false;
            document.getElementById('holiday_name').value = '';
            document.getElementById('holidayForm').classList.remove('hidden');
        }
        
        function editHoliday(holiday) {
            editingHolidayDate = holiday.holiday_date;
            document.getElementById('holidayFormTitle').textContent = 'ç·¨è¼¯åœ‹å®šå‡æ—¥';
            document.getElementById('holiday_date').value = holiday.holiday_date;
            document.getElementById('holiday_date').disabled = true; // ç·¨è¼¯æ™‚ä¸èƒ½ä¿®æ”¹æ—¥æœŸï¼ˆä¸»éµï¼‰
            document.getElementById('holiday_name').value = holiday.name || '';
            
            document.getElementById('holidayForm').classList.remove('hidden');
            document.getElementById('holidayForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelHolidayForm() {
            document.getElementById('holidayForm').classList.add('hidden');
            editingHolidayDate = null;
        }
        
        async function saveHoliday() {
            const date = document.getElementById('holiday_date').value;
            const name = document.getElementById('holiday_name').value;
            
            if (!date || !name) {
                alert('è«‹å¡«å¯«æ—¥æœŸå’Œåç¨±');
                return;
            }
            
            const holidayData = {
                holiday_date: date,
                name: name,
                is_national_holiday: true,
                is_weekly_restday: false,
                is_makeup_workday: false
            };
            
            try {
                const method = editingHolidayDate ? 'PUT' : 'POST';
                const res = await fetch('/internal/api/v1/holidays', {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(holidayData)
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'æ“ä½œå¤±æ•—');
                }
                
                alert(editingHolidayDate ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
                cancelHolidayForm();
                loadHolidays();
            } catch (e) {
                console.error('å„²å­˜å‡æ—¥å¤±æ•—:', e);
                alert('å„²å­˜å¤±æ•—: ' + e.message);
            }
        }
        
        async function deleteHoliday(date) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${date} çš„å‡æ—¥å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const res = await fetch(`/internal/api/v1/holidays?holiday_date=${date}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'åˆªé™¤å¤±æ•—');
                }
                
                alert('åˆªé™¤æˆåŠŸ');
                loadHolidays();
            } catch (e) {
                console.error('åˆªé™¤å‡æ—¥å¤±æ•—:', e);
                alert('åˆªé™¤å¤±æ•—: ' + e.message);
            }
        }
        
        // æ‰¹é‡ä¸Šå‚³åŠŸèƒ½
        function showBatchUploadForm() {
            document.getElementById('batchUploadForm').classList.remove('hidden');
            document.getElementById('batchUploadForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelBatchUpload() {
            document.getElementById('batchUploadForm').classList.add('hidden');
            document.getElementById('csvFile').value = '';
            document.getElementById('csvText').value = '';
        }
        
        function toggleUploadMethod() {
            const method = document.querySelector('input[name="uploadMethod"]:checked').value;
            if (method === 'csv') {
                document.getElementById('csvUploadArea').style.display = 'block';
                document.getElementById('textUploadArea').style.display = 'none';
            } else {
                document.getElementById('csvUploadArea').style.display = 'none';
                document.getElementById('textUploadArea').style.display = 'block';
            }
        }
        
        function parseCSVLine(line) {
            const parts = line.split(',').map(p => p.trim());
            if (parts.length < 2) return null;
            
            const [date, name] = parts;
            if (!date || !name) return null;
            
            return {
                holiday_date: date,
                name: name,
                is_national_holiday: true,
                is_weekly_restday: false,
                is_makeup_workday: false
            };
        }
        
        function downloadSampleCSV() {
            const sampleData = `æ—¥æœŸ,åç¨±
2025-01-01,å…ƒæ—¦
2025-02-28,å’Œå¹³ç´€å¿µæ—¥
2025-04-04,å…’ç«¥ç¯€
2025-04-05,æ¸…æ˜ç¯€
2025-05-01,å‹å‹•ç¯€
2025-06-10,ç«¯åˆç¯€
2025-09-17,ä¸­ç§‹ç¯€
2025-10-10,åœ‹æ…¶æ—¥`;
            
            const blob = new Blob(['\uFEFF' + sampleData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'åœ‹å®šå‡æ—¥ç¯„ä¾‹.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function processBatchUpload() {
            const method = document.querySelector('input[name="uploadMethod"]:checked').value;
            let csvContent = '';
            
            if (method === 'csv') {
                const fileInput = document.getElementById('csvFile');
                if (!fileInput.files || !fileInput.files[0]) {
                    alert('è«‹é¸æ“‡ CSV æª”æ¡ˆ');
                    return;
                }
                
                try {
                    csvContent = await fileInput.files[0].text();
                } catch (e) {
                    alert('è®€å–æª”æ¡ˆå¤±æ•—');
                    return;
                }
            } else {
                csvContent = document.getElementById('csvText').value;
            }
            
            if (!csvContent.trim()) {
                alert('è«‹è¼¸å…¥å…§å®¹');
                return;
            }
            
            // è§£æ CSV
            const lines = csvContent.split('\n').filter(line => line.trim());
            const holidays = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // è·³éæ¨™é¡Œè¡Œï¼ˆå¦‚æœæœ‰ï¼‰
                if (i === 0 && (line.includes('æ—¥æœŸ') || line.includes('date'))) {
                    continue;
                }
                
                const holiday = parseCSVLine(line);
                if (holiday) {
                    holidays.push(holiday);
                }
            }
            
            if (holidays.length === 0) {
                alert('æ²’æœ‰æœ‰æ•ˆçš„å‡æ—¥è³‡æ–™');
                return;
            }
            
            if (!confirm(`å³å°‡ä¸Šå‚³ ${holidays.length} ç­†å‡æ—¥è³‡æ–™ï¼Œç¢ºå®šç¹¼çºŒï¼Ÿ`)) {
                return;
            }
            
            try {
                const res = await fetch('/internal/api/v1/holidays', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(holidays)
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'ä¸Šå‚³å¤±æ•—');
                }
                
                let message = json.message || 'ä¸Šå‚³æˆåŠŸ';
                if (json.data && json.data.errors && json.data.errors.length > 0) {
                    message += '\n\néƒ¨åˆ†éŒ¯èª¤ï¼š\n' + json.data.errors.join('\n');
                }
                
                alert(message);
                cancelBatchUpload();
                loadHolidays();
            } catch (e) {
                console.error('æ‰¹é‡ä¸Šå‚³å¤±æ•—:', e);
                alert('æ‰¹é‡ä¸Šå‚³å¤±æ•—: ' + e.message);
            }
        }

        // ç™»å‡º
        async function logout() {
            if (!confirm('ç¢ºå®šç™»å‡ºï¼Ÿ')) return;
            await fetch('/internal/api/v1/auth/logout', { method: 'POST', credentials: 'include' });
            window.location.href = '/login.html';
        }

        // Tab åˆ‡æ¢åŠŸèƒ½
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰ active class
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            
            // æ·»åŠ  active class
            const targetBtn = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
            const targetPanel = document.getElementById(`tab-${tabName}`);
            
            if (targetBtn) targetBtn.classList.add('active');
            if (targetPanel) targetPanel.classList.add('active');
            
            // æ ¹æ®tabåŠ è½½å¯¹åº”æ•°æ®
            switch(tabName) {
                case 'services':
                    loadServices();
                    break;
                case 'templates':
                    loadTemplates();
                    loadTemplateOptions();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'company':
                    loadCompanyInfo();
                    break;
                case 'automation':
                    loadAutoTasksOverview();
                    break;
                case 'holidays':
                    loadHolidays();
                    break;
            }
        }
        
        // ç»‘å®šæ‰€æœ‰tabæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        // åˆå§‹åŒ–
        (async () => {
            const res = await fetch('/internal/api/v1/auth/me', { credentials: 'include' });
            if (!res.ok) {
                document.getElementById('permBar').style.display = 'block';
                return;
            }
            // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªtabçš„æ•°æ®
            switchTab('services');
        })();
    </script>
  </body>
  </html>

