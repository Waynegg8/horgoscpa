<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ç³»çµ±è¨­å®šï½œç®¡ç†å“¡</title>
    <link rel="stylesheet" href="/assets/css/common.css">
    <link rel="stylesheet" href="/assets/css/internal-system.css">
    <link rel="stylesheet" href="/assets/css/internal-components.css">
    <link rel="stylesheet" href="/assets/css/settings-page.css?v=205">
    
    <!-- âš¡ é¢„åŠ è½½ä¸ç¼“å­˜ç³»ç»Ÿ -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <script src="/assets/js/prerender.js"></script>
    <script src="/assets/js/page-prerender.js"></script>
    <script src="/assets/js/tab-cache.js"></script>
  </head>
<body>
    <div id="permBar" class="alert alert-danger" style="display:none">æ‚¨æ²’æœ‰æ¬Šé™</div>
    
    <nav class="settings-nav">
        <button class="nav-tab active" data-tab="services">æœå‹™é …ç›®</button>
        <button class="nav-tab" data-tab="templates">ä»»å‹™æ¨¡æ¿</button>
        <button class="nav-tab" data-tab="users">ç”¨æˆ¶</button>
        <button class="nav-tab" data-tab="company">å…¬å¸è³‡è¨Š</button>
        <button class="nav-tab" data-tab="automation">è‡ªå‹•åŒ–è¦å‰‡</button>
        <button class="nav-tab" data-tab="holidays">åœ‹å®šå‡æ—¥</button>
    </nav>

    <main class="settings-content">
        
        <!-- æœåŠ¡é¡¹ç›® -->
        <div class="tab-panel active" id="tab-services">
            <div class="search-bar">
                <button class="btn btn-primary" id="btnAddService">+ æ–°å¢</button>
            </div>

            <div class="card hidden" id="addServiceForm">
                <div class="card-header"><h3 id="serviceFormTitle">æ–°å¢æœå‹™é …ç›®</h3></div>
                <div class="card-body">
                    <input type="hidden" id="editServiceId">
                    <div class="form-group">
                        <label>æœå‹™åç¨± *</label>
                        <input type="text" id="newServiceName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>æœå‹™å±¤ç´š SOPï¼ˆå¯é¸ï¼‰</label>
                        <select id="newServiceSOP" class="form-control">
                            <option value="">ç„¡</option>
                        </select>
                        <small style="color:#666;font-size:12px;display:block;margin-top:4px;">
                            ğŸ’¡ æœå‹™å±¤ç´š SOP ä»£è¡¨æ•´å€‹æœå‹™çš„é€šç”¨æµç¨‹ï¼Œä½¿ç”¨æ­¤æœå‹™çš„ä»»å‹™æ¨¡æ¿æœƒè‡ªå‹•ç¹¼æ‰¿ã€‚
                        </small>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveService()">å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="cancelService()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="servicesTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>æœå‹™åç¨±</th>
                                    <th>æœå‹™å±¤ç´š SOP</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="4" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡æ¨¡æ¿ -->
        <div class="tab-panel" id="tab-templates">
            <div class="search-bar">
                <button class="btn btn-primary" id="btnAddTemplate">+ æ–°å¢æ¨¡æ¿</button>
            </div>
            
            <!-- æ–°å¢æ¨¡æ¿è¡¨å• -->
            <div class="card hidden" id="addTemplateForm">
                <div class="card-header"><h3>æ–°å¢ä»»å‹™æ¨¡æ¿</h3></div>
                <div class="card-body">
                    <div class="form-group">
                        <label>æ¨¡æ¿åç¨± *</label>
                        <input type="text" id="newTemplateName" class="form-control" placeholder="ä¾‹å¦‚ï¼šè¨˜å¸³æœå‹™æ¨™æº–æµç¨‹">
                    </div>
                    <div class="form-group">
                        <label>æœå‹™é …ç›® *</label>
                        <select id="newTemplateService" class="form-control" onchange="onTemplateServiceChange()">
                            <option value="">è«‹é¸æ“‡æœå‹™é …ç›®</option>
                        </select>
                    </div>
                    <div id="serviceSOPDisplay" class="form-group" style="display:none;">
                        <label>æœå‹™å±¤ç´š SOPï¼ˆè‡ªå‹•ç¹¼æ‰¿è‡ªæœå‹™é …ç›®ï¼‰</label>
                        <div style="background:#f0f9ff;border:1px solid #bae6fd;padding:12px;border-radius:6px;">
                            <span id="serviceSOPText" style="color:#0369a1;font-weight:500;">-</span>
                        </div>
                        <small style="color:#666;font-size:12px;display:block;margin-top:4px;">
                            ğŸ’¡ æ­¤ SOP å¾æœå‹™é …ç›®è‡ªå‹•ç¹¼æ‰¿ã€‚å¦‚éœ€ä¿®æ”¹ï¼Œè«‹åˆ°æœå‹™é …ç›®è¨­å®šä¸­ç·¨è¼¯ã€‚
                        </small>
                    </div>
                    <div class="form-group">
                        <label>ç¶å®šå®¢æˆ¶ï¼ˆå¯é¸ï¼‰</label>
                        <select id="newTemplateClient" class="form-control">
                            <option value="">é€šç”¨æ¨¡æ¿ï¼ˆä¸ç¶å®šå®¢æˆ¶ï¼‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>èªªæ˜</label>
                        <textarea id="newTemplateDesc" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveTemplate()">å„²å­˜æ¨¡æ¿</button>
                        <button class="btn btn-secondary" onclick="cancelTemplate()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ¿åˆ—è¡¨ -->
            <div id="templatesList"></div>
        </div>

        <!-- ç”¨æˆ· -->
        <div class="tab-panel" id="tab-users">
            <div class="search-bar">
                <button class="btn btn-primary" onclick="showAddUserForm()">+ æ–°å¢</button>
            </div>
            
            <!-- æ–°å¢/ç¼–è¾‘ç”¨æˆ·è¡¨å• -->
            <div class="card hidden" id="userForm">
                <div class="card-header">
                    <h3 id="userFormTitle">æ–°å¢ç”¨æˆ¶</h3>
                </div>
                <div class="card-body">
                    <input type="hidden" id="edit_user_id">
                    <div class="form-group">
                        <label>å§“å *</label>
                        <input type="text" id="user_name" class="form-control" placeholder="è«‹è¼¸å…¥å§“å" required>
                    </div>
                    <div class="form-group">
                        <label>å¸³è™Ÿï¼ˆç”¨æˆ¶åï¼‰*</label>
                        <input type="text" id="user_username" class="form-control" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" required>
                    </div>
                    <div class="form-group" id="passwordGroup">
                        <label>å¯†ç¢¼ *</label>
                        <input type="password" id="user_password" class="form-control" placeholder="è‡³å°‘6å€‹å­—å…ƒ" required>
                    </div>
                    <div class="form-group">
                        <label>è§’è‰²</label>
                        <select id="user_is_admin" class="form-control">
                            <option value="0">å“¡å·¥</option>
                            <option value="1">ç®¡ç†å“¡</option>
                        </select>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveUser()">å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="cancelUserForm()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>å§“å</th>
                                    <th>å¸³è™Ÿ</th>
                                    <th>è§’è‰²</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å…¬å¸è³‡è¨Š -->
        <div class="tab-panel" id="tab-company">
            <div class="card">
                <div class="card-header">
                    <h2>å…¬å¸è³‡è¨Šè¨­å®š</h2>
                    <p style="color:#666;font-size:14px;margin:8px 0 0 0;">è¨­å®šå…¬å¸åŸºæœ¬è³‡è¨Šï¼Œç”¨æ–¼æ”¶æ“šã€å ±è¡¨ç­‰æ–‡ä»¶</p>
                </div>
                <div class="card-body">
                    <!-- å…¬å¸è³‡æ–™åˆ‡æ› -->
                    <div style="margin-bottom:32px;background:#f9fafb;padding:8px;border-radius:12px;display:inline-flex;gap:8px;">
                        <button class="company-tab-btn active" onclick="switchCompanyTab(1)" id="companyTab1">
                            ğŸ¢ å…¬å¸è³‡æ–™ 1
                        </button>
                        <button class="company-tab-btn" onclick="switchCompanyTab(2)" id="companyTab2">
                            ğŸ¢ å…¬å¸è³‡æ–™ 2
                        </button>
                    </div>

                    <input type="hidden" id="current_company_set" value="1">

                    <div class="form-group">
                        <label>å…¬å¸ä¸­æ–‡åç¨± *</label>
                        <input type="text" id="company_name" class="form-control" placeholder="ä¾‹å¦‚ï¼šéœçˆ¾æœæ–¯æœƒè¨ˆå¸«äº‹å‹™æ‰€">
                    </div>
                    <div class="form-group">
                        <label>å…¬å¸è‹±æ–‡åç¨±</label>
                        <input type="text" id="company_name_en" class="form-control" placeholder="ä¾‹å¦‚ï¼šHorgosCPA">
                    </div>
                    <div class="form-group">
                        <label>çµ±ä¸€ç·¨è™Ÿ *</label>
                        <input type="text" id="company_tax_id" class="form-control" placeholder="ä¾‹å¦‚ï¼š92254178">
                    </div>
                    <div class="form-group">
                        <label>å…¬å¸åœ°å€ï¼ˆç¬¬ä¸€è¡Œï¼‰*</label>
                        <input type="text" id="company_address" class="form-control" placeholder="ä¾‹å¦‚ï¼šè‡ºä¸­å¸‚è¥¿å€å»ºåœ‹è·¯21è™Ÿ">
                    </div>
                    <div class="form-group">
                        <label>å…¬å¸åœ°å€ï¼ˆç¬¬äºŒè¡Œï¼‰</label>
                        <input type="text" id="company_address_line2" class="form-control" placeholder="ä¾‹å¦‚ï¼š3æ¨“ä¹‹1">
                    </div>
                    <div class="form-group">
                        <label>è¯çµ¡é›»è©± *</label>
                        <input type="text" id="company_phone" class="form-control" placeholder="ä¾‹å¦‚ï¼š04-22205606">
                    </div>
                    <div class="form-group">
                        <label>éŠ€è¡Œåç¨± *</label>
                        <input type="text" id="company_bank" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ°¸è±éŠ€è¡Œå°ä¸­åˆ†è¡Œ">
                    </div>
                    <div class="form-group">
                        <label>éŠ€è¡Œä»£è™Ÿ *</label>
                        <input type="text" id="company_bank_code" class="form-control" placeholder="ä¾‹å¦‚ï¼š807">
                    </div>
                    <div class="form-group">
                        <label>éŠ€è¡Œå¸³è™Ÿ *</label>
                        <input type="text" id="company_account_number" class="form-control" placeholder="ä¾‹å¦‚ï¼š003-018-0019011-7">
                    </div>
                    
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveCompanyInfo()">å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è‡ªåŠ¨åŒ–è§„åˆ™ -->
        <div class="tab-panel" id="tab-automation">
            <div class="search-bar">
                <button class="btn btn-primary" onclick="showAddAutomationForm()">+ æ–°å¢è¦å‰‡</button>
            </div>
            
            <!-- æ–°å¢/ç¼–è¾‘è¡¨å• -->
            <div class="card hidden" id="automationForm">
                <div class="card-header">
                    <h3 id="automationFormTitle">æ–°å¢è‡ªå‹•åŒ–è¦å‰‡</h3>
                </div>
                <div class="card-body">
                    <input type="hidden" id="edit_rule_id">
                    
                    <div class="form-group">
                        <label>è¦å‰‡åç¨± *</label>
                        <input type="text" id="rule_name" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ¯æ—¥ä»»å‹™æé†’" required>
                    </div>
                    
                    <div class="form-group">
                        <label>æ’ç¨‹é¡å‹ *</label>
                        <select id="schedule_type" class="form-control" onchange="onScheduleTypeChange()" required>
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="daily">æ¯æ—¥åŸ·è¡Œ</option>
                            <option value="weekly">æ¯é€±åŸ·è¡Œ</option>
                            <option value="monthly">æ¯æœˆåŸ·è¡Œ</option>
                            <option value="cron">è‡ªè¨‚ Cron è¡¨é”å¼</option>
                        </select>
                    </div>
                    
                    <!-- æ¯æ—¥æ’ç¨‹ -->
                    <div class="form-group hidden" id="daily_schedule">
                        <label>åŸ·è¡Œæ™‚é–“ *</label>
                        <input type="time" id="daily_time" class="form-control" value="00:00">
                        <small style="color:#666;display:block;margin-top:4px;">æ¯å¤©åœ¨æŒ‡å®šæ™‚é–“åŸ·è¡Œ</small>
                    </div>
                    
                    <!-- æ¯é€±æ’ç¨‹ -->
                    <div class="form-group hidden" id="weekly_schedule">
                        <label>æ˜ŸæœŸèˆ‡æ™‚é–“ *</label>
                        <div style="display:flex;gap:12px;">
                            <select id="weekly_day" class="form-control" style="flex:1;">
                                <option value="Mon">æ˜ŸæœŸä¸€</option>
                                <option value="Tue">æ˜ŸæœŸäºŒ</option>
                                <option value="Wed">æ˜ŸæœŸä¸‰</option>
                                <option value="Thu">æ˜ŸæœŸå››</option>
                                <option value="Fri">æ˜ŸæœŸäº”</option>
                                <option value="Sat">æ˜ŸæœŸå…­</option>
                                <option value="Sun">æ˜ŸæœŸæ—¥</option>
                            </select>
                            <input type="time" id="weekly_time" class="form-control" value="00:00" style="flex:1;">
                        </div>
                        <small style="color:#666;display:block;margin-top:4px;">æ¯é€±åœ¨æŒ‡å®šæ˜ŸæœŸå’Œæ™‚é–“åŸ·è¡Œ</small>
                    </div>
                    
                    <!-- æ¯æœˆæ’ç¨‹ -->
                    <div class="form-group hidden" id="monthly_schedule">
                        <label>æ—¥æœŸèˆ‡æ™‚é–“ *</label>
                        <div style="display:flex;gap:12px;">
                            <input type="number" id="monthly_day" class="form-control" min="1" max="31" value="1" placeholder="æ—¥æœŸ" style="flex:1;">
                            <input type="time" id="monthly_time" class="form-control" value="00:00" style="flex:1;">
                        </div>
                        <small style="color:#666;display:block;margin-top:4px;">æ¯æœˆåœ¨æŒ‡å®šæ—¥æœŸå’Œæ™‚é–“åŸ·è¡Œï¼ˆ1-31ï¼‰</small>
                    </div>
                    
                    <!-- Cronè¡¨é”å¼ -->
                    <div class="form-group hidden" id="cron_schedule">
                        <label>Cron è¡¨é”å¼ *</label>
                        <input type="text" id="cron_expression" class="form-control" placeholder="ä¾‹å¦‚ï¼š0 2 * * *">
                        <small style="color:#666;display:block;margin-top:4px;">
                            æ ¼å¼ï¼šåˆ† æ™‚ æ—¥ æœˆ æ˜ŸæœŸã€‚<a href="https://crontab.guru/" target="_blank">åƒè€ƒ Cron èªæ³•</a>
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>åŸ·è¡Œå‹•ä½œ *</label>
                        <select id="action_type" class="form-control" required>
                            <option value="">è«‹é¸æ“‡å‹•ä½œ</option>
                            <option value="task_reminder">ä»»å‹™åˆ°æœŸæé†’</option>
                            <option value="invoice_reminder">æ”¶æ“šé€¾æœŸæé†’</option>
                            <option value="backup_data">æ•¸æ“šå‚™ä»½</option>
                            <option value="generate_report">ç”Ÿæˆå ±è¡¨</option>
                            <option value="cleanup">æ¸…ç†éæœŸæ•¸æ“š</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>å‹•ä½œåƒæ•¸ï¼ˆJSONæ ¼å¼ï¼Œå¯é¸ï¼‰</label>
                        <textarea id="action_params" class="form-control" rows="4" placeholder='ä¾‹å¦‚ï¼š{"days_before": 3, "notify_users": [1, 2]}'></textarea>
                        <small style="color:#666;display:block;margin-top:4px;">
                            æ ¹æ“šå‹•ä½œé¡å‹è¨­å®šç›¸é—œåƒæ•¸ï¼Œç•™ç©ºä½¿ç”¨é è¨­å€¼
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>æ¢ä»¶éæ¿¾ï¼ˆJSONæ ¼å¼ï¼Œå¯é¸ï¼‰</label>
                        <textarea id="condition_params" class="form-control" rows="4" placeholder='ä¾‹å¦‚ï¼š{"status": "pending", "priority": "high"}'></textarea>
                        <small style="color:#666;display:block;margin-top:4px;">
                            è¨­å®šç¯©é¸æ¢ä»¶ï¼Œç•™ç©ºè¡¨ç¤ºä¸ç¯©é¸
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="is_enabled" checked style="width:20px;height:20px;">
                            <span>å•Ÿç”¨æ­¤è¦å‰‡</span>
                        </label>
                    </div>
                    
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveAutomationRule()">å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="cancelAutomationForm()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="automationTable">
                            <thead>
                                <tr>
                                    <th>è¦å‰‡åç¨±</th>
                                    <th>æ’ç¨‹é¡å‹</th>
                                    <th>æ’ç¨‹è¨­å®š</th>
                                    <th>ä¸Šæ¬¡åŸ·è¡Œ</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
          </div>
          </div>

        <!-- å›½å®šå‡æ—¥ -->
        <div class="tab-panel" id="tab-holidays">
            <div class="search-bar">
                <button class="btn btn-primary" onclick="showAddHolidayForm()">+ æ–°å¢å‡æ—¥</button>
                <button class="btn btn-success" onclick="showBatchUploadForm()">ğŸ“¤ æ‰¹é‡ä¸Šå‚³</button>
                <button class="btn btn-secondary" onclick="downloadSampleCSV()">â¬‡ï¸ ä¸‹è¼‰ç¯„ä¾‹</button>
          </div>
          
            <!-- æ‰¹é‡ä¸Šå‚³è¡¨å–® -->
            <div class="card hidden" id="batchUploadForm">
                <div class="card-header">
                    <h3>æ‰¹é‡ä¸Šå‚³å‡æ—¥</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>ä¸Šå‚³æ–¹å¼</label>
                        <div style="margin-bottom:12px">
                            <label style="margin-right:20px;font-weight:normal">
                                <input type="radio" name="uploadMethod" value="csv" checked onchange="toggleUploadMethod()"> CSV æª”æ¡ˆ
                            </label>
                            <label style="font-weight:normal">
                                <input type="radio" name="uploadMethod" value="text" onchange="toggleUploadMethod()"> æ–‡å­—è²¼ä¸Š
                            </label>
                        </div>
                    </div>
                    
                    <!-- CSV ä¸Šå‚³ -->
                    <div id="csvUploadArea">
                        <div class="form-group">
                            <label>é¸æ“‡ CSV æª”æ¡ˆ</label>
                            <input type="file" id="csvFile" accept=".csv" class="form-control">
                        </div>
                    </div>
                    
                    <!-- æ–‡å­—è²¼ä¸Š -->
                    <div id="textUploadArea" style="display:none">
                        <div class="form-group">
                            <label>è²¼ä¸Š CSV å…§å®¹ï¼ˆæ¯è¡Œä¸€ç­†ï¼Œæ ¼å¼ï¼šæ—¥æœŸ,åç¨±ï¼‰</label>
                            <textarea id="csvText" class="form-control" rows="10" placeholder="2025-01-01,å…ƒæ—¦&#10;2025-01-27,è¾²æ›†é™¤å¤•è£œå‡&#10;2025-01-28,è¾²æ›†é™¤å¤•"></textarea>
                        </div>
                    </div>
                    
                    <div style="background:#f0f9ff;border:1px solid #bfdbfe;padding:12px;border-radius:6px;margin:16px 0;font-size:13px">
                        <strong>ğŸ“‹ æ ¼å¼èªªæ˜ï¼š</strong><br>
                        <code>æ—¥æœŸ,åç¨±</code><br>
                        æ‰€æœ‰ä¸Šå‚³çš„å‡æ—¥å°‡è‡ªå‹•è¨­å®šç‚ºåœ‹å®šå‡æ—¥<br><br>
                        <strong>ç¯„ä¾‹ï¼š</strong><br>
                        <code>2025-01-01,å…ƒæ—¦</code><br>
                        <code>2025-02-28,å’Œå¹³ç´€å¿µæ—¥</code><br>
                        <code>2025-04-04,å…’ç«¥ç¯€</code>
                    </div>
                    
                    <div class="action-btns">
                        <button class="btn btn-success" onclick="processBatchUpload()">é–‹å§‹ä¸Šå‚³</button>
                        <button class="btn btn-secondary" onclick="cancelBatchUpload()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
          
          <!-- æ–°å¢/ç·¨è¼¯å‡æ—¥è¡¨å–® -->
            <div class="card hidden" id="holidayForm">
                <div class="card-header">
                    <h3 id="holidayFormTitle">æ–°å¢åœ‹å®šå‡æ—¥</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>æ—¥æœŸ *</label>
                        <input type="date" id="holiday_date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>å‡æ—¥åç¨± *</label>
                        <input type="text" id="holiday_name" class="form-control" placeholder="ä¾‹å¦‚ï¼šå…ƒæ—¦ã€æ˜¥ç¯€ã€å…’ç«¥ç¯€" required>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveHoliday()">å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="cancelHolidayForm()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
          
            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="holidaysTable">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>å‡æ—¥åç¨±</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="3" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
          </div>
          </div>
          </div>
        </div>

    </main>

    <script src="/assets/js/components/bootstrap.js?v=3"></script>
    <script>
        // âš¡ Tab ç¼“å­˜ç³»ç»Ÿåˆå§‹åŒ–
        let currentSettingsTab = 'services';
        if (window.TabCache) {
            window.TabCache.init(['services', 'templates', 'users', 'company', 'automation', 'holidays']);
        }
        
        // Tabåˆ‡æ¢
        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.onclick = () => {
                const tab = btn.dataset.tab;
                
                // âš¡ æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
                const shouldLoad = window.TabCache ? window.TabCache.shouldLoad(currentSettingsTab, tab) : true;
                currentSettingsTab = tab;
                
                document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tab-' + tab).classList.add('active');
                
                // âš¡ åªåœ¨éœ€è¦æ—¶åŠ è½½æ•°æ®
                if (shouldLoad) {
                    // åŠ è½½å¯¹åº”æ•°æ®
                    if (tab === 'services') loadServices();
                    else if (tab === 'templates') { loadTemplates(); loadTemplateOptions(); }
                    else if (tab === 'users') loadUsers();
                    else if (tab === 'company') loadCompanyInfo();
                    else if (tab === 'automation') loadAutomation();
                    else if (tab === 'holidays') loadHolidays();
                    
                    // âš¡ æ ‡è®°ä¸ºå·²åŠ è½½
                    if (window.TabCache) {
                        window.TabCache.markLoaded(tab);
                    }
                }
            };
        });
        
        // ä»»åŠ¡æ¨¡æ¿ - æ–°å¢
        document.getElementById('btnAddTemplate')?.addEventListener('click', () => {
            editingTemplateId = null;
            document.getElementById('newTemplateName').value = '';
            document.getElementById('newTemplateService').value = '';
            document.getElementById('newTemplateClient').value = '';
            document.getElementById('newTemplateDesc').value = '';
            document.getElementById('serviceSOPDisplay').style.display = 'none';
            document.querySelector('#addTemplateForm .card-header h3').textContent = 'æ–°å¢ä»»å‹™æ¨¡æ¿';
            document.getElementById('addTemplateForm').classList.remove('hidden');
            loadTemplateOptions();
        });

        // ç”¨æˆ·ç®¡ç†åŠŸèƒ½å·²ç§»è‡³å‡½æ•°ä¸­

        // è‡ªåŠ¨åŒ–è§„åˆ™åŠŸèƒ½å·²ç§»è‡³å‡½æ•°ä¸­

        // æ–°å¢æœåŠ¡
        document.getElementById('btnAddService').onclick = async () => {
            document.getElementById('editServiceId').value = '';
            document.getElementById('newServiceName').value = '';
            document.getElementById('newServiceSOP').value = '';
            document.getElementById('serviceFormTitle').textContent = 'æ–°å¢æœå‹™é …ç›®';
            document.getElementById('addServiceForm').classList.remove('hidden');
            await loadServiceSOPOptions();
        };

        // åŠ è½½æœåŠ¡SOPé€‰é¡¹
        async function loadServiceSOPOptions() {
            try {
                const sopRes = await fetch('/internal/api/v1/sop?scope=service', { credentials: 'include' });
                const sops = await sopRes.json();
                
                const sopSelect = document.getElementById('newServiceSOP');
                if (sops.data && sops.data.length > 0) {
                    sopSelect.innerHTML = '<option value="">ç„¡</option>' + 
                        sops.data.map(s => `<option value="${s.sop_id}">${s.title}</option>`).join('');
                } else {
                    sopSelect.innerHTML = '<option value="">ç„¡</option>';
                }
            } catch (e) {
                console.error('åŠ è¼‰SOPå¤±æ•—:', e);
            }
        }

        // ç¼–è¾‘æœåŠ¡
        async function editService(serviceId) {
            try {
                const res = await fetch(`/internal/api/v1/services/${serviceId}`, { credentials: 'include' });
                const json = await res.json();
                
                if (!json.ok || !json.data) {
                    throw new Error('è¼‰å…¥æœå‹™å¤±æ•—');
                }
                
                const service = json.data;
                
                await loadServiceSOPOptions();
                
                document.getElementById('editServiceId').value = service.service_id;
                document.getElementById('newServiceName').value = service.service_name || '';
                document.getElementById('newServiceSOP').value = service.service_sop_id || '';
                document.getElementById('serviceFormTitle').textContent = 'ç·¨è¼¯æœå‹™é …ç›®';
                document.getElementById('addServiceForm').classList.remove('hidden');
                document.getElementById('addServiceForm').scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                console.error('è¼‰å…¥æœå‹™å¤±æ•—:', e);
                alert('è¼‰å…¥æœå‹™å¤±æ•—: ' + e.message);
            }
        }

        function cancelService() {
            document.getElementById('addServiceForm').classList.add('hidden');
            document.getElementById('editServiceId').value = '';
            document.getElementById('newServiceName').value = '';
            document.getElementById('newServiceSOP').value = '';
            document.getElementById('serviceFormTitle').textContent = 'æ–°å¢æœå‹™é …ç›®';
        }

        async function saveService() {
            const serviceId = document.getElementById('editServiceId').value;
            const name = document.getElementById('newServiceName').value;
            const sopId = document.getElementById('newServiceSOP').value;
            
            if (!name) return alert('è«‹è¼¸å…¥æœå‹™åç¨±');
            
            try {
                const url = serviceId 
                    ? `/internal/api/v1/services/${serviceId}`
                    : '/internal/api/v1/services';
                const method = serviceId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        service_name: name,
                        service_sop_id: sopId ? parseInt(sopId) : null
                    })
                });
                if (!res.ok) throw new Error('å¤±æ•—');
                alert(serviceId ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
                cancelService();
                loadServices();
            } catch (e) {
                alert('å¤±æ•—: ' + e.message);
            }
        }

        // åŠ è½½æœåŠ¡
        async function loadServices() {
            const tbody = document.querySelector('#servicesTable tbody');
            try {
                const res = await fetch('/internal/api/v1/services', { credentials: 'include' });
                const json = await res.json();
                
                console.log('æœå‹™é …ç›®APIéŸ¿æ‡‰:', json);
                
                if (!res.ok) {
                    console.error('APIéŒ¯èª¤:', json);
                    tbody.innerHTML = `<tr><td colspan="4" class="loading">è¼‰å…¥å¤±æ•—: ${json.message || 'æœªçŸ¥éŒ¯èª¤'}</td></tr>`;
                    return;
                }
                
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                
                tbody.innerHTML = json.data.map(s => {
                    const sopDisplay = s.service_sop_id ? `ğŸ“– SOP #${s.service_sop_id}` : '-';
                    return `
                    <tr>
                        <td>${s.service_id}</td>
                        <td>${s.service_name}</td>
                        <td>${sopDisplay}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editService(${s.service_id})">ç·¨è¼¯</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteService(${s.service_id})">åˆªé™¤</button>
                        </td>
                    </tr>
                `}).join('');
            } catch (e) {
                console.error('è¼‰å…¥æœå‹™å¤±æ•—:', e);
                tbody.innerHTML = `<tr><td colspan="4" class="loading">è¼‰å…¥å¤±æ•—: ${e.message}</td></tr>`;
            }
        }

        async function deleteService(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            try {
                await fetch('/internal/api/v1/services/' + id, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                loadServices();
            } catch (e) {
                alert('åˆªé™¤å¤±æ•—');
            }
        }

        // å…¨å±€å­˜å‚¨SOPã€é™„ä»¶å’ŒæœåŠ¡åˆ—è¡¨
        let allSOPs = [];
        let allAttachments = [];
        let allServices = [];

        // ä»»åŠ¡æ¨¡æ¿ - åŠ è½½æœåŠ¡ã€å®¢æˆ·ã€SOPã€é™„ä»¶ä¸‹æ‹‰é€‰é¡¹
        async function loadTemplateOptions() {
            try {
                const [servicesRes, clientsRes, sopRes, attachmentRes] = await Promise.all([
                    fetch('/internal/api/v1/services', { credentials: 'include' }),
                    fetch('/internal/api/v1/clients?perPage=200', { credentials: 'include' }),
                    fetch('/internal/api/v1/sop?scope=task', { credentials: 'include' }).catch(() => ({json: () => ({data:[]})})),
                    fetch('/internal/api/v1/attachments', { credentials: 'include' }).catch(() => ({json: () => ({data:[]})}))
                ]);
                const services = await servicesRes.json();
                const clients = await clientsRes.json();
                const sops = await sopRes.json();
                const attachments = await attachmentRes.json();
                
                // ä¿å­˜åˆ°å…¨å±€
                allServices = services.data || [];
                allSOPs = sops.data || [];
                allAttachments = attachments.data || [];
                
                const serviceSelect = document.getElementById('newTemplateService');
                if (services.data) {
                    serviceSelect.innerHTML = '<option value="">è«‹é¸æ“‡æœå‹™é …ç›®</option>' + 
                        services.data.map(s => `<option value="${s.service_id}">${s.service_name}</option>`).join('');
                }
                
                const clientSelect = document.getElementById('newTemplateClient');
                if (clients.data) {
                    clientSelect.innerHTML = '<option value="">é€šç”¨æ¨¡æ¿ï¼ˆä¸ç¶å®šå®¢æˆ¶ï¼‰</option>' + 
                        clients.data.map(c => `<option value="${c.clientId}">${c.companyName}</option>`).join('');
                }
            } catch (e) {}
        }
        
        // å½“é€‰æ‹©æœåŠ¡é¡¹ç›®æ—¶ï¼Œè‡ªåŠ¨æ˜¾ç¤ºè¯¥æœåŠ¡çš„æœåŠ¡å±‚çº§SOP
        function onTemplateServiceChange() {
            const serviceId = parseInt(document.getElementById('newTemplateService').value);
            const displayDiv = document.getElementById('serviceSOPDisplay');
            const sopText = document.getElementById('serviceSOPText');
            
            if (!serviceId) {
                displayDiv.style.display = 'none';
                return;
            }
            
            const service = allServices.find(s => s.service_id === serviceId);
            if (service && service.service_sop_id) {
                sopText.textContent = `ğŸ“– SOP #${service.service_sop_id}`;
                displayDiv.style.display = 'block';
            } else {
                sopText.textContent = 'æ­¤æœå‹™å°šæœªè¨­å®šæœå‹™å±¤ç´š SOP';
                displayDiv.style.display = 'block';
            }
        }
        
        // å­˜å‚¨æ¯ä¸ªæ¨¡æ¿ä»»åŠ¡è¡¨å•çš„å·²é€‰SOP
        const templateTaskSelectedSOPs = {};
        
        // å¡«å……SOPå¤é€‰æ¡†åˆ—è¡¨å’Œé™„ä»¶ä¸‹æ‹‰é€‰å•ï¼ˆæ ¹æ®æœåŠ¡ç±»å‹è¿‡æ»¤ï¼‰
        function populateSOPAndAttachments(templateId, serviceId, existingSOPIds = []) {
            const sopListContainer = document.getElementById(`task-sop-list-${templateId}`);
            const attachmentSelect = document.getElementById(`task-attachment-${templateId}`);
            
            // åˆå§‹åŒ–å·²é€‰SOP
            if (!templateTaskSelectedSOPs[templateId]) {
                templateTaskSelectedSOPs[templateId] = [];
            }
            templateTaskSelectedSOPs[templateId] = existingSOPIds;
            
            if (sopListContainer && allSOPs.length > 0) {
                // æ ¹æ®æœåŠ¡ç±»å‹è¿‡æ»¤SOP
                let filteredSOPs = allSOPs;
                
                if (serviceId) {
                    // æ‰¾åˆ°å½“å‰æœåŠ¡çš„service_code
                    const currentService = allServices.find(s => s.service_id === serviceId);
                    const serviceCode = currentService?.service_code || '';
                    
                    console.log('[Task SOP Filter] serviceId:', serviceId, 'serviceCode:', serviceCode);
                    
                    if (serviceCode) {
                        // ç­›é€‰ï¼šåªæ˜¾ç¤ºscope=taskä¸”categoryåŒ¹é…çš„SOP
                        filteredSOPs = allSOPs.filter(sop => 
                            sop.scope === 'task' && 
                            (sop.category === serviceCode || 
                             sop.category === serviceCode.toLowerCase() || 
                             sop.category === serviceCode.toUpperCase())
                        );
                        
                        console.log('[Task SOP Filter] Filtered SOPs:', filteredSOPs.length, '/', allSOPs.length);
                    }
                }
                
                // æŒ‰æ ‡é¢˜æ’åº
                const sortedSOPs = filteredSOPs.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                
                // å­˜å‚¨è¿‡æ»¤åçš„SOPsä¾›æœç´¢ä½¿ç”¨
                window[`filteredSOPs${templateId}`] = sortedSOPs;
                
                // æ¸²æŸ“SOPå¤é€‰æ¡†
                renderSOPCheckboxes(templateId, sortedSOPs, existingSOPIds);
                
                // æ›´æ–°å·²é€‰æ ‡ç­¾æ˜¾ç¤º
                updateSelectedSOPTags(templateId);
                
                if (serviceId && sortedSOPs.length === 0) {
                    sopListContainer.innerHTML = '<div style="color:#9ca3af;text-align:center;padding:20px;font-size:13px;">æš«ç„¡é©ç”¨æ–¼æ­¤æœå‹™çš„ä»»å‹™å±¤ç´šSOP</div>';
                }
            }
            
            if (attachmentSelect && allAttachments.length > 0) {
                attachmentSelect.innerHTML = '<option value="">ç„¡</option>' + 
                    allAttachments.map(a => `<option value="${a.attachment_id}">${a.file_name || a.attachment_id}</option>`).join('');
            }
        }
        
        // æ¸²æŸ“SOPå¤é€‰æ¡†
        function renderSOPCheckboxes(templateId, sops, selectedIds = []) {
            const sopListContainer = document.getElementById(`task-sop-list-${templateId}`);
            if (!sopListContainer) return;
            
            if (sops.length === 0) {
                sopListContainer.innerHTML = '<div style="color:#9ca3af;text-align:center;padding:20px;font-size:13px;">æš«ç„¡SOP</div>';
                return;
            }
            
            const html = sops.map(sop => {
                const isChecked = selectedIds.includes(parseInt(sop.sop_id));
                return `
                    <label class="sop-option" data-sop-id="${sop.sop_id}" data-sop-title="${(sop.title || '').toLowerCase()}"
                           style="display:flex;align-items:center;gap:8px;padding:8px;cursor:pointer;font-size:13px;margin-bottom:4px;border-radius:4px;border:1px solid ${isChecked ? '#3b82f6' : '#e5e7eb'};background:${isChecked ? '#eff6ff' : 'white'};" 
                           onmouseover="if(!this.querySelector('input').checked) this.style.background='#f3f4f6'" 
                           onmouseout="if(!this.querySelector('input').checked) this.style.background='white'">
                        <input type="checkbox" value="${sop.sop_id}" 
                               ${isChecked ? 'checked' : ''}
                               onchange="updateTaskSOPs${templateId}(this)"
                               style="cursor:pointer;flex-shrink:0;width:16px;height:16px;" />
                        <span style="color:#374151;">${sop.title}</span>
                    </label>
                `;
            }).join('');
            
            sopListContainer.innerHTML = html;
        }
        
        // æ›´æ–°å·²é€‰SOPæ ‡ç­¾æ˜¾ç¤º
        function updateSelectedSOPTags(templateId) {
            const selectedContainer = document.getElementById(`selected-sops-${templateId}`);
            if (!selectedContainer) return;
            
            const selectedIds = templateTaskSelectedSOPs[templateId] || [];
            
            if (selectedIds.length === 0) {
                selectedContainer.innerHTML = '<span style="color:#9ca3af;font-size:12px;">å°šæœªé¸æ“‡SOP</span>';
                return;
            }
            
            const html = selectedIds.map(sopId => {
                const sop = allSOPs.find(s => parseInt(s.sop_id) === parseInt(sopId));
                if (!sop) return '';
                
                return `
                    <span style="display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:#3b82f6;color:white;border-radius:4px;font-size:12px;">
                        ğŸ“– ${sop.title}
                        <button type="button" onclick="removeSOPFromTask${templateId}(${sopId})" 
                                style="background:none;border:none;color:white;cursor:pointer;padding:0;margin-left:4px;font-size:14px;">Ã—</button>
                    </span>
                `;
            }).join('');
            
            selectedContainer.innerHTML = html;
        }
        
        // ä¸ºæ¯ä¸ªæ¨¡æ¿åŠ¨æ€åˆ›å»ºæ›´æ–°å’Œç§»é™¤å‡½æ•°
        function createTaskSOPFunctions(templateId) {
            // æ›´æ–°SOPé€‰æ‹©
            window[`updateTaskSOPs${templateId}`] = function(checkbox) {
                const sopId = parseInt(checkbox.value);
                
                if (!templateTaskSelectedSOPs[templateId]) {
                    templateTaskSelectedSOPs[templateId] = [];
                }
                
                if (checkbox.checked) {
                    if (!templateTaskSelectedSOPs[templateId].includes(sopId)) {
                        templateTaskSelectedSOPs[templateId].push(sopId);
                    }
                    // æ›´æ–°å¤é€‰æ¡†æ ·å¼
                    checkbox.parentElement.style.border = '1px solid #3b82f6';
                    checkbox.parentElement.style.background = '#eff6ff';
                } else {
                    templateTaskSelectedSOPs[templateId] = templateTaskSelectedSOPs[templateId].filter(id => id !== sopId);
                    // æ›´æ–°å¤é€‰æ¡†æ ·å¼
                    checkbox.parentElement.style.border = '1px solid #e5e7eb';
                    checkbox.parentElement.style.background = 'white';
                }
                
                updateSelectedSOPTags(templateId);
            };
            
            // ä»æ ‡ç­¾ä¸­ç§»é™¤SOP
            window[`removeSOPFromTask${templateId}`] = function(sopId) {
                templateTaskSelectedSOPs[templateId] = templateTaskSelectedSOPs[templateId].filter(id => id !== sopId);
                
                // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
                const checkbox = document.querySelector(`#task-sop-list-${templateId} input[value="${sopId}"]`);
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.parentElement.style.border = '1px solid #e5e7eb';
                    checkbox.parentElement.style.background = 'white';
                }
                
                updateSelectedSOPTags(templateId);
            };
            
            // æœç´¢è¿‡æ»¤SOP
            window[`filterTaskSOPs${templateId}`] = function(searchText) {
                const searchLower = searchText.toLowerCase().trim();
                const sopOptions = document.querySelectorAll(`#task-sop-list-${templateId} .sop-option`);
                
                sopOptions.forEach(option => {
                    const title = option.getAttribute('data-sop-title') || '';
                    if (title.includes(searchLower)) {
                        option.style.display = 'flex';
                    } else {
                        option.style.display = 'none';
                    }
                });
            };
        }

        // ä»»åŠ¡æ¨¡æ¿ - åŠ è½½åˆ—è¡¨
        async function loadTemplates() {
            const container = document.getElementById('templatesList');
            try {
                const res = await fetch('/internal/api/v1/task-templates', { credentials: 'include' });
                const json = await res.json();
                
                if (!json.data || json.data.length === 0) {
                    container.innerHTML = '<div class="card"><div class="card-body" style="text-align:center;color:#999">æš«ç„¡æ¨¡æ¿</div></div>';
                    return;
                }
                
                container.innerHTML = json.data.map(t => {
                    // è·å–æœåŠ¡çš„service_sop_id
                    const service = allServices.find(s => s.service_id === t.service_id);
                    const serviceSopId = service?.service_sop_id;
                    
                    return `
                    <div class="card" style="margin-bottom:24px" data-template-id="${t.template_id}" data-service-id="${t.service_id || ''}" data-service-sop-id="${serviceSopId || ''}">
                        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <h3 style="margin:0;font-size:16px">${t.template_name}</h3>
                                <div style="font-size:13px;color:#666;margin-top:4px">
                                    æœå‹™ï¼š${t.service_name || '-'} | å®¢æˆ¶ï¼š${t.client_name || 'é€šç”¨'} | ${t.stages_count || 0} å€‹ä»»å‹™éšæ®µ
                                </div>
                            </div>
                            <div style="display:flex;gap:8px">
                                <button class="btn btn-sm btn-primary" onclick="editTemplate(${t.template_id})">ç·¨è¼¯</button>
                                <button class="btn btn-sm btn-secondary" onclick="toggleTasks(${t.template_id})">â–¼ ä»»å‹™éšæ®µ</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${t.template_id})">åˆªé™¤</button>
                            </div>
                        </div>
                        <div class="card-body hidden" id="tasks-${t.template_id}" style="padding:20px;background:#f9fafb;border-radius:8px;">
                            <div style="display:flex;justify-content:flex-end;align-items:center;margin-bottom:15px;">
                                <button class="btn btn-sm btn-primary" onclick="showAddTask(${t.template_id})">+ æ–°å¢ä»»å‹™</button>
                            </div>
                            
                            <!-- ä»»å‹™è¡¨å–®ï¼ˆé¡ä¼¼æœå‹™çµ„æˆéƒ¨åˆ†ï¼‰ -->
                            <div id="task-form-${t.template_id}" class="hidden" style="background:white;padding:20px;border-radius:8px;margin-bottom:15px;border:2px solid #3b82f6;">
                                <h5 style="margin-top:0;color:#1e40af;">ğŸ“ é…ç½®ä»»å‹™éšæ®µ</h5>
                                
                                <!-- åŸºæœ¬ä¿¡æ¯ -->
                                <div style="display:grid;grid-template-columns:3fr 1fr;gap:15px;margin-bottom:15px;">
                                    <div>
                                        <label style="display:block;margin-bottom:4px;font-size:13px;color:#374151;">ä»»å‹™åç¨± *</label>
                                        <input type="text" id="task-name-${t.template_id}" 
                                               style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px;"
                                               placeholder="è«‹è¼¸å…¥ä»»å‹™åç¨±">
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:4px;font-size:13px;color:#374151;">æ’åºé †åº</label>
                                        <input type="number" id="task-order-${t.template_id}" 
                                               style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:14px;"
                                               value="1" min="1">
                                    </div>
                                </div>
                                
                                <!-- SOPé¸æ“‡å€åŸŸ -->
                                <div style="margin-bottom:15px;">
                                    <label style="display:block;margin-bottom:6px;font-size:13px;color:#374151;">
                                        ğŸ“– ä»»å‹™å±¤ç´š SOPï¼ˆå¯é¸ï¼Œå¯å¤šé¸ï¼‰
                                        <small style="color:#6b7280;margin-left:8px;">åƒ…é¡¯ç¤ºé©ç”¨æ–¼æ­¤æœå‹™çš„SOP</small>
                                    </label>
                                    
                                    <!-- å·²é¸æ“‡çš„SOPæ¨™ç±¤ -->
                                    <div id="selected-sops-${t.template_id}" 
                                         style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;min-height:32px;padding:8px;background:#f9fafb;border:1px solid #d1d5db;border-radius:4px;">
                                        <span style="color:#9ca3af;font-size:11px;">å°šæœªé¸æ“‡SOP</span>
                                    </div>
                                    
                                    <!-- æœç´¢æ¡† -->
                                    <input type="text" 
                                           id="sop-search-${t.template_id}"
                                           placeholder="ğŸ” æœå°‹SOP..." 
                                           style="width:100%;padding:6px 10px;border:1px solid #d1d5db;border-radius:4px;font-size:12px;margin-bottom:6px;"
                                           onkeyup="filterTaskSOPs${t.template_id}(this.value)" />
                                    
                                    <!-- SOPè¤‡é¸æ¡†åˆ—è¡¨ -->
                                    <div id="task-sop-list-${t.template_id}" 
                                         style="max-height:150px;overflow-y:auto;border:1px solid #d1d5db;border-radius:4px;padding:6px;background:white;">
                                        <div style="color:#9ca3af;text-align:center;padding:20px;font-size:12px;">è¼‰å…¥ä¸­...</div>
                                    </div>
                                    <small style="display:block;margin-top:5px;color:#6b7280;font-size:11px;">ğŸ’¡ é¸æ“‡SOPä½œç‚ºä»»å‹™åƒè€ƒæ–‡ä»¶ï¼ˆå¯å¤šé¸ï¼‰</small>
                                </div>
                                
                                <!-- é™„ä»¶é¸æ“‡ -->
                                <div style="margin-bottom:15px;">
                                    <label style="display:block;margin-bottom:4px;font-size:13px;color:#374151;">ğŸ“ ä»»å‹™å±¤ç´šé™„ä»¶ï¼ˆå¯é¸ï¼‰</label>
                                    <select id="task-attachment-${t.template_id}" 
                                            style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:13px;">
                                        <option value="">ç„¡</option>
                                    </select>
                                </div>
                                
                                <!-- æ“ä½œæŒ‰éˆ• -->
                                <div style="display:flex;gap:10px;margin-top:20px;">
                                    <button class="btn btn-primary" onclick="saveTask(${t.template_id})">å„²å­˜</button>
                                    <button class="btn btn-secondary" onclick="cancelTask(${t.template_id})">å–æ¶ˆ</button>
                                </div>
                            </div>
                            
                            <!-- ä»»å‹™åˆ—è¡¨ -->
                            <div id="task-list-${t.template_id}" style="margin-top:15px;">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                    `;
                }).join('');
                
                // ä¸ºæ¯ä¸ªæ¨¡æ¿åˆ›å»ºSOPç®¡ç†å‡½æ•°
                json.data.forEach(t => {
                    createTaskSOPFunctions(t.template_id);
                });
            } catch (e) {
                container.innerHTML = '<div class="card"><div class="card-body" style="text-align:center;color:#f44">è¼‰å…¥å¤±æ•—</div></div>';
            }
        }

        // åˆ‡æ¢ä»»åŠ¡åˆ—è¡¨æ˜¾ç¤º
        async function toggleTasks(templateId) {
            const tasksDiv = document.getElementById(`tasks-${templateId}`);
            if (tasksDiv.classList.contains('hidden')) {
                tasksDiv.classList.remove('hidden');
                await loadTasksForTemplate(templateId);
            } else {
                tasksDiv.classList.add('hidden');
            }
        }

        // åŠ è½½æŸä¸ªæ¨¡æ¿çš„ä»»åŠ¡ï¼ˆç±»ä¼¼æœåŠ¡ç»„æˆéƒ¨åˆ†çš„å±•ç¤ºï¼‰
        async function loadTasksForTemplate(templateId) {
            const listDiv = document.getElementById(`task-list-${templateId}`);
            try {
                const res = await fetch(`/internal/api/v1/task-templates/${templateId}/stages`, { credentials: 'include' });
                const json = await res.json();
                
                // è·å–æœåŠ¡å±‚çº§SOP
                const templateCard = document.querySelector(`[data-template-id="${templateId}"]`);
                const serviceSopId = templateCard ? templateCard.getAttribute('data-service-sop-id') : null;
                let serviceSOP = null;
                if (serviceSopId) {
                    serviceSOP = allSOPs.find(s => parseInt(s.sop_id) === parseInt(serviceSopId));
                }
                
                if (!json.data || json.data.length === 0) {
                    // ä»ç„¶æ˜¾ç¤ºæœåŠ¡å±‚çº§SOPï¼ˆå¦‚æœæœ‰ï¼‰
                    let html = '';
                    
                    if (serviceSOP) {
                        html += `
                            <div style="background:white;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #3b82f6;">
                                <div style="padding:8px 12px;background:#f0f9ff;border-radius:4px;border-left:3px solid #3b82f6;">
                                    <div style="font-size:12px;font-weight:600;color:#1e40af;margin-bottom:4px;">ğŸ“– æœå‹™å±¤ç´šSOPï¼ˆè‡ªå‹•ç¹¼æ‰¿ï¼‰</div>
                                    <div style="font-size:13px;color:#374151;padding:2px 0;">
                                        â€¢ ${serviceSOP.title}
                                        ${serviceSOP.category ? `<span style="font-size:11px;color:#6b7280;margin-left:4px;">[${serviceSOP.category}]</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `
                        <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:2px dashed #fbbf24;">
                            <p style="color:#92400e;font-size:14px;margin:0 0 10px 0;font-weight:500;">âš ï¸ å°šæœªé…ç½®ä»»ä½•ä»»å‹™éšæ®µ</p>
                            <p style="color:#92400e;font-size:13px;margin:0;">é»æ“Šä¸Šæ–¹ã€Œ<strong>+ æ–°å¢ä»»å‹™</strong>ã€æŒ‰éˆ•é–‹å§‹é…ç½®</p>
                        </div>
                    `;
                    
                    listDiv.innerHTML = html;
                    return;
                }
                
                // æ˜¾ç¤ºå®Œæ•´çš„ä»»åŠ¡é…ç½®ï¼ˆç±»ä¼¼æœåŠ¡ç»„æˆéƒ¨åˆ†ï¼‰
                let html = `
                    <div style="background:white;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #3b82f6;">
                        <div style="flex:1;">
                            <h5 style="margin:0 0 12px 0;color:#1f2937;font-size:15px;">æ¨¡æ¿é…ç½®</h5>
                            
                            ${serviceSOP ? `
                                <div style="padding:8px 12px;background:#f0f9ff;border-radius:4px;border-left:3px solid #3b82f6;margin-bottom:12px;">
                                    <div style="font-size:12px;font-weight:600;color:#1e40af;margin-bottom:4px;">ğŸ“– æœå‹™å±¤ç´šSOPï¼ˆè‡ªå‹•ç¹¼æ‰¿ï¼‰</div>
                                    <div style="font-size:13px;color:#374151;padding:2px 0;">
                                        â€¢ ${serviceSOP.title}
                                        ${serviceSOP.category ? `<span style="font-size:11px;color:#6b7280;margin-left:4px;">[${serviceSOP.category}]</span>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="${serviceSOP ? 'padding-top:12px;border-top:1px solid #e5e7eb;' : ''}">
                                <strong style="font-size:13px;color:#374151;">ğŸ“‹ ä»»å‹™éšæ®µåˆ—è¡¨ï¼ˆ${json.data.length}å€‹ï¼‰</strong>
                                <div style="margin-top:8px;">
                                    ${json.data.map((task, taskIdx) => {
                                        // å¤„ç†å¤šä¸ªSOPæ˜¾ç¤ºï¼ˆå…¼å®¹æ—§çš„å•ä¸€SOPï¼‰
                                        let sopIds = [];
                                        if (task.sop_ids && Array.isArray(task.sop_ids)) {
                                            sopIds = task.sop_ids;
                                        } else if (task.sop_id) {
                                            sopIds = [task.sop_id];
                                        }
                                        
                                        return `
                                            <div style="background:#f9fafb;padding:10px;border-radius:6px;margin-bottom:6px;border-left:3px solid #10b981;">
                                                <div style="display:flex;justify-content:space-between;align-items:start;">
                                                    <div style="flex:1;">
                                                        <div style="font-size:13px;color:#1f2937;font-weight:500;margin-bottom:4px;">
                                                            ${task.stage_order}. ${task.stage_name || 'æœªå‘½åä»»å‹™'}
                                                        </div>
                                                        ${sopIds.length > 0 ? `
                                                            <div style="margin-top:6px;padding:6px 8px;background:#ecfdf5;border-radius:4px;border-left:2px solid #10b981;">
                                                                <div style="font-size:11px;font-weight:600;color:#047857;margin-bottom:2px;">ğŸ“– ä»»å‹™SOPï¼š</div>
                                                                ${sopIds.map(sopId => {
                                                                    const sop = allSOPs.find(s => parseInt(s.sop_id) === parseInt(sopId));
                                                                    const sopTitle = sop ? sop.title : `SOP #${sopId}`;
                                                                    return `
                                                                        <div style="font-size:12px;color:#065f46;">
                                                                            â€¢ ${sopTitle}
                                                                        </div>
                                                                    `;
                                                                }).join('')}
                                                            </div>
                                                        ` : ''}
                                                        ${task.attachment_id ? `
                                                            <div style="margin-top:6px;padding:6px 8px;background:#f0f9ff;border-radius:4px;border-left:2px solid #3b82f6;">
                                                                <div style="font-size:11px;color:#1e40af;">
                                                                    ğŸ“ é™„ä»¶ #${task.attachment_id}
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                    <div style="display:flex;gap:5px;margin-left:10px;">
                                                        <button class="table-btn-link" onclick="editTask(${templateId}, ${JSON.stringify(task).replace(/"/g, '&quot;')})">ç·¨è¼¯</button>
                                                        <button class="table-btn-link danger" onclick="deleteTask(${templateId}, ${task.stage_id})">åˆªé™¤</button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                listDiv.innerHTML = html;
            } catch (e) {
                listDiv.innerHTML = '<div style="color:#ef4444;padding:20px;text-align:center;">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        // æ˜¾ç¤ºæ–°å¢ä»»åŠ¡è¡¨å•
        let editingStageId = null;
        
        // è·å–æ¨¡æ¿çš„serviceId
        function getTemplateServiceId(templateId) {
            const templateCard = document.querySelector(`[data-template-id="${templateId}"]`);
            return templateCard ? parseInt(templateCard.getAttribute('data-service-id')) : null;
        }
        
        function showAddTask(templateId) {
            editingStageId = null;
            document.getElementById(`task-form-${templateId}`).classList.remove('hidden');
            document.getElementById(`task-name-${templateId}`).value = '';
            document.getElementById(`task-order-${templateId}`).value = '1';
            document.getElementById(`sop-search-${templateId}`).value = '';
            
            const serviceId = getTemplateServiceId(templateId);
            populateSOPAndAttachments(templateId, serviceId, []);
        }
        
        function editTask(templateId, task) {
            editingStageId = task.stage_id;
            const form = document.getElementById(`task-form-${templateId}`);
            form.classList.remove('hidden');
            
            document.getElementById(`task-name-${templateId}`).value = task.stage_name || '';
            document.getElementById(`task-order-${templateId}`).value = task.stage_order || 1;
            document.getElementById(`sop-search-${templateId}`).value = '';
            
            const serviceId = getTemplateServiceId(templateId);
            
            // å…¼å®¹æ—§çš„å•ä¸€SOPå­—æ®µå’Œæ–°çš„å¤šSOPå­—æ®µ
            let existingSOPIds = [];
            if (task.sop_ids && Array.isArray(task.sop_ids)) {
                existingSOPIds = task.sop_ids.map(id => parseInt(id));
            } else if (task.sop_id) {
                existingSOPIds = [parseInt(task.sop_id)];
            }
            
            populateSOPAndAttachments(templateId, serviceId, existingSOPIds);
            
            // è®¾ç½®é™„ä»¶çš„å€¼
            setTimeout(() => {
                const attachmentSelect = document.getElementById(`task-attachment-${templateId}`);
                if (attachmentSelect) attachmentSelect.value = task.attachment_id || '';
            }, 100);
            
            form.scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelTask(templateId) {
            editingStageId = null;
            document.getElementById(`task-form-${templateId}`).classList.add('hidden');
        }

        // ä¿å­˜ä»»åŠ¡ï¼ˆæ”¯æŒå¤šä¸ªSOPï¼‰
        async function saveTask(templateId) {
            const name = document.getElementById(`task-name-${templateId}`).value;
            const order = document.getElementById(`task-order-${templateId}`).value;
            const attachmentId = document.getElementById(`task-attachment-${templateId}`).value;
            
            if (!name) return alert('è«‹è¼¸å…¥ä»»å‹™åç¨±');
            
            // è·å–å·²é€‰æ‹©çš„SOP IDs
            const selectedSOPIds = templateTaskSelectedSOPs[templateId] || [];
            
            try {
                const url = editingStageId 
                    ? `/internal/api/v1/task-templates/${templateId}/stages/${editingStageId}`
                    : `/internal/api/v1/task-templates/${templateId}/stages`;
                const method = editingStageId ? 'PUT' : 'POST';
                
                const payload = {
                    stage_name: name,
                    stage_order: parseInt(order) || 1,
                    attachment_id: attachmentId ? parseInt(attachmentId) : null
                };
                
                // å…¼å®¹åç«¯ï¼šå¦‚æœæœ‰å¤šä¸ªSOPï¼Œä½¿ç”¨sop_idsæ•°ç»„ï¼›å¦‚æœåªæœ‰ä¸€ä¸ªï¼Œä½¿ç”¨sop_idå­—æ®µ
                if (selectedSOPIds.length > 1) {
                    payload.sop_ids = selectedSOPIds;
                } else if (selectedSOPIds.length === 1) {
                    payload.sop_id = selectedSOPIds[0];
                } else {
                    payload.sop_id = null;
                }
                
                console.log('[Save Task] Payload:', payload);
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'ä¿å­˜å¤±æ•—');
                }
                
                alert(editingStageId ? 'âœ… æ›´æ–°æˆåŠŸ' : 'âœ… æ–°å¢æˆåŠŸ');
                cancelTask(templateId);
                loadTasksForTemplate(templateId);
            } catch (e) {
                console.error('ä¿å­˜ä»»å‹™å¤±æ•—:', e);
                alert((editingStageId ? 'âŒ æ›´æ–°å¤±æ•—: ' : 'âŒ æ–°å¢å¤±æ•—: ') + e.message);
            }
        }

        // åˆ é™¤ä»»åŠ¡
        async function deleteTask(templateId, stageId) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ä»»å‹™ï¼Ÿ')) return;
            try {
                await fetch(`/internal/api/v1/task-templates/${templateId}/stages/${stageId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                loadTasksForTemplate(templateId);
            } catch (e) {
                alert('åˆªé™¤å¤±æ•—');
            }
        }

        // åˆ é™¤æ¨¡æ¿
        async function deleteTemplate(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨¡æ¿ï¼Ÿæ‰€æœ‰ä»»å‹™ä¹Ÿæœƒè¢«åˆªé™¤')) return;
            try {
                await fetch('/internal/api/v1/task-templates/' + id, { method: 'DELETE', credentials: 'include' });
                loadTemplates();
            } catch (e) {
                alert('åˆªé™¤å¤±æ•—');
            }
        }

        // å…¨å±€å˜é‡ï¼šè®°å½•å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ¨¡æ¿ID
        let editingTemplateId = null;

        // ç¼–è¾‘æ¨¡æ¿
        async function editTemplate(templateId) {
            editingTemplateId = templateId;
            
            // åŠ è½½æ¨¡æ¿æ•°æ®
            try {
                const res = await fetch(`/internal/api/v1/task-templates/${templateId}`, { credentials: 'include' });
                const json = await res.json();
                
                if (!json.ok || !json.data) {
                    throw new Error('è¼‰å…¥æ¨¡æ¿å¤±æ•—');
                }
                
                const template = json.data;
                
                // å…ˆåŠ è½½é€‰é¡¹
                await loadTemplateOptions();
                
                // å¡«å……è¡¨å•
                document.getElementById('newTemplateName').value = template.template_name || '';
                document.getElementById('newTemplateService').value = template.service_id || '';
                document.getElementById('newTemplateClient').value = template.client_id || '';
                document.getElementById('newTemplateDesc').value = template.description || '';
                
                // è§¦å‘æœåŠ¡å˜æ›´ï¼Œæ˜¾ç¤ºæœåŠ¡å±‚çº§SOP
                onTemplateServiceChange();
                
                // ä¿®æ”¹è¡¨å•æ ‡é¢˜
                document.querySelector('#addTemplateForm .card-header h3').textContent = 'ç·¨è¼¯ä»»å‹™æ¨¡æ¿';
                
                // æ˜¾ç¤ºè¡¨å•
                document.getElementById('addTemplateForm').classList.remove('hidden');
                document.getElementById('addTemplateForm').scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                console.error('è¼‰å…¥æ¨¡æ¿å¤±æ•—:', e);
                alert('è¼‰å…¥æ¨¡æ¿å¤±æ•—: ' + e.message);
            }
        }

        // ä¿å­˜æ¨¡æ¿ï¼ˆæ–°å¢æˆ–ç¼–è¾‘ï¼‰
        async function saveTemplate() {
            const name = document.getElementById('newTemplateName').value;
            const serviceId = document.getElementById('newTemplateService').value;
            const clientId = document.getElementById('newTemplateClient').value;
            const desc = document.getElementById('newTemplateDesc').value;
            
            if (!name || !serviceId) return alert('è«‹è¼¸å…¥æ¨¡æ¿åç¨±ä¸¦é¸æ“‡æœå‹™é …ç›®');
            
            try {
                const url = editingTemplateId 
                    ? `/internal/api/v1/task-templates/${editingTemplateId}`
                    : '/internal/api/v1/task-templates';
                const method = editingTemplateId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        template_name: name,
                        service_id: parseInt(serviceId),
                        client_id: clientId ? parseInt(clientId) : null,
                        description: desc
                    })
                });
                
                if (!res.ok) throw new Error();
                
                alert(editingTemplateId ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
                cancelTemplate();
                loadTemplates();
            } catch (e) {
                alert(editingTemplateId ? 'æ›´æ–°å¤±æ•—' : 'æ–°å¢å¤±æ•—');
            }
        }

        function cancelTemplate() {
            editingTemplateId = null;
            document.getElementById('addTemplateForm').classList.add('hidden');
            document.getElementById('newTemplateName').value = '';
            document.getElementById('newTemplateService').value = '';
            document.getElementById('newTemplateClient').value = '';
            document.getElementById('newTemplateDesc').value = '';
            document.getElementById('serviceSOPDisplay').style.display = 'none';
            // æ¢å¤è¡¨å•æ ‡é¢˜
            document.querySelector('#addTemplateForm .card-header h3').textContent = 'æ–°å¢ä»»å‹™æ¨¡æ¿';
        }

        // ç”¨æˆ·ç®¡ç†
        async function loadUsers() {
            const tbody = document.querySelector('#usersTable tbody');
            try {
                const res = await fetch('/internal/api/v1/users', { credentials: 'include' });
                const json = await res.json();
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                tbody.innerHTML = json.data.map(u => `
                    <tr>
                        <td>${u.user_id}</td>
                        <td>${u.name}</td>
                        <td>${u.username}</td>
                        <td>${u.is_admin ? 'ç®¡ç†å“¡' : 'å“¡å·¥'}</td>
                        <td><span class="status-badge status-active">å•Ÿç”¨</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="window.location.href='/internal/profile?user_id=${u.user_id}'">æª¢è¦–</button>
                            <button class="btn btn-sm btn-primary" onclick="editUser(${JSON.stringify(u).replace(/"/g, '&quot;')})">ç·¨è¼¯</button>
                            <button class="btn btn-sm btn-warning" onclick="resetUserPassword(${u.user_id}, '${u.name}')">é‡ç½®å¯†ç¢¼</button>
                            ${u.user_id !== 1 ? `<button class="btn btn-sm btn-danger" onclick="deleteUser(${u.user_id}, '${u.name}')">åˆªé™¤</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }
        
        function showAddUserForm() {
            document.getElementById('edit_user_id').value = '';
            document.getElementById('userFormTitle').textContent = 'æ–°å¢ç”¨æˆ¶';
            document.getElementById('user_name').value = '';
            document.getElementById('user_username').value = '';
            document.getElementById('user_password').value = '';
            document.getElementById('user_is_admin').value = '0';
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('userForm').classList.remove('hidden');
        }
        
        function editUser(user) {
            document.getElementById('edit_user_id').value = user.user_id;
            document.getElementById('userFormTitle').textContent = 'ç·¨è¼¯ç”¨æˆ¶';
            document.getElementById('user_name').value = user.name || '';
            document.getElementById('user_username').value = user.username || '';
            document.getElementById('user_is_admin').value = user.is_admin ? '1' : '0';
            document.getElementById('passwordGroup').style.display = 'none';
            document.getElementById('userForm').classList.remove('hidden');
            document.getElementById('userForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelUserForm() {
            document.getElementById('userForm').classList.add('hidden');
        }
        
        async function saveUser() {
            const userId = document.getElementById('edit_user_id').value;
            const name = document.getElementById('user_name').value.trim();
            const username = document.getElementById('user_username').value.trim();
            const password = document.getElementById('user_password').value;
            const isAdmin = document.getElementById('user_is_admin').value === '1';
            
            if (!name || !username) {
                alert('è«‹å¡«å¯«å§“åå’Œå¸³è™Ÿ');
                return;
            }
            
            if (!userId && (!password || password.length < 6)) {
                alert('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ');
                return;
            }
            
            try {
                const payload = {
                    name: name,
                    username: username,
                    is_admin: isAdmin
                };
                
                if (!userId) {
                    // æ–°å¢ç”¨æˆ·
                    payload.password = password;
                }
                
                const url = userId 
                    ? `/internal/api/v1/admin/users/${userId}`
                    : '/internal/api/v1/admin/users';
                const method = userId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'æ“ä½œå¤±æ•—');
                }
                
                alert(userId ? 'âœ… æ›´æ–°æˆåŠŸï¼' : 'âœ… æ–°å¢æˆåŠŸï¼');
                cancelUserForm();
                loadUsers();
            } catch (e) {
                console.error('å„²å­˜ç”¨æˆ¶å¤±æ•—:', e);
                alert('âŒ å„²å­˜å¤±æ•—: ' + e.message);
            }
        }
        
        async function deleteUser(userId, userName) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç”¨æˆ¶ã€Œ${userName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                return;
            }
            
            try {
                const res = await fetch(`/internal/api/v1/admin/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'åˆªé™¤å¤±æ•—');
                }
                
                alert('âœ… åˆªé™¤æˆåŠŸï¼');
                loadUsers();
            } catch (e) {
                console.error('åˆªé™¤ç”¨æˆ¶å¤±æ•—:', e);
                alert('âŒ åˆªé™¤å¤±æ•—: ' + e.message);
            }
        }
        
        async function resetUserPassword(userId, userName) {
            const newPassword = prompt(`è«‹è¼¸å…¥ ${userName} çš„æ–°å¯†ç¢¼ï¼š`);
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                alert('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦å°‡ ${userName} çš„å¯†ç¢¼é‡ç½®ç‚ºæ–°å¯†ç¢¼å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const res = await fetch(`/internal/api/v1/admin/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ new_password: newPassword })
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'é‡ç½®å¤±æ•—');
                }
                
                alert(`âœ… å¯†ç¢¼é‡ç½®æˆåŠŸï¼\nç”¨æˆ¶ï¼š${userName}\nè«‹é€šçŸ¥è©²ç”¨æˆ¶ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥ã€‚`);
            } catch (e) {
                console.error('é‡ç½®å¯†ç¢¼å¤±æ•—:', e);
                alert('âŒ é‡ç½®å¯†ç¢¼å¤±æ•—: ' + e.message);
            }
        }

        // å…¬å¸è³‡è¨Šç®¡ç†
        function switchCompanyTab(setNumber) {
            document.getElementById('current_company_set').value = setNumber;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.getElementById('companyTab1').classList.toggle('active', setNumber === 1);
            document.getElementById('companyTab2').classList.toggle('active', setNumber === 2);
            
            // åŠ è½½å¯¹åº”çš„å…¬å¸èµ„æ–™
            loadCompanyInfo();
        }
        
        async function loadCompanyInfo() {
            const setNumber = document.getElementById('current_company_set').value;
            const category = `company${setNumber}`;
            
            try {
                const res = await fetch(`/internal/api/v1/settings?category=${category}`, { credentials: 'include' });
                const json = await res.json();
                
                // æ¸…ç©ºæ‰€æœ‰å­—æ®µ
                document.getElementById('company_name').value = '';
                document.getElementById('company_name_en').value = '';
                document.getElementById('company_tax_id').value = '';
                document.getElementById('company_address').value = '';
                document.getElementById('company_address_line2').value = '';
                document.getElementById('company_phone').value = '';
                document.getElementById('company_bank').value = '';
                document.getElementById('company_bank_code').value = '';
                document.getElementById('company_account_number').value = '';
                
                if (json.ok && json.data) {
                    json.data.forEach(setting => {
                        // ç§»é™¤å‰ç¼€æ¥åŒ¹é…è¡¨å•å­—æ®µ
                        const key = setting.settingKey.replace(`${category}_`, '');
                        const input = document.getElementById(`company_${key}`);
                        if (input) {
                            input.value = setting.settingValue || '';
                        }
                    });
                }
            } catch (e) {
                console.error('è¼‰å…¥å…¬å¸è³‡è¨Šå¤±æ•—:', e);
            }
        }
        
        async function saveCompanyInfo() {
            const setNumber = document.getElementById('current_company_set').value;
            const category = `company${setNumber}`;
            
            // ä½¿ç”¨categoryä½œä¸ºå‰ç¼€æ¥ç¡®ä¿setting_keyçš„å”¯ä¸€æ€§
            const settings = [
                { settingKey: `${category}_name`, settingValue: document.getElementById('company_name').value },
                { settingKey: `${category}_name_en`, settingValue: document.getElementById('company_name_en').value },
                { settingKey: `${category}_tax_id`, settingValue: document.getElementById('company_tax_id').value },
                { settingKey: `${category}_address`, settingValue: document.getElementById('company_address').value },
                { settingKey: `${category}_address_line2`, settingValue: document.getElementById('company_address_line2').value },
                { settingKey: `${category}_phone`, settingValue: document.getElementById('company_phone').value },
                { settingKey: `${category}_bank`, settingValue: document.getElementById('company_bank').value },
                { settingKey: `${category}_bank_code`, settingValue: document.getElementById('company_bank_code').value },
                { settingKey: `${category}_account_number`, settingValue: document.getElementById('company_account_number').value }
            ];
            
            if (!settings[0].settingValue) {
                alert('å…¬å¸ä¸­æ–‡åç¨±ç‚ºå¿…å¡«é …');
                return;
            }
            
            try {
                const res = await fetch('/internal/api/v1/settings/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        category: category,
                        settings: settings
                    })
                });
                
                // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await res.text();
                    console.error('éJSONéŸ¿æ‡‰:', text);
                    throw new Error('æœå‹™å™¨è¿”å›äº†éJSONéŸ¿æ‡‰ï¼Œè«‹æª¢æŸ¥å¾Œç«¯é…ç½®');
                }
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'å„²å­˜å¤±æ•—');
                }
                
                alert(`âœ… å…¬å¸è³‡æ–™ ${setNumber} å„²å­˜æˆåŠŸï¼`);
            } catch (e) {
                console.error('å„²å­˜å…¬å¸è³‡è¨Šå¤±æ•—:', e);
                alert('âŒ å„²å­˜å¤±æ•—: ' + e.message);
            }
        }

        // è‡ªåŠ¨åŒ–è§„åˆ™ç®¡ç†
        let editingRuleId = null;
        
        // é¡¯ç¤ºæ–°å¢è¡¨å–®
        function showAddAutomationForm() {
            editingRuleId = null;
            document.getElementById('automationFormTitle').textContent = 'æ–°å¢è‡ªå‹•åŒ–è¦å‰‡';
            document.getElementById('edit_rule_id').value = '';
            document.getElementById('rule_name').value = '';
            document.getElementById('schedule_type').value = '';
            document.getElementById('action_type').value = '';
            document.getElementById('action_params').value = '';
            document.getElementById('condition_params').value = '';
            document.getElementById('is_enabled').checked = true;
            
            // éš±è—æ‰€æœ‰æ’ç¨‹é¸é …
            document.getElementById('daily_schedule').classList.add('hidden');
            document.getElementById('weekly_schedule').classList.add('hidden');
            document.getElementById('monthly_schedule').classList.add('hidden');
            document.getElementById('cron_schedule').classList.add('hidden');
            
            document.getElementById('automationForm').classList.remove('hidden');
            document.getElementById('automationForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        // æ’ç¨‹é¡å‹è®Šæ›´
        function onScheduleTypeChange() {
            const type = document.getElementById('schedule_type').value;
            
            // éš±è—æ‰€æœ‰æ’ç¨‹é¸é …
            document.getElementById('daily_schedule').classList.add('hidden');
            document.getElementById('weekly_schedule').classList.add('hidden');
            document.getElementById('monthly_schedule').classList.add('hidden');
            document.getElementById('cron_schedule').classList.add('hidden');
            
            // é¡¯ç¤ºå°æ‡‰çš„æ’ç¨‹é¸é …
            if (type === 'daily') {
                document.getElementById('daily_schedule').classList.remove('hidden');
            } else if (type === 'weekly') {
                document.getElementById('weekly_schedule').classList.remove('hidden');
            } else if (type === 'monthly') {
                document.getElementById('monthly_schedule').classList.remove('hidden');
            } else if (type === 'cron') {
                document.getElementById('cron_schedule').classList.remove('hidden');
            }
        }
        
        // ç·¨è¼¯è¦å‰‡
        async function editAutomationRule(ruleId) {
            try {
                const res = await fetch(`/internal/api/v1/admin/automation-rules/${ruleId}`, { credentials: 'include' });
                const json = await res.json();
                
                if (!json.ok || !json.data) {
                    throw new Error('è¼‰å…¥è¦å‰‡å¤±æ•—');
                }
                
                const rule = json.data;
                editingRuleId = ruleId;
                
                document.getElementById('automationFormTitle').textContent = 'ç·¨è¼¯è‡ªå‹•åŒ–è¦å‰‡';
                document.getElementById('edit_rule_id').value = ruleId;
                document.getElementById('rule_name').value = rule.name || '';
                document.getElementById('schedule_type').value = rule.scheduleType || '';
                
                // è§£æaction
                let actionData = {};
                try {
                    actionData = typeof rule.action === 'string' ? JSON.parse(rule.action) : rule.action;
                } catch (e) {}
                document.getElementById('action_type').value = actionData.type || '';
                document.getElementById('action_params').value = actionData.params ? JSON.stringify(actionData.params, null, 2) : '';
                
                // è§£æcondition
                let conditionData = {};
                try {
                    conditionData = typeof rule.condition === 'string' ? JSON.parse(rule.condition) : rule.condition;
                } catch (e) {}
                document.getElementById('condition_params').value = Object.keys(conditionData).length ? JSON.stringify(conditionData, null, 2) : '';
                
                document.getElementById('is_enabled').checked = rule.isEnabled;
                
                // é¡¯ç¤ºå°æ‡‰çš„æ’ç¨‹é¸é …ä¸¦è¨­ç½®å€¼
                onScheduleTypeChange();
                
                if (rule.scheduleType === 'daily') {
                    document.getElementById('daily_time').value = rule.scheduleValue || '00:00';
                } else if (rule.scheduleType === 'weekly') {
                    const parts = (rule.scheduleValue || 'Mon 00:00').split(' ');
                    document.getElementById('weekly_day').value = parts[0] || 'Mon';
                    document.getElementById('weekly_time').value = parts[1] || '00:00';
                } else if (rule.scheduleType === 'monthly') {
                    const parts = (rule.scheduleValue || '1 00:00').split(' ');
                    document.getElementById('monthly_day').value = parts[0] || '1';
                    document.getElementById('monthly_time').value = parts[1] || '00:00';
                } else if (rule.scheduleType === 'cron') {
                    document.getElementById('cron_expression').value = rule.scheduleValue || '';
                }
                
                document.getElementById('automationForm').classList.remove('hidden');
                document.getElementById('automationForm').scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                console.error('è¼‰å…¥è¦å‰‡å¤±æ•—:', e);
                alert('è¼‰å…¥è¦å‰‡å¤±æ•—: ' + e.message);
            }
        }
        
        // å–æ¶ˆè¡¨å–®
        function cancelAutomationForm() {
            editingRuleId = null;
            document.getElementById('automationForm').classList.add('hidden');
        }
        
        // å„²å­˜è¦å‰‡
        async function saveAutomationRule() {
            const ruleName = document.getElementById('rule_name').value.trim();
            const scheduleType = document.getElementById('schedule_type').value;
            const actionType = document.getElementById('action_type').value;
            const actionParamsText = document.getElementById('action_params').value.trim();
            const conditionParamsText = document.getElementById('condition_params').value.trim();
            const isEnabled = document.getElementById('is_enabled').checked;
            
            if (!ruleName) {
                alert('è«‹è¼¸å…¥è¦å‰‡åç¨±');
                return;
            }
            
            if (!scheduleType) {
                alert('è«‹é¸æ“‡æ’ç¨‹é¡å‹');
                return;
            }
            
            if (!actionType) {
                alert('è«‹é¸æ“‡åŸ·è¡Œå‹•ä½œ');
                return;
            }
            
            // ç²å–æ’ç¨‹å€¼
            let scheduleValue = '';
            if (scheduleType === 'daily') {
                scheduleValue = document.getElementById('daily_time').value;
            } else if (scheduleType === 'weekly') {
                const day = document.getElementById('weekly_day').value;
                const time = document.getElementById('weekly_time').value;
                scheduleValue = `${day} ${time}`;
            } else if (scheduleType === 'monthly') {
                const day = document.getElementById('monthly_day').value;
                const time = document.getElementById('monthly_time').value;
                scheduleValue = `${day} ${time}`;
            } else if (scheduleType === 'cron') {
                scheduleValue = document.getElementById('cron_expression').value.trim();
                if (!scheduleValue) {
                    alert('è«‹è¼¸å…¥ Cron è¡¨é”å¼');
                    return;
                }
            }
            
            // è§£æå‹•ä½œåƒæ•¸
            let actionParams = {};
            if (actionParamsText) {
                try {
                    actionParams = JSON.parse(actionParamsText);
                } catch (e) {
                    alert('å‹•ä½œåƒæ•¸æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨æœ‰æ•ˆçš„ JSON æ ¼å¼');
                    return;
                }
            }
            
            // è§£ææ¢ä»¶åƒæ•¸
            let conditionParams = {};
            if (conditionParamsText) {
                try {
                    conditionParams = JSON.parse(conditionParamsText);
                } catch (e) {
                    alert('æ¢ä»¶åƒæ•¸æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨æœ‰æ•ˆçš„ JSON æ ¼å¼');
                    return;
                }
            }
            
            // æ§‹å»ºè«‹æ±‚æ•¸æ“š
            const payload = {
                rule_name: ruleName,
                schedule_type: scheduleType,
                schedule_value: scheduleValue,
                action_json: {
                    type: actionType,
                    params: actionParams
                },
                condition_json: conditionParams,
                is_enabled: isEnabled ? 1 : 0
            };
            
            try {
                const url = editingRuleId 
                    ? `/internal/api/v1/admin/automation-rules/${editingRuleId}`
                    : '/internal/api/v1/admin/automation-rules';
                const method = editingRuleId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'å„²å­˜å¤±æ•—');
                }
                
                alert(editingRuleId ? 'âœ… è¦å‰‡æ›´æ–°æˆåŠŸï¼' : 'âœ… è¦å‰‡æ–°å¢æˆåŠŸï¼');
                cancelAutomationForm();
                loadAutomation();
            } catch (e) {
                console.error('å„²å­˜è¦å‰‡å¤±æ•—:', e);
                alert('âŒ å„²å­˜å¤±æ•—: ' + e.message);
            }
        }
        
        // è¼‰å…¥è‡ªå‹•åŒ–è¦å‰‡åˆ—è¡¨
        async function loadAutomation() {
            const tbody = document.querySelector('#automationTable tbody');
            try {
                const res = await fetch('/internal/api/v1/admin/automation-rules', { credentials: 'include' });
                const json = await res.json();
                
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                
                // æ’ç¨‹é¡å‹ç¿»è­¯
                const scheduleTypeText = {
                    'daily': 'æ¯æ—¥',
                    'weekly': 'æ¯é€±',
                    'monthly': 'æ¯æœˆ',
                    'cron': 'Cron'
                };
                
                tbody.innerHTML = json.data.map(r => {
                    const statusBadge = r.isEnabled 
                        ? '<span class="status-badge status-active">å•Ÿç”¨</span>'
                        : '<span class="status-badge status-inactive">åœç”¨</span>';
                    
                    const lastRunText = r.lastRunAt 
                        ? new Date(r.lastRunAt).toLocaleString('zh-TW')
                        : 'æœªåŸ·è¡Œ';
                    
                    return `
                        <tr>
                            <td style="font-weight:600;">${r.name}</td>
                            <td>${scheduleTypeText[r.scheduleType] || r.scheduleType}</td>
                            <td>${r.scheduleValue || '-'}</td>
                            <td>${lastRunText}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="editAutomationRule(${r.id})">ç·¨è¼¯</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteAutomationRule(${r.id})">åˆªé™¤</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('è¼‰å…¥è‡ªå‹•åŒ–è¦å‰‡å¤±æ•—:', e);
                tbody.innerHTML = '<tr><td colspan="6" class="loading">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }
        
        // åˆªé™¤è¦å‰‡
        async function deleteAutomationRule(ruleId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è‡ªå‹•åŒ–è¦å‰‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                return;
            }
            
            try {
                const res = await fetch(`/internal/api/v1/admin/automation-rules/${ruleId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'åˆªé™¤å¤±æ•—');
                }
                
                alert('âœ… è¦å‰‡å·²åˆªé™¤ï¼');
                loadAutomation();
            } catch (e) {
                console.error('åˆªé™¤è¦å‰‡å¤±æ•—:', e);
                alert('âŒ åˆªé™¤å¤±æ•—: ' + e.message);
            }
        }

        // å›½å®šå‡æ—¥
        let editingHolidayDate = null; // ç”¨æ–¼è¨˜éŒ„æ­£åœ¨ç·¨è¼¯çš„å‡æ—¥æ—¥æœŸ
        
        async function loadHolidays() {
            const tbody = document.querySelector('#holidaysTable tbody');
            try {
                const res = await fetch(`/internal/api/v1/holidays`, { credentials: 'include' });
                const json = await res.json();
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                tbody.innerHTML = json.data.map(h => {
                    return `
                        <tr>
                            <td>${h.holiday_date}</td>
                            <td>${h.name || 'æœªå‘½å'}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick='editHoliday(${JSON.stringify(h)})'>ç·¨è¼¯</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteHoliday('${h.holiday_date}')">åˆªé™¤</button>
                            </td>
                        </tr>
                    `;
                }).join('');
          } catch (e) {
                console.error('è¼‰å…¥å‡æ—¥å¤±æ•—:', e);
                tbody.innerHTML = '<tr><td colspan="3" class="loading">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }
        
        function showAddHolidayForm() {
            editingHolidayDate = null;
            document.getElementById('holidayFormTitle').textContent = 'æ–°å¢åœ‹å®šå‡æ—¥';
            document.getElementById('holiday_date').value = '';
            document.getElementById('holiday_date').disabled = false;
            document.getElementById('holiday_name').value = '';
            document.getElementById('holidayForm').classList.remove('hidden');
        }
        
        function editHoliday(holiday) {
            editingHolidayDate = holiday.holiday_date;
            document.getElementById('holidayFormTitle').textContent = 'ç·¨è¼¯åœ‹å®šå‡æ—¥';
            document.getElementById('holiday_date').value = holiday.holiday_date;
            document.getElementById('holiday_date').disabled = true; // ç·¨è¼¯æ™‚ä¸èƒ½ä¿®æ”¹æ—¥æœŸï¼ˆä¸»éµï¼‰
            document.getElementById('holiday_name').value = holiday.name || '';
            
            document.getElementById('holidayForm').classList.remove('hidden');
            document.getElementById('holidayForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelHolidayForm() {
            document.getElementById('holidayForm').classList.add('hidden');
            editingHolidayDate = null;
        }
        
        async function saveHoliday() {
            const date = document.getElementById('holiday_date').value;
            const name = document.getElementById('holiday_name').value;
            
            if (!date || !name) {
                alert('è«‹å¡«å¯«æ—¥æœŸå’Œåç¨±');
                return;
            }
            
            const holidayData = {
                holiday_date: date,
                name: name,
                is_national_holiday: true,
                is_weekly_restday: false,
                is_makeup_workday: false
            };
            
            try {
                const method = editingHolidayDate ? 'PUT' : 'POST';
                const res = await fetch('/internal/api/v1/holidays', {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(holidayData)
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'æ“ä½œå¤±æ•—');
                }
                
                alert(editingHolidayDate ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
                cancelHolidayForm();
                loadHolidays();
            } catch (e) {
                console.error('å„²å­˜å‡æ—¥å¤±æ•—:', e);
                alert('å„²å­˜å¤±æ•—: ' + e.message);
            }
        }
        
        async function deleteHoliday(date) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${date} çš„å‡æ—¥å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const res = await fetch(`/internal/api/v1/holidays?holiday_date=${date}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'åˆªé™¤å¤±æ•—');
                }
                
                alert('åˆªé™¤æˆåŠŸ');
                loadHolidays();
            } catch (e) {
                console.error('åˆªé™¤å‡æ—¥å¤±æ•—:', e);
                alert('åˆªé™¤å¤±æ•—: ' + e.message);
            }
        }
        
        // æ‰¹é‡ä¸Šå‚³åŠŸèƒ½
        function showBatchUploadForm() {
            document.getElementById('batchUploadForm').classList.remove('hidden');
            document.getElementById('batchUploadForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelBatchUpload() {
            document.getElementById('batchUploadForm').classList.add('hidden');
            document.getElementById('csvFile').value = '';
            document.getElementById('csvText').value = '';
        }
        
        function toggleUploadMethod() {
            const method = document.querySelector('input[name="uploadMethod"]:checked').value;
            if (method === 'csv') {
                document.getElementById('csvUploadArea').style.display = 'block';
                document.getElementById('textUploadArea').style.display = 'none';
            } else {
                document.getElementById('csvUploadArea').style.display = 'none';
                document.getElementById('textUploadArea').style.display = 'block';
            }
        }
        
        function parseCSVLine(line) {
            const parts = line.split(',').map(p => p.trim());
            if (parts.length < 2) return null;
            
            const [date, name] = parts;
            if (!date || !name) return null;
            
            return {
                holiday_date: date,
                name: name,
                is_national_holiday: true,
                is_weekly_restday: false,
                is_makeup_workday: false
            };
        }
        
        function downloadSampleCSV() {
            const sampleData = `æ—¥æœŸ,åç¨±
2025-01-01,å…ƒæ—¦
2025-02-28,å’Œå¹³ç´€å¿µæ—¥
2025-04-04,å…’ç«¥ç¯€
2025-04-05,æ¸…æ˜ç¯€
2025-05-01,å‹å‹•ç¯€
2025-06-10,ç«¯åˆç¯€
2025-09-17,ä¸­ç§‹ç¯€
2025-10-10,åœ‹æ…¶æ—¥`;
            
            const blob = new Blob(['\uFEFF' + sampleData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'åœ‹å®šå‡æ—¥ç¯„ä¾‹.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function processBatchUpload() {
            const method = document.querySelector('input[name="uploadMethod"]:checked').value;
            let csvContent = '';
            
            if (method === 'csv') {
                const fileInput = document.getElementById('csvFile');
                if (!fileInput.files || !fileInput.files[0]) {
                    alert('è«‹é¸æ“‡ CSV æª”æ¡ˆ');
                    return;
                }
                
                try {
                    csvContent = await fileInput.files[0].text();
                } catch (e) {
                    alert('è®€å–æª”æ¡ˆå¤±æ•—');
                    return;
                }
            } else {
                csvContent = document.getElementById('csvText').value;
            }
            
            if (!csvContent.trim()) {
                alert('è«‹è¼¸å…¥å…§å®¹');
                return;
            }
            
            // è§£æ CSV
            const lines = csvContent.split('\n').filter(line => line.trim());
            const holidays = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // è·³éæ¨™é¡Œè¡Œï¼ˆå¦‚æœæœ‰ï¼‰
                if (i === 0 && (line.includes('æ—¥æœŸ') || line.includes('date'))) {
                    continue;
                }
                
                const holiday = parseCSVLine(line);
                if (holiday) {
                    holidays.push(holiday);
                }
            }
            
            if (holidays.length === 0) {
                alert('æ²’æœ‰æœ‰æ•ˆçš„å‡æ—¥è³‡æ–™');
                return;
            }
            
            if (!confirm(`å³å°‡ä¸Šå‚³ ${holidays.length} ç­†å‡æ—¥è³‡æ–™ï¼Œç¢ºå®šç¹¼çºŒï¼Ÿ`)) {
                return;
            }
            
            try {
                const res = await fetch('/internal/api/v1/holidays', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(holidays)
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'ä¸Šå‚³å¤±æ•—');
                }
                
                let message = json.message || 'ä¸Šå‚³æˆåŠŸ';
                if (json.data && json.data.errors && json.data.errors.length > 0) {
                    message += '\n\néƒ¨åˆ†éŒ¯èª¤ï¼š\n' + json.data.errors.join('\n');
                }
                
                alert(message);
                cancelBatchUpload();
                loadHolidays();
            } catch (e) {
                console.error('æ‰¹é‡ä¸Šå‚³å¤±æ•—:', e);
                alert('æ‰¹é‡ä¸Šå‚³å¤±æ•—: ' + e.message);
            }
        }

        // ç™»å‡º
        async function logout() {
            if (!confirm('ç¢ºå®šç™»å‡ºï¼Ÿ')) return;
            await fetch('/internal/api/v1/auth/logout', { method: 'POST', credentials: 'include' });
            window.location.href = '/login.html';
        }

        // Tab åˆ‡æ¢åŠŸèƒ½
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰ active class
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            
            // æ·»åŠ  active class
            const targetBtn = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
            const targetPanel = document.getElementById(`tab-${tabName}`);
            
            if (targetBtn) targetBtn.classList.add('active');
            if (targetPanel) targetPanel.classList.add('active');
            
            // æ ¹æ®tabåŠ è½½å¯¹åº”æ•°æ®
            switch(tabName) {
                case 'services':
                    loadServices();
                    break;
                case 'templates':
                    loadTemplates();
                    loadTemplateOptions();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'company':
                    loadCompanyInfo();
                    break;
                case 'automation':
                    loadAutomation();
                    break;
                case 'holidays':
                    loadHolidays();
                    break;
            }
        }
        
        // ç»‘å®šæ‰€æœ‰tabæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        // åˆå§‹åŒ–
        (async () => {
            const res = await fetch('/internal/api/v1/auth/me', { credentials: 'include' });
            if (!res.ok) {
                document.getElementById('permBar').style.display = 'block';
                return;
            }
            // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªtabçš„æ•°æ®
            switchTab('services');
        })();
    </script>
  </body>
  </html>
