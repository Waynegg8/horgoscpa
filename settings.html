<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="系統設定（管理員）" />
    <title>系統設定｜管理員</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/settings-page.css" />
  </head>
  <body class="internal-container">
    <header class="settings-header">
      <h1 class="settings-title">系統設定</h1>
      <div id="permBar" class="info-bar" style="display:none;" role="alert">您沒有權限檢視此頁面</div>
      <div id="msgBar" class="info-bar" style="display:none;" role="status"></div>
    </header>

    <main class="settings-content">
      <section class="card" aria-labelledby="danger-title">
        <div class="card-header">
          <h2 id="danger-title">危險設定</h2>
          <div class="subtitle">變更前請確認風險，非管理員不可操作</div>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="rule_comp_hours_expiry">補休有效期規則</label>
            <select id="rule_comp_hours_expiry" disabled>
              <option value="current_month">當月到期</option>
              <option value="next_month">次月到期</option>
              <option value="3_months">3 個月</option>
              <option value="6_months">6 個月</option>
            </select>
          </div>
          <div class="form-group">
            <label>每日工時上限（唯讀）</label>
            <input type="text" value="12" readonly />
          </div>
          <div class="form-group">
            <label>月薪制換算時數（唯讀）</label>
            <input type="text" value="240" readonly />
          </div>
          <div>
            <button id="btnSaveDanger" class="btn btn-danger" type="button" disabled>儲存危險設定</button>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="payroll-title" style="margin-top:20px;">
        <div class="card-header">
          <h2 id="payroll-title">薪資相關參數</h2>
          <div class="subtitle">全勤獎金與薪資計算相關設定</div>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="attendance_bonus_amount">全勤獎金金額（元）</label>
            <input id="attendance_bonus_amount" type="number" min="0" step="1" placeholder="1000" disabled />
          </div>
          <div>
            <button id="btnSavePayroll" class="btn btn-primary" type="button" disabled>儲存薪資參數</button>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="cost-title" style="margin-top:20px;">
        <div class="card-header">
          <h2 id="cost-title">成本分析參數</h2>
          <div class="subtitle">管理成本與盈利目標設定</div>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="overhead_cost_per_hour">每小時管理成本（元/小時）</label>
            <input id="overhead_cost_per_hour" type="number" min="0" step="0.01" placeholder="100" disabled />
          </div>
          <div class="form-group">
            <label for="target_profit_margin">目標毛利率（%）</label>
            <input id="target_profit_margin" type="number" min="0" max="100" step="0.1" placeholder="50" disabled />
          </div>
          <div>
            <button id="btnSaveCost" class="btn btn-primary" type="button" disabled>儲存成本參數</button>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="general-title" style="margin-top:20px;">
        <div class="card-header">
          <h2 id="general-title">一般設定</h2>
          <div class="subtitle">公司資訊等一般參數</div>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="company_name">公司名稱</label>
            <input id="company_name" type="text" placeholder="範例：霍爾果斯會計師事務所" disabled />
          </div>
          <div class="form-group">
            <label for="contact_email">聯絡信箱</label>
            <input id="contact_email" type="email" placeholder="contact@horgoscpa.com" disabled />
          </div>
          <div class="form-group">
            <label for="timezone">系統時區</label>
            <input id="timezone" type="text" placeholder="Asia/Taipei" disabled />
          </div>
          <div class="form-group">
            <label for="currency">幣別</label>
            <input id="currency" type="text" placeholder="TWD" disabled />
          </div>
          <div class="form-group">
            <label for="timesheet_min_unit">工時最小單位（小時）</label>
            <select id="timesheet_min_unit" disabled>
              <option value="0.25">0.25</option>
              <option value="0.5">0.5</option>
              <option value="1">1</option>
            </select>
          </div>
          <div class="form-group">
            <label for="soft_delete_enabled">啟用軟刪除</label>
            <select id="soft_delete_enabled" disabled>
              <option value="1">啟用</option>
              <option value="0">停用</option>
            </select>
          </div>
          <div class="form-group">
            <label for="workday_start">工作日開始時間</label>
            <input id="workday_start" type="time" disabled />
          </div>
          <div class="form-group">
            <label for="workday_end">工作日結束時間</label>
            <input id="workday_end" type="time" disabled />
          </div>
          <div class="form-group">
            <label for="report_locale">報表語系</label>
            <input id="report_locale" type="text" placeholder="zh-TW" disabled />
          </div>
          <div>
            <button id="btnSaveGeneral" class="btn btn-primary" type="button" disabled>儲存一般設定</button>
          </div>
        </div>
      </section>
    </main>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const permBar = document.getElementById('permBar');
        const dangerControls = [
          document.getElementById('rule_comp_hours_expiry'),
          document.getElementById('btnSaveDanger'),
        ];
        const payrollControls = [
          document.getElementById('attendance_bonus_amount'),
          document.getElementById('btnSavePayroll'),
        ];
        const costControls = [
          document.getElementById('overhead_cost_per_hour'),
          document.getElementById('target_profit_margin'),
          document.getElementById('btnSaveCost'),
        ];
        const generalControls = [
          document.getElementById('company_name'),
          document.getElementById('contact_email'),
          document.getElementById('btnSaveGeneral'),
        ];

        function setControlsEnabled(arr, enabled){
          arr.forEach(el => { if (el) { el.disabled = !enabled; } });
        }

        function setMsg(text, isOk){
          const bar = document.getElementById('msgBar');
          if (!bar) return;
          if (!text){ bar.style.display='none'; bar.textContent=''; return; }
          bar.textContent = text;
          bar.style.display = 'block';
          bar.style.color = isOk ? '#1b5e20' : '#c0392b';
        }

        async function loadSettings(){
          try {
            const res = await fetch(`${apiBase}/admin/settings`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/settings'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const map = json.data?.map || {};
            const company = document.getElementById('company_name');
            const email = document.getElementById('contact_email');
            const rule = document.getElementById('rule_comp_hours_expiry');
            const tz = document.getElementById('timezone');
            const cur = document.getElementById('currency');
            const unit = document.getElementById('timesheet_min_unit');
            const soft = document.getElementById('soft_delete_enabled');
            const wdStart = document.getElementById('workday_start');
            const wdEnd = document.getElementById('workday_end');
            const repLoc = document.getElementById('report_locale');
            const attendBonus = document.getElementById('attendance_bonus_amount');
            const overheadCost = document.getElementById('overhead_cost_per_hour');
            const targetMargin = document.getElementById('target_profit_margin');
            if (company) company.value = map.company_name || '';
            if (email) email.value = map.contact_email || '';
            if (rule && map.rule_comp_hours_expiry) rule.value = map.rule_comp_hours_expiry;
            if (tz) tz.value = map.timezone || 'Asia/Taipei';
            if (cur) cur.value = map.currency || 'TWD';
            if (unit && map.timesheet_min_unit) unit.value = String(map.timesheet_min_unit);
            if (soft && map.soft_delete_enabled) soft.value = String(map.soft_delete_enabled);
            if (wdStart) wdStart.value = (map.workday_start||'08:30');
            if (wdEnd) wdEnd.value = (map.workday_end||'17:30');
            if (repLoc) repLoc.value = map.report_locale || 'zh-TW';
            if (attendBonus) attendBonus.value = map.attendance_bonus_amount || '1000';
            if (overheadCost) overheadCost.value = map.overhead_cost_per_hour || '100';
            if (targetMargin) targetMargin.value = map.target_profit_margin || '50';
          } catch (_) {
            setMsg('載入設定失敗，請稍後再試', false);
          }
        }

        async function putSetting(key, payload){
          const res = await fetch(`${apiBase}/admin/settings/${encodeURIComponent(key)}`, {
            method:'PUT', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify(payload||{})
          });
          const json = await res.json().catch(()=>null);
          if (!res.ok || !json || json.ok !== true) {
            const msg = (json && json.message) || '更新失敗';
            throw new Error(msg);
          }
          return json;
        }

        async function ensureAdmin(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/settings'); return false; }
            const json = await res.json();
            if (!json || json.ok !== true) throw new Error();
            const isAdmin = !!json.data?.isAdmin;
            if (!isAdmin) {
              permBar.style.display = 'block';
              setControlsEnabled(dangerControls, false);
              setControlsEnabled(payrollControls, false);
              setControlsEnabled(costControls, false);
              setControlsEnabled(generalControls, false);
              return false;
            }
            setControlsEnabled(dangerControls, true);
            setControlsEnabled(payrollControls, true);
            setControlsEnabled(costControls, true);
            setControlsEnabled(generalControls, true);
            await loadSettings();
            return true;
          } catch (_) {
            permBar.textContent = '載入失敗，請稍後再試';
            permBar.style.display = 'block';
            return false;
          }
        }

        // 綁定儲存事件 - 薪資參數
        document.getElementById('btnSavePayroll').addEventListener('click', async function(){
          setMsg('', true);
          const attendBonus = document.getElementById('attendance_bonus_amount').value.trim();
          const n = parseInt(attendBonus, 10);
          if (!Number.isInteger(n) || n < 0) { setMsg('全勤獎金必須為非負整數', false); return; }
          this.disabled = true; this.textContent = '儲存中…';
          try {
            await putSetting('attendance_bonus_amount', { value: attendBonus });
            setMsg('已更新薪資參數。', true);
          } catch (e) {
            setMsg(String(e && e.message || '更新失敗'), false);
          } finally {
            this.disabled = false; this.textContent = '儲存薪資參數';
          }
        });

        // 綁定儲存事件 - 成本參數
        document.getElementById('btnSaveCost').addEventListener('click', async function(){
          setMsg('', true);
          const overheadCost = document.getElementById('overhead_cost_per_hour').value.trim();
          const targetMargin = document.getElementById('target_profit_margin').value.trim();
          const oc = parseFloat(overheadCost);
          const tm = parseFloat(targetMargin);
          if (!Number.isFinite(oc) || oc < 0) { setMsg('管理成本必須為非負數字', false); return; }
          if (!Number.isFinite(tm) || tm < 0 || tm > 100) { setMsg('目標毛利率必須在 0-100 之間', false); return; }
          this.disabled = true; this.textContent = '儲存中…';
          try {
            await putSetting('overhead_cost_per_hour', { value: overheadCost });
            await putSetting('target_profit_margin', { value: targetMargin });
            setMsg('已更新成本參數。', true);
          } catch (e) {
            setMsg(String(e && e.message || '更新失敗'), false);
          } finally {
            this.disabled = false; this.textContent = '儲存成本參數';
          }
        });

        // 綁定儲存事件 - 危險設定
        document.getElementById('btnSaveDanger').addEventListener('click', async function(){
          setMsg('', true);
          const rule = document.getElementById('rule_comp_hours_expiry').value;
          this.disabled = true; this.textContent = '儲存中…';
          try {
            await putSetting('rule_comp_hours_expiry', { value: rule, confirmed: true });
            setMsg('已更新危險設定。', true);
          } catch (e) {
            setMsg(String(e && e.message || '更新失敗'), false);
          } finally {
            this.disabled = false; this.textContent = '儲存危險設定';
          }
        });

        document.getElementById('btnSaveGeneral').addEventListener('click', async function(){
          setMsg('', true);
          const company = document.getElementById('company_name').value.trim();
          const email = document.getElementById('contact_email').value.trim();
          const tz = document.getElementById('timezone').value.trim();
          const cur = document.getElementById('currency').value.trim();
          const unit = document.getElementById('timesheet_min_unit').value;
          const soft = document.getElementById('soft_delete_enabled').value;
          const wdStart = document.getElementById('workday_start').value;
          const wdEnd = document.getElementById('workday_end').value;
          const repLoc = document.getElementById('report_locale').value.trim();
          if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { setMsg('Email 格式錯誤', false); return; }
          this.disabled = true; this.textContent = '儲存中…';
          try {
            await putSetting('company_name', { value: company });
            await putSetting('contact_email', { value: email });
            await putSetting('timezone', { value: tz||'Asia/Taipei' });
            await putSetting('currency', { value: cur||'TWD' });
            await putSetting('timesheet_min_unit', { value: unit });
            await putSetting('soft_delete_enabled', { value: soft });
            await putSetting('workday_start', { value: wdStart||'08:30' });
            await putSetting('workday_end', { value: wdEnd||'17:30' });
            await putSetting('report_locale', { value: repLoc||'zh-TW' });
            setMsg('已更新一般設定。', true);
          } catch (e) {
            setMsg(String(e && e.message || '更新失敗'), false);
          } finally {
            this.disabled = false; this.textContent = '儲存一般設定';
          }
        });

        ensureAdmin();
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


