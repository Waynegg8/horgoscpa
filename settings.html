<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="系統設定（管理員）" />
    <title>系統設定｜管理員</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/settings-page.css" />
  </head>
  <body class="internal-container">
    <header class="settings-header">
      <h1 class="settings-title">系統設定</h1>
      <div id="permBar" class="info-bar" style="display:none;" role="alert">您沒有權限檢視此頁面</div>
      <div id="msgBar" class="info-bar" style="display:none;" role="status"></div>
    </header>

    <!-- Tab 導覽列 -->
    <nav class="settings-tabs">
      <button class="tab-btn active" data-tab="system">系統基礎</button>
      <button class="tab-btn" data-tab="users">用戶管理</button>
      <button class="tab-btn" data-tab="clients">客戶管理</button>
      <button class="tab-btn" data-tab="tasks">任務管理</button>
      <button class="tab-btn" data-tab="timesheets">工時管理</button>
      <button class="tab-btn" data-tab="leaves">假期管理</button>
      <button class="tab-btn" data-tab="receipts">收據收款</button>
      <button class="tab-btn" data-tab="payroll">薪資管理</button>
      <button class="tab-btn" data-tab="overhead">成本管理</button>
      <button class="tab-btn" data-tab="attachments">附件系統</button>
      <button class="tab-btn" data-tab="sop">知識庫</button>
      <button class="tab-btn" data-tab="lifecycle">服務生命週期</button>
      <button class="tab-btn" data-tab="cms">CMS內容</button>
      <button class="tab-btn" data-tab="automation">自動化規則</button>
    </nav>

    <main class="settings-content">
      <!-- 系統基礎 Tab -->
      <div class="tab-panel active" id="tab-system">
      <section class="card" aria-labelledby="danger-title">
        <div class="card-header">
          <h2 id="danger-title">危險設定</h2>
          <div class="subtitle">變更前請確認風險，非管理員不可操作</div>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="rule_comp_hours_expiry">補休有效期規則</label>
            <select id="rule_comp_hours_expiry" disabled>
              <option value="current_month">當月到期</option>
              <option value="next_month">次月到期</option>
              <option value="3_months">3 個月</option>
              <option value="6_months">6 個月</option>
            </select>
          </div>
          <div class="form-group">
            <label>每日工時上限（唯讀）</label>
            <input type="text" value="12" readonly />
          </div>
          <div class="form-group">
            <label>月薪制換算時數（唯讀）</label>
            <input type="text" value="240" readonly />
          </div>
          <div>
            <button id="btnSaveDanger" class="btn btn-danger" type="button" disabled>儲存危險設定</button>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="payroll-title" style="margin-top:20px;">
        <div class="card-header">
          <h2 id="payroll-title">薪資相關參數</h2>
          <div class="subtitle">全勤獎金與薪資計算相關設定</div>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="attendance_bonus_amount">全勤獎金金額（元）</label>
            <input id="attendance_bonus_amount" type="number" min="0" step="1" placeholder="1000" disabled />
          </div>
          <div>
            <button id="btnSavePayroll" class="btn btn-primary" type="button" disabled>儲存薪資參數</button>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="cost-title" style="margin-top:20px;">
        <div class="card-header">
          <h2 id="cost-title">成本分析參數</h2>
          <div class="subtitle">管理成本與盈利目標設定</div>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="overhead_cost_per_hour">每小時管理成本（元/小時）</label>
            <input id="overhead_cost_per_hour" type="number" min="0" step="0.01" placeholder="100" disabled />
          </div>
          <div class="form-group">
            <label for="target_profit_margin">目標毛利率（%）</label>
            <input id="target_profit_margin" type="number" min="0" max="100" step="0.1" placeholder="50" disabled />
          </div>
          <div>
            <button id="btnSaveCost" class="btn btn-primary" type="button" disabled>儲存成本參數</button>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="general-title" style="margin-top:20px;">
        <div class="card-header">
          <h2 id="general-title">一般設定</h2>
          <div class="subtitle">公司資訊等一般參數</div>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label for="company_name">公司名稱</label>
            <input id="company_name" type="text" placeholder="範例：霍爾果斯會計師事務所" disabled />
          </div>
          <div class="form-group">
            <label for="contact_email">聯絡信箱</label>
            <input id="contact_email" type="email" placeholder="contact@horgoscpa.com" disabled />
          </div>
          <div class="form-group">
            <label for="timezone">系統時區</label>
            <input id="timezone" type="text" placeholder="Asia/Taipei" disabled />
          </div>
          <div class="form-group">
            <label for="currency">幣別</label>
            <input id="currency" type="text" placeholder="TWD" disabled />
          </div>
          <div class="form-group">
            <label for="timesheet_min_unit">工時最小單位（小時）</label>
            <select id="timesheet_min_unit" disabled>
              <option value="0.25">0.25</option>
              <option value="0.5">0.5</option>
              <option value="1">1</option>
            </select>
          </div>
          <div class="form-group">
            <label for="soft_delete_enabled">啟用軟刪除</label>
            <select id="soft_delete_enabled" disabled>
              <option value="1">啟用</option>
              <option value="0">停用</option>
            </select>
          </div>
          <div class="form-group">
            <label for="workday_start">工作日開始時間</label>
            <input id="workday_start" type="time" disabled />
          </div>
          <div class="form-group">
            <label for="workday_end">工作日結束時間</label>
            <input id="workday_end" type="time" disabled />
          </div>
          <div class="form-group">
            <label for="report_locale">報表語系</label>
            <input id="report_locale" type="text" placeholder="zh-TW" disabled />
          </div>
          <div>
            <button id="btnSaveGeneral" class="btn btn-primary" type="button" disabled>儲存一般設定</button>
          </div>
        </div>
      </section>
      </div>
      <!-- 系統基礎 Tab 結束 -->

      <!-- 用戶管理 Tab -->
      <div class="tab-panel" id="tab-users">
        <section class="card">
          <div class="card-header">
            <h2>用戶管理（Users）</h2>
            <div class="subtitle">管理系統用戶與權限設定</div>
          </div>
          <div class="card-body">
            <p class="text-secondary">此模組尚未完成，後續開發中...</p>
            <div class="db-info">
              <strong>資料表：</strong>Users<br>
              <strong>主要欄位：</strong>user_id, username, name, email, is_admin, gender, birth_date, start_date
            </div>
          </div>
        </section>
      </div>

      <!-- 客戶管理 Tab -->
      <div class="tab-panel" id="tab-clients">
        <section class="card">
          <div class="card-header">
            <h2>客戶管理（Clients）</h2>
            <div class="subtitle">管理客戶資料與服務關係</div>
          </div>
          <div class="card-body">
            <p class="text-secondary">此模組尚未完成，後續開發中...</p>
            <div class="db-info">
              <strong>資料表：</strong>Clients<br>
              <strong>主要欄位：</strong>client_id, name, tax_id, contact_person, email, phone, address
            </div>
          </div>
        </section>
      </div>

      <!-- 任務管理 Tab -->
      <div class="tab-panel" id="tab-tasks">
        <section class="card">
          <div class="card-header">
            <h2>任務管理（Tasks & TaskTemplates）</h2>
            <div class="subtitle">管理任務與任務模板</div>
          </div>
          <div class="card-body">
            <p class="text-secondary">此模組尚未完成，後續開發中...</p>
            <div class="db-info">
              <strong>資料表：</strong>Tasks, TaskTemplates<br>
              <strong>主要欄位：</strong>task_id, title, description, status, priority, due_date, assigned_to
            </div>
          </div>
        </section>
      </div>

      <!-- 工時管理 Tab -->
      <div class="tab-panel" id="tab-timesheets">
        <section class="card">
          <div class="card-header">
            <h2>工時管理（Timesheets）</h2>
            <div class="subtitle">管理員工工時記錄</div>
          </div>
          <div class="card-body">
            <p class="text-secondary">此模組尚未完成，後續開發中...</p>
            <div class="db-info">
              <strong>資料表：</strong>Timesheets<br>
              <strong>主要欄位：</strong>timesheet_id, user_id, date, hours, overtime_hours, work_type
            </div>
          </div>
        </section>
      </div>

      <!-- 假期管理 Tab -->
      <div class="tab-panel" id="tab-leaves">
        <section class="card">
          <div class="card-header">
            <h2>假期管理（Leaves & Holidays）</h2>
            <div class="subtitle">管理員工假期、補休與國定假日</div>
          </div>
          <div class="card-body">
            <p class="text-secondary">此模組尚未完成，後續開發中...</p>
            <div class="db-info">
              <strong>資料表：</strong>Leaves, CompensatoryLeaveGrants, Holidays<br>
              <strong>主要欄位：</strong>leave_id, user_id, leave_type, start_date, end_date, status
            </div>
          </div>
        </section>
      </div>

      <!-- 收據收款 Tab -->
      <div class="tab-panel" id="tab-receipts">
        <section class="card">
          <div class="card-header">
            <h2>收據收款（Receipts & BillingSchedule）</h2>
            <div class="subtitle">管理收據開立與收款記錄</div>
          </div>
          <div class="card-body">
            <p class="text-secondary">此模組尚未完成，後續開發中...</p>
            <div class="db-info">
              <strong>資料表：</strong>Receipts, BillingSchedule<br>
              <strong>主要欄位：</strong>receipt_id, client_id, amount, receipt_date, payment_status
            </div>
          </div>
        </section>
      </div>

      <!-- 薪資管理 Tab -->
      <div class="tab-panel" id="tab-payroll">
        <section class="card">
          <div class="card-header">
            <h2>薪資管理（Payroll）</h2>
            <div class="subtitle">管理員工薪資計算與發放</div>
          </div>
          <div class="card-body">
            <p class="text-secondary">此模組尚未完成，後續開發中...</p>
            <div class="db-info">
              <strong>資料表：</strong>Payroll<br>
              <strong>主要欄位：</strong>payroll_id, user_id, period_month, base_salary, overtime_pay, total_pay
            </div>
          </div>
        </section>
      </div>

      <!-- 成本管理 Tab -->
      <div class="tab-panel" id="tab-overhead">
        <section class="card">
          <div class="card-header">
            <h2>成本管理（Overhead）</h2>
            <div class="subtitle">管理公司成本與費用分配</div>
          </div>
          <div class="card-body">
            <p class="text-secondary">此模組尚未完成，後續開發中...</p>
            <div class="db-info">
              <strong>資料表：</strong>Overhead<br>
              <strong>主要欄位：</strong>overhead_id, category, amount, date, description
            </div>
          </div>
        </section>
      </div>

      <!-- 附件系統 Tab -->
      <div class="tab-panel" id="tab-attachments">
        <section class="card">
          <div class="card-header">
            <h2>附件系統（Attachments）</h2>
            <div class="subtitle">管理系統中所有附件與檔案</div>
          </div>
          <div class="card-body">
            <p class="text-secondary">此模組尚未完成，後續開發中...</p>
            <div class="db-info">
              <strong>資料表：</strong>Attachments<br>
              <strong>主要欄位：</strong>attachment_id, entity_type, entity_id, file_name, file_url
            </div>
          </div>
        </section>
      </div>

      <!-- 知識庫 Tab -->
      <div class="tab-panel" id="tab-sop">
        <section class="card">
          <div class="card-header">
            <h2>知識庫（SOP）</h2>
            <div class="subtitle">管理內部知識文件與SOP</div>
          </div>
          <div class="card-body">
            <p class="text-secondary">此模組尚未完成，後續開發中...</p>
            <div class="db-info">
              <strong>資料表：</strong>SOP<br>
              <strong>主要欄位：</strong>sop_id, title, content, category, version
            </div>
          </div>
        </section>
      </div>

      <!-- 服務生命週期 Tab -->
      <div class="tab-panel" id="tab-lifecycle">
        <section class="card">
          <div class="card-header">
            <h2>服務生命週期（ClientServicesLifecycle）</h2>
            <div class="subtitle">管理客戶服務流程與狀態</div>
          </div>
          <div class="card-body">
            <p class="text-secondary">此模組尚未完成，後續開發中...</p>
            <div class="db-info">
              <strong>資料表：</strong>ClientServicesLifecycle, ServiceStructure<br>
              <strong>主要欄位：</strong>lifecycle_id, client_id, service_type, status, stage
            </div>
          </div>
        </section>
      </div>

      <!-- CMS內容 Tab -->
      <div class="tab-panel" id="tab-cms">
        <section class="card">
          <div class="card-header">
            <h2>CMS內容管理（CMS）</h2>
            <div class="subtitle">管理官網內容與文章發布</div>
          </div>
          <div class="card-body">
            <p class="text-secondary">此模組尚未完成，後續開發中...</p>
            <div class="db-info">
              <strong>資料表：</strong>CMS<br>
              <strong>主要欄位：</strong>cms_id, title, content, slug, status, published_at
            </div>
          </div>
        </section>
      </div>

      <!-- 自動化規則 Tab -->
      <div class="tab-panel" id="tab-automation">
        <section class="card">
          <div class="card-header">
            <h2>自動化規則（AutomationRules）</h2>
            <div class="subtitle">管理系統自動化規則與定時任務</div>
          </div>
          <div class="card-body">
            <p class="text-secondary">此模組尚未完成，後續開發中...</p>
            <div class="db-info">
              <strong>資料表：</strong>AutomationRules, CronExecutions<br>
              <strong>主要欄位：</strong>rule_id, rule_name, trigger_type, action_type, is_active
            </div>
          </div>
        </section>
      </div>

    </main>

    <script>
      (function(){
        // Tab 切換功能
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabPanels = document.querySelectorAll('.tab-panel');

        tabBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const targetTab = btn.getAttribute('data-tab');
            
            // 移除所有active狀態
            tabBtns.forEach(b => b.classList.remove('active'));
            tabPanels.forEach(p => p.classList.remove('active'));
            
            // 添加當前tab的active狀態
            btn.classList.add('active');
            const targetPanel = document.getElementById('tab-' + targetTab);
            if (targetPanel) {
              targetPanel.classList.add('active');
            }
          });
        });

        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const permBar = document.getElementById('permBar');
        const dangerControls = [
          document.getElementById('rule_comp_hours_expiry'),
          document.getElementById('btnSaveDanger'),
        ];
        const payrollControls = [
          document.getElementById('attendance_bonus_amount'),
          document.getElementById('btnSavePayroll'),
        ];
        const costControls = [
          document.getElementById('overhead_cost_per_hour'),
          document.getElementById('target_profit_margin'),
          document.getElementById('btnSaveCost'),
        ];
        const generalControls = [
          document.getElementById('company_name'),
          document.getElementById('contact_email'),
          document.getElementById('btnSaveGeneral'),
        ];

        function setControlsEnabled(arr, enabled){
          arr.forEach(el => { if (el) { el.disabled = !enabled; } });
        }

        function setMsg(text, isOk){
          const bar = document.getElementById('msgBar');
          if (!bar) return;
          if (!text){ bar.style.display='none'; bar.textContent=''; return; }
          bar.textContent = text;
          bar.style.display = 'block';
          bar.style.color = isOk ? '#1b5e20' : '#c0392b';
        }

        async function loadSettings(){
          try {
            const res = await fetch(`${apiBase}/admin/settings`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/settings'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const map = json.data?.map || {};
            const company = document.getElementById('company_name');
            const email = document.getElementById('contact_email');
            const rule = document.getElementById('rule_comp_hours_expiry');
            const tz = document.getElementById('timezone');
            const cur = document.getElementById('currency');
            const unit = document.getElementById('timesheet_min_unit');
            const soft = document.getElementById('soft_delete_enabled');
            const wdStart = document.getElementById('workday_start');
            const wdEnd = document.getElementById('workday_end');
            const repLoc = document.getElementById('report_locale');
            const attendBonus = document.getElementById('attendance_bonus_amount');
            const overheadCost = document.getElementById('overhead_cost_per_hour');
            const targetMargin = document.getElementById('target_profit_margin');
            if (company) company.value = map.company_name || '';
            if (email) email.value = map.contact_email || '';
            if (rule && map.rule_comp_hours_expiry) rule.value = map.rule_comp_hours_expiry;
            if (tz) tz.value = map.timezone || 'Asia/Taipei';
            if (cur) cur.value = map.currency || 'TWD';
            if (unit && map.timesheet_min_unit) unit.value = String(map.timesheet_min_unit);
            if (soft && map.soft_delete_enabled) soft.value = String(map.soft_delete_enabled);
            if (wdStart) wdStart.value = (map.workday_start||'08:30');
            if (wdEnd) wdEnd.value = (map.workday_end||'17:30');
            if (repLoc) repLoc.value = map.report_locale || 'zh-TW';
            if (attendBonus) attendBonus.value = map.attendance_bonus_amount || '1000';
            if (overheadCost) overheadCost.value = map.overhead_cost_per_hour || '100';
            if (targetMargin) targetMargin.value = map.target_profit_margin || '50';
          } catch (_) {
            setMsg('載入設定失敗，請稍後再試', false);
          }
        }

        async function putSetting(key, payload){
          const res = await fetch(`${apiBase}/admin/settings/${encodeURIComponent(key)}`, {
            method:'PUT', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify(payload||{})
          });
          const json = await res.json().catch(()=>null);
          if (!res.ok || !json || json.ok !== true) {
            const msg = (json && json.message) || '更新失敗';
            throw new Error(msg);
          }
          return json;
        }

        async function ensureAdmin(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/settings'); return false; }
            const json = await res.json();
            if (!json || json.ok !== true) throw new Error();
            const isAdmin = !!json.data?.isAdmin;
            if (!isAdmin) {
              permBar.style.display = 'block';
              setControlsEnabled(dangerControls, false);
              setControlsEnabled(payrollControls, false);
              setControlsEnabled(costControls, false);
              setControlsEnabled(generalControls, false);
              return false;
            }
            setControlsEnabled(dangerControls, true);
            setControlsEnabled(payrollControls, true);
            setControlsEnabled(costControls, true);
            setControlsEnabled(generalControls, true);
            await loadSettings();
            return true;
          } catch (_) {
            permBar.textContent = '載入失敗，請稍後再試';
            permBar.style.display = 'block';
            return false;
          }
        }

        // 綁定儲存事件 - 薪資參數
        document.getElementById('btnSavePayroll').addEventListener('click', async function(){
          setMsg('', true);
          const attendBonus = document.getElementById('attendance_bonus_amount').value.trim();
          const n = parseInt(attendBonus, 10);
          if (!Number.isInteger(n) || n < 0) { setMsg('全勤獎金必須為非負整數', false); return; }
          this.disabled = true; this.textContent = '儲存中…';
          try {
            await putSetting('attendance_bonus_amount', { value: attendBonus });
            setMsg('已更新薪資參數。', true);
          } catch (e) {
            setMsg(String(e && e.message || '更新失敗'), false);
          } finally {
            this.disabled = false; this.textContent = '儲存薪資參數';
          }
        });

        // 綁定儲存事件 - 成本參數
        document.getElementById('btnSaveCost').addEventListener('click', async function(){
          setMsg('', true);
          const overheadCost = document.getElementById('overhead_cost_per_hour').value.trim();
          const targetMargin = document.getElementById('target_profit_margin').value.trim();
          const oc = parseFloat(overheadCost);
          const tm = parseFloat(targetMargin);
          if (!Number.isFinite(oc) || oc < 0) { setMsg('管理成本必須為非負數字', false); return; }
          if (!Number.isFinite(tm) || tm < 0 || tm > 100) { setMsg('目標毛利率必須在 0-100 之間', false); return; }
          this.disabled = true; this.textContent = '儲存中…';
          try {
            await putSetting('overhead_cost_per_hour', { value: overheadCost });
            await putSetting('target_profit_margin', { value: targetMargin });
            setMsg('已更新成本參數。', true);
          } catch (e) {
            setMsg(String(e && e.message || '更新失敗'), false);
          } finally {
            this.disabled = false; this.textContent = '儲存成本參數';
          }
        });

        // 綁定儲存事件 - 危險設定
        document.getElementById('btnSaveDanger').addEventListener('click', async function(){
          setMsg('', true);
          const rule = document.getElementById('rule_comp_hours_expiry').value;
          this.disabled = true; this.textContent = '儲存中…';
          try {
            await putSetting('rule_comp_hours_expiry', { value: rule, confirmed: true });
            setMsg('已更新危險設定。', true);
          } catch (e) {
            setMsg(String(e && e.message || '更新失敗'), false);
          } finally {
            this.disabled = false; this.textContent = '儲存危險設定';
          }
        });

        document.getElementById('btnSaveGeneral').addEventListener('click', async function(){
          setMsg('', true);
          const company = document.getElementById('company_name').value.trim();
          const email = document.getElementById('contact_email').value.trim();
          const tz = document.getElementById('timezone').value.trim();
          const cur = document.getElementById('currency').value.trim();
          const unit = document.getElementById('timesheet_min_unit').value;
          const soft = document.getElementById('soft_delete_enabled').value;
          const wdStart = document.getElementById('workday_start').value;
          const wdEnd = document.getElementById('workday_end').value;
          const repLoc = document.getElementById('report_locale').value.trim();
          if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { setMsg('Email 格式錯誤', false); return; }
          this.disabled = true; this.textContent = '儲存中…';
          try {
            await putSetting('company_name', { value: company });
            await putSetting('contact_email', { value: email });
            await putSetting('timezone', { value: tz||'Asia/Taipei' });
            await putSetting('currency', { value: cur||'TWD' });
            await putSetting('timesheet_min_unit', { value: unit });
            await putSetting('soft_delete_enabled', { value: soft });
            await putSetting('workday_start', { value: wdStart||'08:30' });
            await putSetting('workday_end', { value: wdEnd||'17:30' });
            await putSetting('report_locale', { value: repLoc||'zh-TW' });
            setMsg('已更新一般設定。', true);
          } catch (e) {
            setMsg(String(e && e.message || '更新失敗'), false);
          } finally {
            this.disabled = false; this.textContent = '儲存一般設定';
          }
        });

        ensureAdmin();
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


