<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ç³»çµ±è¨­å®šï½œç®¡ç†å“¡</title>
    <link rel="stylesheet" href="/assets/css/common.css">
    <link rel="stylesheet" href="/assets/css/internal-system.css">
    <link rel="stylesheet" href="/assets/css/internal-components.css">
    <link rel="stylesheet" href="/assets/css/settings-page.css?v=202">
    
    <!-- âš¡ é¢„åŠ è½½ä¸ç¼“å­˜ç³»ç»Ÿ -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <script src="/assets/js/prerender.js"></script>
    <script src="/assets/js/page-prerender.js"></script>
    <script src="/assets/js/tab-cache.js"></script>
  </head>
<body>
    <div id="permBar" class="alert alert-danger" style="display:none">æ‚¨æ²’æœ‰æ¬Šé™</div>
    
    <nav class="settings-nav">
        <button class="nav-tab active" data-tab="services">æœå‹™é …ç›®</button>
        <button class="nav-tab" data-tab="templates">ä»»å‹™æ¨¡æ¿</button>
        <button class="nav-tab" data-tab="users">ç”¨æˆ¶</button>
        <button class="nav-tab" data-tab="leaves">å‡æœŸ</button>
        <button class="nav-tab" data-tab="lifecycle">æœå‹™ç”Ÿå‘½é€±æœŸ</button>
        <button class="nav-tab" data-tab="automation">è‡ªå‹•åŒ–è¦å‰‡</button>
        <button class="nav-tab" data-tab="holidays">åœ‹å®šå‡æ—¥</button>
    </nav>

    <main class="settings-content">
        
        <!-- æœåŠ¡é¡¹ç›® -->
        <div class="tab-panel active" id="tab-services">
            <div class="search-bar">
                <button class="btn btn-primary" id="btnAddService">+ æ–°å¢</button>
        </div>

            <div class="card hidden" id="addServiceForm">
                <div class="card-header"><h3>æ–°å¢æœå‹™é …ç›®</h3></div>
        <div class="card-body">
          <div class="form-group">
                        <label>æœå‹™åç¨± *</label>
                        <input type="text" id="newServiceName">
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveService()">å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="cancelService()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="servicesTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>æœå‹™åç¨±</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="3" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡æ¨¡æ¿ -->
        <div class="tab-panel" id="tab-templates">
            <div class="search-bar">
                <button class="btn btn-primary" id="btnAddTemplate">+ æ–°å¢æ¨¡æ¿</button>
            </div>
            
            <!-- æ–°å¢æ¨¡æ¿è¡¨å• -->
            <div class="card hidden" id="addTemplateForm">
                <div class="card-header"><h3>æ–°å¢ä»»å‹™æ¨¡æ¿</h3></div>
                <div class="card-body">
                    <div class="form-group">
                        <label>æ¨¡æ¿åç¨± *</label>
                        <input type="text" id="newTemplateName" class="form-control" placeholder="ä¾‹å¦‚ï¼šè¨˜å¸³æœå‹™æ¨™æº–æµç¨‹">
                    </div>
                    <div class="form-group">
                        <label>æœå‹™é …ç›® *</label>
                        <select id="newTemplateService" class="form-control">
                            <option value="">è«‹é¸æ“‡æœå‹™é …ç›®</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç¶å®šå®¢æˆ¶ï¼ˆå¯é¸ï¼‰</label>
                        <select id="newTemplateClient" class="form-control">
                            <option value="">é€šç”¨æ¨¡æ¿ï¼ˆä¸ç¶å®šå®¢æˆ¶ï¼‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>èªªæ˜</label>
                        <textarea id="newTemplateDesc" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveTemplate()">å„²å­˜æ¨¡æ¿</button>
                        <button class="btn btn-secondary" onclick="cancelTemplate()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ¿åˆ—è¡¨ -->
            <div id="templatesList"></div>
        </div>

        <!-- ç”¨æˆ· -->
        <div class="tab-panel" id="tab-users">
            <div class="search-bar">
                <button class="btn btn-primary" id="btnAddUser">+ æ–°å¢</button>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>å§“å</th>
                                    <th>å¸³è™Ÿ</th>
                                    <th>è§’è‰²</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- å‡æœŸ -->
        <div class="tab-panel" id="tab-leaves">
            <div class="search-bar">
                <select id="filterLeaveStatus" class="form-control" style="max-width:200px">
                    <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                    <option value="pending">å¾…å¯©æ ¸</option>
                    <option value="approved">å·²æ‰¹å‡†</option>
                    <option value="rejected">å·²æ‹’çµ•</option>
            </select>
                <button class="btn btn-secondary" onclick="loadLeaves()">æŸ¥è©¢</button>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="leavesTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>å“¡å·¥</th>
                                    <th>å‡æœŸé¡å‹</th>
                                    <th>é–‹å§‹æ—¥æœŸ</th>
                                    <th>çµæŸæ—¥æœŸ</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="7" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœåŠ¡ç”Ÿå‘½å‘¨æœŸ -->
        <div class="tab-panel" id="tab-lifecycle">
            <div class="search-bar">
                <button class="btn btn-primary" id="btnAddLifecycle">+ æ–°å¢</button>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="lifecycleTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ç‹€æ…‹åç¨±</th>
                                    <th>é¡è‰²</th>
                                    <th>æ’åº</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- è‡ªåŠ¨åŒ–è§„åˆ™ -->
        <div class="tab-panel" id="tab-automation">
            <div class="search-bar">
                <button class="btn btn-primary" id="btnAddAutomation">+ æ–°å¢</button>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="automationTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>è¦å‰‡åç¨±</th>
                                    <th>è§¸ç™¼æ¢ä»¶</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
          </div>
          </div>

        <!-- å›½å®šå‡æ—¥ -->
        <div class="tab-panel" id="tab-holidays">
            <div class="search-bar">
                <input type="number" placeholder="å¹´ä»½" id="filterYear" class="form-control" style="max-width:150px">
                <button class="btn btn-secondary" onclick="loadHolidays()">æŸ¥è©¢</button>
                <button class="btn btn-primary" onclick="showAddHolidayForm()">+ æ–°å¢å‡æ—¥</button>
                <button class="btn btn-success" onclick="showBatchUploadForm()">ğŸ“¤ æ‰¹é‡ä¸Šå‚³</button>
          </div>
          
            <!-- æ‰¹é‡ä¸Šå‚³è¡¨å–® -->
            <div class="card hidden" id="batchUploadForm">
                <div class="card-header">
                    <h3>æ‰¹é‡ä¸Šå‚³å‡æ—¥</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>ä¸Šå‚³æ–¹å¼</label>
                        <div style="margin-bottom:12px">
                            <label style="margin-right:20px;font-weight:normal">
                                <input type="radio" name="uploadMethod" value="csv" checked onchange="toggleUploadMethod()"> CSV æª”æ¡ˆ
                            </label>
                            <label style="font-weight:normal">
                                <input type="radio" name="uploadMethod" value="text" onchange="toggleUploadMethod()"> æ–‡å­—è²¼ä¸Š
                            </label>
                        </div>
                    </div>
                    
                    <!-- CSV ä¸Šå‚³ -->
                    <div id="csvUploadArea">
                        <div class="form-group">
                            <label>é¸æ“‡ CSV æª”æ¡ˆ</label>
                            <input type="file" id="csvFile" accept=".csv" class="form-control">
                        </div>
                    </div>
                    
                    <!-- æ–‡å­—è²¼ä¸Š -->
                    <div id="textUploadArea" style="display:none">
                        <div class="form-group">
                            <label>è²¼ä¸Š CSV å…§å®¹ï¼ˆæ¯è¡Œä¸€ç­†ï¼Œæ ¼å¼ï¼šæ—¥æœŸ,åç¨±,é¡å‹ï¼‰</label>
                            <textarea id="csvText" class="form-control" rows="10" placeholder="2025-01-01,å…ƒæ—¦,åœ‹å®šå‡æ—¥&#10;2025-01-27,è¾²æ›†é™¤å¤•è£œå‡,åœ‹å®šå‡æ—¥&#10;2025-01-28,è¾²æ›†é™¤å¤•,åœ‹å®šå‡æ—¥"></textarea>
                        </div>
                    </div>
                    
                    <div style="background:#f0f9ff;border:1px solid #bfdbfe;padding:12px;border-radius:6px;margin:16px 0;font-size:13px">
                        <strong>ğŸ“‹ æ ¼å¼èªªæ˜ï¼š</strong><br>
                        <code>æ—¥æœŸ,åç¨±,é¡å‹</code><br>
                        é¡å‹å¯é¸ï¼š<code>åœ‹å®šå‡æ—¥</code>ã€<code>ä¾‹å‡æ—¥</code>ã€<code>è£œç­æ—¥</code><br><br>
                        <strong>ç¯„ä¾‹ï¼š</strong><br>
                        <code>2025-01-01,å…ƒæ—¦,åœ‹å®šå‡æ—¥</code><br>
                        <code>2025-02-28,å’Œå¹³ç´€å¿µæ—¥,åœ‹å®šå‡æ—¥</code>
                    </div>
                    
                    <div class="action-btns">
                        <button class="btn btn-success" onclick="processBatchUpload()">é–‹å§‹ä¸Šå‚³</button>
                        <button class="btn btn-secondary" onclick="cancelBatchUpload()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
          
          <!-- æ–°å¢/ç·¨è¼¯å‡æ—¥è¡¨å–® -->
            <div class="card hidden" id="holidayForm">
                <div class="card-header">
                    <h3 id="holidayFormTitle">æ–°å¢å‡æ—¥</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>æ—¥æœŸ *</label>
                        <input type="date" id="holiday_date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>å‡æ—¥åç¨± *</label>
                        <input type="text" id="holiday_name" class="form-control" placeholder="ä¾‹å¦‚ï¼šå…ƒæ—¦ã€æ˜¥ç¯€" required>
                    </div>
                    <div class="form-group">
                        <label>é¡å‹</label>
                        <select id="holiday_type" class="form-control">
                            <option value="national">åœ‹å®šå‡æ—¥</option>
                            <option value="weekly">ä¾‹å‡æ—¥</option>
                            <option value="makeup">è£œç­æ—¥</option>
                        </select>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-primary" onclick="saveHoliday()">å„²å­˜</button>
                        <button class="btn btn-secondary" onclick="cancelHolidayForm()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
          
            <div class="card">
                <div class="card-body">
                    <div class="data-table-container">
                        <table class="data-table" id="holidaysTable">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>å‡æ—¥åç¨±</th>
                                    <th>é¡å‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="4" class="loading">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
          </div>
          </div>
          </div>
        </div>

    </main>

    <script src="/assets/js/components/bootstrap.js?v=3"></script>
    <script>
        // âš¡ Tab ç¼“å­˜ç³»ç»Ÿåˆå§‹åŒ–
        let currentSettingsTab = 'services';
        if (window.TabCache) {
            window.TabCache.init(['services', 'templates', 'users', 'leaves', 'lifecycle', 'automation', 'holidays']);
        }
        
        // Tabåˆ‡æ¢
        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.onclick = () => {
                const tab = btn.dataset.tab;
                
                // âš¡ æ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
                const shouldLoad = window.TabCache ? window.TabCache.shouldLoad(currentSettingsTab, tab) : true;
                currentSettingsTab = tab;
                
                document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tab-' + tab).classList.add('active');
                
                // âš¡ åªåœ¨éœ€è¦æ—¶åŠ è½½æ•°æ®
                if (shouldLoad) {
                    // åŠ è½½å¯¹åº”æ•°æ®
                    if (tab === 'services') loadServices();
                    else if (tab === 'templates') { loadTemplates(); loadTemplateOptions(); }
                    else if (tab === 'users') loadUsers();
                    else if (tab === 'leaves') loadLeaves();
                    else if (tab === 'lifecycle') loadLifecycle();
                    else if (tab === 'automation') loadAutomation();
                    else if (tab === 'holidays') loadHolidays();
                    
                    // âš¡ æ ‡è®°ä¸ºå·²åŠ è½½
                    if (window.TabCache) {
                        window.TabCache.markLoaded(tab);
                    }
                }
            };
        });
        
        // ä»»åŠ¡æ¨¡æ¿ - æ–°å¢
        document.getElementById('btnAddTemplate')?.addEventListener('click', () => {
            document.getElementById('addTemplateForm').classList.remove('hidden');
            loadTemplateOptions();
        });

        // ç”¨æˆ· - æ–°å¢
        document.getElementById('btnAddUser')?.addEventListener('click', () => {
            alert('è«‹é€éç®¡ç†å“¡å·¥å…·æ–°å¢ç”¨æˆ¶');
        });

        // ç”Ÿå‘½å‘¨æœŸã€è‡ªåŠ¨åŒ– - æ–°å¢
        ['btnAddLifecycle', 'btnAddAutomation'].forEach(id => {
            document.getElementById(id)?.addEventListener('click', () => alert('æ­¤åŠŸèƒ½é–‹ç™¼ä¸­'));
        });

        // æ–°å¢æœåŠ¡
        document.getElementById('btnAddService').onclick = () => {
            document.getElementById('addServiceForm').classList.remove('hidden');
        };

        function cancelService() {
            document.getElementById('addServiceForm').classList.add('hidden');
        }

        async function saveService() {
            const name = document.getElementById('newServiceName').value;
            if (!name) return alert('è«‹è¼¸å…¥æœå‹™åç¨±');
            
            try {
                const res = await fetch('/internal/api/v1/services', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ service_name: name })
                });
                if (!res.ok) throw new Error('å¤±æ•—');
                alert('æ–°å¢æˆåŠŸ');
                cancelService();
                loadServices();
            } catch (e) {
                alert('å¤±æ•—: ' + e.message);
            }
        }

        // åŠ è½½æœåŠ¡
        async function loadServices() {
            const tbody = document.querySelector('#servicesTable tbody');
            try {
                const res = await fetch('/internal/api/v1/services', { credentials: 'include' });
            const json = await res.json();
                
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                
                tbody.innerHTML = json.data.map(s => `
                    <tr>
                        <td>${s.service_id}</td>
                        <td>${s.service_name}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteService(${s.service_id})">åˆªé™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="3" class="loading">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }

        async function deleteService(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            try {
                await fetch('/internal/api/v1/services/' + id, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                loadServices();
            } catch (e) {
                alert('åˆªé™¤å¤±æ•—');
            }
        }

        // å…¨å±€å­˜å‚¨SOPå’Œé™„ä»¶åˆ—è¡¨
        let allSOPs = [];
        let allAttachments = [];

        // ä»»åŠ¡æ¨¡æ¿ - åŠ è½½æœåŠ¡ã€å®¢æˆ·ã€SOPã€é™„ä»¶ä¸‹æ‹‰é€‰é¡¹
        async function loadTemplateOptions() {
            try {
                const [servicesRes, clientsRes, sopRes, attachmentRes] = await Promise.all([
                    fetch('/internal/api/v1/services', { credentials: 'include' }),
                    fetch('/internal/api/v1/clients?perPage=200', { credentials: 'include' }),
                    fetch('/internal/api/v1/sop', { credentials: 'include' }).catch(() => ({json: () => ({data:[]})})),
                    fetch('/internal/api/v1/attachments', { credentials: 'include' }).catch(() => ({json: () => ({data:[]})}))
                ]);
                const services = await servicesRes.json();
                const clients = await clientsRes.json();
                const sops = await sopRes.json();
                const attachments = await attachmentRes.json();
                
                // ä¿å­˜åˆ°å…¨å±€
                allSOPs = sops.data || [];
                allAttachments = attachments.data || [];
                
                const serviceSelect = document.getElementById('newTemplateService');
                if (services.data) {
                    serviceSelect.innerHTML = '<option value="">è«‹é¸æ“‡æœå‹™é …ç›®</option>' + 
                        services.data.map(s => `<option value="${s.service_id}">${s.service_name}</option>`).join('');
                }
                
                const clientSelect = document.getElementById('newTemplateClient');
                if (clients.data) {
                    clientSelect.innerHTML = '<option value="">é€šç”¨æ¨¡æ¿ï¼ˆä¸ç¶å®šå®¢æˆ¶ï¼‰</option>' + 
                        clients.data.map(c => `<option value="${c.clientId}">${c.companyName}</option>`).join('');
                }
            } catch (e) {}
        }
        
        // å¡«å……SOPå’Œé™„ä»¶ä¸‹æ‹‰é€‰å•
        function populateSOPAndAttachments(templateId) {
            const sopSelect = document.getElementById(`task-sop-${templateId}`);
            const attachmentSelect = document.getElementById(`task-attachment-${templateId}`);
            
            if (sopSelect && allSOPs.length > 0) {
                sopSelect.innerHTML = '<option value="">ç„¡</option>' + 
                    allSOPs.map(s => `<option value="${s.sop_id}">${s.title}</option>`).join('');
            }
            
            if (attachmentSelect && allAttachments.length > 0) {
                attachmentSelect.innerHTML = '<option value="">ç„¡</option>' + 
                    allAttachments.map(a => `<option value="${a.attachment_id}">${a.file_name || a.attachment_id}</option>`).join('');
            }
        }

        // ä»»åŠ¡æ¨¡æ¿ - åŠ è½½åˆ—è¡¨
        async function loadTemplates() {
            const container = document.getElementById('templatesList');
            try {
                const res = await fetch('/internal/api/v1/task-templates', { credentials: 'include' });
                const json = await res.json();
                
                if (!json.data || json.data.length === 0) {
                    container.innerHTML = '<div class="card"><div class="card-body" style="text-align:center;color:#999">æš«ç„¡æ¨¡æ¿</div></div>';
                    return;
                }
                
                container.innerHTML = json.data.map(t => `
                    <div class="card" style="margin-bottom:24px">
                        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <h3 style="margin:0;font-size:16px">${t.template_name}</h3>
                                <div style="font-size:13px;color:#666;margin-top:4px">
                                    æœå‹™ï¼š${t.service_name || '-'} | å®¢æˆ¶ï¼š${t.client_name || 'é€šç”¨'} | ${t.stages_count || 0} å€‹ä»»å‹™
                                </div>
                            </div>
                            <div style="display:flex;gap:8px">
                                <button class="btn btn-sm btn-secondary" onclick="toggleTasks(${t.template_id})">â–¼ ä»»å‹™</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${t.template_id})">åˆªé™¤</button>
                            </div>
                        </div>
                        <div class="card-body hidden" id="tasks-${t.template_id}">
                            <button class="btn btn-sm btn-primary" onclick="showAddTask(${t.template_id})" style="margin-bottom:16px">+ æ–°å¢ä»»å‹™</button>
                            <div id="task-form-${t.template_id}" class="hidden" style="background:#f9f9f9;padding:16px;border-radius:8px;margin-bottom:16px">
                                <div class="form-group">
                                    <label>ä»»å‹™åç¨± *</label>
                                    <input type="text" id="task-name-${t.template_id}" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>æ’åºé †åº</label>
                                    <input type="number" id="task-order-${t.template_id}" class="form-control" value="1">
                                </div>
                                <div class="form-group">
                                    <label>é€£çµSOPï¼ˆå¯é¸ï¼‰</label>
                                    <select id="task-sop-${t.template_id}" class="form-control">
                                        <option value="">ç„¡</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>é€£çµé™„ä»¶ï¼ˆå¯é¸ï¼‰</label>
                                    <select id="task-attachment-${t.template_id}" class="form-control">
                                        <option value="">ç„¡</option>
                                    </select>
                                </div>
                                <div class="action-btns">
                                    <button class="btn btn-sm btn-primary" onclick="saveTask(${t.template_id})">å„²å­˜</button>
                                    <button class="btn btn-sm btn-secondary" onclick="cancelTask(${t.template_id})">å–æ¶ˆ</button>
                                </div>
                            </div>
                            <div id="task-list-${t.template_id}">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<div class="card"><div class="card-body" style="text-align:center;color:#f44">è¼‰å…¥å¤±æ•—</div></div>';
            }
        }

        // åˆ‡æ¢ä»»åŠ¡åˆ—è¡¨æ˜¾ç¤º
        async function toggleTasks(templateId) {
            const tasksDiv = document.getElementById(`tasks-${templateId}`);
            if (tasksDiv.classList.contains('hidden')) {
                tasksDiv.classList.remove('hidden');
                await loadTasksForTemplate(templateId);
            } else {
                tasksDiv.classList.add('hidden');
            }
        }

        // åŠ è½½æŸä¸ªæ¨¡æ¿çš„ä»»åŠ¡
        async function loadTasksForTemplate(templateId) {
            const listDiv = document.getElementById(`task-list-${templateId}`);
            try {
                const res = await fetch(`/internal/api/v1/task-templates/${templateId}/stages`, { credentials: 'include' });
                const json = await res.json();
                
                if (!json.data || json.data.length === 0) {
                    listDiv.innerHTML = '<div style="color:#999;font-size:13px">å°šç„¡ä»»å‹™</div>';
                    return;
                }
                
                listDiv.innerHTML = '<table class="data-table"><thead><tr><th>é †åº</th><th>ä»»å‹™åç¨±</th><th>SOP</th><th>é™„ä»¶</th><th>æ“ä½œ</th></tr></thead><tbody>' +
                    json.data.map(task => `
                        <tr>
                            <td>${task.stage_order}</td>
                            <td>${task.task_name}</td>
                            <td>${task.sop_id || '-'}</td>
                            <td>${task.attachment_id || '-'}</td>
                            <td><button class="btn btn-sm btn-danger" onclick="deleteTask(${templateId}, ${task.stage_id})">åˆªé™¤</button></td>
                        </tr>
                    `).join('') + '</tbody></table>';
            } catch (e) {
                listDiv.innerHTML = '<div style="color:#f44">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        // æ˜¾ç¤ºæ–°å¢ä»»åŠ¡è¡¨å•
        function showAddTask(templateId) {
            document.getElementById(`task-form-${templateId}`).classList.remove('hidden');
            populateSOPAndAttachments(templateId);
        }
        function cancelTask(templateId) {
            document.getElementById(`task-form-${templateId}`).classList.add('hidden');
        }

        // ä¿å­˜ä»»åŠ¡
        async function saveTask(templateId) {
            const name = document.getElementById(`task-name-${templateId}`).value;
            const order = document.getElementById(`task-order-${templateId}`).value;
            const sopId = document.getElementById(`task-sop-${templateId}`).value;
            const attachmentId = document.getElementById(`task-attachment-${templateId}`).value;
            
            if (!name) return alert('è«‹è¼¸å…¥ä»»å‹™åç¨±');
            
            try {
                const res = await fetch(`/internal/api/v1/task-templates/${templateId}/stages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        task_name: name,
                        stage_order: parseInt(order) || 1,
                        sop_id: sopId ? parseInt(sopId) : null,
                        attachment_id: attachmentId ? parseInt(attachmentId) : null
                    })
                });
                if (!res.ok) throw new Error();
                alert('æ–°å¢æˆåŠŸ');
                cancelTask(templateId);
                loadTasksForTemplate(templateId);
            } catch (e) {
                alert('æ–°å¢å¤±æ•—');
            }
        }

        // åˆ é™¤ä»»åŠ¡
        async function deleteTask(templateId, stageId) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ä»»å‹™ï¼Ÿ')) return;
            try {
                await fetch(`/internal/api/v1/task-templates/${templateId}/stages/${stageId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                loadTasksForTemplate(templateId);
            } catch (e) {
                alert('åˆªé™¤å¤±æ•—');
            }
        }

        // åˆ é™¤æ¨¡æ¿
        async function deleteTemplate(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨¡æ¿ï¼Ÿæ‰€æœ‰ä»»å‹™ä¹Ÿæœƒè¢«åˆªé™¤')) return;
            try {
                await fetch('/internal/api/v1/task-templates/' + id, { method: 'DELETE', credentials: 'include' });
                loadTemplates();
            } catch (e) {
                alert('åˆªé™¤å¤±æ•—');
            }
        }

        // ä¿å­˜æ¨¡æ¿
        async function saveTemplate() {
            const name = document.getElementById('newTemplateName').value;
            const serviceId = document.getElementById('newTemplateService').value;
            const clientId = document.getElementById('newTemplateClient').value;
            const desc = document.getElementById('newTemplateDesc').value;
            
            if (!name || !serviceId) return alert('è«‹è¼¸å…¥æ¨¡æ¿åç¨±ä¸¦é¸æ“‡æœå‹™é …ç›®');
            
            try {
                const res = await fetch('/internal/api/v1/task-templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        template_name: name,
                        service_id: parseInt(serviceId),
                        client_id: clientId ? parseInt(clientId) : null,
                        description: desc
                    })
                });
                if (!res.ok) throw new Error();
                alert('æ–°å¢æˆåŠŸ');
                cancelTemplate();
                loadTemplates();
            } catch (e) {
                alert('æ–°å¢å¤±æ•—');
            }
        }

        function cancelTemplate() {
            document.getElementById('addTemplateForm').classList.add('hidden');
            document.getElementById('newTemplateName').value = '';
            document.getElementById('newTemplateService').value = '';
            document.getElementById('newTemplateClient').value = '';
            document.getElementById('newTemplateDesc').value = '';
        }

        // ç”¨æˆ·ç®¡ç†
        async function loadUsers() {
            const tbody = document.querySelector('#usersTable tbody');
            try {
                const res = await fetch('/internal/api/v1/users', { credentials: 'include' });
                const json = await res.json();
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                tbody.innerHTML = json.data.map(u => `
                    <tr>
                        <td>${u.user_id}</td>
                        <td>${u.name}</td>
                        <td>${u.username}</td>
                        <td>${u.is_admin ? 'ç®¡ç†å“¡' : 'å“¡å·¥'}</td>
                        <td><span class="status-badge status-active">å•Ÿç”¨</span></td>
                        <td><button class="btn btn-sm btn-secondary">ç·¨è¼¯</button></td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }

        // å‡æœŸç®¡ç†
        async function loadLeaves() {
            const tbody = document.querySelector('#leavesTable tbody');
            const status = document.getElementById('filterLeaveStatus').value;
            try {
                const url = status ? `/internal/api/v1/leaves?status=${status}` : '/internal/api/v1/leaves';
                const res = await fetch(url, { credentials: 'include' });
                const json = await res.json();
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                tbody.innerHTML = json.data.map(l => `
                    <tr>
                        <td>${l.leave_id}</td>
                        <td>${l.user_name}</td>
                        <td>${l.leave_type_name}</td>
                        <td>${l.start_date}</td>
                        <td>${l.end_date}</td>
                        <td>${l.status}</td>
                        <td><button class="btn btn-sm btn-secondary">å¯©æ ¸</button></td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }

        // æœåŠ¡ç”Ÿå‘½å‘¨æœŸ
        async function loadLifecycle() {
            const tbody = document.querySelector('#lifecycleTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
        }

        // è‡ªåŠ¨åŒ–è§„åˆ™
        async function loadAutomation() {
            const tbody = document.querySelector('#automationTable tbody');
            try {
                const res = await fetch('/internal/api/v1/automation/rules', { credentials: 'include' });
                const json = await res.json();
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                tbody.innerHTML = json.data.map(r => `
                    <tr>
                        <td>${r.rule_id}</td>
                        <td>${r.rule_name}</td>
                        <td>${r.trigger_event || '-'}</td>
                        <td>${r.is_active ? 'å•Ÿç”¨' : 'åœç”¨'}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="deleteRule(${r.rule_id})">åˆªé™¤</button></td>
                    </tr>
                `).join('');
          } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }
        async function deleteRule(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            await fetch('/internal/api/v1/automation/rules/' + id, { method: 'DELETE', credentials: 'include' });
            loadAutomation();
        }

        // å›½å®šå‡æ—¥
        let editingHolidayDate = null; // ç”¨æ–¼è¨˜éŒ„æ­£åœ¨ç·¨è¼¯çš„å‡æ—¥æ—¥æœŸ
        
        async function loadHolidays() {
            const tbody = document.querySelector('#holidaysTable tbody');
            const year = document.getElementById('filterYear').value || new Date().getFullYear();
            try {
                // æ§‹å»ºå¹´ä»½çš„é–‹å§‹å’ŒçµæŸæ—¥æœŸ
                const startDate = `${year}-01-01`;
                const endDate = `${year}-12-31`;
                const res = await fetch(`/internal/api/v1/holidays?start_date=${startDate}&end_date=${endDate}`, { credentials: 'include' });
                const json = await res.json();
                if (!json.data || json.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="loading">æš«ç„¡è³‡æ–™</td></tr>';
                    return;
                }
                tbody.innerHTML = json.data.map(h => {
                    // åˆ¤æ–·å‡æ—¥é¡å‹
                    let type = 'ä¸€èˆ¬å‡æ—¥';
                    if (h.is_national_holiday) type = 'åœ‹å®šå‡æ—¥';
                    else if (h.is_weekly_restday) type = 'ä¾‹å‡æ—¥';
                    else if (h.is_makeup_workday) type = 'è£œç­æ—¥';
                    
                    return `
                        <tr>
                            <td>${h.holiday_date}</td>
                            <td>${h.name || 'æœªå‘½å'}</td>
                            <td>${type}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick='editHoliday(${JSON.stringify(h)})'>ç·¨è¼¯</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteHoliday('${h.holiday_date}')">åˆªé™¤</button>
                            </td>
                        </tr>
                    `;
                }).join('');
          } catch (e) {
                console.error('è¼‰å…¥å‡æ—¥å¤±æ•—:', e);
                tbody.innerHTML = '<tr><td colspan="4" class="loading">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }
        
        function showAddHolidayForm() {
            editingHolidayDate = null;
            document.getElementById('holidayFormTitle').textContent = 'æ–°å¢å‡æ—¥';
            document.getElementById('holiday_date').value = '';
            document.getElementById('holiday_date').disabled = false;
            document.getElementById('holiday_name').value = '';
            document.getElementById('holiday_type').value = 'national';
            document.getElementById('holidayForm').classList.remove('hidden');
        }
        
        function editHoliday(holiday) {
            editingHolidayDate = holiday.holiday_date;
            document.getElementById('holidayFormTitle').textContent = 'ç·¨è¼¯å‡æ—¥';
            document.getElementById('holiday_date').value = holiday.holiday_date;
            document.getElementById('holiday_date').disabled = true; // ç·¨è¼¯æ™‚ä¸èƒ½ä¿®æ”¹æ—¥æœŸï¼ˆä¸»éµï¼‰
            document.getElementById('holiday_name').value = holiday.name || '';
            
            // è¨­ç½®é¡å‹
            if (holiday.is_national_holiday) {
                document.getElementById('holiday_type').value = 'national';
            } else if (holiday.is_weekly_restday) {
                document.getElementById('holiday_type').value = 'weekly';
            } else if (holiday.is_makeup_workday) {
                document.getElementById('holiday_type').value = 'makeup';
            }
            
            document.getElementById('holidayForm').classList.remove('hidden');
            document.getElementById('holidayForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelHolidayForm() {
            document.getElementById('holidayForm').classList.add('hidden');
            editingHolidayDate = null;
        }
        
        async function saveHoliday() {
            const date = document.getElementById('holiday_date').value;
            const name = document.getElementById('holiday_name').value;
            const type = document.getElementById('holiday_type').value;
            
            if (!date || !name) {
                alert('è«‹å¡«å¯«æ—¥æœŸå’Œåç¨±');
                return;
            }
            
            const holidayData = {
                holiday_date: date,
                name: name,
                is_national_holiday: type === 'national',
                is_weekly_restday: type === 'weekly',
                is_makeup_workday: type === 'makeup'
            };
            
            try {
                const method = editingHolidayDate ? 'PUT' : 'POST';
                const res = await fetch('/internal/api/v1/holidays', {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(holidayData)
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'æ“ä½œå¤±æ•—');
                }
                
                alert(editingHolidayDate ? 'æ›´æ–°æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
                cancelHolidayForm();
                loadHolidays();
            } catch (e) {
                console.error('å„²å­˜å‡æ—¥å¤±æ•—:', e);
                alert('å„²å­˜å¤±æ•—: ' + e.message);
            }
        }
        
        async function deleteHoliday(date) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${date} çš„å‡æ—¥å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const res = await fetch(`/internal/api/v1/holidays?holiday_date=${date}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'åˆªé™¤å¤±æ•—');
                }
                
                alert('åˆªé™¤æˆåŠŸ');
                loadHolidays();
            } catch (e) {
                console.error('åˆªé™¤å‡æ—¥å¤±æ•—:', e);
                alert('åˆªé™¤å¤±æ•—: ' + e.message);
            }
        }
        
        // æ‰¹é‡ä¸Šå‚³åŠŸèƒ½
        function showBatchUploadForm() {
            document.getElementById('batchUploadForm').classList.remove('hidden');
            document.getElementById('batchUploadForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelBatchUpload() {
            document.getElementById('batchUploadForm').classList.add('hidden');
            document.getElementById('csvFile').value = '';
            document.getElementById('csvText').value = '';
        }
        
        function toggleUploadMethod() {
            const method = document.querySelector('input[name="uploadMethod"]:checked').value;
            if (method === 'csv') {
                document.getElementById('csvUploadArea').style.display = 'block';
                document.getElementById('textUploadArea').style.display = 'none';
            } else {
                document.getElementById('csvUploadArea').style.display = 'none';
                document.getElementById('textUploadArea').style.display = 'block';
            }
        }
        
        function parseCSVLine(line) {
            const parts = line.split(',').map(p => p.trim());
            if (parts.length < 2) return null;
            
            const [date, name, typeStr] = parts;
            if (!date || !name) return null;
            
            // è§£æé¡å‹
            let is_national_holiday = false;
            let is_weekly_restday = false;
            let is_makeup_workday = false;
            
            if (typeStr) {
                const type = typeStr.trim();
                if (type.includes('åœ‹å®š') || type.includes('national')) {
                    is_national_holiday = true;
                } else if (type.includes('ä¾‹å‡') || type.includes('weekly')) {
                    is_weekly_restday = true;
                } else if (type.includes('è£œç­') || type.includes('makeup')) {
                    is_makeup_workday = true;
                } else {
                    is_national_holiday = true; // é»˜èªç‚ºåœ‹å®šå‡æ—¥
                }
            } else {
                is_national_holiday = true; // é»˜èªç‚ºåœ‹å®šå‡æ—¥
            }
            
            return {
                holiday_date: date,
                name: name,
                is_national_holiday,
                is_weekly_restday,
                is_makeup_workday
            };
        }
        
        async function processBatchUpload() {
            const method = document.querySelector('input[name="uploadMethod"]:checked').value;
            let csvContent = '';
            
            if (method === 'csv') {
                const fileInput = document.getElementById('csvFile');
                if (!fileInput.files || !fileInput.files[0]) {
                    alert('è«‹é¸æ“‡ CSV æª”æ¡ˆ');
                    return;
                }
                
                try {
                    csvContent = await fileInput.files[0].text();
                } catch (e) {
                    alert('è®€å–æª”æ¡ˆå¤±æ•—');
                    return;
                }
            } else {
                csvContent = document.getElementById('csvText').value;
            }
            
            if (!csvContent.trim()) {
                alert('è«‹è¼¸å…¥å…§å®¹');
                return;
            }
            
            // è§£æ CSV
            const lines = csvContent.split('\n').filter(line => line.trim());
            const holidays = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // è·³éæ¨™é¡Œè¡Œï¼ˆå¦‚æœæœ‰ï¼‰
                if (i === 0 && (line.includes('æ—¥æœŸ') || line.includes('date'))) {
                    continue;
                }
                
                const holiday = parseCSVLine(line);
                if (holiday) {
                    holidays.push(holiday);
                }
            }
            
            if (holidays.length === 0) {
                alert('æ²’æœ‰æœ‰æ•ˆçš„å‡æ—¥è³‡æ–™');
                return;
            }
            
            if (!confirm(`å³å°‡ä¸Šå‚³ ${holidays.length} ç­†å‡æ—¥è³‡æ–™ï¼Œç¢ºå®šç¹¼çºŒï¼Ÿ`)) {
                return;
            }
            
            try {
                const res = await fetch('/internal/api/v1/holidays', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(holidays)
                });
                
                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.message || 'ä¸Šå‚³å¤±æ•—');
                }
                
                let message = json.message || 'ä¸Šå‚³æˆåŠŸ';
                if (json.data && json.data.errors && json.data.errors.length > 0) {
                    message += '\n\néƒ¨åˆ†éŒ¯èª¤ï¼š\n' + json.data.errors.join('\n');
                }
                
                alert(message);
                cancelBatchUpload();
                loadHolidays();
            } catch (e) {
                console.error('æ‰¹é‡ä¸Šå‚³å¤±æ•—:', e);
                alert('æ‰¹é‡ä¸Šå‚³å¤±æ•—: ' + e.message);
            }
        }

        // ç™»å‡º
        async function logout() {
            if (!confirm('ç¢ºå®šç™»å‡ºï¼Ÿ')) return;
            await fetch('/internal/api/v1/auth/logout', { method: 'POST', credentials: 'include' });
            window.location.href = '/login.html';
        }

        // Tab åˆ‡æ¢åŠŸèƒ½
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰ active class
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            
            // æ·»åŠ  active class
            const targetBtn = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
            const targetPanel = document.getElementById(`tab-${tabName}`);
            
            if (targetBtn) targetBtn.classList.add('active');
            if (targetPanel) targetPanel.classList.add('active');
            
            // æ ¹æ®tabåŠ è½½å¯¹åº”æ•°æ®
            switch(tabName) {
                case 'services':
                    loadServices();
                    break;
                case 'templates':
                    loadTemplates();
                    loadTemplateOptions();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'leaves':
                    loadLeaves();
                    break;
                case 'automation':
                    loadAutomation();
                    break;
                case 'holidays':
                    loadHolidays();
                    break;
            }
        }
        
        // ç»‘å®šæ‰€æœ‰tabæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        // åˆå§‹åŒ–
        (async () => {
            const res = await fetch('/internal/api/v1/auth/me', { credentials: 'include' });
            if (!res.ok) {
                document.getElementById('permBar').style.display = 'block';
                return;
            }
            // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªtabçš„æ•°æ®
            switchTab('services');
        })();
    </script>
  </body>
  </html>
