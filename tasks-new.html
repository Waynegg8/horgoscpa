<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新增任務 - 內部系統</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <style>
    .form-section {
      background: white;
      padding: 24px;
      margin-bottom: 0;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .form-section:last-of-type {
      border-bottom: none;
    }
    
    .form-section-title {
      font-size: 15px;
      font-weight: 600;
      color: #475569;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f1f5f9;
    }
    
    .form-section-title .material-symbols-outlined {
      font-size: 20px;
      color: var(--primary-color);
    }
    
    .field-hint {
      font-size: 12px;
      color: #64748b;
      margin-top: 6px;
      display: flex;
      align-items: flex-start;
      gap: 4px;
      line-height: 1.5;
    }
    
    .field-hint .material-symbols-outlined {
      font-size: 16px;
      margin-top: 1px;
    }
    
    .alert-warning {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    
    .alert-warning .material-symbols-outlined {
      color: #d97706;
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .alert-warning-content {
      flex: 1;
    }
    
    .alert-warning-title {
      font-weight: 600;
      color: #92400e;
      margin-bottom: 4px;
    }
    
    .alert-warning-text {
      font-size: 14px;
      color: #78350f;
    }
    
    #adjustment_reason_section {
      padding: 24px;
      border-bottom: 1px solid #f1f5f9;
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    
    .content-card {
      border-radius: 8px;
      background: white;
    }
    
    label {
      font-weight: 600;
      color: #334155;
      font-size: 14px;
    }
    
    label .required-mark {
      color: #dc2626;
      margin-left: 2px;
    }
    
    input[type="text"],
    input[type="date"],
    input[type="month"],
    select,
    textarea {
      font-size: 14px;
    }
    
    .form-actions {
      padding: 20px 24px;
      background: #f8fafc;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container" style="max-width: 1200px; padding: 20px;">
    <div class="content-card" style="box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid #e5e7eb;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <a href="/internal/tasks" style="color: #64748b; text-decoration: none; display: flex; align-items: center; gap: 4px; font-size: 14px; transition: color 0.2s;" onmouseover="this.style.color='#2c5f7c'" onmouseout="this.style.color='#64748b'">
            <span style="font-size: 18px;">←</span> 返回
          </a>
          <div style="width: 1px; height: 20px; background: #e5e7eb;"></div>
          <h1 style="margin: 0; font-size: 20px; font-weight: 600; color: #1e293b;">新增任務</h1>
        </div>
      </div>

      <form id="taskForm" onsubmit="submitTask(event)">
        <!-- 基本資訊 -->
        <div class="form-section">
          <div class="form-section-title">
            <span class="material-symbols-outlined">info</span>
            基本資訊
          </div>
          
          <div class="form-row-2col">
            <div class="form-field">
              <label for="client_service_id">客戶服務 <span class="required-mark">*</span></label>
              <select id="client_service_id" required>
                <option value="">載入中...</option>
              </select>
              <div class="field-hint">
                <span class="material-symbols-outlined">help</span>
                選擇要執行任務的客戶和服務類型
              </div>
            </div>
            <div class="form-field">
              <label for="assignee_user_id">負責人</label>
              <select id="assignee_user_id">
                <option value="">未分配</option>
              </select>
              <div class="field-hint">
                <span class="material-symbols-outlined">help</span>
                可稍後再指派負責人
              </div>
            </div>
          </div>

          <div class="form-row-1col">
            <div class="form-field">
              <label for="task_name">任務名稱 <span class="required-mark">*</span></label>
              <input type="text" id="task_name" required maxlength="200" placeholder="例如：11月份記帳服務" />
              <div class="field-hint">
                <span class="material-symbols-outlined">help</span>
                清楚描述任務內容，最多200字
              </div>
            </div>
          </div>
        </div>

        <!-- 時間設定 -->
        <div class="form-section">
          <div class="form-section-title">
            <span class="material-symbols-outlined">schedule</span>
            時間設定
          </div>
          
          <div class="form-row-2col">
            <div class="form-field">
              <label for="service_month">服務月份 <span class="required-mark">*</span></label>
              <input type="month" id="service_month" required />
              <div class="field-hint">
                <span class="material-symbols-outlined">help</span>
                此任務對應的服務月份
              </div>
            </div>
            <div class="form-field">
              <label for="due_date">到期日</label>
              <input type="date" id="due_date" />
              <input type="hidden" id="default_due_date" />
              <div class="field-hint" id="due_date_hint">
                <span class="material-symbols-outlined">help</span>
                系統預設到期日將根據服務自動計算
              </div>
            </div>
          </div>
        </div>

        <!-- 調整原因區（條件顯示） -->
        <div id="adjustment_reason_section" style="display:none;">
          <div class="alert-warning">
            <span class="material-symbols-outlined">warning</span>
            <div class="alert-warning-content">
              <div class="alert-warning-title">您修改了系統預設的到期日</div>
              <div class="alert-warning-text">請說明調整原因，這有助於追蹤客戶的特殊需求或任務複雜度</div>
            </div>
          </div>
          <div class="form-field">
            <label for="adjustment_reason">調整原因 <span class="required-mark">*</span></label>
            <textarea id="adjustment_reason" rows="3" placeholder="例如：該客戶帳務複雜需額外處理時間，或客戶要求提前完成..."></textarea>
          </div>
        </div>

        <!-- 備註 -->
        <div class="form-section">
          <div class="form-section-title">
            <span class="material-symbols-outlined">notes</span>
            任務備註（可選）
          </div>
          
          <div class="form-row-1col">
            <div class="form-field">
              <label for="task_notes">備註說明</label>
              <textarea id="task_notes" rows="3" placeholder="輸入任何需要記錄的額外資訊，例如：特殊要求、注意事項等..."></textarea>
              <div class="field-hint">
                <span class="material-symbols-outlined">help</span>
                記錄這個任務的特殊說明或注意事項
              </div>
            </div>
          </div>
        </div>

      </form>
      
      <div class="form-actions">
        <button type="button" onclick="window.location.href='/internal/tasks'" class="btn btn-secondary">取消</button>
        <button type="submit" form="taskForm" class="btn btn-primary">✓ 建立任務</button>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script src="/assets/js/components/bootstrap.js?v=3"></script>
  <script>
    const onProdHost = location.hostname.endsWith('horgoscpa.com');
    const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
    
    let clientServices = [];
    let defaultDueDate = null;
    
    async function init() {
      // 設定當前月份為默認值
      const now = new Date();
      const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('service_month').value = yearMonth;
      
      // 載入客戶服務列表
      await loadClientServices();
      
      // 載入用戶列表
      await loadUsers();
      
      // 設定監聽器
      document.getElementById('due_date').addEventListener('change', checkDueDateChange);
      document.getElementById('client_service_id').addEventListener('change', calculateDefaultDueDate);
      document.getElementById('service_month').addEventListener('change', calculateDefaultDueDate);
    }
    
    
    async function loadClientServices() {
      try {
        const res = await fetch(`${apiBase}/client-services`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        const select = document.getElementById('client_service_id');
        if (json.ok && Array.isArray(json.data)) {
          clientServices = json.data;
          select.innerHTML = '<option value="">請選擇客戶服務</option>' + 
            clientServices.map(cs => `<option value="${cs.client_service_id}">${cs.client_name} - ${cs.service_name || '未指定服務'}</option>`).join('');
        }
      } catch (err) {
        console.error('載入客戶服務失敗:', err);
      }
    }
    
    async function loadUsers() {
      try {
        const res = await fetch(`${apiBase}/users`, { credentials: 'include' });
        if (res.status === 401) return;
        const json = await res.json();
        
        const select = document.getElementById('assignee_user_id');
        if (json.ok && Array.isArray(json.data)) {
          select.innerHTML = '<option value="">未分配</option>' + 
            json.data.map(u => `<option value="${u.user_id}">${u.name}</option>`).join('');
        }
      } catch (err) {
        console.error('載入用戶失敗:', err);
      }
    }
    
    function calculateDefaultDueDate() {
      // 簡化實現：預設為當月最後一天
      const serviceMonth = document.getElementById('service_month').value;
      if (!serviceMonth) return;
      
      const [year, month] = serviceMonth.split('-').map(Number);
      const lastDay = new Date(year, month, 0).getDate();
      defaultDueDate = `${year}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
      
      document.getElementById('default_due_date').value = defaultDueDate;
      const hintElement = document.getElementById('due_date_hint');
      hintElement.innerHTML = `<span class="material-symbols-outlined">help</span> 系統預設：${defaultDueDate}`;
      
      // 如果還沒設定到期日，自動填入
      if (!document.getElementById('due_date').value) {
        document.getElementById('due_date').value = defaultDueDate;
      }
    }
    
    function checkDueDateChange() {
      const dueDate = document.getElementById('due_date').value;
      const defaultDate = document.getElementById('default_due_date').value;
      
      const section = document.getElementById('adjustment_reason_section');
      const reasonField = document.getElementById('adjustment_reason');
      
      // 如果修改了預設期限，顯示原因欄位並設為必填
      if (defaultDate && dueDate && dueDate !== defaultDate) {
        section.style.display = 'block';
        reasonField.required = true;
      } else {
        section.style.display = 'none';
        reasonField.required = false;
      }
    }
    
    
    async function submitTask(event) {
      event.preventDefault();
      
      const dueDate = document.getElementById('due_date').value;
      const defaultDate = document.getElementById('default_due_date').value;
      const adjustmentReason = document.getElementById('adjustment_reason').value.trim();
      
      // 檢查是否需要填寫原因
      if (defaultDate && dueDate && dueDate !== defaultDate && !adjustmentReason) {
        alert('您修改了預設期限，必須填寫調整原因');
        return;
      }
      
      const data = {
        client_service_id: parseInt(document.getElementById('client_service_id').value),
        task_name: document.getElementById('task_name').value.trim(),
        service_month: document.getElementById('service_month').value,
        due_date: dueDate || null,
        assignee_user_id: document.getElementById('assignee_user_id').value ? parseInt(document.getElementById('assignee_user_id').value) : null,
        notes: document.getElementById('task_notes').value.trim() || null
      };
      
      // 如果調整了期限，添加相關欄位
      if (defaultDate && dueDate && dueDate !== defaultDate && adjustmentReason) {
        data.default_due_date = defaultDate;
        data.adjustment_reason = adjustmentReason;
      }
      
      try {
        const res = await fetch(`${apiBase}/tasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '建立失敗');
          return;
        }
        
        alert('任務已建立');
        window.location.href = '/internal/tasks';
        
      } catch (err) {
        console.error('建立任務失敗:', err);
        alert('建立失敗');
      }
    }
    
    // 初始化
    init();
  </script>
</body>
</html>
