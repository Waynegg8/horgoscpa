<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新增任務 - 內部系統</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <style>
    .form-section {
      background: white;
      padding: 24px;
      margin-bottom: 0;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .form-section:last-of-type {
      border-bottom: none;
    }
    
    .form-section-title {
      font-size: 15px;
      font-weight: 600;
      color: #475569;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f1f5f9;
    }
    
    .form-section-title .material-symbols-outlined {
      font-size: 20px;
      color: var(--primary-color);
    }
    
    .field-hint {
      font-size: 12px;
      color: #64748b;
      margin-top: 6px;
      display: flex;
      align-items: flex-start;
      gap: 4px;
      line-height: 1.5;
    }
    
    .field-hint .material-symbols-outlined {
      font-size: 16px;
      margin-top: 1px;
    }
    
    .alert-warning {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    
    .alert-warning .material-symbols-outlined {
      color: #d97706;
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .alert-warning-content {
      flex: 1;
    }
    
    .alert-warning-title {
      font-weight: 600;
      color: #92400e;
      margin-bottom: 4px;
    }
    
    .alert-warning-text {
      font-size: 14px;
      color: #78350f;
    }
    
    #adjustment_reason_section {
      padding: 24px;
      border-bottom: 1px solid #f1f5f9;
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    
    .content-card {
      border-radius: 8px;
      background: white;
    }
    
    .task-card {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      position: relative;
    }
    
    .task-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .task-number {
      font-weight: 600;
      color: var(--primary-color);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .task-card-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn-move-up, .btn-move-down, .btn-remove-task {
      padding: 4px 8px;
      border: 1px solid #cbd5e1;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .btn-move-up:hover, .btn-move-down:hover {
      background: #f1f5f9;
      border-color: var(--primary-color);
      color: var(--primary-color);
    }
    
    .btn-remove-task {
      color: #dc2626;
      border-color: #fecaca;
    }
    
    .btn-remove-task:hover {
      background: #fef2f2;
      border-color: #dc2626;
    }
    
    .btn-add-task {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: white;
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 500;
    }
    
    .btn-add-task:hover {
      background: #f1f5f9;
      border-color: var(--primary-color);
      color: var(--primary-color);
    }
    
    .task-card input,
    .task-card select {
      font-size: 14px;
    }
    
    label {
      font-weight: 600;
      color: #334155;
      font-size: 14px;
    }
    
    label .required-mark {
      color: #dc2626;
      margin-left: 2px;
    }
    
    input[type="text"],
    input[type="date"],
    input[type="month"],
    select,
    textarea {
      font-size: 14px;
    }
    
    .form-actions {
      padding: 20px 24px;
      background: #f8fafc;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container" style="max-width: 1200px; padding: 20px;">
    <div class="content-card" style="box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid #e5e7eb;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <a href="/internal/tasks" style="color: #64748b; text-decoration: none; display: flex; align-items: center; gap: 4px; font-size: 14px; transition: color 0.2s;" onmouseover="this.style.color='#2c5f7c'" onmouseout="this.style.color='#64748b'">
            <span style="font-size: 18px;">←</span> 返回
          </a>
          <div style="width: 1px; height: 20px; background: #e5e7eb;"></div>
          <h1 style="margin: 0; font-size: 20px; font-weight: 600; color: #1e293b;">新增任務</h1>
        </div>
      </div>

      <form id="taskForm" onsubmit="submitTasks(event)">
        <!-- 基本資訊 -->
        <div class="form-section">
          <div class="form-section-title">
            <span class="material-symbols-outlined">info</span>
            基本資訊
          </div>
          
          <div class="form-row-1col">
            <div class="form-field">
              <label for="client_service_id">客戶服務 <span class="required-mark">*</span></label>
              <select id="client_service_id" required>
                <option value="">載入中...</option>
              </select>
              <div class="field-hint">
                <span class="material-symbols-outlined">help</span>
                選擇要執行任務的客戶和服務類型
              </div>
            </div>
          </div>
        </div>

        <!-- 服務月份 -->
        <div class="form-section">
          <div class="form-section-title">
            <span class="material-symbols-outlined">schedule</span>
            服務月份
          </div>
          
          <div class="form-row-1col">
            <div class="form-field">
              <label for="service_month">服務月份 <span class="required-mark">*</span></label>
              <input type="month" id="service_month" required />
              <div class="field-hint">
                <span class="material-symbols-outlined">help</span>
                所有任務都將使用此服務月份
              </div>
            </div>
          </div>
        </div>

        <!-- 任務列表 -->
        <div class="form-section" style="border-bottom: none;">
          <div class="form-section-title">
            <span class="material-symbols-outlined">list</span>
            任務列表
          </div>
          
          <div id="tasks_container" style="display: flex; flex-direction: column; gap: 16px;">
            <!-- 任務項目將動態添加 -->
          </div>
          
          <button type="button" onclick="addTask()" class="btn-add-task" style="margin-top: 16px;">
            <span class="material-symbols-outlined">add</span>
            添加任務
          </button>
          
          <div class="field-hint" style="margin-top: 12px;">
            <span class="material-symbols-outlined">help</span>
            任務將按照順序執行，每個任務完成後才能開始下一個
          </div>
        </div>

      </form>
      
      <div class="form-actions">
        <button type="button" onclick="window.location.href='/internal/tasks'" class="btn btn-secondary">取消</button>
        <button type="submit" form="taskForm" class="btn btn-primary">✓ 建立所有任務</button>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script src="/assets/js/components/bootstrap.js?v=3"></script>
  <script>
    const onProdHost = location.hostname.endsWith('horgoscpa.com');
    const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
    
    let clientServices = [];
    let users = [];
    let taskCounter = 0;
    
    async function init() {
      // 設定當前月份為默認值
      const now = new Date();
      const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('service_month').value = yearMonth;
      
      // 載入客戶服務列表
      await loadClientServices();
      
      // 載入用戶列表
      await loadUsers();
      
      // 添加第一個任務
      addTask();
    }
    
    
    async function loadClientServices() {
      try {
        const res = await fetch(`${apiBase}/client-services`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        const select = document.getElementById('client_service_id');
        if (json.ok && Array.isArray(json.data)) {
          clientServices = json.data;
          select.innerHTML = '<option value="">請選擇客戶服務</option>' + 
            clientServices.map(cs => `<option value="${cs.client_service_id}">${cs.client_name} - ${cs.service_name || '未指定服務'}</option>`).join('');
        }
      } catch (err) {
        console.error('載入客戶服務失敗:', err);
      }
    }
    
    async function loadUsers() {
      try {
        const res = await fetch(`${apiBase}/users`, { credentials: 'include' });
        if (res.status === 401) return;
        const json = await res.json();
        
        if (json.ok && Array.isArray(json.data)) {
          users = json.data;
        }
      } catch (err) {
        console.error('載入用戶失敗:', err);
      }
    }
    
    function addTask() {
      taskCounter++;
      const container = document.getElementById('tasks_container');
      const taskId = `task_${taskCounter}`;
      
      // 計算預設到期日
      const serviceMonth = document.getElementById('service_month').value;
      let defaultDueDate = '';
      if (serviceMonth) {
        const [year, month] = serviceMonth.split('-').map(Number);
        const lastDay = new Date(year, month, 0).getDate();
        defaultDueDate = `${year}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
      }
      
      const userOptions = '<option value="">未分配</option>' + users.map(u => `<option value="${u.user_id}">${u.name}</option>`).join('');
      
      const taskCard = document.createElement('div');
      taskCard.className = 'task-card';
      taskCard.dataset.taskId = taskId;
      taskCard.innerHTML = `
        <div class="task-card-header">
          <div class="task-number">
            <span class="material-symbols-outlined" style="font-size: 18px;">task</span>
            任務 <span class="task-order">1</span>
          </div>
          <div class="task-card-actions">
            <button type="button" class="btn-move-up" onclick="moveTaskUp('${taskId}')" title="上移">↑</button>
            <button type="button" class="btn-move-down" onclick="moveTaskDown('${taskId}')" title="下移">↓</button>
            <button type="button" class="btn-remove-task" onclick="removeTask('${taskId}')" title="刪除">✕</button>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px; margin-bottom: 12px;">
          <div class="form-field">
            <label style="font-size: 13px;">任務名稱 <span class="required-mark">*</span></label>
            <input type="text" name="task_name" required placeholder="例如：收集憑證" />
          </div>
          <div class="form-field">
            <label style="font-size: 13px;">負責人</label>
            <select name="assignee">${userOptions}</select>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">
          <div class="form-field">
            <label style="font-size: 13px;">到期日</label>
            <input type="date" name="due_date" value="${defaultDueDate}" />
          </div>
          <div class="form-field">
            <label style="font-size: 13px;">備註</label>
            <input type="text" name="notes" placeholder="選填" />
          </div>
        </div>
      `;
      
      container.appendChild(taskCard);
      updateTaskNumbers();
    }
    
    function removeTask(taskId) {
      const card = document.querySelector(`[data-task-id="${taskId}"]`);
      if (card) {
        const container = document.getElementById('tasks_container');
        if (container.children.length <= 1) {
          alert('至少需要一個任務');
          return;
        }
        card.remove();
        updateTaskNumbers();
      }
    }
    
    function moveTaskUp(taskId) {
      const card = document.querySelector(`[data-task-id="${taskId}"]`);
      if (card && card.previousElementSibling) {
        card.parentNode.insertBefore(card, card.previousElementSibling);
        updateTaskNumbers();
      }
    }
    
    function moveTaskDown(taskId) {
      const card = document.querySelector(`[data-task-id="${taskId}"]`);
      if (card && card.nextElementSibling) {
        card.parentNode.insertBefore(card.nextElementSibling, card);
        updateTaskNumbers();
      }
    }
    
    function updateTaskNumbers() {
      const cards = document.querySelectorAll('.task-card');
      cards.forEach((card, index) => {
        const orderSpan = card.querySelector('.task-order');
        if (orderSpan) {
          orderSpan.textContent = index + 1;
        }
        
        // 更新按鈕狀態
        const upBtn = card.querySelector('.btn-move-up');
        const downBtn = card.querySelector('.btn-move-down');
        upBtn.disabled = index === 0;
        downBtn.disabled = index === cards.length - 1;
        upBtn.style.opacity = index === 0 ? '0.3' : '1';
        downBtn.style.opacity = index === cards.length - 1 ? '0.3' : '1';
      });
    }
    
    
    async function submitTasks(event) {
      event.preventDefault();
      
      const clientServiceId = parseInt(document.getElementById('client_service_id').value);
      const serviceMonth = document.getElementById('service_month').value;
      
      // 收集所有任務
      const taskCards = document.querySelectorAll('.task-card');
      const tasks = [];
      let previousTaskId = null;
      
      for (const card of taskCards) {
        const taskName = card.querySelector('[name="task_name"]').value.trim();
        const assigneeSelect = card.querySelector('[name="assignee"]');
        const assigneeUserId = assigneeSelect.value ? parseInt(assigneeSelect.value) : null;
        const dueDate = card.querySelector('[name="due_date"]').value || null;
        const notes = card.querySelector('[name="notes"]').value.trim() || null;
        
        if (!taskName) {
          alert('請填寫所有任務名稱');
          return;
        }
        
        tasks.push({
          task_name: taskName,
          assignee_user_id: assigneeUserId,
          due_date: dueDate,
          notes: notes,
          prerequisite_task_id: previousTaskId
        });
        
        // 暫存當前任務ID的占位符，實際ID會在創建後獲得
        previousTaskId = 'PREVIOUS';
      }
      
      try {
        // 按順序創建任務，並設置前置任務關係
        let actualPreviousTaskId = null;
        let createdCount = 0;
        
        for (const taskData of tasks) {
          const data = {
            client_service_id: clientServiceId,
            service_month: serviceMonth,
            task_name: taskData.task_name,
            due_date: taskData.due_date,
            assignee_user_id: taskData.assignee_user_id,
            notes: taskData.notes,
            prerequisite_task_id: actualPreviousTaskId
          };
          
          const res = await fetch(`${apiBase}/tasks`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
          });
          
          if (res.status === 401) {
            window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
            return;
          }
          
          const json = await res.json();
          
          if (!json.ok) {
            alert(`建立第 ${createdCount + 1} 個任務失敗: ${json.message || '未知錯誤'}`);
            if (createdCount > 0) {
              alert(`已成功建立 ${createdCount} 個任務`);
            }
            return;
          }
          
          // 保存剛創建的任務ID，作為下一個任務的前置任務
          actualPreviousTaskId = json.data.taskId;
          createdCount++;
        }
        
        alert(`成功建立 ${createdCount} 個任務！`);
        window.location.href = '/internal/tasks';
        
      } catch (err) {
        console.error('建立任務失敗:', err);
        alert('建立失敗：' + err.message);
      }
    }
    
    // 初始化
    init();
  </script>
</body>
</html>
