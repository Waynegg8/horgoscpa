<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新增任務 - 內部系統</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container">
    <div class="page-header-simple">
      <a href="/internal/tasks" class="back-link">← 返回任務列表</a>
      <h1 class="page-title">新增任務</h1>
    </div>

    <div class="content-card">
      <form id="taskForm" onsubmit="submitTask(event)">
        <div class="form-row-2col">
          <div class="form-field">
            <label for="client_service_id">客戶服務 *</label>
            <select id="client_service_id" required>
              <option value="">載入中...</option>
            </select>
          </div>
          <div class="form-field">
            <label for="assignee_user_id">負責人</label>
            <select id="assignee_user_id">
              <option value="">未分配</option>
            </select>
          </div>
        </div>

        <div class="form-row-1col">
          <div class="form-field">
            <label for="task_name">任務名稱 *</label>
            <input type="text" id="task_name" required maxlength="200" />
          </div>
        </div>

        <div class="form-row-2col">
          <div class="form-field">
            <label for="service_month">服務月份 *</label>
            <input type="month" id="service_month" required />
          </div>
          <div class="form-field">
            <label for="due_date">到期日</label>
            <input type="date" id="due_date" />
            <input type="hidden" id="default_due_date" />
            <p style="font-size:12px;color:#6b7280;margin-top:4px;" id="due_date_hint">系統預設到期日將根據服務自動計算</p>
          </div>
        </div>

        <div id="adjustment_reason_section" style="margin-bottom:20px;display:none;">
          <div class="form-field">
            <label for="adjustment_reason" style="color:#dc2626;">調整原因 *（您修改了預設期限）</label>
            <textarea id="adjustment_reason" rows="3" placeholder="請說明為何此任務的期限與系統預設不同，這有助於了解客戶的難度..." style="border-color:#dc2626;"></textarea>
            <p style="font-size:12px;color:#6b7280;margin-top:4px;">提示：說明客戶的特殊需求或複雜度，例如「該客戶帳務複雜需額外處理時間」</p>
          </div>
        </div>

        <div class="form-row-2col">
          <div class="form-field">
            <label for="prerequisite_task_id">前置任務（可選）</label>
            <select id="prerequisite_task_id">
              <option value="">無前置任務</option>
            </select>
            <p style="font-size:12px;color:#6b7280;margin-top:4px;">選擇必須先完成的任務</p>
          </div>
          <div class="form-field">
            <label>任務階段（可選）</label>
            <div id="stages_container">
              <input type="text" class="stage_input" placeholder="階段 1" style="margin-bottom:8px;" />
              <button type="button" onclick="addStage()" class="btn btn-sm btn-secondary">+ 添加階段</button>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" onclick="window.location.href='/internal/tasks'" class="btn btn-secondary">取消</button>
          <button type="submit" class="btn btn-primary">建立任務</button>
        </div>
      </form>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script src="/assets/js/components/bootstrap.js?v=3"></script>
  <script>
    const onProdHost = location.hostname.endsWith('horgoscpa.com');
    const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
    
    let clientServices = [];
    let defaultDueDate = null;
    
    async function init() {
      // 設定當前月份為默認值
      const now = new Date();
      const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('service_month').value = yearMonth;
      
      // 載入客戶服務列表
      await loadClientServices();
      
      // 載入用戶列表
      await loadUsers();
      
      // 載入前置任務選項
      await loadPrerequisiteTasks();
      
      // 設定監聽器
      document.getElementById('due_date').addEventListener('change', checkDueDateChange);
      document.getElementById('client_service_id').addEventListener('change', calculateDefaultDueDate);
      document.getElementById('service_month').addEventListener('change', calculateDefaultDueDate);
    }
    
    async function loadPrerequisiteTasks() {
      try {
        // 載入未完成的任務作為前置任務選項
        const res = await fetch(`${apiBase}/tasks?status=pending,in_progress&limit=100`, { credentials: 'include' });
        if (res.status === 401) return;
        const json = await res.json();
        
        const select = document.getElementById('prerequisite_task_id');
        if (json.ok && Array.isArray(json.data)) {
          select.innerHTML = '<option value="">無前置任務</option>' + 
            json.data.map(t => `<option value="${t.taskId}">${t.taskName} (${t.dueDate || '未設定期限'})</option>`).join('');
        }
      } catch (err) {
        console.error('載入前置任務失敗:', err);
      }
    }
    
    async function loadClientServices() {
      try {
        const res = await fetch(`${apiBase}/client-services`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        const select = document.getElementById('client_service_id');
        if (json.ok && Array.isArray(json.data)) {
          clientServices = json.data;
          select.innerHTML = '<option value="">請選擇客戶服務</option>' + 
            clientServices.map(cs => `<option value="${cs.client_service_id}">${cs.client_name} - ${cs.service_name || '未指定服務'}</option>`).join('');
        }
      } catch (err) {
        console.error('載入客戶服務失敗:', err);
      }
    }
    
    async function loadUsers() {
      try {
        const res = await fetch(`${apiBase}/users`, { credentials: 'include' });
        if (res.status === 401) return;
        const json = await res.json();
        
        const select = document.getElementById('assignee_user_id');
        if (json.ok && Array.isArray(json.data)) {
          select.innerHTML = '<option value="">未分配</option>' + 
            json.data.map(u => `<option value="${u.user_id}">${u.name}</option>`).join('');
        }
      } catch (err) {
        console.error('載入用戶失敗:', err);
      }
    }
    
    function calculateDefaultDueDate() {
      // 簡化實現：預設為當月最後一天
      const serviceMonth = document.getElementById('service_month').value;
      if (!serviceMonth) return;
      
      const [year, month] = serviceMonth.split('-').map(Number);
      const lastDay = new Date(year, month, 0).getDate();
      defaultDueDate = `${year}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
      
      document.getElementById('default_due_date').value = defaultDueDate;
      document.getElementById('due_date_hint').textContent = `系統預設：${defaultDueDate}`;
      
      // 如果還沒設定到期日，自動填入
      if (!document.getElementById('due_date').value) {
        document.getElementById('due_date').value = defaultDueDate;
      }
    }
    
    function checkDueDateChange() {
      const dueDate = document.getElementById('due_date').value;
      const defaultDate = document.getElementById('default_due_date').value;
      
      const section = document.getElementById('adjustment_reason_section');
      const reasonField = document.getElementById('adjustment_reason');
      
      // 如果修改了預設期限，顯示原因欄位並設為必填
      if (defaultDate && dueDate && dueDate !== defaultDate) {
        section.style.display = 'block';
        reasonField.required = true;
      } else {
        section.style.display = 'none';
        reasonField.required = false;
      }
    }
    
    function addStage() {
      const container = document.getElementById('stages_container');
      const stageCount = container.querySelectorAll('.stage_input').length + 1;
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'stage_input';
      input.placeholder = `階段 ${stageCount}`;
      input.style.marginBottom = '8px';
      container.insertBefore(input, container.lastElementChild);
    }
    
    async function submitTask(event) {
      event.preventDefault();
      
      const dueDate = document.getElementById('due_date').value;
      const defaultDate = document.getElementById('default_due_date').value;
      const adjustmentReason = document.getElementById('adjustment_reason').value.trim();
      
      // 檢查是否需要填寫原因
      if (defaultDate && dueDate && dueDate !== defaultDate && !adjustmentReason) {
        alert('您修改了預設期限，必須填寫調整原因');
        return;
      }
      
      // 收集階段名稱
      const stageInputs = document.querySelectorAll('.stage_input');
      const stageNames = Array.from(stageInputs)
        .map(input => input.value.trim())
        .filter(name => name.length > 0);
      
      const data = {
        client_service_id: parseInt(document.getElementById('client_service_id').value),
        task_name: document.getElementById('task_name').value.trim(),
        service_month: document.getElementById('service_month').value,
        due_date: dueDate || null,
        assignee_user_id: document.getElementById('assignee_user_id').value ? parseInt(document.getElementById('assignee_user_id').value) : null,
        prerequisite_task_id: document.getElementById('prerequisite_task_id').value ? parseInt(document.getElementById('prerequisite_task_id').value) : null,
        stage_names: stageNames
      };
      
      // 如果調整了期限，添加相關欄位
      if (defaultDate && dueDate && dueDate !== defaultDate && adjustmentReason) {
        data.default_due_date = defaultDate;
        data.adjustment_reason = adjustmentReason;
      }
      
      try {
        const res = await fetch(`${apiBase}/tasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '建立失敗');
          return;
        }
        
        alert('任務已建立');
        window.location.href = '/internal/tasks';
        
      } catch (err) {
        console.error('建立任務失敗:', err);
        alert('建立失敗');
      }
    }
    
    // 初始化
    init();
  </script>
</body>
</html>
