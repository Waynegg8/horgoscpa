<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°å¢ä»»å‹™ - å…§éƒ¨ç³»çµ±</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <style>
    .form-section {
      background: #f8fafc;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid #e2e8f0;
    }
    
    .form-section-title {
      font-size: 16px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-section-title .material-symbols-outlined {
      font-size: 22px;
      color: var(--primary-color);
    }
    
    .field-hint {
      font-size: 12px;
      color: #64748b;
      margin-top: 6px;
      display: flex;
      align-items: flex-start;
      gap: 4px;
      line-height: 1.5;
    }
    
    .field-hint .material-symbols-outlined {
      font-size: 16px;
      margin-top: 1px;
    }
    
    .alert-warning {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    
    .alert-warning .material-symbols-outlined {
      color: #d97706;
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .alert-warning-content {
      flex: 1;
    }
    
    .alert-warning-title {
      font-weight: 600;
      color: #92400e;
      margin-bottom: 4px;
    }
    
    .alert-warning-text {
      font-size: 14px;
      color: #78350f;
    }
    
    #adjustment_reason_section {
      margin-bottom: 24px;
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .stages-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .stage-input-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stage-input-wrapper input {
      flex: 1;
    }
    
    .btn-remove-stage {
      padding: 6px;
      background: #fee;
      border: 1px solid #fcc;
      border-radius: 6px;
      cursor: pointer;
      color: #c00;
      transition: all 0.2s;
    }
    
    .btn-remove-stage:hover {
      background: #fcc;
    }
    
    .btn-add-stage {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: white;
      border: 1px dashed #cbd5e1;
      border-radius: 8px;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    
    .btn-add-stage:hover {
      background: #f1f5f9;
      border-color: var(--primary-color);
      color: var(--primary-color);
    }
    
    .page-intro {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .page-intro h2 {
      font-size: 20px;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .page-intro p {
      font-size: 14px;
      opacity: 0.95;
      margin: 0;
    }
    
    label {
      font-weight: 600;
      color: #334155;
    }
    
    label .required-mark {
      color: #dc2626;
      margin-left: 2px;
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container">
    <div class="page-header-simple">
      <a href="/internal/tasks" class="back-link">â† è¿”å›ä»»å‹™åˆ—è¡¨</a>
      <h1 class="page-title">æ–°å¢ä»»å‹™</h1>
    </div>

    <div class="content-card">
      <div class="page-intro">
        <h2>ğŸ“‹ å»ºç«‹æ–°ä»»å‹™</h2>
        <p>å¡«å¯«ä»¥ä¸‹è³‡è¨Šä¾†å»ºç«‹ä¸€å€‹æ–°çš„ä»»å‹™ã€‚ç³»çµ±å°‡è‡ªå‹•è¨ˆç®—é è¨­åˆ°æœŸæ—¥ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ ¹æ“šéœ€è¦é€²è¡Œèª¿æ•´ã€‚</p>
      </div>

      <form id="taskForm" onsubmit="submitTask(event)">
        <!-- åŸºæœ¬è³‡è¨Š -->
        <div class="form-section">
          <div class="form-section-title">
            <span class="material-symbols-outlined">info</span>
            åŸºæœ¬è³‡è¨Š
          </div>
          
          <div class="form-row-2col">
            <div class="form-field">
              <label for="client_service_id">å®¢æˆ¶æœå‹™ <span class="required-mark">*</span></label>
              <select id="client_service_id" required>
                <option value="">è¼‰å…¥ä¸­...</option>
              </select>
              <div class="field-hint">
                <span class="material-symbols-outlined">help</span>
                é¸æ“‡è¦åŸ·è¡Œä»»å‹™çš„å®¢æˆ¶å’Œæœå‹™é¡å‹
              </div>
            </div>
            <div class="form-field">
              <label for="assignee_user_id">è² è²¬äºº</label>
              <select id="assignee_user_id">
                <option value="">æœªåˆ†é…</option>
              </select>
              <div class="field-hint">
                <span class="material-symbols-outlined">help</span>
                å¯ç¨å¾Œå†æŒ‡æ´¾è² è²¬äºº
              </div>
            </div>
          </div>

          <div class="form-row-1col">
            <div class="form-field">
              <label for="task_name">ä»»å‹™åç¨± <span class="required-mark">*</span></label>
              <input type="text" id="task_name" required maxlength="200" placeholder="ä¾‹å¦‚ï¼š11æœˆä»½è¨˜å¸³æœå‹™" />
              <div class="field-hint">
                <span class="material-symbols-outlined">help</span>
                æ¸…æ¥šæè¿°ä»»å‹™å…§å®¹ï¼Œæœ€å¤š200å­—
              </div>
            </div>
          </div>
        </div>

        <!-- æ™‚é–“è¨­å®š -->
        <div class="form-section">
          <div class="form-section-title">
            <span class="material-symbols-outlined">schedule</span>
            æ™‚é–“è¨­å®š
          </div>
          
          <div class="form-row-2col">
            <div class="form-field">
              <label for="service_month">æœå‹™æœˆä»½ <span class="required-mark">*</span></label>
              <input type="month" id="service_month" required />
              <div class="field-hint">
                <span class="material-symbols-outlined">help</span>
                æ­¤ä»»å‹™å°æ‡‰çš„æœå‹™æœˆä»½
              </div>
            </div>
            <div class="form-field">
              <label for="due_date">åˆ°æœŸæ—¥</label>
              <input type="date" id="due_date" />
              <input type="hidden" id="default_due_date" />
              <div class="field-hint" id="due_date_hint">
                <span class="material-symbols-outlined">help</span>
                ç³»çµ±é è¨­åˆ°æœŸæ—¥å°‡æ ¹æ“šæœå‹™è‡ªå‹•è¨ˆç®—
              </div>
            </div>
          </div>
        </div>

        <!-- èª¿æ•´åŸå› å€ï¼ˆæ¢ä»¶é¡¯ç¤ºï¼‰ -->
        <div id="adjustment_reason_section" style="display:none;">
          <div class="alert-warning">
            <span class="material-symbols-outlined">warning</span>
            <div class="alert-warning-content">
              <div class="alert-warning-title">æ‚¨ä¿®æ”¹äº†ç³»çµ±é è¨­çš„åˆ°æœŸæ—¥</div>
              <div class="alert-warning-text">è«‹èªªæ˜èª¿æ•´åŸå› ï¼Œé€™æœ‰åŠ©æ–¼è¿½è¹¤å®¢æˆ¶çš„ç‰¹æ®Šéœ€æ±‚æˆ–ä»»å‹™è¤‡é›œåº¦</div>
            </div>
          </div>
          <div class="form-field">
            <label for="adjustment_reason">èª¿æ•´åŸå›  <span class="required-mark">*</span></label>
            <textarea id="adjustment_reason" rows="3" placeholder="ä¾‹å¦‚ï¼šè©²å®¢æˆ¶å¸³å‹™è¤‡é›œéœ€é¡å¤–è™•ç†æ™‚é–“ï¼Œæˆ–å®¢æˆ¶è¦æ±‚æå‰å®Œæˆ..."></textarea>
          </div>
        </div>

        <!-- é€²éšé¸é … -->
        <div class="form-section">
          <div class="form-section-title">
            <span class="material-symbols-outlined">tune</span>
            é€²éšé¸é …
          </div>
          
          <div class="form-row-2col">
            <div class="form-field">
              <label for="prerequisite_task_id">å‰ç½®ä»»å‹™</label>
              <select id="prerequisite_task_id">
                <option value="">ç„¡å‰ç½®ä»»å‹™</option>
              </select>
              <div class="field-hint">
                <span class="material-symbols-outlined">help</span>
                è¨­å®šæ­¤ä»»å‹™å¿…é ˆç­‰å¾…å¦ä¸€å€‹ä»»å‹™å®Œæˆå¾Œæ‰èƒ½é–‹å§‹
              </div>
            </div>
            <div class="form-field">
              <label>ä»»å‹™éšæ®µ</label>
              <div id="stages_container" class="stages-list">
                <!-- éšæ®µè¼¸å…¥æ¡†å°‡å‹•æ…‹æ·»åŠ  -->
              </div>
              <button type="button" onclick="addStage()" class="btn-add-stage">
                <span class="material-symbols-outlined">add</span>
                æ·»åŠ éšæ®µ
              </button>
              <div class="field-hint" style="margin-top: 8px;">
                <span class="material-symbols-outlined">help</span>
                å°‡ä»»å‹™æ‹†åˆ†ç‚ºå¤šå€‹éšæ®µï¼Œä¾¿æ–¼è¿½è¹¤é€²åº¦
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" onclick="window.location.href='/internal/tasks'" class="btn btn-secondary">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">âœ“ å»ºç«‹ä»»å‹™</button>
        </div>
      </form>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script src="/assets/js/components/bootstrap.js?v=3"></script>
  <script>
    const onProdHost = location.hostname.endsWith('horgoscpa.com');
    const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
    
    let clientServices = [];
    let defaultDueDate = null;
    
    async function init() {
      // è¨­å®šç•¶å‰æœˆä»½ç‚ºé»˜èªå€¼
      const now = new Date();
      const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('service_month').value = yearMonth;
      
      // æ·»åŠ ç¬¬ä¸€å€‹éšæ®µè¼¸å…¥æ¡†
      addStage();
      
      // è¼‰å…¥å®¢æˆ¶æœå‹™åˆ—è¡¨
      await loadClientServices();
      
      // è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
      await loadUsers();
      
      // è¼‰å…¥å‰ç½®ä»»å‹™é¸é …
      await loadPrerequisiteTasks();
      
      // è¨­å®šç›£è½å™¨
      document.getElementById('due_date').addEventListener('change', checkDueDateChange);
      document.getElementById('client_service_id').addEventListener('change', calculateDefaultDueDate);
      document.getElementById('service_month').addEventListener('change', calculateDefaultDueDate);
    }
    
    async function loadPrerequisiteTasks() {
      try {
        // è¼‰å…¥æœªå®Œæˆçš„ä»»å‹™ä½œç‚ºå‰ç½®ä»»å‹™é¸é …
        const res = await fetch(`${apiBase}/tasks?status=pending,in_progress&limit=100`, { credentials: 'include' });
        if (res.status === 401) return;
        const json = await res.json();
        
        const select = document.getElementById('prerequisite_task_id');
        if (json.ok && Array.isArray(json.data)) {
          select.innerHTML = '<option value="">ç„¡å‰ç½®ä»»å‹™</option>' + 
            json.data.map(t => `<option value="${t.taskId}">${t.taskName} (${t.dueDate || 'æœªè¨­å®šæœŸé™'})</option>`).join('');
        }
      } catch (err) {
        console.error('è¼‰å…¥å‰ç½®ä»»å‹™å¤±æ•—:', err);
      }
    }
    
    async function loadClientServices() {
      try {
        const res = await fetch(`${apiBase}/client-services`, { credentials: 'include' });
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        const select = document.getElementById('client_service_id');
        if (json.ok && Array.isArray(json.data)) {
          clientServices = json.data;
          select.innerHTML = '<option value="">è«‹é¸æ“‡å®¢æˆ¶æœå‹™</option>' + 
            clientServices.map(cs => `<option value="${cs.client_service_id}">${cs.client_name} - ${cs.service_name || 'æœªæŒ‡å®šæœå‹™'}</option>`).join('');
        }
      } catch (err) {
        console.error('è¼‰å…¥å®¢æˆ¶æœå‹™å¤±æ•—:', err);
      }
    }
    
    async function loadUsers() {
      try {
        const res = await fetch(`${apiBase}/users`, { credentials: 'include' });
        if (res.status === 401) return;
        const json = await res.json();
        
        const select = document.getElementById('assignee_user_id');
        if (json.ok && Array.isArray(json.data)) {
          select.innerHTML = '<option value="">æœªåˆ†é…</option>' + 
            json.data.map(u => `<option value="${u.user_id}">${u.name}</option>`).join('');
        }
      } catch (err) {
        console.error('è¼‰å…¥ç”¨æˆ¶å¤±æ•—:', err);
      }
    }
    
    function calculateDefaultDueDate() {
      // ç°¡åŒ–å¯¦ç¾ï¼šé è¨­ç‚ºç•¶æœˆæœ€å¾Œä¸€å¤©
      const serviceMonth = document.getElementById('service_month').value;
      if (!serviceMonth) return;
      
      const [year, month] = serviceMonth.split('-').map(Number);
      const lastDay = new Date(year, month, 0).getDate();
      defaultDueDate = `${year}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
      
      document.getElementById('default_due_date').value = defaultDueDate;
      const hintElement = document.getElementById('due_date_hint');
      hintElement.innerHTML = `<span class="material-symbols-outlined">help</span> ç³»çµ±é è¨­ï¼š${defaultDueDate}`;
      
      // å¦‚æœé‚„æ²’è¨­å®šåˆ°æœŸæ—¥ï¼Œè‡ªå‹•å¡«å…¥
      if (!document.getElementById('due_date').value) {
        document.getElementById('due_date').value = defaultDueDate;
      }
    }
    
    function checkDueDateChange() {
      const dueDate = document.getElementById('due_date').value;
      const defaultDate = document.getElementById('default_due_date').value;
      
      const section = document.getElementById('adjustment_reason_section');
      const reasonField = document.getElementById('adjustment_reason');
      
      // å¦‚æœä¿®æ”¹äº†é è¨­æœŸé™ï¼Œé¡¯ç¤ºåŸå› æ¬„ä½ä¸¦è¨­ç‚ºå¿…å¡«
      if (defaultDate && dueDate && dueDate !== defaultDate) {
        section.style.display = 'block';
        reasonField.required = true;
      } else {
        section.style.display = 'none';
        reasonField.required = false;
      }
    }
    
    function addStage() {
      const container = document.getElementById('stages_container');
      const stageCount = container.querySelectorAll('.stage_input').length + 1;
      const isFirst = stageCount === 1;
      
      const wrapper = document.createElement('div');
      wrapper.className = 'stage-input-wrapper';
      
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'stage_input';
      input.placeholder = isFirst ? 'éšæ®µ 1ï¼ˆå¯é¸ï¼‰' : `éšæ®µ ${stageCount}`;
      
      wrapper.appendChild(input);
      
      // ç¬¬ä¸€å€‹éšæ®µä¸é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
      if (!isFirst) {
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn-remove-stage';
        removeBtn.innerHTML = 'âœ•';
        removeBtn.title = 'åˆªé™¤æ­¤éšæ®µ';
        removeBtn.onclick = function() {
          wrapper.remove();
          updateStagePlaceholders();
        };
        wrapper.appendChild(removeBtn);
      }
      
      container.appendChild(wrapper);
    }
    
    function updateStagePlaceholders() {
      const wrappers = document.querySelectorAll('.stage-input-wrapper');
      wrappers.forEach((wrapper, index) => {
        const input = wrapper.querySelector('.stage_input');
        if (index === 0) {
          input.placeholder = 'éšæ®µ 1ï¼ˆå¯é¸ï¼‰';
        } else {
          input.placeholder = `éšæ®µ ${index + 1}`;
        }
      });
    }
    
    async function submitTask(event) {
      event.preventDefault();
      
      const dueDate = document.getElementById('due_date').value;
      const defaultDate = document.getElementById('default_due_date').value;
      const adjustmentReason = document.getElementById('adjustment_reason').value.trim();
      
      // æª¢æŸ¥æ˜¯å¦éœ€è¦å¡«å¯«åŸå› 
      if (defaultDate && dueDate && dueDate !== defaultDate && !adjustmentReason) {
        alert('æ‚¨ä¿®æ”¹äº†é è¨­æœŸé™ï¼Œå¿…é ˆå¡«å¯«èª¿æ•´åŸå› ');
        return;
      }
      
      // æ”¶é›†éšæ®µåç¨±
      const stageInputs = document.querySelectorAll('.stage_input');
      const stageNames = Array.from(stageInputs)
        .map(input => input.value.trim())
        .filter(name => name.length > 0);
      
      const data = {
        client_service_id: parseInt(document.getElementById('client_service_id').value),
        task_name: document.getElementById('task_name').value.trim(),
        service_month: document.getElementById('service_month').value,
        due_date: dueDate || null,
        assignee_user_id: document.getElementById('assignee_user_id').value ? parseInt(document.getElementById('assignee_user_id').value) : null,
        prerequisite_task_id: document.getElementById('prerequisite_task_id').value ? parseInt(document.getElementById('prerequisite_task_id').value) : null,
        stage_names: stageNames
      };
      
      // å¦‚æœèª¿æ•´äº†æœŸé™ï¼Œæ·»åŠ ç›¸é—œæ¬„ä½
      if (defaultDate && dueDate && dueDate !== defaultDate && adjustmentReason) {
        data.default_due_date = defaultDate;
        data.adjustment_reason = adjustmentReason;
      }
      
      try {
        const res = await fetch(`${apiBase}/tasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        if (res.status === 401) { window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); return; }
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || 'å»ºç«‹å¤±æ•—');
          return;
        }
        
        alert('ä»»å‹™å·²å»ºç«‹');
        window.location.href = '/internal/tasks';
        
      } catch (err) {
        console.error('å»ºç«‹ä»»å‹™å¤±æ•—:', err);
        alert('å»ºç«‹å¤±æ•—');
      }
    }
    
    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
