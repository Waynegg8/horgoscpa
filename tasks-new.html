<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新增任務 - 內部系統</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <style>
    .form-section {
      background: white;
      padding: 24px;
      margin-bottom: 0;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .form-section:last-of-type {
      border-bottom: none;
    }
    
    .form-section-title {
      font-size: 15px;
      font-weight: 600;
      color: #475569;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f1f5f9;
    }
    
    .form-section-title .material-symbols-outlined {
      font-size: 20px;
      color: var(--primary-color);
    }
    
    .field-hint {
      font-size: 12px;
      color: #64748b;
      margin-top: 6px;
      display: flex;
      align-items: flex-start;
      gap: 4px;
      line-height: 1.5;
    }
    
    .field-hint .material-symbols-outlined {
      font-size: 16px;
      margin-top: 1px;
    }
    
    .alert-warning {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    
    .alert-warning .material-symbols-outlined {
      color: #d97706;
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .alert-warning-content {
      flex: 1;
    }
    
    .alert-warning-title {
      font-weight: 600;
      color: #92400e;
      margin-bottom: 4px;
    }
    
    .alert-warning-text {
      font-size: 14px;
      color: #78350f;
    }
    
    #adjustment_reason_section {
      padding: 24px;
      border-bottom: 1px solid #f1f5f9;
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    
    .content-card {
      border-radius: 8px;
      background: white;
    }
    
    .task-card {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      position: relative;
    }
    
    .task-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .task-number {
      font-weight: 600;
      color: var(--primary-color);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .task-card-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn-move-up, .btn-move-down, .btn-remove-task {
      padding: 4px 8px;
      border: 1px solid #cbd5e1;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .btn-move-up:hover, .btn-move-down:hover {
      background: #f1f5f9;
      border-color: var(--primary-color);
      color: var(--primary-color);
    }
    
    .btn-remove-task {
      color: #dc2626;
      border-color: #fecaca;
    }
    
    .btn-remove-task:hover {
      background: #fef2f2;
      border-color: #dc2626;
    }
    
    .btn-add-task {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: white;
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 500;
    }
    
    .btn-add-task:hover {
      background: #f1f5f9;
      border-color: var(--primary-color);
      color: var(--primary-color);
    }
    
    .task-card input,
    .task-card select {
      font-size: 14px;
    }
    
    label {
      font-weight: 600;
      color: #334155;
      font-size: 14px;
    }
    
    label .required-mark {
      color: #dc2626;
      margin-left: 2px;
    }
    
    input[type="text"],
    input[type="date"],
    input[type="month"],
    select,
    textarea {
      font-size: 14px;
    }
    
    .form-actions {
      padding: 20px 24px;
      background: #f8fafc;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container" style="max-width: 1200px; padding: 20px;">
    <div class="content-card" style="box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid #e5e7eb;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <a href="/internal/tasks" style="color: #64748b; text-decoration: none; display: flex; align-items: center; gap: 4px; font-size: 14px; transition: color 0.2s;" onmouseover="this.style.color='#2c5f7c'" onmouseout="this.style.color='#64748b'">
            <span style="font-size: 18px;">←</span> 返回
          </a>
          <div style="width: 1px; height: 20px; background: #e5e7eb;"></div>
          <h1 style="margin: 0; font-size: 20px; font-weight: 600; color: #1e293b;">新增任務</h1>
        </div>
    </div>

      <form id="taskForm" onsubmit="submitTasks(event)">
        <!-- 基本資訊 -->
        <div class="form-section">
          <div class="form-section-title">
            <span class="material-symbols-outlined">info</span>
            基本資訊
    </div>

        <div class="form-row-2col">
          <div class="form-field">
              <label for="client_id">客戶 <span class="required-mark">*</span></label>
              <select id="client_id" required onchange="loadClientService()">
                <option value="">請選擇客戶</option>
            </select>
              <div class="field-hint">
                <span class="material-symbols-outlined">help</span>
                選擇要服務的客戶
              </div>
          </div>
          <div class="form-field">
              <label for="service_id">服務類型 <span class="required-mark">*</span></label>
              <select id="service_id" required disabled onchange="loadClientService()">
                <option value="">請先選擇客戶</option>
            </select>
              <div class="field-hint">
                <span class="material-symbols-outlined">help</span>
                選擇服務類型（記帳、稅務等）
              </div>
            </div>
          </div>
        </div>

        <!-- 服務月份 -->
        <div class="form-section">
          <div class="form-section-title">
            <span class="material-symbols-outlined">schedule</span>
            服務月份
        </div>

        <div class="form-row-1col">
          <div class="form-field">
              <label for="service_month">服務月份 <span class="required-mark">*</span></label>
              <input type="month" id="service_month" required />
              <div class="field-hint">
                <span class="material-symbols-outlined">help</span>
                所有任務都將使用此服務月份
              </div>
            </div>
          </div>
        </div>

        <!-- 服務層級SOP -->
        <div class="form-section">
          <div class="form-section-title">
            <span class="material-symbols-outlined">folder_special</span>
            服務層級SOP（通用）
          </div>
          
          <div class="form-row-1col">
          <div class="form-field">
              <button type="button" onclick="openServiceSOPSelector()" class="btn-sop" style="width: 100%; padding: 12px; border: 2px dashed #cbd5e1; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; color: #475569; transition: all 0.2s;" onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#f0f9ff'" onmouseout="this.style.borderColor='#cbd5e1'; this.style.background='white'">
                <span class="material-symbols-outlined">folder_open</span>
                <span id="serviceSopButtonText">選擇服務通用SOP</span>
              </button>
              <div id="serviceSopTags" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
                <!-- 已選SOP標籤將顯示在這裡 -->
              </div>
              <div class="field-hint" style="margin-top: 8px;">
                <span class="material-symbols-outlined">help</span>
                這些SOP會自動關聯到下方所有批量創建的任務中
              </div>
          </div>
          </div>
        </div>

        <!-- 任務列表 -->
        <div class="form-section" style="border-bottom: none;">
          <div class="form-section-title">
            <span class="material-symbols-outlined">list</span>
            任務列表
        </div>

          <div id="tasks_container" style="display: flex; flex-direction: column; gap: 16px;">
            <!-- 任務項目將動態添加 -->
          </div>
          
          <button type="button" onclick="addTask()" class="btn-add-task" style="margin-top: 16px;">
            <span class="material-symbols-outlined">add</span>
            添加任務
          </button>
          
          <div class="field-hint" style="margin-top: 12px;">
            <span class="material-symbols-outlined">help</span>
            任務將按照順序執行，每個任務完成後才能開始下一個
          </div>
        </div>

      </form>

        <div class="form-actions">
          <button type="button" onclick="window.location.href='/internal/tasks'" class="btn btn-secondary">取消</button>
        <button type="submit" form="taskForm" class="btn btn-primary">✓ 建立所有任務</button>
            </div>
          </div>
        </div>

  <!-- SOP選擇器彈窗 -->
  <div id="sopModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
      <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between;">
        <h3 style="margin: 0; font-size: 18px; font-weight: 600;">選擇SOP文檔</h3>
        <button onclick="closeSOPModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">×</button>
      </div>
      <div style="padding: 16px; overflow-y: auto; flex: 1;">
        <input type="text" id="sopSearchInput" placeholder="搜尋SOP標題..." style="width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 12px;" oninput="filterSOPs()" />
        <div id="sopList" style="display: flex; flex-direction: column; gap: 8px;">
          <!-- SOP列表將動態添加 -->
        </div>
      </div>
      <div style="padding: 16px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px;">
        <button onclick="closeSOPModal()" class="btn btn-secondary">取消</button>
        <button onclick="confirmSOPSelection()" class="btn btn-primary">確定</button>
        </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script src="/assets/js/components/bootstrap.js?v=3"></script>
  <script>
    const onProdHost = location.hostname.endsWith('horgoscpa.com');
    const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
    
    let clients = [];
    let services = [];
    let users = [];
    let sops = [];
    let serviceItems = []; // 服务子项目（任务类型）
    let taskCounter = 0;
    let currentClientServiceId = null;
    let serviceLevelSOPIds = []; // 服務層級SOP（會套用到所有任務）
    let currentSOPTaskId = null;
    let selectedSOPs = {}; // { taskId: [sopId1, sopId2] }
    let sopSelectorMode = 'task'; // 'service' or 'task'
    
    async function init() {
      // 設定當前月份為默認值
      const now = new Date();
      const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById('service_month').value = yearMonth;
      
      // 載入客戶列表
      await loadClients();
      
      // 載入服務類型列表
      await loadServices();
      
      // 載入服務子項目（任務類型）
      await loadServiceItems();
      
      // 載入用戶列表
      await loadUsers();
      
      // 載入SOP列表
      await loadSOPs();
      
      // 添加第一個任務
      addTask();
    }
    
    
    async function loadClients() {
      try {
        const res = await fetch(`${apiBase}/clients?perPage=100`, { credentials: 'include' });
        if (res.status === 401) { 
          window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname); 
          return; 
        }
        const json = await res.json();
        
        const select = document.getElementById('client_id');
        if (json.ok && Array.isArray(json.data)) {
          clients = json.data;
          select.innerHTML = '<option value="">請選擇客戶</option>' + 
            clients.map(c => `<option value="${c.clientId}">${c.companyName || c.clientId}</option>`).join('');
        }
      } catch (err) {
        console.error('載入客戶列表失敗:', err);
      }
    }
    
    async function loadServices() {
      try {
        const res = await fetch(`${apiBase}/services`, { credentials: 'include' });
        if (res.status === 401) return;
        const json = await res.json();
        
        if (json.ok && Array.isArray(json.data)) {
          services = json.data;
        }
      } catch (err) {
        console.error('載入服務類型失敗:', err);
      }
    }
    
    async function loadServiceItems() {
      try {
        const res = await fetch(`${apiBase}/services/items`, { credentials: 'include' });
        if (res.status === 401) return;
        const json = await res.json();
        
        if (json.ok && Array.isArray(json.data)) {
          serviceItems = json.data;
          console.log('[loadServiceItems] 載入服務子項目:', serviceItems.length, '項');
        }
      } catch (err) {
        console.error('載入服務子項目失敗:', err);
      }
    }
    
    async function loadClientService() {
      const clientId = document.getElementById('client_id').value;
      const serviceId = document.getElementById('service_id').value;
      const serviceSelect = document.getElementById('service_id');
      
      // 當選擇客戶後，啟用服務選擇並載入該客戶的服務
      if (clientId && !serviceId) {
        serviceSelect.disabled = false;
        
        // 獲取該客戶已有的服務
        try {
          const res = await fetch(`${apiBase}/client-services?q=${encodeURIComponent(clientId)}`, { credentials: 'include' });
          const json = await res.json();
          
          const existingServiceIds = json.ok ? json.data.map(cs => cs.service_id).filter(Boolean) : [];
          
          serviceSelect.innerHTML = '<option value="">請選擇服務類型</option>' + 
            services.map(s => {
              const exists = existingServiceIds.includes(s.service_id);
              return `<option value="${s.service_id}"${exists ? ' data-exists="1"' : ''}>${s.service_name}${exists ? ' ✓' : ''}</option>`;
            }).join('');
      } catch (err) {
        console.error('載入客戶服務失敗:', err);
          serviceSelect.innerHTML = '<option value="">請選擇服務類型</option>' + 
            services.map(s => `<option value="${s.service_id}">${s.service_name}</option>`).join('');
        }
        return;
      }
      
      // 當客戶和服務都選擇後，查找或創建client_service_id
      if (clientId && serviceId) {
        try {
          // 先查找是否已存在該client_service
        const res = await fetch(`${apiBase}/client-services`, { credentials: 'include' });
        const json = await res.json();
        
        if (json.ok && Array.isArray(json.data)) {
            const existing = json.data.find(cs => 
              (cs.client_id || cs.clientId) === clientId && cs.service_id == serviceId
            );
            
            if (existing) {
              currentClientServiceId = existing.client_service_id;
              console.log('使用現有的 client_service_id:', currentClientServiceId);
            } else {
              // 需要創建新的client_service（暫時先記錄，提交時再創建）
              currentClientServiceId = null;
              console.log('將創建新的客戶服務關係');
            }
        }
        
        // 更新任务类型下拉选单
        updateTaskNameOptions();
      } catch (err) {
          console.error('查找客戶服務失敗:', err);
        }
      }
    }
    
    async function loadUsers() {
      try {
        const res = await fetch(`${apiBase}/users`, { credentials: 'include' });
        if (res.status === 401) return;
        const json = await res.json();
        
        if (json.ok && Array.isArray(json.data)) {
          users = json.data;
        }
      } catch (err) {
        console.error('載入用戶失敗:', err);
      }
    }
    
    async function loadSOPs(category = null, scope = null) {
      try {
        let url = `${apiBase}/sop?perPage=200`;
        if (category) {
          url += `&category=${encodeURIComponent(category)}`;
        }
        if (scope) {
          url += `&scope=${encodeURIComponent(scope)}`;
        }
        
        console.log('[loadSOPs] URL:', url);
        
        const res = await fetch(url, { credentials: 'include' });
        if (res.status === 401) return;
        const json = await res.json();
        
        console.log('[loadSOPs] Response:', json);
        
        if (json.ok && Array.isArray(json.data)) {
          sops = json.data;
          console.log('[loadSOPs] Loaded:', sops.length, 'SOPs');
        }
      } catch (err) {
        console.error('載入SOP列表失敗:', err);
      }
    }
    
    function addTask() {
      taskCounter++;
      const container = document.getElementById('tasks_container');
      const taskId = `task_${taskCounter}`;
      
      // 計算預設到期日
      const serviceMonth = document.getElementById('service_month').value;
      let defaultDueDate = '';
      if (serviceMonth) {
      const [year, month] = serviceMonth.split('-').map(Number);
      const lastDay = new Date(year, month, 0).getDate();
      defaultDueDate = `${year}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
      }
      
      const userOptions = '<option value="">未分配</option>' + users.map(u => `<option value="${u.user_id}">${u.name}</option>`).join('');
      
      const taskCard = document.createElement('div');
      taskCard.className = 'task-card';
      taskCard.dataset.taskId = taskId;
      taskCard.innerHTML = `
        <div class="task-card-header">
          <div class="task-number">
            <span class="material-symbols-outlined" style="font-size: 18px;">task</span>
            任務 <span class="task-order">1</span>
          </div>
          <div class="task-card-actions">
            <button type="button" class="btn-move-up" onclick="moveTaskUp('${taskId}')" title="上移">↑</button>
            <button type="button" class="btn-move-down" onclick="moveTaskDown('${taskId}')" title="下移">↓</button>
            <button type="button" class="btn-remove-task" onclick="removeTask('${taskId}')" title="刪除">✕</button>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px; margin-bottom: 12px;">
          <div class="form-field">
            <label style="font-size: 13px;">
              任務類型 <span class="required-mark">*</span>
              <span style="font-size: 11px; color: #6b7280; font-weight: normal;">（從服務項目選擇）</span>
            </label>
            <select name="task_name" required class="task-name-select">
              <option value="">請選擇任務類型</option>
            </select>
          </div>
          <div class="form-field">
            <label style="font-size: 13px;">負責人</label>
            <select name="assignee">${userOptions}</select>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px; margin-bottom: 12px;">
          <div class="form-field">
            <label style="font-size: 13px;">到期日</label>
            <input type="date" name="due_date" value="${defaultDueDate}" />
          </div>
          <div class="form-field">
            <label style="font-size: 13px;">備註</label>
            <input type="text" name="notes" placeholder="選填" />
          </div>
        </div>
        
        <div class="form-field">
          <label style="font-size: 13px;">關聯SOP文檔</label>
          <button type="button" class="btn-select-sop" onclick="openSOPSelector('${taskId}')" style="width: 100%; text-align: left; padding: 8px 12px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
            <span class="sop-selected-text" style="color: #64748b;">點擊選擇SOP文檔...</span>
            <span class="material-symbols-outlined" style="font-size: 18px; color: #64748b;">chevron_right</span>
          </button>
          <input type="hidden" name="sop_ids" value="" />
          <div class="field-hint" style="margin-top: 4px; font-size: 11px; color: #64748b;">
            可選擇多個SOP作為任務參考文檔
          </div>
        </div>
      `;
      
      container.appendChild(taskCard);
      updateTaskNumbers();
      
      // 填充任务类型下拉选单
      updateTaskNameOptions();
    }
    
    // 更新所有任务卡片的任务类型选项
    function updateTaskNameOptions() {
      const serviceId = parseInt(document.getElementById('service_id').value);
      
      // 获取当前服务的所有服务子项目
      const currentServiceItems = serviceItems.filter(item => 
        String(item.service_id) === String(serviceId) && item.is_active !== false
      );
      
      console.log('[updateTaskNameOptions] serviceId:', serviceId, '匹配项目:', currentServiceItems.length);
      
      // 更新所有任务卡片的下拉选单
      const taskSelects = document.querySelectorAll('.task-name-select');
      taskSelects.forEach(select => {
        const currentValue = select.value;
        
        if (currentServiceItems.length > 0) {
          select.innerHTML = '<option value="">請選擇任務類型</option>' +
            currentServiceItems.map(item => `<option value="${item.item_name}">${item.item_name}</option>`).join('');
          
          // 恢复之前的选择（如果还存在）
          if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
            select.value = currentValue;
          }
        } else {
          select.innerHTML = '<option value="">請先在系統設定中為此服務新增任務類型</option>';
        }
      });
    }
    
    function removeTask(taskId) {
      const card = document.querySelector(`[data-task-id="${taskId}"]`);
      if (card) {
        const container = document.getElementById('tasks_container');
        if (container.children.length <= 1) {
          alert('至少需要一個任務');
          return;
        }
        card.remove();
        updateTaskNumbers();
      }
    }
    
    function moveTaskUp(taskId) {
      const card = document.querySelector(`[data-task-id="${taskId}"]`);
      if (card && card.previousElementSibling) {
        card.parentNode.insertBefore(card, card.previousElementSibling);
        updateTaskNumbers();
      }
    }
    
    function moveTaskDown(taskId) {
      const card = document.querySelector(`[data-task-id="${taskId}"]`);
      if (card && card.nextElementSibling) {
        card.parentNode.insertBefore(card.nextElementSibling, card);
        updateTaskNumbers();
      }
    }
    
    function updateTaskNumbers() {
      const cards = document.querySelectorAll('.task-card');
      cards.forEach((card, index) => {
        const orderSpan = card.querySelector('.task-order');
        if (orderSpan) {
          orderSpan.textContent = index + 1;
        }
        
        // 更新按鈕狀態
        const upBtn = card.querySelector('.btn-move-up');
        const downBtn = card.querySelector('.btn-move-down');
        upBtn.disabled = index === 0;
        downBtn.disabled = index === cards.length - 1;
        upBtn.style.opacity = index === 0 ? '0.3' : '1';
        downBtn.style.opacity = index === cards.length - 1 ? '0.3' : '1';
      });
    }
    
    async function openSOPSelector(taskId) {
      const serviceId = document.getElementById('service_id').value;
      if (!serviceId) {
        alert('請先選擇服務類型');
        return;
      }
      
      // 根據服務類型獲取對應的category
      const selectedService = services.find(s => String(s.service_id) === String(serviceId));
      const serviceCode = selectedService?.service_code || '';
      
      console.log('[Task SOP] serviceId:', serviceId, 'serviceCode:', serviceCode);
      
      // 重新載入對應category和scope的SOP（直接在API层筛选）
      await loadSOPs(serviceCode, 'task');
      
      sopSelectorMode = 'task';
      currentSOPTaskId = taskId;
      const modal = document.getElementById('sopModal');
      modal.style.display = 'flex';
      document.querySelector('#sopModal h3').textContent = `選擇任務SOP（${selectedService?.service_name || '通用'}）`;
      
      console.log('[Task SOP] Loaded SOPs:', sops.length);
      
      // 渲染SOP列表
      renderSOPList();
    }
    
    async function openServiceSOPSelector() {
      const serviceId = document.getElementById('service_id').value;
      if (!serviceId) {
        alert('請先選擇服務類型');
        return;
      }
      
      // 根據服務類型獲取對應的category
      const selectedService = services.find(s => String(s.service_id) === String(serviceId));
      const serviceCode = selectedService?.service_code || '';
      
      console.log('[Service SOP] serviceId:', serviceId, 'serviceCode:', serviceCode);
      
      // 重新載入對應category和scope的SOP（直接在API层筛选）
      await loadSOPs(serviceCode, 'service');
      
      sopSelectorMode = 'service';
      currentSOPTaskId = null;
      const modal = document.getElementById('sopModal');
      modal.style.display = 'flex';
      document.querySelector('#sopModal h3').textContent = `選擇服務層級SOP（${selectedService?.service_name || '通用'}）`;
      
      console.log('[Service SOP] Loaded SOPs:', sops.length);
      
      // 渲染SOP列表
      renderSOPList();
    }
    
    function closeSOPModal() {
      document.getElementById('sopModal').style.display = 'none';
      currentSOPTaskId = null;
    }
    
    function renderSOPList() {
      const listContainer = document.getElementById('sopList');
      const taskSelectedSOPs = sopSelectorMode === 'service' 
        ? serviceLevelSOPIds 
        : (selectedSOPs[currentSOPTaskId] || []);
      
      // API已經做了scope和category篩選，這裡只需要排序
      const sortedSOPs = sops.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
      
      console.log('[renderSOPList] mode:', sopSelectorMode, 'SOPs:', sortedSOPs.length);
      
      // 直接渲染SOP列表
      const html = sortedSOPs.map(sop => {
        const isChecked = taskSelectedSOPs.includes(sop.sop_id);
        const searchText = (sop.title || '').toLowerCase();
        return `
          <label style="display: flex; align-items: center; padding: 12px; margin-bottom: 8px; background: ${isChecked ? '#eff6ff' : 'white'}; border: 1px solid ${isChecked ? '#3b82f6' : '#e5e7eb'}; border-radius: 6px; cursor: pointer; transition: all 0.2s;" class="sop-item" data-search="${searchText}" onmouseover="if(!this.querySelector('input').checked) this.style.background='#f8fafc'" onmouseout="if(!this.querySelector('input').checked) this.style.background='white'">
            <input type="checkbox" value="${sop.sop_id}" ${isChecked ? 'checked' : ''} onchange="toggleSOPCheck(this)" style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;" />
            <div style="flex: 1;">
              <div style="font-weight: 500; font-size: 14px; color: #1e293b;">${sop.title || '未命名'}</div>
            </div>
            ${isChecked ? '<span class="checkmark-icon" style="color: #3b82f6; font-size: 20px;">✓</span>' : ''}
          </label>
        `;
      }).join('');
      
      listContainer.innerHTML = html || `<div style="text-align:center;padding:24px;color:#9ca3af;">暫無適用於此服務的${sopSelectorMode === 'service' ? '服務層級' : '任務層級'}SOP文檔</div>`;
    }
    
    function toggleCategory(categoryId) {
      const content = document.getElementById(categoryId);
      const arrow = document.getElementById(categoryId + '_arrow');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.textContent = 'expand_more';
      } else {
        content.style.display = 'none';
        arrow.textContent = 'chevron_right';
      }
    }
    
    function toggleSOPCheck(checkbox) {
      const label = checkbox.closest('.sop-item');
      
      // 更新样式
      if (checkbox.checked) {
        label.style.background = '#eff6ff';
        label.style.borderColor = '#3b82f6';
      } else {
        label.style.background = 'white';
        label.style.borderColor = '#e5e7eb';
      }
      
      // 更新勾选标记（如果存在的话）
      let checkmark = label.querySelector('.checkmark-icon');
      if (checkbox.checked && !checkmark) {
        checkmark = document.createElement('span');
        checkmark.className = 'checkmark-icon';
        checkmark.style.cssText = 'color: #3b82f6; font-size: 18px;';
        checkmark.textContent = '✓';
        label.appendChild(checkmark);
      } else if (!checkbox.checked && checkmark) {
        checkmark.remove();
      }
    }
    
    function filterSOPs() {
      const searchText = document.getElementById('sopSearchInput').value.toLowerCase();
      const items = document.querySelectorAll('.sop-item');
      
      items.forEach(item => {
        const searchData = item.dataset.search || '';
        if (searchData.includes(searchText)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
      
      // 如果搜尋，展開所有類別
      if (searchText) {
        document.querySelectorAll('.category-content').forEach(cat => {
          cat.style.display = 'block';
        });
        document.querySelectorAll('.category-arrow').forEach(arrow => {
          arrow.textContent = 'expand_more';
        });
      }
    }
    
    function confirmSOPSelection() {
      const checkedBoxes = document.querySelectorAll('#sopList input[type="checkbox"]:checked');
      const sopIds = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
      
      if (sopSelectorMode === 'service') {
        // 服務層級SOP
        serviceLevelSOPIds = sopIds;
        renderServiceSOPTags();
      } else {
        // 任務層級SOP
        selectedSOPs[currentSOPTaskId] = sopIds;
        
        // 更新任務卡片顯示
        const taskCard = document.querySelector(`[data-task-id="${currentSOPTaskId}"]`);
        if (taskCard) {
          const textSpan = taskCard.querySelector('.sop-selected-text');
          const hiddenInput = taskCard.querySelector('[name="sop_ids"]');
          
          if (sopIds.length > 0) {
            const sopTitles = sops.filter(s => sopIds.includes(s.sop_id)).map(s => s.title).join(', ');
            textSpan.textContent = `已選擇 ${sopIds.length} 個SOP: ${sopTitles.substring(0, 40)}${sopTitles.length > 40 ? '...' : ''}`;
            textSpan.style.color = '#1e293b';
            hiddenInput.value = sopIds.join(',');
      } else {
            textSpan.textContent = '點擊選擇SOP文檔...';
            textSpan.style.color = '#64748b';
            hiddenInput.value = '';
          }
        }
      }
      
      closeSOPModal();
    }
    
    function renderServiceSOPTags() {
      const container = document.getElementById('serviceSopTags');
      const buttonText = document.getElementById('serviceSopButtonText');
      
      if (serviceLevelSOPIds.length === 0) {
        container.innerHTML = '';
        buttonText.textContent = '選擇服務通用SOP';
        return;
      }
      
      buttonText.textContent = `已選 ${serviceLevelSOPIds.length} 個SOP`;
      
      container.innerHTML = serviceLevelSOPIds.map(sopId => {
        const sop = sops.find(s => s.sop_id === sopId);
        if (!sop) return '';
        
        return `
          <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: #eff6ff; border: 1px solid #3b82f6; border-radius: 6px; font-size: 13px; color: #1e40af;">
            <span class="material-symbols-outlined" style="font-size: 16px;">description</span>
            ${sop.title}
            <button type="button" onclick="removeServiceSOP(${sopId})" style="background: none; border: none; color: #3b82f6; cursor: pointer; padding: 0; margin-left: 4px; font-size: 18px; line-height: 1; display: flex; align-items: center;" onmouseover="this.style.color='#1e40af'" onmouseout="this.style.color='#3b82f6'">×</button>
          </span>
        `;
      }).join('');
    }
    
    function removeServiceSOP(sopId) {
      serviceLevelSOPIds = serviceLevelSOPIds.filter(id => id !== sopId);
      renderServiceSOPTags();
    }
    
    
    async function submitTasks(event) {
      event.preventDefault();
      
      const clientId = document.getElementById('client_id').value;
      const serviceId = parseInt(document.getElementById('service_id').value);
      const serviceMonth = document.getElementById('service_month').value;
      
      if (!clientId || !serviceId) {
        alert('請選擇客戶和服務類型');
        return;
      }
      
      // 查找或創建client_service_id
      let clientServiceId = currentClientServiceId;
      
      if (!clientServiceId) {
        // 創建新的客戶服務關係
        try {
          const createRes = await fetch(`${apiBase}/client-services`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              client_id: clientId,
              service_id: serviceId,
              status: 'active'
            })
          });
          
          if (createRes.status === 401) {
            window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
            return;
          }
          
          const createJson = await createRes.json();
          if (!createJson.ok) {
            alert('創建客戶服務關係失敗: ' + (createJson.message || '未知錯誤'));
        return;
      }
      
          clientServiceId = createJson.data.client_service_id;
          console.log('成功創建 client_service_id:', clientServiceId);
        } catch (err) {
          console.error('創建客戶服務失敗:', err);
          alert('創建客戶服務失敗: ' + err.message);
          return;
        }
      }
      
      // 收集所有任務
      const taskCards = document.querySelectorAll('.task-card');
      const tasks = [];
      let previousTaskId = null;
      
      for (const card of taskCards) {
        const taskName = card.querySelector('[name="task_name"]').value.trim();
        const assigneeSelect = card.querySelector('[name="assignee"]');
        const assigneeUserId = assigneeSelect.value ? parseInt(assigneeSelect.value) : null;
        const dueDate = card.querySelector('[name="due_date"]').value || null;
        const notes = card.querySelector('[name="notes"]').value.trim() || null;
        
        // 獲取任務層級的SOP IDs
        const taskSopInput = card.querySelector('[name="sop_ids"]');
        const taskSopIds = taskSopInput && taskSopInput.value 
          ? taskSopInput.value.split(',').map(id => parseInt(id)).filter(id => !isNaN(id))
          : [];
        
        // 合併服務層級SOP和任務層級SOP
        const allSopIds = [...new Set([...serviceLevelSOPIds, ...taskSopIds])];
        
        if (!taskName) {
          alert('請填寫所有任務名稱');
          return;
        }
        
        tasks.push({
          task_name: taskName,
          assignee_user_id: assigneeUserId,
          due_date: dueDate,
          notes: notes,
          prerequisite_task_id: previousTaskId,
          sop_ids: allSopIds
        });
        
        // 暫存當前任務ID的占位符，實際ID會在創建後獲得
        previousTaskId = 'PREVIOUS';
      }
      
      try {
        // 按順序創建任務，並設置前置任務關係
        let actualPreviousTaskId = null;
        let createdCount = 0;
        
        for (const taskData of tasks) {
          const data = {
            client_service_id: clientServiceId,
            service_month: serviceMonth,
            task_name: taskData.task_name,
            due_date: taskData.due_date,
            assignee_user_id: taskData.assignee_user_id,
            notes: taskData.notes,
            prerequisite_task_id: actualPreviousTaskId
          };
          
        const res = await fetch(`${apiBase}/tasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
          if (res.status === 401) {
            window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
            return;
          }
          
        const json = await res.json();
        
        if (!json.ok) {
            alert(`建立第 ${createdCount + 1} 個任務失敗: ${json.message || '未知錯誤'}`);
            if (createdCount > 0) {
              alert(`已成功建立 ${createdCount} 個任務`);
            }
          return;
        }
        
          // 保存剛創建的任務ID，作為下一個任務的前置任務
          const newTaskId = json.data.taskId;
          actualPreviousTaskId = newTaskId;
          
          // 關聯SOP（服務層級 + 任務層級）
          if (taskData.sop_ids && taskData.sop_ids.length > 0) {
            try {
              const sopRes = await fetch(`${apiBase}/tasks/${newTaskId}/sops`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ sop_ids: taskData.sop_ids })
              });
              
              if (!sopRes.ok) {
                console.warn(`關聯SOP到任務 ${newTaskId} 失敗，但任務已創建`);
              }
            } catch (sopErr) {
              console.error('關聯SOP失敗:', sopErr);
            }
          }
          
          createdCount++;
        }
        
        alert(`成功建立 ${createdCount} 個任務！`);
        window.location.href = '/internal/tasks';
        
      } catch (err) {
        console.error('建立任務失敗:', err);
        alert('建立失敗：' + err.message);
      }
    }
    
    // 初始化
    init();
  </script>
</body>
</html>
