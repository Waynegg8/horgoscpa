<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="外部內容管理（官網 CMS）" />
    <title>外部內容管理｜CMS</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/internal-system.css" />
    <link rel="stylesheet" href="/assets/css/internal-components.css" />
    <style>
      .cms-content {
        padding: 24px;
        max-width: 1400px;
        margin: 0 auto;
      }
      
      .tab-nav {
        display: flex;
        gap: 8px;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 24px;
      }
      
      .tab-btn {
        padding: 12px 24px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: #6b7280;
        transition: all 0.2s;
        margin-bottom: -2px;
      }
      
      .tab-btn:hover {
        color: #1f2937;
        background: #f9fafb;
      }
      
      .tab-btn.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
      }
      
      .tab-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .tab-panel {
        display: none;
      }
      
      .tab-panel.active {
        display: block;
      }
      
      .filter-bar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 16px;
      }
      
      .filter-spacer {
        flex: 1;
      }
      
      .input-sm {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
      }
      
      .search-input {
        min-width: 200px;
      }
      
      .doc-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        transition: all 0.2s;
      }
      
      .doc-card:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      
      .doc-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #1f2937;
      }
      
      .doc-meta {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 12px;
      }
      
      .doc-meta-item {
        margin-bottom: 4px;
      }
      
      .doc-footer {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
      
      .grid {
        display: grid;
        gap: 16px;
      }
      
      .grid-cols-1 {
        grid-template-columns: repeat(1, 1fr);
      }
      
      @media (min-width: 768px) {
        .md\:grid-cols-2 {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      
      @media (min-width: 1024px) {
        .lg\:grid-cols-3 {
          grid-template-columns: repeat(3, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div id="navbar-placeholder"></div>

    <main class="cms-content">
      <div id="permBar" class="alert alert-error" style="display:none; margin-bottom:20px;" role="alert">您沒有權限存取此模組</div>

      <nav class="tab-nav" role="tablist" aria-label="內容類型">
        <button class="tab-btn active" role="tab" aria-selected="true" data-tab="blog">Blog 文章</button>
        <button class="tab-btn" role="tab" aria-selected="false" data-tab="faq">FAQ</button>
        <button class="tab-btn" role="tab" aria-selected="false" data-tab="services">服務介紹</button>
        <button class="tab-btn" role="tab" aria-selected="false" data-tab="resources">資源下載</button>
      </nav>

      <!-- Blog 文章 -->
      <section id="panel-blog" class="tab-panel active" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Blog 文章管理</h2>
            <button id="btnNewPost" class="btn btn-primary" type="button">+ 新增文章</button>
          </div>
          <div class="card-body">
            <div class="filter-bar">
              <select id="blogStatus" class="input-sm">
                <option value="all">全部狀態</option>
                <option value="published">已發布</option>
                <option value="draft">草稿</option>
              </select>
              <select id="blogCategory" class="input-sm">
                <option value="all">全部分類</option>
              </select>
              <input id="blogTags" type="text" placeholder="標籤（逗號分隔）" class="input-sm" />
              <div class="filter-spacer"></div>
              <input id="blogSearch" type="search" placeholder="搜尋標題…" class="input-sm search-input" />
            </div>
            <div class="table-wrapper">
              <table class="table" aria-label="文章列表">
                <thead>
                  <tr>
                    <th>標題</th>
                    <th>分類</th>
                    <th>標籤</th>
                    <th>狀態</th>
                    <th>更新時間</th>
                    <th>瀏覽數</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="blogTbody">
                  <tr><td colspan="7" class="text-center text-muted">載入中…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- FAQ -->
      <section id="panel-faq" class="tab-panel" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">FAQ 管理</h2>
            <button id="btnNewFAQ" class="btn btn-primary" type="button">+ 新增 FAQ</button>
          </div>
          <div class="card-body">
            <div class="filter-bar">
              <select id="faqCategory" class="input-sm">
                <option value="all">全部分類</option>
              </select>
              <select id="faqStatus" class="input-sm">
                <option value="all">全部狀態</option>
                <option value="published">已發布</option>
                <option value="draft">草稿</option>
              </select>
              <div class="filter-spacer"></div>
              <input id="faqSearch" type="search" placeholder="搜尋問題…" class="input-sm search-input" />
            </div>
            <div class="table-wrapper">
              <table class="table" aria-label="FAQ 列表">
                <thead>
                  <tr>
                    <th>分類</th>
                    <th>問題</th>
                    <th>排序</th>
                    <th>狀態</th>
                    <th>更新時間</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="faqTbody">
                  <tr><td colspan="6" class="text-center text-muted">載入中…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- 服務介紹 -->
      <section id="panel-services" class="tab-panel" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">服務介紹管理</h2>
            <span class="text-muted">共 4 個服務介紹</span>
          </div>
          <div class="card-body">
            <div id="serviceCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3"></div>
          </div>
        </div>
      </section>

      <!-- 資源下載 -->
      <section id="panel-resources" class="tab-panel" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">資源下載管理</h2>
            <button id="btnUploadResource" class="btn btn-primary" type="button">上傳資源</button>
          </div>
          <div class="card-body">
            <div class="filter-bar">
              <select id="resCategory" class="input-sm">
                <option value="all">全部分類</option>
              </select>
              <select id="resType" class="input-sm">
                <option value="all">全部類型</option>
                <option value="pdf">PDF</option>
                <option value="excel">Excel</option>
                <option value="word">Word</option>
                <option value="zip">ZIP</option>
                <option value="image">圖片</option>
              </select>
              <div class="filter-spacer"></div>
              <input id="resSearch" type="search" placeholder="搜尋標題…" class="input-sm search-input" />
            </div>
            <div class="table-wrapper">
              <table class="table" aria-label="資源列表">
                <thead>
                  <tr>
                    <th>標題</th>
                    <th>分類</th>
                    <th>檔案類型</th>
                    <th>檔案大小</th>
                    <th>下載次數</th>
                    <th>更新時間</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="resTbody">
                  <tr><td colspan="7" class="text-center text-muted">載入中…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div id="footer-placeholder"></div>

    <script>
      const CMS = (function() {
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        // Utility functions
        const utils = {
          fmtBytes(n) {
            const b = Number(n || 0);
            if (b < 1024) return `${b} B`;
            if (b < 1024 * 1024) return `${(b / 1024).toFixed(1)} KB`;
            if (b < 1024 * 1024 * 1024) return `${(b / 1024 / 1024).toFixed(1)} MB`;
            return `${(b / 1024 / 1024 / 1024).toFixed(2)} GB`;
          },
          
          joinTags(tags) {
            return (Array.isArray(tags) ? tags : []).map(t => `<span class="badge">${t}</span>`).join(' ');
          },

          async handleApiError(res, context) {
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/cms');
              return true;
            }
            return false;
          }
        };

        // Auth check
        async function ensureAdmin() {
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials: 'include' });
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/cms');
              return false;
            }
            const json = await res.json();
            const isAdmin = !!(json?.ok && json.data?.isAdmin);
            if (!isAdmin) {
              document.getElementById('permBar').style.display = 'block';
              setUIEnabled(false);
              return false;
            }
            setUIEnabled(true);
            return true;
          } catch (_) {
            document.getElementById('permBar').textContent = '載入失敗，請稍後再試';
            document.getElementById('permBar').style.display = 'block';
            setUIEnabled(false);
            return false;
          }
        }

        function setUIEnabled(enabled) {
          document.querySelectorAll('.tab-btn, .filter-bar input, .filter-bar select, .card-header button').forEach(el => {
            el.disabled = !enabled;
          });
        }

        // Tab management
        function initTabs() {
          const tabs = document.querySelectorAll('.tab-btn');
          tabs.forEach(btn => {
            btn.addEventListener('click', () => {
              tabs.forEach(b => {
                b.classList.remove('active');
                b.setAttribute('aria-selected', 'false');
              });
              btn.classList.add('active');
              btn.setAttribute('aria-selected', 'true');
              
              const targetPanel = btn.getAttribute('data-tab');
              document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
              });
              document.getElementById(`panel-${targetPanel}`).classList.add('active');
            });
          });
        }

        // Blog functions
        const blog = {
          async render() {
            const tbody = document.getElementById('blogTbody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">載入中…</td></tr>';
            
            const params = new URLSearchParams();
            const status = document.getElementById('blogStatus').value;
            const category = document.getElementById('blogCategory').value;
            const tagsVal = document.getElementById('blogTags').value.trim();
            const keyword = document.getElementById('blogSearch').value.trim();
            
            if (status !== 'all') params.set('status', status);
            if (category && category !== 'all') params.set('category', category);
            if (tagsVal) params.set('tag', tagsVal.split(',').map(s => s.trim()).filter(Boolean)[0] || '');
            if (keyword) params.set('keyword', keyword);
            
            try {
              const res = await fetch(`${apiBase}/admin/articles?${params.toString()}`, { credentials: 'include' });
              if (await utils.handleApiError(res)) return;
              
              const json = await res.json();
              if (!res.ok || !json?.ok) throw new Error();
              
              const rows = json.data || [];
              tbody.innerHTML = '';
              if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">尚無資料</td></tr>';
                return;
              }
              
              rows.forEach(r => {
                const tr = document.createElement('tr');
                const statusBadge = r.isPublished ? '<span class="badge badge-success">已發布</span>' : '<span class="badge badge-secondary">草稿</span>';
                tr.innerHTML = `
                  <td>${r.title || ''}</td>
                  <td>${r.category || ''}</td>
                  <td>${utils.joinTags(r.tags)}</td>
                  <td>${statusBadge}</td>
                  <td>${r.updatedAt || ''}</td>
                  <td>${Number(r.viewCount || 0)}</td>
                  <td>
                    <button class="btn btn-sm" onclick="CMS.blog.edit(${r.id})">編輯</button>
                    ${!r.isPublished ? `<button class="btn btn-sm btn-success" onclick="CMS.blog.publish(${r.id})">發布</button>` : ''}
                    <button class="btn btn-sm btn-danger" onclick="CMS.blog.delete(${r.id})">刪除</button>
                  </td>
                `;
                tbody.appendChild(tr);
              });
            } catch (_) {
              tbody.innerHTML = '<tr><td colspan="7" class="text-center text-error">載入失敗</td></tr>';
            }
          },
          
          edit(id) {
            location.assign(`/internal/blog-editor.html?id=${id}`);
          },
          
          async publish(id) {
            if (!confirm('確定要發布此文章嗎？')) return;
            try {
              const res = await fetch(`${apiBase}/admin/articles/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ isPublished: true })
              });
              const json = await res.json();
              if (!res.ok || !json.ok) throw new Error(json.message || '發布失敗');
              alert('文章已發布！');
              this.render();
            } catch (err) {
              alert('發布失敗：' + err.message);
            }
          },
          
          async delete(id) {
            if (!confirm('確定要刪除此文章嗎？此操作無法復原。')) return;
            try {
              const res = await fetch(`${apiBase}/admin/articles/${id}`, {
                method: 'DELETE',
                credentials: 'include'
              });
              const json = await res.json();
              if (!res.ok || !json.ok) throw new Error(json.message || '刪除失敗');
              alert('文章已刪除');
              this.render();
            } catch (err) {
              alert('刪除失敗：' + err.message);
            }
          }
        };

        // FAQ functions
        const faq = {
          async render() {
            const tbody = document.getElementById('faqTbody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">載入中…</td></tr>';
            
            const params = new URLSearchParams();
            const status = document.getElementById('faqStatus').value;
            const category = document.getElementById('faqCategory').value;
            const keyword = document.getElementById('faqSearch').value.trim();
            
            if (status !== 'all') params.set('status', status);
            if (category && category !== 'all') params.set('category', category);
            if (keyword) params.set('keyword', keyword);
            
            try {
              const res = await fetch(`${apiBase}/admin/faq?${params.toString()}`, { credentials: 'include' });
              if (await utils.handleApiError(res)) return;
              
              const json = await res.json();
              if (!res.ok || !json?.ok) throw new Error();
              
              const rows = json.data || [];
              tbody.innerHTML = '';
              if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">尚無資料</td></tr>';
                return;
              }
              
              rows.forEach(r => {
                const tr = document.createElement('tr');
                const statusBadge = r.isPublished ? '<span class="badge badge-success">已發布</span>' : '<span class="badge badge-secondary">草稿</span>';
                tr.innerHTML = `
                  <td>${r.category || ''}</td>
                  <td>${r.question || ''}</td>
                  <td>${Number(r.sortOrder || 0)}</td>
                  <td>${statusBadge}</td>
                  <td>${r.updatedAt || ''}</td>
                  <td>
                    <button class="btn btn-sm" onclick="location.assign('/internal/faq-editor.html?id=${r.id}')">編輯</button>
                    <button class="btn btn-sm btn-danger" onclick="CMS.faq.delete(${r.id})">刪除</button>
                  </td>
                `;
                tbody.appendChild(tr);
              });
            } catch (_) {
              tbody.innerHTML = '<tr><td colspan="6" class="text-center text-error">載入失敗</td></tr>';
            }
          },
          
          async delete(id) {
            if (!confirm('確定要刪除此 FAQ 嗎？')) return;
            try {
              const res = await fetch(`${apiBase}/admin/faq/${id}`, {
                method: 'DELETE',
                credentials: 'include'
              });
              const json = await res.json();
              if (!res.ok || !json.ok) throw new Error(json.message || '刪除失敗');
              alert('FAQ 已刪除');
              this.render();
            } catch (err) {
              alert('刪除失敗：' + err.message);
            }
          }
        };

        // Service functions
        const services = {
          async render() {
            const wrap = document.getElementById('serviceCards');
            wrap.innerHTML = '<div class="text-center text-muted">載入中…</div>';
            
            try {
              const res = await fetch(`${apiBase}/admin/services`, { credentials: 'include' });
              if (await utils.handleApiError(res)) return;
              
              const json = await res.json();
              if (!res.ok || !json?.ok) throw new Error();
              
              const rows = json.data || [];
              wrap.innerHTML = '';
              if (!rows.length) {
                wrap.innerHTML = '<div class="text-center text-muted">尚無資料</div>';
                return;
              }
              
              rows.forEach(r => {
                const div = document.createElement('div');
                div.className = 'doc-card';
                const badge = r.isPublished ? '<span class="badge badge-success">已發布</span>' : '<span class="badge badge-secondary">草稿</span>';
                div.innerHTML = `
                  <div class="doc-title">${r.title || r.key} ${badge}</div>
                  <div class="doc-meta">
                    <div class="doc-meta-item">Key: ${r.key}</div>
                    <div class="doc-meta-item">最後更新：${r.updatedAt || ''}</div>
                  </div>
                  <div class="doc-footer">
                    <button class="btn btn-sm btn-primary" onclick="location.assign('/internal/service-editor.html?id=${r.id}')">編輯</button>
                  </div>
                `;
                wrap.appendChild(div);
              });
            } catch (_) {
              wrap.innerHTML = '<div class="text-center text-error">載入失敗</div>';
            }
          }
        };

        // Resource functions
        const resources = {
          async render() {
            const tbody = document.getElementById('resTbody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">載入中…</td></tr>';
            
            const params = new URLSearchParams();
            const category = document.getElementById('resCategory').value;
            const type = document.getElementById('resType').value;
            const keyword = document.getElementById('resSearch').value.trim();
            
            if (category && category !== 'all') params.set('category', category);
            if (type && type !== 'all') params.set('file_type', type);
            if (keyword) params.set('keyword', keyword);
            
            try {
              const res = await fetch(`${apiBase}/admin/resources?${params.toString()}`, { credentials: 'include' });
              if (await utils.handleApiError(res)) return;
              
              const json = await res.json();
              if (!res.ok || !json?.ok) throw new Error();
              
              const rows = json.data || [];
              tbody.innerHTML = '';
              if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">尚無資料</td></tr>';
                return;
              }
              
              rows.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${r.title || ''}</td>
                  <td>${r.category || ''}</td>
                  <td>${r.fileType || ''}</td>
                  <td>${utils.fmtBytes(r.fileSize)}</td>
                  <td>${Number(r.downloadCount || 0)}</td>
                  <td>${r.updatedAt || ''}</td>
                  <td>
                    ${r.fileUrl ? `<button class="btn btn-sm" onclick="window.open('${r.fileUrl}', '_blank')">下載</button>` : ''}
                    <button class="btn btn-sm" onclick="location.assign('/internal/resource-editor.html?id=${r.id}')">編輯</button>
                    <button class="btn btn-sm btn-danger" onclick="CMS.resources.delete(${r.id})">刪除</button>
                  </td>
                `;
                tbody.appendChild(tr);
              });
            } catch (_) {
              tbody.innerHTML = '<tr><td colspan="7" class="text-center text-error">載入失敗</td></tr>';
            }
          },
          
          async delete(id) {
            if (!confirm('確定要刪除此資源嗎？')) return;
            try {
              const res = await fetch(`${apiBase}/admin/resources/${id}`, {
                method: 'DELETE',
                credentials: 'include'
              });
              const json = await res.json();
              if (!res.ok || !json.ok) throw new Error(json.message || '刪除失敗');
              alert('資源已刪除');
              this.render();
            } catch (err) {
              alert('刪除失敗：' + err.message);
            }
          }
        };

        // Event handlers
        function initEvents() {
          let t1 = null, t2 = null, t3 = null;
          
          document.getElementById('btnNewPost').addEventListener('click', () => location.assign('/internal/blog-editor.html'));
          document.getElementById('btnNewFAQ').addEventListener('click', () => location.assign('/internal/faq-editor.html'));
          document.getElementById('btnUploadResource').addEventListener('click', () => location.assign('/internal/resource-editor.html'));
          
          document.getElementById('blogSearch').addEventListener('input', () => { clearTimeout(t1); t1 = setTimeout(() => blog.render(), 300); });
          document.getElementById('blogStatus').addEventListener('change', () => blog.render());
          document.getElementById('blogCategory').addEventListener('change', () => blog.render());
          document.getElementById('blogTags').addEventListener('change', () => blog.render());
          
          document.getElementById('faqSearch').addEventListener('input', () => { clearTimeout(t2); t2 = setTimeout(() => faq.render(), 300); });
          document.getElementById('faqCategory').addEventListener('change', () => faq.render());
          document.getElementById('faqStatus').addEventListener('change', () => faq.render());
          
          document.getElementById('resSearch').addEventListener('input', () => { clearTimeout(t3); t3 = setTimeout(() => resources.render(), 300); });
          document.getElementById('resCategory').addEventListener('change', () => resources.render());
          document.getElementById('resType').addEventListener('change', () => resources.render());
        }

        // Initialize
        async function init() {
          initTabs();
          initEvents();
          
          const isAdmin = await ensureAdmin();
          if (isAdmin) {
            blog.render();
            faq.render();
            services.render();
            resources.render();
          }
        }

        // Public API
        return {
          init,
          blog,
          faq,
          services,
          resources
        };
      })();

      // Start the app when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', CMS.init);
      } else {
        CMS.init();
      }
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
</html>
