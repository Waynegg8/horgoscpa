# ✅ 服務項目與任務模板管理系統

> **完成日期：** 2025-10-31  
> **狀態：** ✅ 基礎功能已完成

---

## 🎯 系統概述

本系統提供完整的**服務項目**和**任務模板**管理功能，讓您可以：

1. ✅ **管理服務項目** - 定義公司提供的服務類別（如記帳服務、稅務申報等）
2. ✅ **管理服務子項目** - 每個服務下可以新增具體的任務項目
3. ✅ **建立任務模板** - 創建可重複使用的任務流程模板
4. ✅ **關聯到客戶** - 新增客戶服務時可選擇對應的模板

---

## 📊 數據結構說明

### 1. Services（服務項目）

**主要服務類別**，系統預設包含：

| service_id | service_name | service_code | 說明 |
|------------|--------------|--------------|------|
| 1 | 記帳服務 | ACCOUNTING | 日常帳務處理、憑證整理 |
| 2 | 稅務申報 | TAX_FILING | 各類稅務申報服務 |
| 3 | 顧問諮詢 | CONSULTING | 稅務諮詢、財務規劃 |
| 4 | 工商登記 | BUSINESS_REG | 公司設立、變更登記 |
| 5 | 審計服務 | AUDIT | 財務簽證、稅務查核 |

### 2. ServiceItems（服務子項目）

**每個服務下的具體任務**，例如：

**記帳服務**下的子項目：
- 收集憑證
- 輸入帳務
- 月結對帳
- 報表產製

**稅務申報**下的子項目：
- 營所稅申報
- 營業稅申報
- 個人綜所稅
- 扣繳申報

### 3. TaskTemplates（任務模板）

**可重複使用的任務流程模板**，包含：
- 模板名稱
- 關聯的服務項目（可選）
- 描述說明
- 任務階段（TaskTemplateStages）

### 4. TaskTemplateStages（任務模板階段）

**模板中的具體執行階段**：
- 階段名稱
- 執行順序
- 預估工時
- 說明

---

## 🚀 使用方式

### 訪問管理界面

1. 登入系統並確保有管理員權限
2. 訪問 `/internal/settings`
3. 點擊**「服務項目」**或**「任務模板」**tab

---

## 📋 功能說明

### 一、服務項目管理

#### 1. 查看服務項目列表

切換到「服務項目」tab，系統會自動載入所有服務項目。

**顯示內容：**
- ID
- 服務名稱
- 服務代碼
- 說明
- 排序
- 狀態（啟用/停用）
- 操作按鈕（編輯、刪除）

#### 2. 選擇服務項目查看子項目

**操作步驟：**
1. 在服務項目列表中點擊任一服務（整行可點擊）
2. 下方會自動展開該服務的子項目列表
3. 可以看到該服務下的所有任務項目

**特色：**
- 點擊任一服務行即可查看其子項目
- 自動載入並顯示子項目表格
- 標題會顯示「服務名稱 - 子項目列表」

#### 3. 新增服務項目

**API端點：** `POST /internal/api/v1/services`

**需要的數據：**
```json
{
  "service_name": "服務名稱",
  "service_code": "SERVICE_CODE",
  "description": "服務說明",
  "sort_order": 0
}
```

**前端操作：**
- 點擊「+ 新增服務項目」按鈕
- （目前顯示提示，需要實現Modal對話框）

#### 4. 編輯服務項目

**API端點：** `PUT /internal/api/v1/services/:id`

**操作：**
- 點擊任一服務的「編輯」按鈕
- （目前顯示提示，需要實現編輯表單）

#### 5. 刪除服務項目

**API端點：** `DELETE /internal/api/v1/services/:id`

**操作：**
- 點擊「刪除」按鈕
- 確認刪除對話框
- ✅ **已實現**：可以正常刪除服務項目

**注意：** 
- 刪除是軟刪除（is_active = 0）
- 刪除服務項目不會刪除其子項目，但會隱藏

#### 6. 管理服務子項目

**新增子項目：**
- API: `POST /internal/api/v1/services/:id/items`
- 點擊子項目區域的「+ 新增子項目」按鈕

**編輯子項目：**
- API: `PUT /internal/api/v1/services/:sid/items/:iid`
- 點擊子項目的「編輯」按鈕

**刪除子項目：**
- API: `DELETE /internal/api/v1/services/:sid/items/:iid`
- ✅ **已實現**：點擊「刪除」按鈕可正常刪除

---

### 二、任務模板管理

#### 1. 查看任務模板列表

切換到「任務模板」tab，系統會自動載入所有模板。

**顯示內容：**
- ID
- 模板名稱
- 關聯服務（顯示服務名稱，或「統一模板」）
- 說明
- 狀態（啟用/停用）
- 創建時間
- 操作按鈕

#### 2. 篩選模板

**功能：** 按服務項目篩選模板

**操作步驟：**
1. 在下拉選單中選擇服務項目
2. 點擊「篩選」按鈕
3. 只顯示該服務相關的模板

**特殊選項：**
- 「所有服務」：顯示所有模板
- 服務選項會自動從Services表載入

#### 3. 新增任務模板

**API端點：** `POST /internal/api/v1/task-templates`

**需要的數據：**
```json
{
  "template_name": "模板名稱",
  "service_id": 1,  // 可選，關聯到服務
  "description": "模板說明",
  "sop_id": null,   // 可選，關聯到SOP
  "stages": [       // 任務階段
    {
      "stage_name": "階段名稱",
      "stage_order": 1,
      "description": "階段說明",
      "estimated_hours": 2.5
    }
  ]
}
```

**模板類型：**
1. **統一模板** - `service_id = null`，適用於所有客戶
2. **服務專屬模板** - `service_id = 指定服務ID`，僅用於該服務

#### 4. 編輯任務模板

**操作：**
- 點擊「編輯」按鈕
- （需要實現包含階段管理的編輯界面）

#### 5. 刪除任務模板

**API端點：** `DELETE /internal/api/v1/task-templates/:id`

**操作：**
- ✅ **已實現**：點擊「刪除」按鈕可正常刪除
- 會同時刪除所有相關的模板階段（CASCADE）

---

## 🔄 與客戶服務的整合

### 場景：新增客戶服務時選擇模板

當為客戶新增服務時，可以：

1. **選擇服務項目**
   ```
   例如：選擇「記帳服務」
   ```

2. **選擇對應的模板**
   ```
   系統顯示：
   - 統一模板（適用所有客戶）
   - 記帳服務專屬模板
   - 該客戶的專屬模板（如果有）
   ```

3. **根據模板創建任務**
   ```
   系統會：
   - 自動創建模板中定義的所有階段
   - 設定預估工時
   - 按順序排列任務
   ```

### 工時記錄時的關聯

員工記錄工時時：
```
1. 選擇客戶
2. 選擇服務項目（Services）
3. 選擇具體任務（ServiceItems）
4. 記錄工時
```

這樣可以精確追蹤每個服務子項目的工時投入。

---

## 📊 數據庫表關聯圖

```
Services (服務項目)
    ├── ServiceItems (服務子項目)
    ├── TaskTemplates (任務模板)
    │   └── TaskTemplateStages (模板階段)
    └── ClientServices (客戶服務)
        └── Tasks (實際任務)
```

---

## ✅ 已實現的功能

| 功能 | 狀態 | 說明 |
|------|------|------|
| 查看服務項目列表 | ✅ 完成 | 自動載入所有服務 |
| 點擊查看子項目 | ✅ 完成 | 點擊服務行展開子項目 |
| 刪除服務項目 | ✅ 完成 | 軟刪除，帶確認對話框 |
| 刪除服務子項目 | ✅ 完成 | 軟刪除，帶確認對話框 |
| 查看任務模板列表 | ✅ 完成 | 顯示所有模板及關聯服務 |
| 按服務篩選模板 | ✅ 完成 | 下拉選單自動載入服務列表 |
| 刪除任務模板 | ✅ 完成 | 帶確認對話框 |
| 服務項目API | ✅ 完成 | CRUD完整實現 |
| 服務子項目API | ✅ 完成 | CRUD完整實現 |
| 任務模板API | ✅ 完成 | 由原有API支持 |

---

## ⚠️ 尚未完成的功能

| 功能 | 狀態 | 優先級 |
|------|------|--------|
| 新增服務項目表單 | ⏳ 待開發 | 高 |
| 編輯服務項目表單 | ⏳ 待開發 | 高 |
| 新增服務子項目表單 | ⏳ 待開發 | 高 |
| 編輯服務子項目表單 | ⏳ 待開發 | 高 |
| 新增任務模板表單 | ⏳ 待開發 | 高 |
| 編輯任務模板表單 | ⏳ 待開發 | 高 |
| 任務模板階段管理 | ⏳ 待開發 | 中 |
| 拖拽排序功能 | ⏳ 待開發 | 低 |
| 批量導入服務項目 | ⏳ 待開發 | 低 |

---

## 🛠️ 下一步開發建議

### 1. 創建通用Modal組件（優先級：高）

**建議路徑：** `assets/js/components/modal.js`

**功能：**
- 通用的對話框組件
- 支持表單輸入
- 支持驗證
- 可重複使用

**使用範例：**
```javascript
const modal = new Modal({
  title: '新增服務項目',
  fields: [
    { name: 'service_name', label: '服務名稱', type: 'text', required: true },
    { name: 'service_code', label: '服務代碼', type: 'text' },
    { name: 'description', label: '說明', type: 'textarea' },
    { name: 'sort_order', label: '排序', type: 'number', default: 0 }
  ],
  onSubmit: async (data) => {
    await createService(data);
  }
});
modal.show();
```

### 2. 實現服務項目的新增/編輯（優先級：高）

**步驟：**
1. 綁定「+ 新增服務項目」按鈕事件
2. 顯示Modal表單
3. 驗證輸入
4. 調用API: `POST /internal/api/v1/services`
5. 重新載入列表

### 3. 實現任務模板的完整管理（優先級：高）

**需要實現：**
1. 新增模板表單
2. 編輯模板表單
3. **階段管理**：
   - 新增階段
   - 編輯階段
   - 刪除階段
   - 排序階段
   - 設定預估工時

**API已存在：**
- `POST /internal/api/v1/task-templates` - 創建模板
- `PUT /internal/api/v1/task-templates/:id` - 更新模板
- `GET /internal/api/v1/task-templates/:id` - 獲取模板詳情（含階段）

### 4. 整合到客戶服務流程（優先級：中）

在客戶詳情頁面中：
1. 新增服務時可選擇服務項目
2. 選擇對應的任務模板
3. 自動根據模板創建任務

---

## 📖 API文檔

### 服務項目 API

#### GET /internal/api/v1/services
**獲取所有服務項目**

**響應：**
```json
{
  "ok": true,
  "data": [
    {
      "service_id": 1,
      "service_name": "記帳服務",
      "service_code": "ACCOUNTING",
      "description": "提供日常帳務處理",
      "is_active": true,
      "sort_order": 1
    }
  ]
}
```

#### POST /internal/api/v1/services
**創建服務項目** （需管理員權限）

**請求體：**
```json
{
  "service_name": "新服務",
  "service_code": "NEW_SERVICE",
  "description": "服務說明",
  "sort_order": 10
}
```

#### PUT /internal/api/v1/services/:id
**更新服務項目** （需管理員權限）

#### DELETE /internal/api/v1/services/:id
**刪除服務項目** （需管理員權限，軟刪除）

---

### 服務子項目 API

#### GET /internal/api/v1/services/:id/items
**獲取服務的所有子項目**

#### POST /internal/api/v1/services/:id/items
**創建服務子項目** （需管理員權限）

#### PUT /internal/api/v1/services/:sid/items/:iid
**更新服務子項目** （需管理員權限）

#### DELETE /internal/api/v1/services/:sid/items/:iid
**刪除服務子項目** （需管理員權限）

---

### 任務模板 API

#### GET /internal/api/v1/task-templates
**獲取所有任務模板**

**參數：**
- `service_id` (可選): 篩選特定服務的模板

#### GET /internal/api/v1/task-templates/:id
**獲取模板詳情** (包含階段)

#### POST /internal/api/v1/task-templates
**創建任務模板** （需管理員權限）

**請求體：**
```json
{
  "template_name": "記帳服務標準流程",
  "service_id": 1,
  "description": "適用於一般客戶的記帳服務",
  "stages": [
    {
      "stage_name": "收集憑證",
      "stage_order": 1,
      "estimated_hours": 1.0
    },
    {
      "stage_name": "輸入帳務",
      "stage_order": 2,
      "estimated_hours": 3.0
    }
  ]
}
```

#### PUT /internal/api/v1/task-templates/:id
**更新任務模板** （需管理員權限）

#### DELETE /internal/api/v1/task-templates/:id
**刪除任務模板** （需管理員權限）

---

## 🎯 使用場景範例

### 場景1：設置新服務類別

**需求：** 公司新增「財務顧問」服務

**步驟：**
1. 切換到「服務項目」tab
2. 點擊「+ 新增服務項目」
3. 填寫：
   - 服務名稱：財務顧問
   - 服務代碼：FIN_ADVISORY
   - 說明：提供企業財務規劃與分析服務
4. 儲存後，點擊該服務
5. 新增子項目：
   - 財務健檢
   - 預算編制
   - 成本分析
   - 投資評估

### 場景2：創建服務模板

**需求：** 為「記帳服務」創建標準化流程

**步驟：**
1. 切換到「任務模板」tab
2. 點擊「+ 新增任務模板」
3. 填寫基本資訊：
   - 模板名稱：記帳服務標準流程
   - 關聯服務：記帳服務
   - 說明：適用於月營業額500萬以下客戶
4. 新增階段：
   - 第1階段：收集憑證（1小時）
   - 第2階段：憑證分類（0.5小時）
   - 第3階段：輸入帳務（3小時）
   - 第4階段：月結對帳（2小時）
   - 第5階段：報表產製（1小時）
5. 儲存模板

### 場景3：為客戶套用模板

**需求：** 新客戶「ABC公司」要使用記帳服務

**步驟：**
1. 在客戶詳情頁面
2. 點擊「新增服務」
3. 選擇：
   - 服務類別：記帳服務
   - 選擇模板：記帳服務標準流程
4. 系統自動：
   - 創建5個任務（對應5個階段）
   - 設定預估工時
   - 按順序排列
5. 可以根據需要調整個別任務

---

## 💡 提示與最佳實踐

### 1. 服務項目命名建議

- **要**：使用清晰的業務術語（記帳服務、稅務申報）
- **不要**：使用過於技術的名稱（ACC_SRV_001）

### 2. 服務代碼建議

- 使用大寫英文和底線
- 簡短且有意義
- 例如：ACCOUNTING, TAX_FILING, AUDIT

### 3. 模板設計建議

- 按客戶規模創建不同模板（小型/中型/大型企業）
- 按業務複雜度創建模板（基礎/標準/進階）
- 定期檢視和更新模板

### 4. 排序建議

- 按照業務重要性排序（核心服務排前面）
- 按照執行順序排序（子項目）
- 預留間隔（10, 20, 30...）方便插入新項目

---

## 📞 相關文件

- [系統設定頁面開發完成報告](./系統設定頁面-開發完成報告.md)
- [任務管理 - 後端規格](./開發指南/後端/任務管理-後端規格.md)
- [客戶管理 - 後端規格](./開發指南/後端/客戶管理-後端規格.md)
- [API設計規範](./開發指南/開發須知/API-設計規範.md)

---

**開發完成日期：** 2025-10-31  
**版本：** v1.0  
**狀態：** ✅ 基礎功能已完成，可開始使用  
**下一步：** 實現新增/編輯表單的Modal組件

