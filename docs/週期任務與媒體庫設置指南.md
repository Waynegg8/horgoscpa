# 週期性任務與媒體庫設置指南

本指南說明如何解決週期性任務資料庫錯誤，以及如何使用新的媒體庫和資源管理功能。

## 目錄

1. [問題概述](#問題概述)
2. [解決週期性任務資料庫錯誤](#解決週期性任務資料庫錯誤)
3. [媒體庫功能使用](#媒體庫功能使用)
4. [資源管理功能使用](#資源管理功能使用)
5. [常見問題](#常見問題)

---

## 問題概述

### 1. 週期性任務資料庫錯誤

**錯誤訊息：**
```
Error: D1_ERROR: no such table: recurring_task_instances: SQLITE_ERROR
```

**原因：**
資料庫遷移檔案 `011_recurring_tasks.sql` 尚未在生產環境執行。

**影響：**
- 無法載入週期性任務頁面
- 無法生成每月固定任務
- 週期任務管理功能無法使用

### 2. 媒體庫和資源管理無上傳功能

**現象：**
- 內容編輯器中的「媒體庫」和「資源管理」頁籤只顯示佔位文字
- 無法上傳圖片或文件
- 無法管理已上傳的媒體

**原因：**
前端 UI 尚未實作，僅有後端 API。

---

## 解決週期性任務資料庫錯誤

### 方法 1：使用自動化腳本（推薦）

1. **進入 API 目錄**
   ```powershell
   cd timesheet-api
   ```

2. **執行遷移腳本**
   ```powershell
   .\run-migrations.ps1
   ```

3. **按照提示操作**
   - 選擇環境（生產/開發/本地）
   - 選擇要執行的遷移（建議選擇 `11` 執行週期性任務遷移）
   - 確認執行

4. **驗證結果**
   - 腳本會顯示執行結果
   - 如果顯示「✓ 成功」，表示遷移完成

### 方法 2：手動執行 Wrangler 命令

#### A. 在生產環境執行

```powershell
cd timesheet-api
npx wrangler d1 execute timesheet-db --remote --file=migrations/011_recurring_tasks.sql
```

#### B. 在預覽環境執行（測試用）

```powershell
npx wrangler d1 execute timesheet-db --remote --env preview --file=migrations/011_recurring_tasks.sql
```

#### C. 在本地環境執行（開發用）

```powershell
npx wrangler d1 execute timesheet-db --local --file=migrations/011_recurring_tasks.sql
```

### 驗證遷移是否成功

執行以下命令檢查表是否建立：

```powershell
npx wrangler d1 execute timesheet-db --remote --command="SELECT name FROM sqlite_master WHERE type='table' AND name LIKE 'recurring%';"
```

應該會看到以下表：
- `client_services`
- `recurring_task_templates`
- `recurring_task_instances`
- `recurring_task_generation_log`
- `task_reminders`

### 測試週期性任務功能

1. 登入系統
2. 前往「週期任務」頁面 (`recurring-tasks.html`)
3. 選擇年月（例如：2025年10月）
4. 點擊「生成本月任務」按鈕
5. 系統會根據客戶服務配置自動生成任務

---

## 媒體庫功能使用

### 功能概述

媒體庫用於管理網站使用的圖片資源（例如：封面圖、文章插圖、SOP 附圖等）。

### 存取媒體庫

1. 登入系統
2. 前往「內容」→「內容管理」(`content-editor.html`)
3. 點擊「媒體庫」頁籤

### 上傳圖片

1. **點擊「上傳圖片」按鈕**
2. **選擇圖片檔案**
   - 支援格式：JPEG、PNG、GIF、WebP
   - 檔案大小限制：5MB
3. **等待上傳完成**
   - 顯示「上傳中...」通知
   - 完成後顯示「上傳成功」
   - 圖片自動出現在媒體庫列表中

### 管理圖片

#### 複製圖片連結
- 點擊圖片卡片上的「複製」按鈕
- 連結會自動複製到剪貼簿
- 可用於在文章或 SOP 中插入圖片

#### 預覽圖片
- 點擊圖片預覽
- 全螢幕查看圖片
- 點擊任意位置關閉預覽

#### 刪除圖片
- 點擊圖片卡片上的「刪除」按鈕
- 確認刪除
- 圖片會從資料庫和 R2 儲存空間中移除

### 技術細節

- **儲存位置：** Cloudflare R2 (images/ 路徑)
- **資料庫記錄：** media_library 表
- **API 端點：**
  - 上傳：`POST /api/upload/image`
  - 列表：`GET /api/media?type=image&limit=100`
  - 刪除：`DELETE /api/media/{mediaId}`

---

## 資源管理功能使用

### 功能概述

資源管理用於上傳和管理可下載的文件資源（例如：表單模板、操作指南、法規文件等）。

### 存取資源管理

1. 登入系統
2. 前往「內容」→「內容管理」(`content-editor.html`)
3. 點擊「資源管理」頁籤

### 上傳資源

1. **點擊「上傳資源」按鈕**
2. **填寫資源資訊**
   - 資源標題（必填）
   - 資源描述（選填）
   - 類型：模板、指南、表單、文件、其他
   - 分類：稅務、會計、創業、營運、其他
3. **選擇檔案**
   - 支援格式：PDF、DOC、DOCX、XLS、XLSX
4. **點擊「上傳」**

### 管理資源

#### 下載資源
- 點擊資源卡片上的「下載」按鈕
- 檔案會在新頁籤中開啟或下載

#### 刪除資源
- 點擊資源卡片上的「刪除」按鈕
- 確認刪除
- 資源會從系統中移除

### 前端顯示

上傳的資源會自動顯示在前台資源頁面 (`resources.html`)，供訪客瀏覽和下載。

### 技術細節

- **API 端點：**
  - 列表：`GET /api/public/resources`
  - 上傳：`POST /api/upload/resource` (待實作)
  - 刪除：`DELETE /api/resources/{resourceId}` (待實作)
- **資料庫表：** resources

**注意：** 資源上傳功能的後端 API 尚需完善，目前僅提供了基本架構。

---

## 常見問題

### Q1: 執行遷移時出現權限錯誤

**A:** 確保您已登入 Wrangler：
```powershell
npx wrangler login
```

### Q2: 遷移執行成功但頁面仍顯示錯誤

**A:** 可能需要重新部署 Worker：
```powershell
cd timesheet-api
npm run deploy
```

或使用完整部署腳本：
```powershell
.\deploy-final.ps1
```

### Q3: 媒體庫上傳後圖片無法顯示

**A:** 檢查以下幾點：
1. R2 Bucket 是否已建立並綁定到 Worker
2. R2 的公開存取設定是否正確
3. 圖片 URL 是否正確（檢查 console）

### Q4: 週期性任務生成後沒有任務

**A:** 可能的原因：
1. 客戶服務配置中沒有設定該月份的排程
2. 該月份的任務已經生成過（檢查 `recurring_task_generation_log` 表）
3. 所有服務都被標記為 `is_active = 0`

使用以下命令檢查客戶服務配置：
```powershell
npx wrangler d1 execute timesheet-db --remote --command="SELECT * FROM client_services WHERE is_active = 1 LIMIT 5;"
```

### Q5: 資源上傳失敗

**A:** 目前資源上傳的後端 API 尚未完全實作。需要：
1. 在 `media.js` 中添加資源上傳處理函數
2. 在 `index.js` 中添加路由
3. 建立 R2 的 `resources/` 路徑處理

---

## 後續改進建議

### 短期（緊急）
1. ✅ 執行 `011_recurring_tasks.sql` 遷移
2. ✅ 實作媒體庫上傳 UI
3. ⏳ 完善資源上傳後端 API

### 中期
1. 添加批量上傳功能
2. 實作圖片編輯功能（裁切、壓縮）
3. 添加資源分類和搜尋功能
4. 週期任務提醒通知功能

### 長期
1. CDN 整合優化
2. 圖片自動壓縮和格式轉換
3. 版本控制和歷史記錄
4. 使用統計和分析

---

## 聯絡支援

如果遇到問題，請提供以下資訊：
- 錯誤訊息截圖
- 瀏覽器 Console 錯誤日誌
- 執行的命令和回應
- 使用的環境（生產/開發/本地）

---

**最後更新：** 2025-10-25
**版本：** 1.0.0

