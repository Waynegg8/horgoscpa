# 知識庫系統設計

**版本**: 1.0  
**最後更新**: 2025-10-26

---

## 📋 功能概述

統一知識管理平台，包含 SOP 標準作業程序、內部文檔、常見問答等內容。

### 核心功能
- SOP 標準作業程序管理
- 內部文檔管理
- 常見問答 (FAQ)
- 階層式分類系統
- 全文搜尋
- 版本控制
- Markdown 編輯器

---

## 🏗️ 系統架構

### 三大模組

| 模組 | 說明 | 資料表 | 頁面標籤 |
|------|------|--------|----------|
| SOP 文件 | 標準作業程序 | sops, sop_categories, sop_versions | SOP文件 |
| 內部文檔 | 公司內部文件 | （與 SOP 共用結構） | 內部文檔 |
| 常見問答 | FAQ 問題集 | （前端 JSON 或資料表） | 常見問答 |

---

## 🗄️ 資料表結構

### sop_categories (分類)
```sql
CREATE TABLE sop_categories (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL UNIQUE,         -- 分類名稱
  parent_id INTEGER,                 -- 父分類（階層式）
  sort_order INTEGER DEFAULT 0,      -- 排序
  description TEXT,
  icon TEXT,                         -- Material Icons 圖示名稱
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (parent_id) REFERENCES sop_categories(id) ON DELETE CASCADE
);
```

**分類範例**：
```
會計服務
├─ 記帳服務
├─ 營業稅申報
└─ 營所稅申報

工商登記
├─ 公司設立
├─ 變更登記
└─ 解散清算

內部管理
├─ 人事管理
├─ 行政流程
└─ 資訊系統操作

常見問題
├─ 稅務問題
├─ 帳務問題
└─ 系統操作
```

### sops (文件主表)
```sql
CREATE TABLE sops (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,               -- 文件標題
  category_id INTEGER,               -- 所屬分類
  content TEXT NOT NULL,             -- 內容（Markdown）
  document_type TEXT DEFAULT 'sop',  -- sop, internal_doc, faq
  version INTEGER DEFAULT 1,         -- 版本號
  status TEXT DEFAULT 'draft',       -- draft, published, archived
  author_id INTEGER,
  business_type TEXT,                -- 關聯業務類型
  tags TEXT,                         -- 標籤（JSON）
  views INTEGER DEFAULT 0,           -- 瀏覽次數
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  published_at DATETIME,
  FOREIGN KEY (category_id) REFERENCES sop_categories(id) ON DELETE SET NULL,
  FOREIGN KEY (author_id) REFERENCES users(id)
);
```

### sop_versions (版本歷史)
```sql
CREATE TABLE sop_versions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  sop_id INTEGER NOT NULL,
  version INTEGER NOT NULL,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  author_id INTEGER,
  change_description TEXT,           -- 變更說明
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (sop_id) REFERENCES sops(id) ON DELETE CASCADE,
  FOREIGN KEY (author_id) REFERENCES users(id),
  UNIQUE(sop_id, version)
);
```

---

## 🔄 業務流程

### SOP 建立流程
```
1. 選擇文件類型（SOP / 內部文檔 / FAQ）
   ↓
2. 選擇分類
   ↓
3. 撰寫內容（Markdown 編輯器）
   ↓
4. 儲存草稿
   - INSERT INTO sops
   - document_type = 'sop'
   - status = 'draft'
   ↓
5. 審核與發布
   - UPDATE status = 'published'
   - 建立版本記錄（INSERT INTO sop_versions）
```

### 文件修訂流程
```
1. 載入現有文件
   ↓
2. 編輯內容
   ↓
3. 儲存新版本
   - 備份當前版本到 sop_versions
   - UPDATE sops SET content = 新內容, version = version + 1
   ↓
4. 記錄變更說明
```

### 搜尋流程
```
1. 輸入搜尋關鍵字
   ↓
2. 搜尋標題與內容
   - SELECT * FROM sops 
     WHERE (title LIKE ? OR content LIKE ?)
     AND document_type = ?
   ↓
3. 顯示搜尋結果
   - 高亮關鍵字
   - 顯示摘要
```

---

## 🔌 API 設計

### 取得分類樹
```
GET /api/sop-categories?type=sop

Response:
{
  "success": true,
  "categories": [
    {
      "id": 1,
      "name": "會計服務",
      "icon": "account_balance",
      "children": [
        { "id": 2, "name": "記帳服務", "doc_count": 5 }
      ]
    }
  ]
}
```

### 取得文件列表
```
GET /api/sops?document_type=sop&category_id=2&status=published

Response:
{
  "success": true,
  "sops": [
    {
      "id": 1,
      "title": "月度記帳標準流程",
      "category": "記帳服務",
      "version": 3,
      "views": 45,
      "updated_at": "2025-10-20"
    }
  ]
}
```

### 取得文件詳情
```
GET /api/sops/{id}

Response:
{
  "success": true,
  "sop": {
    "id": 1,
    "title": "月度記帳標準流程",
    "content": "# 流程說明\n\n...",
    "document_type": "sop",
    "version": 3,
    "category": "記帳服務",
    "tags": ["記帳", "月結"]
  }
}
```

### 搜尋文件
```
GET /api/sops/search?q=發票&type=sop

Response:
{
  "success": true,
  "results": [
    {
      "id": 1,
      "title": "月度記帳流程",
      "excerpt": "...收集進項發票和銷項發票...",
      "category": "記帳服務",
      "document_type": "sop"
    }
  ]
}
```

---

## 💻 前端設計

### 統一頁面：knowledge.html

#### 標籤結構
```
[SOP文件] [內部文檔] [常見問答]
```

#### 佈局（三欄式）

```
┌──────────┬────────────────┬──────────────────┐
│          │                │                  │
│  分類樹  │   文件列表     │   文件內容       │
│          │                │                  │
│ 📁會計服務│ 月度記帳流程   │ # 月度記帳流程   │
│  📄記帳   │ 記帳 | v3 | 45 │                  │
│  📄營業稅 │                │ ## 步驟          │
│          │ 營業稅申報流程 │ 1. 收集憑證      │
│ 📁工商登記│ 營業稅 | v2    │ 2. ...           │
│  📄公司設立│               │                  │
│          │ [+ 新增SOP]    │ [編輯][版本歷史] │
└──────────┴────────────────┴──────────────────┘
```

#### SOP 文件標籤
- 左側：SOP 分類樹
- 中間：SOP 文件列表
- 右側：SOP 內容顯示

#### 內部文檔標籤
- 顯示內部文檔（document_type = 'internal_doc'）
- 例如：會議記錄、政策文件、操作手冊

#### 常見問答標籤
- FAQ 列表（可折疊）
- 問題搜尋
- 分類篩選

---

## 🔍 搜尋功能

### 全站搜尋
```javascript
async function searchKnowledge(keyword) {
  // 同時搜尋 SOP、內部文檔、FAQ
  const results = await fetch(`/api/sops/search?q=${keyword}`);
  
  // 按文件類型分組顯示
  return {
    sops: results.filter(r => r.document_type === 'sop'),
    docs: results.filter(r => r.document_type === 'internal_doc'),
    faqs: results.filter(r => r.document_type === 'faq')
  };
}
```

### 搜尋結果顯示
```
搜尋: "發票"

SOP 文件 (3)
- 月度記帳流程 (會計服務)
- 營業稅申報流程 (營業稅申報)
- ...

內部文檔 (1)
- 發票處理注意事項

常見問答 (2)
- Q: 如何處理遺失的發票？
- Q: 電子發票如何歸檔？
```

---

## 📝 Markdown 編輯

### 編輯器功能
- 標題、粗體、斜體
- 列表（有序、無序）
- 程式碼區塊
- 表格
- 連結、圖片
- 即時預覽
- 自動儲存草稿

### 圖片處理
```javascript
// 從媒體庫插入圖片
editor.codemirror.replaceSelection(
  `![${alt_text}](${image_url})`
);

// 或直接上傳
async function uploadAndInsert(file) {
  const uploaded = await uploadToMediaLibrary(file);
  editor.codemirror.replaceSelection(
    `![](${uploaded.url})`
  );
}
```

---

## 📊 知識庫統計

### 文件統計
```sql
-- 各分類文件數量
SELECT 
  sc.name,
  COUNT(s.id) as doc_count,
  SUM(s.views) as total_views,
  MAX(s.updated_at) as last_updated
FROM sop_categories sc
LEFT JOIN sops s ON sc.id = s.category_id AND s.status = 'published'
GROUP BY sc.id
ORDER BY doc_count DESC;
```

### 熱門文件
```sql
-- 最多人閱讀的文件
SELECT 
  id,
  title,
  document_type,
  views,
  updated_at
FROM sops
WHERE status = 'published'
ORDER BY views DESC
LIMIT 10;
```

### 最新更新
```sql
-- 最近更新的文件
SELECT 
  id,
  title,
  document_type,
  version,
  updated_at
FROM sops
WHERE status = 'published'
ORDER BY updated_at DESC
LIMIT 20;
```

---

## 🎨 前端特色功能

### 側邊欄導航
```html
<div class="sidebar">
  <!-- 分類樹 -->
  <div class="category-tree">
    <div class="category-item">
      <span class="material-symbols-outlined">folder</span>
      會計服務
      <div class="subcategories">
        <div class="subcategory">記帳服務 (5)</div>
        <div class="subcategory">營業稅 (3)</div>
      </div>
    </div>
  </div>
  
  <!-- 快速連結 -->
  <div class="quick-links">
    <h4>常用文件</h4>
    <a href="#sop-1">月度記帳流程</a>
    <a href="#sop-5">營業稅申報</a>
  </div>
</div>
```

### 文件卡片
```html
<div class="doc-card" onclick="openDocument(1)">
  <h3>月度記帳標準流程</h3>
  <div class="doc-meta">
    <span class="badge">SOP</span>
    <span>記帳服務</span>
    <span>v3</span>
    <span>👁 45</span>
  </div>
  <p class="doc-excerpt">標準的月度記帳作業流程...</p>
  <div class="doc-footer">
    <span>更新：2025-10-20</span>
    <span>作者：admin</span>
  </div>
</div>
```

### 文件內容顯示
```html
<div class="doc-content">
  <div class="doc-header">
    <h1>月度記帳標準流程</h1>
    <div class="doc-info">
      <span>版本 3</span>
      <span>記帳服務</span>
      <span>更新於 2025-10-20</span>
    </div>
  </div>
  
  <div class="doc-actions">
    <button onclick="editDocument()">編輯</button>
    <button onclick="viewVersions()">版本歷史</button>
    <button onclick="printDocument()">列印</button>
    <button onclick="shareDocument()">分享</button>
  </div>
  
  <div class="markdown-content">
    <!-- 渲染後的 Markdown 內容 -->
  </div>
</div>
```

---

## 🔍 搜尋與篩選

### 多條件搜尋
```javascript
async function searchDocuments(params) {
  const {
    keyword,          // 關鍵字
    documentType,     // sop, internal_doc, faq
    categoryId,       // 分類 ID
    tags,             // 標籤陣列
    dateFrom,         // 日期範圍
    dateTo
  } = params;
  
  const query = new URLSearchParams({
    q: keyword,
    type: documentType,
    category_id: categoryId,
    // ...
  });
  
  return await fetch(`/api/sops/search?${query}`);
}
```

### 標籤雲
```html
<div class="tag-cloud">
  <span class="tag" data-count="15">記帳</span>
  <span class="tag" data-count="12">營業稅</span>
  <span class="tag" data-count="8">申報</span>
  <span class="tag" data-count="6">發票</span>
  <!-- 標籤大小依使用次數調整 -->
</div>
```

---

## 📚 文件類型差異

### SOP 文件
- 嚴格的版本控制
- 需要審核發布
- 標準化格式
- 關聯業務類型
- 記錄閱讀次數

### 內部文檔
- 較輕量的版本控制
- 快速發布
- 靈活的格式
- 部門內部使用

### 常見問答
- 問答格式
- 分類管理
- 快速查找
- 可折疊顯示

---

## 💻 頁面實施（✅ 已實施 2025-10-26）

### knowledge.html 標籤切換

**實施位置**: knowledge.html 第430-463行，第474-663行

```javascript
// ✅ 已實施
function switchMainTab(tabName) {
    // 更新標籤按鈕和內容顯示
    // ...
}

// ✅ SOP 功能已實施
async function loadSopCategories() {
    const response = await fetch(`${WORKER_URL}/api/sop/categories`, {
        headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const data = await response.json();
    sopCategories = data.categories || [];
    
    // 填充分類篩選器
    // ...
}

async function loadSops() {
    const categoryId = document.getElementById('sopCategoryFilter')?.value || '';
    let url = `${WORKER_URL}/api/sops?document_type=sop&status=published`;
    if (categoryId) {
        url += `&category_id=${categoryId}`;
    }
    
    const response = await fetch(url, {
        headers: { 'Authorization': `Bearer ${sessionToken}` }
    });
    const data = await response.json();
    allSops = data.sops || [];
    
    renderSops(allSops);
}

function renderSops(sops) {
    // 按分類分組顯示
    const grouped = {};
    sops.forEach(sop => {
        const catName = sop.category_name || '未分類';
        if (!grouped[catName]) grouped[catName] = [];
        grouped[catName].push(sop);
    });
    
    // 渲染為卡片列表
    // ...
}
```

**實施狀態**:
- ✅ SOP 列表載入（knowledge.html 第516-559行）
- ✅ 分類篩選器（第482-511行）
- ✅ 搜尋功能（第633-647行）
- ✅ 按分類分組顯示（第564-628行）
- ✅ 點擊查看SOP（第652-656行，可擴展）
- 📋 創建SOP（第661-663行，顯示提示，可進一步實現編輯器）

### 與 sop.html 的關係

**knowledge.html**: 內部知識庫（需登入）
- 包含 SOP、內部文檔、FAQ
- 完整的編輯功能
- 版本控制

**sop.html**: 可能是公開版本或專門的 SOP 管理頁面
- 如果重複，應該整合或廢棄其中一個

---

## 🔧 實施細節

### 文件類型切換
```javascript
// 根據 document_type 顯示不同圖示和樣式
function getDocumentIcon(type) {
  const icons = {
    sop: 'description',
    internal_doc: 'article',
    faq: 'help'
  };
  return icons[type] || 'description';
}

function getDocumentBadgeColor(type) {
  const colors = {
    sop: 'blue',
    internal_doc: 'green',
    faq: 'orange'
  };
  return colors[type] || 'gray';
}
```

### 快速導航
```javascript
// 麵包屑導航
function renderBreadcrumb(category) {
  const path = getCategoryPath(category.id);
  return path.map(c => c.name).join(' > ');
}

// 範例：會計服務 > 記帳服務 > 月度記帳流程
```

---

## 📊 知識庫統計儀表板

### 統計指標
```sql
-- 知識庫總覽
SELECT 
  document_type,
  COUNT(*) as total_docs,
  SUM(views) as total_views,
  COUNT(DISTINCT author_id) as contributors
FROM sops
WHERE status = 'published'
GROUP BY document_type;
```

### 使用分析
```sql
-- 本月熱門文件
SELECT 
  s.title,
  s.document_type,
  s.views,
  sc.name as category
FROM sops s
LEFT JOIN sop_categories sc ON s.category_id = sc.id
WHERE s.status = 'published'
  AND s.updated_at >= date('now', '-30 days')
ORDER BY s.views DESC
LIMIT 10;
```

---

## 🚀 未來擴展

### 計劃功能
- [ ] 文件協作編輯
- [ ] 評論與討論
- [ ] 文件關聯推薦
- [ ] 學習路徑（新人訓練）
- [ ] 文件有效期限與審核提醒
- [ ] 多語言支援
- [ ] PDF 匯出
- [ ] 文件稽核追蹤（誰看過）
- [ ] AI 輔助搜尋
- [ ] 語音輸入

---

## 🔗 與其他系統整合

### 與任務系統整合
```javascript
// SOP 可以關聯到任務
// 任務執行時可快速查看相關 SOP

// 在任務詳情中顯示
<a href="knowledge.html?sop_id=5">查看相關 SOP</a>
```

### 與客戶服務整合
```javascript
// 服務檢查清單範本可以參考 SOP

// 建立範本時
const sopReference = {
  service_type: 'vat',
  related_sop_id: 5,
  sop_title: '營業稅申報流程'
};
```

---

**相關文檔**：
- [系統架構設計.md](./系統架構設計.md) - 整體架構
- [任務管理系統設計.md](./任務管理系統設計.md) - 任務整合
- [內容管理系統設計.md](./內容管理系統設計.md) - CMS 整合
- [API端點文檔.md](./API端點文檔.md) - API 參考

### 資料模型補充：SOP 文件
- 表：`sops`
  - `document_type` TEXT CHECK(document_type IN ('SOP','INTERNAL','FAQ')) DEFAULT 'SOP'
  - 其餘欄位：`title`, `category_id`, `content`, `version`, `status`, `business_type`, `created_by`, `updated_by`, `created_at`, `updated_at`
- 表：`sop_tags`
  - 使用關聯表管理標籤：`id`, `sop_id`, `tag`
  - 好處：可索引、避免 JSON LIKE 查詢效能問題

### API 行為補充
- GET `/api/sops` 支援查詢參數：
  - `category`：分類 ID
  - `business_type`：業務類型
  - `status`：`draft|published|archived`
  - `document_type`：`SOP|INTERNAL|FAQ`

### 設計原則調整
- 原本規劃以 JSON 欄位儲存標籤，現改為關聯表 `sop_tags`，以提升查詢與索引效能。
- 新增 `document_type` 欄位以支援知識庫頁面按類型分頁顯示。

