# 報表系統設計

**版本**: 1.0  
**最後更新**: 2025-10-26

---

## 📋 功能概述

報表系統提供各種管理報表，包含工時分析、年假統計、工作量分析等，支援資料匯出與快取機制。

### 核心功能
- 年假報表（個人與全體）
- 工時分析報表
- 樞紐分析報表
- 報表快取機制
- PDF/Excel 匯出

---

## 🗄️ 資料表結構

### report_cache (報表快取)
```sql
CREATE TABLE report_cache (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  report_type TEXT NOT NULL,         -- annual_leave, work_analysis, pivot
  cache_key TEXT NOT NULL,           -- 快取鍵值（含參數）
  report_data TEXT NOT NULL,         -- 報表資料（JSON）
  generated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  expires_at DATETIME,               -- 過期時間
  hit_count INTEGER DEFAULT 0,       -- 使用次數
  UNIQUE(report_type, cache_key)
);
```

**快取策略**：
- 年假報表：快取 1 小時
- 工時分析：快取 30 分鐘
- 樞紐分析：快取 15 分鐘

### 新增：報表統計表 report_stats
- 表：`report_stats`
  - 欄位：`id`, `report_type`, `execution_time_ms`, `cache_hit`(0/1), `employee_name`(可空), `generated_at`(DATETIME)
  - 目的：統計報表效能、快取命中率，供後台監控頁面使用
- 索引：
  - `idx_report_stats_type` on (report_type)
  - `idx_report_stats_date` on (generated_at)

---

## 📊 報表類型

### 1. 年假報表

#### 個人年假報表
```sql
-- 計算個人年假狀況
SELECT 
  e.id,
  e.name,
  e.hire_date,
  alc.year,
  alc.earned_days,
  alc.carried_over_days,
  alc.used_days,
  alc.remaining_days,
  ROUND((julianday('now') - julianday(e.hire_date)) / 365.25, 2) as years_of_service
FROM employees e
LEFT JOIN annual_leave_carryover alc ON e.id = alc.employee_id
WHERE alc.year = ?
ORDER BY e.name;
```

#### 全體年假統計
```sql
-- 部門年假使用統計
SELECT 
  e.department,
  COUNT(e.id) as employee_count,
  SUM(alc.earned_days) as total_earned,
  SUM(alc.used_days) as total_used,
  SUM(alc.remaining_days) as total_remaining,
  ROUND(AVG(alc.used_days * 100.0 / alc.earned_days), 2) as avg_usage_rate
FROM employees e
JOIN annual_leave_carryover alc ON e.id = alc.employee_id
WHERE alc.year = ? AND e.status = 'active'
GROUP BY e.department;
```

### 2. 工時分析報表

#### 個人工時統計
```sql
-- 月度工時統計
SELECT 
  strftime('%Y-%m', date) as month,
  SUM(regular_hours) as total_regular,
  SUM(overtime_hours) as total_overtime,
  COUNT(DISTINCT date) as work_days,
  ROUND(SUM(regular_hours) / COUNT(DISTINCT date), 2) as avg_daily_hours
FROM timesheets
WHERE employee_id = ? 
  AND date >= ? AND date <= ?
GROUP BY month
ORDER BY month;
```

#### 部門工時統計
```sql
-- 部門加班分析
SELECT 
  e.department,
  COUNT(DISTINCT e.id) as employee_count,
  SUM(t.regular_hours) as total_regular,
  SUM(t.overtime_hours) as total_overtime,
  ROUND(SUM(t.overtime_hours) * 100.0 / SUM(t.regular_hours), 2) as overtime_rate
FROM employees e
JOIN timesheets t ON e.id = t.employee_id
WHERE strftime('%Y-%m', t.date) = ?
GROUP BY e.department
ORDER BY total_overtime DESC;
```

### 3. 樞紐分析報表

#### 員工 x 日期工時樞紐
```sql
-- 產生員工每日工時樞紐表
SELECT 
  e.name as employee,
  strftime('%Y-%m-%d', t.date) as date,
  t.regular_hours,
  t.overtime_hours,
  (t.regular_hours + t.overtime_hours) as total_hours
FROM employees e
LEFT JOIN timesheets t ON e.id = t.employee_id
WHERE t.date >= ? AND t.date <= ?
ORDER BY e.name, t.date;
```

#### 客戶 x 服務類型樞紐
```sql
-- 客戶服務統計樞紐
SELECT 
  c.name as client,
  cs.service_type,
  cs.frequency,
  cs.fee,
  COUNT(tgl.id) as generated_count,
  SUM(tel.actual_hours) as total_hours
FROM clients c
JOIN client_services cs ON c.id = cs.client_id
LEFT JOIN task_generation_log tgl ON cs.id = tgl.client_service_id
LEFT JOIN task_execution_log tel ON cs.id = tel.client_service_id
WHERE cs.is_active = 1
GROUP BY c.id, cs.service_type;
```

---

## 🔌 API 設計

### 年假報表
```
GET /api/reports/annual-leave?employee_id=1&year=2025

Response:
{
  "success": true,
  "report": {
    "employee": {
      "id": 1,
      "name": "張三",
      "hire_date": "2020-01-15",
      "years_of_service": 5.8
    },
    "leave_summary": {
      "year": 2025,
      "earned_days": 15,
      "carried_over_days": 3,
      "used_days": 8,
      "remaining_days": 10,
      "expiry_date": "2025-12-31"
    },
    "usage_history": [...]
  },
  "cached": false
}
```

### 工時分析報表
```
GET /api/reports/work-analysis?month=2025-10&department=會計部

Response:
{
  "success": true,
  "report": {
    "period": "2025-10",
    "department": "會計部",
    "summary": {
      "total_employees": 3,
      "total_regular_hours": 480,
      "total_overtime_hours": 45,
      "avg_daily_hours": 8.2
    },
    "employees": [
      {
        "name": "張紜蓁",
        "regular_hours": 160,
        "overtime_hours": 15,
        "work_days": 20
      }
    ]
  },
  "cached": true
}
```

### 樞紐分析報表
```
POST /api/reports/pivot

Request:
{
  "report_type": "timesheet",
  "row_field": "employee",
  "column_field": "date",
  "value_field": "total_hours",
  "start_date": "2025-10-01",
  "end_date": "2025-10-31",
  "filters": {
    "department": "會計部"
  }
}

Response:
{
  "success": true,
  "pivot_data": {
    "rows": ["張三", "李四", "王五"],
    "columns": ["2025-10-01", "2025-10-02", ...],
    "data": [
      [8, 8, 0, ...],  // 張三的每日工時
      [8, 10, 8, ...], // 李四的每日工時
      [8, 8, 8, ...]   // 王五的每日工時
    ]
  }
}
```

### 清除快取
```
DELETE /api/reports/cache?report_type=annual_leave

Response:
{
  "success": true,
  "message": "已清除 5 筆快取記錄"
}
```

### API 補充
- 管理員 API：
  - `POST /api/admin/cache/clear` 清除快取（支援 type 或 key）
  - `GET /api/admin/cache/stats` 回傳報表效能統計與快取儲存大小

---

## 💻 前端設計

### 頁面：reports.html

#### 報表選擇區
```
[年假報表] [工時分析] [樞紐分析] [客製報表]
```

#### 年假報表介面
```
年假報表
─────────────────────

員工: [全部員工 ▾]
年度: [2025 ▾]

[產生報表] [匯出 PDF] [匯出 Excel]

┌─────────────────────────────────────┐
│ 員工  | 年資 | 應得 | 已用 | 剩餘  │
├─────────────────────────────────────┤
│ 張三  | 5.8年 | 15  | 8   | 10   │
│ 李四  | 3.2年 | 10  | 5   | 8    │
└─────────────────────────────────────┘
```

#### 工時分析介面
```
工時分析報表
─────────────────────

期間: [2025-10 ▾]
部門: [全部 ▾]

[產生報表] [匯出]

┌─────────────────────────────────────┐
│ 部門統計                            │
├─────────────────────────────────────┤
│ 總工時: 525小時                     │
│ 加班工時: 45小時                    │
│ 加班率: 8.6%                        │
└─────────────────────────────────────┘

[工時趨勢圖表]
```

#### 樞紐分析介面
```
樞紐分析
─────────────────────

資料來源: [工時記錄 ▾]
行欄位: [員工 ▾]
列欄位: [日期 ▾]
數值: [總工時 ▾]

期間: [2025-10-01] 至 [2025-10-31]

[產生報表] [匯出 Excel]

[動態樞紐表格]
```

---

## 🔧 快取機制實施

### 快取鍵值生成
```javascript
function generateCacheKey(reportType, params) {
  const sortedParams = Object.keys(params)
    .sort()
    .map(key => `${key}=${params[key]}`)
    .join('&');
  return `${reportType}:${sortedParams}`;
}

// 範例
generateCacheKey('annual_leave', { employee_id: 1, year: 2025 })
// 結果: "annual_leave:employee_id=1&year=2025"
```

### 快取檢查與使用
```javascript
async function getReport(reportType, params) {
  const cacheKey = generateCacheKey(reportType, params);
  
  // 1. 檢查快取
  const cached = await db.get(
    `SELECT * FROM report_cache 
     WHERE report_type = ? AND cache_key = ? 
     AND expires_at > datetime('now')`,
    [reportType, cacheKey]
  );
  
  if (cached) {
    // 更新使用次數
    await db.run(
      `UPDATE report_cache SET hit_count = hit_count + 1 WHERE id = ?`,
      [cached.id]
    );
    
    return {
      data: JSON.parse(cached.report_data),
      cached: true
    };
  }
  
  // 2. 產生報表
  const reportData = await generateReport(reportType, params);
  
  // 3. 儲存快取
  const expiresAt = new Date();
  expiresAt.setMinutes(expiresAt.getMinutes() + getCacheDuration(reportType));
  
  await db.run(
    `INSERT OR REPLACE INTO report_cache 
     (report_type, cache_key, report_data, expires_at) 
     VALUES (?, ?, ?, ?)`,
    [reportType, cacheKey, JSON.stringify(reportData), expiresAt.toISOString()]
  );
  
  return {
    data: reportData,
    cached: false
  };
}
```

---

## 📈 圖表整合

### 推薦圖表庫
- Chart.js - 簡單易用
- ECharts - 功能強大
- Plotly.js - 互動性佳

### 工時趨勢圖範例
```javascript
// 使用 Chart.js
new Chart(ctx, {
  type: 'line',
  data: {
    labels: ['10/01', '10/02', '10/03', ...],
    datasets: [{
      label: '正常工時',
      data: [8, 8, 8, ...],
      borderColor: 'rgb(75, 192, 192)'
    }, {
      label: '加班工時',
      data: [0, 2, 1, ...],
      borderColor: 'rgb(255, 99, 132)'
    }]
  }
});
```

---

## 🚀 未來擴展

### 計劃功能
- [ ] 自訂報表建立器
- [ ] 排程報表（每月自動產生）
- [ ] 報表訂閱（Email 發送）
- [ ] 報表權限控制
- [ ] 更多圖表類型（餅圖、熱力圖等）
- [ ] 報表比較（年度對比）
- [ ] 即時報表（WebSocket）
- [ ] 報表範本管理

---

**相關文檔**：
- [系統架構設計.md](./系統架構設計.md) - 整體架構
- [工時管理系統設計.md](./工時管理系統設計.md) - 工時資料來源
- [API端點文檔.md](./API端點文檔.md) - API 參考

