# å ±è¡¨ç³»çµ±è¨­è¨ˆ

**ç‰ˆæœ¬**: 1.0  
**æœ€å¾Œæ›´æ–°**: 2025-10-26

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å ±è¡¨ç³»çµ±æä¾›å„ç¨®ç®¡ç†å ±è¡¨ï¼ŒåŒ…å«å·¥æ™‚åˆ†æã€å¹´å‡çµ±è¨ˆã€å·¥ä½œé‡åˆ†æç­‰ï¼Œæ”¯æ´è³‡æ–™åŒ¯å‡ºèˆ‡å¿«å–æ©Ÿåˆ¶ã€‚

### æ ¸å¿ƒåŠŸèƒ½
- å¹´å‡å ±è¡¨ï¼ˆå€‹äººèˆ‡å…¨é«”ï¼‰
- å·¥æ™‚åˆ†æå ±è¡¨
- æ¨ç´åˆ†æå ±è¡¨
- å ±è¡¨å¿«å–æ©Ÿåˆ¶
- PDF/Excel åŒ¯å‡º

---

## ğŸ—„ï¸ è³‡æ–™è¡¨çµæ§‹

### report_cache (å ±è¡¨å¿«å–)
```sql
CREATE TABLE report_cache (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  report_type TEXT NOT NULL,         -- annual_leave, work_analysis, pivot
  cache_key TEXT NOT NULL,           -- å¿«å–éµå€¼ï¼ˆå«åƒæ•¸ï¼‰
  report_data TEXT NOT NULL,         -- å ±è¡¨è³‡æ–™ï¼ˆJSONï¼‰
  generated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  expires_at DATETIME,               -- éæœŸæ™‚é–“
  hit_count INTEGER DEFAULT 0,       -- ä½¿ç”¨æ¬¡æ•¸
  UNIQUE(report_type, cache_key)
);
```

**å¿«å–ç­–ç•¥**ï¼š
- å¹´å‡å ±è¡¨ï¼šå¿«å– 1 å°æ™‚
- å·¥æ™‚åˆ†æï¼šå¿«å– 30 åˆ†é˜
- æ¨ç´åˆ†æï¼šå¿«å– 15 åˆ†é˜

### æ–°å¢ï¼šå ±è¡¨çµ±è¨ˆè¡¨ report_stats
- è¡¨ï¼š`report_stats`
  - æ¬„ä½ï¼š`id`, `report_type`, `execution_time_ms`, `cache_hit`(0/1), `employee_name`(å¯ç©º), `generated_at`(DATETIME)
  - ç›®çš„ï¼šçµ±è¨ˆå ±è¡¨æ•ˆèƒ½ã€å¿«å–å‘½ä¸­ç‡ï¼Œä¾›å¾Œå°ç›£æ§é é¢ä½¿ç”¨
- ç´¢å¼•ï¼š
  - `idx_report_stats_type` on (report_type)
  - `idx_report_stats_date` on (generated_at)

---

## ğŸ“Š å ±è¡¨é¡å‹

### 1. å¹´å‡å ±è¡¨

#### å€‹äººå¹´å‡å ±è¡¨
```sql
-- è¨ˆç®—å€‹äººå¹´å‡ç‹€æ³
SELECT 
  e.id,
  e.name,
  e.hire_date,
  alc.year,
  alc.earned_days,
  alc.carried_over_days,
  alc.used_days,
  alc.remaining_days,
  ROUND((julianday('now') - julianday(e.hire_date)) / 365.25, 2) as years_of_service
FROM employees e
LEFT JOIN annual_leave_carryover alc ON e.id = alc.employee_id
WHERE alc.year = ?
ORDER BY e.name;
```

#### å…¨é«”å¹´å‡çµ±è¨ˆ
```sql
-- éƒ¨é–€å¹´å‡ä½¿ç”¨çµ±è¨ˆ
SELECT 
  e.department,
  COUNT(e.id) as employee_count,
  SUM(alc.earned_days) as total_earned,
  SUM(alc.used_days) as total_used,
  SUM(alc.remaining_days) as total_remaining,
  ROUND(AVG(alc.used_days * 100.0 / alc.earned_days), 2) as avg_usage_rate
FROM employees e
JOIN annual_leave_carryover alc ON e.id = alc.employee_id
WHERE alc.year = ? AND e.status = 'active'
GROUP BY e.department;
```

### 2. å·¥æ™‚åˆ†æå ±è¡¨

#### å€‹äººå·¥æ™‚çµ±è¨ˆ
```sql
-- æœˆåº¦å·¥æ™‚çµ±è¨ˆ
SELECT 
  strftime('%Y-%m', date) as month,
  SUM(regular_hours) as total_regular,
  SUM(overtime_hours) as total_overtime,
  COUNT(DISTINCT date) as work_days,
  ROUND(SUM(regular_hours) / COUNT(DISTINCT date), 2) as avg_daily_hours
FROM timesheets
WHERE employee_id = ? 
  AND date >= ? AND date <= ?
GROUP BY month
ORDER BY month;
```

#### éƒ¨é–€å·¥æ™‚çµ±è¨ˆ
```sql
-- éƒ¨é–€åŠ ç­åˆ†æ
SELECT 
  e.department,
  COUNT(DISTINCT e.id) as employee_count,
  SUM(t.regular_hours) as total_regular,
  SUM(t.overtime_hours) as total_overtime,
  ROUND(SUM(t.overtime_hours) * 100.0 / SUM(t.regular_hours), 2) as overtime_rate
FROM employees e
JOIN timesheets t ON e.id = t.employee_id
WHERE strftime('%Y-%m', t.date) = ?
GROUP BY e.department
ORDER BY total_overtime DESC;
```

### 3. æ¨ç´åˆ†æå ±è¡¨

#### å“¡å·¥ x æ—¥æœŸå·¥æ™‚æ¨ç´
```sql
-- ç”¢ç”Ÿå“¡å·¥æ¯æ—¥å·¥æ™‚æ¨ç´è¡¨
SELECT 
  e.name as employee,
  strftime('%Y-%m-%d', t.date) as date,
  t.regular_hours,
  t.overtime_hours,
  (t.regular_hours + t.overtime_hours) as total_hours
FROM employees e
LEFT JOIN timesheets t ON e.id = t.employee_id
WHERE t.date >= ? AND t.date <= ?
ORDER BY e.name, t.date;
```

#### å®¢æˆ¶ x æœå‹™é¡å‹æ¨ç´
```sql
-- å®¢æˆ¶æœå‹™çµ±è¨ˆæ¨ç´
SELECT 
  c.name as client,
  cs.service_type,
  cs.frequency,
  cs.fee,
  COUNT(tgl.id) as generated_count,
  SUM(tel.actual_hours) as total_hours
FROM clients c
JOIN client_services cs ON c.id = cs.client_id
LEFT JOIN task_generation_log tgl ON cs.id = tgl.client_service_id
LEFT JOIN task_execution_log tel ON cs.id = tel.client_service_id
WHERE cs.is_active = 1
GROUP BY c.id, cs.service_type;
```

---

## ğŸ”Œ API è¨­è¨ˆ

### å¹´å‡å ±è¡¨
```
GET /api/reports/annual-leave?employee_id=1&year=2025

Response:
{
  "success": true,
  "report": {
    "employee": {
      "id": 1,
      "name": "å¼µä¸‰",
      "hire_date": "2020-01-15",
      "years_of_service": 5.8
    },
    "leave_summary": {
      "year": 2025,
      "earned_days": 15,
      "carried_over_days": 3,
      "used_days": 8,
      "remaining_days": 10,
      "expiry_date": "2025-12-31"
    },
    "usage_history": [...]
  },
  "cached": false
}
```

### å·¥æ™‚åˆ†æå ±è¡¨
```
GET /api/reports/work-analysis?month=2025-10&department=æœƒè¨ˆéƒ¨

Response:
{
  "success": true,
  "report": {
    "period": "2025-10",
    "department": "æœƒè¨ˆéƒ¨",
    "summary": {
      "total_employees": 3,
      "total_regular_hours": 480,
      "total_overtime_hours": 45,
      "avg_daily_hours": 8.2
    },
    "employees": [
      {
        "name": "å¼µç´œè“",
        "regular_hours": 160,
        "overtime_hours": 15,
        "work_days": 20
      }
    ]
  },
  "cached": true
}
```

### æ¨ç´åˆ†æå ±è¡¨
```
POST /api/reports/pivot

Request:
{
  "report_type": "timesheet",
  "row_field": "employee",
  "column_field": "date",
  "value_field": "total_hours",
  "start_date": "2025-10-01",
  "end_date": "2025-10-31",
  "filters": {
    "department": "æœƒè¨ˆéƒ¨"
  }
}

Response:
{
  "success": true,
  "pivot_data": {
    "rows": ["å¼µä¸‰", "æå››", "ç‹äº”"],
    "columns": ["2025-10-01", "2025-10-02", ...],
    "data": [
      [8, 8, 0, ...],  // å¼µä¸‰çš„æ¯æ—¥å·¥æ™‚
      [8, 10, 8, ...], // æå››çš„æ¯æ—¥å·¥æ™‚
      [8, 8, 8, ...]   // ç‹äº”çš„æ¯æ—¥å·¥æ™‚
    ]
  }
}
```

### æ¸…é™¤å¿«å–
```
DELETE /api/reports/cache?report_type=annual_leave

Response:
{
  "success": true,
  "message": "å·²æ¸…é™¤ 5 ç­†å¿«å–è¨˜éŒ„"
}
```

### API è£œå……
- ç®¡ç†å“¡ APIï¼š
  - `POST /api/admin/cache/clear` æ¸…é™¤å¿«å–ï¼ˆæ”¯æ´ type æˆ– keyï¼‰
  - `GET /api/admin/cache/stats` å›å‚³å ±è¡¨æ•ˆèƒ½çµ±è¨ˆèˆ‡å¿«å–å„²å­˜å¤§å°

---

## ğŸ’» å‰ç«¯è¨­è¨ˆ

### é é¢ï¼šreports.html

#### å ±è¡¨é¸æ“‡å€
```
[å¹´å‡å ±è¡¨] [å·¥æ™‚åˆ†æ] [æ¨ç´åˆ†æ] [å®¢è£½å ±è¡¨]
```

#### å¹´å‡å ±è¡¨ä»‹é¢
```
å¹´å‡å ±è¡¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

å“¡å·¥: [å…¨éƒ¨å“¡å·¥ â–¾]
å¹´åº¦: [2025 â–¾]

[ç”¢ç”Ÿå ±è¡¨] [åŒ¯å‡º PDF] [åŒ¯å‡º Excel]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å“¡å·¥  | å¹´è³‡ | æ‡‰å¾— | å·²ç”¨ | å‰©é¤˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¼µä¸‰  | 5.8å¹´ | 15  | 8   | 10   â”‚
â”‚ æå››  | 3.2å¹´ | 10  | 5   | 8    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å·¥æ™‚åˆ†æä»‹é¢
```
å·¥æ™‚åˆ†æå ±è¡¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

æœŸé–“: [2025-10 â–¾]
éƒ¨é–€: [å…¨éƒ¨ â–¾]

[ç”¢ç”Ÿå ±è¡¨] [åŒ¯å‡º]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éƒ¨é–€çµ±è¨ˆ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¸½å·¥æ™‚: 525å°æ™‚                     â”‚
â”‚ åŠ ç­å·¥æ™‚: 45å°æ™‚                    â”‚
â”‚ åŠ ç­ç‡: 8.6%                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[å·¥æ™‚è¶¨å‹¢åœ–è¡¨]
```

#### æ¨ç´åˆ†æä»‹é¢
```
æ¨ç´åˆ†æ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

è³‡æ–™ä¾†æº: [å·¥æ™‚è¨˜éŒ„ â–¾]
è¡Œæ¬„ä½: [å“¡å·¥ â–¾]
åˆ—æ¬„ä½: [æ—¥æœŸ â–¾]
æ•¸å€¼: [ç¸½å·¥æ™‚ â–¾]

æœŸé–“: [2025-10-01] è‡³ [2025-10-31]

[ç”¢ç”Ÿå ±è¡¨] [åŒ¯å‡º Excel]

[å‹•æ…‹æ¨ç´è¡¨æ ¼]
```

---

## ğŸ”§ å¿«å–æ©Ÿåˆ¶å¯¦æ–½

### å¿«å–éµå€¼ç”Ÿæˆ
```javascript
function generateCacheKey(reportType, params) {
  const sortedParams = Object.keys(params)
    .sort()
    .map(key => `${key}=${params[key]}`)
    .join('&');
  return `${reportType}:${sortedParams}`;
}

// ç¯„ä¾‹
generateCacheKey('annual_leave', { employee_id: 1, year: 2025 })
// çµæœ: "annual_leave:employee_id=1&year=2025"
```

### å¿«å–æª¢æŸ¥èˆ‡ä½¿ç”¨
```javascript
async function getReport(reportType, params) {
  const cacheKey = generateCacheKey(reportType, params);
  
  // 1. æª¢æŸ¥å¿«å–
  const cached = await db.get(
    `SELECT * FROM report_cache 
     WHERE report_type = ? AND cache_key = ? 
     AND expires_at > datetime('now')`,
    [reportType, cacheKey]
  );
  
  if (cached) {
    // æ›´æ–°ä½¿ç”¨æ¬¡æ•¸
    await db.run(
      `UPDATE report_cache SET hit_count = hit_count + 1 WHERE id = ?`,
      [cached.id]
    );
    
    return {
      data: JSON.parse(cached.report_data),
      cached: true
    };
  }
  
  // 2. ç”¢ç”Ÿå ±è¡¨
  const reportData = await generateReport(reportType, params);
  
  // 3. å„²å­˜å¿«å–
  const expiresAt = new Date();
  expiresAt.setMinutes(expiresAt.getMinutes() + getCacheDuration(reportType));
  
  await db.run(
    `INSERT OR REPLACE INTO report_cache 
     (report_type, cache_key, report_data, expires_at) 
     VALUES (?, ?, ?, ?)`,
    [reportType, cacheKey, JSON.stringify(reportData), expiresAt.toISOString()]
  );
  
  return {
    data: reportData,
    cached: false
  };
}
```

---

## ğŸ“ˆ åœ–è¡¨æ•´åˆ

### æ¨è–¦åœ–è¡¨åº«
- Chart.js - ç°¡å–®æ˜“ç”¨
- ECharts - åŠŸèƒ½å¼·å¤§
- Plotly.js - äº’å‹•æ€§ä½³

### å·¥æ™‚è¶¨å‹¢åœ–ç¯„ä¾‹
```javascript
// ä½¿ç”¨ Chart.js
new Chart(ctx, {
  type: 'line',
  data: {
    labels: ['10/01', '10/02', '10/03', ...],
    datasets: [{
      label: 'æ­£å¸¸å·¥æ™‚',
      data: [8, 8, 8, ...],
      borderColor: 'rgb(75, 192, 192)'
    }, {
      label: 'åŠ ç­å·¥æ™‚',
      data: [0, 2, 1, ...],
      borderColor: 'rgb(255, 99, 132)'
    }]
  }
});
```

---

## ğŸš€ æœªä¾†æ“´å±•

### è¨ˆåŠƒåŠŸèƒ½
- [ ] è‡ªè¨‚å ±è¡¨å»ºç«‹å™¨
- [ ] æ’ç¨‹å ±è¡¨ï¼ˆæ¯æœˆè‡ªå‹•ç”¢ç”Ÿï¼‰
- [ ] å ±è¡¨è¨‚é–±ï¼ˆEmail ç™¼é€ï¼‰
- [ ] å ±è¡¨æ¬Šé™æ§åˆ¶
- [ ] æ›´å¤šåœ–è¡¨é¡å‹ï¼ˆé¤…åœ–ã€ç†±åŠ›åœ–ç­‰ï¼‰
- [ ] å ±è¡¨æ¯”è¼ƒï¼ˆå¹´åº¦å°æ¯”ï¼‰
- [ ] å³æ™‚å ±è¡¨ï¼ˆWebSocketï¼‰
- [ ] å ±è¡¨ç¯„æœ¬ç®¡ç†

---

**ç›¸é—œæ–‡æª”**ï¼š
- [ç³»çµ±æ¶æ§‹è¨­è¨ˆ.md](./ç³»çµ±æ¶æ§‹è¨­è¨ˆ.md) - æ•´é«”æ¶æ§‹
- [å·¥æ™‚ç®¡ç†ç³»çµ±è¨­è¨ˆ.md](./å·¥æ™‚ç®¡ç†ç³»çµ±è¨­è¨ˆ.md) - å·¥æ™‚è³‡æ–™ä¾†æº
- [APIç«¯é»æ–‡æª”.md](./APIç«¯é»æ–‡æª”.md) - API åƒè€ƒ

