# 📋 開發指南與原則

**版本**: 1.0  
**最後更新**: 2025-10-25

---

## 🎯 核心開發原則

### 1. 自動化測試與驗證

**規則**：每一步完成都必須自己做測試

- ✅ 完成功能後立即測試
- ✅ 測試通過才能繼續下一步
- ✅ 測試失敗則立即修改
- ❌ 不詢問使用者是否需要測試
- ❌ 不等待使用者手動測試

**測試檢查清單**：
- [ ] API 端點是否正常回應
- [ ] 資料庫操作是否成功
- [ ] 前端頁面是否可訪問
- [ ] 功能是否符合需求

### 2. 清理臨時檔案

**規則**：測試腳本、臨時檔案測試通過後立即刪除

- ✅ 測試通過後刪除測試腳本
- ✅ 不保留中間產物
- ✅ 保持專案結構清晰
- ❌ 不讓測試檔案累積

**需要清理的檔案類型**：
```
test-*.ps1
test-*.js
temp-*.sql
*.tmp
debug-*.log
```

### 3. 系統整合優先

**規則**：所有新功能必須與現有系統完美整合

#### 3.1 避免功能重複
- ✅ 檢查是否已有相似功能
- ✅ 複用現有組件和邏輯
- ✅ 統一的資料來源
- ❌ 不創建重複的 CRUD 功能
- ❌ 不在多處管理同一份資料

#### 3.2 資料聯動
- ✅ 確保資料在各處同步更新
- ✅ 使用外鍵約束保證一致性
- ✅ 級聯刪除/更新相關資料
- ❌ 不允許資料孤島
- ❌ 不允許手動同步

#### 3.3 功能連接
- ✅ 新功能與現有功能建立關聯
- ✅ 在相關頁面顯示關聯資料
- ✅ 提供跨功能導航
- ❌ 不創建獨立的功能孤島

### 4. 無需確認，直接執行

**規則**：需要部署時直接執行，不詢問確認

- ✅ 直接使用 `run_terminal_cmd` 執行部署
- ✅ 完成後通知結果
- ❌ 不詢問「是否需要部署」
- ❌ 不等待使用者確認

### 5. 高效文檔管理

**規則**：不浪費 token 做總結，只更新進度文檔

- ✅ 更新 `docs/SYSTEM_EXPANSION_PROGRESS.md`
- ✅ 記錄關鍵決策和變更
- ❌ 不創建重複的總結文檔
- ❌ 不生成冗長的完成報告

### 6. 重視視覺美觀性

**規則**：所有功能必須具備良好的視覺效果和用戶體驗

- ✅ 使用一致的設計語言
- ✅ 合理的間距和排版
- ✅ 清晰的視覺層級
- ✅ 適當的色彩搭配
- ✅ 流暢的動畫過渡
- ✅ 響應式設計（手機友好）
- ✅ 載入狀態和反饋
- ❌ 不做功能性但醜陋的界面
- ❌ 不忽視細節和精緻度

---

## 🔗 系統整合檢查清單

### 新增功能時必須檢查

#### 資料庫層面
- [ ] 是否有重複的資料表？
- [ ] 是否建立了外鍵關聯？
- [ ] 是否設置了級聯刪除/更新？
- [ ] 是否有適當的索引？

#### API 層面
- [ ] 是否複用現有的驗證邏輯？
- [ ] 是否使用統一的錯誤處理？
- [ ] 是否需要關聯查詢其他資料？
- [ ] 回傳資料是否包含關聯資訊？

#### 前端層面
- [ ] 是否複用現有的 UI 組件？
- [ ] 是否使用統一的樣式？
- [ ] 是否提供跨功能導航？
- [ ] 是否在相關頁面顯示關聯資料？

---

## 📐 整合範例

### ✅ 良好的整合

**案例：SOP 與業務類型整合**

```sql
-- SOP 資料表包含業務類型關聯
ALTER TABLE sops ADD COLUMN business_type TEXT;
CREATE INDEX idx_sops_business_type ON sops(business_type);
```

**好處**：
- SOP 可以按業務類型分類
- 在工時表選擇業務類型時可以顯示相關 SOP
- 業務類型統計可以包含 SOP 使用情況

### ❌ 不良的分離

**錯誤範例：獨立的 SOP 分類系統**

```sql
-- 錯誤：創建與業務類型無關的獨立分類
CREATE TABLE sop_business_categories (
  id INTEGER PRIMARY KEY,
  name TEXT -- 與 business_types 重複
);
```

**問題**：
- 重複管理業務分類
- 資料不同步
- 無法自動關聯

---

## 🚀 開發流程

### 標準開發步驟

1. **需求分析**
   - 檢查現有功能
   - 確認整合點
   - 設計資料關聯

2. **資料庫設計**
   - 創建 migration
   - 建立外鍵約束
   - 設置索引

3. **後端實作**
   - 實作 API
   - 複用認證邏輯
   - 測試 API

4. **前端實作**
   - 複用 UI 組件
   - 整合現有頁面
   - 測試功能

5. **整合測試**
   - 測試資料聯動
   - 測試跨功能導航
   - 測試刪除級聯

6. **部署**
   - 執行 migration
   - 部署 Worker
   - 推送前端
   - 驗證部署

7. **清理**
   - 刪除測試檔案
   - 更新文檔
   - 提交代碼

---

## 📊 整合關係圖

### 現有系統關聯

```
employees (員工)
    ↓ (指派)
client_assignments
    ↓
clients (客戶) ← clients_extended (詳細資料)
    ↓
service_schedule (服務排程)
client_interactions (互動記錄)

business_types (業務類型)
    ↓ (關聯)
timesheets (工時)
    ↓
employees (員工)

users (使用者)
    ↓ (認證)
sessions (會話)
```

### 新增功能必須整合點

**SOP 系統**：
- ✅ 連接 business_types（業務類型）
- ✅ 連接 users（創建者）
- ✅ 顯示在相關業務類型頁面

**專案管理**：
- ✅ 連接 clients（客戶）
- ✅ 連接 employees（負責人）
- ✅ 連接 timesheets（工時）
- ✅ 在客戶頁面顯示相關專案

**CMS**：
- ✅ 連接 users（作者）
- ✅ 使用統一的媒體庫

---

## ⚠️ 常見錯誤

### 1. 創建重複功能

**錯誤**：
```javascript
// 在新模組重新實作認證
function myAuthenticate() { ... }
```

**正確**：
```javascript
// 使用現有的認證函數
import { verifySession } from './auth.js';
```

### 2. 資料不同步

**錯誤**：
```sql
-- 在兩個表儲存客戶名稱
CREATE TABLE new_table (
  client_name TEXT  -- 與 clients 表分離
);
```

**正確**：
```sql
-- 使用外鍵關聯
CREATE TABLE new_table (
  client_name TEXT,
  FOREIGN KEY (client_name) REFERENCES clients(name)
    ON DELETE CASCADE ON UPDATE CASCADE
);
```

### 3. 功能孤立

**錯誤**：
- 新功能沒有與其他頁面連接
- 無法從相關頁面訪問
- 資料無法互相引用

**正確**：
- 在相關頁面添加導航連結
- 顯示關聯資料
- 提供快速跳轉

---

## 📝 文檔更新原則

### 必須更新的文檔

1. **開發指南**（本文件）
   - 新的開發原則
   - 整合範例
   - 常見錯誤

2. **進度追蹤** (`SYSTEM_EXPANSION_PROGRESS.md`)
   - 完成的任務
   - 當前進度
   - 遇到的問題

3. **API 文檔** (如需要)
   - 新增的 API 端點
   - 參數說明
   - 回傳格式

### 不需要的文檔

- ❌ 冗長的完成總結
- ❌ 重複的說明文檔
- ❌ 臨時的測試記錄

---

## 🎯 品質標準

### 代碼提交前檢查

- [ ] 所有測試通過
- [ ] 無 linter 錯誤
- [ ] 功能與現有系統整合
- [ ] 資料聯動正常
- [ ] 臨時檔案已清理
- [ ] 文檔已更新
- [ ] commit message 清晰

### 功能完成標準

- [ ] 功能正常運作
- [ ] 與現有功能整合
- [ ] 資料在各處同步
- [ ] 前後端部署成功
- [ ] 驗證測試通過

---

## 📞 問題處理

### 遇到整合衝突時

1. **停止開發**
2. **分析衝突點**
3. **重新設計整合方式**
4. **修改相關代碼**
5. **測試整合結果**

### 資料不一致時

1. **立即修正**
2. **建立外鍵約束**
3. **添加級聯操作**
4. **測試同步更新**

---

## 🔄 持續改進

本文檔會隨專案發展持續更新。所有開發人員（包括 AI）都應遵循這些原則，確保系統的一致性和可維護性。

**最後更新**: 2025-10-25  
**下次審查**: 需要時更新

