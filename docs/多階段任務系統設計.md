# å¤šéšæ®µä»»å‹™ç³»çµ±è¨­è¨ˆ

**ç‰ˆæœ¬**: 1.0  
**æœ€å¾Œæ›´æ–°**: 2025-10-26

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å¤šéšæ®µä»»å‹™ç³»çµ±å…è¨±å°‡è¤‡é›œä»»å‹™æ‹†åˆ†ç‚ºå¤šå€‹éšæ®µï¼Œæ¯å€‹éšæ®µåŒ…å«æª¢æŸ¥æ¸…å–®ï¼Œæ”¯æ´éšæ®µå¯©æ ¸ã€å·¥æ™‚è¨˜éŒ„ç­‰åŠŸèƒ½ã€‚

### æ ¸å¿ƒåŠŸèƒ½
- å»ºç«‹å¤šéšæ®µä»»å‹™ï¼ˆå¾ç¯„æœ¬æˆ–è‡ªè¨‚ï¼‰
- éšæ®µé †åºåŸ·è¡Œæ§åˆ¶
- éšæ®µæª¢æŸ¥æ¸…å–®ç®¡ç†
- éšæ®µå¯©æ ¸æµç¨‹
- å·¥æ™‚èˆ‡é€²åº¦è¿½è¹¤
- ç¯„æœ¬ç®¡ç†

---

## ğŸ—„ï¸ è³‡æ–™è¡¨çµæ§‹

### tasks (åŸºæœ¬ä»»å‹™)
```sql
CREATE TABLE tasks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  description TEXT,
  status TEXT DEFAULT 'pending',        -- pending, in_progress, completed, cancelled
  priority TEXT DEFAULT 'medium',       -- low, medium, high
  due_date DATETIME,
  assigned_user TEXT,                   -- ä½¿ç”¨è€…åç¨±æˆ–ID
  created_by TEXT,
  category TEXT,                        -- client_service, recurring, business, finance
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### multi_stage_tasks (å¤šéšæ®µä»»å‹™ä¸»è¡¨)
```sql
CREATE TABLE multi_stage_tasks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  task_id INTEGER NOT NULL UNIQUE,
  total_stages INTEGER NOT NULL,       -- ç¸½éšæ®µæ•¸
  completed_stages INTEGER DEFAULT 0,  -- å·²å®Œæˆéšæ®µæ•¸
  overall_progress INTEGER DEFAULT 0,  -- æ•´é«”é€²åº¦ 0-100
  current_stage INTEGER DEFAULT 1,     -- ç•¶å‰éšæ®µ
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
);
```

### task_stages (ä»»å‹™éšæ®µ)
```sql
CREATE TABLE task_stages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  multi_stage_task_id INTEGER NOT NULL,
  stage_order INTEGER NOT NULL,        -- éšæ®µé †åº 1, 2, 3...
  stage_name TEXT NOT NULL,            -- éšæ®µåç¨±
  stage_description TEXT,
  status TEXT DEFAULT 'pending',       -- pending, in_progress, completed, skipped
  checklist TEXT,                      -- JSON æ ¼å¼æª¢æŸ¥æ¸…å–®
  estimated_hours DECIMAL(5,2),        -- é ä¼°å·¥æ™‚
  actual_hours DECIMAL(5,2),           -- å¯¦éš›å·¥æ™‚
  assigned_to TEXT,                    -- è² è²¬äºº
  completed_by TEXT,                   -- å®Œæˆäºº
  completed_at DATETIME,
  notes TEXT,                          -- éšæ®µå‚™è¨»
  requires_approval BOOLEAN DEFAULT 0, -- æ˜¯å¦éœ€è¦å¯©æ ¸
  approved_by TEXT,                    -- å¯©æ ¸äºº
  approved_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (multi_stage_task_id) REFERENCES multi_stage_tasks(id) ON DELETE CASCADE
);
```

### multi_stage_templates (å¤šéšæ®µç¯„æœ¬)
```sql
CREATE TABLE multi_stage_templates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_name TEXT NOT NULL,
  category TEXT,                       -- ç¯„æœ¬åˆ†é¡
  description TEXT,
  total_stages INTEGER NOT NULL,
  is_active BOOLEAN DEFAULT 1,
  created_by TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### template_stages (ç¯„æœ¬éšæ®µ)
```sql
CREATE TABLE template_stages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_id INTEGER NOT NULL,
  stage_order INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_description TEXT,
  checklist TEXT,                      -- JSON æ ¼å¼é è¨­æª¢æŸ¥æ¸…å–®
  estimated_hours DECIMAL(5,2),
  requires_approval BOOLEAN DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (template_id) REFERENCES multi_stage_templates(id) ON DELETE CASCADE
);
```

---

## ğŸ”„ æ¥­å‹™æµç¨‹

### å‰µå»ºå¤šéšæ®µä»»å‹™

```
1. é¸æ“‡ç¯„æœ¬ï¼ˆå¯é¸ï¼‰
   â†“
2. å¡«å¯«ä»»å‹™åŸºæœ¬è³‡è¨Š
   - æ¨™é¡Œã€æè¿°
   - æˆªæ­¢æ—¥æœŸ
   - è² è²¬äºº
   â†“
3. é…ç½®éšæ®µ
   - å¾ç¯„æœ¬è¼‰å…¥æˆ–è‡ªè¨‚
   - è¨­å®šæ¯å€‹éšæ®µçš„æª¢æŸ¥æ¸…å–®
   - è¨­å®šå¯©æ ¸è¦æ±‚
   â†“
4. å‰µå»ºä»»å‹™
   - INSERT INTO tasks
   - INSERT INTO multi_stage_tasks
   - INSERT INTO task_stages (æ‰¹æ¬¡)
   â†“
5. è¿”å›ä»»å‹™ ID
```

### åŸ·è¡Œéšæ®µ

```
1. é–‹å§‹éšæ®µ
   - UPDATE task_stages SET status = 'in_progress'
   - UPDATE tasks SET status = 'in_progress'
   â†“
2. å®Œæˆæª¢æŸ¥æ¸…å–®é …ç›®
   - æ›´æ–° checklist JSON
   - è¨ˆç®—éšæ®µå®Œæˆåº¦
   â†“
3. å®Œæˆéšæ®µ
   - æª¢æŸ¥æ‰€æœ‰æª¢æŸ¥æ¸…å–®é …ç›®
   - è¨˜éŒ„å¯¦éš›å·¥æ™‚
   â†“
4. å¯©æ ¸ï¼ˆå¦‚éœ€è¦ï¼‰
   - ç­‰å¾…å¯©æ ¸äººå“¡å¯©æ ¸
   - UPDATE approved_by, approved_at
   â†“
5. é€²å…¥ä¸‹ä¸€éšæ®µ
   - UPDATE completed_stages
   - UPDATE current_stage
   - è¨ˆç®—æ•´é«”é€²åº¦
   â†“
6. æ‰€æœ‰éšæ®µå®Œæˆ
   - UPDATE tasks SET status = 'completed'
```

---

## ğŸ”Œ API è¨­è¨ˆ

### å‰µå»ºå¤šéšæ®µä»»å‹™
```
POST /api/tasks/multi-stage

Request:
{
  "title": "ä»»å‹™æ¨™é¡Œ",
  "description": "ä»»å‹™æè¿°",
  "due_date": "2025-12-31",
  "assigned_user": "user1",
  "category": "client_service",
  "template_id": 1,  // å¯é¸ï¼Œä½¿ç”¨ç¯„æœ¬
  "stages": [        // æˆ–è‡ªè¨‚éšæ®µ
    {
      "stage_name": "éšæ®µä¸€",
      "stage_description": "...",
      "checklist": ["é …ç›®1", "é …ç›®2"],
      "estimated_hours": 2.0,
      "requires_approval": false
    }
  ]
}

Response:
{
  "success": true,
  "task_id": 123,
  "multi_stage_task_id": 45
}
```

### ç²å–å¤šéšæ®µä»»å‹™åˆ—è¡¨
```
GET /api/tasks/multi-stage?status=in_progress&assigned_user=user1

Response:
{
  "success": true,
  "tasks": [
    {
      "id": 123,
      "title": "...",
      "status": "in_progress",
      "total_stages": 5,
      "completed_stages": 2,
      "overall_progress": 40,
      "current_stage": 3,
      "due_date": "2025-12-31"
    }
  ]
}
```

### ç²å–ä»»å‹™è©³æƒ…ï¼ˆå«æ‰€æœ‰éšæ®µï¼‰
```
GET /api/tasks/multi-stage/{task_id}

Response:
{
  "success": true,
  "task": {
    "id": 123,
    "title": "...",
    "status": "in_progress",
    "stages": [
      {
        "id": 1,
        "stage_order": 1,
        "stage_name": "éšæ®µä¸€",
        "status": "completed",
        "checklist": [
          {"item": "é …ç›®1", "completed": true},
          {"item": "é …ç›®2", "completed": true}
        ],
        "actual_hours": 2.5,
        "completed_at": "2025-10-20T10:00:00Z"
      },
      {
        "id": 2,
        "stage_order": 2,
        "stage_name": "éšæ®µäºŒ",
        "status": "in_progress",
        "checklist": [...]
      }
    ]
  }
}
```

### æ›´æ–°éšæ®µé€²åº¦
```
PUT /api/tasks/multi-stage/{task_id}/stage/{stage_number}

Request:
{
  "status": "completed",
  "checklist": [...],
  "actual_hours": 2.5,
  "notes": "éšæ®µå‚™è¨»"
}

Response:
{
  "success": true,
  "message": "éšæ®µå·²æ›´æ–°",
  "overall_progress": 60
}
```

### ç²å–ç¯„æœ¬åˆ—è¡¨
```
GET /api/multi-stage-templates?category=client_service

Response:
{
  "success": true,
  "templates": [
    {
      "id": 1,
      "template_name": "ç‡Ÿæ¥­ç¨…ç”³å ±æµç¨‹",
      "category": "client_service",
      "total_stages": 8,
      "description": "..."
    }
  ]
}
```

### ç²å–ç¯„æœ¬è©³æƒ…
```
GET /api/multi-stage-templates/{template_id}/stages

Response:
{
  "success": true,
  "template": {
    "id": 1,
    "template_name": "...",
    "stages": [...]
  }
}
```

---

## ğŸ’» å‰ç«¯è¨­è¨ˆ

### é é¢ï¼šmulti-stage-tasks.html

#### ä¸»è¦å€å¡Š
1. **ä»»å‹™åˆ—è¡¨**
   - ç¯©é¸ï¼šç‹€æ…‹ã€è² è²¬äººã€åˆ†é¡
   - æœå°‹
   - ä»»å‹™å¡ç‰‡é¡¯ç¤ºé€²åº¦æ¢

2. **ä»»å‹™è©³æƒ…å´é‚Šæ¬„**
   - ä»»å‹™åŸºæœ¬è³‡è¨Š
   - éšæ®µåˆ—è¡¨ï¼ˆå¯å±•é–‹ï¼‰
   - ç•¶å‰éšæ®µé«˜äº®
   - æª¢æŸ¥æ¸…å–®é …ç›®å‹¾é¸

3. **å‰µå»ºä»»å‹™å°è©±æ¡†**
   - åŸºæœ¬è³‡è¨Šè¼¸å…¥
   - ç¯„æœ¬é¸æ“‡
   - éšæ®µç·¨è¼¯å™¨

#### æª¢æŸ¥æ¸…å–®æ ¼å¼ï¼ˆJSONï¼‰
```json
[
  {
    "item": "æ”¶é›†é€²é …ç™¼ç¥¨",
    "completed": false,
    "completed_by": null,
    "completed_at": null
  },
  {
    "item": "æ”¶é›†éŠ·é …ç™¼ç¥¨",
    "completed": true,
    "completed_by": "user1",
    "completed_at": "2025-10-20T10:00:00Z"
  }
]
```

---

## ğŸ“Š çµ±è¨ˆèˆ‡å ±è¡¨

### ä»»å‹™çµ±è¨ˆ
```sql
-- æ•´é«”ä»»å‹™çµ±è¨ˆ
SELECT 
  COUNT(*) as total_tasks,
  SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed,
  SUM(CASE WHEN status = 'in_progress' THEN 1 ELSE 0 END) as in_progress,
  AVG(overall_progress) as avg_progress
FROM multi_stage_tasks mst
JOIN tasks t ON mst.task_id = t.id
WHERE t.category = 'client_service';
```

### éšæ®µå®Œæˆç‡
```sql
-- å„éšæ®µå¹³å‡å®Œæˆæ™‚é–“
SELECT 
  stage_name,
  AVG(actual_hours) as avg_hours,
  COUNT(*) as total_completed
FROM task_stages
WHERE status = 'completed'
GROUP BY stage_name
ORDER BY avg_hours DESC;
```

---

## ğŸ”§ å¯¦æ–½ç´°ç¯€

### æª¢æŸ¥æ¸…å–®æ“ä½œ
```javascript
// æ›´æ–°æª¢æŸ¥æ¸…å–®é …ç›®
function updateChecklistItem(stageId, itemIndex, completed) {
  // 1. ç²å–ç•¶å‰æª¢æŸ¥æ¸…å–®
  const checklist = JSON.parse(stage.checklist);
  
  // 2. æ›´æ–°é …ç›®
  checklist[itemIndex].completed = completed;
  checklist[itemIndex].completed_by = currentUser;
  checklist[itemIndex].completed_at = new Date().toISOString();
  
  // 3. å„²å­˜å›è³‡æ–™åº«
  await updateStage(stageId, {
    checklist: JSON.stringify(checklist)
  });
}
```

### é€²åº¦è¨ˆç®—
```javascript
// è¨ˆç®—æ•´é«”é€²åº¦
function calculateOverallProgress(stages) {
  const totalStages = stages.length;
  const completedStages = stages.filter(s => s.status === 'completed').length;
  const currentStageProgress = getCurrentStageProgress(stages);
  
  return Math.round(
    ((completedStages + currentStageProgress / 100) / totalStages) * 100
  );
}
```

---

## ğŸš€ æœªä¾†æ“´å±•

### è¨ˆåŠƒåŠŸèƒ½
- [ ] éšæ®µä¾è³´é—œä¿‚ï¼ˆæŸäº›éšæ®µå¿…é ˆå…ˆå®Œæˆï¼‰
- [ ] éšæ®µä¸¦è¡ŒåŸ·è¡Œ
- [ ] å­ä»»å‹™æ”¯æ´
- [ ] ç”˜ç‰¹åœ–è¦–åœ–
- [ ] éšæ®µæ™‚é–“ä¼°ç®— vs å¯¦éš›å°æ¯”å ±è¡¨
- [ ] ç¯„æœ¬å¸‚å ´ï¼ˆå…±äº«ç¯„æœ¬ï¼‰

---

## ğŸ“ ä½¿ç”¨ç¯„ä¾‹

### ç¯„ä¾‹ï¼šç‡Ÿæ¥­ç¨…ç”³å ±ä»»å‹™

```javascript
// å‰µå»ºä»»å‹™
const task = await createMultiStageTask({
  title: "ä»Ÿé‘½å…¬å¸ - 2025-10 ç‡Ÿæ¥­ç¨…ç”³å ±",
  template_id: 1,  // ä½¿ç”¨ç‡Ÿæ¥­ç¨…ç¯„æœ¬
  due_date: "2025-11-15",
  assigned_user: "yunzhen"
});

// åŸ·è¡Œç¬¬ä¸€éšæ®µ
await updateStage(task.id, 1, {
  status: "in_progress"
});

// å®Œæˆæª¢æŸ¥æ¸…å–®
await updateChecklist(task.id, 1, 0, true);  // å®Œæˆç¬¬ä¸€é …
await updateChecklist(task.id, 1, 1, true);  // å®Œæˆç¬¬äºŒé …

// å®Œæˆéšæ®µ
await completeStage(task.id, 1, {
  actual_hours: 2.5,
  notes: "ç™¼ç¥¨å·²æ”¶é›†å®Œæˆ"
});
```

---

**ç›¸é—œæ–‡æª”**ï¼š
- [ç³»çµ±æ¶æ§‹è¨­è¨ˆ.md](./ç³»çµ±æ¶æ§‹è¨­è¨ˆ.md) - æ•´é«”æ¶æ§‹
- [APIç«¯é»æ–‡æª”.md](./APIç«¯é»æ–‡æª”.md) - å®Œæ•´ API åƒè€ƒ

