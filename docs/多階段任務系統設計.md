# 多階段任務系統設計

**版本**: 1.0  
**最後更新**: 2025-10-26

---

## 📋 功能概述

多階段任務系統允許將複雜任務拆分為多個階段，每個階段包含檢查清單，支援階段審核、工時記錄等功能。

### 核心功能
- 建立多階段任務（從範本或自訂）
- 階段順序執行控制
- 階段檢查清單管理
- 階段審核流程
- 工時與進度追蹤
- 範本管理

---

## 🗄️ 資料表結構

### tasks (基本任務)
```sql
CREATE TABLE tasks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  description TEXT,
  status TEXT DEFAULT 'pending',        -- pending, in_progress, completed, cancelled
  priority TEXT DEFAULT 'medium',       -- low, medium, high
  due_date DATETIME,
  assigned_user TEXT,                   -- 使用者名稱或ID
  created_by TEXT,
  category TEXT,                        -- client_service, recurring, business, finance
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### multi_stage_tasks (多階段任務主表)
```sql
CREATE TABLE multi_stage_tasks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  task_id INTEGER NOT NULL UNIQUE,
  total_stages INTEGER NOT NULL,       -- 總階段數
  completed_stages INTEGER DEFAULT 0,  -- 已完成階段數
  overall_progress INTEGER DEFAULT 0,  -- 整體進度 0-100
  current_stage INTEGER DEFAULT 1,     -- 當前階段
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
);
```

### task_stages (任務階段)
```sql
CREATE TABLE task_stages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  multi_stage_task_id INTEGER NOT NULL,
  stage_order INTEGER NOT NULL,        -- 階段順序 1, 2, 3...
  stage_name TEXT NOT NULL,            -- 階段名稱
  stage_description TEXT,
  status TEXT DEFAULT 'pending',       -- pending, in_progress, completed, skipped
  checklist TEXT,                      -- JSON 格式檢查清單
  estimated_hours DECIMAL(5,2),        -- 預估工時
  actual_hours DECIMAL(5,2),           -- 實際工時
  assigned_to TEXT,                    -- 負責人
  completed_by TEXT,                   -- 完成人
  completed_at DATETIME,
  notes TEXT,                          -- 階段備註
  requires_approval BOOLEAN DEFAULT 0, -- 是否需要審核
  approved_by TEXT,                    -- 審核人
  approved_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (multi_stage_task_id) REFERENCES multi_stage_tasks(id) ON DELETE CASCADE
);
```

### multi_stage_templates (多階段範本)
```sql
CREATE TABLE multi_stage_templates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_name TEXT NOT NULL,
  category TEXT,                       -- 範本分類
  description TEXT,
  total_stages INTEGER NOT NULL,
  is_active BOOLEAN DEFAULT 1,
  created_by TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### template_stages (範本階段)
```sql
CREATE TABLE template_stages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_id INTEGER NOT NULL,
  stage_order INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_description TEXT,
  checklist TEXT,                      -- JSON 格式預設檢查清單
  estimated_hours DECIMAL(5,2),
  requires_approval BOOLEAN DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (template_id) REFERENCES multi_stage_templates(id) ON DELETE CASCADE
);
```

---

## 🔄 業務流程

### 創建多階段任務

```
1. 選擇範本（可選）
   ↓
2. 填寫任務基本資訊
   - 標題、描述
   - 截止日期
   - 負責人
   ↓
3. 配置階段
   - 從範本載入或自訂
   - 設定每個階段的檢查清單
   - 設定審核要求
   ↓
4. 創建任務
   - INSERT INTO tasks
   - INSERT INTO multi_stage_tasks
   - INSERT INTO task_stages (批次)
   ↓
5. 返回任務 ID
```

### 執行階段

```
1. 開始階段
   - UPDATE task_stages SET status = 'in_progress'
   - UPDATE tasks SET status = 'in_progress'
   ↓
2. 完成檢查清單項目
   - 更新 checklist JSON
   - 計算階段完成度
   ↓
3. 完成階段
   - 檢查所有檢查清單項目
   - 記錄實際工時
   ↓
4. 審核（如需要）
   - 等待審核人員審核
   - UPDATE approved_by, approved_at
   ↓
5. 進入下一階段
   - UPDATE completed_stages
   - UPDATE current_stage
   - 計算整體進度
   ↓
6. 所有階段完成
   - UPDATE tasks SET status = 'completed'
```

---

## 🔌 API 設計

### 創建多階段任務
```
POST /api/tasks/multi-stage

Request:
{
  "title": "任務標題",
  "description": "任務描述",
  "due_date": "2025-12-31",
  "assigned_user": "user1",
  "category": "client_service",
  "template_id": 1,  // 可選，使用範本
  "stages": [        // 或自訂階段
    {
      "stage_name": "階段一",
      "stage_description": "...",
      "checklist": ["項目1", "項目2"],
      "estimated_hours": 2.0,
      "requires_approval": false
    }
  ]
}

Response:
{
  "success": true,
  "task_id": 123,
  "multi_stage_task_id": 45
}
```

### 獲取多階段任務列表
```
GET /api/tasks/multi-stage?status=in_progress&assigned_user=user1

Response:
{
  "success": true,
  "tasks": [
    {
      "id": 123,
      "title": "...",
      "status": "in_progress",
      "total_stages": 5,
      "completed_stages": 2,
      "overall_progress": 40,
      "current_stage": 3,
      "due_date": "2025-12-31"
    }
  ]
}
```

### 獲取任務詳情（含所有階段）
```
GET /api/tasks/multi-stage/{task_id}

Response:
{
  "success": true,
  "task": {
    "id": 123,
    "title": "...",
    "status": "in_progress",
    "stages": [
      {
        "id": 1,
        "stage_order": 1,
        "stage_name": "階段一",
        "status": "completed",
        "checklist": [
          {"item": "項目1", "completed": true},
          {"item": "項目2", "completed": true}
        ],
        "actual_hours": 2.5,
        "completed_at": "2025-10-20T10:00:00Z"
      },
      {
        "id": 2,
        "stage_order": 2,
        "stage_name": "階段二",
        "status": "in_progress",
        "checklist": [...]
      }
    ]
  }
}
```

### 更新階段進度
```
PUT /api/tasks/multi-stage/{task_id}/stage/{stage_number}

Request:
{
  "status": "completed",
  "checklist": [...],
  "actual_hours": 2.5,
  "notes": "階段備註"
}

Response:
{
  "success": true,
  "message": "階段已更新",
  "overall_progress": 60
}
```

### 獲取範本列表
```
GET /api/multi-stage-templates?category=client_service

Response:
{
  "success": true,
  "templates": [
    {
      "id": 1,
      "template_name": "營業稅申報流程",
      "category": "client_service",
      "total_stages": 8,
      "description": "..."
    }
  ]
}
```

### 獲取範本詳情
```
GET /api/multi-stage-templates/{template_id}/stages

Response:
{
  "success": true,
  "template": {
    "id": 1,
    "template_name": "...",
    "stages": [...]
  }
}
```

---

## 💻 前端設計

### 頁面：multi-stage-tasks.html

#### 主要區塊
1. **任務列表**
   - 篩選：狀態、負責人、分類
   - 搜尋
   - 任務卡片顯示進度條

2. **任務詳情側邊欄**
   - 任務基本資訊
   - 階段列表（可展開）
   - 當前階段高亮
   - 檢查清單項目勾選

3. **創建任務對話框**
   - 基本資訊輸入
   - 範本選擇
   - 階段編輯器

#### 檢查清單格式（JSON）
```json
[
  {
    "item": "收集進項發票",
    "completed": false,
    "completed_by": null,
    "completed_at": null
  },
  {
    "item": "收集銷項發票",
    "completed": true,
    "completed_by": "user1",
    "completed_at": "2025-10-20T10:00:00Z"
  }
]
```

---

## 📊 統計與報表

### 任務統計
```sql
-- 整體任務統計
SELECT 
  COUNT(*) as total_tasks,
  SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed,
  SUM(CASE WHEN status = 'in_progress' THEN 1 ELSE 0 END) as in_progress,
  AVG(overall_progress) as avg_progress
FROM multi_stage_tasks mst
JOIN tasks t ON mst.task_id = t.id
WHERE t.category = 'client_service';
```

### 階段完成率
```sql
-- 各階段平均完成時間
SELECT 
  stage_name,
  AVG(actual_hours) as avg_hours,
  COUNT(*) as total_completed
FROM task_stages
WHERE status = 'completed'
GROUP BY stage_name
ORDER BY avg_hours DESC;
```

---

## 🔧 實施細節

### 檢查清單操作
```javascript
// 更新檢查清單項目
function updateChecklistItem(stageId, itemIndex, completed) {
  // 1. 獲取當前檢查清單
  const checklist = JSON.parse(stage.checklist);
  
  // 2. 更新項目
  checklist[itemIndex].completed = completed;
  checklist[itemIndex].completed_by = currentUser;
  checklist[itemIndex].completed_at = new Date().toISOString();
  
  // 3. 儲存回資料庫
  await updateStage(stageId, {
    checklist: JSON.stringify(checklist)
  });
}
```

### 進度計算
```javascript
// 計算整體進度
function calculateOverallProgress(stages) {
  const totalStages = stages.length;
  const completedStages = stages.filter(s => s.status === 'completed').length;
  const currentStageProgress = getCurrentStageProgress(stages);
  
  return Math.round(
    ((completedStages + currentStageProgress / 100) / totalStages) * 100
  );
}
```

---

## 🚀 未來擴展

### 計劃功能
- [ ] 階段依賴關係（某些階段必須先完成）
- [ ] 階段並行執行
- [ ] 子任務支援
- [ ] 甘特圖視圖
- [ ] 階段時間估算 vs 實際對比報表
- [ ] 範本市場（共享範本）

---

## 📝 使用範例

### 範例：營業稅申報任務

```javascript
// 創建任務
const task = await createMultiStageTask({
  title: "仟鑽公司 - 2025-10 營業稅申報",
  template_id: 1,  // 使用營業稅範本
  due_date: "2025-11-15",
  assigned_user: "yunzhen"
});

// 執行第一階段
await updateStage(task.id, 1, {
  status: "in_progress"
});

// 完成檢查清單
await updateChecklist(task.id, 1, 0, true);  // 完成第一項
await updateChecklist(task.id, 1, 1, true);  // 完成第二項

// 完成階段
await completeStage(task.id, 1, {
  actual_hours: 2.5,
  notes: "發票已收集完成"
});
```

---

**相關文檔**：
- [系統架構設計.md](./系統架構設計.md) - 整體架構
- [API端點文檔.md](./API端點文檔.md) - 完整 API 參考

