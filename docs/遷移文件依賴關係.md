# 資料庫遷移文件依賴關係圖

**版本**: 1.0  
**最後更新**: 2025-10-26  
**目的**: 明確說明21個遷移文件的執行順序與依賴關係

---

## 📊 遷移文件樹狀圖

```
001_complete_schema.sql (基礎架構) ⭐ 核心依賴
│
├─> 002_seed_data.sql (初始資料)
│   └─> 必須在 001 之後
│
├─> 003_clients_expansion.sql (客戶擴展)
│   ├─> 依賴: 001 (clients, employees)
│   └─> 被取代: 015, 017
│
├─> 004_sop_system.sql (SOP系統)
│   ├─> 依賴: 001 (users)
│   └─> 擴展: 004a
│       └─> 004a_sop_business_integration.sql
│
├─> 005_media_library.sql (媒體庫)
│   └─> 依賴: 001 (users)
│
├─> 006_project_management.sql (專案管理)
│   ├─> 依賴: 001 (clients, employees, users)
│   └─> 擴展: 012
│       └─> 012_add_project_category.sql
│
├─> 007_add_timestamps.sql (時間戳)
│   ├─> 依賴: 001-006 (所有現有表)
│   └─> 擴展: 007a
│       └─> 007a_report_cache.sql
│
├─> 008_cms.sql (內容管理)
│   ├─> 依賴: 001 (users), 005 (media_library)
│   └─> 獨立功能
│
├─> 010_multi_stage_tasks.sql (多階段任務)
│   ├─> 依賴: 001 (clients, employees, users)
│   └─> 擴展: 021
│       └─> 021_add_task_templates.sql (12個預設範本)
│
├─> 011_recurring_tasks.sql (周期任務)
│   ├─> 依賴: 010 (tasks, multi_stage_tasks)
│   └─> 獨立循環任務系統
│
├─> 013_client_services_integration_补充.sql (客戶服務自動化)
│   ├─> 依賴: 001 (clients), 010 (tasks)
│   ├─> 被重建: 015
│   └─> 擴展: 019, 020
│       ├─> 019_add_default_checklist_templates.sql (5個預設模板)
│       └─> 020_migrate_old_service_schedules.sql (資料遷移)
│
├─> 015_rebuild_client_services.sql (重建客戶服務) ⭐ 重要
│   ├─> 依賴: 001, 013
│   ├─> 取代: 003 的 client_service_schedules
│   └─> 備份舊表: client_services_old
│
├─> 016_enhanced_system_features.sql (系統功能增強)
│   ├─> 依賴: 001 (users), 010 (tasks)
│   └─> 新增: task_reminders, user_reminders
│
├─> 017_expand_clients_table.sql (擴展客戶表) ⭐ 重要
│   ├─> 依賴: 001
│   ├─> 重建: clients 表
│   └─> 遷移舊資料
│
└─> 018_expand_system_parameters.sql (擴展系統參數)
    ├─> 依賴: 001 (system_parameters)
    └─> 新增欄位: editor_type, validation_rule 等
```

---

## 🔢 推薦執行順序

### Phase 1: 基礎架構 (必須最先)
```bash
001_complete_schema.sql          # ⭐ 必須第一個
002_seed_data.sql                # ⭐ 必須第二個
```

### Phase 2: 核心功能擴展
```bash
003_clients_expansion.sql        # 客戶擴展（舊版）
004_sop_system.sql               # SOP系統
004a_sop_business_integration.sql # SOP業務整合
005_media_library.sql            # 媒體庫
006_project_management.sql       # 專案管理
007_add_timestamps.sql           # 時間戳
007a_report_cache.sql            # 報表快取
008_cms.sql                      # CMS
```

### Phase 3: 任務管理系統
```bash
010_multi_stage_tasks.sql        # ⭐ 多階段任務（核心）
011_recurring_tasks.sql          # 周期任務
012_add_project_category.sql    # 專案分類
```

### Phase 4: 客戶服務自動化
```bash
013_client_services_integration_补充.sql  # 客戶服務整合
015_rebuild_client_services.sql          # ⭐ 重建客戶服務（取代003）
019_add_default_checklist_templates.sql  # 5個預設模板
020_migrate_old_service_schedules.sql    # 資料遷移
021_add_task_templates.sql               # 12個任務範本
```

### Phase 5: 系統增強
```bash
016_enhanced_system_features.sql   # 提醒系統
017_expand_clients_table.sql       # ⭐ 擴展客戶表（取代001的簡化版）
018_expand_system_parameters.sql   # 擴展系統參數
```

---

## ⚠️ 關鍵依賴關係

### 1. 絕對依賴 (必須先執行)

```mermaid
001 → [所有其他遷移]
    ├→ 003, 004, 005, 006, 007, 008
    └→ 010 → [011, 012, 013]
```

### 2. 替代關係 (新版取代舊版)

| 舊版本 | 新版本 | 說明 |
|--------|--------|------|
| 003 的 client_service_schedules | 015 的 client_services | ✅ 015會備份舊表 |
| 001 的 clients (簡化) | 017 的 clients (完整) | ✅ 017會遷移資料 |

### 3. 擴展關係 (增強現有功能)

| 基礎遷移 | 擴展遷移 | 關係 |
|---------|---------|------|
| 004 | 004a | 為 sops 表添加 business_type 欄位 |
| 007 | 007a | 添加報表快取功能 |
| 010 | 021 | 添加12個預設任務範本 |
| 013 | 019 | 添加5個預設檢查清單模板 |
| 013 | 020 | 遷移舊服務排程資料 |

---

## 🔄 遷移文件分類

### A. 核心基礎 (4個)
```
001_complete_schema.sql          ⭐⭐⭐ 最重要
002_seed_data.sql               ⭐⭐⭐ 最重要
017_expand_clients_table.sql    ⭐⭐ 很重要（替換001的clients）
015_rebuild_client_services.sql ⭐⭐ 很重要（替換003）
```

### B. 功能模塊 (8個)
```
004_sop_system.sql              # SOP知識庫
005_media_library.sql           # 媒體庫
006_project_management.sql      # 專案管理
008_cms.sql                     # 內容管理
010_multi_stage_tasks.sql       # 多階段任務
011_recurring_tasks.sql         # 周期任務
013_client_services_integration_补充.sql  # 客戶服務
016_enhanced_system_features.sql # 提醒系統
```

### C. 擴展增強 (6個)
```
004a_sop_business_integration.sql  # SOP業務整合
007_add_timestamps.sql            # 時間戳
007a_report_cache.sql             # 報表快取
012_add_project_category.sql      # 專案分類
018_expand_system_parameters.sql  # 系統參數擴展
```

### D. 預設資料 (3個)
```
002_seed_data.sql                # 基礎初始資料
019_add_default_checklist_templates.sql  # 5個檢查清單模板
021_add_task_templates.sql       # 12個任務範本
020_migrate_old_service_schedules.sql    # 舊資料遷移
```

---

## 🚨 執行注意事項

### 1. 必須按順序執行
```bash
# ❌ 錯誤：跳過基礎遷移
npx wrangler d1 execute DB --remote --file=migrations/010_multi_stage_tasks.sql

# ✅ 正確：先執行001和002
npx wrangler d1 execute DB --remote --file=migrations/001_complete_schema.sql
npx wrangler d1 execute DB --remote --file=migrations/002_seed_data.sql
npx wrangler d1 execute DB --remote --file=migrations/010_multi_stage_tasks.sql
```

### 2. 重建遷移需特別注意
```bash
# 015 和 017 會重建表格，執行前請備份！
npx wrangler d1 backup DB --remote  # 先備份
npx wrangler d1 execute DB --remote --file=migrations/015_rebuild_client_services.sql
npx wrangler d1 execute DB --remote --file=migrations/017_expand_clients_table.sql
```

### 3. 字母後綴遷移(a)
```bash
# 必須在基礎遷移之後
004 -> 004a
007 -> 007a
```

---

## 📋 快速檢查清單

### 新資料庫完整設置
```bash
cd timesheet-api

# Phase 1: 基礎
npx wrangler d1 execute DB --remote --file=migrations/001_complete_schema.sql
npx wrangler d1 execute DB --remote --file=migrations/002_seed_data.sql

# Phase 2: 核心功能
npx wrangler d1 execute DB --remote --file=migrations/003_clients_expansion.sql
npx wrangler d1 execute DB --remote --file=migrations/004_sop_system.sql
npx wrangler d1 execute DB --remote --file=migrations/004a_sop_business_integration.sql
npx wrangler d1 execute DB --remote --file=migrations/005_media_library.sql
npx wrangler d1 execute DB --remote --file=migrations/006_project_management.sql
npx wrangler d1 execute DB --remote --file=migrations/007_add_timestamps.sql
npx wrangler d1 execute DB --remote --file=migrations/007a_report_cache.sql
npx wrangler d1 execute DB --remote --file=migrations/008_cms.sql

# Phase 3: 任務系統
npx wrangler d1 execute DB --remote --file=migrations/010_multi_stage_tasks.sql
npx wrangler d1 execute DB --remote --file=migrations/011_recurring_tasks.sql
npx wrangler d1 execute DB --remote --file=migrations/012_add_project_category.sql

# Phase 4: 客戶服務自動化
npx wrangler d1 execute DB --remote --file=migrations/013_client_services_integration_补充.sql
npx wrangler d1 execute DB --remote --file=migrations/015_rebuild_client_services.sql
npx wrangler d1 execute DB --remote --file=migrations/019_add_default_checklist_templates.sql
npx wrangler d1 execute DB --remote --file=migrations/020_migrate_old_service_schedules.sql
npx wrangler d1 execute DB --remote --file=migrations/021_add_task_templates.sql

# Phase 5: 系統增強
npx wrangler d1 execute DB --remote --file=migrations/016_enhanced_system_features.sql
npx wrangler d1 execute DB --remote --file=migrations/017_expand_clients_table.sql
npx wrangler d1 execute DB --remote --file=migrations/018_expand_system_parameters.sql

echo "✅ 所有遷移執行完成"
```

### 驗證遷移結果
```sql
-- 檢查表數量（應該有40+個表）
SELECT COUNT(*) FROM sqlite_master WHERE type='table';

-- 檢查預設範本（應該有12個）
SELECT COUNT(*) FROM multi_stage_templates;

-- 檢查預設檢查清單（應該有5個）
SELECT COUNT(*) FROM service_checklist_templates;

-- 檢查clients表結構（應該有完整欄位）
PRAGMA table_info(clients);
```

---

## 🎯 遷移策略建議

### 新專案
✅ 按照上述順序執行所有21個遷移文件

### 現有專案升級
1. ✅ 先備份當前資料庫
2. ✅ 檢查已執行的遷移（創建遷移記錄表）
3. ✅ 只執行缺少的遷移文件
4. ⚠️ 特別注意015和017（會重建表）

### 開發環境測試
```bash
# 使用本地資料庫測試
npx wrangler d1 execute DB --local --file=migrations/XXX.sql

# 驗證無誤後再部署到遠端
npx wrangler d1 execute DB --remote --file=migrations/XXX.sql
```

---

## 📝 版本歷史

| 日期 | 版本 | 說明 |
|------|------|------|
| 2025-10-26 | 1.0 | 初始版本，完整遷移依賴關係圖 |

---

**提示**: 此文檔與 `資料表版本說明.md` 配合使用，可完整了解系統的資料庫架構演進。

