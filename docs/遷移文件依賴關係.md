# è³‡æ–™åº«é·ç§»æ–‡ä»¶ä¾è³´é—œä¿‚åœ–

**ç‰ˆæœ¬**: 1.0  
**æœ€å¾Œæ›´æ–°**: 2025-10-26  
**ç›®çš„**: æ˜ç¢ºèªªæ˜21å€‹é·ç§»æ–‡ä»¶çš„åŸ·è¡Œé †åºèˆ‡ä¾è³´é—œä¿‚

---

## ğŸ“Š é·ç§»æ–‡ä»¶æ¨¹ç‹€åœ–

```
001_complete_schema.sql (åŸºç¤æ¶æ§‹) â­ æ ¸å¿ƒä¾è³´
â”‚
â”œâ”€> 002_seed_data.sql (åˆå§‹è³‡æ–™)
â”‚   â””â”€> å¿…é ˆåœ¨ 001 ä¹‹å¾Œ
â”‚
â”œâ”€> 003_clients_expansion.sql (å®¢æˆ¶æ“´å±•)
â”‚   â”œâ”€> ä¾è³´: 001 (clients, employees)
â”‚   â””â”€> è¢«å–ä»£: 015, 017
â”‚
â”œâ”€> 004_sop_system.sql (SOPç³»çµ±)
â”‚   â”œâ”€> ä¾è³´: 001 (users)
â”‚   â””â”€> æ“´å±•: 004a
â”‚       â””â”€> 004a_sop_business_integration.sql
â”‚
â”œâ”€> 005_media_library.sql (åª’é«”åº«)
â”‚   â””â”€> ä¾è³´: 001 (users)
â”‚
â”œâ”€> 006_project_management.sql (å°ˆæ¡ˆç®¡ç†)
â”‚   â”œâ”€> ä¾è³´: 001 (clients, employees, users)
â”‚   â””â”€> æ“´å±•: 012
â”‚       â””â”€> 012_add_project_category.sql
â”‚
â”œâ”€> 007_add_timestamps.sql (æ™‚é–“æˆ³)
â”‚   â”œâ”€> ä¾è³´: 001-006 (æ‰€æœ‰ç¾æœ‰è¡¨)
â”‚   â””â”€> æ“´å±•: 007a
â”‚       â””â”€> 007a_report_cache.sql
â”‚
â”œâ”€> 008_cms.sql (å…§å®¹ç®¡ç†)
â”‚   â”œâ”€> ä¾è³´: 001 (users), 005 (media_library)
â”‚   â””â”€> ç¨ç«‹åŠŸèƒ½
â”‚
â”œâ”€> 010_multi_stage_tasks.sql (å¤šéšæ®µä»»å‹™)
â”‚   â”œâ”€> ä¾è³´: 001 (clients, employees, users)
â”‚   â””â”€> æ“´å±•: 021
â”‚       â””â”€> 021_add_task_templates.sql (12å€‹é è¨­ç¯„æœ¬)
â”‚
â”œâ”€> 011_recurring_tasks.sql (å‘¨æœŸä»»å‹™)
â”‚   â”œâ”€> ä¾è³´: 010 (tasks, multi_stage_tasks)
â”‚   â””â”€> ç¨ç«‹å¾ªç’°ä»»å‹™ç³»çµ±
â”‚
â”œâ”€> 013_client_services_integration_è¡¥å…….sql (å®¢æˆ¶æœå‹™è‡ªå‹•åŒ–)
â”‚   â”œâ”€> ä¾è³´: 001 (clients), 010 (tasks)
â”‚   â”œâ”€> è¢«é‡å»º: 015
â”‚   â””â”€> æ“´å±•: 019, 020
â”‚       â”œâ”€> 019_add_default_checklist_templates.sql (5å€‹é è¨­æ¨¡æ¿)
â”‚       â””â”€> 020_migrate_old_service_schedules.sql (è³‡æ–™é·ç§»)
â”‚
â”œâ”€> 015_rebuild_client_services.sql (é‡å»ºå®¢æˆ¶æœå‹™) â­ é‡è¦
â”‚   â”œâ”€> ä¾è³´: 001, 013
â”‚   â”œâ”€> å–ä»£: 003 çš„ client_service_schedules
â”‚   â””â”€> å‚™ä»½èˆŠè¡¨: client_services_old
â”‚
â”œâ”€> 016_enhanced_system_features.sql (ç³»çµ±åŠŸèƒ½å¢å¼·)
â”‚   â”œâ”€> ä¾è³´: 001 (users), 010 (tasks)
â”‚   â””â”€> æ–°å¢: task_reminders, user_reminders
â”‚
â”œâ”€> 017_expand_clients_table.sql (æ“´å±•å®¢æˆ¶è¡¨) â­ é‡è¦
â”‚   â”œâ”€> ä¾è³´: 001
â”‚   â”œâ”€> é‡å»º: clients è¡¨
â”‚   â””â”€> é·ç§»èˆŠè³‡æ–™
â”‚
â””â”€> 018_expand_system_parameters.sql (æ“´å±•ç³»çµ±åƒæ•¸)
    â”œâ”€> ä¾è³´: 001 (system_parameters)
    â””â”€> æ–°å¢æ¬„ä½: editor_type, validation_rule ç­‰
```

---

## ğŸ”¢ æ¨è–¦åŸ·è¡Œé †åº

### Phase 1: åŸºç¤æ¶æ§‹ (å¿…é ˆæœ€å…ˆ)
```bash
001_complete_schema.sql          # â­ å¿…é ˆç¬¬ä¸€å€‹
002_seed_data.sql                # â­ å¿…é ˆç¬¬äºŒå€‹
```

### Phase 2: æ ¸å¿ƒåŠŸèƒ½æ“´å±•
```bash
003_clients_expansion.sql        # å®¢æˆ¶æ“´å±•ï¼ˆèˆŠç‰ˆï¼‰
004_sop_system.sql               # SOPç³»çµ±
004a_sop_business_integration.sql # SOPæ¥­å‹™æ•´åˆ
005_media_library.sql            # åª’é«”åº«
006_project_management.sql       # å°ˆæ¡ˆç®¡ç†
007_add_timestamps.sql           # æ™‚é–“æˆ³
007a_report_cache.sql            # å ±è¡¨å¿«å–
008_cms.sql                      # CMS
```

### Phase 3: ä»»å‹™ç®¡ç†ç³»çµ±
```bash
010_multi_stage_tasks.sql        # â­ å¤šéšæ®µä»»å‹™ï¼ˆæ ¸å¿ƒï¼‰
011_recurring_tasks.sql          # å‘¨æœŸä»»å‹™
012_add_project_category.sql    # å°ˆæ¡ˆåˆ†é¡
```

### Phase 4: å®¢æˆ¶æœå‹™è‡ªå‹•åŒ–
```bash
013_client_services_integration_è¡¥å…….sql  # å®¢æˆ¶æœå‹™æ•´åˆ
015_rebuild_client_services.sql          # â­ é‡å»ºå®¢æˆ¶æœå‹™ï¼ˆå–ä»£003ï¼‰
019_add_default_checklist_templates.sql  # 5å€‹é è¨­æ¨¡æ¿
020_migrate_old_service_schedules.sql    # è³‡æ–™é·ç§»
021_add_task_templates.sql               # 12å€‹ä»»å‹™ç¯„æœ¬
```

### Phase 5: ç³»çµ±å¢å¼·
```bash
016_enhanced_system_features.sql   # æé†’ç³»çµ±
017_expand_clients_table.sql       # â­ æ“´å±•å®¢æˆ¶è¡¨ï¼ˆå–ä»£001çš„ç°¡åŒ–ç‰ˆï¼‰
018_expand_system_parameters.sql   # æ“´å±•ç³»çµ±åƒæ•¸
```

---

## âš ï¸ é—œéµä¾è³´é—œä¿‚

### 1. çµ•å°ä¾è³´ (å¿…é ˆå…ˆåŸ·è¡Œ)

```mermaid
001 â†’ [æ‰€æœ‰å…¶ä»–é·ç§»]
    â”œâ†’ 003, 004, 005, 006, 007, 008
    â””â†’ 010 â†’ [011, 012, 013]
```

### 2. æ›¿ä»£é—œä¿‚ (æ–°ç‰ˆå–ä»£èˆŠç‰ˆ)

| èˆŠç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ | èªªæ˜ |
|--------|--------|------|
| 003 çš„ client_service_schedules | 015 çš„ client_services | âœ… 015æœƒå‚™ä»½èˆŠè¡¨ |
| 001 çš„ clients (ç°¡åŒ–) | 017 çš„ clients (å®Œæ•´) | âœ… 017æœƒé·ç§»è³‡æ–™ |

### 3. æ“´å±•é—œä¿‚ (å¢å¼·ç¾æœ‰åŠŸèƒ½)

| åŸºç¤é·ç§» | æ“´å±•é·ç§» | é—œä¿‚ |
|---------|---------|------|
| 004 | 004a | ç‚º sops è¡¨æ·»åŠ  business_type æ¬„ä½ |
| 007 | 007a | æ·»åŠ å ±è¡¨å¿«å–åŠŸèƒ½ |
| 010 | 021 | æ·»åŠ 12å€‹é è¨­ä»»å‹™ç¯„æœ¬ |
| 013 | 019 | æ·»åŠ 5å€‹é è¨­æª¢æŸ¥æ¸…å–®æ¨¡æ¿ |
| 013 | 020 | é·ç§»èˆŠæœå‹™æ’ç¨‹è³‡æ–™ |

---

## ğŸ”„ é·ç§»æ–‡ä»¶åˆ†é¡

### A. æ ¸å¿ƒåŸºç¤ (4å€‹)
```
001_complete_schema.sql          â­â­â­ æœ€é‡è¦
002_seed_data.sql               â­â­â­ æœ€é‡è¦
017_expand_clients_table.sql    â­â­ å¾ˆé‡è¦ï¼ˆæ›¿æ›001çš„clientsï¼‰
015_rebuild_client_services.sql â­â­ å¾ˆé‡è¦ï¼ˆæ›¿æ›003ï¼‰
```

### B. åŠŸèƒ½æ¨¡å¡Š (8å€‹)
```
004_sop_system.sql              # SOPçŸ¥è­˜åº«
005_media_library.sql           # åª’é«”åº«
006_project_management.sql      # å°ˆæ¡ˆç®¡ç†
008_cms.sql                     # å…§å®¹ç®¡ç†
010_multi_stage_tasks.sql       # å¤šéšæ®µä»»å‹™
011_recurring_tasks.sql         # å‘¨æœŸä»»å‹™
013_client_services_integration_è¡¥å…….sql  # å®¢æˆ¶æœå‹™
016_enhanced_system_features.sql # æé†’ç³»çµ±
```

### C. æ“´å±•å¢å¼· (6å€‹)
```
004a_sop_business_integration.sql  # SOPæ¥­å‹™æ•´åˆ
007_add_timestamps.sql            # æ™‚é–“æˆ³
007a_report_cache.sql             # å ±è¡¨å¿«å–
012_add_project_category.sql      # å°ˆæ¡ˆåˆ†é¡
018_expand_system_parameters.sql  # ç³»çµ±åƒæ•¸æ“´å±•
```

### D. é è¨­è³‡æ–™ (3å€‹)
```
002_seed_data.sql                # åŸºç¤åˆå§‹è³‡æ–™
019_add_default_checklist_templates.sql  # 5å€‹æª¢æŸ¥æ¸…å–®æ¨¡æ¿
021_add_task_templates.sql       # 12å€‹ä»»å‹™ç¯„æœ¬
020_migrate_old_service_schedules.sql    # èˆŠè³‡æ–™é·ç§»
```

---

## ğŸš¨ åŸ·è¡Œæ³¨æ„äº‹é …

### 1. å¿…é ˆæŒ‰é †åºåŸ·è¡Œ
```bash
# âŒ éŒ¯èª¤ï¼šè·³éåŸºç¤é·ç§»
npx wrangler d1 execute DB --remote --file=migrations/010_multi_stage_tasks.sql

# âœ… æ­£ç¢ºï¼šå…ˆåŸ·è¡Œ001å’Œ002
npx wrangler d1 execute DB --remote --file=migrations/001_complete_schema.sql
npx wrangler d1 execute DB --remote --file=migrations/002_seed_data.sql
npx wrangler d1 execute DB --remote --file=migrations/010_multi_stage_tasks.sql
```

### 2. é‡å»ºé·ç§»éœ€ç‰¹åˆ¥æ³¨æ„
```bash
# 015 å’Œ 017 æœƒé‡å»ºè¡¨æ ¼ï¼ŒåŸ·è¡Œå‰è«‹å‚™ä»½ï¼
npx wrangler d1 backup DB --remote  # å…ˆå‚™ä»½
npx wrangler d1 execute DB --remote --file=migrations/015_rebuild_client_services.sql
npx wrangler d1 execute DB --remote --file=migrations/017_expand_clients_table.sql
```

### 3. å­—æ¯å¾Œç¶´é·ç§»(a)
```bash
# å¿…é ˆåœ¨åŸºç¤é·ç§»ä¹‹å¾Œ
004 -> 004a
007 -> 007a
```

---

## ğŸ“‹ å¿«é€Ÿæª¢æŸ¥æ¸…å–®

### æ–°è³‡æ–™åº«å®Œæ•´è¨­ç½®
```bash
cd timesheet-api

# Phase 1: åŸºç¤
npx wrangler d1 execute DB --remote --file=migrations/001_complete_schema.sql
npx wrangler d1 execute DB --remote --file=migrations/002_seed_data.sql

# Phase 2: æ ¸å¿ƒåŠŸèƒ½
npx wrangler d1 execute DB --remote --file=migrations/003_clients_expansion.sql
npx wrangler d1 execute DB --remote --file=migrations/004_sop_system.sql
npx wrangler d1 execute DB --remote --file=migrations/004a_sop_business_integration.sql
npx wrangler d1 execute DB --remote --file=migrations/005_media_library.sql
npx wrangler d1 execute DB --remote --file=migrations/006_project_management.sql
npx wrangler d1 execute DB --remote --file=migrations/007_add_timestamps.sql
npx wrangler d1 execute DB --remote --file=migrations/007a_report_cache.sql
npx wrangler d1 execute DB --remote --file=migrations/008_cms.sql

# Phase 3: ä»»å‹™ç³»çµ±
npx wrangler d1 execute DB --remote --file=migrations/010_multi_stage_tasks.sql
npx wrangler d1 execute DB --remote --file=migrations/011_recurring_tasks.sql
npx wrangler d1 execute DB --remote --file=migrations/012_add_project_category.sql

# Phase 4: å®¢æˆ¶æœå‹™è‡ªå‹•åŒ–
npx wrangler d1 execute DB --remote --file=migrations/013_client_services_integration_è¡¥å…….sql
npx wrangler d1 execute DB --remote --file=migrations/015_rebuild_client_services.sql
npx wrangler d1 execute DB --remote --file=migrations/019_add_default_checklist_templates.sql
npx wrangler d1 execute DB --remote --file=migrations/020_migrate_old_service_schedules.sql
npx wrangler d1 execute DB --remote --file=migrations/021_add_task_templates.sql

# Phase 5: ç³»çµ±å¢å¼·
npx wrangler d1 execute DB --remote --file=migrations/016_enhanced_system_features.sql
npx wrangler d1 execute DB --remote --file=migrations/017_expand_clients_table.sql
npx wrangler d1 execute DB --remote --file=migrations/018_expand_system_parameters.sql

echo "âœ… æ‰€æœ‰é·ç§»åŸ·è¡Œå®Œæˆ"
```

### é©—è­‰é·ç§»çµæœ
```sql
-- æª¢æŸ¥è¡¨æ•¸é‡ï¼ˆæ‡‰è©²æœ‰40+å€‹è¡¨ï¼‰
SELECT COUNT(*) FROM sqlite_master WHERE type='table';

-- æª¢æŸ¥é è¨­ç¯„æœ¬ï¼ˆæ‡‰è©²æœ‰12å€‹ï¼‰
SELECT COUNT(*) FROM multi_stage_templates;

-- æª¢æŸ¥é è¨­æª¢æŸ¥æ¸…å–®ï¼ˆæ‡‰è©²æœ‰5å€‹ï¼‰
SELECT COUNT(*) FROM service_checklist_templates;

-- æª¢æŸ¥clientsè¡¨çµæ§‹ï¼ˆæ‡‰è©²æœ‰å®Œæ•´æ¬„ä½ï¼‰
PRAGMA table_info(clients);
```

---

## ğŸ¯ é·ç§»ç­–ç•¥å»ºè­°

### æ–°å°ˆæ¡ˆ
âœ… æŒ‰ç…§ä¸Šè¿°é †åºåŸ·è¡Œæ‰€æœ‰21å€‹é·ç§»æ–‡ä»¶

### ç¾æœ‰å°ˆæ¡ˆå‡ç´š
1. âœ… å…ˆå‚™ä»½ç•¶å‰è³‡æ–™åº«
2. âœ… æª¢æŸ¥å·²åŸ·è¡Œçš„é·ç§»ï¼ˆå‰µå»ºé·ç§»è¨˜éŒ„è¡¨ï¼‰
3. âœ… åªåŸ·è¡Œç¼ºå°‘çš„é·ç§»æ–‡ä»¶
4. âš ï¸ ç‰¹åˆ¥æ³¨æ„015å’Œ017ï¼ˆæœƒé‡å»ºè¡¨ï¼‰

### é–‹ç™¼ç’°å¢ƒæ¸¬è©¦
```bash
# ä½¿ç”¨æœ¬åœ°è³‡æ–™åº«æ¸¬è©¦
npx wrangler d1 execute DB --local --file=migrations/XXX.sql

# é©—è­‰ç„¡èª¤å¾Œå†éƒ¨ç½²åˆ°é ç«¯
npx wrangler d1 execute DB --remote --file=migrations/XXX.sql
```

---

## ğŸ“ ç‰ˆæœ¬æ­·å²

| æ—¥æœŸ | ç‰ˆæœ¬ | èªªæ˜ |
|------|------|------|
| 2025-10-26 | 1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´é·ç§»ä¾è³´é—œä¿‚åœ– |

---

**æç¤º**: æ­¤æ–‡æª”èˆ‡ `è³‡æ–™è¡¨ç‰ˆæœ¬èªªæ˜.md` é…åˆä½¿ç”¨ï¼Œå¯å®Œæ•´äº†è§£ç³»çµ±çš„è³‡æ–™åº«æ¶æ§‹æ¼”é€²ã€‚

