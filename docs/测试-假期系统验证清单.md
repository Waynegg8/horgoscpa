# 假期系统验证清单

测试日期：2025-11-01
测试人员：_________

## 一、基础功能验证

### 1. 页面载入
- [ ] 假期页面正常载入（无 500 错误）
- [ ] 工时表页面可以读取假期数据
- [ ] 余额总览正常显示

### 2. 余额显示验证
- [ ] **事假**：显示"剩餘 X / 額度 14 天"（即使未使用过也显示）
- [ ] **病假**：显示"剩餘 X / 額度 30 天"
- [ ] **补休**：显示"當月剩餘 X 小時 / 次月轉加班費"
- [ ] **特休**：显示"剩餘 X / 額度 Y 天"（依年资）
- [ ] 无重复的假期类型（例如只显示一个"补休"）

---

## 二、申请假期流程验证

### 3. 假期申请表单
- [ ] 点击"申请假期"按钮，对话框正常打开
- [ ] 所有输入框高度统一（44px）
- [ ] 假别下拉选单正常显示

### 4. 性别过滤验证
**测试用户性别：** [ ] 男性  [ ] 女性

#### 女性员工应该看到：
- [ ] 特休、病假、事假、补休、生理假、公假
- [ ] **不应该看到**：陪产检及陪产假

#### 男性员工应该看到：
- [ ] 特休、病假、事假、补休、公假
- [ ] **不应该看到**：生理假

#### 生活事件相关假别（默认隐藏）：
- [ ] 产假、产检假、婚假、丧假 **默认不显示**
- [ ] 只有登记相关生活事件后才会出现

### 5. 时间选择验证
- [ ] 开始时间下拉选单显示：08:30, 09:00, 09:30, 10:00, 10:30, 11:00, 11:30, 12:00, 12:30, 13:30, 14:00, 14:30, 15:00, 15:30, 16:00, 16:30, 17:00, 17:30
- [ ] 结束时间下拉选单显示相同时间选项
- [ ] **不包含** 12:31-13:29（午休时间）

### 6. 时数自动计算验证
测试以下场景，验证"请假时数"自动计算是否正确：

| 开始时间 | 结束时间 | 预期时数 | 实际时数 | 结果 |
|---------|---------|---------|---------|------|
| 09:00   | 10:00   | 1 小时   |         | [ ]  |
| 09:00   | 09:30   | 0.5 小时 |         | [ ]  |
| 10:30   | 12:00   | 1.5 小时 |         | [ ]  |
| 10:00   | 14:00   | 3 小时（扣午休）|    | [ ]  |
| 09:00   | 17:30   | 7.5 小时（扣午休）|  | [ ]  |
| 08:30   | 12:30   | 4 小时   |         | [ ]  |
| 13:30   | 17:30   | 4 小时   |         | [ ]  |
| 11:30   | 14:30   | 2 小时（扣午休）|    | [ ]  |

**午休扣除逻辑**：
- [ ] 跨越 12:30-13:30 的请假会自动扣除 1 小时
- [ ] 不跨越午休的请假不扣除

### 7. 申请提交验证
- [ ] 未填写必填字段时显示错误提示
- [ ] 提交成功后显示"申請成功"
- [ ] 申请记录出现在"我的申请"列表中
- [ ] **没有"状态"和"原因"栏位**（已移除）
- [ ] "日期与时间"栏位格式：`2025-11-03 10:00-12:00`

### 8. 余额检查验证
- [ ] 请假时数超过余额时，显示确认对话框
- [ ] 对话框提示："您的餘額不足，確定要繼續申請嗎？"
- [ ] 点击"取消"可以中止申请
- [ ] 点击"确定"仍然可以提交（系统允许负余额）

---

## 三、生活事件登记验证

### 9. 生活事件登记表单
- [ ] 点击"登记生活事件"按钮，对话框正常打开
- [ ] 所有输入框高度统一（44px）
- [ ] 备注 textarea 高度为 80px，可以垂直调整大小

### 10. 事件类型性别过滤

**测试用户性别：** [ ] 男性  [ ] 女性

#### 女性员工应该看到：
- [ ] 结婚
- [ ] 父母/养父母/继父母/配偶丧亡
- [ ] 祖父母/子女/配偶之父母丧亡
- [ ] 曾祖父母/兄弟姊妹/配偶之祖父母丧亡
- [ ] 分娩
- [ ] 妊娠3个月以上流产
- [ ] 妊娠
- [ ] **不应该看到**：配偶分娩或怀孕

#### 男性员工应该看到：
- [ ] 结婚
- [ ] 所有丧假类型
- [ ] 配偶分娩或怀孕
- [ ] **不应该看到**：分娩、流产、妊娠

### 11. 生活事件登记与假期授予

测试登记以下事件，验证假期是否正确授予：

| 事件类型 | 授予假别 | 应授予天数 | 有效期 | 实际结果 |
|---------|---------|----------|--------|---------|
| 结婚 | 婚假 | 8天 | 365天 | [ ] |
| 父母丧亡 | 丧假 | 8天 | 365天 | [ ] |
| 祖父母丧亡 | 丧假 | 6天 | 365天 | [ ] |
| 兄弟姊妹丧亡 | 丧假 | 3天 | 365天 | [ ] |
| 分娩（女） | 产假 | 56天 | 180天 | [ ] |
| 流产（女） | 产假 | 28天 | 180天 | [ ] |
| 妊娠（女） | 产检假 | 7天 | 365天 | [ ] |
| 配偶分娩（男） | 陪产检及陪产假 | 7天 | 60天 | [ ] |

### 12. 生活事件登记后验证
- [ ] 登记成功后，余额总览中出现新的假期类型
- [ ] 申请假期时，对应的假别出现在下拉选单中
- [ ] 假期余额显示正确的天数

---

## 四、补休逻辑验证

### 13. 补休余额计算
- [ ] 补休余额只从 `CompensatoryLeaveGrants` 表计算
- [ ] `LeaveBalances` 表中**没有** `comp` 类型记录
- [ ] 余额显示格式："當月剩餘 X 小時 / 次月轉加班費"

### 14. 补休使用（FIFO）
**前置条件**：员工有多笔补休记录

- [ ] 申请补休时，优先使用最早产生的补休
- [ ] 扣减后，`CompensatoryLeaveGrants` 表的 `hours_used` 和 `hours_remaining` 正确更新
- [ ] 当某笔补休用完时，状态变更为 `fully_used`

### 15. 补休到期转加班费
**测试方法**：手动触发或等待月底自动执行

- [ ] 上月底到期的补休自动转为加班费
- [ ] `CompensatoryLeaveGrants` 状态变更为 `expired`
- [ ] `CompensatoryOvertimePay` 表新增记录
- [ ] 加班费金额 = 剩余小时数 × 时薪 × 倍率

---

## 五、管理员功能验证

### 16. 员工选择器
**测试账号：** 管理员账号

- [ ] 页面顶部显示"选择员工"下拉选单
- [ ] 下拉选单列出所有员工
- [ ] 选择员工后，余额总览和申请列表更新为该员工的数据

### 17. 非管理员验证
**测试账号：** 一般员工账号

- [ ] 页面顶部**不显示**"选择员工"下拉选单
- [ ] 只能查看自己的假期余额和申请记录

---

## 六、自动初始化验证

### 18. 新用户假期余额
**测试方法**：创建新用户或查看未使用过假期的员工

- [ ] 新用户自动拥有病假余额（30天）
- [ ] 新用户自动拥有事假余额（14天）
- [ ] 即使从未使用过，余额总览也会显示

---

## 七、数据一致性验证

### 19. 数据库验证
使用 D1 Console 或 Wrangler 命令验证：

```sql
-- 检查是否有重复的 comp 记录
SELECT * FROM LeaveBalances WHERE leave_type = 'comp';
-- 应该返回空结果

-- 检查所有用户是否都有病假和事假
SELECT user_id, leave_type, total, remain 
FROM LeaveBalances 
WHERE leave_type IN ('sick', 'personal')
ORDER BY user_id, leave_type;

-- 检查补休记录
SELECT * FROM CompensatoryLeaveGrants 
WHERE status = 'active' AND hours_remaining > 0;

-- 检查生活事件授予
SELECT * FROM LifeEventLeaveGrants WHERE status = 'active';
```

验证结果：
- [ ] `LeaveBalances` 中无 `comp` 记录
- [ ] 所有用户都有 `sick` 和 `personal` 记录
- [ ] 补休记录计算正确
- [ ] 生活事件授予记录完整

---

## 八、边界情况测试

### 20. 异常场景
- [ ] 申请假期时数为 0（应该显示错误）
- [ ] 申请假期时数不是 0.5 的倍数（应该显示错误）
- [ ] 结束时间早于开始时间（应该显示错误或计算为 0）
- [ ] 选择的时间不在工作时间内（前端应该不显示此选项）
- [ ] 余额为负数时仍然可以申请（允许）
- [ ] 未登记生活事件就尝试申请相关假别（下拉选单中不显示）

---

## 九、UI/UX 验证

### 21. 界面一致性
- [ ] 所有 input 框高度一致（44px）
- [ ] 所有 select 框高度一致（44px）
- [ ] 日期选择器高度与其他输入框一致（44px）
- [ ] textarea 高度为 80px，可以垂直调整
- [ ] 表单布局整齐，标签对齐
- [ ] 所有元素在桌面和移动设备上显示正常

### 22. 错误提示
- [ ] 必填字段未填写时显示红色错误提示
- [ ] 错误提示文字清晰易懂
- [ ] 提交成功后显示成功消息

---

## 十、性能与安全验证

### 23. API 响应
- [ ] 所有 API 请求返回正确的状态码（200, 201, 400, 422, 500）
- [ ] 无 CORS 错误
- [ ] 未登录用户访问会重定向到登录页

### 24. 数据验证
- [ ] 前端和后端都有输入验证
- [ ] SQL 注入防护（使用参数化查询）
- [ ] XSS 防护（用户输入正确转义）

---

## 测试总结

### 发现的问题
1. 
2. 
3. 

### 需要修复的项目
- [ ] 
- [ ] 
- [ ] 

### 验证结论
- [ ] ✅ 所有功能正常，可以发布
- [ ] ⚠️ 有轻微问题，但不影响使用
- [ ] ❌ 有严重问题，需要修复后重新验证

---

## 附录：测试数据

### 测试账号
- 管理员：`___________`
- 女性员工：`___________`
- 男性员工：`___________`

### 测试日期
- 测试日期：2025-11-01
- 系统当前年度：2025

### 环境信息
- 浏览器：___________
- 操作系统：___________
- 网络环境：___________

