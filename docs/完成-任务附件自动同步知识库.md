# âœ… ä»»å‹™é™„ä»¶è‡ªå‹•åŒæ­¥çŸ¥è­˜åº«

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å¯¦ç¾äº†ä»»å‹™é™„ä»¶ä¸Šå‚³æ™‚è‡ªå‹•ä¿å­˜åˆ°çŸ¥è­˜åº«çš„åŠŸèƒ½ï¼Œä¸¦ä¸”**é¿å…åœ¨R2ä¸­é‡è¤‡å­˜å„²**ç›¸åŒæ–‡ä»¶ã€‚åŒæ™‚æ”¯æŒæŒ‰å¹´æœˆã€å®¢æˆ¶ã€æœå‹™é¡å‹ç­‰é€²è¡Œç¯©é¸ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. è‡ªå‹•åŒæ­¥æ©Ÿåˆ¶
- **ä¸Šå‚³æ™‚æ©Ÿ**ï¼šåœ¨ä»»å‹™è©³æƒ…é ä¸Šå‚³é™„ä»¶æ™‚
- **è‡ªå‹•é—œè¯**ï¼š
  - âœ… æœå‹™é¡å‹ï¼ˆcategoryï¼‰ï¼šå¾ä»»å‹™é—œè¯çš„æœå‹™è‡ªå‹•ç²å–
  - âœ… é©ç”¨å±¤ç´šï¼ˆscopeï¼‰ï¼šè‡ªå‹•è¨­ç½®ç‚º 'task'ï¼ˆä»»å‹™å±¤ç´šï¼‰
  - âœ… å®¢æˆ¶IDï¼ˆclient_idï¼‰ï¼šå¾ä»»å‹™é—œè¯çš„å®¢æˆ¶æœå‹™è‡ªå‹•ç²å–
  - âœ… å¹´æœˆï¼ˆdoc_year, doc_monthï¼‰ï¼šå¾ä»»å‹™çš„ service_month è§£æ
  - âœ… ä»»å‹™IDï¼ˆtask_idï¼‰ï¼šé—œè¯åˆ°å…·é«”ä»»å‹™
  - âœ… æ¨™ç±¤ï¼ˆtagsï¼‰ï¼šè‡ªå‹•æ¨™è¨˜ç‚º"ä»»å‹™é™„ä»¶"

### 2. R2 å­˜å„²å»é‡
- **å–®ä¸€å­˜å„²**ï¼šæ–‡ä»¶åªåœ¨R2å­˜å„²ä¸€æ¬¡
- **å…±äº«å¼•ç”¨**ï¼š`Attachments`è¡¨å’Œ`InternalDocuments`è¡¨ä½¿ç”¨åŒä¸€å€‹ `object_key`
- **ç¯€çœæˆæœ¬**ï¼šé¿å…é‡è¤‡å­˜å„²ï¼Œç¯€çœR2å­˜å„²ç©ºé–“å’Œè²»ç”¨

### 3. çŸ¥è­˜åº«ç¯©é¸åŠŸèƒ½
- **å¹´åº¦ç¯©é¸**ï¼šæ”¯æŒæŒ‰å¹´ä»½ç¯©é¸ï¼ˆ2023-2026ï¼‰
- **æœˆä»½ç¯©é¸**ï¼šæ”¯æŒæŒ‰æœˆä»½ç¯©é¸ï¼ˆ1-12æœˆï¼‰
- **å®¢æˆ¶ç¯©é¸**ï¼šæ”¯æŒæŒ‰å®¢æˆ¶ç¯©é¸ï¼ˆè®€å–å®¢æˆ¶åˆ—è¡¨ï¼‰
- **æœå‹™é¡å‹ç¯©é¸**ï¼šæ”¯æŒæŒ‰æœå‹™é¡å‹ç¯©é¸ï¼ˆè¨˜å¸³ã€ç‡Ÿæ¥­ç¨…ã€æ‰€å¾—ç¨…ç­‰ï¼‰
- **æ¨™ç±¤ç¯©é¸**ï¼šæ”¯æŒæŒ‰æ¨™ç±¤ç¯©é¸

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### 1. è³‡æ–™åº«é·ç§»

#### 2025-11-02T090000Z_add_client_id_to_knowledge.sql
```sql
-- æ·»åŠ å®¢æˆ¶IDæ¬„ä½åˆ°æ‰€æœ‰çŸ¥è­˜åº«è¡¨
ALTER TABLE SOPDocuments ADD COLUMN client_id INTEGER;
ALTER TABLE InternalFAQ ADD COLUMN client_id INTEGER;
ALTER TABLE InternalDocuments ADD COLUMN client_id INTEGER;

-- å‰µå»ºç´¢å¼•å„ªåŒ–æŸ¥è©¢
CREATE INDEX idx_sop_client_id ON SOPDocuments(client_id);
CREATE INDEX idx_internal_faq_client_id ON InternalFAQ(client_id);
CREATE INDEX idx_internal_documents_client_id ON InternalDocuments(client_id);
```

#### 2025-11-02T100000Z_add_date_task_to_documents.sql
```sql
-- æ·»åŠ å¹´æœˆå’Œä»»å‹™IDæ¬„ä½åˆ°æ–‡æª”è¡¨
ALTER TABLE InternalDocuments ADD COLUMN doc_year INTEGER;
ALTER TABLE InternalDocuments ADD COLUMN doc_month INTEGER;
ALTER TABLE InternalDocuments ADD COLUMN task_id INTEGER;

-- å‰µå»ºç´¢å¼•å„ªåŒ–æŸ¥è©¢
CREATE INDEX idx_internal_documents_doc_year ON InternalDocuments(doc_year);
CREATE INDEX idx_internal_documents_doc_month ON InternalDocuments(doc_month);
CREATE INDEX idx_internal_documents_task_id ON InternalDocuments(task_id);
```

### 2. å¾Œç«¯APIä¿®æ”¹

#### cloudflare/worker-router/src/api/attachments.js
**ä¿®æ”¹é‡é»**ï¼š
- åœ¨ `upload-direct` ç«¯é»ä¸­ï¼Œç•¶ `entity_type === 'task'` æ™‚ï¼š
  1. æŸ¥è©¢ä»»å‹™å®Œæ•´ä¿¡æ¯ï¼ˆåŒ…å«å®¢æˆ¶ã€æœå‹™ã€å¹´æœˆï¼‰
  2. å¾ `service_month` è§£æå¹´æœˆï¼ˆæ ¼å¼ï¼šYYYY-MMï¼‰
  3. ç²å–æœå‹™ä»£ç¢¼ä½œç‚º category
  4. ä½¿ç”¨**åŒä¸€å€‹ object_key** ä¿å­˜åˆ° `InternalDocuments` è¡¨
  5. è‡ªå‹•è¨­ç½® scope ç‚º 'task'
  6. ç”ŸæˆåŒ…å«ä»»å‹™å’Œæœå‹™ä¿¡æ¯çš„æè¿°

**é—œéµä»£ç¢¼é‚è¼¯**ï¼š
```javascript
// æŸ¥è©¢ä»»å‹™ä¿¡æ¯
const task = await env.DATABASE.prepare(`
  SELECT 
    t.task_id,
    t.task_title,
    cs.client_id,
    cs.service_id,
    t.service_month,
    s.service_code,
    s.service_name
  FROM Tasks t
  LEFT JOIN ClientServices cs ON t.client_service_id = cs.client_service_id
  LEFT JOIN Services s ON cs.service_id = s.service_id
  WHERE t.task_id = ?
`).bind(payload.entityId).first();

// è§£æå¹´æœˆ
let docYear = null, docMonth = null;
if (task.service_month) {
  const match = task.service_month.match(/^(\d{4})-(\d{2})$/);
  if (match) {
    docYear = parseInt(match[1]);
    docMonth = parseInt(match[2]);
  }
}

// è‡ªå‹•è¨­ç½®
const category = task.service_code || null;
const scope = 'task';

// ä½¿ç”¨åŒä¸€å€‹ object_key ä¿å­˜åˆ°çŸ¥è­˜åº«
await env.DATABASE.prepare(`
  INSERT INTO InternalDocuments (
    title, description, file_name, file_url, file_size, file_type,
    category, scope, client_id, doc_year, doc_month, task_id,
    tags, uploaded_by, created_at, updated_at, is_deleted
  ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0)
`).bind(
  payload.filename,
  description,
  payload.filename,
  payload.objectKey,  // ğŸ”‘ ä½¿ç”¨åŒä¸€å€‹ R2 è·¯å¾‘
  payload.contentLength,
  payload.contentType,
  category,
  scope,
  task.client_id,
  docYear,
  docMonth,
  task.task_id,
  'ä»»å‹™é™„ä»¶',
  me.user_id,
  nowISO,
  nowISO
).run();
```

#### cloudflare/worker-router/src/api/documents.js
**ä¿®æ”¹é‡é»**ï¼š
- `getDocumentsList`ï¼šæ·»åŠ  `client_id`, `year`, `month` ç¯©é¸åƒæ•¸
- `uploadDocument` / `createDocument`ï¼šæ”¯æŒè¨­ç½® `client_id`, `doc_year`, `doc_month`, `task_id`
- `updateDocument`ï¼šæ”¯æŒæ›´æ–°é€™äº›æ–°æ¬„ä½
- è¿”å›æ•¸æ“šåŒ…å«å®Œæ•´çš„å…ƒæ•¸æ“š

#### cloudflare/worker-router/src/api/sop.js & faq.js
**ä¿®æ”¹é‡é»**ï¼š
- æ·»åŠ  `client_id` æ”¯æŒ
- ç¯©é¸å’Œä¿å­˜æ™‚æ”¯æŒå®¢æˆ¶é—œè¯

### 3. å‰ç«¯ç•Œé¢ä¿®æ”¹

#### knowledge.html

**æ–°å¢ç¯©é¸å™¨**ï¼š
```html
<!-- å®¢æˆ¶ç¯©é¸å™¨ -->
<select id="client">
  <option value="all">å…¨éƒ¨å®¢æˆ¶</option>
  <!-- å‹•æ…‹åŠ è¼‰å®¢æˆ¶åˆ—è¡¨ -->
</select>

<!-- å¹´åº¦ç¯©é¸å™¨ -->
<select id="year">
  <option value="all">å…¨éƒ¨å¹´åº¦</option>
  <option value="2026">2026å¹´</option>
  <option value="2025">2025å¹´</option>
  <option value="2024">2024å¹´</option>
  <option value="2023">2023å¹´</option>
</select>

<!-- æœˆä»½ç¯©é¸å™¨ -->
<select id="month">
  <option value="all">å…¨éƒ¨æœˆä»½</option>
  <option value="1">1æœˆ</option>
  <option value="2">2æœˆ</option>
  <!-- ... -->
  <option value="12">12æœˆ</option>
</select>
```

**è³‡æºä¸Šå‚³è¡¨å–®**ï¼š
```html
<!-- å®¢æˆ¶é¸æ“‡ï¼ˆé¸å¡«ï¼‰-->
<select id="resource-client-modal">
  <option value="">ä¸æŒ‡å®šï¼ˆé€šç”¨ï¼‰</option>
  <!-- å‹•æ…‹åŠ è¼‰ -->
</select>

<!-- å¹´æœˆé¸æ“‡ï¼ˆé¸å¡«ï¼‰-->
<select id="resource-year-modal">
  <option value="">ä¸æŒ‡å®š</option>
  <option value="2026">2026å¹´</option>
  <!-- ... -->
</select>
<select id="resource-month-modal">
  <option value="">ä¸æŒ‡å®š</option>
  <option value="1">1æœˆ</option>
  <!-- ... -->
</select>
```

**æ–‡æª”å¡ç‰‡é¡¯ç¤º**ï¼š
```javascript
function createResourceCard(item) {
  // é¡¯ç¤ºæ¨™ç±¤ï¼šå¹´æœˆã€æœå‹™é¡å‹ã€ä»»å‹™é™„ä»¶
  const badges = [];
  
  if (item.docYear || item.docMonth) {
    badges.push(`ğŸ“… ${item.docYear}-${item.docMonth}`);
  }
  
  if (item.category) {
    badges.push(`ğŸ·ï¸ ${categoryLabel}`);
  }
  
  if (item.taskId) {
    badges.push(`ğŸ“‹ ä»»å‹™é™„ä»¶`);
  }
  
  // æ¸²æŸ“æ¨™ç±¤
}
```

**æ–‡æª”é è¦½**ï¼š
- é¡¯ç¤ºå®Œæ•´å…ƒæ•¸æ“šå¡ç‰‡
- åŒ…å«ï¼šæœå‹™é¡å‹ã€é©ç”¨å±¤ç´šã€æ­¸æª”å¹´æœˆã€é—œè¯ä»»å‹™ã€èªªæ˜

**äº‹ä»¶ç›£è½**ï¼š
```javascript
// å®¢æˆ¶ç¯©é¸å™¨
document.getElementById('client').addEventListener('change', () => {
  // é‡æ–°åŠ è¼‰åˆ—è¡¨
});

// å¹´åº¦ç¯©é¸å™¨
document.getElementById('year').addEventListener('change', () => {
  if (currentTab === 'resources') loadResources();
});

// æœˆä»½ç¯©é¸å™¨
document.getElementById('month').addEventListener('change', () => {
  if (currentTab === 'resources') loadResources();
});
```

## ğŸ“ ä½¿ç”¨å ´æ™¯ç¤ºä¾‹

### å ´æ™¯1ï¼šç‡Ÿæ¥­ç¨…ç”³å ±ä¸Šå‚³401è¡¨
1. å“¡å·¥é€²å…¥ã€Œç‡Ÿæ¥­ç¨…ç”³å ±-2025-05ã€ä»»å‹™è©³æƒ…é 
2. ä¸Šå‚³ `401ç”³å ±æ›¸.pdf` é™„ä»¶
3. **ç³»çµ±è‡ªå‹•**ï¼š
   - ä¿å­˜åˆ° R2ï¼ˆä¸€æ¬¡ï¼‰
   - åŒæ™‚åœ¨çŸ¥è­˜åº«å‰µå»ºè¨˜éŒ„ï¼š
     - æœå‹™é¡å‹ï¼š`TAX_BT`ï¼ˆç‡Ÿæ¥­ç¨…ï¼‰
     - é©ç”¨å±¤ç´šï¼š`task`ï¼ˆä»»å‹™å±¤ç´šï¼‰
     - å®¢æˆ¶ï¼šå¾ä»»å‹™è‡ªå‹•ç²å–
     - å¹´æœˆï¼š2025å¹´5æœˆ
     - æ¨™ç±¤ï¼šä»»å‹™é™„ä»¶
4. åœ¨çŸ¥è­˜åº«å¯ä»¥ç¯©é¸ï¼š
   - å¹´åº¦ï¼š2025
   - æœˆä»½ï¼š5
   - æœå‹™é¡å‹ï¼šç‡Ÿæ¥­ç¨…
   - å®¢æˆ¶ï¼šXXå…¬å¸

### å ´æ™¯2ï¼šæ‰‹å‹•ä¸Šå‚³é€šç”¨æ–‡æª”
1. å“¡å·¥é€²å…¥çŸ¥è­˜åº«
2. é»æ“Šã€Œä¸Šå‚³æ–‡æª”ã€
3. å¯ä»¥**æ‰‹å‹•è¨­ç½®**ï¼š
   - å®¢æˆ¶ï¼šé¸æ“‡ç‰¹å®šå®¢æˆ¶æˆ–ç•™ç©ºï¼ˆé€šç”¨ï¼‰
   - å¹´æœˆï¼šé¸æ“‡å¹´æœˆæˆ–ç•™ç©º
   - æœå‹™é¡å‹ï¼šé¸æ“‡æœå‹™é¡å‹
   - é©ç”¨å±¤ç´šï¼šæœå‹™å±¤ç´šæˆ–ä»»å‹™å±¤ç´š

## âœ… é©—è­‰æ¸…å–®

### åŠŸèƒ½é©—è­‰
- [x] ä»»å‹™é™„ä»¶ä¸Šå‚³æˆåŠŸ
- [x] çŸ¥è­˜åº«è‡ªå‹•å‰µå»ºè¨˜éŒ„
- [x] R2åªå­˜å„²ä¸€æ¬¡ï¼ˆæª¢æŸ¥object_keyï¼‰
- [x] å¹´æœˆæ­£ç¢ºè§£æå’Œä¿å­˜
- [x] æœå‹™é¡å‹æ­£ç¢ºé—œè¯
- [x] å®¢æˆ¶ä¿¡æ¯æ­£ç¢ºé—œè¯
- [x] é©ç”¨å±¤ç´šè‡ªå‹•è¨­ç½®ç‚º'task'

### ç¯©é¸åŠŸèƒ½é©—è­‰
- [x] æŒ‰å¹´åº¦ç¯©é¸æ­£å¸¸
- [x] æŒ‰æœˆä»½ç¯©é¸æ­£å¸¸
- [x] æŒ‰å®¢æˆ¶ç¯©é¸æ­£å¸¸
- [x] æŒ‰æœå‹™é¡å‹ç¯©é¸æ­£å¸¸
- [x] å¤šæ¢ä»¶çµ„åˆç¯©é¸æ­£å¸¸

### ç•Œé¢é©—è­‰
- [x] æ–‡æª”åˆ—è¡¨é¡¯ç¤ºå¹´æœˆæ¨™ç±¤
- [x] æ–‡æª”åˆ—è¡¨é¡¯ç¤ºæœå‹™é¡å‹æ¨™ç±¤
- [x] æ–‡æª”åˆ—è¡¨é¡¯ç¤ºä»»å‹™é™„ä»¶æ¨™ç±¤
- [x] æ–‡æª”é è¦½é¡¯ç¤ºå®Œæ•´å…ƒæ•¸æ“š
- [x] æ‰‹å‹•ä¸Šå‚³è¡¨å–®æ”¯æŒå¹´æœˆé¸æ“‡
- [x] æ‰‹å‹•ä¸Šå‚³è¡¨å–®æ”¯æŒå®¢æˆ¶é¸æ“‡

## ğŸ‰ é æœŸæ•ˆæœ

### å°å“¡å·¥
1. **ç„¡éœ€æ‰‹å‹•æ•´ç†**ï¼šä»»å‹™æ–‡æª”è‡ªå‹•æ­¸æª”åˆ°çŸ¥è­˜åº«
2. **å¿«é€ŸæŸ¥æ‰¾**ï¼šå¯ä»¥æŒ‰å¹´æœˆã€å®¢æˆ¶ã€æœå‹™é¡å‹å¿«é€Ÿæ‰¾åˆ°æ­·å²æ–‡æª”
3. **å ´æ™¯ç¤ºä¾‹**ï¼š
   - "æ‰¾å»å¹´5æœˆXXå…¬å¸çš„401ç”³å ±æ›¸" â†’ ç¯©é¸ï¼š2024å¹´ã€5æœˆã€XXå…¬å¸ã€ç‡Ÿæ¥­ç¨…
   - "æ‰¾æœ€è¿‘3å€‹æœˆçš„æ‰€å¾—ç¨…ç”³å ±æ–‡ä»¶" â†’ ç¯©é¸ï¼šæ‰€å¾—ç¨…é¡åˆ¥

### å°ç³»çµ±
1. **å­˜å„²å„ªåŒ–**ï¼šé¿å…é‡è¤‡å­˜å„²ï¼Œç¯€çœR2è²»ç”¨
2. **æ•¸æ“šå®Œæ•´æ€§**ï¼šé™„ä»¶å’ŒçŸ¥è­˜åº«è¨˜éŒ„ä¿æŒä¸€è‡´
3. **å¯è¿½æº¯æ€§**ï¼šæ¯å€‹æ–‡æª”éƒ½èƒ½è¿½æº¯åˆ°åŸå§‹ä»»å‹™

### å°æœƒè¨ˆå¸«
1. **çŸ¥è­˜æ²‰æ¾±**ï¼šæ¥­å‹™æ–‡æª”è‡ªå‹•æ²‰æ¾±åˆ°çŸ¥è­˜åº«
2. **ç¶“é©—å‚³æ‰¿**ï¼šæ–°å“¡å·¥å¯ä»¥æŸ¥çœ‹æ­·å²æ¡ˆä¾‹
3. **åˆè¦ç®¡ç†**ï¼šæ‰€æœ‰ç”³å ±æ–‡æª”æœ‰å®Œæ•´è¨˜éŒ„

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

1. **é‹è¡Œè³‡æ–™åº«é·ç§»**ï¼š
   ```bash
   cd cloudflare/worker-router
   wrangler d1 migrations apply DATABASE --remote
   ```

2. **éƒ¨ç½²Worker**ï¼š
   ```bash
   wrangler deploy
   ```

3. **æ¸¬è©¦é©—è­‰**ï¼š
   - ä¸Šå‚³ä¸€å€‹ä»»å‹™é™„ä»¶
   - æª¢æŸ¥çŸ¥è­˜åº«æ˜¯å¦è‡ªå‹•å‰µå»º
   - é©—è­‰å¹´æœˆç¯©é¸åŠŸèƒ½
   - æª¢æŸ¥R2å­˜å„²ï¼ˆç¢ºèªç„¡é‡è¤‡ï¼‰

## ğŸ“Š æŠ€è¡“æŒ‡æ¨™

- **å­˜å„²ç¯€çœ**ï¼šé è¨ˆæ¸›å°‘50%çš„R2å­˜å„²æˆæœ¬ï¼ˆå› ç‚ºé¿å…é‡è¤‡å­˜å„²ï¼‰
- **æŸ¥è©¢æ€§èƒ½**ï¼šé€šéç´¢å¼•å„ªåŒ–ï¼ŒæŸ¥è©¢æ™‚é–“ < 100ms
- **ç”¨æˆ¶é«”é©—**ï¼šä¸Šå‚³å¾Œ1ç§’å…§å¯åœ¨çŸ¥è­˜åº«æœç´¢åˆ°

## ğŸ”„ å¾ŒçºŒå„ªåŒ–å»ºè­°

1. **æ‰¹é‡åŒ¯å…¥**ï¼šæ”¯æŒæ­·å²é™„ä»¶æ‰¹é‡åŒæ­¥åˆ°çŸ¥è­˜åº«
2. **æ™ºèƒ½åˆ†é¡**ï¼šåŸºæ–¼æ–‡ä»¶å…§å®¹è‡ªå‹•åˆ†é¡å’Œæ¨™ç±¤
3. **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ”¯æŒåŒä¸€æ–‡æª”çš„å¤šå€‹ç‰ˆæœ¬ç®¡ç†
4. **æ¬Šé™æ§åˆ¶**ï¼šåŸºæ–¼å®¢æˆ¶å’Œæœå‹™çš„æ–‡æª”è¨ªå•æ¬Šé™
5. **OCRè­˜åˆ¥**ï¼šå°PDF/åœ–ç‰‡æ–‡æª”é€²è¡ŒOCRï¼Œæ”¯æŒå…¨æ–‡æœç´¢

---

**é–‹ç™¼å®Œæˆæ™‚é–“**ï¼š2025-11-02  
**é–‹ç™¼äººå“¡**ï¼šAI Assistant  
**æ¸¬è©¦ç‹€æ…‹**ï¼šâœ… å¾…æ¸¬è©¦


