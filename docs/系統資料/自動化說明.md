# è‡ªå‹•åŒ–èªªæ˜

**ç³»çµ±è‡ªå‹•åŸ·è¡Œçš„ä»»å‹™**

---

## â° å®šæ™‚ä»»å‹™ï¼ˆCron Jobsï¼‰

### 1. ä»»å‹™è‡ªå‹•ç”Ÿæˆ
**åŸ·è¡Œæ™‚é–“ï¼š** æ¯æœˆ 1 æ—¥ 00:00

**åŠŸèƒ½ï¼š**
```
1. æŸ¥è©¢æ‰€æœ‰å®¢æˆ¶æœå‹™ï¼ˆClientServicesï¼‰
2. æª¢æŸ¥ trigger_months æ˜¯å¦åŒ…å«ç•¶å‰æœˆä»½
3. æ ¹æ“šä»»å‹™æ¨¡æ¿è‡ªå‹•ç”Ÿæˆä»»å‹™
4. è¨­å®šåˆ°æœŸæ—¥æœŸ
5. åˆ†é…çµ¦è² è²¬å“¡å·¥
```

---

### 2. é€¾æœŸä»»å‹™æª¢æ¸¬
**åŸ·è¡Œæ™‚é–“ï¼š** æ¯å¤© 09:00

**åŠŸèƒ½ï¼š**
```
1. æŸ¥è©¢æ‰€æœ‰æœªå®Œæˆçš„ä»»å‹™
2. æª¢æŸ¥ due_date æ˜¯å¦å·²é
3. æ¨™è¨˜ç‚ºé€¾æœŸ
4. ï¼ˆå¯é¸ï¼‰ç™¼é€æé†’é€šçŸ¥
```

---

### 3. ç‰¹ä¼‘å¹´åˆæ›´æ–°ï¼ˆç´¯ç©åˆ¶ï¼‰
**åŸ·è¡Œæ™‚é–“ï¼š** æ¯å¹´ 1æœˆ1æ—¥ 00:00  
**Cronè¡¨é”å¼ï¼š** `0 0 1 1 *`

**åŠŸèƒ½ï¼š**
```
1. è¨ˆç®—æ¯ä½å“¡å·¥ä»Šå¹´æ‡‰å¾—ç‰¹ä¼‘ï¼ˆä¾å¹´è³‡ï¼‰
2. ç´¯ç©å»å¹´å‰©é¤˜ç‰¹ä¼‘ï¼ˆä¸æ­¸é›¶ï¼‰â­
3. å‰µå»ºä»Šå¹´åº¦ç‰¹ä¼‘é¤˜é¡è¨˜éŒ„
4. è¨˜éŒ„åŸ·è¡Œç‹€æ…‹åˆ° CronJobExecutions è¡¨
5. å¦‚æœå¤±æ•—ï¼Œé€šçŸ¥ç®¡ç†å“¡
```

**å†ªç­‰æ€§ä¿è­·ï¼š**
- ä½¿ç”¨ CronJobExecutions è¡¨è¨˜éŒ„åŸ·è¡Œç‹€æ…‹
- åŒä¸€æ—¥æœŸåªå…è¨±åŸ·è¡Œä¸€æ¬¡ï¼ˆUNIQUEç´¢å¼•ï¼‰
- æ”¯æ´æ‰‹å‹•è§¸ç™¼è£œæ•‘

**è©³ç´°å¯¦ä½œï¼š** [å‡æœŸç®¡ç†-å®Œæ•´è¦æ ¼.md](../é–‹ç™¼æŒ‡å—/å‡æœŸç®¡ç†-å®Œæ•´è¦æ ¼.md) ç¬¬482è¡Œ

---

### 4. è£œä¼‘åˆ°æœŸè½‰æ›
**åŸ·è¡Œæ™‚é–“ï¼š** æ¯æœˆ 1æ—¥ 00:00ï¼ˆè™•ç†ä¸Šæœˆåˆ°æœŸè£œä¼‘ï¼‰  
**Cronè¡¨é”å¼ï¼š** `0 0 1 * *`

**åŠŸèƒ½ï¼š**
```
1. æŸ¥è©¢ä¸Šæœˆæœ€å¾Œä¸€å¤©åˆ°æœŸçš„è£œä¼‘
2. è¨ˆç®—æœªä½¿ç”¨æ™‚æ•¸
3. æŒ‰åŸå§‹è²»ç‡è½‰æ›ç‚ºåŠ ç­è²»
4. è¨˜éŒ„åˆ°è–ªè³‡ç³»çµ±ï¼ˆç•¶æœˆè–ªè³‡ï¼‰
5. æ›´æ–°è£œä¼‘ç‹€æ…‹ç‚º 'converted'
6. é€šçŸ¥å“¡å·¥
```

**è©³ç´°å¯¦ä½œï¼š** [å·¥æ™‚ç®¡ç†-å®Œæ•´è¦æ ¼.md](../é–‹ç™¼æŒ‡å—/å·¥æ™‚ç®¡ç†-å®Œæ•´è¦æ ¼.md) ç¬¬554è¡Œ

---

### 5. å·¥æ™‚å¡«å¯«æé†’
**åŸ·è¡Œæ™‚é–“ï¼š** æ¯å¤© 08:30ï¼ˆé€±ä¸€åˆ°é€±äº”ï¼‰  
**Cronè¡¨é”å¼ï¼š** `30 8 * * 1-5`

**åŠŸèƒ½ï¼š**
```
1. æª¢æŸ¥æ‰€æœ‰å“¡å·¥æ˜¨å¤©æ˜¯å¦æœ‰å¡«å·¥æ™‚
2. å¦‚æœæ²’å¡«ï¼Œå‰µå»ºå…©ç­†æé†’ï¼š
   - é€šçŸ¥è©²å“¡å·¥æœ¬äººï¼ˆã€Œæ‚¨æ˜¨å¤©çš„å·¥æ™‚å°šæœªå¡«å¯«ã€ï¼‰
   - é€šçŸ¥ç®¡ç†å“¡ï¼ˆã€Œå“¡å·¥Açš„11/26å·¥æ™‚å°šæœªå¡«å¯«ã€ï¼‰
3. åœ¨å„€è¡¨æ¿é¡¯ç¤ºæé†’
4. è‡ªå‹•æ¶ˆå¤±ï¼šä¸€æ—¦å¡«å¯«å·¥æ™‚ï¼Œæé†’ç«‹å³ç§»é™¤ â­
```

**æ’é™¤æ¢ä»¶ï¼š**
- é€±æœ«ä¸æª¢æŸ¥ï¼ˆé€±å…­æ—¥å¯èƒ½ä¸ä¸Šç­ï¼‰
- åœ‹å®šå‡æ—¥ä¸æª¢æŸ¥
- å·²æœ‰è«‹å‡è¨˜éŒ„çš„æ—¥æœŸä¸æª¢æŸ¥
- å·²æœ‰æé†’çš„æ—¥æœŸä¸é‡è¤‡å‰µå»º

**è©³ç´°å¯¦ä½œï¼š**
```typescript
// Cron Job: æ¯å¤© 08:30 åŸ·è¡Œï¼ˆé€±ä¸€åˆ°é€±äº”ï¼‰
async function checkMissingTimesheets() {
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toISOString().split('T')[0];
  
  // â­ æª¢æŸ¥æ˜¯å¦ç‚ºå·¥ä½œæ—¥ï¼ˆè€ƒæ…®è£œç­æ—¥ï¼‰
  const dayOfWeek = yesterday.getDay();
  
  // å…ˆæŸ¥è©¢æ˜¯å¦æœ‰ç‰¹æ®Šæ—¥æœŸè¨­å®š
  const holiday = await db.prepare(`
    SELECT is_national_holiday, is_makeup_workday 
    FROM Holidays 
    WHERE holiday_date = ?
  `).bind(yesterdayStr).first();
  
  // åˆ¤æ–·æ˜¯å¦æ‡‰è©²æª¢æŸ¥å·¥æ™‚
  let shouldCheck = true;
  
  if (dayOfWeek === 0 || dayOfWeek === 6) {
    // é€±æœ«ï¼šé è¨­ä¸æª¢æŸ¥
    shouldCheck = false;
    
    // ä½†å¦‚æœæ˜¯è£œç­æ—¥ï¼Œè¦æª¢æŸ¥ â­
    if (holiday?.is_makeup_workday) {
      shouldCheck = true;
    }
  }
  
  // å¦‚æœæ˜¯åœ‹å®šå‡æ—¥ï¼ˆä¸”éè£œç­æ—¥ï¼‰ï¼Œä¸æª¢æŸ¥
  if (holiday?.is_national_holiday && !holiday?.is_makeup_workday) {
    shouldCheck = false;
  }
  
  if (!shouldCheck) {
    return;  // ä¸æª¢æŸ¥å·¥æ™‚
  }
  
  // æŸ¥è©¢æ‰€æœ‰å“¡å·¥
  const users = await db.prepare(`
    SELECT user_id, name FROM Users WHERE is_deleted = 0
  `).all();
  
  const missingUsers = [];
  
  for (const user of users.results) {
    // æª¢æŸ¥æ˜¨å¤©æ˜¯å¦æœ‰å·¥æ™‚è¨˜éŒ„
    const timelog = await db.prepare(`
      SELECT * FROM TimeLogs
      WHERE user_id = ? AND work_date = ? AND is_deleted = 0
    `).bind(user.user_id, yesterdayStr).first();
    
    // æª¢æŸ¥æ˜¯å¦æœ‰è«‹å‡è¨˜éŒ„
    const leave = await db.prepare(`
      SELECT * FROM LeaveApplications
      WHERE user_id = ? 
        AND start_date <= ? 
        AND end_date >= ?
        AND is_deleted = 0
    `).bind(user.user_id, yesterdayStr, yesterdayStr).first();
    
    if (!timelog && !leave) {
      missingUsers.push(user);
      
      // 1. é€šçŸ¥å“¡å·¥æœ¬äººï¼ˆæª¢æŸ¥æ˜¯å¦å·²æœ‰æé†’ï¼Œé¿å…é‡è¤‡ï¼‰
      const existingNotif = await db.prepare(`
        SELECT * FROM Notifications
        WHERE user_id = ? 
          AND type = 'missing_timesheet' 
          AND related_date = ?
          AND is_deleted = 0
          AND is_read = 0
      `).bind(user.user_id, yesterdayStr).first();
      
      if (!existingNotif) {
        await db.prepare(`
          INSERT INTO Notifications (
            user_id, type, message, related_date, action_url, auto_dismiss
          ) VALUES (?, 'missing_timesheet', ?, ?, ?, 1)
        `).bind(
          user.user_id,
          `æé†’ï¼š${yesterdayStr} å·¥æ™‚å°šæœªå¡«å¯«`,
          yesterdayStr,
          `/timesheets/new?date=${yesterdayStr}`,
          1  // auto_dismiss=1ï¼šå¡«å¯«å¾Œè‡ªå‹•æ¶ˆå¤±
        ).run();
      }
    }
  }
  
  // 2. é€šçŸ¥ç®¡ç†å“¡ï¼ˆå½™ç¸½æ‰€æœ‰ç¼ºå¡«çš„å“¡å·¥ï¼‰
  if (missingUsers.length > 0) {
    const admins = await db.prepare(`
      SELECT user_id FROM Users WHERE is_admin = 1 AND is_deleted = 0
    `).all();
    
    for (const admin of admins.results) {
      for (const missingUser of missingUsers) {
        // æª¢æŸ¥æ˜¯å¦å·²æœ‰æé†’
        const existingNotif = await db.prepare(`
          SELECT * FROM Notifications
          WHERE user_id = ? 
            AND type = 'missing_timesheet' 
            AND related_date = ?
            AND related_user_id = ?
            AND is_deleted = 0
            AND is_read = 0
        `).bind(admin.user_id, yesterdayStr, missingUser.user_id).first();
        
        if (!existingNotif) {
          await db.prepare(`
            INSERT INTO Notifications (
              user_id, type, message, related_date, related_user_id, action_url, auto_dismiss
            ) VALUES (?, 'missing_timesheet', ?, ?, ?, ?, 1)
          `).bind(
            admin.user_id,
            `${missingUser.name} çš„ ${yesterdayStr} å·¥æ™‚å°šæœªå¡«å¯«`,
            yesterdayStr,
            missingUser.user_id,
            `/admin/timesheets?user_id=${missingUser.user_id}&date=${yesterdayStr}`,
            1  // auto_dismiss=1ï¼šè©²å“¡å·¥å¡«å¯«å¾Œï¼Œç®¡ç†å“¡çš„æé†’ä¹Ÿè‡ªå‹•æ¶ˆå¤±
          ).run();
        }
      }
    }
  }
  
  console.log(`å·¥æ™‚æª¢æŸ¥å®Œæˆï¼š${missingUsers.length} ä½å“¡å·¥ç¼ºå¡« ${yesterdayStr}`);
}

// â­ è‡ªå‹•æ¶ˆå¤±é‚è¼¯ï¼šå“¡å·¥å¡«å¯«å·¥æ™‚å¾Œè§¸ç™¼
async function onTimeLogCreated(userId: number, workDate: string) {
  // ç§»é™¤è©²å“¡å·¥çš„æé†’
  await db.prepare(`
    UPDATE Notifications
    SET is_deleted = 1,
        dismissed_at = datetime('now')
    WHERE user_id = ?
      AND type = 'missing_timesheet'
      AND related_date = ?
      AND auto_dismiss = 1
      AND is_deleted = 0
  `).bind(userId, workDate).run();
  
  // ç§»é™¤ç®¡ç†å“¡é—œæ–¼è©²å“¡å·¥çš„æé†’
  await db.prepare(`
    UPDATE Notifications
    SET is_deleted = 1,
        dismissed_at = datetime('now')
    WHERE type = 'missing_timesheet'
      AND related_date = ?
      AND related_user_id = ?
      AND auto_dismiss = 1
      AND is_deleted = 0
  `).bind(workDate, userId).run();
}

/**
 * âš ï¸ é€šçŸ¥ç‹€æ…‹æ©Ÿèªªæ˜ï¼ˆç°¡åŒ–ç‰ˆï¼‰ï¼š
 * 
 * ç‹€æ…‹å®šç¾©ï¼š
 * - is_deleted = 0ï¼šé€šçŸ¥é¡¯ç¤ºåœ¨å„€è¡¨æ¿ï¼ˆéœ€è¦è™•ç†ï¼‰
 * - is_deleted = 1ï¼šé€šçŸ¥å·²ç§»é™¤ï¼ˆå•é¡Œå·²è§£æ±ºï¼‰
 * 
 * æ²’æœ‰ã€Œå·²è®€æœªè®€ã€æ¦‚å¿µï¼Œåªæœ‰ã€Œé¡¯ç¤º/ç§»é™¤ã€ï¼š
 * - æ‰“é–‹å„€è¡¨æ¿å°±èƒ½çœ‹åˆ°æ‰€æœ‰é€šçŸ¥ï¼ˆä¸éœ€æ¨™è¨˜å·²è®€ï¼‰
 * - å•é¡Œè§£æ±ºå¾Œï¼Œé€šçŸ¥è‡ªå‹•æ¶ˆå¤±ï¼ˆä¸éœ€æ‰‹å‹•é—œé–‰ï¼‰
 * - ä¿æŒä»‹é¢ç°¡æ½”ï¼Œå°ˆæ³¨æ–¼å¾…è™•ç†äº‹é …
 * 
 * ç¯„ä¾‹ï¼š
 * 1. å“¡å·¥11/26æœªå¡«å·¥æ™‚ â†’ 11/27 08:30 å‰µå»ºé€šçŸ¥
 * 2. å“¡å·¥çœ‹åˆ°é€šçŸ¥ï¼Œé»æ“Šã€Œå¡«å¯«å·¥æ™‚ã€
 * 3. å¡«å¯«å®Œæˆ â†’ é€šçŸ¥è‡ªå‹•ç§»é™¤ï¼ˆis_deleted=1ï¼‰
 * 4. ä¸‹æ¬¡æ‰“é–‹å„€è¡¨æ¿ï¼Œé€šçŸ¥å·²æ¶ˆå¤± âœ…
 */
```

---

### 6. è³‡æ–™åº«å‚™ä»½
**åŸ·è¡Œæ™‚é–“ï¼š** æ¯å¤© 02:00  
**Cronè¡¨é”å¼ï¼š** `0 2 * * *`

**åŠŸèƒ½ï¼š**
```
1. å‚™ä»½ D1 è³‡æ–™åº«
2. ä¸Šå‚³åˆ° Cloudflare R2 å„²å­˜
3. ä¿ç•™æœ€è¿‘10å¹´çš„å‚™ä»½ï¼ˆéœ€æ±‚è–ç¶“è¦æ±‚ï¼‰
4. è¨˜éŒ„å‚™ä»½ç‹€æ…‹
```

---

### 7. å¤±æ•—Cron Jobè‡ªå‹•é‡è©¦ â­ æ–°å¢
**åŸ·è¡Œæ™‚é–“ï¼š** æ¯å°æ™‚ä¸€æ¬¡  
**Cronè¡¨é”å¼ï¼š** `0 * * * *`

**åŠŸèƒ½ï¼š**
```
1. æŸ¥è©¢æœ€è¿‘7å¤©å…§å¤±æ•—çš„Cron Job
2. è‡ªå‹•é‡æ–°åŸ·è¡Œ
3. å¦‚æœé‡è©¦æˆåŠŸï¼Œæ›´æ–°ç‹€æ…‹
4. å¦‚æœé‡è©¦3æ¬¡ä»å¤±æ•—ï¼Œé€šçŸ¥ç®¡ç†å“¡ä¸¦åœæ­¢é‡è©¦
```

**è©³ç´°å¯¦ä½œï¼š**
```typescript
// Cron Job: æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
async function retryFailedCronJobs() {
  // 1. æŸ¥è©¢å¤±æ•—çš„ä»»å‹™ï¼ˆæœ€è¿‘7å¤©ï¼Œä¸”é‡è©¦æ¬¡æ•¸<3ï¼‰
  const failedJobs = await db.prepare(`
    SELECT 
      job_name,
      execution_date,
      COUNT(*) as retry_count
    FROM CronJobExecutions
    WHERE status = 'failed'
      AND execution_date >= date('now', '-7 days')
    GROUP BY job_name, execution_date
    HAVING COUNT(*) < 3  -- æœ€å¤šé‡è©¦3æ¬¡
  `).all();
  
  for (const job of failedJobs.results) {
    console.log(`é‡è©¦å¤±æ•—ä»»å‹™ï¼š${job.job_name} (${job.execution_date})ï¼Œç¬¬${job.retry_count + 1}æ¬¡å˜—è©¦`);
    
    try {
      // 2. é‡æ–°åŸ·è¡Œå°æ‡‰çš„Cron Job
      let result;
      
      switch (job.job_name) {
        case 'annual_leave_update':
          result = await annualLeaveYearEndProcessing(job.execution_date);
          break;
        
        case 'monthly_task_generation':
          result = await generateMonthlyTasks();
          break;
        
        case 'comp_leave_conversion':
          result = await convertExpiredCompLeave();
          break;
        
        default:
          console.warn(`æœªçŸ¥çš„ä»»å‹™åç¨±ï¼š${job.job_name}`);
          continue;
      }
      
      // 3. å¦‚æœæˆåŠŸï¼Œè¨˜éŒ„æˆåŠŸç‹€æ…‹
      console.log(`âœ“ é‡è©¦æˆåŠŸï¼š${job.job_name}`);
      
      // é€šçŸ¥ç®¡ç†å“¡
      await sendAdminNotification({
        type: 'cron_retry_success',
        message: `å®šæ™‚ä»»å‹™é‡è©¦æˆåŠŸï¼š${job.job_name} (${job.execution_date})`
      });
      
    } catch (error) {
      // 4. é‡è©¦å¤±æ•—ï¼Œè¨˜éŒ„æ–°çš„å¤±æ•—è¨˜éŒ„
      console.error(`âœ— é‡è©¦å¤±æ•—ï¼š${job.job_name}`, error);
      
      await db.prepare(`
        INSERT INTO CronJobExecutions (
          job_name, execution_date, status, error_message
        ) VALUES (?, ?, 'failed', ?)
      `).bind(job.job_name, job.execution_date, `é‡è©¦å¤±æ•—: ${error.message}`).run();
      
      // 5. å¦‚æœå·²é‡è©¦3æ¬¡ï¼Œé€šçŸ¥ç®¡ç†å“¡æ”¾æ£„
      if (job.retry_count + 1 >= 3) {
        await sendAdminNotification({
          type: 'cron_retry_exhausted',
          message: `å®šæ™‚ä»»å‹™é‡è©¦3æ¬¡ä»å¤±æ•—ï¼š${job.job_name} (${job.execution_date})ï¼Œè«‹æ‰‹å‹•è™•ç†`,
          action_url: `/admin/cron/history?job_name=${job.job_name}`,
          priority: 'high'
        });
      }
    }
  }
}
```

**é‡è©¦ç­–ç•¥ï¼š**
```
ç¬¬1æ¬¡å¤±æ•—ï¼ˆ0:00ï¼‰â†’ 1å°æ™‚å¾Œé‡è©¦ï¼ˆ1:00ï¼‰
ç¬¬2æ¬¡å¤±æ•—ï¼ˆ1:00ï¼‰â†’ 1å°æ™‚å¾Œé‡è©¦ï¼ˆ2:00ï¼‰
ç¬¬3æ¬¡å¤±æ•—ï¼ˆ2:00ï¼‰â†’ æ”¾æ£„ï¼Œé€šçŸ¥ç®¡ç†å“¡
```

---

## âš™ï¸ Cron Job é…ç½®

### Cloudflare Workers Cron é…ç½®ï¼ˆwrangler.tomlï¼‰

```toml
# wrangler.toml

name = "horgoscpa-api"
compatibility_date = "2024-01-01"

[triggers]
crons = [
  "0 0 1 1 *",      # æ¯å¹´1æœˆ1æ—¥ 00:00 - ç‰¹ä¼‘æ›´æ–°
  "0 0 1 * *",      # æ¯æœˆ1æ—¥ 00:00 - ä»»å‹™ç”Ÿæˆ + è£œä¼‘è½‰æ›
  "30 8 * * 1-5",   # é€±ä¸€åˆ°é€±äº” 08:30 - å·¥æ™‚æé†’
  "0 2 * * *",      # æ¯å¤© 02:00 - è³‡æ–™åº«å‚™ä»½
  "0 * * * *"       # â­ æ¯å°æ™‚ - é‡è©¦å¤±æ•—çš„Cron Job
]

[[d1_databases]]
binding = "DB"
database_name = "horgoscpa"
database_id = "your-database-id"

[[r2_buckets]]
binding = "BACKUP"
bucket_name = "horgoscpa-backups"
```

### Cron Handler å…¥å£ï¼ˆsrc/cron/index.tsï¼‰

```typescript
export async function handleCron(event: ScheduledEvent, env: Env) {
  const cron = event.cron;  // Cron è¡¨é”å¼
  const now = new Date();
  
  try {
    // æ¯å¹´1æœˆ1æ—¥ 00:00 - ç‰¹ä¼‘æ›´æ–°
    if (cron === "0 0 1 1 *") {
      await annualLeaveYearEndProcessing(env.DB);
    }
    
    // æ¯æœˆ1æ—¥ 00:00 - ä»»å‹™ç”Ÿæˆ + è£œä¼‘è½‰æ›
    if (cron === "0 0 1 * *") {
      await generateMonthlyTasks(env.DB);
      await convertExpiredCompLeave(env.DB);
    }
    
    // é€±ä¸€åˆ°é€±äº” 08:30 - å·¥æ™‚æé†’
    if (cron === "30 8 * * 1-5") {
      await checkMissingTimesheets(env.DB);
    }
    
    // æ¯å¤© 02:00 - è³‡æ–™åº«å‚™ä»½
    if (cron === "0 2 * * *") {
      await backupDatabase(env.DB, env.BACKUP);
    }
    
    // â­ æ¯å°æ™‚ - é‡è©¦å¤±æ•—çš„Cron Job
    if (cron === "0 * * * *") {
      await retryFailedCronJobs(env.DB);
    }
    
    console.log(`Cron job completed: ${cron}`);
  } catch (error) {
    console.error(`Cron job failed: ${cron}`, error);
    
    // è¨˜éŒ„å¤±æ•—åˆ° CronJobExecutionsï¼ˆå¦‚æœæ˜¯å·²çŸ¥ä»»å‹™ï¼‰
    // é€šçŸ¥ç®¡ç†å“¡
  }
}
```

---

## ğŸ”§ åŸ·è¡Œè¨˜éŒ„èˆ‡ç›£æ§

### æ‰€æœ‰Cron Jobéƒ½æ‡‰è©²ï¼š

1. **è¨˜éŒ„åŸ·è¡Œç‹€æ…‹**
   ```typescript
   await db.prepare(`
     INSERT INTO CronJobExecutions (job_name, execution_date, status, affected_users)
     VALUES (?, ?, ?, ?)
   `).bind(jobName, date, 'success', count).run();
   ```

2. **å†ªç­‰æ€§æª¢æŸ¥**
   ```typescript
   const executed = await db.prepare(`
     SELECT * FROM CronJobExecutions
     WHERE job_name = ? AND execution_date = ? AND status = 'success'
   `).bind(jobName, date).first();
   
   if (executed) return;  // å·²åŸ·è¡Œï¼Œè·³é
   ```

3. **å¤±æ•—é€šçŸ¥**
   ```typescript
   await sendAdminNotification({
     type: 'cron_failed',
     message: `${jobName} åŸ·è¡Œå¤±æ•—ï¼š${error.message}`
   });
   ```

4. **æ”¯æ´æ‰‹å‹•è§¸ç™¼**
   ```typescript
   // POST /api/v1/admin/cron/execute
   // å¯ä»¥è£œæ•‘åŸ·è¡Œå¤±æ•—çš„ä»»å‹™
   ```

---

**å¯¦ç¾ç´°ç¯€ï¼š** ä½¿ç”¨ Cloudflare Workers Cron Triggers

