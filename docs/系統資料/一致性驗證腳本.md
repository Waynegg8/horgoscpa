# 一致性驗證方法

**目的：** 確保所有文件的一致性，不依賴硬編碼數字

**核心原則：單一真相源（SSOT - Single Source of Truth）**

---

## 📌 單一真相源（SSOT）

### 定義
**只在一個地方定義真相，其他所有地方都必須與它一致。**

### 真相源文件

| 資料類型 | 真相源文件 | 說明 |
|---------|----------|------|
| 資料表總數 | `系統資料/數據表清單.md` | 唯一定義資料表數量的地方 |
| API總數 | `系統資料/API清單.md` | 唯一定義 API 數量的地方 |

### 驗證原則

**當你修改數字時：**
1. ✅ **只在 SSOT 文件中修改**
2. ✅ **檢查所有其他文件是否與 SSOT 一致**
3. ✅ **如果不一致，更新它們**

**範例：新增一個資料表**
```
1. 在 數據表清單.md 中：
   - 新增該表的定義
   - 更新總數：28個 → 29個

2. 檢查以下文件，確保數字一致：
   - 開發指南/README.md
   - 使用手冊/README.md
   - 所有提到資料表數量的文件

3. 使用搜尋驗證：
   grep -r "\\d+個.*表" docs/
   → 不應該有任何結果
```

---

## 🔍 驗證方法

### 方法1：檢查數字統計是否一致

```bash
# Windows PowerShell
$tables = @()
$apis = @()

# 提取所有提到「表」的數字
Get-ChildItem -Path "docs" -Filter "*.md" -Recurse | ForEach-Object {
    $content = Get-Content $_.FullName -Raw
    if ($content -match '(\d+)\s*個.*?表') {
        $tables += @{File=$_.Name; Count=$matches[1]}
    }
    if ($content -match '(\d+)\s*個.*?API') {
        $apis += @{File=$_.Name; Count=$matches[1]}
    }
}

# 檢查是否所有數字一致
$tableCount = $tables | Select-Object -ExpandProperty Count -Unique
$apiCount = $apis | Select-Object -ExpandProperty Count -Unique

if ($tableCount.Count -gt 1) {
    Write-Host "❌ 資料表數字不一致！" -ForegroundColor Red
    $tables | Format-Table
} else {
    Write-Host "✅ 資料表數字一致：$tableCount 個" -ForegroundColor Green
}

if ($apiCount.Count -gt 1) {
    Write-Host "❌ API 數字不一致！" -ForegroundColor Red
    $apis | Format-Table
} else {
    Write-Host "✅ API 數字一致：$apiCount 個" -ForegroundColor Green
}
```

---

### 方法2：驗證單一真相源（SSOT）

**原則：** 只在一個地方定義真相，其他地方都引用它

**單一真相源文件：**
- `系統資料/數據表清單.md` - 唯一定義資料表總數的地方
- `系統資料/API清單.md` - 唯一定義 API 總數的地方

**驗證腳本：**
```bash
# 1. 從 SSOT 文件中提取真相
$tableFile = Get-Content "docs\系統資料\數據表清單.md" -Raw
$apiFile = Get-Content "docs\系統資料\API清單.md" -Raw

$tableFile -match '資料表總覽[（(](\d+)個[）)]'
$truthTables = $matches[1]

$apiFile -match '總計[：:]\s*約?\s*(\d+)\s*個'
$truthAPIs = $matches[1]

Write-Host "單一真相源：" 
Write-Host "  資料表：$truthTables 個" -ForegroundColor Cyan
Write-Host "  API：$truthAPIs 個" -ForegroundColor Cyan

# 2. 檢查其他文件是否與 SSOT 一致
$errors = @()

Get-ChildItem -Path "docs" -Filter "*.md" -Recurse | ForEach-Object {
    if ($_.Name -notlike "*數據表清單.md" -and $_.Name -notlike "*API清單.md") {
        $content = Get-Content $_.FullName -Raw
        
        # 檢查表的數字
        if ($content -match '(\d+)\s*個.*?表') {
            if ($matches[1] -ne $truthTables) {
                $errors += "$($_.Name): 表數字 $($matches[1]) ≠ $truthTables"
            }
        }
        
        # 檢查 API 的數字
        if ($content -match '(\d+)\s*個.*?API') {
            if ($matches[1] -ne $truthAPIs) {
                $errors += "$($_.Name): API 數字 $($matches[1]) ≠ $truthAPIs"
            }
        }
    }
}

if ($errors.Count -eq 0) {
    Write-Host "`n✅ 所有文件與單一真相源一致！" -ForegroundColor Green
} else {
    Write-Host "`n❌ 發現 $($errors.Count) 個不一致：" -ForegroundColor Red
    $errors | ForEach-Object { Write-Host "  $_" -ForegroundColor Yellow }
}
```

---

### 方法3：驗證交叉引用對稱性

```bash
# 檢查所有「相關功能」的雙向引用
$files = Get-ChildItem -Path "docs\使用手冊" -Filter "*.md"
$references = @{}

foreach ($file in $files) {
    $content = Get-Content $file.FullName -Raw
    $name = $file.BaseName
    
    # 提取所有引用
    $matches = [regex]::Matches($content, '\\[([^\\]]+)\\]\\(\\./([^\\)]+)\\.md\\)')
    $refs = $matches | ForEach-Object { $_.Groups[2].Value }
    
    $references[$name] = $refs
}

# 檢查對稱性
$asymmetric = @()
foreach ($source in $references.Keys) {
    foreach ($target in $references[$source]) {
        # 如果 A 引用 B，檢查 B 是否引用 A
        if ($references.ContainsKey($target)) {
            if ($references[$target] -notcontains $source) {
                $asymmetric += "$source → $target (但 $target 沒有引用 $source)"
            }
        }
    }
}

if ($asymmetric.Count -eq 0) {
    Write-Host "✅ 所有交叉引用都是對稱的！" -ForegroundColor Green
} else {
    Write-Host "❌ 發現 $($asymmetric.Count) 個不對稱引用：" -ForegroundColor Red
    $asymmetric | ForEach-Object { Write-Host "  $_" -ForegroundColor Yellow }
}
```

---

### 方法4：驗證格式一致性

```bash
# 檢查同類文件是否使用相同的章節結構
$specs = Get-ChildItem -Path "docs\開發指南" -Filter "*-完整規格.md"
$structures = @{}

foreach ($spec in $specs) {
    $content = Get-Content $spec.FullName
    $headers = $content | Where-Object { $_ -match '^##\s+' } | ForEach-Object { $_ -replace '^##\s+', '' }
    $structures[$spec.Name] = $headers -join "|"
}

# 檢查是否所有完整規格都有相同的結構
$uniqueStructures = $structures.Values | Select-Object -Unique

if ($uniqueStructures.Count -eq 1) {
    Write-Host "✅ 所有完整規格文件結構一致！" -ForegroundColor Green
} else {
    Write-Host "❌ 完整規格文件結構不一致：" -ForegroundColor Red
    $structures.GetEnumerator() | ForEach-Object {
        Write-Host "  $($_.Key): $($_.Value)" -ForegroundColor Yellow
    }
}
```

---

## 🧪 手動驗證步驟（AI 必須執行）

### 步驟1：提取 SSOT 真相

```powershell
# 1. 查看資料表真相源
Get-Content "docs\系統資料\數據表清單.md" | Select-String "資料表總覽"
# 輸出範例：## 📊 資料表總覽（N個）
# → 以擷取到的數字為準（SSOT）

# 2. 查看 API 真相源  
Get-Content "docs\系統資料\API清單.md" | Select-String "總計"
# 輸出範例：**總計：約 N 個 API 端點**
# → 以擷取到的數字為準（SSOT）
```

### 步驟2：搜尋所有提到的數字

```powershell
# 搜尋所有提到「表」數字的地方
Get-ChildItem -Path "docs" -Filter "*.md" -Recurse | Select-String "個.*表" | Where-Object { $_.Line -match '\\d+個' }

# 搜尋所有提到「API」數字的地方
Get-ChildItem -Path "docs" -Filter "*.md" -Recurse | Select-String "個.*API" | Where-Object { $_.Line -match '\\d+個' }
```

### 步驟3：檢查一致性

**所有結果都必須與 SSOT 一致！**
– 如果看到不同的數字（如：X 個表、Y 個 API），立即修復
- 直到所有數字都一致（以 SSOT 數字為準）

### 步驟4：驗證交叉引用

```powershell
# 檢查使用手冊中的交叉引用
Get-ChildItem "docs\使用手冊" -Filter "*.md" | ForEach-Object {
    $name = $_.BaseName
    Write-Host "`n=== $name ===" -ForegroundColor Cyan
    Get-Content $_.FullName | Select-String "相關功能" -Context 0,10
}
```

**檢查規則：**
- 如果 A 引用 B，B 也必須引用 A（對稱性）
- 所有功能文件都必須有「相關功能」部分（除了 README 和快速開始）

---

## 📝 一致性檢查清單（AI 必須逐項確認）

完成開發後，逐項檢查：

### ✅ 數字統計一致性
- [ ] 從 SSOT 提取真實數字（資料表、API）
- [ ] 搜尋所有文件中的相關數字
- [ ] 確認所有數字與 SSOT 一致
- [ ] 如有不一致，立即修復

### ✅ 交叉引用對稱性  
- [ ] 列出所有修改/新增的文件
- [ ] 檢查它們的「相關功能」部分
- [ ] 確認雙向引用（A→B 且 B→A）
- [ ] 補充缺失的引用

### ✅ 格式規範一致性
- [ ] 檢查同類文件的章節結構
- [ ] 檢查完整規格的結尾格式
- [ ] 確保統一的格式規範

### ✅ 完整性檢查
- [ ] 所有使用手冊都有「相關功能」
- [ ] 所有完整規格都有必要章節
- [ ] 所有新增功能都有對應文件

---

## 🎯 簡化驗證命令（推薦）

```powershell
# 快速檢查：尋找可能的不一致
cd docs

# 查找所有數字統計
Get-ChildItem -Filter "*.md" -Recurse | Select-String "個.*[表API]" | ForEach-Object {
    if ($_.Line -match '(\d+)個') {
        "$($_.FileName): $($matches[1])個"
    }
} | Sort-Object | Get-Unique

# 如果看到多個不同的數字，代表不一致！
```

---

**AI 開發完成後必須手動執行這些檢查，不可跳過！**


