# 部署說明

**Cloudflare Pages 自動部署指南**

**給 AI：** 每次開發完成後必須自動部署

---

## ⚠️ 重要原則

```
絕對不讓用戶部署！AI必須自動部署！
用戶沒有技術背景，不應接觸部署流程。
```

---

## 🚀 自動部署流程（AI必須執行）

### 這是 Cloudflare Pages 專案

**部署方式：** Git Push → 自動建置 → 自動部署

**不需要手動執行任何部署命令！**

### 標準部署步驟

```powershell
# 1. 使用自動部署腳本（推薦）
.\scripts\deploy.ps1

# 腳本會自動：
#   - 檢查修改的文件
#   - 添加到 Git
#   - 提交代碼
#   - 推送到遠端
#   - Cloudflare 自動部署
```

### 手動部署步驟（如果腳本失敗）

```bash
# 1. 添加所有修改
git add .

# 2. 提交（用繁體中文說明）
git commit -m "新增XX功能：功能描述"

# 3. 推送到遠端
git push origin main

# 4. 等待 Cloudflare 自動部署（1-3分鐘）
```

---

## 📋 部署後驗證清單

**AI必須確認以下所有項目：**

- [ ] Git 推送成功
- [ ] Cloudflare Pages 建置成功
- [ ] 網站能正常訪問
- [ ] 新功能正常運作
- [ ] 繁體中文顯示正確
- [ ] 沒有 Console 錯誤
- [ ] API 正常回應
- [ ] 資料庫連接正常

---

## 🔗 相關資源

**Cloudflare Dashboard:**
```
https://dash.cloudflare.com/
→ 查看建置狀態和部署日誌
```

**網站網址:**
```
https://horgoscpa.pages.dev
→ 驗證部署結果
```

---

## 🧪 驗證步驟

**部署完成後，AI必須測試：**

```javascript
// 1. 打開瀏覽器
// 訪問：https://horgoscpa.pages.dev

// 2. 測試新功能
// 執行所有功能測試

// 3. 檢查 Console
// 確認沒有錯誤

// 4. 測試繁體中文
// 確認顯示正確
```

---

## ❌ 常見問題

### 問題1：Git 推送失敗

```bash
# 檢查遠端連接
git remote -v

# 應該看到：
# origin  https://github.com/your-username/horgoscpa.git (fetch)
# origin  https://github.com/your-username/horgoscpa.git (push)

# 如果不對，重新設定：
git remote set-url origin <正確的URL>
```

### 問題2：Cloudflare 建置失敗

```
1. 到 Cloudflare Dashboard 查看錯誤日誌
2. 檢查是否有語法錯誤
3. 修復後重新推送
```

### 問題3：部署後功能異常

```
1. 清除瀏覽器緩存
2. 檢查 Console 錯誤訊息
3. 檢查 API 端點是否正確
4. 檢查資料庫連接
```

---

## 📝 部署報告模板

**AI完成部署後，必須回報：**

```
已完成XX功能，部署報告如下：

✅ 測試報告：
   - 所有測試通過

✅ Git 提交：
   - Commit: "新增XX功能"
   - 已推送到 main 分支

✅ Cloudflare 建置：
   - 建置成功
   - 部署時間：約 2 分鐘

✅ 線上驗證：
   - 網站正常訪問：https://horgoscpa.pages.dev
   - 新功能正常運作
   - 繁體中文顯示正確
   - 沒有錯誤

功能已上線，可以立即使用！
```

---

## 🔒 HTTPS 強制策略

### 1. Cloudflare 自動 HTTPS

```
✅ Cloudflare Pages 自動提供 HTTPS
✅ 自動申請和續約 SSL 證書
✅ 支援自訂網域的 HTTPS
```

### 2. 強制 HTTPS 重定向

```typescript
// 在 Workers 中強制 HTTPS
app.use('*', async (c, next) => {
  const url = new URL(c.req.url);
  
  // 如果是 HTTP 請求，重定向到 HTTPS
  if (url.protocol === 'http:') {
    url.protocol = 'https:';
    return c.redirect(url.toString(), 301);
  }
  
  await next();
});
```

### 3. HSTS 頭設置

```typescript
// HTTP Strict Transport Security
app.use('*', async (c, next) => {
  await next();
  
  // 強制瀏覽器使用 HTTPS（1年）
  c.header('Strict-Transport-Security', 'max-age=31536000; includeSubDomains; preload');
});
```

### 4. 安全頭設置

```typescript
app.use('*', async (c, next) => {
  await next();
  
  // 安全相關的 HTTP 頭
  c.header('X-Content-Type-Options', 'nosniff');
  c.header('X-Frame-Options', 'DENY');
  c.header('X-XSS-Protection', '1; mode=block');
  c.header('Referrer-Policy', 'strict-origin-when-cross-origin');
  
  // Content Security Policy
  c.header('Content-Security-Policy', [
    "default-src 'self'",
    "script-src 'self' 'unsafe-inline'",
    "style-src 'self' 'unsafe-inline'",
    "img-src 'self' data: https:",
    "font-src 'self' data:",
    "connect-src 'self'",
    "frame-ancestors 'none'"
  ].join('; '));
});
```

### 5. Cloudflare 設定檢查清單

```
□ SSL/TLS 加密模式：Full (strict)
□ Always Use HTTPS：啟用
□ Automatic HTTPS Rewrites：啟用
□ Minimum TLS Version：TLS 1.2
□ TLS 1.3：啟用
□ HSTS：啟用（max-age: 1 年）
```

### 6. 驗證 HTTPS 配置

```bash
# 測試 HTTPS
curl -I https://your-domain.pages.dev

# 應該看到：
HTTP/2 200
strict-transport-security: max-age=31536000; includeSubDomains; preload
x-content-type-options: nosniff
x-frame-options: DENY

# 測試 HTTP 重定向
curl -I http://your-domain.pages.dev

# 應該看到：
HTTP/1.1 301 Moved Permanently
Location: https://your-domain.pages.dev
```

---

## 🎯 關鍵提醒

```
1. 每次開發完成後都必須自動部署
2. 不需要問用戶是否要部署
3. 不需要等待用戶確認
4. AI自主完成整個流程
5. 部署完成後附上測試報告和網址
6. 確保 HTTPS 強制啟用
```

---

**AI開發流程：開發 → 測試 → 部署 → HTTPS驗證 → 回報**

