# 故障排查指南

**給 AI 和運維人員：** 常見問題的診斷和解決方案

---

## 🔍 診斷工具

### 1. 健康檢查端點

```typescript
// GET /api/health
app.get('/api/health', async (c) => {
  const checks = {
    timestamp: new Date().toISOString(),
    status: 'healthy',
    checks: {}
  };
  
  // 數據庫連接檢查
  try {
    await c.env.DB.prepare('SELECT 1').first();
    checks.checks.database = 'ok';
  } catch (error) {
    checks.checks.database = 'error';
    checks.status = 'unhealthy';
  }
  
  // KV 緩存檢查
  try {
    await c.env.CACHE_KV.get('health_check');
    checks.checks.cache = 'ok';
  } catch (error) {
    checks.checks.cache = 'error';
  }
  
  const statusCode = checks.status === 'healthy' ? 200 : 503;
  return c.json(checks, statusCode);
});
```

### 2. 日誌查詢

```bash
# Cloudflare Logpush 查詢
wrangler tail timesheet-api --format=json

# 過濾錯誤日誌
wrangler tail timesheet-api --format=json | grep '"level":"error"'
```

---

## ❌ 常見問題排查

### 問題1：數據庫連接失敗

**症狀：**
```
Error: D1_ERROR: Database connection failed
API 回應 500 Internal Server Error
```

**診斷步驟：**
```bash
# 1. 檢查 wrangler.toml 配置
cat wrangler.toml | grep database

# 2. 檢查 D1 綁定
wrangler d1 list

# 3. 測試數據庫查詢
wrangler d1 execute timesheet-db --command "SELECT 1"
```

**解決方案：**
```bash
# 確認 D1 綁定正確
[[d1_databases]]
binding = "DB"
database_name = "timesheet-db"
database_id = "your-database-id"

# 重新部署
wrangler deploy
```

---

### 問題2：中文亂碼

**症狀：**
```
公司名稱顯示為：ç¹é«å…¬å¸
數據庫中：é­ä¸­å…¬å¸
```

**診斷步驟：**
```sql
-- 檢查數據庫編碼
SELECT hex(company_name) FROM Clients WHERE client_id = '12345678';

-- 應該看到 UTF-8 編碼的十六進制
-- 正確：E7B981 E9AB94 (繁體)
-- 錯誤：3F3F3F (???)
```

**解決方案：**
```typescript
// 1. 確認所有文件使用 UTF-8 編碼
// 2. 確認 Content-Type 頭
c.header('Content-Type', 'application/json; charset=utf-8');

// 3. 數據庫查詢使用參數化
await db.prepare('SELECT * FROM Clients WHERE company_name = ?')
  .bind(name)  // 不要字符串拼接
  .all();
```

---

### 問題3：登入失敗

**症狀：**
```
POST /api/v1/auth/login → 401 Unauthorized
錯誤訊息：帳號或密碼錯誤
```

**診斷步驟：**
```sql
-- 1. 檢查用戶是否存在
SELECT user_id, username, is_deleted, login_attempts 
FROM Users 
WHERE username = '用戶名';

-- 2. 檢查是否被鎖定
SELECT login_attempts, last_failed_login 
FROM Users 
WHERE username = '用戶名';
```

**解決方案：**
```typescript
// 情況1：密碼錯誤
// 重設密碼
const newPassword = 'TempPass123';
const hash = await bcrypt.hash(newPassword, 12);
await db.prepare('UPDATE Users SET password_hash = ?, login_attempts = 0 WHERE user_id = ?')
  .bind(hash, userId)
  .run();

// 情況2：帳號鎖定
// 解鎖帳號
await db.prepare('UPDATE Users SET login_attempts = 0 WHERE user_id = ?')
  .bind(userId)
  .run();
```

---

### 問題4：API 403 Forbidden

**症狀：**
```
GET /api/v1/admin/users → 403 Forbidden
錯誤訊息：權限不足
```

**診斷步驟：**
```sql
-- 檢查用戶角色
SELECT user_id, username, is_admin 
FROM Users 
WHERE user_id = 1;

-- 檢查 JWT Token
```

**解決方案：**
```typescript
// 提升用戶為管理員
await db.prepare('UPDATE Users SET is_admin = 1 WHERE user_id = ?')
  .bind(userId)
  .run();

// 重新登入獲取新 Token
```

---

### 問題5：補休時數計算錯誤

**症狀：**
```
加班 2 小時（平日加班，費率 1.34）
預期補休：0.68 小時
實際補休：0 小時
```

**診斷步驟：**
```sql
-- 1. 檢查工時記錄
SELECT * FROM TimeLogs 
WHERE user_id = 1 AND work_date = '2025-10-28';

-- 2. 檢查費率設定
SELECT * FROM OvertimeRates 
WHERE work_type_id = 2 AND is_current = 1;

-- 3. 檢查補休記錄
SELECT * FROM CompensatoryLeave 
WHERE user_id = 1 
ORDER BY created_at DESC 
LIMIT 10;
```

**解決方案：**
```typescript
// 確認加權工時計算正確
const hours = 2;
const rate = 1.34;
const weightedHours = hours * rate;  // 2.68
const compLeaveHours = weightedHours - hours;  // 0.68

// 手動補充補休記錄
await db.prepare(`
  INSERT INTO CompensatoryLeave (
    user_id, hours_earned, hours_remaining, 
    earned_date, expiry_date
  ) VALUES (?, ?, ?, ?, ?)
`).bind(
  userId,
  0.68,
  0.68,
  '2025-10-28',
  '2025-10-31'  // 當月最後一天
).run();
```

---

### 問題6：任務未自動生成

**症狀：**
```
每月 1 日應自動生成任務
但某些客戶的任務沒有生成
```

**診斷步驟：**
```sql
-- 1. 檢查客戶服務狀態
SELECT 
  cs.*,
  c.company_name,
  s.service_name
FROM ClientServices cs
JOIN Clients c ON cs.client_id = c.client_id
JOIN Services s ON cs.service_id = s.service_id
WHERE cs.is_deleted = 0
  AND cs.trigger_months LIKE '%10%';  -- 當前月份

-- 2. 檢查服務是否暫停
SELECT * FROM ClientServices 
WHERE status != 'active';

-- 3. 檢查 Cron Job 執行日誌
SELECT * FROM AuditLogs 
WHERE action = 'TASK_GENERATION'
ORDER BY created_at DESC 
LIMIT 10;
```

**解決方案：**
```typescript
// 手動觸發任務生成
POST /api/v1/admin/tasks/generate-monthly
{
  "year": 2025,
  "month": 10
}

// 或直接執行 SQL
// 根據任務模板生成任務...
```

---

### 問題7：補休過期未轉加班費

**症狀：**
```
10/31 的補休應該在 11/1 自動轉加班費
但沒有轉換
```

**診斷步驟：**
```sql
-- 檢查過期補休
SELECT * FROM CompensatoryLeave
WHERE expiry_date = '2025-10-31'
  AND status = 'active'
  AND hours_remaining > 0;

-- 檢查 Cron Job 執行記錄
SELECT * FROM AuditLogs
WHERE action = 'COMP_LEAVE_EXPIRATION'
  AND created_at >= '2025-11-01'
ORDER BY created_at DESC;
```

**解決方案：**
```typescript
// 手動執行過期處理
POST /api/v1/admin/compensatory-leave/process-expiry

// 或直接更新數據庫
UPDATE CompensatoryLeave
SET status = 'converted',
    converted_to_payment = 1,
    conversion_date = datetime('now'),
    conversion_rate = 1.34
WHERE expiry_date < date('now')
  AND status = 'active'
  AND hours_remaining > 0;
```

---

## 🛠️ 性能問題排查

### 慢查詢診斷

```sql
-- 開啟查詢日誌
PRAGMA query_log = ON;

-- 分析慢查詢
SELECT * FROM query_log 
WHERE duration_ms > 1000
ORDER BY duration_ms DESC;

-- 檢查索引使用
EXPLAIN QUERY PLAN
SELECT * FROM Clients 
WHERE company_name LIKE '%公司%';
```

**優化建議：**
```sql
-- 添加索引
CREATE INDEX idx_clients_company_name ON Clients(company_name);

-- 使用全文搜索（如果支持）
CREATE VIRTUAL TABLE clients_fts USING fts5(company_name);
```

---

## 📊 監控指標

### 關鍵指標

```
1. API 錯誤率：< 1%
2. API 響應時間：P95 < 500ms
3. 數據庫查詢時間：P95 < 100ms
4. 登入失敗率：< 5%
5. 緩存命中率：> 80%
```

### 告警規則

```typescript
// Cloudflare Workers Analytics
if (errorRate > 0.01) {
  await sendAlert({
    level: 'warning',
    message: 'API 錯誤率超過 1%',
    value: errorRate
  });
}

if (p95ResponseTime > 500) {
  await sendAlert({
    level: 'warning',
    message: 'API 響應時間過慢',
    value: p95ResponseTime
  });
}
```

---

## 🔐 安全問題排查

### SQL 注入檢測

```typescript
// 查找可疑查詢模式
const suspiciousPatterns = [
  "' OR '1'='1",
  "'; DROP TABLE",
  "UNION SELECT",
  "--",
  "/*"
];

// 記錄可疑請求
if (suspiciousPatterns.some(pattern => queryString.includes(pattern))) {
  logger.warn('Potential SQL injection detected', {
    query: queryString,
    ip: clientIp,
    user_id: userId
  });
}
```

### 異常登入偵測

```sql
-- 查找異常登入模式
SELECT 
  user_id,
  COUNT(*) as attempt_count,
  COUNT(DISTINCT ip_address) as ip_count
FROM AuditLogs
WHERE action = 'LOGIN'
  AND created_at > datetime('now', '-1 hour')
GROUP BY user_id
HAVING attempt_count > 10 OR ip_count > 3;
```

---

**遇到問題時，按此指南逐步排查，大部分問題都能快速解決。**

