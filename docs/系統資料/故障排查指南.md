# æ•…éšœæ’æŸ¥æŒ‡å—

**çµ¦ AI å’Œé‹ç¶­äººå“¡ï¼š** å¸¸è¦‹å•é¡Œçš„è¨ºæ–·å’Œè§£æ±ºæ–¹æ¡ˆ

---

## ğŸ” è¨ºæ–·å·¥å…·

### 1. å¥åº·æª¢æŸ¥ç«¯é»

```typescript
// GET /api/health
app.get('/api/health', async (c) => {
  const checks = {
    timestamp: new Date().toISOString(),
    status: 'healthy',
    checks: {}
  };
  
  // æ•¸æ“šåº«é€£æ¥æª¢æŸ¥
  try {
    await c.env.DB.prepare('SELECT 1').first();
    checks.checks.database = 'ok';
  } catch (error) {
    checks.checks.database = 'error';
    checks.status = 'unhealthy';
  }
  
  // KV ç·©å­˜æª¢æŸ¥
  try {
    await c.env.CACHE_KV.get('health_check');
    checks.checks.cache = 'ok';
  } catch (error) {
    checks.checks.cache = 'error';
  }
  
  const statusCode = checks.status === 'healthy' ? 200 : 503;
  return c.json(checks, statusCode);
});
```

### 2. æ—¥èªŒæŸ¥è©¢

```bash
# Cloudflare Logpush æŸ¥è©¢
wrangler tail timesheet-api --format=json

# éæ¿¾éŒ¯èª¤æ—¥èªŒ
wrangler tail timesheet-api --format=json | grep '"level":"error"'
```

---

## âŒ å¸¸è¦‹å•é¡Œæ’æŸ¥

### å•é¡Œ1ï¼šæ•¸æ“šåº«é€£æ¥å¤±æ•—

**ç—‡ç‹€ï¼š**
```
Error: D1_ERROR: Database connection failed
API å›æ‡‰ 500 Internal Server Error
```

**è¨ºæ–·æ­¥é©Ÿï¼š**
```bash
# 1. æª¢æŸ¥ wrangler.toml é…ç½®
cat wrangler.toml | grep database

# 2. æª¢æŸ¥ D1 ç¶å®š
wrangler d1 list

# 3. æ¸¬è©¦æ•¸æ“šåº«æŸ¥è©¢
wrangler d1 execute timesheet-db --command "SELECT 1"
```

**è§£æ±ºæ–¹æ¡ˆï¼š**
```bash
# ç¢ºèª D1 ç¶å®šæ­£ç¢º
[[d1_databases]]
binding = "DB"
database_name = "timesheet-db"
database_id = "your-database-id"

# é‡æ–°éƒ¨ç½²
wrangler deploy
```

---

### å•é¡Œ2ï¼šä¸­æ–‡äº‚ç¢¼

**ç—‡ç‹€ï¼š**
```
å…¬å¸åç¨±é¡¯ç¤ºç‚ºï¼šÃ§Â¹Ã©Â«Ã¥â€¦Â¬Ã¥Â¸
æ•¸æ“šåº«ä¸­ï¼šÃ©Â­Ã¤Â¸Â­Ã¥â€¦Â¬Ã¥Â¸
```

**è¨ºæ–·æ­¥é©Ÿï¼š**
```sql
-- æª¢æŸ¥æ•¸æ“šåº«ç·¨ç¢¼
SELECT hex(company_name) FROM Clients WHERE client_id = '12345678';

-- æ‡‰è©²çœ‹åˆ° UTF-8 ç·¨ç¢¼çš„åå…­é€²åˆ¶
-- æ­£ç¢ºï¼šE7B981 E9AB94 (ç¹é«”)
-- éŒ¯èª¤ï¼š3F3F3F (???)
```

**è§£æ±ºæ–¹æ¡ˆï¼š**
```typescript
// 1. ç¢ºèªæ‰€æœ‰æ–‡ä»¶ä½¿ç”¨ UTF-8 ç·¨ç¢¼
// 2. ç¢ºèª Content-Type é ­
c.header('Content-Type', 'application/json; charset=utf-8');

// 3. æ•¸æ“šåº«æŸ¥è©¢ä½¿ç”¨åƒæ•¸åŒ–
await db.prepare('SELECT * FROM Clients WHERE company_name = ?')
  .bind(name)  // ä¸è¦å­—ç¬¦ä¸²æ‹¼æ¥
  .all();
```

---

### å•é¡Œ3ï¼šç™»å…¥å¤±æ•—

**ç—‡ç‹€ï¼š**
```
POST /api/v1/auth/login â†’ 401 Unauthorized
éŒ¯èª¤è¨Šæ¯ï¼šå¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤
```

**è¨ºæ–·æ­¥é©Ÿï¼š**
```sql
-- 1. æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å­˜åœ¨
SELECT user_id, username, is_deleted, login_attempts 
FROM Users 
WHERE username = 'ç”¨æˆ¶å';

-- 2. æª¢æŸ¥æ˜¯å¦è¢«é–å®š
SELECT login_attempts, last_failed_login 
FROM Users 
WHERE username = 'ç”¨æˆ¶å';
```

**è§£æ±ºæ–¹æ¡ˆï¼š**
```typescript
// æƒ…æ³1ï¼šå¯†ç¢¼éŒ¯èª¤
// é‡è¨­å¯†ç¢¼
const newPassword = 'TempPass123';
const hash = await bcrypt.hash(newPassword, 12);
await db.prepare('UPDATE Users SET password_hash = ?, login_attempts = 0 WHERE user_id = ?')
  .bind(hash, userId)
  .run();

// æƒ…æ³2ï¼šå¸³è™Ÿé–å®š
// è§£é–å¸³è™Ÿ
await db.prepare('UPDATE Users SET login_attempts = 0 WHERE user_id = ?')
  .bind(userId)
  .run();
```

---

### å•é¡Œ4ï¼šAPI 403 Forbidden

**ç—‡ç‹€ï¼š**
```
GET /api/v1/admin/users â†’ 403 Forbidden
éŒ¯èª¤è¨Šæ¯ï¼šæ¬Šé™ä¸è¶³
```

**è¨ºæ–·æ­¥é©Ÿï¼š**
```sql
-- æª¢æŸ¥ç”¨æˆ¶è§’è‰²
SELECT user_id, username, is_admin 
FROM Users 
WHERE user_id = 1;

-- æª¢æŸ¥ JWT Token
```

**è§£æ±ºæ–¹æ¡ˆï¼š**
```typescript
// æå‡ç”¨æˆ¶ç‚ºç®¡ç†å“¡
await db.prepare('UPDATE Users SET is_admin = 1 WHERE user_id = ?')
  .bind(userId)
  .run();

// é‡æ–°ç™»å…¥ç²å–æ–° Token
```

---

### å•é¡Œ5ï¼šè£œä¼‘æ™‚æ•¸è¨ˆç®—éŒ¯èª¤

**ç—‡ç‹€ï¼š**
```
åŠ ç­ 2 å°æ™‚ï¼ˆå¹³æ—¥åŠ ç­ï¼Œè²»ç‡ 1.34ï¼‰
é æœŸè£œä¼‘ï¼š0.68 å°æ™‚
å¯¦éš›è£œä¼‘ï¼š0 å°æ™‚
```

**è¨ºæ–·æ­¥é©Ÿï¼š**
```sql
-- 1. æª¢æŸ¥å·¥æ™‚è¨˜éŒ„
SELECT * FROM TimeLogs 
WHERE user_id = 1 AND work_date = '2025-10-28';

-- 2. æª¢æŸ¥è²»ç‡è¨­å®š
SELECT * FROM OvertimeRates 
WHERE work_type_id = 2 AND is_current = 1;

-- 3. æª¢æŸ¥è£œä¼‘è¨˜éŒ„
SELECT * FROM CompensatoryLeave 
WHERE user_id = 1 
ORDER BY created_at DESC 
LIMIT 10;
```

**è§£æ±ºæ–¹æ¡ˆï¼š**
```typescript
// ç¢ºèªåŠ æ¬Šå·¥æ™‚è¨ˆç®—æ­£ç¢º
const hours = 2;
const rate = 1.34;
const weightedHours = hours * rate;  // 2.68
const compLeaveHours = weightedHours - hours;  // 0.68

// æ‰‹å‹•è£œå……è£œä¼‘è¨˜éŒ„
await db.prepare(`
  INSERT INTO CompensatoryLeave (
    user_id, hours_earned, hours_remaining, 
    earned_date, expiry_date
  ) VALUES (?, ?, ?, ?, ?)
`).bind(
  userId,
  0.68,
  0.68,
  '2025-10-28',
  '2025-10-31'  // ç•¶æœˆæœ€å¾Œä¸€å¤©
).run();
```

---

### å•é¡Œ6ï¼šä»»å‹™æœªè‡ªå‹•ç”Ÿæˆ

**ç—‡ç‹€ï¼š**
```
æ¯æœˆ 1 æ—¥æ‡‰è‡ªå‹•ç”Ÿæˆä»»å‹™
ä½†æŸäº›å®¢æˆ¶çš„ä»»å‹™æ²’æœ‰ç”Ÿæˆ
```

**è¨ºæ–·æ­¥é©Ÿï¼š**
```sql
-- 1. æª¢æŸ¥å®¢æˆ¶æœå‹™ç‹€æ…‹
SELECT 
  cs.*,
  c.company_name,
  s.service_name
FROM ClientServices cs
JOIN Clients c ON cs.client_id = c.client_id
JOIN Services s ON cs.service_id = s.service_id
WHERE cs.is_deleted = 0
  AND cs.trigger_months LIKE '%10%';  -- ç•¶å‰æœˆä»½

-- 2. æª¢æŸ¥æœå‹™æ˜¯å¦æš«åœ
SELECT * FROM ClientServices 
WHERE status != 'active';

-- 3. æª¢æŸ¥ Cron Job åŸ·è¡Œæ—¥èªŒ
SELECT * FROM AuditLogs 
WHERE action = 'TASK_GENERATION'
ORDER BY created_at DESC 
LIMIT 10;
```

**è§£æ±ºæ–¹æ¡ˆï¼š**
```typescript
// æ‰‹å‹•è§¸ç™¼ä»»å‹™ç”Ÿæˆ
POST /api/v1/admin/tasks/generate-monthly
{
  "year": 2025,
  "month": 10
}

// æˆ–ç›´æ¥åŸ·è¡Œ SQL
// æ ¹æ“šä»»å‹™æ¨¡æ¿ç”Ÿæˆä»»å‹™...
```

---

### å•é¡Œ7ï¼šè£œä¼‘éæœŸæœªè½‰åŠ ç­è²»

**ç—‡ç‹€ï¼š**
```
10/31 çš„è£œä¼‘æ‡‰è©²åœ¨ 11/1 è‡ªå‹•è½‰åŠ ç­è²»
ä½†æ²’æœ‰è½‰æ›
```

**è¨ºæ–·æ­¥é©Ÿï¼š**
```sql
-- æª¢æŸ¥éæœŸè£œä¼‘
SELECT * FROM CompensatoryLeave
WHERE expiry_date = '2025-10-31'
  AND status = 'active'
  AND hours_remaining > 0;

-- æª¢æŸ¥ Cron Job åŸ·è¡Œè¨˜éŒ„
SELECT * FROM AuditLogs
WHERE action = 'COMP_LEAVE_EXPIRATION'
  AND created_at >= '2025-11-01'
ORDER BY created_at DESC;
```

**è§£æ±ºæ–¹æ¡ˆï¼š**
```typescript
// æ‰‹å‹•åŸ·è¡ŒéæœŸè™•ç†
POST /api/v1/admin/compensatory-leave/process-expiry

// æˆ–ç›´æ¥æ›´æ–°æ•¸æ“šåº«
UPDATE CompensatoryLeave
SET status = 'converted',
    converted_to_payment = 1,
    conversion_date = datetime('now'),
    conversion_rate = 1.34
WHERE expiry_date < date('now')
  AND status = 'active'
  AND hours_remaining > 0;
```

---

## ğŸ› ï¸ æ€§èƒ½å•é¡Œæ’æŸ¥

### æ…¢æŸ¥è©¢è¨ºæ–·

```sql
-- é–‹å•ŸæŸ¥è©¢æ—¥èªŒ
PRAGMA query_log = ON;

-- åˆ†ææ…¢æŸ¥è©¢
SELECT * FROM query_log 
WHERE duration_ms > 1000
ORDER BY duration_ms DESC;

-- æª¢æŸ¥ç´¢å¼•ä½¿ç”¨
EXPLAIN QUERY PLAN
SELECT * FROM Clients 
WHERE company_name LIKE '%å…¬å¸%';
```

**å„ªåŒ–å»ºè­°ï¼š**
```sql
-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_clients_company_name ON Clients(company_name);

-- ä½¿ç”¨å…¨æ–‡æœç´¢ï¼ˆå¦‚æœæ”¯æŒï¼‰
CREATE VIRTUAL TABLE clients_fts USING fts5(company_name);
```

---

## ğŸ“Š ç›£æ§æŒ‡æ¨™

### é—œéµæŒ‡æ¨™

```
1. API éŒ¯èª¤ç‡ï¼š< 1%
2. API éŸ¿æ‡‰æ™‚é–“ï¼šP95 < 500ms
3. æ•¸æ“šåº«æŸ¥è©¢æ™‚é–“ï¼šP95 < 100ms
4. ç™»å…¥å¤±æ•—ç‡ï¼š< 5%
5. ç·©å­˜å‘½ä¸­ç‡ï¼š> 80%
```

### å‘Šè­¦è¦å‰‡

```typescript
// Cloudflare Workers Analytics
if (errorRate > 0.01) {
  await sendAlert({
    level: 'warning',
    message: 'API éŒ¯èª¤ç‡è¶…é 1%',
    value: errorRate
  });
}

if (p95ResponseTime > 500) {
  await sendAlert({
    level: 'warning',
    message: 'API éŸ¿æ‡‰æ™‚é–“éæ…¢',
    value: p95ResponseTime
  });
}
```

---

## ğŸ” å®‰å…¨å•é¡Œæ’æŸ¥

### SQL æ³¨å…¥æª¢æ¸¬

```typescript
// æŸ¥æ‰¾å¯ç–‘æŸ¥è©¢æ¨¡å¼
const suspiciousPatterns = [
  "' OR '1'='1",
  "'; DROP TABLE",
  "UNION SELECT",
  "--",
  "/*"
];

// è¨˜éŒ„å¯ç–‘è«‹æ±‚
if (suspiciousPatterns.some(pattern => queryString.includes(pattern))) {
  logger.warn('Potential SQL injection detected', {
    query: queryString,
    ip: clientIp,
    user_id: userId
  });
}
```

### ç•°å¸¸ç™»å…¥åµæ¸¬

```sql
-- æŸ¥æ‰¾ç•°å¸¸ç™»å…¥æ¨¡å¼
SELECT 
  user_id,
  COUNT(*) as attempt_count,
  COUNT(DISTINCT ip_address) as ip_count
FROM AuditLogs
WHERE action = 'LOGIN'
  AND created_at > datetime('now', '-1 hour')
GROUP BY user_id
HAVING attempt_count > 10 OR ip_count > 3;
```

---

**é‡åˆ°å•é¡Œæ™‚ï¼ŒæŒ‰æ­¤æŒ‡å—é€æ­¥æ’æŸ¥ï¼Œå¤§éƒ¨åˆ†å•é¡Œéƒ½èƒ½å¿«é€Ÿè§£æ±ºã€‚**

