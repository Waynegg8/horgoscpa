# éƒ¨ç½²èªªæ˜ - å®Œæ•´ç‰ˆ

**çµ¦ DevOpsï¼š** Cloudflare Workers éƒ¨ç½²å®Œæ•´æŒ‡å—

---

## ğŸ“‹ éƒ¨ç½²å‰æª¢æŸ¥æ¸…å–®

### 1. æº–å‚™è³‡æº

- [ ] Cloudflare å¸³è™Ÿï¼ˆå·²é©—è­‰Emailï¼‰
- [ ] ç¶²åŸŸç¶å®šåˆ° Cloudflare
- [ ] Workers Paid æ–¹æ¡ˆï¼ˆD1éœ€è¦ä»˜è²»æ–¹æ¡ˆï¼‰
- [ ] Wrangler CLI å·²å®‰è£ï¼ˆ`npm install -g wrangler`ï¼‰

### 2. å‰µå»ºè³‡æº

```bash
# ç™»å…¥ Cloudflare
wrangler login

# å‰µå»º D1 è³‡æ–™åº«ï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰
wrangler d1 create horgoscpa
# è¨˜ä¸‹ database_idï¼Œå¡«å…¥ wrangler.toml

# å‰µå»º D1 è³‡æ–™åº«ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
wrangler d1 create horgoscpa-dev
# è¨˜ä¸‹ database_idï¼Œå¡«å…¥ wrangler.toml [env.development]

# å‰µå»º R2 å„²å­˜æ¡¶ï¼ˆå‚™ä»½ï¼‰
wrangler r2 bucket create horgoscpa-backups

# å‰µå»º R2 å„²å­˜æ¡¶ï¼ˆé™„ä»¶ï¼‰
wrangler r2 bucket create horgoscpa-attachments

# å‰µå»º KV å‘½åç©ºé–“ï¼ˆå¿«å–ï¼‰
wrangler kv:namespace create CACHE
# è¨˜ä¸‹ idï¼Œå¡«å…¥ wrangler.toml

# å‰µå»º KV å‘½åç©ºé–“ï¼ˆé è¦½ç’°å¢ƒï¼‰
wrangler kv:namespace create CACHE --preview
# è¨˜ä¸‹ preview_idï¼Œå¡«å…¥ wrangler.toml
```

### 3. åˆå§‹åŒ–è³‡æ–™åº«

```bash
# åŸ·è¡Œè³‡æ–™åº«é·ç§»ï¼ˆå»ºç«‹æ‰€æœ‰è³‡æ–™è¡¨ï¼‰
wrangler d1 execute horgoscpa --file=./schema.sql

# æ’å…¥é è¨­æ•¸æ“š
wrangler d1 execute horgoscpa --file=./seed.sql
```

### 4. è¨­å®šå¯†é‘°

```bash
# ç”Ÿæˆ JWT å¯†é‘°
openssl rand -base64 32

# è¨­å®šç‚ºç’°å¢ƒè®Šæ•¸ï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰
wrangler secret put JWT_SECRET_KEY
# è¼¸å…¥å‰›æ‰ç”Ÿæˆçš„å¯†é‘°

# è¨­å®šç®¡ç†å“¡å¯†ç¢¼
wrangler secret put ADMIN_PASSWORD
```

---

## ğŸš€ éƒ¨ç½²æµç¨‹

### é–‹ç™¼ç’°å¢ƒéƒ¨ç½²

```bash
# 1. å®‰è£ä¾è³´
npm install

# 2. æœ¬åœ°é–‹ç™¼ï¼ˆé€£æ¥é ç«¯ D1ï¼‰
npm run dev
# æˆ–
wrangler dev --remote

# 3. éƒ¨ç½²åˆ°é è¦½ç’°å¢ƒ
wrangler deploy --env preview

# 4. æ¸¬è©¦é è¦½ç’°å¢ƒ
curl https://api-preview.horgoscpa.com/api/v1/auth/me
```

### ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²

```bash
# 1. æ§‹å»ºç”Ÿç”¢ç‰ˆæœ¬
npm run build

# 2. åŸ·è¡Œæ¸¬è©¦
npm test

# 3. éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
wrangler deploy

# 4. é©—è­‰éƒ¨ç½²
curl https://api.horgoscpa.com/api/v1/auth/me

# 5. æª¢æŸ¥ Cron Jobs ç‹€æ…‹
wrangler tail
```

---

## ğŸ“ è³‡æ–™åº«é·ç§»

### schema.sqlï¼ˆå®Œæ•´è³‡æ–™è¡¨ï¼‰

```sql
-- æ­¤æª”æ¡ˆæ‡‰åŒ…å«æ‰€æœ‰è³‡æ–™è¡¨çš„ CREATE TABLE èªå¥ï¼ˆä»¥ SSOT ç‚ºæº–ï¼‰
-- ä¾ç…§ä¾è³´é †åºæ’åˆ—ï¼š

-- 1. åŸºç¤è¡¨ï¼ˆç„¡å¤–éµä¾è³´ï¼‰
CREATE TABLE Users (...);
CREATE TABLE Settings (...);
CREATE TABLE WorkTypes (...);
CREATE TABLE LeaveTypes (...);
-- ... å…¶ä»–åŸºç¤è¡¨

-- 2. ä¾è³´è¡¨ï¼ˆæœ‰å¤–éµï¼‰
CREATE TABLE Clients (...);
CREATE TABLE TimeLogs (...);
CREATE TABLE LeaveApplications (...);
-- ... å…¶ä»–ä¾è³´è¡¨

-- 3. é—œè¯è¡¨
CREATE TABLE ClientTagAssignments (...);
CREATE TABLE ClientServices (...);
-- ... å…¶ä»–é—œè¯è¡¨
```

### seed.sqlï¼ˆé è¨­æ•¸æ“šï¼‰

```sql
-- æ’å…¥é è¨­ç³»çµ±åƒæ•¸
INSERT INTO Settings (setting_key, setting_value, description, is_dangerous) VALUES
('comp_leave_expiry_rule', 'current_month', 'è£œä¼‘æœ‰æ•ˆæœŸè¦å‰‡', 1),
('daily_work_hours_limit', '12', 'æ¯æ—¥å·¥æ™‚ä¸Šé™', 1),
('hourly_wage_base', '240', 'æœˆè–ªåˆ¶æ›ç®—æ™‚æ•¸', 1);

-- æ’å…¥å·¥ä½œé¡å‹ï¼ˆ11ç¨®ï¼‰
INSERT INTO WorkTypes VALUES
(1, 'æ­£å¸¸å·¥æ™‚', 1.0, 0, 0, 0),
(2, 'å¹³æ—¥åŠ ç­ï¼ˆå‰2å°æ™‚ï¼‰', 1.34, 1, 1, 1),
-- ... å…¶ä»–9ç¨®

-- æ’å…¥å‡åˆ¥é¡å‹
INSERT INTO LeaveTypes VALUES
(1, 'ç‰¹ä¼‘', NULL, 1, 1, 0, NULL, 1),
(2, 'ç—…å‡', 30, 1, 1, 1, NULL, 1),
-- ... å…¶ä»–å‡åˆ¥

-- æ’å…¥ç‰¹ä¼‘è¦å‰‡
INSERT INTO AnnualLeaveRules VALUES
(1, 6, 12, 3),
(2, 12, 24, 7),
-- ... å…¶ä»–è¦å‰‡

-- æ’å…¥é è¨­ç®¡ç†å“¡å¸³è™Ÿ
INSERT INTO Users (username, password_hash, name, email, is_admin, gender, start_date) VALUES
('admin', '$2a$10$...', 'ç³»çµ±ç®¡ç†å“¡', 'admin@horgoscpa.com', 1, 'ç”·', '2025-01-01');
```

---

## âš™ï¸ ç’°å¢ƒè®Šæ•¸èªªæ˜

### å¿…è¦è®Šæ•¸

| è®Šæ•¸å | èªªæ˜ | ç¯„ä¾‹å€¼ |
|-------|------|--------|
| `JWT_SECRET_KEY` | JWTç°½åå¯†é‘° | (openssl rand -base64 32) |
| `ENVIRONMENT` | ç’°å¢ƒæ¨™è­˜ | production / development |
| `CORS_ALLOWED_ORIGINS` | å…è¨±çš„ä¾†æº | https://horgoscpa.com |

### é¸ç”¨è®Šæ•¸

| è®Šæ•¸å | èªªæ˜ | é è¨­å€¼ |
|-------|------|--------|
| `SESSION_TIMEOUT_MINUTES` | æœƒè©±è¶…æ™‚æ™‚é–“ | 480ï¼ˆ8å°æ™‚ï¼‰|
| `MAX_LOGIN_ATTEMPTS` | ç™»å…¥å¤±æ•—é–å®šæ¬¡æ•¸ | 5 |
| `LOGIN_LOCK_MINUTES` | é–å®šæ™‚é•· | 15 |

---

## ğŸ” ç›£æ§èˆ‡é™¤éŒ¯

### æŸ¥çœ‹å³æ™‚æ—¥èªŒ

```bash
# å³æ™‚æŸ¥çœ‹ Worker æ—¥èªŒ
wrangler tail

# éæ¿¾ç‰¹å®šé¡å‹
wrangler tail --format json | grep "ERROR"

# æŸ¥çœ‹ Cron Job æ—¥èªŒ
wrangler tail --cron
```

### æŸ¥çœ‹ D1 è³‡æ–™

```bash
# æŸ¥è©¢è³‡æ–™è¡¨
wrangler d1 execute horgoscpa --command="SELECT * FROM Users LIMIT 5"

# æª¢æŸ¥ Cron åŸ·è¡Œè¨˜éŒ„
wrangler d1 execute horgoscpa --command="SELECT * FROM CronJobExecutions ORDER BY executed_at DESC LIMIT 10"
```

### æ‰‹å‹•è§¸ç™¼ Cron Job

```bash
# æœ¬åœ°æ¸¬è©¦ Cron
curl -X POST http://localhost:8787/__scheduled?cron=0+0+1+1+*

# ç”Ÿç”¢ç’°å¢ƒæ‰‹å‹•è§¸ç™¼ï¼ˆä½¿ç”¨APIï¼‰
curl -X POST https://api.horgoscpa.com/api/v1/admin/cron/execute \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"job_name":"annual_leave_update","target_date":"2026-01-01"}'
```

---

## ğŸ”’ å®‰å…¨æ€§æª¢æŸ¥

### éƒ¨ç½²å‰ç¢ºèª

- [ ] JWT_SECRET_KEY å·²è¨­å®šä¸”è¶³å¤ è¤‡é›œ
- [ ] ç®¡ç†å“¡å¯†ç¢¼å·²ä¿®æ”¹ï¼ˆä¸ä½¿ç”¨é è¨­å¯†ç¢¼ï¼‰
- [ ] CORSè¨­å®šæ­£ç¢ºï¼ˆåªå…è¨±è‡ªå·±çš„ç¶²åŸŸï¼‰
- [ ] æ‰€æœ‰ SQL æŸ¥è©¢ä½¿ç”¨åƒæ•¸åŒ–ï¼ˆé˜²æ­¢ SQL æ³¨å…¥ï¼‰
- [ ] API éƒ½æœ‰æ¬Šé™æª¢æŸ¥
- [ ] æ•æ„Ÿè³‡æ–™æœ‰åŠ å¯†ï¼ˆå¯†ç¢¼ä½¿ç”¨bcryptï¼‰

### å®šæœŸæª¢æŸ¥

- [ ] æ¯æœˆæª¢æŸ¥ Cron Job åŸ·è¡Œè¨˜éŒ„
- [ ] æ¯é€±æª¢æŸ¥éŒ¯èª¤æ—¥èªŒ
- [ ] æ¯å­£æª¢æŸ¥è³‡æ–™åº«å¤§å°
- [ ] æ¯å¹´æª¢æŸ¥å‚™ä»½å®Œæ•´æ€§

---

## ğŸ“¦ å‚™ä»½èˆ‡é‚„åŸ

### è‡ªå‹•å‚™ä»½ï¼ˆæ¯å¤©02:00ï¼‰

```typescript
// ç”± Cron Job è‡ªå‹•åŸ·è¡Œ
async function backupDatabase() {
  // 1. åŒ¯å‡ºæ‰€æœ‰è³‡æ–™è¡¨
  const tables = await getAllTables();
  const backup = {};
  
  for (const table of tables) {
    backup[table] = await db.prepare(`SELECT * FROM ${table}`).all();
  }
  
  // 2. å£“ç¸®ä¸¦ä¸Šå‚³åˆ° R2
  const filename = `backup-${new Date().toISOString().split('T')[0]}.json.gz`;
  await env.BACKUP.put(filename, compressData(backup));
  
  // 3. æ¸…ç†10å¹´å‰çš„å‚™ä»½
  const cutoffDate = new Date();
  cutoffDate.setFullYear(cutoffDate.getFullYear() - 10);
  
  await deleteOldBackups(cutoffDate);
}
```

### æ‰‹å‹•é‚„åŸ

```bash
# 1. ä¸‹è¼‰å‚™ä»½æª”
wrangler r2 object get horgoscpa-backups/backup-2025-11-01.json.gz --file=backup.json.gz

# 2. è§£å£“ç¸®
gunzip backup.json.gz

# 3. é‚„åŸåˆ°è³‡æ–™åº«ï¼ˆå°å¿ƒï¼æœƒè¦†è“‹ç¾æœ‰è³‡æ–™ï¼‰
wrangler d1 execute horgoscpa --file=restore.sql
```

---

## ğŸ¯ æ•ˆèƒ½å„ªåŒ–

### D1 é€£ç·šæ± è¨­å®š

```typescript
// src/index.ts
export default {
  async fetch(request, env, ctx) {
    // D1 è‡ªå‹•è™•ç†é€£ç·šæ± ï¼Œç„¡éœ€æ‰‹å‹•è¨­å®š
    return handleRequest(request, env, ctx);
  }
}
```

### R2 å¿«å–ç­–ç•¥

```typescript
// é™„ä»¶å­˜å–åŠ å¿«å–
app.get('/api/v1/attachments/:id', async (req) => {
  const cacheKey = `attachment:${req.params.id}`;
  
  // 1. å…ˆæŸ¥ KV å¿«å–
  const cached = await env.CACHE.get(cacheKey);
  if (cached) {
    return new Response(cached, {
      headers: { 'Cache-Control': 'public, max-age=3600' }
    });
  }
  
  // 2. å¾ R2 è®€å–
  const object = await env.ATTACHMENTS.get(req.params.id);
  const data = await object.arrayBuffer();
  
  // 3. å­˜å…¥å¿«å–ï¼ˆ1å°æ™‚ï¼‰
  await env.CACHE.put(cacheKey, data, { expirationTtl: 3600 });
  
  return new Response(data);
});
```

---

## âš ï¸ æ³¨æ„äº‹é …

1. **D1 é™åˆ¶**ï¼š
   - å…è²»ç‰ˆï¼šæ¯å¤© 100,000 æ¬¡è®€å–ï¼Œ50,000 æ¬¡å¯«å…¥
   - ä»˜è²»ç‰ˆï¼šç„¡é™åˆ¶ï¼ˆæŒ‰ç”¨é‡è¨ˆè²»ï¼‰

2. **R2 é™åˆ¶**ï¼š
   - å…è²»ç‰ˆï¼šæ¯æœˆ 10GB å„²å­˜
   - ä»˜è²»ç‰ˆï¼š$0.015/GB/æœˆ

3. **Workers é™åˆ¶**ï¼š
   - CPU æ™‚é–“ï¼šæ¯æ¬¡è«‹æ±‚æœ€å¤š 50msï¼ˆå¯èª¿æ•´ï¼‰
   - è¨˜æ†¶é«”ï¼š128MB

4. **Cron Jobs é™åˆ¶**ï¼š
   - å…è²»ç‰ˆï¼šæœ€å¤š 3 å€‹ cron è§¸ç™¼å™¨
   - ä»˜è²»ç‰ˆï¼šç„¡é™åˆ¶

---

**é…ç½®æª”æ¡ˆä½ç½®ï¼š** `/wrangler.toml`
**ç›¸é—œæ–‡æª”ï¼š** [è‡ªå‹•åŒ–èªªæ˜.md](./è‡ªå‹•åŒ–èªªæ˜.md)

