# 部署說明 - 完整版

**給 DevOps：** Cloudflare Workers 部署完整指南

---

## 📋 部署前檢查清單

### 1. 準備資源

- [ ] Cloudflare 帳號（已驗證Email）
- [ ] 網域綁定到 Cloudflare
- [ ] Workers Paid 方案（D1需要付費方案）
- [ ] Wrangler CLI 已安裝（`npm install -g wrangler`）

### 2. 創建資源

```bash
# 登入 Cloudflare
wrangler login

# 創建 D1 資料庫（生產環境）
wrangler d1 create horgoscpa
# 記下 database_id，填入 wrangler.toml

# 創建 D1 資料庫（開發環境）
wrangler d1 create horgoscpa-dev
# 記下 database_id，填入 wrangler.toml [env.development]

# 創建 R2 儲存桶（備份）
wrangler r2 bucket create horgoscpa-backups

# 創建 R2 儲存桶（附件）
wrangler r2 bucket create horgoscpa-attachments

# 創建 KV 命名空間（快取）
wrangler kv:namespace create CACHE
# 記下 id，填入 wrangler.toml

# 創建 KV 命名空間（預覽環境）
wrangler kv:namespace create CACHE --preview
# 記下 preview_id，填入 wrangler.toml
```

### 3. 初始化資料庫

```bash
# 執行資料庫遷移（建立所有資料表）
wrangler d1 execute horgoscpa --file=./schema.sql

# 插入預設數據
wrangler d1 execute horgoscpa --file=./seed.sql
```

### 4. 設定密鑰

```bash
# 生成 JWT 密鑰
openssl rand -base64 32

# 設定為環境變數（生產環境）
wrangler secret put JWT_SECRET_KEY
# 輸入剛才生成的密鑰

# 設定管理員密碼
wrangler secret put ADMIN_PASSWORD
```

---

## 🚀 部署流程

### 開發環境部署

```bash
# 1. 安裝依賴
npm install

# 2. 本地開發（連接遠端 D1）
npm run dev
# 或
wrangler dev --remote

# 3. 部署到預覽環境
wrangler deploy --env preview

# 4. 測試預覽環境
curl https://api-preview.horgoscpa.com/api/v1/auth/me
```

### 生產環境部署

```bash
# 1. 構建生產版本
npm run build

# 2. 執行測試
npm test

# 3. 部署到生產環境
wrangler deploy

# 4. 驗證部署
curl https://api.horgoscpa.com/api/v1/auth/me

# 5. 檢查 Cron Jobs 狀態
wrangler tail
```

---

## 📝 資料庫遷移

### schema.sql（完整資料表）

```sql
-- 此檔案應包含所有資料表的 CREATE TABLE 語句（以 SSOT 為準）
-- 依照依賴順序排列：

-- 1. 基礎表（無外鍵依賴）
CREATE TABLE Users (...);
CREATE TABLE Settings (...);
CREATE TABLE WorkTypes (...);
CREATE TABLE LeaveTypes (...);
-- ... 其他基礎表

-- 2. 依賴表（有外鍵）
CREATE TABLE Clients (...);
CREATE TABLE TimeLogs (...);
CREATE TABLE LeaveApplications (...);
-- ... 其他依賴表

-- 3. 關聯表
CREATE TABLE ClientTagAssignments (...);
CREATE TABLE ClientServices (...);
-- ... 其他關聯表
```

### seed.sql（預設數據）

```sql
-- 插入預設系統參數
INSERT INTO Settings (setting_key, setting_value, description, is_dangerous) VALUES
('comp_leave_expiry_rule', 'current_month', '補休有效期規則', 1),
('daily_work_hours_limit', '12', '每日工時上限', 1),
('hourly_wage_base', '240', '月薪制換算時數', 1);

-- 插入工作類型（11種）
INSERT INTO WorkTypes VALUES
(1, '正常工時', 1.0, 0, 0, 0),
(2, '平日加班（前2小時）', 1.34, 1, 1, 1),
-- ... 其他9種

-- 插入假別類型
INSERT INTO LeaveTypes VALUES
(1, '特休', NULL, 1, 1, 0, NULL, 1),
(2, '病假', 30, 1, 1, 1, NULL, 1),
-- ... 其他假別

-- 插入特休規則
INSERT INTO AnnualLeaveRules VALUES
(1, 6, 12, 3),
(2, 12, 24, 7),
-- ... 其他規則

-- 插入預設管理員帳號
INSERT INTO Users (username, password_hash, name, email, is_admin, gender, start_date) VALUES
('admin', '$2a$10$...', '系統管理員', 'admin@horgoscpa.com', 1, '男', '2025-01-01');
```

---

## ⚙️ 環境變數說明

### 必要變數

| 變數名 | 說明 | 範例值 |
|-------|------|--------|
| `JWT_SECRET_KEY` | JWT簽名密鑰 | (openssl rand -base64 32) |
| `ENVIRONMENT` | 環境標識 | production / development |
| `CORS_ALLOWED_ORIGINS` | 允許的來源 | https://horgoscpa.com |

### 選用變數

| 變數名 | 說明 | 預設值 |
|-------|------|--------|
| `SESSION_TIMEOUT_MINUTES` | 會話超時時間 | 480（8小時）|
| `MAX_LOGIN_ATTEMPTS` | 登入失敗鎖定次數 | 5 |
| `LOGIN_LOCK_MINUTES` | 鎖定時長 | 15 |

---

## 🔍 監控與除錯

### 查看即時日誌

```bash
# 即時查看 Worker 日誌
wrangler tail

# 過濾特定類型
wrangler tail --format json | grep "ERROR"

# 查看 Cron Job 日誌
wrangler tail --cron
```

### 查看 D1 資料

```bash
# 查詢資料表
wrangler d1 execute horgoscpa --command="SELECT * FROM Users LIMIT 5"

# 檢查 Cron 執行記錄
wrangler d1 execute horgoscpa --command="SELECT * FROM CronJobExecutions ORDER BY executed_at DESC LIMIT 10"
```

### 手動觸發 Cron Job

```bash
# 本地測試 Cron
curl -X POST http://localhost:8787/__scheduled?cron=0+0+1+1+*

# 生產環境手動觸發（使用API）
curl -X POST https://api.horgoscpa.com/api/v1/admin/cron/execute \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"job_name":"annual_leave_update","target_date":"2026-01-01"}'
```

---

## 🔒 安全性檢查

### 部署前確認

- [ ] JWT_SECRET_KEY 已設定且足夠複雜
- [ ] 管理員密碼已修改（不使用預設密碼）
- [ ] CORS設定正確（只允許自己的網域）
- [ ] 所有 SQL 查詢使用參數化（防止 SQL 注入）
- [ ] API 都有權限檢查
- [ ] 敏感資料有加密（密碼使用bcrypt）

### 定期檢查

- [ ] 每月檢查 Cron Job 執行記錄
- [ ] 每週檢查錯誤日誌
- [ ] 每季檢查資料庫大小
- [ ] 每年檢查備份完整性

---

## 📦 備份與還原

### 自動備份（每天02:00）

```typescript
// 由 Cron Job 自動執行
async function backupDatabase() {
  // 1. 匯出所有資料表
  const tables = await getAllTables();
  const backup = {};
  
  for (const table of tables) {
    backup[table] = await db.prepare(`SELECT * FROM ${table}`).all();
  }
  
  // 2. 壓縮並上傳到 R2
  const filename = `backup-${new Date().toISOString().split('T')[0]}.json.gz`;
  await env.BACKUP.put(filename, compressData(backup));
  
  // 3. 清理10年前的備份
  const cutoffDate = new Date();
  cutoffDate.setFullYear(cutoffDate.getFullYear() - 10);
  
  await deleteOldBackups(cutoffDate);
}
```

### 手動還原

```bash
# 1. 下載備份檔
wrangler r2 object get horgoscpa-backups/backup-2025-11-01.json.gz --file=backup.json.gz

# 2. 解壓縮
gunzip backup.json.gz

# 3. 還原到資料庫（小心！會覆蓋現有資料）
wrangler d1 execute horgoscpa --file=restore.sql
```

---

## 🎯 效能優化

### D1 連線池設定

```typescript
// src/index.ts
export default {
  async fetch(request, env, ctx) {
    // D1 自動處理連線池，無需手動設定
    return handleRequest(request, env, ctx);
  }
}
```

### R2 快取策略

```typescript
// 附件存取加快取
app.get('/api/v1/attachments/:id', async (req) => {
  const cacheKey = `attachment:${req.params.id}`;
  
  // 1. 先查 KV 快取
  const cached = await env.CACHE.get(cacheKey);
  if (cached) {
    return new Response(cached, {
      headers: { 'Cache-Control': 'public, max-age=3600' }
    });
  }
  
  // 2. 從 R2 讀取
  const object = await env.ATTACHMENTS.get(req.params.id);
  const data = await object.arrayBuffer();
  
  // 3. 存入快取（1小時）
  await env.CACHE.put(cacheKey, data, { expirationTtl: 3600 });
  
  return new Response(data);
});
```

---

## ⚠️ 注意事項

1. **D1 限制**：
   - 免費版：每天 100,000 次讀取，50,000 次寫入
   - 付費版：無限制（按用量計費）

2. **R2 限制**：
   - 免費版：每月 10GB 儲存
   - 付費版：$0.015/GB/月

3. **Workers 限制**：
   - CPU 時間：每次請求最多 50ms（可調整）
   - 記憶體：128MB

4. **Cron Jobs 限制**：
   - 免費版：最多 3 個 cron 觸發器
   - 付費版：無限制

---

**配置檔案位置：** `/wrangler.toml`
**相關文檔：** [自動化說明.md](./自動化說明.md)

