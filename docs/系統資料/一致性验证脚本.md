# 一致性验证方法

**目的：** 确保所有文档的一致性，不依赖硬编码数字

**核心原则：单一真相源（SSOT - Single Source of Truth）**

---

## 📌 单一真相源（SSOT）

### 定义
**只在一个地方定义真相，其他所有地方都必须与它一致。**

### 真相源文件

| 数据类型 | 真相源文件 | 说明 |
|---------|----------|------|
| 资料表总数 | `系統資料/數據表清單.md` | 唯一定义资料表数量的地方 |
| API总数 | `系統資料/API清單.md` | 唯一定义API数量的地方 |
| 功能列表 | `完整功能清單.md` | 所有功能的完整列表 |

### 验证原则

**当你修改数字时：**
1. ✅ **只在SSOT文件中修改**
2. ✅ **检查所有其他文档是否与SSOT一致**
3. ✅ **如果不一致，更新它们**

**示例：新增一个资料表**
```
1. 在 數據表清單.md 中：
   - 添加新表的定义
   - 更新总数：28個 → 29個

2. 检查以下文件，确保数字一致：
   - docs/README.md
   - 開發指南/README.md  
   - 完整功能清單.md
   - 所有提到资料表数量的文档

3. 使用搜索验证：
   grep -r "28個.*表" docs/
   → 不应该有任何结果
```

---

## 🔍 验证方法

### 方法1：检查数字统计是否一致

```bash
# Windows PowerShell
$tables = @()
$apis = @()

# 提取所有提到"表"的数字
Get-ChildItem -Path "docs" -Filter "*.md" -Recurse | ForEach-Object {
    $content = Get-Content $_.FullName -Raw
    if ($content -match '(\d+)\s*個.*?表') {
        $tables += @{File=$_.Name; Count=$matches[1]}
    }
    if ($content -match '(\d+)\s*個.*?API') {
        $apis += @{File=$_.Name; Count=$matches[1]}
    }
}

# 检查是否所有数字一致
$tableCount = $tables | Select-Object -ExpandProperty Count -Unique
$apiCount = $apis | Select-Object -ExpandProperty Count -Unique

if ($tableCount.Count -gt 1) {
    Write-Host "❌ 资料表数字不一致！" -ForegroundColor Red
    $tables | Format-Table
} else {
    Write-Host "✅ 资料表数字一致：$tableCount 個" -ForegroundColor Green
}

if ($apiCount.Count -gt 1) {
    Write-Host "❌ API数字不一致！" -ForegroundColor Red
    $apis | Format-Table
} else {
    Write-Host "✅ API数字一致：$apiCount 個" -ForegroundColor Green
}
```

---

### 方法2：验证单一真相源（SSOT）

**原则：** 只在一个地方定义真相，其他地方都引用它

**单一真相源文件：**
- `系統資料/數據表清單.md` - 唯一定义资料表总数的地方
- `系統資料/API清單.md` - 唯一定义API总数的地方

**验证脚本：**
```bash
# 1. 从SSOT文件中提取真相
$tableFile = Get-Content "docs\系統資料\數據表清單.md" -Raw
$apiFile = Get-Content "docs\系統資料\API清單.md" -Raw

$tableFile -match '資料表總覽[（(](\d+)個[）)]'
$truthTables = $matches[1]

$apiFile -match '總計[：:]\s*約?\s*(\d+)\s*個'
$truthAPIs = $matches[1]

Write-Host "單一真相源："
Write-Host "  資料表：$truthTables 個" -ForegroundColor Cyan
Write-Host "  API：$truthAPIs 個" -ForegroundColor Cyan

# 2. 检查其他文件是否与SSOT一致
$errors = @()

Get-ChildItem -Path "docs" -Filter "*.md" -Recurse | ForEach-Object {
    if ($_.Name -notlike "*數據表清單.md" -and $_.Name -notlike "*API清單.md") {
        $content = Get-Content $_.FullName -Raw
        
        # 检查表的数字
        if ($content -match '(\d+)\s*個.*?表') {
            if ($matches[1] -ne $truthTables) {
                $errors += "$($_.Name): 表数字 $($matches[1]) ≠ $truthTables"
            }
        }
        
        # 检查API的数字
        if ($content -match '(\d+)\s*個.*?API') {
            if ($matches[1] -ne $truthAPIs) {
                $errors += "$($_.Name): API数字 $($matches[1]) ≠ $truthAPIs"
            }
        }
    }
}

if ($errors.Count -eq 0) {
    Write-Host "`n✅ 所有文档与单一真相源一致！" -ForegroundColor Green
} else {
    Write-Host "`n❌ 发现 $($errors.Count) 个不一致：" -ForegroundColor Red
    $errors | ForEach-Object { Write-Host "  $_" -ForegroundColor Yellow }
}
```

---

### 方法3：验证交叉引用对称性

```bash
# 检查所有"相關功能"的双向引用
$files = Get-ChildItem -Path "docs\使用手冊" -Filter "*.md"
$references = @{}

foreach ($file in $files) {
    $content = Get-Content $file.FullName -Raw
    $name = $file.BaseName
    
    # 提取所有引用
    $matches = [regex]::Matches($content, '\[([^\]]+)\]\(\./([^\)]+)\.md\)')
    $refs = $matches | ForEach-Object { $_.Groups[2].Value }
    
    $references[$name] = $refs
}

# 检查对称性
$asymmetric = @()
foreach ($source in $references.Keys) {
    foreach ($target in $references[$source]) {
        # 如果A引用B，检查B是否引用A
        if ($references.ContainsKey($target)) {
            if ($references[$target] -notcontains $source) {
                $asymmetric += "$source → $target (但 $target 没有引用 $source)"
            }
        }
    }
}

if ($asymmetric.Count -eq 0) {
    Write-Host "✅ 所有交叉引用都是对称的！" -ForegroundColor Green
} else {
    Write-Host "❌ 发现 $($asymmetric.Count) 个不对称引用：" -ForegroundColor Red
    $asymmetric | ForEach-Object { Write-Host "  $_" -ForegroundColor Yellow }
}
```

---

### 方法4：验证格式一致性

```bash
# 检查同类文档是否使用相同的章节结构
$specs = Get-ChildItem -Path "docs\開發指南" -Filter "*-完整規格.md"
$structures = @{}

foreach ($spec in $specs) {
    $content = Get-Content $spec.FullName
    $headers = $content | Where-Object { $_ -match '^##\s+' } | ForEach-Object { $_ -replace '^##\s+', '' }
    $structures[$spec.Name] = $headers -join "|"
}

# 检查是否所有完整规格都有相同的结构
$uniqueStructures = $structures.Values | Select-Object -Unique

if ($uniqueStructures.Count -eq 1) {
    Write-Host "✅ 所有完整规格文档结构一致！" -ForegroundColor Green
} else {
    Write-Host "❌ 完整规格文档结构不一致：" -ForegroundColor Red
    $structures.GetEnumerator() | ForEach-Object {
        Write-Host "  $($_.Key): $($_.Value)" -ForegroundColor Yellow
    }
}
```

---

## 🧪 手动验证步骤（AI必须执行）

### 步骤1：提取SSOT真相

```powershell
# 1. 查看资料表真相源
Get-Content "docs\系統資料\數據表清單.md" | Select-String "資料表總覽"
# 输出：## 📊 資料表總覽（49個）
# → 真相：49個

# 2. 查看API真相源  
Get-Content "docs\系統資料\API清單.md" | Select-String "總計"
# 输出：**總計：約 147 個 API 端點**
# → 真相：147個
```

### 步骤2：搜索所有提到的数字

```powershell
# 搜索所有提到"表"数字的地方
Get-ChildItem -Path "docs" -Filter "*.md" -Recurse | Select-String "個.*表" | Where-Object { $_.Line -match '\d+個' }

# 搜索所有提到"API"数字的地方
Get-ChildItem -Path "docs" -Filter "*.md" -Recurse | Select-String "個.*API" | Where-Object { $_.Line -match '\d+個' }
```

### 步骤3：检查一致性

**所有结果都必须与SSOT一致！**
- 如果看到不同的数字（如：45個表、98個API），立即修复
- 直到所有数字都一致（49個表、147個API）

### 步骤4：验证交叉引用

```powershell
# 检查使用手冊中的交叉引用
Get-ChildItem "docs\使用手冊" -Filter "*.md" | ForEach-Object {
    $name = $_.BaseName
    Write-Host "`n=== $name ===" -ForegroundColor Cyan
    Get-Content $_.FullName | Select-String "相關功能" -Context 0,10
}
```

**检查规则：**
- 如果A引用B，B也必须引用A（对称性）
- 所有功能文档都必须有"相關功能"部分（除了README和快速开始）

---

## 📝 一致性检查清单（AI必须逐项确认）

完成开发后，逐项检查：

### ✅ 数字统计一致性
- [ ] 从SSOT提取真实数字（資料表、API）
- [ ] 搜索所有文档中的相关数字
- [ ] 确认所有数字与SSOT一致
- [ ] 如有不一致，立即修复

### ✅ 交叉引用对称性  
- [ ] 列出所有修改/新增的文档
- [ ] 检查它们的"相關功能"部分
- [ ] 确认双向引用（A→B 且 B→A）
- [ ] 补充缺失的引用

### ✅ 格式规范一致性
- [ ] 检查同类文档的章节结构
- [ ] 检查完整规格的结尾格式
- [ ] 确保统一的格式规范

### ✅ 完整性检查
- [ ] 所有使用手册都有"相關功能"
- [ ] 所有完整规格都有必要章节
- [ ] 所有新增功能都有对应文档

---

## 🎯 简化验证命令（推荐）

```powershell
# 快速检查：查找可能的不一致
cd docs

# 查找所有数字统计
Get-ChildItem -Filter "*.md" -Recurse | Select-String "個.*[表API]" | ForEach-Object {
    if ($_.Line -match '(\d+)個') {
        "$($_.FileName): $($matches[1])個"
    }
} | Sort-Object | Get-Unique

# 如果看到多个不同的数字，说明不一致！
```

---

**AI开发完成后必须手动执行这些检查，不能跳过！**

