# 16 - 任務進度追蹤

**所屬模塊：** 任務追蹤系統  
**頁面路徑：** `/tasks`  
**權限：** 所有員工（取決於 `module_visibility_tasks`）  
**最後更新：** 2025年10月27日

---

## 功能概述

查看指派給自己的所有任務，支援看板視圖和列表視圖。

---

## 看板視圖

```
我的任務
───────────────────────
┌─待開始─┬─進行中─┬─已完成─┬─逾期─┐
│ 宏達   │ 仟鑽   │ 新創   │ 大成 │
│ 0% ░░  │ 50% ██ │ 100% ██│ 75% █│
│ 剩15天 │ 剩8天  │ 已完成 │ 逾5天│
└────────┴────────┴────────┴──────┘
```

---

## 列表視圖

```
| 客戶 | 任務      | 進度 | 到期     | 狀態   |
|------|-----------|------|----------|--------|
| 仟鑽 | 記帳-9-10 | 50%  | 11-15    | 🟡進行中|
| 宏達 | 工商-11   | 0%   | 11-20    | ⚪待開始|
```

---

## 篩選功能

- 客戶篩選
- 狀態篩選
- 月份篩選

---

## API

```
GET /api/v1/tasks?status=進行中&page=1
```

---

## 批量操作

### 批量更新階段狀態

**使用場景：** 10 個客戶都完成「資料收集」階段，一次全部標記完成

**UI 設計：**
```
任務管理（列表視圖）
───────────────────────────────────
[批量操作 ▼]

☑ 仟鑽-記帳-9-10月   階段1: 資料收集  [進行中]
☑ 宏達-記帳-9-10月   階段1: 資料收集  [進行中]
☑ 新創-記帳-9-10月   階段1: 資料收集  [進行中]
☐ 大成-稅務-10月     階段2: 稅額計算  [進行中]

已選擇 3 個任務的相同階段

[批量標記為「已完成」]
```

**API：**
```
POST /api/v1/tasks/stages/batch-update
Body: {
  "stage_ids": [1, 5, 9],
  "status": "已完成",
  "notes": "批量完成"
}
```

**後端邏輯：**
```typescript
async function batchUpdateStages(stageIds: number[], status: string, notes?: string) {
  const completedDate = new Date().toISOString().split('T')[0];
  
  for (const stageId of stageIds) {
    await db.prepare(`
      UPDATE ActiveTaskStages 
      SET status = ?, completed_date = ?, notes = ?
      WHERE active_stage_id = ?
    `).bind(status, completedDate, notes, stageId).run();
  }
  
  return { updated_count: stageIds.length };
}
```

---

### 批量指派客戶

**使用場景：** 員工離職，將其負責的 20 個客戶轉給其他人

**UI 設計：**
```
客戶管理
───────────────────────────────────
負責員工篩選：[已離職員工 ▼]

☑ 仟鑽企業
☑ 宏達公司
☑ 新創科技
... (共 20 筆)

已選擇 20 個客戶

[批量重新指派]

┌─ 批量指派客戶 ─────────┐
│ 新負責人：[凱閔 ▼]     │
│ [確定] [取消]           │
└────────────────────────┘
```

**API：**
```
POST /api/v1/clients/batch-reassign
Body: {
  "client_ids": ["12345678", "87654321", ...],
  "new_assignee_id": 3
}
```

**後端邏輯：**
```typescript
async function batchReassignClients(clientIds: string[], newAssigneeId: number) {
  for (const clientId of clientIds) {
    await db.prepare(`
      UPDATE Clients 
      SET assignee_user_id = ?, updated_at = datetime('now')
      WHERE client_id = ?
    `).bind(newAssigneeId, clientId).run();
    
    // 同時更新該客戶的所有執行中任務
    await db.prepare(`
      UPDATE ActiveTasks 
      SET assigned_user_id = ?
      WHERE client_id = ? AND status IN ('進行中', '待開始')
    `).bind(newAssigneeId, clientId).run();
  }
  
  return { updated_count: clientIds.length };
}
```

---

**相關：** [任務API](../API設計/任務API.md), [階段進度更新](./17-階段進度更新.md), [客戶API](../API設計/客戶API.md)

