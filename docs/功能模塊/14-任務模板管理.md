# 14 - 任務模板管理

**所屬模塊：** 任務追蹤系統（僅管理員）  
**頁面路徑：** `/settings/task-templates`  
**最後更新：** 2025年10月27日

---

## 功能概述

建立標準化任務流程模板，定義各階段名稱和預計天數。

---

## UI 設計

```
任務模板管理
───────────────────────
[+ 新增模板]

┌─ 記帳標準流程（雙月） ───┐
│ 關聯服務：記帳服務        │
│                          │
│ 階段：                   │
│ 1. 資料收集 (3天)        │
│ 2. 營業稅過帳 (2天)      │
│ 3. 提列折舊 (1天)        │
│ 4. 報表產出 (2天)        │
│                          │
│ 總計：8天                │
│ [編輯] [刪除]            │
└──────────────────────────┘
```

---

## 資料表

- `TaskTemplates`
- `TaskStageTemplates`

---

## API

```
GET    /api/v1/task-templates
POST   /api/v1/task-templates
PUT    /api/v1/task-templates/:id
DELETE /api/v1/task-templates/:id
```

---

## 階段依賴關係設定

**功能：** 定義階段執行順序，某階段必須在另一階段完成後才能開始

**UI 設計（新增階段時）：**
```
新增階段
───────────────────────────
階段名稱：[提列折舊           ]
預計天數：[1] 天
階段順序：3

依賴階段：[階段 2：營業稅過帳 ▼]
          (選填，此階段必須在依賴階段完成後才能開始)

說明：    [計算並提列折舊       ]

[確定] [取消]
```

**資料表欄位：**
```sql
ALTER TABLE TaskStageTemplates ADD COLUMN depends_on INTEGER;
```

**實際運作：**
```
任務詳情頁面：

1. ✅ 資料收集  [已完成]

2. 🟢 營業稅過帳  [進行中]

3. 🔒 提列折舊  [未開始]
   ⚠️ 需先完成「階段 2：營業稅過帳」
   [開始此階段] (按鈕禁用)

員工想點擊「開始」
    ↓
系統檢查：depends_on = 2（階段 2）
    ↓
檢查階段 2 狀態：status = '進行中'（未完成）
    ↓
❌ 提示：「需先完成營業稅過帳」
```

**後端邏輯：**
```typescript
// services/task.service.ts
async function canStartStage(stageId: number): Promise<boolean> {
  const stage = await getStage(stageId);
  
  if (!stage.depends_on) {
    return true;  // 沒有依賴，可直接開始
  }
  
  // 檢查依賴階段是否已完成
  const dependentStage = await getStageByTemplateId(stage.depends_on);
  return dependentStage.status === '已完成';
}
```

---

**相關：** [任務API](../API設計/任務API.md), [客戶服務設定](./15-客戶服務設定.md), [階段進度更新](./17-階段進度更新.md)

