# 14 - 任務模板管理

**所屬模塊：** 任務追蹤系統（僅管理員）  
**頁面路徑：** `/settings/task-templates`  
**權限：** 管理員  
**最後更新：** 2025年10月27日

---

## 功能概述

建立標準化任務流程模板，定義各階段名稱、預計天數、階段依賴關係。系統會根據模板自動建立任務實例。

**核心特點：**
- ✓ 定義標準化工作流程
- ✓ 設定各階段預計天數
- ✓ 支援階段依賴關係（必須完成前置階段）
- ✓ 可關聯特定服務項目
- ✓ 自動計算總預計天數
- ✓ 複製模板快速建立新版本

---

## 使用場景

### 場景 1：建立記帳服務流程模板

事務所想標準化記帳服務流程。

**操作：**
1. 進入任務模板管理頁面
2. 點擊「新增模板」
3. 輸入模板名稱：「記帳標準流程（雙月）」
4. 選擇關聯服務：「記帳服務」
5. 新增階段：
   - 階段1：資料收集（3天）
   - 階段2：營業稅過帳（2天，依賴階段1）
   - 階段3：提列折舊（1天，依賴階段2）
   - 階段4：報表產出（2天，依賴階段3）
6. 系統自動計算總天數：8天
7. 點擊「儲存」

**結果：**
- 建立模板，可重複使用
- 自動建立任務時套用此流程

---

## UI 設計

```
任務模板管理
───────────────────────
[+ 新增模板]

┌─ 記帳標準流程（雙月） ───┐
│ 關聯服務：記帳服務        │
│                          │
│ 階段：                   │
│ 1. 資料收集 (3天)        │
│ 2. 營業稅過帳 (2天)      │
│ 3. 提列折舊 (1天)        │
│ 4. 報表產出 (2天)        │
│                          │
│ 總計：8天                │
│ [編輯] [刪除]            │
└──────────────────────────┘
```

---

## 資料表

- `TaskTemplates`
- `TaskStageTemplates`

---

## API

```
GET    /api/v1/task-templates
POST   /api/v1/task-templates
PUT    /api/v1/task-templates/:id
DELETE /api/v1/task-templates/:id
```

---

## 階段依賴關係設定

**功能：** 定義階段執行順序，某階段必須在另一階段完成後才能開始

**UI 設計（新增階段時）：**
```
新增階段
───────────────────────────
階段名稱：[提列折舊           ]
預計天數：[1] 天
階段順序：3

依賴階段：[階段 2：營業稅過帳 ▼]
          (選填，此階段必須在依賴階段完成後才能開始)

說明：    [計算並提列折舊       ]

[確定] [取消]
```

**資料表欄位：**
```sql
ALTER TABLE TaskStageTemplates ADD COLUMN depends_on INTEGER;
```

**實際運作：**
```
任務詳情頁面：

1. ✅ 資料收集  [已完成]

2. 🟢 營業稅過帳  [進行中]

3. 🔒 提列折舊  [未開始]
   ⚠️ 需先完成「階段 2：營業稅過帳」
   [開始此階段] (按鈕禁用)

員工想點擊「開始」
    ↓
系統檢查：depends_on = 2（階段 2）
    ↓
檢查階段 2 狀態：status = '進行中'（未完成）
    ↓
❌ 提示：「需先完成營業稅過帳」
```

**後端邏輯：**
```typescript
// services/task.service.ts
async function canStartStage(stageId: number): Promise<boolean> {
  const stage = await getStage(stageId);
  
  if (!stage.depends_on) {
    return true;  // 沒有依賴，可直接開始
  }
  
  // 檢查依賴階段是否已完成
  const dependentStage = await getStageByTemplateId(stage.depends_on);
  return dependentStage.status === '已完成';
}
```

---

## 整合關聯

### 與客戶服務設定整合
- 客戶服務可關聯任務模板
- 自動建立任務時套用模板流程

### 與任務追蹤整合
- 建立任務實例時複製模板階段
- 實例可獨立修改，不影響模板

### 與階段進度更新整合
- 階段依賴關係自動執行
- 必須完成前置階段才能開始

---

## 技術規格文檔索引

### 詳細設計
- [UI 設計](../../技術規格/任務模板/UI設計.md) - 介面設計與互動
- [業務邏輯](../../技術規格/任務模板/業務邏輯.md) - 核心邏輯與規則
- [測試案例](../../技術規格/任務模板/測試案例.md) - 測試場景

---

## API 規格索引

- [任務模板 API](../../API規格/任務管理/_概覽.md) - API 端點總覽

---

## 資料表索引

- [TaskTemplates](../../資料庫設計/任務系統/TaskTemplates.md) - 任務模板資料表
- [TaskStageTemplates](../../資料庫設計/任務系統/TaskStageTemplates.md) - 階段模板資料表

---

## 相關文檔

- [客戶服務設定](./15-客戶服務設定.md) - 關聯任務模板
- [任務進度追蹤](./16-任務進度追蹤.md) - 使用模板建立任務
- [階段進度更新](./17-階段進度更新.md) - 執行模板定義的階段

---

**最後更新：** 2025年10月27日  
**文檔版本：** 2.0（模塊化重組版）

