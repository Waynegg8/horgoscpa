# 10 - 報表中心

**所屬模塊：** 工時表與報表  
**頁面路徑：** `/reports`  
**權限：** 所有使用者  
**最後更新：** 2025年10月27日

---

## 功能概述

產生多維度工時統計報表，支援模塊化報表服務，提供詳細的加權工時明細分析。

---

## 報表模塊化架構

**後端檔案結構：**
```
/worker/src/services/reports/
├── timesheet.report.ts      # 工時報表（含詳細加權明細）
├── client.report.ts         # 客戶分析報表
├── efficiency.report.ts     # 效率分析報表
├── financial.report.ts      # 財務報表
└── trend.report.ts          # 趨勢分析報表
```

---

## 可用報表

### 10.1 員工工時統計（按業務類型 - 詳細版）

**報表格式：**
```
員工工時統計報表 - 2025年11月 - 紜蓁
═══════════════════════════════════════════════════════════

【記帳業務】
  正常工時：        60.0h  (加權  60.0h   × 1.00)
  平日加班(1.34)：   10.0h  (加權  13.4h   × 1.34)
  平日加班(1.67)：    2.0h  (加權   3.34h  × 1.67)
  假日加班(2.0)：     0.0h  (加權   0.0h   × 2.00)
  ─────────────────────────────────────────────────
  業務小計：        72.0h  (加權  76.74h)

【工商業務】
  正常工時：        18.0h  (加權  18.0h   × 1.00)
  平日加班(1.34)：    0.0h  (加權   0.0h   × 1.34)
  假日加班(2.0)：     2.0h  (加權   4.0h   × 2.00)
  ─────────────────────────────────────────────────
  業務小計：        20.0h  (加權  22.0h)

【稅務業務】
  正常工時：        16.0h  (加權  16.0h   × 1.00)
  平日加班(1.34)：    0.0h  (加權   0.0h   × 1.34)
  ─────────────────────────────────────────────────
  業務小計：        16.0h  (加權  16.0h)

═══════════════════════════════════════════════════════════
【總計】
  原始工時總計：   108.0h
  加權工時總計：   114.74h
  加權工時占比：   106.2%

【加班分析】
  正常工時：        94.0h  (87.0%)
  平日加班(1.34)：   10.0h  ( 9.3%)
  平日加班(1.67)：    2.0h  ( 1.9%)
  假日加班(2.0)：     2.0h  ( 1.9%)
```

**用途：**
- 精確計算人力成本（各業務的正常工時成本 vs 加班成本）
- 分析加班狀況（是否集中在特定業務）
- 成本控制（加班成本占比分析）

---

### 10.2 客戶服務分析（投入工時 vs 收費）

**報表格式：**
```
客戶服務分析報表 - 2025年11月
═══════════════════════════════════════════════════════════════════════════
| 客戶   | 服務 | 原始工時 | 加權工時 | 收費      | 時薪假設 | 成本估算 | 效益比 | 評估      |
|--------|------|----------|----------|-----------|----------|----------|--------|-----------|
| 仟鑽   | 記帳 | 20.0h    | 22.5h    | 15,000    | 500/h    | 11,250   | 1.33   | ✅ 獲利    |
| 宏達   | 記帳 | 35.0h    | 40.0h    | 20,000    | 500/h    | 20,000   | 1.00   | ⚠️ 持平    |
| 新創   | 工商 | 15.0h    | 15.0h    | 30,000    | 500/h    | 7,500    | 4.00   | ✅✅ 高獲利 |
| 大成   | 稅務 | 25.0h    | 30.0h    | 12,000    | 500/h    | 15,000   | 0.80   | ❌ 虧損    |

效益比 = 收費 / (加權工時 × 時薪假設)
```

**用途：**
- 找出獲利/虧損客戶
- 決定是否調整收費或優化流程
- 評估客戶價值

---

### 10.3 業務類型分佈

**圓餅圖（本月）：**
```
本月工時分佈
─────────────
    記帳 60%  ████
    工商 25%  ██
    稅務 15%  █
```

**折線圖（趨勢）：**
```
服務類型分佈趨勢 - 2025年
─────────────────────────────
工時(h)
 100│   記帳 ──────
  80│        ╱╲    ╱╲
  60│       ╱  ╲  ╱  ╲
  40│ 工商 ────────── 
  20│      ╱     ╲╱    ╲
   0│─────────────────────
     1  2  3  4  5  6  7  月份
```

**數據表格：**
```
| 月份 | 記帳(h) | 工商(h) | 稅務(h) | 總計  |
|------|---------|---------|---------|-------|
| 1月  | 180     | 60      | 40      | 280   |
| 2月  | 160     | 70      | 50      | 280   |
| 3月  | 200     | 50      | 30      | 280   |
...
```

**預測分析：**
```
基於過去 6 個月數據預測：
下月(12月)工時需求預估：
  記帳業務：約 190h
  工商業務：約 65h
  稅務業務：約 45h
```

---

### 10.4 月度/季度/年度業務報告

**綜合性報告：**
```
2025年11月業務報告
═══════════════════════════════════════════════════════════

【工時總覽】
  總原始工時：     320.0h
  總加權工時：     346.1h
  加權比例：       108.2%

【業務分佈】（加權工時）
  記帳服務：       65%  (原始 208.0h → 加權 225.0h)
  工商服務：       25%  (原始  80.0h → 加權  85.0h)
  稅務服務：       10%  (原始  32.0h → 加權  36.1h)

【收費統計】
  總收費：         NT$ 450,000
  平均時薪：       NT$ 1,300 (以加權工時計算)

【前五大客戶】（按加權工時排序）
  1. 仟鑽企業      40.0h  (加權 45.0h)   NT$ 60,000   效益比 1.33
  2. 宏達公司      35.0h  (加權 40.0h)   NT$ 50,000   效益比 1.25
  3. 新創科技      30.0h  (加權 32.5h)   NT$ 45,000   效益比 1.38
  4. 大成集團      28.0h  (加權 30.0h)   NT$ 42,000   效益比 1.40
  5. 台灣企業      25.0h  (加權 28.0h)   NT$ 38,000   效益比 1.36

【效率分析】
  高獲利客戶(效益比>1.5)：   5 家
  正常客戶(效益比1.0-1.5)：  8 家
  需檢討客戶(效益比<1.0)：   2 家 ⚠️

【加班分析】
  正常工時：       280.0h  (87.5%)
  平日加班(1.34)：  30.0h  ( 9.4%)
  平日加班(1.67)：   6.0h  ( 1.9%)
  假日加班(2.0)：    4.0h  ( 1.3%)
```

---

### 10.5 假期使用率統計

**報表格式：**
```
假期使用率統計 - 2025年
═══════════════════════════════════════

| 員工 | 特休使用率 | 病假使用率 | 事假使用率 | 總請假天數 |
|------|------------|------------|------------|------------|
| 紜蓁 | 50% (28/56h)| 10% (24/240h)| 30% (34/112h)| 10.75天 |
| 凱閔 | 80% (45/56h)| 5% (12/240h) | 20% (22/112h)| 9.875天 |
| 欣怡 | 30% (17/56h)| 15% (36/240h)| 10% (11/112h)| 8天     |
```

---

## SQL 查詢範例

### 員工工時統計（含加權明細）

```sql
SELECT 
  u.name as employee_name,
  t.business_type,
  t.work_type,
  SUM(t.hours) as total_hours,
  SUM(t.weighted_hours) as total_weighted_hours,
  o.rate
FROM TimeLogs t
JOIN Users u ON t.user_id = u.user_id
LEFT JOIN OvertimeRates o ON t.work_type LIKE '%' || o.overtime_type || '%'
WHERE strftime('%Y-%m', t.work_date) = ?
  AND t.is_deleted = 0
  AND t.leave_type IS NULL
GROUP BY u.user_id, u.name, t.business_type, t.work_type
ORDER BY u.name, t.business_type, t.work_type;
```

---

## API 端點

```
GET /api/v1/reports/timesheet?type=employee&month=2025-11&detailed=true
GET /api/v1/reports/timesheet?type=client&month=2025-11
GET /api/v1/reports/business-distribution?period=2025-Q3
GET /api/v1/reports/trend?type=service&start=2025-01&end=2025-12
GET /api/v1/reports/comprehensive?period=2025-11
GET /api/v1/reports/prediction?month=2025-12
```

**回應範例（員工工時統計 - 詳細版）：**
```json
{
  "success": true,
  "data": {
    "employee": {
      "user_id": 2,
      "name": "紜蓁"
    },
    "month": "2025-11",
    "by_business_type": {
      "記帳": {
        "breakdown": [
          {
            "work_type": "正常工時",
            "hours": 60.0,
            "weighted_hours": 60.0,
            "rate": 1.0
          },
          {
            "work_type": "平日加班(1.34)",
            "hours": 10.0,
            "weighted_hours": 13.4,
            "rate": 1.34
          },
          {
            "work_type": "平日加班(1.67)",
            "hours": 2.0,
            "weighted_hours": 3.34,
            "rate": 1.67
          },
          {
            "work_type": "假日加班(2.0)",
            "hours": 0.0,
            "weighted_hours": 0.0,
            "rate": 2.0
          }
        ],
        "subtotal": {
          "hours": 72.0,
          "weighted_hours": 76.74
        }
      },
      "工商": {
        "breakdown": [
          {
            "work_type": "正常工時",
            "hours": 18.0,
            "weighted_hours": 18.0,
            "rate": 1.0
          },
          {
            "work_type": "假日加班(2.0)",
            "hours": 2.0,
            "weighted_hours": 4.0,
            "rate": 2.0
          }
        ],
        "subtotal": {
          "hours": 20.0,
          "weighted_hours": 22.0
        }
      },
      "稅務": {
        "breakdown": [
          {
            "work_type": "正常工時",
            "hours": 16.0,
            "weighted_hours": 16.0,
            "rate": 1.0
          }
        ],
        "subtotal": {
          "hours": 16.0,
          "weighted_hours": 16.0
        }
      }
    },
    "total": {
      "hours": 108.0,
      "weighted_hours": 114.74,
      "weighted_ratio": 106.2
    },
    "overtime_analysis": {
      "normal": { "hours": 94.0, "percentage": 87.0 },
      "overtime_134": { "hours": 10.0, "percentage": 9.3 },
      "overtime_167": { "hours": 2.0, "percentage": 1.9 },
      "overtime_200": { "hours": 2.0, "percentage": 1.9 }
    }
  }
}
```

---

### 10.2 客戶服務分析（投入工時 vs 收費）

**報表格式：**
```
客戶服務分析報表 - 2025年11月
═══════════════════════════════════════════════════════════════════════════

| 客戶   | 服務 | 原始工時 | 加權工時 | 收費      | 時薪假設 | 成本估算 | 效益比 | 評估      |
|--------|------|----------|----------|-----------|----------|----------|--------|-----------|
| 仟鑽   | 記帳 | 20.0h    | 22.5h    | 15,000    | 500/h    | 11,250   | 1.33   | ✅ 獲利    |
| 宏達   | 記帳 | 35.0h    | 40.0h    | 20,000    | 500/h    | 20,000   | 1.00   | ⚠️ 持平    |
| 新創   | 工商 | 15.0h    | 15.0h    | 30,000    | 500/h    | 7,500    | 4.00   | ✅✅ 高獲利 |
| 大成   | 稅務 | 25.0h    | 30.0h    | 12,000    | 500/h    | 15,000   | 0.80   | ❌ 虧損    |

效益比 = 收費 / (加權工時 × 時薪假設)
時薪假設可在系統設定中配置
```

---

### 10.3 業務類型分佈與趨勢

**本月圓餅圖：**
```
本月工時分佈（加權工時）
─────────────────────────
    記帳 225.0h (65%)  ████████
    工商  85.0h (25%)  ███
    稅務  36.1h (10%)  █
```

**年度趨勢折線圖：**
```
服務類型分佈趨勢 - 2025年
─────────────────────────────────────
加權工時(h)
 250│   記帳 ──────────
 200│        ╱╲    ╱╲  ╱
 150│       ╱  ╲  ╱  ╲╱
 100│ 工商 ──────────────
  50│      ╱     ╲╱    ╲
   0│───────────────────────
     1  2  3  4  5  6  7  8  9 10 11 12 月份
```

**數據表格：**
```
| 月份 | 記帳(h) | 工商(h) | 稅務(h) | 總計(h) |
|------|---------|---------|---------|---------|
| 1月  | 180     | 60      | 40      | 280     |
| 2月  | 160     | 70      | 50      | 280     |
| 3月  | 200     | 50      | 30      | 280     |
...
| 11月 | 225     | 85      | 36      | 346     |
```

---

### 10.4 預測分析

**基於歷史數據預測下月工時需求：**
```
工時需求預測 - 2025年12月
═══════════════════════════════════════

【預測方法】
  分析期間：過去 6 個月 (2025/06-2025/11)
  預測算法：移動平均 + 季節性調整

【預測結果】
  記帳業務：約 190h  (信心區間：180-200h)
  工商業務：約  65h  (信心區間： 60-70h)
  稅務業務：約  45h  (信心區間： 40-50h)
  ─────────────────────────────────────
  總計預估：約 300h

【建議】
  • 12月為稅務申報高峰期，稅務工時可能增加
  • 建議預留 10% 緩衝時間
```

---

## UI 設計

```
報表中心
═══════════════════════════════════════════════════════════

報表類型：[員工工時統計（詳細版）▼]
時間範圍：[2025年11月 ▼]
員工篩選：[所有員工 ▼]

[產生報表] [匯出 Excel]

─────────────────────────────────────────────────────────

（顯示上述報表內容）
```

---

## 圖表組件（已整合）

使用 Chart.js 圖表庫：
- 圓餅圖（PieChart）- 業務類型分佈
- 折線圖（LineChart）- 趨勢分析
- 長條圖（BarChart）- 員工工時對比
- 進度條（ProgressChart）- 完成率顯示

---

**相關：** [工時API](../API設計/工時API.md), [資料庫設計](../資料庫設計.md)
