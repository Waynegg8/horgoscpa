# 業務規則管理（完整版）

**模塊編號：** 02  
**權限要求：** 僅管理員  
**最後更新：** 2025年10月27日

---

## 📋 目錄
- [模塊概述](#模塊概述)
- [國定假日管理](#國定假日管理)
- [假別類型管理](#假別類型管理)
- [加班費率設定](#加班費率設定)
- [特休規則設定](#特休規則設定)
- [其他假期規則設定](#其他假期規則設定)
- [週期類型管理](#週期類型管理)

---

## 模塊概述

### 核心功能
管理所有業務規則，包括：
- 國定假日
- 假別類型
- 加班費率
- 特休規則
- 其他假期規則（婚假、喪假等）
- 週期類型

### 設計原則
- ✅ 所有規則存入資料庫（禁止硬編碼）
- ✅ 管理員透過網頁介面配置
- ✅ 提供「恢復法定預設值」功能
- ✅ 規則變更立即生效

---

## 國定假日管理

### 功能描述
管理每年的國定假日，用於：
- 工時計算（國定假日上班加班費 2.0 倍）
- 假期計算（國定假日不計入請假天數）
- 任務排程（避開國定假日）

### 核心功能
1. **列表查看**：顯示所有國定假日
2. **新增假日**：手動新增
3. **批量導入**：從 CSV 導入（每年更新）
4. **編輯假日**：修改名稱或日期
5. **刪除假日**：刪除錯誤的假日
6. **匯出 CSV**：匯出備份

### 資料結構
| 欄位 | 說明 |
|------|------|
| `holiday_date` | 假日日期（YYYY-MM-DD）|
| `name` | 假日名稱（如：元旦）|
| `is_compensatory_day_off` | 是否為補假 |

### UI 功能
- 按年度篩選
- 按月份分組顯示
- 標示補假
- 批量導入介面

### 業務影響
⚠️ 修改國定假日會影響：
- 工時加權計算
- 假期扣除計算
- 任務自動生成

---

## 假別類型管理

### 功能描述
定義所有假別類型，控制：
- 假別名稱
- 是否扣假
- 是否有薪
- 年度額度

### 預設假別類型
| 假別 | 扣假 | 有薪 | 年度額度 | 說明 |
|------|------|------|---------|------|
| 特休 | ✅ | ✅ | 依年資 | 依 AnnualLeaveRules 計算 |
| 病假 | ✅ | ✅ | 30天/年 | 勞基法規定 |
| 事假 | ✅ | ❌ | 14天/年 | 無薪假 |
| 婚假 | ✅ | ✅ | 8天 | 事件觸發 |
| 喪假 | ✅ | ✅ | 3-8天 | 依親等關係 |
| 產假 | ✅ | ✅ | 56天 | 女性員工 |
| 陪產假 | ✅ | ✅ | 7天 | 配偶生育 |
| 產檢假 | ✅ | ✅ | 7天 | 孕期檢查 |

### 核心功能
1. **列表查看**：顯示所有假別類型
2. **新增假別**：自訂假別類型
3. **編輯假別**：修改設定
4. **啟用/停用**：控制員工是否可選擇
5. **排序調整**：調整顯示順序

### 資料結構
| 欄位 | 說明 |
|------|------|
| `type_name` | 假別名稱 |
| `deduct_leave` | 是否扣假 |
| `is_paid` | 是否有薪 |
| `annual_quota` | 年度額度 |
| `is_enabled` | 是否啟用 |

### 業務影響
⚠️ 停用假別類型後：
- 員工無法申請該假別
- 不影響歷史記錄
- 可重新啟用

---

## 加班費率設定

### 功能描述
設定不同工作類型的加班費率倍數，用於計算加權工時。

### 法定費率
| 工作類型 | 費率倍數 | 說明 |
|---------|---------|------|
| 正常工時 | 1.00 | 一般上班時間 |
| 平日加班 | 1.34 | 平日延長工時 |
| 休息日加班（前2小時）| 1.34 | 例假日前2小時 |
| 休息日加班（第3小時起）| 1.67 | 例假日第3小時起 |
| 國定假日加班 | 2.00 | 國定假日上班 |

### 核心功能
1. **列表查看**：顯示所有費率
2. **新增費率**：新增新的費率規則
3. **編輯費率**：修改費率倍數
4. **標記歷史**：將舊費率標記為歷史（保留記錄）
5. **恢復預設**：恢復為法定費率

### 資料結構
| 欄位 | 說明 |
|------|------|
| `work_type_id` | 工作類型 ID |
| `rate_multiplier` | 費率倍數 |
| `effective_date` | 生效日期 |
| `is_current` | 是否為當前費率 |

### 業務影響
⚠️ 修改費率後：
- 只影響新的工時計算
- 歷史資料不受影響
- 建議保留歷史費率

---

## 特休規則設定

### 功能描述
設定年資與特休天數的對應關係。

### 法定特休規則
| 年資 | 最小月數 | 最大月數 | 天數 |
|------|---------|---------|------|
| 6個月以上未滿1年 | 6 | 12 | 3 |
| 1年以上未滿2年 | 12 | 24 | 7 |
| 2年以上未滿3年 | 24 | 36 | 10 |
| 3年以上未滿5年 | 36 | 60 | 14 |
| 5年以上未滿10年 | 60 | 120 | 15 |
| 10年以上 | 120 | 999 | 每年+1（最高30）|

### 核心功能
1. **列表查看**：顯示所有規則
2. **新增規則**：新增自訂規則
3. **編輯規則**：修改天數
4. **刪除規則**：刪除自訂規則
5. **恢復預設**：恢復為法定規則

### 計算邏輯
```
員工到職日：2024-01-15
今天：2025-10-27
工作月數：21 個月

查詢規則：
SELECT days FROM AnnualLeaveRules
WHERE min_months <= 21 AND max_months > 21

結果：10 天（2年以上未滿3年）
```

### 業務影響
⚠️ 修改特休規則後：
- 所有員工的特休餘額需重新計算
- 建議在年度開始時調整
- 系統自動重算

---

## 其他假期規則設定

### 功能描述
設定婚假、喪假等與生活事件關聯的假期規則。

### 法定規則
| 事件類型 | 假別 | 天數 | 有效期 |
|---------|------|------|--------|
| 結婚 | 婚假 | 8 | 1年 |
| 生育（女性）| 產假 | 56 | 即時 |
| 配偶生育 | 陪產假 | 7 | 前後15天 |
| 父母/配偶/子女過世 | 喪假 | 8 | 1年 |
| 祖父母/配偶父母過世 | 喪假 | 6 | 1年 |
| 曾祖父母/兄弟姊妹過世 | 喪假 | 3 | 1年 |

### 核心功能
1. **列表查看**：顯示所有規則
2. **新增規則**：新增自訂規則
3. **編輯規則**：修改天數或期限
4. **刪除規則**：刪除自訂規則
5. **恢復預設**：恢復為法定規則

### 自動產生邏輯
```
員工登記「結婚」生活事件
  ↓
系統查詢 OtherLeaveRules
  ↓
找到：event_type='結婚' → 婚假 8 天
  ↓
自動在 LeaveBalances 增加 8 天婚假
  ↓
有效期限：事件日期後 1 年
```

---

## 週期類型管理

### 功能描述
定義客戶服務的週期類型（每月、雙月、每季等）。

### 預設週期類型
| 名稱 | 天數間隔 | 月數間隔 | 是否週期性 |
|------|---------|---------|-----------|
| 單次 | NULL | NULL | ❌ |
| 每月 | 30 | 1 | ✅ |
| 雙月 | 60 | 2 | ✅ |
| 每季 | 90 | 3 | ✅ |
| 半年 | 180 | 6 | ✅ |
| 每年 | 365 | 12 | ✅ |

### 核心功能
1. **列表查看**：顯示所有週期類型
2. **新增類型**：新增自訂週期
3. **編輯類型**：修改間隔天數
4. **啟用/停用**：控制是否可選
5. **調整排序**：調整顯示順序

### 使用場景
```
客戶訂閱「記帳服務 - 雙月」
  ↓
選擇週期類型：雙月（60天間隔）
  ↓
設定觸發月份：[1, 3, 5, 7, 9, 11]
  ↓
系統自動在這些月份生成任務
```

### 業務影響
⚠️ 停用週期類型後：
- 新客戶無法選擇該週期
- 不影響現有客戶服務
- 可重新啟用

---

## 通用操作

### 恢復法定預設值功能
所有業務規則都提供「恢復法定預設值」功能：

1. **刪除所有自訂規則**
2. **插入法定預設規則**
3. **重新計算相關數據**（如特休餘額）

⚠️ **警告：** 此操作會清除所有自訂規則，請謹慎使用！

### 查詢使用情況
刪除規則前檢查是否被使用：
- 假別類型 → 檢查 LeaveApplications
- 特休規則 → 檢查受影響員工
- 週期類型 → 檢查 ClientServices
- 加班費率 → 檢查 TimeLogs

---

## 🔗 相關文檔

- **API 規格：** [業務規則API](../API規格/業務規則API.md)
- **資料庫設計：** [業務規則表](../資料庫設計/業務規則表.md)

---

**最後更新：** 2025年10月27日  
**本文檔合併了業務規則下的 6 個子文檔**

