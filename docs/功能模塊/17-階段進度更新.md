# 17 - 階段進度更新

**所屬模塊：** 任務追蹤系統  
**頁面路徑：** `/tasks/:taskId`  
**權限：** 所有員工  
**最後更新：** 2025年10月27日

---

## 功能概述

更新任務各階段的狀態，系統自動計算到期日並提醒逾期。

---

## UI 設計（步驟條）

```
仟鑽企業 - 記帳 - 114年9-10月
───────────────────────────────
總覽：開始 11-01 | 到期 11-15 | 進度 50%

1. ✅ 資料收集  (3天)  已完成
   11-01 → 11-03
   備註：已收到全部發票

2. 🟡 營業稅過帳 (2天)  進行中
   11-04 → 11-05  ⚠️剩1天
   [標記完成] [新增備註]

3. ⚪ 提列折舊  (1天)  未開始
   [開始此階段]

4. ⚪ 報表產出  (2天)  未開始
   (需等待前階段)
```

---

## 顏色規則

| 狀態 | 剩餘天數 | 顏色 | 圖示 |
|------|----------|------|------|
| 未開始 | - | 灰色 | ⚪ |
| 進行中 | ≥2天 | 綠色 | 🟢 |
| 進行中 | 1天 | 黃色 | 🟡 |
| 進行中 | 0天 | 橙色 | 🟠 |
| 逾期 | <0 | 紅色 | 🔴 |
| 已完成 | - | 藍色 | ✅ |

---

## 自動計算邏輯

### 階段開始時
```typescript
start_date = TODAY
due_date = start_date + estimated_days
```

### 任務到期日
```typescript
due_date = start_date + SUM(all_stages.estimated_days)
```

---

## 資料表

`ActiveTaskStages`

---

## API

```
PUT /api/v1/tasks/stages/:stageId
Body: { "status": "進行中", "notes": "..." }
```

---

## 進階功能

### 階段依賴關係檢查

**功能：** 階段必須按順序執行

**UI 顯示（當依賴未滿足時）：**
```
3. 🔒 提列折舊  [未開始]
   ⚠️ 需先完成「階段 2：營業稅過帳」
   [開始此階段] (按鈕禁用，灰色)
```

**前端邏輯：**
```typescript
// 檢查是否可開始
const canStart = computed(() => {
  if (!stage.depends_on) return true;
  
  const dependentStage = stages.find(s => s.stage_id === stage.depends_on);
  return dependentStage?.status === '已完成';
});
```

詳見 [任務模板管理](./14-任務模板管理.md#階段依賴關係設定)

---

### 任務範本複製

**功能：** 從現有任務快速建立新任務

**使用場景：** 客戶臨時需要額外服務，手動複製現有任務

**UI：**
```
任務詳情：仟鑽-記帳-114年9-10月
───────────────────────────────────
[更多操作 ▼]
  ├ 複製此任務
  ├ 重新指派
  └ 刪除任務

點擊「複製此任務」→

┌─ 複製任務 ─────────────┐
│ 新任務標題：            │
│ [仟鑽-記帳-114年11月   ]│
│                        │
│ 開始日期：              │
│ [2025-12-01]           │
│                        │
│ 負責員工：              │
│ [紜蓁 ▼]               │
│                        │
│ [確定複製] [取消]       │
└────────────────────────┘

→ 系統建立新任務（複製所有階段設定）
```

**API：**
```
POST /api/v1/tasks/:taskId/duplicate
Body: {
  "title": "仟鑽-記帳-114年11月",
  "start_date": "2025-12-01",
  "assigned_user_id": 2
}
```

---

### 任務委派功能

**功能：** 將任務重新指派給其他員工

**使用場景：** 
- 員工請假，任務轉給其他人
- 工作量調整

**UI：**
```
任務詳情：仟鑽-記帳-114年9-10月
當前負責人：紜蓁

[重新指派]

┌─ 重新指派任務 ─────────┐
│ 指派給：[凱閔 ▼]       │
│                        │
│ 原因（選填）：          │
│ [紜蓁請假，暫時轉交    ]│
│                        │
│ [確定] [取消]           │
└────────────────────────┘
```

**API：**
```
PUT /api/v1/tasks/:taskId/reassign
Body: {
  "new_assignee_id": 3,
  "reason": "紜蓁請假，暫時轉交"
}
```

**後端邏輯：**
```typescript
async function reassignTask(taskId: number, newAssigneeId: number, reason?: string) {
  await db.prepare(`
    UPDATE ActiveTasks 
    SET assigned_user_id = ?, updated_at = datetime('now')
    WHERE active_task_id = ?
  `).bind(newAssigneeId, taskId).run();
  
  // 記錄審計日誌
  await auditLog.create({
    action: 'REASSIGN_TASK',
    table_name: 'ActiveTasks',
    record_id: taskId,
    old_value: JSON.stringify({ assigned_user_id: oldAssigneeId }),
    new_value: JSON.stringify({ assigned_user_id: newAssigneeId, reason })
  });
}
```

---

**相關：** [任務API](../API設計/任務API.md), [自動化流程](../自動化流程.md), [任務模板管理](./14-任務模板管理.md)

