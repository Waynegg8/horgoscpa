# 假期管理（完整版）

**模塊編號：** 11-13（合併）  
**權限要求：** 所有員工  
**頁面路徑：** `/leave`  
**最後更新：** 2025年10月28日

---

## 📋 目錄
- [功能概述](#功能概述)
- [假期登記](#假期登記)
- [生活事件登記](#生活事件登記)
- [假期餘額查詢](#假期餘額查詢)
- [業務邏輯](#業務邏輯)

---

## 功能概述

### 核心功能
1. **假期登記** - 員工自主登記請假，無需審批
2. **生活事件登記** - 登記婚喪喜慶，自動產生假期額度
3. **假期餘額查詢** - 查詢各假別的應有/已用/剩餘

### 設計原則
- ✅ 無需審批（登記即生效）
- ✅ 自動計算餘額
- ✅ 即時顯示剩餘天數
- ✅ 防止重複請假

---

## 假期登記

### UI 設計
```
┌─────────────────────────────────────┐
│ 假期管理 - 2025年11月               │
├─────────────────────────────────────┤
│ [日曆] [列表]                       │
├─────────────────────────────────────┤
│ 日曆視圖：                          │
│ 一  二  三  四  五  六  日          │
│               1   2                │
│ 3   4   5   6   7   8   9         │
│        [病]                        │
│ 10  11  12  13  14  15  16        │
│            [特][特]                │
├─────────────────────────────────────┤
│ 新增請假                            │
│ 假別：[特休 ▼]                     │
│ 開始日期：[2025-11-15]             │
│ 結束日期：[2025-11-16]             │
│ 天數：2 天                         │
│ 原因：[家庭事務____]                │
│                     [取消] [送出]   │
└─────────────────────────────────────┘
```

### 核心功能
1. **選擇假別** - 從可用假別類型中選擇
2. **選擇日期** - 單日或多日請假
3. **自動計算天數** - 根據起迄日期計算
4. **檢查餘額** - 自動檢查是否足夠
5. **檢查重疊** - 防止同一天重複請假
6. **即時生效** - 登記後立即扣除餘額

### 性別連動
- **男性員工**：看不到「生理假」、「產假」、「產檢假」
- **女性員工**：可看到所有假別

### 驗證規則
1. 假期餘額必須足夠
2. 同一天不能重複請假
3. 結束日期不能早於開始日期
4. 假別類型必須啟用

---

## 生活事件登記

### UI 設計
```
┌─────────────────────────────────────┐
│ 生活事件登記                        │
├─────────────────────────────────────┤
│ 事件類型：[結婚 ▼]                  │
│   ├ 結婚（婚假 8天）                │
│   ├ 生育（產假 56天）               │
│   ├ 配偶生育（陪產假 7天）          │
│   ├ 父母過世（喪假 8天）            │
│   ├ 祖父母過世（喪假 6天）          │
│   └ 兄弟姊妹過世（喪假 3天）        │
│                                     │
│ 事件日期：[2025-12-01]              │
│ 說明：[婚禮日期____]                 │
│                     [取消] [送出]   │
├─────────────────────────────────────┤
│ 已登記事件：                        │
│ • 2023-05-10 結婚                   │
│   已產生：婚假 8天（已用完）        │
└─────────────────────────────────────┘
```

### 自動產生假期流程
```
1. 員工登記「結婚」事件（2025-12-01）
   ↓
2. 系統查詢 OtherLeaveRules 表
   ↓
3. 找到：event_type='結婚' → 婚假 8天
   ↓
4. 自動在 LeaveBalances 增加 8天婚假
   ↓
5. 設定有效期限：2026-12-01
   ↓
6. 員工可開始申請使用
```

### 支持的事件類型

| 事件類型 | 產生假別 | 天數 | 有效期限 |
|---------|---------|------|---------|
| 結婚 | 婚假 | 8 | 事件後1年 |
| 生育（女性）| 產假 | 56 | 即時使用 |
| 配偶生育 | 陪產假 | 7 | 前後15天內 |
| 父母/配偶/子女過世 | 喪假 | 8 | 事件後1年 |
| 祖父母/配偶父母過世 | 喪假 | 6 | 事件後1年 |
| 兄弟姊妹/曾祖父母過世 | 喪假 | 3 | 事件後1年 |

---

## 假期餘額查詢

### UI 設計
```
┌─────────────────────────────────────┐
│ 我的假期餘額 - 2025年               │
├─────────────────────────────────────┤
│ 特休                                │
│ 應有：56h (年資1年)                 │
│ 已用：16h                          │
│ 剩餘：40h  ██████░░░░ 71%          │
├─────────────────────────────────────┤
│ 病假                                │
│ 應有：240h (30天/年)                │
│ 已用：16h                          │
│ 剩餘：224h ████████░ 93%           │
├─────────────────────────────────────┤
│ 事假                                │
│ 應有：112h (14天/年)                │
│ 已用：0h                           │
│ 剩餘：112h ████████ 100%           │
├─────────────────────────────────────┤
│ 婚假（事件給假）                    │
│ 應有：64h (2023-05-10結婚)          │
│ 已用：64h                          │
│ 剩餘：0h  ░░░░░░░░░░ 0%            │
│ 已過期                              │
└─────────────────────────────────────┘
```

### 計算邏輯

#### 特休計算
```typescript
// 根據到職日期和年資計算
const startDate = user.start_date; // 2024-01-15
const now = new Date('2025-10-27');
const monthsWorked = calculateMonths(startDate, now); // 21個月

// 查詢特休規則
const rule = await db.prepare(`
  SELECT days FROM AnnualLeaveRules
  WHERE min_months <= ? AND max_months > ?
`).bind(monthsWorked, monthsWorked).first();

// 結果：10天（2年以上未滿3年）
const annualLeave = rule.days * 8; // 80小時
```

#### 病假/事假計算
```typescript
// 每年固定額度
const leaveType = await db.prepare(
  'SELECT annual_quota FROM LeaveTypes WHERE leave_type_id = ?'
).bind(1).first();

// 病假：30天/年 = 240小時
// 事假：14天/年 = 112小時
```

#### 事件給假計算
```typescript
// 查詢生活事件
const events = await db.prepare(`
  SELECT * FROM LeaveEvents
  WHERE user_id = ? AND event_type = '結婚'
`).bind(userId).all();

// 查詢對應規則
const rule = await db.prepare(`
  SELECT days, validity_days FROM OtherLeaveRules
  WHERE event_type = '結婚'
`).first();

// 計算有效期限
const validUntil = addDays(event.event_date, rule.validity_days);
const isExpired = new Date() > new Date(validUntil);
```

### 餘額顯示規則
- **綠色**：剩餘 > 70%
- **黃色**：剩餘 30-70%
- **紅色**：剩餘 < 30%
- **灰色**：已過期

---

## 業務邏輯

### 假期申請流程
```
1. 員工選擇假別和日期
   ↓
2. 系統檢查假別類型是否啟用
   ↓
3. 系統檢查假期餘額是否足夠
   ↓
4. 系統檢查日期是否重疊
   ↓
5. 插入 LeaveApplications 表
   ↓
6. 更新 LeaveBalances.used_days
   ↓
7. 返回成功，顯示剩餘餘額
```

### 餘額自動計算流程
```
每年1月1日 Cron Job：
1. 查詢所有員工
   ↓
2. 計算每個員工的年資
   ↓
3. 根據 AnnualLeaveRules 計算特休
   ↓
4. 根據 LeaveTypes.annual_quota 設定病假/事假
   ↓
5. 更新或插入 LeaveBalances 表
   ↓
6. 重置 used_days = 0（新年度）
```

### 生活事件產生假期流程
```
1. 員工登記生活事件
   ↓
2. 查詢 OtherLeaveRules 表
   ↓
3. 找到對應的假別和天數
   ↓
4. 在 LeaveBalances 增加額度
   ↓
5. 設定有效期限
   ↓
6. 通知員工已產生額度
```

---

## 權限控制

### 員工
- 只能查看/登記自己的假期
- 只能查看/登記自己的生活事件
- 只能查詢自己的假期餘額

### 管理員
- 可查看所有員工的假期記錄
- 可查看所有員工的假期餘額
- 可調整業務規則（假別類型、特休規則等）

---

## 🔗 相關文檔

- **API 規格：** [假期管理API](../API規格/假期管理API.md)
- **資料庫設計：** [假期系統表](../資料庫設計/假期系統表.md), [業務規則表](../資料庫設計/業務規則表.md)
- **業務規則：** [業務規則管理](./02-業務規則管理（完整版）.md)

---

**最後更新：** 2025年10月28日  
**本文檔合併了以下3個功能模塊：**
1. 11-假期登記.md
2. 12-生活事件登記.md
3. 13-假期餘額查詢.md

