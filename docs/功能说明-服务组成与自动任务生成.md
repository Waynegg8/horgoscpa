# 服务组成与自动任务生成功能说明

## 📋 功能概述

本功能允许您为客户的服务包配置具体的服务组成部分，系统会根据配置自动生成任务并追踪工时。

### 核心特点

✅ **灵活配置** - 每个客户可以独立设置服务内容和期限  
✅ **自动生成** - 系统根据提供频率自动创建任务  
✅ **工时追踪** - 员工可以看到预估工时对比实际工时  
✅ **成本分析** - 管理员可以查看每个服务的成本和利润  
✅ **权限分级** - 员工和管理员看到不同的数据

---

## 🎯 使用场景示例

### 场景：ABC公司的记账服务包

**收费方式：** 每月收费 2,000 元

**服务内容：**
1. 每月记账 - 每月提供
2. 营业税申报 - 每2个月提供（1,3,5,7,9,11月）
3. 营所税申报 - 每年5月提供

---

## 📝 操作步骤

### 第一步：配置客户服务

1. 进入 **客户管理** → 选择客户 → **客户详情页**

2. 在"客户服务"区块，点击 **新增服务**
   - 服务名称：记账服务包
   - 状态：使用中
   - 服务周期：每月
   - 开始日期：2025-01-01

3. 点击 **收费设定** 配置收费计划
   - 1月：2,000元
   - 2月：2,000元
   - ... (全年)

### 第二步：配置服务组成部分

点击 **配置服务内容** 按钮，进入服务组成配置：

#### 组成部分1：每月记账

```
服务名称：每月记账
服务类型：记账服务
提供频率：每月
任务模板：月度记账流程
期限规则：当月月底
期限日期值：（不需要）
预估工时：8小时
提前生成：7天
备注：包含收集凭证、输入账务、月结对账、报表产制
```

#### 组成部分2：营业税申报

```
服务名称：营业税申报
服务类型：税务申报
提供频率：每两个月
任务模板：401营业税申报
期限规则：次月指定日
期限日期值：15
预估工时：2小时
提前生成：7天
备注：双月报（1,3,5,7,9,11月）
```

#### 组成部分3：营所税申报

```
服务名称：营所税申报
服务类型：税务申报
提供频率：每年
任务模板：营所税结算申报
期限规则：当月指定日
期限日期值：31
预估工时：16小时
提前生成：7天
备注：每年5月申报
```

### 第三步：等待系统自动生成任务

系统会在每天自动检查并生成任务：

**2025年1月会生成：**
- ABC公司 - 2025年1月每月记账（截止：1/31）
- ABC公司 - 2025年1-2月营业税申报（截止：2/15）

**2025年5月会生成：**
- ABC公司 - 2025年5月每月记账（截止：5/31）
- ABC公司 - 2025年5-6月营业税申报（截止：6/15）
- ABC公司 - 2025年营所税申报（截止：5/31）

### 第四步：员工填写工时

员工在 **工时管理** 页面：

1. 选择任务：ABC公司 - 2025年1月每月记账
2. 选择阶段：收集凭证
3. 填写工时：2.5小时
4. 保存

### 第五步：查看统计

**员工可以看到：**
- 工时统计 → `/internal/api/v1/timesheets/my-stats?month=2025-01`
- 预估工时 vs 实际工时
- 超时提醒

**管理员额外可以看到：**
- 成本分析 → `/internal/api/v1/admin/cost-analysis?client_id=xxx&month=2025-01`
- 每个服务的成本
- 利润和利润率

---

## 🔧 技术细节

### 数据库结构

```sql
ServiceComponents (服务组成部分)
├─ component_id
├─ client_service_id (关联客户服务)
├─ component_name (服务名称)
├─ delivery_frequency (提供频率)
├─ due_date_rule (期限规则)
├─ estimated_hours (预估工时)
└─ task_template_id (任务模板)

ActiveTasks (任务)
├─ task_id
├─ component_id (关联服务组成)
├─ task_name
├─ due_date
└─ status
```

### API端点

#### 员工可访问

```bash
# 获取服务组成部分列表
GET /internal/api/v1/client-services/:id/components

# 新增服务组成部分
POST /internal/api/v1/client-services/:id/components

# 更新服务组成部分
PUT /internal/api/v1/service-components/:id

# 删除服务组成部分
DELETE /internal/api/v1/service-components/:id

# 我的工时统计
GET /internal/api/v1/timesheets/my-stats?month=2025-01
```

#### 管理员可访问

```bash
# 手动触发任务生成
POST /internal/api/v1/admin/tasks/generate-from-components

# 成本分析
GET /internal/api/v1/admin/cost-analysis?client_id=xxx&month=2025-01
```

### 期限规则说明

| 规则 | 说明 | 示例 |
|-----|------|------|
| `end_of_month` | 当月月底 | 1/31, 2/28, 3/31 |
| `specific_day` | 当月指定日 | 每月5日 → 1/5, 2/5, 3/5 |
| `next_month_day` | 次月指定日 | 次月15日 → 2/15, 3/15 |
| `days_after_start` | 相对天数 | 30天后 |

### 提供频率说明

| 频率 | 说明 | 生成月份 |
|-----|------|---------|
| `monthly` | 每月 | 1-12月 |
| `bi-monthly` | 每两个月 | 1,3,5,7,9,11月 |
| `quarterly` | 每季 | 1,4,7,10月 |
| `yearly` | 每年 | 1月 |
| `one-time` | 一次性 | 需手动创建 |

---

## 📊 工时统计示例

### 员工看到的数据

```json
{
  "total_hours": 152,
  "period": "2025-01",
  "by_client": [
    {
      "client_id": "ABC001",
      "client_name": "ABC公司",
      "total_hours": 11.5,
      "components": [
        {
          "component_name": "每月记账",
          "estimated_hours": 8,
          "actual_hours": 9,
          "over_time": 1,
          "efficiency": "112.5%"
        },
        {
          "component_name": "营业税申报",
          "estimated_hours": 2,
          "actual_hours": 2.5,
          "over_time": 0.5,
          "efficiency": "125%"
        }
      ]
    }
  ]
}
```

### 管理员看到的成本数据

```json
{
  "client": {
    "client_id": "ABC001",
    "company_name": "ABC公司"
  },
  "period": "2025-01",
  "revenue": 2000,
  "total_cost": 2100,
  "profit": -100,
  "profit_rate": "-5%",
  "components": [
    {
      "component_name": "每月记账",
      "estimated_hours": 8,
      "actual_hours": 9,
      "over_time": 1,
      "total_cost": 1600,
      "workers": ["刘会计", "田会计"]
    },
    {
      "component_name": "营业税申报",
      "estimated_hours": 2,
      "actual_hours": 2.5,
      "over_time": 0.5,
      "total_cost": 500,
      "workers": ["刘会计"]
    }
  ]
}
```

---

## 🚀 自动化定时任务

### 手动触发（测试用）

```bash
curl -X POST \
  https://your-domain.com/internal/api/v1/admin/tasks/generate-from-components \
  -H "Cookie: session=xxx" \
  -H "Content-Type: application/json"
```

### Cloudflare Workers定时任务（推荐）

在 `wrangler.toml` 中配置：

```toml
[triggers]
crons = ["0 2 * * *"]  # 每天凌晨2点执行
```

在 Worker 中添加：

```javascript
export default {
  async scheduled(event, env, ctx) {
    // 调用任务生成函数
    await generateTasksForComponents(env);
  }
}
```

---

## ⚠️ 注意事项

1. **不会重复生成** - 系统会检查是否已存在相同的任务
2. **模板是复制关系** - 修改模板不影响已生成的任务
3. **可以手动调整** - 员工可以修改任务的截止日期
4. **删除有保护** - 有关联任务的服务组成无法删除
5. **权限分离** - 员工看不到成本数据

---

## 🔍 常见问题

### Q1: 如何修改已生成的任务？

A: 在任务管理页面，点击任务详情，可以修改截止日期、阶段等。

### Q2: 如果服务组成部分配置错了怎么办？

A: 删除重新配置即可，已生成的任务不受影响。如果要影响已生成的任务，需要手动修改任务。

### Q3: 可以为不同客户设置不同的期限吗？

A: 可以！每个客户的服务组成部分都是独立配置的。

### Q4: 如何查看某个客户的成本分析？

A: 管理员访问：`/internal/api/v1/admin/cost-analysis?client_id=ABC001&month=2025-01`

### Q5: 员工能看到收费金额吗？

A: 可以。员工可以看到客户的收费和预估工时，但看不到薪资成本和利润。

---

## 📈 后续优化建议

1. ✅ 添加任务批量操作功能
2. ✅ 增加工时效率报表
3. ✅ 支持服务组成部分的批量复制
4. ✅ 添加任务延期提醒
5. ✅ 支持按季度、年度统计

---

## 🎓 最佳实践

### 1. 合理设置预估工时

根据历史数据调整预估工时，提高准确度。

### 2. 使用任务模板

为常见服务创建标准模板，提高一致性。

### 3. 定期查看效率

每月查看工时对比，优化流程。

### 4. 客制化配置

针对特殊客户调整期限规则，提高灵活性。

### 5. 及时调整

如果发现某个服务经常超时，调整预估工时或优化流程。

---

## 📞 技术支持

如有问题，请联系系统管理员或查看开发文档。

