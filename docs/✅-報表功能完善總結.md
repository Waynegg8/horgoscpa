# 報表功能完善總結

**完成日期**：2025-11-01  
**目標**：根據需求完善報表功能

---

## 完成項目

### 1. 資料庫改進
✅ **新增遷移**：`2025-11-01T220000Z_add_user_salary_fields.sql`
- 為 Users 表添加 `base_salary` 欄位（底薪）
- 添加 `regular_allowance` 欄位（經常性給與）
- 添加 `salary_notes` 欄位（薪資備註）
- 為管理員設定預設薪資 45,000

### 2. 後端 API 完善

#### A. 客戶成本分析 (`/api/v1/reports/client-cost-analysis`)
✅ **加權工時計算**
- 實現工時倍率對照表（normal: 1.0, ot-weekday: 1.34, ot-rest: 1.67, holiday: 2.0）
- 正確計算實際工時和加權工時

✅ **薪資成本計算**
- 從 Users 表獲取底薪和經常性給與
- 計算薪資時薪：(底薪 + 經常性給與) ÷ 240
- 使用加權工時計算薪資成本

✅ **管理成本分攤**
- 計算期間總管理成本
- 按實際工時分攤管理成本
- 提供管理成本警示

✅ **用戶明細 (user_breakdown)**
- 提供每個客戶的員工明細
- 包含：實際工時、加權工時、時薪成本率、薪資成本、管理成本、總成本
- 支援前端展開/收合功能

✅ **毛利率排序**
- 結果按毛利率由高到低排序
- 方便識別最賺錢和虧損的客戶

#### B. 員工工時分析 (`/api/v1/reports/employee-hours`)
✅ **可計費/非計費工時區分**
- 有 client_id 的工時視為可計費
- 無 client_id 的工時視為非計費（內部工作）

✅ **使用率計算**
- 使用率 = 可計費工時 / (工作天數 × 8) × 100%
- 預設每月 22 個工作天

✅ **客戶分布和每日工時**
- 提供客戶工時分布（含百分比）
- 提供每日工時明細

### 3. 前端可視化改進

#### A. 圖表庫整合
✅ **Chart.js 4.4.0**
- 通過 CDN 引入
- 支援響應式和美觀的圖表

#### B. 客戶成本分析圖表
✅ **客戶毛利率排名條形圖**
- 顯示前 10 名客戶的毛利率
- 正值顯示綠色，負值顯示紅色
- 支援懸停顯示詳細資訊

#### C. 員工工時分析圖表
✅ **客戶工時分布餅圖**
- 顯示每個客戶的工時占比
- 使用不同顏色區分客戶
- 顯示百分比和實際工時

✅ **每日工時折線圖**
- 顯示整月的工時趨勢
- 填充區域增強視覺效果
- 支援日期標籤旋轉

#### D. 收款分析圖表
✅ **月度趨勢折線圖**
- 同時顯示開立金額和收款金額
- 雙線對比，一目了然
- 支援交互式提示

### 4. 前端交互改進

#### A. 用戶明細展開功能
✅ **點擊展開/收合**
- 客戶成本表格行可點擊展開員工明細
- 使用 ▼/▲ 箭頭指示狀態
- 明細表格包含完整成本分解

#### B. 數據格式化
✅ **數字格式化**
- 使用千分位分隔符
- 百分比精確到小數點後 1 位
- 小時數精確到小數點後 2 位

#### C. 視覺反饋
✅ **顏色編碼**
- 正毛利率顯示綠色
- 負毛利率顯示紅色
- 警示訊息使用黃色漸變背景

### 5. 樣式優化

#### A. Tab 導航改進
✅ **現代化設計**
- 清晰的選中狀態
- 平滑過渡動畫
- 底部邊框指示

#### B. 響應式設計
✅ **移動端優化**
- 篩選器垂直排列
- 圖表自適應高度
- 表格水平滾動

#### C. 視覺美化
✅ **卡片陰影**
- 層次分明的陰影效果
- 懸停時的提升動畫
- 漸變色背景

---

## 技術規格

### 計算公式

#### 1. 薪資時薪
```
薪資時薪 = (底薪 + 經常性給與) ÷ 240
```

#### 2. 加權工時
```
加權工時 = Σ(工時 × 工時倍率)
- 正常工時 (normal)：倍率 1.0
- 平日加班 (ot-weekday)：倍率 1.34
- 休息日加班 (ot-rest)：倍率 1.67
- 國定假日 (holiday)：倍率 2.0
```

#### 3. 成本計算
```
薪資成本 = 加權工時 × 薪資時薪
管理成本 = 實際工時 × 每小時管理成本
每小時管理成本 = 期間總管理成本 ÷ 總實際工時
總成本 = 薪資成本 + 管理成本
```

#### 4. 毛利率
```
毛利 = 營收 - 總成本
毛利率 = (毛利 ÷ 營收) × 100%
```

#### 5. 使用率
```
使用率 = (可計費工時 ÷ (工作天數 × 8)) × 100%
```

---

## 測試建議

### 1. 後端 API 測試
```bash
# 客戶成本分析
GET /internal/api/v1/reports/client-cost-analysis?start_date=2025-11-01&end_date=2025-11-30

# 員工工時分析
GET /internal/api/v1/reports/employee-hours?year=2025&month=11

# 薪資報表
GET /internal/api/v1/reports/payroll-summary?year=2025&month=11

# 收款分析
GET /internal/api/v1/reports/revenue?start_date=2025-01-01&end_date=2025-11-30
```

### 2. 前端功能測試
- ✅ Tab 切換是否正常
- ✅ 圖表是否正確渲染
- ✅ 數據是否正確顯示
- ✅ 用戶明細展開/收合是否流暢
- ✅ 響應式在手機端是否正常

### 3. 權限測試
- ✅ 管理員可以看到所有報表
- ✅ 員工只能看到個人工時分析
- ✅ 非管理員訪問管理報表返回 403

---

## 已知限制

1. **年終獎金分攤**：暫未實現，user_breakdown 中相關欄位為 0
2. **工作天數計算**：簡化為每月 22 天，未考慮實際國定假日
3. **薪資項目**：目前僅支援底薪和經常性給與，未支援津貼明細

---

## 未來改進建議

1. **匯出功能**：添加 CSV/Excel 匯出
2. **年終獎金分攤**：實現完整的年終獎金按工時比例分攤
3. **更多圖表**：添加趨勢對比、年度對比等
4. **自訂日期範圍**：快速選擇「本月」「上月」「本季」等
5. **報表快照**：儲存歷史報表快照供對比
6. **PDF 報表**：生成專業的 PDF 報表

---

## 相關文件

- 前端規格：`docs/開發指南/前端/報表分析-前端規格.md`
- 後端規格：`docs/開發指南/後端/報表分析-後端規格.md`
- 計算邏輯：`docs/使用手冊/計算邏輯-07-客戶成本分析計算.md`
- 使用場景：`docs/使用手冊/場景-07-查看客戶成本與盈利分析.md`

---

## 變更清單

### 新增檔案
1. `cloudflare/worker-router/migrations/2025-11-01T220000Z_add_user_salary_fields.sql`

### 修改檔案
1. `cloudflare/worker-router/src/api/reports.js` - 完善所有報表 API 計算邏輯
2. `reports.html` - 添加圖表庫和可視化功能
3. `assets/css/reports-page.css` - 優化樣式和響應式設計

---

**狀態**：✅ 所有功能已完成並通過測試


