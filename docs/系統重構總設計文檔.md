# 霍爾果斯會計師事務所 - 系統重構總設計文檔

**版本**: 3.0  
**創建日期**: 2025-10-26  
**重要性**: 🔴🔴🔴 核心文檔 - 所有設計的總綱

---

## 📋 文檔結構

本文檔整合了所有重構相關的設計，分為以下章節：

1. [系統現狀分析](#1-系統現狀分析)
2. [重構目標與原則](#2-重構目標與原則)
3. [資料庫標準化設計](#3-資料庫標準化設計)
4. [後端模組化架構](#4-後端模組化架構)
5. [前端模組化架構](#5-前端模組化架構)
6. [標準化開發流程](#6-標準化開發流程)
7. [問題診斷與解決](#7-問題診斷與解決)
8. [實施執行計劃](#8-實施執行計劃)
9. [清理與維護](#9-清理與維護)

---

## 1. 系統現狀分析

### 1.1 核心問題

| 問題類別 | 具體表現 | 嚴重程度 | 影響 |
|---------|---------|---------|------|
| **代碼重複** | ~950行重複代碼 | 🔴 高 | 維護困難、易出錯 |
| **資料庫混亂** | 命名不一致、結構重複 | 🔴 高 | 查詢錯誤、難理解 |
| **缺乏模組化** | 大文件（2300行） | 🔴 高 | 難維護、難測試 |
| **API 不統一** | 命名混亂、格式不一 | 🟡 中 | 難使用、難理解 |
| **文檔分散** | 過多設計文檔 | 🟡 中 | 難查找、易混淆 |

### 1.2 技術債務統計

```
前端：
- 代碼重複：~950行（佔總代碼 23%）
- 大文件：5個文件 > 800行
- 最大文件：settings.js (2300行)

後端：
- 缺乏統一架構
- 每個 handler 重複認證邏輯
- 缺乏中間件系統

資料庫：
- 命名不一致：3種外鍵命名方式
- 表結構重複：2套範本系統
- Migration 混亂：只有1個文件
```

---

## 2. 重構目標與原則

### 2.1 重構目標

✅ **代碼量減少 70%**（10000行 → 3000行）  
✅ **代碼重複率 < 5%**（950行 → < 50行）  
✅ **模組文件 < 300行**（最大 2300行 → 300行）  
✅ **資料庫 100% 標準化**  
✅ **API 100% RESTful**  
✅ **性能提升 > 30%**  

### 2.2 核心原則

#### 原則 1: 設計先行
```
任何修改：先更新設計文檔 → 評審 → 實施 → 測試 → 同步文檔
```

#### 原則 2: 模組最小化
```
每個模組：
- 單一職責
- 文件 < 300行
- 函數 < 50行
- 可獨立測試
```

#### 原則 3: 零重複代碼
```
發現重複 → 提取到共用模組 → 全面替換 → 添加檢測
```

#### 原則 4: 統一規範
```
命名、結構、格式、錯誤處理 → 必須 100% 一致
```

---

## 3. 資料庫標準化設計

### 3.1 統一命名規範（強制執行）

#### 表名規範
```sql
格式: {entity}s （複數、小寫、底線分隔）

✅ users, clients, tasks, client_services, task_stages
❌ User, client_service, ClientServices
```

#### 欄位命名規範

```sql
-- 主鍵（固定）
id INTEGER PRIMARY KEY AUTOINCREMENT

-- 外鍵（格式：{table}_id 或 {role}_{table}_id）
user_id INTEGER
client_id INTEGER
assigned_user_id INTEGER        -- 角色明確
created_by_user_id INTEGER      -- 角色明確

-- 布林值（格式：is_{description}）
is_active BOOLEAN
is_deleted BOOLEAN
is_approved BOOLEAN

-- 時間戳（格式：{action}_at）
created_at DATETIME
updated_at DATETIME
deleted_at DATETIME

-- JSON 欄位（格式：{description}_data 或 _json）
metadata_json TEXT
config_data TEXT
checklist_data TEXT
```

### 3.2 核心資料表（重構後）

#### tasks（統一任務表）
```sql
CREATE TABLE tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    task_type TEXT DEFAULT 'task',              -- task, project, recurring
    category TEXT,                               -- recurring, business, finance, client_service
    status TEXT DEFAULT 'pending',
    priority TEXT DEFAULT 'medium',
    assigned_user_id INTEGER,                    -- ✅ 統一命名
    created_by_user_id INTEGER,                  -- ✅ 統一命名
    client_id INTEGER,
    project_budget DECIMAL(12, 2),               -- 專案用
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (assigned_user_id) REFERENCES users(id),
    FOREIGN KEY (created_by_user_id) REFERENCES users(id),
    FOREIGN KEY (client_id) REFERENCES clients(id)
);
```

#### task_templates（統一範本表）
```sql
CREATE TABLE task_templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    template_name TEXT NOT NULL,
    template_type TEXT NOT NULL,                 -- general, service_checklist
    category TEXT,
    service_type TEXT,
    template_data TEXT NOT NULL,                 -- JSON 統一格式
    version INTEGER DEFAULT 1,
    is_active BOOLEAN DEFAULT 1,
    is_default BOOLEAN DEFAULT 0,
    created_by_user_id INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by_user_id) REFERENCES users(id)
);
```

### 3.3 廢棄的表（需刪除）

```sql
DROP TABLE IF EXISTS projects;                      -- 整合到 tasks
DROP TABLE IF EXISTS multi_stage_templates;        -- 整合到 task_templates
DROP TABLE IF EXISTS template_stages;              -- 整合到 task_template_stages
DROP TABLE IF EXISTS service_checklist_templates;  -- 整合到 task_templates
```

---

## 4. 後端模組化架構

### 4.1 分層架構

```
請求 → Middleware → Handler → Service → Repository → Database
```

#### 各層職責

| 層級 | 職責 | 禁止 | 文件大小 |
|------|------|------|---------|
| **Middleware** | 認證、驗證、錯誤處理 | 業務邏輯 | < 100行 |
| **Handler** | HTTP 處理、參數解析 | 資料庫操作 | < 200行 |
| **Service** | 業務邏輯、多表協調 | 直接 SQL | < 300行 |
| **Repository** | 資料庫 CRUD | 業務邏輯 | < 200行 |

### 4.2 標準化 Handler 範本

```javascript
/**
 * GET /api/{entities}
 */
export async function getList(env, request) {
  // 1. 認證（中間件已處理，request.auth 已注入）
  const { user } = request.auth;
  
  // 2. 解析參數
  const url = new URL(request.url);
  const params = {
    page: parseInt(url.searchParams.get('page')) || 1,
    pageSize: parseInt(url.searchParams.get('pageSize')) || 20,
    filters: parseFilters(url.searchParams)
  };
  
  // 3. 調用 Service
  const service = new EntityService(env.DB);
  const result = await service.getList(params);
  
  // 4. 返回響應
  return jsonResponse({
    success: true,
    data: result.data,
    meta: result.meta
  });
}
```

---

## 5. 前端模組化架構

### 5.1 四層架構

```
Core（核心層）→ Components（組件層）→ Modules（業務層）→ Pages（頁面層）
```

#### 各層職責

| 層級 | 內容 | 職責 | 文件大小 |
|------|------|------|---------|
| **Core** | API, State, Utils | 基礎設施 | < 200行/文件 |
| **Components** | Table, Form, Modal | UI 組件 | < 300行/文件 |
| **Modules** | TaskService, ClientService | 業務邏輯 | < 200行/文件 |
| **Pages** | TasksPage, DashboardPage | 頁面協調 | < 150行/文件 |

### 5.2 標準化 Page 範本

```javascript
import { EntityService } from '../modules/entity/EntityService.js';
import { Table, Form, Modal } from '../components';

export class EntityPage {
  constructor() {
    this.service = new EntityService();
    this.table = null;
    this.form = null;
  }

  async init() {
    this._initComponents();
    this._bindEvents();
    await this.loadData();
  }

  _initComponents() { /* 初始化組件 */ }
  _bindEvents() { /* 綁定事件 */ }
  async loadData() { /* 載入數據 */ }
}

// 自動初始化
document.addEventListener('DOMContentLoaded', async () => {
  await initPage(async () => {
    const page = new EntityPage();
    await page.init();
  });
});
```

---

## 6. 標準化開發流程

### 6.1 新功能開發流程（詳細）

```
階段 1: 需求與設計
  ├─ 1.1 創建功能設計文檔
  │   └─ 模板：docs/功能設計文檔範本.md
  ├─ 1.2 定義資料庫結構
  │   └─ 檢查：命名規範檢查清單
  ├─ 1.3 設計 API 端點
  │   └─ 檢查：RESTful 規範檢查清單
  ├─ 1.4 設計前端模組
  │   └─ 檢查：模組重用檢查清單
  └─ 1.5 設計評審
      └─ 通過所有檢查清單才能繼續

階段 2: 資料庫實施
  ├─ 2.1 創建 Migration
  ├─ 2.2 本地測試
  ├─ 2.3 執行遠端
  └─ 2.4 驗證完整性

階段 3: 後端實施
  ├─ 3.1 創建 Repository
  ├─ 3.2 創建 Service
  ├─ 3.3 創建 Handler
  ├─ 3.4 註冊路由
  └─ 3.5 測試 API

階段 4: 前端實施
  ├─ 4.1 創建 Service 模組
  ├─ 4.2 創建 Page 類
  ├─ 4.3 創建 HTML 頁面
  ├─ 4.4 創建頁面 CSS（如需要）
  └─ 4.5 測試功能

階段 5: 測試與文檔
  ├─ 5.1 單元測試
  ├─ 5.2 集成測試
  ├─ 5.3 更新 API 文檔
  └─ 5.4 更新功能設計文檔

階段 6: 部署與清理
  ├─ 6.1 部署到生產
  ├─ 6.2 驗證功能
  └─ 6.3 刪除測試文件
```

### 6.2 每個階段的強制檢查清單

#### 設計階段檢查清單
```
□ 功能設計文檔已創建且完整
□ 資料表命名符合規範（{entity}s, {table}_id, is_{name}, {action}_at）
□ API 端點符合 RESTful（GET /api/entities, POST /api/entities）
□ 前端模組職責清晰（Page < 150行, Module < 200行, Component < 300行）
□ 檢查現有模組，最大化重用
□ 設計評審通過（所有檢查項都打勾）
```

#### 實施階段檢查清單
```
□ Migration 文件格式正確，包含完整註釋
□ Repository 繼承 BaseRepository
□ Service 只包含業務邏輯
□ Handler 只處理 HTTP
□ 前端使用標準化組件
□ HTML 遵循標準範本
□ CSS 使用組件庫或加頁面前綴
□ JavaScript 遵循模組化架構
```

#### 測試階段檢查清單
```
□ 所有 API 端點測試通過
□ 所有頁面功能測試通過
□ 單元測試覆蓋率 > 80%
□ 性能測試通過（頁面 < 2秒，API < 200ms）
□ 瀏覽器相容性測試通過
□ 無控制台錯誤
```

#### 文檔階段檢查清單
```
□ API 文檔已更新
□ 功能設計文檔已更新
□ 系統架構文檔已更新
□ 所有範例代碼可運行
□ 沒有引用已刪除的內容
```

---

## 7. 問題診斷與解決

### 7.1 核心原則：深度診斷

```
表面修復（❌）  vs  根本解決（✅）

❌ 發現樣式問題 → 在該頁面 CSS 中覆蓋
✅ 發現樣式問題 → 診斷是組件問題還是頁面問題 → 修改組件庫或標準化頁面

❌ 發現 API 錯誤 → 在該 API 中添加 try-catch
✅ 發現 API 錯誤 → 診斷缺乏錯誤中間件 → 建立統一錯誤處理

❌ 發現代碼重複 → 刪除一處重複
✅ 發現代碼重複 → 提取到共用模組 → 全面搜索替換 → 添加檢測工具
```

### 7.2 五個為什麼（5 Whys）

遇到任何問題，必須問 5 次"為什麼"：

```
範例：Tasks 頁面表格不顯示

為什麼表格不顯示？
→ 因為 API 返回 500 錯誤

為什麼 API 返回 500？
→ 因為 SQL 查詢失敗

為什麼 SQL 查詢失敗？
→ 因為使用了錯誤的欄位名 (assigned_user)

為什麼使用錯誤的欄位名？
→ 因為資料庫重構後代碼未同步

為什麼代碼未同步？（根本原因）
→ 因為缺乏自動化測試和 schema 驗證

正確解決方案：
1. 修改代碼使用正確欄位名（直接原因）
2. 檢查所有代碼，統一欄位名（影響範圍）
3. 建立欄位名稱常量（預防機制）
4. 添加 schema 驗證測試（自動化）
5. 更新開發流程規範（流程改進）
```

### 7.3 問題解決決策樹

```
發現問題
    ↓
是單一案例還是系統性問題？
    ├─ 單一案例
    │   ↓
    │  修復代碼
    │  添加測試
    │  更新文檔
    │
    └─ 系統性問題
        ↓
      是代碼問題還是架構問題？
        ├─ 代碼問題
        │   ↓
        │  重構代碼
        │  建立共用模組
        │  添加檢測工具
        │
        └─ 架構問題
            ↓
          重新設計架構
          更新設計文檔
          全面重構
          更新開發規範
```

---

## 8. 實施執行計劃

### 8.1 資料庫重構

#### Migration 檔案結構
```
001_core_tables.sql          # 核心表（users, employees, clients）
002_task_system.sql          # 任務系統
003_template_system.sql      # 範本系統
004_client_services.sql      # 客戶服務
005_timesheet_system.sql     # 工時系統
006_knowledge_base.sql       # 知識庫
007_cms_system.sql           # CMS
008_system_config.sql        # 系統配置
009_reports.sql              # 報表
010_seed_data.sql            # 種子數據
```

### 8.2 後端重構

#### 目錄結構
```
timesheet-api/src/
├── config/              # 配置模組
│   ├── app.config.js
│   └── database.config.js
├── middleware/          # 中間件模組
│   ├── auth.middleware.js
│   ├── validate.middleware.js
│   └── error.middleware.js
├── repositories/        # 資料訪問模組
│   ├── BaseRepository.js
│   ├── ClientRepository.js
│   └── TaskRepository.js
├── services/            # 業務邏輯模組
│   ├── ClientService.js
│   └── TaskService.js
├── handlers/            # API 處理模組
│   ├── clients.handler.js
│   └── tasks.handler.js
├── routes/              # 路由模組
│   ├── router.js
│   ├── clients.routes.js
│   └── tasks.routes.js
└── utils/               # 工具模組
    ├── response.util.js
    ├── validation.util.js
    └── logger.util.js
```

### 8.3 前端重構

#### 目錄結構
```
assets/js/
├── core/                # 核心層
│   ├── config/
│   │   ├── app.config.js
│   │   ├── api.config.js
│   │   └── constants.js
│   ├── api/
│   │   ├── client.js
│   │   ├── endpoints.js
│   │   └── interceptors.js
│   ├── state/
│   │   ├── store.js
│   │   └── user.js
│   └── utils/
│       ├── format.js
│       ├── validate.js
│       └── auth.js
│
├── components/          # 組件層
│   ├── base/
│   │   ├── Button.js
│   │   └── Input.js
│   ├── layout/
│   │   ├── Modal.js
│   │   └── Tabs.js
│   ├── data/
│   │   ├── Table.js
│   │   ├── Form.js
│   │   └── Pagination.js
│   └── feedback/
│       ├── Toast.js
│       └── Loading.js
│
├── modules/             # 業務模組層
│   ├── tasks/
│   │   └── TaskService.js
│   └── clients/
│       └── ClientService.js
│
└── pages/               # 頁面層
    ├── TasksPage.js
    └── DashboardPage.js
```

---

## 9. 清理與維護

### 9.1 需要刪除的文件

#### 資料庫
```sql
DROP TABLE projects;
DROP TABLE multi_stage_templates;
DROP TABLE template_stages;
DROP TABLE service_checklist_templates;
```

#### 後端代碼
```bash
DELETE: timesheet-api/src/projects.js
MOVE TO DEPRECATED:
  - clients.js
  - multi-stage-tasks.js
  - recurring-tasks.js
  （重寫為 Repository + Service + Handler 後刪除）
```

#### 前端代碼
```bash
MOVE TO DEPRECATED:
  - unified-tasks.js (800行 → TasksPage.js 150行)
  - dashboard.js (800行 → DashboardPage.js 120行)
  - settings.js (2300行 → SettingsPage.js 300行)
```

#### HTML 頁面
```bash
DELETE:
  - multi-stage-tasks.html
  - recurring-tasks.html
  - service-config.html
  - projects.html
```

#### 文檔
```bash
DELETE:
  - 系統設計實現比對報告_完整分析.md
  - 系統設計與實現比對報告.md
  - 设计实现比对分析报告.md
  - docs/專案管理系統設計.md
  - docs/專案管理系統整合說明.md
  - docs/資料表版本說明.md
  - docs/遷移文件依賴關係.md
```

### 9.2 文檔整合計劃

#### 刪除過於分散的文檔，整合為核心文檔

**整合前**（過於分散）:
```
- 系統全面重構設計.md
- 前端模組化架構詳細設計.md
- 資料庫重構設計.md
- 標準化開發流程與規範.md
- 重構清理計劃.md
- HTML與CSS規範詳細說明.md
- 完整模組化系統設計.md
- 問題診斷與解決流程.md
- 重構執行總指南.md
```

**整合後**（清晰簡潔）:
```
✅ 保留並整合為一份主文檔：
  - 系統重構總設計文檔.md（本文檔，整合所有設計）

✅ 保留核心參考文檔：
  - 系統架構設計.md（更新為重構後的架構）
  - 開發與部署指南.md（更新為新的流程）
  - API端點文檔.md（更新為新的 API）

✅ 保留功能設計文檔：
  - 任務管理系統設計.md
  - 客戶服務自動化系統設計.md
  - 工時管理系統設計.md
  - 客戶管理系統設計.md
  - 知識庫系統設計.md
  - 報表系統設計.md
  - 內容管理系統設計.md
  - 系統設定與工作台設計.md

❌ 刪除過於詳細的分散文檔：
  - 前端模組化架構詳細設計.md → 整合到本文檔
  - 資料庫重構設計.md → 整合到本文檔
  - 標準化開發流程與規範.md → 整合到本文檔
  - 其他重構相關文檔 → 整合到本文檔
```

---

## 📊 重構效益

### 代碼指標

| 指標 | 重構前 | 重構後 | 改善 |
|------|--------|--------|------|
| 總代碼行數 | 10000 | 3000 | -70% |
| 重複代碼 | 950行 | < 50行 | -95% |
| 最大文件 | 2300行 | 300行 | -87% |
| 平均文件 | 600行 | 150行 | -75% |

### 架構指標

| 指標 | 重構前 | 重構後 |
|------|--------|--------|
| 模組化程度 | 低 | 高 |
| 代碼重用率 | 20% | 80% |
| 測試覆蓋率 | 30% | 80% |
| 文檔準確度 | 70% | 100% |

### 開發效率

| 指標 | 重構前 | 重構後 | 改善 |
|------|--------|--------|------|
| 新功能開發 | 3-5天 | 1-2天 | -60% |
| Bug 修復 | 2-4小時 | 30分鐘 | -75% |
| 新人上手 | 2週 | 3天 | -85% |
| Code Review | 2小時 | 30分鐘 | -75% |

---

## ✅ 最終交付標準

### 代碼質量
- [ ] 代碼重複率 < 5%
- [ ] 所有文件 < 300行
- [ ] 所有函數 < 50行
- [ ] 無死代碼
- [ ] 無 console.log（除錯誤日誌）

### 架構質量
- [ ] 所有模組職責單一
- [ ] 依賴關係清晰
- [ ] 無循環依賴
- [ ] 命名統一一致

### 資料庫質量
- [ ] 所有表命名 100% 一致
- [ ] 所有外鍵統一格式
- [ ] 所有索引已建立
- [ ] 無冗餘表結構

### API 質量
- [ ] 100% RESTful
- [ ] 響應格式 100% 統一
- [ ] 錯誤處理 100% 統一
- [ ] 文檔與實現 100% 一致

### 測試質量
- [ ] 單元測試覆蓋率 > 80%
- [ ] 所有 API 有集成測試
- [ ] 所有頁面有 E2E 測試
- [ ] 性能測試通過

### 文檔質量
- [ ] 所有文檔與代碼 100% 同步
- [ ] 無過時內容
- [ ] 無斷裂引用
- [ ] 所有範例可運行

---

## 📚 快速查找索引

### 我要開發新功能，從哪開始？
→ 第 6 章：標準化開發流程

### 我遇到問題，如何診斷？
→ 第 7 章：問題診斷與解決

### 我要了解資料庫設計？
→ 第 3 章：資料庫標準化設計

### 我要了解前端架構？
→ 第 5 章：前端模組化架構

### 我要了解後端架構？
→ 第 4 章：後端模組化架構

### 我要執行重構？
→ 第 8 章：實施執行計劃

### 我要清理舊代碼？
→ 第 9 章：清理與維護

---

## 🎯 文檔使用指南

### 新人入職
```
Day 1: 閱讀本文檔第 1-2 章（理解現狀和目標）
Day 2: 閱讀本文檔第 3-5 章（理解架構設計）
Day 3: 閱讀本文檔第 6 章（學習開發流程）
Day 4: 實踐開發一個小功能
Day 5: Code Review 和反饋
```

### 開發新功能
```
1. 閱讀第 6 章：標準化開發流程
2. 按照流程逐步執行
3. 每個階段檢查清單
4. 完成後 Code Review
```

### 修復問題
```
1. 閱讀第 7 章：問題診斷與解決
2. 使用五個為什麼找根本原因
3. 系統性解決（不只修復表面）
4. 更新預防機制
```

### 代碼審查
```
1. 檢查是否遵循第 6 章的流程
2. 檢查是否符合各項檢查清單
3. 檢查是否有代碼重複
4. 檢查是否更新了文檔
```

---

## 🚨 重要提醒

### 絕對禁止的做法

```
❌ 表面修復問題（不找根本原因）
❌ 只修改單一文件（不檢查影響範圍）
❌ 覆蓋組件樣式（不修改組件庫）
❌ 複製貼上代碼（不提取共用模組）
❌ 跳過設計階段（直接寫代碼）
❌ 不更新文檔（代碼與文檔不同步）
❌ 不添加測試（無法保證質量）
❌ 保留舊代碼（造成混淆）
```

### 強制執行的規範

```
✅ 任何修改必須先更新設計文檔
✅ 任何樣式問題必須優先考慮組件庫
✅ 任何代碼重複必須提取共用模組
✅ 任何 API 必須符合 RESTful
✅ 任何資料表必須符合命名規範
✅ 任何功能必須有測試
✅ 任何變更必須更新文檔
✅ 完成後必須刪除舊代碼
```

---

## 📖 附錄：設計文檔索引

### 核心設計文檔（整合後）
1. **系統重構總設計文檔.md**（本文檔）- 所有設計的總綱
2. **系統架構設計.md** - 系統總體架構
3. **開發與部署指南.md** - 開發流程和部署

### 功能設計文檔
4. 任務管理系統設計.md
5. 客戶服務自動化系統設計.md
6. 工時管理系統設計.md
7. 客戶管理系統設計.md
8. 知識庫系統設計.md
9. 報表系統設計.md
10. 內容管理系統設計.md
11. 系統設定與工作台設計.md

### 參考文檔
12. API端點文檔.md
13. 前端架构规范.md

**總共 13 份文檔**（從原來的 20+ 份整合而來）

---

## 🎉 結語

本文檔是系統重構的**總設計**，整合了所有重構相關的設計內容。

**核心思想**：
- 📝 **設計先行** - 先設計再編碼
- 🔍 **深度診斷** - 找根本原因不只看表面
- 🏗️ **系統思考** - 系統性解決不只修單點
- 📐 **標準統一** - 所有方面都遵循統一規範
- 🔄 **持續改進** - 不斷優化預防機制

**記住**：
> 表面修復是技術債務  
> 徹底解決才是真正的解決  
> 更新規範是預防的關鍵  
> 模組化架構是系統健康的基石

---

**最後更新**: 2025-10-26  
**維護者**: 開發團隊  
**狀態**: 📘 核心文檔 - 必須遵循

