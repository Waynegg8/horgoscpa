# 內容管理系統 (CMS) 設計

**版本**: 1.0  
**最後更新**: 2025-10-26

---

## 📋 功能概述

內容管理系統用於管理對外網站的部落格文章、資源文件和媒體檔案。

### 核心功能
- 部落格文章管理
- 資源文件管理
- 媒體庫（圖片上傳）
- Markdown 編輯器
- 文章發布/草稿
- SEO 設定

**前端顯示邏輯**：
- 導航欄根據用戶角色顯示相應功能
- 員工（role = 'employee'）：不顯示 CMS 相關選項
- 管理員（role = 'admin'）：顯示所有功能

---

## 🗄️ 資料表結構

### posts (文章)
```sql
CREATE TABLE posts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,               -- 文章標題
  slug TEXT UNIQUE NOT NULL,         -- URL slug
  excerpt TEXT,                      -- 摘要
  content TEXT NOT NULL,             -- 文章內容（Markdown）
  featured_image TEXT,               -- 特色圖片 URL
  post_type TEXT DEFAULT 'blog',     -- blog, resource
  status TEXT DEFAULT 'draft',       -- draft, published, archived
  author_id INTEGER,                 -- 作者
  published_at DATETIME,
  views INTEGER DEFAULT 0,
  meta_title TEXT,                   -- SEO 標題
  meta_description TEXT,             -- SEO 描述
  meta_keywords TEXT,                -- SEO 關鍵字
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (author_id) REFERENCES users(id)
);
```

### media_library (媒體庫)
```sql
CREATE TABLE media_library (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  filename TEXT NOT NULL,            -- 檔案名稱
  original_filename TEXT,            -- 原始檔案名
  file_path TEXT NOT NULL,           -- 檔案路徑/URL
  file_type TEXT,                    -- image/jpeg, image/png, etc.
  file_size INTEGER,                 -- 檔案大小（bytes）
  width INTEGER,                     -- 圖片寬度
  height INTEGER,                    -- 圖片高度
  alt_text TEXT,                     -- 替代文字（SEO）
  uploaded_by INTEGER,               -- 上傳者
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (uploaded_by) REFERENCES users(id)
);
```

---

## 🔄 業務流程

### 文章發布流程
```
1. 建立文章草稿
   - 輸入標題
   - 編寫內容（Markdown）
   - 選擇特色圖片
   ↓
2. 設定 SEO
   - Meta 標題
   - Meta 描述
   - 關鍵字
   ↓
3. 預覽文章
   - 查看渲染效果
   - 檢查排版
   ↓
4. 發布文章
   - UPDATE status = 'published'
   - published_at = NOW()
   - 自動產生 slug
   ↓
5. 更新網站地圖
   - 觸發 sitemap.xml 更新
```

### 媒體上傳流程
```
1. 選擇檔案
   - 支援格式：jpg, png, webp
   - 大小限制：5MB
   ↓
2. 上傳到 Cloudflare R2
   - 壓縮圖片（如需要）
   - 產生唯一檔名
   ↓
3. 記錄到資料庫
   - INSERT INTO media_library
   - 記錄檔案資訊
   ↓
4. 返回圖片 URL
   - 供文章編輯器插入
```

---

## 🔌 API 設計

### 取得文章列表
```
GET /api/posts?status=published&post_type=blog&limit=10

Response:
{
  "success": true,
  "posts": [
    {
      "id": 1,
      "title": "創業公司設立指南",
      "slug": "startup-company-setup-guide",
      "excerpt": "完整的公司設立流程...",
      "featured_image": "https://...",
      "author": "admin",
      "published_at": "2025-10-20",
      "views": 156
    }
  ],
  "total": 25,
  "page": 1
}
```

### 取得單篇文章（公開 API）
```
GET /api/public/posts/{slug}

Response:
{
  "success": true,
  "post": {
    "title": "創業公司設立指南",
    "content": "# 內容...",
    "published_at": "2025-10-20",
    "author": "霍爾果斯會計師",
    "views": 156
  }
}
```

### 建立文章
```
POST /api/posts

Request:
{
  "title": "新文章標題",
  "content": "# Markdown 內容...",
  "excerpt": "文章摘要",
  "post_type": "blog",
  "status": "draft",
  "meta_title": "SEO 標題",
  "meta_description": "SEO 描述"
}

Response:
{
  "success": true,
  "post_id": 2,
  "slug": "new-article-title"
}
```

### 上傳媒體
```
POST /api/media/upload

Request: multipart/form-data
- file: 圖片檔案
- alt_text: 替代文字

Response:
{
  "success": true,
  "media": {
    "id": 10,
    "filename": "abc123.jpg",
    "url": "https://r2.../abc123.jpg",
    "width": 1200,
    "height": 800
  }
}
```

### 取得媒體庫
```
GET /api/media?limit=20&page=1

Response:
{
  "success": true,
  "media": [
    {
      "id": 10,
      "filename": "hero-image.jpg",
      "url": "https://...",
      "file_size": 245678,
      "uploaded_by": "admin",
      "created_at": "2025-10-20"
    }
  ],
  "total": 45
}
```

---

## 💻 前端設計

### 頁面：content-editor.html

#### 文章編輯器
```
[標題輸入框]

[Markdown 編輯器]           [即時預覽]
# 內容...                   渲染後的 HTML

[特色圖片選擇]
[從媒體庫選擇] [上傳新圖片]

SEO 設定:
Meta 標題: [...]
Meta 描述: [...]
關鍵字: [...]

[儲存草稿] [發布] [預覽]
```

#### 媒體庫管理
```
[上傳圖片] [批次上傳]

搜尋: [搜尋媒體...]

網格視圖:
┌────┬────┬────┬────┐
│ 📷 │ 📷 │ 📷 │ 📷 │
│img1│img2│img3│img4│
│ ✓  │    │    │    │
└────┴────┴────┴────┘

[選取] [刪除] [查看詳情]
```

### 頁面：blog.html (公開)

前台部落格文章列表頁面。

### 頁面：resources.html (公開)

前台資源文件列表頁面。

---

## 🔧 實施細節

### Slug 自動生成
```javascript
function generateSlug(title) {
  return title
    .toLowerCase()
    .replace(/[\u4e00-\u9fa5]/g, '')  // 移除中文
    .replace(/[^a-z0-9]+/g, '-')      // 替換特殊字元為 -
    .replace(/^-+|-+$/g, '');         // 移除前後的 -
}

// 範例
generateSlug("創業公司設立指南 2025")
// 結果: "2025"
// 應改進為拼音或手動設定
```

### Markdown 渲染
```javascript
// 使用 marked.js
import { marked } from 'marked';

const htmlContent = marked.parse(markdownContent);
```

### 圖片上傳處理
```javascript
async function uploadImage(file) {
  // 1. 驗證檔案
  if (!file.type.startsWith('image/')) {
    throw new Error('只支援圖片檔案');
  }
  
  if (file.size > 5 * 1024 * 1024) {
    throw new Error('檔案大小不可超過 5MB');
  }
  
  // 2. 壓縮圖片（如需要）
  const compressed = await compressImage(file);
  
  // 3. 上傳到 R2
  const filename = `${Date.now()}_${file.name}`;
  const url = await uploadToR2(compressed, filename);
  
  // 4. 記錄到資料庫
  await saveToMediaLibrary({
    filename,
    original_filename: file.name,
    file_path: url,
    file_type: file.type,
    file_size: compressed.size
  });
  
  return url;
}
```

### 自動草稿保存（✅ 已優化 2025-10-26）

**實施位置**: content-management.js 第484-585行

**優化內容**:

1. **大小檢查** - 防止超過 localStorage 限制
```javascript
const MAX_DRAFT_SIZE = 5 * 1024 * 1024;  // 5MB
if (jsonString.length > MAX_DRAFT_SIZE) {
    console.warn('草稿過大，無法保存');
    // 顯示警告給用戶
    return;
}
```

2. **錯誤處理** - QuotaExceededError
```javascript
catch (error) {
    if (error.name === 'QuotaExceededError') {
        // localStorage 空間已滿
        indicator.textContent = '⚠️ 儲存空間已滿';
        // 自動清理舊草稿
        cleanupOldPostDrafts();
    }
}
```

3. **自動清理** - 只保留最新3個草稿
```javascript
function cleanupOldPostDrafts() {
    // 查找所有 post_draft_* 草稿
    // 按保存時間排序
    // 只保留最新3個，刪除其他
    const MAX_DRAFTS = 3;
    if (draftKeys.length > MAX_DRAFTS) {
        draftKeys.slice(MAX_DRAFTS).forEach(item => {
            localStorage.removeItem(item.key);
        });
    }
}
```

4. **時間戳記錄** - 便於排序和清理
```javascript
const draftData = {
    // ... 其他數據
    saved_at: new Date().toISOString()  // ✅ 新增時間戳
};
```

**特點**:
- ✅ 防止 localStorage 溢出
- ✅ 自動清理舊草稿
- ✅ 友好的錯誤提示
- ✅ 保留最新3個草稿

---

## 🚀 未來擴展

### 計劃功能
- [ ] 文章分類與標籤
- [ ] 文章評論系統
- [ ] 文章排程發布
- [ ] 多作者協作
- [ ] 文章版本控制
- [ ] 文章搜尋（全文檢索）
- [ ] 相關文章推薦
- [ ] 閱讀時間估算
- [ ] 社群分享功能
- [ ] RSS Feed 生成

---

**相關文檔**：
- [系統架構設計.md](./系統架構設計.md) - 整體架構
- [SEO部署指南.md](./SEO部署指南.md) - SEO 優化
- [API端點文檔.md](./API端點文檔.md) - API 參考

