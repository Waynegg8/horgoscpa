# 客戶管理系統設計

**版本**: 1.0  
**最後更新**: 2025-10-26

---

## 📋 功能概述

客戶管理系統用於管理會計師事務所的客戶基本資料、服務配置、互動記錄等。

### 核心功能
- 客戶基本資料 CRUD
- 客戶服務配置管理
- 服務排程設定
- 客戶互動記錄
- 客戶標籤與分類
- 客戶統計報表

---

## 🗄️ 資料表結構

### clients (客戶主表)
```sql
CREATE TABLE clients (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    tax_id TEXT UNIQUE,
    contact_person TEXT,
    phone TEXT,
    email TEXT,
    address TEXT,
    status TEXT DEFAULT 'active' CHECK(status IN ('active', 'inactive', 'potential')),
    region TEXT CHECK(region IN ('台中', '台北', '其他')),
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```
**說明**: 這是客戶資料的唯一來源，取代了舊有的 `clients` 和 `clients_extended` 表。主鍵已改為 `id` (INTEGER)。

### client_services (客戶服務配置)
```sql
CREATE TABLE client_services (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id INTEGER NOT NULL, -- Changed from client_name
  service_type TEXT NOT NULL,
  frequency TEXT NOT NULL,
  fee DECIMAL(10,2) DEFAULT 0,
  estimated_hours DECIMAL(5,2),
  assigned_to INTEGER, -- User ID
  backup_assignee INTEGER, -- User ID
  start_month INTEGER,
  execution_day INTEGER,
  advance_days INTEGER DEFAULT 7,
  due_days INTEGER DEFAULT 15,
  is_active BOOLEAN DEFAULT 1,
  notes TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  last_generated_at DATETIME,
  FOREIGN KEY (client_id) REFERENCES clients(id) ON DELETE CASCADE,
  FOREIGN KEY (assigned_to) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (backup_assignee) REFERENCES users(id) ON DELETE SET NULL
);
```

### client_interactions (客戶互動記錄)
```sql
CREATE TABLE client_interactions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id INTEGER NOT NULL, -- Changed from client_name
  interaction_type TEXT NOT NULL,
  subject TEXT,
  content TEXT,
  interaction_date DATETIME,
  participants TEXT,
  follow_up_required BOOLEAN DEFAULT 0,
  follow_up_date DATE,
  created_by TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (client_id) REFERENCES clients(id) ON DELETE CASCADE
);
```

### timesheets (工時表) - 關聯更新
```sql
-- ... (other columns)
  client_id INTEGER, -- Changed from client_name
-- ... (other columns)
  FOREIGN KEY (client_id) REFERENCES clients(id) ON DELETE SET NULL
-- ... (other columns)
```

**⚠️ 廢棄的資料表**:
- `clients_extended`: 已合併至 `clients`。
- `service_schedule`: 已由 `client_services` 完全取代。
- `client_assignments`: 功能已整合至 `client_services` 的 `assigned_to` 欄位，不再使用。

---

## 🔄 業務流程

### 新增客戶流程
```
1. 輸入客戶基本資料
   - 統一編號、公司名稱
   - 聯絡人、電話、Email
   - 地址、產業類別
   ↓
2. 配置服務項目
   - 選擇服務類型（記帳、營業稅等）
   - 設定頻率
   - 指派負責人
   - 設定費用與工時
   ↓
3. 儲存客戶資料
   - INSERT INTO clients
   - INSERT INTO client_services (多筆)
   ↓
4. 建立客戶指派
   - INSERT INTO client_assignments
```

### 服務配置管理
```
1. 查看客戶服務列表
   - SELECT FROM client_services WHERE client_id = ?
   ↓
2. 新增服務
   - 選擇服務類型
   - 設定執行頻率與日期
   - 設定費用與難度
   ↓
3. 編輯服務
   - 修改執行日期
   - 調整費用
   - 更換負責人
   ↓
4. 停用服務
   - UPDATE is_active = 0
   - 不刪除歷史記錄
```

### 客戶互動記錄
```
1. 記錄客戶互動
   - 選擇互動類型（會議、電話、Email）
   - 填寫主旨與內容
   - 記錄參與人員
   ↓
2. 設定後續追蹤
   - 是否需要追蹤
   - 追蹤日期
   ↓
3. 儲存記錄
   - INSERT INTO client_interactions
```

---

## 🔌 API 設計

### 取得客戶列表
`GET /api/clients?status=active&region=台中`

### 取得客戶詳情
`GET /api/clients/{id}`

### 新增客戶
`POST /api/clients`

### 更新客戶
`PUT /api/clients/{id}`

### 刪除客戶
`DELETE /api/clients/{id}`

### 配置客戶服務
`POST /api/client-services` (Request body now uses `client_id`)

### 取得客戶服務列表
`GET /api/client-services?client_id=1`

### 記錄客戶互動
`POST /api/client-interactions` (Request body now uses `client_id`)

---

## 💻 前端設計

### 頁面：settings.html (客戶管理標籤)

#### 客戶列表視圖
```
搜尋: [搜尋客戶...]  狀態: [全部▾]  [+ 新增客戶]

┌─────────────────────────────────────┐
│ ABC科技公司                          │
│ 統編: 12345678 | 聯絡人: 王小明      │
│ 服務: 記帳、營業稅、營所稅           │
│ 負責: 紜蓁                          │
└─────────────────────────────────────┘
```

#### 客戶詳情側邊欄
```
ABC科技公司
─────────────
統一編號: 12345678
聯絡人: 王小明
電話: 02-1234-5678
Email: contact@abc.com

[服務配置]
✓ 記帳服務 - 每月15日 - $5,000
✓ 營業稅申報 - 雙月20日 - $2,000
✓ 營所稅申報 - 年度 - $15,000

[互動記錄]
2025-10-26 會議 - 年度稅務規劃
2025-09-15 電話 - 發票問題諮詢

[編輯] [刪除] [新增服務]
```

---

## 📊 統計功能

### 客戶統計
```sql
-- 客戶總數與狀態分布
SELECT 
  status,
  COUNT(*) as count
FROM clients
GROUP BY status;
```

### 服務統計
```sql
-- 各服務類型客戶數
SELECT 
  service_type,
  COUNT(DISTINCT client_id) as client_count,
  SUM(fee) as total_monthly_revenue
FROM client_services
WHERE is_active = 1
GROUP BY service_type
ORDER BY client_count DESC;
```

### 負責人工作量
```sql
-- 每位會計師負責的客戶數與服務數
SELECT 
  u.username,
  COUNT(DISTINCT cs.client_id) as client_count,
  COUNT(cs.id) as service_count,
  SUM(cs.estimated_hours) as total_hours
FROM client_services cs
JOIN users u ON cs.assigned_to = u.id
WHERE cs.is_active = 1
GROUP BY u.id
ORDER BY total_hours DESC;
```

---

## 🔧 實施細節

### 服務類型定義
```javascript
const SERVICE_TYPES = {
  accounting: '記帳服務',
  vat: '營業稅申報',
  income_tax: '營所稅申報',
  withholding: '扣繳申報',
  prepayment: '暫繳申報',
  dividend: '盈餘分配',
  nhi: '二代健保補充保費',
  shareholder_tax: '股東可扣抵稅額',
  audit: '財務簽證',
  company_setup: '公司設立登記'
};
```

### 服務頻率定義
```javascript
const FREQUENCY_TYPES = {
  monthly: '每月',
  bimonthly: '雙月',
  quarterly: '每季',
  biannual: '半年',
  annual: '年度'
};
```

### 難度等級定義
```javascript
const DIFFICULTY_LEVELS = {
  1: '簡單 - 發票少、帳務單純',
  2: '普通 - 一般企業',
  3: '中等 - 交易頻繁或科目複雜',
  4: '困難 - 多角化經營或特殊行業',
  5: '極難 - 大型企業或跨國業務'
};
```

---

## 🚀 未來擴展

### 計劃功能
- [ ] 客戶分級管理（VIP、一般、潛在）
- [ ] 客戶生命週期追蹤
- [ ] 合約管理（起迄日期、續約提醒）
- [ ] 客戶滿意度調查
- [ ] 客戶文件庫（上傳合約、證件等）
- [ ] 客戶標籤系統
- [ ] 客戶推薦來源追蹤
- [ ] 客戶收入分析報表

---

**相關文檔**：
- [系統架構設計.md](./系統架構設計.md) - 整體架構
- [客戶服務自動化系統設計.md](./客戶服務自動化系統設計.md) - 自動任務生成
- [API端點文檔.md](./API端點文檔.md) - API 參考

