# è³‡æ–™è¡¨ç‰ˆæœ¬èˆ‡ç”¨é€”èªªæ˜

**ç‰ˆæœ¬**: 1.0  
**æœ€å¾Œæ›´æ–°**: 2025-10-26  
**ç›®çš„**: è§£æ±ºå¤šç‰ˆæœ¬è³‡æ–™è¡¨çš„å›°æƒ‘ï¼Œæ˜ç¢ºèªªæ˜å„ç‰ˆæœ¬ç”¨é€”

---

## ğŸ“‹ å¤šç‰ˆæœ¬è³‡æ–™è¡¨èªªæ˜

### 1. ä»»å‹™ç¯„æœ¬ç³»çµ± (é›™ç‰ˆæœ¬å…±å­˜)

#### ç‰ˆæœ¬ 1: multi_stage_templates + template_stages
**é·ç§»æ–‡ä»¶**: `010_multi_stage_tasks.sql`  
**ç”¨é€”**: â­ **é€šç”¨å¤šéšæ®µä»»å‹™ç¯„æœ¬ç³»çµ±ï¼ˆä¸»è¦ç‰ˆæœ¬ï¼‰**  
**é©ç”¨å ´æ™¯**: 
- å·¥å•†ç™»è¨˜ï¼ˆå…¬å¸è¨­ç«‹ã€è®Šæ›´ã€è§£æ•£ï¼‰
- è²¡ç¨…ç°½è­‰ï¼ˆè²¡ç°½ã€ç¨…å‹™æŸ¥æ ¸ï¼‰
- å¤§å‹å°ˆæ¡ˆä»»å‹™
- éœ€è¦å®¢è£½åŒ–éšæ®µçš„è¤‡é›œä»»å‹™

**ç‰¹é»**:
- å®Œæ•´çš„éšæ®µç®¡ç†ï¼ˆstage_name, description, checklistï¼‰
- æ”¯æ´æ™‚æ•¸ä¼°ç®—ï¼ˆestimated_hoursï¼‰
- æ”¯æ´å¯©æ ¸æµç¨‹ï¼ˆrequires_approvalï¼‰
- å¯å‹•æ…‹èª¿æ•´éšæ®µé †åº

**è³‡æ–™è¡¨çµæ§‹**:
```sql
multi_stage_templates (
  id, template_name, category, description, 
  total_stages, is_active, created_by
)

template_stages (
  id, template_id, stage_order, stage_name, 
  stage_description, checklist, estimated_hours, 
  requires_approval
)
```

#### ç‰ˆæœ¬ 2: service_checklist_templates
**é·ç§»æ–‡ä»¶**: `013_client_services_integration_è¡¥å…….sql`, `019_add_default_checklist_templates.sql`  
**ç”¨é€”**: â­ **å®¢æˆ¶æœå‹™è‡ªå‹•åŒ–å°ˆç”¨æª¢æŸ¥æ¸…å–®**  
**é©ç”¨å ´æ™¯**:
- è¨˜å¸³æœå‹™ï¼ˆæ¯æœˆè‡ªå‹•ç”Ÿæˆï¼‰
- ç‡Ÿæ¥­ç¨…ç”³å ±ï¼ˆé›™æœˆè‡ªå‹•ç”Ÿæˆï¼‰
- ç‡Ÿæ‰€ç¨…ç”³å ±ï¼ˆå¹´åº¦è‡ªå‹•ç”Ÿæˆï¼‰
- æ‰£ç¹³ç”³å ±ï¼ˆå¹´åº¦è‡ªå‹•ç”Ÿæˆï¼‰
- å…¶ä»–é€±æœŸæ€§å®¢æˆ¶æœå‹™

**ç‰¹é»**:
- JSON æ ¼å¼å„²å­˜å®Œæ•´æª¢æŸ¥æ¸…å–®
- èˆ‡ client_services è¡¨æ•´åˆ
- æ”¯æ´è‡ªå‹•ä»»å‹™ç”Ÿæˆ
- ç‰ˆæœ¬æ§åˆ¶ï¼ˆversion æ¬„ä½ï¼‰
- é è¨­ç¯„æœ¬ï¼ˆis_default = 1ï¼‰

**è³‡æ–™è¡¨çµæ§‹**:
```sql
service_checklist_templates (
  id, service_type, template_name, version, 
  checklist_data (JSON), is_active, is_default, 
  created_by
)
```

**JSON æ ¼å¼ç¯„ä¾‹**:
```json
[
  {
    "order": 1,
    "name": "æ”¶é›†æ†‘è­‰",
    "description": "æ”¶é›†æœ¬æœŸæ‰€æœ‰é€²é …ã€éŠ·é …ç™¼ç¥¨åŠç›¸é—œæ†‘è­‰",
    "estimated_hours": 1.0,
    "requires_approval": false,
    "checklist_items": [
      "æ”¶é›†é€²é …ç™¼ç¥¨",
      "æ”¶é›†éŠ·é …ç™¼ç¥¨",
      "æ”¶é›†è²»ç”¨æ†‘è­‰"
    ]
  }
]
```

#### ğŸ”€ å…©ç‰ˆæœ¬çš„é—œä¿‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä»»å‹™ç¯„æœ¬ç³»çµ±æ¶æ§‹                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    å‰µå»ºä»»å‹™
                       â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                           â”‚
    é€šç”¨ä»»å‹™                   å®¢æˆ¶æœå‹™ä»»å‹™
    (æ‰‹å‹•å‰µå»º)                  (è‡ªå‹•ç”Ÿæˆ)
         â”‚                           â”‚
         â†“                           â†“
multi_stage_templates        service_checklist_templates
         â”‚                           â”‚
         â†“                           â†“
  template_stages              (JSON checklist)
         â”‚                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
           multi_stage_tasks + task_stages
              (å¯¦éš›åŸ·è¡Œçš„ä»»å‹™)
```

**çµè«–**: âœ… **é›™ç‰ˆæœ¬æ˜¯æœ‰æ„è¨­è¨ˆï¼Œå„å¸å…¶è·ï¼Œä¸éœ€çµ±ä¸€**

---

### 2. å®¢æˆ¶è³‡æ–™è¡¨ (å·²çµ±ä¸€)

#### åŸå§‹ç°¡åŒ–ç‰ˆ
**é·ç§»æ–‡ä»¶**: `001_complete_schema.sql`  
**ç‹€æ…‹**: âŒ **å·²å»¢æ£„**  
**çµæ§‹**: 
```sql
CREATE TABLE clients (
  name TEXT PRIMARY KEY  -- åªæœ‰åç¨±æ¬„ä½
);
```

#### æ“´å±•å®Œæ•´ç‰ˆ (ç•¶å‰ç‰ˆæœ¬)
**é·ç§»æ–‡ä»¶**: `017_expand_clients_table.sql`  
**ç‹€æ…‹**: âœ… **ç•¶å‰ä½¿ç”¨ç‰ˆæœ¬**  
**çµæ§‹**:
```sql
CREATE TABLE clients (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  tax_id TEXT UNIQUE,                    -- çµ±ä¸€ç·¨è™Ÿ
  name TEXT NOT NULL,                    -- å…¬å¸åç¨±
  contact_person TEXT,                   -- è¯çµ¡äºº
  phone TEXT,                            -- é›»è©±
  email TEXT,                            -- Email
  address TEXT,                          -- åœ°å€
  status TEXT DEFAULT 'active',          -- ç‹€æ…‹
  industry TEXT,                         -- ç”¢æ¥­é¡åˆ¥
  company_type TEXT,                     -- å…¬å¸é¡å‹
  founded_date DATE,                     -- æˆç«‹æ—¥æœŸ
  notes TEXT,                            -- å‚™è¨»
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**é·ç§»éç¨‹**:
1. å‰µå»ºæ–°è¡¨ `clients_new` ï¼ˆå®Œæ•´çµæ§‹ï¼‰
2. é·ç§»èˆŠè³‡æ–™ï¼ˆåªæœ‰ nameï¼‰
3. åˆªé™¤èˆŠè¡¨
4. é‡å‘½åæ–°è¡¨ç‚º `clients`

**çµè«–**: âœ… **å·²æˆåŠŸå‡ç´šï¼Œä½¿ç”¨å®Œæ•´ç‰ˆæœ¬**

---

### 3. å®¢æˆ¶æœå‹™é…ç½®è¡¨ (å·²é‡å»º)

#### èˆŠç‰ˆæœ¬
**é·ç§»æ–‡ä»¶**: `003_clients_expansion.sql`  
**ç‹€æ…‹**: âŒ **å·²å‚™ä»½ä¸¦å»¢æ£„**  
**è¡¨å**: `client_service_schedules`

#### æ–°ç‰ˆæœ¬ (ç•¶å‰ç‰ˆæœ¬)
**é·ç§»æ–‡ä»¶**: `015_rebuild_client_services.sql`  
**ç‹€æ…‹**: âœ… **ç•¶å‰ä½¿ç”¨ç‰ˆæœ¬**  
**è¡¨å**: `client_services`

**é‡å»ºéç¨‹**:
```sql
-- 1. é‡å‘½åèˆŠè¡¨
ALTER TABLE client_services RENAME TO client_services_old;

-- 2. å‰µå»ºæ–°è¡¨ (å®Œæ•´çµæ§‹)
CREATE TABLE client_services (
  id, client_id, service_type, frequency,
  fee, estimated_hours, assigned_to, backup_assignee,
  execution_day, advance_days, due_days,
  invoice_count, difficulty_level,
  is_active, notes, special_requirements,
  created_at, updated_at, last_generated_at
);

-- 3. èˆŠè³‡æ–™ä¿ç•™åœ¨ client_services_oldï¼ˆå¦‚éœ€å›æ»¾ï¼‰
```

**çµè«–**: âœ… **å·²æˆåŠŸé‡å»ºï¼ŒèˆŠç‰ˆæœ¬å·²å‚™ä»½**

---

## ğŸ“Š è³‡æ–™è¡¨ç‰ˆæœ¬å°æ‡‰è¡¨

| åŠŸèƒ½é ˜åŸŸ | èˆŠç‰ˆæœ¬ | æ–°ç‰ˆæœ¬/ç•¶å‰ç‰ˆæœ¬ | ç‹€æ…‹ | é·ç§»æ–‡ä»¶ |
|---------|--------|---------------|------|---------|
| å®¢æˆ¶è³‡æ–™ | clients (ç°¡åŒ–) | clients (å®Œæ•´) | âœ… å·²å‡ç´š | 017 |
| å®¢æˆ¶æœå‹™é…ç½® | client_service_schedules | client_services | âœ… å·²é‡å»º | 015 |
| é€šç”¨ä»»å‹™ç¯„æœ¬ | - | multi_stage_templates | âœ… ä½¿ç”¨ä¸­ | 010, 021 |
| æœå‹™æª¢æŸ¥æ¸…å–® | - | service_checklist_templates | âœ… ä½¿ç”¨ä¸­ | 013, 019 |

---

## ğŸ” å¦‚ä½•æŸ¥è©¢ç•¶å‰ä½¿ç”¨çš„ç‰ˆæœ¬ï¼Ÿ

### æª¢æŸ¥ clients è¡¨çµæ§‹
```sql
-- å¦‚æœæœ‰ tax_id, contact_person ç­‰æ¬„ä½ = å·²å‡ç´š
PRAGMA table_info(clients);
```

### æª¢æŸ¥å…©ç¨®ç¯„æœ¬æ˜¯å¦å…±å­˜
```sql
-- æ‡‰è©²éƒ½å­˜åœ¨
SELECT 'multi_stage_templates' as table_name, COUNT(*) as count 
FROM multi_stage_templates
UNION ALL
SELECT 'service_checklist_templates', COUNT(*) 
FROM service_checklist_templates;
```

### æª¢æŸ¥èˆŠè¡¨æ˜¯å¦é‚„å­˜åœ¨
```sql
-- æª¢æŸ¥æ˜¯å¦æœ‰å‚™ä»½è¡¨
SELECT name FROM sqlite_master 
WHERE type='table' AND name LIKE '%_old%';
```

---

## ğŸ’¡ é–‹ç™¼å»ºè­°

### å‰µå»ºæ–°ä»»å‹™æ™‚

**å¦‚æœæ˜¯é€šç”¨ä»»å‹™** (å·¥å•†ã€è²¡ç¨…ã€å°ˆæ¡ˆ):
```javascript
// ä½¿ç”¨ multi_stage_templates
const templates = await db.all(
  'SELECT * FROM multi_stage_templates WHERE category = ?',
  ['business']
);
```

**å¦‚æœæ˜¯å®¢æˆ¶æœå‹™ä»»å‹™** (è‡ªå‹•ç”Ÿæˆ):
```javascript
// ä½¿ç”¨ service_checklist_templates
const template = await db.get(
  'SELECT * FROM service_checklist_templates WHERE service_type = ? AND is_default = 1',
  ['accounting']
);
```

### è³‡æ–™åº«é·ç§»æ³¨æ„äº‹é …

1. âœ… åŸ·è¡Œé·ç§»å‰å‹™å¿…å‚™ä»½
2. âœ… æŒ‰ç·¨è™Ÿé †åºåŸ·è¡Œé·ç§»æ–‡ä»¶
3. âœ… 017 é·ç§»æœƒé‡å»º clients è¡¨ï¼ˆéœ€æ³¨æ„å¤–éµï¼‰
4. âœ… 015 é·ç§»æœƒå‚™ä»½èˆŠçš„ client_services è¡¨
5. âš ï¸ ä¸è¦åˆªé™¤ `*_old` å‚™ä»½è¡¨ï¼ˆé™¤éç¢ºèªä¸éœ€è¦å›æ»¾ï¼‰

---

## ğŸ“ ç‰ˆæœ¬è®Šæ›´æ­·å²

| æ—¥æœŸ | ç‰ˆæœ¬ | è®Šæ›´èªªæ˜ |
|------|------|---------|
| 2025-10-26 | 1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œèªªæ˜æ‰€æœ‰å¤šç‰ˆæœ¬è³‡æ–™è¡¨çš„ç”¨é€” |

---

**çµè«–**: ç³»çµ±ä¸­çš„å¤šç‰ˆæœ¬è³‡æ–™è¡¨éƒ½æœ‰æ˜ç¢ºç”¨é€”ï¼Œä¸æ˜¯éŒ¯èª¤æˆ–ç–å¿½ï¼Œè€Œæ˜¯æœ‰æ„çš„è¨­è¨ˆã€‚

- âœ… å…©ç¨®ä»»å‹™ç¯„æœ¬ç³»çµ±ï¼š**å…±å­˜ä¸”äº’è£œ**
- âœ… clients è¡¨ï¼š**å·²å‡ç´šåˆ°å®Œæ•´ç‰ˆ**
- âœ… client_services è¡¨ï¼š**å·²é‡å»ºåˆ°æ–°ç‰ˆ**

**ä¸éœ€è¦çµ±ä¸€æˆ–åˆªé™¤ä»»ä½•ç‰ˆæœ¬ï¼**

