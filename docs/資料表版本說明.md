# 資料表版本與用途說明

**版本**: 1.0  
**最後更新**: 2025-10-26  
**目的**: 解決多版本資料表的困惑，明確說明各版本用途

---

## 📋 多版本資料表說明

### 1. 任務範本系統 (雙版本共存)

#### 版本 1: multi_stage_templates + template_stages
**遷移文件**: `010_multi_stage_tasks.sql`  
**用途**: ⭐ **通用多階段任務範本系統（主要版本）**  
**適用場景**: 
- 工商登記（公司設立、變更、解散）
- 財稅簽證（財簽、稅務查核）
- 大型專案任務
- 需要客製化階段的複雜任務

**特點**:
- 完整的階段管理（stage_name, description, checklist）
- 支援時數估算（estimated_hours）
- 支援審核流程（requires_approval）
- 可動態調整階段順序

**資料表結構**:
```sql
multi_stage_templates (
  id, template_name, category, description, 
  total_stages, is_active, created_by
)

template_stages (
  id, template_id, stage_order, stage_name, 
  stage_description, checklist, estimated_hours, 
  requires_approval
)
```

#### 版本 2: service_checklist_templates
**遷移文件**: `013_client_services_integration_补充.sql`, `019_add_default_checklist_templates.sql`  
**用途**: ⭐ **客戶服務自動化專用檢查清單**  
**適用場景**:
- 記帳服務（每月自動生成）
- 營業稅申報（雙月自動生成）
- 營所稅申報（年度自動生成）
- 扣繳申報（年度自動生成）
- 其他週期性客戶服務

**特點**:
- JSON 格式儲存完整檢查清單
- 與 client_services 表整合
- 支援自動任務生成
- 版本控制（version 欄位）
- 預設範本（is_default = 1）

**資料表結構**:
```sql
service_checklist_templates (
  id, service_type, template_name, version, 
  checklist_data (JSON), is_active, is_default, 
  created_by
)
```

**JSON 格式範例**:
```json
[
  {
    "order": 1,
    "name": "收集憑證",
    "description": "收集本期所有進項、銷項發票及相關憑證",
    "estimated_hours": 1.0,
    "requires_approval": false,
    "checklist_items": [
      "收集進項發票",
      "收集銷項發票",
      "收集費用憑證"
    ]
  }
]
```

#### 🔀 兩版本的關係

```
┌─────────────────────────────────────────────────────┐
│                   任務範本系統架構                    │
└─────────────────────────────────────────────────────┘

                    創建任務
                       ↓
         ┌─────────────┴─────────────┐
         │                           │
    通用任務                   客戶服務任務
    (手動創建)                  (自動生成)
         │                           │
         ↓                           ↓
multi_stage_templates        service_checklist_templates
         │                           │
         ↓                           ↓
  template_stages              (JSON checklist)
         │                           │
         └───────────┬───────────────┘
                     ↓
           multi_stage_tasks + task_stages
              (實際執行的任務)
```

**結論**: ✅ **雙版本是有意設計，各司其職，不需統一**

---

### 2. 客戶資料表 (已統一)

#### 原始簡化版
**遷移文件**: `001_complete_schema.sql`  
**狀態**: ❌ **已廢棄**  
**結構**: 
```sql
CREATE TABLE clients (
  name TEXT PRIMARY KEY  -- 只有名稱欄位
);
```

#### 擴展完整版 (當前版本)
**遷移文件**: `017_expand_clients_table.sql`  
**狀態**: ✅ **當前使用版本**  
**結構**:
```sql
CREATE TABLE clients (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  tax_id TEXT UNIQUE,                    -- 統一編號
  name TEXT NOT NULL,                    -- 公司名稱
  contact_person TEXT,                   -- 聯絡人
  phone TEXT,                            -- 電話
  email TEXT,                            -- Email
  address TEXT,                          -- 地址
  status TEXT DEFAULT 'active',          -- 狀態
  industry TEXT,                         -- 產業類別
  company_type TEXT,                     -- 公司類型
  founded_date DATE,                     -- 成立日期
  notes TEXT,                            -- 備註
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**遷移過程**:
1. 創建新表 `clients_new` （完整結構）
2. 遷移舊資料（只有 name）
3. 刪除舊表
4. 重命名新表為 `clients`

**結論**: ✅ **已成功升級，使用完整版本**

---

### 3. 客戶服務配置表 (已重建)

#### 舊版本
**遷移文件**: `003_clients_expansion.sql`  
**狀態**: ❌ **已備份並廢棄**  
**表名**: `client_service_schedules`

#### 新版本 (當前版本)
**遷移文件**: `015_rebuild_client_services.sql`  
**狀態**: ✅ **當前使用版本**  
**表名**: `client_services`

**重建過程**:
```sql
-- 1. 重命名舊表
ALTER TABLE client_services RENAME TO client_services_old;

-- 2. 創建新表 (完整結構)
CREATE TABLE client_services (
  id, client_id, service_type, frequency,
  fee, estimated_hours, assigned_to, backup_assignee,
  execution_day, advance_days, due_days,
  invoice_count, difficulty_level,
  is_active, notes, special_requirements,
  created_at, updated_at, last_generated_at
);

-- 3. 舊資料保留在 client_services_old（如需回滾）
```

**結論**: ✅ **已成功重建，舊版本已備份**

---

## 📊 資料表版本對應表

| 功能領域 | 舊版本 | 新版本/當前版本 | 狀態 | 遷移文件 |
|---------|--------|---------------|------|---------|
| 客戶資料 | clients (簡化) | clients (完整) | ✅ 已升級 | 017 |
| 客戶服務配置 | client_service_schedules | client_services | ✅ 已重建 | 015 |
| 通用任務範本 | - | multi_stage_templates | ✅ 使用中 | 010, 021 |
| 服務檢查清單 | - | service_checklist_templates | ✅ 使用中 | 013, 019 |

---

## 🔍 如何查詢當前使用的版本？

### 檢查 clients 表結構
```sql
-- 如果有 tax_id, contact_person 等欄位 = 已升級
PRAGMA table_info(clients);
```

### 檢查兩種範本是否共存
```sql
-- 應該都存在
SELECT 'multi_stage_templates' as table_name, COUNT(*) as count 
FROM multi_stage_templates
UNION ALL
SELECT 'service_checklist_templates', COUNT(*) 
FROM service_checklist_templates;
```

### 檢查舊表是否還存在
```sql
-- 檢查是否有備份表
SELECT name FROM sqlite_master 
WHERE type='table' AND name LIKE '%_old%';
```

---

## 💡 開發建議

### 創建新任務時

**如果是通用任務** (工商、財稅、專案):
```javascript
// 使用 multi_stage_templates
const templates = await db.all(
  'SELECT * FROM multi_stage_templates WHERE category = ?',
  ['business']
);
```

**如果是客戶服務任務** (自動生成):
```javascript
// 使用 service_checklist_templates
const template = await db.get(
  'SELECT * FROM service_checklist_templates WHERE service_type = ? AND is_default = 1',
  ['accounting']
);
```

### 資料庫遷移注意事項

1. ✅ 執行遷移前務必備份
2. ✅ 按編號順序執行遷移文件
3. ✅ 017 遷移會重建 clients 表（需注意外鍵）
4. ✅ 015 遷移會備份舊的 client_services 表
5. ⚠️ 不要刪除 `*_old` 備份表（除非確認不需要回滾）

---

## 📝 版本變更歷史

| 日期 | 版本 | 變更說明 |
|------|------|---------|
| 2025-10-26 | 1.0 | 初始版本，說明所有多版本資料表的用途 |

---

**結論**: 系統中的多版本資料表都有明確用途，不是錯誤或疏忽，而是有意的設計。

- ✅ 兩種任務範本系統：**共存且互補**
- ✅ clients 表：**已升級到完整版**
- ✅ client_services 表：**已重建到新版**

**不需要統一或刪除任何版本！**

