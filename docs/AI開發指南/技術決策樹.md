# 技术决策树

**供 AI 自动决策使用，用户永远不需要看**

---

## 🎯 使用方式

AI 在做技术决策前，查阅本文档，按照决策树自动选择方案，不问用户技术问题。

---

## 决策1：数据存储方式

### 输入：分析业务需求特征

- 需要保留历史记录？
- 需要多对多关系？
- 是否为配置数据？
- 数据量预估？

### 决策树

```
是否需要历史记录？
├─ 是 → 创建独立表
│  ├─ 添加 created_at, updated_at
│  ├─ 添加 created_by, updated_by
│  └─ 使用软删除（is_deleted, deleted_at）
│
└─ 否 → 
   ├─ 是多对多关系？
   │  ├─ 是 → 创建关联表
   │  │  ├─ 两个外键
   │  │  ├─ 唯一约束
   │  │  └─ 添加关联元数据
   │  │
   │  └─ 否 → 
   │     ├─ 是配置数据？
   │     │  ├─ 是 → 创建配置表
   │     │  │  ├─ 支持动态修改
   │     │  │  ├─ 添加 is_active
   │     │  │  └─ 添加 sort_order
   │     │  │
   │     │  └─ 否 → 在现有表添加字段
   │     │     ├─ 选择最相关的表
   │     │     └─ 考虑查询性能
```

### 实例

**案例1：客户评分**
- 需要历史？是（可能修改评分）
- 决策：创建 ClientRatings 表
- 字段：client_id, rating, rated_by, rated_at, notes

**案例2：客户标签**
- 需要多对多？是（一个客户多个标签，一个标签多个客户）
- 决策：创建 CustomerTags 表 + ClientTagAssignments 关联表

**案例3：系统配置**
- 是配置数据？是
- 决策：创建 SystemSettings 表
- 字段：setting_key, setting_value, is_active

---

## 决策2：API 端点设计

### CRUD 资源

```
对于资源（clients, tasks, users等）：

GET    /api/v1/{resource}           # 列表（支持筛选、分页）
GET    /api/v1/{resource}/:id       # 详情
POST   /api/v1/{resource}           # 新增
PUT    /api/v1/{resource}/:id       # 更新
DELETE /api/v1/{resource}/:id       # 删除（软删除）
```

### 操作端点

```
对于操作（非CRUD）：

POST /api/v1/{resource}/:id/{action}

示例：
POST /api/v1/tasks/123/start      # 开始任务
POST /api/v1/tasks/123/complete   # 完成任务
POST /api/v1/users/456/reset-password  # 重置密码
```

### 关联资源

```
对于子资源：

GET    /api/v1/{parent}/:id/{child}        # 查询某父资源的子资源
POST   /api/v1/{parent}/:id/{child}        # 为某父资源添加子资源
DELETE /api/v1/{parent}/:id/{child}/:cid   # 删除某父资源的子资源

示例：
GET    /api/v1/clients/123/services        # 查询客户的服务
POST   /api/v1/clients/123/services        # 为客户添加服务
DELETE /api/v1/clients/123/services/456    # 删除客户的服务
```

---

## 决策3：前端组件选择

### 检查是否有现成组件

```
需要什么UI？
├─ 表格/列表 → 使用 <DataTable>
│  ├─ 支持排序、筛选、分页
│  └─ 位置：src/components/common/DataTable.vue
│
├─ 表单 → 使用 <FormContainer>
│  ├─ 自动验证
│  ├─ 统一样式
│  └─ 位置：src/components/common/FormContainer.vue
│
├─ 按钮 → 使用 <StyledButton>
│  ├─ 主按钮、次按钮、危险按钮
│  └─ 位置：src/components/common/StyledButton.vue
│
├─ 对话框 → 使用 <Modal>
│  └─ 位置：src/components/common/Modal.vue
│
├─ 加载状态 → 使用 <LoadingSpinner>
│  └─ 位置：src/components/common/LoadingSpinner.vue
│
└─ 特殊需求 → 创建新组件
   ├─ 参考现有组件风格
   ├─ 遵循 Vue 3 Composition API
   └─ 创建可复用组件
```

### 组件复用原则

```
1. 先搜索现有组件
2. 能复用就复用
3. 不能复用再创建
4. 创建时考虑通用性
5. 添加到组件库文档
```

---

## 决策4：权限设计

### 权限级别

```
操作类型？
├─ 敏感操作（删除、修改关键数据、系统配置）
│  └─ 仅管理员（role = 'admin'）
│
├─ 日常操作（查询、新增、修改自己的数据）
│  └─ 所有员工（authenticated）
│
└─ 细粒度控制（修改他人数据）
   ├─ 管理员：无限制
   └─ 员工：仅自己或负责的资源
      └─ 检查 created_by = current_user 或 assigned_to = current_user
```

### 实例

```typescript
// 案例1：删除客户（敏感）
if (user.role !== 'admin') {
  throw new Error('仅管理员可删除客户');
}

// 案例2：查询客户列表（日常）
// 所有员工都可以

// 案例3：修改工时记录（细粒度）
if (user.role !== 'admin' && timelog.user_id !== user.user_id) {
  throw new Error('只能修改自己的工时记录');
}
```

---

## 决策5：索引设计

### 何时建立索引

```
该字段是否：
├─ 经常用于 WHERE 查询？→ 是 → 建索引
├─ 经常用于 JOIN？→ 是 → 建索引
├─ 经常用于 ORDER BY？→ 是 → 建索引
├─ 是外键？→ 是 → 建索引
└─ 表数据量大（>1000行）？→ 是 → 建索引
```

### 索引类型

```sql
-- 单列索引
CREATE INDEX idx_clients_name ON Clients(name);

-- 外键索引
CREATE INDEX idx_timelogs_user ON TimeLogs(user_id);

-- 组合索引（常一起查询的字段）
CREATE INDEX idx_timelogs_user_date ON TimeLogs(user_id, work_date);

-- 唯一索引
CREATE UNIQUE INDEX idx_users_email ON Users(email);
```

---

## 决策6：错误处理

### 错误类型

```
什么情况？
├─ 资源不存在 → 404 NOT_FOUND
├─ 权限不足 → 403 FORBIDDEN
├─ 未登录 → 401 UNAUTHORIZED
├─ 输入验证失败 → 422 UNPROCESSABLE_ENTITY
├─ 服务器错误 → 500 INTERNAL_SERVER_ERROR
└─ 业务逻辑错误 → 400 BAD_REQUEST
```

### 错误回应格式

```typescript
{
  success: false,
  error: {
    code: 'ERROR_CODE',
    message: '用户友好的错误信息',
    details: {
      // 详细错误信息（可选）
    }
  }
}
```

---

## 决策7：性能优化

### 何时需要优化

```
查询是否：
├─ 返回大量数据（>100条）？
│  └─ 是 → 添加分页
│     └─ LIMIT + OFFSET 或游标分页
│
├─ 涉及多表 JOIN？
│  └─ 是 → 检查索引
│     └─ 确保 JOIN 字段有索引
│
├─ 响应时间 > 500ms？
│  └─ 是 → 分析瓶颈
│     ├─ 数据库查询慢 → 优化查询/加索引
│     ├─ 数据处理慢 → 优化算法
│     └─ 网络慢 → 考虑缓存
│
└─ 重复查询相同数据？
   └─ 是 → 添加缓存
      └─ 使用 Cloudflare KV
```

---

## 快速决策表

| 场景 | 决策 | 参考 |
|-----|------|------|
| 用户评分 | 独立表（保留历史）| ClientRatings |
| 客户标签 | 关联表（多对多）| ClientTagAssignments |
| 系统配置 | 配置表 | SystemSettings |
| CRUD操作 | 标准REST端点 | GET/POST/PUT/DELETE |
| 列表显示 | DataTable组件 | 现有组件 |
| 表单输入 | FormContainer组件 | 现有组件 |
| 删除数据 | 仅管理员 + 软删除 | is_deleted |
| 外键字段 | 必须建索引 | FOREIGN KEY + INDEX |
| 大数据查询 | 分页 + 索引 | LIMIT + OFFSET |

---

**AI 使用流程：**
1. 理解业务需求
2. 查阅本决策树
3. 按照决策规则选择方案
4. 不问用户技术问题
5. 直接实现

---

**持续更新：每完成一个功能，记录新的决策规则**

