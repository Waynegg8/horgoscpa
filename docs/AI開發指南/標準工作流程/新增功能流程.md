# 新增功能標準流程

**最後更新：** 2025年10月27日

---

## AI自動執行步驟

當識別到"新增功能"任務時，AI自動按以下步驟執行，**無需用戶提醒**。

---

## 步驟 1：理解階段（5分鐘）

### AI自動執行：

```
1. 讀取相關功能模塊文檔
2. 讀取相關技術規格文檔
3. 讀取相關API規格文檔
4. 讀取相關資料庫設計文檔
```

### AI自動檢查：
- [ ] 是否與現有功能衝突？
- [ ] 是否需要新增資料表？
- [ ] 是否需要新增API端點？
- [ ] 是否影響其他模塊？

---

## 步驟 2：需求確認階段（與用戶討論）

### AI自動提問（一次一個點）：

**功能層面（提供選項）：**

1. 這個功能的核心目的是什麼？
   （簡短描述即可）

2. 誰可以使用這個功能？
   A) 管理員專屬
   B) 開放給所有員工
   C) 僅特定角色員工（請說明）
   D) 其他（請說明）

3. 在哪裡使用？
   A) 新增獨立頁面
   B) 現有頁面的新區塊（請說明哪個頁面）
   C) 彈出視窗/Modal
   D) 其他（請說明）

**資料層面（AI自動分析後提問）：**

AI先自動檢查：
```
✅ 讀取所有現有資料表設計
✅ 分析是否有相關表格可用
✅ 對比類似功能的資料結構
✅ 給出推薦方案
```

然後提問：
4. 需要儲存哪些資料？
   （列出需要的資料欄位）

5. 我檢查了現有資料庫設計，發現：
   
   方案A：使用現有的 {TableName} 表（新增欄位）
   - 優點：{列出優點}
   - 缺點：{列出缺點}
   
   方案B：創建新的 {NewTableName} 表（保持獨立）
   - 優點：{列出優點}
   - 缺點：{列出缺點}
   
   我推薦：{方案X}
   理由：{詳細說明}
   
   您選擇：
   A) 方案A
   B) 方案B
   C) 其他想法（請說明）

**UI層面（AI自動分析後提問）：**

AI先自動檢查：
```
✅ 讀取現有共用組件列表
✅ 分析其他模塊的UI實作
✅ 推薦適合的組件組合
```

然後提問：
7. 前端顯示什麼資訊？
   （列出需要顯示的資訊）

8. 我檢查了現有共用組件，建議使用：
   - <StyledTable> 顯示列表
   - <StyledButton> 操作按鈕
   - <StyledModal> 彈出表單
   
   您覺得：
   A) 符合，使用這些組件
   B) 需要調整（請說明）
   C) 需要其他組件（請說明）

**權限層面（提供選項）：**

9. 是否需要權限控制？
   A) 是，需要在 ModulePermissions 中新增
   B) 否，所有人都可以使用
   C) 使用現有權限即可

10. 不同角色看到的內容是否不同？
    A) 是，管理員和員工看到不同內容
    B) 是，每個員工只看到自己的資料
    C) 否，所有人看到相同內容

### 討論原則：
- ✅ 一次只問一個點
- ✅ 等用戶回答後再繼續
- ✅ 用戶回答不清楚時，提供選項
- ✅ 確認完所有細節後才進入下一步

---

## 步驟 3：設計文檔更新階段

### AI自動執行順序：

**3.1 資料庫設計文檔（優先）**
```
如果需要新增資料表：
1. 在 docs/資料庫設計/{分類}/ 創建新表格文檔
2. 更新 docs/資料庫設計.md 的索引
3. 包含：表格定義、欄位說明、索引、常用查詢

如果修改現有表格：
1. 更新對應的表格文檔
2. 標註新增欄位
```

**3.2 API規格文檔**
```
如果需要新增API端點：
1. 在 docs/API規格/{模塊}/ 創建端點文檔
2. 更新 _概覽.md
3. 包含：請求格式、回應格式、錯誤處理、範例

如果修改現有API：
1. 更新對應端點文檔
2. 標註變更內容
```

**3.3 技術規格文檔**
```
1. 在 docs/技術規格/{模塊}/ 創建或更新文檔
2. 包含：UI設計、業務邏輯、測試案例
```

**3.4 功能模塊文檔**
```
1. 更新或創建 docs/功能模塊/{編號}-{名稱}.md
2. 包含：功能概述、核心功能、使用情境、整合關係
```

### AI自動檢查：
- [ ] 所有文檔已更新
- [ ] 文檔之間的交叉引用已更新
- [ ] 遵循命名規範
- [ ] 每個文檔 < 200行
- [ ] 文檔版本已更新

---

## 步驟 4：編程實作階段

### AI自動執行順序：

**4.1 資料庫Schema**
```typescript
// 1. 創建 D1 遷移檔案
// 2. 定義資料表
// 3. 創建索引
// 4. 如需要，插入初始資料
```

**4.2 後端API**
```typescript
// 按順序創建：
1. Repository（資料存取層）
2. Service（業務邏輯層）
3. Route（API路由層）
4. 在 index.ts 中註冊路由
```

**4.3 前端實作**
```typescript
// 按順序創建：
1. API Service（api/{name}.api.ts）
2. Store（stores/{name}.store.ts）
3. 組件（components/features/{module}/{name}.vue）
4. 頁面（pages/{Name}.vue）
5. 在 router 中註冊路由
```

**4.4 權限整合**
```typescript
// 如需要權限控制：
1. 在 ModulePermissions 新增記錄
2. 在前端路由加上 meta.requiredPermission
3. 在後端API加上 checkModulePermission 中間件
```

### AI自動檢查：
- [ ] 遵循命名規範（camelCase, PascalCase, snake_case）
- [ ] API 使用 /api/v1/ 前綴
- [ ] 使用共用組件（不重複實作）
- [ ] 錯誤處理符合標準
- [ ] 沒有硬編碼（業務規則存資料庫）

---

## 步驟 5：自動部署和測試階段

**⚠️ 重要：AI自己測試驗證，不讓用戶測試！**

### AI自動執行：

**5.1 自動部署**
```bash
# AI使用終端工具自動執行：
cd timesheet-api
npm run build  # 如需建置
npm run deploy # 或重啟服務
# 檢查服務狀態
```

**5.2 自動測試（使用終端工具）**
```bash
# 測試1：正常情況
curl -X POST http://localhost:8787/api/v1/{endpoint} \
  -H "Content-Type: application/json" \
  -d '{測試資料}'

# 檢查回應：
- [ ] 狀態碼 200
- [ ] 回應格式符合文檔
- [ ] 資料正確儲存

# 測試2：邊界條件
# 測試3：錯誤處理
# 測試4：權限控制
```

**5.3 系統性驗證（全局角度）**
```
AI必須檢查：

□ 新功能是否正常運作？
  - 測試了X種正常情況
  - 測試了Y種邊界條件
  - 測試了Z種錯誤情況

□ 是否影響相關功能？
  - 檢查使用相同資料表的功能
  - 檢查相關API端點
  - 運行相關功能測試

□ 是否造成新問題？
  - 檢查錯誤日誌
  - 檢查其他模塊
  - 確認無副作用

□ 是否符合所有規範？
  - 文檔與代碼一致
  - 遵循命名規範
  - 遵循RESTful標準
  - 未修改外部網站
```

**5.4 確認無誤才輸出報告**
```
- [ ] 所有測試通過
- [ ] 無影響其他功能
- [ ] 無造成新問題
- [ ] 文檔與代碼一致
- [ ] 才告訴用戶"已完成並驗證"
```

---

## 步驟 6：完成報告

### AI自動輸出：

```markdown
✅ 新增功能完成：{功能名稱}

已更新文檔：
- ✅ 資料庫設計/{分類}/{表格名}.md
- ✅ API規格/{模塊}/{端點名}.md
- ✅ 技術規格/{模塊}/{主題}.md
- ✅ 功能模塊/{編號}-{名稱}.md

已創建檔案：
- ✅ worker/src/repositories/{name}.repository.ts
- ✅ worker/src/services/{name}.service.ts
- ✅ worker/src/routes/{name}.routes.ts
- ✅ frontend/src/api/{name}.api.ts
- ✅ frontend/src/stores/{name}.store.ts
- ✅ frontend/src/pages/{Name}.vue

已自動部署和測試：
- ✅ 代碼已部署
- ✅ 服務已重啟
- ✅ 正常情況測試通過（測試了5種情況）
- ✅ 邊界條件測試通過（測試了3種邊界）
- ✅ 錯誤處理測試通過（測試了4種錯誤）
- ✅ 權限控制測試通過

系統性驗證：
- ✅ 新功能運作正常（實際測試驗證）
- ✅ 無影響其他功能（檢查了8個相關功能）
- ✅ 無造成新問題（錯誤日誌無異常）
- ✅ 文檔與代碼一致
- ✅ 符合所有專案規範

您可以直接使用，無需測試。
如有任何問題，我會立即修復。
```

**⚠️ 禁止說的話：**
- ❌ "請您測試看看"
- ❌ "您可以驗證一下"
- ❌ "麻煩試試看"

**✅ 必須說的話：**
- ✅ "已完成並驗證，您可以直接使用"
- ✅ "所有測試通過，無需您測試"
- ✅ "如有任何問題，我會立即修復"

---

## 完整示例

### 用戶需求：
```
我需要新增一個"客戶標籤"功能，可以為客戶打上多個標籤（如"VIP"、"欠款"等）
```

### AI自動執行（完整流程）：

**步驟1：理解階段**
```
AI讀取：
- 功能模塊/客戶管理相關文檔
- 資料庫設計/核心業務/Clients.md
- API規格/客戶API相關文檔
```

**步驟2：確認階段**
```
AI提問：
Q1: 標籤是預設的固定選項，還是可以自由新增？
用戶：可以自由新增

Q2: 一個客戶可以有多個標籤嗎？
用戶：是的，可以多個

Q3: 誰可以新增/編輯標籤？管理員還是所有員工？
用戶：所有有權限看客戶管理的人都可以

Q4: 標籤要顯示在客戶列表還是客戶詳情？
用戶：兩者都要顯示

Q5: 需要顯示每個標籤被多少客戶使用嗎？
用戶：不需要
```

**步驟3：更新文檔**
```
AI自動更新：
1. docs/資料庫設計/核心業務/ClientTags.md（新建）
2. docs/資料庫設計/核心業務/ClientTagRelations.md（新建）
3. docs/資料庫設計.md（更新索引）
4. docs/API規格/客戶/新增標籤.md（新建）
5. docs/API規格/客戶/移除標籤.md（新建）
6. docs/API規格/客戶/獲取所有標籤.md（新建）
7. docs/API規格/客戶/_概覽.md（更新）
8. docs/技術規格/客戶管理/標籤功能.md（新建）
9. docs/功能模塊/客戶管理.md（更新）
```

**步驟4：編程實作**
```
AI自動創建：
1. D1遷移：CREATE TABLE ClientTags, ClientTagRelations
2. worker/src/repositories/clientTag.repository.ts
3. worker/src/services/clientTag.service.ts
4. worker/src/routes/clientTags.routes.ts
5. frontend/src/api/clientTag.api.ts
6. frontend/src/stores/clientTag.store.ts
7. frontend/src/components/features/clients/TagManager.vue
8. 更新 frontend/src/pages/Clients.vue
```

**步驟5：驗證**
```
AI自動檢查：
✅ 所有文檔已更新
✅ 代碼符合規範
✅ 未修改外部網站
✅ API使用RESTful標準
```

---

## 相關文檔

- [AI開發指南](../AI開發指南.md)
- [任務類型自動識別](../任務類型自動識別.md)
- [修改功能流程](./修改功能流程.md)
- [開發規範](../../開發規範.md)

---

## 🧠 AI思考過程示例

### 示例：新增"客戶評分"功能

**用戶需求：** 我需要新增一個客戶評分功能

**AI完整思考過程：**

```
第一層思考：這是什麼類型的任務？
→ 關鍵詞："新增"
→ 識別為：新增功能
→ 觸發：新增功能標準流程

第二層思考：需要了解什麼？
→ 需要讀取哪些文檔？
  ✓ 功能模塊/客戶管理.md
  ✓ 資料庫設計/核心業務/Clients.md
  ✓ API規格/客戶/_概覽.md
  ✓ 檢查是否有類似功能（任務評分？）

第三層思考：有沒有類似功能可參考？
→ 搜索現有代碼...
→ 發現：TaskRatings 表（任務評分功能）
→ 結構：user_id, task_id, rating, comment, created_at
→ 決策：參考這個設計，保持一致性

第四層思考：要問用戶什麼問題？
→ 業務問題列表：
  Q1: 評分範圍（1-5？1-10？）
  Q2: 誰可以評分（管理員？員工？）
  Q3: 是否需要評論
  Q4: 前端顯示位置

→ 技術問題（自己分析）：
  ✓ 資料庫：創建 ClientRatings 表（參考 TaskRatings）
  ✓ API：POST /api/v1/clients/:id/ratings
  ✓ 前端：使用現有評分組件

第五層思考：開始與用戶討論
→ 一次一個問題，提供選項
→ 等待回答後再繼續

（用戶回答：1-5分，管理員和負責員工可評分）

第六層思考：技術方案選擇
→ 方案A：在 Clients 表新增 rating 欄位
  優點：查詢簡單
  缺點：只能一個評分，無歷史
  
→ 方案B：創建 ClientRatings 表
  優點：多人評分，有歷史
  缺點：需要JOIN
  
→ 決策：方案B
→ 理由：用戶說"管理員和負責員工都可以評分"
        → 代表多人可能評分
        → 需要記錄誰評的
        → 方案B更合適

第七層思考：UI組件選擇
→ 檢查現有組件...
→ 發現：<RatingInput> 組件（星星評分）
→ 發現：<StyledTable> 組件（顯示評分歷史）
→ 發現：<StyledModal> 組件（評分彈窗）
→ 決策：復用這些組件，保持UI一致性

第八層思考：文檔更新順序
→ 順序很重要，從資料層到UI層：
  1. ClientRatings.md（資料庫設計）
  2. 新增評分.md（API規格）
  3. 獲取評分.md（API規格）
  4. 評分功能.md（技術規格）
  5. 客戶管理.md（功能模塊）

第九層思考：代碼實作順序
→ 從後端到前端：
  1. ClientRating Repository（資料存取）
  2. ClientRating Service（業務邏輯）
  3. ClientRating Routes（API路由）
  4. clientRating.api.ts（前端API）
  5. clientRating.store.ts（狀態管理）
  6. RatingHistory.vue（評分組件）
  7. 更新 ClientDetail.vue（整合）

第十層思考：測試什麼？
→ 正常情況：
  ✓ 新增評分（1-5分）
  ✓ 獲取評分列表
  ✓ 計算平均分
  
→ 邊界條件：
  ✓ 評分超過5分（應該拒絕）
  ✓ 評分小於1分（應該拒絕）
  ✓ 重複評分（應該更新而非新增？）
  
→ 權限控制：
  ✓ 普通員工評分（應該拒絕）
  ✓ 管理員評分（應該允許）
  ✓ 負責員工評分（應該允許）
  
→ 影響範圍：
  ✓ 客戶列表顯示平均分
  ✓ 客戶詳情顯示評分歷史
  ✓ 不影響其他客戶功能

第十一層思考：全局檢查
→ 文檔一致性：
  ✓ 資料庫設計說 1-5分
  ✓ API文檔也說 1-5分
  ✓ 代碼驗證也是 1-5分
  ✓ 一致！
  
→ 命名一致性：
  ✓ 資料表：ClientRatings（PascalCase）
  ✓ 欄位：client_id（snake_case）
  ✓ API：/api/v1/clients/:id/ratings
  ✓ Service：clientRatingService（camelCase）
  ✓ 一致！
  
→ 安全檢查：
  ✓ 沒有修改 assets/ 資料夾
  ✓ 沒有修改根目錄 HTML
  ✓ 所有代碼在 timesheet-api/
  ✓ 安全！

第十二層思考：是否真的完成了？
→ 自我質疑：
  ❓ 測試真的通過了嗎？（是，已執行）
  ❓ 會不會影響其他功能？（已檢查，不會）
  ❓ 是否有遺漏的地方？（檢查清單全過）
  ❓ 文檔真的都更新了嗎？（是，9個文檔）
  ❓ 可以讓用戶直接使用嗎？（是，已驗證）
  
→ 結論：真的完成了！可以輸出完成報告
```

### 關鍵思考模式

**模式1：總是問"為什麼"**
```
- 為什麼選方案B而不是方案A？
  → 因為需求暗示多人可能評分
  
- 為什麼參考 TaskRatings 的設計？
  → 保持專案一致性
  
- 為什麼要測試權限控制？
  → 因為需求說"管理員和負責員工"
```

**模式2：總是對比檢查**
```
- 對比類似功能（任務評分）
- 對比現有組件（評分組件）
- 對比命名規範（其他表格）
- 對比文檔設計（其他API）
```

**模式3：總是全局思考**
```
- 這個改動影響哪些地方？
  → 客戶列表、客戶詳情、評分管理
  
- 需要更新哪些文檔？
  → 資料庫、API、技術規格、功能模塊
  
- 會不會影響其他功能？
  → 檢查使用 Clients 表的其他功能
```

**模式4：總是自我驗證**
```
- 文檔與代碼一致嗎？
- 測試真的通過了嗎？
- 有沒有遺漏的地方？
- 可以讓用戶直接使用嗎？
```

---

## 相關文檔

- [AI開發指南](../AI開發指南.md)
- [AI工作原則](../AI工作原則.md)
- [AI思考過程示例](../AI思考過程示例.md)
- [任務類型自動識別](../任務類型自動識別.md)
- [修改功能流程](./修改功能流程.md)
- [開發規範](../../開發規範.md)

---

**最後更新：** 2025年10月27日
