# 優化代碼標準流程

**最後更新：** 2025年10月27日

---

## AI自動執行步驟

當識別到"優化代碼"或"代碼審查"任務時，AI自動按以下步驟執行。

---

## 步驟 1：功能模塊選擇

### AI自動執行：

```
AI自動掃描專案，列出所有功能模塊供您選擇
```

### AI自動輸出：

```markdown
我已經掃描了整個專案，以下是所有功能模塊：

【核心業務】
1. 員工帳號管理
2. 客戶管理
3. 工時表填寫
4. 工時報表

【業務規則】
5. 業務規則管理
6. 假期餘額查詢
7. 生活事件登記

【任務系統】
8. 任務模板管理
9. 任務進度追蹤
10. 階段進度更新

【知識庫】
11. SOP文件管理
12. 通用知識庫

請選擇要檢查的模塊（可多選，用逗號分隔）：
例如：3,4 或 "全部"
```

---

## 步驟 2：代碼全面掃描

### AI自動執行：

**2.1 讀取所有相關文檔**
```
AI自動讀取：
- 功能模塊文檔
- 技術規格文檔
- API規格文檔
- 資料庫設計文檔
- 開發規範文檔
```

**2.2 掃描所有相關代碼**
```
AI自動掃描：
- 後端：repositories/*.ts, services/*.ts, routes/*.ts
- 前端：pages/*.vue, components/**/*.vue, stores/*.ts, api/*.ts
- 資料庫：schema定義
```

**2.3 建立代碼清單**
```
AI自動建立：
檔案清單：
- worker/src/services/timesheet.service.ts
- worker/src/repositories/timesheet.repository.ts
- worker/src/routes/timesheet.routes.ts
- frontend/src/pages/Timesheet.vue
- frontend/src/components/features/timesheet/TimesheetGrid.vue
- frontend/src/stores/timesheet.store.ts
- frontend/src/api/timesheet.api.ts

共 X 個檔案，約 Y 行代碼
```

---

## 步驟 3：自動問題檢測

### AI自動檢查項目：

**3.1 標準化檢查**

```typescript
// AI自動檢查：

□ 業務規則是否硬編碼？
  ❌ 發現：service.ts 中硬編碼加班費率
  ✅ 建議：改為從 OvertimeRates 表查詢

□ 是否使用參數化查詢？
  ❌ 發現：repository.ts 中使用字串拼接SQL
  ✅ 建議：改為 db.prepare().bind()

□ API是否使用/api/v1/前綴？
  ✅ 符合標準

□ 是否使用標準回應格式？
  ❌ 發現：部分API直接返回data，未包裝
  ✅ 建議：使用 successResponse() 包裝
```

**3.2 模塊化檢查**

```typescript
// AI自動檢查：

□ 是否使用共用組件？
  ❌ 發現：TimesheetGrid.vue 中自己實作按鈕
  📝 對比：TaskBoard.vue 中也自己實作了類似按鈕
  ✅ 建議：兩者都改用 <StyledButton>

□ 是否重複實作相同邏輯？
  ❌ 發現：timesheet.service.ts 和 leave.service.ts 都有相同的日期計算邏輯
  ✅ 建議：提取到 utils/date.util.ts

□ Service層是否職責單一？
  ❌ 發現：timesheet.service.ts 中包含權限檢查邏輯
  ✅ 建議：權限檢查應在 middleware 或 route 層

□ 是否有未使用的代碼？
  ❌ 發現：3個未使用的函數
  ✅ 建議：刪除
```

**3.3 命名規範檢查**

```typescript
// AI自動檢查：

□ 變數命名是否符合 camelCase？
  ❌ 發現：5處使用 snake_case
  ✅ 建議：改為 camelCase

□ 資料表欄位是否符合 snake_case？
  ✅ 符合標準

□ API端點是否符合RESTful？
  ❌ 發現：POST /api/v1/timesheets/get（應該用GET）
  ✅ 建議：改為 GET /api/v1/timesheets
```

**3.4 安全檢查**

```typescript
// AI自動檢查：

□ 密碼是否使用 Argon2？
  ✅ 符合標準

□ Cookie是否設定 HttpOnly？
  ✅ 符合標準

□ 是否有SQL Injection風險？
  ❌ 發現：2處未使用參數化查詢
  ✅ 建議：修改

□ 是否修改了外部網站檔案？
  ✅ 未修改
```

**3.5 效能檢查**

```typescript
// AI自動檢查：

□ 是否有N+1查詢問題？
  ❌ 發現：在循環中查詢資料庫
  ✅ 建議：改為一次查詢後在記憶體中處理

□ 是否有缺少的索引？
  ❌ 發現：TimeLogs.work_date 未建立索引（常用於查詢）
  ✅ 建議：新增索引

□ 查詢是否過度？
  ❌ 發現：查詢了不必要的欄位
  ✅ 建議：只查詢需要的欄位
```

**3.6 文檔一致性檢查**

```typescript
// AI自動檢查：

□ 代碼是否符合設計文檔？
  ❌ 發現：API規格文檔說明回應包含 weighted_hours，但實際代碼未返回
  ✅ 建議：修改代碼以符合文檔

□ 設計文檔是否完整？
  ❌ 發現：技術規格文檔缺少錯誤處理說明
  ✅ 建議：補充文檔

□ 測試案例是否涵蓋？
  ❌ 發現：缺少邊界條件測試
  ✅ 建議：新增測試案例
```

---

## 步驟 4：問題報告與優先級排序

### AI自動輸出：

```markdown
✅ 代碼審查完成：工時表模塊

檢查範圍：
- 7個檔案
- 約1,200行代碼

發現問題總計：23個
- 🔴 嚴重問題：5個（必須修復）
- 🟡 中等問題：12個（建議修復）
- 🟢 輕微問題：6個（可選修復）

【🔴 嚴重問題】

1. SQL Injection 風險（安全）
   位置：worker/src/repositories/timesheet.repository.ts:45
   問題：未使用參數化查詢
   風險：可能導致資料庫被攻擊
   建議：改為 db.prepare().bind()
   
2. 硬編碼業務規則（標準化）
   位置：worker/src/services/timesheet.service.ts:78
   問題：加班費率直接寫在代碼中
   風險：修改規則需要改代碼並重新部署
   建議：從 OvertimeRates 表查詢

3. 未使用共用組件（模塊化）
   位置：frontend/src/components/features/timesheet/TimesheetGrid.vue:120-130
   問題：自己實作按鈕
   對比：TaskBoard.vue:89-95 也有相同問題
   建議：兩者都改用 <StyledButton> 共用組件
   
4. N+1 查詢問題（效能）
   位置：worker/src/services/timesheet.service.ts:156
   問題：在循環中查詢資料庫（每個員工一次查詢）
   影響：10個員工需要10次查詢，100個員工需要100次查詢
   建議：改為一次查詢所有資料

5. API回應不符合文檔（一致性）
   位置：worker/src/routes/timesheet.routes.ts:67
   文檔：API規格/工時/新增工時記錄.md 說明應返回 weighted_hours
   實際：代碼未返回 weighted_hours
   建議：修改代碼以符合文檔，或更新文檔

【🟡 中等問題】

6. 重複邏輯（模塊化）
   位置：
   - worker/src/services/timesheet.service.ts:234-256
   - worker/src/services/leave.service.ts:178-198
   問題：兩處都實作相同的日期計算邏輯
   建議：提取到 utils/date.util.ts

... (其他11個中等問題)

【🟢 輕微問題】

17. 命名不符合規範
    位置：frontend/src/stores/timesheet.store.ts:23
    問題：變數名 work_date 應改為 workDate（camelCase）
    
... (其他5個輕微問題)

我的建議執行順序：
1. 先修復所有🔴嚴重問題（安全和標準化優先）
2. 再修復🟡中等問題（模塊化和效能）
3. 最後修復🟢輕微問題（如時間允許）

您想要我：
A) 自動修復所有問題（我會先更新文檔再改代碼）
B) 只修復🔴嚴重問題
C) 讓我選擇特定問題修復
D) 先給我看詳細的修改計劃，您批准後再執行
```

---

## 步驟 5：自動修復執行

### AI自動執行（如用戶選擇A或B）：

**5.1 分組修復**
```
AI自動分組：
組1：標準化問題（5個）→ 需要更新設計文檔
組2：模塊化問題（8個）→ 需要創建共用組件
組3：效能問題（4個）→ 需要更新資料庫設計
組4：命名問題（6個）→ 直接修改代碼
```

**5.2 按組執行**

```markdown
【開始修復組1：標準化問題】

問題1：硬編碼加班費率
1. ✅ 讀取現有設計：
   - 已存在 OvertimeRates 資料表
   - 已有 API規格/業務規則/加班費率/獲取加班費率列表.md
   
2. ✅ 分析現有實作：
   - 其他模塊（leave.service.ts）已正確從資料表查詢
   - 可以參考其實作方式
   
3. ✅ 修改代碼：
   修改前：
   ```typescript
   const rate = workType === '平日加班' ? 1.34 : 1.67;
   ```
   
   修改後：
   ```typescript
   const rateRecord = await db.prepare(
     'SELECT rate FROM OvertimeRates WHERE overtime_type = ?'
   ).bind(workType).first();
   const rate = rateRecord.rate;
   ```

4. ✅ 更新文檔（如需要）：
   - 技術規格/工時表/業務邏輯.md 已有說明，無需更新

✅ 問題1已修復

問題2：SQL Injection風險
1. ✅ 讀取開發規範：
   - 開發規範.md 明確要求使用參數化查詢
   
2. ✅ 修改代碼：
   修改前：
   ```typescript
   const sql = `SELECT * FROM TimeLogs WHERE user_id = ${userId}`;
   const result = await db.prepare(sql).all();
   ```
   
   修改後：
   ```typescript
   const result = await db.prepare(
     'SELECT * FROM TimeLogs WHERE user_id = ?'
   ).bind(userId).all();
   ```

✅ 問題2已修復

... (繼續修復其他問題)
```

**5.3 修復共用組件問題**

```markdown
【開始修復組2：模塊化問題 - 未使用共用組件】

AI自動分析：
- TimesheetGrid.vue 和 TaskBoard.vue 都自己實作按鈕
- 對比兩者代碼，發現樣式和功能相同
- 已存在共用組件：components/common/StyledButton.vue

AI自動執行：
1. ✅ 讀取共用組件定義：
   - StyledButton 支援 variant: 'primary' | 'secondary' | 'danger'
   - 支援 size: 'sm' | 'md' | 'lg'
   
2. ✅ 修改 TimesheetGrid.vue：
   修改前：
   ```vue
   <button class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">
     儲存
   </button>
   ```
   
   修改後：
   ```vue
   <StyledButton variant="primary" @click="save">儲存</StyledButton>
   ```

3. ✅ 修改 TaskBoard.vue：
   同樣改用 <StyledButton>

4. ✅ 更新文檔：
   - 技術規格/工時表/UI設計.md 補充說明使用共用組件
   - 技術規格/任務追蹤/UI設計.md 補充說明使用共用組件

✅ 共用組件問題已全部修復
```

---

## 步驟 6：驗證與報告

### AI自動執行：

```markdown
✅ 代碼優化完成：工時表模塊

修復總結：
- 🔴 嚴重問題：5個 → ✅ 已全部修復
- 🟡 中等問題：12個 → ✅ 已全部修復
- 🟢 輕微問題：6個 → ✅ 已全部修復

已修改檔案：
【後端】
- ✅ worker/src/services/timesheet.service.ts
  - 移除硬編碼，改為查詢資料表
  - 提取重複邏輯到 utils/date.util.ts
  - 修復N+1查詢問題
  
- ✅ worker/src/repositories/timesheet.repository.ts
  - 所有查詢改為參數化
  - 新增缺失的索引（已更新資料庫設計文檔）
  
- ✅ worker/src/routes/timesheet.routes.ts
  - API回應格式改為符合文檔
  - 修復RESTful命名問題

【前端】
- ✅ frontend/src/components/features/timesheet/TimesheetGrid.vue
  - 改用 <StyledButton> 共用組件
  - 改用 <StyledTable> 共用組件
  - 命名改為 camelCase
  
- ✅ frontend/src/stores/timesheet.store.ts
  - 命名改為 camelCase
  - 移除未使用的代碼

【共用工具】
- ✅ worker/src/utils/date.util.ts
  - 新增 calculateDaysBetween()
  - 新增 isWeekend()
  （從重複代碼中提取）

已更新文檔：
- ✅ 技術規格/工時表/UI設計.md（補充共用組件說明）
- ✅ 技術規格/工時表/業務邏輯.md（補充錯誤處理）
- ✅ 資料庫設計/核心業務/TimeLogs.md（新增索引說明）

代碼質量提升：
- 安全性：SQL Injection風險 → ✅ 已消除
- 標準化：硬編碼業務規則 → ✅ 已改為資料表驅動
- 模塊化：重複代碼 -67% → ✅ 提取到共用工具
- 模塊化：共用組件使用率 +100% → ✅ 全部改用共用組件
- 效能：N+1查詢 → ✅ 已優化為單次查詢
- 一致性：代碼與文檔 → ✅ 100%一致

建議：
1. 對其他模塊執行相同的審查（我可以繼續）
2. 建立定期代碼審查機制（每月一次）
3. 在新增功能時，自動檢查是否使用共用組件
```

---

## 完整示例

### 用戶需求：
```
@AI開發指南.md 我想優化代碼，檢查是否都有模塊化和標準化
```

### AI自動執行：

```
AI：✅ 已讀取AI開發指南
    ✅ 識別為：代碼審查/優化
    ✅ 開始執行優化代碼流程
    
    我已經掃描了整個專案，以下是所有功能模塊：
    
    【核心業務】
    1. 員工帳號管理
    2. 客戶管理  
    3. 工時表填寫
    4. 工時報表
    
    【業務規則】
    5. 業務規則管理
    6. 假期餘額查詢
    
    【任務系統】
    7. 任務模板管理
    8. 任務進度追蹤
    
    請選擇要檢查的模塊（可多選，用逗號分隔）：

您：3,4

AI：收到，我將檢查：
    - 工時表填寫
    - 工時報表
    
    開始掃描代碼...
    
    ✅ 已掃描 12個檔案，約 2,300行代碼
    ✅ 已讀取所有相關設計文檔
    ✅ 已對比其他模塊的實作方式
    ✅ 已檢查是否符合專案規範
    
    發現問題總計：18個
    - 🔴 嚴重問題：3個
    - 🟡 中等問題：10個
    - 🟢 輕微問題：5個
    
    【🔴 嚴重問題】
    
    1. 未使用共用組件（模塊化）
       位置：TimesheetGrid.vue:120-130
       問題：自己實作按鈕
       對比：我檢查了 TaskBoard.vue，它正確使用了 <StyledButton>
       建議：改用 <StyledButton>
       
    2. 硬編碼業務規則（標準化）
       位置：timesheet.service.ts:78
       問題：加班費率寫死在代碼中
       我檢查了：
       - ✅ OvertimeRates 資料表已存在
       - ✅ leave.service.ts 已正確從資料表查詢
       建議：參考 leave.service.ts 的實作方式
       
    3. N+1查詢問題（效能）
       位置：timesheet.service.ts:156
       問題：在循環中查詢資料庫
       建議：改為一次查詢所有資料
    
    ... (其他問題)
    
    您想要我：
    A) 自動修復所有問題
    B) 只修復🔴嚴重問題
    C) 讓我選擇特定問題修復

您：A

AI：收到，我將自動修復所有18個問題。
    
    【開始修復】
    
    問題1：未使用共用組件
    1. ✅ 檢查共用組件定義（components/common/StyledButton.vue）
    2. ✅ 修改 TimesheetGrid.vue
    3. ✅ 更新技術規格文檔
    ✅ 問題1已修復
    
    問題2：硬編碼業務規則
    1. ✅ 確認 OvertimeRates 表存在
    2. ✅ 參考 leave.service.ts 的實作
    3. ✅ 修改 timesheet.service.ts
    ✅ 問題2已修復
    
    ... (繼續修復)
    
    ✅ 所有問題已修復！
    
    修復總結：
    - 已修改 12個檔案
    - 已更新 5個設計文檔
    - 代碼質量提升：
      * 模塊化 +100%
      * 標準化 +100%
      * 效能 +45%
    
    建議：
    - 可以繼續檢查其他模塊
    - 建議建立每月定期審查機制
```

---

## 相關文檔

- [AI開發指南](../AI開發指南.md)
- [任務類型自動識別](../任務類型自動識別.md)
- [開發規範](../../開發規範.md)

---

**最後更新：** 2025年10月27日



**最後更新：** 2025年10月27日

---

## AI自動執行步驟

當識別到"優化代碼"或"代碼審查"任務時，AI自動按以下步驟執行。

---

## 步驟 1：功能模塊選擇

### AI自動執行：

```
AI自動掃描專案，列出所有功能模塊供您選擇
```

### AI自動輸出：

```markdown
我已經掃描了整個專案，以下是所有功能模塊：

【核心業務】
1. 員工帳號管理
2. 客戶管理
3. 工時表填寫
4. 工時報表

【業務規則】
5. 業務規則管理
6. 假期餘額查詢
7. 生活事件登記

【任務系統】
8. 任務模板管理
9. 任務進度追蹤
10. 階段進度更新

【知識庫】
11. SOP文件管理
12. 通用知識庫

請選擇要檢查的模塊（可多選，用逗號分隔）：
例如：3,4 或 "全部"
```

---

## 步驟 2：代碼全面掃描

### AI自動執行：

**2.1 讀取所有相關文檔**
```
AI自動讀取：
- 功能模塊文檔
- 技術規格文檔
- API規格文檔
- 資料庫設計文檔
- 開發規範文檔
```

**2.2 掃描所有相關代碼**
```
AI自動掃描：
- 後端：repositories/*.ts, services/*.ts, routes/*.ts
- 前端：pages/*.vue, components/**/*.vue, stores/*.ts, api/*.ts
- 資料庫：schema定義
```

**2.3 建立代碼清單**
```
AI自動建立：
檔案清單：
- worker/src/services/timesheet.service.ts
- worker/src/repositories/timesheet.repository.ts
- worker/src/routes/timesheet.routes.ts
- frontend/src/pages/Timesheet.vue
- frontend/src/components/features/timesheet/TimesheetGrid.vue
- frontend/src/stores/timesheet.store.ts
- frontend/src/api/timesheet.api.ts

共 X 個檔案，約 Y 行代碼
```

---

## 步驟 3：自動問題檢測

### AI自動檢查項目：

**3.1 標準化檢查**

```typescript
// AI自動檢查：

□ 業務規則是否硬編碼？
  ❌ 發現：service.ts 中硬編碼加班費率
  ✅ 建議：改為從 OvertimeRates 表查詢

□ 是否使用參數化查詢？
  ❌ 發現：repository.ts 中使用字串拼接SQL
  ✅ 建議：改為 db.prepare().bind()

□ API是否使用/api/v1/前綴？
  ✅ 符合標準

□ 是否使用標準回應格式？
  ❌ 發現：部分API直接返回data，未包裝
  ✅ 建議：使用 successResponse() 包裝
```

**3.2 模塊化檢查**

```typescript
// AI自動檢查：

□ 是否使用共用組件？
  ❌ 發現：TimesheetGrid.vue 中自己實作按鈕
  📝 對比：TaskBoard.vue 中也自己實作了類似按鈕
  ✅ 建議：兩者都改用 <StyledButton>

□ 是否重複實作相同邏輯？
  ❌ 發現：timesheet.service.ts 和 leave.service.ts 都有相同的日期計算邏輯
  ✅ 建議：提取到 utils/date.util.ts

□ Service層是否職責單一？
  ❌ 發現：timesheet.service.ts 中包含權限檢查邏輯
  ✅ 建議：權限檢查應在 middleware 或 route 層

□ 是否有未使用的代碼？
  ❌ 發現：3個未使用的函數
  ✅ 建議：刪除
```

**3.3 命名規範檢查**

```typescript
// AI自動檢查：

□ 變數命名是否符合 camelCase？
  ❌ 發現：5處使用 snake_case
  ✅ 建議：改為 camelCase

□ 資料表欄位是否符合 snake_case？
  ✅ 符合標準

□ API端點是否符合RESTful？
  ❌ 發現：POST /api/v1/timesheets/get（應該用GET）
  ✅ 建議：改為 GET /api/v1/timesheets
```

**3.4 安全檢查**

```typescript
// AI自動檢查：

□ 密碼是否使用 Argon2？
  ✅ 符合標準

□ Cookie是否設定 HttpOnly？
  ✅ 符合標準

□ 是否有SQL Injection風險？
  ❌ 發現：2處未使用參數化查詢
  ✅ 建議：修改

□ 是否修改了外部網站檔案？
  ✅ 未修改
```

**3.5 效能檢查**

```typescript
// AI自動檢查：

□ 是否有N+1查詢問題？
  ❌ 發現：在循環中查詢資料庫
  ✅ 建議：改為一次查詢後在記憶體中處理

□ 是否有缺少的索引？
  ❌ 發現：TimeLogs.work_date 未建立索引（常用於查詢）
  ✅ 建議：新增索引

□ 查詢是否過度？
  ❌ 發現：查詢了不必要的欄位
  ✅ 建議：只查詢需要的欄位
```

**3.6 文檔一致性檢查**

```typescript
// AI自動檢查：

□ 代碼是否符合設計文檔？
  ❌ 發現：API規格文檔說明回應包含 weighted_hours，但實際代碼未返回
  ✅ 建議：修改代碼以符合文檔

□ 設計文檔是否完整？
  ❌ 發現：技術規格文檔缺少錯誤處理說明
  ✅ 建議：補充文檔

□ 測試案例是否涵蓋？
  ❌ 發現：缺少邊界條件測試
  ✅ 建議：新增測試案例
```

---

## 步驟 4：問題報告與優先級排序

### AI自動輸出：

```markdown
✅ 代碼審查完成：工時表模塊

檢查範圍：
- 7個檔案
- 約1,200行代碼

發現問題總計：23個
- 🔴 嚴重問題：5個（必須修復）
- 🟡 中等問題：12個（建議修復）
- 🟢 輕微問題：6個（可選修復）

【🔴 嚴重問題】

1. SQL Injection 風險（安全）
   位置：worker/src/repositories/timesheet.repository.ts:45
   問題：未使用參數化查詢
   風險：可能導致資料庫被攻擊
   建議：改為 db.prepare().bind()
   
2. 硬編碼業務規則（標準化）
   位置：worker/src/services/timesheet.service.ts:78
   問題：加班費率直接寫在代碼中
   風險：修改規則需要改代碼並重新部署
   建議：從 OvertimeRates 表查詢

3. 未使用共用組件（模塊化）
   位置：frontend/src/components/features/timesheet/TimesheetGrid.vue:120-130
   問題：自己實作按鈕
   對比：TaskBoard.vue:89-95 也有相同問題
   建議：兩者都改用 <StyledButton> 共用組件
   
4. N+1 查詢問題（效能）
   位置：worker/src/services/timesheet.service.ts:156
   問題：在循環中查詢資料庫（每個員工一次查詢）
   影響：10個員工需要10次查詢，100個員工需要100次查詢
   建議：改為一次查詢所有資料

5. API回應不符合文檔（一致性）
   位置：worker/src/routes/timesheet.routes.ts:67
   文檔：API規格/工時/新增工時記錄.md 說明應返回 weighted_hours
   實際：代碼未返回 weighted_hours
   建議：修改代碼以符合文檔，或更新文檔

【🟡 中等問題】

6. 重複邏輯（模塊化）
   位置：
   - worker/src/services/timesheet.service.ts:234-256
   - worker/src/services/leave.service.ts:178-198
   問題：兩處都實作相同的日期計算邏輯
   建議：提取到 utils/date.util.ts

... (其他11個中等問題)

【🟢 輕微問題】

17. 命名不符合規範
    位置：frontend/src/stores/timesheet.store.ts:23
    問題：變數名 work_date 應改為 workDate（camelCase）
    
... (其他5個輕微問題)

我的建議執行順序：
1. 先修復所有🔴嚴重問題（安全和標準化優先）
2. 再修復🟡中等問題（模塊化和效能）
3. 最後修復🟢輕微問題（如時間允許）

您想要我：
A) 自動修復所有問題（我會先更新文檔再改代碼）
B) 只修復🔴嚴重問題
C) 讓我選擇特定問題修復
D) 先給我看詳細的修改計劃，您批准後再執行
```

---

## 步驟 5：自動修復執行

### AI自動執行（如用戶選擇A或B）：

**5.1 分組修復**
```
AI自動分組：
組1：標準化問題（5個）→ 需要更新設計文檔
組2：模塊化問題（8個）→ 需要創建共用組件
組3：效能問題（4個）→ 需要更新資料庫設計
組4：命名問題（6個）→ 直接修改代碼
```

**5.2 按組執行**

```markdown
【開始修復組1：標準化問題】

問題1：硬編碼加班費率
1. ✅ 讀取現有設計：
   - 已存在 OvertimeRates 資料表
   - 已有 API規格/業務規則/加班費率/獲取加班費率列表.md
   
2. ✅ 分析現有實作：
   - 其他模塊（leave.service.ts）已正確從資料表查詢
   - 可以參考其實作方式
   
3. ✅ 修改代碼：
   修改前：
   ```typescript
   const rate = workType === '平日加班' ? 1.34 : 1.67;
   ```
   
   修改後：
   ```typescript
   const rateRecord = await db.prepare(
     'SELECT rate FROM OvertimeRates WHERE overtime_type = ?'
   ).bind(workType).first();
   const rate = rateRecord.rate;
   ```

4. ✅ 更新文檔（如需要）：
   - 技術規格/工時表/業務邏輯.md 已有說明，無需更新

✅ 問題1已修復

問題2：SQL Injection風險
1. ✅ 讀取開發規範：
   - 開發規範.md 明確要求使用參數化查詢
   
2. ✅ 修改代碼：
   修改前：
   ```typescript
   const sql = `SELECT * FROM TimeLogs WHERE user_id = ${userId}`;
   const result = await db.prepare(sql).all();
   ```
   
   修改後：
   ```typescript
   const result = await db.prepare(
     'SELECT * FROM TimeLogs WHERE user_id = ?'
   ).bind(userId).all();
   ```

✅ 問題2已修復

... (繼續修復其他問題)
```

**5.3 修復共用組件問題**

```markdown
【開始修復組2：模塊化問題 - 未使用共用組件】

AI自動分析：
- TimesheetGrid.vue 和 TaskBoard.vue 都自己實作按鈕
- 對比兩者代碼，發現樣式和功能相同
- 已存在共用組件：components/common/StyledButton.vue

AI自動執行：
1. ✅ 讀取共用組件定義：
   - StyledButton 支援 variant: 'primary' | 'secondary' | 'danger'
   - 支援 size: 'sm' | 'md' | 'lg'
   
2. ✅ 修改 TimesheetGrid.vue：
   修改前：
   ```vue
   <button class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">
     儲存
   </button>
   ```
   
   修改後：
   ```vue
   <StyledButton variant="primary" @click="save">儲存</StyledButton>
   ```

3. ✅ 修改 TaskBoard.vue：
   同樣改用 <StyledButton>

4. ✅ 更新文檔：
   - 技術規格/工時表/UI設計.md 補充說明使用共用組件
   - 技術規格/任務追蹤/UI設計.md 補充說明使用共用組件

✅ 共用組件問題已全部修復
```

---

## 步驟 6：驗證與報告

### AI自動執行：

```markdown
✅ 代碼優化完成：工時表模塊

修復總結：
- 🔴 嚴重問題：5個 → ✅ 已全部修復
- 🟡 中等問題：12個 → ✅ 已全部修復
- 🟢 輕微問題：6個 → ✅ 已全部修復

已修改檔案：
【後端】
- ✅ worker/src/services/timesheet.service.ts
  - 移除硬編碼，改為查詢資料表
  - 提取重複邏輯到 utils/date.util.ts
  - 修復N+1查詢問題
  
- ✅ worker/src/repositories/timesheet.repository.ts
  - 所有查詢改為參數化
  - 新增缺失的索引（已更新資料庫設計文檔）
  
- ✅ worker/src/routes/timesheet.routes.ts
  - API回應格式改為符合文檔
  - 修復RESTful命名問題

【前端】
- ✅ frontend/src/components/features/timesheet/TimesheetGrid.vue
  - 改用 <StyledButton> 共用組件
  - 改用 <StyledTable> 共用組件
  - 命名改為 camelCase
  
- ✅ frontend/src/stores/timesheet.store.ts
  - 命名改為 camelCase
  - 移除未使用的代碼

【共用工具】
- ✅ worker/src/utils/date.util.ts
  - 新增 calculateDaysBetween()
  - 新增 isWeekend()
  （從重複代碼中提取）

已更新文檔：
- ✅ 技術規格/工時表/UI設計.md（補充共用組件說明）
- ✅ 技術規格/工時表/業務邏輯.md（補充錯誤處理）
- ✅ 資料庫設計/核心業務/TimeLogs.md（新增索引說明）

代碼質量提升：
- 安全性：SQL Injection風險 → ✅ 已消除
- 標準化：硬編碼業務規則 → ✅ 已改為資料表驅動
- 模塊化：重複代碼 -67% → ✅ 提取到共用工具
- 模塊化：共用組件使用率 +100% → ✅ 全部改用共用組件
- 效能：N+1查詢 → ✅ 已優化為單次查詢
- 一致性：代碼與文檔 → ✅ 100%一致

建議：
1. 對其他模塊執行相同的審查（我可以繼續）
2. 建立定期代碼審查機制（每月一次）
3. 在新增功能時，自動檢查是否使用共用組件
```

---

## 完整示例

### 用戶需求：
```
@AI開發指南.md 我想優化代碼，檢查是否都有模塊化和標準化
```

### AI自動執行：

```
AI：✅ 已讀取AI開發指南
    ✅ 識別為：代碼審查/優化
    ✅ 開始執行優化代碼流程
    
    我已經掃描了整個專案，以下是所有功能模塊：
    
    【核心業務】
    1. 員工帳號管理
    2. 客戶管理  
    3. 工時表填寫
    4. 工時報表
    
    【業務規則】
    5. 業務規則管理
    6. 假期餘額查詢
    
    【任務系統】
    7. 任務模板管理
    8. 任務進度追蹤
    
    請選擇要檢查的模塊（可多選，用逗號分隔）：

您：3,4

AI：收到，我將檢查：
    - 工時表填寫
    - 工時報表
    
    開始掃描代碼...
    
    ✅ 已掃描 12個檔案，約 2,300行代碼
    ✅ 已讀取所有相關設計文檔
    ✅ 已對比其他模塊的實作方式
    ✅ 已檢查是否符合專案規範
    
    發現問題總計：18個
    - 🔴 嚴重問題：3個
    - 🟡 中等問題：10個
    - 🟢 輕微問題：5個
    
    【🔴 嚴重問題】
    
    1. 未使用共用組件（模塊化）
       位置：TimesheetGrid.vue:120-130
       問題：自己實作按鈕
       對比：我檢查了 TaskBoard.vue，它正確使用了 <StyledButton>
       建議：改用 <StyledButton>
       
    2. 硬編碼業務規則（標準化）
       位置：timesheet.service.ts:78
       問題：加班費率寫死在代碼中
       我檢查了：
       - ✅ OvertimeRates 資料表已存在
       - ✅ leave.service.ts 已正確從資料表查詢
       建議：參考 leave.service.ts 的實作方式
       
    3. N+1查詢問題（效能）
       位置：timesheet.service.ts:156
       問題：在循環中查詢資料庫
       建議：改為一次查詢所有資料
    
    ... (其他問題)
    
    您想要我：
    A) 自動修復所有問題
    B) 只修復🔴嚴重問題
    C) 讓我選擇特定問題修復

您：A

AI：收到，我將自動修復所有18個問題。
    
    【開始修復】
    
    問題1：未使用共用組件
    1. ✅ 檢查共用組件定義（components/common/StyledButton.vue）
    2. ✅ 修改 TimesheetGrid.vue
    3. ✅ 更新技術規格文檔
    ✅ 問題1已修復
    
    問題2：硬編碼業務規則
    1. ✅ 確認 OvertimeRates 表存在
    2. ✅ 參考 leave.service.ts 的實作
    3. ✅ 修改 timesheet.service.ts
    ✅ 問題2已修復
    
    ... (繼續修復)
    
    ✅ 所有問題已修復！
    
    修復總結：
    - 已修改 12個檔案
    - 已更新 5個設計文檔
    - 代碼質量提升：
      * 模塊化 +100%
      * 標準化 +100%
      * 效能 +45%
    
    建議：
    - 可以繼續檢查其他模塊
    - 建議建立每月定期審查機制
```

---

## 相關文檔

- [AI開發指南](../AI開發指南.md)
- [任務類型自動識別](../任務類型自動識別.md)
- [開發規範](../../開發規範.md)

---

**最後更新：** 2025年10月27日



