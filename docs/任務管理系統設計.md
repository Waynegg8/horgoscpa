# 任務管理系統設計

**版本**: 2.0  
**最後更新**: 2025-10-26

---

## 📋 功能概述

統一任務管理系統，所有類型的任務都在同一個介面管理，透過標籤分類。

### 核心功能
- 統一任務管理介面（tasks.html）
- 7個標籤分類：全部任務、我的任務、周期任務、工商登記、財稅簽證、客戶服務、服務配置
- 多階段任務支援
- 周期任務自動生成
- 客戶服務自動化任務
- 任務範本系統
- 檢查清單與審核

**優化重點** - ✅ 已實施：
- ✅ **可視化模板編輯器**：拖拽方式調整階段順序（已實施 2025-10-26）
- ✅ **模板市場**：12個預設模板，可一鍵使用（已實施 2025-10-26）
- ✅ **模板預覽**：時間軸視圖即時預覽（已實施 2025-10-26）
- ✅ **快速客製化**：從現有任務或模板複製編輯（已實施 2025-10-26）

---

## 🏗️ 統一架構

### 任務分類（category 欄位）

**⚠️ 重要：統一使用英文值，中文僅用於顯示**

```javascript
const TASK_CATEGORIES = {
  recurring: '周期任務',       // 一般周期性任務
  business: '工商登記',         // 公司設立、變更、解散等
  finance: '財稅簽證',          // 財稅相關任務、審計、簽證
  client_service: '客戶服務',   // 自動生成的客戶服務任務（記帳、報稅）
  project: '專案任務',          // 大型專案（併購、特殊專案等）
  general: '一般任務'           // 其他任務
};
```

**資料庫存儲規範** (已實施 2025-10-26):
- ✅ **資料庫**: 統一使用英文值 (`recurring`, `business`, `finance`, `client_service`, `project`, `general`)
- ✅ **API**: 使用英文值傳輸
- ✅ **前端**: 使用映射表將英文值轉換為中文顯示（tasks.html 第530-537行）

**範例**:
```javascript
// 資料庫存儲
INSERT INTO tasks (title, category) VALUES ('營業稅申報', 'client_service');  // ✅ 英文

// 前端顯示
const categoryMap = {
  'client_service': '客戶服務'  // 英文 → 中文
};
```

**說明**：
- **工商登記**：公司設立、變更登記、解散清算等工商業務
- **財稅簽證**：財稅查核、簽證、特殊財稅案件
- **客戶服務**：日常的記帳、營業稅、營所稅等自動生成的任務
- **專案任務**：大型併購案、IPO、重組等特殊專案

### 標籤對應

| 標籤 | 篩選條件 | 說明 |
|------|----------|------|
| 全部任務 | 所有任務 | 顯示所有類型的任務 |
| 我的任務 | assigned_user = 當前用戶 | 只顯示指派給我的任務 |
| 周期任務 | category = 'recurring' | 周期性任務 |
| 工商登記 | category = 'business' | 公司設立、變更、解散等 |
| 財稅簽證 | category = 'finance' | 財稅查核、簽證、審計等 |
| 客戶服務 | category = 'client_service' | 記帳、報稅等自動生成任務 |
| 服務配置 | 非任務，顯示配置管理介面 | 管理 client_services 配置 |

**專案任務**：大型專案（category = 'project'）也在任務系統中管理，可在"全部任務"或"我的任務"中查看，或使用搜尋/篩選功能。

---

## 🗄️ 資料表結構

### tasks (統一任務表)
```sql
CREATE TABLE tasks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  description TEXT,
  status TEXT DEFAULT 'pending',        -- pending, in_progress, completed, cancelled
  priority TEXT DEFAULT 'medium',       -- low, medium, high
  due_date DATETIME,
  assigned_user TEXT,
  created_by TEXT,
  category TEXT,                        -- recurring, business, finance, client_service, project
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### multi_stage_tasks (多階段任務)
```sql
CREATE TABLE multi_stage_tasks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  task_id INTEGER NOT NULL UNIQUE,
  total_stages INTEGER NOT NULL,
  completed_stages INTEGER DEFAULT 0,
  overall_progress INTEGER DEFAULT 0,
  current_stage INTEGER DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
);
```

### task_stages (任務階段)
```sql
CREATE TABLE task_stages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  multi_stage_task_id INTEGER NOT NULL,
  stage_order INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_description TEXT,
  status TEXT DEFAULT 'pending',
  checklist TEXT,                      -- JSON 格式
  estimated_hours DECIMAL(5,2),
  actual_hours DECIMAL(5,2),
  assigned_to TEXT,
  completed_by TEXT,
  completed_at DATETIME,
  notes TEXT,
  requires_approval BOOLEAN DEFAULT 0,
  approved_by TEXT,
  approved_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (multi_stage_task_id) REFERENCES multi_stage_tasks(id) ON DELETE CASCADE
);
```

### 範本相關表

#### multi_stage_templates (多階段任務範本)
```sql
CREATE TABLE multi_stage_templates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_name TEXT NOT NULL,
  category TEXT,
  description TEXT,
  total_stages INTEGER NOT NULL,
  is_active BOOLEAN DEFAULT 1,
  created_by TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### template_stages (範本階段)
```sql
CREATE TABLE template_stages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_id INTEGER NOT NULL,
  stage_order INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_description TEXT,
  checklist TEXT,
  estimated_hours DECIMAL(5,2),
  requires_approval BOOLEAN DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (template_id) REFERENCES multi_stage_templates(id) ON DELETE CASCADE
);
```

#### service_checklist_templates (服務檢查清單範本)
```sql
CREATE TABLE service_checklist_templates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  service_type TEXT NOT NULL,        -- accounting, vat, income_tax
  template_name TEXT NOT NULL,
  version INTEGER DEFAULT 1,
  checklist_data TEXT NOT NULL,      -- JSON 格式
  is_active BOOLEAN DEFAULT 1,
  is_default BOOLEAN DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  created_by INTEGER,
  FOREIGN KEY (created_by) REFERENCES users(id)
);
```

### 周期任務相關

#### recurring_task_templates (周期任務範本)
```sql
CREATE TABLE recurring_task_templates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_name TEXT NOT NULL,
  category TEXT,
  description TEXT,
  frequency TEXT NOT NULL,           -- daily, weekly, monthly, quarterly
  task_template TEXT NOT NULL,       -- JSON 格式任務範本
  is_active BOOLEAN DEFAULT 1,
  created_by TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### recurring_task_instances (周期任務實例)
```sql
CREATE TABLE recurring_task_instances (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_id INTEGER NOT NULL,
  task_id INTEGER,
  scheduled_date DATE NOT NULL,
  status TEXT DEFAULT 'pending',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (template_id) REFERENCES recurring_task_templates(id),
  FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
);
```

### 專案相關資料表（已整合到統一任務系統）

**✅ 整合完成**：專案管理已整合到統一任務系統
- ✅ Migration 010: `multi_stage_tasks` 表支援所有類型任務（包含專案）
- ✅ 使用 `tasks.category = 'project'` 標記專案類型任務
- 📋 舊表 (`projects`, `project_tasks`, `project_checklist`) 保留作為歷史資料
- 🔄 Migration 020 執行資料遷移後可考慮刪除舊表

**不再使用以下表**：

#### projects (專案 - 已廢棄)
```sql
CREATE TABLE projects (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  client_name TEXT,
  category TEXT,                     -- 專案分類
  description TEXT,
  status TEXT DEFAULT 'planning',
  priority TEXT DEFAULT 'medium',
  start_date DATE,
  due_date DATE,
  completed_date DATE,
  budget DECIMAL(12,2),
  actual_cost DECIMAL(12,2),
  assigned_to TEXT,
  created_by TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**整合方案**：未來可將專案資訊整合到 tasks 表的擴展欄位中。

---

### 客戶服務自動化相關

#### client_services (客戶服務配置)
```sql
CREATE TABLE client_services (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id INTEGER NOT NULL,
  service_type TEXT NOT NULL,
  frequency TEXT NOT NULL,
  fee DECIMAL(10,2) DEFAULT 0,
  estimated_hours DECIMAL(5,2),
  assigned_to INTEGER,
  backup_assignee INTEGER,
  start_month INTEGER,
  execution_day INTEGER,
  advance_days INTEGER DEFAULT 7,
  due_days INTEGER DEFAULT 15,
  invoice_count INTEGER DEFAULT 0,
  difficulty_level INTEGER,
  is_active BOOLEAN DEFAULT 1,
  notes TEXT,
  special_requirements TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  last_generated_at DATETIME,
  FOREIGN KEY (assigned_to) REFERENCES users(id),
  FOREIGN KEY (backup_assignee) REFERENCES users(id)
);
```

#### task_generation_log (任務生成記錄)
```sql
CREATE TABLE task_generation_log (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_service_id INTEGER NOT NULL,
  execution_period TEXT NOT NULL,    -- '2025-10'
  generated_task_id INTEGER,
  generated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  generation_method TEXT,            -- 'auto' 或 'manual'
  FOREIGN KEY (client_service_id) REFERENCES client_services(id),
  FOREIGN KEY (generated_task_id) REFERENCES tasks(id),
  UNIQUE(client_service_id, execution_period)
);
```

---

## 🔄 統一任務流程

### 任務顯示邏輯

所有任務都從 `tasks` 表查詢，根據標籤篩選：

```javascript
// 標籤點擊事件
function switchTab(tabName) {
  switch(tabName) {
    case 'all':
      // 顯示所有任務
      loadTasks({ });
      break;
      
    case 'my-tasks':
      // 只顯示我的任務
      loadTasks({ assigned_user: currentUser.id });
      break;
      
    case 'recurring':
      // 周期任務
      loadTasks({ category: 'recurring' });
      break;
      
    case 'business':
      // 工商登記
      loadTasks({ category: 'business' });
      break;
      
    case 'finance':
      // 財稅簽證
      loadTasks({ category: 'finance' });
      break;
      
    case 'client-service':
      // 客戶服務
      loadTasks({ category: 'client_service' });
      break;
      
    case 'config':
      // 顯示服務配置介面（不是任務列表）
      showServiceConfig();
      break;
  }
}
```

### 任務卡片統一樣式

所有類型任務使用相同的卡片樣式：

```html
<div class="task-card">
  <div class="task-header">
    <h3>{任務標題}</h3>
    <span class="status-badge">{狀態}</span>
  </div>
  
  <!-- 如果是多階段任務，顯示進度條 -->
  <div class="progress-bar">
    <div class="progress-fill" style="width: {進度}%"></div>
    <span>{已完成階段}/{總階段}</span>
  </div>
  
  <div class="task-meta">
    <span class="category-badge">{分類}</span>
    <span>負責：{負責人}</span>
    <span>截止：{截止日期}</span>
  </div>
</div>
```

---

## 🔌 API 設計

### 取得任務列表（統一端點）
```
GET /api/tasks/multi-stage?category=client_service&status=in_progress&assigned_user=user1

Response:
{
  "success": true,
  "tasks": [
    {
      "id": 123,
      "title": "客戶101 - 記帳服務",
      "category": "client_service",
      "status": "in_progress",
      "total_stages": 4,
      "completed_stages": 2,
      "overall_progress": 50,
      "due_date": "2025-11-15",
      "assigned_user": "紜蓁"
    }
  ]
}
```

### 自動任務生成相關

```
POST /api/automated-tasks/generate    # 批次生成任務
POST /api/automated-tasks/generate/:service_id  # 為特定服務生成
GET  /api/automated-tasks/preview     # 預覽將生成的任務
```

### 周期任務相關

```
GET  /api/recurring-templates         # 取得周期任務範本
POST /api/recurring-tasks/generate    # 生成周期任務實例
GET  /api/recurring-tasks/instances   # 取得任務實例
```

---

## 💻 前端設計

### 統一頁面：tasks.html

#### 標籤結構
```
[全部任務] [我的任務] [周期任務] [工商登記] [財稅簽證] [客戶服務] [服務配置]
```

#### 工具列（所有標籤共用）
```
[+ 創建任務] [狀態篩選▾] [搜尋...]
```

#### 任務列表區（標籤1-6）
```
顯示任務卡片列表
- 統一卡片樣式
- 多階段任務顯示進度條
- 點擊卡片打開詳情
```

#### 服務配置區（標籤7）
```
顯示客戶服務配置管理介面
- 客戶服務配置列表
- 新增/編輯配置
- [預覽待生成任務] [立即生成任務] 按鈕
```

### 廢棄的頁面

以下頁面應整合到 tasks.html：
- ❌ ~~multi-stage-tasks.html~~ → 改為任務詳情側邊欄或彈窗
- ❌ ~~recurring-tasks.html~~ → 整合到 tasks.html 的"周期任務"標籤
- ❌ ~~service-config.html~~ → 整合到 tasks.html 的"服務配置"標籤

---

## 🔄 各類型任務生成流程（已優化）

### 1. 一般任務 - 使用模板市場
```
手動創建
  ↓
瀏覽模板市場（10+ 預設模板）
  ├─ 預覽模板（時間軸、階段詳情）
  ├─ 選擇「直接使用」或「複製編輯」
  └─ 使用拖拽編輯器調整
  ↓
填寫基本資訊（客戶、日期等）
  ↓
確認並儲存
  ↓
INSERT INTO tasks + multi_stage_tasks + task_stages
```

### 2. 周期任務
```
建立周期範本
  ↓
設定頻率（每日/每週/每月/每季）
  ↓
系統定期檢查（GitHub Actions 或手動觸發）
  ↓
自動生成任務實例
  ↓
INSERT INTO tasks + recurring_task_instances
```

### 3. 客戶服務任務（自動化）
```
配置客戶服務（client_services）
  ↓
設定執行頻率與日期
  ↓
系統定期檢查（每日 00:00）
  ↓
判斷是否需要生成任務
  ↓
載入服務檢查清單範本
  ↓
自動生成多階段任務
  ↓
INSERT INTO tasks + multi_stage_tasks + task_stages + task_generation_log
```

### 4. 工商/財稅/專案任務
```
手動創建或從範本創建
  ↓
設定 category = 'business', 'finance' 或 'project'
  ↓
通常為多階段任務
  ↓
使用專用範本（公司設立、財稅簽證、併購案等）
  ↓
INSERT INTO tasks + multi_stage_tasks + task_stages
```

**範本範例**：
- 工商登記範本：公司設立流程（8階段）、變更登記流程（5階段）
- 財稅簽證範本：財務簽證流程（10階段）、稅務查核流程（7階段）
- 專案範本：併購案流程（15階段）、IPO流程（20階段）

---

## 📊 任務統計（跨所有類型）

### 整體任務統計
```sql
SELECT 
  category,
  COUNT(*) as total,
  SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed,
  SUM(CASE WHEN status = 'in_progress' THEN 1 ELSE 0 END) as in_progress,
  SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending
FROM tasks
GROUP BY category;
```

### 個人任務統計
```sql
SELECT 
  t.category,
  COUNT(*) as my_tasks,
  AVG(mst.overall_progress) as avg_progress
FROM tasks t
LEFT JOIN multi_stage_tasks mst ON t.id = mst.task_id
WHERE t.assigned_user = ?
  AND t.status IN ('pending', 'in_progress')
GROUP BY t.category;
```

---

## 🔌 統一 API 設計

### 取得任務列表（統一端點）
```
GET /api/tasks/multi-stage?category={category}&status={status}&assigned_user={user}

支援參數：
- category: recurring, business, finance, client_service, project
- status: pending, in_progress, completed, cancelled
- assigned_user: 用戶 ID 或用戶名
- start_date: 開始日期篩選
- end_date: 結束日期篩選
- search: 搜尋關鍵字

Response: 統一的任務列表格式
```

### 創建任務（統一端點）
```
POST /api/tasks/multi-stage

Request:
{
  "title": "任務標題",
  "category": "client_service",
  "template_id": 1,  // 可選
  "stages": [...]    // 或使用範本
}
```

---

## 💻 前端實施（已優化）

### 檔案結構
```
assets/js/
├── unified-tasks.js         # 統一任務管理（✅ 已創建並修復 2025-10-26）
├── auth-common.js           # 共用認證代碼（✅ 新增 2025-10-26）
├── config.js                # 系統配置（✅ 新增 2025-10-26）
├── common-utils.js          # 共用工具函數（✅ 新增 2025-10-26）
├── error-handler.js         # 全局錯誤處理（✅ 新增 2025-10-26）
├── multi-stage-tasks.js     # 多階段任務邏輯（現有）
├── recurring-tasks.js       # 周期任務邏輯（現有）
├── template-market.js       # 模板市場（含在 unified-tasks.js）
└── template-editor.js       # 拖拽式模板編輯器（含在 unified-tasks.js）

assets/css/
├── internal-system.css      # 基礎樣式（✅ 統一使用）
├── internal-components.css  # 組件樣式（✅ 統一使用）
├── tasks-page.css           # 任務頁面樣式（✅ 已創建）
└── settings-page.css        # 設定頁面樣式（✅ 已創建）
```

### 共用模塊說明（2025-10-26 新增）

#### auth-common.js
- 統一認證檢查 `checkAuth()`
- 用戶信息更新 `updateUserInfo()`
- 權限UI控制 `updateUIByRole()`
- 統一API請求 `apiRequest()` （含超時處理）
- 登出處理 `handleLogout()`

#### config.js
- API URL 配置（自動適應開發/生產環境）
- 系統常量定義
- 服務類型/頻率映射表
- 任務狀態/分類映射表

#### common-utils.js
- 日期格式化工具
- HTML轉義（防XSS）
- 文件大小格式化
- 通知顯示 `showNotification()`
- localStorage安全讀寫
- 數據驗證函數

#### error-handler.js
- 全局錯誤捕獲
- Promise錯誤處理
- API錯誤統一處理
- 友好的錯誤提示

### tasks.html 結構
```html
<div class="tabs-container">
  <!-- 7個標籤 -->
  <div class="tab-nav">
    <button onclick="switchTab('all')">全部任務</button>
    <button onclick="switchTab('my-tasks')">我的任務</button>
    <button onclick="switchTab('recurring')">周期任務</button>
    <button onclick="switchTab('business')">工商登記</button>
    <button onclick="switchTab('finance')">財稅簽證</button>
    <button onclick="switchTab('client-service')">客戶服務</button>
    <button onclick="switchTab('config')">服務配置</button>
  </div>
  
  <!-- 工具列 -->
  <div class="toolbar">
    <button onclick="createTask()">+ 創建任務</button>
    <select id="statusFilter">...</select>
    <input type="text" id="searchInput">
  </div>
  
  <!-- 任務列表容器（動態載入） -->
  <div id="tasksContainer"></div>
</div>

<script src="assets/js/unified-tasks.js"></script>
```

---

## 🎯 各標籤特殊功能

### 周期任務標籤
額外顯示：
- 周期範本管理
- 手動生成實例按鈕

### 客戶服務標籤
額外顯示：
- 服務類型篩選
- 客戶篩選
- 自動生成統計

### 服務配置標籤
完全不同的介面：
- ✅ 客戶服務配置列表（已實施 2025-10-26）
- ✅ 配置卡片顯示（含服務類型、頻率、費用、工時、難度等）
- ✅ 操作按鈕（測試生成、執行歷史、啟用/停用）
- ✅ [預覽待生成任務] 按鈕（已實施）
- ✅ [立即生成任務] 按鈕（已實施）
- 📋 CRUD 操作（查看和切換狀態已實施，編輯功能在 settings.html）

**實施狀態**: 
- 前端：✅ 完整實現（tasks.html 第760-908行）
- 後端：✅ API 完整（/api/client-services）
- 顯示：✅ 美化的配置卡片，包含所有關鍵信息

---

## 🚀 未來擴展

### 計劃功能
- [ ] 任務看板視圖（拖曳排序）
- [ ] 任務依賴關係圖
- [ ] 批次操作（批次指派、批次完成）
- [x] ~~任務範本市場~~ ✅ 已實施
- [ ] 任務協作（多人任務）
- [ ] 任務評論系統
- [ ] 任務附件管理

### 已實施的優化 ✅
- [x] 可視化模板編輯器（拖拽調整階段）- ✅ 2025-10-26
- [x] 模板市場（12個預設模板）- ✅ 2025-10-26
- [x] 模板預覽功能 - ✅ 2025-10-26
- [x] 一鍵複製和客製化 - ✅ 2025-10-26
- [ ] 模板使用統計 - ⚠️ 部分實施（資料表已建立）

---

**相關文檔**：
- [系統架構設計.md](./系統架構設計.md) - 整體架構
- [客戶服務自動化系統設計.md](./客戶服務自動化系統設計.md) - 自動化邏輯
- [API端點文檔.md](./API端點文檔.md) - API 參考

