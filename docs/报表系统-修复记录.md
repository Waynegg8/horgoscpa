# 报表系统 - 修复记录

## 部署信息
- **最新版本**: `45afbb92-817d-4ab2-bc6e-73cd375f618a`
- **部署时间**: 刚刚完成
- **修复内容**: 4个关键问题

---

## 修复1: `calculateEmployeePayroll2 is not a function` ❌→✅

### 问题描述
```
Error: calculateEmployeePayroll2 is not a function
```
报表API无法调用薪资计算函数。

### 根本原因
`payroll.js` 中的 `calculateEmployeePayroll` 函数没有被导出，导致 `reports.js` 无法import使用。

### 修复方案
在 `payroll.js` 文件末尾添加：
```javascript
// 导出函数供其他模块使用
export { calculateEmployeePayroll };
```

### 修复文件
- `cloudflare/worker-router/src/api/payroll.js`

---

## 修复2: 服务类型显示"未分类" ❌→✅

### 问题描述
- 月度收款报表：服务类型显示"未分类"
- 年度收款报表：服务类型汇总显示"未分类"
- 客户毛利报表：看不到服务类型信息

### 根本原因
1. **成本API返回的数据结构不匹配**
   - 成本API返回 `data: { tasks: [...] }`
   - 但报表API期望 `data: { clients: [...] }`
   - 导致无法正确读取数据

2. **服务类型信息丢失**
   - 直接将tasks按clientId聚合时，丢失了serviceName信息
   - 没有将服务类型明细保存下来

### 修复方案
在 `reports.js` 的 `handleMonthlyClientProfitability` 函数中：

```javascript
// 修复前：
const clients = costData.data?.clients || []; // ❌ 这个字段不存在

// 修复后：
const tasks = costData.data?.tasks || []; // ✅ 正确的字段

// 将tasks按clientId聚合
const clientsMap = new Map();
for (const task of tasks) {
    if (!clientsMap.has(task.clientId)) {
        clientsMap.set(task.clientId, {
            clientId: task.clientId,
            clientName: task.clientName,
            totalHours: 0,
            weightedHours: 0,
            totalCost: 0,
            totalWeightedCost: 0,
            services: [] // ✅ 保存服务类型明细
        });
    }
    
    const client = clientsMap.get(task.clientId);
    client.totalHours += task.hours;
    client.weightedHours += task.weightedHours;
    client.totalCost += task.totalCost;
    
    // ✅ 保存服务类型信息
    client.services.push({
        serviceName: task.serviceName,
        taskTitle: task.taskTitle,
        hours: task.hours,
        weightedHours: task.weightedHours,
        avgHourlyRate: task.avgActualHourlyRate,
        totalCost: task.totalCost
    });
}
```

### 修复后返回的数据结构
```json
{
  "clientId": 1,
  "clientName": "安和顧問股份有限公司",
  "totalHours": 16.0,
  "weightedHours": 18.0,
  "avgHourlyRate": 740.11,
  "totalCost": 13330,
  "revenue": 569928,
  "profit": 556598,
  "profitMargin": 97.66,
  "services": [
    {
      "serviceName": "記帳服務",
      "taskTitle": "月度記帳",
      "hours": 6.0,
      "weightedHours": 10.0,
      "avgHourlyRate": 740.11,
      "totalCost": 7401
    },
    {
      "serviceName": "稅務服務",
      "taskTitle": "營業稅申報",
      "hours": 10.0,
      "weightedHours": 8.0,
      "avgHourlyRate": 740.11,
      "totalCost": 5929
    }
  ]
}
```

### 修复文件
- `cloudflare/worker-router/src/api/reports.js`

---

## 修复3: 平均时薪显示"NT$ 0" ❌→✅

### 问题描述
客户毛利报表中的"平均时薪"列显示为 `NT$ 0`。

### 根本原因
1. **数据结构不匹配**（与修复2相同）
   - 无法读取到 `client.avgActualHourlyRate`

2. **计算逻辑缺失**
   - 即使能读取数据，也没有正确计算加权平均时薪

### 修复方案
用户要求：**平均时薪应该直接使用成本页面的数字**

实现方式：
```javascript
// 在聚合tasks时，累积加权成本
const client = clientsMap.get(task.clientId);
client.totalWeightedCost += (task.weightedHours * task.avgActualHourlyRate);

// 最后计算加权平均时薪
const avgHourlyRate = client.weightedHours > 0 
    ? (client.totalWeightedCost / client.weightedHours) 
    : 0;
```

### 计算公式
```
平均时薪 = Σ(每个任务的加权工时 × 该任务的平均时薪) ÷ 总加权工时

例如：
任务A: 10小时，时薪 $500
任务B: 20小时，时薪 $800

平均时薪 = (10 × 500 + 20 × 800) ÷ (10 + 20)
         = (5000 + 16000) ÷ 30
         = 21000 ÷ 30
         = $700
```

### 为什么不能用简单平均？
```
❌ 错误方式：(500 + 800) ÷ 2 = $650

✅ 正确方式：加权平均 = $700

原因：任务B的工时更多（20小时 vs 10小时），
所以应该给任务B更大的权重。
```

### 修复文件
- `cloudflare/worker-router/src/api/reports.js`

---

## 验证步骤

### 1. 验证薪资报表可以加载
```
访问: https://www.horgoscpa.com/internal/reports
选择: 月度报表 -> 2025年11月
点击: 载入报表
查看: 薪资报表 Section
预期: 应该显示员工薪资数据，不再报错
```

### 2. 验证服务类型显示
```
查看: 月度收款报表 -> 按客户明细
预期: "服务类型"列应该显示具体的服务名称（例如"記帳服務"），而不是"未分類"

查看: 月度客户毛利报表
预期: 可以展开查看每个客户的服务类型明细
```

### 3. 验证平均时薪显示
```
查看: 月度客户毛利报表 -> 平均时薪列
预期: 应该显示具体的数字（例如"NT$ 740"），而不是"NT$ 0"

对比: 打开成本页面 -> 按客户分析 -> 选择同一客户
验证: 报表中的平均时薪应该与成本页面的数字一致（或接近，因为是加权平均）
```

---

## 已知问题（如果仍然存在）

### 问题1: 收据数据库中service_month为NULL
如果服务类型仍然显示"未分类"，可能是因为：

**数据库检查**：
```sql
-- 检查有多少收据的service_month为NULL
SELECT COUNT(*) FROM Receipts WHERE service_month IS NULL AND is_deleted = 0;
```

**修复方案**：
```sql
-- 使用receipt_date的年月作为service_month
UPDATE Receipts 
SET service_month = substr(receipt_date, 1, 7)
WHERE service_month IS NULL AND is_deleted = 0;
```

### 问题2: 收据未关联客户服务
如果服务类型仍然显示"未分类"：

**数据库检查**：
```sql
-- 检查有多少收据的client_service_id为NULL
SELECT COUNT(*) FROM Receipts WHERE client_service_id IS NULL AND is_deleted = 0;
```

**临时解决方案**：
- 在创建收据时，必须选择客户服务
- 对于旧数据，需要手动补充client_service_id

---

## 浏览器缓存清理

如果修复后仍然看到错误，请清理浏览器缓存：

### Chrome
1. 按 `Ctrl + Shift + Delete`
2. 选择"缓存的图片和文件"
3. 点击"清除数据"
4. 刷新页面（`Ctrl + F5`）

### 或者使用硬刷新
1. 打开报表页面
2. 按 `Ctrl + Shift + R`（Windows）
3. 或按 `Ctrl + F5`

---

## 测试清单

- [ ] 月度收款报表可以加载
- [ ] 月度薪资报表可以加载（不再报错）
- [ ] 月度员工产值报表可以加载
- [ ] 月度客户毛利报表可以加载
- [ ] 年度收款报表可以加载
- [ ] 年度薪资报表可以加载（不再报错）
- [ ] 年度员工产值报表可以加载
- [ ] 年度客户毛利报表可以加载
- [ ] 收款报表中的服务类型显示正确
- [ ] 客户毛利报表中的平均时薪显示正确
- [ ] 平均时薪与成本页面一致

---

## 如果仍有问题

请提供以下信息：

1. **错误截图**
2. **浏览器控制台的完整错误信息**
3. **测试的年月**（例如：2025年11月）
4. **哪个报表有问题**（收款/薪资/员工产值/客户毛利）
5. **预期结果 vs 实际结果**

---

**修复完成！请测试并反馈结果。** ✅

