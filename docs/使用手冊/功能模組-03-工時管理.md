# 工時管理

對應規格：前端 `docs/開發指南/前端/工時管理-前端規格.md`；後端 `docs/開發指南/後端/工時管理-後端規格.md`

**用途：** 記錄每天的工作時間，自動計算加班費和補休。

---

## 角色與權限

### 員工可以做什麼
- 填寫自己的工時
- 修改自己的工時
- 刪除自己的工時
- 查看自己的工時統計
- 看不到別人的工時
- 不能填別人的工時

### 管理員可以做什麼
- 查看所有人的工時
- 查看工時統計報表
- 通常不幫員工填工時（管理原則）

---

## 工時表呈現方式（試算表介面）

**整體設計：** 類似 Excel 的表格介面，左側列出客戶與工作類型，上方為日期欄位（週一至週日），直接在表格儲存格中輸入工時數字。

### 表格結構
- **列（Row）**：每列代表一個工時記錄的組合，包含四個下拉選單
  - 客戶欄：下拉選單（選擇客戶名稱）
  - 服務項目欄：下拉選單（根據選擇的客戶動態載入該客戶的服務項目，第一層）
    - 先選擇客戶後才會載入對應的服務項目
    - 例如：記帳服務、稅務申報、顧問諮詢等
    - 連動客戶管理系統的服務設定
  - 服務子項目欄：下拉選單（根據選擇的服務項目動態載入子項目，第二層）
    - 先選擇服務項目後才會載入對應的子項目
    - 例如：
      - 記帳服務 → 收集憑證、輸入帳務、月結對帳、報表產製
      - 稅務申報 → 營所稅申報、營業稅申報、個人綜所稅、扣繳申報
      - 顧問諮詢 → 稅務諮詢、財務規劃、內控顧問、公司設立
    - 更細緻的工作內容分類
    - 完整顯示格式：「記帳服務-收集憑證」
  - 工時類型欄：下拉選單（正常工時、加班等）
- **欄（Column）**：每欄代表一個日期（週一至週日）
- **儲存格（Cell）**：直接輸入工時數字（0.5 的倍數）

### 填寫方式
1. **選擇列的設定**（必須依序操作）：
   - **步驟 1**：在「客戶」下拉選單選擇客戶（連動客戶管理的客戶清單）
   - **步驟 2**：選擇客戶後，「服務項目」下拉選單會自動載入該客戶的服務項目
     - 如未選擇客戶，服務項目顯示「請先選擇客戶...」
     - 不同客戶有不同的服務項目
     - 例如：記帳服務、稅務申報、顧問諮詢
   - **步驟 3**：選擇服務項目後，「服務子項目」下拉選單會自動載入該服務的子項目
     - 如未選擇服務項目，服務子項目顯示「請先選擇服務項目...」
     - 不同服務項目有不同的子項目
     - 例如：選擇「記帳服務」後顯示「收集憑證、輸入帳務、月結對帳、報表產製」
   - **步驟 4**：在「工時類型」下拉選單選擇類型（正常工時、加班等）
2. **填寫工時**：
   - 在該列的日期欄位中，點擊對應日期的儲存格
   - 直接輸入工時數字
   - **即時驗證**：輸入時系統會立即檢查工時類型是否適用該日期
     - 例如：週六選擇「正常工時」並輸入數字，系統立即清空並提示「休息日不可使用『正常工時』」
     - 防止用戶填寫無效組合，提升填寫效率
3. **日期提醒**（自動顯示，連動國定假日系統）：
   - **週六**：顯示「休息」標籤（黃色），提醒使用「休息日加班」類型
   - **週日**：顯示「例假」標籤（黃色），提醒使用「例假日加班」類型
   - **國定假日**：顯示「國定」標籤（紅色），提醒使用「國定假日加班」類型
     - 國定假日優先級最高（即使是週末也顯示「國定」而非「休息」/「例假」）
   - **補班日**：顯示「補班」標籤（藍色），可使用一般工作日類型
4. **儲存方式**：
   - **即時儲存**：輸入完成後按 Enter 或失焦（blur），立即儲存該筆記錄
   - **統一儲存**：點擊右上角「儲存所有變更」按鈕，批量儲存本週所有修改（推薦）
     - 按鈕會顯示待儲存數量（例如：「儲存所有變更 (3)」）
5. **快速填寫**：使用 Tab 鍵在儲存格間快速移動
6. **數字輸入**：只能輸入 0.5 的倍數（0.5, 1, 1.5, 2, 2.5... 最多 12）
   - 自動四捨五入至最接近的 0.5
   - 超過限制時自動阻止並提示

### 新增列與刪除列
- **新增列**：點擊右上角「+ 新增列」按鈕，在表格底部新增一列空白列
  - 所有下拉選單顯示「請選擇...」
  - 需先選擇客戶、業務類型、工時類型後才能填寫工時
- **刪除列**：點擊列最右側的「×」刪除按鈕
  - 確認提示：「刪除此列將清除本週該組合的所有工時，確定刪除？」
  - 刪除後會調用後端 API 批量刪除該組合的所有記錄
  - 如列為空白（無任何工時），直接刪除不需確認

### 請假記錄顯示（自動同步）
- **位置**：工時表底部（表尾）顯示「請假記錄」行
- **功能**：自動從假期管理系統同步已批准的請假記錄
- **顯示格式**：
  - 有請假：顯示「假別 Xh」（例如：「特休 2h」、「病假 8h」）
  - 無請假：顯示灰色「-」
- **假別類型**：特休、病假、事假、補休、產假、陪產假、生理假、婚假、喪假、公假、其他
- **優點**：
  - 填寫工時時可直接看到當天請假狀況
  - 不需在兩個系統間切換查看
  - 自動納入工時完整性計算

### 工時完整性檢查（每日自動檢查）
- **位置**：工時表底部（請假記錄下方）顯示「工時完整性」行
- **檢查對象**：僅檢查工作日和補班日（週末和國定假日顯示「-」）
- **計算公式**：正常工時 + 請假時數 = 每日應達 8 小時
- **視覺提示**：
  - ✓ 綠色「✓ 完整」：≥8 小時（完整填寫）
  - ⚠️ 黃色「⚠ 缺Xh」：6-7.5 小時（可能漏填）
  - ✗ 紅色「✗ 缺Xh」：<6 小時（嚴重不足）
- **範例**：
  - 工時 8h + 請假 0h = 「✓ 完整」
  - 工時 6h + 請假 2h = 「✓ 完整」（工時+請假達 8h）
  - 工時 5h + 請假 0h = 「✗ 缺3h」（提醒補填）
  - 工時 0h + 請假 8h = 「✓ 完整」（全天請假視為完整）
- **提示訊息**：滑鼠懸停可查看詳細資訊（例如：「工時 6h + 請假 2h = 8h」）

### 工時統計（自動計算）
- **位置**：工時表下方獨立區塊
- **顯示內容**：分為「本週統計」和「本月統計」兩大區塊

#### 本週統計
- **本週總工時**：本週所有儲存格工時加總
- **本週加班工時**：本週所有「加班」類型工時加總
- **本週加權工時**：本週每筆工時 × 對應費率倍數的總和
  - 例如：正常 8h × 1.0 + 加班 2h × 1.34 = 10.68 加權工時
- **本週請假時數**：本週已批准的請假時數加總
  - 連動假期管理系統
  - 僅計算已批准的請假

#### 本月統計
- **本月總工時**：當月所有工時加總（不限於當前顯示週）
- **本月加班工時**：當月所有「加班」類型工時加總
- **本月加權工時**：當月所有工時 × 對應費率倍數的總和
- **本月請假時數**：當月已批准的請假時數加總

#### 更新機制
- **本週統計**：輸入或修改當週工時後自動重新計算
- **本月統計**：切換週時自動重新計算（調用 API 取得當月數據）
- **即時性**：統計數字即時反映最新狀態

## 工作類型選項（下拉選單）

**選項 1：正常工時**
- 說明：一般上班時間（每日8小時內）
- 費率：1.0 倍
- 是否產生補休：不產生

**選項 2：平日加班（前2小時）**
- 說明：平日第 9-10 小時的延長工時
- 費率：1.34 倍
- 是否產生補休：產生補休（1:1）
- 適用時段：當天工作的第 9-10 小時
- **時數限制**：最多只能填 2 小時
- **適用日期**：工作日、補班日

**選項 3：平日加班（後2小時）**
- 說明：平日第 11-12 小時的延長工時
- 費率：1.67 倍
- 是否產生補休：產生補休（1:1）
- 適用時段：當天工作的第 11-12 小時
- **時數限制**：最多只能填 2 小時
- **前置要求**：必須先填寫「平日加班（前2小時）」才能填寫此項
- **適用日期**：工作日、補班日

**選項 4：休息日加班（前2小時）**
- 說明：休息日（通常週六）工作的前2小時
- 費率：1.34 倍
- 是否產生補休：產生補休（1:1）
- **時數限制**：最多只能填 2 小時
- **適用日期**：休息日（通常週六）

**選項 5：休息日加班（第3-8小時）**
- 說明：休息日工作的第3-8小時
- 費率：1.67 倍
- 是否產生補休：產生補休（1:1）
- **時數限制**：最多只能填 6 小時
- **前置要求**：必須先填寫「休息日加班（前2小時）」
- **適用日期**：休息日（通常週六）

**選項 6：休息日加班（第9-12小時）**
- 說明：休息日工作的第9-12小時
- 費率：2.67 倍
- 是否產生補休：產生補休（1:1）
- **時數限制**：最多只能填 4 小時
- **前置要求**：必須先填寫「休息日加班（前2小時）」和「休息日加班（第3-8小時）」
- **適用日期**：休息日（通常週六）

**選項 7：國定假日加班（8小時內）**
- 說明：國定假日（如端午、中秋、國慶）出勤工作
- 費率：加發 1 日工資（雙倍薪，即使只上 1 小時也算 1 日）
- 是否產生補休：產生補休（統一8小時，與加班費對等）
- **時數限制**：最多只能填 8 小時
- **適用日期**：國定假日（由系統自動判定）
- **特別說明**：不論實際工作幾小時（1小時或7小時），補休統一產生8小時

**選項 8：國定假日加班（第9-10小時）**
- 說明：國定假日工作超過8小時的第9-10小時
- 費率：1.34 倍
- 是否產生補休：產生補休（1:1）
- **時數限制**：最多只能填 2 小時
- **前置要求**：必須先填寫「國定假日加班（8小時內）」
- **適用日期**：國定假日

**選項 9：國定假日加班（第11-12小時）**
- 說明：國定假日工作的第11-12小時
- 費率：1.67 倍
- 是否產生補休：產生補休（1:1）
- **時數限制**：最多只能填 2 小時
- **前置要求**：必須先填寫「國定假日加班（8小時內）」和「國定假日加班（第9-10小時）」
- **適用日期**：國定假日

**選項 10：例假日加班（8小時內）**
- 說明：例假日（通常週日）出勤工作
- 費率：加發 1 日工資 + 強制補休 1 天
- 是否產生補休：強制產生補休（統一8小時，與加班費對等）
- **時數限制**：最多只能填 8 小時
- **適用日期**：例假日（通常週日）
- **原則上禁止**：僅限天災、事變或突發事件，需主管機關核備
- **特別說明**：不論實際工作幾小時，補休統一產生8小時

**選項 11：例假日加班（第9-12小時）**
- 說明：例假日工作超過8小時的第9-12小時
- 費率：2.0 倍
- 是否產生補休：產生補休（1:1）
- **時數限制**：最多只能填 4 小時
- **前置要求**：必須先填寫「例假日加班（8小時內）」
- **適用日期**：例假日（通常週日）
- **原則上禁止**

---

## 實際填寫範例（試算表模式）

### 範例 1：正常上班
```
員工 A 在試算表中填寫 2025年11月1日（週五）工時：

表格畫面：
┌──────────────┬──────────┬──────────┬───┬───┬───┬───┬ 週五 ┐
│ 客戶 ▼       │業務類型▼ │工時類型▼ │週一│週二│週三│週四│(11/1)│
├──────────────┼──────────┼──────────┼───┼───┼───┼───┼──────┤
│[選擇客戶...] │[選擇...] │[選擇...] │   │   │   │   │      │← 空白列
└──────────────┴──────────┴──────────┴───┴───┴───┴───┴──────┘

步驟 1：在第一列的「客戶」下拉選單，選擇「測試科技有限公司」
步驟 2：在「業務類型」下拉選單，選擇「記帳」
步驟 3：在「工時類型」下拉選單，選擇「正常工時」
步驟 4：點擊週五欄位的儲存格，輸入 8
步驟 5：按 Enter

設定完成後表格顯示：
┌──────────────┬──────────┬──────────┬───┬───┬───┬───┬──────┐
│ 客戶 ▼       │業務類型▼ │工時類型▼ │週一│週二│週三│週四│週五  │
├──────────────┼──────────┼──────────┼───┼───┼───┼───┼──────┤
│測試科技有限  │ 記帳     │正常工時  │   │   │   │   │  8   │
└──────────────┴──────────┴──────────┴───┴───┴───┴───┴──────┘

自動儲存後：
✓ 記錄 8 小時正常工時
✓ 加權工時 = 8 × 1.0 = 8 小時
✓ 不產生補休（因為是正常工時）
✓ 這 8 小時會列入客戶成本計算
```

### 範例 2：週六加班
```
員工 A 在試算表中填寫 2025年11月2日（週六）工時：

需要新增兩列來記錄不同費率的加班：

第一列設定：
- 客戶：測試科技有限公司
- 業務類型：稅務申報  
- 工時類型：休息日加班（前2小時）
- 週六格：輸入 2

第二列設定（點擊「新增列」按鈕）：
- 客戶：測試科技有限公司
- 業務類型：稅務申報
- 工時類型：休息日加班（第3-8小時）
- 週六格：輸入 2

完成後表格顯示：
┌──────────────┬──────────┬──────────────┬───┬ 週六 ┬───┐
│ 客戶 ▼       │業務類型▼ │工時類型▼     │週五│(11/2)│週日│
├──────────────┼──────────┼──────────────┼───┼──────┼───┤
│測試科技有限  │稅務申報  │休息日加班前2h│   │  2   │   │
│測試科技有限  │稅務申報  │休息日加班3-8h│   │  2   │   │
└──────────────┴──────────┴──────────────┴───┴──────┴───┘

自動儲存後：
✓ 記錄 4 小時實際工時（2+2）
✓ 系統自動計算加班費：2×1.34 + 2×1.67
✓ 自動產生補休 = 4 小時（1:1）
✓ 補休有效期：到 11月30日
```

### 範例 3：平日晚上加班 2 小時
```
員工 B 在試算表中填寫 2025年11月4日（週一）工時：

第一列：
- 客戶下拉選單：選擇「ABC公司」
- 業務類型下拉選單：選擇「記帳」
- 工時類型下拉選單：選擇「正常工時」
- 週一格：輸入 8

第二列（新增）：
- 客戶下拉選單：選擇「ABC公司」
- 業務類型下拉選單：選擇「記帳」
- 工時類型下拉選單：選擇「平日加班（前2小時）」
- 週一格：輸入 2

自動儲存後：
✓ 當天總共 10 小時工時
✓ 正常 8 小時 + 加班 2 小時（第9-10小時）
✓ 加班費 = 2 × 時薪 × 1.34
✓ 產生補休 2 小時（1:1）
```

### 範例 4：一週多天工作
```
員工 C 可在試算表中一次填寫整週工時：

設定第一列：客戶▼ABC公司 | 業務類型▼記帳 | 工時類型▼正常工時
設定第二列：客戶▼ABC公司 | 業務類型▼記帳 | 工時類型▼平日加班前2h

然後在各日期格子填入數字：

┌──────┬────────┬────────┬週一┬週二┬週三┬週四┬週五┬週六┬週日┐
│客戶▼ │業務類型▼│工時類型▼│ 4 │ 5 │ 6 │ 7 │ 8 │ 9 │ 10│
├──────┼────────┼────────┼───┼───┼───┼───┼───┼───┼───┤
│ABC   │記帳    │正常工時│ 8 │ 8 │ 8 │ 8 │ 8 │   │   │
│ABC   │記帳    │平日加班│   │   │ 2 │   │   │   │   │
└──────┴────────┴────────┴───┴───┴───┴───┴───┴───┴───┘

優勢：
✓ 可快速瀏覽整週工時
✓ Tab 鍵快速移動填寫
✓ 每個格子自動儲存
✓ 一目瞭然查看工作分布
✓ 下拉選單設定一次，整週使用
```
