# 核心業務表

**包含表格：** Users, Clients, CustomerTags, ClientTagAssignments, TimeLogs (5個)  
**最後更新：** 2025年10月27日

---

## 📋 目錄
- [Users - 使用者/員工](#users---使用者員工)
- [Clients - 客戶資料](#clients---客戶資料)
- [CustomerTags - 客戶標籤](#customertags---客戶標籤)
- [ClientTagAssignments - 標籤關聯](#clienttagassignments---標籤關聯)
- [TimeLogs - 工時記錄](#timelogs---工時記錄)

---

## Users - 使用者/員工

### 表格定義
```sql
CREATE TABLE Users (
  user_id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  name TEXT NOT NULL,
  email TEXT,
  is_admin BOOLEAN DEFAULT 0,
  gender TEXT,
  birth_date TEXT,
  start_date TEXT,
  phone TEXT,
  address TEXT,
  emergency_contact_name TEXT,
  emergency_contact_phone TEXT,
  
  -- 登入控制
  login_attempts INTEGER DEFAULT 0,
  last_failed_login TEXT,
  last_login TEXT,
  
  -- 審計欄位
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,
  deleted_by INTEGER
);
```

### 索引
```sql
CREATE UNIQUE INDEX idx_users_username ON Users(username);
CREATE INDEX idx_users_email ON Users(email);
CREATE INDEX idx_users_is_admin ON Users(is_admin);
```

### 重要欄位說明
- `is_admin`: 0=員工, 1=管理員
- `login_attempts`: 失敗次數，≥5 鎖定 15 分鐘
- `start_date`: 到職日期（計算特休用）

---

## Clients - 客戶資料

### 表格定義
```sql
CREATE TABLE Clients (
  client_id TEXT PRIMARY KEY,              -- 統一編號（8位數字）
  tax_registration_number TEXT,            -- 稅籍編號
  company_name TEXT NOT NULL,
  tax_registration_address TEXT,
  business_status TEXT DEFAULT '營業中',
  organization_type TEXT,
  capital_amount DECIMAL,
  establishment_date TEXT,
  responsible_person TEXT,
  registered_business_items TEXT,          -- JSON格式
  payment_collection_timing TEXT,
  payment_collection_remarks TEXT,
  assignee_user_id INTEGER,
  contact_person_1 TEXT,
  contact_person_2 TEXT,
  phone TEXT,
  email TEXT,
  invoice_count INTEGER DEFAULT 0,
  remarks TEXT,
  
  -- 審計欄位
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,
  deleted_by INTEGER,
  
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id)
);
```

### 索引
```sql
CREATE INDEX idx_clients_tax_reg_number ON Clients(tax_registration_number);
CREATE INDEX idx_clients_company_name ON Clients(company_name);
CREATE INDEX idx_clients_assignee ON Clients(assignee_user_id);
CREATE INDEX idx_clients_status ON Clients(business_status);
```

### 重要欄位說明
- `client_id`: 8位數字統一編號，作為主鍵
- `business_status`: 營業中/停業/歇業
- `registered_business_items`: JSON格式，如 `[{"name":"項目","code":"123"}]`
- `assignee_user_id`: 負責員工

---

## CustomerTags - 客戶標籤

### 表格定義
```sql
CREATE TABLE CustomerTags (
  tag_id INTEGER PRIMARY KEY AUTOINCREMENT,
  tag_name TEXT UNIQUE NOT NULL,
  tag_color TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,
  deleted_by INTEGER
);
```

### 索引
```sql
CREATE UNIQUE INDEX idx_tags_name ON CustomerTags(tag_name);
```

### 重要欄位說明
- `tag_name`: 標籤名稱（唯一）
- `tag_color`: 顯示顏色（Hex格式，如 #FF0000）

---

## ClientTagAssignments - 標籤關聯

### 表格定義
```sql
CREATE TABLE ClientTagAssignments (
  assignment_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  tag_id INTEGER NOT NULL,
  assigned_at TEXT DEFAULT (datetime('now')),
  assigned_by INTEGER,
  
  FOREIGN KEY (client_id) REFERENCES Clients(client_id) ON DELETE CASCADE,
  FOREIGN KEY (tag_id) REFERENCES CustomerTags(tag_id),
  FOREIGN KEY (assigned_by) REFERENCES Users(user_id)
);
```

### 索引
```sql
CREATE INDEX idx_client_tags_client ON ClientTagAssignments(client_id);
CREATE INDEX idx_client_tags_tag ON ClientTagAssignments(tag_id);
CREATE UNIQUE INDEX idx_client_tags_unique ON ClientTagAssignments(client_id, tag_id);
```

### 重要說明
- 一個客戶可以有多個標籤
- 同一客戶不能重複同一標籤（UNIQUE 約束）
- 客戶刪除時自動刪除關聯（CASCADE）

---

## TimeLogs - 工時記錄

### 表格定義
```sql
CREATE TABLE TimeLogs (
  time_log_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  work_date TEXT NOT NULL,                 -- YYYY-MM-DD
  client_id TEXT,
  service_id INTEGER,
  work_type_id INTEGER,
  hours REAL NOT NULL,
  weighted_hours REAL,
  leave_type_id INTEGER,
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (client_id) REFERENCES Clients(client_id),
  FOREIGN KEY (service_id) REFERENCES Services(service_id),
  FOREIGN KEY (work_type_id) REFERENCES WorkTypes(work_type_id),
  FOREIGN KEY (leave_type_id) REFERENCES LeaveTypes(leave_type_id)
);
```

### 索引
```sql
CREATE INDEX idx_timelogs_user_date ON TimeLogs(user_id, work_date);
CREATE INDEX idx_timelogs_client ON TimeLogs(client_id);
CREATE INDEX idx_timelogs_month ON TimeLogs(substr(work_date, 1, 7));
```

### 重要欄位說明
- `hours`: 實際工時
- `weighted_hours`: 加權工時（根據 work_type_id 計算）
- `work_type_id`: 工作類型（正常/平日加班/休息日加班/國定假日加班）
- `leave_type_id`: 請假時使用（與 client_id 互斥）

---

## 表格關聯圖

```
Users (員工)
  │
  ├──► Clients (客戶) - assignee_user_id
  │      │
  │      └──► ClientTagAssignments (標籤關聯)
  │             │
  │             └──► CustomerTags (標籤)
  │
  └──► TimeLogs (工時記錄)
         ├─► Clients (客戶)
         ├─► Services (服務項目)
         ├─► WorkTypes (工作類型)
         └─► LeaveTypes (假別類型)
```

---

## 常用查詢範例

### 查詢員工負責的客戶及標籤
```sql
SELECT 
  c.*,
  u.name as assignee_name,
  GROUP_CONCAT(ct.tag_name, ',') as tags
FROM Clients c
LEFT JOIN Users u ON c.assignee_user_id = u.user_id
LEFT JOIN ClientTagAssignments cta ON c.client_id = cta.client_id
LEFT JOIN CustomerTags ct ON cta.tag_id = ct.tag_id AND ct.is_deleted = 0
WHERE c.assignee_user_id = ? AND c.is_deleted = 0
GROUP BY c.client_id
ORDER BY c.company_name;
```

### 查詢員工月工時統計
```sql
SELECT 
  u.name,
  SUM(t.hours) as total_hours,
  SUM(t.weighted_hours) as total_weighted_hours,
  COUNT(*) as log_count
FROM Users u
JOIN TimeLogs t ON u.user_id = t.user_id
WHERE t.work_date BETWEEN ? AND ?
GROUP BY u.user_id
ORDER BY total_hours DESC;
```

### 查詢客戶工時統計
```sql
SELECT 
  c.company_name,
  SUM(t.hours) as total_hours,
  COUNT(DISTINCT t.user_id) as worker_count
FROM Clients c
JOIN TimeLogs t ON c.client_id = t.client_id
WHERE t.work_date BETWEEN ? AND ?
GROUP BY c.client_id
ORDER BY total_hours DESC;
```

---

## 🔗 相關文檔

- **API 規格：** [客戶管理API](../API規格/客戶管理API.md), [工時管理API](../API規格/工時管理API.md)
- **功能模塊：** [客戶管理](../功能模塊/23-客戶管理.md), [工時表填寫](../功能模塊/08-工時表填寫.md)
- **技術規格：** [客戶管理技術規格](../技術規格/客戶管理/), [工時管理技術規格](../技術規格/工時管理/)

---

**最後更新：** 2025年10月27日  
**本文檔合併了 5 個資料表文檔**

