# æ ¸å¿ƒæ¥­å‹™è¡¨

**åŒ…å«è¡¨æ ¼ï¼š** Users, Clients, CustomerTags, ClientTagAssignments, TimeLogs (5å€‹)  
**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´10æœˆ27æ—¥

---

## ğŸ“‹ ç›®éŒ„
- [Users - ä½¿ç”¨è€…/å“¡å·¥](#users---ä½¿ç”¨è€…å“¡å·¥)
- [Clients - å®¢æˆ¶è³‡æ–™](#clients---å®¢æˆ¶è³‡æ–™)
- [CustomerTags - å®¢æˆ¶æ¨™ç±¤](#customertags---å®¢æˆ¶æ¨™ç±¤)
- [ClientTagAssignments - æ¨™ç±¤é—œè¯](#clienttagassignments---æ¨™ç±¤é—œè¯)
- [TimeLogs - å·¥æ™‚è¨˜éŒ„](#timelogs---å·¥æ™‚è¨˜éŒ„)

---

## Users - ä½¿ç”¨è€…/å“¡å·¥

### è¡¨æ ¼å®šç¾©
```sql
CREATE TABLE Users (
  user_id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  name TEXT NOT NULL,
  email TEXT,
  is_admin BOOLEAN DEFAULT 0,
  gender TEXT,
  birth_date TEXT,
  start_date TEXT,
  phone TEXT,
  address TEXT,
  emergency_contact_name TEXT,
  emergency_contact_phone TEXT,
  
  -- ç™»å…¥æ§åˆ¶
  login_attempts INTEGER DEFAULT 0,
  last_failed_login TEXT,
  last_login TEXT,
  
  -- å¯©è¨ˆæ¬„ä½
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,
  deleted_by INTEGER
);
```

### ç´¢å¼•
```sql
CREATE UNIQUE INDEX idx_users_username ON Users(username);
CREATE INDEX idx_users_email ON Users(email);
CREATE INDEX idx_users_is_admin ON Users(is_admin);
```

### é‡è¦æ¬„ä½èªªæ˜
- `is_admin`: 0=å“¡å·¥, 1=ç®¡ç†å“¡
- `login_attempts`: å¤±æ•—æ¬¡æ•¸ï¼Œâ‰¥5 é–å®š 15 åˆ†é˜
- `start_date`: åˆ°è·æ—¥æœŸï¼ˆè¨ˆç®—ç‰¹ä¼‘ç”¨ï¼‰

---

## Clients - å®¢æˆ¶è³‡æ–™

### è¡¨æ ¼å®šç¾©
```sql
CREATE TABLE Clients (
  client_id TEXT PRIMARY KEY,              -- çµ±ä¸€ç·¨è™Ÿï¼ˆ8ä½æ•¸å­—ï¼‰
  tax_registration_number TEXT,            -- ç¨…ç±ç·¨è™Ÿ
  company_name TEXT NOT NULL,
  tax_registration_address TEXT,
  business_status TEXT DEFAULT 'ç‡Ÿæ¥­ä¸­',
  organization_type TEXT,
  capital_amount DECIMAL,
  establishment_date TEXT,
  responsible_person TEXT,
  registered_business_items TEXT,          -- JSONæ ¼å¼
  payment_collection_timing TEXT,
  payment_collection_remarks TEXT,
  assignee_user_id INTEGER,
  contact_person_1 TEXT,
  contact_person_2 TEXT,
  phone TEXT,
  email TEXT,
  invoice_count INTEGER DEFAULT 0,
  remarks TEXT,
  
  -- å¯©è¨ˆæ¬„ä½
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,
  deleted_by INTEGER,
  
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id)
);
```

### ç´¢å¼•
```sql
CREATE INDEX idx_clients_tax_reg_number ON Clients(tax_registration_number);
CREATE INDEX idx_clients_company_name ON Clients(company_name);
CREATE INDEX idx_clients_assignee ON Clients(assignee_user_id);
CREATE INDEX idx_clients_status ON Clients(business_status);
```

### é‡è¦æ¬„ä½èªªæ˜
- `client_id`: 8ä½æ•¸å­—çµ±ä¸€ç·¨è™Ÿï¼Œä½œç‚ºä¸»éµ
- `business_status`: ç‡Ÿæ¥­ä¸­/åœæ¥­/æ­‡æ¥­
- `registered_business_items`: JSONæ ¼å¼ï¼Œå¦‚ `[{"name":"é …ç›®","code":"123"}]`
- `assignee_user_id`: è² è²¬å“¡å·¥

---

## CustomerTags - å®¢æˆ¶æ¨™ç±¤

### è¡¨æ ¼å®šç¾©
```sql
CREATE TABLE CustomerTags (
  tag_id INTEGER PRIMARY KEY AUTOINCREMENT,
  tag_name TEXT UNIQUE NOT NULL,
  tag_color TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,
  deleted_by INTEGER
);
```

### ç´¢å¼•
```sql
CREATE UNIQUE INDEX idx_tags_name ON CustomerTags(tag_name);
```

### é‡è¦æ¬„ä½èªªæ˜
- `tag_name`: æ¨™ç±¤åç¨±ï¼ˆå”¯ä¸€ï¼‰
- `tag_color`: é¡¯ç¤ºé¡è‰²ï¼ˆHexæ ¼å¼ï¼Œå¦‚ #FF0000ï¼‰

---

## ClientTagAssignments - æ¨™ç±¤é—œè¯

### è¡¨æ ¼å®šç¾©
```sql
CREATE TABLE ClientTagAssignments (
  assignment_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  tag_id INTEGER NOT NULL,
  assigned_at TEXT DEFAULT (datetime('now')),
  assigned_by INTEGER,
  
  FOREIGN KEY (client_id) REFERENCES Clients(client_id) ON DELETE CASCADE,
  FOREIGN KEY (tag_id) REFERENCES CustomerTags(tag_id),
  FOREIGN KEY (assigned_by) REFERENCES Users(user_id)
);
```

### ç´¢å¼•
```sql
CREATE INDEX idx_client_tags_client ON ClientTagAssignments(client_id);
CREATE INDEX idx_client_tags_tag ON ClientTagAssignments(tag_id);
CREATE UNIQUE INDEX idx_client_tags_unique ON ClientTagAssignments(client_id, tag_id);
```

### é‡è¦èªªæ˜
- ä¸€å€‹å®¢æˆ¶å¯ä»¥æœ‰å¤šå€‹æ¨™ç±¤
- åŒä¸€å®¢æˆ¶ä¸èƒ½é‡è¤‡åŒä¸€æ¨™ç±¤ï¼ˆUNIQUE ç´„æŸï¼‰
- å®¢æˆ¶åˆªé™¤æ™‚è‡ªå‹•åˆªé™¤é—œè¯ï¼ˆCASCADEï¼‰

---

## TimeLogs - å·¥æ™‚è¨˜éŒ„

### è¡¨æ ¼å®šç¾©
```sql
CREATE TABLE TimeLogs (
  time_log_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  work_date TEXT NOT NULL,                 -- YYYY-MM-DD
  client_id TEXT,
  service_id INTEGER,
  work_type_id INTEGER,
  hours REAL NOT NULL,
  weighted_hours REAL,
  leave_type_id INTEGER,
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (client_id) REFERENCES Clients(client_id),
  FOREIGN KEY (service_id) REFERENCES Services(service_id),
  FOREIGN KEY (work_type_id) REFERENCES WorkTypes(work_type_id),
  FOREIGN KEY (leave_type_id) REFERENCES LeaveTypes(leave_type_id)
);
```

### ç´¢å¼•
```sql
CREATE INDEX idx_timelogs_user_date ON TimeLogs(user_id, work_date);
CREATE INDEX idx_timelogs_client ON TimeLogs(client_id);
CREATE INDEX idx_timelogs_month ON TimeLogs(substr(work_date, 1, 7));
```

### é‡è¦æ¬„ä½èªªæ˜
- `hours`: å¯¦éš›å·¥æ™‚
- `weighted_hours`: åŠ æ¬Šå·¥æ™‚ï¼ˆæ ¹æ“š work_type_id è¨ˆç®—ï¼‰
- `work_type_id`: å·¥ä½œé¡å‹ï¼ˆæ­£å¸¸/å¹³æ—¥åŠ ç­/ä¼‘æ¯æ—¥åŠ ç­/åœ‹å®šå‡æ—¥åŠ ç­ï¼‰
- `leave_type_id`: è«‹å‡æ™‚ä½¿ç”¨ï¼ˆèˆ‡ client_id äº’æ–¥ï¼‰

---

## è¡¨æ ¼é—œè¯åœ–

```
Users (å“¡å·¥)
  â”‚
  â”œâ”€â”€â–º Clients (å®¢æˆ¶) - assignee_user_id
  â”‚      â”‚
  â”‚      â””â”€â”€â–º ClientTagAssignments (æ¨™ç±¤é—œè¯)
  â”‚             â”‚
  â”‚             â””â”€â”€â–º CustomerTags (æ¨™ç±¤)
  â”‚
  â””â”€â”€â–º TimeLogs (å·¥æ™‚è¨˜éŒ„)
         â”œâ”€â–º Clients (å®¢æˆ¶)
         â”œâ”€â–º Services (æœå‹™é …ç›®)
         â”œâ”€â–º WorkTypes (å·¥ä½œé¡å‹)
         â””â”€â–º LeaveTypes (å‡åˆ¥é¡å‹)
```

---

## å¸¸ç”¨æŸ¥è©¢ç¯„ä¾‹

### æŸ¥è©¢å“¡å·¥è² è²¬çš„å®¢æˆ¶åŠæ¨™ç±¤
```sql
SELECT 
  c.*,
  u.name as assignee_name,
  GROUP_CONCAT(ct.tag_name, ',') as tags
FROM Clients c
LEFT JOIN Users u ON c.assignee_user_id = u.user_id
LEFT JOIN ClientTagAssignments cta ON c.client_id = cta.client_id
LEFT JOIN CustomerTags ct ON cta.tag_id = ct.tag_id AND ct.is_deleted = 0
WHERE c.assignee_user_id = ? AND c.is_deleted = 0
GROUP BY c.client_id
ORDER BY c.company_name;
```

### æŸ¥è©¢å“¡å·¥æœˆå·¥æ™‚çµ±è¨ˆ
```sql
SELECT 
  u.name,
  SUM(t.hours) as total_hours,
  SUM(t.weighted_hours) as total_weighted_hours,
  COUNT(*) as log_count
FROM Users u
JOIN TimeLogs t ON u.user_id = t.user_id
WHERE t.work_date BETWEEN ? AND ?
GROUP BY u.user_id
ORDER BY total_hours DESC;
```

### æŸ¥è©¢å®¢æˆ¶å·¥æ™‚çµ±è¨ˆ
```sql
SELECT 
  c.company_name,
  SUM(t.hours) as total_hours,
  COUNT(DISTINCT t.user_id) as worker_count
FROM Clients c
JOIN TimeLogs t ON c.client_id = t.client_id
WHERE t.work_date BETWEEN ? AND ?
GROUP BY c.client_id
ORDER BY total_hours DESC;
```

---

## ğŸ”— ç›¸é—œæ–‡æª”

- **API è¦æ ¼ï¼š** [å®¢æˆ¶ç®¡ç†API](../APIè¦æ ¼/å®¢æˆ¶ç®¡ç†API.md), [å·¥æ™‚ç®¡ç†API](../APIè¦æ ¼/å·¥æ™‚ç®¡ç†API.md)
- **åŠŸèƒ½æ¨¡å¡Šï¼š** [å®¢æˆ¶ç®¡ç†](../åŠŸèƒ½æ¨¡å¡Š/23-å®¢æˆ¶ç®¡ç†.md), [å·¥æ™‚è¡¨å¡«å¯«](../åŠŸèƒ½æ¨¡å¡Š/08-å·¥æ™‚è¡¨å¡«å¯«.md)
- **æŠ€è¡“è¦æ ¼ï¼š** [å®¢æˆ¶ç®¡ç†æŠ€è¡“è¦æ ¼](../æŠ€è¡“è¦æ ¼/å®¢æˆ¶ç®¡ç†/), [å·¥æ™‚ç®¡ç†æŠ€è¡“è¦æ ¼](../æŠ€è¡“è¦æ ¼/å·¥æ™‚ç®¡ç†/)

---

**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´10æœˆ27æ—¥  
**æœ¬æ–‡æª”åˆä½µäº† 5 å€‹è³‡æ–™è¡¨æ–‡æª”**

