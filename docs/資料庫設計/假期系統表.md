# å‡æœŸç³»çµ±è¡¨

**åŒ…å«è¡¨æ ¼ï¼š** LeaveBalances, LeaveApplications, LeaveEvents (3å€‹)  
**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´10æœˆ27æ—¥

---

## ğŸ“‹ ç›®éŒ„
- [LeaveBalances - å‡æœŸé¤˜é¡](#leavebalances---å‡æœŸé¤˜é¡)
- [LeaveApplications - å‡æœŸç”³è«‹](#leaveapplications---å‡æœŸç”³è«‹)
- [LeaveEvents - ç”Ÿæ´»äº‹ä»¶](#leaveevents---ç”Ÿæ´»äº‹ä»¶)

---

## LeaveBalances - å‡æœŸé¤˜é¡

### è¡¨æ ¼å®šç¾©
```sql
CREATE TABLE LeaveBalances (
  balance_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  leave_type_id INTEGER NOT NULL,
  year INTEGER NOT NULL,
  entitled_days REAL DEFAULT 0,
  used_days REAL DEFAULT 0,
  valid_until TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (leave_type_id) REFERENCES LeaveTypes(leave_type_id),
  UNIQUE(user_id, leave_type_id, year)
);
```

### ç´¢å¼•
```sql
CREATE INDEX idx_leave_balances_user ON LeaveBalances(user_id);
CREATE INDEX idx_leave_balances_year ON LeaveBalances(year);
CREATE UNIQUE INDEX idx_leave_balances_unique ON LeaveBalances(user_id, leave_type_id, year);
```

### é‡è¦æ¬„ä½èªªæ˜
- `entitled_days`: æ‡‰æœ‰å¤©æ•¸ï¼ˆæ ¹æ“šè¦å‰‡è‡ªå‹•è¨ˆç®—ï¼‰
- `used_days`: å·²ä½¿ç”¨å¤©æ•¸
- `year`: å¹´åº¦ï¼ˆç‰¹ä¼‘ã€ç—…å‡ç­‰æŒ‰å¹´åº¦è¨ˆç®—ï¼‰
- `valid_until`: æœ‰æ•ˆæœŸé™ï¼ˆå©šå‡ã€å–ªå‡ç­‰æœ‰æœŸé™ï¼‰

---

## LeaveApplications - å‡æœŸç”³è«‹

### è¡¨æ ¼å®šç¾©
```sql
CREATE TABLE LeaveApplications (
  application_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  leave_type_id INTEGER NOT NULL,
  start_date TEXT NOT NULL,
  end_date TEXT NOT NULL,
  days REAL NOT NULL,
  hours REAL,
  reason TEXT,
  applied_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (leave_type_id) REFERENCES LeaveTypes(leave_type_id)
);
```

### ç´¢å¼•
```sql
CREATE INDEX idx_leave_apps_user ON LeaveApplications(user_id);
CREATE INDEX idx_leave_apps_date ON LeaveApplications(start_date, end_date);
CREATE INDEX idx_leave_apps_type ON LeaveApplications(leave_type_id);
```

### é‡è¦æ¬„ä½èªªæ˜
- `days`: è«‹å‡å¤©æ•¸ï¼ˆå¯ä»¥æ˜¯å°æ•¸ï¼Œå¦‚ 0.5 å¤©ï¼‰
- `hours`: è«‹å‡å°æ™‚æ•¸ï¼ˆå°æ–¼ 1 å¤©æ™‚ä½¿ç”¨ï¼‰
- ç”³è«‹å¾Œè‡ªå‹•æ›´æ–° `LeaveBalances.used_days`

---

## LeaveEvents - ç”Ÿæ´»äº‹ä»¶

### è¡¨æ ¼å®šç¾©
```sql
CREATE TABLE LeaveEvents (
  event_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  event_type TEXT NOT NULL,
  event_date TEXT NOT NULL,
  description TEXT,
  has_children BOOLEAN DEFAULT 0,
  created_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id)
);
```

### ç´¢å¼•
```sql
CREATE INDEX idx_leave_events_user ON LeaveEvents(user_id);
CREATE INDEX idx_leave_events_type ON LeaveEvents(event_type);
```

### äº‹ä»¶é¡å‹
- **çµå©š** â†’ ç”¢ç”Ÿå©šå‡ 8 å¤©
- **ç”Ÿè‚²ï¼ˆå¥³æ€§ï¼‰** â†’ ç”¢ç”Ÿç”¢å‡ 56 å¤©
- **é…å¶ç”Ÿè‚²** â†’ ç”¢ç”Ÿé™ªç”¢å‡ 7 å¤©
- **çˆ¶æ¯éä¸–** â†’ ç”¢ç”Ÿå–ªå‡ 8 å¤©
- **é…å¶éä¸–** â†’ ç”¢ç”Ÿå–ªå‡ 8 å¤©
- **å­å¥³éä¸–** â†’ ç”¢ç”Ÿå–ªå‡ 8 å¤©
- **ç¥–çˆ¶æ¯éä¸–** â†’ ç”¢ç”Ÿå–ªå‡ 6 å¤©
- **é…å¶çˆ¶æ¯éä¸–** â†’ ç”¢ç”Ÿå–ªå‡ 6 å¤©
- **å…„å¼Ÿå§Šå¦¹éä¸–** â†’ ç”¢ç”Ÿå–ªå‡ 3 å¤©
- **æ›¾ç¥–çˆ¶æ¯éä¸–** â†’ ç”¢ç”Ÿå–ªå‡ 3 å¤©
- **é…å¶ç¥–çˆ¶æ¯éä¸–** â†’ ç”¢ç”Ÿå–ªå‡ 3 å¤©

---

## è¡¨æ ¼é—œè¯åœ–

```
Users (å“¡å·¥)
  â”‚
  â”œâ”€â”€â–º LeaveBalances (å‡æœŸé¤˜é¡)
  â”‚      â”‚
  â”‚      â””â”€â”€â–º LeaveTypes (å‡åˆ¥é¡å‹)
  â”‚
  â”œâ”€â”€â–º LeaveApplications (å‡æœŸç”³è«‹)
  â”‚      â”‚
  â”‚      â””â”€â”€â–º LeaveTypes (å‡åˆ¥é¡å‹)
  â”‚
  â””â”€â”€â–º LeaveEvents (ç”Ÿæ´»äº‹ä»¶)
         â”‚
         â””â”€â–º OtherLeaveRules (å…¶ä»–å‡æœŸè¦å‰‡)
                â”‚
                â””â”€â–º LeaveTypes (å‡åˆ¥é¡å‹)
```

---

## æ¥­å‹™é‚è¼¯èªªæ˜

### å‡æœŸé¤˜é¡è‡ªå‹•è¨ˆç®—

#### ç‰¹ä¼‘è¨ˆç®—
```sql
-- æ ¹æ“šåˆ°è·æ—¥æœŸå’Œå¹´è³‡è¨ˆç®—ç‰¹ä¼‘
-- æŸ¥è©¢ AnnualLeaveRules è¡¨
SELECT days FROM AnnualLeaveRules
WHERE min_months <= è¨ˆç®—å‡ºçš„æœˆæ•¸
  AND max_months > è¨ˆç®—å‡ºçš„æœˆæ•¸
```

#### ç—…å‡/äº‹å‡è¨ˆç®—
```sql
-- æ¯å¹´å›ºå®šå¤©æ•¸
-- ç—…å‡ï¼š30 å¤©/å¹´
-- äº‹å‡ï¼š14 å¤©/å¹´
-- å¾ LeaveTypes.annual_quota è®€å–
```

#### å…¶ä»–å‡æœŸè¨ˆç®—
```sql
-- æ ¹æ“šç”Ÿæ´»äº‹ä»¶è‡ªå‹•ç”¢ç”Ÿ
-- ç™»è¨˜äº‹ä»¶å¾ŒæŸ¥è©¢ OtherLeaveRules
-- è‡ªå‹•åœ¨ LeaveBalances å¢åŠ é¡åº¦
```

### å‡æœŸç”³è«‹é©—è­‰

1. **é¤˜é¡æª¢æŸ¥**
   ```sql
   SELECT (entitled_days - used_days) as remaining
   FROM LeaveBalances
   WHERE user_id = ? AND leave_type_id = ?
   ```
   
2. **é‡ç–Šæª¢æŸ¥**
   ```sql
   SELECT COUNT(*) FROM LeaveApplications
   WHERE user_id = ?
     AND (
       (start_date <= ? AND end_date >= ?)
       OR (start_date <= ? AND end_date >= ?)
       OR (start_date >= ? AND end_date <= ?)
     )
   ```

3. **æ›´æ–°é¤˜é¡**
   ```sql
   UPDATE LeaveBalances
   SET used_days = used_days + ?
   WHERE user_id = ? AND leave_type_id = ?
   ```

---

## å¸¸ç”¨æŸ¥è©¢ç¯„ä¾‹

### æŸ¥è©¢å“¡å·¥å‡æœŸé¤˜é¡
```sql
SELECT 
  lb.*,
  lt.type_name,
  (lb.entitled_days - lb.used_days) as remaining_days
FROM LeaveBalances lb
JOIN LeaveTypes lt ON lb.leave_type_id = lt.leave_type_id
WHERE lb.user_id = ? AND lb.year = ?
ORDER BY lt.sort_order;
```

### æŸ¥è©¢å“¡å·¥å‡æœŸè¨˜éŒ„
```sql
SELECT 
  la.*,
  lt.type_name
FROM LeaveApplications la
JOIN LeaveTypes lt ON la.leave_type_id = lt.leave_type_id
WHERE la.user_id = ?
  AND la.start_date BETWEEN ? AND ?
ORDER BY la.start_date DESC;
```

### æŸ¥è©¢éƒ¨é–€å‡æœŸçµ±è¨ˆ
```sql
SELECT 
  u.name,
  lt.type_name,
  SUM(la.days) as total_days
FROM LeaveApplications la
JOIN Users u ON la.user_id = u.user_id
JOIN LeaveTypes lt ON la.leave_type_id = lt.leave_type_id
WHERE la.start_date BETWEEN ? AND ?
GROUP BY u.user_id, lt.leave_type_id
ORDER BY total_days DESC;
```

---

## ğŸ”— ç›¸é—œæ–‡æª”

- **API è¦æ ¼ï¼š** [å‡æœŸç®¡ç†API](../APIè¦æ ¼/å‡æœŸç®¡ç†API.md)
- **åŠŸèƒ½æ¨¡å¡Šï¼š** [å‡æœŸç™»è¨˜](../åŠŸèƒ½æ¨¡å¡Š/11-å‡æœŸç™»è¨˜.md), [å‡æœŸé¤˜é¡æŸ¥è©¢](../åŠŸèƒ½æ¨¡å¡Š/13-å‡æœŸé¤˜é¡æŸ¥è©¢.md), [ç”Ÿæ´»äº‹ä»¶ç™»è¨˜](../åŠŸèƒ½æ¨¡å¡Š/12-ç”Ÿæ´»äº‹ä»¶ç™»è¨˜.md)
- **æŠ€è¡“è¦æ ¼ï¼š** [å‡æœŸç®¡ç†æŠ€è¡“è¦æ ¼](../æŠ€è¡“è¦æ ¼/å‡æœŸç®¡ç†/)

---

**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´10æœˆ27æ—¥  
**æœ¬æ–‡æª”åˆä½µäº† 3 å€‹è³‡æ–™è¡¨æ–‡æª”**

