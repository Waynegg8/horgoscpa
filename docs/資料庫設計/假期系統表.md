# 假期系統表

**包含表格：** LeaveBalances, LeaveApplications, LeaveEvents (3個)  
**最後更新：** 2025年10月27日

---

## 📋 目錄
- [LeaveBalances - 假期餘額](#leavebalances---假期餘額)
- [LeaveApplications - 假期申請](#leaveapplications---假期申請)
- [LeaveEvents - 生活事件](#leaveevents---生活事件)

---

## LeaveBalances - 假期餘額

### 表格定義
```sql
CREATE TABLE LeaveBalances (
  balance_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  leave_type_id INTEGER NOT NULL,
  year INTEGER NOT NULL,
  entitled_days REAL DEFAULT 0,
  used_days REAL DEFAULT 0,
  valid_until TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (leave_type_id) REFERENCES LeaveTypes(leave_type_id),
  UNIQUE(user_id, leave_type_id, year)
);
```

### 索引
```sql
CREATE INDEX idx_leave_balances_user ON LeaveBalances(user_id);
CREATE INDEX idx_leave_balances_year ON LeaveBalances(year);
CREATE UNIQUE INDEX idx_leave_balances_unique ON LeaveBalances(user_id, leave_type_id, year);
```

### 重要欄位說明
- `entitled_days`: 應有天數（根據規則自動計算）
- `used_days`: 已使用天數
- `year`: 年度（特休、病假等按年度計算）
- `valid_until`: 有效期限（婚假、喪假等有期限）

---

## LeaveApplications - 假期申請

### 表格定義
```sql
CREATE TABLE LeaveApplications (
  application_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  leave_type_id INTEGER NOT NULL,
  start_date TEXT NOT NULL,
  end_date TEXT NOT NULL,
  days REAL NOT NULL,
  hours REAL,
  reason TEXT,
  applied_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (leave_type_id) REFERENCES LeaveTypes(leave_type_id)
);
```

### 索引
```sql
CREATE INDEX idx_leave_apps_user ON LeaveApplications(user_id);
CREATE INDEX idx_leave_apps_date ON LeaveApplications(start_date, end_date);
CREATE INDEX idx_leave_apps_type ON LeaveApplications(leave_type_id);
```

### 重要欄位說明
- `days`: 請假天數（可以是小數，如 0.5 天）
- `hours`: 請假小時數（小於 1 天時使用）
- 申請後自動更新 `LeaveBalances.used_days`

---

## LeaveEvents - 生活事件

### 表格定義
```sql
CREATE TABLE LeaveEvents (
  event_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  event_type TEXT NOT NULL,
  event_date TEXT NOT NULL,
  description TEXT,
  has_children BOOLEAN DEFAULT 0,
  created_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id)
);
```

### 索引
```sql
CREATE INDEX idx_leave_events_user ON LeaveEvents(user_id);
CREATE INDEX idx_leave_events_type ON LeaveEvents(event_type);
```

### 事件類型
- **結婚** → 產生婚假 8 天
- **生育（女性）** → 產生產假 56 天
- **配偶生育** → 產生陪產假 7 天
- **父母過世** → 產生喪假 8 天
- **配偶過世** → 產生喪假 8 天
- **子女過世** → 產生喪假 8 天
- **祖父母過世** → 產生喪假 6 天
- **配偶父母過世** → 產生喪假 6 天
- **兄弟姊妹過世** → 產生喪假 3 天
- **曾祖父母過世** → 產生喪假 3 天
- **配偶祖父母過世** → 產生喪假 3 天

---

## 表格關聯圖

```
Users (員工)
  │
  ├──► LeaveBalances (假期餘額)
  │      │
  │      └──► LeaveTypes (假別類型)
  │
  ├──► LeaveApplications (假期申請)
  │      │
  │      └──► LeaveTypes (假別類型)
  │
  └──► LeaveEvents (生活事件)
         │
         └─► OtherLeaveRules (其他假期規則)
                │
                └─► LeaveTypes (假別類型)
```

---

## 業務邏輯說明

### 假期餘額自動計算

#### 特休計算
```sql
-- 根據到職日期和年資計算特休
-- 查詢 AnnualLeaveRules 表
SELECT days FROM AnnualLeaveRules
WHERE min_months <= 計算出的月數
  AND max_months > 計算出的月數
```

#### 病假/事假計算
```sql
-- 每年固定天數
-- 病假：30 天/年
-- 事假：14 天/年
-- 從 LeaveTypes.annual_quota 讀取
```

#### 其他假期計算
```sql
-- 根據生活事件自動產生
-- 登記事件後查詢 OtherLeaveRules
-- 自動在 LeaveBalances 增加額度
```

### 假期申請驗證

1. **餘額檢查**
   ```sql
   SELECT (entitled_days - used_days) as remaining
   FROM LeaveBalances
   WHERE user_id = ? AND leave_type_id = ?
   ```
   
2. **重疊檢查**
   ```sql
   SELECT COUNT(*) FROM LeaveApplications
   WHERE user_id = ?
     AND (
       (start_date <= ? AND end_date >= ?)
       OR (start_date <= ? AND end_date >= ?)
       OR (start_date >= ? AND end_date <= ?)
     )
   ```

3. **更新餘額**
   ```sql
   UPDATE LeaveBalances
   SET used_days = used_days + ?
   WHERE user_id = ? AND leave_type_id = ?
   ```

---

## 常用查詢範例

### 查詢員工假期餘額
```sql
SELECT 
  lb.*,
  lt.type_name,
  (lb.entitled_days - lb.used_days) as remaining_days
FROM LeaveBalances lb
JOIN LeaveTypes lt ON lb.leave_type_id = lt.leave_type_id
WHERE lb.user_id = ? AND lb.year = ?
ORDER BY lt.sort_order;
```

### 查詢員工假期記錄
```sql
SELECT 
  la.*,
  lt.type_name
FROM LeaveApplications la
JOIN LeaveTypes lt ON la.leave_type_id = lt.leave_type_id
WHERE la.user_id = ?
  AND la.start_date BETWEEN ? AND ?
ORDER BY la.start_date DESC;
```

### 查詢部門假期統計
```sql
SELECT 
  u.name,
  lt.type_name,
  SUM(la.days) as total_days
FROM LeaveApplications la
JOIN Users u ON la.user_id = u.user_id
JOIN LeaveTypes lt ON la.leave_type_id = lt.leave_type_id
WHERE la.start_date BETWEEN ? AND ?
GROUP BY u.user_id, lt.leave_type_id
ORDER BY total_days DESC;
```

---

## 🔗 相關文檔

- **API 規格：** [假期管理API](../API規格/假期管理API.md)
- **功能模塊：** [假期登記](../功能模塊/11-假期登記.md), [假期餘額查詢](../功能模塊/13-假期餘額查詢.md), [生活事件登記](../功能模塊/12-生活事件登記.md)
- **技術規格：** [假期管理技術規格](../技術規格/假期管理/)

---

**最後更新：** 2025年10月27日  
**本文檔合併了 3 個資料表文檔**

