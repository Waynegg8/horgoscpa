# 知識與內容管理表

**包含表格：** SOPDocuments, ClientSOPLinks, KnowledgeArticles, ExternalArticles, ResourceCenter, ModulePermissions (6個)  
**最後更新：** 2025年10月27日

---

## 📋 目錄
- [SOPDocuments - SOP文件](#sopdocuments---sop文件)
- [ClientSOPLinks - 客戶專屬SOP](#clientsoplinks---客戶專屬sop)
- [KnowledgeArticles - 知識庫文章](#knowledgearticles---知識庫文章)
- [ExternalArticles - 外部文章](#externalarticles---外部文章)
- [ResourceCenter - 資源中心](#resourcecenter---資源中心)
- [ModulePermissions - 模塊權限](#modulepermissions---模塊權限)

---

## SOPDocuments - SOP文件

### 表格定義
```sql
CREATE TABLE SOPDocuments (
  sop_id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  category TEXT,
  tags TEXT,                           -- JSON陣列
  version INTEGER DEFAULT 1,
  is_published BOOLEAN DEFAULT 0,
  created_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (created_by) REFERENCES Users(user_id)
);
```

### 索引
```sql
CREATE INDEX idx_sop_category ON SOPDocuments(category);
CREATE INDEX idx_sop_published ON SOPDocuments(is_published);
CREATE INDEX idx_sop_creator ON SOPDocuments(created_by);
```

### 說明
- SOP（Standard Operating Procedure）標準作業流程
- 支持版本控制
- 可設定為草稿或已發布

---

## ClientSOPLinks - 客戶專屬SOP

### 表格定義
```sql
CREATE TABLE ClientSOPLinks (
  link_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  sop_id INTEGER NOT NULL,
  assigned_by INTEGER NOT NULL,
  assigned_at TEXT DEFAULT (datetime('now')),
  notes TEXT,
  
  FOREIGN KEY (client_id) REFERENCES Clients(client_id),
  FOREIGN KEY (sop_id) REFERENCES SOPDocuments(sop_id),
  FOREIGN KEY (assigned_by) REFERENCES Users(user_id),
  UNIQUE(client_id, sop_id)
);
```

### 索引
```sql
CREATE INDEX idx_client_sop_client ON ClientSOPLinks(client_id);
CREATE INDEX idx_client_sop_sop ON ClientSOPLinks(sop_id);
CREATE UNIQUE INDEX idx_client_sop_unique ON ClientSOPLinks(client_id, sop_id);
```

### 說明
- 將特定 SOP 關聯到特定客戶
- 同一客戶不能重複關聯同一 SOP
- 客戶登入後可查看專屬 SOP

---

## KnowledgeArticles - 知識庫文章

### 表格定義
```sql
CREATE TABLE KnowledgeArticles (
  article_id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  category TEXT,
  tags TEXT,                           -- JSON陣列
  is_published BOOLEAN DEFAULT 0,
  view_count INTEGER DEFAULT 0,
  created_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (created_by) REFERENCES Users(user_id)
);
```

### 索引
```sql
CREATE INDEX idx_knowledge_category ON KnowledgeArticles(category);
CREATE INDEX idx_knowledge_published ON KnowledgeArticles(is_published);
```

### 說明
- 內部知識庫（僅員工可見）
- 常見問題、操作指南、技術文件
- 支持分類和標籤

---

## ExternalArticles - 外部文章

### 表格定義
```sql
CREATE TABLE ExternalArticles (
  external_id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  summary TEXT,
  content TEXT NOT NULL,
  featured_image TEXT,
  category TEXT,
  tags TEXT,                           -- JSON陣列
  is_published BOOLEAN DEFAULT 0,
  published_at TEXT,
  view_count INTEGER DEFAULT 0,
  seo_title TEXT,
  seo_description TEXT,
  seo_keywords TEXT,
  created_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (created_by) REFERENCES Users(user_id)
);
```

### 索引
```sql
CREATE UNIQUE INDEX idx_external_slug ON ExternalArticles(slug);
CREATE INDEX idx_external_category ON ExternalArticles(category);
CREATE INDEX idx_external_published ON ExternalArticles(is_published);
```

### 說明
- 公開網站的文章（blog）
- 支持 SEO 優化
- `slug`: URL 友善的標識符

---

## ResourceCenter - 資源中心

### 表格定義
```sql
CREATE TABLE ResourceCenter (
  resource_id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  description TEXT,
  file_url TEXT NOT NULL,
  file_type TEXT,
  file_size INTEGER,
  category TEXT,
  is_published BOOLEAN DEFAULT 0,
  download_count INTEGER DEFAULT 0,
  created_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (created_by) REFERENCES Users(user_id)
);
```

### 索引
```sql
CREATE INDEX idx_resources_category ON ResourceCenter(category);
CREATE INDEX idx_resources_published ON ResourceCenter(is_published);
CREATE INDEX idx_resources_type ON ResourceCenter(file_type);
```

### 說明
- 可下載的文件資源
- 支持 PDF、Excel、Word 等格式
- 記錄下載次數

---

## ~~ModulePermissions - 模塊權限~~ ⚠️ 已移除

**已優化為：** 使用 `Users.is_admin` 控制權限

### 優化說明

**移除原因：**
- 模塊權限控制過於複雜（14個布林欄位）
- 預設模板機制增加複雜度
- 個別權限覆蓋邏輯難以維護
- 對於小型事務所，兩級權限已足夠

**優化後設計：**
```typescript
// 簡單的權限判斷
if (user.is_admin) {
  // 管理員：所有功能
  return true;
} else {
  // 員工：基本功能
  // - 可以：儀表板、工時表、假期、任務、知識庫（查看）
  // - 不可以：系統設定、業務規則、員工管理、外部內容管理
  return !route.requireAdmin;
}
```

**功能權限表：**

| 功能 | 管理員 | 員工 |
|------|--------|------|
| 儀表板 | ✅ | ✅ |
| 個人資料 | ✅ | ✅ |
| 工時表填寫 | ✅ | ✅ |
| 假期管理 | ✅ | ✅ |
| 任務管理 | ✅ | ✅ |
| 報表中心 | ✅ | ✅（僅看自己）|
| 客戶管理 | ✅ | ✅（僅看負責的）|
| 知識庫查看 | ✅ | ✅ |
| SOP查看 | ✅ | ✅ |
| **系統設定** | ✅ | ❌ |
| **業務規則** | ✅ | ❌ |
| **員工管理** | ✅ | ❌ |
| **外部內容** | ✅ | ❌ |
| **CSV導入** | ✅ | ❌ |
| **知識庫編輯** | ✅ | ❌ |

**資料範圍控制：**
- 員工只能看/改自己的工時、假期、任務
- 員工只能看自己負責的客戶
- 管理員可以看/改所有資料

---

## 表格關聯圖

```
SOPDocuments (SOP文件)
  │
  └──► ClientSOPLinks (關聯到客戶)
         │
         └──► Clients (客戶)

KnowledgeArticles (知識庫) ──► 內部員工查看

ExternalArticles (外部文章) ──► 公開網站顯示

ResourceCenter (資源中心) ──► 公開網站下載

ModulePermissions (模塊權限)
  │
  └──► Users (員工)
```

---

## 內容分類說明

### SOP 文件分類
- 記帳流程
- 報稅流程
- 工商登記流程
- 內部作業規範

### 知識庫分類
- 操作指南
- 常見問題
- 技術文件
- 最佳實踐

### 外部文章分類
- 稅務資訊
- 公司設立
- 會計知識
- 法規更新

### 資源檔案分類
- 表格範本
- 操作手冊
- 法規文件
- 其他資源

---

## 常用查詢範例

### 查詢客戶的專屬SOP
```sql
SELECT 
  s.*,
  csl.assigned_at,
  csl.notes
FROM ClientSOPLinks csl
JOIN SOPDocuments s ON csl.sop_id = s.sop_id
WHERE csl.client_id = ? 
  AND s.is_published = 1 
  AND s.is_deleted = 0
ORDER BY s.title;
```

### 查詢已發布的知識庫文章
```sql
SELECT * FROM KnowledgeArticles
WHERE is_published = 1 AND is_deleted = 0
ORDER BY created_at DESC;
```

### 查詢員工權限
```sql
SELECT * FROM ModulePermissions
WHERE user_id = ?
UNION
SELECT * FROM ModulePermissions
WHERE user_id IS NULL
LIMIT 1;
```

### 查詢熱門資源
```sql
SELECT * FROM ResourceCenter
WHERE is_published = 1 AND is_deleted = 0
ORDER BY download_count DESC
LIMIT 10;
```

---

## 🔗 相關文檔

- **API 規格：** [SOP管理API](../API規格/SOP管理API.md), [員工權限API](../API規格/員工權限API.md)
- **功能模塊：** [SOP文件管理](../功能模塊/18-SOP文件管理.md), [知識庫](../功能模塊/20-通用知識庫.md), [員工權限設定](../功能模塊/01-員工權限設定.md)

---

**最後更新：** 2025年10月27日  
**本文檔合併了 6 個資料表文檔**

