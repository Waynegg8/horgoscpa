# ä»»å‹™ç³»çµ±è¡¨

**åŒ…å«è¡¨æ ¼ï¼š** TaskTemplates, TaskStageTemplates, ActiveTasks, ActiveTaskStages (4å€‹)  
**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´10æœˆ27æ—¥

---

## ğŸ“‹ ç›®éŒ„
- [TaskTemplates - ä»»å‹™æ¨¡æ¿](#tasktemplates---ä»»å‹™æ¨¡æ¿)
- [TaskStageTemplates - éšæ®µæ¨¡æ¿](#taskstagetemplates---éšæ®µæ¨¡æ¿)
- [ActiveTasks - åŸ·è¡Œä¸­ä»»å‹™](#activetasks---åŸ·è¡Œä¸­ä»»å‹™)
- [ActiveTaskStages - ä»»å‹™éšæ®µé€²åº¦](#activetaskstages---ä»»å‹™éšæ®µé€²åº¦)

---

## TaskTemplates - ä»»å‹™æ¨¡æ¿

### è¡¨æ ¼å®šç¾©
```sql
CREATE TABLE TaskTemplates (
  template_id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_name TEXT NOT NULL,
  service_id INTEGER,
  description TEXT,
  estimated_days INTEGER,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (service_id) REFERENCES Services(service_id)
);
```

### ç´¢å¼•
```sql
CREATE INDEX idx_task_templates_service ON TaskTemplates(service_id);
```

### èªªæ˜
- å®šç¾©å¯é‡è¤‡ä½¿ç”¨çš„ä»»å‹™æ¨¡æ¿
- é—œè¯åˆ°æœå‹™é …ç›®
- åŒ…å«å¤šå€‹éšæ®µï¼ˆTaskStageTemplatesï¼‰

---

## TaskStageTemplates - éšæ®µæ¨¡æ¿

### è¡¨æ ¼å®šç¾©
```sql
CREATE TABLE TaskStageTemplates (
  stage_template_id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_id INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_order INTEGER NOT NULL,
  estimated_days INTEGER,
  description TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (template_id) REFERENCES TaskTemplates(template_id) ON DELETE CASCADE
);
```

### ç´¢å¼•
```sql
CREATE INDEX idx_stage_templates_template ON TaskStageTemplates(template_id);
CREATE INDEX idx_stage_templates_order ON TaskStageTemplates(template_id, stage_order);
```

### èªªæ˜
- å±¬æ–¼ä»»å‹™æ¨¡æ¿çš„éšæ®µå®šç¾©
- `stage_order`: éšæ®µé †åºï¼ˆ1, 2, 3...ï¼‰
- æ¨¡æ¿åˆªé™¤æ™‚è‡ªå‹•åˆªé™¤éšæ®µï¼ˆCASCADEï¼‰

---

## ActiveTasks - åŸ·è¡Œä¸­ä»»å‹™

### è¡¨æ ¼å®šç¾©
```sql
CREATE TABLE ActiveTasks (
  task_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_service_id INTEGER NOT NULL,
  template_id INTEGER NOT NULL,
  task_name TEXT NOT NULL,
  start_date TEXT,
  due_date TEXT,
  completed_date TEXT,
  status TEXT DEFAULT 'pending',
  assignee_user_id INTEGER,
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (client_service_id) REFERENCES ClientServices(client_service_id),
  FOREIGN KEY (template_id) REFERENCES TaskTemplates(template_id),
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id)
);
```

### ç´¢å¼•
```sql
CREATE INDEX idx_active_tasks_service ON ActiveTasks(client_service_id);
CREATE INDEX idx_active_tasks_assignee ON ActiveTasks(assignee_user_id);
CREATE INDEX idx_active_tasks_status ON ActiveTasks(status);
CREATE INDEX idx_active_tasks_due_date ON ActiveTasks(due_date);
```

### ç‹€æ…‹èªªæ˜
- `pending`: å¾…é–‹å§‹
- `in_progress`: é€²è¡Œä¸­
- `completed`: å·²å®Œæˆ
- `cancelled`: å·²å–æ¶ˆ

---

## ActiveTaskStages - ä»»å‹™éšæ®µé€²åº¦

### è¡¨æ ¼å®šç¾©
```sql
CREATE TABLE ActiveTaskStages (
  active_stage_id INTEGER PRIMARY KEY AUTOINCREMENT,
  task_id INTEGER NOT NULL,
  stage_template_id INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_order INTEGER NOT NULL,
  status TEXT DEFAULT 'pending',
  started_at TEXT,
  completed_at TEXT,
  assignee_user_id INTEGER,
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (task_id) REFERENCES ActiveTasks(task_id) ON DELETE CASCADE,
  FOREIGN KEY (stage_template_id) REFERENCES TaskStageTemplates(stage_template_id),
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id)
);
```

### ç´¢å¼•
```sql
CREATE INDEX idx_active_stages_task ON ActiveTaskStages(task_id);
CREATE INDEX idx_active_stages_assignee ON ActiveTaskStages(assignee_user_id);
CREATE INDEX idx_active_stages_status ON ActiveTaskStages(status);
```

### ç‹€æ…‹èªªæ˜
- `pending`: å¾…é–‹å§‹
- `in_progress`: é€²è¡Œä¸­
- `completed`: å·²å®Œæˆ

---

## è¡¨æ ¼é—œè¯åœ–

```
TaskTemplates (ä»»å‹™æ¨¡æ¿)
  â”‚
  â”œâ”€â”€â–º TaskStageTemplates (éšæ®µæ¨¡æ¿)
  â”‚
  â””â”€â”€â–º ActiveTasks (åŸ·è¡Œä¸­ä»»å‹™)
         â”‚
         â””â”€â”€â–º ActiveTaskStages (éšæ®µé€²åº¦)
                 â”‚
                 â””â”€â”€â–º TaskStageTemplates (å¼•ç”¨éšæ®µæ¨¡æ¿)
```

---

## æ¥­å‹™æµç¨‹èªªæ˜

### ä»»å‹™è‡ªå‹•ç”Ÿæˆæµç¨‹
```
1. å®¢æˆ¶è¨‚é–±æœå‹™ (ClientServices)
   â†“
2. åˆ°é”è§¸ç™¼æœˆä»½
   â†“
3. æ ¹æ“š TaskTemplates è‡ªå‹•ç”Ÿæˆ ActiveTasks
   â†“
4. æ ¹æ“š TaskStageTemplates è‡ªå‹•ç”Ÿæˆ ActiveTaskStages
   â†“
5. å“¡å·¥æ›´æ–°å„éšæ®µé€²åº¦
```

### éšæ®µç‹€æ…‹è½‰æ›
```
pending â†’ in_progress â†’ completed
   â†“            â†“
(å¯è·³é)    (å¯å–æ¶ˆ)
```

---

## å¸¸ç”¨æŸ¥è©¢ç¯„ä¾‹

### æŸ¥è©¢å®¢æˆ¶çš„åŸ·è¡Œä¸­ä»»å‹™
```sql
SELECT 
  t.*,
  c.company_name,
  s.service_name,
  u.name as assignee_name
FROM ActiveTasks t
JOIN ClientServices cs ON t.client_service_id = cs.client_service_id
JOIN Clients c ON cs.client_id = c.client_id
JOIN Services s ON cs.service_id = s.service_id
LEFT JOIN Users u ON t.assignee_user_id = u.user_id
WHERE c.client_id = ? AND t.is_deleted = 0
ORDER BY t.due_date;
```

### æŸ¥è©¢ä»»å‹™çš„éšæ®µé€²åº¦
```sql
SELECT 
  s.*,
  u.name as assignee_name
FROM ActiveTaskStages s
LEFT JOIN Users u ON s.assignee_user_id = u.user_id
WHERE s.task_id = ?
ORDER BY s.stage_order;
```

### æŸ¥è©¢é€¾æœŸä»»å‹™
```sql
SELECT 
  t.*,
  c.company_name
FROM ActiveTasks t
JOIN ClientServices cs ON t.client_service_id = cs.client_service_id
JOIN Clients c ON cs.client_id = c.client_id
WHERE t.due_date < date('now')
  AND t.status != 'completed'
  AND t.is_deleted = 0
ORDER BY t.due_date;
```

---

## ğŸ”— ç›¸é—œæ–‡æª”

- **API è¦æ ¼ï¼š** [ä»»å‹™ç®¡ç†API](../APIè¦æ ¼/ä»»å‹™ç®¡ç†API.md)
- **åŠŸèƒ½æ¨¡å¡Šï¼š** [ä»»å‹™æ¨¡æ¿ç®¡ç†](../åŠŸèƒ½æ¨¡å¡Š/14-ä»»å‹™æ¨¡æ¿ç®¡ç†.md), [ä»»å‹™é€²åº¦è¿½è¹¤](../åŠŸèƒ½æ¨¡å¡Š/16-ä»»å‹™é€²åº¦è¿½è¹¤.md)
- **æŠ€è¡“è¦æ ¼ï¼š** [ä»»å‹™ç³»çµ±æŠ€è¡“è¦æ ¼](../æŠ€è¡“è¦æ ¼/ä»»å‹™æ¨¡æ¿/)

---

**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´10æœˆ27æ—¥  
**æœ¬æ–‡æª”åˆä½µäº† 4 å€‹è³‡æ–™è¡¨æ–‡æª”**

