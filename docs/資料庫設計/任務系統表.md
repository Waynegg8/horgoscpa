# 任務系統表

**包含表格：** TaskTemplates, TaskStageTemplates, ActiveTasks, ActiveTaskStages (4個)  
**最後更新：** 2025年10月27日

---

## 📋 目錄
- [TaskTemplates - 任務模板](#tasktemplates---任務模板)
- [TaskStageTemplates - 階段模板](#taskstagetemplates---階段模板)
- [ActiveTasks - 執行中任務](#activetasks---執行中任務)
- [ActiveTaskStages - 任務階段進度](#activetaskstages---任務階段進度)

---

## TaskTemplates - 任務模板

### 表格定義
```sql
CREATE TABLE TaskTemplates (
  template_id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_name TEXT NOT NULL,
  service_id INTEGER,
  description TEXT,
  estimated_days INTEGER,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (service_id) REFERENCES Services(service_id)
);
```

### 索引
```sql
CREATE INDEX idx_task_templates_service ON TaskTemplates(service_id);
```

### 說明
- 定義可重複使用的任務模板
- 關聯到服務項目
- 包含多個階段（TaskStageTemplates）

---

## TaskStageTemplates - 階段模板

### 表格定義
```sql
CREATE TABLE TaskStageTemplates (
  stage_template_id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_id INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_order INTEGER NOT NULL,
  estimated_days INTEGER,
  description TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (template_id) REFERENCES TaskTemplates(template_id) ON DELETE CASCADE
);
```

### 索引
```sql
CREATE INDEX idx_stage_templates_template ON TaskStageTemplates(template_id);
CREATE INDEX idx_stage_templates_order ON TaskStageTemplates(template_id, stage_order);
```

### 說明
- 屬於任務模板的階段定義
- `stage_order`: 階段順序（1, 2, 3...）
- 模板刪除時自動刪除階段（CASCADE）

---

## ActiveTasks - 執行中任務

### 表格定義
```sql
CREATE TABLE ActiveTasks (
  task_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_service_id INTEGER NOT NULL,
  template_id INTEGER NOT NULL,
  task_name TEXT NOT NULL,
  start_date TEXT,
  due_date TEXT,
  completed_date TEXT,
  status TEXT DEFAULT 'pending',
  assignee_user_id INTEGER,
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (client_service_id) REFERENCES ClientServices(client_service_id),
  FOREIGN KEY (template_id) REFERENCES TaskTemplates(template_id),
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id)
);
```

### 索引
```sql
CREATE INDEX idx_active_tasks_service ON ActiveTasks(client_service_id);
CREATE INDEX idx_active_tasks_assignee ON ActiveTasks(assignee_user_id);
CREATE INDEX idx_active_tasks_status ON ActiveTasks(status);
CREATE INDEX idx_active_tasks_due_date ON ActiveTasks(due_date);
```

### 狀態說明
- `pending`: 待開始
- `in_progress`: 進行中
- `completed`: 已完成
- `cancelled`: 已取消

---

## ActiveTaskStages - 任務階段進度

### 表格定義
```sql
CREATE TABLE ActiveTaskStages (
  active_stage_id INTEGER PRIMARY KEY AUTOINCREMENT,
  task_id INTEGER NOT NULL,
  stage_template_id INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_order INTEGER NOT NULL,
  status TEXT DEFAULT 'pending',
  started_at TEXT,
  completed_at TEXT,
  assignee_user_id INTEGER,
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (task_id) REFERENCES ActiveTasks(task_id) ON DELETE CASCADE,
  FOREIGN KEY (stage_template_id) REFERENCES TaskStageTemplates(stage_template_id),
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id)
);
```

### 索引
```sql
CREATE INDEX idx_active_stages_task ON ActiveTaskStages(task_id);
CREATE INDEX idx_active_stages_assignee ON ActiveTaskStages(assignee_user_id);
CREATE INDEX idx_active_stages_status ON ActiveTaskStages(status);
```

### 狀態說明
- `pending`: 待開始
- `in_progress`: 進行中
- `completed`: 已完成

---

## 表格關聯圖

```
TaskTemplates (任務模板)
  │
  ├──► TaskStageTemplates (階段模板)
  │
  └──► ActiveTasks (執行中任務)
         │
         └──► ActiveTaskStages (階段進度)
                 │
                 └──► TaskStageTemplates (引用階段模板)
```

---

## 業務流程說明

### 任務自動生成流程
```
1. 客戶訂閱服務 (ClientServices)
   ↓
2. 到達觸發月份
   ↓
3. 根據 TaskTemplates 自動生成 ActiveTasks
   ↓
4. 根據 TaskStageTemplates 自動生成 ActiveTaskStages
   ↓
5. 員工更新各階段進度
```

### 階段狀態轉換
```
pending → in_progress → completed
   ↓            ↓
(可跳過)    (可取消)
```

---

## 常用查詢範例

### 查詢客戶的執行中任務
```sql
SELECT 
  t.*,
  c.company_name,
  s.service_name,
  u.name as assignee_name
FROM ActiveTasks t
JOIN ClientServices cs ON t.client_service_id = cs.client_service_id
JOIN Clients c ON cs.client_id = c.client_id
JOIN Services s ON cs.service_id = s.service_id
LEFT JOIN Users u ON t.assignee_user_id = u.user_id
WHERE c.client_id = ? AND t.is_deleted = 0
ORDER BY t.due_date;
```

### 查詢任務的階段進度
```sql
SELECT 
  s.*,
  u.name as assignee_name
FROM ActiveTaskStages s
LEFT JOIN Users u ON s.assignee_user_id = u.user_id
WHERE s.task_id = ?
ORDER BY s.stage_order;
```

### 查詢逾期任務
```sql
SELECT 
  t.*,
  c.company_name
FROM ActiveTasks t
JOIN ClientServices cs ON t.client_service_id = cs.client_service_id
JOIN Clients c ON cs.client_id = c.client_id
WHERE t.due_date < date('now')
  AND t.status != 'completed'
  AND t.is_deleted = 0
ORDER BY t.due_date;
```

---

## 🔗 相關文檔

- **API 規格：** [任務管理API](../API規格/任務管理API.md)
- **功能模塊：** [任務模板管理](../功能模塊/14-任務模板管理.md), [任務進度追蹤](../功能模塊/16-任務進度追蹤.md)
- **技術規格：** [任務系統技術規格](../技術規格/任務模板/)

---

**最後更新：** 2025年10月27日  
**本文檔合併了 4 個資料表文檔**

