# 服務與補休系統表

**包含表格：** ClientServices, CompensatoryLeaveBalance, CompensatoryLeaveTransactions, CompensatoryLeaveUsage, SystemSettings, AuditLogs (6個)  
**最後更新：** 2025年10月27日

---

## 📋 目錄
- [ClientServices - 客戶服務](#clientservices---客戶服務)
- [補休系統](#補休系統)
  - [CompensatoryLeaveBalance - 補休餘額](#compensatoryleavebalance---補休餘額)
  - [CompensatoryLeaveTransactions - 補休交易](#compensatoryleavetransactions---補休交易)
  - [CompensatoryLeaveUsage - 補休使用](#compensatoryleaveusage---補休使用)
- [SystemSettings - 系統設定](#systemsettings---系統設定)
- [AuditLogs - 審計日誌](#auditlogs---審計日誌)

---

## ClientServices - 客戶服務

### 表格定義
```sql
CREATE TABLE ClientServices (
  client_service_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  service_id INTEGER NOT NULL,
  frequency_id INTEGER NOT NULL,
  start_date TEXT NOT NULL,
  end_date TEXT,
  is_active BOOLEAN DEFAULT 1,
  trigger_months TEXT,                  -- JSON陣列：[1,3,5,7,9,11]
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (client_id) REFERENCES Clients(client_id),
  FOREIGN KEY (service_id) REFERENCES Services(service_id),
  FOREIGN KEY (frequency_id) REFERENCES ServiceFrequencyTypes(frequency_id),
  UNIQUE(client_id, service_id)
);
```

### 索引
```sql
CREATE INDEX idx_client_services_client ON ClientServices(client_id);
CREATE INDEX idx_client_services_service ON ClientServices(service_id);
CREATE UNIQUE INDEX idx_client_services_unique ON ClientServices(client_id, service_id);
```

### 重要說明
- 同一客戶不能重複訂閱同一服務
- `trigger_months`: 觸發任務的月份（JSON 陣列）
- 週期性服務必須設定 trigger_months
- 根據此表自動生成 ActiveTasks

---

## 補休系統（已優化）

### CompensatoryLeave - 補休餘額（優化為單表）

```sql
CREATE TABLE CompensatoryLeave (
  user_id INTEGER PRIMARY KEY,  -- 每個員工一筆
  balance_hours REAL DEFAULT 0,
  earned_total REAL DEFAULT 0,   -- 累積獲得（統計用）
  used_total REAL DEFAULT 0,     -- 累積使用（統計用）
  last_earned_at TEXT,           -- 最後獲得時間
  last_used_at TEXT,             -- 最後使用時間
  updated_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id)
);
```

**優化說明：**
- **3個表合併為1個表**
- 保留核心功能：記錄餘額
- 移除複雜的交易記錄（如需歷史，查 TimeLogs 和 LeaveApplications）
- 簡化邏輯，提升效能

**索引：**
```sql
CREATE UNIQUE INDEX idx_comp_leave_user ON CompensatoryLeave(user_id);
```

---

### 補休流程（優化後）

#### 產生補休（簡化）
```sql
-- 員工登記加班工時時
1. INSERT INTO TimeLogs (user_id, work_type_id, hours, ...)
   
-- 如果是加班（is_overtime = 1）
2. 計算補休時數 = hours × overtime_multiplier

3. INSERT INTO CompensatoryLeave (user_id, balance_hours, earned_total, last_earned_at)
   VALUES (?, ?, ?, CURRENT_TIMESTAMP)
   ON CONFLICT(user_id) DO UPDATE SET
     balance_hours = balance_hours + ?,
     earned_total = earned_total + ?,
     last_earned_at = CURRENT_TIMESTAMP
```

#### 使用補休（簡化）
```sql
-- 員工請補休時
1. 檢查餘額
   SELECT balance_hours FROM CompensatoryLeave WHERE user_id = ?
   
2. INSERT INTO LeaveApplications (user_id, leave_type_id='補休', hours, ...)

3. UPDATE CompensatoryLeave SET
     balance_hours = balance_hours - ?,
     used_total = used_total + ?,
     last_used_at = CURRENT_TIMESTAMP
   WHERE user_id = ?
```

---

### 查詢補休歷史（使用現有表）

```sql
-- 查詢補休產生記錄（從加班工時）
SELECT 
  work_date,
  hours,
  hours * overtime_multiplier as comp_hours
FROM TimeLogs
WHERE user_id = ? AND is_overtime = 1
ORDER BY work_date DESC;

-- 查詢補休使用記錄
SELECT 
  start_date,
  end_date,
  days * 8 as hours_used
FROM LeaveApplications
WHERE user_id = ? AND leave_type_id = (
  SELECT leave_type_id FROM LeaveTypes WHERE type_name = '補休'
)
ORDER BY start_date DESC;
```

**優勢：**
- ✅ 不需要單獨的交易表
- ✅ 歷史記錄從現有表查詢
- ✅ 減少資料冗餘
- ✅ 簡化邏輯

---

## SystemSettings - 系統設定

### 表格定義
```sql
CREATE TABLE SystemSettings (
  setting_id INTEGER PRIMARY KEY AUTOINCREMENT,
  setting_key TEXT UNIQUE NOT NULL,
  setting_value TEXT NOT NULL,
  description TEXT,
  updated_at TEXT DEFAULT (datetime('now')),
  updated_by INTEGER,
  
  FOREIGN KEY (updated_by) REFERENCES Users(user_id)
);
```

### 索引
```sql
CREATE UNIQUE INDEX idx_settings_key ON SystemSettings(setting_key);
```

### 常用設定
| Key | 說明 | 範例值 |
|-----|------|--------|
| `system_name` | 系統名稱 | "XX 會計師事務所" |
| `default_working_hours` | 預設工時/日 | "8" |
| `fiscal_year_start` | 會計年度開始月 | "1" |
| `comp_leave_expiry_months` | 補休期限（月）| "12" |

---

## AuditLogs - 審計日誌

### 表格定義
```sql
CREATE TABLE AuditLogs (
  log_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  action TEXT NOT NULL,                -- CREATE, UPDATE, DELETE, LOGIN
  table_name TEXT NOT NULL,
  record_id TEXT,
  changes TEXT,                        -- JSON格式
  ip_address TEXT,
  user_agent TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id)
);
```

### 索引
```sql
CREATE INDEX idx_audit_logs_user ON AuditLogs(user_id);
CREATE INDEX idx_audit_logs_table ON AuditLogs(table_name);
CREATE INDEX idx_audit_logs_action ON AuditLogs(action);
CREATE INDEX idx_audit_logs_date ON AuditLogs(created_at);
```

### 記錄的操作
- **CREATE**: 新增記錄
- **UPDATE**: 更新記錄
- **DELETE**: 刪除記錄（軟刪除）
- **LOGIN**: 使用者登入
- **LOGOUT**: 使用者登出

### 記錄內容
```json
{
  "old": {"client_id": "12345678", "company_name": "舊名稱"},
  "new": {"client_id": "12345678", "company_name": "新名稱"}
}
```

---

## 表格關聯圖

```
Clients (客戶)
  │
  └──► ClientServices (客戶服務)
         ├──► Services (服務項目)
         ├──► ServiceFrequencyTypes (週期類型)
         └──► ActiveTasks (自動生成任務)

TimeLogs (工時記錄)
  │
  └──► CompensatoryLeaveTransactions (產生補休)
         │
         └──► CompensatoryLeaveBalance (補休餘額)
                │
                └──► CompensatoryLeaveUsage (使用補休)

Users (員工) ──► AuditLogs (所有操作記錄)
```

---

## 常用查詢範例

### 查詢客戶的服務配置
```sql
SELECT 
  cs.*,
  c.company_name,
  s.service_name,
  ft.name as frequency_name
FROM ClientServices cs
JOIN Clients c ON cs.client_id = c.client_id
JOIN Services s ON cs.service_id = s.service_id
JOIN ServiceFrequencyTypes ft ON cs.frequency_id = ft.frequency_id
WHERE cs.client_id = ? AND cs.is_deleted = 0;
```

### 查詢員工補休餘額
```sql
SELECT 
  u.name,
  clb.balance_hours,
  clb.updated_at
FROM Users u
LEFT JOIN CompensatoryLeaveBalance clb ON u.user_id = clb.user_id
WHERE u.user_id = ?;
```

### 查詢補休交易記錄
```sql
SELECT 
  t.*,
  CASE 
    WHEN t.transaction_type = 'earned' THEN '+' || t.hours
    WHEN t.transaction_type = 'used' THEN '-' || t.hours
  END as change
FROM CompensatoryLeaveTransactions t
WHERE t.user_id = ?
ORDER BY t.created_at DESC;
```

### 查詢操作日誌
```sql
SELECT 
  al.*,
  u.name as user_name
FROM AuditLogs al
JOIN Users u ON al.user_id = u.user_id
WHERE al.table_name = ? AND al.record_id = ?
ORDER BY al.created_at DESC;
```

---

## 🔗 相關文檔

- **API 規格：** [客戶服務API](../API規格/客戶服務API.md)
- **功能模塊：** [客戶服務設定](../功能模塊/15-客戶服務設定.md)
- **技術規格：** [客戶服務技術規格](../技術規格/客戶服務/)

---

**最後更新：** 2025年10月27日  
**本文檔合併了 6 個資料表文檔**

