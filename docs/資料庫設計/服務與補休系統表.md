# æœå‹™èˆ‡è£œä¼‘ç³»çµ±è¡¨

**åŒ…å«è¡¨æ ¼ï¼š** ClientServices, CompensatoryLeaveBalance, CompensatoryLeaveTransactions, CompensatoryLeaveUsage, SystemSettings, AuditLogs (6å€‹)  
**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´10æœˆ27æ—¥

---

## ğŸ“‹ ç›®éŒ„
- [ClientServices - å®¢æˆ¶æœå‹™](#clientservices---å®¢æˆ¶æœå‹™)
- [è£œä¼‘ç³»çµ±](#è£œä¼‘ç³»çµ±)
  - [CompensatoryLeaveBalance - è£œä¼‘é¤˜é¡](#compensatoryleavebalance---è£œä¼‘é¤˜é¡)
  - [CompensatoryLeaveTransactions - è£œä¼‘äº¤æ˜“](#compensatoryleavetransactions---è£œä¼‘äº¤æ˜“)
  - [CompensatoryLeaveUsage - è£œä¼‘ä½¿ç”¨](#compensatoryleaveusage---è£œä¼‘ä½¿ç”¨)
- [SystemSettings - ç³»çµ±è¨­å®š](#systemsettings---ç³»çµ±è¨­å®š)
- [AuditLogs - å¯©è¨ˆæ—¥èªŒ](#auditlogs---å¯©è¨ˆæ—¥èªŒ)

---

## ClientServices - å®¢æˆ¶æœå‹™

### è¡¨æ ¼å®šç¾©
```sql
CREATE TABLE ClientServices (
  client_service_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  service_id INTEGER NOT NULL,
  frequency_id INTEGER NOT NULL,
  start_date TEXT NOT NULL,
  end_date TEXT,
  is_active BOOLEAN DEFAULT 1,
  trigger_months TEXT,                  -- JSONé™£åˆ—ï¼š[1,3,5,7,9,11]
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (client_id) REFERENCES Clients(client_id),
  FOREIGN KEY (service_id) REFERENCES Services(service_id),
  FOREIGN KEY (frequency_id) REFERENCES ServiceFrequencyTypes(frequency_id),
  UNIQUE(client_id, service_id)
);
```

### ç´¢å¼•
```sql
CREATE INDEX idx_client_services_client ON ClientServices(client_id);
CREATE INDEX idx_client_services_service ON ClientServices(service_id);
CREATE UNIQUE INDEX idx_client_services_unique ON ClientServices(client_id, service_id);
```

### é‡è¦èªªæ˜
- åŒä¸€å®¢æˆ¶ä¸èƒ½é‡è¤‡è¨‚é–±åŒä¸€æœå‹™
- `trigger_months`: è§¸ç™¼ä»»å‹™çš„æœˆä»½ï¼ˆJSON é™£åˆ—ï¼‰
- é€±æœŸæ€§æœå‹™å¿…é ˆè¨­å®š trigger_months
- æ ¹æ“šæ­¤è¡¨è‡ªå‹•ç”Ÿæˆ ActiveTasks

---

## è£œä¼‘ç³»çµ±ï¼ˆå·²å„ªåŒ–ï¼‰

### CompensatoryLeave - è£œä¼‘é¤˜é¡ï¼ˆå„ªåŒ–ç‚ºå–®è¡¨ï¼‰

```sql
CREATE TABLE CompensatoryLeave (
  user_id INTEGER PRIMARY KEY,  -- æ¯å€‹å“¡å·¥ä¸€ç­†
  balance_hours REAL DEFAULT 0,
  earned_total REAL DEFAULT 0,   -- ç´¯ç©ç²å¾—ï¼ˆçµ±è¨ˆç”¨ï¼‰
  used_total REAL DEFAULT 0,     -- ç´¯ç©ä½¿ç”¨ï¼ˆçµ±è¨ˆç”¨ï¼‰
  last_earned_at TEXT,           -- æœ€å¾Œç²å¾—æ™‚é–“
  last_used_at TEXT,             -- æœ€å¾Œä½¿ç”¨æ™‚é–“
  updated_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id)
);
```

**å„ªåŒ–èªªæ˜ï¼š**
- **3å€‹è¡¨åˆä½µç‚º1å€‹è¡¨**
- ä¿ç•™æ ¸å¿ƒåŠŸèƒ½ï¼šè¨˜éŒ„é¤˜é¡
- ç§»é™¤è¤‡é›œçš„äº¤æ˜“è¨˜éŒ„ï¼ˆå¦‚éœ€æ­·å²ï¼ŒæŸ¥ TimeLogs å’Œ LeaveApplicationsï¼‰
- ç°¡åŒ–é‚è¼¯ï¼Œæå‡æ•ˆèƒ½

**ç´¢å¼•ï¼š**
```sql
CREATE UNIQUE INDEX idx_comp_leave_user ON CompensatoryLeave(user_id);
```

---

### è£œä¼‘æµç¨‹ï¼ˆå„ªåŒ–å¾Œï¼‰

#### ç”¢ç”Ÿè£œä¼‘ï¼ˆç°¡åŒ–ï¼‰
```sql
-- å“¡å·¥ç™»è¨˜åŠ ç­å·¥æ™‚æ™‚
1. INSERT INTO TimeLogs (user_id, work_type_id, hours, ...)
   
-- å¦‚æœæ˜¯åŠ ç­ï¼ˆis_overtime = 1ï¼‰
2. è¨ˆç®—è£œä¼‘æ™‚æ•¸ = hours Ã— overtime_multiplier

3. INSERT INTO CompensatoryLeave (user_id, balance_hours, earned_total, last_earned_at)
   VALUES (?, ?, ?, CURRENT_TIMESTAMP)
   ON CONFLICT(user_id) DO UPDATE SET
     balance_hours = balance_hours + ?,
     earned_total = earned_total + ?,
     last_earned_at = CURRENT_TIMESTAMP
```

#### ä½¿ç”¨è£œä¼‘ï¼ˆç°¡åŒ–ï¼‰
```sql
-- å“¡å·¥è«‹è£œä¼‘æ™‚
1. æª¢æŸ¥é¤˜é¡
   SELECT balance_hours FROM CompensatoryLeave WHERE user_id = ?
   
2. INSERT INTO LeaveApplications (user_id, leave_type_id='è£œä¼‘', hours, ...)

3. UPDATE CompensatoryLeave SET
     balance_hours = balance_hours - ?,
     used_total = used_total + ?,
     last_used_at = CURRENT_TIMESTAMP
   WHERE user_id = ?
```

---

### æŸ¥è©¢è£œä¼‘æ­·å²ï¼ˆä½¿ç”¨ç¾æœ‰è¡¨ï¼‰

```sql
-- æŸ¥è©¢è£œä¼‘ç”¢ç”Ÿè¨˜éŒ„ï¼ˆå¾åŠ ç­å·¥æ™‚ï¼‰
SELECT 
  work_date,
  hours,
  hours * overtime_multiplier as comp_hours
FROM TimeLogs
WHERE user_id = ? AND is_overtime = 1
ORDER BY work_date DESC;

-- æŸ¥è©¢è£œä¼‘ä½¿ç”¨è¨˜éŒ„
SELECT 
  start_date,
  end_date,
  days * 8 as hours_used
FROM LeaveApplications
WHERE user_id = ? AND leave_type_id = (
  SELECT leave_type_id FROM LeaveTypes WHERE type_name = 'è£œä¼‘'
)
ORDER BY start_date DESC;
```

**å„ªå‹¢ï¼š**
- âœ… ä¸éœ€è¦å–®ç¨çš„äº¤æ˜“è¡¨
- âœ… æ­·å²è¨˜éŒ„å¾ç¾æœ‰è¡¨æŸ¥è©¢
- âœ… æ¸›å°‘è³‡æ–™å†—é¤˜
- âœ… ç°¡åŒ–é‚è¼¯

---

## SystemSettings - ç³»çµ±è¨­å®š

### è¡¨æ ¼å®šç¾©
```sql
CREATE TABLE SystemSettings (
  setting_id INTEGER PRIMARY KEY AUTOINCREMENT,
  setting_key TEXT UNIQUE NOT NULL,
  setting_value TEXT NOT NULL,
  description TEXT,
  updated_at TEXT DEFAULT (datetime('now')),
  updated_by INTEGER,
  
  FOREIGN KEY (updated_by) REFERENCES Users(user_id)
);
```

### ç´¢å¼•
```sql
CREATE UNIQUE INDEX idx_settings_key ON SystemSettings(setting_key);
```

### å¸¸ç”¨è¨­å®š
| Key | èªªæ˜ | ç¯„ä¾‹å€¼ |
|-----|------|--------|
| `system_name` | ç³»çµ±åç¨± | "XX æœƒè¨ˆå¸«äº‹å‹™æ‰€" |
| `default_working_hours` | é è¨­å·¥æ™‚/æ—¥ | "8" |
| `fiscal_year_start` | æœƒè¨ˆå¹´åº¦é–‹å§‹æœˆ | "1" |
| `comp_leave_expiry_months` | è£œä¼‘æœŸé™ï¼ˆæœˆï¼‰| "12" |

---

## AuditLogs - å¯©è¨ˆæ—¥èªŒ

### è¡¨æ ¼å®šç¾©
```sql
CREATE TABLE AuditLogs (
  log_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  action TEXT NOT NULL,                -- CREATE, UPDATE, DELETE, LOGIN
  table_name TEXT NOT NULL,
  record_id TEXT,
  changes TEXT,                        -- JSONæ ¼å¼
  ip_address TEXT,
  user_agent TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id)
);
```

### ç´¢å¼•
```sql
CREATE INDEX idx_audit_logs_user ON AuditLogs(user_id);
CREATE INDEX idx_audit_logs_table ON AuditLogs(table_name);
CREATE INDEX idx_audit_logs_action ON AuditLogs(action);
CREATE INDEX idx_audit_logs_date ON AuditLogs(created_at);
```

### è¨˜éŒ„çš„æ“ä½œ
- **CREATE**: æ–°å¢è¨˜éŒ„
- **UPDATE**: æ›´æ–°è¨˜éŒ„
- **DELETE**: åˆªé™¤è¨˜éŒ„ï¼ˆè»Ÿåˆªé™¤ï¼‰
- **LOGIN**: ä½¿ç”¨è€…ç™»å…¥
- **LOGOUT**: ä½¿ç”¨è€…ç™»å‡º

### è¨˜éŒ„å…§å®¹
```json
{
  "old": {"client_id": "12345678", "company_name": "èˆŠåç¨±"},
  "new": {"client_id": "12345678", "company_name": "æ–°åç¨±"}
}
```

---

## è¡¨æ ¼é—œè¯åœ–

```
Clients (å®¢æˆ¶)
  â”‚
  â””â”€â”€â–º ClientServices (å®¢æˆ¶æœå‹™)
         â”œâ”€â”€â–º Services (æœå‹™é …ç›®)
         â”œâ”€â”€â–º ServiceFrequencyTypes (é€±æœŸé¡å‹)
         â””â”€â”€â–º ActiveTasks (è‡ªå‹•ç”Ÿæˆä»»å‹™)

TimeLogs (å·¥æ™‚è¨˜éŒ„)
  â”‚
  â””â”€â”€â–º CompensatoryLeaveTransactions (ç”¢ç”Ÿè£œä¼‘)
         â”‚
         â””â”€â”€â–º CompensatoryLeaveBalance (è£œä¼‘é¤˜é¡)
                â”‚
                â””â”€â”€â–º CompensatoryLeaveUsage (ä½¿ç”¨è£œä¼‘)

Users (å“¡å·¥) â”€â”€â–º AuditLogs (æ‰€æœ‰æ“ä½œè¨˜éŒ„)
```

---

## å¸¸ç”¨æŸ¥è©¢ç¯„ä¾‹

### æŸ¥è©¢å®¢æˆ¶çš„æœå‹™é…ç½®
```sql
SELECT 
  cs.*,
  c.company_name,
  s.service_name,
  ft.name as frequency_name
FROM ClientServices cs
JOIN Clients c ON cs.client_id = c.client_id
JOIN Services s ON cs.service_id = s.service_id
JOIN ServiceFrequencyTypes ft ON cs.frequency_id = ft.frequency_id
WHERE cs.client_id = ? AND cs.is_deleted = 0;
```

### æŸ¥è©¢å“¡å·¥è£œä¼‘é¤˜é¡
```sql
SELECT 
  u.name,
  clb.balance_hours,
  clb.updated_at
FROM Users u
LEFT JOIN CompensatoryLeaveBalance clb ON u.user_id = clb.user_id
WHERE u.user_id = ?;
```

### æŸ¥è©¢è£œä¼‘äº¤æ˜“è¨˜éŒ„
```sql
SELECT 
  t.*,
  CASE 
    WHEN t.transaction_type = 'earned' THEN '+' || t.hours
    WHEN t.transaction_type = 'used' THEN '-' || t.hours
  END as change
FROM CompensatoryLeaveTransactions t
WHERE t.user_id = ?
ORDER BY t.created_at DESC;
```

### æŸ¥è©¢æ“ä½œæ—¥èªŒ
```sql
SELECT 
  al.*,
  u.name as user_name
FROM AuditLogs al
JOIN Users u ON al.user_id = u.user_id
WHERE al.table_name = ? AND al.record_id = ?
ORDER BY al.created_at DESC;
```

---

## ğŸ”— ç›¸é—œæ–‡æª”

- **API è¦æ ¼ï¼š** [å®¢æˆ¶æœå‹™API](../APIè¦æ ¼/å®¢æˆ¶æœå‹™API.md)
- **åŠŸèƒ½æ¨¡å¡Šï¼š** [å®¢æˆ¶æœå‹™è¨­å®š](../åŠŸèƒ½æ¨¡å¡Š/15-å®¢æˆ¶æœå‹™è¨­å®š.md)
- **æŠ€è¡“è¦æ ¼ï¼š** [å®¢æˆ¶æœå‹™æŠ€è¡“è¦æ ¼](../æŠ€è¡“è¦æ ¼/å®¢æˆ¶æœå‹™/)

---

**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´10æœˆ27æ—¥  
**æœ¬æ–‡æª”åˆä½µäº† 6 å€‹è³‡æ–™è¡¨æ–‡æª”**

