# å·¥æ™‚ç®¡ç† - å®Œæ•´é–‹ç™¼è¦æ ¼

**çµ¦ AIï¼š** å¯¦ç¾å·¥æ™‚ç®¡ç†åŠŸèƒ½çš„å®Œæ•´æŠ€è¡“è¦æ ¼

---

## ğŸ’¾ è³‡æ–™è¡¨

### TimeLogs
```sql
CREATE TABLE TimeLogs (
  log_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  work_date TEXT NOT NULL,              -- YYYY-MM-DD
  client_id TEXT,                       -- å®¢æˆ¶ï¼ˆå·¥ä½œæ™‚ï¼‰
  service_id INTEGER,                   -- æœå‹™é …ç›®
  work_type_id INTEGER NOT NULL,        -- å·¥ä½œé¡å‹
  hours REAL NOT NULL,                  -- å¯¦éš›å·¥æ™‚
  weighted_hours REAL,                  -- åŠ æ¬Šå·¥æ™‚ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰
  leave_type_id INTEGER,                -- å‡åˆ¥ï¼ˆè«‹å‡æ™‚ï¼‰
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,                       -- â­ åˆªé™¤æ™‚é–“
  deleted_by INTEGER,                    -- â­ åˆªé™¤äººå“¡
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (client_id) REFERENCES Clients(client_id),
  FOREIGN KEY (service_id) REFERENCES Services(service_id),
  FOREIGN KEY (work_type_id) REFERENCES WorkTypes(work_type_id),
  FOREIGN KEY (leave_type_id) REFERENCES LeaveTypes(leave_type_id),
  FOREIGN KEY (deleted_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_timelogs_user_date ON TimeLogs(user_id, work_date);
CREATE INDEX idx_timelogs_client ON TimeLogs(client_id);
CREATE INDEX idx_timelogs_client_date ON TimeLogs(client_id, work_date);  -- â­ å®¢æˆ¶æˆæœ¬åˆ†æå°ˆç”¨
CREATE INDEX idx_timelogs_date ON TimeLogs(work_date);  -- â­ æ—¥æœŸç¯„åœæŸ¥è©¢å°ˆç”¨
```

**ç´¢å¼•ä½¿ç”¨èªªæ˜ï¼š**
```
idx_timelogs_user_date:
  ç”¨é€”ï¼šå“¡å·¥å€‹äººå·¥æ™‚æŸ¥è©¢
  æŸ¥è©¢ï¼šWHERE user_id = ? AND work_date BETWEEN ? AND ?
  
idx_timelogs_client:
  ç”¨é€”ï¼šå®¢æˆ¶å·¥æ™‚åˆ—è¡¨
  æŸ¥è©¢ï¼šWHERE client_id = ?
  
idx_timelogs_client_date: â­ æ–°å¢
  ç”¨é€”ï¼šå®¢æˆ¶æˆæœ¬åˆ†æï¼ˆæœ€å¸¸ç”¨ï¼‰
  æŸ¥è©¢ï¼šWHERE client_id = ? AND work_date BETWEEN ? AND ?
  æ•ˆèƒ½æå‡ï¼šç´„50-80%ï¼ˆé¿å…å…¨è¡¨æƒæï¼‰
  
idx_timelogs_date: â­ æ–°å¢
  ç”¨é€”ï¼šæœˆåº¦å ±è¡¨ã€æ—¥æœŸç¯„åœçµ±è¨ˆ
  æŸ¥è©¢ï¼šWHERE work_date BETWEEN ? AND ?
```

### WorkTypesï¼ˆå·¥ä½œé¡å‹ï¼‰
```sql
CREATE TABLE WorkTypes (
  work_type_id INTEGER PRIMARY KEY AUTOINCREMENT,
  type_name TEXT UNIQUE NOT NULL,
  rate_multiplier REAL NOT NULL,  -- è²»ç‡å€æ•¸
  is_overtime BOOLEAN DEFAULT 0,
  generates_comp_leave BOOLEAN DEFAULT 0,  -- æ˜¯å¦ç”¢ç”Ÿè£œä¼‘
  sort_order INTEGER DEFAULT 0
);

-- é è¨­è³‡æ–™ï¼ˆå…±11ç¨®å·¥ä½œé¡å‹ï¼‰
INSERT INTO WorkTypes VALUES
  (1, 'æ­£å¸¸å·¥æ™‚', 1.0, 0, 0, 0),
  (2, 'å¹³æ—¥åŠ ç­ï¼ˆå‰2å°æ™‚ï¼‰', 1.34, 1, 1, 1),
  (3, 'å¹³æ—¥åŠ ç­ï¼ˆå¾Œ2å°æ™‚ï¼‰', 1.67, 1, 1, 2),
  (4, 'ä¼‘æ¯æ—¥åŠ ç­ï¼ˆå‰2å°æ™‚ï¼‰', 1.34, 1, 1, 3),
  (5, 'ä¼‘æ¯æ—¥åŠ ç­ï¼ˆç¬¬3-8å°æ™‚ï¼‰', 1.67, 1, 1, 4),
  (6, 'ä¼‘æ¯æ—¥åŠ ç­ï¼ˆç¬¬9-12å°æ™‚ï¼‰', 2.67, 1, 1, 5),
  (7, 'åœ‹å®šå‡æ—¥åŠ ç­ï¼ˆ8å°æ™‚å…§ï¼‰', 2.0, 1, 1, 6),
  (8, 'åœ‹å®šå‡æ—¥åŠ ç­ï¼ˆç¬¬9-10å°æ™‚ï¼‰', 1.34, 1, 1, 7),
  (9, 'åœ‹å®šå‡æ—¥åŠ ç­ï¼ˆç¬¬11-12å°æ™‚ï¼‰', 1.67, 1, 1, 8),
  (10, 'ä¾‹å‡æ—¥åŠ ç­ï¼ˆ8å°æ™‚å…§ï¼‰', 2.0, 1, 1, 9),
  (11, 'ä¾‹å‡æ—¥åŠ ç­ï¼ˆç¬¬9-12å°æ™‚ï¼‰', 2.0, 1, 1, 10);
```


### CompensatoryLeaveï¼ˆè£œä¼‘é¤˜é¡ï¼‰
```sql
CREATE TABLE CompensatoryLeave (
  compe_leave_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  hours_earned REAL NOT NULL,           -- ç´¯ç©çš„è£œä¼‘æ™‚æ•¸
  hours_remaining REAL NOT NULL,        -- å‰©é¤˜è£œä¼‘æ™‚æ•¸
  earned_date TEXT NOT NULL,            -- ç´¯ç©æ—¥æœŸï¼ˆç”¨æ–¼ FIFOï¼‰
  expiry_date TEXT NOT NULL,            -- åˆ°æœŸæ—¥ï¼ˆç•¶æœˆæœ‰æ•ˆï¼Œæ¬¡æœˆ1æ—¥æ­¸0ï¼‰
  source_timelog_id INTEGER,            -- ä¾†æºå·¥æ™‚è¨˜éŒ„
  status TEXT DEFAULT 'active',         -- active, expired, used, converted
  converted_to_payment BOOLEAN DEFAULT 0,  -- æ˜¯å¦å·²è½‰åŠ ç­è²»
  conversion_date TEXT,                 -- è½‰æ›æ—¥æœŸ
  conversion_rate REAL,                 -- è½‰æ›æ™‚çš„è²»ç‡
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (source_timelog_id) REFERENCES TimeLogs(log_id)
);

CREATE INDEX idx_compe_leave_user ON CompensatoryLeave(user_id);
CREATE INDEX idx_compe_leave_status ON CompensatoryLeave(status);
CREATE INDEX idx_compe_leave_expiry ON CompensatoryLeave(expiry_date);
CREATE INDEX idx_compe_leave_earned_date ON CompensatoryLeave(earned_date);
```

### CompensatoryLeaveUsageï¼ˆè£œä¼‘ä½¿ç”¨è¨˜éŒ„ï¼‰
```sql
CREATE TABLE CompensatoryLeaveUsage (
  usage_id INTEGER PRIMARY KEY AUTOINCREMENT,
  compe_leave_id INTEGER NOT NULL,
  leave_application_id INTEGER,         -- é—œè¯è«‹å‡ç”³è«‹
  timelog_id INTEGER,                   -- é—œè¯å·¥æ™‚è¨˜éŒ„ï¼ˆè«‹å‡ï¼‰
  hours_used REAL NOT NULL,
  used_date TEXT NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (compe_leave_id) REFERENCES CompensatoryLeave(compe_leave_id),
  FOREIGN KEY (leave_application_id) REFERENCES LeaveApplications(leave_id),
  FOREIGN KEY (timelog_id) REFERENCES TimeLogs(log_id)
);

CREATE INDEX idx_compe_usage_leave ON CompensatoryLeaveUsage(compe_leave_id);
CREATE INDEX idx_compe_usage_date ON CompensatoryLeaveUsage(used_date);
```

---

## ğŸ”Œ API ç«¯é»

### 1. æŸ¥è©¢å·¥æ™‚è¨˜éŒ„
```
GET /api/v1/timelogs
Query: ?start_date=2025-11-01&end_date=2025-11-30&user_id=1
æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå“¡å·¥è‡ªå‹•éæ¿¾ï¼‰
```

### 2. æ–°å¢å·¥æ™‚
```
POST /api/v1/timelogs
æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆåªèƒ½æ–°å¢è‡ªå·±çš„ï¼‰
```

**è«‹æ±‚ Bodyï¼ˆå·¥ä½œï¼‰ï¼š**
```json
{
  "work_date": "2025-11-01",
  "client_id": "12345678",
  "service_id": 1,
  "work_type_id": 1,
  "hours": 8.5,
  "notes": "æ•´ç†å‚³ç¥¨"
}
```

**è«‹æ±‚ Bodyï¼ˆè«‹å‡ï¼‰ï¼š**
```json
{
  "work_date": "2025-11-02",
  "leave_type_id": 1,
  "hours": 8,
  "notes": "ç‰¹ä¼‘"
}
```

### 3. è¨ˆç®—åŠ æ¬Šå·¥æ™‚
```
POST /api/v1/weighted-hours/calculate
```

**è«‹æ±‚ï¼š**
```json
{
  "user_id": 1,
  "start_date": "2025-11-01",
  "end_date": "2025-11-30"
}

### 4. è£œä¼‘ç®¡ç† API
```
GET  /api/v1/compensatory-leave           æŸ¥è©¢è£œä¼‘é¤˜é¡
POST /api/v1/compensatory-leave/use      ä½¿ç”¨è£œä¼‘
POST /api/v1/compensatory-leave/convert  è½‰æ›ç‚ºåŠ ç­è²»
GET  /api/v1/compensatory-leave/history  æŸ¥è©¢ä½¿ç”¨æ­·å²
```

**æŸ¥è©¢è£œä¼‘é¤˜é¡ï¼š**
```json
GET /api/v1/compensatory-leave?user_id=1

// å›æ‡‰
{
  "success": true,
  "data": {
    "user_id": 1,
    "total_hours": 16.5,
    "details": [
      {
        "compe_leave_id": 1,
        "hours_remaining": 8.0,
        "earned_date": "2025-10-15",
        "expiry_date": "2025-10-31",
        "status": "active",
        "days_until_expiry": 3
      },
      {
        "compe_leave_id": 2,
        "hours_remaining": 8.5,
        "earned_date": "2025-10-20",
        "expiry_date": "2025-10-31",
        "status": "active",
        "days_until_expiry": 3
      }
    ],
    "expiring_soon": [
      {
        "compe_leave_id": 1,
        "hours_remaining": 8.0,
        "expiry_date": "2025-10-31"
      }
    ]
  }
}
```

**ä½¿ç”¨è£œä¼‘ï¼ˆFIFOï¼‰ï¼š**
```json
POST /api/v1/compensatory-leave/use
{
  "user_id": 1,
  "hours": 4.0,
  "use_date": "2025-10-28",
  "leave_application_id": 123
}

// å›æ‡‰
{
  "success": true,
  "data": {
    "used_compensatory_leaves": [
      {
        "compe_leave_id": 1,
        "hours_used": 4.0,
        "hours_remaining": 4.0
      }
    ],
    "total_hours_used": 4.0,
    "remaining_total": 12.5
  }
}
```

**è½‰æ›ç‚ºåŠ ç­è²»ï¼š**
```json
POST /api/v1/compensatory-leave/convert
{
  "compe_leave_ids": [1, 2],
  "conversion_rate": 1.34  // ç•¶å‰åŠ ç­è²»ç‡
}

// å›æ‡‰
{
  "success": true,
  "data": {
    "total_hours_converted": 16.5,
    "conversion_rate": 1.34,
    "payment_amount": 22.11,  // 16.5 * 1.34
    "converted_leaves": [
      { "compe_leave_id": 1, "hours": 8.0 },
      { "compe_leave_id": 2, "hours": 8.5 }
    ]
  }
}
```

**éŸ¿æ‡‰ï¼š**
```json
{
  "success": true,
  "data": {
    "total_hours": 160,
    "weighted_hours": 185.5,
    "breakdown": {
      "normal": 152,
      "overtime_weekday": 8
    }
  }
}
```

---

## ğŸ¨ å‰ç«¯çµ„ä»¶

### TimesheetPage.vueï¼ˆExcelé¢¨æ ¼ï¼‰
```vue
<template>
  <div class="timesheet-page">
    <h1>å·¥æ™‚è¡¨ - {{ currentMonth }}</h1>
    
    <!-- é€±é¸æ“‡å™¨ -->
    <div class="week-selector">
      <button @click="prevWeek">â†</button>
      <span>{{ weekRange }}</span>
      <button @click="nextWeek">â†’</button>
    </div>

    <!-- Excel é¢¨æ ¼è¡¨æ ¼ -->
    <table class="timesheet-grid">
      <thead>
        <tr>
          <th>æ—¥æœŸ</th>
          <th>å®¢æˆ¶</th>
          <th>æœå‹™</th>
          <th>å·¥æ™‚</th>
          <th>é¡å‹</th>
          <th>å‚™è¨»</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="day in weekDays" :key="day">
          <td>
            {{ day }}
            <!-- â­ è£œç­æ—¥æ¨™è¨˜ -->
            <span v-if="isMakeupWorkday(day)" class="makeup-badge" title="è£œç­æ—¥ï¼ˆæ­£å¸¸ä¸Šç­æ—¥ï¼‰">
              ğŸ“… è£œç­
            </span>
          </td>
          <td>
            <select v-model="logs[day].client_id">
              <option v-for="c in clients" :value="c.client_id">
                {{ c.company_name }}
              </option>
            </select>
          </td>
          <td>
            <select v-model="logs[day].service_id">
              <option v-for="s in services" :value="s.service_id">
                {{ s.service_name }}
              </option>
            </select>
          </td>
          <td>
            <input 
              v-model.number="logs[day].hours" 
              type="number"
              step="0.5"
              min="0"
              max="12"
              @blur="validateHours(day)"
            />
          </td>
          <td>
            <!-- â­ å·¥ä½œé¡å‹ï¼ˆè£œç­æ—¥æœƒè‡ªå‹•éæ¿¾é¸é …ï¼‰-->
            <select v-model="logs[day].work_type_id">
              <option 
                v-for="type in getAvailableWorkTypes(day)" 
                :key="type.id"
                :value="type.id"
              >
                {{ type.name }}
              </option>
            </select>
          </td>
          <td>
            <input v-model="logs[day].notes" />
          </td>
        </tr>
      </tbody>
    </table>

    <div class="summary">
      æœ¬é€±ç¸½å·¥æ™‚ï¼š{{ weekTotal }} å°æ™‚
      åŠ æ¬Šå·¥æ™‚ï¼š{{ weekWeighted }} å°æ™‚
    </div>

    <StyledButton @click="saveAll">å„²å­˜</StyledButton>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';
import { getClients, getServices, createTimeLog, getHolidays } from '@/api';

const logs = ref({});
const clients = ref([]);
const services = ref([]);
const holidays = ref([]);  // â­ åœ‹å®šå‡æ—¥+è£œç­æ—¥

const weekTotal = computed(() => {
  return Object.values(logs.value).reduce((sum, log) => sum + (log.hours || 0), 0);
});

onMounted(async () => {
  // â­ è¼‰å…¥æœ¬æœˆçš„åœ‹å®šå‡æ—¥å’Œè£œç­æ—¥
  holidays.value = await getHolidays({
    start_date: currentMonthStart,
    end_date: currentMonthEnd
  });
});

// â­ æª¢æŸ¥æ˜¯å¦ç‚ºè£œç­æ—¥
function isMakeupWorkday(date) {
  const holiday = holidays.value.find(h => h.holiday_date === date);
  return holiday?.is_makeup_workday || false;
}

// â­ å–å¾—å¯ç”¨çš„å·¥ä½œé¡å‹é¸é …ï¼ˆè£œç­æ—¥æœƒéæ¿¾ï¼‰
function getAvailableWorkTypes(date) {
  const allTypes = [
    { id: 1, name: 'æ­£å¸¸å·¥æ™‚' },
    { id: 2, name: 'å¹³æ—¥åŠ ç­ï¼ˆå‰2å°æ™‚ï¼‰' },
    { id: 3, name: 'å¹³æ—¥åŠ ç­ï¼ˆå¾Œ2å°æ™‚ï¼‰' },
    { id: 4, name: 'ä¼‘æ¯æ—¥åŠ ç­ï¼ˆå‰2å°æ™‚ï¼‰' },
    { id: 5, name: 'ä¼‘æ¯æ—¥åŠ ç­ï¼ˆç¬¬3-8å°æ™‚ï¼‰' },
    { id: 6, name: 'ä¼‘æ¯æ—¥åŠ ç­ï¼ˆç¬¬9-12å°æ™‚ï¼‰' },
    { id: 7, name: 'åœ‹å®šå‡æ—¥åŠ ç­ï¼ˆ8å°æ™‚å…§ï¼‰' },
    // ... å…¶ä»–é¡å‹
  ];
  
  if (isMakeupWorkday(date)) {
    // â­ è£œç­æ—¥ï¼šåªé¡¯ç¤ºæ­£å¸¸å·¥æ™‚å’Œå¹³æ—¥åŠ ç­
    return allTypes.filter(t => [1, 2, 3].includes(t.id));
  }
  
  return allTypes;  // ä¸€èˆ¬æ—¥æœŸï¼šé¡¯ç¤ºæ‰€æœ‰é¸é …
}

// â­ é©—è­‰å·¥æ™‚ï¼ˆå‰ç«¯ï¼‰
function validateHours(day) {
  const hours = logs.value[day]?.hours;
  
  if (!hours) return true;
  
  // æª¢æŸ¥æ˜¯å¦ç‚º0.5çš„å€æ•¸
  if (hours % 0.5 !== 0) {
    alert('å·¥æ™‚å¿…é ˆæ˜¯0.5çš„å€æ•¸ï¼ˆå¦‚ï¼š0.5ã€1.0ã€1.5ã€2.0...ï¼‰');
    logs.value[day].hours = Math.round(hours * 2) / 2;  // è‡ªå‹•ä¿®æ­£ç‚ºæœ€æ¥è¿‘çš„0.5å€æ•¸
    return false;
  }
  
  // æª¢æŸ¥ç¯„åœ
  if (hours < 0) {
    alert('å·¥æ™‚ä¸å¯ç‚ºè² æ•¸');
    logs.value[day].hours = 0;
    return false;
  }
  
  if (hours > 12) {
    alert('æ¯æ—¥å·¥æ™‚ä¸Šé™ç‚º12å°æ™‚ï¼ˆå‹åŸºæ³•è¦å®šï¼‰');
    logs.value[day].hours = 12;
    return false;
  }
  
  return true;
}

async function saveAll() {
  // é©—è­‰æ‰€æœ‰å·¥æ™‚
  for (const day in logs.value) {
    if (!validateHours(day)) {
      return;  // é©—è­‰å¤±æ•—ï¼Œåœæ­¢å„²å­˜
    }
  }
  
  // å„²å­˜é‚è¼¯...
}
</script>
```

---

## ğŸ”§ å¾Œç«¯å¯¦ç¾

### TimeLogService
```typescript
class TimeLogService {
  async getTimeLogs(filters, user) {
    // å“¡å·¥åªèƒ½çœ‹è‡ªå·±
    if (!user.is_admin) {
      filters.user_id = user.user_id;
    }
    
    return await this.repository.findAll(filters);
  }
  
  async createTimeLog(data, user) {
    // å“¡å·¥åªèƒ½æ–°å¢è‡ªå·±çš„
    if (!user.is_admin && data.user_id !== user.user_id) {
      throw new ForbiddenError('åªèƒ½æ–°å¢è‡ªå·±çš„å·¥æ™‚');
    }
    
    // é©—è­‰å·¥æ™‚ç¯„åœ
    if (data.hours < 0 || data.hours > 12) {
      throw new ValidationError('å·¥æ™‚å¿…é ˆåœ¨ 0-12 ä¹‹é–“');
    }
    
    // é©—è­‰å·¥æ™‚ç²¾åº¦ï¼ˆå¿…é ˆæ˜¯0.5çš„å€æ•¸ï¼‰
    if (data.hours % 0.5 !== 0) {
      throw new ValidationError('å·¥æ™‚å¿…é ˆæ˜¯0.5çš„å€æ•¸ï¼ˆå¦‚ï¼š0.5ã€1.0ã€1.5ã€2.0...ï¼‰');
    }
    
    // â­ æª¢æŸ¥æ˜¯å¦ç‚ºè£œç­æ—¥ï¼ˆé˜²æ­¢èª¤é¸ä¼‘æ¯æ—¥åŠ ç­ï¼‰
    const holiday = await this.db.prepare(`
      SELECT is_makeup_workday FROM Holidays WHERE holiday_date = ?
    `).bind(data.work_date).first();
    
    if (holiday?.is_makeup_workday) {
      // è£œç­æ—¥ä¸å¯é¸ã€Œä¼‘æ¯æ—¥åŠ ç­ã€é¡å‹ï¼ˆ4, 5, 6ï¼‰
      const isRestDayOvertimeType = [4, 5, 6].includes(data.work_type_id);
      
      if (isRestDayOvertimeType) {
        throw new ValidationError(
          'ä»Šå¤©æ˜¯è£œç­æ—¥ï¼ˆæ­£å¸¸ä¸Šç­æ—¥ï¼‰ï¼Œè«‹é¸æ“‡ã€Œæ­£å¸¸å·¥æ™‚ã€æˆ–ã€Œå¹³æ—¥åŠ ç­ã€é¡å‹',
          'WORK_TYPE_HOURS_MISMATCH'
        );
      }
    }
    
    // âš ï¸ åœ‹å®šå‡æ—¥/ä¾‹å‡æ—¥ã€Œ8å°æ™‚å…§ã€é¡å‹ï¼šæœ€å¤šåªèƒ½å¡«8å°æ™‚
    if ((data.work_type_id === 7 || data.work_type_id === 10) && data.hours > 8) {
      throw new ValidationError(
        'å·¥ä½œé¡å‹ã€Œåœ‹å®šå‡æ—¥8å°æ™‚å…§ã€æˆ–ã€Œä¾‹å‡æ—¥8å°æ™‚å…§ã€çš„å·¥æ™‚ä¸å¯è¶…é8å°æ™‚ï¼Œ' +
        'è¶…ééƒ¨åˆ†è«‹åˆ†åˆ¥é¸æ“‡ã€Œç¬¬9-10å°æ™‚ã€æˆ–ã€Œç¬¬11-12å°æ™‚ã€é¡å‹'
      );
    }
    
    // è¨ˆç®—åŠ æ¬Šå·¥æ™‚ï¼ˆâš ï¸ åœ‹å®šå‡æ—¥/ä¾‹å‡æ—¥ç‰¹æ®Šè™•ç†ï¼‰
    const workType = await this.getWorkType(data.work_type_id);
    
    // åœ‹å®šå‡æ—¥ï¼ˆwork_type_id = 7ï¼‰æˆ–ä¾‹å‡æ—¥ï¼ˆwork_type_id = 10ï¼‰8å°æ™‚å…§
    if (data.work_type_id === 7 || data.work_type_id === 10) {
      // âš ï¸ ç‰¹æ®Šï¼šåŠ æ¬Šå·¥æ™‚çµ±ä¸€ç‚º 8 å°æ™‚ï¼ˆä¸æ˜¯å¯¦éš›å·¥æ™‚ Ã— 2.0ï¼‰
      data.weighted_hours = 8.0;
    } else {
      // ä¸€èˆ¬æƒ…æ³ï¼šå¯¦éš›å·¥æ™‚ Ã— è²»ç‡å€æ•¸
      data.weighted_hours = data.hours * workType.rate_multiplier;
    }
    
    // å‰µå»º
    const log = await this.repository.create(data);
    
    // â­ è‡ªå‹•ç§»é™¤å·¥æ™‚ç¼ºå¡«æé†’
    await this.dismissMissingTimesheetNotification(user.user_id, data.work_date);
    
    // å¦‚æœæ˜¯åŠ ç­ï¼Œç”¢ç”Ÿè£œä¼‘
    if (data.work_type_id > 1) {
      // âš ï¸ åœ‹å®šå‡æ—¥/ä¾‹å‡æ—¥ 8å°æ™‚å…§ï¼šç”¢ç”Ÿ8å°æ™‚è£œä¼‘
      let compHours = data.hours;  // é è¨­ï¼šå¯¦éš›å·¥æ™‚
      
      if (data.work_type_id === 7 || data.work_type_id === 10) {
        compHours = 8.0;  // çµ±ä¸€ç”¢ç”Ÿ8å°æ™‚è£œä¼‘ï¼ˆå·²ç¶“é™åˆ¶ä¸æœƒè¶…é8å°æ™‚ï¼‰
      }
      
      await this.generateCompLeave(
        user.user_id, 
        compHours, 
        log.log_id,  // ä¾†æºå·¥æ™‚è¨˜éŒ„ID
        workType.rate_multiplier  // å„²å­˜åŸå§‹è²»ç‡
      );
    }
    
    return log;
  }
  
  /**
   * ç”¢ç”Ÿè£œä¼‘è¨˜éŒ„
   * âš ï¸ åœ‹å®šå‡æ—¥/ä¾‹å‡æ—¥8å°æ™‚å…§ï¼šçµ±ä¸€ç”¢ç”Ÿ8å°æ™‚è£œä¼‘
   */
  async generateCompLeave(
    userId: number, 
    hours: number, 
    sourceTimelogId: number,
    conversionRate: number
  ) {
    const earnedDate = new Date().toISOString().split('T')[0];
    const expiryDate = this.calculateExpiryDate(earnedDate);
    
    await this.db.prepare(`
      INSERT INTO CompensatoryLeave (
        user_id, hours_earned, hours_remaining, earned_date, 
        expiry_date, source_timelog_id, conversion_rate, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, 'active')
    `).bind(
      userId, 
      hours, 
      hours, 
      earnedDate, 
      expiryDate,
      sourceTimelogId,
      conversionRate  // âš ï¸ å„²å­˜åŸå§‹è²»ç‡ï¼Œé¿å…å¾ŒçºŒå›æº¯æŸ¥è©¢
    ).run();
  }
  
  /**
   * è‡ªå‹•ç§»é™¤å·¥æ™‚ç¼ºå¡«æé†’
   * âš ï¸ ç•¶å“¡å·¥å¡«å¯«å·¥æ™‚å¾Œï¼Œè‡ªå‹•ç§»é™¤è©²æ—¥æœŸçš„æé†’ï¼ˆå“¡å·¥+ç®¡ç†å“¡çš„æé†’éƒ½ç§»é™¤ï¼‰
   */
  async dismissMissingTimesheetNotification(userId: number, workDate: string) {
    // ç§»é™¤è©²å“¡å·¥è‡ªå·±çš„æé†’
    await this.db.prepare(`
      UPDATE Notifications
      SET is_deleted = 1
      WHERE user_id = ?
        AND type = 'missing_timesheet'
        AND related_date = ?
        AND auto_dismiss = 1
    `).bind(userId, workDate).run();
    
    // ç§»é™¤ç®¡ç†å“¡é—œæ–¼è©²å“¡å·¥çš„æé†’
    await this.db.prepare(`
      UPDATE Notifications
      SET is_deleted = 1
      WHERE type = 'missing_timesheet'
        AND related_date = ?
        AND related_user_id = ?
        AND auto_dismiss = 1
    `).bind(workDate, userId).run();
  }
  
  /**
   * è¨ˆç®—åœ‹å®šå‡æ—¥åŠ ç­è²»ï¼ˆç‰¹æ®Šè™•ç†ï¼‰
   * âš ï¸ é‡è¦ï¼š8å°æ™‚å…§çµ±ä¸€çµ¦ä»˜8å°æ™‚å·¥è³‡
   */
  async calculateHolidayOvertimePay(userId: number, hours: number, workTypeId: number): number {
    const user = await this.getUserSalary(userId);
    const hourlyBase = user.monthly_salary / 240;
    
    // åœ‹å®šå‡æ—¥åŠ ç­ï¼ˆ8å°æ™‚å…§ï¼‰- work_type_id = 7
    if (workTypeId === 7) {
      // ä¸è«–å¯¦éš›å·¥ä½œå¹¾å°æ™‚ï¼Œçµ±ä¸€çµ¦ä»˜ 8 å°æ™‚ Ã— 2.0 å€
      return hourlyBase * 8 * 2.0;
    }
    
    // åœ‹å®šå‡æ—¥åŠ ç­ï¼ˆç¬¬9-10å°æ™‚ï¼‰- work_type_id = 8
    if (workTypeId === 8) {
      return hourlyBase * hours * 1.34;
    }
    
    // åœ‹å®šå‡æ—¥åŠ ç­ï¼ˆç¬¬11-12å°æ™‚ï¼‰- work_type_id = 9
    if (workTypeId === 9) {
      return hourlyBase * hours * 1.67;
    }
    
    // å…¶ä»–é¡å‹ï¼šå¯¦éš›æ™‚æ•¸ Ã— è²»ç‡
    const rate = await this.getOvertimeRate(workTypeId);
    return hourlyBase * hours * rate.rate_multiplier;
  }
  
  async calculateWeightedHours(userId, startDate, endDate) {
    const logs = await this.repository.findByDateRange(userId, startDate, endDate);
    
    let totalHours = 0;
    let weightedHours = 0;
    
    for (const log of logs) {
      totalHours += log.hours;
      weightedHours += log.weighted_hours;
    }
    
    return { totalHours, weightedHours };
  }
}
```

---

## âœ… æ¥­å‹™è¦å‰‡

### å·¥æ™‚é™åˆ¶
- **æ¯å¤©æœ€å¤š 12 å°æ™‚**ï¼ˆå‹åŸºæ³•è¦å®šï¼‰â­
- å·¥æ™‚å¯ä»¥æ˜¯å°æ•¸ï¼ˆå¦‚ 3.5 å°æ™‚ï¼‰
- **æœ€å°å–®ä½ 0.5 å°æ™‚**ï¼ˆå¿…é ˆæ˜¯0.5çš„å€æ•¸ï¼‰â­
- å‰å¾Œç«¯éƒ½éœ€é©—è­‰ï¼ˆé˜²æ­¢è¼¸å…¥2.3ã€8.7ç­‰éæ³•å€¼ï¼‰

### è£œç­æ—¥ç‰¹æ®Šè¦å‰‡ â­
- **è£œç­æ—¥è¦–ç‚ºæ­£å¸¸ä¸Šç­æ—¥**ï¼ˆå¦‚ï¼šæ˜¥ç¯€å‰çš„é€±å…­è£œç­ï¼‰
- å¯å¡«å¯«ï¼šæ­£å¸¸å·¥æ™‚ã€å¹³æ—¥åŠ ç­
- ä¸å¯å¡«å¯«ï¼šä¼‘æ¯æ—¥åŠ ç­ï¼ˆæœƒè¢«ç³»çµ±æ‹’çµ•ï¼‰
- å‰ç«¯UIæœƒé¡¯ç¤ºã€ŒğŸ“… è£œç­æ—¥ã€æ¨™è¨˜
- ç¯„ä¾‹ï¼š
  ```
  2025-02-08ï¼ˆé€±å…­ï¼Œæ˜¥ç¯€è£œç­æ—¥ï¼‰ï¼š
  âœ… å¯é¸ï¼šæ­£å¸¸å·¥æ™‚ã€å¹³æ—¥åŠ ç­ï¼ˆå‰2hï¼‰ã€å¹³æ—¥åŠ ç­ï¼ˆå¾Œ2hï¼‰
  âŒ ä¸å¯é¸ï¼šä¼‘æ¯æ—¥åŠ ç­ï¼ˆå‰2hï¼‰ã€ä¼‘æ¯æ—¥åŠ ç­ï¼ˆ3-8hï¼‰
  ```

### å·¥ä½œé¡å‹è©³ç´°èªªæ˜ï¼ˆå…±11ç¨®ï¼‰

**1. æ­£å¸¸å·¥æ™‚ï¼ˆ1.0å€ï¼‰**
- èªªæ˜ï¼šä¸€èˆ¬ä¸Šç­æ™‚é–“ï¼ˆæ¯æ—¥8å°æ™‚å…§ï¼‰
- è²»ç‡ï¼š1.0 å€
- ç”¢ç”Ÿè£œä¼‘ï¼šâŒ ä¸ç”¢ç”Ÿ

**2. å¹³æ—¥åŠ ç­ï¼ˆå‰2å°æ™‚ï¼Œ1.34å€ï¼‰**
- èªªæ˜ï¼šå¹³æ—¥ç¬¬ 9-10 å°æ™‚çš„å»¶é•·å·¥æ™‚
- è²»ç‡ï¼š1.34 å€
- ç”¢ç”Ÿè£œä¼‘ï¼šâœ… ç”¢ç”Ÿè£œä¼‘ï¼ˆ1:1ï¼‰

**3. å¹³æ—¥åŠ ç­ï¼ˆå¾Œ2å°æ™‚ï¼Œ1.67å€ï¼‰**
- èªªæ˜ï¼šå¹³æ—¥ç¬¬ 11-12 å°æ™‚çš„å»¶é•·å·¥æ™‚
- è²»ç‡ï¼š1.67 å€
- ç”¢ç”Ÿè£œä¼‘ï¼šâœ… ç”¢ç”Ÿè£œä¼‘ï¼ˆ1:1ï¼‰

**4. ä¼‘æ¯æ—¥åŠ ç­ï¼ˆå‰2å°æ™‚ï¼Œ1.34å€ï¼‰**
- èªªæ˜ï¼šä¼‘æ¯æ—¥ï¼ˆé€šå¸¸é€±å…­ï¼‰å·¥ä½œçš„å‰2å°æ™‚
- è²»ç‡ï¼š1.34 å€
- ç”¢ç”Ÿè£œä¼‘ï¼šâœ… ç”¢ç”Ÿè£œä¼‘ï¼ˆ1:1ï¼‰

**5. ä¼‘æ¯æ—¥åŠ ç­ï¼ˆç¬¬3-8å°æ™‚ï¼Œ1.67å€ï¼‰**
- èªªæ˜ï¼šä¼‘æ¯æ—¥å·¥ä½œçš„ç¬¬3-8å°æ™‚
- è²»ç‡ï¼š1.67 å€
- ç”¢ç”Ÿè£œä¼‘ï¼šâœ… ç”¢ç”Ÿè£œä¼‘ï¼ˆ1:1ï¼‰

**6. ä¼‘æ¯æ—¥åŠ ç­ï¼ˆç¬¬9-12å°æ™‚ï¼Œ2.67å€ï¼‰**
- èªªæ˜ï¼šä¼‘æ¯æ—¥å·¥ä½œçš„ç¬¬9-12å°æ™‚
- è²»ç‡ï¼š2.67 å€
- ç”¢ç”Ÿè£œä¼‘ï¼šâœ… ç”¢ç”Ÿè£œä¼‘ï¼ˆ1:1ï¼‰

**7. åœ‹å®šå‡æ—¥åŠ ç­ï¼ˆ8å°æ™‚å…§ï¼Œé›™å€è–ªï¼‰**
- èªªæ˜ï¼šåœ‹å®šå‡æ—¥ï¼ˆå¦‚ç«¯åˆã€ä¸­ç§‹ã€åœ‹æ…¶ï¼‰å‡ºå‹¤å·¥ä½œ
- è²»ç‡ï¼šåŠ ç™¼ 1 æ—¥å·¥è³‡ï¼ˆé›™å€è–ªï¼Œå³ä½¿åªä¸Š 1 å°æ™‚ä¹Ÿç®— 1 æ—¥ï¼‰
- ç”¢ç”Ÿè£œä¼‘ï¼šâœ… ç”¢ç”Ÿè£œä¼‘ **8å°æ™‚**ï¼ˆçµ±ä¸€ç”¢ç”Ÿï¼Œä¸è«–å¯¦éš›å·¥ä½œå¹¾å°æ™‚ï¼‰â­
- åŠ æ¬Šå·¥æ™‚ï¼šçµ±ä¸€ç‚º **8å°æ™‚**ï¼ˆä¸æ˜¯å¯¦éš›å·¥æ™‚ Ã— 2.0ï¼‰â­
- âš ï¸ **ç‰¹æ®Šè¨ˆç®—ï¼š** 8å°æ™‚å…§çµ±ä¸€çµ¦ä»˜8å°æ™‚å·¥è³‡ã€8å°æ™‚è£œä¼‘ã€8å°æ™‚åŠ æ¬Šå·¥æ™‚

**8. åœ‹å®šå‡æ—¥åŠ ç­ï¼ˆç¬¬9-10å°æ™‚ï¼Œ1.34å€ï¼‰**
- èªªæ˜ï¼šåœ‹å®šå‡æ—¥å·¥ä½œè¶…é8å°æ™‚çš„ç¬¬9-10å°æ™‚
- è²»ç‡ï¼š1.34 å€
- ç”¢ç”Ÿè£œä¼‘ï¼šâœ… ç”¢ç”Ÿè£œä¼‘ï¼ˆ1:1ï¼‰

**9. åœ‹å®šå‡æ—¥åŠ ç­ï¼ˆç¬¬11-12å°æ™‚ï¼Œ1.67å€ï¼‰**
- èªªæ˜ï¼šåœ‹å®šå‡æ—¥å·¥ä½œçš„ç¬¬11-12å°æ™‚
- è²»ç‡ï¼š1.67 å€
- ç”¢ç”Ÿè£œä¼‘ï¼šâœ… ç”¢ç”Ÿè£œä¼‘ï¼ˆ1:1ï¼‰

**10. ä¾‹å‡æ—¥åŠ ç­ï¼ˆ8å°æ™‚å…§ï¼Œé›™å€è–ª+å¼·åˆ¶è£œä¼‘ï¼‰**
- èªªæ˜ï¼šä¾‹å‡æ—¥ï¼ˆé€šå¸¸é€±æ—¥ï¼‰å‡ºå‹¤å·¥ä½œ
- è²»ç‡ï¼šåŠ ç™¼ 1 æ—¥å·¥è³‡ + å¼·åˆ¶è£œä¼‘ 1 å¤©
- ç”¢ç”Ÿè£œä¼‘ï¼šâœ… å¼·åˆ¶ç”¢ç”Ÿè£œä¼‘ **8å°æ™‚**ï¼ˆçµ±ä¸€ç”¢ç”Ÿï¼Œä¸è«–å¯¦éš›å·¥ä½œå¹¾å°æ™‚ï¼‰â­
- åŠ æ¬Šå·¥æ™‚ï¼šçµ±ä¸€ç‚º **8å°æ™‚**ï¼ˆä¸æ˜¯å¯¦éš›å·¥æ™‚ Ã— 2.0ï¼‰â­
- âš ï¸ **åŸå‰‡ä¸Šç¦æ­¢**ï¼Œåƒ…é™å¤©ç½ã€äº‹è®Šæˆ–çªç™¼äº‹ä»¶
- âš ï¸ **ç‰¹æ®Šè¨ˆç®—ï¼š** èˆ‡åœ‹å®šå‡æ—¥ç›¸åŒï¼Œçµ±ä¸€8å°æ™‚å·¥è³‡ã€8å°æ™‚è£œä¼‘ã€8å°æ™‚åŠ æ¬Šå·¥æ™‚

**11. ä¾‹å‡æ—¥åŠ ç­ï¼ˆç¬¬9-12å°æ™‚ï¼Œ2.0å€ï¼‰**
- èªªæ˜ï¼šä¾‹å‡æ—¥å·¥ä½œè¶…é8å°æ™‚çš„ç¬¬9-12å°æ™‚
- è²»ç‡ï¼š2.0 å€
- ç”¢ç”Ÿè£œä¼‘ï¼šâœ… ç”¢ç”Ÿè£œä¼‘ï¼ˆ1:1ï¼‰
- âš ï¸ **åŸå‰‡ä¸Šç¦æ­¢**

### åŠ æ¬Šå·¥æ™‚è¨ˆç®—
```
ä¸€èˆ¬æƒ…æ³ï¼š
  åŠ æ¬Šå·¥æ™‚ = å¯¦éš›å·¥æ™‚ Ã— è²»ç‡å€æ•¸

  ç¯„ä¾‹ï¼š
  æ­£å¸¸å·¥æ™‚ 8å°æ™‚ Ã— 1.0 = 8å°æ™‚
  å¹³æ—¥åŠ ç­ 2å°æ™‚ Ã— 1.34 = 2.68å°æ™‚
  ä¼‘æ¯æ—¥åŠ ç­ 4å°æ™‚ï¼ˆå‰2hÃ—1.34+å¾Œ2hÃ—1.67ï¼‰= 6.02å°æ™‚

åœ‹å®šå‡æ—¥/ä¾‹å‡æ—¥ï¼ˆ8å°æ™‚å…§ï¼‰ï¼šâš ï¸ ç‰¹æ®Šè¦å‰‡
  åŠ æ¬Šå·¥æ™‚ = 8å°æ™‚ï¼ˆçµ±ä¸€è¨ˆç®—ï¼Œä¸è«–å¯¦éš›å·¥ä½œå¹¾å°æ™‚ï¼‰

  ç¯„ä¾‹ï¼š
  åœ‹å®šå‡æ—¥åŠ ç­ 3å°æ™‚ â†’ åŠ æ¬Šå·¥æ™‚ 8å°æ™‚ï¼ˆä¸æ˜¯6å°æ™‚ï¼‰â­
  åœ‹å®šå‡æ—¥åŠ ç­ 0.5å°æ™‚ â†’ åŠ æ¬Šå·¥æ™‚ 8å°æ™‚ â­
  ä¾‹å‡æ—¥åŠ ç­ 5å°æ™‚ â†’ åŠ æ¬Šå·¥æ™‚ 8å°æ™‚ â­

åœ‹å®šå‡æ—¥/ä¾‹å‡æ—¥ï¼ˆè¶…é8å°æ™‚ï¼‰ï¼š
  åŠ æ¬Šå·¥æ™‚ = 8 + è¶…ééƒ¨åˆ†çš„åŠ æ¬Šè¨ˆç®—
  
  ç¯„ä¾‹ï¼š
  åœ‹å®šå‡æ—¥åŠ ç­ 10å°æ™‚ 
  = 8å°æ™‚ï¼ˆå‰8hçµ±ä¸€ï¼‰+ 2 Ã— 1.34ï¼ˆç¬¬9-10hï¼‰
  = 8 + 2.68 = 10.68 åŠ æ¬Šå·¥æ™‚

å®Œæ•´ç¯„ä¾‹ï¼š
  æ­£å¸¸å·¥æ™‚ 8å°æ™‚ Ã— 1.0 = 8å°æ™‚
  å¹³æ—¥åŠ ç­ 2å°æ™‚ Ã— 1.34 = 2.68å°æ™‚
  åœ‹å®šå‡æ—¥åŠ ç­ 3å°æ™‚ = 8å°æ™‚ï¼ˆç‰¹æ®Šè¦å‰‡ï¼‰â­
  ç¸½è¨ˆï¼š8 + 2.68 + 8 = 18.68 åŠ æ¬Šå·¥æ™‚
```

### è£œä¼‘ç”¢ç”Ÿï¼ˆâš ï¸ é‡è¦ä¿®æ­£ï¼šåœ‹å®šå‡æ—¥/ä¾‹å‡æ—¥ç‰¹æ®Šè¦å‰‡ï¼‰
```
ä¸€èˆ¬åŠ ç­ï¼ˆå¹³æ—¥ã€ä¼‘æ¯æ—¥ï¼‰ï¼š
  è£œä¼‘ç”¢ç”Ÿ = å¯¦éš›åŠ ç­æ™‚æ•¸ Ã— 1ï¼ˆ1:1å°æ‡‰ï¼‰
  
  ç¯„ä¾‹ï¼š
  å¹³æ—¥åŠ ç­ 2å°æ™‚ â†’ ç”¢ç”Ÿè£œä¼‘ 2å°æ™‚
  ä¼‘æ¯æ—¥åŠ ç­ 4å°æ™‚ â†’ ç”¢ç”Ÿè£œä¼‘ 4å°æ™‚

åœ‹å®šå‡æ—¥/ä¾‹å‡æ—¥ï¼ˆ8å°æ™‚å…§ï¼‰ï¼šâš ï¸ ç‰¹æ®Šè¦å‰‡
  è£œä¼‘ç”¢ç”Ÿ = 8å°æ™‚ï¼ˆçµ±ä¸€ç”¢ç”Ÿï¼Œä¸è«–å¯¦éš›å·¥ä½œå¹¾å°æ™‚ï¼‰
  
  ç¯„ä¾‹ï¼š
  åœ‹å®šå‡æ—¥åŠ ç­ 3å°æ™‚ â†’ ç”¢ç”Ÿè£œä¼‘ 8å°æ™‚ï¼ˆä¸æ˜¯3å°æ™‚ï¼‰â­
  åœ‹å®šå‡æ—¥åŠ ç­ 0.5å°æ™‚ â†’ ç”¢ç”Ÿè£œä¼‘ 8å°æ™‚ â­
  ä¾‹å‡æ—¥åŠ ç­ 5å°æ™‚ â†’ ç”¢ç”Ÿè£œä¼‘ 8å°æ™‚ â­

åœ‹å®šå‡æ—¥/ä¾‹å‡æ—¥ï¼ˆè¶…é8å°æ™‚ï¼‰ï¼š
  è£œä¼‘ç”¢ç”Ÿ = å¯¦éš›åŠ ç­æ™‚æ•¸ï¼ˆæ¢å¾©1:1å°æ‡‰ï¼‰
  
  ç¯„ä¾‹ï¼š
  åœ‹å®šå‡æ—¥åŠ ç­ 10å°æ™‚ â†’ ç”¢ç”Ÿè£œä¼‘ 10å°æ™‚
  ï¼ˆç¬¬9-10å°æ™‚æŒ‰ä¸€èˆ¬è¦å‰‡ï¼‰

âš ï¸ é—œéµåŸå‰‡ï¼š
- åœ‹å®šå‡æ—¥/ä¾‹å‡æ—¥ã€Œ8å°æ™‚å…§ã€ï¼šåŠ ç­è²»ã€è£œä¼‘ã€åŠ æ¬Šå·¥æ™‚éƒ½çµ±ä¸€æŒ‰8å°æ™‚
- é€™ç¢ºä¿äº†ã€Œè£œä¼‘ = åŠ ç­è²»ã€çš„åƒ¹å€¼å°ç­‰ï¼ˆéƒ½æ˜¯8å°æ™‚å·¥è³‡ï¼‰
```

### è£œä¼‘ç®¡ç†è¦å‰‡ï¼ˆé‡è¦ï¼ï¼‰

#### 1. è£œä¼‘æœ‰æ•ˆæœŸï¼šç•¶æœˆæœ‰æ•ˆï¼Œæ¬¡æœˆ1æ—¥æ­¸0ï¼ˆå¯è¨­å®šï¼‰

```typescript
/**
 * è£œä¼‘ç”¢ç”Ÿæ™‚è‡ªå‹•è¨ˆç®—åˆ°æœŸæ—¥
 * âš ï¸ å¾ Settings è¡¨è®€å–è¦å‰‡ï¼ˆå¯ç”±ç®¡ç†å“¡èª¿æ•´ï¼‰
 */
async function calculateExpiryDate(earnedDate: string): Promise<string> {
  const date = new Date(earnedDate);
  
  // è®€å–è£œä¼‘æœ‰æ•ˆæœŸè¦å‰‡
  const rule = await db.prepare(`
    SELECT setting_value FROM Settings WHERE setting_key = 'comp_leave_expiry_rule'
  `).first();
  
  const expiryRule = rule?.setting_value || 'current_month';  // é è¨­ï¼šç•¶æœˆæœ‰æ•ˆ
  
  let expiryDate: Date;
  
  switch (expiryRule) {
    case 'current_month':  // ç•¶æœˆæœ‰æ•ˆï¼ˆé è¨­ï¼‰
      expiryDate = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      break;
    
    case 'next_month':  // æ¬¡æœˆæœ‰æ•ˆ
      expiryDate = new Date(date.getFullYear(), date.getMonth() + 2, 0);
      break;
    
    case '3_months':  // 3å€‹æœˆæœ‰æ•ˆ
      expiryDate = new Date(date.getFullYear(), date.getMonth() + 3, 0);
      break;
    
    case '6_months':  // åŠå¹´æœ‰æ•ˆ
      expiryDate = new Date(date.getFullYear(), date.getMonth() + 6, 0);
      break;
    
    default:
      expiryDate = new Date(date.getFullYear(), date.getMonth() + 1, 0);
  }
  
  return expiryDate.toISOString().split('T')[0];
}

/**
 * ç¯„ä¾‹ï¼ˆç•¶ expiryRule = 'current_month'ï¼‰ï¼š
 * 2025-10-15 ç´¯ç©çš„è£œä¼‘ â†’ 2025-10-31 åˆ°æœŸï¼ˆç•¶æœˆåº•ï¼‰
 * 2025-10-31 ç´¯ç©çš„è£œä¼‘ â†’ 2025-10-31 åˆ°æœŸï¼ˆç•¶æœˆåº•ï¼‰
 * 2025-11-01 ç´¯ç©çš„è£œä¼‘ â†’ 2025-11-30 åˆ°æœŸï¼ˆç•¶æœˆåº•ï¼‰
 * 
 * ç¯„ä¾‹ï¼ˆç•¶ expiryRule = 'next_month'ï¼‰ï¼š
 * 2025-10-15 ç´¯ç©çš„è£œä¼‘ â†’ 2025-11-30 åˆ°æœŸï¼ˆæ¬¡æœˆåº•ï¼‰
 * 2025-11-01 ç´¯ç©çš„è£œä¼‘ â†’ 2025-12-31 åˆ°æœŸï¼ˆæ¬¡æœˆåº•ï¼‰
 */
```

#### 2. åˆ°æœŸè™•ç†ï¼šç•¶æœˆæœ‰æ•ˆï¼Œæ¬¡æœˆ1æ—¥è‡ªå‹•è½‰æ›ç‚ºåŠ ç­è²»
```typescript
// æ¯æœˆ 1 æ—¥ 00:00 åŸ·è¡Œï¼ˆCron Jobï¼‰
async function monthlyCompensatoryLeaveExpiration() {
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toISOString().split('T')[0];
  
  // æŸ¥è©¢æ˜¨å¤©ï¼ˆä¸Šæœˆæœ€å¾Œä¸€å¤©ï¼‰åˆ°æœŸçš„è£œä¼‘
  const expiredLeaves = await db.prepare(`
    SELECT * FROM CompensatoryLeave
    WHERE expiry_date = ?
      AND status = 'active'
      AND hours_remaining > 0
  `).bind(yesterdayStr).all();
  
  for (const leave of expiredLeaves.results) {
    // ç²å–ç•¶å‰è²»ç‡
    const rate = await getCurrentOvertimeRate(leave.work_type_id);
    
    // è½‰æ›ç‚ºåŠ ç­è²»
    await db.prepare(`
      UPDATE CompensatoryLeave
      SET status = 'converted',
          converted_to_payment = 1,
          conversion_date = datetime('now'),
          conversion_rate = ?
      WHERE compe_leave_id = ?
    `).bind(rate.rate_multiplier, leave.compe_leave_id).run();
    
    // è¨˜éŒ„åˆ°è–ªè³‡ç³»çµ±ï¼ˆæˆ–ç”Ÿæˆå ±è¡¨ï¼‰
    await recordOvertimePayment({
      user_id: leave.user_id,
      hours: leave.hours_remaining,
      rate: rate.rate_multiplier,
      amount: leave.hours_remaining * rate.rate_multiplier,
      source: 'expired_compensatory_leave',
      compe_leave_id: leave.compe_leave_id
    });
    
    // é€šçŸ¥å“¡å·¥
    await sendNotification({
      user_id: leave.user_id,
      type: 'comp_leave_converted',
      message: `æ‚¨åœ¨ ${leave.earned_date} ç´¯ç©çš„ ${leave.hours_remaining} å°æ™‚è£œä¼‘å·²åˆ°æœŸï¼Œå·²è‡ªå‹•è½‰æ›ç‚ºåŠ ç­è²»ï¼ˆè²»ç‡ ${rate.rate_multiplier}ï¼‰`
    });
  }
  
  console.log(`å·²è™•ç† ${expiredLeaves.results.length} ç­†éæœŸè£œä¼‘`);
}
```

#### 3. FIFOï¼ˆå…ˆé€²å…ˆå‡ºï¼‰ä½¿ç”¨è¦å‰‡
```typescript
// ä½¿ç”¨è£œä¼‘æ™‚ï¼Œè‡ªå‹•æŒ‰ç´¯ç©æ—¥æœŸæ’åºä½¿ç”¨
class CompensatoryLeaveService {
  async useCompensatoryLeave(userId: number, hoursToUse: number, useDate: string, leaveApplicationId?: number) {
    // 1. æŸ¥è©¢å¯ç”¨è£œä¼‘ï¼ˆæŒ‰ç´¯ç©æ—¥æœŸæ’åº - FIFOï¼‰
    const availableLeaves = await this.db.prepare(`
      SELECT * FROM CompensatoryLeave
      WHERE user_id = ?
        AND status = 'active'
        AND hours_remaining > 0
        AND expiry_date >= date('now')
      ORDER BY earned_date ASC
    `).bind(userId).all();
    
    if (availableLeaves.results.length === 0) {
      throw new ValidationError('æ²’æœ‰å¯ç”¨çš„è£œä¼‘');
    }
    
    // 2. è¨ˆç®—ç¸½å¯ç”¨æ™‚æ•¸
    const totalAvailable = availableLeaves.results.reduce(
      (sum, leave) => sum + leave.hours_remaining, 
      0
    );
    
    if (totalAvailable < hoursToUse) {
      throw new ValidationError(
        `è£œä¼‘æ™‚æ•¸ä¸è¶³ã€‚å¯ç”¨ï¼š${totalAvailable} å°æ™‚ï¼Œéœ€æ±‚ï¼š${hoursToUse} å°æ™‚`
      );
    }
    
    // 3. æŒ‰ FIFO é †åºæ‰£é™¤
    let remainingToUse = hoursToUse;
    const usedLeaves = [];
    
    for (const leave of availableLeaves.results) {
      if (remainingToUse <= 0) break;
      
      const hoursToUseFromThis = Math.min(leave.hours_remaining, remainingToUse);
      
      // æ›´æ–°è£œä¼‘é¤˜é¡
      await this.db.prepare(`
        UPDATE CompensatoryLeave
        SET hours_remaining = hours_remaining - ?,
            status = CASE 
              WHEN hours_remaining - ? <= 0 THEN 'used'
              ELSE 'active'
            END
        WHERE compe_leave_id = ?
      `).bind(hoursToUseFromThis, hoursToUseFromThis, leave.compe_leave_id).run();
      
      // è¨˜éŒ„ä½¿ç”¨æ­·å²
      await this.db.prepare(`
        INSERT INTO CompensatoryLeaveUsage (
          compe_leave_id,
          leave_application_id,
          hours_used,
          used_date
        ) VALUES (?, ?, ?, ?)
      `).bind(
        leave.compe_leave_id,
        leaveApplicationId || null,
        hoursToUseFromThis,
        useDate
      ).run();
      
      usedLeaves.push({
        compe_leave_id: leave.compe_leave_id,
        hours_used: hoursToUseFromThis,
        hours_remaining: leave.hours_remaining - hoursToUseFromThis
      });
      
      remainingToUse -= hoursToUseFromThis;
    }
    
    return {
      used_compensatory_leaves: usedLeaves,
      total_hours_used: hoursToUse,
      remaining_total: totalAvailable - hoursToUse
    };
  }
}
```

#### 4. è£œä¼‘ä½¿ç”¨è¿½è¸ª
```typescript
// æŸ¥è©¢è£œä¼‘ä½¿ç”¨æ­·å²
async function getCompensatoryLeaveHistory(userId: number, startDate: string, endDate: string) {
  const history = await db.prepare(`
    SELECT 
      cl.compe_leave_id,
      cl.hours_earned,
      cl.earned_date,
      cl.expiry_date,
      cl.status,
      clu.usage_id,
      clu.hours_used,
      clu.used_date,
      la.leave_id,
      la.leave_type_id,
      lt.type_name as leave_type_name
    FROM CompensatoryLeave cl
    LEFT JOIN CompensatoryLeaveUsage clu ON cl.compe_leave_id = clu.compe_leave_id
    LEFT JOIN LeaveApplications la ON clu.leave_application_id = la.leave_id
    LEFT JOIN LeaveTypes lt ON la.leave_type_id = lt.leave_type_id
    WHERE cl.user_id = ?
      AND cl.earned_date BETWEEN ? AND ?
    ORDER BY cl.earned_date DESC, clu.used_date DESC
  `).bind(userId, startDate, endDate).all();
  
  return history.results;
}
```

#### 5. å·¥æ™‚å¡«å¯«æé†’ï¼ˆæ¯å¤©08:30åŸ·è¡Œï¼‰
```typescript
/**
 * Cron Job: æ¯å¤© 08:30 åŸ·è¡Œï¼ˆé€±ä¸€åˆ°é€±äº”ï¼‰
 * é…ç½®ï¼šcrons = ["30 8 * * 1-5"]
 * 
 * åŠŸèƒ½ï¼šæª¢æŸ¥å“¡å·¥æ˜¨å¤©æ˜¯å¦æœ‰å¡«å·¥æ™‚
 * é€šçŸ¥ï¼šå“¡å·¥æœ¬äºº + ç®¡ç†å“¡
 * æœŸé™ï¼šç›´åˆ°å“¡å·¥è£œå¡«ç‚ºæ­¢
 */
async function checkMissingTimesheets(db: D1Database) {
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toISOString().split('T')[0];
  const dayOfWeek = yesterday.getDay();
  
  // æ’é™¤é€±æœ«ï¼ˆ0=é€±æ—¥, 6=é€±å…­ï¼‰
  if (dayOfWeek === 0 || dayOfWeek === 6) {
    console.log('é€±æœ«ï¼Œè·³éå·¥æ™‚æª¢æŸ¥');
    return;
  }
  
  // æª¢æŸ¥æ˜¯å¦ç‚ºåœ‹å®šå‡æ—¥
  const isHoliday = await db.prepare(`
    SELECT * FROM Holidays WHERE holiday_date = ?
  `).bind(yesterdayStr).first();
  
  if (isHoliday) {
    console.log(`${yesterdayStr} ç‚ºåœ‹å®šå‡æ—¥ï¼Œè·³éå·¥æ™‚æª¢æŸ¥`);
    return;
  }
  
  // æŸ¥è©¢æ‰€æœ‰å“¡å·¥
  const users = await db.prepare(`
    SELECT user_id, name FROM Users WHERE is_deleted = 0
  `).all();
  
  const missingUsers = [];
  
  for (const user of users.results) {
    // æª¢æŸ¥æ˜¯å¦æœ‰å·¥æ™‚è¨˜éŒ„
    const timelog = await db.prepare(`
      SELECT * FROM TimeLogs
      WHERE user_id = ? AND work_date = ? AND is_deleted = 0
    `).bind(user.user_id, yesterdayStr).first();
    
    // æª¢æŸ¥æ˜¯å¦æœ‰è«‹å‡è¨˜éŒ„
    const leave = await db.prepare(`
      SELECT * FROM LeaveApplications
      WHERE user_id = ?
        AND start_date <= ?
        AND end_date >= ?
    `).bind(user.user_id, yesterdayStr, yesterdayStr).first();
    
    // å¦‚æœæ²’å·¥æ™‚ä¹Ÿæ²’è«‹å‡ â†’ éœ€è¦æé†’
    if (!timelog && !leave) {
      // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æé†’ï¼ˆé¿å…é‡è¤‡ï¼‰
      const existingNotif = await db.prepare(`
        SELECT * FROM Notifications
        WHERE user_id = ?
          AND type = 'missing_timesheet'
          AND related_date = ?
          AND dismissed_at IS NULL
      `).bind(user.user_id, yesterdayStr).first();
      
      if (!existingNotif) {
        // å‰µå»ºæé†’çµ¦å“¡å·¥æœ¬äºº
        await db.prepare(`
          INSERT INTO Notifications (
            user_id, type, message, related_date, action_url, auto_dismiss
          ) VALUES (?, 'missing_timesheet', ?, ?, ?, 0)
        `).bind(
          user.user_id,
          `æé†’ï¼š${yesterdayStr} å·¥æ™‚å°šæœªå¡«å¯«`,
          yesterdayStr,
          `/timesheets/new?date=${yesterdayStr}`
        ).run();
        
        missingUsers.push({ user_id: user.user_id, name: user.name });
      }
    }
  }
  
  // å¦‚æœæœ‰å“¡å·¥æœªå¡«ï¼Œé€šçŸ¥æ‰€æœ‰ç®¡ç†å“¡
  if (missingUsers.length > 0) {
    const admins = await db.prepare(`
      SELECT user_id FROM Users WHERE is_admin = 1 AND is_deleted = 0
    `).all();
    
    const userNames = missingUsers.map(u => u.name).join('ã€');
    
    for (const admin of admins.results) {
      // æª¢æŸ¥æ˜¯å¦å·²æœ‰æ­¤æ—¥æœŸçš„å½™ç¸½æé†’
      const existingAdminNotif = await db.prepare(`
        SELECT * FROM Notifications
        WHERE user_id = ?
          AND type = 'admin_missing_timesheet_summary'
          AND related_date = ?
          AND dismissed_at IS NULL
      `).bind(admin.user_id, yesterdayStr).first();
      
      if (!existingAdminNotif) {
        await db.prepare(`
          INSERT INTO Notifications (
            user_id, type, message, related_date, action_url, auto_dismiss
          ) VALUES (?, 'admin_missing_timesheet_summary', ?, ?, ?, 0)
        `).bind(
          admin.user_id,
          `${missingUsers.length}ä½å“¡å·¥å°šæœªå¡«å¯«${yesterdayStr}å·¥æ™‚ï¼š${userNames}`,
          yesterdayStr,
          `/admin/timesheets?date=${yesterdayStr}`
        ).run();
      }
    }
  }
  
  console.log(`å·¥æ™‚æª¢æŸ¥å®Œæˆï¼š${missingUsers.length} ä½å“¡å·¥æœªå¡«å¯« ${yesterdayStr} å·¥æ™‚`);
}

/**
 * è‡ªå‹•æ¶ˆé™¤é€šçŸ¥ï¼ˆç•¶å“¡å·¥è£œå¡«å·¥æ™‚å¾Œï¼‰
 * 
 * è§¸ç™¼æ™‚æ©Ÿï¼šå“¡å·¥æ–°å¢å·¥æ™‚è¨˜éŒ„æ™‚
 */
async function dismissTimesheetNotification(userId: number, workDate: string) {
  await db.prepare(`
    UPDATE Notifications
    SET dismissed_at = datetime('now')
    WHERE user_id = ?
      AND type = 'missing_timesheet'
      AND related_date = ?
      AND dismissed_at IS NULL
  `).bind(userId, workDate).run();
  
  // åŒæ™‚æ›´æ–°ç®¡ç†å“¡çš„å½™ç¸½æé†’ï¼ˆé‡æ–°è¨ˆç®—ï¼‰
  await updateAdminTimesheetSummary(workDate);
}
```

#### 6. è£œä¼‘åˆ°æœŸæé†’
```typescript
// æ¯å¤©åŸ·è¡Œï¼Œæé†’å³å°‡åˆ°æœŸçš„è£œä¼‘ï¼ˆæœˆåº•å‰5å¤©ï¼‰
async function sendCompLeaveExpiryReminders() {
  const fiveDaysLater = new Date();
  fiveDaysLater.setDate(fiveDaysLater.getDate() + 5);
  const fiveDaysLaterStr = fiveDaysLater.toISOString().split('T')[0];
  
  const expiringLeaves = await db.prepare(`
    SELECT 
      cl.*,
      u.name
    FROM CompensatoryLeave cl
    JOIN Users u ON cl.user_id = u.user_id
    WHERE cl.expiry_date <= ?
      AND cl.status = 'active'
      AND cl.hours_remaining > 0
  `).bind(fiveDaysLaterStr).all();
  
  for (const leave of expiringLeaves.results) {
    // æª¢æŸ¥æ˜¯å¦å·²æœ‰æé†’
    const existingNotif = await db.prepare(`
      SELECT * FROM Notifications
      WHERE user_id = ?
        AND type = 'comp_leave_expiring'
        AND related_date = ?
        AND dismissed_at IS NULL
    `).bind(leave.user_id, leave.expiry_date).first();
    
    if (!existingNotif) {
      await db.prepare(`
        INSERT INTO Notifications (
          user_id, type, message, related_date, action_url, auto_dismiss
        ) VALUES (?, 'comp_leave_expiring', ?, ?, ?, 1)
      `).bind(
        leave.user_id,
        `æ‚¨æœ‰ ${leave.hours_remaining} å°æ™‚è£œä¼‘å°‡æ–¼ ${leave.expiry_date} åˆ°æœŸï¼Œè«‹å„˜å¿«ä½¿ç”¨`,
        leave.expiry_date,
        `/leaves/apply?type=compensatory`,
        1  // åˆ°æœŸå¾Œå¯è‡ªå‹•æ¶ˆé™¤
      ).run();
    }
  }
}
```

### è«‹å‡è™•ç†
```
åœ¨å·¥æ™‚è¡¨å¡«å¯«è«‹å‡ï¼š
1. client_id = NULL
2. leave_type_id = é¸æ“‡çš„å‡åˆ¥
3. hours = è«‹å‡æ™‚æ•¸
4. è‡ªå‹•æ‰£é™¤å‡æœŸé¤˜é¡

è£œä¼‘è«‹å‡æµç¨‹ï¼š
1. æŸ¥è©¢å¯ç”¨è£œä¼‘ï¼ˆFIFOæ’åºï¼‰
2. å„ªå…ˆä½¿ç”¨æœ€æ—©çš„è£œä¼‘
3. è¨˜éŒ„ä½¿ç”¨æ­·å²
4. æ›´æ–°è£œä¼‘é¤˜é¡
```

---

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

```typescript
// æ¸¬è©¦1ï¼šæ–°å¢å·¥æ™‚æˆåŠŸ
test('æ‡‰è©²æˆåŠŸæ–°å¢å·¥æ™‚', async () => {
  const data = {
    work_date: '2025-11-01',
    client_id: '12345678',
    hours: 8
  };
  const result = await createTimeLog(data, user);
  expect(result.hours).toBe(8);
});

// æ¸¬è©¦2ï¼šå“¡å·¥åªèƒ½çœ‹è‡ªå·±
test('å“¡å·¥åªèƒ½çœ‹è‡ªå·±çš„å·¥æ™‚', async () => {
  const user = { user_id: 2, is_admin: false };
  const logs = await getTimeLogs({}, user);
  logs.forEach(log => {
    expect(log.user_id).toBe(2);
  });
});

// æ¸¬è©¦3ï¼šåŠ æ¬Šå·¥æ™‚è¨ˆç®—æ­£ç¢º
test('æ‡‰è©²æ­£ç¢ºè¨ˆç®—åŠ æ¬Šå·¥æ™‚', async () => {
  const result = await calculateWeightedHours(1, '2025-11-01', '2025-11-30');
  expect(result.weightedHours).toBeGreaterThan(result.totalHours);
});
```

---

**é€™å€‹æ–‡æª”åŒ…å«å·¥æ™‚ç®¡ç†çš„æ‰€æœ‰æŠ€è¡“ç´°ç¯€ã€‚**

