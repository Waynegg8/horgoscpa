# æœå‹™ç”Ÿå‘½é€±æœŸç®¡ç†

**çµ¦ AIï¼š** ClientServices æœå‹™æš«åœ/æ¢å¾©åŠŸèƒ½å®Œæ•´è¦æ ¼

---

## ğŸ’¾ è³‡æ–™è¡¨æ›´æ–°

### ClientServices å¢åŠ ç‹€æ…‹å­—æ®µ

```sql
-- æ·»åŠ ç‹€æ…‹å­—æ®µåˆ° ClientServices
ALTER TABLE ClientServices ADD COLUMN status TEXT DEFAULT 'active';
-- ç‹€æ…‹: 'active', 'suspended', 'expired', 'cancelled'

ALTER TABLE ClientServices ADD COLUMN suspended_at TEXT;
ALTER TABLE ClientServices ADD COLUMN resumed_at TEXT;
ALTER TABLE ClientServices ADD COLUMN suspension_reason TEXT;
ALTER TABLE ClientServices ADD COLUMN auto_renew BOOLEAN DEFAULT 1;
```

### æœå‹™è®Šæ›´æ­·å²è¡¨

```sql
CREATE TABLE ServiceChangeHistory (
  change_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_service_id INTEGER NOT NULL,
  old_status TEXT,
  new_status TEXT,
  changed_by INTEGER NOT NULL,
  changed_at TEXT DEFAULT (datetime('now')),
  reason TEXT,
  notes TEXT,
  
  FOREIGN KEY (client_service_id) REFERENCES ClientServices(client_service_id),
  FOREIGN KEY (changed_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_service_change_service ON ServiceChangeHistory(client_service_id);
CREATE INDEX idx_service_change_date ON ServiceChangeHistory(changed_at);
```

---

## ğŸ”Œ API ç«¯é»

### 1. æš«åœæœå‹™

âš ï¸ **å°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆ** - å“¡å·¥ä¹Ÿå¯æš«åœå®¢æˆ¶æœå‹™

```
POST /api/v1/client-services/:id/suspend
æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
```

**è«‹æ±‚ Bodyï¼š**
```json
{
  "reason": "å®¢æˆ¶è¦æ±‚æš«æ™‚ä¸­æ­¢",
  "notes": "é è¨ˆ3å€‹æœˆå¾Œæ¢å¾©"
}
```

**å›æ‡‰ï¼š**
```json
{
  "success": true,
  "data": {
    "client_service_id": 123,
    "status": "suspended",
    "suspended_at": "2025-10-28 15:30:00",
    "message": "æœå‹™å·²æš«åœï¼Œç›¸é—œä»»å‹™å°‡ä¸å†è‡ªå‹•ç”Ÿæˆ"
  }
}
```

### 2. æ¢å¾©æœå‹™

âš ï¸ **å°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆ** - å“¡å·¥ä¹Ÿå¯æ¢å¾©å®¢æˆ¶æœå‹™

```
POST /api/v1/client-services/:id/resume
æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
```

**è«‹æ±‚ Bodyï¼š**
```json
{
  "notes": "å®¢æˆ¶å·²é‡æ–°å•Ÿå‹•æœå‹™"
}
```

**å›æ‡‰ï¼š**
```json
{
  "success": true,
  "data": {
    "client_service_id": 123,
    "status": "active",
    "resumed_at": "2025-10-28 16:00:00",
    "message": "æœå‹™å·²æ¢å¾©ï¼Œå°‡æ–¼ä¸‹å€‹é€±æœŸé‡æ–°ç”Ÿæˆä»»å‹™"
  }
}
```

### 3. å–æ¶ˆæœå‹™

âš ï¸ å–æ¶ˆæœå‹™å½±éŸ¿è¼ƒå¤§ï¼Œå»ºè­°åƒ…ç®¡ç†å“¡æ“ä½œ

```
POST /api/v1/client-services/:id/cancel
æ¬Šé™ï¼šç®¡ç†å“¡
```

**è«‹æ±‚ Bodyï¼š**
```json
{
  "reason": "å®¢æˆ¶ä¸å†éœ€è¦æ­¤æœå‹™",
  "cancel_pending_tasks": true
}
```

### 4. æŸ¥è©¢æœå‹™è®Šæ›´æ­·å²
```
GET /api/v1/client-services/:id/history
æ¬Šé™ï¼šæ‰€æœ‰äºº
```

**å›æ‡‰ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "change_id": 1,
      "old_status": "active",
      "new_status": "suspended",
      "changed_by": "å¼µç®¡ç†",
      "changed_at": "2025-10-28 15:30:00",
      "reason": "å®¢æˆ¶è¦æ±‚æš«æ™‚ä¸­æ­¢",
      "notes": "é è¨ˆ3å€‹æœˆå¾Œæ¢å¾©"
    }
  ]
}
```

---

## ğŸ”§ å¾Œç«¯å¯¦ç¾

### ClientServiceService

```typescript
class ClientServiceService {
  async suspendService(serviceId: number, reason: string, notes: string, adminUser) {
    // 1. æŸ¥è©¢æœå‹™
    const service = await this.repository.findById(serviceId);
    if (!service) {
      throw new NotFoundError('æœå‹™ä¸å­˜åœ¨');
    }
    
    if (service.status === 'suspended') {
      throw new ValidationError('æœå‹™å·²è™•æ–¼æš«åœç‹€æ…‹');
    }
    
    // 2. æ›´æ–°ç‹€æ…‹
    await this.db.prepare(`
      UPDATE ClientServices
      SET status = 'suspended',
          suspended_at = datetime('now'),
          suspension_reason = ?
      WHERE client_service_id = ?
    `).bind(reason, serviceId).run();
    
    // 3. è¨˜éŒ„è®Šæ›´æ­·å²
    await this.db.prepare(`
      INSERT INTO ServiceChangeHistory (
        client_service_id,
        old_status,
        new_status,
        changed_by,
        reason,
        notes
      ) VALUES (?, ?, ?, ?, ?, ?)
    `).bind(
      serviceId,
      service.status,
      'suspended',
      adminUser.user_id,
      reason,
      notes
    ).run();
    
    // 4. æš«åœç›¸é—œæœªå®Œæˆä»»å‹™
    await this.db.prepare(`
      UPDATE ActiveTasks
      SET status = 'suspended',
          notes = 'Service suspended: ' || ?
      WHERE client_service_id = ?
        AND status NOT IN ('completed', 'cancelled')
    `).bind(reason, serviceId).run();
    
    // 5. é€šçŸ¥ç›¸é—œäººå“¡
    await this.sendNotification({
      client_id: service.client_id,
      type: 'service_suspended',
      message: `æœå‹™ã€Œ${service.service_name}ã€å·²æš«åœ`
    });
    
    return {
      client_service_id: serviceId,
      status: 'suspended',
      suspended_at: new Date(),
      message: 'æœå‹™å·²æš«åœï¼Œç›¸é—œä»»å‹™å°‡ä¸å†è‡ªå‹•ç”Ÿæˆ'
    };
  }
  
  async resumeService(serviceId: number, notes: string, adminUser) {
    // 1. æŸ¥è©¢æœå‹™
    const service = await this.repository.findById(serviceId);
    if (!service) {
      throw new NotFoundError('æœå‹™ä¸å­˜åœ¨');
    }
    
    if (service.status !== 'suspended') {
      throw new ValidationError('åªèƒ½æ¢å¾©å·²æš«åœçš„æœå‹™');
    }
    
    // 2. æ›´æ–°ç‹€æ…‹
    await this.db.prepare(`
      UPDATE ClientServices
      SET status = 'active',
          resumed_at = datetime('now'),
          suspended_at = NULL,
          suspension_reason = NULL
      WHERE client_service_id = ?
    `).bind(serviceId).run();
    
    // 3. è¨˜éŒ„è®Šæ›´æ­·å²
    await this.db.prepare(`
      INSERT INTO ServiceChangeHistory (
        client_service_id,
        old_status,
        new_status,
        changed_by,
        notes
      ) VALUES (?, ?, ?, ?, ?)
    `).bind(
      serviceId,
      'suspended',
      'active',
      adminUser.user_id,
      notes
    ).run();
    
    // 4. æ¢å¾©ç›¸é—œä»»å‹™ï¼ˆå¯é¸ï¼‰
    await this.db.prepare(`
      UPDATE ActiveTasks
      SET status = 'pending'
      WHERE client_service_id = ?
        AND status = 'suspended'
    `).bind(serviceId).run();
    
    // 5. é€šçŸ¥ç›¸é—œäººå“¡
    await this.sendNotification({
      client_id: service.client_id,
      type: 'service_resumed',
      message: `æœå‹™ã€Œ${service.service_name}ã€å·²æ¢å¾©`
    });
    
    return {
      client_service_id: serviceId,
      status: 'active',
      resumed_at: new Date(),
      message: 'æœå‹™å·²æ¢å¾©ï¼Œå°‡æ–¼ä¸‹å€‹é€±æœŸé‡æ–°ç”Ÿæˆä»»å‹™'
    };
  }
  
  async cancelService(serviceId: number, reason: string, cancelPendingTasks: boolean, adminUser) {
    // 1. æŸ¥è©¢æœå‹™
    const service = await this.repository.findById(serviceId);
    if (!service) {
      throw new NotFoundError('æœå‹™ä¸å­˜åœ¨');
    }
    
    // 2. æ›´æ–°ç‹€æ…‹
    await this.db.prepare(`
      UPDATE ClientServices
      SET status = 'cancelled',
          cancelled_at = datetime('now'),
          cancelled_by = ?
      WHERE client_service_id = ?
    `).bind(adminUser.user_id, serviceId).run();
    
    // 3. è¨˜éŒ„è®Šæ›´æ­·å²
    await this.db.prepare(`
      INSERT INTO ServiceChangeHistory (
        client_service_id,
        old_status,
        new_status,
        changed_by,
        reason
      ) VALUES (?, ?, ?, ?, ?)
    `).bind(
      serviceId,
      service.status,
      'cancelled',
      adminUser.user_id,
      reason
    ).run();
    
    // 4. è™•ç†ç›¸é—œä»»å‹™
    if (cancelPendingTasks) {
      await this.db.prepare(`
        UPDATE ActiveTasks
        SET status = 'cancelled',
            cancelled_at = datetime('now'),
            notes = 'Service cancelled: ' || ?
        WHERE client_service_id = ?
          AND status NOT IN ('completed', 'cancelled')
      `).bind(reason, serviceId).run();
    }
    
    return {
      client_service_id: serviceId,
      status: 'cancelled',
      tasks_cancelled: cancelPendingTasks
    };
  }
}
```

---

## âœ… æ¥­å‹™è¦å‰‡

### æœå‹™ç‹€æ…‹èªªæ˜

| ç‹€æ…‹ | èªªæ˜ | èƒ½å¦ç”Ÿæˆä»»å‹™ | é¡¯ç¤ºé¡è‰² |
|------|------|-------------|---------|
| `active` | æ­£å¸¸é‹è¡Œ | âœ… æ˜¯ | ç¶ è‰² |
| `suspended` | æš«æ™‚ä¸­æ­¢ | âŒ å¦ | é»ƒè‰² |
| `expired` | å·²éæœŸ | âŒ å¦ | ç°è‰² |
| `cancelled` | å·²å–æ¶ˆ | âŒ å¦ | ç´…è‰² |

### ç‹€æ…‹è½‰æ›è¦å‰‡

```
active â†’ suspended   âœ… å…è¨±ï¼ˆæš«åœæœå‹™ï¼‰
active â†’ cancelled   âœ… å…è¨±ï¼ˆå–æ¶ˆæœå‹™ï¼‰
active â†’ expired     âœ… å…è¨±ï¼ˆç³»çµ±è‡ªå‹•ï¼‰

suspended â†’ active   âœ… å…è¨±ï¼ˆæ¢å¾©æœå‹™ï¼‰
suspended â†’ cancelled âœ… å…è¨±ï¼ˆç›´æ¥å–æ¶ˆï¼‰

expired â†’ active     âœ… å…è¨±ï¼ˆçºŒç´„ï¼‰
expired â†’ cancelled  âœ… å…è¨±ï¼ˆç¢ºèªå–æ¶ˆï¼‰

cancelled â†’ active   âŒ ä¸å…è¨±ï¼ˆéœ€é‡æ–°å‰µå»ºï¼‰
```

### è‡ªå‹•ä»»å‹™ç”Ÿæˆé‚è¼¯

```typescript
// å®šæ™‚ä»»å‹™ç”Ÿæˆå™¨ï¼ˆæ¯æœˆ1æ—¥åŸ·è¡Œï¼‰
async function generateMonthlyTasks() {
  const currentMonth = new Date().getMonth() + 1;
  
  // æŸ¥è©¢æ‰€æœ‰æ´»èºçš„å®¢æˆ¶æœå‹™
  const services = await db.prepare(`
    SELECT * FROM ClientServices
    WHERE status = 'active'
      AND is_deleted = 0
      AND trigger_months LIKE '%' || ? || '%'
  `).bind(currentMonth).all();
  
  for (const service of services.results) {
    // æš«åœçš„æœå‹™ä¸ç”Ÿæˆä»»å‹™
    if (service.status !== 'active') {
      console.log(`è·³éæš«åœæœå‹™ï¼š${service.client_service_id}`);
      continue;
    }
    
    // ç”Ÿæˆä»»å‹™...
    await generateTaskFromTemplate(service);
  }
}
```

### åˆ°æœŸæé†’

```typescript
// æ¯å¤©åŸ·è¡Œï¼Œæé†’å³å°‡åˆ°æœŸçš„æœå‹™
async function sendServiceExpiryReminders() {
  const thirtyDaysLater = new Date();
  thirtyDaysLater.setDate(thirtyDaysLater.getDate() + 30);
  
  const expiringServices = await db.prepare(`
    SELECT 
      cs.*,
      c.company_name,
      s.service_name,
      u.name as assignee_name,
      u.email
    FROM ClientServices cs
    JOIN Clients c ON cs.client_id = c.client_id
    JOIN Services s ON cs.service_id = s.service_id
    JOIN Users u ON c.assignee_user_id = u.user_id
    WHERE cs.end_date <= ?
      AND cs.status = 'active'
      AND cs.auto_renew = 0
  `).bind(thirtyDaysLater.toISOString().split('T')[0]).all();
  
  for (const service of expiringServices.results) {
    await sendNotification({
      user_id: service.assignee_user_id,
      type: 'service_expiring',
      message: `å®¢æˆ¶ã€Œ${service.company_name}ã€çš„æœå‹™ã€Œ${service.service_name}ã€å°‡æ–¼ ${service.end_date} åˆ°æœŸ`
    });
  }
}
```

---

## ğŸ¨ å‰ç«¯å¯¦ç¾

### æœå‹™ç‹€æ…‹å¾½ç« 

```vue
<template>
  <span :class="['status-badge', status]">
    {{ statusText[status] }}
  </span>
</template>

<script setup>
defineProps({
  status: {
    type: String,
    required: true,
    validator: (value) => ['active', 'suspended', 'expired', 'cancelled'].includes(value)
  }
});

const statusText = {
  active: 'é‹è¡Œä¸­',
  suspended: 'å·²æš«åœ',
  expired: 'å·²éæœŸ',
  cancelled: 'å·²å–æ¶ˆ'
};
</script>

<style scoped>
.status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
}

.status-badge.active {
  background-color: #D1FAE5;
  color: #065F46;
}

.status-badge.suspended {
  background-color: #FEF3C7;
  color: #92400E;
}

.status-badge.expired {
  background-color: #E5E7EB;
  color: #374151;
}

.status-badge.cancelled {
  background-color: #FEE2E2;
  color: #991B1B;
}
</style>
```

### æœå‹™æ“ä½œæŒ‰éˆ•

```vue
<template>
  <div class="service-actions">
    <button 
      v-if="service.status === 'active'"
      @click="handleSuspend"
      class="btn btn-warning"
    >
      æš«åœæœå‹™
    </button>
    
    <button 
      v-if="service.status === 'suspended'"
      @click="handleResume"
      class="btn btn-success"
    >
      æ¢å¾©æœå‹™
    </button>
    
    <button 
      v-if="['active', 'suspended'].includes(service.status)"
      @click="handleCancel"
      class="btn btn-danger"
    >
      å–æ¶ˆæœå‹™
    </button>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import { suspendService, resumeService, cancelService } from '@/api/services';

const props = defineProps({
  service: {
    type: Object,
    required: true
  }
});

const emit = defineEmits(['updated']);

async function handleSuspend() {
  const reason = prompt('è«‹è¼¸å…¥æš«åœåŸå› ï¼š');
  if (!reason) return;
  
  try {
    await suspendService(props.service.client_service_id, { reason });
    emit('updated');
  } catch (err) {
    alert('æš«åœå¤±æ•—ï¼š' + err.message);
  }
}

async function handleResume() {
  const notes = prompt('æ¢å¾©å‚™è¨»ï¼ˆå¯é¸ï¼‰ï¼š');
  
  try {
    await resumeService(props.service.client_service_id, { notes });
    emit('updated');
  } catch (err) {
    alert('æ¢å¾©å¤±æ•—ï¼š' + err.message);
  }
}

async function handleCancel() {
  if (!confirm('ç¢ºå®šè¦å–æ¶ˆæ­¤æœå‹™å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚')) {
    return;
  }
  
  const reason = prompt('è«‹è¼¸å…¥å–æ¶ˆåŸå› ï¼š');
  if (!reason) return;
  
  const cancelTasks = confirm('æ˜¯å¦åŒæ™‚å–æ¶ˆç›¸é—œçš„æœªå®Œæˆä»»å‹™ï¼Ÿ');
  
  try {
    await cancelService(props.service.client_service_id, {
      reason,
      cancel_pending_tasks: cancelTasks
    });
    emit('updated');
  } catch (err) {
    alert('å–æ¶ˆå¤±æ•—ï¼š' + err.message);
  }
}
</script>
```

---

**é€™å€‹æ–‡æª”å®šç¾©äº†æœå‹™ç”Ÿå‘½é€±æœŸç®¡ç†çš„å®Œæ•´åŠŸèƒ½ã€‚**

