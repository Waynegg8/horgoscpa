# 服務生命週期管理

**給 AI：** ClientServices 服務暫停/恢復功能完整規格

---

## 💾 資料表更新

### ClientServices 增加狀態字段

```sql
-- 添加狀態字段到 ClientServices
ALTER TABLE ClientServices ADD COLUMN status TEXT DEFAULT 'active';
-- 狀態: 'active', 'suspended', 'expired', 'cancelled'

ALTER TABLE ClientServices ADD COLUMN suspended_at TEXT;
ALTER TABLE ClientServices ADD COLUMN resumed_at TEXT;
ALTER TABLE ClientServices ADD COLUMN suspension_reason TEXT;
ALTER TABLE ClientServices ADD COLUMN auto_renew BOOLEAN DEFAULT 1;
```

### 服務變更歷史表

```sql
CREATE TABLE ServiceChangeHistory (
  change_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_service_id INTEGER NOT NULL,
  old_status TEXT,
  new_status TEXT,
  changed_by INTEGER NOT NULL,
  changed_at TEXT DEFAULT (datetime('now')),
  reason TEXT,
  notes TEXT,
  
  FOREIGN KEY (client_service_id) REFERENCES ClientServices(client_service_id),
  FOREIGN KEY (changed_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_service_change_service ON ServiceChangeHistory(client_service_id);
CREATE INDEX idx_service_change_date ON ServiceChangeHistory(changed_at);
```

---

## 🔌 API 端點

### 1. 暫停服務

⚠️ **小型事務所彈性設計** - 員工也可暫停客戶服務

```
POST /api/v1/client-services/:id/suspend
權限：所有人（小型事務所彈性設計）
```

**請求 Body：**
```json
{
  "reason": "客戶要求暫時中止",
  "notes": "預計3個月後恢復"
}
```

**回應：**
```json
{
  "success": true,
  "data": {
    "client_service_id": 123,
    "status": "suspended",
    "suspended_at": "2025-10-28 15:30:00",
    "message": "服務已暫停，相關任務將不再自動生成"
  }
}
```

### 2. 恢復服務

⚠️ **小型事務所彈性設計** - 員工也可恢復客戶服務

```
POST /api/v1/client-services/:id/resume
權限：所有人（小型事務所彈性設計）
```

**請求 Body：**
```json
{
  "notes": "客戶已重新啟動服務"
}
```

**回應：**
```json
{
  "success": true,
  "data": {
    "client_service_id": 123,
    "status": "active",
    "resumed_at": "2025-10-28 16:00:00",
    "message": "服務已恢復，將於下個週期重新生成任務"
  }
}
```

### 3. 取消服務

⚠️ 取消服務影響較大，建議僅管理員操作

```
POST /api/v1/client-services/:id/cancel
權限：管理員
```

**請求 Body：**
```json
{
  "reason": "客戶不再需要此服務",
  "cancel_pending_tasks": true
}
```

### 4. 查詢服務變更歷史
```
GET /api/v1/client-services/:id/history
權限：所有人
```

**回應：**
```json
{
  "success": true,
  "data": [
    {
      "change_id": 1,
      "old_status": "active",
      "new_status": "suspended",
      "changed_by": "張管理",
      "changed_at": "2025-10-28 15:30:00",
      "reason": "客戶要求暫時中止",
      "notes": "預計3個月後恢復"
    }
  ]
}
```

---

## 🔧 後端實現

### ClientServiceService

```typescript
class ClientServiceService {
  async suspendService(serviceId: number, reason: string, notes: string, adminUser) {
    // 1. 查詢服務
    const service = await this.repository.findById(serviceId);
    if (!service) {
      throw new NotFoundError('服務不存在');
    }
    
    if (service.status === 'suspended') {
      throw new ValidationError('服務已處於暫停狀態');
    }
    
    // 2. 更新狀態
    await this.db.prepare(`
      UPDATE ClientServices
      SET status = 'suspended',
          suspended_at = datetime('now'),
          suspension_reason = ?
      WHERE client_service_id = ?
    `).bind(reason, serviceId).run();
    
    // 3. 記錄變更歷史
    await this.db.prepare(`
      INSERT INTO ServiceChangeHistory (
        client_service_id,
        old_status,
        new_status,
        changed_by,
        reason,
        notes
      ) VALUES (?, ?, ?, ?, ?, ?)
    `).bind(
      serviceId,
      service.status,
      'suspended',
      adminUser.user_id,
      reason,
      notes
    ).run();
    
    // 4. 暫停相關未完成任務
    await this.db.prepare(`
      UPDATE ActiveTasks
      SET status = 'suspended',
          notes = 'Service suspended: ' || ?
      WHERE client_service_id = ?
        AND status NOT IN ('completed', 'cancelled')
    `).bind(reason, serviceId).run();
    
    // 5. 通知相關人員
    await this.sendNotification({
      client_id: service.client_id,
      type: 'service_suspended',
      message: `服務「${service.service_name}」已暫停`
    });
    
    return {
      client_service_id: serviceId,
      status: 'suspended',
      suspended_at: new Date(),
      message: '服務已暫停，相關任務將不再自動生成'
    };
  }
  
  async resumeService(serviceId: number, notes: string, adminUser) {
    // 1. 查詢服務
    const service = await this.repository.findById(serviceId);
    if (!service) {
      throw new NotFoundError('服務不存在');
    }
    
    if (service.status !== 'suspended') {
      throw new ValidationError('只能恢復已暫停的服務');
    }
    
    // 2. 更新狀態
    await this.db.prepare(`
      UPDATE ClientServices
      SET status = 'active',
          resumed_at = datetime('now'),
          suspended_at = NULL,
          suspension_reason = NULL
      WHERE client_service_id = ?
    `).bind(serviceId).run();
    
    // 3. 記錄變更歷史
    await this.db.prepare(`
      INSERT INTO ServiceChangeHistory (
        client_service_id,
        old_status,
        new_status,
        changed_by,
        notes
      ) VALUES (?, ?, ?, ?, ?)
    `).bind(
      serviceId,
      'suspended',
      'active',
      adminUser.user_id,
      notes
    ).run();
    
    // 4. 恢復相關任務（可選）
    await this.db.prepare(`
      UPDATE ActiveTasks
      SET status = 'pending'
      WHERE client_service_id = ?
        AND status = 'suspended'
    `).bind(serviceId).run();
    
    // 5. 通知相關人員
    await this.sendNotification({
      client_id: service.client_id,
      type: 'service_resumed',
      message: `服務「${service.service_name}」已恢復`
    });
    
    return {
      client_service_id: serviceId,
      status: 'active',
      resumed_at: new Date(),
      message: '服務已恢復，將於下個週期重新生成任務'
    };
  }
  
  async cancelService(serviceId: number, reason: string, cancelPendingTasks: boolean, adminUser) {
    // 1. 查詢服務
    const service = await this.repository.findById(serviceId);
    if (!service) {
      throw new NotFoundError('服務不存在');
    }
    
    // 2. 更新狀態
    await this.db.prepare(`
      UPDATE ClientServices
      SET status = 'cancelled',
          cancelled_at = datetime('now'),
          cancelled_by = ?
      WHERE client_service_id = ?
    `).bind(adminUser.user_id, serviceId).run();
    
    // 3. 記錄變更歷史
    await this.db.prepare(`
      INSERT INTO ServiceChangeHistory (
        client_service_id,
        old_status,
        new_status,
        changed_by,
        reason
      ) VALUES (?, ?, ?, ?, ?)
    `).bind(
      serviceId,
      service.status,
      'cancelled',
      adminUser.user_id,
      reason
    ).run();
    
    // 4. 處理相關任務
    if (cancelPendingTasks) {
      await this.db.prepare(`
        UPDATE ActiveTasks
        SET status = 'cancelled',
            cancelled_at = datetime('now'),
            notes = 'Service cancelled: ' || ?
        WHERE client_service_id = ?
          AND status NOT IN ('completed', 'cancelled')
      `).bind(reason, serviceId).run();
    }
    
    return {
      client_service_id: serviceId,
      status: 'cancelled',
      tasks_cancelled: cancelPendingTasks
    };
  }
}
```

---

## ✅ 業務規則

### 服務狀態說明

| 狀態 | 說明 | 能否生成任務 | 顯示顏色 |
|------|------|-------------|---------|
| `active` | 正常運行 | ✅ 是 | 綠色 |
| `suspended` | 暫時中止 | ❌ 否 | 黃色 |
| `expired` | 已過期 | ❌ 否 | 灰色 |
| `cancelled` | 已取消 | ❌ 否 | 紅色 |

### 狀態轉換規則

```
active → suspended   ✅ 允許（暫停服務）
active → cancelled   ✅ 允許（取消服務）
active → expired     ✅ 允許（系統自動）

suspended → active   ✅ 允許（恢復服務）
suspended → cancelled ✅ 允許（直接取消）

expired → active     ✅ 允許（續約）
expired → cancelled  ✅ 允許（確認取消）

cancelled → active   ❌ 不允許（需重新創建）
```

### 自動任務生成邏輯

```typescript
// 定時任務生成器（每月1日執行）
async function generateMonthlyTasks() {
  const currentMonth = new Date().getMonth() + 1;
  
  // 查詢所有活躍的客戶服務
  const services = await db.prepare(`
    SELECT * FROM ClientServices
    WHERE status = 'active'
      AND is_deleted = 0
      AND trigger_months LIKE '%' || ? || '%'
  `).bind(currentMonth).all();
  
  for (const service of services.results) {
    // 暫停的服務不生成任務
    if (service.status !== 'active') {
      console.log(`跳過暫停服務：${service.client_service_id}`);
      continue;
    }
    
    // 生成任務...
    await generateTaskFromTemplate(service);
  }
}
```

### 到期提醒

```typescript
// 每天執行，提醒即將到期的服務
async function sendServiceExpiryReminders() {
  const thirtyDaysLater = new Date();
  thirtyDaysLater.setDate(thirtyDaysLater.getDate() + 30);
  
  const expiringServices = await db.prepare(`
    SELECT 
      cs.*,
      c.company_name,
      s.service_name,
      u.name as assignee_name,
      u.email
    FROM ClientServices cs
    JOIN Clients c ON cs.client_id = c.client_id
    JOIN Services s ON cs.service_id = s.service_id
    JOIN Users u ON c.assignee_user_id = u.user_id
    WHERE cs.end_date <= ?
      AND cs.status = 'active'
      AND cs.auto_renew = 0
  `).bind(thirtyDaysLater.toISOString().split('T')[0]).all();
  
  for (const service of expiringServices.results) {
    await sendNotification({
      user_id: service.assignee_user_id,
      type: 'service_expiring',
      message: `客戶「${service.company_name}」的服務「${service.service_name}」將於 ${service.end_date} 到期`
    });
  }
}
```

---

## 🎨 前端實現

### 服務狀態徽章

```vue
<template>
  <span :class="['status-badge', status]">
    {{ statusText[status] }}
  </span>
</template>

<script setup>
defineProps({
  status: {
    type: String,
    required: true,
    validator: (value) => ['active', 'suspended', 'expired', 'cancelled'].includes(value)
  }
});

const statusText = {
  active: '運行中',
  suspended: '已暫停',
  expired: '已過期',
  cancelled: '已取消'
};
</script>

<style scoped>
.status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
}

.status-badge.active {
  background-color: #D1FAE5;
  color: #065F46;
}

.status-badge.suspended {
  background-color: #FEF3C7;
  color: #92400E;
}

.status-badge.expired {
  background-color: #E5E7EB;
  color: #374151;
}

.status-badge.cancelled {
  background-color: #FEE2E2;
  color: #991B1B;
}
</style>
```

### 服務操作按鈕

```vue
<template>
  <div class="service-actions">
    <button 
      v-if="service.status === 'active'"
      @click="handleSuspend"
      class="btn btn-warning"
    >
      暫停服務
    </button>
    
    <button 
      v-if="service.status === 'suspended'"
      @click="handleResume"
      class="btn btn-success"
    >
      恢復服務
    </button>
    
    <button 
      v-if="['active', 'suspended'].includes(service.status)"
      @click="handleCancel"
      class="btn btn-danger"
    >
      取消服務
    </button>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import { suspendService, resumeService, cancelService } from '@/api/services';

const props = defineProps({
  service: {
    type: Object,
    required: true
  }
});

const emit = defineEmits(['updated']);

async function handleSuspend() {
  const reason = prompt('請輸入暫停原因：');
  if (!reason) return;
  
  try {
    await suspendService(props.service.client_service_id, { reason });
    emit('updated');
  } catch (err) {
    alert('暫停失敗：' + err.message);
  }
}

async function handleResume() {
  const notes = prompt('恢復備註（可選）：');
  
  try {
    await resumeService(props.service.client_service_id, { notes });
    emit('updated');
  } catch (err) {
    alert('恢復失敗：' + err.message);
  }
}

async function handleCancel() {
  if (!confirm('確定要取消此服務嗎？此操作不可恢復。')) {
    return;
  }
  
  const reason = prompt('請輸入取消原因：');
  if (!reason) return;
  
  const cancelTasks = confirm('是否同時取消相關的未完成任務？');
  
  try {
    await cancelService(props.service.client_service_id, {
      reason,
      cancel_pending_tasks: cancelTasks
    });
    emit('updated');
  } catch (err) {
    alert('取消失敗：' + err.message);
  }
}
</script>
```

---

**這個文檔定義了服務生命週期管理的完整功能。**

