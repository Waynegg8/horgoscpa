# çŸ¥è­˜ç®¡ç† - å®Œæ•´é–‹ç™¼è¦æ ¼

**çµ¦ AIï¼š** å¯¦ç¾çŸ¥è­˜ç®¡ç†åŠŸèƒ½çš„å®Œæ•´æŠ€è¡“è¦æ ¼

---

## ğŸ’¾ è³‡æ–™è¡¨

### SOPDocumentsï¼ˆSOP æ–‡ä»¶ï¼‰
```sql
CREATE TABLE SOPDocuments (
  sop_id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT NOT NULL,               -- HTML å…§å®¹
  category TEXT,
  tags TEXT,                           -- JSON é™£åˆ—
  version INTEGER DEFAULT 1,
  is_published BOOLEAN DEFAULT 0,
  created_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (created_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_sop_category ON SOPDocuments(category);
CREATE INDEX idx_sop_published ON SOPDocuments(is_published);
CREATE INDEX idx_sop_creator ON SOPDocuments(created_by);
```

### ClientSOPLinksï¼ˆå®¢æˆ¶å°ˆå±¬ SOPï¼‰
```sql
CREATE TABLE ClientSOPLinks (
  link_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  sop_id INTEGER NOT NULL,
  assigned_by INTEGER NOT NULL,
  assigned_at TEXT DEFAULT (datetime('now')),
  notes TEXT,
  
  FOREIGN KEY (client_id) REFERENCES Clients(client_id),
  FOREIGN KEY (sop_id) REFERENCES SOPDocuments(sop_id),
  FOREIGN KEY (assigned_by) REFERENCES Users(user_id),
  UNIQUE(client_id, sop_id)
);

CREATE INDEX idx_client_sop_client ON ClientSOPLinks(client_id);
CREATE INDEX idx_client_sop_sop ON ClientSOPLinks(sop_id);
```

### KnowledgeArticlesï¼ˆçŸ¥è­˜åº«æ–‡ç« ï¼‰
```sql
CREATE TABLE KnowledgeArticles (
  article_id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  category TEXT,
  tags TEXT,                           -- JSON é™£åˆ—
  is_published BOOLEAN DEFAULT 0,
  view_count INTEGER DEFAULT 0,
  created_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (created_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_knowledge_category ON KnowledgeArticles(category);
CREATE INDEX idx_knowledge_published ON KnowledgeArticles(is_published);
```

---

## ğŸ”Œ API ç«¯é»

### SOP æ–‡ä»¶ç®¡ç†

âš ï¸ **å°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆ** - å“¡å·¥å¯å”åŠ©å»ºç«‹å’Œç·¨è¼¯ SOP

```
GET    /api/v1/sop                    æ¬Šé™ï¼šæ‰€æœ‰äºº
POST   /api/v1/sop                    æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
GET    /api/v1/sop/:id                æ¬Šé™ï¼šæ‰€æœ‰äºº
PUT    /api/v1/sop/:id                æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
DELETE /api/v1/sop/:id                æ¬Šé™ï¼šç®¡ç†å“¡ï¼ˆåˆªé™¤åƒ…é™ç®¡ç†å“¡ï¼‰
POST   /api/v1/sop/:id/publish        æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
```

### å®¢æˆ¶å°ˆå±¬ SOP

âš ï¸ **å°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆ** - å“¡å·¥ä¹Ÿå¯æŒ‡æ´¾å®¢æˆ¶å°ˆå±¬ SOP

```
GET    /api/v1/clients/:clientId/sop         æ¬Šé™ï¼šæ‰€æœ‰äºº
POST   /api/v1/clients/:clientId/sop         æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
DELETE /api/v1/clients/:clientId/sop/:sopId  æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
```

### çŸ¥è­˜åº«

âš ï¸ **å°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆ** - å“¡å·¥å¯å”åŠ©å»ºç«‹çŸ¥è­˜åº«å…§å®¹

```
GET    /api/v1/knowledge              æ¬Šé™ï¼šæ‰€æœ‰äºº
POST   /api/v1/knowledge              æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
GET    /api/v1/knowledge/:id          æ¬Šé™ï¼šæ‰€æœ‰äºº
PUT    /api/v1/knowledge/:id          æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
DELETE /api/v1/knowledge/:id          æ¬Šé™ï¼šç®¡ç†å“¡ï¼ˆåˆªé™¤åƒ…é™ç®¡ç†å“¡ï¼‰
GET    /api/v1/knowledge/search?q=XX  æ¬Šé™ï¼šæ‰€æœ‰äºº
```

---

## ğŸ¨ å‰ç«¯çµ„ä»¶

### SOPListPage.vue
```vue
<template>
  <div class="sop-list">
    <h1>SOP æ–‡ä»¶</h1>
    
    <div class="filters">
      <input 
        v-model="searchQuery" 
        placeholder="æœå°‹ SOP..."
      />
      <select v-model="categoryFilter">
        <option value="">æ‰€æœ‰åˆ†é¡</option>
        <option value="è¨˜å¸³">è¨˜å¸³æµç¨‹</option>
        <option value="å ±ç¨…">å ±ç¨…æµç¨‹</option>
        <option value="å·¥å•†">å·¥å•†ç™»è¨˜</option>
      </select>
      <StyledButton 
        v-if="user.is_admin"
        @click="showCreateModal = true"
      >
        + æ–°å¢ SOP
      </StyledButton>
    </div>

    <div class="sop-grid">
      <div 
        v-for="sop in filteredSOPs" 
        :key="sop.sop_id"
        class="sop-card"
        @click="viewSOP(sop)"
      >
        <h3>{{ sop.title }}</h3>
        <p class="category">{{ sop.category }}</p>
        <p class="version">ç‰ˆæœ¬ v{{ sop.version }}</p>
        <div class="tags">
          <span v-for="tag in parseTags(sop.tags)" :key="tag">
            {{ tag }}
          </span>
        </div>
      </div>
    </div>
  </div>
</template>
```

### SOPEditor.vue
```vue
<template>
  <Modal :show="show" title="ç·¨è¼¯ SOP" size="xl">
    <form @submit.prevent="handleSave">
      <StyledInput
        v-model="sop.title"
        label="æ¨™é¡Œ"
        :required="true"
      />
      
      <select v-model="sop.category">
        <option value="è¨˜å¸³">è¨˜å¸³æµç¨‹</option>
        <option value="å ±ç¨…">å ±ç¨…æµç¨‹</option>
        <option value="å·¥å•†">å·¥å•†ç™»è¨˜</option>
        <option value="å…§éƒ¨">å…§éƒ¨ä½œæ¥­</option>
      </select>
      
      <!-- WYSIWYG ç·¨è¼¯å™¨ -->
      <div class="editor">
        <div class="toolbar">
          <button type="button" @click="format('bold')">ç²—é«”</button>
          <button type="button" @click="format('italic')">æ–œé«”</button>
          <button type="button" @click="insertList">æ¸…å–®</button>
          <button type="button" @click="insertTable">è¡¨æ ¼</button>
        </div>
        <div
          ref="contentEditor"
          contenteditable="true"
          class="content-area"
          @input="updateContent"
          v-html="sop.content"
        ></div>
      </div>
      
      <div class="actions">
        <StyledButton type="button" variant="ghost" @click="$emit('close')">
          å–æ¶ˆ
        </StyledButton>
        <StyledButton type="submit" variant="secondary">
          å„²å­˜è‰ç¨¿
        </StyledButton>
        <StyledButton type="button" @click="saveAndPublish">
          ç™¼å¸ƒ
        </StyledButton>
      </div>
    </form>
  </Modal>
</template>
```

---

## ğŸ”§ å¾Œç«¯å¯¦ç¾

### KnowledgeService
```typescript
class KnowledgeService {
  async createSOP(data, userId) {
    // 1. é©—è­‰
    if (!data.title || !data.content) {
      throw new ValidationError('æ¨™é¡Œå’Œå…§å®¹ç‚ºå¿…å¡«');
    }
    
    // 2. å‰µå»º
    const sop = await this.sopRepo.create({
      ...data,
      version: 1,
      is_published: false,
      created_by: userId
    });
    
    return sop;
  }
  
  async assignSOPToClient(clientId, sopId, userId) {
    // 1. é©—è­‰å®¢æˆ¶å’Œ SOP å­˜åœ¨
    const client = await this.clientRepo.findById(clientId);
    const sop = await this.sopRepo.findById(sopId);
    
    if (!client || !sop) {
      throw new NotFoundError('å®¢æˆ¶æˆ– SOP ä¸å­˜åœ¨');
    }
    
    // 2. æª¢æŸ¥æ˜¯å¦å·²é—œè¯
    const existing = await this.linkRepo.find(clientId, sopId);
    if (existing) {
      throw new ConflictError('æ­¤ SOP å·²é—œè¯åˆ°è©²å®¢æˆ¶');
    }
    
    // 3. å‰µå»ºé—œè¯
    return await this.linkRepo.create({
      client_id: clientId,
      sop_id: sopId,
      assigned_by: userId
    });
  }
  
  async searchKnowledge(query) {
    // å…¨æ–‡æœå°‹
    return await this.knowledgeRepo.search(query);
  }
}
```

---

## âœ… æ¥­å‹™è¦å‰‡

### SOP ç™¼å¸ƒæµç¨‹
```
è‰ç¨¿ç‹€æ…‹ â†’ ç·¨è¼¯ä¸­ â†’ ç¢ºèªç„¡èª¤ â†’ é»æ“Šç™¼å¸ƒ â†’ ç«‹å³å¯è¦‹
```

### ç‰ˆæœ¬æ§åˆ¶ï¼ˆç°¡åŒ–ï¼‰
```
æ¯æ¬¡ç·¨è¼¯ï¼šversion + 1
ä¸ä¿ç•™æ­·å²ç‰ˆæœ¬ï¼ˆç°¡åŒ–è¨­è¨ˆï¼‰
```

### å®¢æˆ¶ SOP é—œè¯è¦å‰‡
```
ä¸€å€‹å®¢æˆ¶å¯ä»¥é—œè¯å¤šå€‹ SOP
åŒä¸€å€‹ SOP å¯ä»¥é—œè¯å¤šå€‹å®¢æˆ¶
åŒä¸€å®¢æˆ¶ä¸èƒ½é‡è¤‡é—œè¯åŒä¸€ SOP
```

---

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

```typescript
// æ¸¬è©¦1ï¼šå‰µå»º SOP
test('æ‡‰è©²æˆåŠŸå‰µå»º SOP', async () => {
  const sop = await createSOP({
    title: 'è¨˜å¸³æµç¨‹',
    content: 'æ­¥é©Ÿ1...'
  });
  expect(sop.version).toBe(1);
});

// æ¸¬è©¦2ï¼šé—œè¯åˆ°å®¢æˆ¶
test('æ‡‰è©²æˆåŠŸé—œè¯ SOP åˆ°å®¢æˆ¶', async () => {
  await assignSOPToClient('12345678', 1);
  const sops = await getClientSOPs('12345678');
  expect(sops.length).toBe(1);
});

// æ¸¬è©¦3ï¼šæœå°‹åŠŸèƒ½
test('æ‡‰è©²èƒ½æœå°‹çŸ¥è­˜åº«', async () => {
  const results = await searchKnowledge('å¯†ç¢¼');
  expect(results.length).toBeGreaterThan(0);
});
```

---

**é€™å€‹æ–‡æª”åŒ…å«çŸ¥è­˜ç®¡ç†çš„æ‰€æœ‰æŠ€è¡“ç´°ç¯€ã€‚**

