# 知識管理 - 完整開發規格

**給 AI：** 實現知識管理功能的完整技術規格

---

## 💾 資料表

### SOPDocuments（SOP 文件）
```sql
CREATE TABLE SOPDocuments (
  sop_id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT NOT NULL,               -- HTML 內容
  category TEXT,
  tags TEXT,                           -- JSON 陣列
  version INTEGER DEFAULT 1,
  is_published BOOLEAN DEFAULT 0,
  created_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (created_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_sop_category ON SOPDocuments(category);
CREATE INDEX idx_sop_published ON SOPDocuments(is_published);
CREATE INDEX idx_sop_creator ON SOPDocuments(created_by);
```

### ClientSOPLinks（客戶專屬 SOP）
```sql
CREATE TABLE ClientSOPLinks (
  link_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  sop_id INTEGER NOT NULL,
  assigned_by INTEGER NOT NULL,
  assigned_at TEXT DEFAULT (datetime('now')),
  notes TEXT,
  
  FOREIGN KEY (client_id) REFERENCES Clients(client_id),
  FOREIGN KEY (sop_id) REFERENCES SOPDocuments(sop_id),
  FOREIGN KEY (assigned_by) REFERENCES Users(user_id),
  UNIQUE(client_id, sop_id)
);

CREATE INDEX idx_client_sop_client ON ClientSOPLinks(client_id);
CREATE INDEX idx_client_sop_sop ON ClientSOPLinks(sop_id);
```

### KnowledgeArticles（知識庫文章）
```sql
CREATE TABLE KnowledgeArticles (
  article_id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  category TEXT,
  tags TEXT,                           -- JSON 陣列
  is_published BOOLEAN DEFAULT 0,
  view_count INTEGER DEFAULT 0,
  created_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (created_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_knowledge_category ON KnowledgeArticles(category);
CREATE INDEX idx_knowledge_published ON KnowledgeArticles(is_published);
```

---

## 🔌 API 端點

### SOP 文件管理

⚠️ **小型事務所彈性設計** - 員工可協助建立和編輯 SOP

```
GET    /api/v1/sop                    權限：所有人
POST   /api/v1/sop                    權限：所有人（小型事務所彈性設計）
GET    /api/v1/sop/:id                權限：所有人
PUT    /api/v1/sop/:id                權限：所有人（小型事務所彈性設計）
DELETE /api/v1/sop/:id                權限：管理員（刪除僅限管理員）
POST   /api/v1/sop/:id/publish        權限：所有人（小型事務所彈性設計）
```

### 客戶專屬 SOP

⚠️ **小型事務所彈性設計** - 員工也可指派客戶專屬 SOP

```
GET    /api/v1/clients/:clientId/sop         權限：所有人
POST   /api/v1/clients/:clientId/sop         權限：所有人（小型事務所彈性設計）
DELETE /api/v1/clients/:clientId/sop/:sopId  權限：所有人（小型事務所彈性設計）
```

### 知識庫

⚠️ **小型事務所彈性設計** - 員工可協助建立知識庫內容

```
GET    /api/v1/knowledge              權限：所有人
POST   /api/v1/knowledge              權限：所有人（小型事務所彈性設計）
GET    /api/v1/knowledge/:id          權限：所有人
PUT    /api/v1/knowledge/:id          權限：所有人（小型事務所彈性設計）
DELETE /api/v1/knowledge/:id          權限：管理員（刪除僅限管理員）
GET    /api/v1/knowledge/search?q=XX  權限：所有人
```

---

## 🎨 前端組件

### SOPListPage.vue
```vue
<template>
  <div class="sop-list">
    <h1>SOP 文件</h1>
    
    <div class="filters">
      <input 
        v-model="searchQuery" 
        placeholder="搜尋 SOP..."
      />
      <select v-model="categoryFilter">
        <option value="">所有分類</option>
        <option value="記帳">記帳流程</option>
        <option value="報稅">報稅流程</option>
        <option value="工商">工商登記</option>
      </select>
      <StyledButton 
        v-if="user.is_admin"
        @click="showCreateModal = true"
      >
        + 新增 SOP
      </StyledButton>
    </div>

    <div class="sop-grid">
      <div 
        v-for="sop in filteredSOPs" 
        :key="sop.sop_id"
        class="sop-card"
        @click="viewSOP(sop)"
      >
        <h3>{{ sop.title }}</h3>
        <p class="category">{{ sop.category }}</p>
        <p class="version">版本 v{{ sop.version }}</p>
        <div class="tags">
          <span v-for="tag in parseTags(sop.tags)" :key="tag">
            {{ tag }}
          </span>
        </div>
      </div>
    </div>
  </div>
</template>
```

### SOPEditor.vue
```vue
<template>
  <Modal :show="show" title="編輯 SOP" size="xl">
    <form @submit.prevent="handleSave">
      <StyledInput
        v-model="sop.title"
        label="標題"
        :required="true"
      />
      
      <select v-model="sop.category">
        <option value="記帳">記帳流程</option>
        <option value="報稅">報稅流程</option>
        <option value="工商">工商登記</option>
        <option value="內部">內部作業</option>
      </select>
      
      <!-- WYSIWYG 編輯器 -->
      <div class="editor">
        <div class="toolbar">
          <button type="button" @click="format('bold')">粗體</button>
          <button type="button" @click="format('italic')">斜體</button>
          <button type="button" @click="insertList">清單</button>
          <button type="button" @click="insertTable">表格</button>
        </div>
        <div
          ref="contentEditor"
          contenteditable="true"
          class="content-area"
          @input="updateContent"
          v-html="sop.content"
        ></div>
      </div>
      
      <div class="actions">
        <StyledButton type="button" variant="ghost" @click="$emit('close')">
          取消
        </StyledButton>
        <StyledButton type="submit" variant="secondary">
          儲存草稿
        </StyledButton>
        <StyledButton type="button" @click="saveAndPublish">
          發布
        </StyledButton>
      </div>
    </form>
  </Modal>
</template>
```

---

## 🔧 後端實現

### KnowledgeService
```typescript
class KnowledgeService {
  async createSOP(data, userId) {
    // 1. 驗證
    if (!data.title || !data.content) {
      throw new ValidationError('標題和內容為必填');
    }
    
    // 2. 創建
    const sop = await this.sopRepo.create({
      ...data,
      version: 1,
      is_published: false,
      created_by: userId
    });
    
    return sop;
  }
  
  async assignSOPToClient(clientId, sopId, userId) {
    // 1. 驗證客戶和 SOP 存在
    const client = await this.clientRepo.findById(clientId);
    const sop = await this.sopRepo.findById(sopId);
    
    if (!client || !sop) {
      throw new NotFoundError('客戶或 SOP 不存在');
    }
    
    // 2. 檢查是否已關聯
    const existing = await this.linkRepo.find(clientId, sopId);
    if (existing) {
      throw new ConflictError('此 SOP 已關聯到該客戶');
    }
    
    // 3. 創建關聯
    return await this.linkRepo.create({
      client_id: clientId,
      sop_id: sopId,
      assigned_by: userId
    });
  }
  
  async searchKnowledge(query) {
    // 全文搜尋
    return await this.knowledgeRepo.search(query);
  }
}
```

---

## ✅ 業務規則

### SOP 發布流程
```
草稿狀態 → 編輯中 → 確認無誤 → 點擊發布 → 立即可見
```

### 版本控制（簡化）
```
每次編輯：version + 1
不保留歷史版本（簡化設計）
```

### 客戶 SOP 關聯規則
```
一個客戶可以關聯多個 SOP
同一個 SOP 可以關聯多個客戶
同一客戶不能重複關聯同一 SOP
```

---

## 🧪 測試案例

```typescript
// 測試1：創建 SOP
test('應該成功創建 SOP', async () => {
  const sop = await createSOP({
    title: '記帳流程',
    content: '步驟1...'
  });
  expect(sop.version).toBe(1);
});

// 測試2：關聯到客戶
test('應該成功關聯 SOP 到客戶', async () => {
  await assignSOPToClient('12345678', 1);
  const sops = await getClientSOPs('12345678');
  expect(sops.length).toBe(1);
});

// 測試3：搜尋功能
test('應該能搜尋知識庫', async () => {
  const results = await searchKnowledge('密碼');
  expect(results.length).toBeGreaterThan(0);
});
```

---

**這個文檔包含知識管理的所有技術細節。**

