# AI 開發須知

**給 AI：** 每次開始工作前必讀

---

## 🚨 開始前必讀清單（每次都要檢查！）

**收到用戶需求後，先做這些：**

1. **[ ] 確認編碼設定**
   ```
   ⚠️ 所有文件都是繁體中文 UTF-8 編碼
   - 讀取文件：使用 UTF-8 編碼
   - 寫入文件：使用 UTF-8 編碼（with BOM for .ps1）
   - 搜索內容：注意中文字符
   - PowerShell 腳本：必須 UTF-8 with BOM
   ```

2. **[ ] 閱讀對應的完整規格**
   ```
   用戶說："開發客戶管理"
   → 立即閱讀：開發指南/客戶管理-完整規格.md
   ```

3. **[ ] 確認需要修改哪些文檔**
   ```
   新增功能 → 使用手冊 + 完整規格
   新增資料表 → SSOT + 所有引用的文檔
   新增API → API清單 + 完整規格
   ```

4. **[ ] 準備一致性檢查清單**
   ```
   記錄：會修改哪些數字、哪些文檔
   準備：驗證命令
   ```

**然後才開始開發！**

---

## ⚠️ 核心原則

### 絕對禁止
```
❌ 問技術問題（用戶不懂技術）
❌ 讓用戶測試（AI必須自己測試！）
❌ 讓用戶部署（AI必須自動部署！）
❌ 沒有測試就說完成（必須先自行測試）
❌ 沒有部署就說完成（必須自動部署）
❌ 修改外部網站（只改內部系統）
❌ 生成報告文件（直接說明即可）
❌ 忽略編碼問題（所有文件都是繁體中文 UTF-8）
```

### 必須遵守
```
✅ 完全自主決策（不問技術問題）
✅ 自己測試驗證（不讓用戶測試）
✅ 遵循共用規範（統一標準）
✅ 保持簡單清晰（極簡設計）
✅ 確保全局一致性（同步修改所有相關文檔）
✅ 正確處理編碼（繁體中文 UTF-8）
```

---

## 🚀 標準開發流程（每次都遵循！）

```
第0步：檢查編碼設定 ⚠️
   ↓
   確認所有文件使用 UTF-8 編碼（繁體中文）
   PowerShell 腳本使用 UTF-8 with BOM
   ↓

第1步：用戶說需求（用自然語言）
   ↓
   "開發客戶管理功能"
   ↓

第2步：AI 立即閱讀對應的完整規格
   ↓
   閱讀：開發指南/客戶管理-完整規格.md
   理解：資料表、API、前端、業務邏輯
   ↓

第3步：確認需要修改的文檔
   ↓
   列出清單：
   - 使用手冊/客戶管理.md
   - 開發指南/客戶管理-完整規格.md
   - 系統資料/數據表清單.md（如有新表）
   - 系統資料/API清單.md（如有新API）
   - 其他相關文檔
   ↓

第4步：完全自主實現
   ↓
   資料表 → API → 前端
   （不問技術問題！）
   ↓

第5步：自行測試（必須！）⚠️
   ↓
   測試所有功能點
   測試邊界條件
   測試錯誤處理
   確認繁體中文正確顯示
   （絕對不讓用戶測試！）
   ↓

第6步：同步更新所有相關文檔
   ↓
   使用 UTF-8 編碼寫入
   確保繁體中文正確顯示
   ↓

第7步：執行一致性驗證
   ↓
   運行快速檢查命令
   確認所有數字與 SSOT 一致
   檢查交叉引用對稱性
   ↓

第8步：自動部署（必須！）⚠️
   ↓
   執行部署命令
   驗證部署成功
   測試線上環境
   （絕對不讓用戶手動部署！）
   ↓

第9步：確認無誤後說"已完成"
   ↓
   "已完成XX功能，已自行測試通過，已自動部署上線，所有相關文檔已同步更新！"
```

---

## 📚 必要文檔

### 開發任何功能前
1. **閱讀** 對應的完整規格（開發指南/XX管理-完整規格.md）
2. **遵循** 共用規範（開發指南/共用規範.md）
3. **確認** 不修改外部網站（🚨外部網站禁止修改清單.md）

---

## 🎯 技術決策

### 資料存儲
- 使用 Cloudflare D1（SQLite）
- 所有表都有 created_at, is_deleted
- 使用軟刪除

### 權限控制
- 只用 is_admin（管理員/員工）
- 前端路由：meta: { requireAdmin: true }
- 後端 API：requireAdmin middleware
- Service 層自動過濾資料

### API 設計
- RESTful 風格
- 統一響應格式
- 參數化查詢（防 SQL 注入）

### 前端開發
- Vue.js 3 + Composition API
- Tailwind CSS
- 使用共用組件

---

## 業務術語對照

| 業務術語 | 技術實現 |
|---------|---------|
| 客戶 | Clients 表 |
| 工時 | TimeLogs 表 |
| 請假 | LeaveApplications 表 |
| 特休 | 根據年資自動計算 |
| 加班 | work_type_id > 1 |
| 加權工時 | hours × rate_multiplier |
| 補休 | CompensatoryLeave 表 |
| 負責員工 | assignee_user_id |

---

## 🔄 一致性原則（極其重要！）

### 核心要求
```
任何修改都必須同步更新所有相關文檔！
```

### 修改檢查清單

#### 當你修改資料表時
- [ ] 更新 `系統資料/數據表清單.md`
- [ ] 更新對應的完整規格文檔
- [ ] 檢查是否影響其他功能的完整規格
- [ ] 更新 `完整功能清單.md` 中的統計數字

#### 當你新增/修改 API 時
- [ ] 更新 `系統資料/API清單.md`
- [ ] 更新對應的完整規格文檔
- [ ] 更新 `完整功能清單.md` 中的統計數字

#### 當你新增/修改功能時
- [ ] 更新對應的使用手冊
- [ ] 更新對應的完整規格
- [ ] 檢查所有相關功能的"相關功能"部分
- [ ] 確保雙向引用一致

#### 當你修改數字統計時
- [ ] **第一步：只在SSOT更新**
  - 資料表數量 → 只在 `系統資料/數據表清單.md` 中更新
  - API數量 → 只在 `系統資料/API清單.md` 中更新
- [ ] **第二步：搜索所有相關文檔**
  ```powershell
  # 搜索所有提到这个数字的地方
  Get-ChildItem -Path "docs" -Filter "*.md" -Recurse | Select-String "個.*表"
  ```
- [ ] **第三步：逐一更新，確保與SSOT一致**
- [ ] **第四步：再次驗證，確保沒有遺漏**

### 一致性驗證步驟

完成開發後，**執行手動驗證**（必須！）：

```powershell
# 1. 提取SSOT真相
Get-Content "docs\系統資料\數據表清單.md" | Select-String "資料表總覽"
Get-Content "docs\系統資料\API清單.md" | Select-String "總計"

# 2. 快速检查所有数字
cd docs
Get-ChildItem -Filter "*.md" -Recurse | Select-String "個.*[表API]" | ForEach-Object {
    if ($_.Line -match '(\d+)個') { "$($_.FileName): $($matches[1])個" }
} | Sort-Object | Get-Unique

# 3. 如果看到多个不同的数字，立即修复！
```

**必須逐項檢查：**

1. **單一真相源（SSOT）一致性**
   - 從 `系統資料/數據表清單.md` 提取真實的資料表數量
   - 從 `系統資料/API清單.md` 提取真實的API數量
   - 搜索所有文檔，確保數字與SSOT一致
   - ✅ **不依賴硬編碼數字，適用於未來任何變化**

2. **交叉引用對稱性**
   - 列出所有修改的文檔
   - 檢查"相關功能"的雙向引用
   - 例如：A引用B → 必須B也引用A

3. **格式規範一致性**
   - 檢查同類文檔使用相同結構
   - 檢查完整規格文檔的結尾格式

4. **完整性檢查**
   - 使用手冊都有"相關功能"部分
   - 完整規格都有必要章節

**詳細驗證步驟：** 見 [系統資料/一致性验证脚本.md](../系統資料/一致性验证脚本.md)

### 典型錯誤示例（必須避免！）

❌ **錯誤：** 只更新了一個文檔
```
修改了客戶管理-完整規格.md，但沒更新使用手冊/客戶管理.md
→ 導致文檔不一致
```

❌ **錯誤：** 只更新了單向引用
```
在A文檔中添加了對B的引用，但B沒有引用A
→ 導致引用不對稱
```

❌ **錯誤：** 數字統計不一致
```
完整功能清單.md 說 29個表
數據表清單.md 說 28個表
→ 導致統計混亂
```

✅ **正確：** 全局同步修改
```
1. 修改完整規格
2. 同步更新使用手冊
3. 更新所有統計數字
4. 檢查所有交叉引用
5. 驗證一致性
```

---

## 📝 編碼處理規範（極其重要！）

### 所有文件都是繁體中文 UTF-8

**讀取文件時：**
```javascript
// Node.js
const content = fs.readFileSync('file.md', 'utf-8');

// Python
with open('file.md', 'r', encoding='utf-8') as f:
    content = f.read()
```

**寫入文件時：**
```javascript
// Node.js
fs.writeFileSync('file.md', content, 'utf-8');

// Python
with open('file.md', 'w', encoding='utf-8') as f:
    f.write(content)
```

**PowerShell 腳本：**
```powershell
# 必須使用 UTF-8 with BOM
# 讀取
Get-Content "file.md" -Encoding UTF8

# 寫入
$content | Out-File "file.md" -Encoding UTF8
```

**搜索中文內容：**
```powershell
# Windows PowerShell
Get-ChildItem -Path "docs" -Filter "*.md" -Recurse | Select-String "繁體中文"

# 注意：确保终端也是 UTF-8 编码
```

### 常見編碼問題

❌ **錯誤：** 中文變成亂碼
```
原因：沒有指定 UTF-8 編碼
解決：明確指定 encoding='utf-8'
```

❌ **錯誤：** PowerShell 腳本執行錯誤
```
原因：腳本不是 UTF-8 with BOM
解決：使用支持 BOM 的編輯器保存，或：
[System.IO.File]::WriteAllText("script.ps1", $content, [System.Text.UTF8Encoding]::new($true))
```

❌ **錯誤：** 搜索找不到中文內容
```
原因：編碼不匹配
解決：確認文件是 UTF-8，終端也是 UTF-8
```

### 驗證編碼

**檢查文件編碼：**
```powershell
# 查看文件的前幾個字節
Get-Content "file.md" -Encoding Byte -TotalCount 3
# UTF-8 with BOM: EF BB BF
# UTF-8 without BOM: 其他
```

**測試中文顯示：**
```powershell
Get-Content "docs\README.md" -Encoding UTF8 | Select-Object -First 5
# 應該正確顯示繁體中文
```

---

## 🎯 快速參考：完整開發流程

```
開始前：
□ 編碼設定確認（UTF-8）
□ 閱讀對應的完整規格
□ 列出需要修改的文檔
□ 準備一致性檢查命令

開發中：
□ 實現功能（資料表、API、前端）
□ 同步更新所有相關文檔

完成後（必須全部完成才能說完成！）：
□ 自行測試所有功能 ⚠️
□ 執行一致性驗證
□ 自動部署上線 ⚠️
□ 驗證線上環境正常
□ 確認無誤後回報
```

---

## 🧪 自行測試規範（極其重要！）

### 測試原則

```
⚠️ 絕對不讓用戶測試！AI必須自己測試！
```

**為什麼必須自行測試：**
- 用戶不懂技術，無法有效測試
- 用戶的時間寶貴，不應浪費在測試上
- AI可以快速完整地測試所有場景
- 確保交付給用戶的是完全可用的功能

### 必須測試的項目

**1. 功能測試**
```
□ 正常流程能否正常運作
□ 所有按鈕、表單、連結都能正常使用
□ 資料能否正確儲存和讀取
□ 頁面能否正確顯示
```

**2. 邊界條件測試**
```
□ 空值輸入會怎樣
□ 超長文字會怎樣
□ 特殊字符（繁體中文、表情符號）會怎樣
□ 重複提交會怎樣
```

**3. 錯誤處理測試**
```
□ 必填欄位沒填會顯示錯誤訊息嗎
□ 格式錯誤會顯示清楚的提示嗎
□ 權限不足會正確攔截嗎
□ 資料不存在會正確處理嗎
```

**4. 權限測試**
```
□ 管理員能否訪問所有功能
□ 員工只能訪問自己的資料
□ 未登入用戶會被導向登入頁
```

**5. 中文編碼測試**
```
□ 繁體中文能否正確顯示
□ 儲存後讀取，中文沒有變成亂碼
□ 搜索繁體中文能否正常運作
```

**6. 資料一致性測試**
```
□ 新增後能否立即查詢到
□ 修改後資料是否正確更新
□ 刪除後（軟刪除）資料是否正確標記
```

### 測試方法

**後端 API 測試：**
```javascript
// 使用 console.log 驗證
const result = await apiFunction();
console.log('API結果：', result);

// 使用 assert 驗證
assert(result.success === true, 'API應該返回成功');
assert(result.data.length > 0, '應該有資料');
```

**前端功能測試：**
```javascript
// 在瀏覽器中手動測試
1. 打開頁面
2. 填寫表單
3. 點擊按鈕
4. 檢查結果
5. 查看 Console 有無錯誤
```

**資料庫測試：**
```sql
-- 檢查資料是否正確儲存
SELECT * FROM TableName WHERE id = 1;

-- 檢查中文是否正確
SELECT name FROM TableName WHERE name LIKE '%繁體%';
```

### 測試案例示例

**案例1：新增客戶**
```
測試步驟：
1. 打開新增客戶頁面
2. 填寫客戶資料（包含繁體中文）
3. 點擊儲存
4. 檢查是否成功
5. 到列表頁面確認新客戶出現
6. 檢查繁體中文顯示正確

預期結果：
✅ 儲存成功
✅ 列表中出現新客戶
✅ 繁體中文正確顯示
✅ 所有欄位資料正確
```

**案例2：權限控制**
```
測試步驟：
1. 以員工身份登入
2. 嘗試訪問管理員功能
3. 嘗試查看其他員工的資料

預期結果：
✅ 管理員功能顯示"權限不足"
✅ 只能看到自己的資料
✅ 不會出現錯誤畫面
```

**案例3：錯誤處理**
```
測試步驟：
1. 表單必填欄位留空
2. 點擊提交
3. 輸入錯誤格式的Email
4. 點擊提交

預期結果：
✅ 顯示清楚的錯誤訊息
✅ 用戶知道哪裡錯了
✅ 錯誤訊息是繁體中文
✅ 表單不會被清空
```

### 測試報告格式

**完成測試後，在回報時說明：**

```
已完成XX功能，測試報告如下：

✅ 功能測試：通過
   - 新增功能正常
   - 修改功能正常
   - 刪除功能正常
   - 查詢功能正常

✅ 邊界條件測試：通過
   - 空值處理正常
   - 超長文字處理正常
   - 特殊字符處理正常

✅ 錯誤處理測試：通過
   - 必填欄位驗證正常
   - 格式驗證正常
   - 錯誤訊息清楚

✅ 權限測試：通過
   - 管理員權限正常
   - 員工權限正常

✅ 中文編碼測試：通過
   - 繁體中文顯示正常
   - 儲存讀取正常

✅ 一致性驗證：通過
   - 所有文檔已同步更新
   - 數字統計一致

所有測試通過，可以交付使用！
```

### 如果測試失敗

```
❌ 不要說"已完成"
→ 立即修復問題
→ 重新測試
→ 直到所有測試通過
```

---

## 🚀 自動部署規範（極其重要！）

### 部署原則

```
⚠️ 絕對不讓用戶部署！AI必須自動部署！
```

**為什麼必須自動部署：**
- 用戶沒有技術背景，無法手動部署
- 用戶不應該接觸技術細節
- AI可以快速自動化部署
- 確保部署流程正確無誤

### 部署流程

**這是 Cloudflare Pages 專案，使用 Git 自動部署**

#### 步驟1：提交代碼到 Git
```bash
# 1. 檢查修改的文件
git status

# 2. 添加所有修改
git add .

# 3. 提交（用繁體中文說明）
git commit -m "新增XX功能：功能描述"

# 例如：
git commit -m "新增客戶管理功能：包含客戶列表、新增、編輯、刪除功能"
```

#### 步驟2：推送到遠端
```bash
# 推送到 main 分支
git push origin main
```

#### 步驟3：等待 Cloudflare 自動部署
```
Cloudflare Pages 會自動：
1. 偵測到新的 commit
2. 開始建置專案
3. 部署到線上環境
4. 通常需要 1-3 分鐘
```

#### 步驟4：驗證部署成功
```bash
# 1. 檢查 Cloudflare Pages 部署狀態
# 到 Cloudflare Dashboard 查看

# 2. 訪問線上網址，測試功能
# 打開瀏覽器測試新功能

# 3. 檢查以下項目：
□ 頁面能否正常打開
□ 新功能能否正常使用
□ 繁體中文顯示正確
□ API 正常運作
□ 沒有 Console 錯誤
```

### 部署前檢查清單

```
□ 所有測試已通過
□ 所有文檔已更新
□ 一致性驗證通過
□ 代碼沒有明顯錯誤
□ 沒有未完成的 TODO
```

### 完整部署腳本

```bash
#!/bin/bash
# 自動部署腳本

echo "開始自動部署..."

# 1. 檢查狀態
echo "檢查修改的文件..."
git status

# 2. 添加所有修改
echo "添加文件到 Git..."
git add .

# 3. 提交
echo "提交代碼..."
read -p "請輸入提交訊息: " message
git commit -m "$message"

# 4. 推送
echo "推送到遠端..."
git push origin main

echo "代碼已推送！Cloudflare Pages 將自動部署。"
echo "請稍等 1-3 分鐘，然後訪問網站驗證。"
```

### PowerShell 部署腳本

```powershell
# deploy.ps1 - Windows 自動部署腳本

Write-Host "開始自動部署..." -ForegroundColor Cyan

# 1. 檢查狀態
Write-Host "`n檢查修改的文件..." -ForegroundColor Yellow
git status

# 2. 添加所有修改
Write-Host "`n添加文件到 Git..." -ForegroundColor Yellow
git add .

# 3. 提交
$message = Read-Host "`n請輸入提交訊息（繁體中文）"
git commit -m $message

# 4. 推送
Write-Host "`n推送到遠端..." -ForegroundColor Yellow
git push origin main

if ($LASTEXITCODE -eq 0) {
    Write-Host "`n✅ 部署成功！" -ForegroundColor Green
    Write-Host "Cloudflare Pages 正在自動建置和部署..." -ForegroundColor Cyan
    Write-Host "請稍等 1-3 分鐘，然後訪問網站驗證。" -ForegroundColor Cyan
} else {
    Write-Host "`n❌ 部署失敗！請檢查錯誤訊息。" -ForegroundColor Red
}
```

### 部署後驗證

**必須確認以下項目：**

```
□ Cloudflare Pages 建置成功
□ 網站能正常訪問
□ 新功能正常運作
□ 繁體中文顯示正確
□ 沒有控制台錯誤
□ API 正常回應
□ 資料庫連接正常
```

### 驗證方法

```javascript
// 1. 打開瀏覽器開發者工具
// 2. 訪問網站
// 3. 測試新功能
// 4. 檢查 Console 有無錯誤
// 5. 檢查 Network 請求是否正常
```

### 部署報告格式

**部署完成後，回報給用戶：**

```
已完成XX功能，部署報告如下：

✅ 測試報告：
   - 所有測試通過

✅ 部署步驟：
   - 代碼已提交到 Git
   - 已推送到遠端倉庫
   - Cloudflare Pages 自動建置成功
   - 已部署到線上環境

✅ 線上驗證：
   - 網站正常訪問
   - 新功能正常運作
   - 繁體中文顯示正確
   - 沒有錯誤

✅ 訪問網址：
   https://your-site.pages.dev

功能已上線，可以立即使用！
```

### 如果部署失敗

```
❌ 不要說"已完成"
→ 查看錯誤訊息
→ 修復問題
→ 重新提交
→ 重新部署
→ 直到部署成功
```

### 常見部署問題

**問題1：Git 推送失敗**
```bash
# 檢查遠端連接
git remote -v

# 重新設定遠端
git remote set-url origin <你的倉庫URL>

# 強制推送（謹慎使用）
git push -f origin main
```

**問題2：Cloudflare 建置失敗**
```
1. 檢查 Cloudflare Dashboard 的錯誤日誌
2. 檢查是否有語法錯誤
3. 檢查是否缺少依賴
4. 修復後重新推送
```

**問題3：部署後功能異常**
```
1. 檢查瀏覽器 Console 錯誤
2. 檢查 API 是否正常
3. 檢查資料庫連接
4. 清除瀏覽器緩存重試
```

---

**遵循這些原則，確保全局一致性、正確的編碼處理、完整的測試，以及自動部署！**

