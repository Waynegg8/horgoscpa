# 規格行號標記規範

**目的：** 確保所有實現都能追溯到規格文檔，並在完成時能回到規格進行驗證

---

## 📋 核心規則

### 規則 1：標記規格行號
在 `MASTER_PLAN.md` 的每個任務項中，**必須標記對應規格文檔的行號範圍**

**格式：** `[規格:L行號]` 或 `[規格:L起始行-L結束行]`

### 規則 2：完成前驗證
標記任務完成前，**必須回到規格文檔對應行號處，逐一驗證實現是否完全符合規格要求**

---

## ✅ 正確示例

### 示例 1：單一功能（單行規格）
```markdown
- [x] 8.2.1 實現 `GET /api/v1/sop` 路由（查詢 SOP 列表，含創建者資訊）[規格:L83]
```

**對應規格（知識管理-完整規格.md，第 83 行）：**
```markdown
GET    /api/v1/sop                    權限：所有人
```

**驗證步驟：**
1. 打開 `docs/開發指南/知識管理-完整規格.md`
2. 跳到第 83 行
3. 確認已實現 `GET /api/v1/sop` 路由
4. 確認權限為「所有人」（authMiddleware，無額外限制）
5. ✅ 驗證通過，標記完成

---

### 示例 2：資料表創建（多行規格）
```markdown
- [x] 8.1.1 創建 `SOPDocuments` 表（SOP 文件，含版本控制、發布狀態、索引）[規格:L10-L30]
```

**對應規格（知識管理-完整規格.md，第 10-30 行）：**
```sql
CREATE TABLE SOPDocuments (
  sop_id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  category TEXT,
  tags TEXT,
  version INTEGER DEFAULT 1,
  is_published BOOLEAN DEFAULT 0,
  created_by INTEGER NOT NULL,
  ...
);

CREATE INDEX idx_sop_category ON SOPDocuments(category);
CREATE INDEX idx_sop_published ON SOPDocuments(is_published);
...
```

**驗證步驟：**
1. 打開 `docs/開發指南/知識管理-完整規格.md`
2. 讀取第 10-30 行的完整規格
3. 對照 `timesheet-api/schema.sql` 中的實現
4. 逐一檢查：
   - ✅ 所有欄位都已創建
   - ✅ 資料類型正確
   - ✅ DEFAULT 值正確
   - ✅ 所有索引都已創建
5. ✅ 驗證通過，標記完成

---

### 示例 3：業務邏輯（多處規格）
```markdown
- [x] 8.5.4 驗證業務邏輯（版本控制、發布流程、UNIQUE 約束、瀏覽次數）[規格:L271-L289]
```

**對應規格（知識管理-完整規格.md，第 271-289 行）：**
```markdown
## ✅ 業務規則

### SOP 發布流程
草稿狀態 → 編輯中 → 確認無誤 → 點擊發布 → 立即可見

### 版本控制（簡化）
每次編輯：version + 1
不保留歷史版本（簡化設計）

### 客戶 SOP 關聯規則
一個客戶可以關聯多個 SOP
同一個 SOP 可以關聯多個客戶
同一客戶不能重複關聯同一 SOP
```

**驗證步驟：**
1. 打開 `docs/開發指南/知識管理-完整規格.md`
2. 讀取第 271-289 行的業務規則
3. 對照實現：
   - ✅ 版本控制：`SOPRepository.update()` 中 `version = version + 1`
   - ✅ 發布流程：`publishSOP()` 方法將 `is_published` 設為 1
   - ✅ UNIQUE 約束：`ClientSOPLinks` 表有 `UNIQUE(client_id, sop_id)`
   - ✅ 瀏覽次數：`KnowledgeRepository.findById()` 中 `view_count = view_count + 1`
4. ✅ 驗證通過，標記完成

---

## 🔍 實際執行流程

### 開始新模組時：

**步驟 1：讀取規格並記錄行號**
```typescript
// 1. 完整讀取規格文檔
read_file("docs/開發指南/知識管理-完整規格.md")

// 2. 記錄關鍵部分的行號：
// - 資料表定義：L10-L72
// - API 端點列表：L76-L112
// - 業務規則：L271-L289
// - 測試案例：L293-L317
```

**步驟 2：在 MASTER_PLAN.md 中標記**
```markdown
#### 8.1 資料表創建
- [ ] 8.1.1 創建 `SOPDocuments` 表 [規格:L10-L30]
- [ ] 8.1.2 創建 `ClientSOPLinks` 表 [規格:L32-L50]
- [ ] 8.1.3 創建 `KnowledgeArticles` 表 [規格:L52-L72]

#### 8.2 SOP 管理 API
- [ ] 8.2.1 實現 `GET /api/v1/sop` [規格:L83]
- [ ] 8.2.2 實現 `POST /api/v1/sop` [規格:L84]
...
```

### 完成任務時：

**步驟 1：回到規格行號**
```typescript
// 準備標記 8.2.1 完成，先回到規格第 83 行
read_file("docs/開發指南/知識管理-完整規格.md", offset: 80, limit: 10)
// 讀取：
// L83: GET    /api/v1/sop    權限：所有人
```

**步驟 2：對照實現驗證**
```typescript
// 檢查實現：
// ✅ routes/knowledge.ts 中有 knowledge.get('/sop', authMiddleware, ...)
// ✅ 權限：authMiddleware（所有人可用，無額外限制）
// ✅ 響應格式：含 creator_name（通過 JOIN）
```

**步驟 3：標記完成**
```markdown
- [x] 8.2.1 實現 `GET /api/v1/sop` 路由（查詢 SOP 列表，含創建者資訊）[規格:L83]
```

---

## ❌ 錯誤示例

### 錯誤 1：沒有標記行號
```markdown
❌ - [x] 8.2.1 實現 `GET /api/v1/sop` 路由
```

**問題：** 無法追溯到規格，無法驗證

**修正：**
```markdown
✅ - [x] 8.2.1 實現 `GET /api/v1/sop` 路由 [規格:L83]
```

---

### 錯誤 2：行號範圍不正確
```markdown
❌ - [x] 8.1.1 創建 `SOPDocuments` 表 [規格:L10-L15]
```

**問題：** 規格實際到第 30 行（包含索引），範圍不完整

**修正：**
```markdown
✅ - [x] 8.1.1 創建 `SOPDocuments` 表 [規格:L10-L30]
```

---

### 錯誤 3：標記完成前沒有回到規格驗證
```markdown
// 實現完就標記完成，沒有回到規格第 83 行確認
❌ - [x] 8.2.1 實現 `GET /api/v1/sop` 路由 [規格:L83]
```

**正確做法：**
1. 實現完成
2. 打開規格文檔，跳到第 83 行
3. 逐一檢查：API 端點、權限、響應格式
4. 確認無誤後再標記完成

---

## 📝 標記規範總結

### 格式規範
- **單行規格：** `[規格:L83]`
- **多行規格：** `[規格:L10-L30]`
- **多處規格：** `[規格:L10-L30, L271-L289]`

### 驗證清單
在標記任務完成前，必須確認：
- [ ] 已打開規格文檔
- [ ] 已跳到標記的行號
- [ ] 已完整閱讀該行號範圍的規格
- [ ] 已對照實現逐一驗證
- [ ] 所有規格要求都已實現
- [ ] 響應格式符合規格示例
- [ ] 業務邏輯符合規格說明

---

## 🎯 為什麼需要這個規範？

### 問題：之前的錯誤
- ❌ 只讀前 200 行就開始實現
- ❌ 實現後不回去檢查規格
- ❌ 遺漏關鍵功能和業務邏輯
- ❌ 響應格式不符合規格示例

### 解決方案：行號標記
- ✅ 強制完整讀取規格（記錄行號）
- ✅ 實現時有明確的規格引用
- ✅ 完成時必須回到規格驗證
- ✅ 可追溯、可驗證、不遺漏

---

**這個規範是核心原則的一部分，必須嚴格遵守！**

