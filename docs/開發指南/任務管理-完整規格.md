# ä»»å‹™ç®¡ç† - å®Œæ•´é–‹ç™¼è¦æ ¼

**çµ¦ AIï¼š** å¯¦ç¾ä»»å‹™ç®¡ç†åŠŸèƒ½çš„å®Œæ•´æŠ€è¡“è¦æ ¼

---

## ğŸ’¾ è³‡æ–™è¡¨

### TaskTemplatesï¼ˆä»»å‹™æ¨¡æ¿ï¼‰
```sql
CREATE TABLE TaskTemplates (
  template_id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_name TEXT NOT NULL,
  service_id INTEGER,
  description TEXT,
  estimated_days INTEGER,
  related_sop_id INTEGER,           -- é—œè¯çš„ SOP æ–‡ä»¶
  is_client_specific BOOLEAN DEFAULT 0,  -- æ˜¯å¦ç‚ºå®¢æˆ¶å°ˆå±¬æ¨¡æ¿
  specific_client_id TEXT,          -- å°ˆå±¬å®¢æˆ¶IDï¼ˆè‹¥ç‚ºå®¢æˆ¶å°ˆå±¬ï¼‰
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (service_id) REFERENCES Services(service_id),
  FOREIGN KEY (related_sop_id) REFERENCES KnowledgeBase(knowledge_id),
  FOREIGN KEY (specific_client_id) REFERENCES Clients(client_id)
);

CREATE INDEX idx_task_templates_client ON TaskTemplates(specific_client_id);
```

### TaskStageTemplatesï¼ˆéšæ®µæ¨¡æ¿ï¼‰
```sql
CREATE TABLE TaskStageTemplates (
  stage_template_id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_id INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_order INTEGER NOT NULL,
  estimated_days INTEGER,
  description TEXT,
  
  FOREIGN KEY (template_id) REFERENCES TaskTemplates(template_id) ON DELETE CASCADE
);

CREATE INDEX idx_stage_templates_template ON TaskStageTemplates(template_id);
CREATE INDEX idx_stage_templates_order ON TaskStageTemplates(template_id, stage_order);
```

### ActiveTasksï¼ˆåŸ·è¡Œä¸­ä»»å‹™ï¼‰
```sql
CREATE TABLE ActiveTasks (
  task_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_service_id INTEGER NOT NULL,
  template_id INTEGER NOT NULL,
  task_name TEXT NOT NULL,
  start_date TEXT,
  due_date TEXT,
  completed_date TEXT,
  status TEXT DEFAULT 'pending',    -- pending, in_progress, completed, cancelled
  assignee_user_id INTEGER,
  related_sop_id INTEGER,           -- é—œè¯çš„é€šç”¨ SOP æ–‡ä»¶
  client_specific_sop_id INTEGER,   -- å®¢æˆ¶å°ˆå±¬ SOP æ–‡ä»¶
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,                      -- â­ åˆªé™¤æ™‚é–“
  deleted_by INTEGER,                   -- â­ åˆªé™¤äººå“¡
  
  FOREIGN KEY (client_service_id) REFERENCES ClientServices(client_service_id),
  FOREIGN KEY (template_id) REFERENCES TaskTemplates(template_id),
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id),
  FOREIGN KEY (related_sop_id) REFERENCES KnowledgeBase(knowledge_id),
  FOREIGN KEY (client_specific_sop_id) REFERENCES KnowledgeBase(knowledge_id),
  FOREIGN KEY (deleted_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_active_tasks_service ON ActiveTasks(client_service_id);
CREATE INDEX idx_active_tasks_assignee ON ActiveTasks(assignee_user_id);
CREATE INDEX idx_active_tasks_status ON ActiveTasks(status);
CREATE INDEX idx_active_tasks_due_date ON ActiveTasks(due_date);
CREATE INDEX idx_active_tasks_assignee_status ON ActiveTasks(assignee_user_id, status, due_date);  -- â­ å„€è¡¨æ¿æŸ¥è©¢å°ˆç”¨
CREATE INDEX idx_active_tasks_due_status ON ActiveTasks(due_date, status);  -- â­ é€¾æœŸä»»å‹™æª¢æ¸¬å°ˆç”¨
```

**ç´¢å¼•ä½¿ç”¨èªªæ˜ï¼š**
```
idx_active_tasks_assignee_status: â­ æ–°å¢
  ç”¨é€”ï¼šå„€è¡¨æ¿ã€Œæˆ‘çš„ä»»å‹™ã€æŸ¥è©¢
  æŸ¥è©¢ï¼šWHERE assignee_user_id = ? AND status IN ('pending', 'in_progress') ORDER BY due_date
  æ•ˆèƒ½æå‡ï¼šå„€è¡¨æ¿è¼‰å…¥é€Ÿåº¦æå‡60-80%
  
idx_active_tasks_due_status: â­ æ–°å¢
  ç”¨é€”ï¼šCron Jobæª¢æ¸¬é€¾æœŸä»»å‹™
  æŸ¥è©¢ï¼šWHERE due_date < date('now') AND status != 'completed'
```

### ActiveTaskStagesï¼ˆä»»å‹™éšæ®µé€²åº¦ï¼‰
```sql
CREATE TABLE ActiveTaskStages (
  active_stage_id INTEGER PRIMARY KEY AUTOINCREMENT,
  task_id INTEGER NOT NULL,
  stage_template_id INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_order INTEGER NOT NULL,
  status TEXT DEFAULT 'pending',    -- pending, in_progress, completed
  started_at TEXT,
  completed_at TEXT,
  assignee_user_id INTEGER,
  notes TEXT,
  
  FOREIGN KEY (task_id) REFERENCES ActiveTasks(task_id) ON DELETE CASCADE,
  FOREIGN KEY (stage_template_id) REFERENCES TaskStageTemplates(stage_template_id),
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id)
);

CREATE INDEX idx_active_stages_task ON ActiveTaskStages(task_id);
```

### ClientServicesï¼ˆå®¢æˆ¶æœå‹™é…ç½®ï¼‰
```sql
CREATE TABLE ClientServices (
  client_service_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  service_id INTEGER NOT NULL,
  frequency_id INTEGER NOT NULL,
  template_id INTEGER,              -- â­ é è¨­ä»»å‹™æ¨¡æ¿ï¼ˆé€šç”¨ï¼‰
  custom_template_id INTEGER,       -- â­ å®¢æˆ¶å°ˆå±¬æ¨¡æ¿ï¼ˆå„ªå…ˆä½¿ç”¨ï¼‰
  start_date TEXT NOT NULL,
  end_date TEXT,
  status TEXT DEFAULT 'active',     -- 'active', 'suspended', 'expired', 'cancelled'
  trigger_months TEXT,              -- JSON: [1,3,5,7,9,11]
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (client_id) REFERENCES Clients(client_id),
  FOREIGN KEY (service_id) REFERENCES Services(service_id),
  FOREIGN KEY (frequency_id) REFERENCES ServiceFrequencyTypes(frequency_id),
  FOREIGN KEY (template_id) REFERENCES TaskTemplates(template_id),
  FOREIGN KEY (custom_template_id) REFERENCES TaskTemplates(template_id),
  UNIQUE(client_id, service_id)
);

CREATE INDEX idx_client_services_client ON ClientServices(client_id);
CREATE INDEX idx_client_services_service ON ClientServices(service_id);
CREATE INDEX idx_client_services_status ON ClientServices(status);
```

**æ¬„ä½èªªæ˜ï¼š**
```
template_id:
  - é€šç”¨ä»»å‹™æ¨¡æ¿ï¼ˆå¦‚ï¼šã€Œè¨˜å¸³æœå‹™æµç¨‹ã€ï¼‰
  - é©ç”¨æ–¼å¤§éƒ¨åˆ†å®¢æˆ¶

custom_template_id:
  - å®¢æˆ¶å°ˆå±¬æ¨¡æ¿ï¼ˆå¦‚ï¼šã€ŒJKLä¼æ¥­å°ˆå±¬è¨˜å¸³æµç¨‹ã€ï¼‰
  - å¦‚æœæœ‰å¡«ï¼Œå„ªå…ˆä½¿ç”¨æ­¤æ¨¡æ¿ç”Ÿæˆä»»å‹™
  - ç•™ç©º = ä½¿ç”¨é€šç”¨æ¨¡æ¿

ç¯„ä¾‹ï¼š
å®¢æˆ¶A - è¨˜å¸³æœå‹™ï¼š
  template_id = 1ï¼ˆè¨˜å¸³æœå‹™æµç¨‹ï¼‰
  custom_template_id = NULL
  â†’ ä½¿ç”¨é€šç”¨æ¨¡æ¿

å®¢æˆ¶JKL - è¨˜å¸³æœå‹™ï¼š
  template_id = 1ï¼ˆè¨˜å¸³æœå‹™æµç¨‹ï¼‰
  custom_template_id = 15ï¼ˆJKLä¼æ¥­å°ˆå±¬ï¼‰
  â†’ å„ªå…ˆä½¿ç”¨å°ˆå±¬æ¨¡æ¿ï¼ˆ15ï¼‰
```

---

## ğŸ”Œ API ç«¯é»

### ä»»å‹™æ¨¡æ¿ç®¡ç†

âš ï¸ **å°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆ** - å“¡å·¥å¯å”åŠ©å»ºç«‹ä»»å‹™æ¨¡æ¿

```
GET    /api/v1/task-templates                æŸ¥è©¢æ¨¡æ¿åˆ—è¡¨ï¼ˆæ‰€æœ‰äººï¼‰
POST   /api/v1/task-templates                æ–°å¢æ¨¡æ¿ï¼ˆæ‰€æœ‰äººï¼Œå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
PUT    /api/v1/task-templates/:id            æ›´æ–°æ¨¡æ¿ï¼ˆæ‰€æœ‰äººï¼Œå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
DELETE /api/v1/task-templates/:id            åˆªé™¤æ¨¡æ¿ï¼ˆæ‰€æœ‰äººï¼Œå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
POST   /api/v1/task-templates/:id/copy       è¤‡è£½æ¨¡æ¿ï¼ˆæ‰€æœ‰äººï¼Œå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
```

### å®¢æˆ¶æœå‹™è¨­å®š

âš ï¸ **å°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆ** - å“¡å·¥å¯è¨­å®šå®¢æˆ¶æœå‹™ï¼ˆè‡ªå‹•ç”¢ç”Ÿä»»å‹™ï¼‰

```
GET    /api/v1/client-services                     æ¬Šé™ï¼šæ‰€æœ‰äºº
POST   /api/v1/client-services                     æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
PUT    /api/v1/client-services/:id                 æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
DELETE /api/v1/client-services/:id                 æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
GET    /api/v1/clients/:clientId/services          æ¬Šé™ï¼šæ‰€æœ‰äºº
GET    /api/v1/clients/:clientId/available-templates  æŸ¥è©¢å¯ç”¨æ¨¡æ¿ï¼ˆé€šç”¨+å°ˆå±¬ï¼‰â­
```

**æ–°å¢å®¢æˆ¶æœå‹™ç¯„ä¾‹ï¼š**
```json
// POST /api/v1/client-services
{
  "client_id": "12345678",
  "service_id": 1,              // è¨˜å¸³æœå‹™
  "frequency_id": 1,            // æ¯æœˆ
  "template_id": 5,             // é€šç”¨æ¨¡æ¿ï¼šè¨˜å¸³æœå‹™æµç¨‹
  "custom_template_id": null,   // â­ ç„¡å°ˆå±¬æ¨¡æ¿ï¼ˆä½¿ç”¨é€šç”¨ï¼‰
  "start_date": "2025-11-01"
}

// å›æ‡‰
{
  "success": true,
  "data": {
    "client_service_id": 123,
    "client_id": "12345678",
    "service_id": 1,
    "template_id": 5,
    "custom_template_id": null,
    "template_name": "è¨˜å¸³æœå‹™æµç¨‹ï¼ˆé€šç”¨ï¼‰",
    "trigger_months": [1,2,3,4,5,6,7,8,9,10,11,12]
  }
}
```

**ä½¿ç”¨å®¢æˆ¶å°ˆå±¬æ¨¡æ¿ç¯„ä¾‹ï¼š**
```json
// POST /api/v1/client-servicesï¼ˆJKLä¼æ¥­ï¼‰
{
  "client_id": "87654321",
  "service_id": 1,              // è¨˜å¸³æœå‹™
  "frequency_id": 1,            // æ¯æœˆ
  "template_id": 5,             // é€šç”¨æ¨¡æ¿ï¼ˆå‚™ç”¨ï¼‰
  "custom_template_id": 15,     // â­ JKLä¼æ¥­å°ˆå±¬è¨˜å¸³æµç¨‹
  "start_date": "2025-11-01"
}

// å›æ‡‰
{
  "success": true,
  "data": {
    "client_service_id": 124,
    "template_id": 5,
    "custom_template_id": 15,
    "template_name": "JKLä¼æ¥­å°ˆå±¬è¨˜å¸³æµç¨‹",  // â­ é¡¯ç¤ºå°ˆå±¬æ¨¡æ¿åç¨±
    "is_using_custom_template": true
  }
}
```

**æŸ¥è©¢å¯ç”¨æ¨¡æ¿APIï¼š**
```json
// GET /api/v1/clients/87654321/available-templates?service_id=1

{
  "success": true,
  "data": {
    "general_templates": [
      { "template_id": 5, "template_name": "è¨˜å¸³æœå‹™æµç¨‹", "is_client_specific": false }
    ],
    "client_specific_templates": [
      { "template_id": 15, "template_name": "JKLä¼æ¥­å°ˆå±¬è¨˜å¸³æµç¨‹", "is_client_specific": true }
    ]
  }
}
```

### ä»»å‹™é€²åº¦è¿½è¹¤
```
GET    /api/v1/tasks                               æŸ¥è©¢ä»»å‹™åˆ—è¡¨
GET    /api/v1/tasks/:id                           æŸ¥è©¢ä»»å‹™è©³æƒ…ï¼ˆå«SOPï¼‰
POST   /api/v1/tasks/:id/stages/:stageId/start     é–‹å§‹éšæ®µ
POST   /api/v1/tasks/:id/stages/:stageId/complete  å®Œæˆéšæ®µ
PUT    /api/v1/tasks/:id                           æ›´æ–°ä»»å‹™
GET    /api/v1/tasks/:id/sop                       æŸ¥è©¢ä»»å‹™é—œè¯çš„SOP
```

**æŸ¥è©¢ä»»å‹™è©³æƒ…ï¼ˆå«SOPï¼‰ç¯„ä¾‹ï¼š**
```json
GET /api/v1/tasks/123

// å›æ‡‰
{
  "success": true,
  "data": {
    "task_id": 123,
    "task_name": "ABCç§‘æŠ€ - 12æœˆè¨˜å¸³æœå‹™",
    "client_id": "12345678",
    "company_name": "ABCç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸",
    "status": "in_progress",
    "assignee_user_id": 1,
    "assignee_name": "ç‹å°æ˜",
    "due_date": "2025-12-31",
    "related_sop": {
      "knowledge_id": 5,
      "title": "è¨˜å¸³æœå‹™æ¨™æº–ä½œæ¥­æµç¨‹",
      "version": "v2.1"
    },
    "client_specific_sop": {
      "knowledge_id": 15,
      "title": "ABCç§‘æŠ€ - è¨˜å¸³ç‰¹æ®Šæ³¨æ„äº‹é …",
      "version": "v1.0"
    },
    "stages": [
      {
        "active_stage_id": 1,
        "stage_name": "æ”¶é›†æ†‘è­‰",
        "status": "completed"
      },
      {
        "active_stage_id": 2,
        "stage_name": "å»ºæª”åˆ†éŒ„",
        "status": "in_progress"
      },
      {
        "active_stage_id": 3,
        "stage_name": "ç”¢å‡ºå ±è¡¨",
        "status": "pending"
      }
    ]
  }
}
```

---

## ğŸ¨ å‰ç«¯çµ„ä»¶

### TaskBoardPage.vueï¼ˆçœ‹æ¿è¦–åœ–ï¼‰
```vue
<template>
  <div class="task-board">
    <h1>ä»»å‹™ç®¡ç†</h1>
    
    <div class="view-switcher">
      <button @click="view = 'board'">çœ‹æ¿</button>
      <button @click="view = 'list'">åˆ—è¡¨</button>
    </div>

    <!-- çœ‹æ¿è¦–åœ– -->
    <div v-if="view === 'board'" class="kanban-board">
      <div class="column">
        <h3>å¾…é–‹å§‹</h3>
        <TaskCard 
          v-for="task in pendingTasks" 
          :key="task.task_id"
          :task="task"
          @click="openTaskDetail(task)"
        />
      </div>
      
      <div class="column">
        <h3>é€²è¡Œä¸­</h3>
        <TaskCard 
          v-for="task in inProgressTasks" 
          :key="task.task_id"
          :task="task"
        />
      </div>
      
      <div class="column">
        <h3>å·²å®Œæˆ</h3>
        <TaskCard 
          v-for="task in completedTasks" 
          :key="task.task_id"
          :task="task"
        />
      </div>
    </div>

    <!-- åˆ—è¡¨è¦–åœ– -->
    <DataTable 
      v-else
      :columns="columns"
      :data="allTasks"
    />
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';
import { getTasks } from '@/api/tasks';

const view = ref('board');
const tasks = ref([]);

const pendingTasks = computed(() => 
  tasks.value.filter(t => t.status === 'pending')
);
const inProgressTasks = computed(() => 
  tasks.value.filter(t => t.status === 'in_progress')
);
const completedTasks = computed(() => 
  tasks.value.filter(t => t.status === 'completed')
);

onMounted(async () => {
  const response = await getTasks();
  tasks.value = response.data;
});
</script>
```

### TaskDetailModal.vue
```vue
<template>
  <Modal :show="show" :title="task.task_name" size="lg">
    <div class="task-stages">
      <div 
        v-for="stage in stages" 
        :key="stage.active_stage_id"
        :class="['stage', `stage-${stage.status}`]"
      >
        <div class="stage-header">
          <span class="stage-number">{{ stage.stage_order }}</span>
          <h4>{{ stage.stage_name }}</h4>
          <span :class="['status', stage.status]">
            {{ statusText[stage.status] }}
          </span>
        </div>
        
        <div class="stage-info">
          <p v-if="stage.started_at">é–‹å§‹ï¼š{{ formatDate(stage.started_at) }}</p>
          <p v-if="stage.completed_at">å®Œæˆï¼š{{ formatDate(stage.completed_at) }}</p>
        </div>
        
        <div v-if="stage.status === 'pending'" class="stage-actions">
          <!-- â­ æª¢æŸ¥æ˜¯å¦å¯ä»¥é–‹å§‹ï¼ˆå‰ä¸€éšæ®µå·²å®Œæˆï¼‰-->
          <StyledButton 
            @click="startStage(stage.active_stage_id)"
            :disabled="!canStartStage(stage)"
          >
            é–‹å§‹æ­¤éšæ®µ
          </StyledButton>
          <p v-if="!canStartStage(stage)" class="hint-disabled">
            âš ï¸ è«‹å…ˆå®Œæˆã€Œ{{ getPreviousStageName(stage) }}ã€ï¼ˆéšæ®µ{{ stage.stage_order - 1 }}ï¼‰
          </p>
        </div>
        
        <div v-if="stage.status === 'in_progress'" class="stage-actions">
          <StyledButton @click="completeStage(stage.active_stage_id)">
            å®Œæˆæ­¤éšæ®µ
          </StyledButton>
        </div>
      </div>
    </div>
  </Modal>
</template>

<script setup>
import { ref, computed } from 'vue';
import { startStage as apiStartStage, completeStage as apiCompleteStage } from '@/api/tasks';

const props = defineProps({
  show: Boolean,
  task: Object
});

const emit = defineEmits(['updated']);

const stages = computed(() => props.task?.stages || []);

const statusText = {
  'pending': 'å¾…é–‹å§‹',
  'in_progress': 'é€²è¡Œä¸­',
  'completed': 'å·²å®Œæˆ'
};

// â­ æª¢æŸ¥æ˜¯å¦å¯ä»¥é–‹å§‹è©²éšæ®µï¼ˆå‰ä¸€éšæ®µå·²å®Œæˆï¼‰
function canStartStage(stage) {
  // éšæ®µ1ï¼šæ°¸é å¯ä»¥é–‹å§‹
  if (stage.stage_order === 1) {
    return true;
  }
  
  // éšæ®µ2+ï¼šæª¢æŸ¥å‰ä¸€éšæ®µæ˜¯å¦å·²å®Œæˆ
  const previousStage = stages.value.find(s => s.stage_order === stage.stage_order - 1);
  
  return previousStage && previousStage.status === 'completed';
}

// â­ å–å¾—å‰ä¸€éšæ®µçš„åç¨±ï¼ˆç”¨æ–¼UIæç¤ºï¼‰
function getPreviousStageName(stage) {
  if (stage.stage_order === 1) {
    return '';
  }
  
  const previousStage = stages.value.find(s => s.stage_order === stage.stage_order - 1);
  return previousStage ? previousStage.stage_name : `éšæ®µ${stage.stage_order - 1}`;
}

async function startStage(stageId) {
  try {
    await apiStartStage(props.task.task_id, stageId);
    emit('updated');
  } catch (error) {
    alert('é–‹å§‹å¤±æ•—ï¼š' + error.message);
  }
}

async function completeStage(stageId) {
  try {
    await apiCompleteStage(props.task.task_id, stageId);
    emit('updated');
  } catch (error) {
    alert('å®Œæˆå¤±æ•—ï¼š' + error.message);
  }
}
</script>

<style scoped>
.stage.stage-completed {
  background: #d1fae5;
  border-left: 4px solid #10b981;
}

.stage.stage-in_progress {
  background: #dbeafe;
  border-left: 4px solid #3b82f6;
}

.stage.stage-pending {
  background: #f3f4f6;
  border-left: 4px solid #9ca3af;
}

.hint-disabled {
  color: #ef4444;
  font-size: 0.875rem;
  margin-top: 0.5rem;
}
</style>
```

---

## ğŸ”§ å¾Œç«¯å¯¦ç¾

### TaskService
```typescript
class TaskService {
  async getTasks(filters, user) {
    // å“¡å·¥åªèƒ½çœ‹è‡ªå·±çš„ä»»å‹™
    if (!user.is_admin) {
      filters.assignee_user_id = user.user_id;
    }
    
    return await this.repository.findAll(filters);
  }
  
  async startStage(taskId, stageId, user) {
    // 1. é©—è­‰ä»»å‹™å­˜åœ¨
    const task = await this.taskRepo.findById(taskId);
    if (!task) {
      throw new NotFoundError('ä»»å‹™ä¸å­˜åœ¨');
    }
    
    // 2. é©—è­‰æ¬Šé™
    if (!user.is_admin && task.assignee_user_id !== user.user_id) {
      throw new ForbiddenError('ç„¡æ¬Šé™æ“ä½œæ­¤ä»»å‹™');
    }
    
    // 3. æŸ¥è©¢è©²éšæ®µè³‡è¨Š
    const stage = await this.stageRepo.findById(stageId);
    if (!stage) {
      throw new NotFoundError('éšæ®µä¸å­˜åœ¨');
    }
    
    // 4. â­ æª¢æŸ¥æ˜¯å¦æŒ‰é †åºï¼ˆå¿…é ˆå‰ä¸€éšæ®µå·²å®Œæˆï¼‰
    if (stage.stage_order > 1) {
      const previousStage = await this.db.prepare(`
        SELECT status, stage_name FROM ActiveTaskStages
        WHERE task_id = ? AND stage_order = ?
      `).bind(taskId, stage.stage_order - 1).first();
      
      if (previousStage && previousStage.status !== 'completed') {
        throw new ValidationError(
          `è«‹å…ˆå®Œæˆã€Œ${previousStage.stage_name}ã€ï¼ˆéšæ®µ${stage.stage_order - 1}ï¼‰`
        );
      }
    }
    
    // 5. æ›´æ–°éšæ®µç‹€æ…‹
    await this.stageRepo.update(stageId, {
      status: 'in_progress',
      started_at: new Date(),
      assignee_user_id: user.user_id
    });
    
    // 6. æ›´æ–°ä»»å‹™ç‹€æ…‹
    await this.taskRepo.update(taskId, {
      status: 'in_progress'
    });
    
    return { success: true };
  }
  
  async completeStage(taskId, stageId, user) {
    // 1. é©—è­‰æ¬Šé™
    const task = await this.taskRepo.findById(taskId);
    if (!user.is_admin && task.assignee_user_id !== user.user_id) {
      throw new ForbiddenError('ç„¡æ¬Šé™æ“ä½œæ­¤ä»»å‹™');
    }
    
    // 2. æŸ¥è©¢è©²éšæ®µè³‡è¨Š
    const stage = await this.stageRepo.findById(stageId);
    if (!stage) {
      throw new NotFoundError('éšæ®µä¸å­˜åœ¨');
    }
    
    // â­ 3. æª¢æŸ¥è©²éšæ®µæ˜¯å¦ç‚ºã€Œé€²è¡Œä¸­ã€
    if (stage.status !== 'in_progress') {
      throw new ValidationError('åªèƒ½å®Œæˆã€Œé€²è¡Œä¸­ã€çš„éšæ®µï¼Œè«‹å…ˆé–‹å§‹æ­¤éšæ®µ');
    }
    
    // 4. å®Œæˆç•¶å‰éšæ®µ
    await this.stageRepo.update(stageId, {
      status: 'completed',
      completed_at: new Date()
    });
    
    // 5. æª¢æŸ¥æ˜¯å¦æ‰€æœ‰éšæ®µéƒ½å®Œæˆ
    const allStages = await this.stageRepo.findByTaskId(taskId);
    const allCompleted = allStages.every(s => s.status === 'completed');
    
    if (allCompleted) {
      // 6. å®Œæˆæ•´å€‹ä»»å‹™
      await this.taskRepo.update(taskId, {
        status: 'completed',
        completed_date: new Date()
      });
    }
    
    return { success: true };
  }
}
```

---

## â° è‡ªå‹•åŒ–ï¼šä»»å‹™è‡ªå‹•ç”Ÿæˆ

```typescript
/**
 * Cron Job: æ¯æœˆ1æ—¥åŸ·è¡Œ
 * é…ç½®ï¼šwrangler.toml crons = ["0 0 1 * *"]
 */
async function generateMonthlyTasks(env) {
  const currentMonth = new Date().getMonth() + 1;
  
  // 1. æŸ¥è©¢æ‰€æœ‰å•Ÿç”¨ä¸­çš„å®¢æˆ¶æœå‹™
  const services = await env.DB.prepare(`
    SELECT * FROM ClientServices 
    WHERE status = 'active' AND is_deleted = 0
  `).all();
  
  for (const service of services.results) {
    // 2. æª¢æŸ¥æ˜¯å¦åœ¨è§¸ç™¼æœˆä»½
    const triggerMonths = JSON.parse(service.trigger_months);
    if (!triggerMonths.includes(currentMonth)) {
      continue;
    }
    
    // 3. æŸ¥è©¢ä»»å‹™æ¨¡æ¿ï¼ˆâ­ å„ªå…ˆä½¿ç”¨å®¢æˆ¶å°ˆå±¬æ¨¡æ¿ï¼‰
    let template;
    
    // å„ªå…ˆï¼šå®¢æˆ¶å°ˆå±¬æ¨¡æ¿
    if (service.custom_template_id) {
      template = await env.DB.prepare(`
        SELECT * FROM TaskTemplates 
        WHERE template_id = ?
          AND (is_client_specific = 0 OR specific_client_id = ?)
      `).bind(service.custom_template_id, service.client_id).first();
      
      if (template) {
        console.log(`ä½¿ç”¨å®¢æˆ¶å°ˆå±¬æ¨¡æ¿ï¼š${template.template_name}`);
      }
    }
    
    // å…¶æ¬¡ï¼šé€šç”¨æ¨¡æ¿
    if (!template && service.template_id) {
      template = await env.DB.prepare(
        'SELECT * FROM TaskTemplates WHERE template_id = ?'
      ).bind(service.template_id).first();
      
      if (template) {
        console.log(`ä½¿ç”¨é€šç”¨æ¨¡æ¿ï¼š${template.template_name}`);
      }
    }
    
    // å¦‚æœéƒ½æ²’æœ‰æ¨¡æ¿ï¼Œè·³é
    if (!template) {
      console.warn(`å®¢æˆ¶ ${service.client_id} æœå‹™ ${service.service_id} ç¼ºå°‘ä»»å‹™æ¨¡æ¿`);
      continue;
    }
    
    // 4. æŸ¥è©¢å®¢æˆ¶å°ˆå±¬SOPï¼ˆå¦‚æœæœ‰ï¼‰
    const clientSpecificSOP = await env.DB.prepare(`
      SELECT knowledge_id FROM ClientSOPLinks
      WHERE client_id = ? AND service_id = ?
    `).bind(service.client_id, service.service_id).first();
    
    // 5. æŸ¥è©¢å®¢æˆ¶è² è²¬äºº
    const client = await env.DB.prepare(`
      SELECT assignee_user_id FROM Clients WHERE client_id = ?
    `).bind(service.client_id).first();
    
    // 6. ç”Ÿæˆä»»å‹™ï¼ˆè‡ªå‹•é€£çµSOPï¼‰
    const taskResult = await env.DB.prepare(`
      INSERT INTO ActiveTasks (
        client_service_id, template_id, task_name,
        start_date, due_date, assignee_user_id,
        related_sop_id, client_specific_sop_id, status
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'pending')
    `).bind(
      service.client_service_id,
      template.template_id,
      `${service.client_id} - ${template.template_name}`,
      new Date().toISOString().split('T')[0],
      addDays(new Date(), template.estimated_days || 15),
      client?.assignee_user_id || null,
      template.related_sop_id || null,           // æ¨¡æ¿é—œè¯çš„é€šç”¨SOP
      clientSpecificSOP?.knowledge_id || null    // å®¢æˆ¶å°ˆå±¬SOP
    ).run();
    
    const taskId = taskResult.meta.last_row_id;
    
    // 7. ç”Ÿæˆéšæ®µ
    const stages = await env.DB.prepare(
      'SELECT * FROM TaskStageTemplates WHERE template_id = ? ORDER BY stage_order'
    ).bind(template.template_id).all();
    
    for (const stage of stages.results) {
      await env.DB.prepare(`
        INSERT INTO ActiveTaskStages (
          task_id, stage_template_id, stage_name, stage_order, status
        )
        VALUES (?, ?, ?, ?, 'pending')
      `).bind(
        taskId,
        stage.stage_template_id,
        stage.stage_name,
        stage.stage_order
      ).run();
    }
    
    console.log(`å·²ç”Ÿæˆä»»å‹™ï¼š${taskId} - ${template.template_name}`);
  }
  
  console.log(`æœˆåº¦ä»»å‹™ç”Ÿæˆå®Œæˆï¼šç•¶æœˆ ${currentMonth}`);
}
```

---

## âœ… æ¥­å‹™è¦å‰‡

### ä»»å‹™ç”Ÿæˆè¦å‰‡
```
å®¢æˆ¶æœå‹™è¨­å®šï¼š
- æœå‹™ï¼šè¨˜å¸³æœå‹™
- é€±æœŸï¼šé›™æœˆ
- è§¸ç™¼æœˆä»½ï¼š[1,3,5,7,9,11]
- ä»»å‹™æ¨¡æ¿ï¼šè¨˜å¸³æœå‹™æµç¨‹

è‡ªå‹•ç”Ÿæˆï¼š
â†’ 1æœˆ1æ—¥ï¼šç”Ÿæˆ1æœˆä»½ä»»å‹™
â†’ 3æœˆ1æ—¥ï¼šç”Ÿæˆ3æœˆä»½ä»»å‹™
â†’ ä»¥æ­¤é¡æ¨
```

### éšæ®µé †åºè¦å‰‡ï¼ˆå¼·åˆ¶åŸ·è¡Œï¼‰â­

**è¦å‰‡ï¼š** éšæ®µå¿…é ˆæŒ‰é †åºå®Œæˆï¼Œä¸å¯è·³é

```
éšæ®µ1ï¼ˆå¾…é–‹å§‹ï¼‰â†’ é–‹å§‹ â†’ éšæ®µ1ï¼ˆé€²è¡Œä¸­ï¼‰â†’ å®Œæˆ â†’ éšæ®µ1ï¼ˆå·²å®Œæˆï¼‰
  â†“ âš ï¸ æª¢æŸ¥ï¼šéšæ®µ1æ˜¯å¦å·²å®Œæˆ
éšæ®µ2ï¼ˆå¾…é–‹å§‹ï¼‰â†’ é–‹å§‹ â†’ éšæ®µ2ï¼ˆé€²è¡Œä¸­ï¼‰â†’ å®Œæˆ â†’ éšæ®µ2ï¼ˆå·²å®Œæˆï¼‰
  â†“ âš ï¸ æª¢æŸ¥ï¼šéšæ®µ2æ˜¯å¦å·²å®Œæˆ
éšæ®µ3ï¼ˆå¾…é–‹å§‹ï¼‰â†’ é–‹å§‹ â†’ éšæ®µ3ï¼ˆé€²è¡Œä¸­ï¼‰â†’ å®Œæˆ â†’ éšæ®µ3ï¼ˆå·²å®Œæˆï¼‰
  â†“
æ•´å€‹ä»»å‹™å®Œæˆ
```

**å¾Œç«¯é©—è­‰é‚è¼¯ï¼ˆå·²æ•´åˆåˆ° TaskService.startStageï¼‰ï¼š**
```typescript
// é–‹å§‹éšæ®µæ™‚è‡ªå‹•æª¢æŸ¥å‰ä¸€éšæ®µ
if (stage.stage_order > 1) {
  const previousStage = await db.prepare(`
    SELECT stage_name, status FROM ActiveTaskStages
    WHERE task_id = ? AND stage_order = ?
  `).bind(taskId, stage.stage_order - 1).first();
  
  if (previousStage.status !== 'completed') {
    throw new ValidationError(
      `è«‹å…ˆå®Œæˆã€Œ${previousStage.stage_name}ã€ï¼ˆéšæ®µ${stage.stage_order - 1}ï¼‰`
    );
  }
}

// å®Œæˆéšæ®µæ™‚æª¢æŸ¥ç‹€æ…‹
if (stage.status !== 'in_progress') {
  throw new ValidationError('åªèƒ½å®Œæˆã€Œé€²è¡Œä¸­ã€çš„éšæ®µï¼Œè«‹å…ˆé–‹å§‹æ­¤éšæ®µ');
}
```

**å‰ç«¯UIè™•ç†ï¼š**
```vue
<div 
  v-for="stage in stages" 
  :key="stage.active_stage_id"
  class="stage"
>
  <h4>{{ stage.stage_name }}</h4>
  
  <!-- é–‹å§‹æŒ‰éˆ• -->
  <StyledButton 
    v-if="stage.status === 'pending'"
    @click="startStage(stage.active_stage_id)"
    :disabled="!canStartStage(stage)"
  >
    é–‹å§‹æ­¤éšæ®µ
  </StyledButton>
  
  <!-- â­ ç¦ç”¨æç¤ºï¼ˆé¡¯ç¤ºå‰ä¸€éšæ®µåç¨±ï¼‰-->
  <p v-if="stage.status === 'pending' && !canStartStage(stage)" class="hint-disabled">
    âš ï¸ è«‹å…ˆå®Œæˆã€Œ{{ getPreviousStageName(stage) }}ã€ï¼ˆéšæ®µ{{ stage.stage_order - 1 }}ï¼‰
  </p>
  
  <!-- å®ŒæˆæŒ‰éˆ• -->
  <StyledButton 
    v-if="stage.status === 'in_progress'"
    @click="completeStage(stage.active_stage_id)"
  >
    å®Œæˆæ­¤éšæ®µ
  </StyledButton>
</div>

<script setup>
// â­ æª¢æŸ¥æ˜¯å¦å¯ä»¥é–‹å§‹è©²éšæ®µ
function canStartStage(stage) {
  if (stage.stage_order === 1) {
    return true;  // ç¬¬ä¸€éšæ®µç¸½æ˜¯å¯ä»¥é–‹å§‹
  }
  
  // æª¢æŸ¥å‰ä¸€éšæ®µæ˜¯å¦å·²å®Œæˆ
  const previousStage = stages.value.find(s => s.stage_order === stage.stage_order - 1);
  return previousStage?.status === 'completed';
}
</script>
```

**éŒ¯èª¤è™•ç†ç¯„ä¾‹ï¼š**
```
å“¡å·¥å˜—è©¦é–‹å§‹ã€Œéšæ®µ3ï¼šç”¢å‡ºå ±è¡¨ã€ï¼Œä½†éšæ®µ2æœªå®Œæˆ
â†’ å‰ç«¯ï¼šã€Œé–‹å§‹ã€æŒ‰éˆ•disabledï¼Œé¡¯ç¤ºã€Œè«‹å…ˆå®Œæˆå‰ä¸€éšæ®µã€
â†’ å¦‚æœç¹éå‰ç«¯ç›´æ¥èª¿APIï¼š
  POST /api/v1/tasks/123/stages/3/start
  å›æ‡‰ï¼š
  {
    "success": false,
    "error": {
      "code": "VALIDATION_ERROR",
      "message": "è«‹å…ˆå®Œæˆã€Œæ ¸å°éŠ€è¡Œå°å¸³å–®ã€ï¼ˆéšæ®µ2ï¼‰"
    }
  }
```

### æ¬Šé™è¦å‰‡

âš ï¸ **å°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆ** - å“¡å·¥æœ‰è¼ƒå¤šæ¬Šé™

- **æŸ¥çœ‹ä»»å‹™ï¼š** å“¡å·¥åªèƒ½çœ‹è‡ªå·±çš„ä»»å‹™ï¼Œç®¡ç†å“¡å¯ä»¥çœ‹æ‰€æœ‰ä»»å‹™
- **ä»»å‹™æ¨¡æ¿ç®¡ç†ï¼š** âœ… æ‰€æœ‰äººå¯ç®¡ç†ï¼ˆå“¡å·¥å¯å”åŠ©å»ºç«‹æ¨¡æ¿ï¼‰
- **å®¢æˆ¶æœå‹™è¨­å®šï¼š** âœ… æ‰€æœ‰äººå¯ç®¡ç†ï¼ˆå“¡å·¥å¯è¨­å®šå®¢æˆ¶æœå‹™ï¼‰
- **åŸ·è¡Œä»»å‹™ï¼š** å“¡å·¥å¯åŸ·è¡Œè‡ªå·±çš„ä»»å‹™ï¼Œç®¡ç†å“¡å¯åŸ·è¡Œæ‰€æœ‰ä»»å‹™

---

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

```typescript
// æ¸¬è©¦1ï¼šè‡ªå‹•ç”Ÿæˆä»»å‹™
test('æ‡‰è©²åœ¨è§¸ç™¼æœˆä»½è‡ªå‹•ç”Ÿæˆä»»å‹™', async () => {
  // è¨­å®šå®¢æˆ¶æœå‹™ï¼ˆtrigger_months = [1,3,5]ï¼‰
  // åŸ·è¡Œ Cron Jobï¼ˆå‡è¨­ç•¶å‰æ˜¯1æœˆï¼‰
  // é©—è­‰ä»»å‹™å·²ç”Ÿæˆ
});

// æ¸¬è©¦2ï¼šéšæ®µé †åº
test('æ‡‰è©²æŒ‰é †åºå®Œæˆéšæ®µ', async () => {
  // å˜—è©¦å®Œæˆéšæ®µ2ï¼ˆéšæ®µ1æœªå®Œæˆï¼‰
  // æ‡‰è©²æ‹‹å‡ºéŒ¯èª¤
});

// æ¸¬è©¦3ï¼šå“¡å·¥åªçœ‹è‡ªå·±
test('å“¡å·¥åªèƒ½çœ‹è‡ªå·±çš„ä»»å‹™', async () => {
  const user = { user_id: 2, is_admin: false };
  const tasks = await getTasks({}, user);
  tasks.forEach(t => {
    expect(t.assignee_user_id).toBe(2);
  });
});
```

---

**é€™å€‹æ–‡æª”åŒ…å«ä»»å‹™ç®¡ç†çš„æ‰€æœ‰æŠ€è¡“ç´°ç¯€ã€‚**

