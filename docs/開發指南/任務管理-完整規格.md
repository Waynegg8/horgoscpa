# 任務管理 - 完整開發規格

**給 AI：** 實現任務管理功能的完整技術規格

---

## 💾 資料表

### TaskTemplates（任務模板）
```sql
CREATE TABLE TaskTemplates (
  template_id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_name TEXT NOT NULL,
  service_id INTEGER,
  description TEXT,
  estimated_days INTEGER,
  related_sop_id INTEGER,           -- 關聯的 SOP 文件
  is_client_specific BOOLEAN DEFAULT 0,  -- 是否為客戶專屬模板
  specific_client_id TEXT,          -- 專屬客戶ID（若為客戶專屬）
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (service_id) REFERENCES Services(service_id),
  FOREIGN KEY (related_sop_id) REFERENCES KnowledgeBase(knowledge_id),
  FOREIGN KEY (specific_client_id) REFERENCES Clients(client_id)
);

CREATE INDEX idx_task_templates_client ON TaskTemplates(specific_client_id);
```

### TaskStageTemplates（階段模板）
```sql
CREATE TABLE TaskStageTemplates (
  stage_template_id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_id INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_order INTEGER NOT NULL,
  estimated_days INTEGER,
  description TEXT,
  
  FOREIGN KEY (template_id) REFERENCES TaskTemplates(template_id) ON DELETE CASCADE
);

CREATE INDEX idx_stage_templates_template ON TaskStageTemplates(template_id);
CREATE INDEX idx_stage_templates_order ON TaskStageTemplates(template_id, stage_order);
```

### ActiveTasks（執行中任務）
```sql
CREATE TABLE ActiveTasks (
  task_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_service_id INTEGER NOT NULL,
  template_id INTEGER NOT NULL,
  task_name TEXT NOT NULL,
  start_date TEXT,
  due_date TEXT,
  completed_date TEXT,
  status TEXT DEFAULT 'pending',    -- pending, in_progress, completed, cancelled
  assignee_user_id INTEGER,
  related_sop_id INTEGER,           -- 關聯的通用 SOP 文件
  client_specific_sop_id INTEGER,   -- 客戶專屬 SOP 文件
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,                      -- ⭐ 刪除時間
  deleted_by INTEGER,                   -- ⭐ 刪除人員
  
  FOREIGN KEY (client_service_id) REFERENCES ClientServices(client_service_id),
  FOREIGN KEY (template_id) REFERENCES TaskTemplates(template_id),
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id),
  FOREIGN KEY (related_sop_id) REFERENCES KnowledgeBase(knowledge_id),
  FOREIGN KEY (client_specific_sop_id) REFERENCES KnowledgeBase(knowledge_id),
  FOREIGN KEY (deleted_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_active_tasks_service ON ActiveTasks(client_service_id);
CREATE INDEX idx_active_tasks_assignee ON ActiveTasks(assignee_user_id);
CREATE INDEX idx_active_tasks_status ON ActiveTasks(status);
CREATE INDEX idx_active_tasks_due_date ON ActiveTasks(due_date);
CREATE INDEX idx_active_tasks_assignee_status ON ActiveTasks(assignee_user_id, status, due_date);  -- ⭐ 儀表板查詢專用
CREATE INDEX idx_active_tasks_due_status ON ActiveTasks(due_date, status);  -- ⭐ 逾期任務檢測專用
```

**索引使用說明：**
```
idx_active_tasks_assignee_status: ⭐ 新增
  用途：儀表板「我的任務」查詢
  查詢：WHERE assignee_user_id = ? AND status IN ('pending', 'in_progress') ORDER BY due_date
  效能提升：儀表板載入速度提升60-80%
  
idx_active_tasks_due_status: ⭐ 新增
  用途：Cron Job檢測逾期任務
  查詢：WHERE due_date < date('now') AND status != 'completed'
```

### ActiveTaskStages（任務階段進度）
```sql
CREATE TABLE ActiveTaskStages (
  active_stage_id INTEGER PRIMARY KEY AUTOINCREMENT,
  task_id INTEGER NOT NULL,
  stage_template_id INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_order INTEGER NOT NULL,
  status TEXT DEFAULT 'pending',    -- pending, in_progress, completed
  started_at TEXT,
  completed_at TEXT,
  assignee_user_id INTEGER,
  notes TEXT,
  
  FOREIGN KEY (task_id) REFERENCES ActiveTasks(task_id) ON DELETE CASCADE,
  FOREIGN KEY (stage_template_id) REFERENCES TaskStageTemplates(stage_template_id),
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id)
);

CREATE INDEX idx_active_stages_task ON ActiveTaskStages(task_id);
```

### ClientServices（客戶服務配置）
```sql
CREATE TABLE ClientServices (
  client_service_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  service_id INTEGER NOT NULL,
  frequency_id INTEGER NOT NULL,
  template_id INTEGER,              -- ⭐ 預設任務模板（通用）
  custom_template_id INTEGER,       -- ⭐ 客戶專屬模板（優先使用）
  start_date TEXT NOT NULL,
  end_date TEXT,
  status TEXT DEFAULT 'active',     -- 'active', 'suspended', 'expired', 'cancelled'
  trigger_months TEXT,              -- JSON: [1,3,5,7,9,11]
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (client_id) REFERENCES Clients(client_id),
  FOREIGN KEY (service_id) REFERENCES Services(service_id),
  FOREIGN KEY (frequency_id) REFERENCES ServiceFrequencyTypes(frequency_id),
  FOREIGN KEY (template_id) REFERENCES TaskTemplates(template_id),
  FOREIGN KEY (custom_template_id) REFERENCES TaskTemplates(template_id),
  UNIQUE(client_id, service_id)
);

CREATE INDEX idx_client_services_client ON ClientServices(client_id);
CREATE INDEX idx_client_services_service ON ClientServices(service_id);
CREATE INDEX idx_client_services_status ON ClientServices(status);
```

**欄位說明：**
```
template_id:
  - 通用任務模板（如：「記帳服務流程」）
  - 適用於大部分客戶

custom_template_id:
  - 客戶專屬模板（如：「JKL企業專屬記帳流程」）
  - 如果有填，優先使用此模板生成任務
  - 留空 = 使用通用模板

範例：
客戶A - 記帳服務：
  template_id = 1（記帳服務流程）
  custom_template_id = NULL
  → 使用通用模板

客戶JKL - 記帳服務：
  template_id = 1（記帳服務流程）
  custom_template_id = 15（JKL企業專屬）
  → 優先使用專屬模板（15）
```

---

## 🔌 API 端點

### 任務模板管理

⚠️ **小型事務所彈性設計** - 員工可協助建立任務模板

```
GET    /api/v1/task-templates                查詢模板列表（所有人）
POST   /api/v1/task-templates                新增模板（所有人，小型事務所彈性設計）
PUT    /api/v1/task-templates/:id            更新模板（所有人，小型事務所彈性設計）
DELETE /api/v1/task-templates/:id            刪除模板（所有人，小型事務所彈性設計）
POST   /api/v1/task-templates/:id/copy       複製模板（所有人，小型事務所彈性設計）
```

### 客戶服務設定

⚠️ **小型事務所彈性設計** - 員工可設定客戶服務（自動產生任務）

```
GET    /api/v1/client-services                     權限：所有人
POST   /api/v1/client-services                     權限：所有人（小型事務所彈性設計）
PUT    /api/v1/client-services/:id                 權限：所有人（小型事務所彈性設計）
DELETE /api/v1/client-services/:id                 權限：所有人（小型事務所彈性設計）
GET    /api/v1/clients/:clientId/services          權限：所有人
GET    /api/v1/clients/:clientId/available-templates  查詢可用模板（通用+專屬）⭐
```

**新增客戶服務範例：**
```json
// POST /api/v1/client-services
{
  "client_id": "12345678",
  "service_id": 1,              // 記帳服務
  "frequency_id": 1,            // 每月
  "template_id": 5,             // 通用模板：記帳服務流程
  "custom_template_id": null,   // ⭐ 無專屬模板（使用通用）
  "start_date": "2025-11-01"
}

// 回應
{
  "success": true,
  "data": {
    "client_service_id": 123,
    "client_id": "12345678",
    "service_id": 1,
    "template_id": 5,
    "custom_template_id": null,
    "template_name": "記帳服務流程（通用）",
    "trigger_months": [1,2,3,4,5,6,7,8,9,10,11,12]
  }
}
```

**使用客戶專屬模板範例：**
```json
// POST /api/v1/client-services（JKL企業）
{
  "client_id": "87654321",
  "service_id": 1,              // 記帳服務
  "frequency_id": 1,            // 每月
  "template_id": 5,             // 通用模板（備用）
  "custom_template_id": 15,     // ⭐ JKL企業專屬記帳流程
  "start_date": "2025-11-01"
}

// 回應
{
  "success": true,
  "data": {
    "client_service_id": 124,
    "template_id": 5,
    "custom_template_id": 15,
    "template_name": "JKL企業專屬記帳流程",  // ⭐ 顯示專屬模板名稱
    "is_using_custom_template": true
  }
}
```

**查詢可用模板API：**
```json
// GET /api/v1/clients/87654321/available-templates?service_id=1

{
  "success": true,
  "data": {
    "general_templates": [
      { "template_id": 5, "template_name": "記帳服務流程", "is_client_specific": false }
    ],
    "client_specific_templates": [
      { "template_id": 15, "template_name": "JKL企業專屬記帳流程", "is_client_specific": true }
    ]
  }
}
```

### 任務進度追蹤
```
GET    /api/v1/tasks                               查詢任務列表
GET    /api/v1/tasks/:id                           查詢任務詳情（含SOP）
POST   /api/v1/tasks/:id/stages/:stageId/start     開始階段
POST   /api/v1/tasks/:id/stages/:stageId/complete  完成階段
PUT    /api/v1/tasks/:id                           更新任務
GET    /api/v1/tasks/:id/sop                       查詢任務關聯的SOP
```

**查詢任務詳情（含SOP）範例：**
```json
GET /api/v1/tasks/123

// 回應
{
  "success": true,
  "data": {
    "task_id": 123,
    "task_name": "ABC科技 - 12月記帳服務",
    "client_id": "12345678",
    "company_name": "ABC科技股份有限公司",
    "status": "in_progress",
    "assignee_user_id": 1,
    "assignee_name": "王小明",
    "due_date": "2025-12-31",
    "related_sop": {
      "knowledge_id": 5,
      "title": "記帳服務標準作業流程",
      "version": "v2.1"
    },
    "client_specific_sop": {
      "knowledge_id": 15,
      "title": "ABC科技 - 記帳特殊注意事項",
      "version": "v1.0"
    },
    "stages": [
      {
        "active_stage_id": 1,
        "stage_name": "收集憑證",
        "status": "completed"
      },
      {
        "active_stage_id": 2,
        "stage_name": "建檔分錄",
        "status": "in_progress"
      },
      {
        "active_stage_id": 3,
        "stage_name": "產出報表",
        "status": "pending"
      }
    ]
  }
}
```

---

## 🎨 前端組件

### TaskBoardPage.vue（看板視圖）
```vue
<template>
  <div class="task-board">
    <h1>任務管理</h1>
    
    <div class="view-switcher">
      <button @click="view = 'board'">看板</button>
      <button @click="view = 'list'">列表</button>
    </div>

    <!-- 看板視圖 -->
    <div v-if="view === 'board'" class="kanban-board">
      <div class="column">
        <h3>待開始</h3>
        <TaskCard 
          v-for="task in pendingTasks" 
          :key="task.task_id"
          :task="task"
          @click="openTaskDetail(task)"
        />
      </div>
      
      <div class="column">
        <h3>進行中</h3>
        <TaskCard 
          v-for="task in inProgressTasks" 
          :key="task.task_id"
          :task="task"
        />
      </div>
      
      <div class="column">
        <h3>已完成</h3>
        <TaskCard 
          v-for="task in completedTasks" 
          :key="task.task_id"
          :task="task"
        />
      </div>
    </div>

    <!-- 列表視圖 -->
    <DataTable 
      v-else
      :columns="columns"
      :data="allTasks"
    />
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';
import { getTasks } from '@/api/tasks';

const view = ref('board');
const tasks = ref([]);

const pendingTasks = computed(() => 
  tasks.value.filter(t => t.status === 'pending')
);
const inProgressTasks = computed(() => 
  tasks.value.filter(t => t.status === 'in_progress')
);
const completedTasks = computed(() => 
  tasks.value.filter(t => t.status === 'completed')
);

onMounted(async () => {
  const response = await getTasks();
  tasks.value = response.data;
});
</script>
```

### TaskDetailModal.vue
```vue
<template>
  <Modal :show="show" :title="task.task_name" size="lg">
    <div class="task-stages">
      <div 
        v-for="stage in stages" 
        :key="stage.active_stage_id"
        :class="['stage', `stage-${stage.status}`]"
      >
        <div class="stage-header">
          <span class="stage-number">{{ stage.stage_order }}</span>
          <h4>{{ stage.stage_name }}</h4>
          <span :class="['status', stage.status]">
            {{ statusText[stage.status] }}
          </span>
        </div>
        
        <div class="stage-info">
          <p v-if="stage.started_at">開始：{{ formatDate(stage.started_at) }}</p>
          <p v-if="stage.completed_at">完成：{{ formatDate(stage.completed_at) }}</p>
        </div>
        
        <div v-if="stage.status === 'pending'" class="stage-actions">
          <!-- ⭐ 檢查是否可以開始（前一階段已完成）-->
          <StyledButton 
            @click="startStage(stage.active_stage_id)"
            :disabled="!canStartStage(stage)"
          >
            開始此階段
          </StyledButton>
          <p v-if="!canStartStage(stage)" class="hint-disabled">
            ⚠️ 請先完成「{{ getPreviousStageName(stage) }}」（階段{{ stage.stage_order - 1 }}）
          </p>
        </div>
        
        <div v-if="stage.status === 'in_progress'" class="stage-actions">
          <StyledButton @click="completeStage(stage.active_stage_id)">
            完成此階段
          </StyledButton>
        </div>
      </div>
    </div>
  </Modal>
</template>

<script setup>
import { ref, computed } from 'vue';
import { startStage as apiStartStage, completeStage as apiCompleteStage } from '@/api/tasks';

const props = defineProps({
  show: Boolean,
  task: Object
});

const emit = defineEmits(['updated']);

const stages = computed(() => props.task?.stages || []);

const statusText = {
  'pending': '待開始',
  'in_progress': '進行中',
  'completed': '已完成'
};

// ⭐ 檢查是否可以開始該階段（前一階段已完成）
function canStartStage(stage) {
  // 階段1：永遠可以開始
  if (stage.stage_order === 1) {
    return true;
  }
  
  // 階段2+：檢查前一階段是否已完成
  const previousStage = stages.value.find(s => s.stage_order === stage.stage_order - 1);
  
  return previousStage && previousStage.status === 'completed';
}

// ⭐ 取得前一階段的名稱（用於UI提示）
function getPreviousStageName(stage) {
  if (stage.stage_order === 1) {
    return '';
  }
  
  const previousStage = stages.value.find(s => s.stage_order === stage.stage_order - 1);
  return previousStage ? previousStage.stage_name : `階段${stage.stage_order - 1}`;
}

async function startStage(stageId) {
  try {
    await apiStartStage(props.task.task_id, stageId);
    emit('updated');
  } catch (error) {
    alert('開始失敗：' + error.message);
  }
}

async function completeStage(stageId) {
  try {
    await apiCompleteStage(props.task.task_id, stageId);
    emit('updated');
  } catch (error) {
    alert('完成失敗：' + error.message);
  }
}
</script>

<style scoped>
.stage.stage-completed {
  background: #d1fae5;
  border-left: 4px solid #10b981;
}

.stage.stage-in_progress {
  background: #dbeafe;
  border-left: 4px solid #3b82f6;
}

.stage.stage-pending {
  background: #f3f4f6;
  border-left: 4px solid #9ca3af;
}

.hint-disabled {
  color: #ef4444;
  font-size: 0.875rem;
  margin-top: 0.5rem;
}
</style>
```

---

## 🔧 後端實現

### TaskService
```typescript
class TaskService {
  async getTasks(filters, user) {
    // 員工只能看自己的任務
    if (!user.is_admin) {
      filters.assignee_user_id = user.user_id;
    }
    
    return await this.repository.findAll(filters);
  }
  
  async startStage(taskId, stageId, user) {
    // 1. 驗證任務存在
    const task = await this.taskRepo.findById(taskId);
    if (!task) {
      throw new NotFoundError('任務不存在');
    }
    
    // 2. 驗證權限
    if (!user.is_admin && task.assignee_user_id !== user.user_id) {
      throw new ForbiddenError('無權限操作此任務');
    }
    
    // 3. 查詢該階段資訊
    const stage = await this.stageRepo.findById(stageId);
    if (!stage) {
      throw new NotFoundError('階段不存在');
    }
    
    // 4. ⭐ 檢查是否按順序（必須前一階段已完成）
    if (stage.stage_order > 1) {
      const previousStage = await this.db.prepare(`
        SELECT status, stage_name FROM ActiveTaskStages
        WHERE task_id = ? AND stage_order = ?
      `).bind(taskId, stage.stage_order - 1).first();
      
      if (previousStage && previousStage.status !== 'completed') {
        throw new ValidationError(
          `請先完成「${previousStage.stage_name}」（階段${stage.stage_order - 1}）`
        );
      }
    }
    
    // 5. 更新階段狀態
    await this.stageRepo.update(stageId, {
      status: 'in_progress',
      started_at: new Date(),
      assignee_user_id: user.user_id
    });
    
    // 6. 更新任務狀態
    await this.taskRepo.update(taskId, {
      status: 'in_progress'
    });
    
    return { success: true };
  }
  
  async completeStage(taskId, stageId, user) {
    // 1. 驗證權限
    const task = await this.taskRepo.findById(taskId);
    if (!user.is_admin && task.assignee_user_id !== user.user_id) {
      throw new ForbiddenError('無權限操作此任務');
    }
    
    // 2. 查詢該階段資訊
    const stage = await this.stageRepo.findById(stageId);
    if (!stage) {
      throw new NotFoundError('階段不存在');
    }
    
    // ⭐ 3. 檢查該階段是否為「進行中」
    if (stage.status !== 'in_progress') {
      throw new ValidationError('只能完成「進行中」的階段，請先開始此階段');
    }
    
    // 4. 完成當前階段
    await this.stageRepo.update(stageId, {
      status: 'completed',
      completed_at: new Date()
    });
    
    // 5. 檢查是否所有階段都完成
    const allStages = await this.stageRepo.findByTaskId(taskId);
    const allCompleted = allStages.every(s => s.status === 'completed');
    
    if (allCompleted) {
      // 6. 完成整個任務
      await this.taskRepo.update(taskId, {
        status: 'completed',
        completed_date: new Date()
      });
    }
    
    return { success: true };
  }
}
```

---

## ⏰ 自動化：任務自動生成

```typescript
/**
 * Cron Job: 每月1日執行
 * 配置：wrangler.toml crons = ["0 0 1 * *"]
 */
async function generateMonthlyTasks(env) {
  const currentMonth = new Date().getMonth() + 1;
  
  // 1. 查詢所有啟用中的客戶服務
  const services = await env.DB.prepare(`
    SELECT * FROM ClientServices 
    WHERE status = 'active' AND is_deleted = 0
  `).all();
  
  for (const service of services.results) {
    // 2. 檢查是否在觸發月份
    const triggerMonths = JSON.parse(service.trigger_months);
    if (!triggerMonths.includes(currentMonth)) {
      continue;
    }
    
    // 3. 查詢任務模板（⭐ 優先使用客戶專屬模板）
    let template;
    
    // 優先：客戶專屬模板
    if (service.custom_template_id) {
      template = await env.DB.prepare(`
        SELECT * FROM TaskTemplates 
        WHERE template_id = ?
          AND (is_client_specific = 0 OR specific_client_id = ?)
      `).bind(service.custom_template_id, service.client_id).first();
      
      if (template) {
        console.log(`使用客戶專屬模板：${template.template_name}`);
      }
    }
    
    // 其次：通用模板
    if (!template && service.template_id) {
      template = await env.DB.prepare(
        'SELECT * FROM TaskTemplates WHERE template_id = ?'
      ).bind(service.template_id).first();
      
      if (template) {
        console.log(`使用通用模板：${template.template_name}`);
      }
    }
    
    // 如果都沒有模板，跳過
    if (!template) {
      console.warn(`客戶 ${service.client_id} 服務 ${service.service_id} 缺少任務模板`);
      continue;
    }
    
    // 4. 查詢客戶專屬SOP（如果有）
    const clientSpecificSOP = await env.DB.prepare(`
      SELECT knowledge_id FROM ClientSOPLinks
      WHERE client_id = ? AND service_id = ?
    `).bind(service.client_id, service.service_id).first();
    
    // 5. 查詢客戶負責人
    const client = await env.DB.prepare(`
      SELECT assignee_user_id FROM Clients WHERE client_id = ?
    `).bind(service.client_id).first();
    
    // 6. 生成任務（自動連結SOP）
    const taskResult = await env.DB.prepare(`
      INSERT INTO ActiveTasks (
        client_service_id, template_id, task_name,
        start_date, due_date, assignee_user_id,
        related_sop_id, client_specific_sop_id, status
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'pending')
    `).bind(
      service.client_service_id,
      template.template_id,
      `${service.client_id} - ${template.template_name}`,
      new Date().toISOString().split('T')[0],
      addDays(new Date(), template.estimated_days || 15),
      client?.assignee_user_id || null,
      template.related_sop_id || null,           // 模板關聯的通用SOP
      clientSpecificSOP?.knowledge_id || null    // 客戶專屬SOP
    ).run();
    
    const taskId = taskResult.meta.last_row_id;
    
    // 7. 生成階段
    const stages = await env.DB.prepare(
      'SELECT * FROM TaskStageTemplates WHERE template_id = ? ORDER BY stage_order'
    ).bind(template.template_id).all();
    
    for (const stage of stages.results) {
      await env.DB.prepare(`
        INSERT INTO ActiveTaskStages (
          task_id, stage_template_id, stage_name, stage_order, status
        )
        VALUES (?, ?, ?, ?, 'pending')
      `).bind(
        taskId,
        stage.stage_template_id,
        stage.stage_name,
        stage.stage_order
      ).run();
    }
    
    console.log(`已生成任務：${taskId} - ${template.template_name}`);
  }
  
  console.log(`月度任務生成完成：當月 ${currentMonth}`);
}
```

---

## ✅ 業務規則

### 任務生成規則
```
客戶服務設定：
- 服務：記帳服務
- 週期：雙月
- 觸發月份：[1,3,5,7,9,11]
- 任務模板：記帳服務流程

自動生成：
→ 1月1日：生成1月份任務
→ 3月1日：生成3月份任務
→ 以此類推
```

### 階段順序規則（強制執行）⭐

**規則：** 階段必須按順序完成，不可跳過

```
階段1（待開始）→ 開始 → 階段1（進行中）→ 完成 → 階段1（已完成）
  ↓ ⚠️ 檢查：階段1是否已完成
階段2（待開始）→ 開始 → 階段2（進行中）→ 完成 → 階段2（已完成）
  ↓ ⚠️ 檢查：階段2是否已完成
階段3（待開始）→ 開始 → 階段3（進行中）→ 完成 → 階段3（已完成）
  ↓
整個任務完成
```

**後端驗證邏輯（已整合到 TaskService.startStage）：**
```typescript
// 開始階段時自動檢查前一階段
if (stage.stage_order > 1) {
  const previousStage = await db.prepare(`
    SELECT stage_name, status FROM ActiveTaskStages
    WHERE task_id = ? AND stage_order = ?
  `).bind(taskId, stage.stage_order - 1).first();
  
  if (previousStage.status !== 'completed') {
    throw new ValidationError(
      `請先完成「${previousStage.stage_name}」（階段${stage.stage_order - 1}）`
    );
  }
}

// 完成階段時檢查狀態
if (stage.status !== 'in_progress') {
  throw new ValidationError('只能完成「進行中」的階段，請先開始此階段');
}
```

**前端UI處理：**
```vue
<div 
  v-for="stage in stages" 
  :key="stage.active_stage_id"
  class="stage"
>
  <h4>{{ stage.stage_name }}</h4>
  
  <!-- 開始按鈕 -->
  <StyledButton 
    v-if="stage.status === 'pending'"
    @click="startStage(stage.active_stage_id)"
    :disabled="!canStartStage(stage)"
  >
    開始此階段
  </StyledButton>
  
  <!-- ⭐ 禁用提示（顯示前一階段名稱）-->
  <p v-if="stage.status === 'pending' && !canStartStage(stage)" class="hint-disabled">
    ⚠️ 請先完成「{{ getPreviousStageName(stage) }}」（階段{{ stage.stage_order - 1 }}）
  </p>
  
  <!-- 完成按鈕 -->
  <StyledButton 
    v-if="stage.status === 'in_progress'"
    @click="completeStage(stage.active_stage_id)"
  >
    完成此階段
  </StyledButton>
</div>

<script setup>
// ⭐ 檢查是否可以開始該階段
function canStartStage(stage) {
  if (stage.stage_order === 1) {
    return true;  // 第一階段總是可以開始
  }
  
  // 檢查前一階段是否已完成
  const previousStage = stages.value.find(s => s.stage_order === stage.stage_order - 1);
  return previousStage?.status === 'completed';
}
</script>
```

**錯誤處理範例：**
```
員工嘗試開始「階段3：產出報表」，但階段2未完成
→ 前端：「開始」按鈕disabled，顯示「請先完成前一階段」
→ 如果繞過前端直接調API：
  POST /api/v1/tasks/123/stages/3/start
  回應：
  {
    "success": false,
    "error": {
      "code": "VALIDATION_ERROR",
      "message": "請先完成「核對銀行對帳單」（階段2）"
    }
  }
```

### 權限規則

⚠️ **小型事務所彈性設計** - 員工有較多權限

- **查看任務：** 員工只能看自己的任務，管理員可以看所有任務
- **任務模板管理：** ✅ 所有人可管理（員工可協助建立模板）
- **客戶服務設定：** ✅ 所有人可管理（員工可設定客戶服務）
- **執行任務：** 員工可執行自己的任務，管理員可執行所有任務

---

## 🧪 測試案例

```typescript
// 測試1：自動生成任務
test('應該在觸發月份自動生成任務', async () => {
  // 設定客戶服務（trigger_months = [1,3,5]）
  // 執行 Cron Job（假設當前是1月）
  // 驗證任務已生成
});

// 測試2：階段順序
test('應該按順序完成階段', async () => {
  // 嘗試完成階段2（階段1未完成）
  // 應該拋出錯誤
});

// 測試3：員工只看自己
test('員工只能看自己的任務', async () => {
  const user = { user_id: 2, is_admin: false };
  const tasks = await getTasks({}, user);
  tasks.forEach(t => {
    expect(t.assignee_user_id).toBe(2);
  });
});
```

---

**這個文檔包含任務管理的所有技術細節。**

