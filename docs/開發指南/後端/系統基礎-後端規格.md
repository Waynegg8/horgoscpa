## 系統基礎－後端規格

對應使用手冊：`docs/使用手冊/功能模組-14-員工帳號管理.md`、`docs/使用手冊/功能模組-16-報表查詢與系統設定.md`、`docs/使用手冊/參數配置-08-系統基礎參數與權限總覽.md`、`docs/使用手冊/參數配置-09-重要提醒與必填設定.md`

**範圍**：資料庫、API、權限、核心邏輯、伺服器端驗證與審計；不含前端畫面。

**依據**：優先遵循《使用手冊》（系統基礎參數/權限總覽、重要提醒與必填設定、員工帳號管理）。

---

## 資料庫設計（DDL 摘要）

```sql
-- Users（員工/用戶）
CREATE TABLE Users (
  user_id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  is_admin BOOLEAN DEFAULT 0,
  gender TEXT NOT NULL,                -- 'M', 'F'（UI 顯示男性/女性）
  birth_date TEXT,
  start_date TEXT NOT NULL,
  phone TEXT,
  address TEXT,
  emergency_contact_name TEXT,
  emergency_contact_phone TEXT,
  login_attempts INTEGER DEFAULT 0,
  last_failed_login TEXT,
  last_login TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,        -- 停用：1
  deleted_at TEXT,
  deleted_by INTEGER
);
CREATE UNIQUE INDEX idx_users_username ON Users(username);
CREATE INDEX idx_users_email ON Users(email);
CREATE INDEX idx_users_is_admin ON Users(is_admin);

-- Settings（系統設定）
CREATE TABLE Settings (
  setting_key TEXT PRIMARY KEY,
  setting_value TEXT NOT NULL,
  description TEXT,
  is_dangerous BOOLEAN DEFAULT 0,
  updated_at TEXT DEFAULT (datetime('now')),
  updated_by INTEGER,
  FOREIGN KEY (updated_by) REFERENCES Users(user_id)
);
CREATE UNIQUE INDEX idx_settings_key ON Settings(setting_key);

-- 必須設定的參數（初始化時需預設值或提醒設定）：
-- 系統基礎：company_name, contact_email, timezone, currency, timesheet_min_unit, soft_delete_enabled, workday_start, workday_end, report_locale
-- 危險設定：rule_comp_hours_expiry, daily_work_hours_limit(唯讀), hourly_wage_base(唯讀)
-- 薪資相關：attendance_bonus_amount（全勤獎金）
-- 成本分析：overhead_cost_per_hour（每小時管理成本）, target_profit_margin（目標毛利率）

-- AuditLogs（操作審計）
CREATE TABLE AuditLogs (
  log_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  action TEXT NOT NULL,         -- CREATE, UPDATE, DELETE, LOGIN, RESET_PASSWORD
  table_name TEXT NOT NULL,
  record_id TEXT,
  changes TEXT,
  ip_address TEXT,
  user_agent TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY (user_id) REFERENCES Users(user_id)
);
CREATE INDEX idx_audit_logs_user ON AuditLogs(user_id);
CREATE INDEX idx_audit_logs_table ON AuditLogs(table_name);
CREATE INDEX idx_audit_logs_action ON AuditLogs(action);
CREATE INDEX idx_audit_logs_date ON AuditLogs(created_at);

-- FieldAuditTrail（字段級審計）
CREATE TABLE FieldAuditTrail (
  audit_id INTEGER PRIMARY KEY AUTOINCREMENT,
  table_name TEXT NOT NULL,
  record_id TEXT NOT NULL,
  field_name TEXT NOT NULL,
  old_value TEXT,
  new_value TEXT,
  changed_by INTEGER NOT NULL,
  changed_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY (changed_by) REFERENCES Users(user_id)
);
CREATE INDEX idx_field_audit_table_record ON FieldAuditTrail(table_name, record_id);
CREATE INDEX idx_field_audit_field ON FieldAuditTrail(field_name);
CREATE INDEX idx_field_audit_user ON FieldAuditTrail(changed_by);
CREATE INDEX idx_field_audit_date ON FieldAuditTrail(changed_at);

-- Notifications（系統通知）
CREATE TABLE Notifications (
  notification_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  type TEXT NOT NULL,            -- missing_timesheet, task_overdue, payment_overdue, cron_failed
  message TEXT NOT NULL,
  related_date TEXT,
  related_user_id INTEGER,
  action_url TEXT,
  auto_dismiss BOOLEAN DEFAULT 1,
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  dismissed_at TEXT,
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (related_user_id) REFERENCES Users(user_id)
);
CREATE INDEX idx_notifications_user ON Notifications(user_id);
CREATE INDEX idx_notifications_type ON Notifications(type);
CREATE INDEX idx_notifications_deleted ON Notifications(is_deleted);
CREATE INDEX idx_notifications_date ON Notifications(related_date);
CREATE UNIQUE INDEX idx_notifications_unique ON Notifications(user_id, type, related_date, related_user_id) 
  WHERE is_deleted = 0;
```

---

## 權限與政策（伺服器端強制）

- 角色：`is_admin` 決定「管理功能」可用性（員工不可存取員工管理與系統參數）。
- 隱私隔離：員工不可閱讀他人之工時、假期、薪資等資料（跨模組授權層統一限制）。
- 停用策略：以 `Users.is_deleted = 1` 表示停用；停用者不可登入。

---

## API 設計

### 認證

- POST `/api/v1/auth/login`：登入（返回 token 或 session 訊息）
- POST `/api/v1/auth/logout`：登出
- GET  `/api/v1/auth/me`：驗證當前會話
- POST `/api/v1/auth/change-password`：修改密碼

錯誤碼（示例）：
- `UNAUTHORIZED`：帳號或密碼錯誤
- `ACCOUNT_LOCKED`：多次失敗鎖定

### 個人資料

- GET `/api/v1/profile`：取得個人資料
- PUT `/api/v1/profile`：更新個人資料（姓名、性別、Email、到職日等）

### 員工管理（管理員）

- GET    `/api/v1/admin/users`：查詢員工列表（支援關鍵字/角色/狀態過濾）
- POST   `/api/v1/admin/users`：新增員工
- GET    `/api/v1/admin/users/:id`：查詢員工詳情
- PUT    `/api/v1/admin/users/:id`：更新員工
- DELETE `/api/v1/admin/users/:id`：停用員工（軟刪除/設為停用）
- POST   `/api/v1/admin/users/:id/reset-password`：重置員工密碼

### 系統設定（管理員）

- GET `/api/v1/admin/settings`：獲取所有設定
- PUT `/api/v1/admin/settings/:key`：更新設定值（危險設定需 `confirmed: true`）

### 審計（管理員）

- GET `/api/v1/admin/audit-logs`：查詢操作日誌
- GET `/api/v1/admin/audit-logs/user/:userId`：查詢特定員工日誌

### 通知

- GET    `/api/v1/notifications`：取得使用者未移除通知
- PATCH  `/api/v1/notifications/:id/dismiss`：移除/關閉通知

回應格式（建議）：
```json
{ "success": true, "data": ... }
{ "success": false, "error": { "code": "FORBIDDEN", "message": "無權限" } }
```

---

## 核心業務邏輯

### 登入鎖定

- 規則：連續失敗 5 次 → 鎖定 15 分鐘。
- 流程：
  1) 驗證帳密；失敗則 `login_attempts + 1` 並寫入 `last_failed_login`。
  2) 嘗試登入時若 `login_attempts >= 5` 且未過 15 分鐘 → 返回 `ACCOUNT_LOCKED`。
  3) 成功登入後重置 `login_attempts = 0`，更新 `last_login`。

### 密碼處理

- 方案：bcrypt，成本因子 12。
- 規則：新密碼至少 6 碼（無複雜度要求）。

### 新增/更新員工

- 必填：`username`、`name`、`email`、`gender`、`start_date`。
- `username` 唯一；英數字元。
- `gender` 檢核：`M`/`F`（UI 呈現 男性/女性）。
- 建立後記錄審計日誌（`AuditLogs`）與字段級審計（必要欄位變動）。

### 停用員工

- 僅管理員可執行；將 `is_deleted = 1`，寫入 `deleted_at`、`deleted_by`。
- 停用使用者登入驗證一律拒絕。

### 系統設定

- 危險設定（`is_dangerous = 1`）更新需 `confirmed = true`；否則回 `VALIDATION_ERROR`。
- `daily_work_hours_limit`、`hourly_wage_base` 等法律參數不可變更（強制拒絕）。
- 設定更新記錄 `updated_by/updated_at` 與審計。
- 新增參數驗證規則：
  - `attendance_bonus_amount`（全勤獎金）：非負整數
  - `overhead_cost_per_hour`（每小時管理成本）：非負數字（可含小數）
  - `target_profit_margin`（目標毛利率）：0-100 之間的數字

### 通知生命週期

- 自動創建：由各模組觸發（如：逾期/缺填），避免重複（唯一索引）。
- 自動移除：問題解決後設 `is_deleted = 1, dismissed_at = now()`。

---

## 伺服器端驗證

- 認證：帳號存在、鎖定檢查、密碼正確。
- 使用者：必填欄位檢核、`username` 唯一、`gender in (M,F)`、Email 格式。
- 系統設定：危險設定需確認；法律參數不可更新；Key 必須存在。
- 權限：非管理員訪問管理端點 → `FORBIDDEN`。

---

## 安全與儲存

- Token：JWT（建議放置於 HttpOnly Cookie），有效期 24 小時。
- 審計：重要操作寫入 `AuditLogs`；敏感欄位變更寫入 `FieldAuditTrail`。
- 軟刪除：預設查詢排除 `is_deleted = 1` 之資料。

---

## 與《使用手冊》的對應

- 權限總覽：員工無權存取他人敏感資料；管理員具員工管理與設定權限。
- 重要提醒/必填：性別/Email/到職日為必填；危險設定受限制且需確認。
- 員工帳號管理：新增、編輯、停用、重置密碼；前述規則與審計均覆蓋。


