# 管理成本｜後端規格

對應使用手冊：`docs/使用手冊/功能模組-13-管理成本分配.md`、`docs/使用手冊/參數配置-07-成本分析參數.md`

> 嚴格限定：資料庫設計、API 端點、核心分攤邏輯、與報表/成本率整合；完全省略前端細節。

---

## 1) 角色與權限
- 管理員：可管理成本項目、月度成本、查詢分析
- 員工：無權限（403）

---

## 2) 資料庫設計（沿用完整規格）

### 2.1 OverheadCostTypes（管理成本項目類型）
```sql
CREATE TABLE IF NOT EXISTS OverheadCostTypes (
  cost_type_id INTEGER PRIMARY KEY AUTOINCREMENT,
  cost_code TEXT UNIQUE NOT NULL,
  cost_name TEXT NOT NULL,
  category TEXT NOT NULL,
  allocation_method TEXT NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT 1,
  display_order INTEGER DEFAULT 0,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  CHECK (category IN ('fixed', 'variable')),
  CHECK (allocation_method IN ('per_employee', 'per_hour', 'per_revenue'))
);
CREATE INDEX IF NOT EXISTS idx_overhead_cost_types_active ON OverheadCostTypes(is_active);
CREATE INDEX IF NOT EXISTS idx_overhead_cost_types_category ON OverheadCostTypes(category);
```

### 2.2 MonthlyOverheadCosts（月度管理成本）
```sql
CREATE TABLE IF NOT EXISTS MonthlyOverheadCosts (
  overhead_id INTEGER PRIMARY KEY AUTOINCREMENT,
  cost_type_id INTEGER NOT NULL,
  year INTEGER NOT NULL,
  month INTEGER NOT NULL,
  amount REAL NOT NULL,
  notes TEXT,
  recorded_by INTEGER NOT NULL,
  recorded_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  FOREIGN KEY (cost_type_id) REFERENCES OverheadCostTypes(cost_type_id),
  FOREIGN KEY (recorded_by) REFERENCES Users(user_id),
  UNIQUE(cost_type_id, year, month)
);
CREATE INDEX IF NOT EXISTS idx_monthly_overhead_date ON MonthlyOverheadCosts(year, month);
CREATE INDEX IF NOT EXISTS idx_monthly_overhead_type ON MonthlyOverheadCosts(cost_type_id);
```

---

## 3) API 端點（/api/v1/admin）

### 3.1 成本項目管理
- `GET /overhead-types`（管理員）
- `POST /overhead-types`（管理員）
- `PUT /overhead-types/:id`（管理員）
- `DELETE /overhead-types/:id`（管理員）

驗證：
- `cost_code`：必填、唯一、格式 `^[A-Z0-9_]{1,20}$`
- `cost_name`：必填 ≤ 50
- `category` ∈ {fixed, variable}
- `allocation_method` ∈ {per_employee, per_hour, per_revenue}

### 3.2 月度成本記錄
- `GET /overhead-costs?year=2025&month=10`
- `POST /overhead-costs`
- `PUT /overhead-costs/:id`
- `DELETE /overhead-costs/:id`

驗證：
- 同一 `cost_type_id + year + month` 不可重複
- `amount > 0` 且 ≤ 上限（如 1e9）

### 3.3 成本分析/彙總
- `GET /overhead-analysis?year=2025&month=10`
- `GET /overhead-summary?year=2025&month=10`

回應（分析，概要）：
```json
{
  "success": true,
  "data": {
    "year": 2025,
    "month": 10,
    "total_overhead": 38500,
    "employee_count": 4,
    "overhead_per_employee": 9625,
    "breakdown_by_category": { "fixed": 38500, "variable": 0 },
    "breakdown_by_type": [ { "cost_type_id": 1, "cost_name": "辦公室租金", "amount": 25000, "percentage": 64.9 } ],
    "cost_rate_impact": { "avg_hourly_without_overhead": 230, "avg_hourly_with_overhead": 285, "overhead_impact_percentage": 24.0 }
  },
  "warnings": [ { "type": "partial_overhead", "message": "僅輸入部分項目：RENT, INTERNET" } ]
}
```

---

## 4) 核心分攤與整合邏輯
- 每人分攤（per_employee）：`sum(amount where method=per_employee) / 員工數`
- 按工時分攤（per_hour）：`sum(amount where method=per_hour) / 公司總工時`
- 按營收分攤（per_revenue）：`sum(amount where method=per_revenue) / 當月總營收`，用占比套用至各客戶
- 完整時薪成本率整合：
  - `salary_rate = (底薪 + 經常性給與) / 240`（依薪資模組）
  - `overhead_rate = per_employee_overhead / 240 + per_hour_overhead_rate`（必要時）
  - `full_hourly_cost_rate = salary_rate + overhead_rate`
- 警示產出：
  - 無任何管理成本 → `overhead_missing`
  - 僅部分項目 → `partial_overhead` 並列出已輸入項目

---

## 5) 驗證與錯誤
- 400 `VALIDATION_ERROR`：欄位格式、唯一性、金額範圍
- 403 `FORBIDDEN`：非管理員存取
- 404 `NOT_FOUND`：資源不存在

錯誤格式：
```json
{ "success": false, "error": { "code": "VALIDATION_ERROR", "message": "該月份已有此項目記錄" } }
```

---

## 6) 效能與一致性
- 索引：`idx_monthly_overhead_date`、`idx_monthly_overhead_type`
- 事務：同月多筆 upsert 時使用交易保證一致性
- 快取：可對分析回應加上 10 分鐘快取（key 含 year,month）

---

## 7) 與其他模組整合
- 報表分析：提供每小時管理成本與分攤資料
- 客戶成本分析：用於加權工時 × 完整時薪成本計算
- 薪資管理：計算完整時薪成本率（僅經常性給與）

---

## 8) 業務需求對應（覆蓋檢核）
- 角色：員工無權限；管理員可設定項目、記錄月度成本、查詢報表
- 項目設定：代碼/名稱/類別/分攤方式/描述；啟用狀態
- 月度成本：年/月唯一、金額正數
- 分攤與影響：每人/每小時、結構拆分、影響百分比、警示輸出

