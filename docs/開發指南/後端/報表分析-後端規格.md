# 報表分析｜後端規格

對應使用手冊：`docs/使用手冊/功能模組-16-報表查詢與系統設定.md`、`docs/使用手冊/場景-07-查看客戶成本與盈利分析.md`

> 嚴格限定：資料庫/相依資料、API 端點、核心計算邏輯、效能與驗證；完全省略前端細節。

---

## 1) 角色與權限（業務對應）
- 員工：僅可查詢本人工時/假期相關報表；不可存取成本/盈利/營收/收款等管理報表
- 管理員：可查詢所有管理報表（客戶成本、員工工時、薪資、收款/營收、帳齡分析）
- 403 規則：非管理員請求管理報表 → FORBIDDEN

---

## 2) 相依資料與資料表
- 工時：`TimeLogs(user_id, client_id, work_date, hours, work_type_id, service_id, is_deleted)`
- 使用者：`Users(user_id, username, is_admin, ... )`
- 工作類型與倍率：`WorkTypes(work_type_id, rate_multiplier)`
- 服務：`Services(service_id, is_billable)`（可計費 vs 非計費）
- 客戶：`Clients(client_id, company_name)`
- 收據/收款：`Receipts(receipt_id, client_id, receipt_date, total_amount, status, is_deleted)`，`Payments(receipt_id, amount, ...)`
- 管理成本：每月成本與每小時管理成本（依現行成本模組）
- 薪資/年終：薪資項目與 `YearEndBonus(user_id, attribution_year, amount, is_deleted)`

索引建議（關鍵）：
```sql
CREATE INDEX idx_timelogs_date_client ON TimeLogs(work_date, client_id);
CREATE INDEX idx_timelogs_user_date ON TimeLogs(user_id, work_date);
CREATE INDEX idx_receipts_date_status ON Receipts(receipt_date, status);
```

---

## 3) API 設計（/api/v1/reports）

### 3.1 客戶成本分析
- `GET /api/v1/reports/client-cost-analysis`
- 權限：管理員
- Query
```json
{
  "start_date": "2025-01-01",
  "end_date": "2025-12-31",
  "client_id": "12345678",   // 可選
  "include_year_end_bonus": true  // 預設 false
}
```
- 回應（概要）
```json
{
  "success": true,
  "data": [
    {
      "client_id": "12345678",
      "company_name": "測試公司",
      "total_actual_hours": 125.5,
      "total_weighted_hours": 142.3,
      "cost_breakdown": {
        "salary_cost": 24650,
        "overhead_cost": 9860,
        "year_end_bonus": 3125,
        "total_cost": 37635
      },
      "labor_cost": 37635,
      "revenue": 45000,
      "gross_profit": 10490,
      "profit_margin": 23.3,
      "cost_percentage": { "salary": 71.4, "overhead": 28.6 },
      "user_breakdown": [
        {
          "user_id": 1,
          "username": "員工A",
          "actual_hours": 80.0,
          "weighted_hours": 86.7,
          "hourly_cost_rate": 285,
          "salary_rate": 230,
          "overhead_rate": 55,
          "total_cost": 27835,
          "salary_cost": 19941,
          "overhead_cost": 4769,
          "year_end_bonus_allocated": 3125,
          "year_end_bonus_ratio": 0.125
        }
      ]
    }
  ],
  "warnings": [
    { "type": "overhead_missing", "message": "11月管理成本未輸入" },
    { "type": "overhead_incomplete", "message": "僅包含：租金、水電", "missing_items": ["網路通訊", "軟體授權", "設備折舊"] }
  ]
}
```
- 計算邏輯（摘要）
  - 加權工時：`weighted_hours = hours × rate_multiplier`
  - 完整時薪成本率：`hourly_cost_rate = salary_rate + overhead_rate`
  - 成本：`cost = weighted_hours × hourly_cost_rate`（拆分為 `salary_cost`、`overhead_cost`）
  - 年終分攤（可選）：按員工年度工時比例分配至該客戶
  - 營收：期間內收據金額合計（排除 cancelled）
  - 毛利：`revenue - labor_cost`；毛利率：`gross_profit / revenue`
- 驗證
  - 日期有效與 `start_date <= end_date`
  - 權限：非管理員 403

### 3.2 員工工時分析
- `GET /api/v1/reports/employee-hours`
- 權限：
  - 管理員：可查所有人
  - 員工：僅回本人資料（忽略 `user_id` 或強制覆寫）
- Query
```json
{ "year": 2025, "month": 10, "user_id": 1 }
```
- 回應（概要）
```json
{
  "success": true,
  "data": [
    {
      "user_id": 1,
      "username": "員工A",
      "total_hours": 180.5,
      "normal_hours": 160.0,
      "overtime_hours": 20.5,
      "billable_hours": 170.0,
      "non_billable_hours": 10.5,
      "utilization_rate": 94.17,
      "client_distribution": [ { "client_id": "123", "company_name": "客戶A", "hours": 80.0, "percentage": 44.32 } ],
      "daily_hours": [ { "date": "2025-10-01", "hours": 8.0 } ]
    }
  ]
}
```

### 3.3 薪資報表
- `GET /api/v1/reports/payroll-summary`
- 權限：管理員
- Query
```json
{ "year": 2025, "month": 10, "user_id": 1 }
```
- 回應（概要）
```json
{
  "success": true,
  "data": {
    "summary": {
      "total_base_salary": 140000,
      "total_allowances": 15200,
      "total_bonuses": 8000,
      "total_overtime_pay": 5230,
      "total_gross_salary": 168430,
      "total_net_salary": 168430
    },
    "by_employee": [
      { "user_id": 1, "username": "員工A", "base_salary": 35000, "total_allowances": 3800, "total_bonuses": 2000, "overtime_pay": 1552, "gross_salary": 42352, "net_salary": 42352, "has_full_attendance": true }
    ]
  }
}
```

### 3.4 收款報表
- `GET /api/v1/reports/revenue`
- 權限：管理員
- Query
```json
{ "start_date": "2025-01-01", "end_date": "2025-10-31" }
```
- 回應（概要）
```json
{
  "success": true,
  "data": {
    "summary": { "total_receipts": 500000, "total_paid": 420000, "total_outstanding": 80000, "collection_rate": 84.0 },
    "monthly_trend": [ { "month": "2025-01", "receipts": 45000, "paid": 42000, "outstanding": 3000 } ],
    "by_client": [ { "client_id": "12345678", "company_name": "客戶A", "total_receipts": 120000, "total_paid": 100000, "total_outstanding": 20000 } ]
  }
}
```

---

## 4) 核心計算邏輯（細節）
- 加權工時：依 `WorkTypes.rate_multiplier` 計算（符合勞基法分段）
- 完整時薪成本率：
  - `salary_rate`：依薪資模組計算（底薪+經常性給與÷240）
  - `overhead_rate`：每小時管理成本（依成本模組）
- 年終獎金分攤（可選）：
  - 員工年度年終 `amount` 依「該年度為該客戶之工時 ÷ 該員工年度總工時」比例分攤
  - 跨年查詢：對每個年度分別計算後加總
- 收據金額與狀態：
  - 僅併入 `status != 'cancelled'` 的收據
- 使用率（工時報表）：
  - `utilization_rate = billable_hours / (working_days × 8) × 100`

---

## 5) 驗證與錯誤
- 日期/年月格式驗證；`start_date <= end_date`
- 角色權限驗證；員工請求管理報表 → 403 FORBIDDEN
- 客戶/員工存在性檢查（如提供）
- 400：`VALIDATION_ERROR`（含訊息）
- 404：`NOT_FOUND`
- 403：`FORBIDDEN`

錯誤格式建議：
```json
{ "success": false, "error": { "code": "VALIDATION_ERROR", "message": "請選擇有效日期區間" } }
```

---

## 6) 效能與快取
- 批次查詢避免 N+1：一次查詢所有涉及的 user/client 資料
- 建議使用 KV 快取：key = `report:client-cost:${start}:${end}:${client}:${yearEnd}`，TTL=3600 秒
- 分頁：大量資料（>100 客戶）支援 `page`/`page_size`
- 索引：`idx_timelogs_date_client`、`idx_receipts_date_status`

---

## 7) 警示（warnings）規格
- `overhead_missing`：本期間無任何管理成本資料
- `overhead_incomplete`：僅部分成本項目，回傳 `missing_items`、`current_total` 等
- 顯示為回應根層 `warnings: Warning[]`

---

## 8) 安全與資料保護
- 僅管理員可存取管理報表；員工僅能查詢自身的報表
- 避免敏感薪資細節外泄：薪資報表僅管理員可用；員工端不提供

---

## 9) 業務需求對應（覆蓋檢核）
- 報表可視權限：符合使用手冊（員工不可見成本/盈利等）
- 客戶成本分析：使用加權工時與管理成本分攤；年終獎金分攤可切換
- 員工工時：提供月度分布、可計費/非計費、使用率、日趨勢
- 薪資報表：月度匯總與個人明細欄位
- 收款報表：總覽、月度趨勢、客戶明細；狀態排除 cancelled

