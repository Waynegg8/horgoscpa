# 儀表板｜後端規格

對應使用手冊：`docs/使用手冊/功能模組-01-儀表板.md`

> 嚴格限定：資料表相依、API 端點、角色回應、核心計算、驗證與性能；完全省略前端畫面。

---

## 1) 角色與權限
- 員工：僅取回個人儀表板（我的工時/任務/假期/近期活動/快速操作/通知）
- 管理員：取回管理員儀表板（公司總覽/財務狀況/待處理/營收趨勢/快速操作/通知）
- 非登入者：401；無權資源：403

---

## 2) 相依資料表（節錄）
- `TimeLogs(user_id, work_date, hours, work_type_id, is_deleted)`
- `ActiveTasks(task_id, client_service_id, assignee_user_id, due_date, status, completed_date, is_deleted)`
- `ActiveTaskStages(task_id, status)`
- `Clients(client_id, company_name)`、`ClientServices(client_service_id, client_id)`
- `LeaveApplications(user_id, leave_type_id, start_date, days, status, applied_at, is_deleted)`、`LeaveTypes(type_name)`
- `EmployeeLeaveBalances(user_id, type, entitled, used, remaining)`（或由規則即時計算）
- `Receipts(receipt_id, client_id, receipt_date, due_date, total_amount, status, is_deleted)`、`Payments(receipt_id, amount, payment_date)`
- `MonthlyPayroll(year, month, gross_salary)`（月度總成本來源之一）
- `Notifications(user_id, type, message, action_url, is_read, is_deleted, created_at)`
- 儀表板設定（可選）：`DashboardWidgets`、`UserDashboardSettings`

索引建議：
```sql
CREATE INDEX idx_timelogs_user_month ON TimeLogs(user_id, work_date);
CREATE INDEX idx_tasks_assignee_due ON ActiveTasks(assignee_user_id, due_date);
CREATE INDEX idx_receipts_status_date ON Receipts(status, receipt_date);
CREATE INDEX idx_payments_date ON Payments(payment_date);
CREATE INDEX idx_notifications_user_created ON Notifications(user_id, created_at);
```

---

## 3) API 端點（/api/v1/dashboard）
- `GET /dashboard`：依角色返回完整儀表板資料
- `GET /dashboard/my-hours`：我的工時統計（員工）
- `GET /dashboard/my-tasks`：我的任務（員工）
- `GET /dashboard/my-leaves`：我的假期（員工）
- `GET /dashboard/recent-activities`：最近動態（員工）
- `GET /dashboard/company-overview`：公司總覽（管理員）
- `GET /dashboard/financial-status`：財務狀況（管理員）
- `GET /dashboard/pending-items`：待處理事項（管理員）
- 設定（可選）：`GET/PUT /dashboard/settings`

回應需遵循完整規格的欄位結構（含 `urgency_level`、`days_until_due`、`collection_rate` 等計算欄位）。

---

## 4) 核心計算邏輯

### 4.1 我的工時（員工）
- 當月字串 `YYYY-MM` → 聚合 `TimeLogs`
- 統計：`total_hours`、`normal_hours`（work_type_id=1）、`overtime_hours`（>1）
- `target_hours` 預設 160；`completion_rate = total_hours / target_hours × 100`（四捨五入至 1 位）

### 4.2 我的任務（員工）
- 篩選 assignee=本人、狀態 in(pending,in_progress)、未刪除
- 進度：`completed_stages / total_stages`
- 逾期：`due_date < today` → `is_overdue=true`，`days_overdue = today - due_date`
- 緊急度：`days_until_due = floor((due - now)/day)`；`<=3 → urgent`、`>7 → low`、其餘 normal；逾期 → `overdue`
- 含 `has_sop`（related_sop_id 或 client_specific_sop_id 非空）

### 4.3 我的假期（員工）
- 餘額：特休/病假由 `EmployeeLeaveBalances` 或規則即時計算
- 補休：顯示小時與最近到期日
- 最近申請：取近 1-3 筆 `LeaveApplications`（時間倒序）

### 4.4 最近動態與通知（員工）
- 動態：
  - 最近 7 天完成任務（完成時間）
  - 最近 7 天的請假（applied_at）
  - 近 7 天的工時缺填提醒（Notifications.type='missing_timesheet'）
- 通知：未讀（is_read=0）、最多 10 筆；`type` 映射至 warning/info

### 4.5 公司總覽（管理員）
- 當月總工時、員工數、出勤率（簡化：出勤人/總人）
- 進行中服務數（依 `ClientServices` 或任務）

### 4.6 財務狀況（管理員）
- 應收（AR）：所有 `Receipts` 狀態 in(unpaid,partial) 的未收金額合計（排除刪除）
- 本月收款：當月 `Payments.amount` 合計
- 逾期金額：`Receipts.due_date < today` 且未收清金額合計
- 營收：當月 `Receipts.total_amount`（排除 cancelled/刪除）
- 成本：`MonthlyPayroll.gross_salary` 合計（簡化）
- 毛利=營收-成本；毛利率=毛利/營收（%）
- 收款率=本月收款/本月營收（%）

### 4.7 待處理事項（管理員）
- 假期待審：`LeaveApplications.status='pending'` 近 N 筆
- 逾期任務：未完成且 `due_date < today` 近 N 筆（含負責人）
- 逾期應收：`Receipts` 未收清且 `due_date < today` 近 N 筆（顯示剩餘金額）

### 4.8 營收趨勢（管理員）
- 近 6 個月：每月 `revenue`/`cost`/`profit`（同上計法）

---

## 5) 驗證與錯誤
- 角色檢查：員工請求管理員端點 → 403；未登入 → 401
- 查詢範圍：日期字串格式驗證（若提供）
- 通用錯誤格式：
```json
{ "success": false, "error": { "code": "FORBIDDEN", "message": "您沒有權限" } }
```

---

## 6) 效能
- 儀表板要求即時；不使用持久快取
- 查詢採批次/聚合避免 N+1；必要欄位索引
- 返回資料量限制：列表各上限 10 筆；活動上限 10 筆

---

## 7) 安全
- 僅回傳本人資料（員工）；不暴露他人敏感數據
- 管理員端匯總不返回個人隱私（如個別薪資項目）

---

## 8) 業務需求對應（覆蓋檢核）
- 員工：我的工時/任務/假期/動態/快速操作/通知
- 管理員：公司總覽/財務/待處理/營收趨勢/快速操作/通知
- 逾期與緊急任務標示，補休到期顯示，財務指標完整
- 即時查詢、權限嚴格、性能 <1s（依資料量調優）
