# 假期管理｜後端規格

對應使用手冊：`docs/使用手冊/功能模組-05-假期管理.md`

> 嚴格限定：資料庫設計、API 端點、核心業務邏輯、計算規則與後端驗證；完全省略前端細節。

---

## 1) 業務與權限（概要）
- 目標：員工申請假期、系統計算餘額、管理生活事件額度、維護國定假日
- 角色（小型事務所彈性）：
  - 員工：申請自己的假、查看自己的餘額、登記生活事件、維護國定假日（允許）
  - 管理員：查看全員假期、統計、維護規則與國定假日、審核假單

---

## 2) 資料庫設計

### 2.1 LeaveApplications（申請單）
- 欄位（加入審核欄位以符合『送審/核准/駁回』業務需求）
```sql
CREATE TABLE IF NOT EXISTS LeaveApplications (
  application_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  leave_type_id INTEGER NOT NULL,
  start_date TEXT NOT NULL,
  end_date TEXT NOT NULL,
  days REAL NOT NULL,
  hours REAL,
  reason TEXT,
  event_type TEXT,
  counts_as_sick_leave BOOLEAN DEFAULT 0,
  status TEXT DEFAULT 'pending',               -- pending|approved|rejected
  approved_by INTEGER,
  approved_at TEXT,
  rejected_reason TEXT,
  applied_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,
  deleted_by INTEGER,
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (leave_type_id) REFERENCES LeaveTypes(leave_type_id),
  FOREIGN KEY (approved_by) REFERENCES Users(user_id),
  FOREIGN KEY (deleted_by) REFERENCES Users(user_id),
  CHECK (status IN ('pending','approved','rejected'))
);
CREATE INDEX IF NOT EXISTS idx_leave_apps_user ON LeaveApplications(user_id);
CREATE INDEX IF NOT EXISTS idx_leave_apps_date ON LeaveApplications(start_date, end_date);
CREATE INDEX IF NOT EXISTS idx_leave_apps_status ON LeaveApplications(status);
```

### 2.2 LeaveTypes（假別）
- 依法定假別與性別限制設置（女性：生理/產/產檢；男性：陪產檢及陪產）
```sql
CREATE TABLE IF NOT EXISTS LeaveTypes (
  leave_type_id INTEGER PRIMARY KEY AUTOINCREMENT,
  type_name TEXT UNIQUE NOT NULL,
  annual_quota REAL,
  deduct_leave BOOLEAN DEFAULT 1,
  is_paid BOOLEAN DEFAULT 1,
  affects_attendance BOOLEAN DEFAULT 1,
  gender_specific TEXT,                   -- 'M'|'F'|NULL
  is_enabled BOOLEAN DEFAULT 1
);
```

### 2.3 AnnualLeaveRules（特休規則）/ AnnualLeaveBalance（特休餘額）
- 同『完整規格』定義（採累積制；去年餘額遞延）

### 2.4 OtherLeaveRules（其他假期規則）/ LifeEventLeaveGrants（生活事件額度）
- 同『完整規格』定義（婚/喪/產等事件產生額度，FIFO 使用與有效期）

### 2.5 PublicHolidays（國定假日）
```sql
CREATE TABLE IF NOT EXISTS PublicHolidays (
  holiday_id INTEGER PRIMARY KEY AUTOINCREMENT,
  holiday_date TEXT NOT NULL,       -- YYYY-MM-DD
  name TEXT NOT NULL,
  source TEXT DEFAULT 'manual',     -- manual|system
  created_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  UNIQUE(holiday_date),
  FOREIGN KEY (created_by) REFERENCES Users(user_id)
);
CREATE INDEX IF NOT EXISTS idx_public_holidays_date ON PublicHolidays(holiday_date);
```

### 2.6 CompensatoryLeaveGrants（補休追蹤）
```sql
CREATE TABLE IF NOT EXISTS CompensatoryLeaveGrants (
  grant_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  source_timelog_id INTEGER,          -- 來源工時記錄 ID
  hours_generated REAL NOT NULL,      -- 產生的補休時數
  hours_used REAL NOT NULL DEFAULT 0, -- 已使用時數
  hours_remaining REAL NOT NULL,      -- 剩餘時數
  generated_date TEXT NOT NULL,       -- 產生日期（YYYY-MM-DD）
  expiry_date TEXT NOT NULL,          -- 到期日（當月底）
  original_rate REAL,                 -- 原始費率（用於轉加班費）
  status TEXT DEFAULT 'active',       -- active|expired|fully_used
  created_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (source_timelog_id) REFERENCES Timesheets(log_id)
);
CREATE INDEX IF NOT EXISTS idx_comp_leave_user_status ON CompensatoryLeaveGrants(user_id, status);
CREATE INDEX IF NOT EXISTS idx_comp_leave_expiry ON CompensatoryLeaveGrants(expiry_date, status);
```

### 2.7 CronJobExecutions / Notifications
- 參考系統基礎規格（年初特休更新；排程失敗通知）

---

## 3) API 設計
基底：`/api/v1`

### 3.1 申請假期
- `POST /leave/applications`
- 權限：員工（申請自己）、管理員（可代申請，是否開放依環境設定）
- Request
```json
{
  "leave_type_id": 1,
  "start_date": "2025-11-20",
  "end_date": "2025-11-22",
  "days": 3,
  "hours": null,
  "reason": "家庭旅遊"
}
```
- 行為（成功）
  - 建立 `pending` 申請單；生理假第 4 日起併入病假邏輯於審核/核可時計入
- 失敗（400）
  - 日期無效/結束早於開始/餘額不足/重疊申請/假別禁用/性別限制不符

### 3.2 查詢我的申請
- `GET /leave/applications?status=pending|approved|rejected`
- 權限：員工（僅本人）、管理員（見全部，或使用 3.4）

### 3.3 查詢餘額
- `GET /leave/balance?year=2025`
- 權限：員工（本人）；管理員可指定 `user_id`

### 3.4 管理員審核清單
- `GET /admin/leave/applications?status=pending&user_id=...&from=...&to=...`
- 權限：管理員

### 3.5 審核操作
- `POST /admin/leave/applications/:id/approve`
```json
{ "notes": "同意，祝旅途愉快" }
```
- 行為：
  - 驗證餘額與重疊 → 通過則 `status='approved'`, `approved_by`, `approved_at`
  - 生理假超過 3 日的部分標記 `counts_as_sick_leave = 1` 並併入病假統計
- `POST /admin/leave/applications/:id/reject`
```json
{ "reason": "高峰期人力不足，請改期" }
```
- 行為：`status='rejected'`, `rejected_reason` 記錄

### 3.6 可申請假別（依性別過濾）
- `GET /leave/available-types?user_id=...`
- 權限：員工/管理員

### 3.7 生活事件登記
- `POST /leave/life-events`
```json
{ "event_type": "結婚", "event_date": "2025-12-15", "description": "婚禮" }
```
- 行為：產生對應 `LifeEventLeaveGrants`（有效期內可分次使用）

### 3.8 國定假日維護
- `GET /holidays`
- `POST /holidays`（員工/管理員皆可；小型事務所彈性）
```json
{ "holiday_date": "2026-01-01", "name": "元旦" }
```
- `DELETE /holidays/:id`

### 3.9 手動觸發 Cron Job（管理員）
- `POST /internal/api/v1/admin/cron/execute`
```json
{ "job_name": "comp_leave_expiry" }
```
- 支援的 Job：
  - `annual_leave_update`：年初特休更新
  - **`comp_leave_expiry`：補休到期轉加班費**
- 行為：
  - 驗證權限（僅管理員）
  - 執行對應邏輯
  - 記錄到 `CronJobExecutions`
  - 返回執行結果與影響筆數

### 3.10 查詢 Cron 執行歷史（管理員）
- `GET /internal/api/v1/admin/cron/history?job_name=comp_leave_expiry`
- 權限：管理員
- 返回：執行時間、狀態、影響筆數、錯誤訊息

---

## 4) 核心業務邏輯（摘要）
- 年資特休（累積制）
  - 依 `AnnualLeaveRules` 計算年度應得；將去年 `remaining_days` 累入新年度 `AnnualLeaveBalance`
- 病假/事假額度
  - 病假 30 天/年、事假 14 天/年；每年 1/1 重置
- 生理假（女性限定）
  - 當年第 1–3 日：不併入病假；第 4 日起：超過部分併入病假（並檢查病假餘額）
- 生活事件假（婚/喪/產等）
  - 依 `OtherLeaveRules` 產生 `LifeEventLeaveGrants`；FIFO 扣抵；需在有效期內申請
- 補休
  - 工時表記錄加班時自動寫入 `CompensatoryLeaveGrants`（1:1 對應；國定/例假日 8 小時內固定 8 小時）
  - 使用補休請假時，依 `generated_date` ASC（FIFO）扣減 `hours_remaining`
  - 每月 1 日 Cron：掃描 `expiry_date` 為上月底的 `status='active'` 且 `hours_remaining > 0` 記錄
    → 計算加班費（`hours_remaining × 時薪 × original_rate`）
    → 寫入當月薪資
    → 更新 `status='expired'`
- 國定假日
  - 用於工作日/天數計算與顯示（排除週末與國定假日的工作天數計算）

---

## 5) 後端驗證規則
- 申請
  - `start_date <= end_date`
  - 不得與本人已核准/待審假期重疊（日期重疊檢查）
  - 假別啟用且符合性別限制
  - 餘額足夠（包含生理假併入病假的聯動檢查）
- 審核
  - 僅 `pending` 可被核准/駁回
  - 核准時再次檢查餘額與重疊，確保一致性
- 國定假日
  - `holiday_date` 格式 `YYYY-MM-DD`、`name` ≤ 50、同日唯一

錯誤格式建議
```json
{
  "success": false,
  "error": { "code": "VALIDATION_ERROR", "message": "結束日期不可早於開始日期" }
}
```
- 其他錯誤碼：`NOT_FOUND`、`FORBIDDEN`、`CONFLICT_OVERLAP`、`INSUFFICIENT_BALANCE`、`GENDER_RESTRICTION`

---

## 6) 權限控制
- 員工：僅能操作與檢視自身申請與餘額；允許維護國定假日（依小型事務所彈性）
- 管理員：可檢視全員、審核、查詢統計、維護假別與國定假日、手動觸發 Cron

---

## 7) 排程與維運
- 年初（1/1 00:00）：建立年度 `AnnualLeaveBalance`（累積去年的剩餘）
- **每月 1 日（00:05）：補休到期轉加班費**
  - 掃描 `CompensatoryLeaveGrants` WHERE `expiry_date = 上月底` AND `status='active'` AND `hours_remaining > 0`
  - 計算加班費：`hours_remaining × (base_salary / 240) × original_rate`
  - 寫入 `CompensatoryOvertimePay` 表（關聯到當月薪資）
  - 更新 `status='expired'`
  - 通知員工與管理員
- 錯誤審計：寫入 `CronJobExecutions` 並發送 `Notifications`（type=`cron_failed`）

---

## 8) 業務需求對應（覆蓋檢核）
- 申請/審核流程：pending→approved/rejected 與對應 API
- 性別過濾：available-types 端點；生理假第4日起併入病假
- 年資特休：依規則表計算；採累積制
- 生活事件：登記→產生額度→有效期內 FIFO 使用
- 國定假日：提供維護 API 以支援工作天數計算與行事曆顯示
