# 薪資管理｜後端規格

對應使用手冊：`docs/使用手冊/功能模組-15-薪資管理.md`、`docs/使用手冊/場景-08-月末薪資計算.md`、`docs/使用手冊/計算邏輯-06-月度薪資完整計算.md`

> 嚴格限定：資料庫設計、API 端點、核心計算邏輯、驗證與權限；完全省略前端細節。

---

## 1) 角色與權限（業務優先）
- 員工：無權限（本模組所有端點 403）
- 管理員：可查看所有人的薪資、計算月度薪資、設定薪資項目、匯出薪資報表、管理年終獎金

---

## 2) 資料庫設計（節錄；沿用完整規格）

### 2.1 Users（擴充）
- 欄位：`base_salary`（底薪，月薪）、`join_date`

### 2.2 SalaryItemTypes（薪資項目類型）
- 欄位：`item_code`（唯一）、`item_name`、`category`（allowance/bonus/deduction）、`is_regular_payment`（經常性給與，計入時薪）、`is_fixed`、`is_active`
- 索引：active、regular_payment

### 2.3 EmployeeSalaryItems（員工薪資項目）
- 欄位：`user_id`、`item_type_id`、`amount`、`effective_date`、`expiry_date`（NULL=永久）、`is_active`
- 月份查詢：月份專屬優先，其次預設值（詳見完整規格）

### 2.4 MonthlyPayroll（月度薪資）
- 每人每月唯一；保存計算結果（底薪、各小計、加班費分類、統計、應發/實發）

### 2.5 OvertimeRecords（加班明細）
- 保存月份計算分解（來源工時、型別、倍率、時薪基準、加班費、是否補休）

### 2.6 YearEndBonus（年終獎金）
- 欄位：`user_id`、`attribution_year`（歸屬年度）、`amount`、`payment_year/month/date`、`decision_date`
- 唯一：每人每年度一筆

---

## 3) API 設計（/api/v1/admin/...）

### 3.1 薪資項目類型
- `GET  /admin/salary-item-types`
- `POST /admin/salary-item-types`
- `PUT  /admin/salary-item-types/:id`
- `DELETE /admin/salary-item-types/:id`

驗證：
- `item_code` 必填唯一 `^[A-Z0-9_]{1,20}$`
- `item_name` ≤ 50；`category` ∈ {allowance, bonus, deduction}

### 3.2 員工薪資設定
- `GET  /admin/users/:id/salary`（查底薪與有效項目）
- `PUT  /admin/users/:id/salary`（整批更新：底薪 + 項目）
- `PUT  /admin/users/:id/salary-items/:employeeItemId`（單筆項目；支援月度專屬）
- `POST /admin/salary-items/batch-update`（批次更新指定項目，如：PERFORMANCE 月度調整）

驗證：
- 金額 ≥ 0；日期格式 `YYYY-MM-01`；月份專屬需同月 `YYYY-MM-01 ~ YYYY-MM-末`

### 3.3 薪資計算與查詢
- `POST /admin/payroll/calculate`（計算指定月份；可選 user_id）
- `GET  /admin/payroll`（查詢薪資記錄，支持 year/month/user_id）
- `GET  /admin/payroll/:id`（薪資明細）
- `PUT  /admin/payroll/:id/adjust`（當月調整項目金額，如績效覆蓋）
- 匯出端點（可選）：`GET /admin/payroll/export?year=...&month=...&format=csv|pdf`

### 3.4 年終獎金管理
- `GET  /admin/year-end-bonus`（列表）
- `POST /admin/year-end-bonus`（新增）
- `PUT  /admin/year-end-bonus/:id`（更新）
- `DELETE /admin/year-end-bonus/:id`（刪除）
- `GET  /admin/year-end-bonus/summary?attribution_year=YYYY`（彙總）

---

## 4) 核心計算邏輯

### 4.1 時薪基準（勞基法）
- `hourly_base = (底薪 + Σ經常性給與金額) ÷ 240`
- 經常性給與：`SalaryItemTypes.is_regular_payment = 1`（全勤、各津貼、每月績效等）

### 4.2 加班費（分段倍率）
- 平日第 9-10 小時：1.34；第 11-12 小時：1.67
- 休息日：前 2 小時 1.34；第 3-8 小時 1.67；第 9-12 小時 2.67
- 國定/例假日：8 小時內雙倍薪（統一以 8 小時計算），之後依分段
- 選擇補休的加班不計入加班費（而計入補休模組）

### 4.3 全勤判定
- 病假/事假扣全勤；特休/補休/婚喪公產（含產檢/陪產）不扣

### 4.4 月度薪資計算步驟
1) 讀取底薪與當月有效經常性給與 → 計算時薪基準
2) 讀取當月加班工時 → 依型別分段計算加班費
3) 判定全勤 → 決定是否給全勤獎金
4) 匯總：`gross_salary = 底薪 + 津貼 + 獎金 + 加班費 - 扣款(暫無)`；`net_salary = gross_salary - 扣款`
5) 保存 `MonthlyPayroll` 與 `OvertimeRecords`

### 4.5 年終獎金分攤（供報表使用）
- 客戶成本查詢勾選「包含年終」時：按員工於歸屬年度在該客戶工時占比分攤 `YearEndBonus.amount`

---

## 5) 驗證與錯誤
- 權限：非管理員 → 403 FORBIDDEN
- 參數：金額 ≥ 0；日期/月格式正確；唯一鍵衝突（回 409 CONFLICT）
- 通用錯誤格式：
```json
{ "success": false, "error": { "code": "VALIDATION_ERROR", "message": "請輸入有效金額" } }
```

---

## 6) 效能與一致性
- 月份計算支援針對特定員工或全部員工；批次計算使用交易包覆
- 索引：`idx_payroll_date`、`idx_employee_salary_items_date`、`idx_overtime_user_date`
- 不建議快取計算結果以外的即時計算邏輯；查詢以聚合 SQL 避免 N+1

---

## 7) 安全與隱私
- 僅管理員可存取；薪資資料屬高度敏感
- 日誌：建議對薪資變更與年終設定記錄稽核（操作者、時間、差異）

---

## 8) 業務需求對應（覆蓋檢核）
- 角色：員工無權限；管理員可查看/計算/設定/匯出
- 薪資組成：底薪/津貼/獎金/加班費（扣款暫不包含）
- 自由設定：可新增項目、每人不同、支援月度績效調整
- 年終獎金：獨立管理且支援歸屬年度；可於成本分析按年度分攤
