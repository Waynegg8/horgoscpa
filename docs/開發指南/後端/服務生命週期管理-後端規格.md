# 服務生命週期管理｜後端規格

> 僅包含資料庫設計、API 設計、核心業務邏輯、計算規則與後端驗證；完全省略前端細節。

---

## 1. 狀態與權限定義（業務）
- 服務狀態（枚舉）：`active`｜`suspended`｜`expired`｜`cancelled`
- 角色權限（小型事務所彈性）：
  - 員工：允許 暫停、恢復、查看歷史
  - 管理員：允許 暫停、恢復、取消、查看所有服務狀態、查看歷史

---

## 2. 資料庫設計

### 2.1 ClientServices（既有表，新增欄位）
- 欄位
  - `status` TEXT NOT NULL DEFAULT 'active'  // active｜suspended｜expired｜cancelled
  - `suspended_at` DATETIME NULL
  - `resumed_at` DATETIME NULL
  - `suspension_reason` TEXT NULL
  - `suspension_effective_date` DATE NULL  // 支援預約暫停日期（業務需求）
  - `auto_renew` BOOLEAN NOT NULL DEFAULT 1
  - `cancelled_at` DATETIME NULL
  - `cancelled_by` INTEGER NULL  // FK Users(user_id)
  - 其餘（如 `start_date`, `end_date`, `client_id`, `service_id`, ...）為既有欄位
- 索引建議
  - `idx_client_services_status` on (status)
  - `idx_client_services_suspend_effective` on (suspension_effective_date)

SQL（示意）：
```sql
ALTER TABLE ClientServices ADD COLUMN status TEXT DEFAULT 'active';
ALTER TABLE ClientServices ADD COLUMN suspended_at TEXT;
ALTER TABLE ClientServices ADD COLUMN resumed_at TEXT;
ALTER TABLE ClientServices ADD COLUMN suspension_reason TEXT;
ALTER TABLE ClientServices ADD COLUMN suspension_effective_date TEXT; -- YYYY-MM-DD
ALTER TABLE ClientServices ADD COLUMN auto_renew BOOLEAN DEFAULT 1;
ALTER TABLE ClientServices ADD COLUMN cancelled_at TEXT;
ALTER TABLE ClientServices ADD COLUMN cancelled_by INTEGER;
```

### 2.2 ServiceChangeHistory（新增表）
- 欄位
  - `change_id` INTEGER PK AUTOINCREMENT
  - `client_service_id` INTEGER NOT NULL  // FK ClientServices(client_service_id)
  - `old_status` TEXT
  - `new_status` TEXT
  - `changed_by` INTEGER NOT NULL         // FK Users(user_id)
  - `changed_at` DATETIME DEFAULT (datetime('now'))
  - `reason` TEXT NULL
  - `notes` TEXT NULL
- 索引
  - `idx_service_change_service` on (client_service_id)
  - `idx_service_change_date` on (changed_at)

SQL（示意）：
```sql
CREATE TABLE ServiceChangeHistory (
  change_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_service_id INTEGER NOT NULL,
  old_status TEXT,
  new_status TEXT,
  changed_by INTEGER NOT NULL,
  changed_at TEXT DEFAULT (datetime('now')),
  reason TEXT,
  notes TEXT,
  FOREIGN KEY (client_service_id) REFERENCES ClientServices(client_service_id),
  FOREIGN KEY (changed_by) REFERENCES Users(user_id)
);
CREATE INDEX idx_service_change_service ON ServiceChangeHistory(client_service_id);
CREATE INDEX idx_service_change_date ON ServiceChangeHistory(changed_at);
```

> 記錄原則：只有「實際生效」之狀態變更需寫入歷史。預約暫停的建立行為可省略歷史（或以 `notes` 記錄在生效當下）。

---

## 3. API 設計
基底路徑：`/api/v1/client-services`

### 3.1 暫停服務（支援預約）
- `POST /api/v1/client-services/:id/suspend`
- 權限：員工、管理員
- Request
```json
{
  "reason": "客戶要求暫時中止",
  "notes": "預計3個月後恢復",
  "effective_date": "2025-12-01"  // 必填，格式 YYYY-MM-DD；可為今日或未來
}
```
- 行為
  - 若 `effective_date` ≤ 今日：立即生效
    - 設 `status = 'suspended'`, `suspended_at = now()`, `suspension_reason = reason`, 清空 `suspension_effective_date`
    - 寫入 `ServiceChangeHistory`
  - 若 `effective_date` > 今日：建立排程
    - 僅寫入 `suspension_effective_date = effective_date` 與 `suspension_reason = reason`
    - 當日不變更 `status`（維持 `active`）
- Response（成功）
  - 立即生效：
```json
{
  "success": true,
  "data": {
    "client_service_id": 123,
    "status": "suspended",
    "suspended_at": "2025-10-30T10:00:00Z",
    "message": "服務已暫停"
  }
}
```
  - 排程：
```json
{
  "success": true,
  "data": {
    "client_service_id": 123,
    "status": "active",
    "suspension_effective_date": "2025-12-01",
    "message": "已排程於 2025-12-01 暫停"
  }
}
```
- 驗證與錯誤（400）
  - `effective_date` 缺漏或格式錯誤
  - `effective_date` 早於今日
  - 服務已為 `suspended`／`expired`／`cancelled`
  - 已存在未來 `suspension_effective_date` 時禁止重複排程
- 錯誤（404）
  - 服務不存在

### 3.2 恢復服務
- `POST /api/v1/client-services/:id/resume`
- 權限：員工、管理員
- Request
```json
{ "notes": "客戶已重新啟動服務" }
```
- 行為
  - 僅允許於 `status = 'suspended'` 時恢復
  - 設 `status = 'active'`, `resumed_at = now()`, 清空 `suspended_at`, `suspension_reason`, `suspension_effective_date`
  - 寫入 `ServiceChangeHistory`
- Response（成功）
```json
{
  "success": true,
  "data": {
    "client_service_id": 123,
    "status": "active",
    "resumed_at": "2025-10-30T11:00:00Z",
    "message": "服務已恢復"
  }
}
```
- 驗證與錯誤（400）
  - 當前狀態非 `suspended`
- 錯誤（404）
  - 服務不存在

### 3.3 取消服務（影響較大）
- `POST /api/v1/client-services/:id/cancel`
- 權限：管理員
- Request
```json
{
  "reason": "客戶終止服務",
  "cancel_pending_tasks": true
}
```
- 行為
  - 設 `status = 'cancelled'`, `cancelled_at = now()`, `cancelled_by = current_user`
  - 寫入 `ServiceChangeHistory`
  - 若 `cancel_pending_tasks = true`，將相關未完成任務狀態改為 `cancelled`
- Response（成功）
```json
{
  "success": true,
  "data": {
    "client_service_id": 123,
    "status": "cancelled",
    "tasks_cancelled": true
  }
}
```
- 驗證與錯誤（400）
  - 已為 `cancelled` 無法重複取消
- 錯誤（404）
  - 服務不存在
- 錯誤（403）
  - 權限不足

### 3.4 查詢服務變更歷史
- `GET /api/v1/client-services/:id/history`
- 權限：員工、管理員（員工僅能查詢有權限之服務）
- Response（成功）
```json
{
  "success": true,
  "data": [
    {
      "change_id": 1,
      "old_status": "active",
      "new_status": "suspended",
      "changed_by": "張管理",
      "changed_at": "2025-12-01T00:00:00Z",
      "reason": "暫停營業 3 個月",
      "notes": ""
    }
  ]
}
```

### 3.5 查詢服務清單（狀態篩選）
- `GET /api/v1/client-services?status={status}`
- 權限：
  - 管理員：可查詢所有
  - 員工：僅查詢自身可見範圍（依產品現行授權模型）

---

## 4. 排程／自動化作業

### 4.1 套用預約暫停
- 觸發：每日 00:00
- 流程
  1. 查 `suspension_effective_date = 今天` 且 `status = 'active'`
  2. 設 `status = 'suspended'`, `suspended_at = now()`；清空 `suspension_effective_date`
  3. 寫入 `ServiceChangeHistory`（`old_status = 'active'`, `new_status = 'suspended'`）

### 4.2 月度任務自動生成（與狀態關聯）
- 觸發：每月 1 日 00:00
- 選取條件（簡述）：
  - `status = 'active'`
  - `start_date <= 本月第一天`
  - （若存在）`suspension_effective_date > 本月第一天`
- 依模板生成任務並通知（細節見任務模組）

### 4.3 到期提醒與自動到期
- 到期提醒：每日執行，提醒 30 天內即將到期之 `active` 且 `auto_renew = 0` 之服務
- 自動到期：每日將 `end_date < 今天` 且 `auto_renew = 0` 的 `active` 服務設為 `expired`

---

## 5. 業務規則（狀態轉換）
```
active → suspended    允許（暫停或預約暫停）
active → cancelled    允許（取消）
active → expired      允許（系統自動）

suspended → active    允許（恢復）
suspended → cancelled 允許（取消）

expired → active      允許（續約）
expired → cancelled   允許（確認取消）

cancelled → active    不允許（需重新建立）
```

---

## 6. 後端驗證規則（摘要）
- 共通
  - `id` 應存在；否則回傳 404
  - 權限檢查：員工 vs 管理員
- 暫停
  - `effective_date` 必填、格式 `YYYY-MM-DD`、不可早於今日
  - 當前狀態不可為 `suspended`／`expired`／`cancelled`
  - 存在未來 `suspension_effective_date` 時不可再次排程
  - `reason` 長度上限 200、`notes` 上限 500
- 恢復
  - 僅允許於 `suspended` 狀態
- 取消
  - 僅管理員可執行
  - `reason` 必填（≤200）

---

## 7. 錯誤格式（建議）
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR", // NOT_FOUND | FORBIDDEN | ...
    "message": "暫停生效日期不可早於今日"
  }
}
```

---

## 8. 覆蓋之業務需求（對應）
- 角色與權限：員工（暫停、恢復、歷史）、管理員（暫停、恢復、取消、狀態總覽）
- 狀態定義：active／suspended／expired／cancelled
- 使用範例：支援『選擇暫停日期（未來）』，於指定日生效並停止自動產生任務；記錄生效時間與原因於歷史
