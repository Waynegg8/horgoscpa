# 附件系統｜後端規格

對應使用手冊：`docs/使用手冊/功能模組-11-附件系統.md`

> 嚴格限定：資料庫、API、核心業務邏輯、驗證與權限；完全省略前端細節。

---

## 1) 角色與權限（業務對應）
- 員工（小型事務所彈性）：可上傳、下載、刪除自身/所屬範圍實體之附件
- 管理員：可上傳、下載、刪除所有附件

> 權限檢查以實體可見性（客戶/收據/任務/SOP 所屬公司或授權）為準。

---

## 2) 資料庫設計（沿用中央 Attachments 表）

### 2.1 Attachments
- 欄位
  - `attachment_id` INTEGER PK AUTOINCREMENT
  - `entity_type` TEXT NOT NULL       -- 'client' | 'receipt' | 'sop' | 'task'
  - `entity_id` TEXT NOT NULL         -- 關聯實體 ID（依各模組定義）
  - `file_name` TEXT NOT NULL         -- 原始檔名
  - `file_path` TEXT NOT NULL         -- 雲端儲存路徑（R2）
  - `file_size` INTEGER               -- bytes
  - `mime_type` TEXT
  - `uploaded_by` INTEGER NOT NULL    -- FK Users(user_id)
  - `uploaded_at` TEXT DEFAULT (datetime('now'))
  - `is_deleted` BOOLEAN DEFAULT 0
- 檢核
  - `CHECK (entity_type IN ('client','receipt','sop','task'))`
- 索引
  - `(entity_type, entity_id)`、`(uploaded_at)`

SQL（示意）
```sql
CREATE TABLE IF NOT EXISTS Attachments (
  attachment_id INTEGER PRIMARY KEY AUTOINCREMENT,
  entity_type TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  file_name TEXT NOT NULL,
  file_path TEXT NOT NULL,
  file_size INTEGER,
  mime_type TEXT,
  uploaded_by INTEGER NOT NULL,
  uploaded_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  FOREIGN KEY (uploaded_by) REFERENCES Users(user_id),
  CHECK (entity_type IN ('client','receipt','sop','task'))
);
CREATE INDEX IF NOT EXISTS idx_attachments_entity ON Attachments(entity_type, entity_id);
CREATE INDEX IF NOT EXISTS idx_attachments_uploaded ON Attachments(uploaded_at);
```

---

## 3) 上傳限制與驗證
- 大小：單檔 ≤ 10MB（10,485,760 bytes）
- MIME 白名單：pdf、jpeg、png、xlsx、xls、docx、doc
- 副檔名白名單：.pdf/.jpg/.jpeg/.png/.xlsx/.xls/.docx/.doc
- 每實體數量上限：
  - client: 20、receipt: 5、sop: 10、task: 10
- 檔名安全：禁止含 `..`、`/`、`\`

錯誤碼建議
- FILE_TOO_LARGE、INVALID_FILE_TYPE、INVALID_EXTENSION、INVALID_FILENAME、TOO_MANY_FILES

---

## 4) 儲存（Cloudflare R2）
- Bucket：`horgoscpa-attachments`
- 路徑：`{entity_type}/{entity_id}/{timestamp}-{rand}.{ext}`
- 下載時以原始檔名提供 `Content-Disposition`；MIME 由資料庫 `mime_type` 設定

---

## 5) API 設計（/api/v1/attachments）

### 5.1 上傳附件
- `POST /api/v1/attachments/upload`（multipart/form-data）
- 權限：登入者（員工或管理員），且對目標實體有存取權
- 欄位
  - file: File（二進位）
  - entity_type: string（'client'|'receipt'|'sop'|'task'）
  - entity_id: string
- 流程
  1) 權限檢查：確認對該實體具可見/可寫入權
  2) 依限制驗證（大小/型別/副檔名/數量/檔名安全）
  3) 上傳到 R2，生成 `file_path`
  4) 新增 Attachments 紀錄
- 回應（成功）
```json
{
  "success": true,
  "data": {
    "attachment_id": 123,
    "file_name": "公司登記證.pdf",
    "file_path": "client/12345678/1730123456-abc123.pdf",
    "file_size": 524288
  }
}
```

### 5.2 查詢附件列表
- `GET /api/v1/attachments?entity_type=client&entity_id=12345678`
- 權限：登入者（需具實體可見權）
- 回應（成功）
```json
{
  "success": true,
  "data": [
    {
      "attachment_id": 123,
      "file_name": "公司登記證.pdf",
      "file_size": 524288,
      "mime_type": "application/pdf",
      "uploaded_by": 1,
      "uploaded_at": "2025-10-28T10:30:00Z"
    }
  ]
}
```

### 5.3 下載附件
- `GET /api/v1/attachments/:id/download`
- 權限：登入者（需具實體可見權）
- 行為：查 DB → 權限檢查 → 從 R2 取檔 → 以 `Content-Disposition` 檔名回應

### 5.4 取得附件詳情
- `GET /api/v1/attachments/:id`
- 權限：登入者（需具實體可見權）

### 5.5 刪除附件（軟刪）
- `DELETE /api/v1/attachments/:id`
- 權限：
  - 小型事務所彈性：員工可刪除；或限制為上傳者與管理員
- 行為：
  - 刪除 R2 檔案
  - `UPDATE Attachments SET is_deleted = 1`
- 回應（成功）`{ "success": true }`

---

## 6) 權限檢查（實體層）
- client：同公司/允許清單內可見
- receipt：收據歸屬之客戶/財務角色可見
- sop：公司內可見；若設計為公開/非公開，須比對 SOP 權限
- task：任務參與者/管理員可見

> 依現行授權模型實作；若授權模型更新，沿用同一檢查函式。

---

## 7) 錯誤格式與狀態碼
- 400：VALIDATION_ERROR（含上述錯誤碼）
- 403：FORBIDDEN（無權限）
- 404：NOT_FOUND（附件或實體不存在）
- 413：PAYLOAD_TOO_LARGE（超過上限）
- 500：INTERNAL_ERROR

通用格式
```json
{
  "success": false,
  "error": { "code": "VALIDATION_ERROR", "message": "檔案大小超過限制（最大 10MB）" }
}
```

---

## 8) 排程與維運
- 週期清理：掃描 `is_deleted = 1` 且超過 N 天 → 刪除 R2 檔案（若尚未刪除）
- 審計：可選擇新增 AttachmentsLog 記錄操作（上傳/下載/刪除）

---

## 9) 業務需求對應覆蓋
- 角色：員工/管理員可上傳、下載、刪除
- 支援實體：客戶、收據、SOP、任務
- 案例：上傳到 R2、紀錄上傳者與時間、可下載查看
- 限制：型別/大小/數量/檔名安全均有驗證

