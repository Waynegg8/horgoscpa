## 工時管理－後端規格

對應使用手冊：`docs/使用手冊/功能模組-03-工時管理.md`、`docs/使用手冊/計算邏輯-01-工時與補休計算.md`

**對應文件：** 使用手冊《功能模組-03-工時管理》《場景-02-員工填寫日常工時》

**範圍：** 資料庫結構、API 設計、核心業務邏輯、計算規則與後端驗證；不含前端畫面細節。

---

## 資料庫設計

### TimeLogs（工時記錄）
- log_id（PK, autoincrement）
- user_id（FK Users.user_id, NOT NULL）
- work_date（TEXT YYYY-MM-DD, NOT NULL）
- client_id（TEXT, 可與外部客戶表對應）
- service_id（INTEGER, 可與外部服務表對應）
- work_type_id（INTEGER, NOT NULL, FK WorkTypes.work_type_id）
- hours（REAL, NOT NULL）
- weighted_hours（REAL, NOT NULL）
- leave_type_id（INTEGER, NULL）
- notes（TEXT）
- created_at（TEXT, DEFAULT now）
- updated_at（TEXT, DEFAULT now）
- is_deleted（BOOLEAN, DEFAULT 0）
- deleted_at（TEXT, NULL）
- deleted_by（INTEGER, NULL, FK Users.user_id）

索引：
- idx_timelogs_user_date（user_id, work_date）
- idx_timelogs_client（client_id）
- idx_timelogs_client_date（client_id, work_date）
- idx_timelogs_date（work_date）

### WorkTypes（工作類型）
- work_type_id（PK）
- type_name（TEXT, UNIQUE, NOT NULL）
- rate_multiplier（REAL, NOT NULL）
- is_overtime（BOOLEAN, DEFAULT 0）
- generates_comp_leave（BOOLEAN, DEFAULT 0）
- sort_order（INTEGER, DEFAULT 0）

預設資料（摘要）：
- 正常工時（1.0）
- 平日加班（前2小時 1.34 / 後2小時 1.67）
- 休息日加班（1.34 / 1.67 / 2.67）
- 國定假日加班（8小時內＝特殊；第9-10＝1.34；第11-12＝1.67）
- 例假日加班（8小時內＝特殊；第9-12＝2.0）

### Holidays（日期屬性）
- holiday_date（TEXT, PK）
- name（TEXT）
- is_national_holiday（BOOLEAN, DEFAULT 0）
- is_weekly_restday（BOOLEAN, DEFAULT 0）
- is_makeup_workday（BOOLEAN, DEFAULT 0）

索引：idx_holidays_date（holiday_date）

### CompensatoryLeave（補休餘額）
- compe_leave_id（PK）
- user_id（FK Users.user_id, NOT NULL）
- hours_earned（REAL, NOT NULL）
- hours_remaining（REAL, NOT NULL）
- earned_date（TEXT, NOT NULL）
- expiry_date（TEXT, NOT NULL）
- source_timelog_id（INTEGER, FK TimeLogs.log_id）
- status（TEXT: active/used/expired/converted，DEFAULT active）
- converted_to_payment（BOOLEAN, DEFAULT 0）
- conversion_date（TEXT, NULL）
- conversion_rate（REAL, NULL）

索引：user、status、expiry_date、earned_date

### CompensatoryLeaveUsage（補休使用記錄）
- usage_id（PK）
- compe_leave_id（FK CompensatoryLeave.compe_leave_id, NOT NULL）
- leave_application_id（INTEGER, NULL）
- timelog_id（INTEGER, NULL, FK TimeLogs.log_id）
- hours_used（REAL, NOT NULL）
- used_date（TEXT, NOT NULL）

索引：compe_leave_id、used_date

### Settings（相關設定：到期規則）
- setting_key（TEXT, PK）
- setting_value（TEXT）
  - comp_leave_expiry_rule ∈ {current_month, next_month, 3_months, 6_months}

---

## 權限規則

- 員工：僅可存取自己的工時（查詢/建立/變更/刪除）。
- 管理員：可查詢所有人的工時與統計；不建議代填，API 可拒絕管理員針對他人建立/變更/刪除。

---

## API 設計

### 查詢工時記錄
- GET /api/v1/timelogs?start_date&end_date&user_id
  - 員工：忽略 user_id，僅回自己的資料。
  - 管理員：可指定 user_id 或多條件篩選。

回應（示例）：
```json
{
  "success": true,
  "data": [
    {"log_id": 1, "work_date": "2025-11-01", "client_id": "123", "service_id": 1, "work_type_id": 1, "hours": 8, "weighted_hours": 8, "notes": "..."}
  ]
}
```

### 新增工時
- POST /api/v1/timelogs
  - 權限：員工僅能為自己新增；管理員預設拒絕為他人新增。

請求（示例）：
```json
{
  "work_date": "2025-11-01",
  "client_id": "123",
  "service_id": 1,
  "work_type_id": 1,
  "hours": 8,
  "notes": ""
}
```

回應（示例）：
```json
{
  "ok": true,
  "code": "SUCCESS",
  "data": {
    "log_id": 10,
    "weighted_hours": 8.0,
    "comp_hours_generated": 0
  },
  "meta": {"requestId": "..."}
}
```

伺服器端處理：
- 驗證（見「後端資料驗證」）。
- 計算 weighted_hours。
- 如屬加班（work_type_id > 1），依規則產生補休（特殊情境見「核心業務邏輯」）。
- **試算表模式優化**：
  - 檢查是否已存在相同 (user_id, work_date, client_id, service_id, work_type_id) 的記錄
  - 如存在，執行 UPDATE 而非 INSERT（避免重複記錄）
  - 回應中包含 weighted_hours 與 comp_hours_generated，供前端即時顯示

### 更新工時
- PUT /api/v1/timelogs/:id
  - 僅限擁有者（或被授權者）。
  - 重新驗證、重算 weighted_hours；必要時調整對應的補休紀錄（簡化：先撤銷原始來源，再依新值重建）。

### 刪除工時（軟刪除）
- DELETE /api/v1/timelogs/:id
  - 僅限擁有者。
  - 標記 is_deleted=1、deleted_at、deleted_by。
  - 若該筆工時曾產生補休且仍為 active，連帶軟刪或標記為無效（避免殘留可用時數）。

### 批次刪除工時（試算表列刪除）
- DELETE /api/v1/timelogs/batch
  - 權限：僅限擁有者
  - 用途：刪除試算表中某一列的所有工時記錄

請求（示例）：
```json
{
  "user_id": 1,
  "start_date": "2025-11-04",
  "end_date": "2025-11-10",
  "client_id": "123",
  "service_id": 1,
  "work_type_id": 1
}
```

回應（示例）：
```json
{
  "ok": true,
  "code": "SUCCESS",
  "data": {
    "deleted_count": 5
  },
  "meta": {"requestId": "..."}
}
```

伺服器端處理：
- 查詢符合條件的所有記錄（user_id, date範圍, client_id, service_id, work_type_id）
- 批次標記為軟刪除
- 調整相關的補休記錄
- 回傳刪除的記錄數

### 彙總查詢（供儀表板/頁面彙總）
- GET /api/v1/timelogs/summary?start_date&end_date&user_id
  - 回傳總工時、加班工時、加權工時等彙總欄位。

### 參考資料（依賴）
- GET /api/v1/holidays?start_date&end_date（傳回每日 is_national_holiday/is_weekly_restday/is_makeup_workday）。
- GET /api/v1/clients、GET /api/v1/services（提供下拉清單資料）。

---

## 後端資料驗證

- 必填：work_date、client_id、service_id、work_type_id、hours。
- hours 必須為 0.5 的倍數；範圍 0.5–12。
- 同一 user 的同一 work_date 合計 hours ≤ 12（需跨記錄彙整檢查）。
- 日期/種類一致性：
  - 補班日不可使用任何「休息日加班」類型。
  - 非國定假日不可使用「國定假日加班」類型；非例假日不可使用「例假日加班」類型。
  - 「8 小時內」類型（國定/例假）單筆 hours ≤ 8。

錯誤碼（示例）：
- HOURS_INVALID_STEP、HOURS_OUT_OF_RANGE、DAY_TOTAL_EXCEEDED
- WORK_TYPE_NOT_ALLOWED_FOR_DATE、HOLIDAY_8H_CAP_EXCEEDED
- FORBIDDEN_NOT_OWNER

---

## 核心業務邏輯與計算

### 加權工時計算
- 一般：weighted_hours = hours × rate_multiplier。
- 特殊（國定假日 8 小時內、例假日 8 小時內）：weighted_hours = 8.0（與實際 hours 無關）。
- 超過 8 小時的部分（國定/例假）：依對應後續類型的 rate_multiplier 計算並加總。

### 補休產生
- 一般加班（平日/休息日）：補休 = 實際加班時數（1:1）。
- 國定/例假日「8 小時內」：補休固定 8 小時。
- 儲存補休時保留來源 timelog_id、earned_date、expiry_date（由 Settings.comp_leave_expiry_rule 決定）。

### 更新/刪除的補休調整（簡化策略）
- 更新：若關鍵欄位（work_type_id/hours/work_date）改變，撤銷原來源補休後，按新值重建補休。
- 刪除：若來源補休仍 active，標記為 is_deleted 或作廢處理，避免殘留可用時數。

---

## 事件與批次作業（與工時相關）

- 每日工時缺填檢查（可選）：工作日 08:30 檢查昨日是否無工時且無請假，產生通知給員工與管理員彙總。（如採用，請使用 Notifications 表並避免重複通知）

---

## 其他

- 審計欄位（created_at/updated_at/deleted_at/deleted_by）皆需正確維護。
- 索引需覆蓋最常見查詢：依 user/date、client/date、date 範圍查詢。


