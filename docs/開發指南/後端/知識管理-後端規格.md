# 知識管理（內部知識庫）｜後端規格

> 嚴格限定：資料庫設計、API 端點、核心業務邏輯、後端驗證；不含任何前端畫面細節。

---

## 1) 角色與權限（業務對應）
- 員工：可 查看 / 新增 / 編輯 / 發布 SOP；可指派客戶專屬 SOP；可提交建議
- 管理員：具上述權限，另可 刪除 SOP；可管理建議狀態

---

## 2) 資料庫設計

### 2.1 SOPDocuments（SOP 文件）
- 欄位
  - `sop_id` INTEGER PK AUTOINCREMENT
  - `title` TEXT NOT NULL
  - `content` TEXT NOT NULL           -- HTML 內容
  - `category` TEXT
  - `tags` TEXT                       -- JSON 陣列字串
  - `version` INTEGER DEFAULT 1       -- 版本自動遞增
  - `is_published` BOOLEAN DEFAULT 0
  - `created_by` INTEGER NOT NULL     -- FK Users(user_id)
  - `created_at` TEXT DEFAULT (datetime('now'))
  - `updated_at` TEXT DEFAULT (datetime('now'))
  - `is_deleted` BOOLEAN DEFAULT 0
- 索引
  - `idx_sop_published` (is_published)
  - `idx_sop_category` (category)
  - `idx_sop_creator` (created_by)

SQL（示意）
```sql
CREATE TABLE IF NOT EXISTS SOPDocuments (
  sop_id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  category TEXT,
  tags TEXT,
  version INTEGER DEFAULT 1,
  is_published BOOLEAN DEFAULT 0,
  created_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  FOREIGN KEY (created_by) REFERENCES Users(user_id)
);
CREATE INDEX IF NOT EXISTS idx_sop_published ON SOPDocuments(is_published);
CREATE INDEX IF NOT EXISTS idx_sop_category ON SOPDocuments(category);
CREATE INDEX IF NOT EXISTS idx_sop_creator ON SOPDocuments(created_by);
```

### 2.2 SOPAttachments（SOP 附件）
- 欄位（新增以符合「可附加檔案」需求）
  - `attachment_id` INTEGER PK AUTOINCREMENT
  - `sop_id` INTEGER NOT NULL         -- FK SOPDocuments(sop_id)
  - `file_name` TEXT NOT NULL
  - `storage_key` TEXT NOT NULL       -- 檔案儲存鍵/URL
  - `content_type` TEXT
  - `file_size_bytes` INTEGER
  - `uploaded_by` INTEGER NOT NULL    -- FK Users(user_id)
  - `uploaded_at` TEXT DEFAULT (datetime('now'))
  - `is_deleted` BOOLEAN DEFAULT 0
- 索引
  - `idx_sop_attachments_sop` (sop_id)

SQL（示意）
```sql
CREATE TABLE IF NOT EXISTS SOPAttachments (
  attachment_id INTEGER PRIMARY KEY AUTOINCREMENT,
  sop_id INTEGER NOT NULL,
  file_name TEXT NOT NULL,
  storage_key TEXT NOT NULL,
  content_type TEXT,
  file_size_bytes INTEGER,
  uploaded_by INTEGER NOT NULL,
  uploaded_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  FOREIGN KEY (sop_id) REFERENCES SOPDocuments(sop_id),
  FOREIGN KEY (uploaded_by) REFERENCES Users(user_id)
);
CREATE INDEX IF NOT EXISTS idx_sop_attachments_sop ON SOPAttachments(sop_id);
```

### 2.3 ClientSOPLinks（客戶專屬 SOP）
- 欄位
  - `link_id` INTEGER PK AUTOINCREMENT
  - `client_id` TEXT NOT NULL         -- FK Clients(client_id)
  - `sop_id` INTEGER NOT NULL         -- FK SOPDocuments(sop_id)
  - `assigned_by` INTEGER NOT NULL    -- FK Users(user_id)
  - `assigned_at` TEXT DEFAULT (datetime('now'))
  - `notes` TEXT
  - UNIQUE(client_id, sop_id)

SQL（示意）
```sql
CREATE TABLE IF NOT EXISTS ClientSOPLinks (
  link_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  sop_id INTEGER NOT NULL,
  assigned_by INTEGER NOT NULL,
  assigned_at TEXT DEFAULT (datetime('now')),
  notes TEXT,
  UNIQUE(client_id, sop_id),
  FOREIGN KEY (client_id) REFERENCES Clients(client_id),
  FOREIGN KEY (sop_id) REFERENCES SOPDocuments(sop_id),
  FOREIGN KEY (assigned_by) REFERENCES Users(user_id)
);
CREATE INDEX IF NOT EXISTS idx_client_sop_client ON ClientSOPLinks(client_id);
CREATE INDEX IF NOT EXISTS idx_client_sop_sop ON ClientSOPLinks(sop_id);
```

### 2.4 SOPSuggestions（SOP 改進建議）
- 欄位（新增以符合「建議修改」需求）
  - `suggestion_id` INTEGER PK AUTOINCREMENT
  - `sop_id` INTEGER NOT NULL         -- FK SOPDocuments(sop_id)
  - `content` TEXT NOT NULL
  - `status` TEXT DEFAULT 'open'      -- open｜resolved
  - `suggested_by` INTEGER NOT NULL   -- FK Users(user_id)
  - `suggested_at` TEXT DEFAULT (datetime('now'))
  - `resolved_by` INTEGER NULL        -- FK Users(user_id)
  - `resolved_at` TEXT NULL
- 索引
  - `idx_suggestions_sop` (sop_id)
  - `idx_suggestions_status` (status)

SQL（示意）
```sql
CREATE TABLE IF NOT EXISTS SOPSuggestions (
  suggestion_id INTEGER PRIMARY KEY AUTOINCREMENT,
  sop_id INTEGER NOT NULL,
  content TEXT NOT NULL,
  status TEXT DEFAULT 'open',
  suggested_by INTEGER NOT NULL,
  suggested_at TEXT DEFAULT (datetime('now')),
  resolved_by INTEGER,
  resolved_at TEXT,
  FOREIGN KEY (sop_id) REFERENCES SOPDocuments(sop_id),
  FOREIGN KEY (suggested_by) REFERENCES Users(user_id),
  FOREIGN KEY (resolved_by) REFERENCES Users(user_id)
);
CREATE INDEX IF NOT EXISTS idx_suggestions_sop ON SOPSuggestions(sop_id);
CREATE INDEX IF NOT EXISTS idx_suggestions_status ON SOPSuggestions(status);
```

---

## 3) API 設計
基底：`/api/v1`

### 3.1 SOP 文件
- GET `/sop`  查詢（支援 q、category、tags、published）
- POST `/sop`  建立（員工/管理員）
- GET `/sop/:id`  讀取
- PUT `/sop/:id`  更新（員工/管理員；version 自動 +1）
- DELETE `/sop/:id`  刪除（僅管理員；軟刪）
- POST `/sop/:id/publish`  發布（員工/管理員）
- POST `/sop/:id/unpublish`  取消發布（員工/管理員）

Request（POST/PUT）示例
```json
{
  "title": "月結作業標準流程",
  "content": "<h2>步驟 1</h2>...",
  "category": "記帳流程",
  "tags": ["月結", "報表"],
  "is_published": true
}
```

### 3.2 SOP 附件
- GET `/sop/:id/attachments`
- POST `/sop/:id/attachments`  上傳（multipart/form-data）
- DELETE `/sop/:id/attachments/:attachmentId`  移除（員工/管理員；或僅上傳者/管理員）

附件上傳規範
- 型別：pdf、docx、xlsx、csv、png、jpg
- 單檔 ≤ 10MB；每 SOP 附件數量建議 ≤ 10（伺服器可再限制）

### 3.3 客戶專屬 SOP 指派
- GET `/clients/:clientId/sop`  查詢該客戶 SOP
- POST `/clients/:clientId/sop`  指派（員工/管理員）
- DELETE `/clients/:clientId/sop/:sopId`  取消指派（員工/管理員）

Request（POST）
```json
{ "sop_id": 12, "notes": "客製流程" }
```

### 3.4 SOP 改進建議
- GET `/sop/:id/suggestions`  列表（依時間倒序）
- POST `/sop/:id/suggestions`  提交（所有人）
- PATCH `/sop/:id/suggestions/:suggestionId`  更新狀態（管理員：open→resolved）

Request（POST）
```json
{ "content": "新增常見科目對照表" }
```

---

## 4) 核心業務邏輯
- 版本控制
  - 新增：`version = 1`
  - 更新（PUT）：`version = version + 1`；`updated_at = now()`
- 發布/取消發布
  - 切換 `is_published`；記錄 `updated_at`
- 客戶指派唯一性
  - `UNIQUE(client_id, sop_id)`；重複建立回傳 409
- 附件
  - 檔案驗證（型別/大小）→ 上傳儲存 → 建立 `SOPAttachments`
- 建議
  - 提交時建立 `open`；管理員可將 `status` 設為 `resolved` 並記錄 `resolved_*`

---

## 5) 後端驗證規則
- SOP
  - `title` 必填（長度 ≤ 100）
  - `content` 必填（HTML 非空）
  - `tags` 最多 10；每個長度 ≤ 30
  - `category` 可選（長度 ≤ 50）
- 附件
  - 型別白名單：pdf、docx、xlsx、csv、png、jpg
  - 單檔大小 ≤ 10MB；數量限制可在伺服器端保護
- 指派
  - `client_id`、`sop_id` 必填且存在
  - 不可重複指派（唯一鍵衝突回 409）
- 建議
  - `content` 必填；長度 ≤ 500
- 權限
  - 刪除 SOP 僅管理員；其餘（新增/編輯/發布/指派）員工亦可

---

## 6) 回應與錯誤格式（建議）
```json
{
  "success": false,
  "error": { "code": "VALIDATION_ERROR", "message": "標題為必填" }
}
```
- 409：`DUPLICATE_LINK`（客戶已指派該 SOP）
- 403：`FORBIDDEN`（權限不足）
- 404：`NOT_FOUND`（資源不存在）

---

## 7) 與其他模組整合（資料/API 層）
- 任務模組：任務詳情可顯示通用 SOP 與客戶專屬 SOP 連結（由任務模組查詢 `ClientSOPLinks` 與 `SOPDocuments`）

---

## 8) 業務需求對應覆蓋
- 角色：員工可查看/新增/編輯/發布/指派；管理員可刪除
- SOP 欄位：標題、內容（富文本）、分類、標籤、版本、是否發布、附件
- 客戶專屬 SOP：指派/取消指派、唯一性
- 建議修改：提交/管理建議
