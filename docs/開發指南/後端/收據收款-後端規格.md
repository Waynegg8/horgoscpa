## 收據收款－後端規格

對應使用手冊：`docs/使用手冊/功能模組-07-收據收款管理.md`、`docs/使用手冊/場景-06-開立收據並記錄收款.md`、`docs/使用手冊/場景-09-逾期應收帳款管理.md`

**範圍**：資料庫、API、權限、核心邏輯、計算與伺服器端驗證；不含前端畫面。

**依據**：優先遵循《使用手冊》（功能模組－收據收款管理、場景 6）。

---

## 資料庫設計（DDL 摘要）

```sql
-- 收據（無稅額；會計師事務所使用收據而非發票）
CREATE TABLE Receipts (
  receipt_id TEXT PRIMARY KEY,            -- 格式：YYYYMM-NNN
  client_id TEXT NOT NULL,
  receipt_date TEXT NOT NULL,
  due_date TEXT,
  total_amount REAL NOT NULL,
  status TEXT DEFAULT 'unpaid',           -- unpaid, partial, paid, cancelled
  is_auto_generated BOOLEAN DEFAULT 1,
  notes TEXT,
  created_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,
  deleted_by INTEGER,
  FOREIGN KEY (client_id) REFERENCES Clients(client_id),
  FOREIGN KEY (created_by) REFERENCES Users(user_id),
  FOREIGN KEY (deleted_by) REFERENCES Users(user_id)
);
CREATE INDEX idx_receipts_client ON Receipts(client_id);
CREATE INDEX idx_receipts_date ON Receipts(receipt_date);
CREATE INDEX idx_receipts_status ON Receipts(status);
CREATE INDEX idx_receipts_status_due ON Receipts(status, due_date);
CREATE INDEX idx_receipts_client_status ON Receipts(client_id, status);

-- 收據項目
CREATE TABLE ReceiptItems (
  item_id INTEGER PRIMARY KEY AUTOINCREMENT,
  receipt_id TEXT NOT NULL,
  service_id INTEGER,
  description TEXT NOT NULL,
  quantity REAL DEFAULT 1,
  unit_price REAL NOT NULL,
  amount REAL NOT NULL,
  FOREIGN KEY (receipt_id) REFERENCES Receipts(receipt_id) ON DELETE CASCADE,
  FOREIGN KEY (service_id) REFERENCES Services(service_id)
);
CREATE INDEX idx_receipt_items_receipt ON ReceiptItems(receipt_id);

-- 收據流水號（月份序列）
CREATE TABLE ReceiptSequence (
  sequence_id INTEGER PRIMARY KEY AUTOINCREMENT,
  year_month TEXT UNIQUE NOT NULL,        -- YYYYMM
  last_sequence INTEGER NOT NULL DEFAULT 0,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now'))
);
CREATE INDEX idx_receipt_sequence_ym ON ReceiptSequence(year_month);

-- 收款記錄
CREATE TABLE Payments (
  payment_id INTEGER PRIMARY KEY AUTOINCREMENT,
  receipt_id TEXT NOT NULL,
  payment_date TEXT NOT NULL,
  amount REAL NOT NULL,
  payment_method TEXT,
  reference_number TEXT,
  notes TEXT,
  received_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY (receipt_id) REFERENCES Receipts(receipt_id),
  FOREIGN KEY (received_by) REFERENCES Users(user_id)
);
CREATE INDEX idx_payments_receipt ON Payments(receipt_id);
CREATE INDEX idx_payments_date ON Payments(payment_date);
```

索引用途：
- idx_receipts_status_due：應收帳款與逾期查詢。
- idx_receipts_client_status：客戶應收統計與查詢。

---

## 權限與規則（伺服器端強制）

- 員工：可開立/編輯收據、記錄收款、查詢收據與應收；不可作廢。
- 管理員：擁有員工權限並可作廢收據、執行帳齡與營收報表查詢。
- 作廢收據：軟刪除（is_deleted 或 status = cancelled），不計入應收統計。

---

## API 設計

### 收據

- GET `/api/v1/receipts`（列表查詢；支援狀態、日期、客戶、關鍵字過濾）
- POST `/api/v1/receipts`（開立收據；支援自動/手動號碼）
- GET `/api/v1/receipts/:id`（收據詳情＋項目＋已收金額彙總）
- PUT `/api/v1/receipts/:id`（更新收據與項目）
- DELETE `/api/v1/receipts/:id`（作廢）
- GET `/api/v1/receipts/check-number?number=YYYYMM-NNN`（號碼可用性檢查）

回應格式（成功）：`{ "success": true, "data": ... }`
回應格式（錯誤）：`{ "success": false, "error": { "code": "...", "message": "..." } }`

### 收款

- GET `/api/v1/receipts/:id/payments`（收據的收款記錄）
- POST `/api/v1/receipts/:id/payments`（記錄收款並回寫收據狀態與餘額）
- DELETE `/api/v1/payments/:id`（刪除收款記錄並重算狀態）

### 統計與報表

- GET `/api/v1/receipts/stats`（收據統計）
- GET `/api/v1/receipts/ar-aging?as_of_date=YYYY-MM-DD`（帳齡分析）

---

## 核心業務邏輯

### 收據號碼生成（自動/手動）

- 格式：`YYYYMM-NNN`（NNN 001–999）。
- 手動號碼：
  - 驗證格式：正則 `^\d{6}-\d{3}$`；重複則回 `VALIDATION_ERROR`（已存在）。
- 自動號碼（併發安全）：
  - 使用 ReceiptSequence 的 UPSERT + RETURNING 將 last_sequence 原子加一。
  - 超過 999 時回 `RECEIPT_SEQUENCE_EXCEEDED`。

### 開立/更新收據

- 以項目小計合計 total_amount；⚠️ 不計稅額（符合業務需求）。
- 至少一筆有效項目（quantity > 0、unit_price >= 0）。
- 初始狀態：unpaid。

### 記錄收款

- 新增 Payments 後即時計算已收金額：`SUM(amount)`。
- 更新 Receipts.status：
  - paid：`SUM(amount) >= total_amount`
  - partial：`0 < SUM(amount) < total_amount`
  - unpaid：`SUM(amount) = 0`
- 驗證：本次金額 > 0 且 ≤ 剩餘應收（total_amount - 已收）；超額回 `VALIDATION_ERROR`。

### 作廢收據

- 僅管理員可作廢；設定 `status = 'cancelled'`、寫入 `deleted_at/deleted_by` 或 `is_deleted=1`。
- 作廢後不計入應收與帳齡。

### 應收帳款與逾期

- 逾期條件：`due_date < date('now') AND status IN ('unpaid','partial')`。
- 帳齡分組：
  - current：`days_overdue <= 0`
  - overdue_1_30：1–30
  - overdue_31_60：31–60
  - overdue_61_90：61–90
  - overdue_over_90：>90
- 查詢結果建議包含：
  - `client_payment_notes` 與 `client_notes`（JOIN Clients）供前端提示。

---

## 伺服器端驗證

- receipt_id（手動）：格式、唯一。
- receipt_date 必填；due_date 若提供需為有效日期。
- 項目：description 必填；quantity > 0；unit_price >= 0；amount = quantity × unit_price。
- total_amount > 0。
- 收款：payment_date 必填；amount > 0 且不超過剩餘；payment_method 合法值。
- 權限：
  - 非管理員執行作廢 → FORBIDDEN。
  - 無資料 → NOT_FOUND。

---

## 效能與索引建議

- 應收與逾期查詢：idx_receipts_status_due。
- 客戶維度查詢：idx_receipts_client_status。
- 大量明細載入：對 ReceiptItems(receipt_id) 做索引。

---

## 審計與安全

- 關鍵操作紀錄：created_at/updated_at/deleted_at、created_by/received_by/deleted_by。
- 作廢/刪除採軟刪除策略，保留追溯性。

---

## 與《使用手冊》的對應

- 開立收據：支援自動/手動號碼、格式規則、999 上限、無稅額合計。
- 記錄收款：多次部分收款、自動更新狀態與餘額、超額驗證。
- 應收帳款：逾期判斷、帳齡分組、客戶收款備註輸出。
- 角色權限：員工操作（不含作廢）、管理員可作廢與查詢報表。
