# 外部內容管理（官網 CMS）- 後端規格

對應使用手冊：`docs/使用手冊/功能模組-08-外部內容管理（官網CMS）.md`

> 僅定義資料庫、API、核心業務邏輯與後端驗證。嚴禁包含前端畫面細節。

---

## 1. 角色與權限
- 僅管理員具備「外部內容管理」所有寫入權限（新增/更新/刪除/發布）。
- 員工無存取權限。
- 公開端僅允許讀取「已發布」內容。

授權原則：
- Admin 端點需管理員角色；Public 端點無需登入但只返回 is_published = true 的資料。

---

## 2. 資料庫設計

### 2.1 ExternalArticles（Blog 文章）
```
article_id           INTEGER  PK AUTOINCREMENT
title                TEXT     NOT NULL
slug                 TEXT     NOT NULL UNIQUE   -- 小寫/數字/連字號
summary              TEXT
content              TEXT     NOT NULL          -- HTML
featured_image       TEXT                      -- 檔案 URL
category             TEXT
tags                 TEXT                      -- JSON array 字串
is_published         BOOLEAN  DEFAULT 0
published_at         TEXT
view_count           INTEGER  DEFAULT 0
seo_title            TEXT
seo_description      TEXT
seo_keywords         TEXT
created_by           INTEGER   NOT NULL
created_at           TEXT      DEFAULT (datetime('now'))
updated_at           TEXT      DEFAULT (datetime('now'))
is_deleted           BOOLEAN   DEFAULT 0
```
索引：
- UNIQUE(slug)
- INDEX(category)
- INDEX(is_published)

驗證要點：
- title/content 必填；slug 符合格式且唯一；SEO 長度限制：title ≤ 60、description ≤ 160。
- tags 為 JSON 陣列字串，元素數量 ≤ 10，每個元素長度 ≤ 32。

### 2.2 ExternalFAQ（常見問題）
```
faq_id               INTEGER  PK AUTOINCREMENT
question             TEXT     NOT NULL
answer               TEXT     NOT NULL
category             TEXT
sort_order           INTEGER  DEFAULT 0
is_published         BOOLEAN  DEFAULT 0
view_count           INTEGER  DEFAULT 0
created_at           TEXT     DEFAULT (datetime('now'))
updated_at           TEXT     DEFAULT (datetime('now'))
is_deleted           BOOLEAN  DEFAULT 0
```
索引：INDEX(category), INDEX(is_published), INDEX(sort_order)

驗證要點：question/answer 必填；sort_order 為非負整數。

### 2.3 ResourceCenter（資源下載）
（符合業務需求：含封面圖選填）
```
resource_id          INTEGER  PK AUTOINCREMENT
title                TEXT     NOT NULL
description          TEXT
file_url             TEXT     NOT NULL         -- 物件儲存路徑
file_type            TEXT
file_size            INTEGER                    -- bytes
category             TEXT
cover_image          TEXT                       -- 選填封面圖 URL
is_published         BOOLEAN  DEFAULT 1         -- 業務未要求切換，預設上架
download_count       INTEGER  DEFAULT 0
created_by           INTEGER  NOT NULL
created_at           TEXT     DEFAULT (datetime('now'))
updated_at           TEXT     DEFAULT (datetime('now'))
is_deleted           BOOLEAN  DEFAULT 0
```
索引：INDEX(category), INDEX(is_published), INDEX(file_type)

驗證要點：title 必填；檔案大小 ≤ 10MB；允許副檔名：pdf/xlsx/xls/docx/doc/zip；cover_image（若有）為圖片且 ≤ 5MB。

### 2.4 ExternalServices（服務介紹）
（新增以滿足使用手冊 7.3：記帳、稅務申報、工商登記、財務諮詢）
```
service_id           INTEGER  PK AUTOINCREMENT
service_key          TEXT     NOT NULL UNIQUE   -- bookkeeping/tax/registration/consulting
title                TEXT     NOT NULL
summary              TEXT
content              TEXT     NOT NULL          -- HTML
hero_image           TEXT                       -- 服務封面圖 URL（選填）
is_published         BOOLEAN  DEFAULT 1
sort_order           INTEGER  DEFAULT 0
updated_at           TEXT     DEFAULT (datetime('now'))
is_deleted           BOOLEAN  DEFAULT 0
```
索引：UNIQUE(service_key), INDEX(sort_order), INDEX(is_published)

備註：初始化時預置四筆 service_key；更新採用 upsert 策略。

### 2.5 ExternalImages（圖片資源，選用）
（作為文章/資源/服務封面或內文圖片的物件存證）
```
image_id             INTEGER  PK AUTOINCREMENT
title                TEXT     NOT NULL
image_url            TEXT     NOT NULL
alt_text             TEXT
category             TEXT
file_size            INTEGER
width                INTEGER
height               INTEGER
uploaded_by          INTEGER   NOT NULL
uploaded_at          TEXT      DEFAULT (datetime('now'))
is_deleted           BOOLEAN   DEFAULT 0
```

---

## 3. API 設計

命名空間：
- Admin：/api/v1/admin
- Public：/api/v1/public

### 3.1 Blog 文章（Admin）
- GET /articles
  - 查詢條件：status(draft|published)、category、tag、keyword、paging(sort, page, pageSize)
  - 回傳：列表（含總筆數）
- POST /articles
  - 請求：{ title, slug, summary?, content, featured_image?, category?, tags?, seo_title?, seo_description?, seo_keywords? }
  - 響應：{ article_id, ... }
- GET /articles/:id
  - 回傳：單筆文章
- PUT /articles/:id
  - 請求：同 POST（允許部分欄位更新）
- DELETE /articles/:id
  - 行為：軟刪除 is_deleted = 1
- POST /articles/:id/publish
  - 行為：is_published = true, published_at = now
- POST /articles/:id/unpublish
  - 行為：is_published = false

驗證錯誤碼（示例）：
- 409 slug_conflict：Slug 已存在
- 400 invalid_slug：Slug 格式不符
- 422 validation_failed：必要欄位缺失

### 3.2 Blog 文章（Public）
- GET /articles
  - 僅返回 is_published = true；支援 category、tag、keyword、paging
- GET /articles/:slug
  - 找不到或未發布回 404
  - 副作用：view_count += 1

### 3.3 FAQ（Admin）
- GET /faq
  - 查詢：category、status、keyword、paging
- POST /faq
  - 請求：{ question, answer, category?, sort_order?, is_published? }
- PUT /faq/:id
  - 可更新：question, answer, category, sort_order, is_published
- DELETE /faq/:id
  - 軟刪除
- PUT /faq/reorder（選用）
  - 請求：[{ faq_id, sort_order }, ...] 批次調整排序

### 3.4 FAQ（Public）
- GET /faq
  - 僅返回 is_published = true，並依 sort_order 升冪排序

### 3.5 資源下載（Admin）
- GET /resources
  - 查詢：category、file_type、keyword、paging
- POST /resources/upload
  - 多部份表單：file、metadata(JSON: { title, description?, category?, cover_image? })
  - 行為：檔案大小/副檔名驗證；寫入 ResourceCenter；預設 is_published = 1
- GET /resources/:id
  - 回傳：單筆資源
- PUT /resources/:id
  - 可更新：title, description, category, cover_image
- DELETE /resources/:id
  - 軟刪除（同時可選擇標記物件為待清理）

### 3.6 資源下載（Public）
- GET /resources
  - 僅返回 is_published = true
- GET /resources/:id/download
  - 存在且已發布時：download_count += 1，回傳檔案串流

### 3.7 服務介紹（Admin）
- GET /services
  - 回傳全部服務內容（含未發布）
- GET /services/:serviceKey
  - 依 service_key 取得單筆
- PUT /services/:serviceKey
  - upsert：{ title, summary?, content, hero_image?, is_published?, sort_order? }

### 3.8 服務介紹（Public）
- GET /services
  - 僅返回 is_published = true，依 sort_order 升冪
- GET /services/:serviceKey
  - 未發布或不存在回 404

### 3.9 圖片上傳（選用 Admin）
- POST /images/upload
  - 多部份表單：image、metadata(JSON: { title?, alt_text?, category? })
  - 驗證：image/* 且 ≤ 5MB；回傳 image_url 與尺寸

---

## 4. 核心業務邏輯

### 4.1 Slug 規則（文章）
- 格式：^[a-z0-9]+(-[a-z0-9]+)*$；長度 3–80。
- 產生：由標題轉小寫，移除非字元，空白改為連字號；若衝突則加尾碼 -2/-3...
- 唯一性：資料庫 UNIQUE(slug)；衝突回 409。

### 4.2 發布狀態
- 發布：設 is_published = true, published_at = now。
- 取消發布：設 is_published = false。
- 公開查詢一律過濾 is_published = true 且 is_deleted = 0。

### 4.3 檔案與圖片
- 檔案（資源）：大小 ≤ 10MB；允許 pdf/xlsx/xls/docx/doc/zip；儲存在物件儲存（如 R2/S3 相容），以 resources/yyyymmdd-{timestamp}-{filename} 命名。
- 圖片（封面/內文）：大小 ≤ 5MB；類型 image/*；命名 images/yyyymmdd-{timestamp}-{filename}。
- 刪除策略：記錄軟刪除；實體檔可由離線工作清理。

### 4.4 下載與瀏覽計數
- 文章：Public 端點成功取得單篇時，view_count += 1。
- 資源：下載端點成功取回檔案時，download_count += 1。

### 4.5 FAQ 排序
- 以 sort_order 升冪顯示；提供批次調整端點以減少多次寫入。

### 4.6 服務介紹內容
- 預置 service_key 集：bookkeeping、tax、registration、consulting。
- 更新策略：以 service_key 定位，若不存在則建立。

---

## 5. 後端驗證規則（摘要）
- 文章：title/content 必填；slug 格式與唯一；featured_image（若有）必須為圖片 URL；SEO 欄位長度限制。
- FAQ：question/answer 必填；sort_order 為非負整數。
- 資源：title 必填；file 必填且型別/大小符合限制；cover_image（若有）須為圖片 URL。
- 服務：service_key 為限定值；title/content 必填。

錯誤回傳標準：
- 400 invalid_argument：欄位格式錯誤
- 401 unauthorized / 403 forbidden：未授權/無權限
- 404 not_found：資源不存在或未發布（Public）
- 409 conflict：唯一性衝突（例如 slug）
- 422 validation_failed：驗證失敗與欄位詳情

---

## 6. 效能與索引建議
- 常用查詢索引：articles(is_published, category)、faq(is_published, category, sort_order)、resources(is_published, category, file_type)、services(is_published, sort_order)。
- 清單查詢預設分頁；限制單頁筆數以避免過大回應。

---

## 7. 稽核與安全
- 寫入操作紀錄：created_by/created_at/updated_at；重要動作（發布/取消）記錄審計日誌。
- 檔案與圖片 MIME 嚴格檢查；拒絕可疑內容。
- 公開端點僅回傳 is_published = true 且 is_deleted = 0 的資料。


