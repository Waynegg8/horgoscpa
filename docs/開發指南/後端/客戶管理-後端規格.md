# 客戶管理｜後端規格

對應使用手冊：`docs/使用手冊/功能模組-02-客戶管理.md`

> 嚴格限定：資料庫設計、API 設計、核心業務邏輯、後端驗證與權限；完全省略前端畫面細節。

---

## 1) 業務與權限（概要）
- 目標：記錄客戶資料、分配負責人、標籤管理、客戶服務設定入口
- 權限（小型事務所彈性）：
  - 員工：查詢、建立、更新、刪除、標籤管理
  - 管理員：上述全部 + 批量分配負責人、批量刪除

---

## 2) 資料庫設計

### 2.1 Clients
- 欄位（沿用完整規格並補充刪除稽核）
```sql
CREATE TABLE IF NOT EXISTS Clients (
  client_id TEXT PRIMARY KEY,
  company_name TEXT NOT NULL,
  tax_registration_number TEXT,
  business_status TEXT DEFAULT '營業中',
  assignee_user_id INTEGER NOT NULL,
  phone TEXT,
  email TEXT,
  client_notes TEXT,
  payment_notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,
  deleted_by INTEGER,
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id),
  FOREIGN KEY (deleted_by) REFERENCES Users(user_id)
);
CREATE INDEX IF NOT EXISTS idx_clients_assignee ON Clients(assignee_user_id);
CREATE INDEX IF NOT EXISTS idx_clients_company_name ON Clients(company_name);
```

### 2.2 CustomerTags
```sql
CREATE TABLE IF NOT EXISTS CustomerTags (
  tag_id INTEGER PRIMARY KEY AUTOINCREMENT,
  tag_name TEXT UNIQUE NOT NULL,
  tag_color TEXT,
  created_at TEXT DEFAULT (datetime('now'))
);
```

### 2.3 ClientTagAssignments
```sql
CREATE TABLE IF NOT EXISTS ClientTagAssignments (
  assignment_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  tag_id INTEGER NOT NULL,
  assigned_at TEXT DEFAULT (datetime('now')),
  FOREIGN KEY (client_id) REFERENCES Clients(client_id) ON DELETE CASCADE,
  FOREIGN KEY (tag_id) REFERENCES CustomerTags(tag_id),
  UNIQUE(client_id, tag_id)
);
```

---

## 3) API 設計（/api/v1/clients）

### 3.1 查詢客戶列表
```
GET /api/v1/clients
Query: ?company_name=XX&limit=50&offset=0&fields=client_id,company_name,tags
權限：員工/管理員（小型事務所彈性：員工可看全部）
```
- 回應欄位建議：`client_id, company_name, assignee_name, tags, client_notes, payment_notes, pagination`
- N+1 避免：以 JOIN + GROUP_CONCAT 一次返回 tags

### 3.2 讀取客戶詳情
```
GET /api/v1/clients/:id
權限：員工/管理員
```

### 3.3 新增客戶
```
POST /api/v1/clients
權限：員工/管理員（皆可）
```
- Body 範例：
```json
{
  "client_id": "12345678",
  "company_name": "測試公司",
  "assignee_user_id": 1,
  "phone": "02-1234-5678",
  "email": "test@example.com",
  "client_notes": "喜歡提前收到報表，每月5日前完成",
  "payment_notes": "由財務陳小姐負責，習慣月底轉帳",
  "tag_ids": [1, 2]
}
```

### 3.4 更新客戶
```
PUT /api/v1/clients/:id
權限：員工/管理員（皆可）
```

### 3.5 刪除客戶（軟刪）
```
DELETE /api/v1/clients/:id
權限：員工/管理員（皆可）
```
- 行為：
  - `is_deleted = 1, deleted_at = now(), deleted_by = current_user`

### 3.6 標籤管理
```
GET  /api/v1/clients/tags
POST /api/v1/clients/tags
PUT  /api/v1/clients/tags/:id
DELETE /api/v1/clients/tags/:id
權限：員工/管理員（皆可）
```

### 3.7 批量操作（管理員）
```
POST /api/v1/clients/batch-assign    // 批量分配負責人（上限 100）
POST /api/v1/clients/batch-delete    // 批量刪除（上限 100）
權限：管理員
```
- 回應包含：`total, succeeded, failed, warnings`

---

## 4) 核心業務邏輯
- 建立
  - 驗證 → 檢查唯一性（client_id）→ 建立 → 若有 `tag_ids` 同步建立 `ClientTagAssignments`
- 更新
  - 驗證 → 更新基本欄位 → 標籤同步（依需求：全量覆寫或增刪）
- 刪除（軟刪）
  - 設定 `is_deleted` 與審計欄位；由外鍵 ON DELETE CASCADE 處理標籤連結（或保留）
- 查詢
  - 避免 N+1：以 JOIN 彙總 tags；支援 `fields` 參數（sparse fieldsets）
- 批量
  - 限制 100 筆；使用交易；審計日誌可選（記錄操作者與變更）

---

## 5) 後端驗證規則
- `client_id`：必填、8 位數字、唯一
- `company_name`：必填、長度 1–100
- `email`：如提供需符合 Email 格式
- `phone`：如提供做基本電話格式檢查
- `tag_ids`：如提供需存在於 `CustomerTags`
- 批量分配：`assignee_user_id` 必須存在

錯誤格式範例：
```json
{
  "success": false,
  "error": { "code": "VALIDATION_ERROR", "message": "統一編號必須為8位數字" }
}
```

---

## 6) 權限控制
- 小型事務所彈性：員工對客戶 CRUD 與標籤管理開放；批量操作僅管理員
- 路由中介：驗證登入 → 判定是否為管理員以開放批量端點

---

## 7) 效能與索引
- 以 `idx_clients_company_name` 支援模糊搜尋
- 以 `idx_clients_assignee` 支援以負責人檢索
- 列表分頁：limit/offset，建議預設 50 筆

---

## 8) 業務需求對應覆蓋
- 角色與權限：員工可查詢/新增/修改/刪除/標籤；管理員可批量
- 欄位：統一編號、公司名稱、負責人員、電話、Email、標籤、客戶備註、收款備註
- 重要功能：提供客戶服務設定入口（由其他模組實作任務自動化）
- 批量上限：100 筆
