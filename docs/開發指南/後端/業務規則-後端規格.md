# 業務規則管理｜後端規格

對應使用手冊：`docs/使用手冊/功能模組-10-業務規則管理.md`、`docs/使用手冊/參數配置-06-國定假日參數.md`

> 嚴格限定：資料庫結構、API 端點、權限、核心邏輯與後端驗證；完全省略前端細節。

---

## 1) 角色與權限
- 員工（小型事務所彈性）：
  - 可維護：國定假日、假別類型、服務項目
  - 僅檢視：工作類型費率（依法不可修改）
- 管理員：上述全部；另可管理特休規則、週期類型、批次匯入假日
- 權限錯誤：回 403 FORBIDDEN

---

## 2) 資料庫（沿用完整規格）

### 2.1 Holidays（國定假日/補班日）
```sql
CREATE TABLE IF NOT EXISTS Holidays (
  holiday_id INTEGER PRIMARY KEY AUTOINCREMENT,
  holiday_date TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  is_national_holiday BOOLEAN DEFAULT 1,
  is_makeup_workday BOOLEAN DEFAULT 0,
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0
);
CREATE UNIQUE INDEX IF NOT EXISTS idx_holidays_date ON Holidays(holiday_date);
CREATE INDEX IF NOT EXISTS idx_holidays_makeup ON Holidays(is_makeup_workday);
```

### 2.2 LeaveTypes（假別類型）
```sql
CREATE TABLE IF NOT EXISTS LeaveTypes (
  leave_type_id INTEGER PRIMARY KEY AUTOINCREMENT,
  type_name TEXT UNIQUE NOT NULL,
  annual_quota REAL,
  deduct_leave BOOLEAN DEFAULT 1,
  is_paid BOOLEAN DEFAULT 1,
  gender_specific TEXT,
  is_enabled BOOLEAN DEFAULT 1,
  sort_order INTEGER DEFAULT 0,
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0
);
```

### 2.3 AnnualLeaveRules（特休規則，僅管理員）
```sql
CREATE TABLE IF NOT EXISTS AnnualLeaveRules (
  rule_id INTEGER PRIMARY KEY AUTOINCREMENT,
  min_months INTEGER NOT NULL,
  max_months INTEGER NOT NULL,
  days INTEGER NOT NULL,
  description TEXT
);
```

### 2.4 OtherLeaveRules（其他假期規則）
```sql
CREATE TABLE IF NOT EXISTS OtherLeaveRules (
  rule_id INTEGER PRIMARY KEY AUTOINCREMENT,
  leave_type_id INTEGER NOT NULL,
  event_type TEXT NOT NULL,
  days REAL NOT NULL,
  validity_days INTEGER DEFAULT 365,
  FOREIGN KEY (leave_type_id) REFERENCES LeaveTypes(leave_type_id)
);
```

### 2.5 OvertimeRates（工作類型費率，依法只讀）
```sql
CREATE TABLE IF NOT EXISTS OvertimeRates (
  rate_id INTEGER PRIMARY KEY AUTOINCREMENT,
  work_type_id INTEGER NOT NULL,
  rate_multiplier REAL NOT NULL,
  effective_date TEXT NOT NULL,
  is_current BOOLEAN DEFAULT 1,
  FOREIGN KEY (work_type_id) REFERENCES WorkTypes(work_type_id)
);
```

### 2.6 ServiceFrequencyTypes（週期類型，僅管理員）
```sql
CREATE TABLE IF NOT EXISTS ServiceFrequencyTypes (
  frequency_id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT UNIQUE NOT NULL,
  days_interval INTEGER,
  months_interval INTEGER,
  is_recurring BOOLEAN DEFAULT 1,
  is_enabled BOOLEAN DEFAULT 1,
  sort_order INTEGER DEFAULT 0
);
```

### 2.7 Services（服務項目，最多兩層）
```sql
CREATE TABLE IF NOT EXISTS Services (
  service_id INTEGER PRIMARY KEY AUTOINCREMENT,
  parent_service_id INTEGER,
  service_name TEXT NOT NULL,
  description TEXT,
  sort_order INTEGER DEFAULT 0,
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  FOREIGN KEY (parent_service_id) REFERENCES Services(service_id)
);
CREATE INDEX IF NOT EXISTS idx_services_parent ON Services(parent_service_id);
```

---

## 3) API 端點設計（/api/v1）

### 3.1 國定假日
- `GET /holidays`（員工/管理員）
- `POST /holidays`（員工/管理員）
- `PUT /holidays/:id`（員工/管理員）
- `DELETE /holidays/:id`（員工/管理員）
- `POST /admin/holidays/import`（管理員，CSV 批次匯入）

驗證：
- `holiday_date` 格式 YYYY-MM-DD，唯一
- `name` 必填 ≤ 50

### 3.2 假別類型
- `GET /leave-types`（員工/管理員）
- `POST /leave-types`（員工/管理員）
- `PUT /leave-types/:id`（員工/管理員）
- `POST /leave-types/:id/enable`（員工/管理員）
- `POST /leave-types/:id/disable`（員工/管理員）

驗證：
- `type_name` 必填唯一 ≤ 30
- `annual_quota`（如提供）≥ 0
- `gender_specific` ∈ {'M','F',null}

### 3.3 特休規則（僅管理員）
- `GET /admin/annual-leave-rules`
- `POST /admin/annual-leave-rules`
- `PUT /admin/annual-leave-rules/:id`
- `DELETE /admin/annual-leave-rules/:id`
- `POST /admin/annual-leave-rules/restore-defaults`

驗證：
- `min_months`/`max_months`/`days` 為正整數；`min_months <= max_months`

### 3.4 加班費率（依法只讀）
- `GET /admin/overtime-rates`（管理員；或對所有人開放唯讀端點）
- `POST /admin/overtime-rates/restore-defaults`（管理員，用於重新載入法定表）

限制：
- 禁止一般 `POST`/`PUT` 修改費率（返回 403），以符合勞基法「不可修改」的業務需求

### 3.5 週期類型（僅管理員）
- `GET /admin/frequency-types`
- `POST /admin/frequency-types`
- `PUT /admin/frequency-types/:id`
- `POST /admin/frequency-types/:id/enable`
- `POST /admin/frequency-types/:id/disable`

驗證：
- `name` 唯一且 ≤ 30
- `days_interval` 或 `months_interval` 至少其一為正數

### 3.6 服務項目（員工/管理員）
- `GET /services`
- `POST /services`
- `PUT /services/:id`
- `DELETE /services/:id`（軟刪）

驗證與限制：
- `service_name` 必填 ≤ 50
- 僅允許兩層：若 `parent_service_id` 的父層不為 null → 400 `INVALID_HIERARCHY`
- 刪除時若存在子項：400 `HAS_CHILDREN`

---

## 4) 核心業務邏輯
- 兩層服務層級檢查：create/update 前查父層是否已有上層
- 國定假日唯一性：相同 `holiday_date` 拒絕建立
- 假別類型啟用/停用：切換 `is_enabled`，不移除既有申請資料
- 特休規則恢復預設：刪除現有 → 寫入法定規則 → 觸發全員特休餘額重算（排程或同步）
- 加班費率：僅允許 `restore-defaults`；維持 `is_current` 標記

---

## 5) 後端驗證與錯誤格式
- 400 `VALIDATION_ERROR`：欄位格式錯誤、唯一性衝突、階層限制等
- 403 `FORBIDDEN`：權限不足（如員工嘗試修改費率）
- 404 `NOT_FOUND`：資源不存在

錯誤格式範例：
```json
{ "success": false, "error": { "code": "VALIDATION_ERROR", "message": "holiday_date 已存在" } }
```

---

## 6) 安全與稽核
- 重要變更（假別類型、特休規則、服務項目、假日）建議記錄稽核日誌（操作者、時間、變更內容）

---

## 7) 與其他模組相依
- 國定假日：工時檢查（缺填排除）、加班型別判斷、假期顯示
- 假別類型：假期申請可選清單與前端過濾（性別限制）
- 特休規則：年初特休更新與年資計算
- 服務項目/週期類型：客戶服務設定與任務自動生成
- 加班費率：工時與加班費計算（唯讀來源）

---

## 8) 業務需求對應（覆蓋檢核）
- 國定假日：員工/管理員可維護；日期唯一；補班日支援
- 假別類型：員工/管理員可維護；性別限制、給薪、全勤影響
- 工作類型費率：依法只讀；提供查詢與恢復法定預設
- 服務項目：員工/管理員可維護；限制最多兩層
- 特休規則/週期類型：僅管理員可維護
