## 任務管理－後端規格

對應使用手冊：`docs/使用手冊/功能模組-06-任務管理.md`、`docs/使用手冊/場景-05-月度任務自動生成.md`、`docs/使用手冊/場景-10-員工使用知識庫SOP處理任務.md`

**範圍**：資料庫結構、API 端點、權限、核心業務邏輯、計算與驗證。完全省略前端畫面細節。

**依據**：以《使用手冊》為最高優先（功能模組－任務管理、場景 5、每月自動執行、場景 10）。

---

## 資料庫設計（DDL 摘要）

> 說明重點：支援「任務模板」「客戶服務設定」「每月自動產生任務」「任務階段依序執行」「連結通用/客戶專屬 SOP」。

```sql
-- 任務模板
CREATE TABLE TaskTemplates (
  template_id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_name TEXT NOT NULL,
  service_id INTEGER,
  description TEXT,
  estimated_days INTEGER,
  related_sop_id INTEGER,              -- 通用 SOP 參照
  is_client_specific BOOLEAN DEFAULT 0,
  specific_client_id TEXT,             -- 若為客戶專屬模板
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  FOREIGN KEY (service_id) REFERENCES Services(service_id),
  FOREIGN KEY (related_sop_id) REFERENCES KnowledgeBase(knowledge_id),
  FOREIGN KEY (specific_client_id) REFERENCES Clients(client_id)
);
CREATE INDEX idx_task_templates_client ON TaskTemplates(specific_client_id);

-- 任務階段模板
CREATE TABLE TaskStageTemplates (
  stage_template_id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_id INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_order INTEGER NOT NULL,
  estimated_days INTEGER,
  description TEXT,
  FOREIGN KEY (template_id) REFERENCES TaskTemplates(template_id) ON DELETE CASCADE
);
CREATE INDEX idx_stage_templates_template ON TaskStageTemplates(template_id);
CREATE INDEX idx_stage_templates_order ON TaskStageTemplates(template_id, stage_order);

-- 客戶服務設定（決定何時自動產生任務與使用哪個模板）
CREATE TABLE ClientServices (
  client_service_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  service_id INTEGER NOT NULL,
  frequency_id INTEGER NOT NULL,
  template_id INTEGER,                 -- 通用模板（備用）
  custom_template_id INTEGER,          -- 客戶專屬模板（優先）
  start_date TEXT NOT NULL,
  end_date TEXT,
  status TEXT DEFAULT 'active',        -- active, suspended, expired, cancelled
  trigger_months TEXT,                 -- JSON: [1,3,5,...]
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  FOREIGN KEY (client_id) REFERENCES Clients(client_id),
  FOREIGN KEY (service_id) REFERENCES Services(service_id),
  FOREIGN KEY (frequency_id) REFERENCES ServiceFrequencyTypes(frequency_id),
  FOREIGN KEY (template_id) REFERENCES TaskTemplates(template_id),
  FOREIGN KEY (custom_template_id) REFERENCES TaskTemplates(template_id),
  UNIQUE(client_id, service_id)
);
CREATE INDEX idx_client_services_client ON ClientServices(client_id);
CREATE INDEX idx_client_services_service ON ClientServices(service_id);
CREATE INDEX idx_client_services_status ON ClientServices(status);

-- 自動產生後的任務
CREATE TABLE ActiveTasks (
  task_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_service_id INTEGER NOT NULL,
  template_id INTEGER NOT NULL,
  task_name TEXT NOT NULL,
  start_date TEXT,
  due_date TEXT,
  completed_date TEXT,
  status TEXT DEFAULT 'pending',       -- pending, in_progress, completed, cancelled
  assignee_user_id INTEGER,
  related_sop_id INTEGER,              -- 通用 SOP
  client_specific_sop_id INTEGER,      -- 客戶專屬 SOP
  notes TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,
  deleted_by INTEGER,
  FOREIGN KEY (client_service_id) REFERENCES ClientServices(client_service_id),
  FOREIGN KEY (template_id) REFERENCES TaskTemplates(template_id),
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id),
  FOREIGN KEY (related_sop_id) REFERENCES KnowledgeBase(knowledge_id),
  FOREIGN KEY (client_specific_sop_id) REFERENCES KnowledgeBase(knowledge_id),
  FOREIGN KEY (deleted_by) REFERENCES Users(user_id)
);
CREATE INDEX idx_active_tasks_service ON ActiveTasks(client_service_id);
CREATE INDEX idx_active_tasks_assignee ON ActiveTasks(assignee_user_id);
CREATE INDEX idx_active_tasks_status ON ActiveTasks(status);
CREATE INDEX idx_active_tasks_due_date ON ActiveTasks(due_date);
-- 儀表板/我的任務最佳化
CREATE INDEX idx_active_tasks_assignee_status ON ActiveTasks(assignee_user_id, status, due_date);
-- 逾期檢測最佳化
CREATE INDEX idx_active_tasks_due_status ON ActiveTasks(due_date, status);

-- 任務階段（依序完成）
CREATE TABLE ActiveTaskStages (
  active_stage_id INTEGER PRIMARY KEY AUTOINCREMENT,
  task_id INTEGER NOT NULL,
  stage_template_id INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_order INTEGER NOT NULL,
  status TEXT DEFAULT 'pending',       -- pending, in_progress, completed
  started_at TEXT,
  completed_at TEXT,
  assignee_user_id INTEGER,
  notes TEXT,
  FOREIGN KEY (task_id) REFERENCES ActiveTasks(task_id) ON DELETE CASCADE,
  FOREIGN KEY (stage_template_id) REFERENCES TaskStageTemplates(stage_template_id),
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id)
);
CREATE INDEX idx_active_stages_task ON ActiveTaskStages(task_id);
```

> 參考表：`Users`、`Clients`、`Services`、`ServiceFrequencyTypes`、`KnowledgeBase`、（如需）`ClientSOPLinks` 用於查找客戶專屬 SOP。

---

## 權限與規則（服務端強制）

- 員工：
  - 只能取得/操作「自己被指派」的任務與階段。
  - 可協助新增/更新任務模板、設定客戶服務（小型事務所彈性）。
- 管理員：
  - 可檢視/操作所有任務。
  - 可分配任務負責人。
- 階段順序：必須依序開始與完成；不可跳過。

---

## API 設計

### 任務模板管理

- GET `/api/v1/task-templates`
- POST `/api/v1/task-templates`
- PUT `/api/v1/task-templates/:id`
- DELETE `/api/v1/task-templates/:id`
- POST `/api/v1/task-templates/:id/copy`

權限：員工與管理員皆可（小型事務所彈性）。

輸入/輸出（摘要）：
```json
// POST /api/v1/task-templates
{
  "template_name": "記帳服務流程",
  "service_id": 1,
  "estimated_days": 15,
  "related_sop_id": 5,
  "is_client_specific": false
}
```

### 客戶服務設定

- GET `/api/v1/client-services`
- POST `/api/v1/client-services`
- PUT `/api/v1/client-services/:id`
- DELETE `/api/v1/client-services/:id`
- GET `/api/v1/clients/:clientId/services`
- GET `/api/v1/clients/:clientId/available-templates?service_id=...`（回傳通用與客戶專屬模板）

權限：員工與管理員皆可（小型事務所彈性）。

### 任務與階段

- GET `/api/v1/tasks`（支援依狀態、到期日範圍過濾；員工自動套用 assignee = 自己）
- GET `/api/v1/tasks/:id`（任務詳情，含階段、SOP 摘要）
- GET `/api/v1/tasks/:id/sop`（通用/客戶專屬 SOP 連結資訊）
- PUT `/api/v1/tasks/:id`（更新備註、負責人等）
- POST `/api/v1/tasks/:id/stages/:stageId/start`
- POST `/api/v1/tasks/:id/stages/:stageId/complete`

### 任務附件（整合附件系統）

- 使用附件系統通用端點，無需新增任務專屬 API：
  - 上傳：`POST /api/v1/attachments/upload`（multipart/form-data）
    - 參數：`file`, `entity_type='task'`, `entity_id=:taskId`
  - 列表：`GET /api/v1/attachments?entity_type=task&entity_id=:taskId`
  - 下載：`GET /api/v1/attachments/:attachmentId/download`
  - 刪除：`DELETE /api/v1/attachments/:attachmentId`
  - 權限與驗證：依附件系統規格；任務參與者/管理員可見；任務附件數量上限 10

錯誤格式（建議）：
```json
{
  "success": false,
  "error": { "code": "VALIDATION_ERROR", "message": "請先完成『核對銀行對帳單』（階段2）" }
}
```

---

## 核心業務邏輯

### 任務清單查詢（我的任務）

- 員工：`WHERE assignee_user_id = :userId`，狀態預設含 `pending, in_progress`，並依 `due_date` 升冪排序。
- 管理員：可不加 assignee 限制，並支援過濾器。
- 回傳需包含：進度（已完成階段數/總階段數）、是否有 SOP（任一 SOP 欄位非空）。

### 階段操作規則

- Start：
  - 若 `stage_order > 1`，需檢查「前一階段 `status = completed`」。
  - 通過後：更新該階段為 `in_progress`，寫入 `started_at`，並將任務狀態更新為 `in_progress`（若尚未）。

- Complete：
  - 僅允許在 `status = in_progress` 時完成，否則回 `VALIDATION_ERROR`。
  - 完成後：更新 `completed_at`；若所有階段皆完成，將任務狀態更新為 `completed` 並寫入 `completed_date`。

### 自動化：每月 1 日 00:00 產生任務

流程（對應《使用手冊／自動化》與「場景 5」）：
1) 掃描 `ClientServices`：`status = active` 且 `is_deleted = 0`，當月屬於其 `trigger_months`。
2) 選擇模板：優先 `custom_template_id`（需匹配指定客戶），否則使用 `template_id`（通用）。
3) 指派負責人：取客戶的預設負責人（若空則 `NULL`）。
4) 連結 SOP：模板的通用 SOP；若存在客戶專屬 SOP，則一併連結。
5) 建立任務名稱：`{client_id} - {template_name}` 或依商業規則組字（例：「ABC科技 - 12月記帳服務」）。
6) 期限：`due_date = start_date + (template.estimated_days || 15)`。
7) 避免重複：同一 `client_service_id` + 當月若已有任務，則跳過（以任務日期區間或命名與月份比對）。
8) 產生階段：依模板 `stage_order` 建立 `pending` 階段列。
9) 通知：依產生結果彙總每位負責員工的「新任務數」並建立通知紀錄。

產出（範例）：
```json
{
  "success": true,
  "generated": 15,
  "byAssignee": [
    { "user_id": 1, "new_tasks": 5 },
    { "user_id": 2, "new_tasks": 3 },
    { "user_id": 3, "new_tasks": 7 }
  ]
}
```

### 逾期與即將到期（查詢規則）

- 逾期：`due_date < date('now') AND status != 'completed'`。
- 即將到期（3 天內）：`date(due_date) BETWEEN date('now') AND date('now','+3 days')`。
- 已於索引 `idx_active_tasks_due_status` 最佳化逾期檢索。

---

## 資料驗證與錯誤

- 任務模板：`template_name` 必填；`stage_order` 需為正整數且同模板內不重覆；階段序連續性由建立時檢查。
- 客戶服務設定：`client_id + service_id` 唯一；`trigger_months` 必為有效月份（1–12）清單；`start_date <= end_date`（如有）。
- 階段操作：
  - Start：若前一階段未完成 → `VALIDATION_ERROR`（含前一階段名稱與序號）。
  - Complete：若非 `in_progress` → `VALIDATION_ERROR`（需先開始）。
- 權限：
  - 非管理員操作他人任務/階段 → `FORBIDDEN`。
  - 查無資料 → `NOT_FOUND`。

錯誤格式（建議）：
```json
{ "success": false, "error": { "code": "FORBIDDEN", "message": "無權限操作此任務" } }
```

---

## 效能與索引建議

- 我的任務清單：`idx_active_tasks_assignee_status (assignee_user_id, status, due_date)`
- 逾期檢測：`idx_active_tasks_due_status (due_date, status)`
- 模板階段讀取：`idx_stage_templates_order (template_id, stage_order)`

---

## 通知（支援「場景 5」需求）

- 任務自動產生時，建立每位被指派員工的「新任務數量」通知紀錄，供前端顯示提醒條或通知中心。
- 建議欄位：`notification_id, user_id, type, title, body, ref_type, ref_id, created_at, read_at`。

---

## 安全與審計

- 任務與模板支援軟刪除（`is_deleted`、`deleted_at`、`deleted_by`）。
- 寫入關鍵操作時間戳（`created_at`、`started_at`、`completed_at`）。

---

## 與《使用手冊》的對應關係

- 自動產生任務（每月 1 日）：完整覆蓋掃描、產生、指派、連結 SOP、通知的流程與規則。
- 角色權限：員工僅能查詢與操作自己的任務；管理員可看全部並分配。
- 任務與 SOP：同時支援通用 SOP 與客戶專屬 SOP 的回傳。
- 階段依序完成：服務端強制驗證，並據此返回對應錯誤訊息。
 - 任務附件：承接「場景 10」中『上傳附件』行為，透過附件系統以 `entity_type='task'` 進行存取。


