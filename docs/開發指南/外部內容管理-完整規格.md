# 外部內容管理 - 完整開發規格

**給 AI：** 實現外部網站 CMS 的完整技術規格（僅管理員）

---

## 💾 資料表

### ExternalArticles（外部文章/Blog）
```sql
CREATE TABLE ExternalArticles (
  article_id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,           -- URL 標識符
  summary TEXT,
  content TEXT NOT NULL,               -- HTML 內容
  featured_image TEXT,                 -- 封面圖 URL
  category TEXT,
  tags TEXT,                           -- JSON 陣列
  is_published BOOLEAN DEFAULT 0,
  published_at TEXT,
  view_count INTEGER DEFAULT 0,
  seo_title TEXT,
  seo_description TEXT,
  seo_keywords TEXT,
  created_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (created_by) REFERENCES Users(user_id)
);

CREATE UNIQUE INDEX idx_external_slug ON ExternalArticles(slug);
CREATE INDEX idx_external_category ON ExternalArticles(category);
CREATE INDEX idx_external_published ON ExternalArticles(is_published);
```

### ExternalFAQ（外部常見問題）
```sql
CREATE TABLE ExternalFAQ (
  faq_id INTEGER PRIMARY KEY AUTOINCREMENT,
  question TEXT NOT NULL,
  answer TEXT NOT NULL,
  category TEXT,
  sort_order INTEGER DEFAULT 0,
  is_published BOOLEAN DEFAULT 0,
  view_count INTEGER DEFAULT 0,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0
);

CREATE INDEX idx_faq_category ON ExternalFAQ(category);
CREATE INDEX idx_faq_published ON ExternalFAQ(is_published);
CREATE INDEX idx_faq_order ON ExternalFAQ(sort_order);
```

### ResourceCenter（資源中心）
```sql
CREATE TABLE ResourceCenter (
  resource_id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  description TEXT,
  file_url TEXT NOT NULL,              -- R2 儲存路徑
  file_type TEXT,                      -- PDF, Excel, Word
  file_size INTEGER,                   -- 位元組
  category TEXT,
  is_published BOOLEAN DEFAULT 0,
  download_count INTEGER DEFAULT 0,
  created_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (created_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_resources_category ON ResourceCenter(category);
CREATE INDEX idx_resources_published ON ResourceCenter(is_published);
CREATE INDEX idx_resources_type ON ResourceCenter(file_type);
```

### ExternalImages（外部圖片資源）
```sql
CREATE TABLE ExternalImages (
  image_id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  image_url TEXT NOT NULL,             -- R2 儲存路徑
  alt_text TEXT,                       -- SEO 替代文字
  category TEXT,
  file_size INTEGER,
  width INTEGER,
  height INTEGER,
  uploaded_by INTEGER NOT NULL,
  uploaded_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (uploaded_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_images_category ON ExternalImages(category);
```

---

## 🔌 API 端點

### Blog 文章管理
```
GET    /api/v1/admin/articles              查詢文章列表
POST   /api/v1/admin/articles              新增文章
GET    /api/v1/admin/articles/:id          查詢文章詳情
PUT    /api/v1/admin/articles/:id          更新文章
DELETE /api/v1/admin/articles/:id          刪除文章
POST   /api/v1/admin/articles/:id/publish  發布文章
POST   /api/v1/admin/articles/:id/unpublish 取消發布

# 公開 API（訪客使用）
GET    /api/v1/public/articles             查詢已發布文章
GET    /api/v1/public/articles/:slug       查詢單篇文章（by slug）
```

### FAQ 管理
```
GET    /api/v1/admin/faq                   查詢FAQ列表
POST   /api/v1/admin/faq                   新增FAQ
PUT    /api/v1/admin/faq/:id               更新FAQ
DELETE /api/v1/admin/faq/:id               刪除FAQ
PUT    /api/v1/admin/faq/reorder           調整排序

# 公開 API
GET    /api/v1/public/faq                  查詢已發布FAQ
```

### 資源中心管理
```
GET    /api/v1/admin/resources             查詢資源列表
POST   /api/v1/admin/resources/upload      上傳資源
GET    /api/v1/admin/resources/:id         查詢資源詳情
PUT    /api/v1/admin/resources/:id         更新資源資訊
DELETE /api/v1/admin/resources/:id         刪除資源

# 公開 API
GET    /api/v1/public/resources            查詢已發布資源
GET    /api/v1/public/resources/:id/download 下載資源（記錄次數）
```

### 圖片資源管理
```
GET    /api/v1/admin/images                查詢圖片列表
POST   /api/v1/admin/images/upload         上傳圖片
DELETE /api/v1/admin/images/:id            刪除圖片
GET    /api/v1/admin/images/categories     查詢分類

# 公開 API
GET    /api/v1/public/images/:id           獲取圖片URL
```

---

## 🎨 前端組件

### ArticleManagementPage.vue
```vue
<template>
  <div class="article-management">
    <h1>Blog 文章管理</h1>
    
    <div class="toolbar">
      <StyledButton @click="showCreateModal = true">
        + 新增文章
      </StyledButton>
      <select v-model="filter.status">
        <option value="">全部</option>
        <option value="published">已發布</option>
        <option value="draft">草稿</option>
      </select>
    </div>

    <DataTable
      :columns="columns"
      :data="articles"
    >
      <template #actions="{ row }">
        <button @click="editArticle(row)">編輯</button>
        <button 
          v-if="!row.is_published"
          @click="publishArticle(row.article_id)"
        >
          發布
        </button>
        <button 
          v-else
          @click="unpublishArticle(row.article_id)"
        >
          取消發布
        </button>
        <button @click="deleteArticle(row.article_id)">刪除</button>
      </template>
    </DataTable>

    <!-- 文章編輯器 Modal -->
    <Modal :show="showEditor" title="編輯文章" size="xl">
      <ArticleEditor
        v-model="currentArticle"
        @save="handleSave"
        @cancel="showEditor = false"
      />
    </Modal>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { getArticles, publishArticle as apiPublish } from '@/api/external';
import ArticleEditor from '@/components/external/ArticleEditor.vue';

const articles = ref([]);
const showEditor = ref(false);
const currentArticle = ref(null);

onMounted(async () => {
  const response = await getArticles();
  articles.value = response.data;
});
</script>
```

### ArticleEditor.vue（富文本編輯器）
```vue
<template>
  <div class="article-editor">
    <!-- 基本資訊 -->
    <StyledInput
      v-model="article.title"
      label="文章標題"
      :required="true"
    />
    
    <StyledInput
      v-model="article.slug"
      label="URL Slug"
      placeholder="company-setup-guide"
      :required="true"
    />
    
    <textarea
      v-model="article.summary"
      placeholder="文章摘要（顯示在列表頁）"
    />
    
    <!-- 富文本編輯器 -->
    <div class="wysiwyg-editor">
      <div class="editor-toolbar">
        <button @click="format('bold')">B</button>
        <button @click="format('italic')">I</button>
        <button @click="format('heading')">H</button>
        <button @click="insertImage">圖片</button>
        <button @click="insertLink">連結</button>
      </div>
      <div
        ref="editorContent"
        contenteditable="true"
        class="editor-content"
        @input="updateContent"
      >
        {{ article.content }}
      </div>
    </div>
    
    <!-- 特色圖片 -->
    <div class="featured-image">
      <label>封面圖</label>
      <input
        type="file"
        accept="image/*"
        @change="uploadFeaturedImage"
      />
      <img
        v-if="article.featured_image"
        :src="article.featured_image"
        alt="封面圖預覽"
      />
    </div>
    
    <!-- 分類和標籤 -->
    <select v-model="article.category">
      <option value="公司設立">公司設立</option>
      <option value="稅務資訊">稅務資訊</option>
      <option value="會計知識">會計知識</option>
      <option value="法規更新">法規更新</option>
    </select>
    
    <!-- SEO 設定 -->
    <div class="seo-section">
      <h3>SEO 設定</h3>
      <StyledInput
        v-model="article.seo_title"
        label="SEO 標題"
        placeholder="公司設立完整指南 | XX會計師事務所"
      />
      <textarea
        v-model="article.seo_description"
        placeholder="SEO 描述（顯示在搜尋結果）"
        maxlength="160"
      />
      <StyledInput
        v-model="article.seo_keywords"
        label="SEO 關鍵字"
        placeholder="公司設立, 會計師, 台中"
      />
    </div>
    
    <!-- 按鈕 -->
    <div class="actions">
      <StyledButton variant="ghost" @click="$emit('cancel')">
        取消
      </StyledButton>
      <StyledButton @click="saveDraft">
        儲存草稿
      </StyledButton>
      <StyledButton variant="primary" @click="saveAndPublish">
        發布
      </StyledButton>
    </div>
  </div>
</template>
```

### ResourceUploadPage.vue
```vue
<template>
  <div class="resource-upload">
    <h1>資源中心管理</h1>
    
    <div class="upload-area">
      <input
        type="file"
        ref="fileInput"
        @change="handleFileSelect"
        accept=".pdf,.xlsx,.xls,.docx,.doc,.zip"
      />
      <p>支持：PDF、Excel、Word、ZIP</p>
      <p>最大 10MB</p>
    </div>
    
    <div v-if="selectedFile" class="file-info">
      <p>檔案名稱：{{ selectedFile.name }}</p>
      <p>檔案大小：{{ formatFileSize(selectedFile.size) }}</p>
      
      <StyledInput
        v-model="resourceData.title"
        label="資源標題"
        :required="true"
      />
      
      <textarea
        v-model="resourceData.description"
        placeholder="資源描述"
      />
      
      <select v-model="resourceData.category">
        <option value="表格範本">表格範本</option>
        <option value="操作手冊">操作手冊</option>
        <option value="法規文件">法規文件</option>
        <option value="其他">其他</option>
      </select>
      
      <StyledButton
        @click="uploadResource"
        :loading="isUploading"
      >
        上傳並發布
      </StyledButton>
    </div>
    
    <!-- 已上傳資源列表 -->
    <DataTable
      :columns="resourceColumns"
      :data="resources"
    >
      <template #actions="{ row }">
        <a :href="row.file_url" target="_blank">下載</a>
        <button @click="editResource(row)">編輯</button>
        <button @click="deleteResource(row.resource_id)">刪除</button>
        <span class="download-count">{{ row.download_count }} 次下載</span>
      </template>
    </DataTable>
  </div>
</template>
```

---

## 🔧 後端實現

### ExternalContentService
```typescript
class ExternalContentService {
  async createArticle(data, userId) {
    // 1. 驗證
    if (!data.title || !data.slug) {
      throw new ValidationError('標題和 Slug 為必填');
    }
    
    // 2. 檢查 Slug 唯一性
    const existing = await this.repository.findBySlug(data.slug);
    if (existing) {
      throw new ConflictError('URL Slug 已存在');
    }
    
    // 3. 創建文章
    return await this.repository.create({
      ...data,
      created_by: userId,
      is_published: false,
      view_count: 0
    });
  }
  
  async publishArticle(articleId, userId) {
    const article = await this.repository.findById(articleId);
    
    if (!article) {
      throw new NotFoundError('文章不存在');
    }
    
    return await this.repository.update(articleId, {
      is_published: true,
      published_at: new Date()
    });
  }
  
  async uploadResource(file, metadata, userId) {
    // 1. 驗證文件大小（最大 10MB）
    if (file.size > 10 * 1024 * 1024) {
      throw new ValidationError('文件大小不可超過 10MB');
    }
    
    // 2. 上傳到 R2
    const fileName = `resources/${Date.now()}-${file.name}`;
    await env.R2_BUCKET.put(fileName, file.stream());
    
    // 3. 創建記錄
    return await this.resourceRepo.create({
      title: metadata.title,
      description: metadata.description,
      file_url: fileName,
      file_type: file.type,
      file_size: file.size,
      category: metadata.category,
      is_published: true,
      created_by: userId
    });
  }
  
  async downloadResource(resourceId) {
    // 1. 查詢資源
    const resource = await this.resourceRepo.findById(resourceId);
    
    if (!resource || !resource.is_published) {
      throw new NotFoundError('資源不存在');
    }
    
    // 2. 增加下載次數
    await this.resourceRepo.incrementDownloadCount(resourceId);
    
    // 3. 從 R2 獲取文件
    const file = await env.R2_BUCKET.get(resource.file_url);
    
    return {
      file: file.body,
      fileName: resource.title,
      fileType: resource.file_type
    };
  }
  
  async uploadImage(file, metadata, userId) {
    // 1. 驗證圖片格式
    if (!file.type.startsWith('image/')) {
      throw new ValidationError('只能上傳圖片文件');
    }
    
    // 2. 驗證大小（最大 5MB）
    if (file.size > 5 * 1024 * 1024) {
      throw new ValidationError('圖片大小不可超過 5MB');
    }
    
    // 3. 上傳到 R2
    const fileName = `images/${Date.now()}-${file.name}`;
    await env.R2_BUCKET.put(fileName, file.stream());
    
    // 4. 獲取圖片尺寸
    const dimensions = await getImageDimensions(file);
    
    // 5. 創建記錄
    return await this.imageRepo.create({
      title: metadata.title,
      image_url: fileName,
      alt_text: metadata.alt_text,
      category: metadata.category,
      file_size: file.size,
      width: dimensions.width,
      height: dimensions.height,
      uploaded_by: userId
    });
  }
}
```

---

## 🌐 公開網站整合

### Blog 文章顯示
```javascript
// 公開網站頁面：yourfirm.com/blog/company-setup-guide

// 查詢文章
GET /api/v1/public/articles/company-setup-guide

// 渲染頁面
<html>
  <head>
    <title>{{ article.seo_title }}</title>
    <meta name="description" content="{{ article.seo_description }}">
    <meta name="keywords" content="{{ article.seo_keywords }}">
  </head>
  <body>
    <article>
      <h1>{{ article.title }}</h1>
      <img src="{{ article.featured_image }}" alt="封面圖">
      <div class="content">
        {{{ article.content }}}  <!-- HTML 內容 -->
      </div>
    </article>
  </body>
</html>

// 增加瀏覽次數
UPDATE ExternalArticles 
SET view_count = view_count + 1 
WHERE slug = 'company-setup-guide'
```

### 資源下載流程
```javascript
// 訪客點擊下載：yourfirm.com/resources/checklist.pdf

// 1. 查詢資源
GET /api/v1/public/resources/123/download

// 2. 增加下載次數
UPDATE ResourceCenter 
SET download_count = download_count + 1 
WHERE resource_id = 123

// 3. 從 R2 獲取文件
const file = await env.R2_BUCKET.get(resource.file_url);

// 4. 返回文件流
return new Response(file.body, {
  headers: {
    'Content-Type': resource.file_type,
    'Content-Disposition': `attachment; filename="${resource.title}"`
  }
});
```

### FAQ 顯示
```javascript
// 公開網站頁面：yourfirm.com/faq

// 查詢所有已發布的 FAQ
GET /api/v1/public/faq

// 按分類分組顯示
<div class="faq-section">
  <h2>稅務相關</h2>
  <div v-for="faq in taxFAQs">
    <h3>{{ faq.question }}</h3>
    <p>{{ faq.answer }}</p>
  </div>
</div>
```

---

## 📁 R2 檔案儲存

### 目錄結構
```
R2 Bucket: external-content/
├── articles/
│   ├── images/
│   │   ├── 2025-10-28-hero.jpg
│   │   └── 2025-10-28-diagram.png
│   └── featured/
│       └── 2025-10-28-cover.jpg
├── resources/
│   ├── 2025-10-28-checklist.pdf
│   ├── 2025-10-28-template.xlsx
│   └── 2025-10-28-guide.docx
└── images/
    ├── 2025-10-28-logo.png
    └── 2025-10-28-banner.jpg
```

### 上傳邏輯
```typescript
async function uploadToR2(file, path, env) {
  const fileName = `${path}/${Date.now()}-${file.name}`;
  
  await env.R2_BUCKET.put(fileName, file.stream(), {
    httpMetadata: {
      contentType: file.type
    }
  });
  
  // 返回公開 URL
  return `https://cdn.yourfirm.com/${fileName}`;
}
```

---

## ✅ 業務規則

### 文章發布規則
- 草稿狀態：不顯示在公開網站
- 發布狀態：立即顯示在公開網站
- 取消發布：從公開網站隱藏（但不刪除）

### URL Slug 規則
- 只能包含小寫字母、數字、連字號
- 必須唯一
- 範例：`company-setup-guide`, `tax-filing-tips`

### 檔案大小限制
- 圖片：最大 5MB
- 資源文件：最大 10MB
- 超過限制會拒絕上傳

### SEO 優化
- SEO 標題：建議 50-60 字元
- SEO 描述：建議 150-160 字元
- SEO 關鍵字：5-10 個關鍵字

---

## 🧪 測試案例

```typescript
// 測試1：發布文章
test('應該成功發布文章', async () => {
  const article = await createArticle({
    title: '測試文章',
    slug: 'test-article',
    content: '內容'
  });
  
  await publishArticle(article.article_id);
  
  const published = await getArticle(article.article_id);
  expect(published.is_published).toBe(true);
});

// 測試2：Slug 唯一性
test('應該拒絕重複的 Slug', async () => {
  await createArticle({ slug: 'test' });
  
  await expect(createArticle({ slug: 'test' }))
    .rejects.toThrow('URL Slug 已存在');
});

// 測試3：檔案大小限制
test('應該拒絕過大的文件', async () => {
  const largeFile = createMockFile(11 * 1024 * 1024); // 11MB
  
  await expect(uploadResource(largeFile))
    .rejects.toThrow('文件大小不可超過 10MB');
});

// 測試4：下載次數統計
test('應該記錄下載次數', async () => {
  const resource = await createResource({...});
  
  await downloadResource(resource.resource_id);
  await downloadResource(resource.resource_id);
  
  const updated = await getResource(resource.resource_id);
  expect(updated.download_count).toBe(2);
});
```

---

## 📝 內容分類建議

### Blog 文章分類
- 公司設立
- 稅務資訊
- 會計知識
- 法規更新
- 產業動態

### FAQ 分類
- 稅務問題
- 公司登記
- 記帳服務
- 一般諮詢

### 資源分類
- 表格範本
- 操作手冊
- 法規文件
- 參考資料

---

**這個文檔包含外部內容管理（CMS）的所有技術細節。**

