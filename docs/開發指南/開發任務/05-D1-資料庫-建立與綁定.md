### 任務 05：建立 D1 資料庫與綁定（含遷移）

對應索引：`docs/開發指南/開發須知/開發清單-任務索引.md`

【目標】
- 建立 Cloudflare D1 資料庫、於 Worker 綁定 `DATABASE`，並套用遷移，確保後續 API（如登入）可讀寫。

【需閱讀】
- `docs/開發指南/開發須知/部署-與-環境.md`
- `docs/開發指南/開發須知/資料庫-D1-規範.md`

【前置】
- 已安裝並登入 Wrangler（Cloudflare 帳號）
  - 登入：`wrangler login`

【步驟】
1) 建立 D1 資料庫（雲端）
```bash
wrangler d1 create horgoscpa-db
```
- 記下輸出的 `database_id`（之後填入 `wrangler.toml`）。

2) 綁定至 Worker 並確認變數
- 編輯 `cloudflare/worker-router/wrangler.toml`：
  - 在 `[[d1_databases]]` 區塊填入 `database_id`
  - 確認：
    - `binding = "DATABASE"`
    - `migrations_dir = "migrations"`
  - 可一併確認（若尚未設）：
    - `[vars] APP_ENV = "prod|staging|dev"`
    - `[vars] SESSION_COOKIE_NAME = "session"`
    - `[vars] SESSION_TTL_SECONDS = "2592000"`

3) 套用遷移
- 遠端（正式/預覽環境）
```bash
cd cloudflare/worker-router
wrangler d1 migrations apply DATABASE --remote
```
- 本機（若要本機開發）
```bash
wrangler d1 migrations apply DATABASE --local
```

4) 驗證（選擇其一）
```bash
# 查表清單（遠端）
wrangler d1 execute DATABASE --remote --command "SELECT name FROM sqlite_master WHERE type='table';"

# 查表清單（本機）
wrangler d1 execute DATABASE --local --command "SELECT name FROM sqlite_master WHERE type='table';"
```
應可看到 `Users`、`sessions` 等表。

5)（可選）DEV 測試資料
- 啟動本機：`wrangler dev src/index.js`
- 以 DEV 種子端點建立測試用戶：
```bash
curl -X POST http://127.0.0.1:8787/internal/api/v1/admin/dev-seed-user \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"111111","name":"管理員","email":"admin@example.com"}'
```

【驗收標準（AC）】
- D1 已建立且 `wrangler.toml` 成功綁定 `DATABASE`
- 遷移成功（`Users`、`sessions` 等表存在）
- 若啟動 Worker，本機或遠端呼叫 API 不出現 `資料庫未綁定` 類錯誤

【備註】
- 機密請用 `wrangler secret` 管理，勿入庫。
- 遷移需可重入（`IF NOT EXISTS`）。


