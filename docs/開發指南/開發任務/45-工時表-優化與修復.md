# 任務 45：工時表優化與修復

## 對應文件
- 使用手冊：`docs/使用手冊/功能模組-03-工時管理.md`
- 前端規格：`docs/開發指南/前端/工時管理-前端規格.md`
- 後端規格：`docs/開發指南/後端/工時管理-後端規格.md`

## 任務範圍

本任務修復工時表的多個關鍵問題，提升用戶體驗與資料準確性。

### 問題清單

1. **客戶下拉選單空白**：未正確載入客戶管理的客戶列表
2. **工時類型選擇不友好**：預先篩選導致用戶困惑，應改為先輸入後提示
3. **工時總計未正確統計**：加班工時與加權工時計算錯誤
4. **缺少統一儲存按鈕**：只能逐格儲存，體驗不佳
5. **國定假日未連動**：日期標籤未顯示國定假日資訊

---

## 修復內容

### 1️⃣ 客戶下拉選單修復

**問題**：客戶下拉選單空白，未顯示客戶列表

**原因**：API 返回的欄位格式不一致（`clientId` vs `client_id`，`companyName` vs `company_name`）

**解決方案**：
- 支援多種欄位格式：`c.clientId || c.client_id`
- 支援多種命名：`c.companyName || c.company_name || c.name`

**修改檔案**：`timesheets.html` 第 621-627 行

---

### 2️⃣ 工時類型選擇優化（智能提示）

**問題**：工時類型下拉選單預先篩選，用戶看不到所有選項

**改進**：
- **不預先篩選**：顯示所有 11 種工時類型
- **先輸入後提示**：允許用戶自由選擇任何類型
- **儲存時驗證**：如選擇不適用的類型，顯示友善提示
  - 例：週六選「正常工時」→ 提示「休息日不可使用『正常工時』，請選擇『休息日加班』類型」

**修改檔案**：`timesheets.html` 第 652-668 行（移除動態篩選）、第 794-807 行（新增儲存時驗證）

---

### 3️⃣ 國定假日整合顯示

**問題**：日期標籤未顯示國定假日，用戶不知道該日期類型

**解決方案**：
- 從 `GET /api/v1/holidays` 載入假日資料
- 在日期標籤顯示：
  - **國定假日**：紅色「國定」標籤
  - **例假日**（週日）：黃色「例假」標籤
  - **休息日**（週六）：黃色「休息」標籤
  - **補班日**：藍色「補班」標籤

**修改檔案**：
- `timesheets.html` 第 476-500 行（載入假日資料）
- `timesheets.html` 第 415-460 行（更新日期標籤顯示）

---

### 4️⃣ 工時總計修復

**問題**：
- 本週總工時：未計算（顯示 0）
- 本週加班工時：未計算（顯示 0）
- 本週加權工時：未計算（顯示 0）

**解決方案**：
```javascript
function updateSummary() {
  let totalHours = 0;
  let overtimeHours = 0;
  let weightedHours = 0;
  
  rows.forEach(row => {
    const workType = workTypes.find(wt => wt.id == row.work_type_id);
    if (!workType) return;
    
    row.hours.forEach(h => {
      if (h && h > 0) {
        totalHours += h;
        if (workType.isOvertime) {
          overtimeHours += h;
        }
        weightedHours += h * workType.multiplier;
      }
    });
  });
  
  document.getElementById('sumTotal').textContent = totalHours.toFixed(1);
  document.getElementById('sumOvertime').textContent = overtimeHours.toFixed(1);
  document.getElementById('sumWeighted').textContent = weightedHours.toFixed(1);
}
```

**修改檔案**：`timesheets.html` 第 872-897 行

---

### 5️⃣ 新增統一儲存按鈕

**問題**：只能逐格儲存（按 Enter），填寫多個儲存格很麻煩

**解決方案**：
- 新增「儲存所有變更」按鈕（放在表格底部）
- 追蹤未儲存的變更（`pendingChanges` Map）
- 點擊按鈕時批量儲存所有變更

**HTML 新增**：
```html
<button class="btn-save-all" id="btnSaveAll">儲存所有變更</button>
```

**JS 邏輯**：
```javascript
let pendingChanges = new Map(); // key: rowIndex_dayIndex, value: hours

// 儲存格輸入時記錄變更
input.addEventListener('input', function() {
  const key = `${rowIndex}_${dayIndex}`;
  pendingChanges.set(key, this.value);
  // 更新按鈕狀態
  updateSaveButton();
});

// 批量儲存
async function saveAllChanges() {
  for (const [key, value] of pendingChanges) {
    const [rowIndex, dayIndex] = key.split('_').map(Number);
    await saveCell(rowIndex, dayIndex, value);
  }
  pendingChanges.clear();
  updateSaveButton();
}
```

**修改檔案**：
- HTML：新增按鈕（第 333 行後）
- JS：新增邏輯（第 910-940 行）

---

## 自我測試清單

### 客戶下拉
- [ ] 客戶下拉選單顯示所有客戶名稱
- [ ] 支援 API 返回的 camelCase 和 snake_case 格式
- [ ] 選擇客戶後能正確儲存

### 工時類型智能提示
- [ ] 下拉選單顯示所有 11 種工時類型
- [ ] 週六填寫「正常工時」時，儲存顯示錯誤提示
- [ ] 週日填寫「例假日加班」能正常儲存
- [ ] 國定假日填寫對應類型能正常儲存

### 國定假日顯示
- [ ] 週六顯示「休息」標籤（黃色背景）
- [ ] 週日顯示「例假」標籤（黃色背景）
- [ ] 國定假日顯示「國定」標籤（紅色背景）
- [ ] 補班日顯示「補班」標籤（藍色背景）

### 工時總計
- [ ] 本週總工時：所有儲存格加總正確
- [ ] 本週加班工時：只計算 `isOvertime=true` 的工時
- [ ] 本週加權工時：每筆工時 × 對應費率倍數，總和正確
- [ ] 新增/修改工時後，總計自動更新

### 統一儲存按鈕
- [ ] 按鈕初始狀態為灰色（無變更）
- [ ] 修改儲存格後，按鈕變為可點擊（藍色）
- [ ] 點擊按鈕後，所有變更批量儲存
- [ ] 儲存完成後，按鈕恢復灰色

---

## 部署驗證

1. 推送代碼到 `main` 分支
2. 等待 Cloudflare Pages 自動部署（約 1-2 分鐘）
3. 訪問 `https://www.horgoscpa.com/internal/timesheets`
4. 測試所有修復點
5. 確認無錯誤後標記為完成

---

## 追加修復（第二輪）

### 6️⃣ 總計未自動更新
**問題**：載入資料後總計顯示0，沒有自動計算

**解決方案**：
- 在 `renderTable()` 結尾調用 `updateSummary()`
- 在 `addRow()` 和 `deleteRow()` 後調用 `updateSummary()`

**修改檔案**：`timesheets.html`

### 7️⃣ UI佈局優化
**問題**：新增列和儲存按鈕應該與週導航按鈕在同一行

**解決方案**：
- 調整HTML結構，將按鈕放在 `.week-nav` 容器內
- 使用 `display: flex` 和 `justify-content: space-between`

**修改檔案**：`timesheets.html` HTML 和 CSS

### 8️⃣ 國定假日資料確認
**問題**：10/10 國慶日未顯示國定假日標籤

**解決方案**：
- 檢查 `loadHolidays()` API 調用
- 確認資料庫中有 2025-10-10 的國定假日資料
- 確認 `updateWeekDisplay()` 正確讀取 holidays Map

**修改檔案**：`timesheets.html`、資料庫遷移

## 預期成果

- ✅ 客戶下拉選單正常顯示所有客戶
- ✅ 工時類型選擇更友好（先輸入後提示）
- ✅ 日期標籤正確顯示假日類型
- ✅ 工時總計準確計算並自動更新
- ✅ 統一儲存按鈕提升填寫效率
- ✅ UI佈局合理，按鈕在同一行


