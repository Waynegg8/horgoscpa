# 任務 45：工時表優化與修復

## 對應文件
- 使用手冊：`docs/使用手冊/功能模組-03-工時管理.md`
- 前端規格：`docs/開發指南/前端/工時管理-前端規格.md`
- 後端規格：`docs/開發指南/後端/工時管理-後端規格.md`

## 任務範圍

本任務修復工時表的多個關鍵問題，提升用戶體驗與資料準確性。

### 問題清單

1. **客戶下拉選單空白**：未正確載入客戶管理的客戶列表
2. **工時類型選擇不友好**：預先篩選導致用戶困惑，應改為先輸入後提示
3. **工時總計未正確統計**：加班工時與加權工時計算錯誤
4. **缺少統一儲存按鈕**：只能逐格儲存，體驗不佳
5. **國定假日未連動**：日期標籤未顯示國定假日資訊

---

## 修復內容

### 1️⃣ 客戶下拉選單修復

**問題**：客戶下拉選單空白，未顯示客戶列表

**原因**：API 返回的欄位格式不一致（`clientId` vs `client_id`，`companyName` vs `company_name`）

**解決方案**：
- 支援多種欄位格式：`c.clientId || c.client_id`
- 支援多種命名：`c.companyName || c.company_name || c.name`

**修改檔案**：`timesheets.html` 第 621-627 行

---

### 2️⃣ 工時類型選擇優化（智能提示）

**問題**：工時類型下拉選單預先篩選，用戶看不到所有選項

**改進**：
- **不預先篩選**：顯示所有 11 種工時類型
- **先輸入後提示**：允許用戶自由選擇任何類型
- **儲存時驗證**：如選擇不適用的類型，顯示友善提示
  - 例：週六選「正常工時」→ 提示「休息日不可使用『正常工時』，請選擇『休息日加班』類型」

**修改檔案**：`timesheets.html` 第 652-668 行（移除動態篩選）、第 794-807 行（新增儲存時驗證）

---

### 3️⃣ 國定假日整合顯示

**問題**：日期標籤未顯示國定假日，用戶不知道該日期類型

**解決方案**：
- 從 `GET /api/v1/holidays` 載入假日資料
- 在日期標籤顯示：
  - **國定假日**：紅色「國定」標籤
  - **例假日**（週日）：黃色「例假」標籤
  - **休息日**（週六）：黃色「休息」標籤
  - **補班日**：藍色「補班」標籤

**修改檔案**：
- `timesheets.html` 第 476-500 行（載入假日資料）
- `timesheets.html` 第 415-460 行（更新日期標籤顯示）

---

### 4️⃣ 工時總計修復

**問題**：
- 本週總工時：未計算（顯示 0）
- 本週加班工時：未計算（顯示 0）
- 本週加權工時：未計算（顯示 0）

**解決方案**：
```javascript
function updateSummary() {
  let totalHours = 0;
  let overtimeHours = 0;
  let weightedHours = 0;
  
  rows.forEach(row => {
    const workType = workTypes.find(wt => wt.id == row.work_type_id);
    if (!workType) return;
    
    row.hours.forEach(h => {
      if (h && h > 0) {
        totalHours += h;
        if (workType.isOvertime) {
          overtimeHours += h;
        }
        weightedHours += h * workType.multiplier;
      }
    });
  });
  
  document.getElementById('sumTotal').textContent = totalHours.toFixed(1);
  document.getElementById('sumOvertime').textContent = overtimeHours.toFixed(1);
  document.getElementById('sumWeighted').textContent = weightedHours.toFixed(1);
}
```

**修改檔案**：`timesheets.html` 第 872-897 行

---

### 5️⃣ 新增統一儲存按鈕

**問題**：只能逐格儲存（按 Enter），填寫多個儲存格很麻煩

**解決方案**：
- 新增「儲存所有變更」按鈕（放在表格底部）
- 追蹤未儲存的變更（`pendingChanges` Map）
- 點擊按鈕時批量儲存所有變更

**HTML 新增**：
```html
<button class="btn-save-all" id="btnSaveAll">儲存所有變更</button>
```

**JS 邏輯**：
```javascript
let pendingChanges = new Map(); // key: rowIndex_dayIndex, value: hours

// 儲存格輸入時記錄變更
input.addEventListener('input', function() {
  const key = `${rowIndex}_${dayIndex}`;
  pendingChanges.set(key, this.value);
  // 更新按鈕狀態
  updateSaveButton();
});

// 批量儲存
async function saveAllChanges() {
  for (const [key, value] of pendingChanges) {
    const [rowIndex, dayIndex] = key.split('_').map(Number);
    await saveCell(rowIndex, dayIndex, value);
  }
  pendingChanges.clear();
  updateSaveButton();
}
```

**修改檔案**：
- HTML：新增按鈕（第 333 行後）
- JS：新增邏輯（第 910-940 行）

---

## 自我測試清單

### 客戶下拉
- [ ] 客戶下拉選單顯示所有客戶名稱
- [ ] 支援 API 返回的 camelCase 和 snake_case 格式
- [ ] 選擇客戶後能正確儲存

### 工時類型智能提示
- [ ] 下拉選單顯示所有 11 種工時類型
- [ ] 週六填寫「正常工時」時，儲存顯示錯誤提示
- [ ] 週日填寫「例假日加班」能正常儲存
- [ ] 國定假日填寫對應類型能正常儲存

### 國定假日顯示
- [ ] 週六顯示「休息」標籤（黃色背景）
- [ ] 週日顯示「例假」標籤（黃色背景）
- [ ] 國定假日顯示「國定」標籤（紅色背景）
- [ ] 補班日顯示「補班」標籤（藍色背景）

### 工時總計
- [ ] 本週總工時：所有儲存格加總正確
- [ ] 本週加班工時：只計算 `isOvertime=true` 的工時
- [ ] 本週加權工時：每筆工時 × 對應費率倍數，總和正確
- [ ] 新增/修改工時後，總計自動更新

### 統一儲存按鈕
- [ ] 按鈕初始狀態為灰色（無變更）
- [ ] 修改儲存格後，按鈕變為可點擊（藍色）
- [ ] 點擊按鈕後，所有變更批量儲存
- [ ] 儲存完成後，按鈕恢復灰色

---

## 部署驗證

1. 推送代碼到 `main` 分支
2. 等待 Cloudflare Pages 自動部署（約 1-2 分鐘）
3. 訪問 `https://www.horgoscpa.com/internal/timesheets`
4. 測試所有修復點
5. 確認無錯誤後標記為完成

---

## 追加修復（第二輪）

### 6️⃣ 總計未自動更新
**問題**：載入資料後總計顯示0，沒有自動計算

**解決方案**：
- 在 `renderTable()` 結尾調用 `updateSummary()`
- 在 `addRow()` 和 `deleteRow()` 後調用 `updateSummary()`

**修改檔案**：`timesheets.html`

### 7️⃣ UI佈局優化
**問題**：新增列和儲存按鈕應該與週導航按鈕在同一行

**解決方案**：
- 調整HTML結構，將按鈕放在 `.week-nav` 容器內
- 使用 `display: flex` 和 `justify-content: space-between`

**修改檔案**：`timesheets.html` HTML 和 CSS

### 8️⃣ 國定假日資料確認
**問題**：10/10 國慶日未顯示國定假日標籤

**解決方案**：
- 檢查 `loadHolidays()` API 調用
- 確認資料庫中有 2025-10-10 的國定假日資料
- 確認 `updateWeekDisplay()` 正確讀取 holidays Map

**修改檔案**：`timesheets.html`、資料庫遷移

### 9️⃣ 每日工時完整性檢查
**問題**：無法得知員工是否漏填工時（正常工時 + 請假應達8小時）

**需求場景**：
- 員工請假2小時，工作6小時，加班2小時
- 正常工時(6h) + 請假(2h) = 8h ✅ 完整
- 加班不計入8小時基準

**解決方案**：
- 在每日欄位下方顯示完整度指示器
- 從假期管理系統讀取請假資料（`GET /api/v1/leaves`）
- 計算：`正常工時總計 + 當日請假時數`
- 視覺提示：
  - ✅ 綠色：≥8小時（完整）
  - ⚠️ 黃色：6-7.5小時（可能漏填）
  - ❌ 紅色：<6小時（嚴重不足）
  - 灰色：≥8小時但有請假（正常）

**新增 API 調用**：
```javascript
async function loadLeaves() {
  const params = new URLSearchParams({
    start_date: formatDate(currentWeekStart),
    end_date: formatDate(weekEnd),
    status: 'approved'  // 只計算已批准的請假
  });
  const res = await fetch(`${apiBase}/leaves?${params}`, { credentials: 'include' });
  // 建立 leaves Map: date -> hours
}
```

**修改檔案**：`timesheets.html`

### 🔟 工時類型時數限制與順序驗證
**問題**：
1. 選擇「前2小時」可以填8小時（應限制最多2小時）
2. 沒填「前2小時」可以直接填「後2小時」（應強制順序）
3. 週六填正常工時無錯誤提示（後端拒絕但前端無提示）

**解決方案**：
1. **時數限制**：為每種工時類型添加 `maxHours`
   - 平日加班（前2小時）：maxHours: 2
   - 平日加班（後2小時）：maxHours: 2
   - 休息日加班（前2小時）：maxHours: 2
   - 休息日加班（第3-8小時）：maxHours: 6
   - 休息日加班（第9-12小時）：maxHours: 4

2. **順序驗證**：檢查同日是否已填寫前置工時類型
   - 填「後2小時」→ 檢查是否有「前2小時」
   - 填「第3-8小時」→ 檢查是否有「前2小時」
   - 填「第9-12小時」→ 檢查是否有「前2小時」+「第3-8小時」

3. **錯誤提示增強**：在 saveCell 的 else 分支添加錯誤訊息顯示

**修改檔案**：`timesheets.html`

### 1️⃣1️⃣ 刪除列功能修復與完整性顯示優化
**問題**：
1. 刪除列後刷新頁面，記錄仍然存在（未調用後端API）
2. 工時完整性顯示「已有幾小時」不夠直觀，應顯示「還缺幾小時」

**解決方案**：
1. **刪除功能修復**：
   - 調用後端 `DELETE /api/v1/timelogs/batch` API
   - 傳入週的起始/結束日期和該列的組合鍵
   - 刪除成功後重新載入工時資料

2. **完整性顯示優化**：
   - ✓ 完整（≥8h）：顯示「✓ 完整」
   - ⚠️ 可能漏填（6-7.5h）：顯示「⚠ 缺Xh」
   - ✗ 嚴重不足（<6h）：顯示「✗ 缺Xh」
   - 更直觀地告訴用戶還需要填多少工時

**修改檔案**：`timesheets.html`

### 1️⃣2️⃣ 國定假日顯示與完整性檢查修復
**問題**：
1. 10/10國慶日、10/11-10/12補假未正確顯示「國定」標籤
2. 完整性檢查在週六(10/11)顯示「X 0h」紅色（不應檢查週末）

**根本原因**：
- `updateWeekDisplay()` 在假日資料載入之前執行
- 初始化時 holidays Map 為空，導致全部按照星期判斷（週六→休息、週日→例假）
- 完整性檢查邏輯正確，但因為 `getDateType()` 返回錯誤值（應該是 national_holiday，實際返回 restday）

**解決方案**：
1. **調整初始化順序**：先載入假日資料，再更新週顯示
   ```javascript
   // 修改前
   updateWeekDisplay();
   loadMasterData().then(() => Promise.all([loadHolidays(), loadLeaves()]))...
   
   // 修改後
   loadMasterData()
     .then(() => Promise.all([loadHolidays(), loadLeaves()]))
     .then(() => {
       updateWeekDisplay();  // 移到假日資料載入後
       loadTimesheets();
     });
   ```

2. **修改週導航邏輯**：確保先載入假日再更新顯示
   ```javascript
   // 修改前
   updateWeekDisplay();
   Promise.all([loadHolidays(), loadLeaves()]).then(() => loadTimesheets());
   
   // 修改後
   Promise.all([loadHolidays(), loadLeaves()]).then(() => {
     updateWeekDisplay();
     loadTimesheets();
   });
   ```

**修改檔案**：`timesheets.html`

### 1️⃣3️⃣ 國定假日優先級與輸入即時驗證
**問題**：
1. 週六可以輸入正常工時，雖然刷新後會消失，但體驗不佳
2. `updateWeekDisplay()` 邏輯未明確國定假日優先級

**根本原因**：
1. **輸入驗證時機錯誤**：
   - 驗證只在 `blur` 或 `Enter` 時執行（調用 `saveCell`）
   - 用戶已經輸入完畢才發現無法儲存
   - 導致「可以輸入但儲存後消失」的困惑

2. **優先級邏輯不清晰**：
   - `updateWeekDisplay()` 使用 if-else 結構
   - 雖然邏輯正確（先檢查 holiday 再檢查星期）
   - 但代碼可讀性差，優先級不明確

**解決方案**：
1. **添加輸入時即時驗證**：
   ```javascript
   input.addEventListener('input', function() {
     // 即時驗證：檢查該日期是否允許當前工時類型
     const row = rows[rowIndex];
     if (row.work_type_id && this.value) {
       const date = new Date(currentWeekStart);
       date.setDate(date.getDate() + dayIndex);
       const availableTypes = getAvailableWorkTypes(date);
       
       if (!availableTypes.find(wt => wt.id == row.work_type_id)) {
         // 不允許的組合，立即清空並提示
         this.value = '';
         showToast(`${dateType}不可使用「${workType.name}」`, false);
         return;
       }
     }
     
     // 通過驗證，記錄變更
     pendingChanges.set(key, { rowIndex, dayIndex, value: this.value });
   });
   ```

2. **重構 `updateWeekDisplay()` 優先級**：
   ```javascript
   // 修改前：if-else 結構
   if (holiday) {
     if (holiday.is_national_holiday) { ... }
     else if (holiday.is_makeup_workday) { ... }
   } else {
     if (dayOfWeek === 0) { ... }
     else if (dayOfWeek === 6) { ... }
   }
   
   // 修改後：明確優先級
   // 第一優先：國定假日（即使是週末也顯示國定）
   if (holiday && holiday.is_national_holiday) { ... }
   // 第二優先：補班日
   else if (holiday && holiday.is_makeup_workday) { ... }
   // 第三優先：週日例假日
   else if (dayOfWeek === 0) { ... }
   // 第四優先：週六休息日
   else if (dayOfWeek === 6) { ... }
   ```

**優先級規則（從高到低）**：
1. 🔴 國定假日 > 週末（10/10週五是國定、10/11週六是國定補假）
2. 🟡 補班日 > 週六（2/8週六是補班日）
3. 🟠 週日例假日（預設）
4. 🟢 週六休息日（預設）
5. ⚪ 一般工作日

**測試場景**：
- 10/10(週五) → 顯示「國定」
- 10/11(週六) → 顯示「國定」（不是「休息」）
- 10/12(週日) → 顯示「國定」（不是「例假」）
- 2/8(週六) → 顯示「補班」（不是「休息」）
- 11/1(週六) → 顯示「休息」（無國定假日）
- 11/2(週日) → 顯示「例假」（無國定假日）

**即時驗證效果**：
- 用戶在週六選擇「正常工時」並輸入 → 立即清空並提示「休息日不可使用「正常工時」」
- 用戶在週六選擇「休息日加班」並輸入 → 通過驗證，可以輸入

**修改檔案**：`timesheets.html`

### 1️⃣4️⃣ 假期記錄同步顯示
**需求**：在工時表中直觀顯示員工請假記錄，避免查看兩個系統

**用戶場景**：
- 員工在假期管理申請特休2小時
- 在工時表應該直接看到「特休 2h」
- 計算工時完整性時自動納入請假時數

**設計方案B（用戶選擇）**：
- 在工時表 `<tfoot>` 添加「請假記錄」行
- 位於「工時完整性」行上方
- 顯示格式：`假別 Xh`（例如：「特休 2h」、「病假 8h」）
- 無請假時顯示灰色「-」

**表格結構**：
```html
<tfoot>
  <!-- 新增：請假記錄行 -->
  <tr id="leave-records-row">
    <td colspan="3">請假記錄</td>
    <td>-</td>          <!-- 週一無請假 -->
    <td>特休 2h</td>    <!-- 週二請特休2小時 -->
    <td>病假 8h</td>    <!-- 週三請病假全天 -->
    <td>-</td>
    <td>-</td>
    <td>-</td>
    <td>-</td>
    <td></td>          <!-- 操作欄 -->
  </tr>
  
  <!-- 原有：工時完整性行 -->
  <tr id="completeness-row">
    <td colspan="3">工時完整性</td>
    <td>✗ 缺8h</td>     <!-- 週一：0h工時 + 0h請假 = 缺8h -->
    <td>✗ 缺6h</td>     <!-- 週二：0h工時 + 2h請假 = 缺6h -->
    <td>✓ 完整</td>     <!-- 週三：0h工時 + 8h請假 = 完整 -->
    <td>-</td>         <!-- 週四：國定假日，不檢查 -->
    <td>-</td>
    <td>-</td>
    <td>-</td>
    <td></td>
  </tr>
</tfoot>
```

**假別對應**：
- 從 `GET /api/v1/leaves` 取得 `leave_type` 欄位
- 對應假別名稱：
  - `annual`: 特休
  - `sick`: 病假
  - `personal`: 事假
  - `compensatory`: 補休
  - `maternity`: 產假
  - `paternity`: 陪產假
  - `menstrual`: 生理假
  - `marriage`: 婚假
  - `bereavement`: 喪假
  - `official`: 公假
  - `other`: 其他

**樣式設計**：
```css
#leave-records-row td {
  background-color: #e7f3ff;  /* 淡藍色背景 */
  color: #0066cc;
  font-size: 12px;
  font-weight: 600;
  padding: 8px;
  text-align: center;
  border-top: 2px solid #1b65b8;
}
```

**資料處理**：
1. 修改 `loadLeaves()` 函數，同時儲存假別資訊
   ```javascript
   // 修改前
   leaves.set(dateStr, existing + hoursPerDay);
   
   // 修改後
   const leaveInfo = leaves.get(dateStr) || { hours: 0, types: [] };
   leaveInfo.hours += hoursPerDay;
   leaveInfo.types.push({ type: leave.leave_type, hours: hoursPerDay });
   leaves.set(dateStr, leaveInfo);
   ```

2. 新增 `updateLeaveRecords()` 函數渲染請假記錄行
   ```javascript
   function updateLeaveRecords() {
     const leaveRecordsRow = document.getElementById('leave-records-row');
     // 清空並重新生成
     for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
       const dateStr = formatDate(date);
       const leaveInfo = leaves.get(dateStr);
       
       if (leaveInfo && leaveInfo.hours > 0) {
         // 顯示假別和時數
         const leaveTypeNames = { annual: '特休', sick: '病假', ... };
         const typeName = leaveTypeNames[leaveInfo.types[0].type] || '請假';
         td.textContent = `${typeName} ${leaveInfo.hours}h`;
       } else {
         td.textContent = '-';
       }
     }
   }
   ```

3. 在 `renderTable()` 和導航事件調用
   ```javascript
   renderTable();
   updateLeaveRecords();  // 新增
   updateSummary();
   updateDailyCompleteness();
   ```

**修改檔案**：
- `timesheets.html`：添加請假記錄行和渲染邏輯
- `docs/使用手冊/功能模組-03-工時管理.md`：更新說明文件

**預期效果**：
- ✅ 申請假期後，工時表自動顯示請假記錄
- ✅ 假別和時數清晰易讀
- ✅ 工時完整性計算自動納入請假
- ✅ 無需在兩個系統間切換查看

**修改檔案**：`timesheets.html`

### 1️⃣5️⃣ 請假記錄日期循環與欄位修復
**問題**：
1. 10/22（週三）顯示「其他 8h」，但該日無請假記錄
2. 假別顯示為「其他」而非正確的「特休」

**根本原因**：
1. **日期循環邏輯有 bug**：
   - 原代碼：`for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1))`
   - JavaScript `new Date('2025-10-20')` 可能被解析為 UTC 時間
   - 時區處理不當導致循環多執行，把 10/20 的請假擴散到 10/21、10/22
   
2. **API 欄位名稱不一致**：
   - 後端返回：`type`（cloudflare/worker-router/src/api/leaves.js:68）
   - 前端讀取：`leave.leave_type`（undefined）
   - 結果：`leaveType` 被設為 `'other'`，顯示「其他」

**解決方案**：
1. **修復日期循環**：
   ```javascript
   // 修改前：直接使用 Date 物件
   for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
     // 可能因時區問題循環多次
   }
   
   // 修改後：強制本地時間
   const current = new Date(startStr + 'T00:00:00');  // 加 T00:00:00 確保本地時間
   const end = new Date(endStr + 'T00:00:00');
   
   while (current <= end) {
     const dateStr = formatDate(current);
     // ... 記錄請假
     current.setDate(current.getDate() + 1);  // 移到下一天
   }
   ```

2. **修復欄位讀取**：
   ```javascript
   // 修改前
   const leaveType = leave.leave_type || 'other';
   
   // 修改後：兼容兩種欄位名
   const leaveType = leave.type || leave.leave_type || 'other';
   ```

3. **增加防禦性檢查**：
   ```javascript
   if (!startStr || !endStr) return;  // 跳過無效記錄
   ```

**測試驗證**：
- 10/20（週一）申請特休 1天
- 工時表應該：
  - 10/20 顯示「特休 8h」✅
  - 10/21 顯示「-」✅
  - 10/22 顯示「-」✅（修復前錯誤顯示「其他 8h」）

**修改檔案**：`timesheets.html`

## 預期成果

- ✅ 客戶下拉選單正常顯示所有客戶
- ✅ 工時類型選擇更友好（先輸入後提示）
- ✅ 日期標籤正確顯示假日類型
- ✅ 工時總計準確計算並自動更新
- ✅ 統一儲存按鈕提升填寫效率
- ✅ UI佈局合理，按鈕在同一行
- ✅ 每日工時完整性視覺提醒
- ✅ 工時類型時數限制正確
- ✅ 加班順序邏輯強制執行
- ✅ 刪除列正確調用後端API
- ✅ 完整性顯示改為「缺X小時」更直觀
- ✅ 國定假日正確顯示標籤
- ✅ 完整性檢查不檢查週末和假日
- ✅ 國定假日優先級最高（覆蓋週末顯示）
- ✅ 輸入時即時驗證（立即阻止不允許的組合）


