# 任務 55：取消補班制度與更新2025-2026年假日資料

## 任務目標
根據2025年5月28日公布的《紀念日及節日實施條例》修正案，取消補班制度（改為只補假不補班），並更新2025-2026年完整假日資料。

## 背景說明

### 政策變更
- **生效時間**：2025年下半年起
- **主要變更**：取消補班制度，改為「只補假不補班」
- **影響範圍**：
  - 2025年下半年起無補班日
  - 2026年全年無補班日
  - 新增5個國定假日

### 新增國定假日（2025年起）
1. 農曆小年夜（農曆除夕前一天）
2. 勞動節（5月1日）- 全國放假
3. 教師節（9月28日）- 孔子誕辰
4. 光復節（10月25日）
5. 行憲紀念日（12月25日）

### 2025年假日資料
**全年總放假日數**：120天  
**3天以上連續假期**：8個

| 連假名稱 | 日期範圍 | 天數 |
|---------|----------|------|
| 春節連假 | 1/25～2/2 | 9天 |
| 228連假 | 2/28～3/2 | 3天 |
| 清明節連假 | 4/3～4/6 | 4天 |
| 端午節連假 | 5/30～6/1 | 3天 |
| 教師節連假 | 9/27～9/29 | 3天 |
| 中秋節連假 | 10/4～10/6 | 3天 |
| 國慶日連假 | 10/10～10/12 | 3天 |
| 光復節連假 | 10/24～10/26 | 3天 |

**單日假期**：
- 元旦（1/1）
- 勞動節（5/1）
- 行憲紀念日（12/25）

**補班日**：僅2/8一天（為上半年最後補班）

### 2026年假日資料
**全年總放假日數**：120天  
**3天以上連續假期**：9個

| 連假名稱 | 日期範圍 | 天數 |
|---------|----------|------|
| 農曆春節連假 | 2/14～2/22 | 9天 |
| 228連假 | 2/27～3/1 | 3天 |
| 清明節連假 | 4/3～4/6 | 4天 |
| 勞動節連假 | 5/1～5/3 | 3天 |
| 端午節連假 | 6/19～6/21 | 3天 |
| 中秋節及教師節連假 | 9/25～9/28 | 4天 |
| 國慶日連假 | 10/9～10/11 | 3天 |
| 光復節連假 | 10/24～10/26 | 3天 |
| 行憲紀念日連假 | 12/25～12/27 | 3天 |

**單日假期**：元旦（1/1）  
**補班日**：無

---

## 對應文件

### 使用手冊
- `docs/使用手冊/參數配置-06-國定假日參數.md`（需更新）

### 前後端規格
- 後端：`docs/開發指南/後端/假期管理-後端規格.md`
- 前端：`docs/開發指南/前端/工時管理-前端規格.md`

### 相關任務
- 任務 45：工時表優化與修復
- 任務 51：假期餘額 API

---

## 實作步驟

### 1️⃣ 更新資料庫遷移

**檔案**：`cloudflare/worker-router/migrations/2025-10-30T001600Z_update_holidays_2025.sql`

**內容**：
- 刪除2025年舊資料
- 插入2025年完整假日資料（包含新增國定假日）
- 標記補班日（僅2/8）

**檔案**：`cloudflare/worker-router/migrations/2025-10-30T001700Z_add_holidays_2026.sql`（新建）

**內容**：
- 插入2026年完整假日資料
- 無補班日

### 2️⃣ 更新 Holidays 表結構（如需要）

**保持現有欄位**：
```sql
- holiday_date TEXT PRIMARY KEY
- name TEXT
- is_national_holiday BOOLEAN
- is_weekly_restday BOOLEAN
- is_makeup_workday BOOLEAN  -- 保留欄位，但2026年起不再使用
```

**說明**：
- `is_makeup_workday` 欄位保留以支援歷史資料
- 2025年僅2/8為補班日
- 2026年起此欄位值恆為 0

### 3️⃣ 更新假日 API

**檔案**：`cloudflare/worker-router/src/api/holidays.js`

**變更**：無需修改（API已支援查詢補班日欄位）

### 4️⃣ 更新前端日期判斷邏輯

**檔案**：`timesheets.html`

**函數**：`getDateType(date)`

**變更說明**：
- 保持現有邏輯（從 holidays Map 查詢）
- 確保補班日判斷正確處理
- 2026年起不會有補班日資料

**函數**：`updateWeekDisplay()`

**變更說明**：
- 補班日標籤顯示邏輯保留
- 2025年可能顯示補班標籤
- 2026年起不再顯示補班標籤

### 5️⃣ 更新使用手冊

**檔案**：`docs/使用手冊/參數配置-06-國定假日參數.md`

**新增說明**：
- 2025年政策變更說明
- 新增5個國定假日列表
- 補班制度取消說明
- 2025-2026年完整假日列表

---

## 自我測試清單

### 資料庫測試
- [ ] 2025年假日資料正確載入（共38筆，含1個補班日）
- [ ] 2026年假日資料正確載入（共34筆，無補班日）
- [ ] 新增國定假日正確標記為 `is_national_holiday = 1`
- [ ] 2/8補班日正確標記為 `is_makeup_workday = 1`

### API測試
- [ ] `GET /api/v1/holidays?start_date=2025-01-01&end_date=2025-12-31` 返回完整2025年資料
- [ ] `GET /api/v1/holidays?start_date=2026-01-01&end_date=2026-12-31` 返回完整2026年資料
- [ ] 教師節（9/28）、光復節（10/25）、行憲紀念日（12/25）正確返回

### 前端測試
- [ ] 工時管理頁面：9/28、10/25、12/25 顯示「國定」標籤
- [ ] 工時管理頁面：2025年2/8 顯示「補班」標籤
- [ ] 工時管理頁面：2026年無任何「補班」標籤
- [ ] 假期管理頁面：國定假日正確顯示並可選擇
- [ ] 日期類型判斷：補班日允許使用「正常工時」

### 邏輯測試
- [ ] 週六+補班日：判斷為「補班日」而非「休息日」
- [ ] 週日+國定假日：判斷為「國定假日」而非「例假日」
- [ ] 2025年2/8（週六）判斷為補班日，可選擇正常工時
- [ ] 2026年所有週六判斷為休息日，不可選擇正常工時

---

## 部署驗證

### 1. 執行資料庫遷移
```bash
cd cloudflare/worker-router
wrangler d1 migrations apply horgoscpa-db --remote
```

### 2. 驗證資料
```bash
# 查詢2025年假日
wrangler d1 execute horgoscpa-db --remote --command \
  "SELECT holiday_date, name, is_national_holiday, is_makeup_workday 
   FROM Holidays WHERE holiday_date BETWEEN '2025-01-01' AND '2025-12-31' 
   ORDER BY holiday_date"

# 查詢2026年假日
wrangler d1 execute horgoscpa-db --remote --command \
  "SELECT holiday_date, name, is_national_holiday, is_makeup_workday 
   FROM Holidays WHERE holiday_date BETWEEN '2026-01-01' AND '2026-12-31' 
   ORDER BY holiday_date"

# 查詢補班日
wrangler d1 execute horgoscpa-db --remote --command \
  "SELECT holiday_date, name FROM Holidays 
   WHERE is_makeup_workday = 1 
   ORDER BY holiday_date"
```

### 3. 前端測試
- 刷新工時管理頁面
- 切換到2025年9月、10月、12月，確認新增國定假日顯示
- 切換到2026年，確認無補班日標籤

### 4. 回滾預案
如發現問題，可執行：
```bash
wrangler d1 execute horgoscpa-db --remote --command \
  "DELETE FROM Holidays WHERE holiday_date >= '2025-01-01'"
```
然後重新執行舊版遷移。

---

## 完成標準
- ✅ 2025-2026年假日資料完整載入
- ✅ 新增5個國定假日正確標記
- ✅ 補班制度邏輯正確（2025僅2/8，2026無）
- ✅ 前端日期標籤正確顯示
- ✅ 工時類型驗證邏輯正常運作
- ✅ 使用手冊更新完成
- ✅ 所有測試通過
- ✅ 部署成功並驗證

---

## 備註
- 本次變更不涉及前端代碼修改（僅資料庫與文檔）
- 前端邏輯已支援補班日判斷，無需調整
- 未來年度假日資料可持續使用相同遷移模式更新

