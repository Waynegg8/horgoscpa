# 管理成本 - 完整規格

**模組名稱：** 管理成本系統  
**版本：** 3.2  
**更新日期：** 2025-10-28

---

## 📋 功能概述

### 設計目標

**需求背景：**
- 公司有房租、水電、設備等管理成本
- 這些成本應該分攤到員工工時成本中
- 才能計算出真實的客戶服務成本
- 需要能自由新增/管理各種成本項目

**核心功能：**
1. ✅ 靈活的管理成本項目系統
2. ✅ 月度管理成本記錄
3. ✅ 自動分攤到員工時薪成本率
4. ✅ 完整的成本追蹤與報表

---

## 💾 資料表設計

### 1. OverheadCostTypes（管理成本項目類型）

**設計理由：** 每家公司的管理成本項目不同，需要靈活配置

```sql
CREATE TABLE OverheadCostTypes (
  cost_type_id INTEGER PRIMARY KEY AUTOINCREMENT,
  cost_code TEXT UNIQUE NOT NULL,  -- 成本代碼（如：RENT）
  cost_name TEXT NOT NULL,  -- 成本名稱（如：辦公室租金）
  category TEXT NOT NULL,  -- 類別：'fixed'（固定成本）, 'variable'（變動成本）
  allocation_method TEXT NOT NULL,  -- 分攤方式：'per_employee'（按人頭）, 'per_hour'（按工時）, 'per_revenue'（按營收）
  description TEXT,
  is_active BOOLEAN DEFAULT 1,
  display_order INTEGER DEFAULT 0,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  
  CHECK (category IN ('fixed', 'variable')),
  CHECK (allocation_method IN ('per_employee', 'per_hour', 'per_revenue'))
);

CREATE INDEX idx_overhead_cost_types_active ON OverheadCostTypes(is_active);
CREATE INDEX idx_overhead_cost_types_category ON OverheadCostTypes(category);

-- 預設管理成本項目範例
INSERT INTO OverheadCostTypes (cost_code, cost_name, category, allocation_method, description) VALUES
('RENT', '辦公室租金', 'fixed', 'per_employee', '每月辦公室租金'),
('UTILITIES', '水電瓦斯', 'fixed', 'per_employee', '水費、電費、瓦斯費'),
('INTERNET', '網路通訊', 'fixed', 'per_employee', '網路、電話費用'),
('EQUIPMENT', '設備折舊', 'fixed', 'per_employee', '電腦、辦公設備折舊'),
('SOFTWARE', '軟體授權', 'fixed', 'per_employee', '各種軟體訂閱費用'),
('INSURANCE', '保險費用', 'fixed', 'per_employee', '公司保險費'),
('MAINTENANCE', '維護費用', 'variable', 'per_hour', '辦公室維護、清潔'),
('MARKETING', '行銷費用', 'variable', 'per_revenue', '廣告、行銷活動');
```

### 2. MonthlyOverheadCosts（月度管理成本）

```sql
CREATE TABLE MonthlyOverheadCosts (
  overhead_id INTEGER PRIMARY KEY AUTOINCREMENT,
  cost_type_id INTEGER NOT NULL,
  year INTEGER NOT NULL,
  month INTEGER NOT NULL,
  amount REAL NOT NULL,  -- 金額
  notes TEXT,
  recorded_by INTEGER NOT NULL,
  recorded_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (cost_type_id) REFERENCES OverheadCostTypes(cost_type_id),
  FOREIGN KEY (recorded_by) REFERENCES Users(user_id),
  UNIQUE(cost_type_id, year, month)  -- 每種成本每月只有一筆
);

CREATE INDEX idx_monthly_overhead_date ON MonthlyOverheadCosts(year, month);
CREATE INDEX idx_monthly_overhead_type ON MonthlyOverheadCosts(cost_type_id);

-- 範例資料（2025年10月）
INSERT INTO MonthlyOverheadCosts (cost_type_id, year, month, amount, recorded_by) VALUES
(1, 2025, 10, 25000, 1),  -- 租金 25,000元
(2, 2025, 10, 3500, 1),   -- 水電 3,500元
(3, 2025, 10, 2000, 1),   -- 網路 2,000元
(4, 2025, 10, 5000, 1),   -- 設備折舊 5,000元
(5, 2025, 10, 3000, 1);   -- 軟體授權 3,000元
-- 合計：38,500元/月
```

---

## 📐 成本分攤計算

### 1. 按人頭分攤（per_employee）

**適用成本：** 租金、水電、網路等固定成本

```typescript
/**
 * 固定成本按人頭分攤
 * 例如：租金、水電
 */
function calculatePerEmployeeOverhead(
  totalOverhead: number,
  employeeCount: number
): number {
  return totalOverhead / employeeCount;
}

/**
 * 範例：
 * 租金 25,000 + 水電 3,500 + 網路 2,000 = 30,500元
 * 員工數：4人
 * 每人分攤：30,500 ÷ 4 = 7,625元/月
 */
```

### 2. 按工時分攤（per_hour）

**適用成本：** 維護費用等變動成本

```typescript
/**
 * 變動成本按工時分攤
 * 例如：維護費用
 */
function calculatePerHourOverhead(
  totalOverhead: number,
  totalWorkHours: number
): number {
  return totalOverhead / totalWorkHours;
}

/**
 * 範例：
 * 維護費用 5,000元
 * 全公司總工時：640小時（4人 × 160小時）
 * 每小時分攤：5,000 ÷ 640 ≈ 7.81元/小時
 */
```

### 3. 按營收分攤（per_revenue）

**適用成本：** 行銷成本等

```typescript
/**
 * 行銷成本按營收分攤
 * 例如：廣告費用
 */
function calculatePerRevenueOverhead(
  totalOverhead: number,
  totalRevenue: number
): number {
  return totalOverhead / totalRevenue;
}

/**
 * 範例：
 * 行銷費用 10,000元
 * 當月營收 500,000元
 * 營收占比：10,000 ÷ 500,000 = 2%
 * 
 * 某客戶營收 50,000元
 * 應分攤行銷成本：50,000 × 2% = 1,000元
 */
```

### 4. 時薪成本率計算（含管理成本）⭐

**修正後的計算公式：**

```typescript
/**
 * 計算員工的完整時薪成本率
 * 包含：薪資成本 + 管理成本分攤
 */
async function calculateFullHourlyCostRate(
  user_id: number,
  year: number,
  month: number
): Promise<number> {
  
  const MONTHLY_STANDARD_HOURS = 240;
  
  // 1. 取得員工基本資料
  const user = await db.prepare(`
    SELECT * FROM Users WHERE user_id = ?
  `).bind(user_id).first();
  
  // 2. 查詢員工所有薪資項目（⚠️ 只算經常性給與）
  const salaryItems = await db.prepare(`
    SELECT sit.*, esi.amount
    FROM EmployeeSalaryItems esi
    JOIN SalaryItemTypes sit ON esi.item_type_id = sit.item_type_id
    WHERE esi.user_id = ?
      AND esi.is_active = 1
      AND sit.is_regular_payment = 1  -- ⭐ 只算經常性給與（不含年終獎金等）
      AND (esi.expiry_date IS NULL OR esi.expiry_date >= date('now'))
  `).bind(user_id).all();
  
  // 計算固定薪資總和
  const totalFixedSalary = 
    user.base_salary + 
    salaryItems.results.reduce((sum, item) => sum + item.amount, 0);
  
  // 3. 查詢當月管理成本（按人頭分攤的部分）
  const employeeCount = await db.prepare(`
    SELECT COUNT(*) as count FROM Users WHERE is_deleted = 0
  `).first();
  
  const perEmployeeOverhead = await db.prepare(`
    SELECT COALESCE(SUM(moc.amount), 0) as total
    FROM MonthlyOverheadCosts moc
    JOIN OverheadCostTypes oct ON moc.cost_type_id = oct.cost_type_id
    WHERE moc.year = ?
      AND moc.month = ?
      AND oct.allocation_method = 'per_employee'
      AND moc.is_deleted = 0
  `).bind(year, month).first();
  
  // ⚠️ 依照現有數據計算（即使只有部分管理成本也可以算）
  // 如果完全沒輸入 → total = 0，只計算薪資成本
  // 如果只輸入部分（如：只填租金） → 就用部分數據計算
  const overheadPerEmployee = 
    (perEmployeeOverhead?.total || 0) / (employeeCount?.count || 1);
  
  // 4. 計算時薪成本率
  const monthlyCost = totalFixedSalary + overheadPerEmployee;
  const hourlyCostRate = monthlyCost / MONTHLY_STANDARD_HOURS;
  
  return hourlyCostRate;
}

/**
 * 計算範例：
 * 
 * 員工A：
 * - 底薪：35,000元
 * - 全勤：2,000元
 * - 交通：1,000元
 * - 伙食：1,800元
 * - 固定薪資合計：39,800元
 * 
 * 情況1：管理成本已完整輸入（4人均分）
 * - 租金：25,000 ÷ 4 = 6,250元
 * - 水電：3,500 ÷ 4 = 875元
 * - 網路：2,000 ÷ 4 = 500元
 * - 設備：5,000 ÷ 4 = 1,250元
 * - 軟體：3,000 ÷ 4 = 750元
 * - 管理成本合計：9,625元
 * - 月度總成本：39,800 + 9,625 = 49,425元
 * - 時薪成本率：49,425 ÷ 240 ≈ 206元/小時
 * 
 * 情況2：管理成本只輸入部分（如：只填租金）⚠️
 * - 租金：25,000 ÷ 4 = 6,250元
 * - 其他：尚未輸入
 * - 管理成本合計：6,250元（部分）
 * - 月度總成本：39,800 + 6,250 = 46,050元
 * - 時薪成本率：46,050 ÷ 240 ≈ 192元/小時
 * - ⚠️ 報表會顯示警告：「管理成本尚未完整輸入」
 * 
 * 情況3：管理成本完全沒輸入
 * - 管理成本合計：0元
 * - 月度總成本：39,800元
 * - 時薪成本率：39,800 ÷ 240 ≈ 166元/小時
 * - ⚠️ 報表會顯示警告：「管理成本未輸入，僅含薪資成本」
 */
```

---

## 🔌 API 端點

### 管理成本項目管理

```
GET    /api/v1/admin/overhead-types              查詢所有成本項目類型
POST   /api/v1/admin/overhead-types              新增成本項目類型
PUT    /api/v1/admin/overhead-types/:id          更新成本項目類型
DELETE /api/v1/admin/overhead-types/:id          刪除成本項目類型
```

**新增成本項目範例：**
```json
// POST /api/v1/admin/overhead-types
{
  "cost_code": "PARKING",
  "cost_name": "停車費",
  "category": "fixed",
  "allocation_method": "per_employee",
  "description": "辦公室停車位租金"
}

// 回應
{
  "success": true,
  "data": {
    "cost_type_id": 9,
    "cost_code": "PARKING",
    "cost_name": "停車費",
    "category": "fixed",
    "allocation_method": "per_employee"
  }
}
```

### 月度成本記錄

```
GET    /api/v1/admin/overhead-costs              查詢月度成本
POST   /api/v1/admin/overhead-costs              新增月度成本
PUT    /api/v1/admin/overhead-costs/:id          更新月度成本
DELETE /api/v1/admin/overhead-costs/:id          刪除月度成本
```

**記錄月度成本範例：**
```json
// POST /api/v1/admin/overhead-costs
{
  "cost_type_id": 1,  // 租金
  "year": 2025,
  "month": 11,
  "amount": 25000,
  "notes": "11月份租金"
}

// 回應
{
  "success": true,
  "data": {
    "overhead_id": 123,
    "cost_type_id": 1,
    "cost_name": "辦公室租金",
    "year": 2025,
    "month": 11,
    "amount": 25000
  }
}
```

### 成本分析

```
GET    /api/v1/admin/overhead-analysis           管理成本分析報表
GET    /api/v1/admin/overhead-summary            管理成本彙總
```

**管理成本分析範例：**
```json
// GET /api/v1/admin/overhead-analysis?year=2025&month=10

{
  "success": true,
  "data": {
    "year": 2025,
    "month": 10,
    "total_overhead": 38500,
    "employee_count": 4,
    "overhead_per_employee": 9625,
    
    "breakdown_by_category": {
      "fixed": 38500,
      "variable": 0
    },
    
    "breakdown_by_type": [
      {
        "cost_type_id": 1,
        "cost_name": "辦公室租金",
        "amount": 25000,
        "percentage": 64.9
      },
      {
        "cost_type_id": 4,
        "cost_name": "設備折舊",
        "amount": 5000,
        "percentage": 13.0
      }
    ],
    
    "cost_rate_impact": {
      "average_hourly_cost_without_overhead": 230,
      "average_hourly_cost_with_overhead": 285,
      "overhead_impact_percentage": 24.0
    }
  }
}
```

---

## 🎨 前端組件

### OverheadCostManagementPage.vue

**功能：**
- 成本項目設定
- 月度成本記錄
- 成本分析報表

**Tab 結構：**
1. **成本項目設定**
   - 新增/編輯/刪除成本項目
   - 顯示所有成本項目列表
   
2. **月度成本記錄**
   - 月份選擇
   - 新增/編輯月度成本
   - 顯示月度成本列表
   - 月度總計
   
3. **成本分析**
   - 成本結構圓餅圖
   - 歷史趨勢折線圖
   - 對時薪成本率的影響分析

---

## 📊 成本影響分析

### 成本對比範例

**情境：** 員工A為客戶服務85小時（含5小時加班）

#### 不含管理成本

```
固定薪資：39,800元
時薪成本率：39,800 ÷ 240 ≈ 166元/小時

加權工時：80 × 1.0 + 5 × 1.34 = 86.7小時
成本：86.7 × 166 = 14,392元
```

#### 含管理成本

```
固定薪資：39,800元
管理成本分攤：9,625元
月度總成本：49,425元
時薪成本率：49,425 ÷ 240 ≈ 206元/小時

加權工時：86.7小時
成本：86.7 × 206 = 17,860元
```

#### 差異分析

```
成本增加：17,860 - 14,392 = 3,468元 (+24%)
管理成本影響：24%
```

**結論：** 加入管理成本後，客戶服務的真實成本提高約24%

---

## ⚠️ 注意事項

1. **成本項目靈活性**：可隨時新增自訂成本項目
2. **分攤方式選擇**：根據成本性質選擇合適的分攤方式
3. **按月記錄**：每月需要記錄管理成本，才能準確計算
4. **自動併入**：管理成本會自動併入時薪成本率計算

---

**相關文檔：**
- [薪資管理-完整規格](./薪資管理-完整規格.md)
- [工時管理-完整規格](./工時管理-完整規格.md)
- [報表分析-完整規格](./報表分析-完整規格.md)

