# 附件系統 - 完整規格

**模組名稱：** 文件上傳/附件系統  
**版本：** 3.2  
**更新日期：** 2025-10-28

---

## 📋 功能概述

### 使用場景

1. **客戶附件**
   - 公司登記文件
   - 合約掃描檔
   - 營業執照
   - 負責人身分證影本

2. **收據附件**
   - 收據掃描檔
   - 相關憑證

3. **知識管理附件**
   - SOP 附件（範本檔案、流程圖）
   - 知識庫附件

4. **任務附件**
   - 任務相關文件
   - 客戶提供的資料

---

## 💾 資料表設計

```sql
CREATE TABLE Attachments (
  attachment_id INTEGER PRIMARY KEY AUTOINCREMENT,
  entity_type TEXT NOT NULL,  -- 'client', 'receipt', 'sop', 'task'
  entity_id TEXT NOT NULL,  -- 關聯的實體ID
  file_name TEXT NOT NULL,  -- 原始檔名
  file_path TEXT NOT NULL,  -- Cloudflare R2 路徑
  file_size INTEGER,  -- 檔案大小（bytes）
  mime_type TEXT,  -- 檔案類型
  uploaded_by INTEGER NOT NULL,
  uploaded_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (uploaded_by) REFERENCES Users(user_id),
  CHECK (entity_type IN ('client', 'receipt', 'sop', 'task'))
);

CREATE INDEX idx_attachments_entity ON Attachments(entity_type, entity_id);
CREATE INDEX idx_attachments_uploaded ON Attachments(uploaded_at);
```

---

## 📐 檔案限制規範

### 上傳限制

```typescript
/**
 * 檔案上傳限制
 */
const FILE_UPLOAD_LIMITS = {
  // 單檔大小限制：10MB
  MAX_FILE_SIZE: 10 * 1024 * 1024,  // 10MB = 10,485,760 bytes
  
  // 允許的檔案類型（MIME Type）
  ALLOWED_MIME_TYPES: [
    'application/pdf',                        // PDF
    'image/jpeg',                             // JPG/JPEG
    'image/png',                              // PNG
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',  // XLSX
    'application/vnd.ms-excel',               // XLS
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',  // DOCX
    'application/msword'                      // DOC
  ],
  
  // 允許的副檔名
  ALLOWED_EXTENSIONS: ['.pdf', '.jpg', '.jpeg', '.png', '.xlsx', '.xls', '.docx', '.doc'],
  
  // 每個實體的附件數量限制
  MAX_FILES_PER_ENTITY: {
    client: 20,
    receipt: 5,
    sop: 10,
    task: 10
  }
};
```

### 驗證函數

```typescript
/**
 * 驗證上傳檔案
 */
async function validateUploadFile(
  file: File,
  entity_type: string,
  entity_id: string
): Promise<{ valid: boolean; errors: any[] }> {
  const errors = [];
  
  // 1. 檔案大小檢查
  if (file.size > FILE_UPLOAD_LIMITS.MAX_FILE_SIZE) {
    errors.push({
      code: 'FILE_TOO_LARGE',
      message: `檔案大小超過限制（最大 10MB）`
    });
  }
  
  // 2. MIME 類型檢查
  if (!FILE_UPLOAD_LIMITS.ALLOWED_MIME_TYPES.includes(file.type)) {
    errors.push({
      code: 'INVALID_FILE_TYPE',
      message: `不支援的檔案類型，僅允許：PDF, JPG, PNG, XLSX, DOCX`
    });
  }
  
  // 3. 副檔名檢查
  const extension = ('.' + file.name.split('.').pop()).toLowerCase();
  if (!FILE_UPLOAD_LIMITS.ALLOWED_EXTENSIONS.includes(extension)) {
    errors.push({
      code: 'INVALID_EXTENSION',
      message: `不支援的副檔名`
    });
  }
  
  // 4. 檔名安全檢查（防止路徑遍歷攻擊）
  if (file.name.includes('..') || file.name.includes('/') || file.name.includes('\\')) {
    errors.push({
      code: 'INVALID_FILENAME',
      message: `檔名包含非法字元`
    });
  }
  
  // 5. 附件數量檢查
  const count = await db.prepare(`
    SELECT COUNT(*) as count FROM Attachments
    WHERE entity_type = ? AND entity_id = ? AND is_deleted = 0
  `).bind(entity_type, entity_id).first();
  
  const maxFiles = FILE_UPLOAD_LIMITS.MAX_FILES_PER_ENTITY[entity_type] || 10;
  if (count.count >= maxFiles) {
    errors.push({
      code: 'TOO_MANY_FILES',
      message: `已達到附件數量上限（最多 ${maxFiles} 個）`
    });
  }
  
  return { valid: errors.length === 0, errors };
}
```

---

## 🔌 Cloudflare R2 整合

### 設定 R2 Bucket

```toml
# wrangler.toml
[[r2_buckets]]
binding = "ATTACHMENTS_BUCKET"
bucket_name = "horgoscpa-attachments"
```

### 上傳 API

```typescript
// POST /api/v1/attachments/upload
async function uploadAttachment(request: Request, env: Env) {
  const formData = await request.formData();
  const file = formData.get('file') as File;
  const entityType = formData.get('entity_type') as string;
  const entityId = formData.get('entity_id') as string;
  
  // ⭐ 驗證檔案
  const validation = await validateUploadFile(file, entityType, entityId);
  if (!validation.valid) {
    return {
      success: false,
      errors: validation.errors
    };
  }
  
  // 生成唯一檔名
  const fileExt = file.name.split('.').pop();
  const timestamp = Date.now();
  const randomStr = Math.random().toString(36).substring(2, 8);
  const fileName = `${entityType}/${entityId}/${timestamp}-${randomStr}.${fileExt}`;
  
  // 上傳到 R2
  await env.ATTACHMENTS_BUCKET.put(fileName, file.stream(), {
    httpMetadata: {
      contentType: file.type
    }
  });
  
  // 記錄到資料庫
  const result = await db.prepare(`
    INSERT INTO Attachments (
      entity_type, entity_id, file_name, file_path,
      file_size, mime_type, uploaded_by
    ) VALUES (?, ?, ?, ?, ?, ?, ?)
  `).bind(
    entityType, 
    entityId, 
    file.name, 
    fileName,
    file.size, 
    file.type, 
    user.user_id
  ).run();
  
  return { 
    success: true, 
    data: {
      attachment_id: result.meta.last_row_id,
      file_name: file.name,
      file_path: fileName,
      file_size: file.size
    }
  };
}
```

### 下載 API

```typescript
// GET /api/v1/attachments/:id/download
async function downloadAttachment(attachmentId: number, env: Env) {
  // 查詢附件資訊
  const attachment = await db.prepare(`
    SELECT * FROM Attachments WHERE attachment_id = ? AND is_deleted = 0
  `).bind(attachmentId).first();
  
  if (!attachment) {
    return new Response('附件不存在', { status: 404 });
  }
  
  // 從 R2 獲取檔案
  const file = await env.ATTACHMENTS_BUCKET.get(attachment.file_path);
  
  if (!file) {
    return new Response('檔案不存在', { status: 404 });
  }
  
  return new Response(file.body, {
    headers: {
      'Content-Type': attachment.mime_type,
      'Content-Disposition': `attachment; filename="${encodeURIComponent(attachment.file_name)}"`,
      'Content-Length': attachment.file_size.toString()
    }
  });
}
```

### 刪除 API

```typescript
// DELETE /api/v1/attachments/:id
async function deleteAttachment(attachmentId: number, env: Env) {
  // 查詢附件資訊
  const attachment = await db.prepare(`
    SELECT * FROM Attachments WHERE attachment_id = ?
  `).bind(attachmentId).first();
  
  if (!attachment) {
    return { success: false, error: '附件不存在' };
  }
  
  // 從 R2 刪除檔案
  await env.ATTACHMENTS_BUCKET.delete(attachment.file_path);
  
  // 軟刪除資料庫記錄
  await db.prepare(`
    UPDATE Attachments SET is_deleted = 1 WHERE attachment_id = ?
  `).bind(attachmentId).run();
  
  return { success: true };
}
```

---

## 🔌 API 端點

⚠️ **小型事務所彈性設計** - 員工也可刪除附件

```
POST   /api/v1/attachments/upload        權限：所有人
GET    /api/v1/attachments/:id           權限：所有人
GET    /api/v1/attachments/:id/download  權限：所有人
DELETE /api/v1/attachments/:id           權限：所有人（小型事務所彈性設計）
GET    /api/v1/attachments                權限：所有人
```

### API 範例

**上傳附件：**
```typescript
// POST /api/v1/attachments/upload
// Content-Type: multipart/form-data

FormData:
- file: [File Object]
- entity_type: "client"
- entity_id: "12345678"

// 回應
{
  "success": true,
  "data": {
    "attachment_id": 123,
    "file_name": "公司登記證.pdf",
    "file_path": "client/12345678/1730123456-abc123.pdf",
    "file_size": 524288  // 512KB
  }
}
```

**查詢附件列表：**
```typescript
// GET /api/v1/attachments?entity_type=client&entity_id=12345678

{
  "success": true,
  "data": [
    {
      "attachment_id": 123,
      "file_name": "公司登記證.pdf",
      "file_size": 524288,
      "mime_type": "application/pdf",
      "uploaded_by": 1,
      "uploaded_at": "2025-10-28T10:30:00Z"
    },
    {
      "attachment_id": 124,
      "file_name": "營業執照.jpg",
      "file_size": 1048576,
      "mime_type": "image/jpeg",
      "uploaded_by": 1,
      "uploaded_at": "2025-10-28T11:00:00Z"
    }
  ]
}
```

---

## 🎨 前端組件

### AttachmentUploader.vue

```vue
<template>
  <div class="attachment-uploader">
    <div class="upload-area">
      <input
        type="file"
        ref="fileInput"
        @change="handleFileChange"
        multiple
        accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls,.docx,.doc"
        :disabled="isUploading"
      />
      
      <div class="upload-button">
        <StyledButton @click="$refs.fileInput.click()" :disabled="isUploading">
          <IconUpload /> 選擇檔案
        </StyledButton>
        <span class="hint">支援：PDF, JPG, PNG, XLSX, DOCX（最大10MB）</span>
      </div>
    </div>
    
    <!-- 附件列表 -->
    <div class="attachment-list">
      <div
        v-for="file in attachments"
        :key="file.attachment_id"
        class="attachment-item"
      >
        <div class="file-icon">
          <IconFile :type="getFileType(file.mime_type)" />
        </div>
        <div class="file-info">
          <span class="file-name">{{ file.file_name }}</span>
          <span class="file-size">{{ formatFileSize(file.file_size) }}</span>
        </div>
        <div class="file-actions">
          <StyledButton size="small" @click="downloadFile(file)">
            <IconDownload /> 下載
          </StyledButton>
          <StyledButton 
            size="small" 
            variant="danger" 
            @click="deleteFile(file)"
          >
            <IconDelete /> 刪除
          </StyledButton>
        </div>
      </div>
    </div>
    
    <!-- 上傳進度 -->
    <div v-if="isUploading" class="upload-progress">
      <ProgressBar :value="uploadProgress" />
      <span>上傳中... {{ uploadProgress }}%</span>
    </div>
  </div>
</template>

<script setup>
import { ref } from 'vue';

const props = defineProps({
  entityType: { type: String, required: true },
  entityId: { type: String, required: true }
});

const attachments = ref([]);
const isUploading = ref(false);
const uploadProgress = ref(0);

async function handleFileChange(event) {
  const files = Array.from(event.target.files);
  
  for (const file of files) {
    await uploadFile(file);
  }
  
  // 清空 input
  event.target.value = '';
}

async function uploadFile(file) {
  isUploading.value = true;
  
  try {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('entity_type', props.entityType);
    formData.append('entity_id', props.entityId);
    
    const response = await fetch('/api/v1/attachments/upload', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      attachments.value.push(result.data);
    } else {
      alert('上傳失敗：' + result.errors.map(e => e.message).join(', '));
    }
  } catch (error) {
    alert('上傳失敗：' + error.message);
  } finally {
    isUploading.value = false;
  }
}

async function downloadFile(file) {
  window.open(`/api/v1/attachments/${file.attachment_id}/download`, '_blank');
}

async function deleteFile(file) {
  if (!confirm(`確定要刪除「${file.file_name}」嗎？`)) return;
  
  const response = await fetch(`/api/v1/attachments/${file.attachment_id}`, {
    method: 'DELETE'
  });
  
  const result = await response.json();
  
  if (result.success) {
    attachments.value = attachments.value.filter(
      f => f.attachment_id !== file.attachment_id
    );
  }
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function getFileType(mimeType) {
  if (mimeType.includes('pdf')) return 'pdf';
  if (mimeType.includes('image')) return 'image';
  if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'excel';
  if (mimeType.includes('word') || mimeType.includes('document')) return 'word';
  return 'file';
}
</script>
```

---

## 🔒 安全性考量

### 1. 檔案類型驗證

- ✅ 檢查 MIME Type
- ✅ 檢查副檔名
- ✅ 雙重驗證防止偽造

### 2. 檔案大小限制

- ✅ 前端驗證（提早阻止）
- ✅ 後端驗證（防止繞過）
- ✅ 限制 10MB 防止濫用

### 3. 檔名安全

- ✅ 過濾路徑遍歷字元（`..`, `/`, `\`）
- ✅ 使用時間戳 + 隨機字串重新命名
- ✅ 下載時使用原始檔名

### 4. 存取權限

- ✅ 上傳需登入
- ✅ 下載檢查權限（同公司/同團隊）
- ✅ 刪除檢查權限（上傳者或管理員）

### 5. 儲存安全

- ✅ 使用 Cloudflare R2（自動備份）
- ✅ 軟刪除（可恢復）
- ✅ 定期清理已刪除檔案

---

## ⚠️ 注意事項

1. **檔案大小**：單檔最大 10MB
2. **檔案類型**：僅支援 PDF, JPG, PNG, XLSX, DOCX
3. **數量限制**：
   - 客戶：20個
   - 發票：5個
   - SOP：10個
   - 任務：10個
4. **命名規則**：自動生成唯一檔名，避免衝突

---

## 📊 儲存結構

### R2 Bucket 目錄結構

```
horgoscpa-attachments/
├── client/
│   ├── 12345678/
│   │   ├── 1730123456-abc123.pdf
│   │   └── 1730124567-def456.jpg
│   └── 87654321/
│       └── 1730125678-ghi789.pdf
├── invoice/
│   ├── 202510-001/
│   │   └── 1730126789-jkl012.pdf
│   └── 202510-002/
│       └── 1730127890-mno345.pdf
├── sop/
│   └── 1/
│       ├── 1730128901-pqr678.docx
│       └── 1730129012-stu901.xlsx
└── task/
    └── 42/
        └── 1730130123-vwx234.pdf
```

---

**相關文檔：**
- [客戶管理-完整規格](./客戶管理-完整規格.md)
- [發票收款-完整規格](./發票收款-完整規格.md)
- [知識管理-完整規格](./知識管理-完整規格.md)
- [任務管理-完整規格](./任務管理-完整規格.md)

