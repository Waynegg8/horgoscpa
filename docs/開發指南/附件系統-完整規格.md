# é™„ä»¶ç³»çµ± - å®Œæ•´è¦æ ¼

**æ¨¡çµ„åç¨±ï¼š** æ–‡ä»¶ä¸Šå‚³/é™„ä»¶ç³»çµ±  
**ç‰ˆæœ¬ï¼š** 3.2  
**æ›´æ–°æ—¥æœŸï¼š** 2025-10-28

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

### ä½¿ç”¨å ´æ™¯

1. **å®¢æˆ¶é™„ä»¶**
   - å…¬å¸ç™»è¨˜æ–‡ä»¶
   - åˆç´„æƒææª”
   - ç‡Ÿæ¥­åŸ·ç…§
   - è² è²¬äººèº«åˆ†è­‰å½±æœ¬

2. **æ”¶æ“šé™„ä»¶**
   - æ”¶æ“šæƒææª”
   - ç›¸é—œæ†‘è­‰

3. **çŸ¥è­˜ç®¡ç†é™„ä»¶**
   - SOP é™„ä»¶ï¼ˆç¯„æœ¬æª”æ¡ˆã€æµç¨‹åœ–ï¼‰
   - çŸ¥è­˜åº«é™„ä»¶

4. **ä»»å‹™é™„ä»¶**
   - ä»»å‹™ç›¸é—œæ–‡ä»¶
   - å®¢æˆ¶æä¾›çš„è³‡æ–™

---

## ğŸ’¾ è³‡æ–™è¡¨è¨­è¨ˆ

```sql
CREATE TABLE Attachments (
  attachment_id INTEGER PRIMARY KEY AUTOINCREMENT,
  entity_type TEXT NOT NULL,  -- 'client', 'receipt', 'sop', 'task'
  entity_id TEXT NOT NULL,  -- é—œè¯çš„å¯¦é«”ID
  file_name TEXT NOT NULL,  -- åŸå§‹æª”å
  file_path TEXT NOT NULL,  -- Cloudflare R2 è·¯å¾‘
  file_size INTEGER,  -- æª”æ¡ˆå¤§å°ï¼ˆbytesï¼‰
  mime_type TEXT,  -- æª”æ¡ˆé¡å‹
  uploaded_by INTEGER NOT NULL,
  uploaded_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (uploaded_by) REFERENCES Users(user_id),
  CHECK (entity_type IN ('client', 'receipt', 'sop', 'task'))
);

CREATE INDEX idx_attachments_entity ON Attachments(entity_type, entity_id);
CREATE INDEX idx_attachments_uploaded ON Attachments(uploaded_at);
```

---

## ğŸ“ æª”æ¡ˆé™åˆ¶è¦ç¯„

### ä¸Šå‚³é™åˆ¶

```typescript
/**
 * æª”æ¡ˆä¸Šå‚³é™åˆ¶
 */
const FILE_UPLOAD_LIMITS = {
  // å–®æª”å¤§å°é™åˆ¶ï¼š10MB
  MAX_FILE_SIZE: 10 * 1024 * 1024,  // 10MB = 10,485,760 bytes
  
  // å…è¨±çš„æª”æ¡ˆé¡å‹ï¼ˆMIME Typeï¼‰
  ALLOWED_MIME_TYPES: [
    'application/pdf',                        // PDF
    'image/jpeg',                             // JPG/JPEG
    'image/png',                              // PNG
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',  // XLSX
    'application/vnd.ms-excel',               // XLS
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',  // DOCX
    'application/msword'                      // DOC
  ],
  
  // å…è¨±çš„å‰¯æª”å
  ALLOWED_EXTENSIONS: ['.pdf', '.jpg', '.jpeg', '.png', '.xlsx', '.xls', '.docx', '.doc'],
  
  // æ¯å€‹å¯¦é«”çš„é™„ä»¶æ•¸é‡é™åˆ¶
  MAX_FILES_PER_ENTITY: {
    client: 20,
    receipt: 5,
    sop: 10,
    task: 10
  }
};
```

### é©—è­‰å‡½æ•¸

```typescript
/**
 * é©—è­‰ä¸Šå‚³æª”æ¡ˆ
 */
async function validateUploadFile(
  file: File,
  entity_type: string,
  entity_id: string
): Promise<{ valid: boolean; errors: any[] }> {
  const errors = [];
  
  // 1. æª”æ¡ˆå¤§å°æª¢æŸ¥
  if (file.size > FILE_UPLOAD_LIMITS.MAX_FILE_SIZE) {
    errors.push({
      code: 'FILE_TOO_LARGE',
      message: `æª”æ¡ˆå¤§å°è¶…éé™åˆ¶ï¼ˆæœ€å¤§ 10MBï¼‰`
    });
  }
  
  // 2. MIME é¡å‹æª¢æŸ¥
  if (!FILE_UPLOAD_LIMITS.ALLOWED_MIME_TYPES.includes(file.type)) {
    errors.push({
      code: 'INVALID_FILE_TYPE',
      message: `ä¸æ”¯æ´çš„æª”æ¡ˆé¡å‹ï¼Œåƒ…å…è¨±ï¼šPDF, JPG, PNG, XLSX, DOCX`
    });
  }
  
  // 3. å‰¯æª”åæª¢æŸ¥
  const extension = ('.' + file.name.split('.').pop()).toLowerCase();
  if (!FILE_UPLOAD_LIMITS.ALLOWED_EXTENSIONS.includes(extension)) {
    errors.push({
      code: 'INVALID_EXTENSION',
      message: `ä¸æ”¯æ´çš„å‰¯æª”å`
    });
  }
  
  // 4. æª”åå®‰å…¨æª¢æŸ¥ï¼ˆé˜²æ­¢è·¯å¾‘éæ­·æ”»æ“Šï¼‰
  if (file.name.includes('..') || file.name.includes('/') || file.name.includes('\\')) {
    errors.push({
      code: 'INVALID_FILENAME',
      message: `æª”ååŒ…å«éæ³•å­—å…ƒ`
    });
  }
  
  // 5. é™„ä»¶æ•¸é‡æª¢æŸ¥
  const count = await db.prepare(`
    SELECT COUNT(*) as count FROM Attachments
    WHERE entity_type = ? AND entity_id = ? AND is_deleted = 0
  `).bind(entity_type, entity_id).first();
  
  const maxFiles = FILE_UPLOAD_LIMITS.MAX_FILES_PER_ENTITY[entity_type] || 10;
  if (count.count >= maxFiles) {
    errors.push({
      code: 'TOO_MANY_FILES',
      message: `å·²é”åˆ°é™„ä»¶æ•¸é‡ä¸Šé™ï¼ˆæœ€å¤š ${maxFiles} å€‹ï¼‰`
    });
  }
  
  return { valid: errors.length === 0, errors };
}
```

---

## ğŸ”Œ Cloudflare R2 æ•´åˆ

### è¨­å®š R2 Bucket

```toml
# wrangler.toml
[[r2_buckets]]
binding = "ATTACHMENTS_BUCKET"
bucket_name = "horgoscpa-attachments"
```

### ä¸Šå‚³ API

```typescript
// POST /api/v1/attachments/upload
async function uploadAttachment(request: Request, env: Env) {
  const formData = await request.formData();
  const file = formData.get('file') as File;
  const entityType = formData.get('entity_type') as string;
  const entityId = formData.get('entity_id') as string;
  
  // â­ é©—è­‰æª”æ¡ˆ
  const validation = await validateUploadFile(file, entityType, entityId);
  if (!validation.valid) {
    return {
      success: false,
      errors: validation.errors
    };
  }
  
  // ç”Ÿæˆå”¯ä¸€æª”å
  const fileExt = file.name.split('.').pop();
  const timestamp = Date.now();
  const randomStr = Math.random().toString(36).substring(2, 8);
  const fileName = `${entityType}/${entityId}/${timestamp}-${randomStr}.${fileExt}`;
  
  // ä¸Šå‚³åˆ° R2
  await env.ATTACHMENTS_BUCKET.put(fileName, file.stream(), {
    httpMetadata: {
      contentType: file.type
    }
  });
  
  // è¨˜éŒ„åˆ°è³‡æ–™åº«
  const result = await db.prepare(`
    INSERT INTO Attachments (
      entity_type, entity_id, file_name, file_path,
      file_size, mime_type, uploaded_by
    ) VALUES (?, ?, ?, ?, ?, ?, ?)
  `).bind(
    entityType, 
    entityId, 
    file.name, 
    fileName,
    file.size, 
    file.type, 
    user.user_id
  ).run();
  
  return { 
    success: true, 
    data: {
      attachment_id: result.meta.last_row_id,
      file_name: file.name,
      file_path: fileName,
      file_size: file.size
    }
  };
}
```

### ä¸‹è¼‰ API

```typescript
// GET /api/v1/attachments/:id/download
async function downloadAttachment(attachmentId: number, env: Env) {
  // æŸ¥è©¢é™„ä»¶è³‡è¨Š
  const attachment = await db.prepare(`
    SELECT * FROM Attachments WHERE attachment_id = ? AND is_deleted = 0
  `).bind(attachmentId).first();
  
  if (!attachment) {
    return new Response('é™„ä»¶ä¸å­˜åœ¨', { status: 404 });
  }
  
  // å¾ R2 ç²å–æª”æ¡ˆ
  const file = await env.ATTACHMENTS_BUCKET.get(attachment.file_path);
  
  if (!file) {
    return new Response('æª”æ¡ˆä¸å­˜åœ¨', { status: 404 });
  }
  
  return new Response(file.body, {
    headers: {
      'Content-Type': attachment.mime_type,
      'Content-Disposition': `attachment; filename="${encodeURIComponent(attachment.file_name)}"`,
      'Content-Length': attachment.file_size.toString()
    }
  });
}
```

### åˆªé™¤ API

```typescript
// DELETE /api/v1/attachments/:id
async function deleteAttachment(attachmentId: number, env: Env) {
  // æŸ¥è©¢é™„ä»¶è³‡è¨Š
  const attachment = await db.prepare(`
    SELECT * FROM Attachments WHERE attachment_id = ?
  `).bind(attachmentId).first();
  
  if (!attachment) {
    return { success: false, error: 'é™„ä»¶ä¸å­˜åœ¨' };
  }
  
  // å¾ R2 åˆªé™¤æª”æ¡ˆ
  await env.ATTACHMENTS_BUCKET.delete(attachment.file_path);
  
  // è»Ÿåˆªé™¤è³‡æ–™åº«è¨˜éŒ„
  await db.prepare(`
    UPDATE Attachments SET is_deleted = 1 WHERE attachment_id = ?
  `).bind(attachmentId).run();
  
  return { success: true };
}
```

---

## ğŸ”Œ API ç«¯é»

âš ï¸ **å°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆ** - å“¡å·¥ä¹Ÿå¯åˆªé™¤é™„ä»¶

```
POST   /api/v1/attachments/upload        æ¬Šé™ï¼šæ‰€æœ‰äºº
GET    /api/v1/attachments/:id           æ¬Šé™ï¼šæ‰€æœ‰äºº
GET    /api/v1/attachments/:id/download  æ¬Šé™ï¼šæ‰€æœ‰äºº
DELETE /api/v1/attachments/:id           æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
GET    /api/v1/attachments                æ¬Šé™ï¼šæ‰€æœ‰äºº
```

### API ç¯„ä¾‹

**ä¸Šå‚³é™„ä»¶ï¼š**
```typescript
// POST /api/v1/attachments/upload
// Content-Type: multipart/form-data

FormData:
- file: [File Object]
- entity_type: "client"
- entity_id: "12345678"

// å›æ‡‰
{
  "success": true,
  "data": {
    "attachment_id": 123,
    "file_name": "å…¬å¸ç™»è¨˜è­‰.pdf",
    "file_path": "client/12345678/1730123456-abc123.pdf",
    "file_size": 524288  // 512KB
  }
}
```

**æŸ¥è©¢é™„ä»¶åˆ—è¡¨ï¼š**
```typescript
// GET /api/v1/attachments?entity_type=client&entity_id=12345678

{
  "success": true,
  "data": [
    {
      "attachment_id": 123,
      "file_name": "å…¬å¸ç™»è¨˜è­‰.pdf",
      "file_size": 524288,
      "mime_type": "application/pdf",
      "uploaded_by": 1,
      "uploaded_at": "2025-10-28T10:30:00Z"
    },
    {
      "attachment_id": 124,
      "file_name": "ç‡Ÿæ¥­åŸ·ç…§.jpg",
      "file_size": 1048576,
      "mime_type": "image/jpeg",
      "uploaded_by": 1,
      "uploaded_at": "2025-10-28T11:00:00Z"
    }
  ]
}
```

---

## ğŸ¨ å‰ç«¯çµ„ä»¶

### AttachmentUploader.vue

```vue
<template>
  <div class="attachment-uploader">
    <div class="upload-area">
      <input
        type="file"
        ref="fileInput"
        @change="handleFileChange"
        multiple
        accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls,.docx,.doc"
        :disabled="isUploading"
      />
      
      <div class="upload-button">
        <StyledButton @click="$refs.fileInput.click()" :disabled="isUploading">
          <IconUpload /> é¸æ“‡æª”æ¡ˆ
        </StyledButton>
        <span class="hint">æ”¯æ´ï¼šPDF, JPG, PNG, XLSX, DOCXï¼ˆæœ€å¤§10MBï¼‰</span>
      </div>
    </div>
    
    <!-- é™„ä»¶åˆ—è¡¨ -->
    <div class="attachment-list">
      <div
        v-for="file in attachments"
        :key="file.attachment_id"
        class="attachment-item"
      >
        <div class="file-icon">
          <IconFile :type="getFileType(file.mime_type)" />
        </div>
        <div class="file-info">
          <span class="file-name">{{ file.file_name }}</span>
          <span class="file-size">{{ formatFileSize(file.file_size) }}</span>
        </div>
        <div class="file-actions">
          <StyledButton size="small" @click="downloadFile(file)">
            <IconDownload /> ä¸‹è¼‰
          </StyledButton>
          <StyledButton 
            size="small" 
            variant="danger" 
            @click="deleteFile(file)"
          >
            <IconDelete /> åˆªé™¤
          </StyledButton>
        </div>
      </div>
    </div>
    
    <!-- ä¸Šå‚³é€²åº¦ -->
    <div v-if="isUploading" class="upload-progress">
      <ProgressBar :value="uploadProgress" />
      <span>ä¸Šå‚³ä¸­... {{ uploadProgress }}%</span>
    </div>
  </div>
</template>

<script setup>
import { ref } from 'vue';

const props = defineProps({
  entityType: { type: String, required: true },
  entityId: { type: String, required: true }
});

const attachments = ref([]);
const isUploading = ref(false);
const uploadProgress = ref(0);

async function handleFileChange(event) {
  const files = Array.from(event.target.files);
  
  for (const file of files) {
    await uploadFile(file);
  }
  
  // æ¸…ç©º input
  event.target.value = '';
}

async function uploadFile(file) {
  isUploading.value = true;
  
  try {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('entity_type', props.entityType);
    formData.append('entity_id', props.entityId);
    
    const response = await fetch('/api/v1/attachments/upload', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      attachments.value.push(result.data);
    } else {
      alert('ä¸Šå‚³å¤±æ•—ï¼š' + result.errors.map(e => e.message).join(', '));
    }
  } catch (error) {
    alert('ä¸Šå‚³å¤±æ•—ï¼š' + error.message);
  } finally {
    isUploading.value = false;
  }
}

async function downloadFile(file) {
  window.open(`/api/v1/attachments/${file.attachment_id}/download`, '_blank');
}

async function deleteFile(file) {
  if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${file.file_name}ã€å—ï¼Ÿ`)) return;
  
  const response = await fetch(`/api/v1/attachments/${file.attachment_id}`, {
    method: 'DELETE'
  });
  
  const result = await response.json();
  
  if (result.success) {
    attachments.value = attachments.value.filter(
      f => f.attachment_id !== file.attachment_id
    );
  }
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function getFileType(mimeType) {
  if (mimeType.includes('pdf')) return 'pdf';
  if (mimeType.includes('image')) return 'image';
  if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'excel';
  if (mimeType.includes('word') || mimeType.includes('document')) return 'word';
  return 'file';
}
</script>
```

---

## ğŸ”’ å®‰å…¨æ€§è€ƒé‡

### 1. æª”æ¡ˆé¡å‹é©—è­‰

- âœ… æª¢æŸ¥ MIME Type
- âœ… æª¢æŸ¥å‰¯æª”å
- âœ… é›™é‡é©—è­‰é˜²æ­¢å½é€ 

### 2. æª”æ¡ˆå¤§å°é™åˆ¶

- âœ… å‰ç«¯é©—è­‰ï¼ˆææ—©é˜»æ­¢ï¼‰
- âœ… å¾Œç«¯é©—è­‰ï¼ˆé˜²æ­¢ç¹éï¼‰
- âœ… é™åˆ¶ 10MB é˜²æ­¢æ¿«ç”¨

### 3. æª”åå®‰å…¨

- âœ… éæ¿¾è·¯å¾‘éæ­·å­—å…ƒï¼ˆ`..`, `/`, `\`ï¼‰
- âœ… ä½¿ç”¨æ™‚é–“æˆ³ + éš¨æ©Ÿå­—ä¸²é‡æ–°å‘½å
- âœ… ä¸‹è¼‰æ™‚ä½¿ç”¨åŸå§‹æª”å

### 4. å­˜å–æ¬Šé™

- âœ… ä¸Šå‚³éœ€ç™»å…¥
- âœ… ä¸‹è¼‰æª¢æŸ¥æ¬Šé™ï¼ˆåŒå…¬å¸/åŒåœ˜éšŠï¼‰
- âœ… åˆªé™¤æª¢æŸ¥æ¬Šé™ï¼ˆä¸Šå‚³è€…æˆ–ç®¡ç†å“¡ï¼‰

### 5. å„²å­˜å®‰å…¨

- âœ… ä½¿ç”¨ Cloudflare R2ï¼ˆè‡ªå‹•å‚™ä»½ï¼‰
- âœ… è»Ÿåˆªé™¤ï¼ˆå¯æ¢å¾©ï¼‰
- âœ… å®šæœŸæ¸…ç†å·²åˆªé™¤æª”æ¡ˆ

---

## âš ï¸ æ³¨æ„äº‹é …

1. **æª”æ¡ˆå¤§å°**ï¼šå–®æª”æœ€å¤§ 10MB
2. **æª”æ¡ˆé¡å‹**ï¼šåƒ…æ”¯æ´ PDF, JPG, PNG, XLSX, DOCX
3. **æ•¸é‡é™åˆ¶**ï¼š
   - å®¢æˆ¶ï¼š20å€‹
   - ç™¼ç¥¨ï¼š5å€‹
   - SOPï¼š10å€‹
   - ä»»å‹™ï¼š10å€‹
4. **å‘½åè¦å‰‡**ï¼šè‡ªå‹•ç”Ÿæˆå”¯ä¸€æª”åï¼Œé¿å…è¡çª

---

## ğŸ“Š å„²å­˜çµæ§‹

### R2 Bucket ç›®éŒ„çµæ§‹

```
horgoscpa-attachments/
â”œâ”€â”€ client/
â”‚   â”œâ”€â”€ 12345678/
â”‚   â”‚   â”œâ”€â”€ 1730123456-abc123.pdf
â”‚   â”‚   â””â”€â”€ 1730124567-def456.jpg
â”‚   â””â”€â”€ 87654321/
â”‚       â””â”€â”€ 1730125678-ghi789.pdf
â”œâ”€â”€ invoice/
â”‚   â”œâ”€â”€ 202510-001/
â”‚   â”‚   â””â”€â”€ 1730126789-jkl012.pdf
â”‚   â””â”€â”€ 202510-002/
â”‚       â””â”€â”€ 1730127890-mno345.pdf
â”œâ”€â”€ sop/
â”‚   â””â”€â”€ 1/
â”‚       â”œâ”€â”€ 1730128901-pqr678.docx
â”‚       â””â”€â”€ 1730129012-stu901.xlsx
â””â”€â”€ task/
    â””â”€â”€ 42/
        â””â”€â”€ 1730130123-vwx234.pdf
```

---

**ç›¸é—œæ–‡æª”ï¼š**
- [å®¢æˆ¶ç®¡ç†-å®Œæ•´è¦æ ¼](./å®¢æˆ¶ç®¡ç†-å®Œæ•´è¦æ ¼.md)
- [ç™¼ç¥¨æ”¶æ¬¾-å®Œæ•´è¦æ ¼](./ç™¼ç¥¨æ”¶æ¬¾-å®Œæ•´è¦æ ¼.md)
- [çŸ¥è­˜ç®¡ç†-å®Œæ•´è¦æ ¼](./çŸ¥è­˜ç®¡ç†-å®Œæ•´è¦æ ¼.md)
- [ä»»å‹™ç®¡ç†-å®Œæ•´è¦æ ¼](./ä»»å‹™ç®¡ç†-å®Œæ•´è¦æ ¼.md)

