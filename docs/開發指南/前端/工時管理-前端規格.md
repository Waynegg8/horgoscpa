## 工時管理－前端規格

對應使用手冊：`docs/使用手冊/功能模組-03-工時管理.md`

**對應文件：** 使用手冊《功能模組-03-工時管理》《場景-02-員工填寫日常工時》

**範圍：** 僅涵蓋 UI/UX、畫面顯示邏輯與前端驗證；不含資料庫、API 與後端計算細節。

---

## 角色與權限（UI 行為）

- **員工**：
  - 新增/編輯/刪除「自己的」工時。
  - 僅可檢視自己的工時與統計。
  - 不能檢視或編輯他人工時。
- **管理員**：
  - 可切換/篩選查看所有員工工時與統計。
  - 預設不提供代填/代編輯操作（UI 禁用或隱藏新增/編輯/刪除）。

---

## 導覽與入口

- **儀表板快速入口**：
  - 按鈕「填寫今日工時」→ 導至工時填寫頁，預選今日日期。
  - 導覽後保留返回儀表板的明確返回控制（如麵包屑或返回按鈕）。

---

## 頁面與元件

### 1) 工時填寫頁（試算表模式）

- **整體設計**：類似 Excel 的表格介面，橫向為日期（週一至週日），縱向為客戶/業務/工時類型組合
  
- **結構**：
  - 週切換器（上一週/下一週 + 目前週期顯示，例如「2025年11月4日 - 11月10日」）
  - 試算表主體：
    - **固定左側欄**（凍結，捲動時保持可見）：
      1. 客戶名稱欄
      2. 業務類型欄（記帳、稅務申報等）
      3. 工時類型欄（正常工時、平日加班前2h等）
    - **日期欄位**（7欄）：週一至週日，顯示日期與徽章
      - **國定假日**：顯示「國定」徽章（紅色背景），從 `GET /api/v1/holidays` 取得
      - **例假日**（通常週日）：顯示「例假」徽章（黃色背景）
      - **休息日**（通常週六）：顯示「休息」徽章（黃色背景）
      - **補班日**：顯示「補班」徽章（藍色背景）
      - 當天日期：背景高亮
  - **週彙總區塊**：本週總工時、加班工時、加權工時（表格底部）
    - **本週總工時**：所有儲存格數字加總
    - **本週加班工時**：`isOvertime=true` 的工時類型加總
    - **本週加權工時**：每筆工時 × 對應費率倍數加總
  - **統一儲存按鈕**：批量儲存本週所有未儲存的修改（推薦使用）

- **列（Row）結構**：
  - 每列包含三個下拉選單欄位 + 7個日期儲存格
  - **客戶欄（下拉選單）**：
    - 顯示所有可用客戶清單（從 `GET /api/v1/clients` 取得）
    - 支援 API 返回的欄位格式：`clientId`/`client_id`，`companyName`/`company_name`
    - 支援搜尋過濾
    - 必須先選擇客戶才能填寫工時
  - **業務類型欄（下拉選單）**：
    - 顯示業務選項（記帳服務、稅務申報等）
    - 選項來自系統設定或客戶服務項目
  - **工時類型欄（下拉選單）**：
    - **顯示所有選項**（不預先篩選）
    - 員工可自由選擇任何工時類型
    - **智能提示**：當儲存時，如選擇的工時類型不適用該日期，顯示友善錯誤訊息
    - 例：週六選擇「正常工時」→ 提示「休息日不可使用『正常工時』，請選擇『休息日加班』類型」
  - 預設狀態：系統根據用戶過去一個月常用組合，自動建立 3-5 列
  - 可手動新增列（點擊「新增列」按鈕，新增空白列）

### 2) 儲存格互動

- **點擊編輯**：
  - 點擊任何儲存格進入編輯模式
  - 顯示輸入框，預填已有數值（如有）
  - 支援數字鍵盤輸入

- **輸入限制**：
  - 只接受數字與小數點
  - 自動驗證 0.5 的倍數（0.5, 1, 1.5, 2...）
  - 最大值 12（或特定類型的 8）
  - 輸入非法值時紅框提示

- **儲存行為**：
  - 按 Enter：儲存並跳到下一行（同一欄）
  - 按 Tab：儲存並跳到右邊儲存格
  - 按方向鍵：儲存並跳到對應方向
  - 點擊其他儲存格：儲存當前並編輯新儲存格
  - 失焦（blur）：自動儲存

- **視覺反饋**：
  - 編輯中：藍色邊框
  - 儲存中：顯示載入動畫
  - 儲存成功：綠色閃爍提示
  - 儲存失敗：紅色邊框 + 錯誤提示

### 3) 儲存格顯示

- **空白狀態**：顯示淡灰色底色，可點擊輸入
- **已填寫**：顯示數字，字體居中，粗體
- **背景顏色**：
  - 週末（六日）：淡灰色背景
  - 國定假日：淡紅色背景
  - 當天：淡藍色高亮
- **備註圖示**：如有備註，顯示小圖示（懸停顯示內容）
- **錯誤狀態**：紅色邊框 + 錯誤圖示

### 4) 列管理

- **新增列按鈕**（表格上方，「+ 新增列」）：
  - 點擊後在表格底部新增一列空白列
  - 新列的三個下拉選單皆顯示「請選擇...」提示
  - 所有日期儲存格皆為空白，但需先選擇客戶才能輸入

- **刪除列**：
  - 每列最左側顯示「×」刪除圖示（預設隱藏，懸停時顯示）
  - 點擊需二次確認：「刪除此列將清除本週該組合的所有工時，確定刪除？」
  - 確認後：
    - 刪除該列在當週的所有工時記錄（呼叫 DELETE API）
    - 從表格移除該列
  - 如該列所有儲存格皆為空，直接刪除不需確認

- **列排序**：
  - 預設按客戶名稱字母順序排列
  - 同一客戶的列會群組在一起
  - 用戶可手動拖曳列來調整順序（拖曳手把顯示在列號前）

###5) 彙總與指標區塊

- **位置**：表格右側或底部固定區域
- **顯示內容**：
  - 本週總工時（所有儲存格加總）
  - 本週加班工時
  - 本週加權工時
  - 各日合計（每欄底部顯示當日總計）
- **即時更新**：儲存格變更後自動重新計算

### 6) 管理員檢視（僅檢視）

- 追加篩選器：員工下拉選單、日期區間選擇
- 試算表呈現該員工的工時記錄
- 所有儲存格禁用編輯（唯讀模式）
- 顯示「唯讀模式」提示

---

## 動態顯示與邏輯

### 日期徽章與提示

- 國定假日/例假日/補班日由系統資料決定，前端據此顯示徽章與工具提示：
  - 補班日提示：「今日為補班日（視為平日）」。
  - 國定假日提示：「今日為國定假日」；例假日提示：「今日為例假日」。

### 工作類型下拉選單的動態篩選

- 一般工作日（非假日、非補班）：顯示「正常工時」與「平日加班（前2小時/後2小時）」。
- 休息日（通常週六）：顯示各「休息日加班」選項（前2小時/第3-8/第9-12）。
- 補班日：僅顯示「正常工時」與「平日加班（前/後2小時）」，隱藏所有「休息日加班」。
- 國定假日：顯示「國定假日」相關選項（8小時內、第9-10、第11-12）；非國定假日日期隱藏該組選項。
- 例假日：顯示「例假日」相關選項（8小時內、第9-12）；非例假日日期隱藏該組選項。

### 工時欄位的動態限制

- 選「國定假日（8小時內）」或「例假日（8小時內）」時，工時輸入的最大值動態限制為 8。超過即顯示錯誤並回退至 8。
- 其他類型最大值為 12（仍受「單日總工時上限」約束）。

### 單日總工時上限

- 同一用戶同一日期下，所有記錄合計不得超過 12 小時。
- 新增/編輯時，需即時計算「已存在記錄合計 + 當前輸入值」是否超標，超過即阻止儲存並提示。

---

## 前端驗證規則（僅列 UI 規則）

- 必填：日期、客戶、服務、工作類型、工時。
- 工時數值：
  - 僅允許 0.5 的倍數（例：0.5、1.0、1.5）。
  - 範圍 0.5–12（含）；8 小時內類型的最大值 8。
  - 輸入非 0.5 倍數時，自動四捨五入至最接近的 0.5，並提示已自動修正。
- 工作類型 X 日期條件：
  - 補班日不可選「休息日加班」。
  - 非國定假日不可選國定假日類型；非例假日不可選例假日類型。
- 單日總工時 ≤ 12：若超過，阻止儲存並顯示錯誤。

---

## 提示與錯誤訊息（文案）

- 儲存成功：
  - 「已儲存工時。」
- 刪除確認：
  - 「確定要刪除此筆工時嗎？刪除後將無法復原。」
- 欄位驗證：
  - 「請選擇日期。」/「請選擇客戶。」/「請選擇服務。」/「請選擇工作類型。」/「請輸入工時。」
  - 「工時必須是 0.5 的倍數。」
  - 「每日工時合計不可超過 12 小時。」
  - 「『8 小時內』類型的工時不可超過 8 小時。」
  - 「補班日不可選『休息日加班』。」
- 自動修正提示：
  - 「已自動將工時修正為最接近的 0.5 倍數。」

---

## 無障礙（a11y）與國際化（i18n）

- 欄位具備可見標籤與 aria-* 屬性；表單錯誤以文字提示且關聯到欄位。
- 下拉選單可鍵盤操作；儲存/取消可使用 Enter/Esc。
- 所有提示文字可國際化；時間/日期/數字遵循使用者在地化設定。

---

## 邊界情境與 UI 行為

- 當日已有多筆記錄時，新增行預設沿用上一筆的「客戶/服務/工作類型」。
- 變更日期後，工作類型清單即時重新篩選；若原選項於新日期不適用，需清除並提示。
- 網路錯誤：保留使用者輸入於暫存區，提供重試；失敗時不清空表單。

---

## 性能與互動

- 客戶/服務下拉需支援快速搜尋與虛擬清單（避免大型清單卡頓）。
- 週切換保留使用者已輸入但未儲存的內容，切換前提示是否離開/儲存。


