## 工時管理－前端規格

對應使用手冊：`docs/使用手冊/功能模組-03-工時管理.md`

**對應文件：** 使用手冊《功能模組-03-工時管理》《場景-02-員工填寫日常工時》

**範圍：** 僅涵蓋 UI/UX、畫面顯示邏輯與前端驗證；不含資料庫、API 與後端計算細節。

---

## 角色與權限（UI 行為）

- **員工**：
  - 新增/編輯/刪除「自己的」工時。
  - 僅可檢視自己的工時與統計。
  - 不能檢視或編輯他人工時。
- **管理員**：
  - 可切換/篩選查看所有員工工時與統計。
  - 預設不提供代填/代編輯操作（UI 禁用或隱藏新增/編輯/刪除）。

---

## 導覽與入口

- **儀表板快速入口**：
  - 按鈕「填寫今日工時」→ 導至工時填寫頁，預選今日日期。
  - 導覽後保留返回儀表板的明確返回控制（如麵包屑或返回按鈕）。

---

## 頁面與元件

### 1) 工時填寫頁（試算表模式）

- **整體設計**：類似 Excel 的完整動態表格介面，橫向為日期（週一至週日），縱向為客戶/業務/工時類型組合
  
- **結構**：
  - **週導航區**（頁面頂部，三欄水平佈局）：
    - 左側：週導航按鈕（上一週 / 本週 / 下一週）
    - 中央：週期顯示（例如「2025年11月4日 - 11月10日」）
    - 右側：操作按鈕（+ 新增列 / 儲存所有變更）
  - **試算表主體**：
    - **固定左側欄**（使用 `position: sticky`，橫向捲動時保持可見）：
      1. 客戶名稱欄（下拉選單，寬度 200px）
      2. 服務項目欄（下拉選單，寬度 150px，第一層，根據選擇的客戶動態載入）
         - 先選擇客戶後才會載入對應的服務項目
         - 調用 `GET /api/v1/clients/:clientId/services` 取得該客戶的服務
         - 如未選擇客戶，顯示「請先選擇客戶...」
         - 例如：記帳服務、稅務申報、顧問諮詢
      3. 服務子項目欄（下拉選單，寬度 150px，第二層，根據選擇的服務項目動態載入）
         - 先選擇服務項目後才會載入對應的子項目
         - 調用 `GET /api/v1/clients/:clientId/services/:serviceId/items` 取得子項目
         - 如未選擇服務項目，顯示「請先選擇服務項目...」
         - 例如：收集憑證、輸入帳務、月結對帳、報表產製
      4. 工時類型欄（下拉選單，寬度 150px）
    - **日期欄位**（7欄，每欄 80px）：週一至週日，顯示日期與徽章
      - **國定假日**：顯示「國定」徽章（紅色背景 `#ffebee`），從 `GET /api/v1/holidays` 取得
        - **優先級最高**：即使是週末，只要是國定假日就顯示「國定」而非「休息」/「例假」
      - **例假日**（通常週日）：顯示「例假」徽章（黃色背景 `#fff3cd`）
      - **休息日**（通常週六）：顯示「休息」徽章（黃色背景 `#fff3cd`）
      - **補班日**：顯示「補班」徽章（藍色背景 `#e3f2fd`）
    - **操作欄**（最右側，80px）：刪除按鈕（×）
  - **表尾區塊**（`<tfoot>`）：
    - **請假記錄行**（第一行）：
      - 顯示每日請假資訊（從 `GET /api/v1/leaves` 取得）
      - 格式：「假別 Xh」（例如：「特休 2h」）
      - 背景色：淡藍 `#e7f3ff`
    - **工時完整性行**（第二行）：
      - 顯示每日工時完整性檢查結果
      - 僅檢查工作日和補班日（週末和假日顯示空白）
      - 格式：「✓ 完整」/ 「⚠ 缺Xh」 / 「✗ 缺Xh」
      - 背景色依狀態變化（綠/黃/紅）
  - **工時統計區塊**（表格下方獨立區塊，兩列佈局）：
    - **第一列：本週統計**（4欄水平佈局）
      - **本週總工時**：本週所有儲存格數字加總
      - **本週加班工時**：本週 `isOvertime=true` 的工時類型加總
      - **本週加權工時**：本週每筆工時 × 對應費率倍數加總
      - **本週請假時數**：本週已批准的請假時數加總（從 `state.leaves` 計算）
    - **第二列：本月統計**（4欄水平佈局）
      - **本月總工時**：當月所有工時加總（調用 API）
      - **本月加班工時**：當月所有加班工時加總（調用 API）
      - **本月加權工時**：當月所有加權工時加總（調用 API）
      - **本月請假時數**：當月已批准的請假時數加總（調用 API）
    - **更新時機**：
      - 本週統計：輸入工時後即時計算
      - 本月統計：切換週時調用 API 更新

- **技術特性**：
  - 完整動態載入，連動客戶管理、假期管理、國定假日系統
  - 即時驗證與儲存，防止無效輸入
  - 競態條件防護（使用 `isLoading` 旗標防止重複點擊）
  - 模組化代碼結構（清晰的數據流和函數職責）

### 2) 儲存格互動

- **點擊編輯**：
  - 點擊任何儲存格直接輸入（`<input type="number">`）
  - 預填已有數值（如有）
  - 支援數字鍵盤輸入（`step="0.5" min="0" max="12"`）

- **即時驗證**（輸入時觸發）：
  - **數值驗證**：
    - 只接受 0.5 的倍數（0.5, 1, 1.5, 2...）
    - 自動四捨五入至最接近的 0.5
  - **工時類型與日期相容性驗證**：
    - 檢查選擇的工時類型是否適用該日期
    - 例如：週六選擇「正常工時」並輸入 → 立即清空並提示「休息日不可使用『正常工時』」
    - 例如：國定假日選擇「平日加班」並輸入 → 立即清空並提示
  - **時數限制驗證**：
    - 各工時類型有最大時數限制（`maxHours`）
    - 例如：「平日加班（前2小時）」最多只能填 2
    - 超過時提示：「平日加班（前2小時）最多只能填 2 小時」
  - **前置要求驗證**：
    - 某些工時類型需要先填寫前置類型（`requiresTypes`）
    - 例如：填「平日加班（後2小時）」前必須先有「平日加班（前2小時）」
    - 未滿足時提示：「請先填寫前置加班類型」

- **儲存行為**：
  - **即時儲存**：失焦（blur）時自動調用 `saveCell()`
  - **批量儲存**：點擊「儲存所有變更」按鈕批量儲存
    - 變更會先記錄在 `state.pending` Map 中
    - 按鈕顯示待儲存數量（例如：「儲存所有變更 (3)」）
  - **儲存策略**：
    - 如已存在相同組合的記錄，執行 UPDATE（後端自動處理）
    - 否則執行 INSERT

- **視覺反饋**：
  - **編輯中**：藍色外框高亮（`.editing` class）
  - **已填值**：綠色背景（`.has-value` class）
  - **週末**：黃色背景（`.weekend` class）
  - **國定假日**：紅色背景（`.holiday` class）
  - **儲存成功**：顯示 Toast 提示「已儲存」（綠色）
  - **儲存失敗**：顯示 Toast 提示錯誤訊息（紅色）

### 3) 儲存格顯示

- **空白狀態**：顯示淡灰色底色，可點擊輸入
- **已填寫**：顯示數字，字體居中，粗體
- **背景顏色**：
  - 週末（六日）：淡灰色背景
  - 國定假日：淡紅色背景
  - 當天：淡藍色高亮
- **備註圖示**：如有備註，顯示小圖示（懸停顯示內容）
- **錯誤狀態**：紅色邊框 + 錯誤圖示

### 4) 列管理

- **新增列按鈕**（右上角「+ 新增列」）：
  - 點擊後在表格底部新增一列空白列
  - 新列的三個下拉選單皆顯示「請選擇...」
  - 所有日期儲存格皆為空白
  - 需先選擇客戶、業務類型、工時類型後才能輸入工時

- **刪除列**：
  - 每列最右側顯示「×」刪除按鈕（紅色）
  - 點擊需二次確認：「刪除此列將清除本週該組合的所有工時，確定刪除？」
  - 確認後：
    - 調用 `DELETE /api/v1/timelogs/batch` 批量刪除該組合的所有記錄
    - 從表格移除該列
    - 重新載入工時資料並渲染
  - 如該列所有儲存格皆為空（無任何工時），直接刪除不需確認

- **列排序**：
  - 按照載入順序顯示（由後端返回順序決定）
  - 同一客戶/業務/工時類型組合合併為一列

###5) 彙總與指標區塊

- **位置**：表格下方獨立區塊（兩列，每列四欄）
- **第一列：本週統計**
  - **本週總工時**：本週所有儲存格數字加總（單位：小時）
  - **本週加班工時**：本週所有 `isOvertime=true` 的工時類型加總
  - **本週加權工時**：本週每筆工時 × 對應費率倍數的總和
    - 計算公式：`Σ (hours × multiplier)`
    - 例如：8h × 1.0 + 2h × 1.34 = 10.68
  - **本週請假時數**：本週已批准的請假時數加總
    - 從 `state.leaves` Map 計算
    - 只計算當週7天的請假
- **第二列：本月統計**
  - **本月總工時**：當月所有工時加總（不限於當前顯示週）
  - **本月加班工時**：當月所有加班工時加總
  - **本月加權工時**：當月所有加權工時加總
  - **本月請假時數**：當月已批准的請假時數加總
  - **資料來源**：調用 `GET /api/v1/timelogs/summary?month={YYYY-MM}` 取得
- **即時更新**：
  - 本週統計：在 `renderTable()` 結束時調用 `updateWeeklySummary()`，儲存格變更後自動重新計算
  - 本月統計：在 `loadWeek()` 時調用 `loadMonthlySummary()`
  - 顯示一位小數（例如：「10.5」）

### 6) 管理員檢視（僅檢視）

- 追加篩選器：員工下拉選單、日期區間選擇
- 試算表呈現該員工的工時記錄
- 所有儲存格禁用編輯（唯讀模式）
- 顯示「唯讀模式」提示

---

## 動態顯示與邏輯

### 日期徽章優先級（重要）

國定假日優先級最高，顯示邏輯如下：
1. **第一優先**：國定假日（`is_national_holiday=true`）→ 顯示「國定」紅色徽章
   - 即使該日是週六或週日，仍顯示「國定」而非「休息」/「例假」
2. **第二優先**：補班日（`is_makeup_workday=true`）→ 顯示「補班」藍色徽章
3. **第三優先**：週日（`dayOfWeek === 0`）→ 顯示「例假」黃色徽章
4. **第四優先**：週六（`dayOfWeek === 6`）→ 顯示「休息」黃色徽章
5. **預設**：一般工作日 → 無徽章

### 工作類型不預先篩選（重要）

- **顯示所有 11 種工時類型**：下拉選單不做預先篩選
- **輸入時即時驗證**：用戶選擇類型並輸入工時時，立即檢查該類型是否適用該日期
  - 不適用 → 立即清空輸入並顯示 Toast 錯誤提示
  - 適用 → 允許輸入並記錄待儲存
- **優點**：
  - 用戶可以看到所有工時類型（學習與參考）
  - 即時反饋阻止無效輸入（體驗更好）
  - 避免「預先篩選邏輯複雜且易出錯」的問題

### 工時類型適用規則（`allowedOn`）

每種工時類型定義 `allowedOn` 陣列，指明適用的日期類型：
- **正常工時**：`['workday', 'makeup']`（工作日、補班日）
- **平日加班**：`['workday', 'makeup']`
- **休息日加班**：`['restday']`（休息日，通常週六）
- **國定假日加班**：`['national_holiday']`
- **例假日加班**：`['weekly_restday']`（例假日，通常週日）

### 工時類型時數限制（`maxHours`）

- **平日加班（前2小時）**：`maxHours: 2`
- **平日加班（後2小時）**：`maxHours: 2`
- **休息日加班（前2小時）**：`maxHours: 2`
- **休息日加班（第3-8小時）**：`maxHours: 6`
- **休息日加班（第9-12小時）**：`maxHours: 4`
- **國定假日加班（8小時內）**：`maxHours: 8`
- **國定假日加班（第9-10小時）**：`maxHours: 2`
- **國定假日加班（第11-12小時）**：`maxHours: 2`
- **例假日加班（8小時內）**：`maxHours: 8`
- **例假日加班（第9-12小時）**：`maxHours: 4`

### 工時類型前置要求（`requiresTypes`）

- **平日加班（後2小時）**：`requiresTypes: [2]`（需先有「平日加班（前2小時）」）
- **休息日加班（第3-8小時）**：`requiresTypes: [4]`
- **休息日加班（第9-12小時）**：`requiresTypes: [4, 5]`
- **國定假日加班（第9-10小時）**：`requiresTypes: [7]`
- **國定假日加班（第11-12小時）**：`requiresTypes: [7, 8]`
- **例假日加班（第9-12小時）**：`requiresTypes: [10]`

### 單日總工時上限

- 同一日期所有工時合計不得超過 12 小時
- 前端不做檢查（由後端驗證）

---

## 前端驗證規則

### 必填檢查
- 必填：客戶（`client_id`）、服務項目（`service_id`）、服務子項目（`service_item_id`）、工時類型（`work_type_id`）
- 依序檢查：
  - 如未選擇客戶，阻止選擇服務項目，提示：「請先選擇客戶」
  - 如未選擇服務項目，阻止選擇服務子項目，提示：「請先選擇服務項目」
  - 如未完整選擇所有必填欄位，阻止輸入工時並提示：「請先選擇客戶、服務項目、服務子項目與工時類型」

### 工時數值驗證
- **0.5 的倍數**：只接受 0.5, 1.0, 1.5, 2.0...
  - 實現：`Math.round(hours * 2) / 2`
  - 如誤差超過 0.01，提示：「工時必須為0.5的倍數」
- **範圍限制**：0.5–12（視工時類型而定）
  - 各工時類型有 `maxHours` 限制
  - 超過時提示：「{工時類型名稱}最多只能填 {maxHours} 小時」

### 工時類型與日期相容性
- 檢查邏輯：`getAvailableWorkTypes(date)` 返回該日期適用的工時類型
- 不適用時立即清空並提示：「該日期不可使用此工時類型」
- 例如：
  - 週六選「正常工時」→ 提示「休息日不可使用『正常工時』」
  - 週日選「平日加班」→ 提示「例假日不可使用『平日加班（前2小時）』」

### 前置要求檢查
- 檢查邏輯：檢查 `requiresTypes` 是否滿足
- 未滿足時提示：「請先填寫前置加班類型」
- 例如：
  - 填「平日加班（後2小時）」前必須先有「平日加班（前2小時）」

---

## 提示與錯誤訊息（文案）

- **儲存成功**：「已儲存」（綠色 Toast）
- **刪除確認**：「刪除此列將清除本週該組合的所有工時，確定刪除？」
- **刪除成功**：「已刪除列」（綠色 Toast）
- **必填驗證**：「請先選擇客戶、業務類型與工時類型」
- **數值驗證**：
  - 「工時必須為0.5的倍數」
  - 「{工時類型名稱}最多只能填 {maxHours} 小時」
- **日期相容性**：「該日期不可使用此工時類型」
- **前置要求**：「請先填寫前置加班類型」
- **連線錯誤**：「無法連接伺服器」（紅色 Toast）
- **儲存失敗**：後端返回的錯誤訊息（紅色 Toast）

---

## 資料載入流程

### 初始化（`init()`）
1. 載入基礎資料：`loadClients()`（客戶列表）
2. 載入本週資料：`loadWeek()`

### 週資料載入（`loadWeek()`）
```javascript
async function loadWeek() {
  const token = ++state.token; // 防止競態
  state.ready = false;
  
  // 1. 載入假日和請假資料（並行）
  await Promise.all([loadHolidays(), loadLeaves()]);
  if (token !== state.token) return; // 取消過期請求
  
  // 2. 建立週模型和更新週標題
  buildWeekDays();
  renderWeekHeader();
  if (token !== state.token) return;
  
  // 3. 載入工時資料
  await loadTimesheets();
  if (token !== state.token) return;
  
  // 4. 渲染表格
  state.ready = true;
  renderTable();
  requestAnimationFrame(() => {
    renderLeaveRow();
    renderCompleteness();
  });
}
```

### 週導航（上一週/下一週/本週）
```javascript
document.getElementById('btnPrevWeek').addEventListener('click', async () => {
  if (isLoading) return; // 防止重複點擊
  isLoading = true;
  resetWeekView(); // 清空狀態
  state.currentWeekStart.setDate(state.currentWeekStart.getDate() - 7);
  await loadWeek();
  isLoading = false;
});
```

### API 調用
- **客戶列表**：`GET /api/v1/clients?perPage=100`
- **客戶服務項目**：`GET /api/v1/clients/:clientId/services`
- **服務子項目**：`GET /api/v1/clients/:clientId/services/:serviceId/items`
- **假日資料**：`GET /api/v1/holidays?start_date={start}&end_date={end}`
- **請假資料**：`GET /api/v1/leaves?dateFrom={start}&dateTo={end}&status=approved`
- **工時資料**：`GET /api/v1/timelogs?start_date={start}&end_date={end}`
- **週統計**：前端即時計算
- **月統計**：`GET /api/v1/timelogs/summary?month={YYYY-MM}`（返回當月總工時、加班、加權、請假時數）
- **儲存工時**：`POST /api/v1/timelogs`（自動 UPSERT）
- **刪除列**：`DELETE /api/v1/timelogs/batch`

---

## 狀態管理

### 全域狀態（`state` 物件）
```javascript
const state = {
  currentWeekStart: Date,      // 當前週的週一日期
  clients: Array,               // 客戶列表
  clientServices: Map,          // Map<client_id, Array<service>>（各客戶的服務項目）
  serviceItems: Map,            // Map<`${client_id}_${service_id}`, Array<item>>（各服務的子項目）
  workTypes: Array,             // 工時類型列表（硬編碼，含 maxHours, requiresTypes, allowedOn）
  holidays: Map,                // Map<iso, {is_national_holiday, is_makeup_workday, is_weekly_restday}>
  leaves: Map,                  // Map<iso, {hours, types:[{type, hours}]}>
  rows: Array,                  // [{client_id, service_id, service_item_id, work_type_id, hours:[h0..h6]}]
  pending: Map,                 // Map<`${rowIdx}_${dayIdx}`, {rowIndex, dayIndex, value}>
  weekDateTypes: Map,           // Map<iso, type>
  weekDays: Array,              // [{index, iso, dow, type, mustWork}]
  dailyNormalHours: Map,        // Map<iso, hours>（正常工時，用於完整性檢查）
  monthlySummary: Object,       // {totalHours, overtimeHours, weightedHours, leaveHours}（本月統計）
  token: Number,                // 防止競態條件
  ready: Boolean                // 資料是否載入完成
};
```

### 競態條件防護
- **週導航**：使用 `isLoading` 旗標防止重複點擊
- **資料載入**：使用 `state.token` 防止舊請求覆蓋新資料
- **渲染順序**：確保假日和請假資料載入完成後再渲染完整性檢查

---

## 性能優化

- **客戶下拉**：一次性載入 100 筆（`perPage=100`），前端不做分頁
- **假日和請假資料並行載入**：使用 `Promise.all()`
- **延遲渲染**：請假記錄和完整性檢查使用 `requestAnimationFrame()` 延後渲染
- **即時計算**：週彙總在 `renderTable()` 結束時自動調用，無需額外監聽


