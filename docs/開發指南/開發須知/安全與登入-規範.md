### 安全與登入規範（認證、授權、會話、前端整合）

本規範定義登入頁與 API、密碼儲存、會話管理、CSRF、授權與安全標頭，並說明前端如何整合與保護頁面。

### 認證模式
- **主要模式**：伺服器維護會話，透過 `HttpOnly; Secure; SameSite=Lax` 的 `session` Cookie 鑑別
- **API 用戶端（選用）**：允許 `Authorization: Bearer <token>`，但瀏覽器以 Cookie 為準

### 登入頁（`login.html`）
- 欄位：Email + Password；表單驗證明確，錯誤訊息為繁體中文
- 成功：設定 `session` Cookie，導向首頁或原始目的頁
- 失敗：通用錯誤訊息（避免透露帳號存在與否）
- 安全：限制連續嘗試（前端冷卻），鍵盤可用性良好

### 認證端點
- `POST /api/v1/auth/login`
  - 入參：`email`, `password`
  - 行為：驗證、建立會話、回應使用者摘要，設定 `Set-Cookie: session=...`
- `POST /api/v1/auth/logout`
  - 行為：刪除會話（D1）並清除 Cookie
- `GET /api/v1/auth/me`
  - 行為：回傳目前使用者資訊與角色；未登入回 401

### 密碼儲存
- 優先採 **Argon2id**（WASM 實作），不可用時以 **PBKDF2-SHA256** ≥ 310,000 次迭代（WebCrypto）
- 每位使用者獨立隨機 Salt；儲存格式建議：`algo$iterations$salt$hash`
- 禁止明碼或可逆加密；重設密碼以一次性 Token + 期限控制

### 會話管理（D1）
- 表：`sessions(id TEXT PK, user_id TEXT, created_at TEXT, expires_at TEXT, meta_json TEXT)`
- TTL：預設 30 天；敏感操作可短時延長或二次驗證
- 輪替：登入成功後、敏感操作前後皆可輪替 Session ID（防固定攻擊）
- 失效：登出/密碼變更/角色變更時，標記既有會話失效

### CSRF 與 CORS
- SameSite=Lax 可減少 CSRF 風險
- 對需狀態變更的表單/請求：採雙重提交 Token 或自定 CSRF 標頭
- CORS 僅允許受信來源；禁止 `*` 搭配憑證

### 授權（RBAC）
- 角色：`admin`、`manager`、`staff`、`viewer`
- 檢查點：
  - 端點層級（API 路由）
  - 資源層級（同一端點對不同資源不同權限）
- 政策：最小權限、只授權必要行為

### 安全標頭與設定
- `Content-Security-Policy`：限制來源（`default-src 'self'`，依需求允許 R2 網域等）
- `X-Frame-Options: DENY`（或必要時使用 `SAMEORIGIN`）
- `X-Content-Type-Options: nosniff`
- `Referrer-Policy: no-referrer-when-downgrade`（可依需求收斂）

### 錯誤處理與日誌
- 回應錯誤訊息簡短，不暴露內部細節
- 日誌不可包含密碼/Token/敏感個資；保留 `requestId`、`userId`、`path`、`status`
- 登入嘗試與異常活動需標記與警示（Rate Limit）

### 前端整合指引
- 受保護頁面在載入時呼叫 `GET /api/v1/auth/me`：
  - 200：渲染內容
  - 401：導向 `login.html`（可附 redirect 參數）
- 導覽列可依角色顯示/隱藏功能入口（僅 UI；權限以後端為準）
- 表單送出時附 CSRF Token（若採雙重提交策略）

### 風險控管
- 登入/上傳等敏感端點實施速率限制與冷卻
- 重要設定以 Secret 管理，不進入版本庫
- 定期審視會話未使用/過期清理策略


