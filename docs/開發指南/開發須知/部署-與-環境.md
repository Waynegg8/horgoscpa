### 部署與環境（Cloudflare Pages / Workers / Wrangler）

本文件說明環境切分、變數與綁定、遷移流程、部署與回滾，以及本機開發方法。

### 環境切分
- 分支策略：
  - `main`：穩定分支，合併即部署到 Production
  - `feature/*`：功能開發分支，開 PR 並於 Preview 環境驗證
- Pages Deployments：
  - Preview：PR 自動產生預覽網址
  - Production：合併至 `main` 觸發正式部署，可一鍵回滾

### Cloudflare 綁定（Bindings）
- D1：`DATABASE`（範例名稱），對應資料庫實例
- R2：`R2_BUCKET_ATTACHMENTS`、`R2_BUCKET_PUBLIC`（依實際命名）
- 環境變數：
  - `APP_ENV=dev|staging|prod`
  - `SESSION_COOKIE_NAME=session`
  - `SESSION_TTL_SECONDS=2592000`（30 天）
  - 其他機密以 `wrangler secret` 管控（不得入庫）

### 遷移（D1 Migrations）
- 目錄：`migrations/`
- 命名：`YYYY-MM-DDThhmmssZ_<action>_<object>.sql`
- 部署時序：
  1) 先套用遷移至目標環境
  2) 再釋出新程式碼
- 範例命令：
```bash
wrangler d1 migrations apply <DATABASE_BINDING> --remote
```

### Pages Functions / Workers 結構
- Pages Functions 目錄：`functions/`（例如：`functions/api/v1/clients.ts`）
- 單一 Worker 專案：`src/index.ts`（依專案需要擇一）
- API 必採 `/api/v1/...` 路徑規範，回應格式依《API-設計規範》

### 部署流程（自動化）
1) 程式碼合併前：完成自我測試、更新文件、審查安全影響
2) 於 CI/CD：
   - 安裝 wrangler
   - 套用 D1 遷移
   - 發佈 Pages / Worker
3) 發佈後：
   - 健康檢查（API 探測、首頁載入）
   - 重要頁面快取預熱（如有）
   - 監控日誌與錯誤告警

### 回滾策略
- 使用 Cloudflare Deployments 一鍵回滾至上一個成功版本
- Schema 變更需具備前後相容或提供回滾遷移

### 本機開發（Windows PowerShell 範例）
```powershell
# 頁面與函式本機預覽
wrangler pages dev .

# 單一 Workers 專案
wrangler dev
```

### 監控與日誌
- 以 `console` 日誌結構化輸出（JSON），包含 `requestId`、`userId`、`path`、`status`
- 針對 4xx/5xx 保留必要上下文（勿記錄敏感資訊）


