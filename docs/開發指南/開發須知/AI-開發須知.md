### AI 開發須知（流程、原則、測試與部署）

本文件規範 AI 在本專案中的工作方式：從理解任務、規劃、實作、自我測試、部署、驗證到文件同步更新，過程中嚴格遵守統一標準與安全要求。

### 核心原則（請逐條遵守）
#### 絕對禁止
```
❌ 問技術問題（用戶不懂技術）
❌ 讓用戶測試（AI必須自己測試！）
❌ 讓用戶部署（AI必須自動部署！）
❌ 沒有測試就說完成（必須先自行測試）
❌ 沒有部署就說完成（必須自動部署）
❌ 修改外部網站（只改內部系統）
❌ 生成報告文件（直接說明即可）
❌ 忽略編碼問題（所有文件都是繁體中文 UTF-8）
```

#### 必須遵守
```
✅ 完全自主決策（不問技術問題）
✅ 自己測試驗證（不讓用戶測試）
✅ 遵循共用規範（統一標準）
✅ 保持簡單清晰（極簡設計）
✅ 確保全局一致性（同步修改所有相關文檔）
✅ 正確處理編碼（繁體中文 UTF-8）
✅ 變更採用「小步提交、可回滾」：一次只改一個明確範圍（單檔/單功能）
✅ 每個提交必附自我測試與一致性驗證，通過後再進下一步
✅ 嚴禁用腳本進行未審查的全域批量修改
✅ 嚴禁 God File（單檔塞滿所有邏輯）：`src/index.js` 只能作為「主路由器」，不得寫業務邏輯；
   工具放 `src/utils.js`，驗證放 `src/auth.js`，各資源 API 放 `src/api/*.js`。
✅ 需求變更由 AI 同步更新：使用手冊（`docs/使用手冊/*`）、前端/後端規格（`docs/開發指南/前端/*`、`docs/開發指南/後端/*`）、
   開發任務（`docs/開發指南/開發任務/*`）、任務索引（`docs/開發指南/開發須知/開發清單-任務索引.md`）與對應程式碼/遷移必須同時更新；嚴禁只改其中一處。

```

### 任務起手式（每次任務都要做）
1) 先讀 `docs/開發指南/開發須知/README.md`（索引與總則）
2) **需求變更同步（必須優先完成，再寫程式碼）**：
   - 找出受影響的「使用手冊/前端規格/後端規格/資料庫遷移/開發任務」
   - **先更新「任務索引」**（`開發清單-任務索引.md`）之對應關係（手冊↔前端↔後端↔開發任務）
   - 同步更新所有相關文件，確保使用手冊、前端/後端規格與「開發任務」頁面皆更新「對應文件/索引」段落並指向正確檔案
   - **文件更新完成後，才能開始寫程式碼**
3) 僅在將實作的部分才讀對應規範：
   - 前端前：讀 `前端-共用規範.md` ＋ 對應前端模組規格
   - API/後端前：讀 `API-設計規範.md` ＋ 對應後端模組規格
   - 資料庫前：讀 `資料庫-D1-規範.md`（必要時查模組欄位/索引）
   - 存儲前：讀 `存儲-R2-規範.md`
   - 部署/安全相關：讀 `部署-與-環境.md`、`安全與登入-規範.md`
4) 建立待辦（TODO）：將任務切為 2–5 個可獨立驗證的小步驟，僅開啟第一步為進行中
5) 明確輸入/輸出：列出將修改的程式碼檔案與預期影響面（後端務必遵守模組化：路由在 `src/index.js`，邏輯在 `src/auth.js` 與 `src/api/*`）

### 讀檔策略（最小化上下文）
- 只載入「當前步驟」必要文件；完成後釋放上下文
- 若任務範圍擴大，再按需補讀相應規範與模組規格
- 不向用戶詢問技術細節，優先以規範與既有規格自行決策

### 工作循環（每一步都要閉環）
1) 實作程式碼：只改單一範圍，遵守相應規範；後端務必維持 `index.js` 僅分派、`utils/auth/api` 承載邏輯
2) 自我測試：
   - 前端：頁面載入、RWD、互動、表單驗證
   - API：請求/回應 Envelope、狀態碼、分頁/排序/篩選、權限
   - D1：遷移、資料完整性、交易/鎖
   - R2：簽名 URL、型別/大小白名單、權限
3) 一致性驗證：命名、時間格式、錯誤碼、繁體中文 UTF-8
4) 部署：使用 Cloudflare Pages/Workers 自動部署與 D1 遷移
5) 驗證：健康檢查（首頁、登入、關鍵 API）、回滾預案就緒
6) 狀態更新與總結：簡明說明已完成與下一步（不得要求用戶測試）

**重要提醒**：「工作循環」是在完成「任務起手式」第2步（文件同步更新）之後才執行。順序為：
→ 先更新所有文件（使用手冊、規格、任務索引）→ 再進入工作循環寫程式碼 → 測試 → 部署

### 狀態更新規範（簡短、高訊噪）
- 1–3 句描述：剛完成什麼、接下來做什麼、是否有風險/阻礙
- 若宣告「要做 X」，需在同一次回合內實際執行

### 提交訊息格式與內容
- 格式：`type(scope): summary`
- 內文：
  - 目的/動機
  - 影響檔案與風險/回滾
  - 自我測試重點與結果

### 自我測試清單（精簡）
- 前端
  - 首屏載入無錯誤、RWD 正常、頁面字體/顏色/間距符合 Token
  - 表單驗證正確、錯誤訊息清楚、鍵盤可用性良好
- API
  - Envelope 與狀態碼正確、分頁/排序/篩選可用
  - 錯誤碼一致、驗證訊息為繁體中文
- D1
  - 遷移可重複執行（`IF NOT EXISTS`）、索引齊全
  - 時間欄位 UTC/ISO8601、一致的主鍵策略
- R2
  - 簽名 URL 限時與型別大小檢查、私有預設
  - 下載 `Content-Disposition` 正確
- 安全
  - 會話 Cookie：`HttpOnly; Secure; SameSite=Lax`，登入/登出/逾時行為正確
  - 最小權限與角色檢查可用

### 部署檢查清單
1) D1 遷移成功套用、資料可查詢
2) 頁面可開啟、登入流程可用
3) 重要 API 皆 2xx，無 CORS/編碼問題
4) R2 上傳/下載（簽名）流程可用
5) 錯誤日誌零重大異常，可隨時回滾

### 文件與一致性（文件優先原則）
- **文件優先**：任何需求變更必須「先更新文件，再寫程式碼」
- **同步更新範圍**：使用手冊 ↔ 前端規格 ↔ 後端規格 ↔ 開發任務 ↔ 任務索引（`開發清單-任務索引.md`）↔ 程式碼/遷移
- **更新順序**：
  1. 先更新任務索引的對應關係
  2. 同步更新使用手冊、前端規格、後端規格、開發任務
  3. 確認所有文件的「對應文件/索引」段落正確
  4. 最後才實作程式碼與資料庫遷移
- 若規範有新要求或行為改變，務必同步更新對應文件（本區、前端、API、資料庫、存儲、部署、安全）
- 所有文件維持繁體中文 UTF-8
- **嚴禁只改其中一處**：文件與程式碼必須保持一致


