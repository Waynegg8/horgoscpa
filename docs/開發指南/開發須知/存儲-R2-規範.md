### 存儲規範（Cloudflare R2）

本規範定義 Bucket/路徑結構、權限與簽名、檔案中繼資料、生命週期與大小限制，以及安全控管。

### Bucket 與路徑
- Bucket 命名：`attachments-<env>`（私有，附件/內部檔）；`public-<env>`（公開靜態資產）
- 物件路徑：`<visibility>/<env>/<module>/<entityId>/<fileId>.<ext>`
  - 例：`private/prod/attachments/client_01JB.../f_01H8...pdf`
  - `module`：`attachments|invoices|reports|images|...`
  - `entityId`：對應 D1 資源（如客戶/任務/收據）

### 權限策略
- 預設私有：下載需**簽名 URL**或透過 API 轉送（權限檢查）
- 公開資產（如官網圖片）才放 `public-<env>`，並設定快取策略
- 產生簽名 URL 的 API 須驗證使用者角色與資源可見性

### 中繼資料（Metadata）
- 必填：`contentType`、`contentLength`、`ownerId`、`module`、`entityId`
- 選填：`originalFilename`、`description`、`tags`

### 檔案大小與型別
- 型別白名單（範例）：PDF、JPEG/PNG/WebP、CSV、TXT；禁止可執行檔
- 大小限制（範例）：單檔 ≤ 20 MB（可依需求調整）

### 生命週期
- 非必要檔案可設定自動刪除（如臨時上傳 24 小時）
- 長期保存檔案應定期檢視占用與合規

### 簽名 URL（上傳/下載）
- 由後端（Workers）生成，限制：存活時間（如 5 分鐘）、Content-Type、Content-Length、HTTP 方法
- 回應需提供：`uploadUrl`/`downloadUrl` 與 `objectKey`

### 範例回應（上傳簽名）
```json
{
  "ok": true,
  "code": "OK",
  "message": "成功",
  "data": {
    "uploadUrl": "https://...",
    "objectKey": "private/prod/attachments/client_01JB.../f_01...pdf",
    "headers": {
      "Content-Type": "application/pdf"
    }
  },
  "meta": { "requestId": "req_..." }
}
```

### 安全與稽核
- 產生簽名前必須檢查：權限、檔案型別/大小、配額
- 記錄存取稽核（誰在何時存取/下載了何檔案）
- 下載時可附 `Content-Disposition` 以正確檔名


