# ç³»çµ±é€²éšåŠŸèƒ½

**çµ¦ AIï¼š** APIç‰ˆæœ¬ç®¡ç†ã€æ¸¬è©¦ã€æ—¥å¿—ã€æ€§èƒ½å„ªåŒ–ã€ç¼“å­˜ç­–ç•¥çš„å®Œæ•´èªªæ˜

---

## ğŸ“¦ API ç‰ˆæœ¬æ¼”é€²ç­–ç•¥

### ç‰ˆæœ¬å‘½åè¦ç¯„

```
/api/v1/*  - ç¬¬ä¸€ç‰ˆ API
/api/v2/*  - ç¬¬äºŒç‰ˆ APIï¼ˆé‡å¤§æ›´æ–°ï¼‰

ç‰ˆæœ¬è™Ÿè¦å‰‡ï¼š
- ä¸»ç‰ˆæœ¬è™Ÿï¼ˆv1, v2ï¼‰- ä¸å…¼å®¹çš„è®Šæ›´
- æ¬¡ç‰ˆæœ¬è™Ÿåœ¨ API è·¯å¾‘ä¸­ä¸é«”ç¾ï¼ˆå‘å¾Œå…¼å®¹çš„æ–°åŠŸèƒ½ï¼‰
```

### ç‰ˆæœ¬å‡ç´šç­–ç•¥

```typescript
// 1. æ–°ç‰ˆæœ¬èˆ‡èˆŠç‰ˆæœ¬ä¸¦è¡Œé‹è¡Œ
app.get('/api/v1/clients', v1ClientsHandler);
app.get('/api/v2/clients', v2ClientsHandler);

// 2. åœ¨éŸ¿æ‡‰é ­ä¸­æ¨™ç¤ºç‰ˆæœ¬
c.header('X-API-Version', 'v1');
c.header('X-API-Deprecated', 'This API version will be deprecated on 2026-01-01');

// 3. ç‰ˆæœ¬åˆ¤æ–·ä¸­é–“ä»¶
async function apiVersionMiddleware(c, next) {
  const requestedVersion = c.req.path.split('/')[2];  // å¾ /api/v1/ æå– v1
  
  if (requestedVersion === 'v1' && new Date() > new Date('2026-01-01')) {
    return c.json({
      success: false,
      error: {
        code: 'VERSION_DEPRECATED',
        message: 'API v1 å·²åœæ­¢æœå‹™ï¼Œè«‹å‡ç´šè‡³ v2'
      }
    }, 410);
  }
  
  await next();
}
```

### å‘å¾Œå…¼å®¹æ€§ä¿è­‰

```typescript
// æ–°å¢å­—æ®µï¼ˆå‘å¾Œå…¼å®¹ï¼‰âœ…
// v1 å›æ‡‰
{
  "client_id": "123",
  "company_name": "æ¸¬è©¦å…¬å¸"
}

// v2 å›æ‡‰ï¼ˆæ–°å¢å­—æ®µï¼‰
{
  "client_id": "123",
  "company_name": "æ¸¬è©¦å…¬å¸",
  "industry": "æœƒè¨ˆæœå‹™",  // æ–°å­—æ®µ
  "rating": "A"            // æ–°å­—æ®µ
}

// å­—æ®µé‡å‘½åï¼ˆä¸å…¼å®¹ï¼‰âŒ â†’ éœ€è¦æ–°ç‰ˆæœ¬
// v1: { "company_name": "..." }
// v2: { "name": "..." }  // éœ€è¦å‡ç´šåˆ° v2
```

### æ£„ç”¨é€šçŸ¥æ©Ÿåˆ¶

```typescript
// 1. æå‰ 6 å€‹æœˆé€šçŸ¥
const deprecationDate = new Date('2026-01-01');
const now = new Date();

if (now > deprecationDate.setMonth(deprecationDate.getMonth() - 6)) {
  c.header('Warning', '299 - "API v1 will be deprecated on 2026-01-01"');
}

// 2. æ—¥èªŒè¨˜éŒ„ä½¿ç”¨æƒ…æ³
logger.info('Deprecated API called', {
  version: 'v1',
  endpoint: '/api/v1/clients',
  user_id: user.user_id,
  client_ip: c.req.header('CF-Connecting-IP')
});

// 3. ç™¼é€é€šçŸ¥çµ¦ç®¡ç†å“¡
if (deprecatedAPIUsageCount > 1000) {
  await sendAdminNotification({
    type: 'deprecated_api_usage',
    message: 'API v1 ä»æœ‰å¤§é‡ä½¿ç”¨ï¼Œéœ€åŠ é€Ÿé·ç§»'
  });
}
```

---

## ğŸ§ª å®Œæ•´æ¸¬è©¦é«”ç³»

### 1. å–®å…ƒæ¸¬è©¦ï¼ˆVitestï¼‰

```typescript
// tests/unit/services/ClientService.test.ts
import { describe, it, expect, beforeEach } from 'vitest';
import { ClientService } from '@/services/ClientService';

describe('ClientService', () => {
  let clientService: ClientService;
  let mockDb: any;
  
  beforeEach(() => {
    mockDb = {
      prepare: vi.fn(),
      // ... mock DB
    };
    clientService = new ClientService(mockDb);
  });
  
  it('æ‡‰è©²æ­£ç¢ºéæ¿¾å“¡å·¥æ¬Šé™', async () => {
    const user = { user_id: 1, is_admin: false };
    const filters = {};
    
    const result = await clientService.getClients(filters, user);
    
    // é©—è­‰å“¡å·¥åªèƒ½çœ‹åˆ°è‡ªå·±çš„å®¢æˆ¶
    expect(mockDb.prepare).toHaveBeenCalledWith(
      expect.stringContaining('assignee_user_id = ?')
    );
  });
  
  it('æ‡‰è©²æ‹’çµ•å“¡å·¥æ–°å¢å…¶ä»–äººçš„å®¢æˆ¶', async () => {
    const user = { user_id: 1, is_admin: false };
    const data = { assignee_user_id: 2 };
    
    await expect(
      clientService.createClient(data, user)
    ).rejects.toThrow('æ¬Šé™ä¸è¶³');
  });
  
  it('æ‡‰è©²æ­£ç¢ºè¨ˆç®—è£œä¼‘æ™‚æ•¸ï¼ˆFIFOï¼‰', async () => {
    const availableLeaves = [
      { compe_leave_id: 1, hours_remaining: 4.0, earned_date: '2025-10-01' },
      { compe_leave_id: 2, hours_remaining: 8.0, earned_date: '2025-10-15' }
    ];
    
    const result = await useCompensatoryLeave(1, 6.0, '2025-10-28');
    
    // æ‡‰è©²å…ˆç”¨å®Œç¬¬ä¸€ç­†ï¼ˆ4å°æ™‚ï¼‰ï¼Œç„¶å¾Œç”¨ç¬¬äºŒç­†ï¼ˆ2å°æ™‚ï¼‰
    expect(result.used_compensatory_leaves).toHaveLength(2);
    expect(result.used_compensatory_leaves[0].hours_used).toBe(4.0);
    expect(result.used_compensatory_leaves[1].hours_used).toBe(2.0);
  });
});
```

### 2. API é›†æˆæ¸¬è©¦

```typescript
// tests/integration/api/clients.test.ts
import { describe, it, expect } from 'vitest';
import { app } from '@/index';

describe('GET /api/v1/clients', () => {
  it('æ‡‰è©²è¿”å› 401 ç•¶æœªç™»å…¥', async () => {
    const res = await app.request('/api/v1/clients');
    expect(res.status).toBe(401);
  });
  
  it('æ‡‰è©²è¿”å›å®¢æˆ¶åˆ—è¡¨ç•¶å·²ç™»å…¥', async () => {
    const token = await getTestToken({ user_id: 1, is_admin: true });
    
    const res = await app.request('/api/v1/clients', {
      headers: { 'Cookie': `token=${token}` }
    });
    
    expect(res.status).toBe(200);
    const data = await res.json();
    expect(data.success).toBe(true);
    expect(Array.isArray(data.data)).toBe(true);
  });
  
  it('æ‡‰è©²æ­£ç¢ºè™•ç† N+1 æŸ¥è©¢ï¼ˆä½¿ç”¨ JOINï¼‰', async () => {
    const queryCount = getQueryCount();
    
    const token = await getTestToken({ user_id: 1, is_admin: true });
    const res = await app.request('/api/v1/clients', {
      headers: { 'Cookie': `token=${token}` }
    });
    
    // æ‡‰è©²åªæœ‰ä¸€æ¬¡æŸ¥è©¢ï¼ˆJOIN å„ªåŒ–ï¼‰
    expect(getQueryCount() - queryCount).toBe(1);
  });
});
```

### 3. E2E æ¸¬è©¦ï¼ˆPlaywrightï¼‰

```typescript
// tests/e2e/client-management.spec.ts
import { test, expect } from '@playwright/test';

test.describe('å®¢æˆ¶ç®¡ç†æµç¨‹', () => {
  test.beforeEach(async ({ page }) => {
    // ç™»å…¥
    await page.goto('/login');
    await page.fill('[name="username"]', 'admin');
    await page.fill('[name="password"]', 'password');
    await page.click('[data-test="login-button"]');
    await page.waitForURL('/dashboard');
  });
  
  test('æ‡‰è©²æˆåŠŸæ–°å¢å®¢æˆ¶', async ({ page }) => {
    // é€²å…¥å®¢æˆ¶ç®¡ç†é é¢
    await page.goto('/clients');
    
    // é»æ“Šæ–°å¢æŒ‰éˆ•
    await page.click('[data-test="add-client"]');
    
    // å¡«å¯«è¡¨å–®
    await page.fill('[name="client_id"]', '12345678');
    await page.fill('[name="company_name"]', 'æ¸¬è©¦å…¬å¸ E2E');
    await page.selectOption('[name="assignee_user_id"]', '1');
    
    // æäº¤
    await page.click('[data-test="submit"]');
    
    // é©—è­‰æˆåŠŸæç¤º
    await expect(page.locator('.toast.success')).toBeVisible();
    await expect(page.locator('.toast.success')).toContainText('æ–°å¢æˆåŠŸ');
    
    // é©—è­‰åˆ—è¡¨ä¸­å‡ºç¾æ–°å®¢æˆ¶
    await expect(page.locator('.client-list')).toContainText('æ¸¬è©¦å…¬å¸ E2E');
  });
  
  test('æ‡‰è©²é¡¯ç¤ºåŠ è¼‰ç‹€æ…‹', async ({ page }) => {
    await page.goto('/clients');
    
    // æ‡‰è©²çœ‹åˆ°åŠ è¼‰æŒ‡ç¤ºå™¨
    const loader = page.locator('[data-test="loading-spinner"]');
    await expect(loader).toBeVisible();
    
    // åŠ è¼‰å®Œæˆå¾Œæ¶ˆå¤±
    await expect(loader).not.toBeVisible();
  });
  
  test('æ‡‰è©²æ­£ç¢ºé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯', async ({ page }) => {
    await page.goto('/clients');
    await page.click('[data-test="add-client"]');
    
    // ä¸å¡«å¯«å¿…å¡«æ¬„ä½ç›´æ¥æäº¤
    await page.click('[data-test="submit"]');
    
    // æ‡‰è©²é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    const errorMessage = page.locator('[data-test="error-message"]');
    await expect(errorMessage).toBeVisible();
    await expect(errorMessage).toContainText('å…¬å¸åç¨±ç‚ºå¿…å¡«');
  });
});
```

### æ¸¬è©¦è¦†è“‹ç‡ç›®æ¨™

```
æ ¸å¿ƒæ¥­å‹™é‚è¼¯ï¼š   90%+
API ç«¯é»ï¼š       80%+
å‰ç«¯çµ„ä»¶ï¼š       70%+
æ•´é«”è¦†è“‹ç‡ï¼š     75%+
```

---

## ğŸ“‹ çµæ§‹åŒ–æ—¥èªŒç³»çµ±

### æ—¥èªŒç´šåˆ¥

```typescript
enum LogLevel {
  DEBUG = 'debug',
  INFO = 'info',
  WARN = 'warn',
  ERROR = 'error',
  FATAL = 'fatal'
}
```

### æ—¥èªŒæ ¼å¼

```typescript
interface LogEntry {
  timestamp: string;         // ISO 8601
  level: LogLevel;
  message: string;
  context?: {
    user_id?: number;
    client_id?: string;
    request_id?: string;
    ip_address?: string;
    user_agent?: string;
  };
  error?: {
    name: string;
    message: string;
    stack?: string;
  };
  metadata?: any;
}
```

### Logger å¯¦ç¾

```typescript
class Logger {
  private context: any = {};
  
  constructor(defaultContext = {}) {
    this.context = defaultContext;
  }
  
  private log(level: LogLevel, message: string, metadata?: any) {
    const entry: LogEntry = {
      timestamp: new Date().toISOString(),
      level,
      message,
      context: this.context,
      metadata
    };
    
    console.log(JSON.stringify(entry));
    
    // ç™¼é€åˆ°æ—¥èªŒæœå‹™ï¼ˆCloudflare Logpushã€Sentryç­‰ï¼‰
    if (level === 'error' || level === 'fatal') {
      this.sendToErrorTracking(entry);
    }
  }
  
  debug(message: string, metadata?: any) {
    this.log(LogLevel.DEBUG, message, metadata);
  }
  
  info(message: string, metadata?: any) {
    this.log(LogLevel.INFO, message, metadata);
  }
  
  warn(message: string, metadata?: any) {
    this.log(LogLevel.WARN, message, metadata);
  }
  
  error(message: string, error?: Error, metadata?: any) {
    this.log(LogLevel.ERROR, message, {
      ...metadata,
      error: error ? {
        name: error.name,
        message: error.message,
        stack: error.stack
      } : undefined
    });
  }
  
  fatal(message: string, error?: Error, metadata?: any) {
    this.log(LogLevel.FATAL, message, {
      ...metadata,
      error: error ? {
        name: error.name,
        message: error.message,
        stack: error.stack
      } : undefined
    });
  }
  
  private async sendToErrorTracking(entry: LogEntry) {
    // ç™¼é€åˆ° Sentry
    if (typeof Sentry !== 'undefined') {
      Sentry.captureException(new Error(entry.message), {
        level: entry.level as any,
        contexts: {
          custom: entry.context
        }
      });
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const logger = new Logger({ service: 'timesheet-api' });

logger.info('Client created', {
  client_id: '12345678',
  company_name: 'æ¸¬è©¦å…¬å¸',
  duration_ms: 150
});

logger.error('Database query failed', error, {
  query: 'SELECT * FROM Clients',
  params: ['12345678']
});
```

### æ…¢æŸ¥è©¢ç›£æ§

```typescript
async function queryWithLogging(sql: string, params: any[]) {
  const startTime = Date.now();
  
  try {
    const result = await db.prepare(sql).bind(...params).all();
    const duration = Date.now() - startTime;
    
    if (duration > 1000) {
      logger.warn('Slow query detected', {
        sql,
        params,
        duration_ms: duration
      });
    }
    
    return result;
  } catch (error) {
    logger.error('Query failed', error, { sql, params });
    throw error;
  }
}
```

---

## âš¡ å¤šå±¤ç·©å­˜ç­–ç•¥

### 1. CDN ç·©å­˜ï¼ˆCloudflareï¼‰

```typescript
// éœæ…‹è³‡æºç·©å­˜
app.get('/assets/*', (c) => {
  c.header('Cache-Control', 'public, max-age=31536000, immutable');
  return c.file(path);
});

// API éŸ¿æ‡‰ç·©å­˜ï¼ˆä¸å¸¸è®Šçš„æ•¸æ“šï¼‰
app.get('/api/v1/leave-types', async (c) => {
  c.header('Cache-Control', 'public, max-age=3600');  // 1å°æ™‚
  return c.json(await getLeaveTypes());
});
```

### 2. Workers KV ç·©å­˜

```typescript
class CacheService {
  constructor(private kv: KVNamespace) {}
  
  async get<T>(key: string): Promise<T | null> {
    const cached = await this.kv.get(key, 'json');
    if (cached) {
      logger.debug('Cache hit', { key });
      return cached as T;
    }
    logger.debug('Cache miss', { key });
    return null;
  }
  
  async set<T>(key: string, value: T, expirationTtl?: number) {
    await this.kv.put(key, JSON.stringify(value), { expirationTtl });
    logger.debug('Cache set', { key, ttl: expirationTtl });
  }
  
  async delete(key: string) {
    await this.kv.delete(key);
    logger.debug('Cache deleted', { key });
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const cache = new CacheService(env.CACHE_KV);

async function getLeaveBalance(userId: number) {
  const cacheKey = `leave_balance:${userId}`;
  
  // å˜—è©¦å¾ç·©å­˜ç²å–
  let balance = await cache.get<any>(cacheKey);
  
  if (!balance) {
    // ç·©å­˜æœªå‘½ä¸­ï¼Œå¾æ•¸æ“šåº«æŸ¥è©¢
    balance = await calculateLeaveBalance(userId);
    
    // å¯«å…¥ç·©å­˜ï¼ˆ1å°æ™‚éæœŸï¼‰
    await cache.set(cacheKey, balance, 3600);
  }
  
  return balance;
}
```

### 3. ç·©å­˜å¤±æ•ˆç­–ç•¥

```typescript
// æ•¸æ“šæ›´æ–°æ™‚æ¸…é™¤ç·©å­˜
async function updateClient(clientId: string, data: any) {
  await db.prepare(`UPDATE Clients SET ... WHERE client_id = ?`).bind(clientId).run();
  
  // æ¸…é™¤ç›¸é—œç·©å­˜
  await cache.delete(`client:${clientId}`);
  await cache.delete(`clients:list:*`);  // æ¸…é™¤æ‰€æœ‰åˆ—è¡¨ç·©å­˜
}

// æ™‚é–“å¤±æ•ˆï¼ˆTTLï¼‰
await cache.set('data', value, 3600);  // 1å°æ™‚å¾Œè‡ªå‹•éæœŸ

// ä¸»å‹•å¤±æ•ˆ
async function clearAllClientCaches() {
  const keys = await getAllCacheKeys('client:*');
  for (const key of keys) {
    await cache.delete(key);
  }
}
```

---

## ğŸš€ å‰ç«¯æ€§èƒ½å„ªåŒ–

### 1. ä»£ç¢¼åˆ†å‰²

```javascript
// vite.config.js
export default {
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor': ['vue', 'vue-router'],
          'ui': ['tailwindcss'],
          'charts': ['echarts'],
        }
      }
    }
  }
}

// è·¯ç”±æ‡¶åŠ è¼‰
const routes = [
  {
    path: '/clients',
    component: () => import('./pages/ClientsPage.vue')
  }
];
```

### 2. è™›æ“¬æ»¾å‹•

```vue
<template>
  <virtual-scroller
    :items="clients"
    :item-height="60"
    class="client-list"
  >
    <template #default="{ item }">
      <ClientRow :client="item" />
    </template>
  </virtual-scroller>
</template>
```

### 3. åœ–ç‰‡å„ªåŒ–

```html
<!-- æ‡¶åŠ è¼‰ -->
<img loading="lazy" src="..." />

<!-- éŸ¿æ‡‰å¼åœ–ç‰‡ -->
<img 
  srcset="image-320w.jpg 320w, image-640w.jpg 640w, image-1280w.jpg 1280w"
  sizes="(max-width: 640px) 100vw, 50vw"
  src="image-640w.jpg"
/>
```

---

**é€™å€‹æ–‡æª”æ¶µè“‹äº†ç³»çµ±çš„é€²éšåŠŸèƒ½è¨­è¨ˆã€‚**

