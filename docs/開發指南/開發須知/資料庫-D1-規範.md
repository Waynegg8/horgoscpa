### 資料庫規範（Cloudflare D1 / SQLite）

本規範定義命名、時間與鍵、Schema 設計、遷移（Migrations）、索引與參照、查詢風格與資料保護。

### 命名與一般約定
- 表與欄位使用 `snake_case`（例如：`users`, `password_hash`）
- 主鍵使用 `TEXT` 類型，值採 **ULID** 或 **UUIDv7**（由應用層產生），欄位名 `id`
- 時間欄位：`created_at`、`updated_at`（ISO 8601 UTC，字串 TEXT）
- 軟刪除（可選）：`deleted_at`（NULL 表示未刪除）
- 表使用 `STRICT` 模式，避免隱式型別

### 範例 Schema（使用者與會話）
```sql
-- users
CREATE TABLE IF NOT EXISTS users (
  id TEXT PRIMARY KEY,
  email TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  role TEXT NOT NULL CHECK (role IN ('admin','manager','staff','viewer')),
  created_at TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ','now')),
  updated_at TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ','now')),
  deleted_at TEXT
) STRICT;

CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);

CREATE TRIGGER IF NOT EXISTS trg_users_updated_at
AFTER UPDATE ON users FOR EACH ROW
BEGIN
  UPDATE users SET updated_at = strftime('%Y-%m-%dT%H:%M:%fZ','now') WHERE id = NEW.id;
END;

-- sessions（以會話 Cookie 驗證）
CREATE TABLE IF NOT EXISTS sessions (
  id TEXT PRIMARY KEY, -- 隨機不可預測 ID
  user_id TEXT NOT NULL,
  created_at TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ','now')),
  expires_at TEXT NOT NULL,
  meta_json TEXT, -- UA/IP 等
  FOREIGN KEY(user_id) REFERENCES users(id)
) STRICT;

CREATE INDEX IF NOT EXISTS idx_sessions_user ON sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_sessions_expires ON sessions(expires_at);
```

### 外鍵與索引
- 外鍵一律明確宣告，並為查詢條件加上索引。
- 索引命名：`idx_<table>_<columns>`；唯一索引命名：`uniq_<table>_<columns>`。

### 遷移（Migrations）
- 目錄：`migrations/`
- 檔名：`YYYY-MM-DDThhmmssZ_<action>_<object>.sql`（例如：`2025-10-30T090000Z_create_users.sql`）
- 內容需具備 **可重複執行**（`IF NOT EXISTS`）與 **回滾指引**（於檔案註解說明）
- 部署流程於《部署-與-環境》說明，使用 wrangler 套用遷移

### 查詢與交易
- 一律使用參數化查詢，禁止字串拼接產生 SQL 注入風險
- 重要寫入操作需以交易包裹；同資源更新採樂觀鎖或條件更新

### 時間與時區
- 一律以 UTC 儲存（`strftime('%Y-%m-%dT%H:%M:%fZ','now')`）
- 前端顯示時再進行當地時區轉換

### 金額與小數
- 金額以最小貨幣單位整數儲存（如分），避免浮點計算誤差

### 範例：客戶資料表
```sql
CREATE TABLE IF NOT EXISTS clients (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'active',
  created_at TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ','now')),
  updated_at TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%fZ','now'))
) STRICT;

CREATE INDEX IF NOT EXISTS idx_clients_status ON clients(status);
```

### 匯入/匯出與備援
- 禁止在生產環境手動執行未審查 SQL；所有結構變更透過遷移
- 以 Cloudflare 提供工具進行備援/匯出（如可用），並於部署前後記錄版本與校驗


