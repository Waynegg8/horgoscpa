# 如何開發

**給 AI：** 開發任何功能的標準流程

---

## 🚨 第一步：完成開始前檢查清單（必須！）

**收到用戶需求後，立即閱讀：**

→ **[開始前檢查清單.md](./開始前檢查清單.md)**

**這個清單會指導你：**
1. ✅ 確認編碼設定（繁體中文 UTF-8）
2. ✅ 理解用戶需求
3. ✅ 閱讀對應的完整規格
4. ✅ 列出需要修改的文檔
5. ✅ 準備驗證命令
6. ✅ 最終確認

**完成清單後才開始開發！**

---

## 🚀 第二步：開發流程

### 1. 閱讀對應的完整規格（已在檢查清單中完成）

```
用戶說："開發客戶管理功能"
  ↓
AI 閱讀：開發指南/客戶管理-完整規格.md
  ↓
理解：資料表、API、前端組件、業務邏輯
  ↓
準備開始實現
```

### 2. 確保編碼正確（已在檢查清單中確認）

```
⚠️ 所有文件都是繁體中文 UTF-8
- 讀取：使用 UTF-8 編碼
- 寫入：使用 UTF-8 編碼
- PowerShell：UTF-8 with BOM
```

### 2.5. PowerShell 命令語法限制（重要！）

```
🚨 絕對不能使用 && 操作符！

❌ 錯誤：
npm install && npm run build

✅ 正確：
npm install; if ($LASTEXITCODE -eq 0) { npm run build }
或
npm install; npm run build
```

**原因：** PowerShell 不支持 `&&` 操作符，會導致命令執行失敗！

### 3. 按順序實現

⚠️ **重要提醒：開發完成後必須自行測試，絕不讓用戶測試！**

#### 步驟1：創建資料表
```sql
-- 根據規格文檔中的 CREATE TABLE
-- 複製貼上即可
```

#### 步驟2：實現後端
```
1. Repository 層（資料存取）
2. Service 層（業務邏輯）
3. Route 層（API 端點）
```

#### 步驟3：實現前端
```
1. API Service（調用後端）
2. Page 組件（頁面）
3. 子組件（表單、列表等）
```

#### 步驟4：測試
```
1. 測試 API 端點
2. 測試權限控制
3. 測試前端功能
```

---

## 📁 項目結構

### 後端（Cloudflare Workers）
```
timesheet-api/
├── src/
│   ├── routes/
│   │   ├── clients.ts
│   │   ├── timelogs.ts
│   │   ├── leave.ts
│   │   └── index.ts
│   ├── services/
│   │   ├── ClientService.ts
│   │   ├── TimeLogService.ts
│   │   └── LeaveService.ts
│   ├── repositories/
│   │   ├── ClientRepository.ts
│   │   ├── TimeLogRepository.ts
│   │   └── LeaveRepository.ts
│   ├── middleware/
│   │   ├── auth.ts
│   │   └── error.ts
│   └── index.ts
├── wrangler.toml
└── schema.sql
```

### 前端（Vue.js）
```
src/
├── pages/
│   ├── ClientsPage.vue
│   ├── TimesheetPage.vue
│   ├── LeavePage.vue
│   └── DashboardPage.vue
├── components/
│   ├── shared/
│   │   ├── StyledButton.vue
│   │   ├── StyledInput.vue
│   │   └── Modal.vue
│   └── clients/
│       ├── ClientList.vue
│       └── ClientForm.vue
├── api/
│   ├── clients.js
│   ├── timelogs.js
│   └── leave.js
├── router/
│   └── index.js
└── App.vue
```

---

## 🔧 實現規範

### 後端三層架構

#### Repository 層（資料存取）
```typescript
// 只負責 SQL 操作
class ClientRepository {
  async findAll(filters) {
    // 執行 SQL
  }
  async create(data) {
    // INSERT
  }
}
```

#### Service 層（業務邏輯）
```typescript
// 負責驗證、業務規則、權限
class ClientService {
  async getClients(filters, user) {
    // 權限過濾
    if (!user.is_admin) {
      filters.assignee_user_id = user.user_id;
    }
    return await this.repository.findAll(filters);
  }
  
  async createClient(data, userId) {
    // 驗證
    this.validate(data);
    // 檢查唯一性
    // 創建
  }
}
```

#### Route 層（API 端點）
```typescript
// 只負責接收請求、調用 Service、返回響應
app.get('/api/v1/clients', authMiddleware, async (c) => {
  const service = new ClientService(c.env.DB);
  const result = await service.getClients(c.req.query(), c.get('user'));
  return c.json(successResponse(result));
});
```

---

## 📝 共用規範

### API 響應格式
```json
// 成功
{
  "success": true,
  "data": { ... }
}

// 錯誤
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "錯誤訊息"
  }
}
```

### 權限控制
```typescript
// 前端路由
{ path: '/admin/*', meta: { requireAdmin: true } }

// 後端 API
app.post('/api/v1/admin/*', requireAdmin, handler);

// Service 層資料過濾
if (!user.is_admin) {
  filters.user_id = user.user_id;
}
```

### 錯誤處理
```typescript
throw new ValidationError('訊息');  // 422
throw new NotFoundError('訊息');    // 404
throw new ConflictError('訊息');    // 409
throw new ForbiddenError('訊息');   // 403
```

---

## 🎯 開發檢查清單

### 開發前確認：

- [ ] 已閱讀對應的完整規格文檔
- [ ] 理解資料表結構
- [ ] 理解 API 端點
- [ ] 理解權限控制規則
- [ ] 理解業務邏輯流程
- [ ] 已確認編碼設定（UTF-8）

### 實現完成後確認：

- [ ] 資料表已創建，索引已建立
- [ ] API 端點已實現
- [ ] 權限控制已實現（管理員/員工）
- [ ] 前端頁面已實現
- [ ] 錯誤處理完整
- [ ] 驗證規則正確
- [ ] 所有相關文檔已同步更新

### 🧪 自行測試（必須完成！）⚠️

**絕對不讓用戶測試！AI必須自己測試！**

- [ ] **功能測試**
  - 所有功能正常運作
  - 按鈕、表單、連結都能使用
  
- [ ] **邊界條件測試**
  - 空值、超長文字、特殊字符
  
- [ ] **錯誤處理測試**
  - 必填欄位驗證
  - 格式驗證
  - 錯誤訊息清楚（繁體中文）
  
- [ ] **權限測試**
  - 管理員權限正常
  - 員工權限正常
  - 權限不足會正確攔截
  
- [ ] **中文編碼測試** ⚠️
  - 繁體中文正確顯示
  - 儲存讀取沒有亂碼
  - 搜索中文正常運作
  
- [ ] **資料一致性測試**
  - 新增、修改、刪除、查詢都正常

### 一致性驗證（極其重要！）

- [ ] **執行快速檢查命令**：
  ```powershell
  cd docs
  Get-ChildItem -Filter "*.md" -Recurse | Select-String "個.*[表API]" | ForEach-Object {
      if ($_.Line -match '(\d+)個') { "$($_.FileName): $($matches[1])個" }
  } | Sort-Object | Get-Unique
  ```
- [ ] **確認所有數字與SSOT一致**（只有一個唯一的數字）
- [ ] **檢查交叉引用對稱性**（A→B 且 B→A）
- [ ] **如有不一致，立即修復並重新驗證**

### 🚀 自動部署（必須完成！）⚠️

**測試通過後，必須自動部署！絕不讓用戶手動部署！**

- [ ] **執行部署腳本**
  ```powershell
  .\scripts\deploy.ps1
  ```
  
- [ ] **提交代碼到 Git**
  - 添加所有修改：`git add .`
  - 提交：`git commit -m "新增XX功能"`
  - 推送：`git push origin main`
  
- [ ] **等待 Cloudflare 自動建置**
  - 通常需要 1-3 分鐘
  - 到 Cloudflare Dashboard 查看狀態
  
- [ ] **驗證線上環境**
  - 訪問線上網址
  - 測試新功能
  - 檢查繁體中文顯示
  - 檢查 Console 無錯誤

### 最終確認

```
✅ 所有功能已自行測試通過
✅ 所有文檔已同步更新
✅ 一致性驗證通過
✅ 繁體中文顯示正常
✅ 已自動部署上線
✅ 線上環境驗證通過

→ 現在可以說「已完成」！
```

---

## 🚨 常見錯誤（必須避免！）

❌ **使用 PowerShell 不支持的 `&&` 操作符**
```
後果：命令執行失敗，開發流程中斷
正確：使用 ; 分隔命令或 if ($LASTEXITCODE -eq 0) 檢查
```

❌ **直接開始寫代碼，沒有閱讀完整規格**
```
後果：做錯功能、遺漏需求
正確：先讀完整規格，理解所有細節
```

❌ **忘記更新文檔**
```
後果：文檔與代碼不一致
正確：列出需要修改的文檔清單
```

❌ **沒有檢查編碼**
```
後果：中文變亂碼
正確：確認所有操作使用 UTF-8
```

❌ **開發完就說完成，沒有驗證一致性**
```
後果：數字不一致、引用缺失
正確：執行一致性驗證命令
```

---

## 📚 完整規格文檔清單

### 核心功能
- [客戶管理-完整規格.md](./客戶管理-完整規格.md)
- [工時管理-完整規格.md](./工時管理-完整規格.md)
- [假期管理-完整規格.md](./假期管理-完整規格.md)
- [任務管理-完整規格.md](./任務管理-完整規格.md)

### 系統功能
- [系統基礎-完整規格.md](./系統基礎-完整規格.md) - 認證、員工管理、個人資料、系統設定
- [業務規則-完整規格.md](./業務規則-完整規格.md) - 6種業務規則
- [知識管理-完整規格.md](./知識管理-完整規格.md) - SOP、知識庫
- [外部內容管理-完整規格.md](./外部內容管理-完整規格.md) - CMS

### 共用規範
- [共用規範.md](./共用規範.md) - API格式、權限、錯誤處理等

---

## ⚠️ 一致性驗證（必須執行！）

完成開發後，**執行手動驗證**：

```powershell
# 快速驗證命令
cd docs
Get-ChildItem -Filter "*.md" -Recurse | Select-String "個.*[表API]" | ForEach-Object {
    if ($_.Line -match '(\d+)個') { "$($_.FileName): $($matches[1])個" }
} | Sort-Object | Get-Unique

# 如果看到多个不同的数字 → 不一致！立即修复！
```

**必須逐項檢查：**
- ✅ 單一真相源一致性（從SSOT提取真相，確保所有文檔一致）
- ✅ 交叉引用對稱性（A→B 且 B→A）
- ✅ 格式規範一致性（同類文檔格式統一）
- ✅ 完整性檢查（必要章節存在）

**詳細驗證步驟：** [系統資料/一致性驗證腳本.md](../系統資料/一致性驗證腳本.md)

**核心原則：**
1. **單一真相源（SSOT）** - 只在一個地方定義真相
   - 資料表數量 → `系統資料/數據表清單.md`
   - API數量 → `系統資料/API清單.md`
2. **其他所有文檔都必須與SSOT一致**
3. **不依賴硬編碼數字，適用於未來任何變化**

---

**AI 開發時只需要閱讀"開發指南"目錄下的文檔即可！**

