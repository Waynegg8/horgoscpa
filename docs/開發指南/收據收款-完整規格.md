# 收據收款 - 完整規格

**模組名稱：** 收據/收款管理系統  
**版本：** 3.2  
**更新日期：** 2025-10-28

**⚠️ 重要說明：** 會計師事務所開立的是「收據」而非「發票」，且無稅額（不計算5%營業稅）

---

## 📋 功能概述

### 核心功能

1. **收據管理**
   - 開立收據（客戶、金額、日期、項目）
   - 收據號碼自動生成（YYYYMM-NNN格式）或手動輸入
   - 查看收據列表
   - 編輯收據
   - 作廢收據

2. **收款管理**
   - 記錄收款（關聯收據）
   - 部分收款支持
   - 查看應收帳款
   - 收款統計

3. **報表分析**
   - 應收帳款帳齡分析
   - 收款統計
   - 營收報表

---

## 💾 資料表設計

### 1. Receipts（收據表）

```sql
CREATE TABLE Receipts (
  receipt_id TEXT PRIMARY KEY,  -- 收據號碼（格式：YYYYMM-NNN，如：202510-001）
  client_id TEXT NOT NULL,
  receipt_date TEXT NOT NULL,  -- 開立日期
  due_date TEXT,  -- 到期日
  total_amount REAL NOT NULL,  -- 總金額（無稅額）
  status TEXT DEFAULT 'unpaid',  -- unpaid, partial, paid, cancelled
  is_auto_generated BOOLEAN DEFAULT 1,  -- 是否自動生成編號（0=手動輸入）
  notes TEXT,
  created_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,                      -- ⭐ 作廢時間
  deleted_by INTEGER,                   -- ⭐ 作廢人員
  
  FOREIGN KEY (client_id) REFERENCES Clients(client_id),
  FOREIGN KEY (created_by) REFERENCES Users(user_id),
  FOREIGN KEY (deleted_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_receipts_client ON Receipts(client_id);
CREATE INDEX idx_receipts_date ON Receipts(receipt_date);
CREATE INDEX idx_receipts_status ON Receipts(status);
CREATE INDEX idx_receipts_status_due ON Receipts(status, due_date);  -- ⭐ 應收帳款查詢專用
CREATE INDEX idx_receipts_client_status ON Receipts(client_id, status);  -- ⭐ 客戶收款查詢專用
```

**索引使用說明：**
```
idx_receipts_status_due: ⭐ 新增
  用途：應收帳款帳齡分析
  查詢：WHERE status IN ('unpaid', 'partial') AND due_date < ?
  效能提升：避免全表掃描，快速定位逾期收據
  
idx_receipts_client_status: ⭐ 新增
  用途：客戶收款統計
  查詢：WHERE client_id = ? AND status = 'unpaid'
```

### 2. ReceiptItems（收據項目）

```sql
CREATE TABLE ReceiptItems (
  item_id INTEGER PRIMARY KEY AUTOINCREMENT,
  receipt_id TEXT NOT NULL,
  service_id INTEGER,  -- 關聯到 Services
  description TEXT NOT NULL,  -- 項目說明
  quantity REAL DEFAULT 1,  -- 數量
  unit_price REAL NOT NULL,  -- 單價
  amount REAL NOT NULL,  -- 金額（quantity × unit_price）
  
  FOREIGN KEY (receipt_id) REFERENCES Receipts(receipt_id) ON DELETE CASCADE,
  FOREIGN KEY (service_id) REFERENCES Services(service_id)
);

CREATE INDEX idx_receipt_items_receipt ON ReceiptItems(receipt_id);
```

### 3. ReceiptSequence（收據流水號管理）

```sql
CREATE TABLE ReceiptSequence (
  sequence_id INTEGER PRIMARY KEY AUTOINCREMENT,
  year_month TEXT UNIQUE NOT NULL,  -- 年月（YYYYMM）
  last_sequence INTEGER NOT NULL DEFAULT 0,  -- 最後使用的流水號
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now'))
);

CREATE INDEX idx_receipt_sequence_ym ON ReceiptSequence(year_month);

-- 範例資料
INSERT INTO ReceiptSequence (year_month, last_sequence) VALUES
('202510', 15),  -- 10月已開立15張收據
('202511', 0);   -- 11月尚未開立
```

### 4. Payments（收款記錄）

```sql
CREATE TABLE Payments (
  payment_id INTEGER PRIMARY KEY AUTOINCREMENT,
  receipt_id TEXT NOT NULL,
  payment_date TEXT NOT NULL,  -- 收款日期
  amount REAL NOT NULL,  -- 收款金額
  payment_method TEXT,  -- 現金、轉帳、支票
  reference_number TEXT,  -- 參考號碼（如：支票號碼、帳號後5碼）
  notes TEXT,
  received_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (receipt_id) REFERENCES Receipts(receipt_id),
  FOREIGN KEY (received_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_payments_receipt ON Payments(receipt_id);
CREATE INDEX idx_payments_date ON Payments(payment_date);
```

---

## 📐 收據號碼設計

### 格式規範

**格式：** `YYYYMM-NNN`

- `YYYYMM`：年月（如：202510）
- `NNN`：流水號（001-999，3位數）
- 範例：`202510-001`, `202510-002`, `202511-001`

### 收據號碼生成邏輯

```typescript
/**
 * 生成收據號碼（含自動重試機制，處理併發衝突）
 * @param yearMonth - 指定年月（YYYYMM），不提供則使用當月
 * @param manualNumber - 手動指定號碼（可選）
 */
async function generateReceiptNumber(
  yearMonth?: string,
  manualNumber?: string
): Promise<string> {
  
  // 1. 如果提供手動編號，直接使用
  if (manualNumber) {
    // 驗證格式
    if (!/^\d{6}-\d{3}$/.test(manualNumber)) {
      throw new Error('收據號碼格式錯誤（應為：YYYYMM-NNN）');
    }
    
    // 檢查是否已存在
    const existing = await db.prepare(`
      SELECT receipt_id FROM Receipts WHERE receipt_id = ?
    `).bind(manualNumber).first();
    
    if (existing) {
      throw new Error('收據號碼已存在');
    }
    
    return manualNumber;
  }
  
  // 2. 自動生成（使用原子操作，避免併發衝突）
  const targetYearMonth = yearMonth || getCurrentYearMonth();  // 如：202510
  
  // ⚠️ 使用 UPSERT + RETURNING 原子操作（併發安全）
  const result = await db.prepare(`
    INSERT INTO ReceiptSequence (year_month, last_sequence, updated_at)
    VALUES (?, 1, datetime('now'))
    ON CONFLICT(year_month) 
    DO UPDATE SET 
      last_sequence = last_sequence + 1,
      updated_at = datetime('now')
    RETURNING last_sequence
  `).bind(targetYearMonth).first();
  
  const nextSequence = result.last_sequence;
  
  // 檢查是否超過999（最大流水號）
  if (nextSequence > 999) {
    throw new ValidationError(
      '本月收據流水號已達上限（999張），請聯絡系統管理員升級流水號位數',
      'RECEIPT_SEQUENCE_EXCEEDED'
    );
  }
  
  // 生成收據號碼
  const receiptNumber = `${targetYearMonth}-${String(nextSequence).padStart(3, '0')}`;
  
  return receiptNumber;
}

/**
 * ⚠️ 業務限制說明：
 * 
 * 流水號上限999張的合理性：
 * - 貴事務所目前每月約開立 50-200 張收據
 * - 999張上限提供 5-20倍的成長空間
 * - 如未來業務快速成長超過此上限：
 *   1. 短期方案：手動切換月份（提前使用下月號碼）
 *   2. 長期方案：升級系統，改為 4位數流水號（YYYYMM-NNNN，可到9999張）
 * 
 * 錯誤處理：
 * - 錯誤碼：RECEIPT_SEQUENCE_EXCEEDED
 * - 前端提示：「本月收據已達上限，請聯絡管理員」
 * - 管理員儀表板：顯示警告並提供升級指引
 */
}

/**
 * 範例使用：
 */

// 1. 自動生成（使用當月）
const receiptId1 = await generateReceiptNumber();
// 結果：202510-001

// 2. 自動生成（指定月份，用於補開收據）
const receiptId2 = await generateReceiptNumber('202509');
// 結果：202509-001（9月的第一張補開收據）

// 3. 手動輸入（系統推出不一定是年初，需要手動設定起始編號）
const receiptId3 = await generateReceiptNumber(null, '202510-100');
// 結果：202510-100（從100開始編號）

// 4. 手動輸入（特殊編號）
const receiptId4 = await generateReceiptNumber(null, '202510-999');
// 結果：202510-999
```

---

## 🔌 API 端點

### 收據管理 API

```
GET    /api/v1/receipts                      查詢收據列表
POST   /api/v1/receipts                      開立收據
GET    /api/v1/receipts/:id                  查詢收據詳情
PUT    /api/v1/receipts/:id                  更新收據
DELETE /api/v1/receipts/:id                  作廢收據
GET    /api/v1/receipts/check-number?number=202511-001  檢查收據號碼是否可用 ⭐ 新增
```

**檢查收據號碼可用性（即時驗證）：**
```json
// GET /api/v1/receipts/check-number?number=202511-001

// 回應（可用）
{
  "success": true,
  "data": {
    "number": "202511-001",
    "available": true
  }
}

// 回應（已存在）
{
  "success": true,
  "data": {
    "number": "202511-001",
    "available": false,
    "message": "此收據號碼已存在",
    "existing_receipt": {
      "receipt_id": "202511-001",
      "client_name": "測試科技",
      "receipt_date": "2025-11-01"
    }
  }
}
```

**查詢收據列表範例：**
```json
// GET /api/v1/receipts?status=unpaid

{
  "success": true,
  "data": [
    {
      "receipt_id": "202511-003",
      "client_id": "12345678",
      "company_name": "測試科技",
      "receipt_date": "2025-11-01",
      "due_date": "2025-12-05",
      "total_amount": 12000,
      "paid_amount": 0,
      "remaining_amount": 12000,
      "status": "unpaid",
      "days_overdue": 0,
      "client_payment_notes": "由財務陳小姐負責，習慣月底轉帳",  // ⭐ JOIN Clients.payment_notes
      "client_notes": "喜歡提前收到報表"  // ⭐ JOIN Clients.client_notes（可能也有收款提示）
    },
    {
      "receipt_id": "202511-005",
      "client_id": "87654321",
      "company_name": "ABC公司",
      "receipt_date": "2025-11-05",
      "due_date": "2025-11-28",
      "total_amount": 25000,
      "paid_amount": 0,
      "remaining_amount": 25000,
      "status": "unpaid",
      "days_overdue": 2,
      "is_overdue": true,
      "client_payment_notes": "請提前通知張經理",  // ⭐ 顯示客戶收款備註
      "client_notes": "VIP客戶，優先處理"  // ⭐ 客戶備註
    }
  ]
}

/**
 * ⚠️ 重要說明：
 * 
 * 為什麼要 JOIN 客戶備註欄位？
 * - 業務報告第1140行要求：「查詢應收帳款時顯示客戶收款備註」
 * - payment_notes：收款相關資訊（付款習慣、聯絡窗口、收款方式）
 * - client_notes：客戶業務備註（可能包含「付款需提前通知」等資訊）
 * 
 * 前端UI應顯示這些備註，協助收款人員了解客戶特性。
 */
```

### 收款管理 API

```
GET    /api/v1/receipts/:id/payments     查詢收據的收款記錄
POST   /api/v1/receipts/:id/payments     記錄收款
DELETE /api/v1/payments/:id              刪除收款記錄
```

### 統計報表 API

```
GET    /api/v1/receipts/stats            收據統計
GET    /api/v1/receipts/ar-aging         應收帳款帳齡分析
GET    /api/v1/reports/revenue           營收報表
```

---

## 📝 API 範例

### 開立收據

**請求：**
```json
// POST /api/v1/receipts
{
  "receipt_id": "202510-001",  // 可選，不提供則自動生成
  "is_auto_generated": true,   // true=自動生成，false=手動輸入
  "client_id": "12345678",
  "receipt_date": "2025-10-28",
  "due_date": "2025-11-28",
  "items": [
    {
      "service_id": 1,
      "description": "記帳服務 - 10月",
      "quantity": 1,
      "unit_price": 5000
    },
    {
      "service_id": 2,
      "description": "工商登記變更",
      "quantity": 1,
      "unit_price": 3000
    }
  ],
  "notes": "月結30天"
}
```

**回應：**
```json
{
  "success": true,
  "data": {
    "receipt_id": "202510-001",
    "client_id": "12345678",
    "company_name": "測試公司",
    "receipt_date": "2025-10-28",
    "due_date": "2025-11-28",
    "total_amount": 8000,  // 無稅額，會計師事務所免稅
    "status": "unpaid",
    "items": [
      {
        "description": "記帳服務 - 10月",
        "quantity": 1,
        "unit_price": 5000,
        "amount": 5000
      },
      {
        "description": "工商登記變更",
        "quantity": 1,
        "unit_price": 3000,
        "amount": 3000
      }
    ]
  }
}
```

### 記錄收款

**請求：**
```json
// POST /api/v1/receipts/202510-001/payments
{
  "payment_date": "2025-11-05",
  "amount": 8000,
  "payment_method": "轉帳",
  "reference_number": "20251105001",
  "notes": "已確認入帳"
}
```

**回應：**
```json
{
  "success": true,
  "data": {
    "payment_id": 123,
    "receipt_id": "202510-001",
    "payment_date": "2025-11-05",
    "amount": 8000,
    "payment_method": "轉帳",
    "receipt_status": "paid",  // 自動更新收據狀態
    "remaining_amount": 0
  }
}
```

### 應收帳款帳齡分析

**請求：**
```
GET /api/v1/receipts/ar-aging?as_of_date=2025-10-31
```

**回應：**
```json
{
  "success": true,
  "data": {
    "as_of_date": "2025-10-31",
    "total_ar": 125000,
    "aging_summary": {
      "current": 45000,        // 未到期
      "overdue_1_30": 30000,   // 逾期1-30天
      "overdue_31_60": 25000,  // 逾期31-60天
      "overdue_61_90": 15000,  // 逾期61-90天
      "overdue_over_90": 10000 // 逾期超過90天
    },
    "by_client": [
      {
        "client_id": "12345678",
        "company_name": "客戶A",
        "total_ar": 50000,
        "current": 20000,
        "overdue_1_30": 15000,
        "overdue_31_60": 10000,
        "overdue_61_90": 5000,
        "overdue_over_90": 0,
        "client_payment_notes": "由財務陳小姐負責，習慣月底轉帳"  // ⭐ 顯示客戶收款備註
      }
    ],
    "details": [
      {
        "receipt_id": "202510-003",
        "client_id": "12345678",
        "company_name": "客戶A",
        "total_amount": 15000,
        "paid_amount": 0,
        "remaining_amount": 15000,
        "due_date": "2025-10-20",
        "days_overdue": 11,
        "aging_bucket": "overdue_1_30",
        "client_payment_notes": "由財務陳小姐負責，習慣月底轉帳"  // ⭐ 每筆收據都顯示
      }
    ]
  }
}
```

---

## 🎨 前端組件

### ReceiptListPage.vue（收據列表）

**功能：**
- 顯示所有收據
- 篩選（狀態、日期、客戶）
- 開立新收據
- 查看收據詳情

**統計卡片：**
- 未收款金額
- 本月開立
- 逾期未收

### ReceiptFormModal.vue（收據表單）

**功能：**
- 客戶選擇
- 收據號碼（自動/手動切換）
- 收據日期、到期日
- 項目明細（可多項）
- 總金額自動計算（無稅額）

**收據號碼切換（含即時驗證）：**
```vue
<template>
  <FormGroup label="收據號碼">
    <div class="receipt-number-input">
      <!-- 自動生成（預設） -->
      <div v-if="!manualMode">
        <StyledInput
          :value="autoGeneratedNumber"
          disabled
          placeholder="將自動生成"
        />
        <StyledButton
          type="button"
          size="small"
          @click="manualMode = true"
        >
          手動輸入
        </StyledButton>
      </div>
      
      <!-- 手動輸入（即時驗證）⭐ -->
      <div v-else>
        <StyledInput
          v-model="form.receipt_id"
          placeholder="202510-001"
          pattern="^\\d{6}-\\d{3}$"
          @blur="checkReceiptNumberAvailability"
          :error="receiptNumberError"
          :class="{ 'input-error': receiptNumberError, 'input-success': receiptNumberValid }"
        />
        <span class="hint">格式：YYYYMM-NNN（如：202510-001）</span>
        
        <!-- ⭐ 即時驗證結果 -->
        <div v-if="isCheckingNumber" class="validation-status checking">
          <SpinnerIcon /> 檢查中...
        </div>
        <div v-else-if="receiptNumberError" class="validation-status error">
          ❌ {{ receiptNumberError }}
        </div>
        <div v-else-if="receiptNumberValid" class="validation-status success">
          ✅ 此號碼可用
        </div>
        
        <StyledButton
          type="button"
          size="small"
          @click="manualMode = false; form.receipt_id = null; receiptNumberError = ''"
        >
          使用自動編號
        </StyledButton>
      </div>
    </div>
  </FormGroup>
</template>

<script setup>
import { ref } from 'vue';
import { checkReceiptNumber } from '@/api/receipts';

const manualMode = ref(false);
const receiptNumberError = ref('');
const receiptNumberValid = ref(false);
const isCheckingNumber = ref(false);

// ⭐ 即時檢查收據號碼是否可用
async function checkReceiptNumberAvailability() {
  const number = form.value.receipt_id;
  
  if (!number) {
    receiptNumberError.value = '';
    receiptNumberValid.value = false;
    return;
  }
  
  // 檢查格式
  if (!/^\d{6}-\d{3}$/.test(number)) {
    receiptNumberError.value = '格式錯誤（應為：YYYYMM-NNN）';
    receiptNumberValid.value = false;
    return;
  }
  
  // 檢查唯一性（呼叫API）
  isCheckingNumber.value = true;
  
  try {
    const response = await checkReceiptNumber(number);
    
    if (response.data.available) {
      receiptNumberError.value = '';
      receiptNumberValid.value = true;
    } else {
      receiptNumberError.value = '此收據號碼已存在，請更換';
      receiptNumberValid.value = false;
    }
  } catch (error) {
    receiptNumberError.value = '檢查失敗，請稍後再試';
    receiptNumberValid.value = false;
  } finally {
    isCheckingNumber.value = false;
  }
}
</script>

<style scoped>
.validation-status {
  margin-top: 0.5rem;
  font-size: 0.875rem;
  padding: 0.5rem;
  border-radius: 0.375rem;
}

.validation-status.checking {
  color: #6b7280;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.validation-status.error {
  color: #ef4444;
  background: #fef2f2;
  border: 1px solid #fecaca;
}

.validation-status.success {
  color: #059669;
  background: #d1fae5;
  border: 1px solid #6ee7b7;
}

.input-error { border-color: #ef4444 !important; }
.input-success { border-color: #059669 !important; }
</style>
```

### PaymentRecordModal.vue（收款記錄）

**功能：**
- 收款日期
- 收款金額
- 收款方式（現金/轉帳/支票）
- 參考號碼
- 自動更新收據狀態

### ARAgingReportPage.vue（應收帳款報表）

**功能：**
- 帳齡分析表
- 帳齡分布圓餅圖
- 逾期客戶列表
- 收款提醒

---

## 📊 業務邏輯

### 收據狀態自動更新

```typescript
/**
 * 記錄收款後自動更新收據狀態
 */
async function recordPayment(receiptId: string, paymentData: PaymentData) {
  // 1. 記錄收款
  await db.prepare(`
    INSERT INTO Payments (receipt_id, payment_date, amount, payment_method, reference_number, received_by, notes)
    VALUES (?, ?, ?, ?, ?, ?, ?)
  `).bind(
    receiptId,
    paymentData.payment_date,
    paymentData.amount,
    paymentData.payment_method,
    paymentData.reference_number,
    paymentData.received_by,
    paymentData.notes
  ).run();
  
  // 2. 查詢該收據的總收款金額
  const receipt = await db.prepare(`
    SELECT total_amount FROM Receipts WHERE receipt_id = ?
  `).bind(receiptId).first();
  
  const payments = await db.prepare(`
    SELECT SUM(amount) as total_paid FROM Payments WHERE receipt_id = ?
  `).bind(receiptId).first();
  
  const totalPaid = payments?.total_paid || 0;
  const totalAmount = receipt.total_amount;
  
  // 3. 自動更新收據狀態
  let status = 'unpaid';
  if (totalPaid >= totalAmount) {
    status = 'paid';  // 已全額收款
  } else if (totalPaid > 0) {
    status = 'partial';  // 部分收款
  }
  
  await db.prepare(`
    UPDATE Receipts SET status = ?, updated_at = datetime('now')
    WHERE receipt_id = ?
  `).bind(status, receiptId).run();
  
  return { status, remaining_amount: totalAmount - totalPaid };
}
```

### 日期計算工具函數

```typescript
/**
 * 計算兩個日期之間的天數差
 * @param fromDate - 起始日期（如：到期日）
 * @param toDate - 結束日期（如：查詢日）
 * @returns 天數差（正數表示fromDate在toDate之前）
 */
function getDaysDiff(fromDate: string, toDate: string): number {
  const from = new Date(fromDate);
  const to = new Date(toDate);
  const diffTime = to - from;
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  return diffDays;
}

/**
 * 範例：
 * getDaysDiff('2025-10-31', '2025-12-10') = 40天（逾期40天）
 * getDaysDiff('2025-12-05', '2025-11-28') = -7天（尚未到期，還有7天）
 */
```

### 應收帳款計算

```typescript
/**
 * 計算應收帳款帳齡（含客戶收款備註）
 * ⚠️ 逾期天數從「到期日」開始計算
 * ⚠️ 必須包含客戶的 payment_notes（收款備註），用於提醒收款注意事項
 */
async function calculateARAging(asOfDate: string) {
  const receipts = await db.prepare(`
    SELECT 
      r.receipt_id,
      r.client_id,
      c.company_name,
      c.payment_notes as client_payment_notes,  -- ⭐ JOIN 客戶收款備註（業務報告第1154行要求）
      c.client_notes,                           -- ⭐ 客戶備註（可能也有收款相關提示）
      r.receipt_date,
      r.due_date,
      r.total_amount,
      COALESCE(SUM(p.amount), 0) as paid_amount
    FROM Receipts r
    JOIN Clients c ON r.client_id = c.client_id
    LEFT JOIN Payments p ON r.receipt_id = p.receipt_id
    WHERE r.status != 'paid'
      AND r.status != 'cancelled'
      AND r.is_deleted = 0
    GROUP BY r.receipt_id
  `).all();
  
  const aging = {
    current: 0,
    overdue_1_30: 0,
    overdue_31_60: 0,
    overdue_61_90: 0,
    overdue_over_90: 0
  };
  
  for (const rec of receipts.results) {
    const remaining = rec.total_amount - rec.paid_amount;
    
    // ⭐ 從「到期日」開始計算逾期天數
    const daysOverdue = getDaysDiff(rec.due_date, asOfDate);
    
    // 分類到對應的帳齡區間
    if (daysOverdue <= 0) {
      aging.current += remaining;  // 未到期或今天到期
    } else if (daysOverdue <= 30) {
      aging.overdue_1_30 += remaining;  // 逾期1-30天
    } else if (daysOverdue <= 60) {
      aging.overdue_31_60 += remaining;  // 逾期31-60天
    } else if (daysOverdue <= 90) {
      aging.overdue_61_90 += remaining;  // 逾期61-90天
    } else {
      aging.overdue_over_90 += remaining;  // 逾期超過90天
    }
  }
  
  return aging;
}

/**
 * 範例計算：
 * 
 * 收據A：
 * - 到期日：2025-10-31
 * - 查詢日：2025-12-10
 * - 逾期天數：getDaysDiff('2025-10-31', '2025-12-10') = 40天
 * - 分類：overdue_31_60（31-60天區間）
 * 
 * 收據B：
 * - 到期日：2025-12-15
 * - 查詢日：2025-12-10
 * - 逾期天數：getDaysDiff('2025-12-15', '2025-12-10') = -5天（還有5天）
 * - 分類：current（未到期）
 */
}
```

---

## 📄 收據列印範本

### PDF 格式規格

**頁面設定：**
- 紙張：A4（210mm × 297mm）
- 邊距：上下左右各20mm
- 字體：標楷體（繁體中文）

**收據範本結構：**

```typescript
/**
 * 生成收據PDF
 */
async function generateReceiptPDF(receiptId: string): Promise<PDFDocument> {
  const receipt = await getReceiptDetails(receiptId);
  const client = await getClient(receipt.client_id);
  const company = await getCompanySettings();
  
  const pdfContent = {
    // ========== 頁首（20% 高度）==========
    header: {
      logo: {
        url: company.logo_url || '/images/logo.png',
        position: 'top-left',
        size: '80px × 40px'
      },
      company_info: {
        name: company.company_name || '霍爾果斯會計師事務所',
        address: company.address || '台中市西區建國路21號3樓之1',
        phone: company.phone || '04-2220-5606',
        email: company.email || 'contact@horgoscpa.com',
        position: 'top-right',
        font_size: '10pt'
      }
    },
    
    // ========== 收據標題（10% 高度）==========
    title: {
      text: '收　據',
      font_size: '24pt',
      font_weight: 'bold',
      alignment: 'center',
      margin_top: '30mm'
    },
    
    // ========== 收據資訊（15% 高度）==========
    receipt_info: {
      layout: 'two-columns',
      left_column: {
        receipt_number: {
          label: '收據編號：',
          value: receipt.receipt_id,  // 202511-001
          font_size: '12pt'
        },
        receipt_date: {
          label: '開立日期：',
          value: formatDate(receipt.receipt_date),  // 2025年11月01日
          font_size: '12pt'
        }
      },
      right_column: {
        client_name: {
          label: '客戶名稱：',
          value: client.company_name,
          font_size: '12pt'
        },
        client_tax_id: {
          label: '統一編號：',
          value: receipt.client_id,
          font_size: '12pt'
        }
      }
    },
    
    // ========== 項目明細表格（40% 高度）==========
    items_table: {
      columns: [
        { header: '項目說明', width: '50%', align: 'left' },
        { header: '數量', width: '15%', align: 'center' },
        { header: '單價', width: '17.5%', align: 'right' },
        { header: '金額', width: '17.5%', align: 'right' }
      ],
      rows: receipt.items.map(item => ({
        description: item.description,
        quantity: item.quantity,
        unit_price: formatCurrency(item.unit_price),
        amount: formatCurrency(item.amount)
      })),
      footer_row: {
        label: '合計金額',
        amount: formatCurrency(receipt.total_amount),
        font_size: '14pt',
        font_weight: 'bold'
      }
    },
    
    // ========== 備註區（10% 高度）==========
    notes: {
      label: '備註：',
      value: receipt.notes || '',
      font_size: '10pt',
      color: '#666666'
    },
    
    // ========== 頁尾（5% 高度）==========
    footer: {
      notice: {
        text: '※ 此為收據，非統一發票',
        font_size: '9pt',
        font_style: 'italic',
        color: '#999999',
        alignment: 'center'
      },
      signature: {
        label: '經辦人員：',
        value: receipt.created_by_name,
        position: 'bottom-right',
        font_size: '10pt'
      }
    }
  };
  
  return generatePDF(pdfContent);
}
```

**實際PDF範例佈局：**

```
┌─────────────────────────────────────────────────────────────┐
│ [Logo]                         霍爾果斯會計師事務所              │
│                          台中市西區建國路21號3樓之1                    │
│                                電話：04-2220-5606            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│                         收　據                               │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│ 收據編號：202511-001              客戶名稱：測試科技股份有限公司 │
│ 開立日期：2025年11月01日          統一編號：12345678          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ 項目說明            │ 數量 │    單價    │    金額     │  │
│ ├───────────────────────────────────────────────────────┤  │
│ │ 記帳服務 - 11月     │  1   │  8,000    │   8,000    │  │
│ │ 營業稅申報          │  1   │  3,000    │   3,000    │  │
│ ├───────────────────────────────────────────────────────┤  │
│ │ 合計金額                                  │  11,000   │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                              │
│ 備註：月結30天                                               │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│           ※ 此為收據，非統一發票                             │
│                                         經辦人員：王小明      │
└─────────────────────────────────────────────────────────────┘
```

**API 端點：**
```
GET /api/v1/receipts/:id/pdf          生成收據PDF
GET /api/v1/receipts/:id/preview      預覽收據（HTML）
```

---

## 🧪 測試案例

- 同秒併發兩人開立收據 → 收據號碼應不重複（原子操作）
- 開立第 1000 張（當月）→ 應拒絕並提示超過 999 上限
- 作廢後嘗試查詢 → 列表預設不可見；復原後可再次查到
- 多筆部分收款 → 應正確累計、統計數據一致
- 生成 PDF 與 HTML 預覽 → 檔案可開啟、版面正確

## ⚠️ 注意事項

1. **會計師事務所特性**：開立收據而非發票，無需計算營業稅
2. **收據號碼唯一性**：使用原子操作（UPSERT + RETURNING）確保併發安全，避免重複
3. **併發處理**：多人同時開收據時，系統自動分配不同號碼，無需手動重試
4. **流水號上限**：每月最多999張收據，超過需更換格式
5. **部分收款**：支援多次收款，自動累計
6. **收據作廢**：使用軟刪除，可恢復
7. **收款備註**：可記錄收款相關資訊（如：聯絡窗口、付款習慣等）
8. **收據列印**：⭐ 提供PDF格式，可直接列印或Email寄送

---

**相關文檔：**
- [客戶管理-完整規格](./客戶管理-完整規格.md)
- [報表分析-完整規格](./報表分析-完整規格.md)
- [附件系統-完整規格](./附件系統-完整規格.md)


