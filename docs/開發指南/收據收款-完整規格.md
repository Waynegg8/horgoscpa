# æ”¶æ“šæ”¶æ¬¾ - å®Œæ•´è¦æ ¼

**æ¨¡çµ„åç¨±ï¼š** æ”¶æ“š/æ”¶æ¬¾ç®¡ç†ç³»çµ±  
**ç‰ˆæœ¬ï¼š** 3.2  
**æ›´æ–°æ—¥æœŸï¼š** 2025-10-28

**âš ï¸ é‡è¦èªªæ˜ï¼š** æœƒè¨ˆå¸«äº‹å‹™æ‰€é–‹ç«‹çš„æ˜¯ã€Œæ”¶æ“šã€è€Œéã€Œç™¼ç¥¨ã€ï¼Œä¸”ç„¡ç¨…é¡ï¼ˆä¸è¨ˆç®—5%ç‡Ÿæ¥­ç¨…ï¼‰

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

### æ ¸å¿ƒåŠŸèƒ½

1. **æ”¶æ“šç®¡ç†**
   - é–‹ç«‹æ”¶æ“šï¼ˆå®¢æˆ¶ã€é‡‘é¡ã€æ—¥æœŸã€é …ç›®ï¼‰
   - æ”¶æ“šè™Ÿç¢¼è‡ªå‹•ç”Ÿæˆï¼ˆYYYYMM-NNNæ ¼å¼ï¼‰æˆ–æ‰‹å‹•è¼¸å…¥
   - æŸ¥çœ‹æ”¶æ“šåˆ—è¡¨
   - ç·¨è¼¯æ”¶æ“š
   - ä½œå»¢æ”¶æ“š

2. **æ”¶æ¬¾ç®¡ç†**
   - è¨˜éŒ„æ”¶æ¬¾ï¼ˆé—œè¯æ”¶æ“šï¼‰
   - éƒ¨åˆ†æ”¶æ¬¾æ”¯æŒ
   - æŸ¥çœ‹æ‡‰æ”¶å¸³æ¬¾
   - æ”¶æ¬¾çµ±è¨ˆ

3. **å ±è¡¨åˆ†æ**
   - æ‡‰æ”¶å¸³æ¬¾å¸³é½¡åˆ†æ
   - æ”¶æ¬¾çµ±è¨ˆ
   - ç‡Ÿæ”¶å ±è¡¨

---

## ğŸ’¾ è³‡æ–™è¡¨è¨­è¨ˆ

### 1. Receiptsï¼ˆæ”¶æ“šè¡¨ï¼‰

```sql
CREATE TABLE Receipts (
  receipt_id TEXT PRIMARY KEY,  -- æ”¶æ“šè™Ÿç¢¼ï¼ˆæ ¼å¼ï¼šYYYYMM-NNNï¼Œå¦‚ï¼š202510-001ï¼‰
  client_id TEXT NOT NULL,
  receipt_date TEXT NOT NULL,  -- é–‹ç«‹æ—¥æœŸ
  due_date TEXT,  -- åˆ°æœŸæ—¥
  total_amount REAL NOT NULL,  -- ç¸½é‡‘é¡ï¼ˆç„¡ç¨…é¡ï¼‰
  status TEXT DEFAULT 'unpaid',  -- unpaid, partial, paid, cancelled
  is_auto_generated BOOLEAN DEFAULT 1,  -- æ˜¯å¦è‡ªå‹•ç”Ÿæˆç·¨è™Ÿï¼ˆ0=æ‰‹å‹•è¼¸å…¥ï¼‰
  notes TEXT,
  created_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,                      -- â­ ä½œå»¢æ™‚é–“
  deleted_by INTEGER,                   -- â­ ä½œå»¢äººå“¡
  
  FOREIGN KEY (client_id) REFERENCES Clients(client_id),
  FOREIGN KEY (created_by) REFERENCES Users(user_id),
  FOREIGN KEY (deleted_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_receipts_client ON Receipts(client_id);
CREATE INDEX idx_receipts_date ON Receipts(receipt_date);
CREATE INDEX idx_receipts_status ON Receipts(status);
CREATE INDEX idx_receipts_status_due ON Receipts(status, due_date);  -- â­ æ‡‰æ”¶å¸³æ¬¾æŸ¥è©¢å°ˆç”¨
CREATE INDEX idx_receipts_client_status ON Receipts(client_id, status);  -- â­ å®¢æˆ¶æ”¶æ¬¾æŸ¥è©¢å°ˆç”¨
```

**ç´¢å¼•ä½¿ç”¨èªªæ˜ï¼š**
```
idx_receipts_status_due: â­ æ–°å¢
  ç”¨é€”ï¼šæ‡‰æ”¶å¸³æ¬¾å¸³é½¡åˆ†æ
  æŸ¥è©¢ï¼šWHERE status IN ('unpaid', 'partial') AND due_date < ?
  æ•ˆèƒ½æå‡ï¼šé¿å…å…¨è¡¨æƒæï¼Œå¿«é€Ÿå®šä½é€¾æœŸæ”¶æ“š
  
idx_receipts_client_status: â­ æ–°å¢
  ç”¨é€”ï¼šå®¢æˆ¶æ”¶æ¬¾çµ±è¨ˆ
  æŸ¥è©¢ï¼šWHERE client_id = ? AND status = 'unpaid'
```

### 2. ReceiptItemsï¼ˆæ”¶æ“šé …ç›®ï¼‰

```sql
CREATE TABLE ReceiptItems (
  item_id INTEGER PRIMARY KEY AUTOINCREMENT,
  receipt_id TEXT NOT NULL,
  service_id INTEGER,  -- é—œè¯åˆ° Services
  description TEXT NOT NULL,  -- é …ç›®èªªæ˜
  quantity REAL DEFAULT 1,  -- æ•¸é‡
  unit_price REAL NOT NULL,  -- å–®åƒ¹
  amount REAL NOT NULL,  -- é‡‘é¡ï¼ˆquantity Ã— unit_priceï¼‰
  
  FOREIGN KEY (receipt_id) REFERENCES Receipts(receipt_id) ON DELETE CASCADE,
  FOREIGN KEY (service_id) REFERENCES Services(service_id)
);

CREATE INDEX idx_receipt_items_receipt ON ReceiptItems(receipt_id);
```

### 3. ReceiptSequenceï¼ˆæ”¶æ“šæµæ°´è™Ÿç®¡ç†ï¼‰

```sql
CREATE TABLE ReceiptSequence (
  sequence_id INTEGER PRIMARY KEY AUTOINCREMENT,
  year_month TEXT UNIQUE NOT NULL,  -- å¹´æœˆï¼ˆYYYYMMï¼‰
  last_sequence INTEGER NOT NULL DEFAULT 0,  -- æœ€å¾Œä½¿ç”¨çš„æµæ°´è™Ÿ
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now'))
);

CREATE INDEX idx_receipt_sequence_ym ON ReceiptSequence(year_month);

-- ç¯„ä¾‹è³‡æ–™
INSERT INTO ReceiptSequence (year_month, last_sequence) VALUES
('202510', 15),  -- 10æœˆå·²é–‹ç«‹15å¼µæ”¶æ“š
('202511', 0);   -- 11æœˆå°šæœªé–‹ç«‹
```

### 4. Paymentsï¼ˆæ”¶æ¬¾è¨˜éŒ„ï¼‰

```sql
CREATE TABLE Payments (
  payment_id INTEGER PRIMARY KEY AUTOINCREMENT,
  receipt_id TEXT NOT NULL,
  payment_date TEXT NOT NULL,  -- æ”¶æ¬¾æ—¥æœŸ
  amount REAL NOT NULL,  -- æ”¶æ¬¾é‡‘é¡
  payment_method TEXT,  -- ç¾é‡‘ã€è½‰å¸³ã€æ”¯ç¥¨
  reference_number TEXT,  -- åƒè€ƒè™Ÿç¢¼ï¼ˆå¦‚ï¼šæ”¯ç¥¨è™Ÿç¢¼ã€å¸³è™Ÿå¾Œ5ç¢¼ï¼‰
  notes TEXT,
  received_by INTEGER NOT NULL,
  created_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (receipt_id) REFERENCES Receipts(receipt_id),
  FOREIGN KEY (received_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_payments_receipt ON Payments(receipt_id);
CREATE INDEX idx_payments_date ON Payments(payment_date);
```

---

## ğŸ“ æ”¶æ“šè™Ÿç¢¼è¨­è¨ˆ

### æ ¼å¼è¦ç¯„

**æ ¼å¼ï¼š** `YYYYMM-NNN`

- `YYYYMM`ï¼šå¹´æœˆï¼ˆå¦‚ï¼š202510ï¼‰
- `NNN`ï¼šæµæ°´è™Ÿï¼ˆ001-999ï¼Œ3ä½æ•¸ï¼‰
- ç¯„ä¾‹ï¼š`202510-001`, `202510-002`, `202511-001`

### æ”¶æ“šè™Ÿç¢¼ç”Ÿæˆé‚è¼¯

```typescript
/**
 * ç”Ÿæˆæ”¶æ“šè™Ÿç¢¼ï¼ˆå«è‡ªå‹•é‡è©¦æ©Ÿåˆ¶ï¼Œè™•ç†ä½µç™¼è¡çªï¼‰
 * @param yearMonth - æŒ‡å®šå¹´æœˆï¼ˆYYYYMMï¼‰ï¼Œä¸æä¾›å‰‡ä½¿ç”¨ç•¶æœˆ
 * @param manualNumber - æ‰‹å‹•æŒ‡å®šè™Ÿç¢¼ï¼ˆå¯é¸ï¼‰
 */
async function generateReceiptNumber(
  yearMonth?: string,
  manualNumber?: string
): Promise<string> {
  
  // 1. å¦‚æœæä¾›æ‰‹å‹•ç·¨è™Ÿï¼Œç›´æ¥ä½¿ç”¨
  if (manualNumber) {
    // é©—è­‰æ ¼å¼
    if (!/^\d{6}-\d{3}$/.test(manualNumber)) {
      throw new Error('æ”¶æ“šè™Ÿç¢¼æ ¼å¼éŒ¯èª¤ï¼ˆæ‡‰ç‚ºï¼šYYYYMM-NNNï¼‰');
    }
    
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
    const existing = await db.prepare(`
      SELECT receipt_id FROM Receipts WHERE receipt_id = ?
    `).bind(manualNumber).first();
    
    if (existing) {
      throw new Error('æ”¶æ“šè™Ÿç¢¼å·²å­˜åœ¨');
    }
    
    return manualNumber;
  }
  
  // 2. è‡ªå‹•ç”Ÿæˆï¼ˆä½¿ç”¨åŸå­æ“ä½œï¼Œé¿å…ä½µç™¼è¡çªï¼‰
  const targetYearMonth = yearMonth || getCurrentYearMonth();  // å¦‚ï¼š202510
  
  // âš ï¸ ä½¿ç”¨ UPSERT + RETURNING åŸå­æ“ä½œï¼ˆä½µç™¼å®‰å…¨ï¼‰
  const result = await db.prepare(`
    INSERT INTO ReceiptSequence (year_month, last_sequence, updated_at)
    VALUES (?, 1, datetime('now'))
    ON CONFLICT(year_month) 
    DO UPDATE SET 
      last_sequence = last_sequence + 1,
      updated_at = datetime('now')
    RETURNING last_sequence
  `).bind(targetYearMonth).first();
  
  const nextSequence = result.last_sequence;
  
  // æª¢æŸ¥æ˜¯å¦è¶…é999ï¼ˆæœ€å¤§æµæ°´è™Ÿï¼‰
  if (nextSequence > 999) {
    throw new ValidationError(
      'æœ¬æœˆæ”¶æ“šæµæ°´è™Ÿå·²é”ä¸Šé™ï¼ˆ999å¼µï¼‰ï¼Œè«‹è¯çµ¡ç³»çµ±ç®¡ç†å“¡å‡ç´šæµæ°´è™Ÿä½æ•¸',
      'RECEIPT_SEQUENCE_EXCEEDED'
    );
  }
  
  // ç”Ÿæˆæ”¶æ“šè™Ÿç¢¼
  const receiptNumber = `${targetYearMonth}-${String(nextSequence).padStart(3, '0')}`;
  
  return receiptNumber;
}

/**
 * âš ï¸ æ¥­å‹™é™åˆ¶èªªæ˜ï¼š
 * 
 * æµæ°´è™Ÿä¸Šé™999å¼µçš„åˆç†æ€§ï¼š
 * - è²´äº‹å‹™æ‰€ç›®å‰æ¯æœˆç´„é–‹ç«‹ 50-200 å¼µæ”¶æ“š
 * - 999å¼µä¸Šé™æä¾› 5-20å€çš„æˆé•·ç©ºé–“
 * - å¦‚æœªä¾†æ¥­å‹™å¿«é€Ÿæˆé•·è¶…éæ­¤ä¸Šé™ï¼š
 *   1. çŸ­æœŸæ–¹æ¡ˆï¼šæ‰‹å‹•åˆ‡æ›æœˆä»½ï¼ˆæå‰ä½¿ç”¨ä¸‹æœˆè™Ÿç¢¼ï¼‰
 *   2. é•·æœŸæ–¹æ¡ˆï¼šå‡ç´šç³»çµ±ï¼Œæ”¹ç‚º 4ä½æ•¸æµæ°´è™Ÿï¼ˆYYYYMM-NNNNï¼Œå¯åˆ°9999å¼µï¼‰
 * 
 * éŒ¯èª¤è™•ç†ï¼š
 * - éŒ¯èª¤ç¢¼ï¼šRECEIPT_SEQUENCE_EXCEEDED
 * - å‰ç«¯æç¤ºï¼šã€Œæœ¬æœˆæ”¶æ“šå·²é”ä¸Šé™ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€
 * - ç®¡ç†å“¡å„€è¡¨æ¿ï¼šé¡¯ç¤ºè­¦å‘Šä¸¦æä¾›å‡ç´šæŒ‡å¼•
 */
}

/**
 * ç¯„ä¾‹ä½¿ç”¨ï¼š
 */

// 1. è‡ªå‹•ç”Ÿæˆï¼ˆä½¿ç”¨ç•¶æœˆï¼‰
const receiptId1 = await generateReceiptNumber();
// çµæœï¼š202510-001

// 2. è‡ªå‹•ç”Ÿæˆï¼ˆæŒ‡å®šæœˆä»½ï¼Œç”¨æ–¼è£œé–‹æ”¶æ“šï¼‰
const receiptId2 = await generateReceiptNumber('202509');
// çµæœï¼š202509-001ï¼ˆ9æœˆçš„ç¬¬ä¸€å¼µè£œé–‹æ”¶æ“šï¼‰

// 3. æ‰‹å‹•è¼¸å…¥ï¼ˆç³»çµ±æ¨å‡ºä¸ä¸€å®šæ˜¯å¹´åˆï¼Œéœ€è¦æ‰‹å‹•è¨­å®šèµ·å§‹ç·¨è™Ÿï¼‰
const receiptId3 = await generateReceiptNumber(null, '202510-100');
// çµæœï¼š202510-100ï¼ˆå¾100é–‹å§‹ç·¨è™Ÿï¼‰

// 4. æ‰‹å‹•è¼¸å…¥ï¼ˆç‰¹æ®Šç·¨è™Ÿï¼‰
const receiptId4 = await generateReceiptNumber(null, '202510-999');
// çµæœï¼š202510-999
```

---

## ğŸ”Œ API ç«¯é»

### æ”¶æ“šç®¡ç† API

```
GET    /api/v1/receipts                      æŸ¥è©¢æ”¶æ“šåˆ—è¡¨
POST   /api/v1/receipts                      é–‹ç«‹æ”¶æ“š
GET    /api/v1/receipts/:id                  æŸ¥è©¢æ”¶æ“šè©³æƒ…
PUT    /api/v1/receipts/:id                  æ›´æ–°æ”¶æ“š
DELETE /api/v1/receipts/:id                  ä½œå»¢æ”¶æ“š
GET    /api/v1/receipts/check-number?number=202511-001  æª¢æŸ¥æ”¶æ“šè™Ÿç¢¼æ˜¯å¦å¯ç”¨ â­ æ–°å¢
```

**æª¢æŸ¥æ”¶æ“šè™Ÿç¢¼å¯ç”¨æ€§ï¼ˆå³æ™‚é©—è­‰ï¼‰ï¼š**
```json
// GET /api/v1/receipts/check-number?number=202511-001

// å›æ‡‰ï¼ˆå¯ç”¨ï¼‰
{
  "success": true,
  "data": {
    "number": "202511-001",
    "available": true
  }
}

// å›æ‡‰ï¼ˆå·²å­˜åœ¨ï¼‰
{
  "success": true,
  "data": {
    "number": "202511-001",
    "available": false,
    "message": "æ­¤æ”¶æ“šè™Ÿç¢¼å·²å­˜åœ¨",
    "existing_receipt": {
      "receipt_id": "202511-001",
      "client_name": "æ¸¬è©¦ç§‘æŠ€",
      "receipt_date": "2025-11-01"
    }
  }
}
```

**æŸ¥è©¢æ”¶æ“šåˆ—è¡¨ç¯„ä¾‹ï¼š**
```json
// GET /api/v1/receipts?status=unpaid

{
  "success": true,
  "data": [
    {
      "receipt_id": "202511-003",
      "client_id": "12345678",
      "company_name": "æ¸¬è©¦ç§‘æŠ€",
      "receipt_date": "2025-11-01",
      "due_date": "2025-12-05",
      "total_amount": 12000,
      "paid_amount": 0,
      "remaining_amount": 12000,
      "status": "unpaid",
      "days_overdue": 0,
      "client_payment_notes": "ç”±è²¡å‹™é™³å°å§è² è²¬ï¼Œç¿’æ…£æœˆåº•è½‰å¸³",  // â­ JOIN Clients.payment_notes
      "client_notes": "å–œæ­¡æå‰æ”¶åˆ°å ±è¡¨"  // â­ JOIN Clients.client_notesï¼ˆå¯èƒ½ä¹Ÿæœ‰æ”¶æ¬¾æç¤ºï¼‰
    },
    {
      "receipt_id": "202511-005",
      "client_id": "87654321",
      "company_name": "ABCå…¬å¸",
      "receipt_date": "2025-11-05",
      "due_date": "2025-11-28",
      "total_amount": 25000,
      "paid_amount": 0,
      "remaining_amount": 25000,
      "status": "unpaid",
      "days_overdue": 2,
      "is_overdue": true,
      "client_payment_notes": "è«‹æå‰é€šçŸ¥å¼µç¶“ç†",  // â­ é¡¯ç¤ºå®¢æˆ¶æ”¶æ¬¾å‚™è¨»
      "client_notes": "VIPå®¢æˆ¶ï¼Œå„ªå…ˆè™•ç†"  // â­ å®¢æˆ¶å‚™è¨»
    }
  ]
}

/**
 * âš ï¸ é‡è¦èªªæ˜ï¼š
 * 
 * ç‚ºä»€éº¼è¦ JOIN å®¢æˆ¶å‚™è¨»æ¬„ä½ï¼Ÿ
 * - æ¥­å‹™å ±å‘Šç¬¬1140è¡Œè¦æ±‚ï¼šã€ŒæŸ¥è©¢æ‡‰æ”¶å¸³æ¬¾æ™‚é¡¯ç¤ºå®¢æˆ¶æ”¶æ¬¾å‚™è¨»ã€
 * - payment_notesï¼šæ”¶æ¬¾ç›¸é—œè³‡è¨Šï¼ˆä»˜æ¬¾ç¿’æ…£ã€è¯çµ¡çª—å£ã€æ”¶æ¬¾æ–¹å¼ï¼‰
 * - client_notesï¼šå®¢æˆ¶æ¥­å‹™å‚™è¨»ï¼ˆå¯èƒ½åŒ…å«ã€Œä»˜æ¬¾éœ€æå‰é€šçŸ¥ã€ç­‰è³‡è¨Šï¼‰
 * 
 * å‰ç«¯UIæ‡‰é¡¯ç¤ºé€™äº›å‚™è¨»ï¼Œå”åŠ©æ”¶æ¬¾äººå“¡äº†è§£å®¢æˆ¶ç‰¹æ€§ã€‚
 */
```

### æ”¶æ¬¾ç®¡ç† API

```
GET    /api/v1/receipts/:id/payments     æŸ¥è©¢æ”¶æ“šçš„æ”¶æ¬¾è¨˜éŒ„
POST   /api/v1/receipts/:id/payments     è¨˜éŒ„æ”¶æ¬¾
DELETE /api/v1/payments/:id              åˆªé™¤æ”¶æ¬¾è¨˜éŒ„
```

### çµ±è¨ˆå ±è¡¨ API

```
GET    /api/v1/receipts/stats            æ”¶æ“šçµ±è¨ˆ
GET    /api/v1/receipts/ar-aging         æ‡‰æ”¶å¸³æ¬¾å¸³é½¡åˆ†æ
GET    /api/v1/reports/revenue           ç‡Ÿæ”¶å ±è¡¨
```

---

## ğŸ“ API ç¯„ä¾‹

### é–‹ç«‹æ”¶æ“š

**è«‹æ±‚ï¼š**
```json
// POST /api/v1/receipts
{
  "receipt_id": "202510-001",  // å¯é¸ï¼Œä¸æä¾›å‰‡è‡ªå‹•ç”Ÿæˆ
  "is_auto_generated": true,   // true=è‡ªå‹•ç”Ÿæˆï¼Œfalse=æ‰‹å‹•è¼¸å…¥
  "client_id": "12345678",
  "receipt_date": "2025-10-28",
  "due_date": "2025-11-28",
  "items": [
    {
      "service_id": 1,
      "description": "è¨˜å¸³æœå‹™ - 10æœˆ",
      "quantity": 1,
      "unit_price": 5000
    },
    {
      "service_id": 2,
      "description": "å·¥å•†ç™»è¨˜è®Šæ›´",
      "quantity": 1,
      "unit_price": 3000
    }
  ],
  "notes": "æœˆçµ30å¤©"
}
```

**å›æ‡‰ï¼š**
```json
{
  "success": true,
  "data": {
    "receipt_id": "202510-001",
    "client_id": "12345678",
    "company_name": "æ¸¬è©¦å…¬å¸",
    "receipt_date": "2025-10-28",
    "due_date": "2025-11-28",
    "total_amount": 8000,  // ç„¡ç¨…é¡ï¼Œæœƒè¨ˆå¸«äº‹å‹™æ‰€å…ç¨…
    "status": "unpaid",
    "items": [
      {
        "description": "è¨˜å¸³æœå‹™ - 10æœˆ",
        "quantity": 1,
        "unit_price": 5000,
        "amount": 5000
      },
      {
        "description": "å·¥å•†ç™»è¨˜è®Šæ›´",
        "quantity": 1,
        "unit_price": 3000,
        "amount": 3000
      }
    ]
  }
}
```

### è¨˜éŒ„æ”¶æ¬¾

**è«‹æ±‚ï¼š**
```json
// POST /api/v1/receipts/202510-001/payments
{
  "payment_date": "2025-11-05",
  "amount": 8000,
  "payment_method": "è½‰å¸³",
  "reference_number": "20251105001",
  "notes": "å·²ç¢ºèªå…¥å¸³"
}
```

**å›æ‡‰ï¼š**
```json
{
  "success": true,
  "data": {
    "payment_id": 123,
    "receipt_id": "202510-001",
    "payment_date": "2025-11-05",
    "amount": 8000,
    "payment_method": "è½‰å¸³",
    "receipt_status": "paid",  // è‡ªå‹•æ›´æ–°æ”¶æ“šç‹€æ…‹
    "remaining_amount": 0
  }
}
```

### æ‡‰æ”¶å¸³æ¬¾å¸³é½¡åˆ†æ

**è«‹æ±‚ï¼š**
```
GET /api/v1/receipts/ar-aging?as_of_date=2025-10-31
```

**å›æ‡‰ï¼š**
```json
{
  "success": true,
  "data": {
    "as_of_date": "2025-10-31",
    "total_ar": 125000,
    "aging_summary": {
      "current": 45000,        // æœªåˆ°æœŸ
      "overdue_1_30": 30000,   // é€¾æœŸ1-30å¤©
      "overdue_31_60": 25000,  // é€¾æœŸ31-60å¤©
      "overdue_61_90": 15000,  // é€¾æœŸ61-90å¤©
      "overdue_over_90": 10000 // é€¾æœŸè¶…é90å¤©
    },
    "by_client": [
      {
        "client_id": "12345678",
        "company_name": "å®¢æˆ¶A",
        "total_ar": 50000,
        "current": 20000,
        "overdue_1_30": 15000,
        "overdue_31_60": 10000,
        "overdue_61_90": 5000,
        "overdue_over_90": 0,
        "client_payment_notes": "ç”±è²¡å‹™é™³å°å§è² è²¬ï¼Œç¿’æ…£æœˆåº•è½‰å¸³"  // â­ é¡¯ç¤ºå®¢æˆ¶æ”¶æ¬¾å‚™è¨»
      }
    ],
    "details": [
      {
        "receipt_id": "202510-003",
        "client_id": "12345678",
        "company_name": "å®¢æˆ¶A",
        "total_amount": 15000,
        "paid_amount": 0,
        "remaining_amount": 15000,
        "due_date": "2025-10-20",
        "days_overdue": 11,
        "aging_bucket": "overdue_1_30",
        "client_payment_notes": "ç”±è²¡å‹™é™³å°å§è² è²¬ï¼Œç¿’æ…£æœˆåº•è½‰å¸³"  // â­ æ¯ç­†æ”¶æ“šéƒ½é¡¯ç¤º
      }
    ]
  }
}
```

---

## ğŸ¨ å‰ç«¯çµ„ä»¶

### ReceiptListPage.vueï¼ˆæ”¶æ“šåˆ—è¡¨ï¼‰

**åŠŸèƒ½ï¼š**
- é¡¯ç¤ºæ‰€æœ‰æ”¶æ“š
- ç¯©é¸ï¼ˆç‹€æ…‹ã€æ—¥æœŸã€å®¢æˆ¶ï¼‰
- é–‹ç«‹æ–°æ”¶æ“š
- æŸ¥çœ‹æ”¶æ“šè©³æƒ…

**çµ±è¨ˆå¡ç‰‡ï¼š**
- æœªæ”¶æ¬¾é‡‘é¡
- æœ¬æœˆé–‹ç«‹
- é€¾æœŸæœªæ”¶

### ReceiptFormModal.vueï¼ˆæ”¶æ“šè¡¨å–®ï¼‰

**åŠŸèƒ½ï¼š**
- å®¢æˆ¶é¸æ“‡
- æ”¶æ“šè™Ÿç¢¼ï¼ˆè‡ªå‹•/æ‰‹å‹•åˆ‡æ›ï¼‰
- æ”¶æ“šæ—¥æœŸã€åˆ°æœŸæ—¥
- é …ç›®æ˜ç´°ï¼ˆå¯å¤šé …ï¼‰
- ç¸½é‡‘é¡è‡ªå‹•è¨ˆç®—ï¼ˆç„¡ç¨…é¡ï¼‰

**æ”¶æ“šè™Ÿç¢¼åˆ‡æ›ï¼ˆå«å³æ™‚é©—è­‰ï¼‰ï¼š**
```vue
<template>
  <FormGroup label="æ”¶æ“šè™Ÿç¢¼">
    <div class="receipt-number-input">
      <!-- è‡ªå‹•ç”Ÿæˆï¼ˆé è¨­ï¼‰ -->
      <div v-if="!manualMode">
        <StyledInput
          :value="autoGeneratedNumber"
          disabled
          placeholder="å°‡è‡ªå‹•ç”Ÿæˆ"
        />
        <StyledButton
          type="button"
          size="small"
          @click="manualMode = true"
        >
          æ‰‹å‹•è¼¸å…¥
        </StyledButton>
      </div>
      
      <!-- æ‰‹å‹•è¼¸å…¥ï¼ˆå³æ™‚é©—è­‰ï¼‰â­ -->
      <div v-else>
        <StyledInput
          v-model="form.receipt_id"
          placeholder="202510-001"
          pattern="^\\d{6}-\\d{3}$"
          @blur="checkReceiptNumberAvailability"
          :error="receiptNumberError"
          :class="{ 'input-error': receiptNumberError, 'input-success': receiptNumberValid }"
        />
        <span class="hint">æ ¼å¼ï¼šYYYYMM-NNNï¼ˆå¦‚ï¼š202510-001ï¼‰</span>
        
        <!-- â­ å³æ™‚é©—è­‰çµæœ -->
        <div v-if="isCheckingNumber" class="validation-status checking">
          <SpinnerIcon /> æª¢æŸ¥ä¸­...
        </div>
        <div v-else-if="receiptNumberError" class="validation-status error">
          âŒ {{ receiptNumberError }}
        </div>
        <div v-else-if="receiptNumberValid" class="validation-status success">
          âœ… æ­¤è™Ÿç¢¼å¯ç”¨
        </div>
        
        <StyledButton
          type="button"
          size="small"
          @click="manualMode = false; form.receipt_id = null; receiptNumberError = ''"
        >
          ä½¿ç”¨è‡ªå‹•ç·¨è™Ÿ
        </StyledButton>
      </div>
    </div>
  </FormGroup>
</template>

<script setup>
import { ref } from 'vue';
import { checkReceiptNumber } from '@/api/receipts';

const manualMode = ref(false);
const receiptNumberError = ref('');
const receiptNumberValid = ref(false);
const isCheckingNumber = ref(false);

// â­ å³æ™‚æª¢æŸ¥æ”¶æ“šè™Ÿç¢¼æ˜¯å¦å¯ç”¨
async function checkReceiptNumberAvailability() {
  const number = form.value.receipt_id;
  
  if (!number) {
    receiptNumberError.value = '';
    receiptNumberValid.value = false;
    return;
  }
  
  // æª¢æŸ¥æ ¼å¼
  if (!/^\d{6}-\d{3}$/.test(number)) {
    receiptNumberError.value = 'æ ¼å¼éŒ¯èª¤ï¼ˆæ‡‰ç‚ºï¼šYYYYMM-NNNï¼‰';
    receiptNumberValid.value = false;
    return;
  }
  
  // æª¢æŸ¥å”¯ä¸€æ€§ï¼ˆå‘¼å«APIï¼‰
  isCheckingNumber.value = true;
  
  try {
    const response = await checkReceiptNumber(number);
    
    if (response.data.available) {
      receiptNumberError.value = '';
      receiptNumberValid.value = true;
    } else {
      receiptNumberError.value = 'æ­¤æ”¶æ“šè™Ÿç¢¼å·²å­˜åœ¨ï¼Œè«‹æ›´æ›';
      receiptNumberValid.value = false;
    }
  } catch (error) {
    receiptNumberError.value = 'æª¢æŸ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
    receiptNumberValid.value = false;
  } finally {
    isCheckingNumber.value = false;
  }
}
</script>

<style scoped>
.validation-status {
  margin-top: 0.5rem;
  font-size: 0.875rem;
  padding: 0.5rem;
  border-radius: 0.375rem;
}

.validation-status.checking {
  color: #6b7280;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.validation-status.error {
  color: #ef4444;
  background: #fef2f2;
  border: 1px solid #fecaca;
}

.validation-status.success {
  color: #059669;
  background: #d1fae5;
  border: 1px solid #6ee7b7;
}

.input-error { border-color: #ef4444 !important; }
.input-success { border-color: #059669 !important; }
</style>
```

### PaymentRecordModal.vueï¼ˆæ”¶æ¬¾è¨˜éŒ„ï¼‰

**åŠŸèƒ½ï¼š**
- æ”¶æ¬¾æ—¥æœŸ
- æ”¶æ¬¾é‡‘é¡
- æ”¶æ¬¾æ–¹å¼ï¼ˆç¾é‡‘/è½‰å¸³/æ”¯ç¥¨ï¼‰
- åƒè€ƒè™Ÿç¢¼
- è‡ªå‹•æ›´æ–°æ”¶æ“šç‹€æ…‹

### ARAgingReportPage.vueï¼ˆæ‡‰æ”¶å¸³æ¬¾å ±è¡¨ï¼‰

**åŠŸèƒ½ï¼š**
- å¸³é½¡åˆ†æè¡¨
- å¸³é½¡åˆ†å¸ƒåœ“é¤…åœ–
- é€¾æœŸå®¢æˆ¶åˆ—è¡¨
- æ”¶æ¬¾æé†’

---

## ğŸ“Š æ¥­å‹™é‚è¼¯

### æ”¶æ“šç‹€æ…‹è‡ªå‹•æ›´æ–°

```typescript
/**
 * è¨˜éŒ„æ”¶æ¬¾å¾Œè‡ªå‹•æ›´æ–°æ”¶æ“šç‹€æ…‹
 */
async function recordPayment(receiptId: string, paymentData: PaymentData) {
  // 1. è¨˜éŒ„æ”¶æ¬¾
  await db.prepare(`
    INSERT INTO Payments (receipt_id, payment_date, amount, payment_method, reference_number, received_by, notes)
    VALUES (?, ?, ?, ?, ?, ?, ?)
  `).bind(
    receiptId,
    paymentData.payment_date,
    paymentData.amount,
    paymentData.payment_method,
    paymentData.reference_number,
    paymentData.received_by,
    paymentData.notes
  ).run();
  
  // 2. æŸ¥è©¢è©²æ”¶æ“šçš„ç¸½æ”¶æ¬¾é‡‘é¡
  const receipt = await db.prepare(`
    SELECT total_amount FROM Receipts WHERE receipt_id = ?
  `).bind(receiptId).first();
  
  const payments = await db.prepare(`
    SELECT SUM(amount) as total_paid FROM Payments WHERE receipt_id = ?
  `).bind(receiptId).first();
  
  const totalPaid = payments?.total_paid || 0;
  const totalAmount = receipt.total_amount;
  
  // 3. è‡ªå‹•æ›´æ–°æ”¶æ“šç‹€æ…‹
  let status = 'unpaid';
  if (totalPaid >= totalAmount) {
    status = 'paid';  // å·²å…¨é¡æ”¶æ¬¾
  } else if (totalPaid > 0) {
    status = 'partial';  // éƒ¨åˆ†æ”¶æ¬¾
  }
  
  await db.prepare(`
    UPDATE Receipts SET status = ?, updated_at = datetime('now')
    WHERE receipt_id = ?
  `).bind(status, receiptId).run();
  
  return { status, remaining_amount: totalAmount - totalPaid };
}
```

### æ—¥æœŸè¨ˆç®—å·¥å…·å‡½æ•¸

```typescript
/**
 * è¨ˆç®—å…©å€‹æ—¥æœŸä¹‹é–“çš„å¤©æ•¸å·®
 * @param fromDate - èµ·å§‹æ—¥æœŸï¼ˆå¦‚ï¼šåˆ°æœŸæ—¥ï¼‰
 * @param toDate - çµæŸæ—¥æœŸï¼ˆå¦‚ï¼šæŸ¥è©¢æ—¥ï¼‰
 * @returns å¤©æ•¸å·®ï¼ˆæ­£æ•¸è¡¨ç¤ºfromDateåœ¨toDateä¹‹å‰ï¼‰
 */
function getDaysDiff(fromDate: string, toDate: string): number {
  const from = new Date(fromDate);
  const to = new Date(toDate);
  const diffTime = to - from;
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  return diffDays;
}

/**
 * ç¯„ä¾‹ï¼š
 * getDaysDiff('2025-10-31', '2025-12-10') = 40å¤©ï¼ˆé€¾æœŸ40å¤©ï¼‰
 * getDaysDiff('2025-12-05', '2025-11-28') = -7å¤©ï¼ˆå°šæœªåˆ°æœŸï¼Œé‚„æœ‰7å¤©ï¼‰
 */
```

### æ‡‰æ”¶å¸³æ¬¾è¨ˆç®—

```typescript
/**
 * è¨ˆç®—æ‡‰æ”¶å¸³æ¬¾å¸³é½¡ï¼ˆå«å®¢æˆ¶æ”¶æ¬¾å‚™è¨»ï¼‰
 * âš ï¸ é€¾æœŸå¤©æ•¸å¾ã€Œåˆ°æœŸæ—¥ã€é–‹å§‹è¨ˆç®—
 * âš ï¸ å¿…é ˆåŒ…å«å®¢æˆ¶çš„ payment_notesï¼ˆæ”¶æ¬¾å‚™è¨»ï¼‰ï¼Œç”¨æ–¼æé†’æ”¶æ¬¾æ³¨æ„äº‹é …
 */
async function calculateARAging(asOfDate: string) {
  const receipts = await db.prepare(`
    SELECT 
      r.receipt_id,
      r.client_id,
      c.company_name,
      c.payment_notes as client_payment_notes,  -- â­ JOIN å®¢æˆ¶æ”¶æ¬¾å‚™è¨»ï¼ˆæ¥­å‹™å ±å‘Šç¬¬1154è¡Œè¦æ±‚ï¼‰
      c.client_notes,                           -- â­ å®¢æˆ¶å‚™è¨»ï¼ˆå¯èƒ½ä¹Ÿæœ‰æ”¶æ¬¾ç›¸é—œæç¤ºï¼‰
      r.receipt_date,
      r.due_date,
      r.total_amount,
      COALESCE(SUM(p.amount), 0) as paid_amount
    FROM Receipts r
    JOIN Clients c ON r.client_id = c.client_id
    LEFT JOIN Payments p ON r.receipt_id = p.receipt_id
    WHERE r.status != 'paid'
      AND r.status != 'cancelled'
      AND r.is_deleted = 0
    GROUP BY r.receipt_id
  `).all();
  
  const aging = {
    current: 0,
    overdue_1_30: 0,
    overdue_31_60: 0,
    overdue_61_90: 0,
    overdue_over_90: 0
  };
  
  for (const rec of receipts.results) {
    const remaining = rec.total_amount - rec.paid_amount;
    
    // â­ å¾ã€Œåˆ°æœŸæ—¥ã€é–‹å§‹è¨ˆç®—é€¾æœŸå¤©æ•¸
    const daysOverdue = getDaysDiff(rec.due_date, asOfDate);
    
    // åˆ†é¡åˆ°å°æ‡‰çš„å¸³é½¡å€é–“
    if (daysOverdue <= 0) {
      aging.current += remaining;  // æœªåˆ°æœŸæˆ–ä»Šå¤©åˆ°æœŸ
    } else if (daysOverdue <= 30) {
      aging.overdue_1_30 += remaining;  // é€¾æœŸ1-30å¤©
    } else if (daysOverdue <= 60) {
      aging.overdue_31_60 += remaining;  // é€¾æœŸ31-60å¤©
    } else if (daysOverdue <= 90) {
      aging.overdue_61_90 += remaining;  // é€¾æœŸ61-90å¤©
    } else {
      aging.overdue_over_90 += remaining;  // é€¾æœŸè¶…é90å¤©
    }
  }
  
  return aging;
}

/**
 * ç¯„ä¾‹è¨ˆç®—ï¼š
 * 
 * æ”¶æ“šAï¼š
 * - åˆ°æœŸæ—¥ï¼š2025-10-31
 * - æŸ¥è©¢æ—¥ï¼š2025-12-10
 * - é€¾æœŸå¤©æ•¸ï¼šgetDaysDiff('2025-10-31', '2025-12-10') = 40å¤©
 * - åˆ†é¡ï¼šoverdue_31_60ï¼ˆ31-60å¤©å€é–“ï¼‰
 * 
 * æ”¶æ“šBï¼š
 * - åˆ°æœŸæ—¥ï¼š2025-12-15
 * - æŸ¥è©¢æ—¥ï¼š2025-12-10
 * - é€¾æœŸå¤©æ•¸ï¼šgetDaysDiff('2025-12-15', '2025-12-10') = -5å¤©ï¼ˆé‚„æœ‰5å¤©ï¼‰
 * - åˆ†é¡ï¼šcurrentï¼ˆæœªåˆ°æœŸï¼‰
 */
}
```

---

## ğŸ“„ æ”¶æ“šåˆ—å°ç¯„æœ¬

### PDF æ ¼å¼è¦æ ¼

**é é¢è¨­å®šï¼š**
- ç´™å¼µï¼šA4ï¼ˆ210mm Ã— 297mmï¼‰
- é‚Šè·ï¼šä¸Šä¸‹å·¦å³å„20mm
- å­—é«”ï¼šæ¨™æ¥·é«”ï¼ˆç¹é«”ä¸­æ–‡ï¼‰

**æ”¶æ“šç¯„æœ¬çµæ§‹ï¼š**

```typescript
/**
 * ç”Ÿæˆæ”¶æ“šPDF
 */
async function generateReceiptPDF(receiptId: string): Promise<PDFDocument> {
  const receipt = await getReceiptDetails(receiptId);
  const client = await getClient(receipt.client_id);
  const company = await getCompanySettings();
  
  const pdfContent = {
    // ========== é é¦–ï¼ˆ20% é«˜åº¦ï¼‰==========
    header: {
      logo: {
        url: company.logo_url || '/images/logo.png',
        position: 'top-left',
        size: '80px Ã— 40px'
      },
      company_info: {
        name: company.company_name || 'éœçˆ¾æœæ–¯æœƒè¨ˆå¸«äº‹å‹™æ‰€',
        address: company.address || 'å°ä¸­å¸‚è¥¿å€å»ºåœ‹è·¯21è™Ÿ3æ¨“ä¹‹1',
        phone: company.phone || '04-2220-5606',
        email: company.email || 'contact@horgoscpa.com',
        position: 'top-right',
        font_size: '10pt'
      }
    },
    
    // ========== æ”¶æ“šæ¨™é¡Œï¼ˆ10% é«˜åº¦ï¼‰==========
    title: {
      text: 'æ”¶ã€€æ“š',
      font_size: '24pt',
      font_weight: 'bold',
      alignment: 'center',
      margin_top: '30mm'
    },
    
    // ========== æ”¶æ“šè³‡è¨Šï¼ˆ15% é«˜åº¦ï¼‰==========
    receipt_info: {
      layout: 'two-columns',
      left_column: {
        receipt_number: {
          label: 'æ”¶æ“šç·¨è™Ÿï¼š',
          value: receipt.receipt_id,  // 202511-001
          font_size: '12pt'
        },
        receipt_date: {
          label: 'é–‹ç«‹æ—¥æœŸï¼š',
          value: formatDate(receipt.receipt_date),  // 2025å¹´11æœˆ01æ—¥
          font_size: '12pt'
        }
      },
      right_column: {
        client_name: {
          label: 'å®¢æˆ¶åç¨±ï¼š',
          value: client.company_name,
          font_size: '12pt'
        },
        client_tax_id: {
          label: 'çµ±ä¸€ç·¨è™Ÿï¼š',
          value: receipt.client_id,
          font_size: '12pt'
        }
      }
    },
    
    // ========== é …ç›®æ˜ç´°è¡¨æ ¼ï¼ˆ40% é«˜åº¦ï¼‰==========
    items_table: {
      columns: [
        { header: 'é …ç›®èªªæ˜', width: '50%', align: 'left' },
        { header: 'æ•¸é‡', width: '15%', align: 'center' },
        { header: 'å–®åƒ¹', width: '17.5%', align: 'right' },
        { header: 'é‡‘é¡', width: '17.5%', align: 'right' }
      ],
      rows: receipt.items.map(item => ({
        description: item.description,
        quantity: item.quantity,
        unit_price: formatCurrency(item.unit_price),
        amount: formatCurrency(item.amount)
      })),
      footer_row: {
        label: 'åˆè¨ˆé‡‘é¡',
        amount: formatCurrency(receipt.total_amount),
        font_size: '14pt',
        font_weight: 'bold'
      }
    },
    
    // ========== å‚™è¨»å€ï¼ˆ10% é«˜åº¦ï¼‰==========
    notes: {
      label: 'å‚™è¨»ï¼š',
      value: receipt.notes || '',
      font_size: '10pt',
      color: '#666666'
    },
    
    // ========== é å°¾ï¼ˆ5% é«˜åº¦ï¼‰==========
    footer: {
      notice: {
        text: 'â€» æ­¤ç‚ºæ”¶æ“šï¼Œéçµ±ä¸€ç™¼ç¥¨',
        font_size: '9pt',
        font_style: 'italic',
        color: '#999999',
        alignment: 'center'
      },
      signature: {
        label: 'ç¶“è¾¦äººå“¡ï¼š',
        value: receipt.created_by_name,
        position: 'bottom-right',
        font_size: '10pt'
      }
    }
  };
  
  return generatePDF(pdfContent);
}
```

**å¯¦éš›PDFç¯„ä¾‹ä½ˆå±€ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Logo]                         éœçˆ¾æœæ–¯æœƒè¨ˆå¸«äº‹å‹™æ‰€              â”‚
â”‚                          å°ä¸­å¸‚è¥¿å€å»ºåœ‹è·¯21è™Ÿ3æ¨“ä¹‹1                    â”‚
â”‚                                é›»è©±ï¼š04-2220-5606            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚                         æ”¶ã€€æ“š                               â”‚
â”‚                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ”¶æ“šç·¨è™Ÿï¼š202511-001              å®¢æˆ¶åç¨±ï¼šæ¸¬è©¦ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸ â”‚
â”‚ é–‹ç«‹æ—¥æœŸï¼š2025å¹´11æœˆ01æ—¥          çµ±ä¸€ç·¨è™Ÿï¼š12345678          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ é …ç›®èªªæ˜            â”‚ æ•¸é‡ â”‚    å–®åƒ¹    â”‚    é‡‘é¡     â”‚  â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚ â”‚ è¨˜å¸³æœå‹™ - 11æœˆ     â”‚  1   â”‚  8,000    â”‚   8,000    â”‚  â”‚
â”‚ â”‚ ç‡Ÿæ¥­ç¨…ç”³å ±          â”‚  1   â”‚  3,000    â”‚   3,000    â”‚  â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚ â”‚ åˆè¨ˆé‡‘é¡                                  â”‚  11,000   â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚ å‚™è¨»ï¼šæœˆçµ30å¤©                                               â”‚
â”‚                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           â€» æ­¤ç‚ºæ”¶æ“šï¼Œéçµ±ä¸€ç™¼ç¥¨                             â”‚
â”‚                                         ç¶“è¾¦äººå“¡ï¼šç‹å°æ˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**API ç«¯é»ï¼š**
```
GET /api/v1/receipts/:id/pdf          ç”Ÿæˆæ”¶æ“šPDF
GET /api/v1/receipts/:id/preview      é è¦½æ”¶æ“šï¼ˆHTMLï¼‰
```

---

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

- åŒç§’ä½µç™¼å…©äººé–‹ç«‹æ”¶æ“š â†’ æ”¶æ“šè™Ÿç¢¼æ‡‰ä¸é‡è¤‡ï¼ˆåŸå­æ“ä½œï¼‰
- é–‹ç«‹ç¬¬ 1000 å¼µï¼ˆç•¶æœˆï¼‰â†’ æ‡‰æ‹’çµ•ä¸¦æç¤ºè¶…é 999 ä¸Šé™
- ä½œå»¢å¾Œå˜—è©¦æŸ¥è©¢ â†’ åˆ—è¡¨é è¨­ä¸å¯è¦‹ï¼›å¾©åŸå¾Œå¯å†æ¬¡æŸ¥åˆ°
- å¤šç­†éƒ¨åˆ†æ”¶æ¬¾ â†’ æ‡‰æ­£ç¢ºç´¯è¨ˆã€çµ±è¨ˆæ•¸æ“šä¸€è‡´
- ç”Ÿæˆ PDF èˆ‡ HTML é è¦½ â†’ æª”æ¡ˆå¯é–‹å•Ÿã€ç‰ˆé¢æ­£ç¢º

## âš ï¸ æ³¨æ„äº‹é …

1. **æœƒè¨ˆå¸«äº‹å‹™æ‰€ç‰¹æ€§**ï¼šé–‹ç«‹æ”¶æ“šè€Œéç™¼ç¥¨ï¼Œç„¡éœ€è¨ˆç®—ç‡Ÿæ¥­ç¨…
2. **æ”¶æ“šè™Ÿç¢¼å”¯ä¸€æ€§**ï¼šä½¿ç”¨åŸå­æ“ä½œï¼ˆUPSERT + RETURNINGï¼‰ç¢ºä¿ä½µç™¼å®‰å…¨ï¼Œé¿å…é‡è¤‡
3. **ä½µç™¼è™•ç†**ï¼šå¤šäººåŒæ™‚é–‹æ”¶æ“šæ™‚ï¼Œç³»çµ±è‡ªå‹•åˆ†é…ä¸åŒè™Ÿç¢¼ï¼Œç„¡éœ€æ‰‹å‹•é‡è©¦
4. **æµæ°´è™Ÿä¸Šé™**ï¼šæ¯æœˆæœ€å¤š999å¼µæ”¶æ“šï¼Œè¶…ééœ€æ›´æ›æ ¼å¼
5. **éƒ¨åˆ†æ”¶æ¬¾**ï¼šæ”¯æ´å¤šæ¬¡æ”¶æ¬¾ï¼Œè‡ªå‹•ç´¯è¨ˆ
6. **æ”¶æ“šä½œå»¢**ï¼šä½¿ç”¨è»Ÿåˆªé™¤ï¼Œå¯æ¢å¾©
7. **æ”¶æ¬¾å‚™è¨»**ï¼šå¯è¨˜éŒ„æ”¶æ¬¾ç›¸é—œè³‡è¨Šï¼ˆå¦‚ï¼šè¯çµ¡çª—å£ã€ä»˜æ¬¾ç¿’æ…£ç­‰ï¼‰
8. **æ”¶æ“šåˆ—å°**ï¼šâ­ æä¾›PDFæ ¼å¼ï¼Œå¯ç›´æ¥åˆ—å°æˆ–Emailå¯„é€

---

**ç›¸é—œæ–‡æª”ï¼š**
- [å®¢æˆ¶ç®¡ç†-å®Œæ•´è¦æ ¼](./å®¢æˆ¶ç®¡ç†-å®Œæ•´è¦æ ¼.md)
- [å ±è¡¨åˆ†æ-å®Œæ•´è¦æ ¼](./å ±è¡¨åˆ†æ-å®Œæ•´è¦æ ¼.md)
- [é™„ä»¶ç³»çµ±-å®Œæ•´è¦æ ¼](./é™„ä»¶ç³»çµ±-å®Œæ•´è¦æ ¼.md)


