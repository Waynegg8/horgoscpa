# å‡æœŸç®¡ç† - å®Œæ•´é–‹ç™¼è¦æ ¼

**çµ¦ AIï¼š** å¯¦ç¾å‡æœŸç®¡ç†åŠŸèƒ½çš„å®Œæ•´æŠ€è¡“è¦æ ¼

---

## ğŸ’¾ è³‡æ–™è¡¨

### LeaveApplications
```sql
CREATE TABLE LeaveApplications (
  application_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  leave_type_id INTEGER NOT NULL,
  start_date TEXT NOT NULL,
  end_date TEXT NOT NULL,
  days REAL NOT NULL,
  hours REAL,
  reason TEXT,
  event_type TEXT,                      -- å¦‚æœæ˜¯ç”Ÿæ´»äº‹ä»¶ç”¢ç”Ÿçš„
  counts_as_sick_leave BOOLEAN DEFAULT 0,  -- â­ ç”Ÿç†å‡å°ˆç”¨ï¼šæ˜¯å¦ä½µå…¥ç—…å‡ï¼ˆç¬¬4æ—¥èµ·ï¼‰
  applied_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,         -- â­ è»Ÿåˆªé™¤æ¨™è¨˜
  deleted_at TEXT,                      -- â­ åˆªé™¤æ™‚é–“
  deleted_by INTEGER,                   -- â­ åˆªé™¤äººå“¡
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (leave_type_id) REFERENCES LeaveTypes(leave_type_id),
  FOREIGN KEY (deleted_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_leave_apps_user ON LeaveApplications(user_id);
CREATE INDEX idx_leave_apps_date ON LeaveApplications(start_date, end_date);
CREATE INDEX idx_leave_apps_user_date ON LeaveApplications(user_id, start_date, end_date);  -- â­ å‡æœŸæŸ¥è©¢å°ˆç”¨
CREATE INDEX idx_leave_apps_type_year ON LeaveApplications(leave_type_id, start_date);  -- â­ å‡æœŸçµ±è¨ˆå°ˆç”¨
```

**ç´¢å¼•ä½¿ç”¨èªªæ˜ï¼š**
```
idx_leave_apps_user_date: â­ æ–°å¢
  ç”¨é€”ï¼šæŸ¥è©¢å“¡å·¥æŸæ™‚é–“å€é–“çš„è«‹å‡è¨˜éŒ„
  æŸ¥è©¢ï¼šWHERE user_id = ? AND start_date <= ? AND end_date >= ?
  æ•ˆèƒ½æå‡ï¼šé¿å…é‡ç–Šå‡æœŸæª¢æŸ¥æ™‚çš„å…¨è¡¨æƒæ
```

### LeaveTypesï¼ˆå‡åˆ¥é¡å‹ï¼‰
```sql
CREATE TABLE LeaveTypes (
  leave_type_id INTEGER PRIMARY KEY AUTOINCREMENT,
  type_name TEXT UNIQUE NOT NULL,
  annual_quota REAL,                    -- å¹´åº¦é¡åº¦ï¼ˆå¤©ï¼‰
  deduct_leave BOOLEAN DEFAULT 1,       -- æ˜¯å¦æ‰£å‡
  is_paid BOOLEAN DEFAULT 1,            -- æ˜¯å¦æœ‰è–ª
  affects_attendance BOOLEAN DEFAULT 1, -- æ˜¯å¦å½±éŸ¿å…¨å‹¤
  gender_specific TEXT,                 -- 'M'=ç”·æ€§é™å®š,'F'=å¥³æ€§é™å®š,NULL=ä¸é™
  is_enabled BOOLEAN DEFAULT 1
);

-- é è¨­å‡åˆ¥ï¼ˆâš ï¸ æ³¨æ„æ€§åˆ¥é™åˆ¶ï¼‰
INSERT INTO LeaveTypes VALUES
  (1, 'ç‰¹ä¼‘', NULL, 1, 1, 0, NULL, 1),      -- ä¾å¹´è³‡è¨ˆç®—ï¼Œä¸å½±éŸ¿å…¨å‹¤
  (2, 'ç—…å‡', 30, 1, 1, 1, NULL, 1),        -- å½±éŸ¿å…¨å‹¤
  (3, 'äº‹å‡', 14, 1, 0, 1, NULL, 1),        -- å½±éŸ¿å…¨å‹¤
  (4, 'å©šå‡', 8, 1, 1, 0, NULL, 1),         -- ä¸å½±éŸ¿å…¨å‹¤
  (5, 'ç”¢å‡', 56, 1, 1, 0, 'F', 1),         -- é™å¥³æ€§ï¼Œä¸å½±éŸ¿å…¨å‹¤
  (6, 'ç”¢æª¢å‡', 7, 1, 1, 0, 'F', 1),        -- é™å¥³æ€§ï¼Œä¸å½±éŸ¿å…¨å‹¤
  (7, 'é™ªç”¢æª¢åŠé™ªç”¢å‡', 7, 1, 1, 0, 'M', 1), -- é™ç”·æ€§ï¼Œä¸å½±éŸ¿å…¨å‹¤
  (8, 'ç”Ÿç†å‡', 12, 1, 0.5, 0, 'F', 1),     -- é™å¥³æ€§ï¼ŒåŠè–ªï¼Œä¸å½±éŸ¿å…¨å‹¤
  (9, 'å–ªå‡', NULL, 1, 1, 0, NULL, 1),      -- ä¸å½±éŸ¿å…¨å‹¤
  (10, 'å…¬å‡', NULL, 1, 1, 0, NULL, 1),     -- ä¸å½±éŸ¿å…¨å‹¤
  (11, 'å®¶åº­ç…§é¡§å‡', 7, 1, 0, 0, NULL, 1),  -- ä¸å½±éŸ¿å…¨å‹¤
  (12, 'è£œä¼‘', NULL, 0, 1, 0, NULL, 1),     -- ä¸æ‰£å‡ï¼Œä¸å½±éŸ¿å…¨å‹¤
  (13, 'é¢±é¢¨å‡', NULL, 1, 0, 0, NULL, 1);   -- ä¸å½±éŸ¿å…¨å‹¤
```

### AnnualLeaveRulesï¼ˆç‰¹ä¼‘è¦å‰‡ï¼‰
```sql
CREATE TABLE AnnualLeaveRules (
  rule_id INTEGER PRIMARY KEY AUTOINCREMENT,
  min_months INTEGER NOT NULL,
  max_months INTEGER NOT NULL,
  days INTEGER NOT NULL
);

-- æ³•å®šç‰¹ä¼‘ï¼ˆå‹åŸºæ³•ç¬¬38æ¢ï¼‰
INSERT INTO AnnualLeaveRules VALUES
  (1, 6, 12, 3),       -- 6å€‹æœˆ-1å¹´ï¼š3å¤©
  (2, 12, 24, 7),      -- 1-2å¹´ï¼š7å¤©
  (3, 24, 36, 10),     -- 2-3å¹´ï¼š10å¤©
  (4, 36, 60, 14),     -- 3-5å¹´ï¼š14å¤©
  (5, 60, 120, 15),    -- 5-10å¹´ï¼š15å¤©
  (6, 120, 132, 16),   -- 10-11å¹´ï¼š16å¤©
  (7, 132, 144, 17),   -- 11-12å¹´ï¼š17å¤©
  (8, 144, 156, 18),   -- 12-13å¹´ï¼š18å¤©
  (9, 156, 168, 19),   -- 13-14å¹´ï¼š19å¤©
  (10, 168, 180, 20),  -- 14-15å¹´ï¼š20å¤©
  -- ... ä»¥æ­¤é¡æ¨ï¼Œæ¯æ»¿1å¹´åŠ 1å¤©ï¼Œæœ€é«˜30å¤©
  (11, 300, 999999, 30); -- 25å¹´ä»¥ä¸Šï¼š30å¤©ï¼ˆä¸Šé™ï¼‰
```

### AnnualLeaveBalanceï¼ˆç‰¹ä¼‘é¤˜é¡ï¼‰âš ï¸ ç´¯ç©åˆ¶
```sql
CREATE TABLE AnnualLeaveBalance (
  balance_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  year INTEGER NOT NULL,                -- å¹´åº¦
  entitled_days REAL NOT NULL,          -- ç•¶å¹´åº¦æ–°å¢ç‰¹ä¼‘
  carried_over_days REAL DEFAULT 0,     -- å»å¹´éå»¶ç‰¹ä¼‘ï¼ˆç´¯ç©ï¼‰
  used_days REAL DEFAULT 0,             -- å·²ä½¿ç”¨å¤©æ•¸
  remaining_days REAL NOT NULL,         -- å‰©é¤˜å¤©æ•¸
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  UNIQUE(user_id, year)
);

CREATE INDEX idx_annual_leave_balance_user ON AnnualLeaveBalance(user_id);
CREATE INDEX idx_annual_leave_balance_year ON AnnualLeaveBalance(year);
```

### OtherLeaveRulesï¼ˆå…¶ä»–å‡æœŸè¦å‰‡ï¼‰
```sql
CREATE TABLE OtherLeaveRules (
  rule_id INTEGER PRIMARY KEY AUTOINCREMENT,
  leave_type_id INTEGER NOT NULL,
  event_type TEXT NOT NULL,             -- 'çµå©š','ç”Ÿè‚²','çˆ¶æ¯éä¸–'ç­‰
  days REAL NOT NULL,
  validity_days INTEGER DEFAULT 365,
  
  FOREIGN KEY (leave_type_id) REFERENCES LeaveTypes(leave_type_id)
);

-- é è¨­è¦å‰‡
INSERT INTO OtherLeaveRules VALUES
  (1, 4, 'çµå©š', 8, 365),
  (2, 5, 'ç”Ÿè‚²', 56, 0),
  (3, 6, 'é…å¶ç”Ÿè‚²', 7, 15),
  (4, 7, 'çˆ¶æ¯éä¸–', 8, 365),
  (5, 7, 'é…å¶éä¸–', 8, 365),
  (6, 7, 'ç¥–çˆ¶æ¯éä¸–', 6, 365);
```

### LifeEventLeaveGrantsï¼ˆç”Ÿæ´»äº‹ä»¶å‡æœŸé¡åº¦ï¼‰â­ æ–°å¢

**è¨­è¨ˆç†ç”±ï¼š** è¿½è¹¤ç”Ÿæ´»äº‹ä»¶ç”¢ç”Ÿçš„å‡æœŸé¤˜é¡å’Œæœ‰æ•ˆæœŸï¼ˆå¦‚ï¼šå©šå‡8å¤©ï¼Œ1å¹´å…§åˆ†æ¬¡ä½¿ç”¨ï¼‰

```sql
CREATE TABLE LifeEventLeaveGrants (
  grant_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  leave_type_id INTEGER NOT NULL,       -- å‡åˆ¥ï¼ˆå©šå‡ã€å–ªå‡ç­‰ï¼‰
  event_type TEXT NOT NULL,             -- äº‹ä»¶é¡å‹ï¼ˆ'çµå©š'ã€'çˆ¶æ¯éä¸–'ç­‰ï¼‰
  event_date TEXT NOT NULL,             -- äº‹ä»¶ç™¼ç”Ÿæ—¥æœŸ
  total_days REAL NOT NULL,             -- ç¸½é¡åº¦ï¼ˆå¦‚ï¼š8å¤©ï¼‰
  used_days REAL DEFAULT 0,             -- å·²ä½¿ç”¨å¤©æ•¸
  remaining_days REAL NOT NULL,         -- å‰©é¤˜å¤©æ•¸
  valid_from TEXT NOT NULL,             -- æœ‰æ•ˆæœŸèµ·å§‹æ—¥
  valid_until TEXT NOT NULL,            -- æœ‰æ•ˆæœŸçµæŸæ—¥
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (leave_type_id) REFERENCES LeaveTypes(leave_type_id)
);

CREATE INDEX idx_life_event_grants_user ON LifeEventLeaveGrants(user_id);
CREATE INDEX idx_life_event_grants_valid ON LifeEventLeaveGrants(valid_until);
CREATE INDEX idx_life_event_grants_type ON LifeEventLeaveGrants(leave_type_id);

/**
 * ç¯„ä¾‹è³‡æ–™ï¼š
 * 
 * å“¡å·¥Bç™»è¨˜ã€Œçµå©šã€äº‹ä»¶ï¼ˆ2025-12-15ï¼‰ï¼š
 * INSERT INTO LifeEventLeaveGrants VALUES
 * (1, 2, 4, 'çµå©š', '2025-12-15', 8.0, 0.0, 8.0, '2025-12-15', '2026-12-14', ...);
 * 
 * ä½¿ç”¨ç‹€æ…‹è¿½è¹¤ï¼š
 * - 12æœˆè«‹5å¤©å©šå‡ â†’ used_days = 5.0, remaining_days = 3.0
 * - å‰©é¤˜3å¤©å¯åœ¨ 2026-12-14 å‰ä½¿ç”¨
 * - è¶…éæœ‰æ•ˆæœŸ â†’ è‡ªå‹•å¤±æ•ˆï¼ˆæˆ–ç”±Cron Jobæ¨™è¨˜ç‚ºéæœŸï¼‰
 */
```

### CronJobExecutionsï¼ˆå®šæ™‚ä»»å‹™åŸ·è¡Œè¨˜éŒ„ï¼‰â­

**æ³¨æ„ï¼š** æ­¤è¡¨å®šç¾©åœ¨ [ç³»çµ±åŸºç¤-å®Œæ•´è¦æ ¼.md](./ç³»çµ±åŸºç¤-å®Œæ•´è¦æ ¼.md) ä¸­ï¼Œæ­¤è™•åƒ…ä¾›åƒè€ƒã€‚

```sql
CREATE TABLE CronJobExecutions (
  execution_id INTEGER PRIMARY KEY AUTOINCREMENT,
  job_name TEXT NOT NULL,               -- ä»»å‹™åç¨±ï¼ˆå¦‚ï¼š'annual_leave_update'ï¼‰
  execution_date TEXT NOT NULL,         -- åŸ·è¡Œæ—¥æœŸï¼ˆå¦‚ï¼š'2026-01-01'ï¼‰
  status TEXT NOT NULL,                 -- 'success', 'failed'
  affected_users INTEGER DEFAULT 0,     -- å½±éŸ¿çš„ç”¨æˆ¶æ•¸
  error_message TEXT,                   -- éŒ¯èª¤è¨Šæ¯ï¼ˆå¤±æ•—æ™‚ï¼‰
  executed_at TEXT DEFAULT (datetime('now')),
  execution_duration_ms INTEGER,        -- åŸ·è¡Œæ™‚é•·ï¼ˆæ¯«ç§’ï¼‰
  
  CHECK (status IN ('success', 'failed'))
);

CREATE INDEX idx_cron_job_name ON CronJobExecutions(job_name);
CREATE INDEX idx_cron_job_date ON CronJobExecutions(execution_date);
CREATE INDEX idx_cron_job_status ON CronJobExecutions(status);
CREATE UNIQUE INDEX idx_cron_job_unique ON CronJobExecutions(job_name, execution_date, status) 
  WHERE status = 'success';  -- åŒä¸€å¤©åŒä¸€ä»»å‹™åªèƒ½æˆåŠŸåŸ·è¡Œä¸€æ¬¡
```

**è©³ç´°è¨­è¨ˆè«‹åƒè€ƒï¼š** [ç³»çµ±åŸºç¤-å®Œæ•´è¦æ ¼.md](./ç³»çµ±åŸºç¤-å®Œæ•´è¦æ ¼.md)

### Notificationsï¼ˆç³»çµ±é€šçŸ¥ï¼‰â­ 

**æ³¨æ„ï¼š** æ­¤è¡¨å®šç¾©åœ¨ [ç³»çµ±åŸºç¤-å®Œæ•´è¦æ ¼.md](./ç³»çµ±åŸºç¤-å®Œæ•´è¦æ ¼.md) ä¸­ï¼Œæ­¤è™•åƒ…ä¾›åƒè€ƒã€‚

```sql
CREATE TABLE Notifications (
  notification_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,             -- é€šçŸ¥å°è±¡ï¼ˆå“¡å·¥æˆ–ç®¡ç†å“¡ï¼‰
  type TEXT NOT NULL,                   -- é€šçŸ¥é¡å‹
  message TEXT NOT NULL,                -- é€šçŸ¥è¨Šæ¯
  related_date TEXT,                    -- é—œè¯æ—¥æœŸï¼ˆå¦‚ï¼šç¼ºå¡«çš„æ—¥æœŸï¼‰
  related_user_id INTEGER,              -- é—œè¯ç”¨æˆ¶ï¼ˆç®¡ç†å“¡çœ‹å“¡å·¥ç¼ºå¡«æ™‚ç”¨ï¼‰
  action_url TEXT,                      -- æ“ä½œé€£çµï¼ˆå¦‚ï¼š/timesheets/new?date=2025-11-26ï¼‰
  auto_dismiss BOOLEAN DEFAULT 1,       -- æ˜¯å¦è‡ªå‹•æ¶ˆå¤±ï¼ˆ1=å•é¡Œè§£æ±ºå¾Œè‡ªå‹•ç§»é™¤ï¼Œ0=éœ€æ‰‹å‹•é—œé–‰ï¼‰
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,         -- æ˜¯å¦å·²ç§»é™¤ï¼ˆ0=é¡¯ç¤ºåœ¨åˆ—è¡¨ï¼Œ1=å·²ç§»é™¤ï¼‰
  dismissed_at TEXT,                    -- ç§»é™¤æ™‚é–“ï¼ˆè‡ªå‹•æˆ–æ‰‹å‹•ï¼‰
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (related_user_id) REFERENCES Users(user_id),
  CHECK (type IN ('missing_timesheet', 'task_overdue', 'leave_pending', 'payment_overdue', 'cron_failed'))
);

CREATE INDEX idx_notifications_user ON Notifications(user_id);
CREATE INDEX idx_notifications_type ON Notifications(type);
CREATE INDEX idx_notifications_deleted ON Notifications(is_deleted);
CREATE INDEX idx_notifications_date ON Notifications(related_date);
CREATE UNIQUE INDEX idx_notifications_unique ON Notifications(user_id, type, related_date, related_user_id) 
  WHERE is_deleted = 0;  -- åŒä¸€ç”¨æˆ¶åŒé¡å‹åŒæ—¥æœŸåªæœ‰ä¸€ç­†æœªç§»é™¤é€šçŸ¥
```

**è©³ç´°è¨­è¨ˆè«‹åƒè€ƒï¼š** [ç³»çµ±åŸºç¤-å®Œæ•´è¦æ ¼.md](./ç³»çµ±åŸºç¤-å®Œæ•´è¦æ ¼.md)

---

## ğŸ”Œ API ç«¯é»

### 1. æ–°å¢å‡æœŸç”³è«‹
```
POST /api/v1/leave/applications
```

**è«‹æ±‚ï¼š**
```json
{
  "leave_type_id": 1,
  "start_date": "2025-11-15",
  "end_date": "2025-11-16",
  "days": 2,
  "reason": "å®¶åº­äº‹å‹™"
}
```

### 2. æŸ¥è©¢å‡æœŸé¤˜é¡
```
GET /api/v1/leave/balance?user_id=1&year=2025
```

**éŸ¿æ‡‰ï¼š**
```json
{
  "success": true,
  "data": {
    "balances": [
      {
        "leave_type": "ç‰¹ä¼‘",
        "entitled_days": 10,
        "used_days": 3,
        "remaining_days": 7
      },
      {
        "leave_type": "ç—…å‡",
        "entitled_days": 30,
        "used_days": 2,
        "remaining_days": 28
      }
    ]
  }
}
```

### 3. æŸ¥è©¢å¯ç”³è«‹çš„å‡åˆ¥ï¼ˆä¾æ€§åˆ¥éæ¿¾ï¼‰â­ æ–°å¢
```
GET /api/v1/leave/available-types?user_id=1
```

**å›æ‡‰ç¯„ä¾‹ï¼ˆå¥³æ€§å“¡å·¥ï¼‰ï¼š**
```json
{
  "success": true,
  "data": [
    { "leave_type_id": 1, "type_name": "ç‰¹ä¼‘", "gender_specific": null },
    { "leave_type_id": 2, "type_name": "ç—…å‡", "gender_specific": null },
    { "leave_type_id": 3, "type_name": "äº‹å‡", "gender_specific": null },
    { "leave_type_id": 4, "type_name": "å©šå‡", "gender_specific": null },
    { "leave_type_id": 5, "type_name": "ç”¢å‡", "gender_specific": "F" },
    { "leave_type_id": 6, "type_name": "ç”¢æª¢å‡", "gender_specific": "F" },
    { "leave_type_id": 8, "type_name": "ç”Ÿç†å‡", "gender_specific": "F" },
    { "leave_type_id": 9, "type_name": "å–ªå‡", "gender_specific": null },
    { "leave_type_id": 10, "type_name": "å…¬å‡", "gender_specific": null }
    // âš ï¸ ä¸åŒ…å«ã€Œé™ªç”¢æª¢åŠé™ªç”¢å‡ã€ï¼ˆleave_type_id = 7ï¼Œé™ç”·æ€§ï¼‰
  ]
}
```

**å›æ‡‰ç¯„ä¾‹ï¼ˆç”·æ€§å“¡å·¥ï¼‰ï¼š**
```json
{
  "success": true,
  "data": [
    { "leave_type_id": 1, "type_name": "ç‰¹ä¼‘", "gender_specific": null },
    { "leave_type_id": 2, "type_name": "ç—…å‡", "gender_specific": null },
    { "leave_type_id": 3, "type_name": "äº‹å‡", "gender_specific": null },
    { "leave_type_id": 4, "type_name": "å©šå‡", "gender_specific": null },
    { "leave_type_id": 7, "type_name": "é™ªç”¢æª¢åŠé™ªç”¢å‡", "gender_specific": "M" },
    { "leave_type_id": 9, "type_name": "å–ªå‡", "gender_specific": null },
    { "leave_type_id": 10, "type_name": "å…¬å‡", "gender_specific": null }
    // âš ï¸ ä¸åŒ…å«ã€Œç”¢å‡ã€ç”¢æª¢å‡ã€ç”Ÿç†å‡ã€ï¼ˆé™å¥³æ€§ï¼‰
  ]
}
```

### 4. ç™»è¨˜ç”Ÿæ´»äº‹ä»¶
```
POST /api/v1/leave/life-events
```

**è«‹æ±‚ï¼š**
```json
{
  "event_type": "çµå©š",
  "event_date": "2025-12-01",
  "description": "å©šç¦®æ—¥æœŸ"
}
```

### 5. æ‰‹å‹•è§¸ç™¼Cron Jobï¼ˆç®¡ç†å“¡å°ˆç”¨ï¼‰â­ æ–°å¢
```
POST /api/v1/admin/cron/execute
æ¬Šé™ï¼šç®¡ç†å“¡
```

**è«‹æ±‚ï¼š**
```json
{
  "job_name": "annual_leave_update",
  "target_date": "2026-01-01"
}
```

**å›æ‡‰ï¼š**
```json
{
  "success": true,
  "data": {
    "job_name": "annual_leave_update",
    "execution_date": "2026-01-01",
    "status": "success",
    "affected_users": 5,
    "execution_duration_ms": 234
  }
}
```

### 6. æŸ¥è©¢Cron JobåŸ·è¡Œæ­·å²ï¼ˆç®¡ç†å“¡å°ˆç”¨ï¼‰â­ æ–°å¢
```
GET /api/v1/admin/cron/history?job_name=annual_leave_update
æ¬Šé™ï¼šç®¡ç†å“¡
```

**å›æ‡‰ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "execution_id": 1,
      "job_name": "annual_leave_update",
      "execution_date": "2026-01-01",
      "status": "success",
      "affected_users": 5,
      "executed_at": "2026-01-01 00:00:15"
    },
    {
      "execution_id": 2,
      "job_name": "annual_leave_update",
      "execution_date": "2025-01-01",
      "status": "success",
      "affected_users": 4,
      "executed_at": "2025-01-01 00:00:08"
    }
  ]
}
```

---

## ğŸ”§ å¾Œç«¯å¯¦ç¾

### LeaveService
```typescript
class LeaveService {
  async applyLeave(data, user) {
    // 0. é©—è­‰æ€§åˆ¥é™åˆ¶ â­ æ–°å¢
    await this.validateGenderRestriction(user.user_id, data.leave_type_id);
    
    // 1. é©—è­‰æ—¥æœŸ
    if (data.end_date < data.start_date) {
      throw new ValidationError('çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ');
    }
    
    // 2. æª¢æŸ¥é¤˜é¡
    const balance = await this.calculateBalance(user.user_id, data.leave_type_id);
    if (balance.remaining < data.days) {
      throw new ValidationError(`å‡æœŸé¤˜é¡ä¸è¶³ï¼Œå‰©é¤˜${balance.remaining}å¤©`);
    }
    
    // 3. æª¢æŸ¥é‡ç–Š
    const overlap = await this.checkOverlap(user.user_id, data.start_date, data.end_date);
    if (overlap) {
      throw new ConflictError('èˆ‡ç¾æœ‰å‡æœŸé‡ç–Š');
    }
    
    // 4. â­ ç”Ÿç†å‡ç‰¹æ®Šè™•ç†ï¼šåˆ¤æ–·æ˜¯å¦ä½µå…¥ç—…å‡
    let countsAsSickLeave = false;
    
    if (data.leave_type_id === 8) {  // ç”Ÿç†å‡
      const currentYear = new Date(data.start_date).getFullYear();
      
      // æŸ¥è©¢ä»Šå¹´å·²è«‹ç”Ÿç†å‡å¤©æ•¸
      const menstrualUsed = await this.db.prepare(`
        SELECT COALESCE(SUM(days), 0) as total
        FROM LeaveApplications
        WHERE user_id = ?
          AND leave_type_id = 8
          AND strftime('%Y', start_date) = ?
          AND is_deleted = 0
      `).bind(user.user_id, currentYear.toString()).first();
      
      const totalMenstrualDays = (menstrualUsed?.total || 0) + data.days;
      
      // åˆ¤æ–·æ˜¯å¦è¶…é3æ—¥
      if (totalMenstrualDays > 3) {
        countsAsSickLeave = true;  // è¶…ééƒ¨åˆ†ä½µå…¥ç—…å‡
        
        // é¡å¤–æª¢æŸ¥ï¼šç—…å‡é¡åº¦æ˜¯å¦è¶³å¤ 
        const sickBalance = await this.calculateBalance(user.user_id, 2);  // 2=ç—…å‡
        const overDays = totalMenstrualDays - 3;  // è¶…éçš„å¤©æ•¸
        
        if (sickBalance.remaining < overDays) {
          throw new ValidationError(
            `ç”Ÿç†å‡è¶…é3æ—¥çš„éƒ¨åˆ†æœƒä½µå…¥ç—…å‡è¨ˆç®—ï¼Œä½†æ‚¨çš„ç—…å‡é¤˜é¡ä¸è¶³ã€‚` +
            `è¶…éå¤©æ•¸ï¼š${overDays}å¤©ï¼Œç—…å‡é¤˜é¡ï¼š${sickBalance.remaining}å¤©`
          );
        }
      }
    }
    
    // 5. å‰µå»ºç”³è«‹
    return await this.repository.create({
      ...data,
      user_id: user.user_id,
      counts_as_sick_leave: countsAsSickLeave  // â­ è¨˜éŒ„æ˜¯å¦ä½µå…¥ç—…å‡
    });
  }
  
  async calculateBalance(userId, leaveTypeId, year) {
    const leaveType = await this.getLeaveType(leaveTypeId);
    
    let entitled = 0;
    
    if (leaveType.type_name === 'ç‰¹ä¼‘') {
      // æ ¹æ“šå¹´è³‡è¨ˆç®—
      const user = await this.userRepo.findById(userId);
      const months = this.calculateMonths(user.start_date, new Date());
      const rule = await this.getAnnualLeaveRule(months);
      entitled = rule.days;
    } else if (leaveType.annual_quota) {
      // å›ºå®šé¡åº¦
      entitled = leaveType.annual_quota;
    } else {
      // äº‹ä»¶çµ¦å‡ï¼ˆæŸ¥è©¢ç”Ÿæ´»äº‹ä»¶ï¼‰
      entitled = await this.calculateEventLeave(userId, leaveTypeId);
    }
    
    // è¨ˆç®—å·²ç”¨
    const used = await this.repository.sumUsedDays(userId, leaveTypeId, year);
    
    return {
      entitled_days: entitled,
      used_days: used,
      remaining_days: entitled - used
    };
  }
  
  async registerLifeEvent(eventType, eventDate, user) {
    // 1. æŸ¥è©¢å°æ‡‰è¦å‰‡
    const rule = await this.getOtherLeaveRule(eventType);
    if (!rule) {
      throw new NotFoundError('æ‰¾ä¸åˆ°å°æ‡‰çš„å‡æœŸè¦å‰‡');
    }
    
    // 2. æª¢æŸ¥æ˜¯å¦å·²ç™»è¨˜éï¼ˆé¿å…é‡è¤‡ï¼Œå¦‚ï¼šåŒä¸€å¹´çµå…©æ¬¡å©šï¼‰
    const existingGrant = await this.db.prepare(`
      SELECT * FROM LifeEventLeaveGrants
      WHERE user_id = ?
        AND event_type = ?
        AND event_date = ?
        AND is_deleted = 0
    `).bind(user.user_id, eventType, eventDate).first();
    
    if (existingGrant) {
      throw new ConflictError('æ­¤ç”Ÿæ´»äº‹ä»¶å·²ç™»è¨˜é');
    }
    
    // 3. è¨ˆç®—æœ‰æ•ˆæœŸ
    const validFrom = eventDate;
    const validUntil = this.addDays(eventDate, rule.validity_days);
    
    // 4. å‰µå»ºå‡æœŸé¡åº¦è¨˜éŒ„ â­
    const result = await this.db.prepare(`
      INSERT INTO LifeEventLeaveGrants (
        user_id, leave_type_id, event_type, event_date,
        total_days, remaining_days, valid_from, valid_until
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      user.user_id,
      rule.leave_type_id,
      eventType,
      eventDate,
      rule.days,
      rule.days,  // åˆå§‹ remaining = total
      validFrom,
      validUntil
    ).run();
    
    return {
      grant_id: result.meta.last_row_id,
      leave_type: rule.leave_type_name,
      event_type: eventType,
      event_date: eventDate,
      total_days: rule.days,
      remaining_days: rule.days,
      valid_from: validFrom,
      valid_until: validUntil
    };
  }
  
  /**
   * ç”³è«‹ç”Ÿæ´»äº‹ä»¶å‡æœŸæ™‚çš„é¤˜é¡é©—è­‰ â­
   */
  async applyLifeEventLeave(data, user) {
    // 1. æŸ¥è©¢å¯ç”¨çš„ç”Ÿæ´»äº‹ä»¶å‡æœŸé¡åº¦
    const grants = await this.db.prepare(`
      SELECT * FROM LifeEventLeaveGrants
      WHERE user_id = ?
        AND leave_type_id = ?
        AND remaining_days > 0
        AND valid_until >= ?
        AND is_deleted = 0
      ORDER BY event_date ASC
    `).bind(user.user_id, data.leave_type_id, data.start_date).all();
    
    if (grants.results.length === 0) {
      throw new ValidationError('æ²’æœ‰å¯ç”¨çš„ç”Ÿæ´»äº‹ä»¶å‡æœŸé¡åº¦ï¼Œæˆ–é¡åº¦å·²éæœŸ');
    }
    
    // 2. è¨ˆç®—ç¸½å¯ç”¨å¤©æ•¸
    const totalAvailable = grants.results.reduce((sum, g) => sum + g.remaining_days, 0);
    
    if (totalAvailable < data.days) {
      throw new ValidationError(
        `å‡æœŸé¡åº¦ä¸è¶³ã€‚å¯ç”¨ï¼š${totalAvailable}å¤©ï¼Œç”³è«‹ï¼š${data.days}å¤©`
      );
    }
    
    // 3. é©—è­‰ç”³è«‹æ—¥æœŸåœ¨æœ‰æ•ˆæœŸå…§
    const grant = grants.results[0];  // ä½¿ç”¨æœ€æ—©çš„é¡åº¦ï¼ˆFIFOï¼‰
    if (data.start_date < grant.valid_from || data.end_date > grant.valid_until) {
      throw new ValidationError(
        `è«‹å‡æ—¥æœŸå¿…é ˆåœ¨æœ‰æ•ˆæœŸå…§ï¼ˆ${grant.valid_from} ~ ${grant.valid_until}ï¼‰`
      );
    }
    
    // 4. å‰µå»ºè«‹å‡ç”³è«‹
    const application = await this.repository.create({
      ...data,
      user_id: user.user_id,
      event_type: grant.event_type
    });
    
    // 5. æ‰£é™¤é¡åº¦ï¼ˆå„ªå…ˆä½¿ç”¨æœ€æ—©çš„é¡åº¦ï¼ŒFIFOï¼‰
    let remainingToDeduct = data.days;
    
    for (const grant of grants.results) {
      if (remainingToDeduct <= 0) break;
      
      const deductFromThis = Math.min(grant.remaining_days, remainingToDeduct);
      
      await this.db.prepare(`
        UPDATE LifeEventLeaveGrants
        SET used_days = used_days + ?,
            remaining_days = remaining_days - ?
        WHERE grant_id = ?
      `).bind(deductFromThis, deductFromThis, grant.grant_id).run();
      
      remainingToDeduct -= deductFromThis;
    }
    
    return application;
  }
  
  /**
   * ç¯„ä¾‹ï¼š
   * 
   * 1. å“¡å·¥Bç™»è¨˜çµå©šï¼ˆ2025-12-15ï¼‰
   *    â†’ å‰µå»º grantï¼š8å¤©å©šå‡ï¼Œæœ‰æ•ˆæœŸè‡³ 2026-12-14
   * 
   * 2. 12æœˆè«‹5å¤©å©šå‡ï¼ˆ2025-12-16 ~ 2025-12-20ï¼‰
   *    â†’ used_days = 5, remaining_days = 3
   * 
   * 3. 2026å¹´6æœˆå†è«‹3å¤©å©šå‡ï¼ˆ2026-06-10 ~ 2026-06-12ï¼‰
   *    â†’ é©—è­‰ï¼š2026-06-12 < 2026-12-14 âœ… æœ‰æ•ˆ
   *    â†’ used_days = 8, remaining_days = 0
   * 
   * 4. 2026å¹´12æœˆæƒ³å†è«‹å©šå‡
   *    â†’ æŸ¥è©¢ï¼šremaining_days = 0 ä¸” valid_until å·²é
   *    â†’ æ‹‹å‡ºéŒ¯èª¤ï¼šã€Œæ²’æœ‰å¯ç”¨çš„ç”Ÿæ´»äº‹ä»¶å‡æœŸé¡åº¦ã€
   */
}
```

---

## âœ… æ¥­å‹™è¦å‰‡

### å‡æœŸé¤˜é¡è¨ˆç®—

#### ç‰¹ä¼‘ï¼ˆä¾å¹´è³‡ï¼Œâš ï¸ ç´¯ç©åˆ¶ï¼‰

**é‡è¦èªªæ˜ï¼š** ç‰¹ä¼‘æ¡ç´¯ç©åˆ¶ï¼Œå»å¹´å‰©é¤˜ç‰¹ä¼‘æœƒç´¯ç©åˆ°ä»Šå¹´ï¼Œä¸æœƒæ­¸é›¶ã€‚

```typescript
/**
 * è¨ˆç®—ç‰¹ä¼‘é¤˜é¡ï¼ˆå«ç´¯ç©ï¼‰
 */
async function calculateAnnualLeaveBalance(userId: number, year: number) {
  // 1. æŸ¥è©¢å“¡å·¥åˆ°è·æ—¥
  const user = await db.prepare(
    'SELECT join_date FROM Users WHERE user_id = ?'
  ).bind(userId).first();
  
  // 2. è¨ˆç®—å¹´è³‡ï¼ˆæœˆæ•¸ï¼‰
  const joinDate = new Date(user.join_date);
  const currentDate = new Date(year, 11, 31); // ç•¶å¹´åº¦12æœˆ31æ—¥
  const months = calculateMonths(joinDate, currentDate);
  
  // 3. æŸ¥è©¢ç•¶å¹´åº¦æ‡‰å¾—ç‰¹ä¼‘
  const rule = await db.prepare(`
    SELECT days FROM AnnualLeaveRules
    WHERE min_months <= ? AND max_months > ?
  `).bind(months, months).first();
  
  const entitledDays = rule?.days || 0;
  
  // 4. æŸ¥è©¢å»å¹´å‰©é¤˜ç‰¹ä¼‘ï¼ˆç´¯ç©ï¼‰
  const lastYearBalance = await db.prepare(`
    SELECT remaining_days FROM AnnualLeaveBalance
    WHERE user_id = ? AND year = ?
  `).bind(userId, year - 1).first();
  
  const carriedOverDays = lastYearBalance?.remaining_days || 0;
  
  // 5. æŸ¥è©¢ä»Šå¹´å·²ä½¿ç”¨å¤©æ•¸
  const usedDays = await db.prepare(`
    SELECT SUM(days) as total FROM LeaveApplications
    WHERE user_id = ?
      AND leave_type_id = 1  -- ç‰¹ä¼‘
      AND strftime('%Y', start_date) = ?
  `).bind(userId, year.toString()).first();
  
  const used = usedDays?.total || 0;
  
  // 6. è¨ˆç®—å‰©é¤˜ç‰¹ä¼‘
  const remaining = entitledDays + carriedOverDays - used;
  
  return {
    entitled_days: entitledDays,      // ç•¶å¹´æ–°å¢
    carried_over_days: carriedOverDays, // å»å¹´ç´¯ç©
    used_days: used,
    remaining_days: remaining,
    total_available: entitledDays + carriedOverDays  // ç¸½å¯ç”¨
  };
}

/**
 * ç¯„ä¾‹ï¼š
 * 
 * å“¡å·¥ Aï¼š
 * - åˆ°è·æ—¥ï¼š2024-01-15
 * - æŸ¥è©¢å¹´åº¦ï¼š2025
 * - å·¥ä½œå¹´è³‡ï¼š1å¹´11å€‹æœˆ = 23å€‹æœˆ
 * - ç•¶å¹´æ–°å¢ç‰¹ä¼‘ï¼š7å¤©ï¼ˆ1-2å¹´ï¼‰
 * - å»å¹´ï¼ˆ2024ï¼‰å‰©é¤˜ï¼š2å¤©
 * - ä»Šå¹´ç¸½å¯ç”¨ï¼š7 + 2 = 9å¤© âœ… ç´¯ç©åˆ¶
 * - å·²ä½¿ç”¨ï¼š3å¤©
 * - å‰©é¤˜ï¼š6å¤©
 */
```

**å¹´åˆè‡ªå‹•è™•ç†ï¼ˆæ¯å¹´1æœˆ1æ—¥ï¼‰ï¼š**
```typescript
/**
 * Cron Job: æ¯å¹´ 1/1 00:00 åŸ·è¡Œ
 * é…ç½®æª”ï¼šwrangler.toml
 * 
 * [triggers]
 * crons = ["0 0 1 1 *"]  # æ¯å¹´1æœˆ1æ—¥ 00:00
 */
async function annualLeaveYearEndProcessing(targetDate?: string) {
  const startTime = Date.now();
  const executionDate = targetDate || new Date().toISOString().split('T')[0];
  const currentYear = parseInt(executionDate.substring(0, 4));
  const lastYear = currentYear - 1;
  
  // âš ï¸ å†ªç­‰æ€§æª¢æŸ¥ï¼šé˜²æ­¢é‡è¤‡åŸ·è¡Œ
  const existingExecution = await db.prepare(`
    SELECT * FROM CronJobExecutions
    WHERE job_name = 'annual_leave_update'
      AND execution_date = ?
      AND status = 'success'
  `).bind(executionDate).first();
  
  if (existingExecution) {
    console.log(`ç‰¹ä¼‘æ›´æ–°å·²åŸ·è¡Œéï¼ˆ${executionDate}ï¼‰ï¼Œè·³é`);
    return {
      skipped: true,
      message: 'è©²æ—¥æœŸå·²åŸ·è¡Œé',
      previous_execution: existingExecution
    };
  }
  
  try {
    // æŸ¥è©¢æ‰€æœ‰å“¡å·¥
    const users = await db.prepare(`
      SELECT user_id, join_date FROM Users WHERE is_deleted = 0
    `).all();
    
    let affectedUsers = 0;
    
    for (const user of users.results) {
      // è¨ˆç®—ç•¶å¹´åº¦æ‡‰å¾—ç‰¹ä¼‘
      const months = calculateMonths(user.join_date, new Date(currentYear, 11, 31));
      const rule = await getAnnualLeaveRule(months);
      
      if (!rule) {
        console.warn(`å“¡å·¥ ${user.user_id} å¹´è³‡ä¸è¶³ï¼Œè·³é`);
        continue;
      }
      
      // æŸ¥è©¢å»å¹´å‰©é¤˜ç‰¹ä¼‘
      const lastYearBalance = await db.prepare(`
        SELECT remaining_days FROM AnnualLeaveBalance
        WHERE user_id = ? AND year = ?
      `).bind(user.user_id, lastYear).first();
      
      const carriedOver = lastYearBalance?.remaining_days || 0;
      
      // å‰µå»ºä»Šå¹´åº¦ç‰¹ä¼‘è¨˜éŒ„
      await db.prepare(`
        INSERT INTO AnnualLeaveBalance (
          user_id, year, entitled_days, carried_over_days, remaining_days
        ) VALUES (?, ?, ?, ?, ?)
      `).bind(
        user.user_id,
        currentYear,
        rule.days,
        carriedOver,  // âœ… å»å¹´å‰©é¤˜ç´¯ç©åˆ°ä»Šå¹´
        rule.days + carriedOver
      ).run();
      
      affectedUsers++;
    }
    
    // è¨˜éŒ„åŸ·è¡ŒæˆåŠŸ
    const duration = Date.now() - startTime;
    await db.prepare(`
      INSERT INTO CronJobExecutions (
        job_name, execution_date, status, affected_users, execution_duration_ms
      ) VALUES (?, ?, 'success', ?, ?)
    `).bind('annual_leave_update', executionDate, affectedUsers, duration).run();
    
    console.log(`ç‰¹ä¼‘æ›´æ–°å®Œæˆï¼š${affectedUsers} ä½å“¡å·¥ï¼Œè€—æ™‚ ${duration}ms`);
    
    return {
      success: true,
      affected_users: affectedUsers,
      execution_duration_ms: duration
    };
    
  } catch (error) {
    // è¨˜éŒ„åŸ·è¡Œå¤±æ•—
    const duration = Date.now() - startTime;
    await db.prepare(`
      INSERT INTO CronJobExecutions (
        job_name, execution_date, status, error_message, execution_duration_ms
      ) VALUES (?, ?, 'failed', ?, ?)
    `).bind('annual_leave_update', executionDate, error.message, duration).run();
    
    // âš ï¸ é€šçŸ¥ç®¡ç†å“¡ï¼ˆå„€è¡¨æ¿é¡¯ç¤ºï¼‰
    await sendAdminNotification({
      type: 'cron_failed',
      message: `ç‰¹ä¼‘å¹´åˆæ›´æ–°å¤±æ•—ï¼š${error.message}`,
      action_url: '/admin/cron/history?job_name=annual_leave_update'
    });
    
    console.error('ç‰¹ä¼‘æ›´æ–°å¤±æ•—:', error);
    throw error;
  }
}
```

#### ç—…å‡/äº‹å‡ï¼ˆå›ºå®šé¡åº¦ï¼‰
```
ç—…å‡ï¼š30å¤©/å¹´
äº‹å‡ï¼š14å¤©/å¹´
æ¯å¹´1æœˆ1æ—¥é‡ç½®

âš ï¸ ç”Ÿç†å‡ä½µå…¥ç—…å‡çš„ç‰¹æ®Šè™•ç†ï¼š
- å…¨å¹´ç”Ÿç†å‡å‰ 3 æ—¥ï¼šä¸ä½µå…¥ç—…å‡è¨ˆç®—
- å…¨å¹´ç”Ÿç†å‡ç¬¬ 4 æ—¥èµ·ï¼šä½µå…¥ç—…å‡è¨ˆç®—
```

**ç”Ÿç†å‡ä½µå…¥ç—…å‡çš„è¨ˆç®—é‚è¼¯ï¼š**
```typescript
/**
 * è¨ˆç®—ç—…å‡é¤˜é¡ï¼ˆå«ç”Ÿç†å‡ä½µå…¥ï¼‰
 */
async function calculateSickLeaveBalance(userId: number, year: number) {
  // 1. æŸ¥è©¢ç—…å‡ä½¿ç”¨å¤©æ•¸
  const sickLeaveUsed = await db.prepare(`
    SELECT COALESCE(SUM(days), 0) as total
    FROM LeaveApplications
    WHERE user_id = ?
      AND leave_type_id = 2  -- ç—…å‡
      AND strftime('%Y', start_date) = ?
      AND is_deleted = 0
  `).bind(userId, year.toString()).first();
  
  // 2. æŸ¥è©¢ç”Ÿç†å‡ä½µå…¥ç—…å‡çš„å¤©æ•¸
  const menstrualAsSickLeave = await db.prepare(`
    SELECT COALESCE(SUM(days), 0) as total
    FROM LeaveApplications
    WHERE user_id = ?
      AND leave_type_id = 8  -- ç”Ÿç†å‡
      AND counts_as_sick_leave = 1  -- â­ ä½µå…¥ç—…å‡çš„éƒ¨åˆ†
      AND strftime('%Y', start_date) = ?
      AND is_deleted = 0
  `).bind(userId, year.toString()).first();
  
  const totalUsed = (sickLeaveUsed?.total || 0) + (menstrualAsSickLeave?.total || 0);
  
  return {
    entitled: 30,
    used: totalUsed,
    remaining: 30 - totalUsed,
    breakdown: {
      sick_leave_used: sickLeaveUsed?.total || 0,
      menstrual_as_sick_leave: menstrualAsSickLeave?.total || 0
    }
  };
}

/**
 * ç¯„ä¾‹ï¼š
 * 
 * å¥³æ€§å“¡å·¥ä»Šå¹´è«‹å‡è¨˜éŒ„ï¼š
 * - ç—…å‡ï¼š2å¤©
 * - ç”Ÿç†å‡ï¼ˆå‰3æ—¥ï¼‰ï¼š3å¤©ï¼ˆcounts_as_sick_leave = 0ï¼‰
 * - ç”Ÿç†å‡ï¼ˆç¬¬4æ—¥ï¼‰ï¼š1å¤©ï¼ˆcounts_as_sick_leave = 1ï¼‰â­
 * 
 * ç—…å‡é¤˜é¡è¨ˆç®—ï¼š
 * - ç—…å‡ä½¿ç”¨ï¼š2å¤©
 * - ç”Ÿç†å‡ä½µå…¥ï¼š1å¤©
 * - ç¸½ä½¿ç”¨ï¼š3å¤©
 * - å‰©é¤˜ï¼š30 - 3 = 27å¤©
 */
```

#### å©šå‡/å–ªå‡ï¼ˆç”Ÿæ´»äº‹ä»¶ï¼‰
```
ç™»è¨˜ã€Œçµå©šã€â†’ ç”¢ç”Ÿå©šå‡8å¤©
ç™»è¨˜ã€Œçˆ¶æ¯éä¸–ã€â†’ ç”¢ç”Ÿå–ªå‡8å¤©
æœ‰æ•ˆæœŸé™ï¼šäº‹ä»¶å¾Œ1å¹´

âš ï¸ ä½¿ç”¨ LifeEventLeaveGrants è¡¨è¿½è¹¤ï¼š
- è¨˜éŒ„ç¸½é¡åº¦ï¼ˆ8å¤©ï¼‰
- è¨˜éŒ„å·²ä½¿ç”¨ï¼ˆå¦‚ï¼š5å¤©ï¼‰
- è¨˜éŒ„å‰©é¤˜ï¼ˆå¦‚ï¼š3å¤©ï¼‰
- è¨˜éŒ„æœ‰æ•ˆæœŸï¼ˆäº‹ä»¶æ—¥ ~ äº‹ä»¶æ—¥+365å¤©ï¼‰
- æ”¯æ´åˆ†æ¬¡ä½¿ç”¨ï¼ˆFIFOï¼Œå„ªå…ˆä½¿ç”¨æœ€æ—©çš„é¡åº¦ï¼‰
```

**ç”Ÿæ´»äº‹ä»¶å‡æœŸé¤˜é¡æŸ¥è©¢é‚è¼¯ï¼š**
```typescript
/**
 * æŸ¥è©¢ç”Ÿæ´»äº‹ä»¶å‡æœŸé¤˜é¡
 */
async function getLifeEventLeaveBalance(userId: number, leaveTypeId: number) {
  const grants = await db.prepare(`
    SELECT 
      grant_id,
      event_type,
      event_date,
      total_days,
      used_days,
      remaining_days,
      valid_from,
      valid_until,
      CASE 
        WHEN valid_until < date('now') THEN 'expired'
        WHEN remaining_days <= 0 THEN 'used_up'
        ELSE 'active'
      END as status
    FROM LifeEventLeaveGrants
    WHERE user_id = ?
      AND leave_type_id = ?
      AND is_deleted = 0
    ORDER BY event_date ASC
  `).bind(userId, leaveTypeId).all();
  
  // åªè¨ˆç®—æœ‰æ•ˆä¸”æœªç”¨å®Œçš„é¡åº¦
  const activeGrants = grants.results.filter(g => g.status === 'active');
  const totalRemaining = activeGrants.reduce((sum, g) => sum + g.remaining_days, 0);
  
  return {
    total_remaining: totalRemaining,
    grants: grants.results,
    active_grants: activeGrants
  };
}

/**
 * ç¯„ä¾‹è¼¸å‡ºï¼š
 * 
 * å“¡å·¥BæŸ¥è©¢å©šå‡é¤˜é¡ï¼š
 * {
 *   "total_remaining": 3,
 *   "grants": [
 *     {
 *       "grant_id": 1,
 *       "event_type": "çµå©š",
 *       "event_date": "2025-12-15",
 *       "total_days": 8,
 *       "used_days": 5,
 *       "remaining_days": 3,
 *       "valid_from": "2025-12-15",
 *       "valid_until": "2026-12-14",
 *       "status": "active"
 *     }
 *   ],
 *   "active_grants": [...]
 * }
 */
```

### é©—è­‰è¦å‰‡
1. æ—¥æœŸå€é–“æœ‰æ•ˆï¼ˆend_date >= start_dateï¼‰
2. å‡æœŸé¤˜é¡è¶³å¤ 
3. ç„¡é‡ç–Šå‡æœŸï¼ˆåŒä¸€å¤©ä¸èƒ½é‡è¤‡è«‹å‡ï¼‰
4. å‡åˆ¥é¡å‹å·²å•Ÿç”¨
5. **æ€§åˆ¥é™åˆ¶æª¢æŸ¥**ï¼ˆé‡è¦ï¼ï¼‰

#### æ€§åˆ¥é™åˆ¶é©—è­‰

```typescript
/**
 * é©—è­‰å‡åˆ¥æ˜¯å¦ç¬¦åˆæ€§åˆ¥é™åˆ¶
 * âš ï¸ æ­¤å‡½æ•¸å·²æ•´åˆåˆ° LeaveService.applyLeave() ä¸­ï¼Œä½œç‚ºç¬¬0æ­¥é©—è­‰
 */
async function validateGenderRestriction(userId: number, leaveTypeId: number): boolean {
  // 1. æŸ¥è©¢å“¡å·¥æ€§åˆ¥
  const user = await db.prepare(`
    SELECT gender FROM Users WHERE user_id = ?
  `).bind(userId).first();
  
  if (!user) {
    throw new NotFoundError('å“¡å·¥ä¸å­˜åœ¨');
  }
  
  // 2. æŸ¥è©¢å‡åˆ¥æ€§åˆ¥é™åˆ¶
  const leaveType = await db.prepare(`
    SELECT gender_specific, type_name FROM LeaveTypes WHERE leave_type_id = ?
  `).bind(leaveTypeId).first();
  
  if (!leaveType) {
    throw new NotFoundError('å‡åˆ¥ä¸å­˜åœ¨');
  }
  
  // 3. æª¢æŸ¥æ€§åˆ¥é™åˆ¶
  if (leaveType.gender_specific) {
    if (leaveType.gender_specific === 'F' && user.gender !== 'å¥³') {
      throw new ValidationError(
        `${leaveType.type_name}åƒ…é™å¥³æ€§å“¡å·¥ç”³è«‹`,
        'GENDER_RESTRICTION_VIOLATED'
      );
    }
    if (leaveType.gender_specific === 'M' && user.gender !== 'ç”·') {
      throw new ValidationError(
        `${leaveType.type_name}åƒ…é™ç”·æ€§å“¡å·¥ç”³è«‹`,
        'GENDER_RESTRICTION_VIOLATED'
      );
    }
  }
  
  return true;
}

/**
 * ç¯„ä¾‹ï¼š
 * 
 * æƒ…å¢ƒ 1ï¼šç”·æ€§å“¡å·¥ç”³è«‹ç”¢å‡
 * - user.gender = 'ç”·'
 * - leaveType.gender_specific = 'F'
 * - çµæœï¼šâŒ æ‹‹å‡ºéŒ¯èª¤ã€Œç”¢å‡åƒ…é™å¥³æ€§å“¡å·¥ç”³è«‹ã€
 * 
 * æƒ…å¢ƒ 2ï¼šå¥³æ€§å“¡å·¥ç”³è«‹é™ªç”¢æª¢åŠé™ªç”¢å‡
 * - user.gender = 'å¥³'
 * - leaveType.gender_specific = 'M'
 * - çµæœï¼šâŒ æ‹‹å‡ºéŒ¯èª¤ã€Œé™ªç”¢æª¢åŠé™ªç”¢å‡åƒ…é™ç”·æ€§å“¡å·¥ç”³è«‹ã€
 * 
 * æƒ…å¢ƒ 3ï¼šç”·æ€§å“¡å·¥ç”³è«‹ç‰¹ä¼‘
 * - user.gender = 'ç”·'
 * - leaveType.gender_specific = NULL
 * - çµæœï¼šâœ… é€šéï¼ˆç‰¹ä¼‘ç„¡æ€§åˆ¥é™åˆ¶ï¼‰
 */
```

#### å‰ç«¯å‡åˆ¥é¸é …éæ¿¾ï¼ˆAPIå¯¦ä½œï¼‰

**APIç«¯é»ï¼š** `GET /api/v1/leave/available-types?user_id=1`

```typescript
/**
 * æ ¹æ“šå“¡å·¥æ€§åˆ¥éæ¿¾å¯ç”³è«‹çš„å‡åˆ¥
 * âš ï¸ å‰ç«¯ä¸‹æ‹‰é¸å–®æ‡‰èª¿ç”¨æ­¤APIï¼Œä¸è¦åœ¨å‰ç«¯è‡ªè¡Œéæ¿¾
 */
async function getAvailableLeaveTypes(userId: number) {
  // 1. æŸ¥è©¢å“¡å·¥æ€§åˆ¥
  const user = await db.prepare(`
    SELECT gender FROM Users WHERE user_id = ?
  `).bind(userId).first();
  
  if (!user) {
    throw new NotFoundError('å“¡å·¥ä¸å­˜åœ¨');
  }
  
  // 2. æŸ¥è©¢ç¬¦åˆæ€§åˆ¥çš„å‡åˆ¥
  const leaveTypes = await db.prepare(`
    SELECT 
      leave_type_id,
      type_name,
      gender_specific,
      annual_quota,
      is_paid,
      affects_attendance
    FROM LeaveTypes
    WHERE is_enabled = 1
      AND (gender_specific IS NULL 
        OR gender_specific = ?)
    ORDER BY leave_type_id
  `).bind(user.gender === 'å¥³' ? 'F' : user.gender === 'ç”·' ? 'M' : NULL).all();
  
  return leaveTypes.results;
}

/**
 * ç¯„ä¾‹è¼¸å‡ºï¼š
 * 
 * å¥³æ€§å“¡å·¥çœ‹åˆ°çš„å‡åˆ¥é¸é …ï¼š
 * - ç‰¹ä¼‘ âœ…
 * - ç—…å‡ âœ…
 * - äº‹å‡ âœ…
 * - å©šå‡ âœ…
 * - ç”¢å‡ âœ…ï¼ˆåƒ…å¥³æ€§ï¼‰
 * - ç”¢æª¢å‡ âœ…ï¼ˆåƒ…å¥³æ€§ï¼‰
 * - ç”Ÿç†å‡ âœ…ï¼ˆåƒ…å¥³æ€§ï¼‰
 * - å–ªå‡ âœ…
 * - å…¬å‡ âœ…
 * - å®¶åº­ç…§é¡§å‡ âœ…
 * - è£œä¼‘ âœ…
 * - é¢±é¢¨å‡ âœ…
 * ï¼ˆä¸æœƒé¡¯ç¤ºé™ªç”¢æª¢åŠé™ªç”¢å‡ï¼‰
 * 
 * ç”·æ€§å“¡å·¥çœ‹åˆ°çš„å‡åˆ¥é¸é …ï¼š
 * - ç‰¹ä¼‘ âœ…
 * - ç—…å‡ âœ…
 * - äº‹å‡ âœ…
 * - å©šå‡ âœ…
 * - é™ªç”¢æª¢åŠé™ªç”¢å‡ âœ…ï¼ˆåƒ…ç”·æ€§ï¼‰
 * - å–ªå‡ âœ…
 * - å…¬å‡ âœ…
 * - å®¶åº­ç…§é¡§å‡ âœ…
 * - è£œä¼‘ âœ…
 * - é¢±é¢¨å‡ âœ…
 * ï¼ˆä¸æœƒé¡¯ç¤ºç”¢å‡ã€ç”¢æª¢å‡ã€ç”Ÿç†å‡ï¼‰
 */
```

---

## ğŸ¨ å‰ç«¯çµ„ä»¶ç¯„ä¾‹

### LeaveApplicationForm.vueï¼ˆå‡æœŸç”³è«‹è¡¨å–®ï¼‰

```vue
<template>
  <Modal :show="show" title="ç”³è«‹å‡æœŸ">
    <form @submit.prevent="submitLeave">
      <!-- å‡åˆ¥é¸æ“‡ï¼ˆè‡ªå‹•ä¾æ€§åˆ¥éæ¿¾ï¼‰â­ -->
      <FormGroup label="å‡åˆ¥">
        <select v-model="form.leave_type_id" required>
          <option value="">è«‹é¸æ“‡</option>
          <option 
            v-for="type in availableLeaveTypes" 
            :key="type.leave_type_id"
            :value="type.leave_type_id"
          >
            {{ type.type_name }}
            <span v-if="type.gender_specific === 'F'">ï¼ˆé™å¥³æ€§ï¼‰</span>
            <span v-if="type.gender_specific === 'M'">ï¼ˆé™ç”·æ€§ï¼‰</span>
          </option>
        </select>
      </FormGroup>
      
      <!-- æ—¥æœŸé¸æ“‡ -->
      <FormGroup label="é–‹å§‹æ—¥æœŸ">
        <input type="date" v-model="form.start_date" required />
      </FormGroup>
      
      <FormGroup label="çµæŸæ—¥æœŸ">
        <input type="date" v-model="form.end_date" required />
      </FormGroup>
      
      <!-- åŸå›  -->
      <FormGroup label="åŸå› ">
        <textarea v-model="form.reason"></textarea>
      </FormGroup>
      
      <StyledButton type="submit">é€å‡ºç”³è«‹</StyledButton>
    </form>
  </Modal>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { getAvailableLeaveTypes, applyLeave } from '@/api/leave';
import { useAuth } from '@/composables/useAuth';

const { user } = useAuth();
const availableLeaveTypes = ref([]);
const form = ref({
  leave_type_id: '',
  start_date: '',
  end_date: '',
  reason: ''
});

// â­ è¼‰å…¥æ™‚è‡ªå‹•å–å¾—è©²å“¡å·¥å¯ç”³è«‹çš„å‡åˆ¥ï¼ˆå·²ä¾æ€§åˆ¥éæ¿¾ï¼‰
onMounted(async () => {
  const response = await getAvailableLeaveTypes(user.value.user_id);
  availableLeaveTypes.value = response.data;
  
  // ç”·æ€§å“¡å·¥çœ‹ä¸åˆ°ç”¢å‡ã€ç”¢æª¢å‡ã€ç”Ÿç†å‡
  // å¥³æ€§å“¡å·¥çœ‹ä¸åˆ°é™ªç”¢æª¢åŠé™ªç”¢å‡
});

async function submitLeave() {
  try {
    await applyLeave(form.value);
    alert('å‡æœŸç”³è«‹æˆåŠŸ');
  } catch (error) {
    // å¦‚æœå¾Œç«¯ä¹Ÿæ””æˆªåˆ°æ€§åˆ¥é™åˆ¶éŒ¯èª¤
    if (error.code === 'GENDER_RESTRICTION_VIOLATED') {
      alert(error.message);  // é¡¯ç¤ºï¼šã€Œç”¢å‡åƒ…é™å¥³æ€§å“¡å·¥ç”³è«‹ã€
    } else {
      alert('ç”³è«‹å¤±æ•—ï¼š' + error.message);
    }
  }
}
</script>
```

### API Serviceï¼ˆå‰ç«¯èª¿ç”¨ï¼‰

```typescript
// src/api/leave.ts

/**
 * æŸ¥è©¢å¯ç”³è«‹çš„å‡åˆ¥ï¼ˆä¾æ€§åˆ¥è‡ªå‹•éæ¿¾ï¼‰
 */
export async function getAvailableLeaveTypes(userId: number) {
  const response = await fetch(`/api/v1/leave/available-types?user_id=${userId}`, {
    headers: { 'Authorization': `Bearer ${getToken()}` }
  });
  return await response.json();
}

/**
 * ç”³è«‹å‡æœŸ
 */
export async function applyLeave(data: LeaveApplicationData) {
  const response = await fetch('/api/v1/leave/applications', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${getToken()}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  });
  
  const result = await response.json();
  
  if (!result.success) {
    throw { code: result.error.code, message: result.error.message };
  }
  
  return result;
}
```

---

**é€™å€‹æ–‡æª”åŒ…å«å‡æœŸç®¡ç†çš„æ‰€æœ‰æŠ€è¡“ç´°ç¯€ã€‚**

