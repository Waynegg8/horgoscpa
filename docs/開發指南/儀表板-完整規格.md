# 儀表板 - 完整開發規格

**模組名稱：** 儀表板（Dashboard）系統  
**版本：** 3.2  
**更新日期：** 2025-10-29  
**重要性：** ⭐⭐⭐ 使用者登入後第一個看到的頁面

---

## 📋 功能概述

### 核心功能

**儀表板是系統的入口頁面，所有用戶登入後都會看到。**

#### 員工儀表板
- 我的工時統計（本月）
- 我的任務列表（待辦/進行中）
- 我的假期餘額
- 快速操作按鈕
- 最近動態

#### 管理員儀表板
- 公司總覽
- 財務狀況
- 待處理事項
- 快速操作按鈕

---

## 💾 資料表

### DashboardWidgets（儀表板小部件配置）
```sql
CREATE TABLE DashboardWidgets (
  widget_id INTEGER PRIMARY KEY AUTOINCREMENT,
  widget_code TEXT UNIQUE NOT NULL,      -- 小部件代碼
  widget_name TEXT NOT NULL,             -- 小部件名稱
  widget_type TEXT NOT NULL,             -- 'stat', 'chart', 'list', 'calendar'
  default_position INTEGER,              -- 預設位置
  is_admin_only BOOLEAN DEFAULT 0,       -- 是否僅管理員可見
  is_enabled BOOLEAN DEFAULT 1,
  created_at TEXT DEFAULT (datetime('now'))
);

-- 預設小部件
INSERT INTO DashboardWidgets (widget_code, widget_name, widget_type, default_position, is_admin_only) VALUES
('my_hours', '我的工時統計', 'stat', 1, 0),
('my_tasks', '我的任務列表', 'list', 2, 0),
('my_leaves', '我的假期餘額', 'stat', 3, 0),
('recent_activities', '最近動態', 'list', 4, 0),
('company_overview', '公司總覽', 'stat', 1, 1),
('financial_status', '財務狀況', 'stat', 2, 1),
('pending_items', '待處理事項', 'list', 3, 1),
('revenue_chart', '營收趨勢', 'chart', 4, 1);
```

### UserDashboardSettings（用戶儀表板設定）
```sql
CREATE TABLE UserDashboardSettings (
  setting_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  widget_code TEXT NOT NULL,
  is_visible BOOLEAN DEFAULT 1,
  position INTEGER,                      -- 自訂位置
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (widget_code) REFERENCES DashboardWidgets(widget_code),
  UNIQUE(user_id, widget_code)
);

CREATE INDEX idx_user_dashboard_user ON UserDashboardSettings(user_id);
```

---

## 🔌 API 端點

### 儀表板數據

```
GET    /api/v1/dashboard                    獲取儀表板數據（依角色自動切換）
GET    /api/v1/dashboard/my-hours           我的工時統計
GET    /api/v1/dashboard/my-tasks           我的任務列表
GET    /api/v1/dashboard/my-leaves          我的假期餘額
GET    /api/v1/dashboard/recent-activities  最近動態
GET    /api/v1/dashboard/company-overview   公司總覽（管理員）
GET    /api/v1/dashboard/financial-status   財務狀況（管理員）
GET    /api/v1/dashboard/pending-items      待處理事項（管理員）
```

### 儀表板設定

```
GET    /api/v1/dashboard/settings           獲取用戶儀表板設定
PUT    /api/v1/dashboard/settings           更新儀表板設定
```

---

## 📝 API 範例

### 員工儀表板數據

**請求：**
```
GET /api/v1/dashboard
Authorization: Bearer {token}
```

**回應（員工）：**
```json
{
  "success": true,
  "data": {
    "user_type": "employee",
    "user_name": "王小明",
    
    "my_hours": {
      "month": "2025-11",
      "total_hours": 128.0,
      "target_hours": 160.0,
      "normal_hours": 120.0,
      "overtime_hours": 8.0,
      "completion_rate": 80.0,
      "trend": {
        "week_1": 32,
        "week_2": 40,
        "week_3": 36,
        "week_4": 20
      }
    },
    
    "my_tasks": {
      "total": 5,
      "pending": 2,
      "in_progress": 2,
      "overdue": 1,
      "urgent": 1,      // ⭐ 新增：3天內到期的任務數
      "tasks": [
        {
          "task_id": 123,
          "task_name": "測試科技 - 記帳服務",
          "client_name": "測試科技股份有限公司",
          "due_date": "2025-11-30",
          "status": "in_progress",
          "progress": "2/3",
          "is_overdue": false,
          "days_until_due": 12,        // ⭐ 後端計算（還有12天）
          "urgency_level": "normal",   // ⭐ urgent/normal/low
          "has_sop": true
        },
        {
          "task_id": 124,
          "task_name": "ABC公司 - 工商登記",
          "client_name": "ABC公司",
          "due_date": "2025-11-25",
          "status": "pending",
          "progress": "0/2",
          "is_overdue": true,
          "days_overdue": 2,
          "days_until_due": -2,        // ⭐ 負數表示已逾期
          "urgency_level": "overdue"   // ⭐ 已逾期
        }
      ]
    },
    
    "my_leaves": {
      "annual_leave": {
        "entitled": 7,
        "used": 2,
        "remaining": 5
      },
      "sick_leave": {
        "entitled": 30,
        "used": 2,
        "remaining": 28
      },
      "compensatory_leave": {
        "hours": 8.0,
        "expiry_date": "2025-11-30"
      },
      "recent_applications": [
        {
          "leave_type": "特休",
          "start_date": "2025-11-20",
          "days": 1,
          "status": "approved"
        }
      ]
    },
    
    "quick_actions": [
      {
        "action": "fill_timesheet",
        "label": "填寫今日工時",
        "icon": "clock",
        "url": "/timesheets/new"
      },
      {
        "action": "apply_leave",
        "label": "申請假期",
        "icon": "calendar",
        "url": "/leaves/apply"
      },
      {
        "action": "view_reports",
        "label": "查看我的報表",
        "icon": "chart",
        "url": "/reports/my"
      }
    ],
    
    "recent_activities": [
      {
        "type": "task_completed",
        "message": "完成任務：XYZ公司 - 稅務申報",
        "timestamp": "2025-11-28 15:30:00"
      },
      {
        "type": "leave_approved",
        "message": "假期申請已核准：11/25 特休 1天",
        "timestamp": "2025-11-27 10:20:00"
      },
      {
        "type": "timesheet_reminder",
        "message": "提醒：11/26 工時尚未填寫",
        "timestamp": "2025-11-27 08:30:00"
      }
    ],
    
    "notifications": [
      {
        "type": "warning",
        "message": "您有1個任務已逾期",
        "action_url": "/tasks?filter=overdue"
      },
    ]
  }
}
```

### 管理員儀表板數據

**回應（管理員）：**
```json
{
  "success": true,
  "data": {
    "user_type": "admin",
    "user_name": "管理員",
    
    "company_overview": {
      "month": "2025-11",
      "total_hours": 1200.0,
      "employee_count": 5,
      "attendance_rate": 95.0,
      "active_services": 15,
      "active_clients": 50,
      "employee_status": {
        "working": 4,
        "on_leave": 1,
        "absent": 0
      }
    },
    
    "financial_status": {
      "month": "2025-11",
      "total_ar": 85500,           // 應收帳款
      "collected": 45000,          // 本月收款
      "overdue": 25000,            // 逾期金額
      "collection_rate": 87.5,     // 收款率%
      "revenue": 120000,           // 本月開立收據總額
      "cost": 95000,               // 本月總成本
      "profit": 25000,             // 本月毛利
      "profit_margin": 20.8        // 毛利率%
    },
    
    "pending_items": {
      "total": 5,
      "items": [
        {
          "type": "leave_application",
          "message": "王小明 - 事假申請（待審核）",
          "date": "2025-11-28",
          "action_url": "/admin/leaves/approve/123"
        },
        {
          "type": "overdue_task",
          "message": "ABC公司 - 記帳任務逾期2天",
          "assignee": "李美玲",
          "action_url": "/tasks/124"
        },
        {
          "type": "overdue_payment",
          "message": "XYZ企業 - 收據逾期30天（15,000元）",
          "action_url": "/receipts/202510-003"
        }
      ]
    },
    
    "revenue_chart": {
      "period": "last_6_months",
      "data": [
        { "month": "2025-06", "revenue": 110000, "cost": 85000, "profit": 25000 },
        { "month": "2025-07", "revenue": 125000, "cost": 90000, "profit": 35000 },
        { "month": "2025-08", "revenue": 115000, "cost": 88000, "profit": 27000 },
        { "month": "2025-09", "revenue": 130000, "cost": 95000, "profit": 35000 },
        { "month": "2025-10", "revenue": 118000, "cost": 92000, "profit": 26000 },
        { "month": "2025-11", "revenue": 120000, "cost": 95000, "profit": 25000 }
      ]
    },
    
    "quick_actions": [
      {
        "action": "add_client",
        "label": "新增客戶",
        "icon": "user-plus",
        "url": "/clients/new"
      },
      {
        "action": "create_receipt",
        "label": "開立收據",
        "icon": "file-text",
        "url": "/receipts/new"
      },
      {
        "action": "view_reports",
        "label": "查看所有報表",
        "icon": "chart-bar",
        "url": "/reports"
      },
      {
        "action": "system_settings",
        "label": "系統設定",
        "icon": "settings",
        "url": "/admin/settings"
      }
    ],
    
    "notifications": [
      {
        "type": "warning",
        "message": "有3個收據逾期超過30天",
        "count": 3,
        "action_url": "/reports/ar-aging"
      },
      {
        "type": "info",
        "message": "本月薪資尚未計算",
        "action_url": "/admin/payroll/calculate"
      }
    ]
  }
}
```

---

## 🎨 前端組件

### DashboardPage.vue（主頁面）

```vue
<template>
  <div class="dashboard-page">
    <!-- 歡迎標題 -->
    <div class="dashboard-header">
      <h1>歡迎回來，{{ userName }}！</h1>
      <p class="date">{{ currentDate }}</p>
    </div>

    <!-- 通知區域 -->
    <div v-if="notifications.length > 0" class="notifications">
      <div 
        v-for="(notif, index) in notifications" 
        :key="index"
        :class="['notification', `notification-${notif.type}`]"
      >
        <Icon :name="notif.type === 'warning' ? 'alert-triangle' : 'info'" />
        <span>{{ notif.message }}</span>
        <a v-if="notif.action_url" :href="notif.action_url" class="action-link">
          查看 →
        </a>
      </div>
    </div>

    <!-- 員工儀表板 -->
    <div v-if="!isAdmin" class="employee-dashboard">
      <!-- 工時統計卡片 -->
      <StatsCard
        title="📊 本月工時統計"
        :stats="myHours"
      >
        <div class="hours-summary">
          <div class="stat-item">
            <span class="label">總工時</span>
            <span class="value">{{ myHours.total_hours }} / {{ myHours.target_hours }} 小時</span>
            <ProgressBar :value="myHours.completion_rate" />
          </div>
          <div class="stat-row">
            <div class="stat-mini">
              <span class="label">正常工時</span>
              <span class="value">{{ myHours.normal_hours }} 小時</span>
            </div>
            <div class="stat-mini">
              <span class="label">加班工時</span>
              <span class="value">{{ myHours.overtime_hours }} 小時</span>
            </div>
          </div>
        </div>
      </StatsCard>

      <!-- 我的任務卡片 -->
      <StatsCard
        :title="`📋 我的任務（${myTasks.total}個）`"
      >
        <div class="task-list">
          <div 
            v-for="task in myTasks.tasks" 
            :key="task.task_id"
            :class="['task-item', { 'overdue': task.is_overdue }]"
            @click="navigateTo(`/tasks/${task.task_id}`)"
          >
            <div class="task-header">
              <h4>{{ task.task_name }}</h4>
              <span v-if="task.has_sop" class="sop-badge">📄 SOP</span>
            </div>
            <div class="task-meta">
              <span class="progress">進度：{{ task.progress }}</span>
              <span 
                class="due-date" 
                :class="{
                  'urgent': task.urgency_level === 'urgent',
                  'overdue': task.urgency_level === 'overdue'
                }"
              >
                到期：{{ formatDate(task.due_date) }}
                <span v-if="task.is_overdue" class="overdue-badge">
                  ⚠️ 逾期{{ task.days_overdue }}天
                </span>
                <span v-else-if="task.urgency_level === 'urgent'" class="urgent-badge">
                  🔥 還有{{ task.days_until_due }}天
                </span>
                <span v-else class="normal-badge">
                  還有{{ task.days_until_due }}天
                </span>
              </span>
            </div>
          </div>
        </div>
      </StatsCard>

      <!-- 我的假期卡片 -->
      <StatsCard title="🏖️ 我的假期">
        <div class="leave-balance">
          <div class="leave-item">
            <span class="label">特休</span>
            <span class="value">剩餘 {{ myLeaves.annual_leave.remaining }} 天</span>
          </div>
          <div class="leave-item">
            <span class="label">病假</span>
            <span class="value">剩餘 {{ myLeaves.sick_leave.remaining }} 天</span>
          </div>
          <div v-if="myLeaves.compensatory_leave.hours > 0" class="leave-item highlight">
            <span class="label">補休</span>
            <span class="value">{{ myLeaves.compensatory_leave.hours }} 小時</span>
            <span class="expiry">{{ myLeaves.compensatory_leave.expiry_date }}到期</span>
          </div>
        </div>
        
        <div v-if="myLeaves.recent_applications.length > 0" class="recent-leaves">
          <h5>最近申請</h5>
          <div 
            v-for="app in myLeaves.recent_applications"
            :key="app.leave_id"
            class="leave-record"
          >
            <span>{{ app.start_date }} {{ app.leave_type }} {{ app.days }}天</span>
            <span :class="['status', app.status]">{{ statusText[app.status] }}</span>
          </div>
        </div>
      </StatsCard>

      <!-- 快速操作 -->
      <div class="quick-actions">
        <StyledButton 
          v-for="action in quickActions" 
          :key="action.action"
          @click="navigateTo(action.url)"
          variant="primary"
        >
          <Icon :name="action.icon" />
          {{ action.label }}
        </StyledButton>
      </div>
    </div>

    <!-- 管理員儀表板 -->
    <div v-else class="admin-dashboard">
      <!-- 公司總覽 -->
      <div class="overview-grid">
        <StatCard
          title="本月總工時"
          :value="companyOverview.total_hours"
          unit="小時"
          icon="clock"
          trend="+5%"
        />
        <StatCard
          title="出勤率"
          :value="companyOverview.attendance_rate"
          unit="%"
          icon="users"
          :is-good="companyOverview.attendance_rate >= 95"
        />
        <StatCard
          title="客戶服務"
          :value="companyOverview.active_services"
          unit="個進行中"
          icon="briefcase"
        />
        <StatCard
          title="員工人數"
          :value="companyOverview.employee_count"
          unit="人"
          icon="user"
        />
      </div>

      <!-- 財務狀況 -->
      <StatsCard title="💰 財務狀況">
        <div class="financial-grid">
          <div class="financial-item">
            <span class="label">應收帳款</span>
            <span class="value amount">{{ formatCurrency(financialStatus.total_ar) }}</span>
          </div>
          <div class="financial-item">
            <span class="label">本月收款</span>
            <span class="value amount positive">{{ formatCurrency(financialStatus.collected) }}</span>
          </div>
          <div class="financial-item warning">
            <span class="label">逾期金額</span>
            <span class="value amount negative">{{ formatCurrency(financialStatus.overdue) }}</span>
          </div>
          <div class="financial-item">
            <span class="label">收款率</span>
            <span class="value">{{ financialStatus.collection_rate }}%</span>
          </div>
        </div>
        
        <!-- 營收趨勢圖 -->
        <div class="revenue-chart">
          <h5>營收趨勢（近6個月）</h5>
          <LineChart :data="revenueChart.data" />
        </div>
      </StatsCard>

      <!-- 待處理事項 -->
      <StatsCard :title="`⚠️ 待處理事項（${pendingItems.total}項）`">
        <div class="pending-list">
          <div 
            v-for="item in pendingItems.items"
            :key="item.id"
            :class="['pending-item', `pending-${item.type}`]"
            @click="navigateTo(item.action_url)"
          >
            <Icon :name="getItemIcon(item.type)" />
            <div class="item-content">
              <p class="message">{{ item.message }}</p>
              <span class="date">{{ formatDate(item.date) }}</span>
            </div>
            <Icon name="chevron-right" class="arrow" />
          </div>
        </div>
      </StatsCard>

      <!-- 快速操作 -->
      <div class="quick-actions">
        <StyledButton 
          v-for="action in quickActions" 
          :key="action.action"
          @click="navigateTo(action.url)"
        >
          <Icon :name="action.icon" />
          {{ action.label }}
        </StyledButton>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';
import { getDashboardData } from '@/api/dashboard';
import { useAuth } from '@/composables/useAuth';

const { user } = useAuth();
const dashboardData = ref(null);

const isAdmin = computed(() => user.value?.is_admin);
const userName = computed(() => user.value?.name);
const currentDate = computed(() => 
  new Date().toLocaleDateString('zh-TW', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    weekday: 'long'
  })
);

const myHours = computed(() => dashboardData.value?.my_hours || {});
const myTasks = computed(() => dashboardData.value?.my_tasks || {});
const myLeaves = computed(() => dashboardData.value?.my_leaves || {});
const quickActions = computed(() => dashboardData.value?.quick_actions || []);
const recentActivities = computed(() => dashboardData.value?.recent_activities || []);
const notifications = computed(() => dashboardData.value?.notifications || []);

const companyOverview = computed(() => dashboardData.value?.company_overview || {});
const financialStatus = computed(() => dashboardData.value?.financial_status || {});
const pendingItems = computed(() => dashboardData.value?.pending_items || {});
const revenueChart = computed(() => dashboardData.value?.revenue_chart || {});

onMounted(async () => {
  const response = await getDashboardData();
  dashboardData.value = response.data;
});

const navigateTo = (url) => {
  window.location.href = url;
};

const formatCurrency = (amount) => {
  return new Intl.NumberFormat('zh-TW', {
    style: 'currency',
    currency: 'TWD',
    minimumFractionDigits: 0
  }).format(amount);
};
</script>

<style scoped>
.dashboard-page {
  padding: 2rem;
  max-width: 1400px;
  margin: 0 auto;
}

.dashboard-header {
  margin-bottom: 2rem;
}

.dashboard-header h1 {
  font-size: 2rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.dashboard-header .date {
  color: #6b7280;
  font-size: 0.875rem;
}

.notifications {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-bottom: 2rem;
}

.notification {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem;
  border-radius: 0.5rem;
  background: white;
  border-left: 4px solid;
}

.notification-warning {
  border-left-color: #f59e0b;
  background: #fffbeb;
}

.notification-info {
  border-left-color: #3b82f6;
  background: #eff6ff;
}

.employee-dashboard,
.admin-dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 1.5rem;
}

.task-item {
  padding: 1rem;
  border: 1px solid #e5e7eb;
  border-radius: 0.5rem;
  cursor: pointer;
  transition: all 0.2s;
}

.task-item:hover {
  border-color: #3b82f6;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.task-item.overdue {
  border-left: 4px solid #ef4444;
}

.overdue-badge {
  color: #ef4444;
  font-weight: 600;
}

.quick-actions {
  grid-column: 1 / -1;
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.overview-grid {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
}
</style>
```

---

## 🔧 後端實現

### DashboardService

```typescript
class DashboardService {
  /**
   * 獲取儀表板數據（依角色自動切換）
   */
  async getDashboardData(user: User) {
    if (user.is_admin) {
      return await this.getAdminDashboard(user);
    } else {
      return await this.getEmployeeDashboard(user);
    }
  }
  
  /**
   * 員工儀表板數據
   */
  async getEmployeeDashboard(user: User) {
    const currentMonth = new Date().toISOString().substring(0, 7); // YYYY-MM
    
    // 1. 我的工時統計
    const myHours = await this.getMyHoursStats(user.user_id, currentMonth);
    
    // 2. 我的任務列表
    const myTasks = await this.getMyTasks(user.user_id);
    
    // 3. 我的假期餘額
    const myLeaves = await this.getMyLeaveBalance(user.user_id);
    
    // 4. 快速操作
    const quickActions = this.getEmployeeQuickActions();
    
    // 5. 最近動態（最近7天的活動）
    const recentActivities = await this.getRecentActivities(user.user_id);
    
    // 6. 通知（未讀通知）
    const notifications = await this.getEmployeeNotifications(user.user_id);
    
    return {
      user_type: 'employee',
      user_name: user.name,
      my_hours: myHours,
      my_tasks: myTasks,
      my_leaves: myLeaves,
      quick_actions: quickActions,
      recent_activities: recentActivities,
      notifications
    };
  }
  
  /**
   * 員工通知（未讀）⭐ 新增
   */
  async getEmployeeNotifications(userId: number) {
    const notifications = await this.db.prepare(`
      SELECT 
        type,
        message,
        action_url,
        created_at
      FROM Notifications
      WHERE user_id = ?
        AND is_read = 0
        AND is_deleted = 0
      ORDER BY created_at DESC
      LIMIT 10
    `).bind(userId).all();
    
    return notifications.results.map(n => ({
      type: n.type === 'missing_timesheet' ? 'warning' : 'info',
      message: n.message,
      action_url: n.action_url
    }));
  }
  
  /**
   * 財務狀況統計（管理員）⭐ 新增完整實作
   */
  async getFinancialStatus(currentMonth: string) {
    const today = new Date().toISOString().split('T')[0];
    
    // 1. 應收帳款總額（所有未收款+部分收款的收據）
    const arResult = await this.db.prepare(`
      SELECT 
        SUM(r.total_amount - COALESCE(p.paid_amount, 0)) as total_ar
      FROM Receipts r
      LEFT JOIN (
        SELECT receipt_id, SUM(amount) as paid_amount
        FROM Payments
        GROUP BY receipt_id
      ) p ON r.receipt_id = p.receipt_id
      WHERE r.status IN ('unpaid', 'partial')
        AND r.is_deleted = 0
    `).first();
    
    // 2. 本月收款金額（本月的所有收款記錄）
    const collectedResult = await this.db.prepare(`
      SELECT COALESCE(SUM(amount), 0) as collected
      FROM Payments
      WHERE strftime('%Y-%m', payment_date) = ?
    `).bind(currentMonth).first();
    
    // 3. 逾期金額（所有已逾期的未收款+部分收款收據）
    const overdueResult = await this.db.prepare(`
      SELECT 
        SUM(r.total_amount - COALESCE(p.paid_amount, 0)) as overdue
      FROM Receipts r
      LEFT JOIN (
        SELECT receipt_id, SUM(amount) as paid_amount
        FROM Payments
        GROUP BY receipt_id
      ) p ON r.receipt_id = p.receipt_id
      WHERE r.status IN ('unpaid', 'partial')
        AND r.due_date < ?
        AND r.is_deleted = 0
    `).bind(today).first();
    
    // 4. 本月開立收據總額（營收）
    const revenueResult = await this.db.prepare(`
      SELECT COALESCE(SUM(total_amount), 0) as revenue
      FROM Receipts
      WHERE strftime('%Y-%m', receipt_date) = ?
        AND status != 'cancelled'
        AND is_deleted = 0
    `).bind(currentMonth).first();
    
    // 5. 本月總成本（人力成本+管理成本，簡化版）
    const costResult = await this.db.prepare(`
      SELECT COALESCE(SUM(gross_salary), 0) as cost
      FROM MonthlyPayroll
      WHERE year = ? AND month = ?
    `).bind(
      parseInt(currentMonth.substring(0, 4)), 
      parseInt(currentMonth.substring(5, 7))
    ).first();
    
    const totalAr = arResult?.total_ar || 0;
    const collected = collectedResult?.collected || 0;
    const overdue = overdueResult?.overdue || 0;
    const revenue = revenueResult?.revenue || 0;
    const cost = costResult?.cost || 0;
    const profit = revenue - cost;
    const profitMargin = revenue > 0 ? (profit / revenue) * 100 : 0;
    
    // 6. 收款率（本月）
    const collectionRate = revenue > 0 ? (collected / revenue) * 100 : 0;
    
    return {
      month: currentMonth,
      total_ar: Math.round(totalAr),           // 應收帳款（所有未收，不限月份）
      collected: Math.round(collected),        // 本月收款
      overdue: Math.round(overdue),            // 逾期金額（所有逾期，不限月份）
      collection_rate: Math.round(collectionRate * 10) / 10,  // 收款率%
      revenue: Math.round(revenue),            // 本月營收（開立收據總額）
      cost: Math.round(cost),                  // 本月成本
      profit: Math.round(profit),              // 本月毛利
      profit_margin: Math.round(profitMargin * 10) / 10  // 毛利率%
    };
  }
  
  /**
   * 管理員儀表板數據
   */
  async getAdminDashboard(user: User) {
    const currentMonth = new Date().toISOString().substring(0, 7);
    
    // 1. 公司總覽
    const companyOverview = await this.getCompanyOverview(currentMonth);
    
    // 2. 財務狀況
    const financialStatus = await this.getFinancialStatus(currentMonth);
    
    // 3. 待處理事項
    const pendingItems = await this.getPendingItems();
    
    // 4. 營收趨勢
    const revenueChart = await this.getRevenueChart(6); // 最近6個月
    
    // 5. 快速操作
    const quickActions = this.getAdminQuickActions();
    
    // 6. 通知
    const notifications = await this.getAdminNotifications();
    
    return {
      user_type: 'admin',
      user_name: user.name,
      company_overview: companyOverview,
      financial_status: financialStatus,
      pending_items: pendingItems,
      revenue_chart: revenueChart,
      quick_actions: quickActions,
      notifications
    };
  }
  
  /**
   * 我的工時統計
   */
  async getMyHoursStats(userId: number, month: string) {
    const stats = await this.db.prepare(`
      SELECT 
        SUM(hours) as total_hours,
        SUM(CASE WHEN work_type_id = 1 THEN hours ELSE 0 END) as normal_hours,
        SUM(CASE WHEN work_type_id > 1 THEN hours ELSE 0 END) as overtime_hours
      FROM TimeLogs
      WHERE user_id = ?
        AND strftime('%Y-%m', work_date) = ?
        AND is_deleted = 0
    `).bind(userId, month).first();
    
    const target_hours = 160; // 每月目標工時
    const completion_rate = (stats.total_hours / target_hours) * 100;
    
    return {
      month,
      total_hours: stats.total_hours || 0,
      target_hours,
      normal_hours: stats.normal_hours || 0,
      overtime_hours: stats.overtime_hours || 0,
      completion_rate: Math.round(completion_rate * 10) / 10
    };
  }
  
  /**
   * 我的任務列表
   */
  async getMyTasks(userId: number) {
    const tasks = await this.db.prepare(`
      SELECT 
        t.task_id,
        t.task_name,
        c.company_name as client_name,
        t.due_date,
        t.status,
        t.related_sop_id,
        t.client_specific_sop_id,
        (SELECT COUNT(*) FROM ActiveTaskStages WHERE task_id = t.task_id AND status = 'completed') as completed_stages,
        (SELECT COUNT(*) FROM ActiveTaskStages WHERE task_id = t.task_id) as total_stages
      FROM ActiveTasks t
      JOIN ClientServices cs ON t.client_service_id = cs.client_service_id
      JOIN Clients c ON cs.client_id = c.client_id
      WHERE t.assignee_user_id = ?
        AND t.status IN ('pending', 'in_progress')
        AND t.is_deleted = 0
      ORDER BY 
        CASE WHEN t.due_date < date('now') THEN 0 ELSE 1 END,
        t.due_date ASC
      LIMIT 10
    `).bind(userId).all();
    
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    
    const taskList = tasks.results.map(task => {
      const dueDate = new Date(task.due_date);
      const isOverdue = task.due_date < today;
      
      // ⭐ 計算剩餘/逾期天數
      const daysDiff = Math.floor((dueDate - now) / (1000 * 60 * 60 * 24));
      const daysUntilDue = daysDiff;  // 正數=還有X天，負數=逾期X天
      const daysOverdue = isOverdue ? Math.abs(daysDiff) : 0;
      
      // ⭐ 計算緊急程度
      let urgencyLevel = 'normal';
      if (isOverdue) {
        urgencyLevel = 'overdue';
      } else if (daysUntilDue <= 3) {
        urgencyLevel = 'urgent';  // 3天內到期
      } else if (daysUntilDue > 7) {
        urgencyLevel = 'low';  // 還有很多時間
      }
      
      return {
        task_id: task.task_id,
        task_name: task.task_name,
        client_name: task.client_name,
        due_date: task.due_date,
        status: task.status,
        progress: `${task.completed_stages}/${task.total_stages}`,
        is_overdue: isOverdue,
        days_overdue: daysOverdue,
        days_until_due: daysUntilDue,      // ⭐ 新增
        urgency_level: urgencyLevel,        // ⭐ 新增
        has_sop: task.related_sop_id || task.client_specific_sop_id
      };
    });
    
    return {
      total: taskList.length,
      pending: taskList.filter(t => t.status === 'pending').length,
      in_progress: taskList.filter(t => t.status === 'in_progress').length,
      overdue: taskList.filter(t => t.is_overdue).length,
      urgent: taskList.filter(t => t.urgency_level === 'urgent').length,  // ⭐ 新增統計
      tasks: taskList
    };
  }
  
  /**
   * 最近動態（員工）⭐ 新增
   */
  async getRecentActivities(userId: number) {
    const activities = [];
    
    // 1. 最近完成的任務（最近7天）
    const completedTasks = await this.db.prepare(`
      SELECT 
        t.task_name,
        c.company_name,
        t.completed_date as timestamp
      FROM ActiveTasks t
      JOIN ClientServices cs ON t.client_service_id = cs.client_service_id
      JOIN Clients c ON cs.client_id = c.client_id
      WHERE t.assignee_user_id = ?
        AND t.status = 'completed'
        AND t.completed_date >= datetime('now', '-7 days')
      ORDER BY t.completed_date DESC
      LIMIT 5
    `).bind(userId).all();
    
    for (const task of completedTasks.results) {
      activities.push({
        type: 'task_completed',
        message: `完成任務：${task.company_name} - ${task.task_name}`,
        timestamp: task.timestamp
      });
    }
    
    // 2. 最近的請假記錄（最近7天）
    const recentLeaves = await this.db.prepare(`
      SELECT 
        lt.type_name,
        la.start_date,
        la.days,
        la.applied_at as timestamp
      FROM LeaveApplications la
      JOIN LeaveTypes lt ON la.leave_type_id = lt.leave_type_id
      WHERE la.user_id = ?
        AND la.applied_at >= datetime('now', '-7 days')
        AND la.is_deleted = 0
      ORDER BY la.applied_at DESC
      LIMIT 5
    `).bind(userId).all();
    
    for (const leave of recentLeaves.results) {
      activities.push({
        type: 'leave_applied',
        message: `假期申請：${leave.start_date} ${leave.type_name} ${leave.days}天`,
        timestamp: leave.timestamp
      });
    }
    
    // 3. 工時缺填提醒（從Notifications表）
    const timesheetReminders = await this.db.prepare(`
      SELECT 
        message,
        created_at as timestamp
      FROM Notifications
      WHERE user_id = ?
        AND type = 'missing_timesheet'
        AND is_deleted = 0
        AND created_at >= datetime('now', '-7 days')
      ORDER BY created_at DESC
      LIMIT 3
    `).bind(userId).all();
    
    for (const reminder of timesheetReminders.results) {
      activities.push({
        type: 'timesheet_reminder',
        message: reminder.message,
        timestamp: reminder.timestamp
      });
    }
    
    // 4. 按時間排序（最新的在前）
    activities.sort((a, b) => 
      new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
    );
    
    // 5. 最多返回10筆
    return activities.slice(0, 10);
  }
  
  /**
   * 待處理事項（管理員）
   */
  async getPendingItems() {
    const items = [];
    
    // 1. 待審核的假期申請
    const leaveApplications = await this.db.prepare(`
      SELECT 
        la.application_id,
        u.name as user_name,
        lt.type_name as leave_type,
        la.start_date,
        la.days,
        la.applied_at
      FROM LeaveApplications la
      JOIN Users u ON la.user_id = u.user_id
      JOIN LeaveTypes lt ON la.leave_type_id = lt.leave_type_id
      WHERE la.status = 'pending'
      ORDER BY la.applied_at DESC
      LIMIT 5
    `).all();
    
    for (const app of leaveApplications.results) {
      items.push({
        type: 'leave_application',
        message: `${app.user_name} - ${app.leave_type}申請（待審核）`,
        date: app.applied_at,
        action_url: `/admin/leaves/approve/${app.application_id}`
      });
    }
    
    // 2. 逾期任務
    const overdueTasks = await this.db.prepare(`
      SELECT 
        t.task_id,
        t.task_name,
        c.company_name,
        u.name as assignee_name,
        t.due_date
      FROM ActiveTasks t
      JOIN ClientServices cs ON t.client_service_id = cs.client_service_id
      JOIN Clients c ON cs.client_id = c.client_id
      JOIN Users u ON t.assignee_user_id = u.user_id
      WHERE t.status != 'completed'
        AND t.due_date < date('now')
        AND t.is_deleted = 0
      ORDER BY t.due_date ASC
      LIMIT 5
    `).all();
    
    for (const task of overdueTasks.results) {
      const daysOverdue = Math.floor(
        (new Date() - new Date(task.due_date)) / (1000 * 60 * 60 * 24)
      );
      items.push({
        type: 'overdue_task',
        message: `${task.company_name} - ${task.task_name}逾期${daysOverdue}天`,
        assignee: task.assignee_name,
        action_url: `/tasks/${task.task_id}`
      });
    }
    
    // 3. 逾期應收帳款
    const overdueReceipts = await this.db.prepare(`
      SELECT 
        r.receipt_id,
        c.company_name,
        r.total_amount,
        r.due_date,
        COALESCE(SUM(p.amount), 0) as paid_amount
      FROM Receipts r
      JOIN Clients c ON r.client_id = c.client_id
      LEFT JOIN Payments p ON r.receipt_id = p.receipt_id
      WHERE r.status IN ('unpaid', 'partial')
        AND r.due_date < date('now')
        AND r.is_deleted = 0
      GROUP BY r.receipt_id
      ORDER BY r.due_date ASC
      LIMIT 5
    `).all();
    
    for (const receipt of overdueReceipts.results) {
      const remainingAmount = receipt.total_amount - receipt.paid_amount;
      const daysOverdue = Math.floor(
        (new Date() - new Date(receipt.due_date)) / (1000 * 60 * 60 * 24)
      );
      items.push({
        type: 'overdue_payment',
        message: `${receipt.company_name} - 收據逾期${daysOverdue}天（${remainingAmount.toLocaleString()}元）`,
        action_url: `/receipts/${receipt.receipt_id}`
      });
    }
    
    return {
      total: items.length,
      items
    };
  }
}
```

---

## ✅ 業務規則

### 儀表板刷新規則

**自動刷新：**
- 頁面載入時獲取最新數據
- 每5分鐘自動刷新一次（可選）
- 用戶切換頁面返回時刷新

### 數據優先級

**員工儀表板：**
1. 逾期任務（最高優先級，紅色標示）
2. 即將到期的補休
3. 本週未填寫的工時
4. 待辦任務

**管理員儀表板：**
1. 待審核的假期申請
2. 逾期任務
3. 逾期應收帳款
4. 系統通知

### 快速操作設定

**員工快速操作：**
- 填寫今日工時
- 申請假期
- 查看我的報表

**管理員快速操作：**
- 新增客戶
- 開立收據
- 查看所有報表
- 系統設定

---

## 🧪 測試案例

```typescript
// 測試1：員工儀表板數據
test('應該返回員工儀表板數據', async () => {
  const user = { user_id: 2, is_admin: false };
  const data = await getDashboardData(user);
  expect(data.user_type).toBe('employee');
  expect(data.my_hours).toBeDefined();
  expect(data.my_tasks).toBeDefined();
});

// 測試2：管理員儀表板數據
test('應該返回管理員儀表板數據', async () => {
  const user = { user_id: 1, is_admin: true };
  const data = await getDashboardData(user);
  expect(data.user_type).toBe('admin');
  expect(data.company_overview).toBeDefined();
  expect(data.financial_status).toBeDefined();
});

// 測試3：逾期任務標示
test('應該正確標示逾期任務', async () => {
  const user = { user_id: 2, is_admin: false };
  const data = await getDashboardData(user);
  const overdueTasks = data.my_tasks.tasks.filter(t => t.is_overdue);
  expect(overdueTasks.length).toBeGreaterThan(0);
});
```

---

## ⚠️ 注意事項

1. **性能優化**：儀表板數據應該快速載入（< 1秒）
2. **權限控制**：嚴格區分員工和管理員可見內容
3. **即時性**：數據應該是最新的（使用即時查詢，不用快取）
4. **響應式設計**：在手機、平板上也要好用
5. **補休到期提醒**：月底前5天開始提醒

---

**相關文檔：**
- [工時管理-完整規格](./工時管理-完整規格.md)
- [任務管理-完整規格](./任務管理-完整規格.md)
- [假期管理-完整規格](./假期管理-完整規格.md)
 - [收據收款-完整規格](./收據收款-完整規格.md)
- [報表分析-完整規格](./報表分析-完整規格.md)

