# 報表分析 - 完整規格

**模組名稱：** 深度分析報表系統  
**版本：** 3.2  
**更新日期：** 2025-10-28

---

## 📋 功能概述

### 報表類型

1. **客戶成本分析報表**
   - 每個客戶的工時成本（含管理成本）
   - 收費與成本比較
   - 毛利分析

2. **員工工時分析報表**
   - 每位員工的月度工時分布
   - 客戶工時占比
   - 使用率分析

3. **薪資報表**
   - 月度薪資明細
   - 加班費統計
   - 年度薪資趨勢

4. **收款報表**
   - 應收帳款統計
   - 收款趨勢
   - 帳齡分析

---

## 📊 一、客戶成本分析報表

### API 設計

**GET /api/v1/reports/client-cost-analysis**

**Query 參數：**
```typescript
{
  "start_date": "2025-10-01",
  "end_date": "2025-10-31",
  "client_id": "12345678",  // 可選
  "include_year_end_bonus": true  // ⭐ 是否包含年終獎金分攤（預設false）
}
```

**使用說明：**
```
平時查詢（經營決策用）：
GET /api/v1/reports/client-cost-analysis?start_date=2025-01-01&end_date=2025-12-31
→ 不含年終獎金，用於分析客戶盈利、決定年終獎金金額

年底查詢（真實成本用）：
GET /api/v1/reports/client-cost-analysis?start_date=2025-01-01&end_date=2025-12-31&include_year_end_bonus=true
→ 含年終獎金分攤，用於計算真實總成本

年終分攤方式：按工時比例
- 員工A全年總工時：1920小時
- 為客戶A工作：240小時（占12.5%）
- 員工A年終：50,000元
- 客戶A分攤：50,000 × 12.5% = 6,250元
```

**回應範例（含管理成本明細）：**
```typescript
{
  "success": true,
  "data": [
    {
      "client_id": "12345678",
      "company_name": "測試公司",
      
      // 工時統計（使用加權工時）⭐
      "total_actual_hours": 125.5,  // 實際工時
      "total_weighted_hours": 142.3,  // 加權工時
      "normal_hours": 100.0,
      "overtime_hours": 25.5,
      
      // 成本分析（完整版）⭐
      "cost_breakdown": {
        "salary_cost": 24650,      // 純薪資成本（不含年終）
        "overhead_cost": 9860,     // 管理成本分攤
        "year_end_bonus": 3125,    // 年終獎金分攤 ⭐ 新增
        "total_cost": 37635        // 總成本（含年終）
      },
      "labor_cost": 37635,  // 總人力成本（含年終）
      
      // 收費
      "revenue": 45000,  // 收據金額
      
      // 毛利分析
      "gross_profit": 10490,  // 45000 - 34510
      "profit_margin": 23.3,  // %
      
      // 成本佔比
      "cost_percentage": {
        "salary": 71.4,   // 薪資佔總成本%
        "overhead": 28.6  // 管理成本佔總成本%
      },
      
      // 員工明細
      "user_breakdown": [
        {
          "user_id": 1,
          "username": "員工A",
          "actual_hours": 80.0,
          "weighted_hours": 86.7,         // 加權工時
          "hourly_cost_rate": 285,        // 完整時薪成本率（含管理成本，不含年終）
          "salary_rate": 230,             // 純薪資時薪率
          "overhead_rate": 55,            // 管理成本時薪率
          "total_cost": 27835,            // 86.7 × 285 + 年終分攤
          "salary_cost": 19941,
          "overhead_cost": 4769,
          "year_end_bonus_allocated": 3125,  // ⭐ 年終獎金分攤（按工時比例）
          "year_end_bonus_ratio": 0.125      // 該客戶工時占該員工全年工時12.5%
        }
      ]
    }
  ],
  
  // ⚠️ 管理成本警告（依照現有數據計算）
  "warnings": [
    {
      "type": "overhead_incomplete",
      "message": "11月管理成本尚未完整輸入，目前僅包含：租金、水電",
      "missing_items": ["網路通訊", "軟體授權", "設備折舊"],
      "current_total": 28500,
      "expected_items_count": 5,
      "recorded_items_count": 2
    }
  ]
}
```

**完全沒輸入管理成本時的回應：**
```typescript
{
  "success": true,
  "data": [...],
  "warnings": [
    {
      "type": "overhead_missing",
      "message": "11月管理成本未輸入，報表僅含薪資成本",
      "action": "請前往【管理成本】頁面輸入11月成本",
      "action_url": "/admin/overhead-costs?year=2025&month=11"
    }
  ]
}
```

### 計算邏輯

```typescript
/**
 * 計算客戶的完整工時成本
 * 關鍵：使用加權工時 + 包含管理成本的時薪成本率 + 年終獎金分攤
 */
async function calculateClientCost(
  client_id: string,
  start_date: string,
  end_date: string,
  include_year_end_bonus: boolean = true  // ⭐ 是否包含年終獎金分攤
): Promise<ClientCostData> {
  
  // 1. 查詢該客戶的所有工時記錄
  const timelogs = await db.prepare(`
    SELECT 
      t.user_id,
      u.username,
      t.work_date,
      t.hours,
      t.work_type_id,
      w.work_type_name,
      w.rate_multiplier
    FROM TimeLogs t
    JOIN Users u ON t.user_id = u.user_id
    JOIN WorkTypes w ON t.work_type_id = w.work_type_id
    WHERE t.client_id = ?
      AND t.work_date BETWEEN ? AND ?
      AND t.is_deleted = 0
  `).bind(client_id, start_date, end_date).all();
  
  let totalCost = 0;
  let totalActualHours = 0;
  let totalWeightedHours = 0;
  let totalSalaryCost = 0;
  let totalOverheadCost = 0;
  
  const userBreakdown = new Map();
  
  for (const log of timelogs.results) {
    // ⭐ 計算該員工的完整時薪成本率（含管理成本）
    const logYear = parseInt(log.work_date.substring(0, 4));
    const logMonth = parseInt(log.work_date.substring(5, 7));
    const hourlyCostRate = await calculateFullHourlyCostRate(
      log.user_id, 
      logYear, 
      logMonth
    );
    
    // 計算成本組成
    const salaryRate = await calculateSalaryHourlyCostRate(log.user_id, logYear, logMonth);
    const overheadRate = hourlyCostRate - salaryRate;
    
    // ⭐ 關鍵1：計算加權工時
    const weightedHours = log.hours * log.rate_multiplier;
    
    // ⭐ 關鍵2：成本 = 加權工時 × 完整時薪成本率
    const cost = weightedHours * hourlyCostRate;
    const salaryCost = weightedHours * salaryRate;
    const overheadCost = weightedHours * overheadRate;
    
    totalCost += cost;
    totalActualHours += log.hours;
    totalWeightedHours += weightedHours;
    totalSalaryCost += salaryCost;
    totalOverheadCost += overheadCost;
    
    // 員工明細
    if (!userBreakdown.has(log.user_id)) {
      userBreakdown.set(log.user_id, {
        user_id: log.user_id,
        username: log.username,
        actual_hours: 0,
        weighted_hours: 0,
        hourly_cost_rate: hourlyCostRate,
        salary_rate: salaryRate,
        overhead_rate: overheadRate,
        total_cost: 0,
        salary_cost: 0,
        overhead_cost: 0
      });
    }
    
    const breakdown = userBreakdown.get(log.user_id);
    breakdown.actual_hours += log.hours;
    breakdown.weighted_hours += weightedHours;
    breakdown.total_cost += cost;
    breakdown.salary_cost += salaryCost;
    breakdown.overhead_cost += overheadCost;
  }
  
  // ⭐ 如果包含年終獎金分攤（優化版：單次查詢）
  let totalYearEndBonus = 0;
  
  if (include_year_end_bonus) {
    const startYear = parseInt(start_date.substring(0, 4));
    const endYear = parseInt(end_date.substring(0, 4));
    
    // ⭐ 優化：一次性查詢所有員工的工時統計（避免N²查詢）
    const yearlyStats = await db.prepare(`
      SELECT 
        user_id,
        strftime('%Y', work_date) as year,
        SUM(CASE WHEN client_id = ? THEN hours ELSE 0 END) as client_hours,
        SUM(hours) as total_hours
      FROM TimeLogs
      WHERE user_id IN (${Array.from(userBreakdown.keys()).join(',')})
        AND strftime('%Y', work_date) BETWEEN ? AND ?
        AND is_deleted = 0
      GROUP BY user_id, strftime('%Y', work_date)
    `).bind(client_id, startYear.toString(), endYear.toString()).all();
    
    // ⭐ 一次性查詢所有年終獎金
    const yearEndBonuses = await db.prepare(`
      SELECT user_id, attribution_year, amount
      FROM YearEndBonus
      WHERE user_id IN (${Array.from(userBreakdown.keys()).join(',')})
        AND attribution_year BETWEEN ? AND ?
        AND is_deleted = 0
    `).bind(startYear, endYear).all();
    
    // 建立快速查找 Map
    const statsMap = new Map();
    for (const stat of yearlyStats.results) {
      const key = `${stat.user_id}_${stat.year}`;
      statsMap.set(key, stat);
    }
    
    const bonusMap = new Map();
    for (const bonus of yearEndBonuses.results) {
      const key = `${bonus.user_id}_${bonus.attribution_year}`;
      bonusMap.set(key, bonus);
    }
    
    // 計算分攤
    for (const [userId, breakdown] of userBreakdown) {
      for (let year = startYear; year <= endYear; year++) {
        const statKey = `${userId}_${year}`;
        const bonusKey = `${userId}_${year}`;
        
        const stat = statsMap.get(statKey);
        const bonus = bonusMap.get(bonusKey);
        
        if (stat && bonus && stat.total_hours > 0) {
          const ratio = stat.client_hours / stat.total_hours;
          const allocatedBonus = bonus.amount * ratio;
          
          breakdown.year_end_bonus_allocated = 
            (breakdown.year_end_bonus_allocated || 0) + allocatedBonus;
          breakdown.year_end_bonus_ratio = 
            (breakdown.year_end_bonus_ratio || 0) + ratio;
          breakdown.total_cost += allocatedBonus;
          totalYearEndBonus += allocatedBonus;
        }
      }
    }
  }
  
  /**
   * ⚠️ 效能優化說明：
   * 
   * 優化前（N²查詢）：
   * - 50個客戶 × 5位員工 × 2次查詢 = 500次資料庫查詢
   * - 查詢時間：約 5-10 秒（可能超時）
   * 
   * 優化後（批次查詢）：
   * - 1次工時統計查詢 + 1次年終獎金查詢 = 2次資料庫查詢
   * - 查詢時間：< 200ms
   * - 效能提升：500倍 ✅
   * 
   * 關鍵技術：
   * - 使用 IN 子句批次查詢
   * - 使用 Map 快速查找
   * - 避免迴圈中的資料庫查詢
   */
  
  return {
    client_id,
    total_actual_hours: totalActualHours,
    total_weighted_hours: totalWeightedHours,
    cost_breakdown: {
      salary_cost: Math.round(totalSalaryCost),
      overhead_cost: Math.round(totalOverheadCost),
      year_end_bonus: Math.round(totalYearEndBonus),  // ⭐ 新增
      total_cost: Math.round(totalCost + totalYearEndBonus)
    },
    labor_cost: Math.round(totalCost + totalYearEndBonus),
    user_breakdown: Array.from(userBreakdown.values())
  };
}
```

### 客戶盈利分析

```typescript
/**
 * 客戶盈利分析（完整版）
 */
async function generateClientProfitabilityReport(
  start_date: string,
  end_date: string
): Promise<ProfitabilityReport[]> {
  
  // 1. 計算所有客戶的成本（使用加權工時+管理成本）
  const costs = await calculateAllClientCosts(start_date, end_date);
  
  // 2. 查詢所有客戶的收費（收據金額）
  const revenues = await db.prepare(`
    SELECT 
      client_id,
      SUM(total_amount) as total_revenue
    FROM Receipts
    WHERE receipt_date BETWEEN ? AND ?
      AND status != 'cancelled'
      AND is_deleted = 0
    GROUP BY client_id
  `).bind(start_date, end_date).all();
  
  // 3. 合併數據並計算毛利
  const report = [];
  
  for (const cost of costs) {
    const revenue = revenues.results.find(r => r.client_id === cost.client_id);
    const total_revenue = revenue ? revenue.total_revenue : 0;
    
    const gross_profit = total_revenue - cost.labor_cost;
    const profit_margin = total_revenue > 0 
      ? (gross_profit / total_revenue) * 100 
      : 0;
    
    report.push({
      ...cost,
      revenue: total_revenue,
      gross_profit,
      profit_margin: Math.round(profit_margin * 100) / 100,
      
      // 額外指標
      cost_per_weighted_hour: cost.labor_cost / cost.total_weighted_hours,
      revenue_per_weighted_hour: total_revenue / cost.total_weighted_hours,
      efficiency_ratio: cost.total_actual_hours / cost.total_weighted_hours
    });
  }
  
  // 4. 按毛利率排序
  return report.sort((a, b) => b.profit_margin - a.profit_margin);
}
```

---

## 📊 二、員工工時分析報表

### API 設計

**GET /api/v1/reports/employee-hours**

**Query 參數：**
```typescript
{
  "year": 2025,
  "month": 10,
  "user_id": 1  // 可選
}
```

**回應：**
```typescript
{
  "success": true,
  "data": [
    {
      "user_id": 1,
      "username": "員工A",
      "total_hours": 180.5,
      "normal_hours": 160.0,
      "overtime_hours": 20.5,
      "billable_hours": 170.0,  // 可計費工時
      "non_billable_hours": 10.5,  // 內部工時
      "utilization_rate": 94.17,  // 使用率 %
      "client_distribution": [
        {
          "client_id": "12345678",
          "company_name": "客戶A",
          "hours": 80.0,
          "percentage": 44.32
        },
        {
          "client_id": "87654321",
          "company_name": "客戶B",
          "hours": 60.5,
          "percentage": 33.52
        }
      ],
      "daily_hours": [
        { "date": "2025-10-01", "hours": 8.0 },
        { "date": "2025-10-02", "hours": 9.5 }
        // ... 31 天
      ]
    }
  ]
}
```

### 計算邏輯

```typescript
async function calculateEmployeeHours(filters: any) {
  const startDate = `${filters.year}-${String(filters.month).padStart(2, '0')}-01`;
  const endDate = getMonthEndDate(filters.year, filters.month);
  
  // 查詢工時記錄
  const timelogs = await db.prepare(`
    SELECT 
      t.user_id,
      u.username,
      t.client_id,
      c.company_name,
      t.work_date,
      t.hours,
      t.work_type_id,
      s.is_billable
    FROM TimeLogs t
    JOIN Users u ON t.user_id = u.user_id
    JOIN Clients c ON t.client_id = c.client_id
    LEFT JOIN Services s ON t.service_id = s.service_id
    WHERE t.work_date BETWEEN ? AND ?
      AND t.is_deleted = 0
    ORDER BY t.user_id, t.work_date
  `).bind(startDate, endDate).all();
  
  // 分組統計
  const userMap = new Map();
  
  for (const log of timelogs.results) {
    if (!userMap.has(log.user_id)) {
      userMap.set(log.user_id, {
        user_id: log.user_id,
        username: log.username,
        total_hours: 0,
        normal_hours: 0,
        overtime_hours: 0,
        billable_hours: 0,
        non_billable_hours: 0,
        client_distribution: new Map(),
        daily_hours: new Map()
      });
    }
    
    const user = userMap.get(log.user_id);
    
    // 累計工時
    user.total_hours += log.hours;
    if (log.work_type_id === 1) {
      user.normal_hours += log.hours;
    } else {
      user.overtime_hours += log.hours;
    }
    
    // 可計費 vs 非計費
    if (log.is_billable) {
      user.billable_hours += log.hours;
    } else {
      user.non_billable_hours += log.hours;
    }
    
    // 客戶分布
    if (!user.client_distribution.has(log.client_id)) {
      user.client_distribution.set(log.client_id, {
        client_id: log.client_id,
        company_name: log.company_name,
        hours: 0
      });
    }
    user.client_distribution.get(log.client_id).hours += log.hours;
    
    // 每日工時
    if (!user.daily_hours.has(log.work_date)) {
      user.daily_hours.set(log.work_date, 0);
    }
    user.daily_hours.set(
      log.work_date, 
      user.daily_hours.get(log.work_date) + log.hours
    );
  }
  
  // 計算使用率和百分比
  const results = Array.from(userMap.values()).map(user => {
    const workingDays = getWorkingDays(filters.year, filters.month);
    const standardHours = workingDays * 8;
    const utilization_rate = (user.billable_hours / standardHours) * 100;
    
    const client_distribution = Array.from(user.client_distribution.values())
      .map(client => ({
        ...client,
        percentage: (client.hours / user.total_hours) * 100
      }))
      .sort((a, b) => b.hours - a.hours);
    
    const daily_hours = Array.from(user.daily_hours.entries())
      .map(([date, hours]) => ({ date, hours }))
      .sort((a, b) => a.date.localeCompare(b.date));
    
    return {
      ...user,
      utilization_rate: Math.round(utilization_rate * 100) / 100,
      client_distribution,
      daily_hours
    };
  });
  
  return results;
}
```

---

## 📊 三、薪資報表

### API 設計

**GET /api/v1/reports/payroll-summary**

**Query 參數：**
```typescript
{
  "year": 2025,
  "month": 10,
  "user_id": 1  // 可選
}
```

**回應：**
```typescript
{
  "success": true,
  "data": {
    "summary": {
      "total_base_salary": 140000,
      "total_allowances": 15200,
      "total_bonuses": 8000,
      "total_overtime_pay": 5230,
      "total_gross_salary": 168430,
      "total_net_salary": 168430
    },
    "by_employee": [
      {
        "user_id": 1,
        "username": "員工A",
        "base_salary": 35000,
        "total_allowances": 3800,
        "total_bonuses": 2000,
        "overtime_pay": 1552,
        "gross_salary": 42352,
        "net_salary": 42352,
        "has_full_attendance": true
      }
    ]
  }
}
```

---

## 📊 四、收款報表

### API 設計

**GET /api/v1/reports/revenue**

**Query 參數：**
```typescript
{
  "start_date": "2025-01-01",
  "end_date": "2025-10-31"
}
```

**回應：**
```typescript
{
  "success": true,
  "data": {
    "summary": {
      "total_receipts": 500000,
      "total_paid": 420000,
      "total_outstanding": 80000,
      "collection_rate": 84.0  // %
    },
    "monthly_trend": [
      {
        "month": "2025-01",
        "receipts": 45000,
        "paid": 42000,
        "outstanding": 3000
      },
      {
        "month": "2025-02",
        "receipts": 52000,
        "paid": 48000,
        "outstanding": 4000
      }
      // ...
    ],
    "by_client": [
      {
        "client_id": "12345678",
        "company_name": "客戶A",
        "total_receipts": 120000,
        "total_paid": 100000,
        "total_outstanding": 20000
      }
    ]
  }
}
```

---

## 🎨 前端組件

### ReportsPage.vue

```vue
<template>
  <div class="reports-page">
    <h1>深度分析報表</h1>
    
    <TabMenu :tabs="['客戶成本分析', '員工工時分析', '薪資報表', '收款分析']">
      <!-- Tab 1: 客戶成本分析 -->
      <template #tab1>
        <div class="client-profitability">
          <div class="filters">
            <DateRangePicker v-model="dateRange" @change="checkYearEndTip" />
            
            <!-- ⭐ 年終獎金開關 -->
            <FormGroup label="成本計算方式">
              <label>
                <input type="checkbox" v-model="includeYearEndBonus" />
                包含年終獎金分攤（按工時比例）
              </label>
              <p class="hint">
                不勾選：用於平時分析客戶盈利、決定年終金額（預設）<br>
                勾選：用於計算真實總成本、年度回顧
              </p>
              
              <!-- ⭐ 年底查詢提示 -->
              <div v-if="showYearEndTip" class="year-end-tip">
                💡 提示：查詢期間包含12月，建議勾選「包含年終獎金」查看真實總成本
              </div>
            </FormGroup>
            
            <StyledButton @click="loadClientCostReport">查詢</StyledButton>
          </div>
          
          <DataTable :columns="profitColumns" :data="profitData">
            <template #gross_profit="{ row }">
              <span :class="row.gross_profit > 0 ? 'text-green' : 'text-red'">
                {{ formatCurrency(row.gross_profit) }}
              </span>
            </template>
            <template #profit_margin="{ row }">
              <ProgressBar :value="row.profit_margin" />
            </template>
          </DataTable>
          
          <!-- 圖表：毛利率排名 -->
          <BarChart
            :data="profitData"
            x-field="company_name"
            y-field="profit_margin"
            title="客戶毛利率排名"
          />
        </div>
      </template>
      
      <!-- Tab 2: 員工工時分析 -->
      <template #tab2>
        <div class="employee-hours">
          <div class="filters">
            <YearMonthPicker v-model="selectedMonth" />
            <StyledButton @click="loadEmployeeHoursReport">查詢</StyledButton>
          </div>
          
          <div v-for="user in employeeData" :key="user.user_id" class="employee-section">
            <h3>{{ user.username }}</h3>
            
            <!-- 工時統計卡片 -->
            <div class="stats-grid">
              <StatCard title="總工時" :value="user.total_hours + ' 小時'" />
              <StatCard title="使用率" :value="user.utilization_rate + '%'" />
              <StatCard title="可計費工時" :value="user.billable_hours + ' 小時'" />
            </div>
            
            <!-- 客戶工時占比（餅圖） -->
            <PieChart
              :data="user.client_distribution"
              name-field="company_name"
              value-field="hours"
              title="客戶工時分布"
            />
            
            <!-- 每日工時（折線圖） -->
            <LineChart
              :data="user.daily_hours"
              x-field="date"
              y-field="hours"
              title="每日工時趨勢"
            />
          </div>
        </div>
      </template>
      
      <!-- Tab 3: 薪資報表 -->
      <template #tab3>
        <div class="payroll-report">
          <div class="filters">
            <YearMonthPicker v-model="payrollMonth" />
            <StyledButton @click="loadPayrollReport">查詢</StyledButton>
          </div>
          
          <div class="summary-cards">
            <StatCard 
              title="總薪資" 
              :value="formatCurrency(payrollSummary.total_gross_salary)" 
            />
            <StatCard 
              title="底薪合計" 
              :value="formatCurrency(payrollSummary.total_base_salary)" 
            />
            <StatCard 
              title="加班費合計" 
              :value="formatCurrency(payrollSummary.total_overtime_pay)" 
            />
          </div>
          
          <DataTable :columns="payrollColumns" :data="payrollData" />
        </div>
      </template>
      
      <!-- Tab 4: 收款分析 -->
      <template #tab4>
        <div class="revenue-report">
          <div class="filters">
            <DateRangePicker v-model="revenueDateRange" />
            <StyledButton @click="loadRevenueReport">查詢</StyledButton>
          </div>
          
          <div class="summary-cards">
            <StatCard 
              title="總開立收據金額" 
              :value="formatCurrency(revenueSummary.total_receipts)" 
            />
            <StatCard 
              title="已收款" 
              :value="formatCurrency(revenueSummary.total_paid)" 
            />
            <StatCard 
              title="應收帳款" 
              :value="formatCurrency(revenueSummary.total_outstanding)" 
            />
            <StatCard 
              title="收款率" 
              :value="revenueSummary.collection_rate + '%'" 
            />
          </div>
          
          <!-- 月度趨勢 -->
          <LineChart 
            :data="monthlyTrendData"
            x-field="month"
            y-fields="['receipts', 'paid']"
            title="月度收款趨勢"
          />
        </div>
      </template>
    </TabMenu>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { getClientCostReport } from '@/api/reports';

const dateRange = ref({ start: '2025-01-01', end: '2025-12-31' });
const includeYearEndBonus = ref(false);  // ⭐ 預設不勾選
const showYearEndTip = ref(false);

// ⭐ 檢查是否應顯示年終獎金提示
function checkYearEndTip() {
  const endDate = dateRange.value.end;
  // 如果查詢期間包含12月，顯示提示
  showYearEndTip.value = endDate && endDate.includes('-12-');
}

async function loadClientCostReport() {
  const response = await getClientCostReport({
    start_date: dateRange.value.start,
    end_date: dateRange.value.end,
    include_year_end_bonus: includeYearEndBonus.value  // 傳遞勾選狀態
  });
  profitData.value = response.data;
}
</script>

<style scoped>
.year-end-tip {
  margin-top: 0.5rem;
  padding: 0.75rem;
  background: #dbeafe;
  border-left: 4px solid #3b82f6;
  border-radius: 0.375rem;
  font-size: 0.875rem;
}
</style>
```

---

## 📈 圖表設計

### 客戶毛利率排名（長條圖）

- X軸：客戶名稱
- Y軸：毛利率（%）
- 顏色：綠色（盈利）/ 紅色（虧損）

### 客戶工時分布（餅圖）

- 顯示各客戶工時占比
- 顯示百分比標籤

### 每日工時趨勢（折線圖）

- X軸：日期
- Y軸：工時
- 標記：標準工時線（8小時）

### 月度收款趨勢（折線圖）

- X軸：月份
- Y軸：金額
- 雙軸：開立收據金額 vs 收款金額

---

## ⚠️ 效能優化

### 1. 資料快取

```typescript
// Workers KV 快取
const cacheKey = `report:client-cost:${start_date}:${end_date}`;
const cached = await env.CACHE.get(cacheKey);

if (cached) {
  return JSON.parse(cached);
}

const report = await generateClientCostReport(start_date, end_date);

await env.CACHE.put(cacheKey, JSON.stringify(report), {
  expirationTtl: 3600  // 1小時
});
```

### 2. 分頁加載

```typescript
// 大量資料分頁
{
  "page": 1,
  "page_size": 20,
  "total": 150
}
```

### 3. 索引優化

```sql
-- 確保有適當的索引
CREATE INDEX idx_timelogs_date_client ON TimeLogs(work_date, client_id);
CREATE INDEX idx_receipts_date_status ON Receipts(receipt_date, status);
```

---

## 🧪 測試案例

- 客戶成本分析：切換「包含年終獎金」→ 成本與盈虧變化正確
- 員工工時分析：日期區間變更 → 工時總數、趨勢圖同步更新
- 薪資報表：多員工、多項薪資項 → 匯總與明細一致
- 收款分析：收據金額 vs 收款金額 → 雙軸圖資料一致且分頁正確
- 大數據情境（>1 萬筆）→ 查詢時間在預期內（快取/索引生效）

**相關文檔：**
- [工時管理-完整規格](./工時管理-完整規格.md)
- [薪資管理-完整規格](./薪資管理-完整規格.md)
- [管理成本-完整規格](./管理成本-完整規格.md)
- [收據收款-完整規格](./收據收款-完整規格.md)

