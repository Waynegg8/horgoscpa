# å ±è¡¨åˆ†æ - å®Œæ•´è¦æ ¼

**æ¨¡çµ„åç¨±ï¼š** æ·±åº¦åˆ†æå ±è¡¨ç³»çµ±  
**ç‰ˆæœ¬ï¼š** 3.2  
**æ›´æ–°æ—¥æœŸï¼š** 2025-10-28

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

### å ±è¡¨é¡å‹

1. **å®¢æˆ¶æˆæœ¬åˆ†æå ±è¡¨**
   - æ¯å€‹å®¢æˆ¶çš„å·¥æ™‚æˆæœ¬ï¼ˆå«ç®¡ç†æˆæœ¬ï¼‰
   - æ”¶è²»èˆ‡æˆæœ¬æ¯”è¼ƒ
   - æ¯›åˆ©åˆ†æ

2. **å“¡å·¥å·¥æ™‚åˆ†æå ±è¡¨**
   - æ¯ä½å“¡å·¥çš„æœˆåº¦å·¥æ™‚åˆ†å¸ƒ
   - å®¢æˆ¶å·¥æ™‚å æ¯”
   - ä½¿ç”¨ç‡åˆ†æ

3. **è–ªè³‡å ±è¡¨**
   - æœˆåº¦è–ªè³‡æ˜ç´°
   - åŠ ç­è²»çµ±è¨ˆ
   - å¹´åº¦è–ªè³‡è¶¨å‹¢

4. **æ”¶æ¬¾å ±è¡¨**
   - æ‡‰æ”¶å¸³æ¬¾çµ±è¨ˆ
   - æ”¶æ¬¾è¶¨å‹¢
   - å¸³é½¡åˆ†æ

---

## ğŸ“Š ä¸€ã€å®¢æˆ¶æˆæœ¬åˆ†æå ±è¡¨

### API è¨­è¨ˆ

**GET /api/v1/reports/client-cost-analysis**

**Query åƒæ•¸ï¼š**
```typescript
{
  "start_date": "2025-10-01",
  "end_date": "2025-10-31",
  "client_id": "12345678",  // å¯é¸
  "include_year_end_bonus": true  // â­ æ˜¯å¦åŒ…å«å¹´çµ‚çé‡‘åˆ†æ”¤ï¼ˆé è¨­falseï¼‰
}
```

**ä½¿ç”¨èªªæ˜ï¼š**
```
å¹³æ™‚æŸ¥è©¢ï¼ˆç¶“ç‡Ÿæ±ºç­–ç”¨ï¼‰ï¼š
GET /api/v1/reports/client-cost-analysis?start_date=2025-01-01&end_date=2025-12-31
â†’ ä¸å«å¹´çµ‚çé‡‘ï¼Œç”¨æ–¼åˆ†æå®¢æˆ¶ç›ˆåˆ©ã€æ±ºå®šå¹´çµ‚çé‡‘é‡‘é¡

å¹´åº•æŸ¥è©¢ï¼ˆçœŸå¯¦æˆæœ¬ç”¨ï¼‰ï¼š
GET /api/v1/reports/client-cost-analysis?start_date=2025-01-01&end_date=2025-12-31&include_year_end_bonus=true
â†’ å«å¹´çµ‚çé‡‘åˆ†æ”¤ï¼Œç”¨æ–¼è¨ˆç®—çœŸå¯¦ç¸½æˆæœ¬

å¹´çµ‚åˆ†æ”¤æ–¹å¼ï¼šæŒ‰å·¥æ™‚æ¯”ä¾‹
- å“¡å·¥Aå…¨å¹´ç¸½å·¥æ™‚ï¼š1920å°æ™‚
- ç‚ºå®¢æˆ¶Aå·¥ä½œï¼š240å°æ™‚ï¼ˆå 12.5%ï¼‰
- å“¡å·¥Aå¹´çµ‚ï¼š50,000å…ƒ
- å®¢æˆ¶Aåˆ†æ”¤ï¼š50,000 Ã— 12.5% = 6,250å…ƒ
```

**å›æ‡‰ç¯„ä¾‹ï¼ˆå«ç®¡ç†æˆæœ¬æ˜ç´°ï¼‰ï¼š**
```typescript
{
  "success": true,
  "data": [
    {
      "client_id": "12345678",
      "company_name": "æ¸¬è©¦å…¬å¸",
      
      // å·¥æ™‚çµ±è¨ˆï¼ˆä½¿ç”¨åŠ æ¬Šå·¥æ™‚ï¼‰â­
      "total_actual_hours": 125.5,  // å¯¦éš›å·¥æ™‚
      "total_weighted_hours": 142.3,  // åŠ æ¬Šå·¥æ™‚
      "normal_hours": 100.0,
      "overtime_hours": 25.5,
      
      // æˆæœ¬åˆ†æï¼ˆå®Œæ•´ç‰ˆï¼‰â­
      "cost_breakdown": {
        "salary_cost": 24650,      // ç´”è–ªè³‡æˆæœ¬ï¼ˆä¸å«å¹´çµ‚ï¼‰
        "overhead_cost": 9860,     // ç®¡ç†æˆæœ¬åˆ†æ”¤
        "year_end_bonus": 3125,    // å¹´çµ‚çé‡‘åˆ†æ”¤ â­ æ–°å¢
        "total_cost": 37635        // ç¸½æˆæœ¬ï¼ˆå«å¹´çµ‚ï¼‰
      },
      "labor_cost": 37635,  // ç¸½äººåŠ›æˆæœ¬ï¼ˆå«å¹´çµ‚ï¼‰
      
      // æ”¶è²»
      "revenue": 45000,  // æ”¶æ“šé‡‘é¡
      
      // æ¯›åˆ©åˆ†æ
      "gross_profit": 10490,  // 45000 - 34510
      "profit_margin": 23.3,  // %
      
      // æˆæœ¬ä½”æ¯”
      "cost_percentage": {
        "salary": 71.4,   // è–ªè³‡ä½”ç¸½æˆæœ¬%
        "overhead": 28.6  // ç®¡ç†æˆæœ¬ä½”ç¸½æˆæœ¬%
      },
      
      // å“¡å·¥æ˜ç´°
      "user_breakdown": [
        {
          "user_id": 1,
          "username": "å“¡å·¥A",
          "actual_hours": 80.0,
          "weighted_hours": 86.7,         // åŠ æ¬Šå·¥æ™‚
          "hourly_cost_rate": 285,        // å®Œæ•´æ™‚è–ªæˆæœ¬ç‡ï¼ˆå«ç®¡ç†æˆæœ¬ï¼Œä¸å«å¹´çµ‚ï¼‰
          "salary_rate": 230,             // ç´”è–ªè³‡æ™‚è–ªç‡
          "overhead_rate": 55,            // ç®¡ç†æˆæœ¬æ™‚è–ªç‡
          "total_cost": 27835,            // 86.7 Ã— 285 + å¹´çµ‚åˆ†æ”¤
          "salary_cost": 19941,
          "overhead_cost": 4769,
          "year_end_bonus_allocated": 3125,  // â­ å¹´çµ‚çé‡‘åˆ†æ”¤ï¼ˆæŒ‰å·¥æ™‚æ¯”ä¾‹ï¼‰
          "year_end_bonus_ratio": 0.125      // è©²å®¢æˆ¶å·¥æ™‚å è©²å“¡å·¥å…¨å¹´å·¥æ™‚12.5%
        }
      ]
    }
  ],
  
  // âš ï¸ ç®¡ç†æˆæœ¬è­¦å‘Šï¼ˆä¾ç…§ç¾æœ‰æ•¸æ“šè¨ˆç®—ï¼‰
  "warnings": [
    {
      "type": "overhead_incomplete",
      "message": "11æœˆç®¡ç†æˆæœ¬å°šæœªå®Œæ•´è¼¸å…¥ï¼Œç›®å‰åƒ…åŒ…å«ï¼šç§Ÿé‡‘ã€æ°´é›»",
      "missing_items": ["ç¶²è·¯é€šè¨Š", "è»Ÿé«”æˆæ¬Š", "è¨­å‚™æŠ˜èˆŠ"],
      "current_total": 28500,
      "expected_items_count": 5,
      "recorded_items_count": 2
    }
  ]
}
```

**å®Œå…¨æ²’è¼¸å…¥ç®¡ç†æˆæœ¬æ™‚çš„å›æ‡‰ï¼š**
```typescript
{
  "success": true,
  "data": [...],
  "warnings": [
    {
      "type": "overhead_missing",
      "message": "11æœˆç®¡ç†æˆæœ¬æœªè¼¸å…¥ï¼Œå ±è¡¨åƒ…å«è–ªè³‡æˆæœ¬",
      "action": "è«‹å‰å¾€ã€ç®¡ç†æˆæœ¬ã€‘é é¢è¼¸å…¥11æœˆæˆæœ¬",
      "action_url": "/admin/overhead-costs?year=2025&month=11"
    }
  ]
}
```

### è¨ˆç®—é‚è¼¯

```typescript
/**
 * è¨ˆç®—å®¢æˆ¶çš„å®Œæ•´å·¥æ™‚æˆæœ¬
 * é—œéµï¼šä½¿ç”¨åŠ æ¬Šå·¥æ™‚ + åŒ…å«ç®¡ç†æˆæœ¬çš„æ™‚è–ªæˆæœ¬ç‡ + å¹´çµ‚çé‡‘åˆ†æ”¤
 */
async function calculateClientCost(
  client_id: string,
  start_date: string,
  end_date: string,
  include_year_end_bonus: boolean = true  // â­ æ˜¯å¦åŒ…å«å¹´çµ‚çé‡‘åˆ†æ”¤
): Promise<ClientCostData> {
  
  // 1. æŸ¥è©¢è©²å®¢æˆ¶çš„æ‰€æœ‰å·¥æ™‚è¨˜éŒ„
  const timelogs = await db.prepare(`
    SELECT 
      t.user_id,
      u.username,
      t.work_date,
      t.hours,
      t.work_type_id,
      w.work_type_name,
      w.rate_multiplier
    FROM TimeLogs t
    JOIN Users u ON t.user_id = u.user_id
    JOIN WorkTypes w ON t.work_type_id = w.work_type_id
    WHERE t.client_id = ?
      AND t.work_date BETWEEN ? AND ?
      AND t.is_deleted = 0
  `).bind(client_id, start_date, end_date).all();
  
  let totalCost = 0;
  let totalActualHours = 0;
  let totalWeightedHours = 0;
  let totalSalaryCost = 0;
  let totalOverheadCost = 0;
  
  const userBreakdown = new Map();
  
  for (const log of timelogs.results) {
    // â­ è¨ˆç®—è©²å“¡å·¥çš„å®Œæ•´æ™‚è–ªæˆæœ¬ç‡ï¼ˆå«ç®¡ç†æˆæœ¬ï¼‰
    const logYear = parseInt(log.work_date.substring(0, 4));
    const logMonth = parseInt(log.work_date.substring(5, 7));
    const hourlyCostRate = await calculateFullHourlyCostRate(
      log.user_id, 
      logYear, 
      logMonth
    );
    
    // è¨ˆç®—æˆæœ¬çµ„æˆ
    const salaryRate = await calculateSalaryHourlyCostRate(log.user_id, logYear, logMonth);
    const overheadRate = hourlyCostRate - salaryRate;
    
    // â­ é—œéµ1ï¼šè¨ˆç®—åŠ æ¬Šå·¥æ™‚
    const weightedHours = log.hours * log.rate_multiplier;
    
    // â­ é—œéµ2ï¼šæˆæœ¬ = åŠ æ¬Šå·¥æ™‚ Ã— å®Œæ•´æ™‚è–ªæˆæœ¬ç‡
    const cost = weightedHours * hourlyCostRate;
    const salaryCost = weightedHours * salaryRate;
    const overheadCost = weightedHours * overheadRate;
    
    totalCost += cost;
    totalActualHours += log.hours;
    totalWeightedHours += weightedHours;
    totalSalaryCost += salaryCost;
    totalOverheadCost += overheadCost;
    
    // å“¡å·¥æ˜ç´°
    if (!userBreakdown.has(log.user_id)) {
      userBreakdown.set(log.user_id, {
        user_id: log.user_id,
        username: log.username,
        actual_hours: 0,
        weighted_hours: 0,
        hourly_cost_rate: hourlyCostRate,
        salary_rate: salaryRate,
        overhead_rate: overheadRate,
        total_cost: 0,
        salary_cost: 0,
        overhead_cost: 0
      });
    }
    
    const breakdown = userBreakdown.get(log.user_id);
    breakdown.actual_hours += log.hours;
    breakdown.weighted_hours += weightedHours;
    breakdown.total_cost += cost;
    breakdown.salary_cost += salaryCost;
    breakdown.overhead_cost += overheadCost;
  }
  
  // â­ å¦‚æœåŒ…å«å¹´çµ‚çé‡‘åˆ†æ”¤ï¼ˆå„ªåŒ–ç‰ˆï¼šå–®æ¬¡æŸ¥è©¢ï¼‰
  let totalYearEndBonus = 0;
  
  if (include_year_end_bonus) {
    const startYear = parseInt(start_date.substring(0, 4));
    const endYear = parseInt(end_date.substring(0, 4));
    
    // â­ å„ªåŒ–ï¼šä¸€æ¬¡æ€§æŸ¥è©¢æ‰€æœ‰å“¡å·¥çš„å·¥æ™‚çµ±è¨ˆï¼ˆé¿å…NÂ²æŸ¥è©¢ï¼‰
    const yearlyStats = await db.prepare(`
      SELECT 
        user_id,
        strftime('%Y', work_date) as year,
        SUM(CASE WHEN client_id = ? THEN hours ELSE 0 END) as client_hours,
        SUM(hours) as total_hours
      FROM TimeLogs
      WHERE user_id IN (${Array.from(userBreakdown.keys()).join(',')})
        AND strftime('%Y', work_date) BETWEEN ? AND ?
        AND is_deleted = 0
      GROUP BY user_id, strftime('%Y', work_date)
    `).bind(client_id, startYear.toString(), endYear.toString()).all();
    
    // â­ ä¸€æ¬¡æ€§æŸ¥è©¢æ‰€æœ‰å¹´çµ‚çé‡‘
    const yearEndBonuses = await db.prepare(`
      SELECT user_id, attribution_year, amount
      FROM YearEndBonus
      WHERE user_id IN (${Array.from(userBreakdown.keys()).join(',')})
        AND attribution_year BETWEEN ? AND ?
        AND is_deleted = 0
    `).bind(startYear, endYear).all();
    
    // å»ºç«‹å¿«é€ŸæŸ¥æ‰¾ Map
    const statsMap = new Map();
    for (const stat of yearlyStats.results) {
      const key = `${stat.user_id}_${stat.year}`;
      statsMap.set(key, stat);
    }
    
    const bonusMap = new Map();
    for (const bonus of yearEndBonuses.results) {
      const key = `${bonus.user_id}_${bonus.attribution_year}`;
      bonusMap.set(key, bonus);
    }
    
    // è¨ˆç®—åˆ†æ”¤
    for (const [userId, breakdown] of userBreakdown) {
      for (let year = startYear; year <= endYear; year++) {
        const statKey = `${userId}_${year}`;
        const bonusKey = `${userId}_${year}`;
        
        const stat = statsMap.get(statKey);
        const bonus = bonusMap.get(bonusKey);
        
        if (stat && bonus && stat.total_hours > 0) {
          const ratio = stat.client_hours / stat.total_hours;
          const allocatedBonus = bonus.amount * ratio;
          
          breakdown.year_end_bonus_allocated = 
            (breakdown.year_end_bonus_allocated || 0) + allocatedBonus;
          breakdown.year_end_bonus_ratio = 
            (breakdown.year_end_bonus_ratio || 0) + ratio;
          breakdown.total_cost += allocatedBonus;
          totalYearEndBonus += allocatedBonus;
        }
      }
    }
  }
  
  /**
   * âš ï¸ æ•ˆèƒ½å„ªåŒ–èªªæ˜ï¼š
   * 
   * å„ªåŒ–å‰ï¼ˆNÂ²æŸ¥è©¢ï¼‰ï¼š
   * - 50å€‹å®¢æˆ¶ Ã— 5ä½å“¡å·¥ Ã— 2æ¬¡æŸ¥è©¢ = 500æ¬¡è³‡æ–™åº«æŸ¥è©¢
   * - æŸ¥è©¢æ™‚é–“ï¼šç´„ 5-10 ç§’ï¼ˆå¯èƒ½è¶…æ™‚ï¼‰
   * 
   * å„ªåŒ–å¾Œï¼ˆæ‰¹æ¬¡æŸ¥è©¢ï¼‰ï¼š
   * - 1æ¬¡å·¥æ™‚çµ±è¨ˆæŸ¥è©¢ + 1æ¬¡å¹´çµ‚çé‡‘æŸ¥è©¢ = 2æ¬¡è³‡æ–™åº«æŸ¥è©¢
   * - æŸ¥è©¢æ™‚é–“ï¼š< 200ms
   * - æ•ˆèƒ½æå‡ï¼š500å€ âœ…
   * 
   * é—œéµæŠ€è¡“ï¼š
   * - ä½¿ç”¨ IN å­å¥æ‰¹æ¬¡æŸ¥è©¢
   * - ä½¿ç”¨ Map å¿«é€ŸæŸ¥æ‰¾
   * - é¿å…è¿´åœˆä¸­çš„è³‡æ–™åº«æŸ¥è©¢
   */
  
  return {
    client_id,
    total_actual_hours: totalActualHours,
    total_weighted_hours: totalWeightedHours,
    cost_breakdown: {
      salary_cost: Math.round(totalSalaryCost),
      overhead_cost: Math.round(totalOverheadCost),
      year_end_bonus: Math.round(totalYearEndBonus),  // â­ æ–°å¢
      total_cost: Math.round(totalCost + totalYearEndBonus)
    },
    labor_cost: Math.round(totalCost + totalYearEndBonus),
    user_breakdown: Array.from(userBreakdown.values())
  };
}
```

### å®¢æˆ¶ç›ˆåˆ©åˆ†æ

```typescript
/**
 * å®¢æˆ¶ç›ˆåˆ©åˆ†æï¼ˆå®Œæ•´ç‰ˆï¼‰
 */
async function generateClientProfitabilityReport(
  start_date: string,
  end_date: string
): Promise<ProfitabilityReport[]> {
  
  // 1. è¨ˆç®—æ‰€æœ‰å®¢æˆ¶çš„æˆæœ¬ï¼ˆä½¿ç”¨åŠ æ¬Šå·¥æ™‚+ç®¡ç†æˆæœ¬ï¼‰
  const costs = await calculateAllClientCosts(start_date, end_date);
  
  // 2. æŸ¥è©¢æ‰€æœ‰å®¢æˆ¶çš„æ”¶è²»ï¼ˆæ”¶æ“šé‡‘é¡ï¼‰
  const revenues = await db.prepare(`
    SELECT 
      client_id,
      SUM(total_amount) as total_revenue
    FROM Receipts
    WHERE receipt_date BETWEEN ? AND ?
      AND status != 'cancelled'
      AND is_deleted = 0
    GROUP BY client_id
  `).bind(start_date, end_date).all();
  
  // 3. åˆä½µæ•¸æ“šä¸¦è¨ˆç®—æ¯›åˆ©
  const report = [];
  
  for (const cost of costs) {
    const revenue = revenues.results.find(r => r.client_id === cost.client_id);
    const total_revenue = revenue ? revenue.total_revenue : 0;
    
    const gross_profit = total_revenue - cost.labor_cost;
    const profit_margin = total_revenue > 0 
      ? (gross_profit / total_revenue) * 100 
      : 0;
    
    report.push({
      ...cost,
      revenue: total_revenue,
      gross_profit,
      profit_margin: Math.round(profit_margin * 100) / 100,
      
      // é¡å¤–æŒ‡æ¨™
      cost_per_weighted_hour: cost.labor_cost / cost.total_weighted_hours,
      revenue_per_weighted_hour: total_revenue / cost.total_weighted_hours,
      efficiency_ratio: cost.total_actual_hours / cost.total_weighted_hours
    });
  }
  
  // 4. æŒ‰æ¯›åˆ©ç‡æ’åº
  return report.sort((a, b) => b.profit_margin - a.profit_margin);
}
```

---

## ğŸ“Š äºŒã€å“¡å·¥å·¥æ™‚åˆ†æå ±è¡¨

### API è¨­è¨ˆ

**GET /api/v1/reports/employee-hours**

**Query åƒæ•¸ï¼š**
```typescript
{
  "year": 2025,
  "month": 10,
  "user_id": 1  // å¯é¸
}
```

**å›æ‡‰ï¼š**
```typescript
{
  "success": true,
  "data": [
    {
      "user_id": 1,
      "username": "å“¡å·¥A",
      "total_hours": 180.5,
      "normal_hours": 160.0,
      "overtime_hours": 20.5,
      "billable_hours": 170.0,  // å¯è¨ˆè²»å·¥æ™‚
      "non_billable_hours": 10.5,  // å…§éƒ¨å·¥æ™‚
      "utilization_rate": 94.17,  // ä½¿ç”¨ç‡ %
      "client_distribution": [
        {
          "client_id": "12345678",
          "company_name": "å®¢æˆ¶A",
          "hours": 80.0,
          "percentage": 44.32
        },
        {
          "client_id": "87654321",
          "company_name": "å®¢æˆ¶B",
          "hours": 60.5,
          "percentage": 33.52
        }
      ],
      "daily_hours": [
        { "date": "2025-10-01", "hours": 8.0 },
        { "date": "2025-10-02", "hours": 9.5 }
        // ... 31 å¤©
      ]
    }
  ]
}
```

### è¨ˆç®—é‚è¼¯

```typescript
async function calculateEmployeeHours(filters: any) {
  const startDate = `${filters.year}-${String(filters.month).padStart(2, '0')}-01`;
  const endDate = getMonthEndDate(filters.year, filters.month);
  
  // æŸ¥è©¢å·¥æ™‚è¨˜éŒ„
  const timelogs = await db.prepare(`
    SELECT 
      t.user_id,
      u.username,
      t.client_id,
      c.company_name,
      t.work_date,
      t.hours,
      t.work_type_id,
      s.is_billable
    FROM TimeLogs t
    JOIN Users u ON t.user_id = u.user_id
    JOIN Clients c ON t.client_id = c.client_id
    LEFT JOIN Services s ON t.service_id = s.service_id
    WHERE t.work_date BETWEEN ? AND ?
      AND t.is_deleted = 0
    ORDER BY t.user_id, t.work_date
  `).bind(startDate, endDate).all();
  
  // åˆ†çµ„çµ±è¨ˆ
  const userMap = new Map();
  
  for (const log of timelogs.results) {
    if (!userMap.has(log.user_id)) {
      userMap.set(log.user_id, {
        user_id: log.user_id,
        username: log.username,
        total_hours: 0,
        normal_hours: 0,
        overtime_hours: 0,
        billable_hours: 0,
        non_billable_hours: 0,
        client_distribution: new Map(),
        daily_hours: new Map()
      });
    }
    
    const user = userMap.get(log.user_id);
    
    // ç´¯è¨ˆå·¥æ™‚
    user.total_hours += log.hours;
    if (log.work_type_id === 1) {
      user.normal_hours += log.hours;
    } else {
      user.overtime_hours += log.hours;
    }
    
    // å¯è¨ˆè²» vs éè¨ˆè²»
    if (log.is_billable) {
      user.billable_hours += log.hours;
    } else {
      user.non_billable_hours += log.hours;
    }
    
    // å®¢æˆ¶åˆ†å¸ƒ
    if (!user.client_distribution.has(log.client_id)) {
      user.client_distribution.set(log.client_id, {
        client_id: log.client_id,
        company_name: log.company_name,
        hours: 0
      });
    }
    user.client_distribution.get(log.client_id).hours += log.hours;
    
    // æ¯æ—¥å·¥æ™‚
    if (!user.daily_hours.has(log.work_date)) {
      user.daily_hours.set(log.work_date, 0);
    }
    user.daily_hours.set(
      log.work_date, 
      user.daily_hours.get(log.work_date) + log.hours
    );
  }
  
  // è¨ˆç®—ä½¿ç”¨ç‡å’Œç™¾åˆ†æ¯”
  const results = Array.from(userMap.values()).map(user => {
    const workingDays = getWorkingDays(filters.year, filters.month);
    const standardHours = workingDays * 8;
    const utilization_rate = (user.billable_hours / standardHours) * 100;
    
    const client_distribution = Array.from(user.client_distribution.values())
      .map(client => ({
        ...client,
        percentage: (client.hours / user.total_hours) * 100
      }))
      .sort((a, b) => b.hours - a.hours);
    
    const daily_hours = Array.from(user.daily_hours.entries())
      .map(([date, hours]) => ({ date, hours }))
      .sort((a, b) => a.date.localeCompare(b.date));
    
    return {
      ...user,
      utilization_rate: Math.round(utilization_rate * 100) / 100,
      client_distribution,
      daily_hours
    };
  });
  
  return results;
}
```

---

## ğŸ“Š ä¸‰ã€è–ªè³‡å ±è¡¨

### API è¨­è¨ˆ

**GET /api/v1/reports/payroll-summary**

**Query åƒæ•¸ï¼š**
```typescript
{
  "year": 2025,
  "month": 10,
  "user_id": 1  // å¯é¸
}
```

**å›æ‡‰ï¼š**
```typescript
{
  "success": true,
  "data": {
    "summary": {
      "total_base_salary": 140000,
      "total_allowances": 15200,
      "total_bonuses": 8000,
      "total_overtime_pay": 5230,
      "total_gross_salary": 168430,
      "total_net_salary": 168430
    },
    "by_employee": [
      {
        "user_id": 1,
        "username": "å“¡å·¥A",
        "base_salary": 35000,
        "total_allowances": 3800,
        "total_bonuses": 2000,
        "overtime_pay": 1552,
        "gross_salary": 42352,
        "net_salary": 42352,
        "has_full_attendance": true
      }
    ]
  }
}
```

---

## ğŸ“Š å››ã€æ”¶æ¬¾å ±è¡¨

### API è¨­è¨ˆ

**GET /api/v1/reports/revenue**

**Query åƒæ•¸ï¼š**
```typescript
{
  "start_date": "2025-01-01",
  "end_date": "2025-10-31"
}
```

**å›æ‡‰ï¼š**
```typescript
{
  "success": true,
  "data": {
    "summary": {
      "total_receipts": 500000,
      "total_paid": 420000,
      "total_outstanding": 80000,
      "collection_rate": 84.0  // %
    },
    "monthly_trend": [
      {
        "month": "2025-01",
        "receipts": 45000,
        "paid": 42000,
        "outstanding": 3000
      },
      {
        "month": "2025-02",
        "receipts": 52000,
        "paid": 48000,
        "outstanding": 4000
      }
      // ...
    ],
    "by_client": [
      {
        "client_id": "12345678",
        "company_name": "å®¢æˆ¶A",
        "total_receipts": 120000,
        "total_paid": 100000,
        "total_outstanding": 20000
      }
    ]
  }
}
```

---

## ğŸ¨ å‰ç«¯çµ„ä»¶

### ReportsPage.vue

```vue
<template>
  <div class="reports-page">
    <h1>æ·±åº¦åˆ†æå ±è¡¨</h1>
    
    <TabMenu :tabs="['å®¢æˆ¶æˆæœ¬åˆ†æ', 'å“¡å·¥å·¥æ™‚åˆ†æ', 'è–ªè³‡å ±è¡¨', 'æ”¶æ¬¾åˆ†æ']">
      <!-- Tab 1: å®¢æˆ¶æˆæœ¬åˆ†æ -->
      <template #tab1>
        <div class="client-profitability">
          <div class="filters">
            <DateRangePicker v-model="dateRange" @change="checkYearEndTip" />
            
            <!-- â­ å¹´çµ‚çé‡‘é–‹é—œ -->
            <FormGroup label="æˆæœ¬è¨ˆç®—æ–¹å¼">
              <label>
                <input type="checkbox" v-model="includeYearEndBonus" />
                åŒ…å«å¹´çµ‚çé‡‘åˆ†æ”¤ï¼ˆæŒ‰å·¥æ™‚æ¯”ä¾‹ï¼‰
              </label>
              <p class="hint">
                ä¸å‹¾é¸ï¼šç”¨æ–¼å¹³æ™‚åˆ†æå®¢æˆ¶ç›ˆåˆ©ã€æ±ºå®šå¹´çµ‚é‡‘é¡ï¼ˆé è¨­ï¼‰<br>
                å‹¾é¸ï¼šç”¨æ–¼è¨ˆç®—çœŸå¯¦ç¸½æˆæœ¬ã€å¹´åº¦å›é¡§
              </p>
              
              <!-- â­ å¹´åº•æŸ¥è©¢æç¤º -->
              <div v-if="showYearEndTip" class="year-end-tip">
                ğŸ’¡ æç¤ºï¼šæŸ¥è©¢æœŸé–“åŒ…å«12æœˆï¼Œå»ºè­°å‹¾é¸ã€ŒåŒ…å«å¹´çµ‚çé‡‘ã€æŸ¥çœ‹çœŸå¯¦ç¸½æˆæœ¬
              </div>
            </FormGroup>
            
            <StyledButton @click="loadClientCostReport">æŸ¥è©¢</StyledButton>
          </div>
          
          <DataTable :columns="profitColumns" :data="profitData">
            <template #gross_profit="{ row }">
              <span :class="row.gross_profit > 0 ? 'text-green' : 'text-red'">
                {{ formatCurrency(row.gross_profit) }}
              </span>
            </template>
            <template #profit_margin="{ row }">
              <ProgressBar :value="row.profit_margin" />
            </template>
          </DataTable>
          
          <!-- åœ–è¡¨ï¼šæ¯›åˆ©ç‡æ’å -->
          <BarChart
            :data="profitData"
            x-field="company_name"
            y-field="profit_margin"
            title="å®¢æˆ¶æ¯›åˆ©ç‡æ’å"
          />
        </div>
      </template>
      
      <!-- Tab 2: å“¡å·¥å·¥æ™‚åˆ†æ -->
      <template #tab2>
        <div class="employee-hours">
          <div class="filters">
            <YearMonthPicker v-model="selectedMonth" />
            <StyledButton @click="loadEmployeeHoursReport">æŸ¥è©¢</StyledButton>
          </div>
          
          <div v-for="user in employeeData" :key="user.user_id" class="employee-section">
            <h3>{{ user.username }}</h3>
            
            <!-- å·¥æ™‚çµ±è¨ˆå¡ç‰‡ -->
            <div class="stats-grid">
              <StatCard title="ç¸½å·¥æ™‚" :value="user.total_hours + ' å°æ™‚'" />
              <StatCard title="ä½¿ç”¨ç‡" :value="user.utilization_rate + '%'" />
              <StatCard title="å¯è¨ˆè²»å·¥æ™‚" :value="user.billable_hours + ' å°æ™‚'" />
            </div>
            
            <!-- å®¢æˆ¶å·¥æ™‚å æ¯”ï¼ˆé¤…åœ–ï¼‰ -->
            <PieChart
              :data="user.client_distribution"
              name-field="company_name"
              value-field="hours"
              title="å®¢æˆ¶å·¥æ™‚åˆ†å¸ƒ"
            />
            
            <!-- æ¯æ—¥å·¥æ™‚ï¼ˆæŠ˜ç·šåœ–ï¼‰ -->
            <LineChart
              :data="user.daily_hours"
              x-field="date"
              y-field="hours"
              title="æ¯æ—¥å·¥æ™‚è¶¨å‹¢"
            />
          </div>
        </div>
      </template>
      
      <!-- Tab 3: è–ªè³‡å ±è¡¨ -->
      <template #tab3>
        <div class="payroll-report">
          <div class="filters">
            <YearMonthPicker v-model="payrollMonth" />
            <StyledButton @click="loadPayrollReport">æŸ¥è©¢</StyledButton>
          </div>
          
          <div class="summary-cards">
            <StatCard 
              title="ç¸½è–ªè³‡" 
              :value="formatCurrency(payrollSummary.total_gross_salary)" 
            />
            <StatCard 
              title="åº•è–ªåˆè¨ˆ" 
              :value="formatCurrency(payrollSummary.total_base_salary)" 
            />
            <StatCard 
              title="åŠ ç­è²»åˆè¨ˆ" 
              :value="formatCurrency(payrollSummary.total_overtime_pay)" 
            />
          </div>
          
          <DataTable :columns="payrollColumns" :data="payrollData" />
        </div>
      </template>
      
      <!-- Tab 4: æ”¶æ¬¾åˆ†æ -->
      <template #tab4>
        <div class="revenue-report">
          <div class="filters">
            <DateRangePicker v-model="revenueDateRange" />
            <StyledButton @click="loadRevenueReport">æŸ¥è©¢</StyledButton>
          </div>
          
          <div class="summary-cards">
            <StatCard 
              title="ç¸½é–‹ç«‹æ”¶æ“šé‡‘é¡" 
              :value="formatCurrency(revenueSummary.total_receipts)" 
            />
            <StatCard 
              title="å·²æ”¶æ¬¾" 
              :value="formatCurrency(revenueSummary.total_paid)" 
            />
            <StatCard 
              title="æ‡‰æ”¶å¸³æ¬¾" 
              :value="formatCurrency(revenueSummary.total_outstanding)" 
            />
            <StatCard 
              title="æ”¶æ¬¾ç‡" 
              :value="revenueSummary.collection_rate + '%'" 
            />
          </div>
          
          <!-- æœˆåº¦è¶¨å‹¢ -->
          <LineChart 
            :data="monthlyTrendData"
            x-field="month"
            y-fields="['receipts', 'paid']"
            title="æœˆåº¦æ”¶æ¬¾è¶¨å‹¢"
          />
        </div>
      </template>
    </TabMenu>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { getClientCostReport } from '@/api/reports';

const dateRange = ref({ start: '2025-01-01', end: '2025-12-31' });
const includeYearEndBonus = ref(false);  // â­ é è¨­ä¸å‹¾é¸
const showYearEndTip = ref(false);

// â­ æª¢æŸ¥æ˜¯å¦æ‡‰é¡¯ç¤ºå¹´çµ‚çé‡‘æç¤º
function checkYearEndTip() {
  const endDate = dateRange.value.end;
  // å¦‚æœæŸ¥è©¢æœŸé–“åŒ…å«12æœˆï¼Œé¡¯ç¤ºæç¤º
  showYearEndTip.value = endDate && endDate.includes('-12-');
}

async function loadClientCostReport() {
  const response = await getClientCostReport({
    start_date: dateRange.value.start,
    end_date: dateRange.value.end,
    include_year_end_bonus: includeYearEndBonus.value  // å‚³éå‹¾é¸ç‹€æ…‹
  });
  profitData.value = response.data;
}
</script>

<style scoped>
.year-end-tip {
  margin-top: 0.5rem;
  padding: 0.75rem;
  background: #dbeafe;
  border-left: 4px solid #3b82f6;
  border-radius: 0.375rem;
  font-size: 0.875rem;
}
</style>
```

---

## ğŸ“ˆ åœ–è¡¨è¨­è¨ˆ

### å®¢æˆ¶æ¯›åˆ©ç‡æ’åï¼ˆé•·æ¢åœ–ï¼‰

- Xè»¸ï¼šå®¢æˆ¶åç¨±
- Yè»¸ï¼šæ¯›åˆ©ç‡ï¼ˆ%ï¼‰
- é¡è‰²ï¼šç¶ è‰²ï¼ˆç›ˆåˆ©ï¼‰/ ç´…è‰²ï¼ˆè™§æï¼‰

### å®¢æˆ¶å·¥æ™‚åˆ†å¸ƒï¼ˆé¤…åœ–ï¼‰

- é¡¯ç¤ºå„å®¢æˆ¶å·¥æ™‚å æ¯”
- é¡¯ç¤ºç™¾åˆ†æ¯”æ¨™ç±¤

### æ¯æ—¥å·¥æ™‚è¶¨å‹¢ï¼ˆæŠ˜ç·šåœ–ï¼‰

- Xè»¸ï¼šæ—¥æœŸ
- Yè»¸ï¼šå·¥æ™‚
- æ¨™è¨˜ï¼šæ¨™æº–å·¥æ™‚ç·šï¼ˆ8å°æ™‚ï¼‰

### æœˆåº¦æ”¶æ¬¾è¶¨å‹¢ï¼ˆæŠ˜ç·šåœ–ï¼‰

- Xè»¸ï¼šæœˆä»½
- Yè»¸ï¼šé‡‘é¡
- é›™è»¸ï¼šé–‹ç«‹æ”¶æ“šé‡‘é¡ vs æ”¶æ¬¾é‡‘é¡

---

## âš ï¸ æ•ˆèƒ½å„ªåŒ–

### 1. è³‡æ–™å¿«å–

```typescript
// Workers KV å¿«å–
const cacheKey = `report:client-cost:${start_date}:${end_date}`;
const cached = await env.CACHE.get(cacheKey);

if (cached) {
  return JSON.parse(cached);
}

const report = await generateClientCostReport(start_date, end_date);

await env.CACHE.put(cacheKey, JSON.stringify(report), {
  expirationTtl: 3600  // 1å°æ™‚
});
```

### 2. åˆ†é åŠ è¼‰

```typescript
// å¤§é‡è³‡æ–™åˆ†é 
{
  "page": 1,
  "page_size": 20,
  "total": 150
}
```

### 3. ç´¢å¼•å„ªåŒ–

```sql
-- ç¢ºä¿æœ‰é©ç•¶çš„ç´¢å¼•
CREATE INDEX idx_timelogs_date_client ON TimeLogs(work_date, client_id);
CREATE INDEX idx_receipts_date_status ON Receipts(receipt_date, status);
```

---

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

- å®¢æˆ¶æˆæœ¬åˆ†æï¼šåˆ‡æ›ã€ŒåŒ…å«å¹´çµ‚çé‡‘ã€â†’ æˆæœ¬èˆ‡ç›ˆè™§è®ŠåŒ–æ­£ç¢º
- å“¡å·¥å·¥æ™‚åˆ†æï¼šæ—¥æœŸå€é–“è®Šæ›´ â†’ å·¥æ™‚ç¸½æ•¸ã€è¶¨å‹¢åœ–åŒæ­¥æ›´æ–°
- è–ªè³‡å ±è¡¨ï¼šå¤šå“¡å·¥ã€å¤šé …è–ªè³‡é … â†’ åŒ¯ç¸½èˆ‡æ˜ç´°ä¸€è‡´
- æ”¶æ¬¾åˆ†æï¼šæ”¶æ“šé‡‘é¡ vs æ”¶æ¬¾é‡‘é¡ â†’ é›™è»¸åœ–è³‡æ–™ä¸€è‡´ä¸”åˆ†é æ­£ç¢º
- å¤§æ•¸æ“šæƒ…å¢ƒï¼ˆ>1 è¬ç­†ï¼‰â†’ æŸ¥è©¢æ™‚é–“åœ¨é æœŸå…§ï¼ˆå¿«å–/ç´¢å¼•ç”Ÿæ•ˆï¼‰

**ç›¸é—œæ–‡æª”ï¼š**
- [å·¥æ™‚ç®¡ç†-å®Œæ•´è¦æ ¼](./å·¥æ™‚ç®¡ç†-å®Œæ•´è¦æ ¼.md)
- [è–ªè³‡ç®¡ç†-å®Œæ•´è¦æ ¼](./è–ªè³‡ç®¡ç†-å®Œæ•´è¦æ ¼.md)
- [ç®¡ç†æˆæœ¬-å®Œæ•´è¦æ ¼](./ç®¡ç†æˆæœ¬-å®Œæ•´è¦æ ¼.md)
- [æ”¶æ“šæ”¶æ¬¾-å®Œæ•´è¦æ ¼](./æ”¶æ“šæ”¶æ¬¾-å®Œæ•´è¦æ ¼.md)

