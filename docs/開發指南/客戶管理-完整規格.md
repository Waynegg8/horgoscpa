# 客戶管理 - 完整開發規格

**給 AI：** 實現客戶管理功能的完整技術規格

---

## 📋 功能清單

- 客戶列表（查詢、搜尋、篩選）
- 新增客戶
- 編輯客戶
- 刪除客戶（軟刪除）
- 標籤管理

---

## 💾 資料表

### Clients
```sql
CREATE TABLE Clients (
  client_id TEXT PRIMARY KEY,
  company_name TEXT NOT NULL,
  tax_registration_number TEXT,
  business_status TEXT DEFAULT '營業中',
  assignee_user_id INTEGER NOT NULL,
  phone TEXT,
  email TEXT,
  remarks TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id)
);

CREATE INDEX idx_clients_assignee ON Clients(assignee_user_id);
CREATE INDEX idx_clients_company_name ON Clients(company_name);
```

### CustomerTags
```sql
CREATE TABLE CustomerTags (
  tag_id INTEGER PRIMARY KEY AUTOINCREMENT,
  tag_name TEXT UNIQUE NOT NULL,
  tag_color TEXT,
  created_at TEXT DEFAULT (datetime('now'))
);
```

### ClientTagAssignments
```sql
CREATE TABLE ClientTagAssignments (
  assignment_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  tag_id INTEGER NOT NULL,
  assigned_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (client_id) REFERENCES Clients(client_id) ON DELETE CASCADE,
  FOREIGN KEY (tag_id) REFERENCES CustomerTags(tag_id),
  UNIQUE(client_id, tag_id)
);
```

---

## 🔌 API 端點

### 1. 查詢客戶列表
```
GET /api/v1/clients
Query: ?company_name=XX&limit=50&offset=0
權限：所有人（員工自動過濾）
```

**回應：**
```json
{
  "success": true,
  "data": [
    {
      "client_id": "12345678",
      "company_name": "測試公司",
      "assignee_name": "紜蓁",
      "tags": ["VIP"]
    }
  ],
  "pagination": { "total": 100, "limit": 50, "offset": 0 }
}
```

### 2. 新增客戶
```
POST /api/v1/clients
權限：管理員
```

**請求 Body：**
```json
{
  "client_id": "12345678",
  "company_name": "測試公司",
  "assignee_user_id": 1,
  "phone": "02-1234-5678",
  "email": "test@example.com",
  "tag_ids": [1, 2]
}
```

### 3. 更新客戶
```
PUT /api/v1/clients/:id
權限：管理員
```

### 4. 刪除客戶
```
DELETE /api/v1/clients/:id
權限：管理員
```

### 5. 標籤管理
```
GET /api/v1/clients/tags
POST /api/v1/clients/tags
```

---

## 🎨 前端組件

### ClientListPage.vue
```vue
<template>
  <div class="clients-page">
    <h1>客戶管理</h1>
    
    <div class="filters">
      <StyledInput 
        v-model="searchQuery"
        placeholder="搜尋公司名稱"
      />
      <StyledButton 
        v-if="user.is_admin"
        @click="showCreateModal = true"
      >
        + 新增客戶
      </StyledButton>
    </div>

    <DataTable
      :columns="columns"
      :data="clients"
      @row-click="handleRowClick"
    />
    
    <Pagination
      :total="total"
      :current-page="page"
      @change="fetchClients"
    />
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { getClients } from '@/api/clients';

const clients = ref([]);
const searchQuery = ref('');
const page = ref(1);

onMounted(() => {
  fetchClients();
});

async function fetchClients() {
  const response = await getClients({
    company_name: searchQuery.value,
    limit: 50,
    offset: (page.value - 1) * 50
  });
  clients.value = response.data;
}
</script>
```

### ClientFormModal.vue
```vue
<template>
  <Modal :show="show" title="新增客戶" @close="$emit('close')">
    <form @submit.prevent="handleSubmit">
      <StyledInput
        v-model="form.client_id"
        label="統一編號"
        :required="true"
        maxlength="8"
      />
      <StyledInput
        v-model="form.company_name"
        label="公司名稱"
        :required="true"
      />
      <select v-model="form.assignee_user_id">
        <option v-for="user in users" :value="user.user_id">
          {{ user.name }}
        </option>
      </select>
      
      <div class="buttons">
        <StyledButton type="button" variant="ghost" @click="$emit('close')">
          取消
        </StyledButton>
        <StyledButton type="submit" :loading="isSubmitting">
          儲存
        </StyledButton>
      </div>
    </form>
  </Modal>
</template>
```

---

## 🔧 後端實現

### Service 層
```typescript
// services/ClientService.ts
class ClientService {
  async getClients(filters, user) {
    // 權限過濾
    if (!user.is_admin) {
      filters.assignee_user_id = user.user_id;
    }
    
    return await this.repository.findAll(filters);
  }
  
  async createClient(data, userId) {
    // 1. 驗證
    this.validate(data);
    
    // 2. 檢查唯一性
    const exists = await this.repository.findByClientId(data.client_id);
    if (exists) {
      throw new ConflictError('統一編號已存在');
    }
    
    // 3. 創建
    const client = await this.repository.create({
      ...data,
      created_at: new Date(),
      is_deleted: 0
    });
    
    // 4. 處理標籤
    if (data.tag_ids) {
      await this.assignTags(client.client_id, data.tag_ids);
    }
    
    return client;
  }
  
  private validate(data) {
    if (!/^\d{8}$/.test(data.client_id)) {
      throw new ValidationError('統一編號必須為8位數字');
    }
    if (!data.company_name) {
      throw new ValidationError('公司名稱為必填');
    }
  }
}
```

### Repository 層
```typescript
// repositories/ClientRepository.ts
class ClientRepository {
  async findAll(filters) {
    let query = 'SELECT * FROM Clients WHERE is_deleted = 0';
    const params = [];
    
    if (filters.assignee_user_id) {
      query += ' AND assignee_user_id = ?';
      params.push(filters.assignee_user_id);
    }
    
    if (filters.company_name) {
      query += ' AND company_name LIKE ?';
      params.push(`%${filters.company_name}%`);
    }
    
    query += ' ORDER BY company_name LIMIT ? OFFSET ?';
    params.push(filters.limit || 50, filters.offset || 0);
    
    const result = await this.db.prepare(query).bind(...params).all();
    return result.results;
  }
  
  async create(data) {
    await this.db.prepare(`
      INSERT INTO Clients (
        client_id, company_name, assignee_user_id,
        phone, email, created_at
      )
      VALUES (?, ?, ?, ?, ?, ?)
    `).bind(
      data.client_id,
      data.company_name,
      data.assignee_user_id,
      data.phone || null,
      data.email || null,
      data.created_at
    ).run();
    
    return await this.findByClientId(data.client_id);
  }
}
```

### Route 層
```typescript
// routes/clients.ts
import { Hono } from 'hono';
import { authMiddleware, requireAdmin } from '../middleware/auth';
import { ClientService } from '../services/ClientService';

const app = new Hono();

app.get('/api/v1/clients', authMiddleware, async (c) => {
  const service = new ClientService(c.env.DB);
  const user = c.get('user');
  const query = c.req.query();
  
  const result = await service.getClients(query, user);
  return c.json(successResponse(result));
});

app.post('/api/v1/clients', authMiddleware, requireAdmin, async (c) => {
  const service = new ClientService(c.env.DB);
  const user = c.get('user');
  const data = await c.req.json();
  
  const client = await service.createClient(data, user.user_id);
  return c.json(successResponse(client), 201);
});

export default app;
```

---

## ✅ 驗證規則

| 欄位 | 規則 | 錯誤訊息 |
|------|------|---------|
| client_id | 8位數字，唯一 | "統一編號必須為8位數字" |
| company_name | 必填，1-100字元 | "公司名稱為必填" |
| email | Email格式 | "Email格式錯誤" |
| phone | 台灣電話格式 | "電話格式錯誤" |

---

## 🔒 權限控制

### 查詢客戶
- **員工：** 只能看自己負責的（WHERE assignee_user_id = user_id）
- **管理員：** 可以看全部

### 新增/編輯/刪除
- **員工：** 無權限
- **管理員：** 完整權限

---

## 🧪 測試案例

### 測試1：新增客戶成功
```javascript
const data = {
  client_id: '12345678',
  company_name: '測試公司',
  assignee_user_id: 1
};
const result = await createClient(data);
expect(result.client_id).toBe('12345678');
```

### 測試2：統一編號重複
```javascript
await expect(createClient({ client_id: '12345678', ... }))
  .rejects.toThrow('統一編號已存在');
```

### 測試3：員工只看自己負責的
```javascript
const user = { user_id: 2, is_admin: false };
const clients = await getClients({}, user);
clients.forEach(c => {
  expect(c.assignee_user_id).toBe(2);
});
```

---

**這個文檔包含了客戶管理的所有技術細節，AI可以直接根據此文檔實現功能。**

