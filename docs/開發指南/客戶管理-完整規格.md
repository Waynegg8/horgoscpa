# å®¢æˆ¶ç®¡ç† - å®Œæ•´é–‹ç™¼è¦æ ¼

**çµ¦ AIï¼š** å¯¦ç¾å®¢æˆ¶ç®¡ç†åŠŸèƒ½çš„å®Œæ•´æŠ€è¡“è¦æ ¼

---

## ğŸ“‹ åŠŸèƒ½æ¸…å–®

- å®¢æˆ¶åˆ—è¡¨ï¼ˆæŸ¥è©¢ã€æœå°‹ã€ç¯©é¸ï¼‰
- æ–°å¢å®¢æˆ¶
- ç·¨è¼¯å®¢æˆ¶
- åˆªé™¤å®¢æˆ¶ï¼ˆè»Ÿåˆªé™¤ï¼‰
- æ¨™ç±¤ç®¡ç†

---

## ğŸ’¾ è³‡æ–™è¡¨

### Clients
```sql
CREATE TABLE Clients (
  client_id TEXT PRIMARY KEY,
  company_name TEXT NOT NULL,
  tax_registration_number TEXT,
  business_status TEXT DEFAULT 'ç‡Ÿæ¥­ä¸­',
  assignee_user_id INTEGER NOT NULL,
  phone TEXT,
  email TEXT,
  remarks TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id)
);

CREATE INDEX idx_clients_assignee ON Clients(assignee_user_id);
CREATE INDEX idx_clients_company_name ON Clients(company_name);
```

### CustomerTags
```sql
CREATE TABLE CustomerTags (
  tag_id INTEGER PRIMARY KEY AUTOINCREMENT,
  tag_name TEXT UNIQUE NOT NULL,
  tag_color TEXT,
  created_at TEXT DEFAULT (datetime('now'))
);
```

### ClientTagAssignments
```sql
CREATE TABLE ClientTagAssignments (
  assignment_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  tag_id INTEGER NOT NULL,
  assigned_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (client_id) REFERENCES Clients(client_id) ON DELETE CASCADE,
  FOREIGN KEY (tag_id) REFERENCES CustomerTags(tag_id),
  UNIQUE(client_id, tag_id)
);
```

---

## ğŸ”Œ API ç«¯é»

### 1. æŸ¥è©¢å®¢æˆ¶åˆ—è¡¨
```
GET /api/v1/clients
Query: ?company_name=XX&limit=50&offset=0
æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå“¡å·¥è‡ªå‹•éæ¿¾ï¼‰
```

**å›æ‡‰ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "client_id": "12345678",
      "company_name": "æ¸¬è©¦å…¬å¸",
      "assignee_name": "ç´œè“",
      "tags": ["VIP"]
    }
  ],
  "pagination": { "total": 100, "limit": 50, "offset": 0 }
}
```

### 2. æ–°å¢å®¢æˆ¶
```
POST /api/v1/clients
æ¬Šé™ï¼šç®¡ç†å“¡
```

**è«‹æ±‚ Bodyï¼š**
```json
{
  "client_id": "12345678",
  "company_name": "æ¸¬è©¦å…¬å¸",
  "assignee_user_id": 1,
  "phone": "02-1234-5678",
  "email": "test@example.com",
  "tag_ids": [1, 2]
}
```

### 3. æ›´æ–°å®¢æˆ¶
```
PUT /api/v1/clients/:id
æ¬Šé™ï¼šç®¡ç†å“¡
```

### 4. åˆªé™¤å®¢æˆ¶
```
DELETE /api/v1/clients/:id
æ¬Šé™ï¼šç®¡ç†å“¡
```

### 5. æ¨™ç±¤ç®¡ç†
```
GET /api/v1/clients/tags
POST /api/v1/clients/tags
```

---

## ğŸ¨ å‰ç«¯çµ„ä»¶

### ClientListPage.vue
```vue
<template>
  <div class="clients-page">
    <h1>å®¢æˆ¶ç®¡ç†</h1>
    
    <div class="filters">
      <StyledInput 
        v-model="searchQuery"
        placeholder="æœå°‹å…¬å¸åç¨±"
      />
      <StyledButton 
        v-if="user.is_admin"
        @click="showCreateModal = true"
      >
        + æ–°å¢å®¢æˆ¶
      </StyledButton>
    </div>

    <DataTable
      :columns="columns"
      :data="clients"
      @row-click="handleRowClick"
    />
    
    <Pagination
      :total="total"
      :current-page="page"
      @change="fetchClients"
    />
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { getClients } from '@/api/clients';

const clients = ref([]);
const searchQuery = ref('');
const page = ref(1);

onMounted(() => {
  fetchClients();
});

async function fetchClients() {
  const response = await getClients({
    company_name: searchQuery.value,
    limit: 50,
    offset: (page.value - 1) * 50
  });
  clients.value = response.data;
}
</script>
```

### ClientFormModal.vue
```vue
<template>
  <Modal :show="show" title="æ–°å¢å®¢æˆ¶" @close="$emit('close')">
    <form @submit.prevent="handleSubmit">
      <StyledInput
        v-model="form.client_id"
        label="çµ±ä¸€ç·¨è™Ÿ"
        :required="true"
        maxlength="8"
      />
      <StyledInput
        v-model="form.company_name"
        label="å…¬å¸åç¨±"
        :required="true"
      />
      <select v-model="form.assignee_user_id">
        <option v-for="user in users" :value="user.user_id">
          {{ user.name }}
        </option>
      </select>
      
      <div class="buttons">
        <StyledButton type="button" variant="ghost" @click="$emit('close')">
          å–æ¶ˆ
        </StyledButton>
        <StyledButton type="submit" :loading="isSubmitting">
          å„²å­˜
        </StyledButton>
      </div>
    </form>
  </Modal>
</template>
```

---

## ğŸ”§ å¾Œç«¯å¯¦ç¾

### Service å±¤
```typescript
// services/ClientService.ts
class ClientService {
  async getClients(filters, user) {
    // æ¬Šé™éæ¿¾
    if (!user.is_admin) {
      filters.assignee_user_id = user.user_id;
    }
    
    return await this.repository.findAll(filters);
  }
  
  async createClient(data, userId) {
    // 1. é©—è­‰
    this.validate(data);
    
    // 2. æª¢æŸ¥å”¯ä¸€æ€§
    const exists = await this.repository.findByClientId(data.client_id);
    if (exists) {
      throw new ConflictError('çµ±ä¸€ç·¨è™Ÿå·²å­˜åœ¨');
    }
    
    // 3. å‰µå»º
    const client = await this.repository.create({
      ...data,
      created_at: new Date(),
      is_deleted: 0
    });
    
    // 4. è™•ç†æ¨™ç±¤
    if (data.tag_ids) {
      await this.assignTags(client.client_id, data.tag_ids);
    }
    
    return client;
  }
  
  private validate(data) {
    if (!/^\d{8}$/.test(data.client_id)) {
      throw new ValidationError('çµ±ä¸€ç·¨è™Ÿå¿…é ˆç‚º8ä½æ•¸å­—');
    }
    if (!data.company_name) {
      throw new ValidationError('å…¬å¸åç¨±ç‚ºå¿…å¡«');
    }
  }
}
```

### Repository å±¤
```typescript
// repositories/ClientRepository.ts
class ClientRepository {
  async findAll(filters) {
    let query = 'SELECT * FROM Clients WHERE is_deleted = 0';
    const params = [];
    
    if (filters.assignee_user_id) {
      query += ' AND assignee_user_id = ?';
      params.push(filters.assignee_user_id);
    }
    
    if (filters.company_name) {
      query += ' AND company_name LIKE ?';
      params.push(`%${filters.company_name}%`);
    }
    
    query += ' ORDER BY company_name LIMIT ? OFFSET ?';
    params.push(filters.limit || 50, filters.offset || 0);
    
    const result = await this.db.prepare(query).bind(...params).all();
    return result.results;
  }
  
  async create(data) {
    await this.db.prepare(`
      INSERT INTO Clients (
        client_id, company_name, assignee_user_id,
        phone, email, created_at
      )
      VALUES (?, ?, ?, ?, ?, ?)
    `).bind(
      data.client_id,
      data.company_name,
      data.assignee_user_id,
      data.phone || null,
      data.email || null,
      data.created_at
    ).run();
    
    return await this.findByClientId(data.client_id);
  }
}
```

### Route å±¤
```typescript
// routes/clients.ts
import { Hono } from 'hono';
import { authMiddleware, requireAdmin } from '../middleware/auth';
import { ClientService } from '../services/ClientService';

const app = new Hono();

app.get('/api/v1/clients', authMiddleware, async (c) => {
  const service = new ClientService(c.env.DB);
  const user = c.get('user');
  const query = c.req.query();
  
  const result = await service.getClients(query, user);
  return c.json(successResponse(result));
});

app.post('/api/v1/clients', authMiddleware, requireAdmin, async (c) => {
  const service = new ClientService(c.env.DB);
  const user = c.get('user');
  const data = await c.req.json();
  
  const client = await service.createClient(data, user.user_id);
  return c.json(successResponse(client), 201);
});

export default app;
```

---

## âœ… é©—è­‰è¦å‰‡

| æ¬„ä½ | è¦å‰‡ | éŒ¯èª¤è¨Šæ¯ |
|------|------|---------|
| client_id | 8ä½æ•¸å­—ï¼Œå”¯ä¸€ | "çµ±ä¸€ç·¨è™Ÿå¿…é ˆç‚º8ä½æ•¸å­—" |
| company_name | å¿…å¡«ï¼Œ1-100å­—å…ƒ | "å…¬å¸åç¨±ç‚ºå¿…å¡«" |
| email | Emailæ ¼å¼ | "Emailæ ¼å¼éŒ¯èª¤" |
| phone | å°ç£é›»è©±æ ¼å¼ | "é›»è©±æ ¼å¼éŒ¯èª¤" |

---

## ğŸ”’ æ¬Šé™æ§åˆ¶

### æŸ¥è©¢å®¢æˆ¶
- **å“¡å·¥ï¼š** åªèƒ½çœ‹è‡ªå·±è² è²¬çš„ï¼ˆWHERE assignee_user_id = user_idï¼‰
- **ç®¡ç†å“¡ï¼š** å¯ä»¥çœ‹å…¨éƒ¨

### æ–°å¢/ç·¨è¼¯/åˆªé™¤
- **å“¡å·¥ï¼š** ç„¡æ¬Šé™
- **ç®¡ç†å“¡ï¼š** å®Œæ•´æ¬Šé™

---

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

### æ¸¬è©¦1ï¼šæ–°å¢å®¢æˆ¶æˆåŠŸ
```javascript
const data = {
  client_id: '12345678',
  company_name: 'æ¸¬è©¦å…¬å¸',
  assignee_user_id: 1
};
const result = await createClient(data);
expect(result.client_id).toBe('12345678');
```

### æ¸¬è©¦2ï¼šçµ±ä¸€ç·¨è™Ÿé‡è¤‡
```javascript
await expect(createClient({ client_id: '12345678', ... }))
  .rejects.toThrow('çµ±ä¸€ç·¨è™Ÿå·²å­˜åœ¨');
```

### æ¸¬è©¦3ï¼šå“¡å·¥åªçœ‹è‡ªå·±è² è²¬çš„
```javascript
const user = { user_id: 2, is_admin: false };
const clients = await getClients({}, user);
clients.forEach(c => {
  expect(c.assignee_user_id).toBe(2);
});
```

---

**é€™å€‹æ–‡æª”åŒ…å«äº†å®¢æˆ¶ç®¡ç†çš„æ‰€æœ‰æŠ€è¡“ç´°ç¯€ï¼ŒAIå¯ä»¥ç›´æ¥æ ¹æ“šæ­¤æ–‡æª”å¯¦ç¾åŠŸèƒ½ã€‚**

