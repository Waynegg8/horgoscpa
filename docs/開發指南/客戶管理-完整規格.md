# 客戶管理 - 完整開發規格

**給 AI：** 實現客戶管理功能的完整技術規格

---

## 📋 功能清單

- 客戶列表（查詢、搜尋、篩選）
- 新增客戶
- 編輯客戶
- 刪除客戶（軟刪除）
- 標籤管理

---

## 💾 資料表

### Clients
```sql
CREATE TABLE Clients (
  client_id TEXT PRIMARY KEY,
  company_name TEXT NOT NULL,
  tax_registration_number TEXT,
  business_status TEXT DEFAULT '營業中',
  assignee_user_id INTEGER NOT NULL,
  phone TEXT,
  email TEXT,
  client_notes TEXT,          -- 客戶備註（記錄客戶特殊需求、注意事項）
  payment_notes TEXT,          -- 收款備註（記錄收款相關資訊，如：付款習慣、聯絡窗口）
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,                      -- ⭐ 刪除時間
  deleted_by INTEGER,                   -- ⭐ 刪除人員
  
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id),
  FOREIGN KEY (deleted_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_clients_assignee ON Clients(assignee_user_id);
CREATE INDEX idx_clients_company_name ON Clients(company_name);
```

### CustomerTags
```sql
CREATE TABLE CustomerTags (
  tag_id INTEGER PRIMARY KEY AUTOINCREMENT,
  tag_name TEXT UNIQUE NOT NULL,
  tag_color TEXT,
  created_at TEXT DEFAULT (datetime('now'))
);
```

### ClientTagAssignments
```sql
CREATE TABLE ClientTagAssignments (
  assignment_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  tag_id INTEGER NOT NULL,
  assigned_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (client_id) REFERENCES Clients(client_id) ON DELETE CASCADE,
  FOREIGN KEY (tag_id) REFERENCES CustomerTags(tag_id),
  UNIQUE(client_id, tag_id)
);
```

---

## 🔌 API 端點

### 1. 查詢客戶列表
```
GET /api/v1/clients
Query: ?company_name=XX&limit=50&offset=0&fields=client_id,company_name,tags
權限：所有人（員工自動過濾）
```

**回應：**
```json
{
  "success": true,
  "data": [
    {
      "client_id": "12345678",
      "company_name": "測試公司",
      "assignee_name": "紜蓁",
      "tags": ["VIP", "長期合作"],
      "client_notes": "喜歡提前收到報表，每月5日前完成",
      "payment_notes": "由財務陳小姐負責，習慣月底轉帳"
    }
  ],
  "pagination": { "total": 100, "limit": 50, "offset": 0 }
}

**⚠️ 欄位說明：**
- `client_notes`：業務相關備註（客戶偏好、特殊要求、注意事項）
- `payment_notes`：財務相關備註（付款習慣、聯絡窗口、收款方式）
- 這兩個欄位在「應收帳款查詢」時非常重要（提醒收款注意事項）
```

**N+1 查詢優化（重要！）：**
```typescript
// ❌ 錯誤示例 - N+1 查詢問題
async getClientsWrong() {
  const clients = await db.query(`SELECT * FROM Clients`);
  
  for (let client of clients) {
    // 每個客戶都查一次標籤 → N+1 問題！
    const tags = await db.query(`
      SELECT t.tag_name 
      FROM ClientTagAssignments cta
      JOIN CustomerTags t ON cta.tag_id = t.tag_id
      WHERE cta.client_id = ?
    `, [client.client_id]);
    client.tags = tags.map(t => t.tag_name);
  }
  
  return clients;
}

// ✅ 正確示例 - 使用 JOIN 一次查詢
async getClientsCorrect(filters, user) {
  let sql = `
    SELECT 
      c.*,
      u.name as assignee_name,
      GROUP_CONCAT(t.tag_name) as tags,
      c.client_notes,     -- ⭐ 客戶備註
      c.payment_notes     -- ⭐ 收款備註
    FROM Clients c
    LEFT JOIN Users u ON c.assignee_user_id = u.user_id
    LEFT JOIN ClientTagAssignments cta ON c.client_id = cta.client_id
    LEFT JOIN CustomerTags t ON cta.tag_id = t.tag_id
    WHERE c.is_deleted = 0
  `;
  
  const params = [];
  
  // 員工只看自己的客戶
  if (!user.is_admin) {
    sql += ` AND c.assignee_user_id = ?`;
    params.push(user.user_id);
  }
  
  // 搜尋條件
  if (filters.company_name) {
    sql += ` AND c.company_name LIKE ?`;
    params.push(`%${filters.company_name}%`);
  }
  
  sql += ` GROUP BY c.client_id`;
  sql += ` ORDER BY c.created_at DESC`;
  sql += ` LIMIT ? OFFSET ?`;
  params.push(filters.limit || 50, filters.offset || 0);
  
  const result = await db.prepare(sql).bind(...params).all();
  
  // 處理標籤字符串
  return result.results.map(row => ({
    ...row,
    tags: row.tags ? row.tags.split(',') : []
  }));
}
```

**字段選擇器（Sparse Fieldsets）：**
```typescript
// 支持僅返回所需字段
async getClients(filters, user, fields = ['*']) {
  const selectClause = fields.includes('*') 
    ? 'c.*, u.name as assignee_name, GROUP_CONCAT(t.tag_name) as tags'
    : fields.map(f => {
        if (f === 'assignee_name') return 'u.name as assignee_name';
        if (f === 'tags') return 'GROUP_CONCAT(t.tag_name) as tags';
        return `c.${f}`;
      }).join(', ');
  
  // ... 其他查詢邏輯
}

// 使用示例
GET /api/v1/clients?fields=client_id,company_name
// 僅返回 ID 和公司名稱，減少帶寬
```

### 2. 新增客戶
```
POST /api/v1/clients
權限：所有人（小型事務所彈性設計）
```

**請求 Body：**
```json
{
  "client_id": "12345678",
  "company_name": "測試公司",
  "assignee_user_id": 1,
  "phone": "02-1234-5678",
  "email": "test@example.com",
  "client_notes": "喜歡提前收到報表，每月5日前完成",
  "payment_notes": "由財務陳小姐負責，習慣月底轉帳",
  "tag_ids": [1, 2]
}
```

### 3. 更新客戶
```
PUT /api/v1/clients/:id
權限：所有人（小型事務所彈性設計）
```

### 4. 刪除客戶
```
DELETE /api/v1/clients/:id
權限：所有人（小型事務所彈性設計）
```

### 5. 標籤管理
```
GET  /api/v1/clients/tags          權限：所有人
POST /api/v1/clients/tags          權限：所有人（小型事務所彈性設計）
PUT  /api/v1/clients/tags/:id      權限：所有人（小型事務所彈性設計）
DELETE /api/v1/clients/tags/:id    權限：所有人（小型事務所彈性設計）
```

### 6. 批量操作（管理員）
```
POST /api/v1/clients/batch-update         批量更新
POST /api/v1/clients/batch-delete         批量刪除
POST /api/v1/clients/batch-assign         批量分配負責人
```

**批量更新負責人：**
```json
POST /api/v1/clients/batch-assign
{
  "client_ids": ["12345678", "87654321", "11223344"],
  "assignee_user_id": 5
}

// 回應
{
  "success": true,
  "data": {
    "total": 3,
    "succeeded": 3,
    "failed": 0,
    "details": [
      { "client_id": "12345678", "status": "success" },
      { "client_id": "87654321", "status": "success" },
      { "client_id": "11223344", "status": "success" }
    ]
  }
}
```

**批量刪除：**
```json
POST /api/v1/clients/batch-delete
{
  "client_ids": ["12345678", "87654321"]
}

// 回應
{
  "success": true,
  "data": {
    "total": 2,
    "succeeded": 2,
    "failed": 0,
    "warnings": [
      "客戶 12345678 有 5 個未完成任務將一併刪除"
    ]
  }
}
```

**批量操作實現：**
```typescript
class ClientService {
  async batchAssign(clientIds: string[], assigneeUserId: number, adminUser) {
    // 1. 限制批量大小
    if (clientIds.length > 100) {
      throw new ValidationError('批量操作最多 100 條記錄');
    }
    
    // 2. 驗證員工存在
    const user = await this.userRepo.findById(assigneeUserId);
    if (!user) {
      throw new NotFoundError('負責人不存在');
    }
    
    const results = [];
    let succeeded = 0;
    let failed = 0;
    
    // 3. 使用事務處理
    await this.db.batch([
      ...clientIds.map(clientId => 
        this.db.prepare(`
          UPDATE Clients 
          SET assignee_user_id = ?, updated_at = datetime('now')
          WHERE client_id = ? AND is_deleted = 0
        `).bind(assigneeUserId, clientId)
      )
    ]);
    
    // 4. 記錄審計日誌
    for (const clientId of clientIds) {
      await this.auditLog.log({
        user_id: adminUser.user_id,
        action: 'BATCH_UPDATE',
        table_name: 'Clients',
        record_id: clientId,
        changes: { assignee_user_id: assigneeUserId }
      });
    }
    
    return {
      total: clientIds.length,
      succeeded: clientIds.length,
      failed: 0
    };
  }
  
  async batchDelete(clientIds: string[], adminUser) {
    // 1. 限制批量大小
    if (clientIds.length > 100) {
      throw new ValidationError('批量操作最多 100 條記錄');
    }
    
    const warnings = [];
    
    // 2. 檢查關聯數據
    for (const clientId of clientIds) {
      const taskCount = await this.db.prepare(`
        SELECT COUNT(*) as count FROM ActiveTasks
        WHERE client_id = ? AND is_deleted = 0
      `).bind(clientId).first();
      
      if (taskCount.count > 0) {
        warnings.push(`客戶 ${clientId} 有 ${taskCount.count} 個未完成任務將一併刪除`);
      }
    }
    
    // 3. 軟刪除客戶
    await this.db.batch([
      ...clientIds.map(clientId =>
        this.db.prepare(`
          UPDATE Clients
          SET is_deleted = 1, 
              deleted_at = datetime('now'),
              deleted_by = ?
          WHERE client_id = ?
        `).bind(adminUser.user_id, clientId)
      )
    ]);
    
    return {
      total: clientIds.length,
      succeeded: clientIds.length,
      failed: 0,
      warnings
    };
  }
}
```

---

## 🎨 前端組件

### ClientListPage.vue
```vue
<template>
  <div class="clients-page">
    <h1>客戶管理</h1>
    
    <div class="filters">
      <StyledInput 
        v-model="searchQuery"
        placeholder="搜尋公司名稱"
      />
      <StyledButton 
        v-if="user.is_admin"
        @click="showCreateModal = true"
      >
        + 新增客戶
      </StyledButton>
    </div>

    <!-- ⭐ 批量操作區域（管理員）-->
    <div v-if="user.is_admin && selectedClients.length > 0" class="batch-actions">
      <div class="selection-info">
        <span class="count">
          已選擇 {{ selectedClients.length }} / 100
        </span>
        <span v-if="selectedClients.length > 100" class="error">
          ⚠️ 超過上限！批量操作最多100條
        </span>
      </div>
      
      <StyledButton 
        @click="showBatchAssign = true"
        :disabled="selectedClients.length === 0 || selectedClients.length > 100"
      >
        批量分配負責人
      </StyledButton>
      
      <StyledButton 
        @click="batchDelete"
        :disabled="selectedClients.length === 0 || selectedClients.length > 100"
        variant="danger"
      >
        批量刪除
      </StyledButton>
    </div>

    <DataTable
      :columns="columns"
      :data="clients"
      :selectable="user.is_admin"
      v-model:selected="selectedClients"
      @row-click="handleRowClick"
    />
    
    <Pagination
      :total="total"
      :current-page="page"
      @change="fetchClients"
    />
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { getClients, batchAssignClients, batchDeleteClients } from '@/api/clients';
import { useAuth } from '@/composables/useAuth';

const { user } = useAuth();
const clients = ref([]);
const searchQuery = ref('');
const page = ref(1);
const selectedClients = ref([]);  // ⭐ 已選擇的客戶
const showBatchAssign = ref(false);

onMounted(() => {
  fetchClients();
});

async function fetchClients() {
  const response = await getClients({
    company_name: searchQuery.value,
    limit: 50,
    offset: (page.value - 1) * 50
  });
  clients.value = response.data;
}

// ⭐ 批量刪除（前端驗證100條上限）
async function batchDelete() {
  if (selectedClients.value.length > 100) {
    alert('批量操作最多100條記錄，請減少選擇數量');
    return;
  }
  
  if (!confirm(`確定要刪除 ${selectedClients.value.length} 個客戶嗎？`)) {
    return;
  }
  
  try {
    await batchDeleteClients(selectedClients.value);
    alert('批量刪除成功');
    selectedClients.value = [];
    fetchClients();
  } catch (error) {
    alert('批量刪除失敗：' + error.message);
  }
}
</script>

<style scoped>
.batch-actions {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: #f3f4f6;
  border-radius: 0.5rem;
  margin-bottom: 1rem;
}

.selection-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.selection-info .count {
  font-weight: 600;
  color: #374151;
}

.selection-info .error {
  color: #ef4444;
  font-weight: 600;
}
</style>
```

### ClientFormModal.vue
```vue
<template>
  <Modal :show="show" title="新增客戶" @close="$emit('close')">
    <form @submit.prevent="handleSubmit">
      <FormGroup label="統一編號">
        <StyledInput
          v-model="form.client_id"
          :required="true"
          maxlength="8"
          placeholder="8位數字"
        />
      </FormGroup>
      
      <FormGroup label="公司名稱">
        <StyledInput
          v-model="form.company_name"
          :required="true"
        />
      </FormGroup>
      
      <FormGroup label="負責人員">
        <select v-model="form.assignee_user_id" required>
          <option value="">請選擇</option>
          <option v-for="user in users" :value="user.user_id">
            {{ user.name }}
          </option>
        </select>
      </FormGroup>
      
      <FormGroup label="電話">
        <StyledInput v-model="form.phone" />
      </FormGroup>
      
      <FormGroup label="Email">
        <StyledInput v-model="form.email" type="email" />
      </FormGroup>
      
      <!-- ⭐ 客戶備註（業務相關）-->
      <FormGroup label="客戶備註">
        <textarea 
          v-model="form.client_notes" 
          rows="3"
          placeholder="記錄客戶特殊需求、注意事項等&#10;例如：喜歡提前收到報表，每月5日前完成"
        ></textarea>
        <p class="hint">業務相關備註：客戶偏好、特殊要求、注意事項等</p>
      </FormGroup>
      
      <!-- ⭐ 收款備註（財務相關）-->
      <FormGroup label="收款備註">
        <textarea 
          v-model="form.payment_notes" 
          rows="3"
          placeholder="記錄收款相關資訊&#10;例如：由財務陳小姐負責，習慣月底轉帳，帳號後5碼12345"
        ></textarea>
        <p class="hint">財務相關備註：付款習慣、聯絡窗口、收款方式等</p>
      </FormGroup>
      
      <div class="buttons">
        <StyledButton type="button" variant="ghost" @click="$emit('close')">
          取消
        </StyledButton>
        <StyledButton type="submit" :loading="isSubmitting">
          儲存
        </StyledButton>
      </div>
    </form>
  </Modal>
</template>

<script setup>
import { ref } from 'vue';

const form = ref({
  client_id: '',
  company_name: '',
  assignee_user_id: '',
  phone: '',
  email: '',
  client_notes: '',    // ⭐ 客戶備註
  payment_notes: ''    // ⭐ 收款備註
});
</script>
```

### ClientServiceForm.vue（設定客戶服務）⭐ 新增

```vue
<template>
  <div class="client-service-form">
    <h3>客戶服務設定</h3>
    
    <form @submit.prevent="submitService">
      <FormGroup label="服務項目">
        <select v-model="form.service_id" required>
          <option value="">請選擇</option>
          <option v-for="s in services" :value="s.service_id">
            {{ s.service_name }}
          </option>
        </select>
      </FormGroup>
      
      <FormGroup label="服務週期">
        <select v-model="form.frequency_id" required>
          <option value="">請選擇</option>
          <option v-for="f in frequencies" :value="f.frequency_id">
            {{ f.frequency_name }}
          </option>
        </select>
      </FormGroup>
      
      <!-- ⭐ 任務模板選擇（通用+專屬）-->
      <FormGroup label="任務模板">
        <select v-model="form.custom_template_id">
          <option value="">使用預設通用模板</option>
          
          <!-- 通用模板 -->
          <optgroup label="通用模板">
            <option 
              v-for="t in generalTemplates" 
              :value="t.template_id"
            >
              {{ t.template_name }}
            </option>
          </optgroup>
          
          <!-- 客戶專屬模板 -->
          <optgroup v-if="clientTemplates.length > 0" label="此客戶專屬模板">
            <option 
              v-for="t in clientTemplates" 
              :value="t.template_id"
              class="template-custom"
            >
              ⭐ {{ t.template_name }}
            </option>
          </optgroup>
        </select>
        <p class="hint">
          如果選擇專屬模板，系統會優先使用專屬流程生成任務。<br>
          留空則使用該服務的預設通用模板。
        </p>
      </FormGroup>
      
      <FormGroup label="開始日期">
        <input type="date" v-model="form.start_date" required />
      </FormGroup>
      
      <StyledButton type="submit">儲存</StyledButton>
    </form>
  </div>
</template>

<script setup>
import { ref, watch, onMounted } from 'vue';
import { getServices, getFrequencies } from '@/api/services';
import { getAvailableTemplates } from '@/api/tasks';

const props = defineProps({
  clientId: { type: String, required: true }
});

const services = ref([]);
const frequencies = ref([]);
const generalTemplates = ref([]);
const clientTemplates = ref([]);
const form = ref({
  client_id: props.clientId,
  service_id: '',
  frequency_id: '',
  template_id: null,
  custom_template_id: null,
  start_date: ''
});

onMounted(async () => {
  services.value = await getServices();
  frequencies.value = await getFrequencies();
});

// ⭐ 當選擇服務時，載入可用的模板
watch(() => form.value.service_id, async (serviceId) => {
  if (serviceId) {
    const response = await getAvailableTemplates(props.clientId, serviceId);
    generalTemplates.value = response.data.general_templates;
    clientTemplates.value = response.data.client_specific_templates;
  }
});

async function submitService() {
  // 提交客戶服務設定...
}
</script>

<style scoped>
.template-custom {
  font-weight: bold;
  color: #2563eb;
}
</style>
```

---

## 🔧 後端實現

### Service 層
```typescript
// services/ClientService.ts
class ClientService {
  async getClients(filters, user) {
    // ⚠️ 小型事務所彈性設計：員工可以查看所有客戶
    // 不需要權限過濾
    // if (!user.is_admin) {
    //   filters.assignee_user_id = user.user_id;  // ❌ 移除此限制
    // }
    
    return await this.repository.findAll(filters);
  }
  
  async createClient(data, userId) {
    // 1. 驗證
    this.validate(data);
    
    // 2. 檢查唯一性
    const exists = await this.repository.findByClientId(data.client_id);
    if (exists) {
      throw new ConflictError('統一編號已存在');
    }
    
    // 3. 創建
    const client = await this.repository.create({
      ...data,
      created_at: new Date(),
      is_deleted: 0
    });
    
    // 4. 處理標籤
    if (data.tag_ids) {
      await this.assignTags(client.client_id, data.tag_ids);
    }
    
    return client;
  }
  
  private validate(data) {
    if (!/^\d{8}$/.test(data.client_id)) {
      throw new ValidationError('統一編號必須為8位數字');
    }
    if (!data.company_name) {
      throw new ValidationError('公司名稱為必填');
    }
  }
}
```

### Repository 層
```typescript
// repositories/ClientRepository.ts
class ClientRepository {
  async findAll(filters) {
    let query = 'SELECT * FROM Clients WHERE is_deleted = 0';
    const params = [];
    
    if (filters.assignee_user_id) {
      query += ' AND assignee_user_id = ?';
      params.push(filters.assignee_user_id);
    }
    
    if (filters.company_name) {
      query += ' AND company_name LIKE ?';
      params.push(`%${filters.company_name}%`);
    }
    
    query += ' ORDER BY company_name LIMIT ? OFFSET ?';
    params.push(filters.limit || 50, filters.offset || 0);
    
    const result = await this.db.prepare(query).bind(...params).all();
    return result.results;
  }
  
  async create(data) {
    await this.db.prepare(`
      INSERT INTO Clients (
        client_id, company_name, assignee_user_id,
        phone, email, created_at
      )
      VALUES (?, ?, ?, ?, ?, ?)
    `).bind(
      data.client_id,
      data.company_name,
      data.assignee_user_id,
      data.phone || null,
      data.email || null,
      data.created_at
    ).run();
    
    return await this.findByClientId(data.client_id);
  }
}
```

### Route 層
```typescript
// routes/clients.ts
import { Hono } from 'hono';
import { authMiddleware, requireAdmin } from '../middleware/auth';
import { ClientService } from '../services/ClientService';

const app = new Hono();

app.get('/api/v1/clients', authMiddleware, async (c) => {
  const service = new ClientService(c.env.DB);
  const user = c.get('user');
  const query = c.req.query();
  
  const result = await service.getClients(query, user);
  return c.json(successResponse(result));
});

// ⚠️ 小型事務所彈性設計：移除 requireAdmin 中間件
app.post('/api/v1/clients', authMiddleware, async (c) => {
  const service = new ClientService(c.env.DB);
  const user = c.get('user');
  const data = await c.req.json();
  
  const client = await service.createClient(data, user.user_id);
  return c.json(successResponse(client), 201);
});

app.put('/api/v1/clients/:id', authMiddleware, async (c) => {
  const service = new ClientService(c.env.DB);
  const user = c.get('user');
  const data = await c.req.json();
  const clientId = c.req.param('id');
  
  const client = await service.updateClient(clientId, data, user);
  return c.json(successResponse(client));
});

app.delete('/api/v1/clients/:id', authMiddleware, async (c) => {
  const service = new ClientService(c.env.DB);
  const user = c.get('user');
  const clientId = c.req.param('id');
  
  await service.deleteClient(clientId, user);
  return c.json(successResponse({ message: '刪除成功' }));
});

export default app;
```

---

## ✅ 驗證規則

| 欄位 | 規則 | 錯誤訊息 |
|------|------|---------|
| client_id | 8位數字，唯一 | "統一編號必須為8位數字" |
| company_name | 必填，1-100字元 | "公司名稱為必填" |
| email | Email格式 | "Email格式錯誤" |
| phone | 台灣電話格式 | "電話格式錯誤" |

---

## 🔒 權限控制

⚠️ **小型事務所彈性設計** - 員工有較多權限以提升工作效率

### 查詢客戶
- **員工：** ✅ 可以看所有客戶（因規模小，不限負責人）
- **管理員：** ✅ 可以看所有客戶

### 新增/編輯/刪除
- **員工：** ✅ 完整權限（可新增、修改、刪除客戶）
- **管理員：** ✅ 完整權限

### 批量操作
- **員工：** ❌ 無權限（批量操作僅管理員）
- **管理員：** ✅ 完整權限（批量分配、批量刪除）

---

## 🧪 測試案例

### 測試1：新增客戶成功
```javascript
const data = {
  client_id: '12345678',
  company_name: '測試公司',
  assignee_user_id: 1
};
const result = await createClient(data);
expect(result.client_id).toBe('12345678');
```

### 測試2：統一編號重複
```javascript
await expect(createClient({ client_id: '12345678', ... }))
  .rejects.toThrow('統一編號已存在');
```

### 測試3：員工可以看所有客戶（小型事務所彈性）
```javascript
const user = { user_id: 2, is_admin: false };
const clients = await getClients({}, user);
// ✅ 小型事務所模式：員工可以看所有客戶
expect(clients.length).toBeGreaterThan(0);
// 不需要檢查 assignee_user_id（員工可看全部）
```

---

**這個文檔包含客戶管理的所有技術細節。**

