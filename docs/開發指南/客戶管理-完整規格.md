# å®¢æˆ¶ç®¡ç† - å®Œæ•´é–‹ç™¼è¦æ ¼

**çµ¦ AIï¼š** å¯¦ç¾å®¢æˆ¶ç®¡ç†åŠŸèƒ½çš„å®Œæ•´æŠ€è¡“è¦æ ¼

---

## ğŸ“‹ åŠŸèƒ½æ¸…å–®

- å®¢æˆ¶åˆ—è¡¨ï¼ˆæŸ¥è©¢ã€æœå°‹ã€ç¯©é¸ï¼‰
- æ–°å¢å®¢æˆ¶
- ç·¨è¼¯å®¢æˆ¶
- åˆªé™¤å®¢æˆ¶ï¼ˆè»Ÿåˆªé™¤ï¼‰
- æ¨™ç±¤ç®¡ç†

---

## ğŸ’¾ è³‡æ–™è¡¨

### Clients
```sql
CREATE TABLE Clients (
  client_id TEXT PRIMARY KEY,
  company_name TEXT NOT NULL,
  tax_registration_number TEXT,
  business_status TEXT DEFAULT 'ç‡Ÿæ¥­ä¸­',
  assignee_user_id INTEGER NOT NULL,
  phone TEXT,
  email TEXT,
  client_notes TEXT,          -- å®¢æˆ¶å‚™è¨»ï¼ˆè¨˜éŒ„å®¢æˆ¶ç‰¹æ®Šéœ€æ±‚ã€æ³¨æ„äº‹é …ï¼‰
  payment_notes TEXT,          -- æ”¶æ¬¾å‚™è¨»ï¼ˆè¨˜éŒ„æ”¶æ¬¾ç›¸é—œè³‡è¨Šï¼Œå¦‚ï¼šä»˜æ¬¾ç¿’æ…£ã€è¯çµ¡çª—å£ï¼‰
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,                      -- â­ åˆªé™¤æ™‚é–“
  deleted_by INTEGER,                   -- â­ åˆªé™¤äººå“¡
  
  FOREIGN KEY (assignee_user_id) REFERENCES Users(user_id),
  FOREIGN KEY (deleted_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_clients_assignee ON Clients(assignee_user_id);
CREATE INDEX idx_clients_company_name ON Clients(company_name);
```

### CustomerTags
```sql
CREATE TABLE CustomerTags (
  tag_id INTEGER PRIMARY KEY AUTOINCREMENT,
  tag_name TEXT UNIQUE NOT NULL,
  tag_color TEXT,
  created_at TEXT DEFAULT (datetime('now'))
);
```

### ClientTagAssignments
```sql
CREATE TABLE ClientTagAssignments (
  assignment_id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id TEXT NOT NULL,
  tag_id INTEGER NOT NULL,
  assigned_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (client_id) REFERENCES Clients(client_id) ON DELETE CASCADE,
  FOREIGN KEY (tag_id) REFERENCES CustomerTags(tag_id),
  UNIQUE(client_id, tag_id)
);
```

---

## ğŸ”Œ API ç«¯é»

### 1. æŸ¥è©¢å®¢æˆ¶åˆ—è¡¨
```
GET /api/v1/clients
Query: ?company_name=XX&limit=50&offset=0&fields=client_id,company_name,tags
æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå“¡å·¥è‡ªå‹•éæ¿¾ï¼‰
```

**å›æ‡‰ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "client_id": "12345678",
      "company_name": "æ¸¬è©¦å…¬å¸",
      "assignee_name": "ç´œè“",
      "tags": ["VIP", "é•·æœŸåˆä½œ"],
      "client_notes": "å–œæ­¡æå‰æ”¶åˆ°å ±è¡¨ï¼Œæ¯æœˆ5æ—¥å‰å®Œæˆ",
      "payment_notes": "ç”±è²¡å‹™é™³å°å§è² è²¬ï¼Œç¿’æ…£æœˆåº•è½‰å¸³"
    }
  ],
  "pagination": { "total": 100, "limit": 50, "offset": 0 }
}

**âš ï¸ æ¬„ä½èªªæ˜ï¼š**
- `client_notes`ï¼šæ¥­å‹™ç›¸é—œå‚™è¨»ï¼ˆå®¢æˆ¶åå¥½ã€ç‰¹æ®Šè¦æ±‚ã€æ³¨æ„äº‹é …ï¼‰
- `payment_notes`ï¼šè²¡å‹™ç›¸é—œå‚™è¨»ï¼ˆä»˜æ¬¾ç¿’æ…£ã€è¯çµ¡çª—å£ã€æ”¶æ¬¾æ–¹å¼ï¼‰
- é€™å…©å€‹æ¬„ä½åœ¨ã€Œæ‡‰æ”¶å¸³æ¬¾æŸ¥è©¢ã€æ™‚éå¸¸é‡è¦ï¼ˆæé†’æ”¶æ¬¾æ³¨æ„äº‹é …ï¼‰
```

**N+1 æŸ¥è©¢å„ªåŒ–ï¼ˆé‡è¦ï¼ï¼‰ï¼š**
```typescript
// âŒ éŒ¯èª¤ç¤ºä¾‹ - N+1 æŸ¥è©¢å•é¡Œ
async getClientsWrong() {
  const clients = await db.query(`SELECT * FROM Clients`);
  
  for (let client of clients) {
    // æ¯å€‹å®¢æˆ¶éƒ½æŸ¥ä¸€æ¬¡æ¨™ç±¤ â†’ N+1 å•é¡Œï¼
    const tags = await db.query(`
      SELECT t.tag_name 
      FROM ClientTagAssignments cta
      JOIN CustomerTags t ON cta.tag_id = t.tag_id
      WHERE cta.client_id = ?
    `, [client.client_id]);
    client.tags = tags.map(t => t.tag_name);
  }
  
  return clients;
}

// âœ… æ­£ç¢ºç¤ºä¾‹ - ä½¿ç”¨ JOIN ä¸€æ¬¡æŸ¥è©¢
async getClientsCorrect(filters, user) {
  let sql = `
    SELECT 
      c.*,
      u.name as assignee_name,
      GROUP_CONCAT(t.tag_name) as tags,
      c.client_notes,     -- â­ å®¢æˆ¶å‚™è¨»
      c.payment_notes     -- â­ æ”¶æ¬¾å‚™è¨»
    FROM Clients c
    LEFT JOIN Users u ON c.assignee_user_id = u.user_id
    LEFT JOIN ClientTagAssignments cta ON c.client_id = cta.client_id
    LEFT JOIN CustomerTags t ON cta.tag_id = t.tag_id
    WHERE c.is_deleted = 0
  `;
  
  const params = [];
  
  // å“¡å·¥åªçœ‹è‡ªå·±çš„å®¢æˆ¶
  if (!user.is_admin) {
    sql += ` AND c.assignee_user_id = ?`;
    params.push(user.user_id);
  }
  
  // æœå°‹æ¢ä»¶
  if (filters.company_name) {
    sql += ` AND c.company_name LIKE ?`;
    params.push(`%${filters.company_name}%`);
  }
  
  sql += ` GROUP BY c.client_id`;
  sql += ` ORDER BY c.created_at DESC`;
  sql += ` LIMIT ? OFFSET ?`;
  params.push(filters.limit || 50, filters.offset || 0);
  
  const result = await db.prepare(sql).bind(...params).all();
  
  // è™•ç†æ¨™ç±¤å­—ç¬¦ä¸²
  return result.results.map(row => ({
    ...row,
    tags: row.tags ? row.tags.split(',') : []
  }));
}
```

**å­—æ®µé¸æ“‡å™¨ï¼ˆSparse Fieldsetsï¼‰ï¼š**
```typescript
// æ”¯æŒåƒ…è¿”å›æ‰€éœ€å­—æ®µ
async getClients(filters, user, fields = ['*']) {
  const selectClause = fields.includes('*') 
    ? 'c.*, u.name as assignee_name, GROUP_CONCAT(t.tag_name) as tags'
    : fields.map(f => {
        if (f === 'assignee_name') return 'u.name as assignee_name';
        if (f === 'tags') return 'GROUP_CONCAT(t.tag_name) as tags';
        return `c.${f}`;
      }).join(', ');
  
  // ... å…¶ä»–æŸ¥è©¢é‚è¼¯
}

// ä½¿ç”¨ç¤ºä¾‹
GET /api/v1/clients?fields=client_id,company_name
// åƒ…è¿”å› ID å’Œå…¬å¸åç¨±ï¼Œæ¸›å°‘å¸¶å¯¬
```

### 2. æ–°å¢å®¢æˆ¶
```
POST /api/v1/clients
æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
```

**è«‹æ±‚ Bodyï¼š**
```json
{
  "client_id": "12345678",
  "company_name": "æ¸¬è©¦å…¬å¸",
  "assignee_user_id": 1,
  "phone": "02-1234-5678",
  "email": "test@example.com",
  "client_notes": "å–œæ­¡æå‰æ”¶åˆ°å ±è¡¨ï¼Œæ¯æœˆ5æ—¥å‰å®Œæˆ",
  "payment_notes": "ç”±è²¡å‹™é™³å°å§è² è²¬ï¼Œç¿’æ…£æœˆåº•è½‰å¸³",
  "tag_ids": [1, 2]
}
```

### 3. æ›´æ–°å®¢æˆ¶
```
PUT /api/v1/clients/:id
æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
```

### 4. åˆªé™¤å®¢æˆ¶
```
DELETE /api/v1/clients/:id
æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
```

### 5. æ¨™ç±¤ç®¡ç†
```
GET  /api/v1/clients/tags          æ¬Šé™ï¼šæ‰€æœ‰äºº
POST /api/v1/clients/tags          æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
PUT  /api/v1/clients/tags/:id      æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
DELETE /api/v1/clients/tags/:id    æ¬Šé™ï¼šæ‰€æœ‰äººï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼‰
```

### 6. æ‰¹é‡æ“ä½œï¼ˆç®¡ç†å“¡ï¼‰
```
POST /api/v1/clients/batch-update         æ‰¹é‡æ›´æ–°
POST /api/v1/clients/batch-delete         æ‰¹é‡åˆªé™¤
POST /api/v1/clients/batch-assign         æ‰¹é‡åˆ†é…è² è²¬äºº
```

**æ‰¹é‡æ›´æ–°è² è²¬äººï¼š**
```json
POST /api/v1/clients/batch-assign
{
  "client_ids": ["12345678", "87654321", "11223344"],
  "assignee_user_id": 5
}

// å›æ‡‰
{
  "success": true,
  "data": {
    "total": 3,
    "succeeded": 3,
    "failed": 0,
    "details": [
      { "client_id": "12345678", "status": "success" },
      { "client_id": "87654321", "status": "success" },
      { "client_id": "11223344", "status": "success" }
    ]
  }
}
```

**æ‰¹é‡åˆªé™¤ï¼š**
```json
POST /api/v1/clients/batch-delete
{
  "client_ids": ["12345678", "87654321"]
}

// å›æ‡‰
{
  "success": true,
  "data": {
    "total": 2,
    "succeeded": 2,
    "failed": 0,
    "warnings": [
      "å®¢æˆ¶ 12345678 æœ‰ 5 å€‹æœªå®Œæˆä»»å‹™å°‡ä¸€ä½µåˆªé™¤"
    ]
  }
}
```

**æ‰¹é‡æ“ä½œå¯¦ç¾ï¼š**
```typescript
class ClientService {
  async batchAssign(clientIds: string[], assigneeUserId: number, adminUser) {
    // 1. é™åˆ¶æ‰¹é‡å¤§å°
    if (clientIds.length > 100) {
      throw new ValidationError('æ‰¹é‡æ“ä½œæœ€å¤š 100 æ¢è¨˜éŒ„');
    }
    
    // 2. é©—è­‰å“¡å·¥å­˜åœ¨
    const user = await this.userRepo.findById(assigneeUserId);
    if (!user) {
      throw new NotFoundError('è² è²¬äººä¸å­˜åœ¨');
    }
    
    const results = [];
    let succeeded = 0;
    let failed = 0;
    
    // 3. ä½¿ç”¨äº‹å‹™è™•ç†
    await this.db.batch([
      ...clientIds.map(clientId => 
        this.db.prepare(`
          UPDATE Clients 
          SET assignee_user_id = ?, updated_at = datetime('now')
          WHERE client_id = ? AND is_deleted = 0
        `).bind(assigneeUserId, clientId)
      )
    ]);
    
    // 4. è¨˜éŒ„å¯©è¨ˆæ—¥èªŒ
    for (const clientId of clientIds) {
      await this.auditLog.log({
        user_id: adminUser.user_id,
        action: 'BATCH_UPDATE',
        table_name: 'Clients',
        record_id: clientId,
        changes: { assignee_user_id: assigneeUserId }
      });
    }
    
    return {
      total: clientIds.length,
      succeeded: clientIds.length,
      failed: 0
    };
  }
  
  async batchDelete(clientIds: string[], adminUser) {
    // 1. é™åˆ¶æ‰¹é‡å¤§å°
    if (clientIds.length > 100) {
      throw new ValidationError('æ‰¹é‡æ“ä½œæœ€å¤š 100 æ¢è¨˜éŒ„');
    }
    
    const warnings = [];
    
    // 2. æª¢æŸ¥é—œè¯æ•¸æ“š
    for (const clientId of clientIds) {
      const taskCount = await this.db.prepare(`
        SELECT COUNT(*) as count FROM ActiveTasks
        WHERE client_id = ? AND is_deleted = 0
      `).bind(clientId).first();
      
      if (taskCount.count > 0) {
        warnings.push(`å®¢æˆ¶ ${clientId} æœ‰ ${taskCount.count} å€‹æœªå®Œæˆä»»å‹™å°‡ä¸€ä½µåˆªé™¤`);
      }
    }
    
    // 3. è»Ÿåˆªé™¤å®¢æˆ¶
    await this.db.batch([
      ...clientIds.map(clientId =>
        this.db.prepare(`
          UPDATE Clients
          SET is_deleted = 1, 
              deleted_at = datetime('now'),
              deleted_by = ?
          WHERE client_id = ?
        `).bind(adminUser.user_id, clientId)
      )
    ]);
    
    return {
      total: clientIds.length,
      succeeded: clientIds.length,
      failed: 0,
      warnings
    };
  }
}
```

---

## ğŸ¨ å‰ç«¯çµ„ä»¶

### ClientListPage.vue
```vue
<template>
  <div class="clients-page">
    <h1>å®¢æˆ¶ç®¡ç†</h1>
    
    <div class="filters">
      <StyledInput 
        v-model="searchQuery"
        placeholder="æœå°‹å…¬å¸åç¨±"
      />
      <StyledButton 
        v-if="user.is_admin"
        @click="showCreateModal = true"
      >
        + æ–°å¢å®¢æˆ¶
      </StyledButton>
    </div>

    <!-- â­ æ‰¹é‡æ“ä½œå€åŸŸï¼ˆç®¡ç†å“¡ï¼‰-->
    <div v-if="user.is_admin && selectedClients.length > 0" class="batch-actions">
      <div class="selection-info">
        <span class="count">
          å·²é¸æ“‡ {{ selectedClients.length }} / 100
        </span>
        <span v-if="selectedClients.length > 100" class="error">
          âš ï¸ è¶…éä¸Šé™ï¼æ‰¹é‡æ“ä½œæœ€å¤š100æ¢
        </span>
      </div>
      
      <StyledButton 
        @click="showBatchAssign = true"
        :disabled="selectedClients.length === 0 || selectedClients.length > 100"
      >
        æ‰¹é‡åˆ†é…è² è²¬äºº
      </StyledButton>
      
      <StyledButton 
        @click="batchDelete"
        :disabled="selectedClients.length === 0 || selectedClients.length > 100"
        variant="danger"
      >
        æ‰¹é‡åˆªé™¤
      </StyledButton>
    </div>

    <DataTable
      :columns="columns"
      :data="clients"
      :selectable="user.is_admin"
      v-model:selected="selectedClients"
      @row-click="handleRowClick"
    />
    
    <Pagination
      :total="total"
      :current-page="page"
      @change="fetchClients"
    />
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { getClients, batchAssignClients, batchDeleteClients } from '@/api/clients';
import { useAuth } from '@/composables/useAuth';

const { user } = useAuth();
const clients = ref([]);
const searchQuery = ref('');
const page = ref(1);
const selectedClients = ref([]);  // â­ å·²é¸æ“‡çš„å®¢æˆ¶
const showBatchAssign = ref(false);

onMounted(() => {
  fetchClients();
});

async function fetchClients() {
  const response = await getClients({
    company_name: searchQuery.value,
    limit: 50,
    offset: (page.value - 1) * 50
  });
  clients.value = response.data;
}

// â­ æ‰¹é‡åˆªé™¤ï¼ˆå‰ç«¯é©—è­‰100æ¢ä¸Šé™ï¼‰
async function batchDelete() {
  if (selectedClients.value.length > 100) {
    alert('æ‰¹é‡æ“ä½œæœ€å¤š100æ¢è¨˜éŒ„ï¼Œè«‹æ¸›å°‘é¸æ“‡æ•¸é‡');
    return;
  }
  
  if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${selectedClients.value.length} å€‹å®¢æˆ¶å—ï¼Ÿ`)) {
    return;
  }
  
  try {
    await batchDeleteClients(selectedClients.value);
    alert('æ‰¹é‡åˆªé™¤æˆåŠŸ');
    selectedClients.value = [];
    fetchClients();
  } catch (error) {
    alert('æ‰¹é‡åˆªé™¤å¤±æ•—ï¼š' + error.message);
  }
}
</script>

<style scoped>
.batch-actions {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: #f3f4f6;
  border-radius: 0.5rem;
  margin-bottom: 1rem;
}

.selection-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.selection-info .count {
  font-weight: 600;
  color: #374151;
}

.selection-info .error {
  color: #ef4444;
  font-weight: 600;
}
</style>
```

### ClientFormModal.vue
```vue
<template>
  <Modal :show="show" title="æ–°å¢å®¢æˆ¶" @close="$emit('close')">
    <form @submit.prevent="handleSubmit">
      <FormGroup label="çµ±ä¸€ç·¨è™Ÿ">
        <StyledInput
          v-model="form.client_id"
          :required="true"
          maxlength="8"
          placeholder="8ä½æ•¸å­—"
        />
      </FormGroup>
      
      <FormGroup label="å…¬å¸åç¨±">
        <StyledInput
          v-model="form.company_name"
          :required="true"
        />
      </FormGroup>
      
      <FormGroup label="è² è²¬äººå“¡">
        <select v-model="form.assignee_user_id" required>
          <option value="">è«‹é¸æ“‡</option>
          <option v-for="user in users" :value="user.user_id">
            {{ user.name }}
          </option>
        </select>
      </FormGroup>
      
      <FormGroup label="é›»è©±">
        <StyledInput v-model="form.phone" />
      </FormGroup>
      
      <FormGroup label="Email">
        <StyledInput v-model="form.email" type="email" />
      </FormGroup>
      
      <!-- â­ å®¢æˆ¶å‚™è¨»ï¼ˆæ¥­å‹™ç›¸é—œï¼‰-->
      <FormGroup label="å®¢æˆ¶å‚™è¨»">
        <textarea 
          v-model="form.client_notes" 
          rows="3"
          placeholder="è¨˜éŒ„å®¢æˆ¶ç‰¹æ®Šéœ€æ±‚ã€æ³¨æ„äº‹é …ç­‰&#10;ä¾‹å¦‚ï¼šå–œæ­¡æå‰æ”¶åˆ°å ±è¡¨ï¼Œæ¯æœˆ5æ—¥å‰å®Œæˆ"
        ></textarea>
        <p class="hint">æ¥­å‹™ç›¸é—œå‚™è¨»ï¼šå®¢æˆ¶åå¥½ã€ç‰¹æ®Šè¦æ±‚ã€æ³¨æ„äº‹é …ç­‰</p>
      </FormGroup>
      
      <!-- â­ æ”¶æ¬¾å‚™è¨»ï¼ˆè²¡å‹™ç›¸é—œï¼‰-->
      <FormGroup label="æ”¶æ¬¾å‚™è¨»">
        <textarea 
          v-model="form.payment_notes" 
          rows="3"
          placeholder="è¨˜éŒ„æ”¶æ¬¾ç›¸é—œè³‡è¨Š&#10;ä¾‹å¦‚ï¼šç”±è²¡å‹™é™³å°å§è² è²¬ï¼Œç¿’æ…£æœˆåº•è½‰å¸³ï¼Œå¸³è™Ÿå¾Œ5ç¢¼12345"
        ></textarea>
        <p class="hint">è²¡å‹™ç›¸é—œå‚™è¨»ï¼šä»˜æ¬¾ç¿’æ…£ã€è¯çµ¡çª—å£ã€æ”¶æ¬¾æ–¹å¼ç­‰</p>
      </FormGroup>
      
      <div class="buttons">
        <StyledButton type="button" variant="ghost" @click="$emit('close')">
          å–æ¶ˆ
        </StyledButton>
        <StyledButton type="submit" :loading="isSubmitting">
          å„²å­˜
        </StyledButton>
      </div>
    </form>
  </Modal>
</template>

<script setup>
import { ref } from 'vue';

const form = ref({
  client_id: '',
  company_name: '',
  assignee_user_id: '',
  phone: '',
  email: '',
  client_notes: '',    // â­ å®¢æˆ¶å‚™è¨»
  payment_notes: ''    // â­ æ”¶æ¬¾å‚™è¨»
});
</script>
```

### ClientServiceForm.vueï¼ˆè¨­å®šå®¢æˆ¶æœå‹™ï¼‰â­ æ–°å¢

```vue
<template>
  <div class="client-service-form">
    <h3>å®¢æˆ¶æœå‹™è¨­å®š</h3>
    
    <form @submit.prevent="submitService">
      <FormGroup label="æœå‹™é …ç›®">
        <select v-model="form.service_id" required>
          <option value="">è«‹é¸æ“‡</option>
          <option v-for="s in services" :value="s.service_id">
            {{ s.service_name }}
          </option>
        </select>
      </FormGroup>
      
      <FormGroup label="æœå‹™é€±æœŸ">
        <select v-model="form.frequency_id" required>
          <option value="">è«‹é¸æ“‡</option>
          <option v-for="f in frequencies" :value="f.frequency_id">
            {{ f.frequency_name }}
          </option>
        </select>
      </FormGroup>
      
      <!-- â­ ä»»å‹™æ¨¡æ¿é¸æ“‡ï¼ˆé€šç”¨+å°ˆå±¬ï¼‰-->
      <FormGroup label="ä»»å‹™æ¨¡æ¿">
        <select v-model="form.custom_template_id">
          <option value="">ä½¿ç”¨é è¨­é€šç”¨æ¨¡æ¿</option>
          
          <!-- é€šç”¨æ¨¡æ¿ -->
          <optgroup label="é€šç”¨æ¨¡æ¿">
            <option 
              v-for="t in generalTemplates" 
              :value="t.template_id"
            >
              {{ t.template_name }}
            </option>
          </optgroup>
          
          <!-- å®¢æˆ¶å°ˆå±¬æ¨¡æ¿ -->
          <optgroup v-if="clientTemplates.length > 0" label="æ­¤å®¢æˆ¶å°ˆå±¬æ¨¡æ¿">
            <option 
              v-for="t in clientTemplates" 
              :value="t.template_id"
              class="template-custom"
            >
              â­ {{ t.template_name }}
            </option>
          </optgroup>
        </select>
        <p class="hint">
          å¦‚æœé¸æ“‡å°ˆå±¬æ¨¡æ¿ï¼Œç³»çµ±æœƒå„ªå…ˆä½¿ç”¨å°ˆå±¬æµç¨‹ç”Ÿæˆä»»å‹™ã€‚<br>
          ç•™ç©ºå‰‡ä½¿ç”¨è©²æœå‹™çš„é è¨­é€šç”¨æ¨¡æ¿ã€‚
        </p>
      </FormGroup>
      
      <FormGroup label="é–‹å§‹æ—¥æœŸ">
        <input type="date" v-model="form.start_date" required />
      </FormGroup>
      
      <StyledButton type="submit">å„²å­˜</StyledButton>
    </form>
  </div>
</template>

<script setup>
import { ref, watch, onMounted } from 'vue';
import { getServices, getFrequencies } from '@/api/services';
import { getAvailableTemplates } from '@/api/tasks';

const props = defineProps({
  clientId: { type: String, required: true }
});

const services = ref([]);
const frequencies = ref([]);
const generalTemplates = ref([]);
const clientTemplates = ref([]);
const form = ref({
  client_id: props.clientId,
  service_id: '',
  frequency_id: '',
  template_id: null,
  custom_template_id: null,
  start_date: ''
});

onMounted(async () => {
  services.value = await getServices();
  frequencies.value = await getFrequencies();
});

// â­ ç•¶é¸æ“‡æœå‹™æ™‚ï¼Œè¼‰å…¥å¯ç”¨çš„æ¨¡æ¿
watch(() => form.value.service_id, async (serviceId) => {
  if (serviceId) {
    const response = await getAvailableTemplates(props.clientId, serviceId);
    generalTemplates.value = response.data.general_templates;
    clientTemplates.value = response.data.client_specific_templates;
  }
});

async function submitService() {
  // æäº¤å®¢æˆ¶æœå‹™è¨­å®š...
}
</script>

<style scoped>
.template-custom {
  font-weight: bold;
  color: #2563eb;
}
</style>
```

---

## ğŸ”§ å¾Œç«¯å¯¦ç¾

### Service å±¤
```typescript
// services/ClientService.ts
class ClientService {
  async getClients(filters, user) {
    // âš ï¸ å°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼šå“¡å·¥å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å®¢æˆ¶
    // ä¸éœ€è¦æ¬Šé™éæ¿¾
    // if (!user.is_admin) {
    //   filters.assignee_user_id = user.user_id;  // âŒ ç§»é™¤æ­¤é™åˆ¶
    // }
    
    return await this.repository.findAll(filters);
  }
  
  async createClient(data, userId) {
    // 1. é©—è­‰
    this.validate(data);
    
    // 2. æª¢æŸ¥å”¯ä¸€æ€§
    const exists = await this.repository.findByClientId(data.client_id);
    if (exists) {
      throw new ConflictError('çµ±ä¸€ç·¨è™Ÿå·²å­˜åœ¨');
    }
    
    // 3. å‰µå»º
    const client = await this.repository.create({
      ...data,
      created_at: new Date(),
      is_deleted: 0
    });
    
    // 4. è™•ç†æ¨™ç±¤
    if (data.tag_ids) {
      await this.assignTags(client.client_id, data.tag_ids);
    }
    
    return client;
  }
  
  private validate(data) {
    if (!/^\d{8}$/.test(data.client_id)) {
      throw new ValidationError('çµ±ä¸€ç·¨è™Ÿå¿…é ˆç‚º8ä½æ•¸å­—');
    }
    if (!data.company_name) {
      throw new ValidationError('å…¬å¸åç¨±ç‚ºå¿…å¡«');
    }
  }
}
```

### Repository å±¤
```typescript
// repositories/ClientRepository.ts
class ClientRepository {
  async findAll(filters) {
    let query = 'SELECT * FROM Clients WHERE is_deleted = 0';
    const params = [];
    
    if (filters.assignee_user_id) {
      query += ' AND assignee_user_id = ?';
      params.push(filters.assignee_user_id);
    }
    
    if (filters.company_name) {
      query += ' AND company_name LIKE ?';
      params.push(`%${filters.company_name}%`);
    }
    
    query += ' ORDER BY company_name LIMIT ? OFFSET ?';
    params.push(filters.limit || 50, filters.offset || 0);
    
    const result = await this.db.prepare(query).bind(...params).all();
    return result.results;
  }
  
  async create(data) {
    await this.db.prepare(`
      INSERT INTO Clients (
        client_id, company_name, assignee_user_id,
        phone, email, created_at
      )
      VALUES (?, ?, ?, ?, ?, ?)
    `).bind(
      data.client_id,
      data.company_name,
      data.assignee_user_id,
      data.phone || null,
      data.email || null,
      data.created_at
    ).run();
    
    return await this.findByClientId(data.client_id);
  }
}
```

### Route å±¤
```typescript
// routes/clients.ts
import { Hono } from 'hono';
import { authMiddleware, requireAdmin } from '../middleware/auth';
import { ClientService } from '../services/ClientService';

const app = new Hono();

app.get('/api/v1/clients', authMiddleware, async (c) => {
  const service = new ClientService(c.env.DB);
  const user = c.get('user');
  const query = c.req.query();
  
  const result = await service.getClients(query, user);
  return c.json(successResponse(result));
});

// âš ï¸ å°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆï¼šç§»é™¤ requireAdmin ä¸­é–“ä»¶
app.post('/api/v1/clients', authMiddleware, async (c) => {
  const service = new ClientService(c.env.DB);
  const user = c.get('user');
  const data = await c.req.json();
  
  const client = await service.createClient(data, user.user_id);
  return c.json(successResponse(client), 201);
});

app.put('/api/v1/clients/:id', authMiddleware, async (c) => {
  const service = new ClientService(c.env.DB);
  const user = c.get('user');
  const data = await c.req.json();
  const clientId = c.req.param('id');
  
  const client = await service.updateClient(clientId, data, user);
  return c.json(successResponse(client));
});

app.delete('/api/v1/clients/:id', authMiddleware, async (c) => {
  const service = new ClientService(c.env.DB);
  const user = c.get('user');
  const clientId = c.req.param('id');
  
  await service.deleteClient(clientId, user);
  return c.json(successResponse({ message: 'åˆªé™¤æˆåŠŸ' }));
});

export default app;
```

---

## âœ… é©—è­‰è¦å‰‡

| æ¬„ä½ | è¦å‰‡ | éŒ¯èª¤è¨Šæ¯ |
|------|------|---------|
| client_id | 8ä½æ•¸å­—ï¼Œå”¯ä¸€ | "çµ±ä¸€ç·¨è™Ÿå¿…é ˆç‚º8ä½æ•¸å­—" |
| company_name | å¿…å¡«ï¼Œ1-100å­—å…ƒ | "å…¬å¸åç¨±ç‚ºå¿…å¡«" |
| email | Emailæ ¼å¼ | "Emailæ ¼å¼éŒ¯èª¤" |
| phone | å°ç£é›»è©±æ ¼å¼ | "é›»è©±æ ¼å¼éŒ¯èª¤" |

---

## ğŸ”’ æ¬Šé™æ§åˆ¶

âš ï¸ **å°å‹äº‹å‹™æ‰€å½ˆæ€§è¨­è¨ˆ** - å“¡å·¥æœ‰è¼ƒå¤šæ¬Šé™ä»¥æå‡å·¥ä½œæ•ˆç‡

### æŸ¥è©¢å®¢æˆ¶
- **å“¡å·¥ï¼š** âœ… å¯ä»¥çœ‹æ‰€æœ‰å®¢æˆ¶ï¼ˆå› è¦æ¨¡å°ï¼Œä¸é™è² è²¬äººï¼‰
- **ç®¡ç†å“¡ï¼š** âœ… å¯ä»¥çœ‹æ‰€æœ‰å®¢æˆ¶

### æ–°å¢/ç·¨è¼¯/åˆªé™¤
- **å“¡å·¥ï¼š** âœ… å®Œæ•´æ¬Šé™ï¼ˆå¯æ–°å¢ã€ä¿®æ”¹ã€åˆªé™¤å®¢æˆ¶ï¼‰
- **ç®¡ç†å“¡ï¼š** âœ… å®Œæ•´æ¬Šé™

### æ‰¹é‡æ“ä½œ
- **å“¡å·¥ï¼š** âŒ ç„¡æ¬Šé™ï¼ˆæ‰¹é‡æ“ä½œåƒ…ç®¡ç†å“¡ï¼‰
- **ç®¡ç†å“¡ï¼š** âœ… å®Œæ•´æ¬Šé™ï¼ˆæ‰¹é‡åˆ†é…ã€æ‰¹é‡åˆªé™¤ï¼‰

---

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

### æ¸¬è©¦1ï¼šæ–°å¢å®¢æˆ¶æˆåŠŸ
```javascript
const data = {
  client_id: '12345678',
  company_name: 'æ¸¬è©¦å…¬å¸',
  assignee_user_id: 1
};
const result = await createClient(data);
expect(result.client_id).toBe('12345678');
```

### æ¸¬è©¦2ï¼šçµ±ä¸€ç·¨è™Ÿé‡è¤‡
```javascript
await expect(createClient({ client_id: '12345678', ... }))
  .rejects.toThrow('çµ±ä¸€ç·¨è™Ÿå·²å­˜åœ¨');
```

### æ¸¬è©¦3ï¼šå“¡å·¥å¯ä»¥çœ‹æ‰€æœ‰å®¢æˆ¶ï¼ˆå°å‹äº‹å‹™æ‰€å½ˆæ€§ï¼‰
```javascript
const user = { user_id: 2, is_admin: false };
const clients = await getClients({}, user);
// âœ… å°å‹äº‹å‹™æ‰€æ¨¡å¼ï¼šå“¡å·¥å¯ä»¥çœ‹æ‰€æœ‰å®¢æˆ¶
expect(clients.length).toBeGreaterThan(0);
// ä¸éœ€è¦æª¢æŸ¥ assignee_user_idï¼ˆå“¡å·¥å¯çœ‹å…¨éƒ¨ï¼‰
```

---

**é€™å€‹æ–‡æª”åŒ…å«å®¢æˆ¶ç®¡ç†çš„æ‰€æœ‰æŠ€è¡“ç´°ç¯€ã€‚**

