# 業務規則 - 完整開發規格

**給 AI：** 實現業務規則管理的完整技術規格（僅管理員）

---

## 💾 資料表

### Holidays（國定假日）
```sql
CREATE TABLE Holidays (
  holiday_id INTEGER PRIMARY KEY AUTOINCREMENT,
  holiday_date TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  is_national_holiday BOOLEAN DEFAULT 1,     -- ⭐ 是否為國定假日（1=是，0=補班日）
  is_makeup_workday BOOLEAN DEFAULT 0,       -- ⭐ 是否為補班日（原本假日調整為上班）
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0
);

CREATE UNIQUE INDEX idx_holidays_date ON Holidays(holiday_date);
CREATE INDEX idx_holidays_makeup ON Holidays(is_makeup_workday);
```

**欄位說明：**
```
is_national_holiday:
  1 = 國定假日（如：10/10國慶日）
  0 = 補班日（原本是假日，調整為上班）
  
is_makeup_workday:
  1 = 補班日（如：春節前的週六要補班）
  0 = 一般國定假日

範例：
1. 2025-10-10（國慶日）
   is_national_holiday = 1
   is_makeup_workday = 0
   
2. 2025-02-08（春節補班日）
   is_national_holiday = 0  ⭐ 不是國定假日
   is_makeup_workday = 1    ⭐ 是補班日
   
3. 2025-02-10（調整放假）
   不用記錄在Holidays表（因為是「多放的假」，不是國定假日）
   或記錄為：
   is_national_holiday = 0
   is_makeup_workday = 0
   name = '春節調整放假'
```

### LeaveTypes（假別類型）
```sql
CREATE TABLE LeaveTypes (
  leave_type_id INTEGER PRIMARY KEY AUTOINCREMENT,
  type_name TEXT UNIQUE NOT NULL,
  annual_quota REAL,
  deduct_leave BOOLEAN DEFAULT 1,
  is_paid BOOLEAN DEFAULT 1,
  gender_specific TEXT,             -- 'M', 'F', NULL
  is_enabled BOOLEAN DEFAULT 1,
  sort_order INTEGER DEFAULT 0,
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0
);
```

### AnnualLeaveRules（特休規則）
```sql
CREATE TABLE AnnualLeaveRules (
  rule_id INTEGER PRIMARY KEY AUTOINCREMENT,
  min_months INTEGER NOT NULL,
  max_months INTEGER NOT NULL,
  days INTEGER NOT NULL,
  description TEXT
);
```

### OtherLeaveRules（其他假期規則）
```sql
CREATE TABLE OtherLeaveRules (
  rule_id INTEGER PRIMARY KEY AUTOINCREMENT,
  leave_type_id INTEGER NOT NULL,
  event_type TEXT NOT NULL,
  days REAL NOT NULL,
  validity_days INTEGER DEFAULT 365,
  
  FOREIGN KEY (leave_type_id) REFERENCES LeaveTypes(leave_type_id)
);
```

### OvertimeRates（加班費率）
```sql
CREATE TABLE OvertimeRates (
  rate_id INTEGER PRIMARY KEY AUTOINCREMENT,
  work_type_id INTEGER NOT NULL,
  rate_multiplier REAL NOT NULL,
  effective_date TEXT NOT NULL,
  is_current BOOLEAN DEFAULT 1,
  
  FOREIGN KEY (work_type_id) REFERENCES WorkTypes(work_type_id)
);
```

### ServiceFrequencyTypes（週期類型）
```sql
CREATE TABLE ServiceFrequencyTypes (
  frequency_id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT UNIQUE NOT NULL,
  days_interval INTEGER,
  months_interval INTEGER,
  is_recurring BOOLEAN DEFAULT 1,
  is_enabled BOOLEAN DEFAULT 1,
  sort_order INTEGER DEFAULT 0
);
```

### Services（服務項目）
```sql
CREATE TABLE Services (
  service_id INTEGER PRIMARY KEY AUTOINCREMENT,
  parent_service_id INTEGER,
  service_name TEXT NOT NULL,
  description TEXT,
  sort_order INTEGER DEFAULT 0,
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  
  FOREIGN KEY (parent_service_id) REFERENCES Services(service_id)
);

CREATE INDEX idx_services_parent ON Services(parent_service_id);
```

---

## 🔌 API 端點

### 國定假日

⚠️ **小型事務所彈性設計** - 員工可協助維護國定假日

```
GET    /api/v1/holidays                   權限：所有人
POST   /api/v1/holidays                   權限：所有人（小型事務所彈性設計）
PUT    /api/v1/holidays/:id               權限：所有人（小型事務所彈性設計）
DELETE /api/v1/holidays/:id               權限：所有人（小型事務所彈性設計）
POST   /api/v1/admin/holidays/import      權限：管理員（批量導入）
```

### 假別類型

⚠️ **小型事務所彈性設計** - 員工可新增/編輯自訂假別

```
GET    /api/v1/leave-types                 權限：所有人
POST   /api/v1/leave-types                 權限：所有人（小型事務所彈性設計）
PUT    /api/v1/leave-types/:id             權限：所有人（小型事務所彈性設計）
POST   /api/v1/leave-types/:id/enable      權限：所有人（小型事務所彈性設計）
POST   /api/v1/leave-types/:id/disable     權限：所有人（小型事務所彈性設計）
```

### 特休規則
```
GET    /api/v1/admin/annual-leave-rules
POST   /api/v1/admin/annual-leave-rules
PUT    /api/v1/admin/annual-leave-rules/:id
DELETE /api/v1/admin/annual-leave-rules/:id
POST   /api/v1/admin/annual-leave-rules/restore-defaults
```

### 加班費率
```
GET    /api/v1/admin/overtime-rates
POST   /api/v1/admin/overtime-rates
PUT    /api/v1/admin/overtime-rates/:id
POST   /api/v1/admin/overtime-rates/restore-defaults
```

### 週期類型
```
GET    /api/v1/admin/frequency-types
POST   /api/v1/admin/frequency-types
PUT    /api/v1/admin/frequency-types/:id
POST   /api/v1/admin/frequency-types/:id/enable
POST   /api/v1/admin/frequency-types/:id/disable
```

### 服務項目

⚠️ **小型事務所彈性設計** - 員工可協助維護服務項目

```
GET    /api/v1/services                    權限：所有人
POST   /api/v1/services                    權限：所有人（小型事務所彈性設計）
PUT    /api/v1/services/:id                權限：所有人（小型事務所彈性設計）
DELETE /api/v1/services/:id                權限：所有人（小型事務所彈性設計）
```

---

## 🔧 後端實現

### BusinessRulesService
```typescript
class BusinessRulesService {
  // 恢復法定預設值
  async restoreDefaultAnnualLeaveRules() {
    // 1. 刪除所有現有規則
    await this.repository.deleteAll('AnnualLeaveRules');
    
    // 2. 插入法定預設值
    const defaults = [
      { min_months: 6, max_months: 12, days: 3 },
      { min_months: 12, max_months: 24, days: 7 },
      { min_months: 24, max_months: 36, days: 10 },
      { min_months: 36, max_months: 60, days: 14 },
      { min_months: 60, max_months: 120, days: 15 }
    ];
    
    for (const rule of defaults) {
      await this.repository.create('AnnualLeaveRules', rule);
    }
    
    // 3. 重新計算所有員工的特休餘額
    await this.recalculateAllLeaveBalances();
    
    return { success: true };
  }
  
  // 服務項目層級驗證
  async validateServiceHierarchy(serviceData) {
    if (serviceData.parent_service_id) {
      const parent = await this.serviceRepo.findById(serviceData.parent_service_id);
      
      // 禁止三層結構
      if (parent.parent_service_id !== null) {
        throw new ValidationError('不允許三層結構');
      }
    }
  }
  
  // 批量導入國定假日
  async importHolidays(csvData) {
    const holidays = parseCsv(csvData);
    
    for (const holiday of holidays) {
      await this.holidayRepo.create({
        holiday_date: holiday.date,
        name: holiday.name,
        is_compensatory_day_off: holiday.isCompensatory || false
      });
    }
    
    return { imported: holidays.length };
  }
}
```

---

## 🎨 前端組件

- 業務規則的管理介面由系統設定/管理頁整合呈現，無專屬單獨頁面
- 國定假日、假別類型、服務項目等以表單與列表管理（共用組件）

## ✅ 業務規則

### 法定預設值

**特休規則：**
```
6個月-1年：3天
1-2年：7天
2-3年：10天
3-5年：14天
5-10年：15天
10年以上：每年+1天（最高30天）
```

**加班費率：**
```
正常工時：1.00倍
平日加班：1.34倍
休息日加班（前2小時）：1.34倍
休息日加班（第3小時起）：1.67倍
國定假日加班：2.00倍
```

**週期類型：**
```
單次、每月、雙月、每季、半年、每年
```

### 驗證規則
- 服務項目：最多兩層結構
- 國定假日：日期不可重複
- 費率倍數：必須 > 0

---

## 🧪 測試案例

- 國定假日：同日期重複新增 → 應被唯一性約束拒絕
- 假別類型：性別限制設定後 → 前端可申請假別清單正確過濾
- 服務項目：建立第三層（孫層）→ 應被拒絕（最多兩層）
- 批量導入國定假日 → 匯入筆數與資料正確

**這個文檔包含所有業務規則管理的技術細節。**

