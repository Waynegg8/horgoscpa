# ç³»çµ±åŸºç¤ - å®Œæ•´é–‹ç™¼è¦æ ¼

**çµ¦ AIï¼š** èªè­‰ã€å“¡å·¥ç®¡ç†ã€ç³»çµ±è¨­å®šç­‰åŸºç¤åŠŸèƒ½çš„å®Œæ•´æŠ€è¡“è¦æ ¼

---

## ğŸ’¾ è³‡æ–™è¡¨

### Usersï¼ˆå“¡å·¥/ç”¨æˆ¶ï¼‰
```sql
CREATE TABLE Users (
  user_id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  name TEXT NOT NULL,
  email TEXT NOT NULL,                 -- å¿…å¡«
  is_admin BOOLEAN DEFAULT 0,          -- â­ æ ¸å¿ƒï¼š0=å“¡å·¥, 1=ç®¡ç†å“¡
  gender TEXT NOT NULL,                -- 'M', 'F'ï¼ˆå¿…å¡«ï¼Œå½±éŸ¿å‡æœŸé¸é …ï¼‰
  birth_date TEXT,
  start_date TEXT NOT NULL,            -- åˆ°è·æ—¥æœŸï¼ˆå¿…å¡«ï¼Œç”¨æ–¼è¨ˆç®—å¹´è³‡å’Œç‰¹ä¼‘ï¼‰
  phone TEXT,
  address TEXT,
  emergency_contact_name TEXT,
  emergency_contact_phone TEXT,
  
  -- ç™»å…¥æ§åˆ¶
  login_attempts INTEGER DEFAULT 0,
  last_failed_login TEXT,
  last_login TEXT,
  
  -- å¯©è¨ˆæ¬„ä½
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,
  deleted_at TEXT,
  deleted_by INTEGER
);

CREATE UNIQUE INDEX idx_users_username ON Users(username);
CREATE INDEX idx_users_email ON Users(email);
CREATE INDEX idx_users_is_admin ON Users(is_admin);
```

### Settingsï¼ˆç³»çµ±è¨­å®šï¼‰
```sql
CREATE TABLE Settings (
  setting_key TEXT PRIMARY KEY,
  setting_value TEXT NOT NULL,
  description TEXT,
  is_dangerous BOOLEAN DEFAULT 0,  -- â­ æ˜¯å¦ç‚ºå±éšªè¨­å®šï¼ˆéœ€è­¦å‘Šï¼‰
  updated_at TEXT DEFAULT (datetime('now')),
  updated_by INTEGER,
  
  FOREIGN KEY (updated_by) REFERENCES Users(user_id)
);

CREATE UNIQUE INDEX idx_settings_key ON Settings(setting_key);

-- é è¨­ç³»çµ±åƒæ•¸
INSERT INTO Settings (setting_key, setting_value, description, is_dangerous) VALUES
('comp_leave_expiry_rule', 'current_month', 'è£œä¼‘æœ‰æ•ˆæœŸè¦å‰‡', 1),  -- âš ï¸ å±éšªè¨­å®š
('daily_work_hours_limit', '12', 'æ¯æ—¥å·¥æ™‚ä¸Šé™', 1),
('hourly_wage_base', '240', 'æœˆè–ªåˆ¶æ›ç®—æ™‚æ•¸', 1),
('company_name', 'éœçˆ¾æœæ–¯æœƒè¨ˆå¸«äº‹å‹™æ‰€', 'å…¬å¸åç¨±', 0),
('contact_email', 'contact@horgoscpa.com', 'è¯çµ¡ä¿¡ç®±', 0);

-- è£œä¼‘æœ‰æ•ˆæœŸè¦å‰‡å¯é¸å€¼èªªæ˜ï¼š
-- 'current_month'  - ç•¶æœˆæœ‰æ•ˆï¼Œæ¬¡æœˆ1æ—¥æ­¸0ï¼ˆé è¨­ï¼‰
-- 'next_month'     - æ¬¡æœˆæœ‰æ•ˆï¼Œæ¬¡æ¬¡æœˆ1æ—¥æ­¸0
-- '3_months'       - 3å€‹æœˆæœ‰æ•ˆ
-- '6_months'       - åŠå¹´æœ‰æ•ˆ
```

### AuditLogsï¼ˆå¯©è¨ˆæ—¥èªŒï¼‰
```sql
CREATE TABLE AuditLogs (
  log_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  action TEXT NOT NULL,                -- CREATE, UPDATE, DELETE, LOGIN
  table_name TEXT NOT NULL,
  record_id TEXT,
  changes TEXT,                        -- JSON æ ¼å¼
  ip_address TEXT,
  user_agent TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id)
);

CREATE INDEX idx_audit_logs_user ON AuditLogs(user_id);
CREATE INDEX idx_audit_logs_table ON AuditLogs(table_name);
CREATE INDEX idx_audit_logs_action ON AuditLogs(action);
CREATE INDEX idx_audit_logs_date ON AuditLogs(created_at);
```

### FieldAuditTrailï¼ˆå­—æ®µç´šå¯©è¨ˆï¼‰
```sql
CREATE TABLE FieldAuditTrail (
  audit_id INTEGER PRIMARY KEY AUTOINCREMENT,
  table_name TEXT NOT NULL,
  record_id TEXT NOT NULL,
  field_name TEXT NOT NULL,
  old_value TEXT,
  new_value TEXT,
  changed_by INTEGER NOT NULL,
  changed_at TEXT DEFAULT (datetime('now')),
  
  FOREIGN KEY (changed_by) REFERENCES Users(user_id)
);

CREATE INDEX idx_field_audit_table_record ON FieldAuditTrail(table_name, record_id);
CREATE INDEX idx_field_audit_field ON FieldAuditTrail(field_name);
CREATE INDEX idx_field_audit_user ON FieldAuditTrail(changed_by);
CREATE INDEX idx_field_audit_date ON FieldAuditTrail(changed_at);
```

### Notificationsï¼ˆç³»çµ±é€šçŸ¥ï¼‰â­ æ–°å¢

**è¨­è¨ˆç†ç”±ï¼š** å„€è¡¨æ¿æé†’åŠŸèƒ½ï¼ˆå·¥æ™‚ç¼ºå¡«ã€ä»»å‹™é€¾æœŸç­‰ï¼‰

**è¨­è¨ˆå“²å­¸ï¼š**
- âœ… å°ˆæ³¨æ–¼ã€Œéœ€è¦è™•ç†çš„äº‹é …ã€ï¼Œä¸æ˜¯ç¤¾äº¤é€šçŸ¥ä¸­å¿ƒ
- âœ… è‡ªå‹•æ¶ˆå¤±æ©Ÿåˆ¶ï¼šå•é¡Œè§£æ±ºå¾Œï¼Œé€šçŸ¥è‡ªå‹•ç§»é™¤
- âœ… ç°¡åŒ–ç‹€æ…‹ï¼šä¸éœ€è¦ã€Œå·²è®€/æœªè®€ã€å€åˆ†ï¼Œåªæœ‰ã€Œé¡¯ç¤º/ç§»é™¤ã€

```sql
CREATE TABLE Notifications (
  notification_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,             -- é€šçŸ¥å°è±¡ï¼ˆå“¡å·¥æˆ–ç®¡ç†å“¡ï¼‰
  type TEXT NOT NULL,                   -- é€šçŸ¥é¡å‹
  message TEXT NOT NULL,                -- é€šçŸ¥è¨Šæ¯
  related_date TEXT,                    -- é—œè¯æ—¥æœŸï¼ˆå¦‚ï¼šç¼ºå¡«çš„æ—¥æœŸï¼‰
  related_user_id INTEGER,              -- é—œè¯ç”¨æˆ¶ï¼ˆç®¡ç†å“¡çœ‹å“¡å·¥ç¼ºå¡«æ™‚ç”¨ï¼‰
  action_url TEXT,                      -- æ“ä½œé€£çµï¼ˆå¦‚ï¼š/timesheets/new?date=2025-11-26ï¼‰
  auto_dismiss BOOLEAN DEFAULT 1,       -- æ˜¯å¦è‡ªå‹•æ¶ˆå¤±ï¼ˆ1=å•é¡Œè§£æ±ºå¾Œè‡ªå‹•ç§»é™¤ï¼Œ0=éœ€æ‰‹å‹•é—œé–‰ï¼‰
  created_at TEXT DEFAULT (datetime('now')),
  is_deleted BOOLEAN DEFAULT 0,         -- æ˜¯å¦å·²ç§»é™¤ï¼ˆ0=é¡¯ç¤ºåœ¨åˆ—è¡¨ï¼Œ1=å·²ç§»é™¤ï¼‰
  dismissed_at TEXT,                    -- ç§»é™¤æ™‚é–“ï¼ˆè‡ªå‹•æˆ–æ‰‹å‹•ï¼‰
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id),
  FOREIGN KEY (related_user_id) REFERENCES Users(user_id),
  CHECK (type IN ('missing_timesheet', 'task_overdue', 'leave_pending', 'payment_overdue', 'cron_failed'))
);

CREATE INDEX idx_notifications_user ON Notifications(user_id);
CREATE INDEX idx_notifications_type ON Notifications(type);
CREATE INDEX idx_notifications_deleted ON Notifications(is_deleted);
CREATE INDEX idx_notifications_date ON Notifications(related_date);
CREATE UNIQUE INDEX idx_notifications_unique ON Notifications(user_id, type, related_date, related_user_id) 
  WHERE is_deleted = 0;  -- åŒä¸€ç”¨æˆ¶åŒé¡å‹åŒæ—¥æœŸåªæœ‰ä¸€ç­†æœªç§»é™¤é€šçŸ¥
```

**ç‹€æ…‹æ©Ÿå®šç¾©ï¼š**

```typescript
/**
 * é€šçŸ¥ç”Ÿå‘½é€±æœŸ
 * 
 * 1. å‰µå»ºé€šçŸ¥ï¼ˆç³»çµ±è‡ªå‹•ï¼‰
 *    is_deleted = 0
 *    auto_dismiss = 1ï¼ˆå·¥æ™‚ç¼ºå¡«ã€è£œä¼‘åˆ°æœŸç­‰ï¼‰
 * 
 * 2. å•é¡Œè§£æ±ºï¼ˆè‡ªå‹•ç§»é™¤ï¼‰
 *    - è§¸ç™¼ï¼šå“¡å·¥å¡«å¯«å·¥æ™‚ã€ä½¿ç”¨è£œä¼‘ç­‰
 *    - å‹•ä½œï¼šis_deleted = 1, dismissed_at = now()
 *    - çµæœï¼šé€šçŸ¥å¾å„€è¡¨æ¿æ¶ˆå¤±
 * 
 * 3. æŸ¥è©¢é¡¯ç¤º
 *    SELECT * FROM Notifications
 *    WHERE user_id = ? AND is_deleted = 0
 *    ORDER BY created_at DESC
 * 
 * âš ï¸ ç°¡åŒ–è¨­è¨ˆèªªæ˜ï¼š
 * - ç§»é™¤ is_read æ¬„ä½ï¼ˆä¸éœ€è¦ã€Œå·²è®€/æœªè®€ã€å€åˆ†ï¼‰
 * - ç§»é™¤ read_at æ¬„ä½ï¼ˆæ”¹ç”¨ dismissed_atï¼‰
 * - é€šçŸ¥è¦éº¼ã€Œéœ€è¦è™•ç†ã€ï¼ˆé¡¯ç¤ºï¼‰ï¼Œè¦éº¼ã€Œå·²è™•ç†ã€ï¼ˆç§»é™¤ï¼‰
 * - æ²’æœ‰ã€ŒæŸ¥çœ‹æ­·å²é€šçŸ¥ã€åŠŸèƒ½ï¼ˆä¿æŒä»‹é¢ç°¡æ½”ï¼‰
 */
```

**é€šçŸ¥é¡å‹èªªæ˜ï¼š**
```
missing_timesheet   - å·¥æ™‚ç¼ºå¡«æé†’ï¼ˆauto_dismiss=1ï¼Œå¡«å¯«å¾Œè‡ªå‹•æ¶ˆå¤±ï¼‰
  å“¡å·¥ï¼šçœ‹åˆ°è‡ªå·±ç¼ºå¡«çš„æ—¥æœŸ
  ç®¡ç†å“¡ï¼šçœ‹åˆ°æ‰€æœ‰å“¡å·¥ç¼ºå¡«çµ±è¨ˆ
  
task_overdue        - ä»»å‹™é€¾æœŸæé†’ï¼ˆauto_dismiss=1ï¼Œä»»å‹™å®Œæˆå¾Œè‡ªå‹•æ¶ˆå¤±ï¼‰

leave_pending       - å‡æœŸå¾…å¯©æ ¸ï¼ˆç›®å‰ç„¡å¯©æ ¸æ©Ÿåˆ¶ï¼Œä¿ç•™æ¬„ä½ï¼‰

payment_overdue     - æ‡‰æ”¶å¸³æ¬¾é€¾æœŸï¼ˆauto_dismiss=1ï¼Œæ”¶æ¬¾å¾Œè‡ªå‹•æ¶ˆå¤±ï¼‰

cron_failed         - å®šæ™‚ä»»å‹™åŸ·è¡Œå¤±æ•—ï¼ˆauto_dismiss=0ï¼Œéœ€ç®¡ç†å“¡æ‰‹å‹•è™•ç†ï¼‰
```

### æ•¸æ“šæ­¸æª”è¡¨ï¼ˆç†±æ•¸æ“šä¿ç•™2å¹´ï¼‰
```sql
-- TimeLogs æ­¸æª”è¡¨ï¼ˆæŒ‰å¹´ä»½ï¼‰
CREATE TABLE TimeLogs_Archive_2023 (
  log_id INTEGER PRIMARY KEY,
  user_id INTEGER NOT NULL,
  work_date TEXT NOT NULL,
  client_id TEXT,
  hours REAL NOT NULL,
  work_type_id INTEGER DEFAULT 1,
  description TEXT,
  created_at TEXT,
  updated_at TEXT,
  is_deleted BOOLEAN DEFAULT 0
);

-- LeaveApplications æ­¸æª”è¡¨ï¼ˆæŒ‰å¹´ä»½ï¼‰
CREATE TABLE LeaveApplications_Archive_2023 (
  leave_id INTEGER PRIMARY KEY,
  user_id INTEGER NOT NULL,
  leave_type_id INTEGER NOT NULL,
  start_date TEXT NOT NULL,
  end_date TEXT NOT NULL,
  total_days REAL NOT NULL,
  reason TEXT,
  status TEXT DEFAULT 'approved',
  created_at TEXT,
  is_deleted BOOLEAN DEFAULT 0
);

-- AuditLogs æ­¸æª”è¡¨ï¼ˆæŒ‰å¹´ä»½ï¼‰
CREATE TABLE AuditLogs_Archive_2023 (
  log_id INTEGER PRIMARY KEY,
  user_id INTEGER NOT NULL,
  action TEXT NOT NULL,
  table_name TEXT NOT NULL,
  record_id TEXT,
  changes TEXT,
  ip_address TEXT,
  user_agent TEXT,
  created_at TEXT
);
```

---

## ğŸ”Œ API ç«¯é»

### èªè­‰
```
POST /api/v1/auth/login              ç™»å…¥
POST /api/v1/auth/logout             ç™»å‡º
GET  /api/v1/auth/me                 é©—è­‰ç•¶å‰æœƒè©±
POST /api/v1/auth/change-password    ä¿®æ”¹å¯†ç¢¼
```

### å€‹äººè³‡æ–™
```
GET  /api/v1/profile                 ç²å–å€‹äººè³‡æ–™
PUT  /api/v1/profile                 æ›´æ–°å€‹äººè³‡æ–™
```

### å“¡å·¥ç®¡ç†ï¼ˆç®¡ç†å“¡ï¼‰
```
GET    /api/v1/admin/users           æŸ¥è©¢å“¡å·¥åˆ—è¡¨
POST   /api/v1/admin/users           æ–°å¢å“¡å·¥
GET    /api/v1/admin/users/:id       æŸ¥è©¢å“¡å·¥è©³æƒ…
PUT    /api/v1/admin/users/:id       æ›´æ–°å“¡å·¥
DELETE /api/v1/admin/users/:id       åˆªé™¤å“¡å·¥
POST   /api/v1/admin/users/:id/reset-password  é‡è¨­å¯†ç¢¼
```

### ç³»çµ±è¨­å®šï¼ˆç®¡ç†å“¡ï¼‰
```
GET  /api/v1/admin/settings          ç²å–æ‰€æœ‰è¨­å®š
PUT  /api/v1/admin/settings/:key     æ›´æ–°è¨­å®šå€¼
```

**ç²å–è¨­å®šç¯„ä¾‹ï¼š**
```json
// GET /api/v1/admin/settings

{
  "success": true,
  "data": [
    {
      "setting_key": "comp_leave_expiry_rule",
      "setting_value": "current_month",
      "description": "è£œä¼‘æœ‰æ•ˆæœŸè¦å‰‡",
      "is_dangerous": true,
      "updated_at": "2025-01-01 00:00:00"
    },
    {
      "setting_key": "daily_work_hours_limit",
      "setting_value": "12",
      "description": "æ¯æ—¥å·¥æ™‚ä¸Šé™",
      "is_dangerous": true
    },
    {
      "setting_key": "company_name",
      "setting_value": "å®åœ‹æœƒè¨ˆå¸«äº‹å‹™æ‰€",
      "description": "å…¬å¸åç¨±",
      "is_dangerous": false
    }
  ]
}
```

**æ›´æ–°è¨­å®šç¯„ä¾‹ï¼ˆå±éšªè¨­å®šï¼‰ï¼š**
```json
// PUT /api/v1/admin/settings/comp_leave_expiry_rule
{
  "setting_value": "next_month",
  "confirmed": true  // â­ å±éšªè¨­å®šéœ€ç¢ºèª
}

// å›æ‡‰
{
  "success": true,
  "data": {
    "setting_key": "comp_leave_expiry_rule",
    "setting_value": "next_month",
    "old_value": "current_month",
    "warning": "âš ï¸ è£œä¼‘æœ‰æ•ˆæœŸå»¶é•·å¯èƒ½å¢åŠ äººåŠ›æˆæœ¬"
  }
}
```

### å¯©è¨ˆæ—¥èªŒï¼ˆç®¡ç†å“¡ï¼‰
```
GET  /api/v1/admin/audit-logs        æŸ¥è©¢æ“ä½œæ—¥èªŒ
GET  /api/v1/admin/audit-logs/user/:userId  æŸ¥è©¢ç‰¹å®šå“¡å·¥çš„æ—¥èªŒ
```

---

## ğŸ¨ å‰ç«¯çµ„ä»¶

### SystemSettingsPage.vueï¼ˆç³»çµ±åƒæ•¸è¨­å®šï¼‰â­ æ–°å¢

```vue
<template>
  <div class="system-settings-page">
    <h2>ç³»çµ±åƒæ•¸</h2>
    
    <!-- å±éšªè¨­å®šå€åŸŸï¼ˆè­¦å‘Šè‰²ï¼‰-->
    <div class="settings-section danger-section">
      <h3>âš ï¸ å±éšªè¨­å®šï¼ˆä¿®æ”¹å‰è«‹ä¸‰æ€ï¼‰</h3>
      <p class="warning-text">
        ä»¥ä¸‹è¨­å®šæœƒå½±éŸ¿ç³»çµ±æ ¸å¿ƒé‹ä½œï¼Œä¿®æ”¹å¾Œå¯èƒ½å¢åŠ æˆæœ¬æˆ–é€ æˆæ³•å¾‹é¢¨éšªã€‚
      </p>
      
      <!-- è£œä¼‘æœ‰æ•ˆæœŸ -->
      <div class="setting-item">
        <label class="setting-label">
          <strong>è£œä¼‘æœ‰æ•ˆæœŸè¦å‰‡</strong>
          <span class="current-value">ç•¶å‰ï¼š{{ getExpiryRuleText(settings.comp_leave_expiry_rule) }}</span>
        </label>
        
        <select v-model="tempSettings.comp_leave_expiry_rule">
          <option value="current_month">ç•¶æœˆæœ‰æ•ˆï¼ˆæ¨è–¦ï¼‰</option>
          <option value="next_month">æ¬¡æœˆæœ‰æ•ˆ</option>
          <option value="3_months">3å€‹æœˆæœ‰æ•ˆ</option>
          <option value="6_months">åŠå¹´æœ‰æ•ˆ</option>
        </select>
        
        <div v-if="tempSettings.comp_leave_expiry_rule !== 'current_month'" class="warning-box">
          <p>âš ï¸ <strong>é¢¨éšªè­¦å‘Šï¼š</strong></p>
          <ul>
            <li>å»¶é•·è£œä¼‘æœ‰æ•ˆæœŸæœƒè®“å“¡å·¥è£œä¼‘ç´¯ç©éå¤š</li>
            <li>åˆ°æœŸæ™‚è½‰æ›ç‚ºåŠ ç­è²»ï¼Œå¢åŠ äººåŠ›æˆæœ¬</li>
            <li>ç¯„ä¾‹ï¼šæ”¹ç‚ºã€Œæ¬¡æœˆæœ‰æ•ˆã€ï¼Œæˆæœ¬å¯èƒ½å¢åŠ 15-30%</li>
          </ul>
          <label>
            <input type="checkbox" v-model="confirmDangerous" />
            æˆ‘äº†è§£é¢¨éšªï¼Œç¢ºå®šè¦ä¿®æ”¹
          </label>
        </div>
        
        <StyledButton 
          @click="updateSetting('comp_leave_expiry_rule')"
          :disabled="tempSettings.comp_leave_expiry_rule !== 'current_month' && !confirmDangerous"
          variant="warning"
        >
          å„²å­˜ä¿®æ”¹
        </StyledButton>
      </div>
      
      <hr />
      
      <!-- æ¯æ—¥å·¥æ™‚ä¸Šé™ -->
      <div class="setting-item">
        <label class="setting-label">
          <strong>æ¯æ—¥å·¥æ™‚ä¸Šé™</strong>
          <span class="current-value">ç•¶å‰ï¼š{{ settings.daily_work_hours_limit }} å°æ™‚</span>
        </label>
        
        <input 
          type="number" 
          v-model.number="tempSettings.daily_work_hours_limit" 
          min="8"
          max="12"
          disabled
        />
        
        <p class="readonly-hint">âš ï¸ æ­¤åƒæ•¸å—å‹åŸºæ³•é™åˆ¶ï¼Œä¸å¯ä¿®æ”¹ï¼ˆå›ºå®š12å°æ™‚ï¼‰</p>
      </div>
      
      <hr />
      
      <!-- æœˆè–ªåˆ¶æ›ç®—æ™‚æ•¸ -->
      <div class="setting-item">
        <label class="setting-label">
          <strong>æœˆè–ªåˆ¶æ›ç®—æ™‚æ•¸</strong>
          <span class="current-value">ç•¶å‰ï¼š{{ settings.hourly_wage_base }} å°æ™‚</span>
        </label>
        
        <input 
          type="number" 
          v-model.number="tempSettings.hourly_wage_base" 
          disabled
        />
        
        <p class="readonly-hint">âš ï¸ æ­¤åƒæ•¸å—å‹åŸºæ³•é™åˆ¶ï¼Œä¸å¯ä¿®æ”¹ï¼ˆå›ºå®š240å°æ™‚ï¼‰</p>
      </div>
    </div>
    
    <!-- ä¸€èˆ¬è¨­å®šå€åŸŸ -->
    <div class="settings-section normal-section">
      <h3>ä¸€èˆ¬è¨­å®š</h3>
      
      <div class="setting-item">
        <label class="setting-label">å…¬å¸åç¨±</label>
        <input v-model="tempSettings.company_name" />
        <StyledButton @click="updateSetting('company_name')">å„²å­˜</StyledButton>
      </div>
      
      <div class="setting-item">
        <label class="setting-label">è¯çµ¡ä¿¡ç®±</label>
        <input v-model="tempSettings.contact_email" type="email" />
        <StyledButton @click="updateSetting('contact_email')">å„²å­˜</StyledButton>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { getSettings, updateSetting as apiUpdateSetting } from '@/api/settings';

const settings = ref({});
const tempSettings = ref({});
const confirmDangerous = ref(false);

onMounted(async () => {
  const response = await getSettings();
  settings.value = response.data.reduce((obj, item) => {
    obj[item.setting_key] = item.setting_value;
    return obj;
  }, {});
  tempSettings.value = { ...settings.value };
});

function getExpiryRuleText(value) {
  const map = {
    'current_month': 'ç•¶æœˆæœ‰æ•ˆï¼ˆæ¬¡æœˆ1æ—¥æ­¸0ï¼‰',
    'next_month': 'æ¬¡æœˆæœ‰æ•ˆ',
    '3_months': '3å€‹æœˆæœ‰æ•ˆ',
    '6_months': 'åŠå¹´æœ‰æ•ˆ'
  };
  return map[value] || value;
}

async function updateSetting(key) {
  const isDangerous = ['comp_leave_expiry_rule', 'daily_work_hours_limit', 'hourly_wage_base'].includes(key);
  
  if (isDangerous && !confirmDangerous.value) {
    alert('è«‹å…ˆå‹¾é¸ã€Œæˆ‘äº†è§£é¢¨éšªã€');
    return;
  }
  
  try {
    await apiUpdateSetting(key, {
      setting_value: tempSettings.value[key],
      confirmed: confirmDangerous.value
    });
    
    alert('è¨­å®šå·²æ›´æ–°');
    settings.value[key] = tempSettings.value[key];
    confirmDangerous.value = false;  // é‡ç½®ç¢ºèª
  } catch (error) {
    alert('æ›´æ–°å¤±æ•—ï¼š' + error.message);
  }
}
</script>

<style scoped>
.danger-section {
  border: 2px solid #ef4444;
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  background: #fef2f2;
}

.warning-box {
  background: #fef3c7;
  border-left: 4px solid #f59e0b;
  padding: 1rem;
  margin: 1rem 0;
}

.warning-box ul {
  margin: 0.5rem 0;
  padding-left: 1.5rem;
}

.readonly-hint {
  color: #6b7280;
  font-size: 0.875rem;
  font-style: italic;
}

.current-value {
  color: #059669;
  font-weight: 600;
  margin-left: 1rem;
}
</style>
```

---

## ğŸ”§ å¾Œç«¯å¯¦ç¾

### AuthService
```typescript
class AuthService {
  async login(username, password) {
    // 1. æŸ¥è©¢ç”¨æˆ¶
    const user = await this.userRepo.findByUsername(username);
    if (!user) {
      throw new UnauthorizedError('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
    }
    
    // 2. æª¢æŸ¥é–å®š
    if (user.login_attempts >= 5) {
      const lockUntil = addMinutes(user.last_failed_login, 15);
      if (new Date() < lockUntil) {
        throw new ForbiddenError('å¸³è™Ÿå·²é–å®šï¼Œè«‹15åˆ†é˜å¾Œå†è©¦');
      }
      // é‡ç½®è¨ˆæ•¸å™¨
      user.login_attempts = 0;
    }
    
    // 3. é©—è­‰å¯†ç¢¼
    const isValid = await verifyPassword(password, user.password_hash);
    if (!isValid) {
      // å¢åŠ å¤±æ•—æ¬¡æ•¸
      await this.userRepo.incrementLoginAttempts(user.user_id);
      throw new UnauthorizedError('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
    }
    
    // 4. é‡ç½®å¤±æ•—è¨ˆæ•¸ï¼Œæ›´æ–°ç™»å…¥æ™‚é–“
    await this.userRepo.update(user.user_id, {
      login_attempts: 0,
      last_login: new Date()
    });
    
    // 5. ç”Ÿæˆ JWT Token
    const token = await createJWT({
      user_id: user.user_id,
      username: user.username,
      is_admin: user.is_admin
    }, JWT_SECRET);
    
    return { user, token };
  }
  
  async changePassword(userId, currentPassword, newPassword) {
    // 1. ç²å–ç”¨æˆ¶
    const user = await this.userRepo.findById(userId);
    
    // 2. é©—è­‰åŸå¯†ç¢¼
    const isValid = await verifyPassword(currentPassword, user.password_hash);
    if (!isValid) {
      throw new UnauthorizedError('åŸå¯†ç¢¼éŒ¯èª¤');
    }
    
    // 3. é©—è­‰æ–°å¯†ç¢¼é•·åº¦ï¼ˆæ¥­å‹™éœ€æ±‚ï¼šç„¡è¤‡é›œåº¦è¦æ±‚ï¼‰
    if (newPassword.length < 6) {
      throw new ValidationError('å¯†ç¢¼è‡³å°‘6å€‹å­—å…ƒ');
    }
    
    // 4. é›œæ¹Šä¸¦æ›´æ–°
    const hashedPassword = await hashPassword(newPassword);
    await this.userRepo.update(userId, {
      password_hash: hashedPassword
    });
    
    return { success: true };
  }
}
```

### UserManagementService
```typescript
class UserManagementService {
  async createUser(data, adminUserId) {
    // 1. é©—è­‰å¿…å¡«æ¬„ä½
    if (!data.username || !data.name || !data.email || !data.gender || !data.start_date) {
      throw new ValidationError('ä½¿ç”¨è€…åç¨±ã€å§“åã€Emailã€æ€§åˆ¥ã€åˆ°è·æ—¥ç‚ºå¿…å¡«');
    }
    
    // 2. é©—è­‰æ€§åˆ¥å€¼
    if (!['M', 'F', 'ç”·', 'å¥³'].includes(data.gender)) {
      throw new ValidationError('æ€§åˆ¥å¿…é ˆç‚ºï¼šMï¼ˆç”·ï¼‰æˆ– Fï¼ˆå¥³ï¼‰');
    }
    
    // 2. æª¢æŸ¥å”¯ä¸€æ€§
    const existing = await this.repository.findByUsername(data.username);
    if (existing) {
      throw new ConflictError('ä½¿ç”¨è€…åç¨±å·²å­˜åœ¨');
    }
    
    // 3. ç”Ÿæˆåˆå§‹å¯†ç¢¼
    const initialPassword = generateRandomPassword();
    const hashedPassword = await hashPassword(initialPassword);
    
    // 4. å‰µå»ºç”¨æˆ¶
    const user = await this.repository.create({
      ...data,
      password_hash: hashedPassword,
      is_admin: data.is_admin || false
    });
    
    // 5. è¨˜éŒ„å¯©è¨ˆæ—¥èªŒ
    await this.auditLog.log({
      user_id: adminUserId,
      action: 'CREATE',
      table_name: 'Users',
      record_id: user.user_id
    });
    
    return { user, initialPassword };
  }
  
  async resetPassword(userId, adminUserId) {
    // 1. ç”Ÿæˆæ–°å¯†ç¢¼
    const newPassword = generateRandomPassword();
    const hashedPassword = await hashPassword(newPassword);
    
    // 2. æ›´æ–°
    await this.repository.update(userId, {
      password_hash: hashedPassword,
      login_attempts: 0
    });
    
    // 3. è¨˜éŒ„æ—¥èªŒ
    await this.auditLog.log({
      user_id: adminUserId,
      action: 'RESET_PASSWORD',
      table_name: 'Users',
      record_id: userId
    });
    
    return { newPassword };
  }
}
```

### AuditLogService
```typescript
class AuditLogService {
  async log(data) {
    await this.repository.create({
      user_id: data.user_id,
      action: data.action,
      table_name: data.table_name,
      record_id: data.record_id,
      changes: JSON.stringify(data.changes || {}),
      ip_address: data.ip_address,
      user_agent: data.user_agent
    });
  }
  
  async getRecordHistory(tableName, recordId) {
    return await this.repository.findByRecord(tableName, recordId);
  }
  
  async getUserLogs(userId, startDate, endDate) {
    return await this.repository.findByUser(userId, startDate, endDate);
  }
}
```

---

## ğŸ”’ å®‰å…¨æ©Ÿåˆ¶

### å¯†ç¢¼é›œæ¹Šï¼ˆä½¿ç”¨ bcryptï¼‰
```typescript
import bcrypt from 'bcryptjs';

// é›œæ¹Šå¯†ç¢¼
// ä½¿ç”¨ bcryptï¼Œæˆæœ¬å› å­ 12ï¼ˆå¹³è¡¡å®‰å…¨æ€§èˆ‡æ•ˆèƒ½ï¼‰
async function hashPassword(password: string): Promise<string> {
  const saltRounds = 12;
  return await bcrypt.hash(password, saltRounds);
}

// é©—è­‰å¯†ç¢¼
async function verifyPassword(password: string, hash: string): Promise<boolean> {
  return await bcrypt.compare(password, hash);
}

// å¯†ç¢¼å¼·åº¦é©—è­‰ï¼ˆâš ï¸ ä¾æ¥­å‹™éœ€æ±‚ï¼šç„¡å¯†ç¢¼è¦å‰‡ï¼‰
function isStrongPassword(password: string): boolean {
  // æ¥­å‹™éœ€æ±‚ç¢ºèªï¼šç„¡å¯†ç¢¼å¼·åº¦è¦æ±‚
  // åªæª¢æŸ¥æœ€å°é•·åº¦
  if (password.length < 6) return false;
  
  return true;
  
  // âŒ ç§»é™¤è¤‡é›œåº¦è¦æ±‚ï¼ˆæ¥­å‹™å ±å‘Šæ˜ç¢ºèªªæ˜ã€Œç„¡å¯†ç¢¼è¦å‰‡ã€ï¼‰
  // if (!/[A-Z]/.test(password)) return false;
  // if (!/[a-z]/.test(password)) return false;
  // if (!/[0-9]/.test(password)) return false;
}

// ç”Ÿæˆéš¨æ©Ÿå¯†ç¢¼ï¼ˆç”¨æ–¼åˆå§‹å¯†ç¢¼å’Œé‡è¨­å¯†ç¢¼ï¼‰
function generateRandomPassword(): string {
  const uppercaseChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const lowercaseChars = 'abcdefghijklmnopqrstuvwxyz';
  const numberChars = '0123456789';
  const specialChars = '!@#$%^&*';
  
  let password = '';
  password += uppercaseChars[Math.floor(Math.random() * uppercaseChars.length)];
  password += lowercaseChars[Math.floor(Math.random() * lowercaseChars.length)];
  password += numberChars[Math.floor(Math.random() * numberChars.length)];
  password += specialChars[Math.floor(Math.random() * specialChars.length)];
  
  // å¡«å……è‡³ 12 å€‹å­—å…ƒ
  const allChars = uppercaseChars + lowercaseChars + numberChars + specialChars;
  for (let i = 4; i < 12; i++) {
    password += allChars[Math.floor(Math.random() * allChars.length)];
  }
  
  // æ‰“äº‚é †åº
  return password.split('').sort(() => Math.random() - 0.5).join('');
}
```

**ç‚ºä»€éº¼é¸æ“‡ bcryptï¼š**
- âœ… å°ˆç‚ºå¯†ç¢¼è¨­è¨ˆçš„é›œæ¹Šç®—æ³•
- âœ… è‡ªå‹•åŠ é¹½ï¼ˆsaltï¼‰
- âœ… è¨ˆç®—æˆæœ¬å¯èª¿æ•´ï¼ˆæˆæœ¬å› å­ 12ï¼‰
- âœ… æŠ—å½©è™¹è¡¨æ”»æ“Š
- âœ… æˆç†Ÿç©©å®šï¼Œå»£æ³›ä½¿ç”¨

**é¿å…ä½¿ç”¨ï¼š**
- âŒ SHA-256/SHA-512ï¼ˆå¤ªå¿«ï¼Œæ˜“è¢«æš´åŠ›ç ´è§£ï¼‰
- âŒ MD5ï¼ˆå·²è¢«æ”»ç ´ï¼Œä¸å®‰å…¨ï¼‰

### ç™»å…¥å¤±æ•—é–å®š
```
é€£çºŒå¤±æ•— 5 æ¬¡ â†’ é–å®š 15 åˆ†é˜
ç™»å…¥æˆåŠŸ â†’ é‡ç½®è¨ˆæ•¸å™¨
```

### å¯†ç¢¼å¼·åº¦è¦æ±‚

âš ï¸ **æ¥­å‹™éœ€æ±‚ç¢ºèªï¼š** ç„¡å¯†ç¢¼å¼·åº¦è¦å‰‡ï¼ˆå°å‹äº‹å‹™æ‰€ï¼Œç°¡åŒ–ç®¡ç†ï¼‰

```
æœ€å°é•·åº¦ï¼š6 å€‹å­—å…ƒ
ç„¡è¤‡é›œåº¦è¦æ±‚ï¼ˆä¸å¼·åˆ¶å¤§å°å¯«ã€æ•¸å­—ç­‰ï¼‰
```

### JWT Token
```typescript
{
  user_id: 1,
  username: 'admin',
  is_admin: true,
  iat: 1234567890,
  exp: 1234654290
}

// å„²å­˜åœ¨ HttpOnly Cookie
// æœ‰æ•ˆæœŸï¼š24å°æ™‚
```

---

## âœ… ç³»çµ±è¨­å®š Key-Value

| Key | èªªæ˜ | é è¨­å€¼ |
|-----|------|--------|
| `system_name` | ç³»çµ±åç¨± | "XX æœƒè¨ˆå¸«äº‹å‹™æ‰€" |
| `default_working_hours` | é è¨­å·¥æ™‚/æ—¥ | "8" |
| `fiscal_year_start` | æœƒè¨ˆå¹´åº¦é–‹å§‹æœˆ | "1" |
| `comp_leave_expiry_months` | è£œä¼‘æœŸé™ï¼ˆæœˆï¼‰| "12" |

---

## ğŸ“¦ æ•¸æ“šæ­¸æª”ç­–ç•¥

### æ­¸æª”æ™‚æ©Ÿ
```
æ¯å¹´ 1 æœˆ 1 æ—¥ 03:00 åŸ·è¡Œæ­¸æª”ä½œæ¥­
æ­¸æª”å‰ 2 å¹´çš„æ•¸æ“šï¼ˆä¿ç•™ç†±æ•¸æ“š 2 å¹´ï¼‰
```

### æ­¸æª”æµç¨‹
```typescript
// 1. å‰µå»ºæ­¸æª”è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
const archiveYear = new Date().getFullYear() - 2;
await db.exec(`
  CREATE TABLE IF NOT EXISTS TimeLogs_Archive_${archiveYear} 
  AS SELECT * FROM TimeLogs WHERE 1=0;
`);

// 2. é·ç§»æ•¸æ“š
await db.exec(`
  INSERT INTO TimeLogs_Archive_${archiveYear}
  SELECT * FROM TimeLogs 
  WHERE created_at < datetime('now', '-2 years');
`);

// 3. åˆªé™¤å·²æ­¸æª”æ•¸æ“š
await db.exec(`
  DELETE FROM TimeLogs 
  WHERE created_at < datetime('now', '-2 years');
`);

// 4. è¨˜éŒ„æ­¸æª”æ—¥èªŒ
await auditLog.log({
  action: 'ARCHIVE',
  table_name: 'TimeLogs',
  details: `Archived ${count} records to ${archiveYear}`
});
```

### æ­¸æª”æ•¸æ“šæŸ¥è©¢
```typescript
// æŸ¥è©¢æ­·å²æ•¸æ“šï¼ˆåŒ…å«æ­¸æª”ï¼‰
async function getTimeLogsWithArchive(userId, startDate, endDate) {
  const year = new Date(startDate).getFullYear();
  const currentYear = new Date().getFullYear();
  
  // åˆ¤æ–·æ˜¯å¦éœ€è¦æŸ¥è©¢æ­¸æª”è¡¨
  if (year < currentYear - 2) {
    return await db.query(`
      SELECT * FROM TimeLogs_Archive_${year}
      WHERE user_id = ? AND work_date BETWEEN ? AND ?
    `, [userId, startDate, endDate]);
  } else {
    return await db.query(`
      SELECT * FROM TimeLogs
      WHERE user_id = ? AND work_date BETWEEN ? AND ?
    `, [userId, startDate, endDate]);
  }
}
```

### æ­¸æª”å‚™ä»½
```
1. æ¯æœˆå°‡æ­¸æª”è¡¨å‚™ä»½åˆ° Cloudflare R2
2. ä¿ç•™ 7 å¹´ï¼ˆæ³•è¦è¦æ±‚ï¼‰
3. å£“ç¸®å­˜å„²ï¼ˆç¯€çœç©ºé–“ï¼‰
```

---

## â±ï¸ æ™‚é–“æˆ³å­˜å„²èªªæ˜

### ç•¶å‰æ–¹æ¡ˆï¼šTEXT æ ¼å¼
```sql
created_at TEXT DEFAULT (datetime('now'))
-- æ ¼å¼ï¼š'2024-10-28 15:30:45'
```

**å„ªå‹¢ï¼š**
- âœ… äººé¡å¯è®€ï¼Œèª¿è©¦æ–¹ä¾¿
- âœ… SQLite datetime å‡½æ•¸ç›´æ¥æ”¯æŒ
- âœ… ä¸éœ€è¦æ‡‰ç”¨å±¤è½‰æ›

**åŠ£å‹¢ï¼š**
- âš ï¸ å ç”¨ç©ºé–“è¼ƒå¤§ï¼ˆ19 å­—ç¯€ï¼‰
- âš ï¸ ç¯„åœæŸ¥è©¢æ€§èƒ½è¼ƒ INTEGER ç¨æ…¢

### æ›¿ä»£æ–¹æ¡ˆï¼šINTEGERï¼ˆUNIXæ™‚é–“æˆ³ï¼‰
```sql
created_at INTEGER DEFAULT (strftime('%s', 'now'))
-- æ ¼å¼ï¼š1698516645
```

**å„ªå‹¢ï¼š**
- âœ… å ç”¨ç©ºé–“å°ï¼ˆ4-8 å­—ç¯€ï¼‰
- âœ… ç¯„åœæŸ¥è©¢æ€§èƒ½æ›´å¥½
- âœ… æ™‚å€è™•ç†ç°¡å–®

**åŠ£å‹¢ï¼š**
- âš ï¸ æ•¸æ“šåº«å…§æŸ¥çœ‹ä¸ç›´è§€
- âš ï¸ éœ€è¦æ‡‰ç”¨å±¤è½‰æ›

### æ±ºç­–ï¼šä¿æŒ TEXT æ ¼å¼
```
ç†ç”±ï¼š
1. å…§éƒ¨ç³»çµ±ï¼Œæ•¸æ“šé‡ä¸å¤§ï¼ˆ<100è¬æ¢ï¼‰
2. èª¿è©¦å’Œç¶­è­·ä¾¿åˆ©æ€§æ›´é‡è¦
3. SQLite datetime å‡½æ•¸ç”Ÿæ…‹å®Œå–„
4. æ€§èƒ½å·®ç•°åœ¨å¯æ¥å—ç¯„åœå…§
```

**å¦‚æœæœªä¾†æ•¸æ“šé‡æ¿€å¢ï¼š**
- å†è©•ä¼°é·ç§»åˆ° INTEGER
- æˆ–ä½¿ç”¨æ•¸æ“šåº«ç´šå„ªåŒ–ï¼ˆåˆ†å€ã€ç´¢å¼•å„ªåŒ–ï¼‰

---

**é€™å€‹æ–‡æª”åŒ…å«ç³»çµ±åŸºç¤åŠŸèƒ½çš„æ‰€æœ‰æŠ€è¡“ç´°ç¯€ã€‚**

