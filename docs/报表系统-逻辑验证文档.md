# æŠ¥è¡¨ç³»ç»Ÿé€»è¾‘éªŒè¯æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [æ•°æ®æµæ¶æ„](#æ•°æ®æµæ¶æ„)
2. [æœˆåº¦æ”¶æ¬¾æŠ¥è¡¨](#æœˆåº¦æ”¶æ¬¾æŠ¥è¡¨)
3. [æœˆåº¦è–ªèµ„æŠ¥è¡¨](#æœˆåº¦è–ªèµ„æŠ¥è¡¨)
4. [æœˆåº¦å‘˜å·¥äº§å€¼æŠ¥è¡¨](#æœˆåº¦å‘˜å·¥äº§å€¼æŠ¥è¡¨)
5. [æœˆåº¦å®¢æˆ·æ¯›åˆ©æŠ¥è¡¨](#æœˆåº¦å®¢æˆ·æ¯›åˆ©æŠ¥è¡¨)
6. [å¹´åº¦æŠ¥è¡¨é€»è¾‘](#å¹´åº¦æŠ¥è¡¨é€»è¾‘)
7. [å…³é”®é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å…³é”®é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)

---

## æ•°æ®æµæ¶æ„

### æ ¸å¿ƒæ•°æ®è¡¨å…³ç³»
```
Clients (å®¢æˆ·)
    â†“
ClientServices (å®¢æˆ·æœåŠ¡)
    â†“
Receipts (æ”¶æ®) â† æ”¶å…¥æ•°æ®æ¥æº
    â†“
ServiceBillingSchedule (è®¡è´¹æ’ç¨‹)
    â†“
Tasks (ä»»åŠ¡)
    â†“
Timesheets (å·¥æ—¶è¡¨) â† å·¥æ—¶æ•°æ®æ¥æº
    â†“
Users (ç”¨æˆ·) â† è–ªèµ„æ•°æ®æ¥æº
```

### æ•°æ®ä¸€è‡´æ€§è¦æ±‚
1. **æ”¶æ® â†” å®¢æˆ·æœåŠ¡**ï¼š`Receipts.client_service_id` â†’ `ClientServices.client_service_id`
2. **ä»»åŠ¡ â†” å®¢æˆ·æœåŠ¡**ï¼š`Tasks.client_service_id` â†’ `ClientServices.client_service_id`
3. **å·¥æ—¶ â†” ä»»åŠ¡**ï¼š`Timesheets.task_id` â†’ `Tasks.task_id`
4. **å·¥æ—¶ â†” å®¢æˆ·**ï¼š`Timesheets.client_id` â†’ `Clients.client_id`

---

## æœˆåº¦æ”¶æ¬¾æŠ¥è¡¨

### æ•°æ®æ¥æº
- **è¡¨**ï¼š`Receipts`, `Clients`, `ClientServices`, `Services`
- **æ—¶é—´å­—æ®µ**ï¼š`receipt_date` (æ”¶æ®å¼€ç«‹æ—¥æœŸ)

### é€»è¾‘éªŒè¯

#### âœ… æ­£ç¡®çš„é€»è¾‘
```sql
-- åº”æ”¶é‡‘é¢
SUM(total_amount) WHERE receipt_date IN month AND status != 'cancelled'

-- å®æ”¶é‡‘é¢
SUM(paid_amount) WHERE receipt_date IN month AND status != 'cancelled'

-- æ”¶æ¬¾ç‡
(å®æ”¶é‡‘é¢ / åº”æ”¶é‡‘é¢) Ã— 100%

-- é€¾æœŸåˆ¤æ–­
due_date < CURRENT_DATE AND status IN ('unpaid', 'partial')
```

#### âš ï¸ æ½œåœ¨é—®é¢˜
1. **é—®é¢˜**ï¼šæ”¶æ®çš„`receipt_date`æ˜¯å¼€ç«‹æ—¥æœŸï¼Œä¸æ˜¯æœåŠ¡æœˆä»½
   - **å½±å“**ï¼šå¦‚æœ12æœˆçš„æœåŠ¡åœ¨1æœˆæ‰å¼€æ”¶æ®ï¼Œä¼šè®¡å…¥1æœˆçš„åº”æ”¶
   - **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨`billing_month`å­—æ®µï¼ˆæœåŠ¡æœˆä»½ï¼‰è€Œé`receipt_date`

2. **é—®é¢˜**ï¼šå®æ”¶é‡‘é¢å¯èƒ½è·¨æœˆ
   - **å½±å“**ï¼š11æœˆå¼€çš„æ”¶æ®ï¼Œ12æœˆæ‰æ”¶æ¬¾ï¼Œåº”è¯¥ç®—å“ªä¸ªæœˆçš„å®æ”¶ï¼Ÿ
   - **å½“å‰é€»è¾‘**ï¼šæŒ‰æ”¶æ®å¼€ç«‹æœˆä»½ç»Ÿè®¡ï¼ˆæƒè´£å‘ç”Ÿåˆ¶ï¼‰
   - **ç”¨æˆ·éœ€æ±‚ç¡®è®¤**ï¼šæ˜¯å¦éœ€è¦æ”¹ä¸ºæŒ‰å®é™…æ”¶æ¬¾æ—¥æœŸç»Ÿè®¡ï¼ˆç°é‡‘æ”¶ä»˜åˆ¶ï¼‰ï¼Ÿ

#### ğŸ”§ å»ºè®®ä¿®æ”¹
```sql
-- æ”¹ç”¨ billing_month è€Œé receipt_date
WHERE r.billing_month = '2024-11'
  AND r.is_deleted = 0 
  AND r.status != 'cancelled'
```

---

## æœˆåº¦è–ªèµ„æŠ¥è¡¨

### æ•°æ®æ¥æº
- **å‡½æ•°**ï¼š`calculateEmployeePayroll(env, user_id, year, month)`
- **è¡¨**ï¼š`Users`, `SalaryItems`, `Timesheets`, `Leaves`, `MonthlyBonus`, `YearEndBonus`

### é€»è¾‘éªŒè¯

#### âœ… æ­£ç¡®çš„é€»è¾‘ï¼ˆå·²åœ¨payroll.jséªŒè¯ï¼‰
```javascript
// åº”å‘å·¥èµ„ = åº•è–ª + å›ºå®šæ´¥è´´ + éå›ºå®šæ´¥è´´ + å›ºå®šå¥–é‡‘ + éå›ºå®šå¥–é‡‘ 
//          + å…¨å‹¤å¥–é‡‘ + åŠ ç­è´¹ + ä¼™é£Ÿæ´¥è´´ + äº¤é€šè¡¥è´´ + ç»©æ•ˆå¥–é‡‘ + å¹´ç»ˆå¥–é‡‘
grossSalary = baseSalary + allowances + bonuses + overtime + ...

// å®å‘å·¥èµ„ = åº”å‘ - å›ºå®šæ‰£æ¬¾ - è¯·å‡æ‰£æ¬¾
netSalary = grossSalary - fixedDeductions - leaveDeductions
```

#### âœ… ä¾èµ–çš„è®¡ç®—é€»è¾‘
- **åŠ ç­è´¹**ï¼šä»`Timesheets`è®¡ç®—ï¼Œä½¿ç”¨`overtimeMultipliers`
- **è¡¥ä¼‘è½¬åŠ ç­è´¹**ï¼šæœªä½¿ç”¨çš„è¡¥ä¼‘è½¬ä¸ºåŠ ç­è´¹
- **è¯·å‡æ‰£æ¬¾**ï¼šç—…å‡/äº‹å‡æŒ‰æ—¶è–ªæ‰£æ¬¾
- **å…¨å‹¤å¥–é‡‘**ï¼šæ— ç—…å‡/äº‹å‡æ‰å‘æ”¾

#### âš ï¸ æ½œåœ¨é—®é¢˜
**é—®é¢˜**ï¼šç»©æ•ˆå¥–é‡‘å’Œå¹´ç»ˆå¥–é‡‘è·å–é€»è¾‘
- å½“å‰ä»£ç è®¾ç½®ä¸º0ï¼Œéœ€è¦ä»`MonthlyBonus`å’Œ`YearEndBonus`è¡¨è·å–

#### ğŸ”§ éœ€è¦è¡¥å……çš„ä»£ç 
```javascript
// åœ¨ handleMonthlyPayroll ä¸­æ·»åŠ 
const performanceBonus = await env.DATABASE.prepare(`
  SELECT amount_cents 
  FROM MonthlyBonus 
  WHERE user_id = ? AND year = ? AND month = ?
`).bind(user.user_id, year, month).first();

const yearEndBonus = await env.DATABASE.prepare(`
  SELECT amount_cents 
  FROM YearEndBonus 
  WHERE user_id = ? AND year = ?
`).bind(user.user_id, year).first();
```

---

## æœˆåº¦å‘˜å·¥äº§å€¼æŠ¥è¡¨

### æ•°æ®æ¥æº
- **è¡¨**ï¼š`Timesheets`, `Tasks`, `Receipts`, `Clients`, `Services`
- **å…³è”é€»è¾‘**ï¼šå·¥æ—¶ â†’ ä»»åŠ¡ â†’ æ”¶æ®

### é€»è¾‘éªŒè¯

#### âŒ å½“å‰ä»£ç çš„é—®é¢˜

**é—®é¢˜1ï¼šæ”¶å…¥åˆ†é…é€»è¾‘ä¸å®Œæ•´**
```javascript
// å½“å‰ä»£ç 
LEFT JOIN Receipts r ON r.client_service_id = task.client_service_id 
  AND substr(r.receipt_date, 1, 7) = substr(t.work_date, 1, 7)
```
**é—®é¢˜**ï¼š
- æ”¶æ®çš„`receipt_date`æ˜¯å¼€ç«‹æ—¥æœŸï¼Œä¸æ˜¯æœåŠ¡æœˆä»½
- åº”è¯¥ç”¨`billing_month`è€Œé`receipt_date`
- ä¸€ä¸ªæœåŠ¡å¯èƒ½æœ‰å¤šå¼ æ”¶æ®ï¼ˆåˆ†æœŸæ”¶æ¬¾ï¼‰

**é—®é¢˜2ï¼šè·¨æœˆä»»åŠ¡å¤„ç†ä¸æ­£ç¡®**
```javascript
// å½“å‰ä»£ç æ²¡æœ‰å®ç°è·¨æœˆä»»åŠ¡çš„æ”¶å…¥æŒ‰å·¥æ—¶æ¯”ä¾‹åˆ†é…
```

**é—®é¢˜3ï¼šä»»åŠ¡å’Œæ”¶æ®çš„æ˜ å°„å…³ç³»**
- æ”¶æ®æ˜¯åŸºäº`client_service_id`ï¼ˆå®¢æˆ·æœåŠ¡çº§åˆ«ï¼‰
- ä»»åŠ¡ä¹Ÿæ˜¯åŸºäº`client_service_id`
- **ä½†æ˜¯**ï¼šä¸€ä¸ªæœåŠ¡ä¸‹å¯èƒ½æœ‰å¤šä¸ªä»»åŠ¡ï¼Œæ”¶å…¥å¦‚ä½•åˆ†é…ï¼Ÿ

#### âœ… æ­£ç¡®çš„é€»è¾‘åº”è¯¥æ˜¯

**æ­¥éª¤1ï¼šè·å–å‘˜å·¥çš„æ‰€æœ‰å·¥æ—¶è®°å½•**
```sql
SELECT 
  t.timesheet_id,
  t.task_id,
  t.client_id,
  t.hours,
  t.weighted_hours,
  t.work_date,
  task.client_service_id
FROM Timesheets t
LEFT JOIN Tasks task ON task.task_id = t.task_id
WHERE t.user_id = ? 
  AND t.is_deleted = 0
  AND substr(t.work_date, 1, 7) = ?
```

**æ­¥éª¤2ï¼šè·å–æœåŠ¡çš„æ”¶å…¥ï¼ˆæŒ‰æœåŠ¡æœˆä»½ï¼‰**
```sql
SELECT 
  client_service_id,
  billing_month,
  SUM(total_amount) as revenue
FROM Receipts
WHERE is_deleted = 0 
  AND status != 'cancelled'
GROUP BY client_service_id, billing_month
```

**æ­¥éª¤3ï¼šè®¡ç®—ä»»åŠ¡çš„æ€»å·¥æ—¶ï¼ˆç”¨äºåˆ†é…æ”¶å…¥ï¼‰**
```sql
SELECT 
  task_id,
  client_service_id,
  billing_month,
  SUM(hours) as total_hours
FROM (
  SELECT 
    t.task_id,
    task.client_service_id,
    substr(t.work_date, 1, 7) as billing_month,
    t.hours
  FROM Timesheets t
  LEFT JOIN Tasks task ON task.task_id = t.task_id
  WHERE t.is_deleted = 0
)
GROUP BY task_id, client_service_id, billing_month
```

**æ­¥éª¤4ï¼šåˆ†é…æ”¶å…¥åˆ°å‘˜å·¥**
```javascript
for (const timesheet of timesheets) {
  const serviceBillingMonth = timesheet.billing_month; // å·¥æ—¶æ‰€å±æœˆä»½
  const clientServiceId = timesheet.client_service_id;
  
  // è·å–è¯¥æœåŠ¡è¯¥æœˆçš„æ€»æ”¶å…¥
  const serviceRevenue = revenueMap.get(`${clientServiceId}_${serviceBillingMonth}`) || 0;
  
  // è·å–è¯¥ä»»åŠ¡åœ¨è¯¥æœˆçš„æ€»å·¥æ—¶
  const taskTotalHours = taskHoursMap.get(`${timesheet.task_id}_${serviceBillingMonth}`) || 0;
  
  // æŒ‰å·¥æ—¶æ¯”ä¾‹åˆ†é…æ”¶å…¥
  if (taskTotalHours > 0) {
    const employeeRevenue = serviceRevenue * (timesheet.hours / taskTotalHours);
    generatedRevenue += employeeRevenue;
  }
}
```

#### ğŸ”§ éœ€è¦é‡å†™çš„ä»£ç 
å½“å‰çš„å‘˜å·¥äº§å€¼æŠ¥è¡¨APIéœ€è¦å®Œå…¨é‡å†™ï¼Œå› ä¸ºï¼š
1. æ”¶å…¥åˆ†é…é€»è¾‘ä¸æ­£ç¡®
2. æ²¡æœ‰æ­£ç¡®å¤„ç†è·¨æœˆä»»åŠ¡
3. æ²¡æœ‰æ­£ç¡®å…³è”æ”¶æ®çš„`billing_month`

---

## æœˆåº¦å®¢æˆ·æ¯›åˆ©æŠ¥è¡¨

### æ•°æ®æ¥æº
- **API**ï¼š`/admin/costs/client` (æˆæœ¬æ•°æ®)
- **è¡¨**ï¼š`Receipts` (æ”¶å…¥æ•°æ®)

### é€»è¾‘éªŒè¯

#### âœ… æˆæœ¬è®¡ç®—ï¼ˆå·²åœ¨overhead.jséªŒè¯ï¼‰
```javascript
// å®¢æˆ·æ€»æˆæœ¬ = Î£(æ¯ä½å‘˜å·¥åœ¨è¯¥å®¢æˆ·çš„åŠ æƒå·¥æ—¶ Ã— è¯¥å‘˜å·¥çš„å®é™…æ—¶è–ª)
totalCost = Î£(weightedHours Ã— actualHourlyRate)

// å®é™…æ—¶è–ª = (è–ªèµ„æˆæœ¬ + ç®¡ç†è´¹åˆ†æ‘Š) / å®é™…å·¥æ—¶
actualHourlyRate = (laborCost + overheadAllocation) / monthHours
```

#### âš ï¸ æ”¶å…¥æ•°æ®çš„é—®é¢˜
**é—®é¢˜**ï¼šæ”¶å…¥åº”è¯¥æŒ‰æœåŠ¡æœˆä»½ç»Ÿè®¡ï¼Œè€Œéæ”¶æ®å¼€ç«‹æ—¥æœŸ
```javascript
// å½“å‰ä»£ç 
WHERE substr(r.receipt_date, 1, 7) = ?

// åº”è¯¥æ”¹ä¸º
WHERE r.billing_month = ?
```

#### âœ… æ­£ç¡®çš„æ¯›åˆ©è®¡ç®—
```javascript
// æ¯›åˆ© = æ”¶å…¥ - æˆæœ¬
profit = revenue - totalCost

// æ¯›åˆ©ç‡ = æ¯›åˆ© / æ”¶å…¥ Ã— 100%
profitMargin = (profit / revenue) Ã— 100
```

---

## å¹´åº¦æŠ¥è¡¨é€»è¾‘

### å½“å‰å®ç°æ–¹å¼
```javascript
// å¾ªç¯12ä¸ªæœˆï¼Œè°ƒç”¨æœˆåº¦API
for (let month = 1; month <= 12; month++) {
  const monthData = await callMonthlyAPI(year, month);
  annualData += monthData;
}
```

### âš ï¸ æ€§èƒ½é—®é¢˜
- **é—®é¢˜**ï¼šå¹´åº¦è–ªèµ„æŠ¥è¡¨éœ€è¦è®¡ç®—12æ¬¡Ã—å‘˜å·¥æ•°æ¬¡
  - ä¾‹å¦‚ï¼š3ä¸ªå‘˜å·¥Ã—12ä¸ªæœˆ = 36æ¬¡`calculateEmployeePayroll`è°ƒç”¨
- **å½±å“**ï¼šåŠ è½½æ—¶é—´å¯èƒ½è¶…è¿‡30ç§’

### ğŸ”§ ä¼˜åŒ–æ–¹æ¡ˆ
1. **çŸ­æœŸæ–¹æ¡ˆ**ï¼šåœ¨åç«¯èšåˆå¹´åº¦æ•°æ®ï¼ˆä¸€æ¬¡æ€§æŸ¥è¯¢ï¼‰
2. **é•¿æœŸæ–¹æ¡ˆ**ï¼šå»ºç«‹å¹´åº¦æ•°æ®å¿«ç…§è¡¨

---

## å…³é”®é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### ğŸ”´ é—®é¢˜1ï¼šæ”¶æ®æ—¶é—´å­—æ®µæ··æ·†

**é—®é¢˜æè¿°**ï¼š
- `receipt_date`ï¼šæ”¶æ®å¼€ç«‹æ—¥æœŸï¼ˆå¯èƒ½åœ¨æœåŠ¡æœˆä»½ä¹‹åï¼‰
- `billing_month`ï¼šæœåŠ¡æœˆä»½ï¼ˆä¾‹å¦‚"2024-11"ï¼‰
- **æ··ç”¨è¿™ä¸¤ä¸ªå­—æ®µä¼šå¯¼è‡´æ•°æ®é”™ä¹±**

**å½±å“èŒƒå›´**ï¼š
- âœ… æœˆåº¦æ”¶æ¬¾æŠ¥è¡¨
- âœ… æœˆåº¦å‘˜å·¥äº§å€¼æŠ¥è¡¨
- âœ… æœˆåº¦å®¢æˆ·æ¯›åˆ©æŠ¥è¡¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
ç»Ÿä¸€ä½¿ç”¨`billing_month`ä½œä¸ºæŠ¥è¡¨çš„æ—¶é—´ç»´åº¦

---

### ğŸ”´ é—®é¢˜2ï¼šå‘˜å·¥äº§å€¼çš„æ”¶å…¥åˆ†é…é€»è¾‘

**é—®é¢˜æè¿°**ï¼š
- æ”¶æ®æ˜¯æŒ‰`client_service_id`å¼€ç«‹çš„ï¼ˆæœåŠ¡çº§åˆ«ï¼‰
- ä¸€ä¸ªæœåŠ¡ä¸‹å¯èƒ½æœ‰å¤šä¸ªä»»åŠ¡
- å¤šä¸ªå‘˜å·¥å¯èƒ½å‚ä¸åŒä¸€ä¸ªä»»åŠ¡
- **å¦‚ä½•å…¬å¹³åˆ†é…æ”¶å…¥åˆ°æ¯ä¸ªå‘˜å·¥ï¼Ÿ**

**æ­£ç¡®çš„åˆ†é…é€»è¾‘**ï¼š
```
1. æœåŠ¡æ”¶å…¥ = è¯¥æœåŠ¡è¯¥æœˆçš„æ‰€æœ‰æ”¶æ®æ€»é¢
2. ä»»åŠ¡æ”¶å…¥ = æœåŠ¡æ”¶å…¥ Ã— (ä»»åŠ¡å·¥æ—¶ / æœåŠ¡æ€»å·¥æ—¶)
3. å‘˜å·¥æ”¶å…¥ = ä»»åŠ¡æ”¶å…¥ Ã— (å‘˜å·¥å·¥æ—¶ / ä»»åŠ¡å·¥æ—¶)
```

**ç¤ºä¾‹**ï¼š
```
æœåŠ¡Aï¼ˆ11æœˆï¼‰ï¼š
- æ”¶å…¥ï¼š10,000å…ƒ
- ä»»åŠ¡1ï¼š60å°æ—¶ï¼ˆå¼ ä¸‰40hï¼Œæå››20hï¼‰
- ä»»åŠ¡2ï¼š40å°æ—¶ï¼ˆå¼ ä¸‰20hï¼Œç‹äº”20hï¼‰
- æœåŠ¡æ€»å·¥æ—¶ï¼š100å°æ—¶

ä»»åŠ¡1æ”¶å…¥ = 10,000 Ã— (60/100) = 6,000å…ƒ
- å¼ ä¸‰äº§ç”Ÿæ”¶å…¥ = 6,000 Ã— (40/60) = 4,000å…ƒ
- æå››äº§ç”Ÿæ”¶å…¥ = 6,000 Ã— (20/60) = 2,000å…ƒ

ä»»åŠ¡2æ”¶å…¥ = 10,000 Ã— (40/100) = 4,000å…ƒ
- å¼ ä¸‰äº§ç”Ÿæ”¶å…¥ = 4,000 Ã— (20/40) = 2,000å…ƒ
- ç‹äº”äº§ç”Ÿæ”¶å…¥ = 4,000 Ã— (20/40) = 2,000å…ƒ

æœ€ç»ˆï¼š
- å¼ ä¸‰æœ¬æœˆäº§ç”Ÿæ”¶å…¥ = 4,000 + 2,000 = 6,000å…ƒ
- æå››æœ¬æœˆäº§ç”Ÿæ”¶å…¥ = 2,000å…ƒ
- ç‹äº”æœ¬æœˆäº§ç”Ÿæ”¶å…¥ = 2,000å…ƒ
```

---

### ğŸ”´ é—®é¢˜3ï¼šè·¨æœˆä»»åŠ¡çš„å¤„ç†

**é—®é¢˜æè¿°**ï¼š
- ä»»åŠ¡ä»10æœˆå¼€å§‹ï¼Œ11æœˆå®Œæˆ
- æ”¶æ®åœ¨11æœˆå¼€ç«‹ï¼Œ`billing_month`=2024-11
- **10æœˆçš„å·¥æ—¶å¦‚ä½•åˆ†é…æ”¶å…¥ï¼Ÿ**

**ç”¨æˆ·éœ€æ±‚**ï¼šæŒ‰å·¥æ—¶æ¯”ä¾‹åˆ†é…æ”¶å…¥

**æ­£ç¡®çš„å¤„ç†é€»è¾‘**ï¼š
```javascript
// æ”¶æ®ï¼šæœåŠ¡Aï¼Œbilling_month=2024-11ï¼Œæ”¶å…¥=10,000å…ƒ
// ä»»åŠ¡1çš„å·¥æ—¶åˆ†å¸ƒï¼š10æœˆ60hï¼Œ11æœˆ40h

// åˆ†é…æ–¹å¼ï¼š
10æœˆåˆ†é…æ”¶å…¥ = 10,000 Ã— (60/100) = 6,000å…ƒ
11æœˆåˆ†é…æ”¶å…¥ = 10,000 Ã— (40/100) = 4,000å…ƒ

// æŠ¥è¡¨æ˜¾ç¤ºï¼š
- 10æœˆæŠ¥è¡¨ï¼šè¯¥ä»»åŠ¡äº§ç”Ÿæ”¶å…¥6,000å…ƒ
- 11æœˆæŠ¥è¡¨ï¼šè¯¥ä»»åŠ¡äº§ç”Ÿæ”¶å…¥4,000å…ƒ
```

**å®ç°éš¾ç‚¹**ï¼š
éœ€è¦æŒ‰`work_date`çš„æœˆä»½åˆ†ç»„ï¼Œè€ŒéæŒ‰`billing_month`

---

### ğŸ”´ é—®é¢˜4ï¼šå®é™…æ—¶è–ªçš„è®¡ç®—åŸºå‡†

**é—®é¢˜æè¿°**ï¼š
- æˆæœ¬é¡µé¢ï¼šå®é™…æ—¶è–ª = æ€»æˆæœ¬ / å®é™…å·¥æ—¶
- å‘˜å·¥äº§å€¼ï¼šæ—¶è–ª = äº§ç”Ÿæ”¶å…¥ / åŠ æƒå·¥æ—¶
- **ä¸¤è€…ä¸ä¸€è‡´ï¼Œå“ªä¸ªæ‰å¯¹ï¼Ÿ**

**æ­£ç¡®ç†è§£**ï¼š
1. **æˆæœ¬æ—¶è–ª**ï¼ˆæˆæœ¬é¡µé¢ï¼‰ï¼šæ¯å°æ—¶çš„å®é™…æˆæœ¬
   - ç”¨äºè®¡ç®—ä»»åŠ¡æˆæœ¬
   - å…¬å¼ï¼š(è–ªèµ„æˆæœ¬ + ç®¡ç†è´¹) / å®é™…å·¥æ—¶

2. **äº§å€¼æ—¶è–ª**ï¼ˆäº§å€¼æŠ¥è¡¨ï¼‰ï¼šæ¯å°æ—¶åˆ›é€ çš„æ”¶å…¥
   - ç”¨äºè¯„ä¼°å‘˜å·¥æ•ˆç‡
   - å…¬å¼ï¼šäº§ç”Ÿæ”¶å…¥ / åŠ æƒå·¥æ—¶

**ä¸¤è€…éƒ½éœ€è¦ï¼Œå«ä¹‰ä¸åŒï¼**

---

### ğŸ”´ é—®é¢˜5ï¼šæ— ä»»åŠ¡çš„å·¥æ—¶å¤„ç†

**é—®é¢˜æè¿°**ï¼š
- å‘˜å·¥æœ‰äº›å·¥æ—¶æ²¡æœ‰å…³è”ä»»åŠ¡ï¼ˆ`task_id = NULL`ï¼‰
- ä¾‹å¦‚ï¼šç®¡ç†å·¥ä½œã€å­¦ä¹ åŸ¹è®­
- **è¿™äº›å·¥æ—¶å¦‚ä½•è®¡ç®—äº§å€¼ï¼Ÿ**

**å»ºè®®å¤„ç†æ–¹å¼**ï¼š
```javascript
// æ–¹æ¡ˆ1ï¼šä¸è®¡å…¥äº§å€¼ï¼ˆéè®¡è´¹å·¥æ—¶ï¼‰
if (timesheet.task_id === null) {
  // ä¸ç´¯åŠ åˆ°äº§ç”Ÿæ”¶å…¥
}

// æ–¹æ¡ˆ2ï¼šæŒ‰å¹³å‡æ—¶è–ªä¼°ç®—
const avgHourlyRate = totalRevenue / totalBillableHours;
const estimatedRevenue = nonBillableHours Ã— avgHourlyRate;
```

**éœ€è¦ç”¨æˆ·ç¡®è®¤**ï¼šé‡‡ç”¨å“ªç§æ–¹æ¡ˆï¼Ÿ

---

## æ€»ç»“ï¼šéœ€è¦ä¿®å¤çš„API

### ğŸ”§ å¿…é¡»ä¿®å¤çš„API
1. âœ… `/reports/monthly/revenue` - æ”¹ç”¨`billing_month`
2. âŒ `/reports/monthly/employee-performance` - **å®Œå…¨é‡å†™**
3. âœ… `/reports/monthly/client-profitability` - æ”¹ç”¨`billing_month`
4. âŒ `/reports/annual/*` - **ä¼˜åŒ–æ€§èƒ½**

### ğŸ“‹ éœ€è¦ç”¨æˆ·ç¡®è®¤çš„é—®é¢˜
1. æ”¶æ¬¾æŠ¥è¡¨ï¼šæŒ‰æœåŠ¡æœˆä»½è¿˜æ˜¯æ”¶æ®å¼€ç«‹æ—¥æœŸï¼Ÿ â†’ å·²ç¡®è®¤ï¼šæœåŠ¡æœˆä»½
2. å®æ”¶é‡‘é¢ï¼šæŒ‰æ”¶æ®æ—¥æœŸè¿˜æ˜¯å®é™…æ”¶æ¬¾æ—¥æœŸï¼Ÿ â†’ éœ€ç¡®è®¤
3. æ— ä»»åŠ¡å·¥æ—¶ï¼šå¦‚ä½•è®¡ç®—äº§å€¼ï¼Ÿ â†’ éœ€ç¡®è®¤
4. ç»©æ•ˆå¥–é‡‘/å¹´ç»ˆå¥–é‡‘ï¼šå¦‚ä½•è·å–ï¼Ÿ â†’ éœ€è¡¥å……
5. è·¨æœˆä»»åŠ¡ï¼šæ”¶å…¥åˆ†é…åˆ°å“ªä¸ªæœˆçš„æŠ¥è¡¨ï¼Ÿ â†’ å·²ç¡®è®¤ï¼šæŒ‰å·¥æ—¶æ¯”ä¾‹åˆ†é…

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### Phase 1: ä¿®å¤æ ¸å¿ƒé€»è¾‘é—®é¢˜
1. ç»Ÿä¸€ä½¿ç”¨`billing_month`å­—æ®µ
2. é‡å†™å‘˜å·¥äº§å€¼æŠ¥è¡¨API
3. å®ç°æ­£ç¡®çš„æ”¶å…¥åˆ†é…é€»è¾‘
4. å¤„ç†è·¨æœˆä»»åŠ¡

### Phase 2: ä¼˜åŒ–æ€§èƒ½
1. å¹´åº¦æŠ¥è¡¨æ”¹ä¸ºåç«¯èšåˆ
2. æ·»åŠ æ•°æ®ç¼“å­˜æœºåˆ¶

### Phase 3: è¡¥å……ç¼ºå¤±åŠŸèƒ½
1. ç»©æ•ˆå¥–é‡‘å’Œå¹´ç»ˆå¥–é‡‘è·å–
2. æœåŠ¡ç±»å‹å’Œä»»åŠ¡æ˜ç»†å±•å¼€
3. å‘˜å·¥æœˆåº¦è–ªèµ„æ˜ç»†æŸ¥çœ‹


