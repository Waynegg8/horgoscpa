# 驗證當前會話

**端點：** `GET /api/v1/auth/me`  
**權限：** 需登入

---

## 請求

### 查詢參數
無

### Headers
- Cookie: `auth_token=<JWT>`

---

## 成功回應

**HTTP 狀態碼：** 200

```json
{
  "success": true,
  "data": {
    "user": {
      "user_id": 2,
      "name": "紜蓁",
      "username": "yunzhen@firm.com",
      "is_admin": false,
      "gender": "female"
    },
    "permissions": {
      "dashboard": true,
      "timesheet": true,
      "tasks": true,
      "leave": true,
      "sop": false,
      "knowledge": false,
      "clients": false,
      "cms": false
    }
  }
}
```

---

## 錯誤回應

### Token 無效或過期
**HTTP 狀態碼：** 401
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "請先登入"
  }
}
```

---

## 使用場景

### 1. 前端頁面載入時
```javascript
// App.vue mounted()
async function checkAuth() {
  const response = await fetch('/api/v1/auth/me', {
    credentials: 'include'
  });
  
  if (response.ok) {
    const { data } = await response.json();
    store.commit('SET_USER', data.user);
    store.commit('SET_PERMISSIONS', data.permissions);
  } else {
    router.push('/login');
  }
}
```

### 2. Token 過期檢查
- 前端可定期（每 5 分鐘）呼叫此端點
- 若返回 401，自動登出並導向登入頁

---

## 業務邏輯

### 步驟
1. 驗證 JWT Token（由 `authMiddleware` 處理）
2. 從 Token 提取 `user_id`
3. 查詢使用者資料
4. 查詢權限
5. 返回完整資料

---

## 範例程式碼

```typescript
app.get('/api/v1/auth/me', authMiddleware, async (c) => {
  const userId = c.get('user').user_id;
  const isAdmin = c.get('user').is_admin;
  
  // 查詢使用者資料
  const user = await c.env.DB.prepare(
    'SELECT user_id, name, username, is_admin, gender FROM Users WHERE user_id = ?'
  ).bind(userId).first();
  
  if (!user) {
    return c.json(errorResponse('USER_NOT_FOUND'), 404);
  }
  
  // 查詢權限
  const permissions = await getPermissions(userId, isAdmin);
  
  return c.json(successResponse({ user, permissions }));
});
```


