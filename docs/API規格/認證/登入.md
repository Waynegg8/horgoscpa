# 登入

**端點：** `POST /api/v1/auth/login`  
**權限：** 無需認證（公開端點）

---

## 請求

### Body
```json
{
  "username": "yunzhen@firm.com",
  "password": "SecurePassword123"
}
```

### 驗證規則
- `username`: 必填，email 格式
- `password`: 必填，最少 8 字元

---

## 成功回應

**HTTP 狀態碼：** 200

```json
{
  "success": true,
  "data": {
    "user": {
      "user_id": 2,
      "name": "紜蓁",
      "username": "yunzhen@firm.com",
      "is_admin": false,
      "gender": "female"
    },
    "permissions": {
      "dashboard": true,
      "timesheet": true,
      "tasks": true,
      "leave": true,
      "sop": false,
      "knowledge": false,
      "clients": false,
      "cms": false
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

**額外動作：**
- 設定 `auth_token` Cookie（HttpOnly, Secure, SameSite=Strict, MaxAge=86400）

---

## 錯誤回應

### 帳號或密碼錯誤
**HTTP 狀態碼：** 401
```json
{
  "success": false,
  "error": {
    "code": "INVALID_CREDENTIALS",
    "message": "帳號或密碼錯誤"
  }
}
```

### 帳號已鎖定
**HTTP 狀態碼：** 403
```json
{
  "success": false,
  "error": {
    "code": "ACCOUNT_LOCKED",
    "message": "帳號已被鎖定，請於 15 分鐘後再試"
  }
}
```

---

## 業務邏輯

### 步驟
1. 檢查帳號是否鎖定（`locked_until`）
2. 查詢使用者（`username`）
3. 驗證密碼（Argon2）
4. 登入失敗：
   - 增加 `failed_login_attempts`
   - 若達 5 次，設定 `locked_until = now + 15分鐘`
5. 登入成功：
   - 重置 `failed_login_attempts = 0`
   - 清除 `locked_until`
   - 產生 JWT Token
   - 設定 Cookie
   - 查詢權限並返回

### 權限查詢邏輯
- **管理員：** 所有權限為 `true`
- **員工：** 從 `ModulePermissions` 查詢個人權限

---

## 範例程式碼

```typescript
app.post('/api/v1/auth/login', async (c) => {
  const { username, password } = await c.req.json();
  
  // 1. 查詢使用者
  const user = await c.env.DB.prepare(
    'SELECT * FROM Users WHERE username = ?'
  ).bind(username).first();
  
  if (!user) {
    return c.json(errorResponse('INVALID_CREDENTIALS'), 401);
  }
  
  // 2. 檢查鎖定狀態
  if (user.locked_until && new Date(user.locked_until) > new Date()) {
    return c.json(errorResponse('ACCOUNT_LOCKED'), 403);
  }
  
  // 3. 驗證密碼
  const valid = await argon2.verify(user.hashed_password, password);
  
  if (!valid) {
    await incrementFailedAttempts(user.user_id);
    return c.json(errorResponse('INVALID_CREDENTIALS'), 401);
  }
  
  // 4. 登入成功
  await resetFailedAttempts(user.user_id);
  const token = await generateJWT({ user_id: user.user_id, is_admin: user.is_admin });
  setCookie(c, 'auth_token', token, { httpOnly: true, secure: true, sameSite: 'strict', maxAge: 86400 });
  
  const permissions = await getPermissions(user.user_id, user.is_admin);
  
  return c.json(successResponse({ user, permissions, token }));
});
```


