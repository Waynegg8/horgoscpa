# 修改密碼

**端點：** `POST /api/v1/auth/change-password`  
**權限：** 需登入

---

## 請求

### Body
```json
{
  "current_password": "OldPassword123",
  "new_password": "NewPassword456"
}
```

### 驗證規則
- `current_password`: 必填
- `new_password`: 必填，最少 8 字元

---

## 成功回應

**HTTP 狀態碼：** 200

```json
{
  "success": true,
  "data": {
    "message": "密碼已更新"
  }
}
```

---

## 錯誤回應

### 當前密碼錯誤
**HTTP 狀態碼：** 401
```json
{
  "success": false,
  "error": {
    "code": "INVALID_PASSWORD",
    "message": "當前密碼錯誤"
  }
}
```

### 新密碼強度不足
**HTTP 狀態碼：** 422
```json
{
  "success": false,
  "error": {
    "code": "WEAK_PASSWORD",
    "message": "密碼至少需要 8 個字元"
  }
}
```

---

## 業務邏輯

### 步驟
1. 驗證 JWT Token（由 `authMiddleware` 處理）
2. 查詢當前使用者的 `hashed_password`
3. 驗證 `current_password` 是否正確
4. 驗證 `new_password` 強度（至少 8 字元）
5. 雜湊新密碼（Argon2）
6. 更新資料庫
7. 返回成功訊息

### 密碼強度建議（可擴展）
- 至少 8 字元（必須）
- 包含大小寫字母（建議）
- 包含數字（建議）
- 包含特殊符號（建議）

---

## 範例程式碼

```typescript
app.post('/api/v1/auth/change-password', authMiddleware, async (c) => {
  const { current_password, new_password } = await c.req.json();
  const userId = c.get('user').user_id;
  
  // 1. 獲取當前密碼
  const user = await c.env.DB.prepare(
    'SELECT hashed_password FROM Users WHERE user_id = ?'
  ).bind(userId).first();
  
  // 2. 驗證當前密碼
  const valid = await argon2.verify(user.hashed_password, current_password);
  
  if (!valid) {
    return c.json(errorResponse('INVALID_PASSWORD', '當前密碼錯誤'), 401);
  }
  
  // 3. 驗證新密碼強度
  if (new_password.length < 8) {
    return c.json(errorResponse('WEAK_PASSWORD', '密碼至少需要 8 個字元'), 422);
  }
  
  // 4. 雜湊新密碼
  const newHash = await argon2.hash(new_password, {
    type: argon2.argon2id,
    memoryCost: 65536,
    timeCost: 3,
    parallelism: 4
  });
  
  // 5. 更新資料庫
  await c.env.DB.prepare(
    'UPDATE Users SET hashed_password = ?, updated_at = datetime("now") WHERE user_id = ?'
  ).bind(newHash, userId).run();
  
  return c.json(successResponse({ message: '密碼已更新' }));
});
```

---

## 前端使用範例

```javascript
async function changePassword(currentPassword, newPassword) {
  try {
    const response = await fetch('/api/v1/auth/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        current_password: currentPassword,
        new_password: newPassword
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('密碼已更新');
    } else {
      alert(result.error.message);
    }
  } catch (error) {
    console.error('修改密碼失敗', error);
  }
}
```





