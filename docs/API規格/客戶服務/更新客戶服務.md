# 更新客戶服務

**端點：** `PUT /api/v1/client-services/:id`  
**權限：** 管理員或負責該客戶的會計師

---

## 請求

### 路徑參數
| 參數 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| `id` | integer | ✅ | 客戶服務ID |

### Body
```json
{
  "frequency_type_id": 1,
  "trigger_months": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
  "fee_amount": 18000,
  "difficulty": "困難",
  "is_active": true
}
```

**說明：**
- 只需傳送要更新的欄位
- `client_id` 和 `service_id` 不可更新
- 未提供的欄位保持原值

---

## 成功回應

**HTTP 狀態碼：** 200

```json
{
  "success": true,
  "data": {
    "message": "客戶服務更新成功"
  }
}
```

---

## 錯誤回應

### 客戶服務不存在
**HTTP 狀態碼：** 404
```json
{
  "success": false,
  "error": {
    "code": "CLIENT_SERVICE_NOT_FOUND",
    "message": "客戶服務不存在"
  }
}
```

### 週期性服務未設定觸發月份
**HTTP 狀態碼：** 422
```json
{
  "success": false,
  "error": {
    "code": "MISSING_TRIGGER_MONTHS",
    "message": "週期性服務必須設定觸發月份"
  }
}
```

---

## 業務邏輯

### 可更新欄位
- `frequency_type_id`
- `trigger_months`
- `fee_amount`
- `task_template_id`
- `difficulty`
- `start_date`
- `end_date`
- `is_active`
- `notes`

### 不可更新欄位
- `client_service_id`（主鍵）
- `client_id`（客戶關聯）
- `service_id`（服務關聯）
- `created_by`
- `created_at`

### 驗證規則
1. 客戶服務必須存在
2. 若修改頻率或觸發月份，驗證週期性規則

---

## 範例程式碼

```typescript
app.put('/api/v1/client-services/:id', 
  authMiddleware,
  async (c) => {
    const id = parseInt(c.req.param('id'));
    const userId = c.get('user').user_id;
    const isAdmin = c.get('user').is_admin;
    const input = await c.req.json();
    
    // 1. 檢查是否存在
    const existing = await c.env.DB.prepare(`
      SELECT cs.*, c.assignee_user_id
      FROM ClientServices cs
      JOIN Clients c ON cs.client_id = c.client_id
      WHERE cs.client_service_id = ? AND cs.is_deleted = 0
    `).bind(id).first();
    
    if (!existing) {
      return c.json(errorResponse('CLIENT_SERVICE_NOT_FOUND'), 404);
    }
    
    // 2. 權限檢查
    if (!isAdmin && existing.assignee_user_id !== userId) {
      return c.json(errorResponse('PERMISSION_DENIED'), 403);
    }
    
    // 3. 驗證觸發月份（若修改頻率）
    if (input.frequency_type_id || input.trigger_months !== undefined) {
      const freqId = input.frequency_type_id || existing.frequency_type_id;
      const triggerMonths = input.trigger_months !== undefined 
        ? input.trigger_months 
        : JSON.parse(existing.trigger_months || '[]');
      
      const freq = await c.env.DB.prepare(
        'SELECT is_recurring FROM ServiceFrequencyTypes WHERE frequency_type_id = ?'
      ).bind(freqId).first();
      
      if (freq?.is_recurring && (!triggerMonths || triggerMonths.length === 0)) {
        return c.json(errorResponse('MISSING_TRIGGER_MONTHS'), 422);
      }
    }
    
    // 4. 更新資料
    await c.env.DB.prepare(`
      UPDATE ClientServices 
      SET 
        frequency_type_id = COALESCE(?, frequency_type_id),
        trigger_months = COALESCE(?, trigger_months),
        fee_amount = COALESCE(?, fee_amount),
        task_template_id = COALESCE(?, task_template_id),
        difficulty = COALESCE(?, difficulty),
        start_date = COALESCE(?, start_date),
        end_date = COALESCE(?, end_date),
        is_active = COALESCE(?, is_active),
        notes = COALESCE(?, notes),
        updated_at = datetime('now')
      WHERE client_service_id = ?
    `).bind(
      input.frequency_type_id,
      input.trigger_months ? JSON.stringify(input.trigger_months) : null,
      input.fee_amount,
      input.task_template_id,
      input.difficulty,
      input.start_date,
      input.end_date,
      input.is_active,
      input.notes,
      id
    ).run();
    
    return c.json(successResponse({ message: '客戶服務更新成功' }));
  }
);
```





