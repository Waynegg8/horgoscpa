# 刪除客戶服務

**端點：** `DELETE /api/v1/client-services/:id`  
**權限：** 管理員或負責該客戶的會計師

---

## 請求

### 路徑參數
| 參數 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| `id` | integer | ✅ | 客戶服務ID |

---

## 成功回應

**HTTP 狀態碼：** 200

```json
{
  "success": true,
  "data": {
    "message": "客戶服務刪除成功"
  }
}
```

---

## 錯誤回應

### 客戶服務不存在
**HTTP 狀態碼：** 404
```json
{
  "success": false,
  "error": {
    "code": "CLIENT_SERVICE_NOT_FOUND",
    "message": "客戶服務不存在"
  }
}
```

### 服務有關聯任務
**HTTP 狀態碼：** 409
```json
{
  "success": false,
  "error": {
    "code": "SERVICE_HAS_TASKS",
    "message": "此服務有關聯的任務，無法刪除",
    "details": {
      "task_count": 5
    }
  }
}
```

### 無權限
**HTTP 狀態碼：** 403
```json
{
  "success": false,
  "error": {
    "code": "PERMISSION_DENIED",
    "message": "您無權刪除此服務"
  }
}
```

---

## 業務邏輯

### 刪除方式
- **軟刪除**：設定 `is_deleted = 1`
- 不實際刪除資料庫記錄

### 刪除前檢查
1. 檢查是否有關聯的任務（`ActiveTasks`）
2. 若有任務，禁止刪除

### 建議
若需要刪除有任務的服務：
1. 先將服務設為「停用」（`is_active = 0`）
2. 不要直接刪除

---

## 範例程式碼

```typescript
app.delete('/api/v1/client-services/:id', 
  authMiddleware,
  async (c) => {
    const id = parseInt(c.req.param('id'));
    const userId = c.get('user').user_id;
    const isAdmin = c.get('user').is_admin;
    
    // 1. 檢查是否存在並獲取客戶資訊
    const existing = await c.env.DB.prepare(`
      SELECT cs.*, c.assignee_user_id
      FROM ClientServices cs
      JOIN Clients c ON cs.client_id = c.client_id
      WHERE cs.client_service_id = ? AND cs.is_deleted = 0
    `).bind(id).first();
    
    if (!existing) {
      return c.json(errorResponse('CLIENT_SERVICE_NOT_FOUND'), 404);
    }
    
    // 2. 權限檢查
    if (!isAdmin && existing.assignee_user_id !== userId) {
      return c.json(errorResponse('PERMISSION_DENIED'), 403);
    }
    
    // 3. 檢查是否有關聯任務
    const tasks = await c.env.DB.prepare(`
      SELECT COUNT(*) as count 
      FROM ActiveTasks 
      WHERE client_id = ? 
        AND task_template_id = ?
        AND is_deleted = 0
    `).bind(existing.client_id, existing.task_template_id).first();
    
    if (tasks.count > 0) {
      return c.json(errorResponse(
        'SERVICE_HAS_TASKS', 
        '此服務有關聯的任務，無法刪除',
        { task_count: tasks.count }
      ), 409);
    }
    
    // 4. 軟刪除
    await c.env.DB.prepare(`
      UPDATE ClientServices 
      SET is_deleted = 1, deleted_at = datetime('now'), deleted_by = ?
      WHERE client_service_id = ?
    `).bind(userId, id).run();
    
    return c.json(successResponse({ message: '客戶服務刪除成功' }));
  }
);
```

---

## 前端使用範例

```javascript
async function deleteClientService(id) {
  if (!confirm('確定要刪除此服務嗎？')) return;
  
  try {
    const response = await fetch(`/api/v1/client-services/${id}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    
    const result = await response.json();
    
    if (!result.success) {
      if (result.error.code === 'SERVICE_HAS_TASKS') {
        alert(`無法刪除：此服務有 ${result.error.details.task_count} 個關聯任務\n` +
              `建議：將服務設為「停用」而不是刪除`);
      } else {
        alert(result.error.message);
      }
      return;
    }
    
    alert('刪除成功');
    await refreshServiceList();
  } catch (error) {
    console.error('刪除失敗', error);
  }
}
```


