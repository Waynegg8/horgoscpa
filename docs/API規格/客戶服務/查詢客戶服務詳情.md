# 查詢客戶服務詳情

**端點：** `GET /api/v1/client-services/:id`  
**權限：** 管理員或負責該客戶的會計師

---

## 請求

### 路徑參數
| 參數 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| `id` | integer | ✅ | 客戶服務ID |

---

## 成功回應

**HTTP 狀態碼：** 200

```json
{
  "success": true,
  "data": {
    "client_service_id": 1,
    "client_id": "12345678",
    "company_name": "冠群資訊股份有限公司",
    "service_id": 3,
    "service_name": "收集憑證",
    "parent_service_name": "記帳服務",
    "frequency_type_id": 2,
    "frequency_name": "雙月",
    "trigger_months": [1, 3, 5, 7, 9, 11],
    "fee_amount": 15000,
    "task_template_id": 1,
    "task_template_name": "記帳標準流程",
    "difficulty": "中等",
    "start_date": "2024-01-01",
    "end_date": null,
    "is_active": true,
    "notes": "雙月記帳服務",
    "status": "啟用中",
    "created_by": 1,
    "created_by_name": "紜蓁",
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z"
  }
}
```

---

## 錯誤回應

### 客戶服務不存在
**HTTP 狀態碼：** 404
```json
{
  "success": false,
  "error": {
    "code": "CLIENT_SERVICE_NOT_FOUND",
    "message": "客戶服務不存在"
  }
}
```

### 無權限
**HTTP 狀態碼：** 403
```json
{
  "success": false,
  "error": {
    "code": "PERMISSION_DENIED",
    "message": "您無權查看此服務"
  }
}
```

---

## 業務邏輯

### 返回資料
- 包含完整的服務資訊
- 包含關聯的客戶、服務項目、頻率類型、任務模板名稱
- 計算服務狀態（啟用中/已停用/已結束）

---

## 範例程式碼

```typescript
app.get('/api/v1/client-services/:id', 
  authMiddleware,
  async (c) => {
    const id = parseInt(c.req.param('id'));
    const userId = c.get('user').user_id;
    const isAdmin = c.get('user').is_admin;
    
    // 查詢服務詳情
    const service = await c.env.DB.prepare(`
      SELECT 
        cs.*,
        c.company_name,
        c.assignee_user_id,
        s.service_name,
        ps.service_name as parent_service_name,
        ft.frequency_name,
        tt.name as task_template_name,
        u.name as created_by_name
      FROM ClientServices cs
      JOIN Clients c ON cs.client_id = c.client_id
      JOIN Services s ON cs.service_id = s.service_id
      LEFT JOIN Services ps ON s.parent_service_id = ps.service_id
      LEFT JOIN ServiceFrequencyTypes ft ON cs.frequency_type_id = ft.frequency_type_id
      LEFT JOIN TaskTemplates tt ON cs.task_template_id = tt.task_template_id
      LEFT JOIN Users u ON cs.created_by = u.user_id
      WHERE cs.client_service_id = ? AND cs.is_deleted = 0
    `).bind(id).first();
    
    if (!service) {
      return c.json(errorResponse('CLIENT_SERVICE_NOT_FOUND'), 404);
    }
    
    // 權限檢查
    if (!isAdmin && service.assignee_user_id !== userId) {
      return c.json(errorResponse('PERMISSION_DENIED'), 403);
    }
    
    // 處理資料
    const result = {
      ...service,
      trigger_months: service.trigger_months ? JSON.parse(service.trigger_months) : null,
      status: getServiceStatus(service)
    };
    
    // 移除內部欄位
    delete result.assignee_user_id;
    
    return c.json(successResponse(result));
  }
);
```


