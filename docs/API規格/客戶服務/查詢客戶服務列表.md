# 查詢客戶服務列表

**端點：** `GET /api/v1/clients/:clientId/services`  
**權限：** 管理員或負責該客戶的會計師

---

## 請求

### 路徑參數
| 參數 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| `clientId` | string | ✅ | 客戶統編（8位數字）|

### 查詢參數
| 參數 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| `include_inactive` | boolean | ❌ | 是否包含停用的服務（預設：true）|

---

## 成功回應

**HTTP 狀態碼：** 200

```json
{
  "success": true,
  "data": [
    {
      "client_service_id": 1,
      "client_id": "12345678",
      "company_name": "冠群資訊股份有限公司",
      "service_id": 3,
      "service_name": "收集憑證",
      "parent_service_name": "記帳服務",
      "frequency_type_id": 2,
      "frequency_name": "雙月",
      "trigger_months": [1, 3, 5, 7, 9, 11],
      "fee_amount": 15000,
      "task_template_id": 1,
      "task_template_name": "記帳標準流程",
      "difficulty": "中等",
      "start_date": "2024-01-01",
      "end_date": null,
      "is_active": true,
      "notes": null,
      "status": "啟用中",
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-01T00:00:00Z"
    },
    {
      "client_service_id": 2,
      "client_id": "12345678",
      "company_name": "冠群資訊股份有限公司",
      "service_id": 6,
      "service_name": "公司變更",
      "parent_service_name": "工商登記服務",
      "frequency_type_id": 1,
      "frequency_name": "每月",
      "trigger_months": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
      "fee_amount": 5000,
      "task_template_id": null,
      "task_template_name": null,
      "difficulty": "簡單",
      "start_date": "2024-06-01",
      "end_date": null,
      "is_active": true,
      "notes": null,
      "status": "啟用中",
      "created_at": "2024-06-01T00:00:00Z",
      "updated_at": "2024-06-01T00:00:00Z"
    }
  ]
}
```

---

## 錯誤回應

### 客戶不存在
**HTTP 狀態碼：** 404
```json
{
  "success": false,
  "error": {
    "code": "CLIENT_NOT_FOUND",
    "message": "客戶不存在"
  }
}
```

### 無權限
**HTTP 狀態碼：** 403
```json
{
  "success": false,
  "error": {
    "code": "PERMISSION_DENIED",
    "message": "您無權查看此客戶的服務"
  }
}
```

---

## 業務邏輯

### 排序規則
1. 啟用的服務在前（`is_active = 1`）
2. 創建時間降序（新的在前）

### 狀態計算
- **啟用中**：`is_active = 1` 且（`end_date IS NULL` 或 `end_date >= 今天`）
- **已停用**：`is_active = 0`
- **已結束**：`end_date < 今天`

---

## 範例程式碼

```typescript
app.get('/api/v1/clients/:clientId/services', 
  authMiddleware,
  async (c) => {
    const clientId = c.req.param('clientId');
    const userId = c.get('user').user_id;
    const isAdmin = c.get('user').is_admin;
    const { include_inactive = 'true' } = c.req.query();
    
    // 1. 檢查客戶是否存在
    const client = await c.env.DB.prepare(
      'SELECT * FROM Clients WHERE client_id = ? AND is_deleted = 0'
    ).bind(clientId).first();
    
    if (!client) {
      return c.json(errorResponse('CLIENT_NOT_FOUND', '客戶不存在'), 404);
    }
    
    // 2. 權限檢查
    if (!isAdmin && client.assignee_user_id !== userId) {
      return c.json(errorResponse('PERMISSION_DENIED', '您無權查看此客戶的服務'), 403);
    }
    
    // 3. 查詢服務列表
    let sql = `
      SELECT 
        cs.*,
        c.company_name,
        s.service_name,
        ps.service_name as parent_service_name,
        ft.frequency_name,
        tt.name as task_template_name
      FROM ClientServices cs
      JOIN Clients c ON cs.client_id = c.client_id
      JOIN Services s ON cs.service_id = s.service_id
      LEFT JOIN Services ps ON s.parent_service_id = ps.service_id
      LEFT JOIN ServiceFrequencyTypes ft ON cs.frequency_type_id = ft.frequency_type_id
      LEFT JOIN TaskTemplates tt ON cs.task_template_id = tt.task_template_id
      WHERE cs.client_id = ? AND cs.is_deleted = 0
    `;
    
    if (include_inactive !== 'true') {
      sql += ' AND cs.is_active = 1';
    }
    
    sql += ' ORDER BY cs.is_active DESC, cs.created_at DESC';
    
    const services = await c.env.DB.prepare(sql).bind(clientId).all();
    
    // 4. 處理資料
    const result = services.results.map(s => ({
      ...s,
      trigger_months: s.trigger_months ? JSON.parse(s.trigger_months) : null,
      status: getServiceStatus(s)
    }));
    
    return c.json(successResponse(result));
  }
);

function getServiceStatus(service: any): string {
  if (service.end_date && new Date(service.end_date) < new Date()) {
    return '已結束';
  }
  return service.is_active ? '啟用中' : '已停用';
}
```


