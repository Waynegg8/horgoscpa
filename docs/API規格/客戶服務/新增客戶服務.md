# 新增客戶服務

**端點：** `POST /api/v1/clients/:clientId/services`  
**權限：** 管理員或負責該客戶的會計師

---

## 請求

### 路徑參數
| 參數 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| `clientId` | string | ✅ | 客戶統編（8位數字）|

### Body
```json
{
  "service_id": 3,
  "frequency_type_id": 2,
  "trigger_months": [1, 3, 5, 7, 9, 11],
  "fee_amount": 15000,
  "task_template_id": 1,
  "difficulty": "中等",
  "start_date": "2024-01-01",
  "end_date": null,
  "notes": "雙月記帳服務"
}
```

### 欄位說明
| 欄位 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| `service_id` | integer | ✅ | 服務項目ID |
| `frequency_type_id` | integer | ❌ | 週期類型ID |
| `trigger_months` | array | 條件 | 觸發月份（週期性服務必填）|
| `fee_amount` | number | ❌ | 服務費用 |
| `task_template_id` | integer | ❌ | 任務模板ID |
| `difficulty` | string | ❌ | 難易度（簡單/中等/困難）|
| `start_date` | string | ❌ | 開始日期（YYYY-MM-DD）|
| `end_date` | string | ❌ | 結束日期（YYYY-MM-DD）|
| `notes` | string | ❌ | 備註 |

---

## 成功回應

**HTTP 狀態碼：** 201

```json
{
  "success": true,
  "data": {
    "client_service_id": 15,
    "message": "客戶服務新增成功"
  }
}
```

---

## 錯誤回應

### 客戶已訂閱該服務
**HTTP 狀態碼：** 409
```json
{
  "success": false,
  "error": {
    "code": "DUPLICATE_SERVICE",
    "message": "此客戶已訂閱該服務項目"
  }
}
```

### 週期性服務未設定觸發月份
**HTTP 狀態碼：** 422
```json
{
  "success": false,
  "error": {
    "code": "MISSING_TRIGGER_MONTHS",
    "message": "週期性服務必須設定觸發月份"
  }
}
```

### 觸發月份無效
**HTTP 狀態碼：** 422
```json
{
  "success": false,
  "error": {
    "code": "INVALID_MONTH",
    "message": "觸發月份必須在1-12之間"
  }
}
```

---

## 業務邏輯

### 驗證規則
1. 客戶必須存在
2. 服務項目必須存在
3. 客戶不能重複訂閱同一服務
4. 週期性服務必須設定觸發月份
5. 觸發月份範圍：1-12

### 處理流程
1. 驗證客戶存在
2. 驗證服務項目存在
3. 檢查唯一性
4. 驗證觸發月份
5. 插入資料庫
6. 返回新服務ID

---

## 範例程式碼

```typescript
app.post('/api/v1/clients/:clientId/services', 
  authMiddleware,
  async (c) => {
    const clientId = c.req.param('clientId');
    const userId = c.get('user').user_id;
    const isAdmin = c.get('user').is_admin;
    const input = await c.req.json();
    
    // 1. 檢查客戶並驗證權限
    const client = await c.env.DB.prepare(
      'SELECT * FROM Clients WHERE client_id = ? AND is_deleted = 0'
    ).bind(clientId).first();
    
    if (!client) {
      return c.json(errorResponse('CLIENT_NOT_FOUND'), 404);
    }
    
    if (!isAdmin && client.assignee_user_id !== userId) {
      return c.json(errorResponse('PERMISSION_DENIED'), 403);
    }
    
    // 2. 檢查唯一性
    const existing = await c.env.DB.prepare(`
      SELECT COUNT(*) as count 
      FROM ClientServices 
      WHERE client_id = ? AND service_id = ? AND is_deleted = 0
    `).bind(clientId, input.service_id).first();
    
    if (existing.count > 0) {
      return c.json(errorResponse('DUPLICATE_SERVICE'), 409);
    }
    
    // 3. 驗證觸發月份（若為週期性服務）
    if (input.frequency_type_id) {
      const freq = await c.env.DB.prepare(
        'SELECT is_recurring FROM ServiceFrequencyTypes WHERE frequency_type_id = ?'
      ).bind(input.frequency_type_id).first();
      
      if (freq?.is_recurring) {
        if (!input.trigger_months || input.trigger_months.length === 0) {
          return c.json(errorResponse('MISSING_TRIGGER_MONTHS'), 422);
        }
        
        for (const month of input.trigger_months) {
          if (month < 1 || month > 12) {
            return c.json(errorResponse('INVALID_MONTH'), 422);
          }
        }
      }
    }
    
    // 4. 插入資料
    const result = await c.env.DB.prepare(`
      INSERT INTO ClientServices (
        client_id, service_id, frequency_type_id,
        trigger_months, fee_amount, task_template_id,
        difficulty, start_date, end_date, notes, created_by
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      clientId,
      input.service_id,
      input.frequency_type_id || null,
      input.trigger_months ? JSON.stringify(input.trigger_months) : null,
      input.fee_amount || null,
      input.task_template_id || null,
      input.difficulty || null,
      input.start_date || null,
      input.end_date || null,
      input.notes || null,
      userId
    ).run();
    
    return c.json(successResponse({
      client_service_id: result.meta.last_row_id,
      message: '客戶服務新增成功'
    }), 201);
  }
);
```





