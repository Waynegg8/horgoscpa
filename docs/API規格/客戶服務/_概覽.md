# 客戶服務 API 概覽

**API 前綴：** `/api/v1`  
**最後更新：** 2025年10月27日

---

## 端點總覽

| 端點 | 方法 | 權限 | 說明 |
|------|------|------|------|
| `/clients/:clientId/services` | GET | 管理員/負責會計師 | 查詢客戶的服務列表 |
| `/clients/:clientId/services` | POST | 管理員/負責會計師 | 為客戶新增服務 |
| `/client-services/:id` | GET | 管理員/負責會計師 | 查詢服務詳情 |
| `/client-services/:id` | PUT | 管理員/負責會計師 | 更新服務設定 |
| `/client-services/:id` | DELETE | 管理員/負責會計師 | 刪除服務 |

---

## 認證

所有 API 需要 JWT 認證：
```
Cookie: auth_token=<JWT_TOKEN>
```

---

## 權限規則

### 管理員
- 可管理所有客戶的服務

### 會計師
- 只能管理自己負責的客戶（`Clients.assignee_user_id` 匹配）

---

## 標準回應格式

### 成功
```json
{
  "success": true,
  "data": { ... }
}
```

### 錯誤
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "錯誤訊息"
  }
}
```

---

## 錯誤代碼

| 代碼 | HTTP狀態 | 說明 |
|-----|---------|------|
| `CLIENT_NOT_FOUND` | 404 | 客戶不存在 |
| `SERVICE_NOT_FOUND` | 404 | 服務項目不存在 |
| `CLIENT_SERVICE_NOT_FOUND` | 404 | 客戶服務不存在 |
| `DUPLICATE_SERVICE` | 409 | 客戶已訂閱該服務 |
| `MISSING_TRIGGER_MONTHS` | 422 | 週期性服務必須設定觸發月份 |
| `INVALID_MONTH` | 422 | 觸發月份必須在1-12之間 |
| `SERVICE_HAS_TASKS` | 409 | 服務有關聯任務，無法刪除 |
| `PERMISSION_DENIED` | 403 | 無權限 |

---

## 資料模型

### ClientService
```typescript
interface ClientService {
  client_service_id: number;
  client_id: string;
  company_name: string;
  service_id: number;
  service_name: string;
  parent_service_name: string | null;
  frequency_type_id: number | null;
  frequency_name: string | null;
  trigger_months: number[] | null;
  fee_amount: number | null;
  task_template_id: number | null;
  task_template_name: string | null;
  difficulty: string | null;
  start_date: string | null;
  end_date: string | null;
  is_active: boolean;
  notes: string | null;
  status: string;  // "啟用中" | "已停用" | "已結束"
  created_at: string;
  updated_at: string;
}
```

---

## 詳細端點規格

- [查詢客戶服務列表](./查詢客戶服務列表.md)
- [查詢客戶服務詳情](./查詢客戶服務詳情.md)
- [新增客戶服務](./新增客戶服務.md)
- [更新客戶服務](./更新客戶服務.md)
- [刪除客戶服務](./刪除客戶服務.md)

---

## 相關文檔

- [功能模塊 - 客戶服務設定](../../功能模塊/15-客戶服務設定.md)
- [技術規格 - UI設計](../../技術規格/客戶服務/UI設計.md)
- [技術規格 - 業務邏輯](../../技術規格/客戶服務/業務邏輯.md)
- [資料庫設計 - ClientServices](../../資料庫設計/業務服務/ClientServices.md)


