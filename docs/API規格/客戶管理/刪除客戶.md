# 刪除客戶

**端點：** `DELETE /api/v1/clients/:client_id`  
**權限：** 僅管理員

---

## 路徑參數

| 參數 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| `client_id` | string | ✅ | 客戶統一編號 |

---

## 請求範例

```bash
DELETE /api/v1/clients/86753078
```

---

## 成功回應

**HTTP 狀態碼：** 200

```json
{
  "success": true,
  "data": {
    "message": "客戶刪除成功"
  }
}
```

---

## 錯誤回應

### 客戶不存在
**HTTP 狀態碼：** 404
```json
{
  "success": false,
  "error": {
    "code": "CLIENT_NOT_FOUND",
    "message": "客戶不存在"
  }
}
```

### 客戶有關聯資料
**HTTP 狀態碼：** 409
```json
{
  "success": false,
  "error": {
    "code": "CANNOT_DELETE",
    "message": "客戶有關聯的服務項目，無法刪除"
  }
}
```

---

## 業務邏輯

### 刪除方式
- **軟刪除**（`is_deleted = 1`, `deleted_at = now()`, `deleted_by = user_id`）
- 不實際刪除資料庫記錄

### 處理流程
1. 檢查客戶是否存在
2. 檢查是否有關聯的服務項目（若有，禁止刪除）
3. 更新 `is_deleted`, `deleted_at`, `deleted_by`
4. 自動移除標籤關聯（`ClientTagAssignments` 表 `ON DELETE CASCADE`）

### 關聯資料處理
- **標籤關聯：** 自動移除
- **任務記錄：** 保留（不刪除）
- **工時記錄：** 保留（不刪除）
- **服務項目：** 若存在，禁止刪除客戶

---

## 範例程式碼

```typescript
app.delete('/api/v1/clients/:client_id', adminOnly, async (c) => {
  const clientId = c.req.param('client_id');
  const userId = c.get('user').user_id;
  
  // 檢查是否有服務項目
  const services = await c.env.DB.prepare(
    'SELECT COUNT(*) as count FROM ClientServices WHERE client_id = ?'
  ).bind(clientId).first();
  
  if (services.count > 0) {
    return c.json(errorResponse('CANNOT_DELETE', '客戶有關聯的服務項目，無法刪除'), 409);
  }
  
  // 軟刪除
  await c.env.DB.prepare(`
    UPDATE Clients 
    SET is_deleted = 1, deleted_at = datetime('now'), deleted_by = ?
    WHERE client_id = ?
  `).bind(userId, clientId).run();
  
  return c.json(successResponse({ message: '客戶刪除成功' }));
});
```





