# 查詢客戶列表

**端點：** `GET /api/v1/clients`  
**權限：** 所有員工

---

## 查詢參數

| 參數 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| `company_name` | string | ❌ | 公司名稱（模糊搜尋）|
| `client_id` | string | ❌ | 統一編號（模糊搜尋）|
| `tax_registration_number` | string | ❌ | 稅籍編號（模糊搜尋）|
| `assignee_user_id` | integer | ❌ | 負責員工 ID |
| `business_status` | string | ❌ | 營業狀況 |
| `organization_type` | string | ❌ | 組織種類 |
| `tag_ids` | string | ❌ | 標籤 ID（逗號分隔）|
| `limit` | integer | ❌ | 每頁筆數（預設：50）|
| `offset` | integer | ❌ | 偏移量（預設：0）|

---

## 請求範例

```bash
GET /api/v1/clients?company_name=冠群&business_status=營業中&limit=20
```

---

## 成功回應

**HTTP 狀態碼：** 200

```json
{
  "success": true,
  "data": [
    {
      "client_id": "86753078",
      "tax_registration_number": "12345678",
      "company_name": "冠群資訊股份有限公司",
      "business_status": "營業中",
      "organization_type": "股份有限公司",
      "assignee_user_id": 1,
      "assignee_name": "紜蓁",
      "phone": "04-1234-5678",
      "tags": ["VIP客戶", "長期合作"],
      "created_at": "2025-01-01T00:00:00Z"
    }
  ],
  "pagination": {
    "total": 150,
    "limit": 20,
    "offset": 0
  }
}
```

---

## 業務邏輯

### 權限檢查
- **所有員工** 皆可查詢
- **非管理員** 只能看到自己負責的客戶（需後端自動過濾）

### 搜尋邏輯
- 支援多條件組合查詢
- 字串欄位使用 `LIKE '%keyword%'` 模糊搜尋
- `tag_ids` 參數格式：`1,2,3`，查詢包含任一標籤的客戶

---

## 範例程式碼

```typescript
app.get('/api/v1/clients', authMiddleware, async (c) => {
  const userId = c.get('user').user_id;
  const isAdmin = c.get('user').is_admin;
  const { company_name, client_id, assignee_user_id, limit = 50, offset = 0 } = c.req.query();
  
  let sql = `
    SELECT c.*, u.name as assignee_name
    FROM Clients c
    LEFT JOIN Users u ON c.assignee_user_id = u.user_id
    WHERE c.is_deleted = 0
  `;
  
  const params = [];
  
  // 非管理員只能看自己負責的
  if (!isAdmin) {
    sql += ' AND c.assignee_user_id = ?';
    params.push(userId);
  }
  
  if (company_name) {
    sql += ' AND c.company_name LIKE ?';
    params.push(`%${company_name}%`);
  }
  
  sql += ` LIMIT ? OFFSET ?`;
  params.push(parseInt(limit), parseInt(offset));
  
  const clients = await c.env.DB.prepare(sql).bind(...params).all();
  
  return c.json(successResponse(clients.results, { total, limit, offset }));
});
```





