# 更新特定員工的權限

**端點：** `PUT /api/v1/settings/module-permissions/users/:user_id`  
**權限：** 管理員

---

## 請求

### 路徑參數
- `user_id`: 員工ID（整數）

### Body
```json
{
  "permissions": {
    "dashboard": true,
    "reports": true,
    "tasks": false
  }
}
```

### 驗證規則
- `permissions`: 必填，物件
- 鍵名：必須是有效的模塊代號
- 值：必須是 `boolean`

---

## 成功回應

**HTTP 狀態碼：** 200

```json
{
  "success": true,
  "message": "員工權限已更新"
}
```

---

## 業務邏輯

### 步驟
1. 驗證員工是否存在
2. 驗證模塊代號是否有效
3. 逐一更新 `ModulePermissions` 表
4. 使用 `UPSERT`（INSERT ... ON CONFLICT DO UPDATE）
5. 員工的 `is_customized` 狀態自動變為 `true`

### 注意事項
- 只更新提供的模塊，未提供的保持原狀
- 如需清除所有自訂，應使用「恢復為預設模板」端點

---

## 範例程式碼

```typescript
app.put('/api/v1/settings/module-permissions/users/:user_id', adminOnly, async (c) => {
  const userId = parseInt(c.req.param('user_id'));
  const { permissions } = await c.req.json();
  
  // 驗證員工是否存在
  const user = await c.env.DB.prepare(
    'SELECT user_id FROM Users WHERE user_id = ?'
  ).bind(userId).first();
  
  if (!user) {
    return c.json(errorResponse('USER_NOT_FOUND', '員工不存在'), 404);
  }
  
  // 更新權限
  for (const [moduleName, isEnabled] of Object.entries(permissions)) {
    await c.env.DB.prepare(`
      INSERT INTO ModulePermissions (user_id, module_name, is_enabled, updated_at)
      VALUES (?, ?, ?, datetime('now'))
      ON CONFLICT(user_id, module_name) 
      DO UPDATE SET 
        is_enabled = ?, 
        updated_at = datetime('now')
    `).bind(userId, moduleName, isEnabled ? 1 : 0, isEnabled ? 1 : 0).run();
  }
  
  return c.json(successResponse({ message: '員工權限已更新' }));
});
```

---

## 前端使用範例

```javascript
async function updateUserPermissions(userId, newPermissions) {
  const response = await fetch(`/api/v1/settings/module-permissions/users/${userId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ permissions: newPermissions })
  });
  
  if (response.ok) {
    alert('員工權限已更新');
  }
}
```


