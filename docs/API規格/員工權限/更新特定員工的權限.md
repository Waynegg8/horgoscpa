# 更新特定員工的權限

**端點：** `PUT /api/v1/settings/module-permissions/users/:user_id`  
**權限：** 管理員  
**最後更新：** 2025年10月27日

---

## 概述

更新特定員工的權限設定，創建個別調整記錄。

---

## 請求

### 路徑參數

- `user_id` (必填, integer): 員工 ID

### 請求 Body

```json
{
  "permissions": {
    "dashboard": true,
    "reports": true,
    "tasks": false
  }
}
```

**欄位說明：**
- `permissions`: 員工的完整權限設定
- 需包含所有可開放的模塊
- 系統會自動判斷與預設模板的差異，只儲存不同的部分

---

## 驗證規則

- `user_id`:
  - 必須存在
  - 必須為員工角色
- `permissions`:
  - 必填
  - 物件類型
  - 模塊名稱必須有效
  - 值必須為布林值

---

## 回應

### 成功回應（HTTP 200）

```json
{
  "success": true,
  "message": "員工權限已更新",
  "data": {
    "user_id": 123,
    "is_customized": true,
    "updated_modules": ["reports", "tasks"]
  }
}
```

**欄位說明：**
- `is_customized`: 更新後是否已個別調整
- `updated_modules`: 與預設模板不同的模塊清單

---

### 錯誤回應

**400 Bad Request - 管理員不可修改：**
```json
{
  "success": false,
  "error": {
    "code": "CANNOT_MODIFY_ADMIN",
    "message": "不可修改管理員的權限"
  }
}
```

**404 Not Found - 員工不存在：**
```json
{
  "success": false,
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "找不到員工"
  }
}
```

---

## 後端邏輯

```typescript
async function updateUserPermissions(
  userId: number, 
  permissions: Record<string, boolean>
) {
  // 1. 驗證員工
  const user = await getUserById(userId);
  if (!user) {
    throw new Error('USER_NOT_FOUND');
  }
  if (user.role === 'admin') {
    throw new Error('CANNOT_MODIFY_ADMIN');
  }
  
  // 2. 獲取預設模板
  const defaultPerms = await getDefaultPermissions();
  
  // 3. 找出與預設不同的權限
  const updatedModules = [];
  for (const [module, enabled] of Object.entries(permissions)) {
    if (enabled !== defaultPerms[module]) {
      updatedModules.push(module);
      
      // 插入或更新個別權限
      await db.run(`
        INSERT INTO ModulePermissions (user_id, module_name, is_enabled, updated_at)
        VALUES (?, ?, ?, CURRENT_TIMESTAMP)
        ON CONFLICT(user_id, module_name)
        DO UPDATE SET is_enabled = ?, updated_at = CURRENT_TIMESTAMP
      `, [userId, module, enabled, enabled]);
    } else {
      // 如果與預設相同，刪除個別設定
      await db.run(`
        DELETE FROM ModulePermissions
        WHERE user_id = ? AND module_name = ?
      `, [userId, module]);
    }
  }
  
  return {
    user_id: userId,
    is_customized: updatedModules.length > 0,
    updated_modules: updatedModules
  };
}
```

---

## 使用場景

### 場景：個別開放報表功能給特定員工

**請求：**
```bash
PUT /api/v1/settings/module-permissions/users/123
Content-Type: application/json

{
  "permissions": {
    "dashboard": true,
    "timesheet": true,
    "reports": true,  // 與預設不同
    "tasks": false
  }
}
```

**結果：** 只儲存 `reports: true` 的個別設定

---

## 相關端點

- [獲取特定員工的權限](./獲取特定員工的權限.md)
- [恢復員工為預設模板](./恢復員工為預設模板.md)
- [API 概覽](./_概覽.md)

---

**最後更新：** 2025年10月27日



**端點：** `PUT /api/v1/settings/module-permissions/users/:user_id`  
**權限：** 管理員  
**最後更新：** 2025年10月27日

---

## 概述

更新特定員工的權限設定，創建個別調整記錄。

---

## 請求

### 路徑參數

- `user_id` (必填, integer): 員工 ID

### 請求 Body

```json
{
  "permissions": {
    "dashboard": true,
    "reports": true,
    "tasks": false
  }
}
```

**欄位說明：**
- `permissions`: 員工的完整權限設定
- 需包含所有可開放的模塊
- 系統會自動判斷與預設模板的差異，只儲存不同的部分

---

## 驗證規則

- `user_id`:
  - 必須存在
  - 必須為員工角色
- `permissions`:
  - 必填
  - 物件類型
  - 模塊名稱必須有效
  - 值必須為布林值

---

## 回應

### 成功回應（HTTP 200）

```json
{
  "success": true,
  "message": "員工權限已更新",
  "data": {
    "user_id": 123,
    "is_customized": true,
    "updated_modules": ["reports", "tasks"]
  }
}
```

**欄位說明：**
- `is_customized`: 更新後是否已個別調整
- `updated_modules`: 與預設模板不同的模塊清單

---

### 錯誤回應

**400 Bad Request - 管理員不可修改：**
```json
{
  "success": false,
  "error": {
    "code": "CANNOT_MODIFY_ADMIN",
    "message": "不可修改管理員的權限"
  }
}
```

**404 Not Found - 員工不存在：**
```json
{
  "success": false,
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "找不到員工"
  }
}
```

---

## 後端邏輯

```typescript
async function updateUserPermissions(
  userId: number, 
  permissions: Record<string, boolean>
) {
  // 1. 驗證員工
  const user = await getUserById(userId);
  if (!user) {
    throw new Error('USER_NOT_FOUND');
  }
  if (user.role === 'admin') {
    throw new Error('CANNOT_MODIFY_ADMIN');
  }
  
  // 2. 獲取預設模板
  const defaultPerms = await getDefaultPermissions();
  
  // 3. 找出與預設不同的權限
  const updatedModules = [];
  for (const [module, enabled] of Object.entries(permissions)) {
    if (enabled !== defaultPerms[module]) {
      updatedModules.push(module);
      
      // 插入或更新個別權限
      await db.run(`
        INSERT INTO ModulePermissions (user_id, module_name, is_enabled, updated_at)
        VALUES (?, ?, ?, CURRENT_TIMESTAMP)
        ON CONFLICT(user_id, module_name)
        DO UPDATE SET is_enabled = ?, updated_at = CURRENT_TIMESTAMP
      `, [userId, module, enabled, enabled]);
    } else {
      // 如果與預設相同，刪除個別設定
      await db.run(`
        DELETE FROM ModulePermissions
        WHERE user_id = ? AND module_name = ?
      `, [userId, module]);
    }
  }
  
  return {
    user_id: userId,
    is_customized: updatedModules.length > 0,
    updated_modules: updatedModules
  };
}
```

---

## 使用場景

### 場景：個別開放報表功能給特定員工

**請求：**
```bash
PUT /api/v1/settings/module-permissions/users/123
Content-Type: application/json

{
  "permissions": {
    "dashboard": true,
    "timesheet": true,
    "reports": true,  // 與預設不同
    "tasks": false
  }
}
```

**結果：** 只儲存 `reports: true` 的個別設定

---

## 相關端點

- [獲取特定員工的權限](./獲取特定員工的權限.md)
- [恢復員工為預設模板](./恢復員工為預設模板.md)
- [API 概覽](./_概覽.md)

---

**最後更新：** 2025年10月27日



