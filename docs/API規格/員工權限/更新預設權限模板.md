# 更新預設權限模板

**端點：** `PUT /api/v1/settings/module-permissions/default`  
**權限：** 管理員  
**最後更新：** 2025年10月27日

---

## 概述

更新預設權限模板。只需傳遞要更新的模塊，未傳遞的保持不變。

---

## 請求

### 請求 Body

```json
{
  "permissions": {
    "dashboard": true,
    "reports": true,
    "tasks": false
  }
}
```

**欄位說明：**
- `permissions`: 要更新的模塊權限（部分更新）
- 只需包含要修改的模塊
- 未包含的模塊保持原狀

---

## 驗證規則

- `permissions`:
  - 必填
  - 物件類型
  - 至少包含 1 個模塊
  - 模塊名稱必須在可開放清單中
  - 值必須為布林值

---

## 回應

### 成功回應（HTTP 200）

```json
{
  "success": true,
  "message": "預設權限模板已更新"
}
```

---

### 錯誤回應

**400 Bad Request - 無效模塊名稱：**
```json
{
  "success": false,
  "error": {
    "code": "INVALID_MODULE_NAME",
    "message": "無效的模塊名稱：invalid_module"
  }
}
```

**403 Forbidden - 無權限：**
```json
{
  "success": false,
  "error": {
    "code": "ADMIN_PERMISSION_REQUIRED",
    "message": "需要管理員權限"
  }
}
```

---

## 後端邏輯

```typescript
async function updateDefaultPermissions(permissions: Record<string, boolean>) {
  // 驗證模塊名稱
  const validModules = EMPLOYEE_MODULES;
  for (const moduleName of Object.keys(permissions)) {
    if (!validModules.includes(moduleName)) {
      throw new Error(`INVALID_MODULE_NAME: ${moduleName}`);
    }
  }
  
  // 更新或插入權限
  for (const [moduleName, isEnabled] of Object.entries(permissions)) {
    await db.run(`
      INSERT INTO ModulePermissions (user_id, module_name, is_enabled, updated_at)
      VALUES (NULL, ?, ?, CURRENT_TIMESTAMP)
      ON CONFLICT(user_id, module_name) 
      DO UPDATE SET is_enabled = ?, updated_at = CURRENT_TIMESTAMP
    `, [moduleName, isEnabled, isEnabled]);
  }
}
```

---

## 使用範例

### 場景：開放報表中心給所有新員工

**請求：**
```bash
PUT /api/v1/settings/module-permissions/default
Content-Type: application/json

{
  "permissions": {
    "reports": true
  }
}
```

**回應：**
```json
{
  "success": true,
  "message": "預設權限模板已更新"
}
```

---

## 相關端點

- [獲取預設權限模板](./獲取預設權限模板.md)
- [同步預設模板到員工](./同步預設模板到員工.md)
- [API 概覽](./_概覽.md)

---

**最後更新：** 2025年10月27日



**端點：** `PUT /api/v1/settings/module-permissions/default`  
**權限：** 管理員  
**最後更新：** 2025年10月27日

---

## 概述

更新預設權限模板。只需傳遞要更新的模塊，未傳遞的保持不變。

---

## 請求

### 請求 Body

```json
{
  "permissions": {
    "dashboard": true,
    "reports": true,
    "tasks": false
  }
}
```

**欄位說明：**
- `permissions`: 要更新的模塊權限（部分更新）
- 只需包含要修改的模塊
- 未包含的模塊保持原狀

---

## 驗證規則

- `permissions`:
  - 必填
  - 物件類型
  - 至少包含 1 個模塊
  - 模塊名稱必須在可開放清單中
  - 值必須為布林值

---

## 回應

### 成功回應（HTTP 200）

```json
{
  "success": true,
  "message": "預設權限模板已更新"
}
```

---

### 錯誤回應

**400 Bad Request - 無效模塊名稱：**
```json
{
  "success": false,
  "error": {
    "code": "INVALID_MODULE_NAME",
    "message": "無效的模塊名稱：invalid_module"
  }
}
```

**403 Forbidden - 無權限：**
```json
{
  "success": false,
  "error": {
    "code": "ADMIN_PERMISSION_REQUIRED",
    "message": "需要管理員權限"
  }
}
```

---

## 後端邏輯

```typescript
async function updateDefaultPermissions(permissions: Record<string, boolean>) {
  // 驗證模塊名稱
  const validModules = EMPLOYEE_MODULES;
  for (const moduleName of Object.keys(permissions)) {
    if (!validModules.includes(moduleName)) {
      throw new Error(`INVALID_MODULE_NAME: ${moduleName}`);
    }
  }
  
  // 更新或插入權限
  for (const [moduleName, isEnabled] of Object.entries(permissions)) {
    await db.run(`
      INSERT INTO ModulePermissions (user_id, module_name, is_enabled, updated_at)
      VALUES (NULL, ?, ?, CURRENT_TIMESTAMP)
      ON CONFLICT(user_id, module_name) 
      DO UPDATE SET is_enabled = ?, updated_at = CURRENT_TIMESTAMP
    `, [moduleName, isEnabled, isEnabled]);
  }
}
```

---

## 使用範例

### 場景：開放報表中心給所有新員工

**請求：**
```bash
PUT /api/v1/settings/module-permissions/default
Content-Type: application/json

{
  "permissions": {
    "reports": true
  }
}
```

**回應：**
```json
{
  "success": true,
  "message": "預設權限模板已更新"
}
```

---

## 相關端點

- [獲取預設權限模板](./獲取預設權限模板.md)
- [同步預設模板到員工](./同步預設模板到員工.md)
- [API 概覽](./_概覽.md)

---

**最後更新：** 2025年10月27日



