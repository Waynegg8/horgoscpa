# 獲取當前用戶權限

**端點：** `GET /api/v1/settings/module-permissions/me`  
**權限：** 所有登入用戶  
**最後更新：** 2025年10月27日

---

## 概述

獲取當前登入用戶可存取的模塊清單，供前端決定顯示哪些導航選單。

---

## 請求

無需參數（從 JWT token 或 session 獲取當前用戶）。

---

## 回應

### 成功回應 - 員工（HTTP 200）

```json
{
  "success": true,
  "data": {
    "dashboard": true,
    "personal_settings": true,
    "timesheet": true,
    "reports": false,
    "tasks": false,
    "life_events": false
  }
}
```

---

### 成功回應 - 管理員（HTTP 200）

```json
{
  "success": true,
  "data": {
    "dashboard": true,
    "personal_settings": true,
    "timesheet": true,
    "reports": true,
    "tasks": true,
    "sop_management": true,
    "knowledge_base": true,
    "service_management": true,
    "csv_import": true,
    "employee_permissions": true,
    "business_rules": true,
    "employee_accounts": true,
    "external_articles": true,
    "external_faq": true,
    "external_resources": true,
    "external_images": true,
    "booking_settings": true
  }
}
```

**說明：**
- 管理員擁有所有模塊的權限（包含管理員專屬8個）
- 員工權限為預設模板+個別調整的合併結果

---

### 錯誤回應

**401 Unauthorized - 未登入：**
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "請先登入"
  }
}
```

---

## 後端邏輯

```typescript
async function getCurrentUserPermissions(userId: number) {
  const user = await getUserById(userId);
  
  // 管理員擁有所有權限
  if (user.role === 'admin') {
    return {
      ...getAllEmployeeModules(),  // 14個可開放模塊
      ...getAllAdminOnlyModules()   // 8個管理員專屬
    };
  }
  
  // 員工：查詢個別設定 + 預設模板
  const permissions = await db.all(`
    SELECT module_name, is_enabled
    FROM ModulePermissions
    WHERE (user_id = ? OR user_id IS NULL)
    ORDER BY user_id DESC  -- 個別設定優先
  `, [userId]);
  
  // 轉換為物件，去重（個別設定覆蓋預設）
  const result = {};
  const seen = new Set();
  
  permissions.forEach(p => {
    if (!seen.has(p.module_name)) {
      result[p.module_name] = p.is_enabled;
      seen.add(p.module_name);
    }
  });
  
  return result;
}
```

---

## 前端使用範例

### 場景：根據權限顯示導航選單

```typescript
// 獲取當前用戶權限
const { data: permissions } = await api.get('/api/v1/settings/module-permissions/me');

// 導航選單配置
const navItems = [
  { path: '/dashboard', label: '儀表板', module: 'dashboard' },
  { path: '/timesheet', label: '工時表', module: 'timesheet' },
  { path: '/reports', label: '報表中心', module: 'reports' },
  { path: '/tasks', label: '任務追蹤', module: 'tasks' },
];

// 只顯示有權限的選單
const visibleNavItems = navItems.filter(item => permissions[item.module]);
```

---

## 快取建議

此 API 結果可以快取：
- **快取時間：** 5 分鐘
- **清除時機：** 
  - 管理員更新該用戶權限時
  - 用戶重新登入時

---

## 相關端點

- [獲取特定員工的權限](./獲取特定員工的權限.md)
- [更新特定員工的權限](./更新特定員工的權限.md)
- [API 概覽](./_概覽.md)

---

**最後更新：** 2025年10月27日



**端點：** `GET /api/v1/settings/module-permissions/me`  
**權限：** 所有登入用戶  
**最後更新：** 2025年10月27日

---

## 概述

獲取當前登入用戶可存取的模塊清單，供前端決定顯示哪些導航選單。

---

## 請求

無需參數（從 JWT token 或 session 獲取當前用戶）。

---

## 回應

### 成功回應 - 員工（HTTP 200）

```json
{
  "success": true,
  "data": {
    "dashboard": true,
    "personal_settings": true,
    "timesheet": true,
    "reports": false,
    "tasks": false,
    "life_events": false
  }
}
```

---

### 成功回應 - 管理員（HTTP 200）

```json
{
  "success": true,
  "data": {
    "dashboard": true,
    "personal_settings": true,
    "timesheet": true,
    "reports": true,
    "tasks": true,
    "sop_management": true,
    "knowledge_base": true,
    "service_management": true,
    "csv_import": true,
    "employee_permissions": true,
    "business_rules": true,
    "employee_accounts": true,
    "external_articles": true,
    "external_faq": true,
    "external_resources": true,
    "external_images": true,
    "booking_settings": true
  }
}
```

**說明：**
- 管理員擁有所有模塊的權限（包含管理員專屬8個）
- 員工權限為預設模板+個別調整的合併結果

---

### 錯誤回應

**401 Unauthorized - 未登入：**
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "請先登入"
  }
}
```

---

## 後端邏輯

```typescript
async function getCurrentUserPermissions(userId: number) {
  const user = await getUserById(userId);
  
  // 管理員擁有所有權限
  if (user.role === 'admin') {
    return {
      ...getAllEmployeeModules(),  // 14個可開放模塊
      ...getAllAdminOnlyModules()   // 8個管理員專屬
    };
  }
  
  // 員工：查詢個別設定 + 預設模板
  const permissions = await db.all(`
    SELECT module_name, is_enabled
    FROM ModulePermissions
    WHERE (user_id = ? OR user_id IS NULL)
    ORDER BY user_id DESC  -- 個別設定優先
  `, [userId]);
  
  // 轉換為物件，去重（個別設定覆蓋預設）
  const result = {};
  const seen = new Set();
  
  permissions.forEach(p => {
    if (!seen.has(p.module_name)) {
      result[p.module_name] = p.is_enabled;
      seen.add(p.module_name);
    }
  });
  
  return result;
}
```

---

## 前端使用範例

### 場景：根據權限顯示導航選單

```typescript
// 獲取當前用戶權限
const { data: permissions } = await api.get('/api/v1/settings/module-permissions/me');

// 導航選單配置
const navItems = [
  { path: '/dashboard', label: '儀表板', module: 'dashboard' },
  { path: '/timesheet', label: '工時表', module: 'timesheet' },
  { path: '/reports', label: '報表中心', module: 'reports' },
  { path: '/tasks', label: '任務追蹤', module: 'tasks' },
];

// 只顯示有權限的選單
const visibleNavItems = navItems.filter(item => permissions[item.module]);
```

---

## 快取建議

此 API 結果可以快取：
- **快取時間：** 5 分鐘
- **清除時機：** 
  - 管理員更新該用戶權限時
  - 用戶重新登入時

---

## 相關端點

- [獲取特定員工的權限](./獲取特定員工的權限.md)
- [更新特定員工的權限](./更新特定員工的權限.md)
- [API 概覽](./_概覽.md)

---

**最後更新：** 2025年10月27日



