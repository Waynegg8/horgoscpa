# 獲取當前用戶權限

**端點：** `GET /api/v1/settings/module-permissions/me`  
**權限：** 需登入（所有用戶）

---

## 請求

### 查詢參數
無

### Headers
- Cookie: `auth_token=<JWT>`

---

## 成功回應

**HTTP 狀態碼：** 200

```json
{
  "success": true,
  "data": {
    "dashboard": true,
    "personal_settings": true,
    "timesheet": true,
    "reports": false,
    "tasks": false,
    "life_events": false,
    "client_services": false
  }
}
```

---

## 業務邏輯

### 步驟
1. 從 JWT Token 取得 `user_id` 和 `is_admin`
2. **管理員：** 返回所有權限為 `true`
3. **員工：** 查詢預設模板 + 個別權限，合併後返回

### 管理員權限
```typescript
if (isAdmin) {
  return getAllModulesEnabled();  // 所有模塊 = true
}
```

### 員工權限
```typescript
// 1. 獲取預設模板
const defaultPerms = await getDefaultPermissions();

// 2. 獲取個別設定（若有）
const userPerms = await getUserCustomPermissions(userId);

// 3. 合併（個別設定覆蓋預設）
return { ...defaultPerms, ...userPerms };
```

---

## 使用場景

### 場景 1：前端導航選單
頁面載入時呼叫此 API，根據權限決定顯示哪些選單項目：
```javascript
if (permissions.tasks) {
  showMenuItem('任務管理');
}
```

### 場景 2：功能開關
在特定功能頁面檢查權限，決定是否顯示某些按鈕。

---

## 範例程式碼

```typescript
app.get('/api/v1/settings/module-permissions/me', authMiddleware, async (c) => {
  const userId = c.get('user').user_id;
  const isAdmin = c.get('user').is_admin;
  
  // 管理員擁有所有權限
  if (isAdmin) {
    return c.json(successResponse(getAllModulesEnabled()));
  }
  
  // 員工權限：合併預設+個別設定
  const defaultPerms = await getDefaultPermissions(c.env.DB);
  const userPerms = await c.env.DB.prepare(`
    SELECT module_name, is_enabled 
    FROM ModulePermissions 
    WHERE user_id = ?
  `).bind(userId).all();
  
  const permissions = { ...defaultPerms };
  userPerms.results.forEach(row => {
    permissions[row.module_name] = row.is_enabled === 1;
  });
  
  return c.json(successResponse(permissions));
});
```

---

## 前端使用範例

```javascript
async function loadUserPermissions() {
  const response = await fetch('/api/v1/settings/module-permissions/me', {
    credentials: 'include'
  });
  const { data } = await response.json();
  
  // 儲存到 Vuex/Pinia
  store.commit('SET_PERMISSIONS', data);
  
  // 動態渲染導航
  renderNavigation(data);
}
```


