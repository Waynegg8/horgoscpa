# 同步預設模板到員工

**端點：** `POST /api/v1/settings/module-permissions/sync`  
**權限：** 管理員  
**最後更新：** 2025年10月27日

---

## 概述

將當前的預設權限模板同步到指定的員工，刪除這些員工的個別設定。

---

## 請求

### 請求 Body

```json
{
  "user_ids": [123, 456, 789]
}
```

**欄位說明：**
- `user_ids`: 要同步的員工 ID 陣列

---

## 驗證規則

- `user_ids`:
  - 必填
  - 陣列，至少包含 1 個員工 ID
  - 所有 ID 必須存在且為非管理員
  - 不可包含管理員 ID

---

## 回應

### 成功回應（HTTP 200）

```json
{
  "success": true,
  "message": "已同步 3 位員工的權限",
  "data": {
    "synced_users": [123, 456, 789],
    "synced_count": 3
  }
}
```

---

### 錯誤回應

**400 Bad Request - 包含管理員：**
```json
{
  "success": false,
  "error": {
    "code": "CANNOT_MODIFY_ADMIN",
    "message": "不可修改管理員的權限"
  }
}
```

**404 Not Found - 員工不存在：**
```json
{
  "success": false,
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "找不到員工 ID：456"
  }
}
```

---

## 後端邏輯

```typescript
async function syncDefaultPermissions(userIds: number[]) {
  // 1. 驗證所有 user_id 存在且為員工
  for (const userId of userIds) {
    const user = await getUserById(userId);
    if (!user) {
      throw new Error(`USER_NOT_FOUND: ${userId}`);
    }
    if (user.role === 'admin') {
      throw new Error('CANNOT_MODIFY_ADMIN');
    }
  }
  
  // 2. 刪除這些員工的所有個別權限設定
  await db.run(`
    DELETE FROM ModulePermissions
    WHERE user_id IN (${userIds.join(',')})
  `);
  
  // 3. 這些員工將自動使用預設模板
  return {
    synced_users: userIds,
    synced_count: userIds.length
  };
}
```

---

## 使用場景

### 場景：更新預設模板後批量同步

1. 管理員更新預設模板（開放報表中心）
2. 前端彈出「同步現有員工」對話框
3. 管理員勾選要同步的員工：[123, 456, 789]
4. 前端呼叫此 API 同步權限

---

## 相關端點

- [更新預設權限模板](./更新預設權限模板.md)
- [獲取所有員工的權限狀態列表](./獲取所有員工的權限狀態列表.md)
- [API 概覽](./_概覽.md)

---

**最後更新：** 2025年10月27日



**端點：** `POST /api/v1/settings/module-permissions/sync`  
**權限：** 管理員  
**最後更新：** 2025年10月27日

---

## 概述

將當前的預設權限模板同步到指定的員工，刪除這些員工的個別設定。

---

## 請求

### 請求 Body

```json
{
  "user_ids": [123, 456, 789]
}
```

**欄位說明：**
- `user_ids`: 要同步的員工 ID 陣列

---

## 驗證規則

- `user_ids`:
  - 必填
  - 陣列，至少包含 1 個員工 ID
  - 所有 ID 必須存在且為非管理員
  - 不可包含管理員 ID

---

## 回應

### 成功回應（HTTP 200）

```json
{
  "success": true,
  "message": "已同步 3 位員工的權限",
  "data": {
    "synced_users": [123, 456, 789],
    "synced_count": 3
  }
}
```

---

### 錯誤回應

**400 Bad Request - 包含管理員：**
```json
{
  "success": false,
  "error": {
    "code": "CANNOT_MODIFY_ADMIN",
    "message": "不可修改管理員的權限"
  }
}
```

**404 Not Found - 員工不存在：**
```json
{
  "success": false,
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "找不到員工 ID：456"
  }
}
```

---

## 後端邏輯

```typescript
async function syncDefaultPermissions(userIds: number[]) {
  // 1. 驗證所有 user_id 存在且為員工
  for (const userId of userIds) {
    const user = await getUserById(userId);
    if (!user) {
      throw new Error(`USER_NOT_FOUND: ${userId}`);
    }
    if (user.role === 'admin') {
      throw new Error('CANNOT_MODIFY_ADMIN');
    }
  }
  
  // 2. 刪除這些員工的所有個別權限設定
  await db.run(`
    DELETE FROM ModulePermissions
    WHERE user_id IN (${userIds.join(',')})
  `);
  
  // 3. 這些員工將自動使用預設模板
  return {
    synced_users: userIds,
    synced_count: userIds.length
  };
}
```

---

## 使用場景

### 場景：更新預設模板後批量同步

1. 管理員更新預設模板（開放報表中心）
2. 前端彈出「同步現有員工」對話框
3. 管理員勾選要同步的員工：[123, 456, 789]
4. 前端呼叫此 API 同步權限

---

## 相關端點

- [更新預設權限模板](./更新預設權限模板.md)
- [獲取所有員工的權限狀態列表](./獲取所有員工的權限狀態列表.md)
- [API 概覽](./_概覽.md)

---

**最後更新：** 2025年10月27日



