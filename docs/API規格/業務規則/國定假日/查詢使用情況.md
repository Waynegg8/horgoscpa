# 查詢使用情況

**端點：** `GET /api/v1/settings/holidays/:date/usage`  
**權限：** 管理員  
**最後更新：** 2025年10月27日

---

## 概述

查詢特定國定假日是否被工時記錄使用，以及使用次數和相關記錄。

---

## 請求

### 路徑參數

- `date` (必填, string): 國定假日日期，格式 `YYYY-MM-DD`

---

## 回應

### 成功回應（HTTP 200）

```json
{
  "success": true,
  "data": {
    "date": "2025-01-01",
    "is_in_use": true,
    "usage_count": 5,
    "usage_details": [
      {
        "log_id": 1001,
        "user_id": 123,
        "user_name": "王小明",
        "hours": 8.0,
        "work_day_type": "national_holiday",
        "created_at": "2025-01-02T10:00:00Z"
      },
      {
        "log_id": 1002,
        "user_id": 456,
        "user_name": "李小華",
        "hours": 4.0,
        "work_day_type": "national_holiday",
        "created_at": "2025-01-02T11:00:00Z"
      }
    ]
  }
}
```

---

### 未使用的國定假日

```json
{
  "success": true,
  "data": {
    "date": "2025-01-26",
    "is_in_use": false,
    "usage_count": 0,
    "usage_details": []
  }
}
```

---

### 錯誤回應

**404 Not Found - 找不到國定假日：**
```json
{
  "success": false,
  "error": {
    "code": "HOLIDAY_NOT_FOUND",
    "message": "找不到該日期的國定假日"
  }
}
```

---

## 使用場景

### 場景：刪除前檢查

在刪除國定假日前，前端先呼叫此 API 檢查使用情況：

```typescript
async function deleteHolidayWithCheck(date: string) {
  // 1. 檢查使用情況
  const usage = await api.get(`/api/v1/settings/holidays/${date}/usage`);
  
  if (usage.data.is_in_use) {
    // 2. 顯示警告對話框
    const confirmed = await showConfirmDialog(
      `該國定假日已被 ${usage.data.usage_count} 筆工時記錄使用，確定要刪除嗎？`
    );
    
    if (!confirmed) return;
  }
  
  // 3. 執行刪除
  await api.delete(`/api/v1/settings/holidays/${date}`);
}
```

---

## 後端查詢邏輯

```typescript
async function getHolidayUsage(date: string) {
  // 1. 檢查國定假日是否存在
  const holiday = await db.get(`
    SELECT * FROM Holidays WHERE date = ?
  `, [date]);
  
  if (!holiday) {
    throw new Error('HOLIDAY_NOT_FOUND');
  }
  
  // 2. 查詢工時記錄
  const usageDetails = await db.all(`
    SELECT 
      tl.log_id,
      tl.user_id,
      u.name AS user_name,
      tl.hours,
      tl.work_day_type,
      tl.created_at
    FROM TimeLogs tl
    JOIN Users u ON tl.user_id = u.user_id
    WHERE tl.work_date = ?
    ORDER BY tl.created_at DESC
  `, [date]);
  
  return {
    date,
    is_in_use: usageDetails.length > 0,
    usage_count: usageDetails.length,
    usage_details: usageDetails
  };
}
```

---

## 相關端點

- [刪除國定假日](./刪除國定假日.md)
- [獲取特定國定假日](./獲取特定國定假日.md)
- [API 概覽](./_概覽.md)

---

**最後更新：** 2025年10月27日



**端點：** `GET /api/v1/settings/holidays/:date/usage`  
**權限：** 管理員  
**最後更新：** 2025年10月27日

---

## 概述

查詢特定國定假日是否被工時記錄使用，以及使用次數和相關記錄。

---

## 請求

### 路徑參數

- `date` (必填, string): 國定假日日期，格式 `YYYY-MM-DD`

---

## 回應

### 成功回應（HTTP 200）

```json
{
  "success": true,
  "data": {
    "date": "2025-01-01",
    "is_in_use": true,
    "usage_count": 5,
    "usage_details": [
      {
        "log_id": 1001,
        "user_id": 123,
        "user_name": "王小明",
        "hours": 8.0,
        "work_day_type": "national_holiday",
        "created_at": "2025-01-02T10:00:00Z"
      },
      {
        "log_id": 1002,
        "user_id": 456,
        "user_name": "李小華",
        "hours": 4.0,
        "work_day_type": "national_holiday",
        "created_at": "2025-01-02T11:00:00Z"
      }
    ]
  }
}
```

---

### 未使用的國定假日

```json
{
  "success": true,
  "data": {
    "date": "2025-01-26",
    "is_in_use": false,
    "usage_count": 0,
    "usage_details": []
  }
}
```

---

### 錯誤回應

**404 Not Found - 找不到國定假日：**
```json
{
  "success": false,
  "error": {
    "code": "HOLIDAY_NOT_FOUND",
    "message": "找不到該日期的國定假日"
  }
}
```

---

## 使用場景

### 場景：刪除前檢查

在刪除國定假日前，前端先呼叫此 API 檢查使用情況：

```typescript
async function deleteHolidayWithCheck(date: string) {
  // 1. 檢查使用情況
  const usage = await api.get(`/api/v1/settings/holidays/${date}/usage`);
  
  if (usage.data.is_in_use) {
    // 2. 顯示警告對話框
    const confirmed = await showConfirmDialog(
      `該國定假日已被 ${usage.data.usage_count} 筆工時記錄使用，確定要刪除嗎？`
    );
    
    if (!confirmed) return;
  }
  
  // 3. 執行刪除
  await api.delete(`/api/v1/settings/holidays/${date}`);
}
```

---

## 後端查詢邏輯

```typescript
async function getHolidayUsage(date: string) {
  // 1. 檢查國定假日是否存在
  const holiday = await db.get(`
    SELECT * FROM Holidays WHERE date = ?
  `, [date]);
  
  if (!holiday) {
    throw new Error('HOLIDAY_NOT_FOUND');
  }
  
  // 2. 查詢工時記錄
  const usageDetails = await db.all(`
    SELECT 
      tl.log_id,
      tl.user_id,
      u.name AS user_name,
      tl.hours,
      tl.work_day_type,
      tl.created_at
    FROM TimeLogs tl
    JOIN Users u ON tl.user_id = u.user_id
    WHERE tl.work_date = ?
    ORDER BY tl.created_at DESC
  `, [date]);
  
  return {
    date,
    is_in_use: usageDetails.length > 0,
    usage_count: usageDetails.length,
    usage_details: usageDetails
  };
}
```

---

## 相關端點

- [刪除國定假日](./刪除國定假日.md)
- [獲取特定國定假日](./獲取特定國定假日.md)
- [API 概覽](./_概覽.md)

---

**最後更新：** 2025年10月27日



