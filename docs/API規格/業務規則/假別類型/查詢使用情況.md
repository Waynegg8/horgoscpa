# 查詢使用情況

**端點：** `GET /api/v1/settings/leave-types/:id/usage`  
**權限：** 管理員  
**最後更新：** 2025年10月27日

---

## 概述

查詢特定假別類型的使用情況，包含使用次數、使用者、總時數等統計資訊。

---

## 請求

### 路徑參數

- `id` (必填, integer): 假別類型 ID

---

## 回應

### 成功回應（HTTP 200）

```json
{
  "success": true,
  "data": {
    "leave_type_id": 1,
    "code": "sick_leave",
    "name": "病假",
    "is_in_use": true,
    "statistics": {
      "total_usage_count": 150,
      "total_hours": 1200,
      "total_users": 45,
      "recent_usage": [
        {
          "log_id": 5001,
          "user_id": 123,
          "user_name": "王小明",
          "hours": 8,
          "leave_date": "2025-10-25",
          "status": "approved",
          "created_at": "2025-10-24T10:00:00Z"
        },
        {
          "log_id": 5002,
          "user_id": 456,
          "user_name": "李小華",
          "hours": 4,
          "leave_date": "2025-10-26",
          "status": "approved",
          "created_at": "2025-10-25T09:00:00Z"
        }
      ],
      "monthly_trend": [
        {
          "year_month": "2025-08",
          "usage_count": 45,
          "total_hours": 360
        },
        {
          "year_month": "2025-09",
          "usage_count": 52,
          "total_hours": 416
        },
        {
          "year_month": "2025-10",
          "usage_count": 53,
          "total_hours": 424
        }
      ]
    }
  }
}
```

---

### 未使用的假別類型

```json
{
  "success": true,
  "data": {
    "leave_type_id": 10,
    "code": "volunteer_leave",
    "name": "志工假",
    "is_in_use": false,
    "statistics": {
      "total_usage_count": 0,
      "total_hours": 0,
      "total_users": 0,
      "recent_usage": [],
      "monthly_trend": []
    }
  }
}
```

---

### 錯誤回應

**404 Not Found - 找不到假別類型：**
```json
{
  "success": false,
  "error": {
    "code": "LEAVE_TYPE_NOT_FOUND",
    "message": "找不到指定的假別類型"
  }
}
```

---

## 使用場景

### 場景 1：停用前檢查

管理員想停用某假別類型前，先查看使用情況：

```typescript
async function deactivateLeaveTypeWithCheck(leaveTypeId: number) {
  // 1. 查詢使用情況
  const usage = await api.get(`/api/v1/settings/leave-types/${leaveTypeId}/usage`);
  
  if (usage.data.is_in_use) {
    // 2. 顯示警告
    const confirmed = await showConfirmDialog(
      `該假別已被 ${usage.data.statistics.total_users} 位員工使用，` +
      `共 ${usage.data.statistics.total_usage_count} 筆記錄，` +
      `確定要停用嗎？`
    );
    
    if (!confirmed) return;
  }
  
  // 3. 執行停用
  await api.delete(`/api/v1/settings/leave-types/${leaveTypeId}`);
}
```

---

### 場景 2：假別使用率分析

管理員查看各假別的使用趨勢，優化假別政策：

```
病假：使用率高（150次）→ 考慮增加額度
志工假：使用率低（0次）→ 考慮取消或調整
```

---

## 後端查詢邏輯

```typescript
async function getLeaveTypeUsage(leaveTypeId: number) {
  // 1. 基本統計
  const stats = await db.get(`
    SELECT 
      COUNT(*) AS total_usage_count,
      SUM(hours) AS total_hours,
      COUNT(DISTINCT user_id) AS total_users
    FROM TimeLogs
    WHERE leave_type_id = ?
  `, [leaveTypeId]);
  
  // 2. 最近使用記錄（最近10筆）
  const recentUsage = await db.all(`
    SELECT 
      tl.log_id,
      tl.user_id,
      u.name AS user_name,
      tl.hours,
      tl.work_date AS leave_date,
      tl.status,
      tl.created_at
    FROM TimeLogs tl
    JOIN Users u ON tl.user_id = u.user_id
    WHERE tl.leave_type_id = ?
    ORDER BY tl.created_at DESC
    LIMIT 10
  `, [leaveTypeId]);
  
  // 3. 月度趨勢（最近3個月）
  const monthlyTrend = await db.all(`
    SELECT 
      strftime('%Y-%m', work_date) AS year_month,
      COUNT(*) AS usage_count,
      SUM(hours) AS total_hours
    FROM TimeLogs
    WHERE leave_type_id = ?
      AND work_date >= date('now', '-3 months')
    GROUP BY year_month
    ORDER BY year_month
  `, [leaveTypeId]);
  
  return {
    is_in_use: stats.total_usage_count > 0,
    statistics: {
      ...stats,
      recent_usage: recentUsage,
      monthly_trend: monthlyTrend
    }
  };
}
```

---

## 相關端點

- [停用假別類型](./停用假別類型.md)
- [獲取特定假別類型](./獲取特定假別類型.md)
- [API 概覽](./_概覽.md)

---

**最後更新：** 2025年10月27日



**端點：** `GET /api/v1/settings/leave-types/:id/usage`  
**權限：** 管理員  
**最後更新：** 2025年10月27日

---

## 概述

查詢特定假別類型的使用情況，包含使用次數、使用者、總時數等統計資訊。

---

## 請求

### 路徑參數

- `id` (必填, integer): 假別類型 ID

---

## 回應

### 成功回應（HTTP 200）

```json
{
  "success": true,
  "data": {
    "leave_type_id": 1,
    "code": "sick_leave",
    "name": "病假",
    "is_in_use": true,
    "statistics": {
      "total_usage_count": 150,
      "total_hours": 1200,
      "total_users": 45,
      "recent_usage": [
        {
          "log_id": 5001,
          "user_id": 123,
          "user_name": "王小明",
          "hours": 8,
          "leave_date": "2025-10-25",
          "status": "approved",
          "created_at": "2025-10-24T10:00:00Z"
        },
        {
          "log_id": 5002,
          "user_id": 456,
          "user_name": "李小華",
          "hours": 4,
          "leave_date": "2025-10-26",
          "status": "approved",
          "created_at": "2025-10-25T09:00:00Z"
        }
      ],
      "monthly_trend": [
        {
          "year_month": "2025-08",
          "usage_count": 45,
          "total_hours": 360
        },
        {
          "year_month": "2025-09",
          "usage_count": 52,
          "total_hours": 416
        },
        {
          "year_month": "2025-10",
          "usage_count": 53,
          "total_hours": 424
        }
      ]
    }
  }
}
```

---

### 未使用的假別類型

```json
{
  "success": true,
  "data": {
    "leave_type_id": 10,
    "code": "volunteer_leave",
    "name": "志工假",
    "is_in_use": false,
    "statistics": {
      "total_usage_count": 0,
      "total_hours": 0,
      "total_users": 0,
      "recent_usage": [],
      "monthly_trend": []
    }
  }
}
```

---

### 錯誤回應

**404 Not Found - 找不到假別類型：**
```json
{
  "success": false,
  "error": {
    "code": "LEAVE_TYPE_NOT_FOUND",
    "message": "找不到指定的假別類型"
  }
}
```

---

## 使用場景

### 場景 1：停用前檢查

管理員想停用某假別類型前，先查看使用情況：

```typescript
async function deactivateLeaveTypeWithCheck(leaveTypeId: number) {
  // 1. 查詢使用情況
  const usage = await api.get(`/api/v1/settings/leave-types/${leaveTypeId}/usage`);
  
  if (usage.data.is_in_use) {
    // 2. 顯示警告
    const confirmed = await showConfirmDialog(
      `該假別已被 ${usage.data.statistics.total_users} 位員工使用，` +
      `共 ${usage.data.statistics.total_usage_count} 筆記錄，` +
      `確定要停用嗎？`
    );
    
    if (!confirmed) return;
  }
  
  // 3. 執行停用
  await api.delete(`/api/v1/settings/leave-types/${leaveTypeId}`);
}
```

---

### 場景 2：假別使用率分析

管理員查看各假別的使用趨勢，優化假別政策：

```
病假：使用率高（150次）→ 考慮增加額度
志工假：使用率低（0次）→ 考慮取消或調整
```

---

## 後端查詢邏輯

```typescript
async function getLeaveTypeUsage(leaveTypeId: number) {
  // 1. 基本統計
  const stats = await db.get(`
    SELECT 
      COUNT(*) AS total_usage_count,
      SUM(hours) AS total_hours,
      COUNT(DISTINCT user_id) AS total_users
    FROM TimeLogs
    WHERE leave_type_id = ?
  `, [leaveTypeId]);
  
  // 2. 最近使用記錄（最近10筆）
  const recentUsage = await db.all(`
    SELECT 
      tl.log_id,
      tl.user_id,
      u.name AS user_name,
      tl.hours,
      tl.work_date AS leave_date,
      tl.status,
      tl.created_at
    FROM TimeLogs tl
    JOIN Users u ON tl.user_id = u.user_id
    WHERE tl.leave_type_id = ?
    ORDER BY tl.created_at DESC
    LIMIT 10
  `, [leaveTypeId]);
  
  // 3. 月度趨勢（最近3個月）
  const monthlyTrend = await db.all(`
    SELECT 
      strftime('%Y-%m', work_date) AS year_month,
      COUNT(*) AS usage_count,
      SUM(hours) AS total_hours
    FROM TimeLogs
    WHERE leave_type_id = ?
      AND work_date >= date('now', '-3 months')
    GROUP BY year_month
    ORDER BY year_month
  `, [leaveTypeId]);
  
  return {
    is_in_use: stats.total_usage_count > 0,
    statistics: {
      ...stats,
      recent_usage: recentUsage,
      monthly_trend: monthlyTrend
    }
  };
}
```

---

## 相關端點

- [停用假別類型](./停用假別類型.md)
- [獲取特定假別類型](./獲取特定假別類型.md)
- [API 概覽](./_概覽.md)

---

**最後更新：** 2025年10月27日



