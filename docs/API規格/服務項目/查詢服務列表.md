# 查詢服務列表

**端點：** `GET /api/v1/services`  
**權限：** 需有 `service_management` 權限

---

## 請求

### 查詢參數
| 參數 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| `include_inactive` | boolean | ❌ | 是否包含停用的服務（預設：false）|

---

## 成功回應

**HTTP 狀態碼：** 200

```json
{
  "success": true,
  "data": [
    {
      "service_id": 1,
      "parent_service_id": null,
      "service_name": "記帳服務",
      "description": "雙月記帳標準服務",
      "sort_order": 0,
      "is_active": true,
      "created_by": 1,
      "created_by_name": "紜蓁",
      "created_at": "2025-01-01T00:00:00Z",
      "updated_at": "2025-01-01T00:00:00Z",
      "children": [
        {
          "service_id": 3,
          "parent_service_id": 1,
          "service_name": "收集憑證",
          "description": null,
          "sort_order": 0,
          "is_active": true,
          "created_by": 1,
          "created_by_name": "紜蓁",
          "created_at": "2025-01-02T00:00:00Z",
          "updated_at": "2025-01-02T00:00:00Z"
        },
        {
          "service_id": 4,
          "parent_service_id": 1,
          "service_name": "整理傳票",
          "description": null,
          "sort_order": 1,
          "is_active": true,
          "created_by": 1,
          "created_by_name": "紜蓁",
          "created_at": "2025-01-02T00:00:00Z",
          "updated_at": "2025-01-02T00:00:00Z"
        }
      ]
    },
    {
      "service_id": 2,
      "parent_service_id": null,
      "service_name": "工商登記服務",
      "description": null,
      "sort_order": 1,
      "is_active": true,
      "created_by": 1,
      "created_by_name": "紜蓁",
      "created_at": "2025-01-01T00:00:00Z",
      "updated_at": "2025-01-01T00:00:00Z",
      "children": []
    }
  ]
}
```

---

## 業務邏輯

### 層級結構
- 返回兩層結構：主項目 + 子項目
- 主項目的 `children` 陣列包含子項目
- 預設不包含停用的服務（`is_active = 0`）

### 排序規則
1. 主項目按 `sort_order` 升序
2. 相同 `sort_order` 按 `service_name` 升序
3. 子項目同樣規則

---

## 範例程式碼

```typescript
app.get('/api/v1/services', authMiddleware, checkPermission('service_management'), async (c) => {
  const { include_inactive } = c.req.query();
  
  let sql = `
    SELECT 
      s.service_id,
      s.parent_service_id,
      s.service_name,
      s.description,
      s.sort_order,
      s.is_active,
      s.created_by,
      u.name as created_by_name,
      s.created_at,
      s.updated_at
    FROM Services s
    LEFT JOIN Users u ON s.created_by = u.user_id
    WHERE s.is_deleted = 0
  `;
  
  if (!include_inactive) {
    sql += ' AND s.is_active = 1';
  }
  
  sql += ' ORDER BY s.sort_order ASC, s.service_name ASC';
  
  const services = await c.env.DB.prepare(sql).all();
  
  // 建立層級結構
  const tree = buildTree(services.results);
  
  return c.json(successResponse(tree));
});

function buildTree(flatList: any[]): any[] {
  const tree: any[] = [];
  const map = new Map<number, any>();
  
  flatList.forEach(item => {
    map.set(item.service_id, { ...item, children: [] });
  });
  
  map.forEach(item => {
    if (item.parent_service_id === null) {
      tree.push(item);
    } else {
      const parent = map.get(item.parent_service_id);
      if (parent) {
        parent.children.push(item);
      }
    }
  });
  
  return tree;
}
```

---

## 前端使用範例

```javascript
async function fetchServices() {
  const response = await fetch('/api/v1/services', {
    credentials: 'include'
  });
  const { data } = await response.json();
  
  // data 已經是層級結構
  console.log('主項目:', data);
  console.log('第一個主項目的子項目:', data[0].children);
}
```


