# 新增服務項目

**端點：** `POST /api/v1/services`  
**權限：** 管理員或有 `service_management` 權限

---

## 請求

### Body
```json
{
  "parent_service_id": null,
  "service_name": "記帳服務",
  "description": "雙月記帳標準服務",
  "sort_order": 0
}
```

### 欄位說明
| 欄位 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| `parent_service_id` | integer \| null | ✅ | 父項目ID，`null` = 主項目 |
| `service_name` | string | ✅ | 服務名稱（1-100字元）|
| `description` | string | ❌ | 服務說明 |
| `sort_order` | integer | ❌ | 排序順序（預設0）|

---

## 成功回應

**HTTP 狀態碼：** 201

```json
{
  "success": true,
  "data": {
    "service_id": 5,
    "message": "服務項目新增成功"
  }
}
```

---

## 錯誤回應

### 服務名稱已存在
**HTTP 狀態碼：** 409
```json
{
  "success": false,
  "error": {
    "code": "DUPLICATE_SERVICE_NAME",
    "message": "服務名稱已存在"
  }
}
```

### 不允許三層結構
**HTTP 狀態碼：** 400
```json
{
  "success": false,
  "error": {
    "code": "INVALID_HIERARCHY",
    "message": "不允許三層結構，子項目不能再有子項目"
  }
}
```

### 驗證錯誤
**HTTP 狀態碼：** 422
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "服務名稱不可為空"
  }
}
```

---

## 業務邏輯

### 驗證規則
1. **服務名稱**：1-100字元，不可為空
2. **唯一性**：
   - 主項目名稱全局唯一
   - 同一主項目下子項目名稱唯一
3. **層級限制**：不允許三層結構

### 處理流程
1. 驗證層級結構
2. 驗證唯一性
3. 驗證欄位
4. 插入資料庫
5. 返回新服務ID

---

## 範例程式碼

```typescript
app.post('/api/v1/services', 
  authMiddleware, 
  checkPermission('service_management'), 
  async (c) => {
    const input = await c.req.json();
    const userId = c.get('user').user_id;
    
    // 1. 驗證層級
    if (input.parent_service_id) {
      const parent = await c.env.DB.prepare(
        'SELECT parent_service_id FROM Services WHERE service_id = ?'
      ).bind(input.parent_service_id).first();
      
      if (parent && parent.parent_service_id !== null) {
        return c.json(
          errorResponse('INVALID_HIERARCHY', '不允許三層結構'), 
          400
        );
      }
    }
    
    // 2. 驗證唯一性
    let uniqueCheck;
    if (input.parent_service_id === null) {
      uniqueCheck = await c.env.DB.prepare(`
        SELECT COUNT(*) as count FROM Services 
        WHERE parent_service_id IS NULL 
          AND service_name = ? 
          AND is_deleted = 0
      `).bind(input.service_name).first();
    } else {
      uniqueCheck = await c.env.DB.prepare(`
        SELECT COUNT(*) as count FROM Services 
        WHERE parent_service_id = ? 
          AND service_name = ? 
          AND is_deleted = 0
      `).bind(input.parent_service_id, input.service_name).first();
    }
    
    if (uniqueCheck.count > 0) {
      return c.json(
        errorResponse('DUPLICATE_SERVICE_NAME', '服務名稱已存在'), 
        409
      );
    }
    
    // 3. 插入資料
    const result = await c.env.DB.prepare(`
      INSERT INTO Services (
        parent_service_id, service_name, description, 
        sort_order, created_by
      )
      VALUES (?, ?, ?, ?, ?)
    `).bind(
      input.parent_service_id,
      input.service_name,
      input.description || null,
      input.sort_order || 0,
      userId
    ).run();
    
    return c.json(successResponse({
      service_id: result.meta.last_row_id,
      message: '服務項目新增成功'
    }), 201);
  }
);
```


