# 更新服務項目

**端點：** `PUT /api/v1/services/:service_id`  
**權限：** 管理員或有 `service_management` 權限

---

## 請求

### 路徑參數
| 參數 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| `service_id` | integer | ✅ | 服務項目ID |

### Body
```json
{
  "service_name": "會計記帳服務",
  "description": "包含雙月記帳及稅務申報",
  "sort_order": 1
}
```

**說明：**
- 只需傳送要更新的欄位
- `parent_service_id` 不可更新
- 未提供的欄位保持原值

---

## 成功回應

**HTTP 狀態碼：** 200

```json
{
  "success": true,
  "data": {
    "message": "服務項目更新成功"
  }
}
```

---

## 錯誤回應

### 服務項目不存在
**HTTP 狀態碼：** 404
```json
{
  "success": false,
  "error": {
    "code": "SERVICE_NOT_FOUND",
    "message": "服務項目不存在"
  }
}
```

### 服務名稱已存在
**HTTP 狀態碼：** 409
```json
{
  "success": false,
  "error": {
    "code": "DUPLICATE_SERVICE_NAME",
    "message": "服務名稱已存在"
  }
}
```

---

## 業務邏輯

### 可更新欄位
- `service_name`
- `description`
- `sort_order`
- `is_active`

### 不可更新欄位
- `service_id`（主鍵）
- `parent_service_id`（層級關係）
- `created_by`
- `created_at`

### 驗證規則
1. 服務項目必須存在
2. 若修改名稱，驗證唯一性
3. 名稱長度：1-100字元

---

## 範例程式碼

```typescript
app.put('/api/v1/services/:service_id', 
  authMiddleware, 
  checkPermission('service_management'), 
  async (c) => {
    const serviceId = parseInt(c.req.param('service_id'));
    const input = await c.req.json();
    
    // 1. 檢查是否存在
    const existing = await c.env.DB.prepare(
      'SELECT * FROM Services WHERE service_id = ? AND is_deleted = 0'
    ).bind(serviceId).first();
    
    if (!existing) {
      return c.json(
        errorResponse('SERVICE_NOT_FOUND', '服務項目不存在'), 
        404
      );
    }
    
    // 2. 若修改名稱，驗證唯一性
    if (input.service_name && input.service_name !== existing.service_name) {
      let uniqueCheck;
      if (existing.parent_service_id === null) {
        uniqueCheck = await c.env.DB.prepare(`
          SELECT COUNT(*) as count FROM Services 
          WHERE parent_service_id IS NULL 
            AND service_name = ? 
            AND service_id != ?
            AND is_deleted = 0
        `).bind(input.service_name, serviceId).first();
      } else {
        uniqueCheck = await c.env.DB.prepare(`
          SELECT COUNT(*) as count FROM Services 
          WHERE parent_service_id = ? 
            AND service_name = ? 
            AND service_id != ?
            AND is_deleted = 0
        `).bind(existing.parent_service_id, input.service_name, serviceId).first();
      }
      
      if (uniqueCheck.count > 0) {
        return c.json(
          errorResponse('DUPLICATE_SERVICE_NAME', '服務名稱已存在'), 
          409
        );
      }
    }
    
    // 3. 更新資料
    await c.env.DB.prepare(`
      UPDATE Services 
      SET 
        service_name = COALESCE(?, service_name),
        description = COALESCE(?, description),
        sort_order = COALESCE(?, sort_order),
        is_active = COALESCE(?, is_active),
        updated_at = datetime('now')
      WHERE service_id = ?
    `).bind(
      input.service_name,
      input.description,
      input.sort_order,
      input.is_active,
      serviceId
    ).run();
    
    return c.json(successResponse({ message: '服務項目更新成功' }));
  }
);
```


