# 刪除服務項目

**端點：** `DELETE /api/v1/services/:service_id`  
**權限：** 管理員或有 `service_management` 權限

---

## 請求

### 路徑參數
| 參數 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| `service_id` | integer | ✅ | 服務項目ID |

---

## 成功回應

**HTTP 狀態碼：** 200

```json
{
  "success": true,
  "data": {
    "message": "服務項目刪除成功",
    "deleted_count": 3
  }
}
```

**說明：**
- `deleted_count`: 實際刪除的項目數（主項目=1，若有子項目則會更多）

---

## 錯誤回應

### 服務項目不存在
**HTTP 狀態碼：** 404
```json
{
  "success": false,
  "error": {
    "code": "SERVICE_NOT_FOUND",
    "message": "服務項目不存在"
  }
}
```

### 服務項目已被使用
**HTTP 狀態碼：** 409
```json
{
  "success": false,
  "error": {
    "code": "SERVICE_IN_USE",
    "message": "此服務項目已被使用，無法刪除",
    "details": {
      "client_services": 5,
      "time_logs": 120,
      "task_templates": 2
    }
  }
}
```

---

## 業務邏輯

### 刪除方式
- **軟刪除**：設定 `is_deleted = 1`
- 不實際刪除資料庫記錄

### 刪除前檢查
必須檢查以下依賴：
1. `ClientServices` - 客戶服務設定
2. `TimeLogs` - 工時記錄
3. `TaskTemplates` - 任務模板

若任一依賴存在，**禁止刪除**。

### 級聯刪除
- 若刪除主項目，同時軟刪除所有子項目
- 刪除前會先檢查所有子項目的依賴

---

## 範例程式碼

```typescript
app.delete('/api/v1/services/:service_id', 
  authMiddleware, 
  checkPermission('service_management'), 
  async (c) => {
    const serviceId = parseInt(c.req.param('service_id'));
    const userId = c.get('user').user_id;
    
    // 1. 檢查是否存在
    const service = await c.env.DB.prepare(
      'SELECT * FROM Services WHERE service_id = ? AND is_deleted = 0'
    ).bind(serviceId).first();
    
    if (!service) {
      return c.json(
        errorResponse('SERVICE_NOT_FOUND', '服務項目不存在'), 
        404
      );
    }
    
    // 2. 獲取所有相關ID（包含子項目）
    let serviceIds = [serviceId];
    if (service.parent_service_id === null) {
      const children = await c.env.DB.prepare(
        'SELECT service_id FROM Services WHERE parent_service_id = ? AND is_deleted = 0'
      ).bind(serviceId).all();
      serviceIds.push(...children.results.map(c => c.service_id));
    }
    
    // 3. 檢查依賴
    const dependencies = {
      client_services: 0,
      time_logs: 0,
      task_templates: 0
    };
    
    for (const id of serviceIds) {
      const clientServices = await c.env.DB.prepare(
        'SELECT COUNT(*) as count FROM ClientServices WHERE service_id = ? AND is_deleted = 0'
      ).bind(id).first();
      dependencies.client_services += clientServices.count;
      
      const timeLogs = await c.env.DB.prepare(
        'SELECT COUNT(*) as count FROM TimeLogs WHERE service_id = ? AND is_deleted = 0'
      ).bind(id).first();
      dependencies.time_logs += timeLogs.count;
      
      const taskTemplates = await c.env.DB.prepare(
        'SELECT COUNT(*) as count FROM TaskTemplates WHERE service_template_id = ? AND is_deleted = 0'
      ).bind(id).first();
      dependencies.task_templates += taskTemplates.count;
    }
    
    const totalDependencies = 
      dependencies.client_services + 
      dependencies.time_logs + 
      dependencies.task_templates;
    
    if (totalDependencies > 0) {
      return c.json(
        errorResponse('SERVICE_IN_USE', '此服務項目已被使用，無法刪除', dependencies), 
        409
      );
    }
    
    // 4. 執行軟刪除
    const placeholders = serviceIds.map(() => '?').join(',');
    await c.env.DB.prepare(`
      UPDATE Services 
      SET is_deleted = 1, deleted_at = datetime('now'), deleted_by = ?
      WHERE service_id IN (${placeholders})
    `).bind(userId, ...serviceIds).run();
    
    return c.json(successResponse({ 
      message: '服務項目刪除成功',
      deleted_count: serviceIds.length
    }));
  }
);
```

---

## 前端使用範例

```javascript
async function deleteService(serviceId) {
  if (!confirm('確定要刪除此服務項目嗎？')) return;
  
  try {
    const response = await fetch(`/api/v1/services/${serviceId}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    
    const result = await response.json();
    
    if (!result.success) {
      if (result.error.code === 'SERVICE_IN_USE') {
        alert(`無法刪除：\n` +
          `- 客戶服務：${result.error.details.client_services} 筆\n` +
          `- 工時記錄：${result.error.details.time_logs} 筆\n` +
          `- 任務模板：${result.error.details.task_templates} 筆`
        );
      } else {
        alert(result.error.message);
      }
      return;
    }
    
    alert(`刪除成功（共 ${result.data.deleted_count} 個項目）`);
    await refreshServiceList();
  } catch (error) {
    console.error('刪除失敗', error);
  }
}
```


