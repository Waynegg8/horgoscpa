# ç³»çµ±è¨­è¨ˆèªªæ˜ï¼šæœå‹™èˆ‡è¨ˆè²»çµæ§‹

## ğŸ“‹ æ•¸æ“šçµæ§‹é—œä¿‚

### 1. ClientServicesï¼ˆå®¢æˆ¶æœå‹™ï¼‰
å®¢æˆ¶è¨‚é–±çš„ä¸»æœå‹™ï¼Œä¾‹å¦‚ï¼š"è¨˜å¸³æœå‹™åŒ…"

**é‡è¦æ¬„ä½ï¼š**
- `client_service_id` - æœå‹™ID
- `service_id` - æœå‹™é¡å‹ï¼ˆè¨˜å¸³ã€ç¨…å‹™ã€é¡§å•ç­‰ï¼‰
- `status` - ç‹€æ…‹ï¼ˆä½¿ç”¨ä¸­ã€æš«åœã€å·²å–æ¶ˆç­‰ï¼‰
- `start_date` - é–‹å§‹æ—¥æœŸ
- ~~`service_cycle`~~ - **å·²å»¢æ£„** ä¸å†ä½¿ç”¨

**å¹´åº¦ç¸½é¡è¨ˆç®—ï¼š**
- `year_total` = SUM(ServiceBillingSchedule.billing_amount) WHERE client_service_id = x
- å³ï¼šæ‰€æœ‰æœˆä»½æ”¶è²»çš„ç¸½å’Œ

---

### 2. ServiceComponentsï¼ˆæœå‹™çµ„æˆéƒ¨åˆ†ï¼‰
ä¸»æœå‹™åŒ…å«çš„å…·é«”å­æœå‹™ï¼Œæ¯å€‹å¯ä»¥ç¨ç«‹é…ç½®æä¾›é »ç‡

**é‡è¦æ¬„ä½ï¼š**
- `component_id` - çµ„æˆéƒ¨åˆ†ID
- `client_service_id` - æ‰€å±¬ä¸»æœå‹™
- `service_id` - æœå‹™é¡å‹
- `component_name` - ä¾‹å¦‚ï¼š"æœˆåº¦è¨˜å¸³"ã€"ç‡Ÿæ¥­ç¨…ç”³å ±"
- `delivery_frequency` - æä¾›é »ç‡ï¼ˆmonthly, bi-monthly, quarterly, yearly, one-timeï¼‰
- `auto_generate_task` - æ˜¯å¦è‡ªå‹•ç”Ÿæˆä»»å‹™
- `advance_days` - æå‰å¹¾å¤©ç”Ÿæˆä»»å‹™

**ç¯„ä¾‹ï¼š**
```
å®¢æˆ¶è¨‚é–±"è¨˜å¸³æœå‹™åŒ…" (ClientServices)
  â”œâ”€ æœˆåº¦è¨˜å¸³ (ServiceComponent, frequency: monthly)
  â”œâ”€ ç‡Ÿæ¥­ç¨…ç”³å ± (ServiceComponent, frequency: bi-monthly)
  â””â”€ ç‡Ÿæ‰€ç¨…ç”³å ± (ServiceComponent, frequency: yearly)
```

---

### 3. ServiceBillingScheduleï¼ˆæ”¶è²»æ˜ç´°ï¼‰
è¨˜éŒ„æ¯å€‹æœˆçš„æ”¶è²»é‡‘é¡

**é‡è¦æ¬„ä½ï¼š**
- `schedule_id` - æ˜ç´°ID
- `client_service_id` - æ‰€å±¬æœå‹™
- `billing_month` - æœˆä»½ï¼ˆ1-12ï¼‰
- `billing_amount` - è©²æœˆæ”¶è²»é‡‘é¡
- `payment_due_days` - ä»˜æ¬¾æœŸé™ï¼ˆå¤©æ•¸ï¼‰

**ç¯„ä¾‹ï¼š**
```
å®¢æˆ¶æœå‹™ID 123 çš„æ”¶è²»æ˜ç´°ï¼š
  - 1æœˆ: $2,000
  - 2æœˆ: $2,000
  - 3æœˆ: $5,000 (å«å­£åº¦ç¨…å‹™ç”³å ±)
  - ...
  - å¹´åº¦ç¸½é¡ = $30,000
```

---

### 4. TaskTemplateStagesï¼ˆä»»å‹™æ¨¡æ¿éšæ®µï¼‰
å®šç¾©æ¯å€‹ç¨ç«‹ä»»å‹™çš„è©³ç´°é…ç½®

**é‡è¦æ¬„ä½ï¼š**
- `stage_id` - éšæ®µID
- `template_id` - æ‰€å±¬æ¨¡æ¿
- `stage_name` - ä»»å‹™åç¨±
- `stage_order` - é †åº
- `estimated_hours` - é ä¼°å·¥æ™‚
- `due_date_rule` - æœŸé™è¦å‰‡ï¼ˆend_of_month, specific_day, next_month_day, days_after_startï¼‰
- `due_date_value` - æ—¥æœŸ/å¤©æ•¸å€¼
- `advance_days` - æå‰ç”Ÿæˆå¤©æ•¸

**ç¯„ä¾‹ï¼š**
```
"æœˆåº¦è¨˜å¸³æœå‹™"æ¨¡æ¿çš„ä»»å‹™ï¼š
  1. æ”¶é›†æ†‘è­‰ (æ¯æœˆ5æ—¥åˆ°æœŸ, 3å¤©å‰ç”Ÿæˆ)
  2. æ•´ç†åˆ†é¡ (æ¯æœˆ10æ—¥åˆ°æœŸ, 3å¤©å‰ç”Ÿæˆ)
  3. å¸³å‹™éŒ„å…¥ (æ¯æœˆ20æ—¥åˆ°æœŸ, 5å¤©å‰ç”Ÿæˆ)
  4. æ ¸å°èª¿æ•´ (æ¯æœˆ28æ—¥åˆ°æœŸ, 3å¤©å‰ç”Ÿæˆ)
  5. ç”¢å‡ºå ±è¡¨ (æœˆåº•åˆ°æœŸ, 3å¤©å‰ç”Ÿæˆ)
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### æœå‹™é…ç½®æµç¨‹ï¼š

1. **å»ºç«‹å®¢æˆ¶æœå‹™** â†’ ClientServices
2. **é…ç½®æœå‹™å…§å®¹** â†’ ServiceComponentsï¼ˆå¯é¸æ“‡æ¨¡æ¿æˆ–æ‰‹å‹•é…ç½®ï¼‰
3. **è¨­å®šæ”¶è²»æ˜ç´°** â†’ ServiceBillingSchedule
4. **è‡ªå‹•ç”Ÿæˆä»»å‹™** â†’ ç³»çµ±æ ¹æ“š ServiceComponents å’Œ TaskTemplateStages é…ç½®è‡ªå‹•ç”Ÿæˆ ActiveTasks

### ä»»å‹™ç”Ÿæˆé‚è¼¯ï¼š

```
æ¯å¤©åŸ·è¡Œè‡ªå‹•ä»»å‹™ç”Ÿæˆï¼š
  FOR EACH ServiceComponent WHERE auto_generate_task = 1:
    IF ç•¶å‰æ—¥æœŸ >= (ä»»å‹™åŸ·è¡Œæ—¥ - advance_days):
      æ ¹æ“š delivery_frequency åˆ¤æ–·æ˜¯å¦è©²ç”Ÿæˆ
      æ ¹æ“š task_template_id å–å¾—æ¨¡æ¿éšæ®µ
      FOR EACH TaskTemplateStage:
        ç”Ÿæˆä¸€å€‹ ActiveTask
          - task_name = stage_name
          - due_date = æ ¹æ“š due_date_rule è¨ˆç®—
          - estimated_hours = stage.estimated_hours
```

---

## ğŸ’° å¹´åº¦ç¸½é¡è¨ˆç®—

### æ­£ç¢ºçš„è¨ˆç®—æ–¹å¼ï¼š

```sql
SELECT 
  SUM(billing_amount) as year_total
FROM ServiceBillingSchedule
WHERE client_service_id = ?
```

### å‰ç«¯é¡¯ç¤ºï¼š
- å®¢æˆ¶æœå‹™åˆ—è¡¨ä¸­çš„"å¹´åº¦ç¸½é¡"æ¬„ä½
- å¾ ServiceBillingSchedule æ‰€æœ‰æœˆä»½çš„ç¸½å’Œè¨ˆç®—
- å³ä½¿ä¸åŒæœˆä»½é‡‘é¡ä¸åŒï¼ˆä¾‹å¦‚æŸäº›æœˆä»½æœ‰é¡å¤–æœå‹™ï¼‰ä¹Ÿèƒ½æ­£ç¢ºåæ˜ 

---

## âš ï¸ é‡è¦è®Šæ›´èªªæ˜

### service_cycle å­—æ®µå·²å»¢æ£„

**åŸå› ï¼š**
- ä¸åŒçš„å­æœå‹™å¯èƒ½æœ‰ä¸åŒçš„æä¾›é »ç‡
- ä¾‹å¦‚ï¼šæœˆåº¦è¨˜å¸³ï¼ˆmonthlyï¼‰+ ç‡Ÿæ¥­ç¨…ç”³å ±ï¼ˆbi-monthlyï¼‰+ ç‡Ÿæ‰€ç¨…ç”³å ±ï¼ˆyearlyï¼‰
- å–®ä¸€çš„ service_cycle ç„¡æ³•è¡¨é”é€™ç¨®è¤‡é›œçµæ§‹

**æ–°è¨­è¨ˆï¼š**
- ClientServices ä¸å†éœ€è¦ service_cycle
- æ¯å€‹ ServiceComponent æœ‰è‡ªå·±çš„ delivery_frequency
- æ›´éˆæ´»ã€æ›´ç²¾ç¢º

**æ•¸æ“šé·ç§»ï¼š**
- service_cycle å­—æ®µä¿ç•™åœ¨æ•¸æ“šåº«ä¸­ï¼ˆSQLiteä¸æ”¯æŒåˆªé™¤åˆ—ï¼‰
- å‰ç«¯å’Œå¾Œç«¯ API å·²ç¶“ä¸å†ä½¿ç”¨æ­¤å­—æ®µ
- èˆŠæ•¸æ“šä¸å—å½±éŸ¿

---

## ğŸ“Š æ•¸æ“šä¸€è‡´æ€§æª¢æŸ¥

### ç¢ºä¿æ•¸æ“šå®Œæ•´æ€§ï¼š

1. æ¯å€‹æ´»èºçš„ ClientServices æ‡‰è©²è‡³å°‘æœ‰ä¸€å€‹ ServiceComponent
2. æ¯å€‹ ServiceComponent å¦‚æœå•Ÿç”¨ auto_generate_taskï¼Œæ‡‰è©²é—œè¯ä¸€å€‹æœ‰æ•ˆçš„ TaskTemplate
3. ServiceBillingSchedule çš„æœˆä»½æ”¶è²»ç¸½å’Œæ‡‰è©²ç­‰æ–¼é¡¯ç¤ºçš„å¹´åº¦ç¸½é¡

### é©—è­‰æŸ¥è©¢ï¼š

```sql
-- æª¢æŸ¥ç¼ºå°‘ServiceComponentsçš„å®¢æˆ¶æœå‹™
SELECT cs.* 
FROM ClientServices cs
LEFT JOIN ServiceComponents sc ON cs.client_service_id = sc.client_service_id
WHERE cs.status = 'active' 
  AND sc.component_id IS NULL;

-- é©—è­‰å¹´åº¦ç¸½é¡è¨ˆç®—
SELECT 
  cs.client_service_id,
  cs.service_name,
  SUM(sbs.billing_amount) as calculated_total,
  -- èˆ‡å‰ç«¯é¡¯ç¤ºæ¯”å°
FROM ClientServices cs
LEFT JOIN ServiceBillingSchedule sbs ON cs.client_service_id = sbs.client_service_id
GROUP BY cs.client_service_id;
```

---

## ğŸ¯ ç¸½çµ

### æ ¸å¿ƒè¨­è¨ˆåŸå‰‡ï¼š

1. **åˆ†å±¤çµæ§‹** - ClientServices â†’ ServiceComponents â†’ Tasks
2. **éˆæ´»é…ç½®** - æ¯å€‹çµ„æˆéƒ¨åˆ†ç¨ç«‹é…ç½®æä¾›é »ç‡å’Œä»»å‹™æœŸé™
3. **ç²¾ç¢ºè¨ˆè²»** - æŒ‰æœˆè¨­å®šæ”¶è²»ï¼Œæ”¯æŒä¸åŒæœˆä»½ä¸åŒé‡‘é¡
4. **è‡ªå‹•åŒ–** - ç³»çµ±è‡ªå‹•ç”Ÿæˆä»»å‹™ï¼Œæ¸›å°‘æ‰‹å‹•æ“ä½œ

### å„ªå‹¢ï¼š

- âœ… æ”¯æŒè¤‡é›œçš„æœå‹™çµ„åˆ
- âœ… ç²¾ç¢ºçš„æˆæœ¬å’Œæ”¶å…¥è¿½è¹¤
- âœ… è‡ªå‹•åŒ–ä»»å‹™ç”Ÿæˆ
- âœ… éˆæ´»çš„æœŸé™ç®¡ç†
- âœ… æ¸…æ™°çš„æ•¸æ“šçµæ§‹

---

**æ–‡æª”ç‰ˆæœ¬ï¼š** 1.0  
**æœ€å¾Œæ›´æ–°ï¼š** 2025-11-01  
**ç¶­è­·è€…ï¼š** ç³»çµ±é–‹ç™¼åœ˜éšŠ

