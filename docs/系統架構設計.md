# 霍爾果斯會計師事務所 - 系統架構設計

**版本**: 2.0  
**最後更新**: 2025-10-26

---

## 📋 系統概述

### 系統定位
內部管理系統，提供會計師事務所日常營運所需的各項功能，包含工時管理、客戶管理、任務管理、知識管理等。

### 技術架構
```
前端: HTML + CSS + JavaScript (Vanilla JS)
後端: Cloudflare Workers (JavaScript)
資料庫: Cloudflare D1 (SQLite)
部署: Cloudflare Pages + Workers
```

### 系統特點
- 🌐 完全雲端化，無需自建伺服器
- 📱 響應式設計，支援桌面與行動裝置
- 🔐 基於 Token 的身份驗證
- 📊 即時資料同步
- 🚀 自動化任務生成

---

## 🏗️ 系統架構圖

```
┌─────────────────────────────────────────────────────┐
│                    前端層 (HTML/CSS/JS)               │
├─────────────────────────────────────────────────────┤
│  工作台  │ 任務管理 │ 工時記錄 │ 專案管理 │ 知識庫  │
│  報表    │ 客戶管理 │ SOP管理  │ 內容編輯 │ 設定    │
└─────────────────────────────────────────────────────┘
                         ↕ HTTPS/REST API
┌─────────────────────────────────────────────────────┐
│              後端層 (Cloudflare Workers)              │
├─────────────────────────────────────────────────────┤
│  認證授權  │  業務邏輯   │  資料驗證  │  錯誤處理   │
│  API路由   │  自動化任務 │  報表生成  │  檔案處理   │
└─────────────────────────────────────────────────────┘
                         ↕ SQL
┌─────────────────────────────────────────────────────┐
│              資料庫層 (Cloudflare D1)                 │
├─────────────────────────────────────────────────────┤
│  使用者  │  客戶    │  任務    │  工時    │  專案   │
│  SOP    │  報表快取 │  媒體庫  │  CMS     │  排程   │
└─────────────────────────────────────────────────────┘
```

---

## 🎯 核心功能模組

### 1. 使用者與權限管理
**頁面**: `login.html`, `change-password.html`  
**模組**: `src/auth.js`  
**功能**: 登入/登出、Session 管理、角色權限控制  
**資料表**: `users`, `sessions`  
**設計文檔**: [開發與部署指南.md](./開發與部署指南.md) (安全規範章節)

### 2. 統一任務管理系統 ⭐
**頁面**: `tasks.html` (7個標籤統一管理)  
**模組**: `src/multi-stage-tasks.js`, `src/recurring-tasks.js`, `src/automated-tasks.js`  
**功能**: 
- 全部任務、我的任務
- 周期任務自動生成
- 工商登記任務、財稅簽證任務
- 客戶服務自動化任務
- 服務配置管理

**資料表**: `tasks`, `multi_stage_tasks`, `task_stages`, `multi_stage_templates`, `template_stages`, `recurring_task_templates`, `recurring_task_instances`, `client_services`, `service_checklist_templates`, `task_execution_log`, `task_generation_log`

**設計文檔**: [任務管理系統設計.md](./任務管理系統設計.md) + [客戶服務自動化系統設計.md](./客戶服務自動化系統設計.md)

**廢棄頁面**: ~~multi-stage-tasks.html~~, ~~recurring-tasks.html~~, ~~service-config.html~~ (已整合到 tasks.html)

### 3. 工時管理系統
**頁面**: `timesheet.html`  
**模組**: API 端點內建於 `src/index.js`  
**功能**: 工時記錄、加班管理、請假申請、年假試算  
**資料表**: `employees`, `timesheets`, `leave_events`, `annual_leave_rules`, `annual_leave_carryover`, `overtime_rates`, `holidays`, `leave_types`  
**設計文檔**: [工時管理系統設計.md](./工時管理系統設計.md)

### 4. 客戶管理系統
**頁面**: `settings.html` (客戶管理標籤)  
**模組**: `src/clients.js`  
**功能**: 客戶資料 CRUD、服務配置、互動記錄  
**資料表**: `clients`, `client_services`, `client_interactions`, `client_assignments`  
**設計文檔**: [客戶管理系統設計.md](./客戶管理系統設計.md)

### 5. 知識庫系統
**頁面**: `knowledge.html` (SOP+內部文檔+FAQ 三個標籤)  
**模組**: `src/sop.js`  
**功能**: SOP 管理、內部文檔、FAQ、版本控制、搜尋  
**資料表**: `sop_categories`, `sops`, `sop_versions`  
**設計文檔**: [知識庫系統設計.md](./知識庫系統設計.md)  
**廢棄頁面**: ~~sop.html~~ (如與 knowledge.html 重複)

### 6. 報表系統
**頁面**: `reports.html`  
**模組**: `src/reports.js`  
**功能**: 年假報表、工時分析、樞紐分析、報表快取  
**資料表**: `report_cache`  
**設計文檔**: [報表系統設計.md](./報表系統設計.md)

### 7. 內容管理系統 (CMS)
**頁面**: `content-editor.html`, `blog.html`, `resources.html`  
**模組**: `src/cms.js`, `src/media.js`  
**功能**: 部落格管理、資源管理、媒體庫  
**資料表**: `posts`, `media_library`  
**設計文檔**: [內容管理系統設計.md](./內容管理系統設計.md)

### 8. 系統設定與工作台
**頁面**: `settings.html` (員工/系統參數/範本標籤), `dashboard.html`  
**模組**: `src/index.js`  
**功能**: 員工管理、系統參數、工作台儀表板、通知  
**資料表**: `employees`, `system_parameters`, `task_reminders`  
**設計文檔**: [系統設定與工作台設計.md](./系統設定與工作台設計.md)

---

### ⚠️ 資料表整合說明

**專案管理相關資料表**：
- `projects`, `project_tasks`, `project_checklist` 資料表目前存在於資料庫中
- 但功能已整合到統一任務系統（category = 'project'）
- 這些資料表可能：
  - 選項 1：未來遷移資料後廢棄
  - 選項 2：作為大型專案的輔助資訊（預算、成本追蹤等）
  - 選項 3：完全廢棄，使用 tasks 表的擴展欄位

**頁面狀態**：
- `projects.html` 目前仍存在但應該廢棄或整合到 `tasks.html`

---

## 🗄️ 資料庫完整架構

### 核心資料表

#### users (使用者)
```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  role TEXT NOT NULL,                -- 'admin' 或 'employee'
  employee_name TEXT,
  is_active INTEGER DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### clients (客戶)
```sql
CREATE TABLE clients (
  name TEXT PRIMARY KEY              -- 目前使用客戶名稱為主鍵
);
```
**注意**: 簡化結構，未來可能需要擴展為完整的客戶資料表。

#### tasks (任務)
```sql
CREATE TABLE tasks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  description TEXT,
  status TEXT DEFAULT 'pending',     -- pending, in_progress, completed, cancelled
  priority TEXT DEFAULT 'medium',    -- low, medium, high
  due_date DATETIME,
  assigned_user TEXT,
  created_by TEXT,
  category TEXT,                     -- client_service, recurring, business, finance
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 多階段任務相關

#### multi_stage_tasks (多階段任務)
```sql
CREATE TABLE multi_stage_tasks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  task_id INTEGER NOT NULL UNIQUE,
  total_stages INTEGER NOT NULL,
  completed_stages INTEGER DEFAULT 0,
  overall_progress INTEGER DEFAULT 0,
  current_stage INTEGER DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
);
```

#### task_stages (任務階段)
```sql
CREATE TABLE task_stages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  multi_stage_task_id INTEGER NOT NULL,
  stage_order INTEGER NOT NULL,
  stage_name TEXT NOT NULL,
  stage_description TEXT,
  status TEXT DEFAULT 'pending',
  checklist TEXT,                    -- JSON 格式
  estimated_hours DECIMAL(5,2),
  actual_hours DECIMAL(5,2),
  assigned_to TEXT,
  completed_by TEXT,
  completed_at DATETIME,
  notes TEXT,
  requires_approval BOOLEAN DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (multi_stage_task_id) REFERENCES multi_stage_tasks(id) ON DELETE CASCADE
);
```

### 客戶服務自動化相關

#### client_services (客戶服務配置)
```sql
CREATE TABLE client_services (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id INTEGER NOT NULL,
  service_type TEXT NOT NULL,        -- accounting, vat, income_tax, etc.
  frequency TEXT NOT NULL,           -- monthly, bimonthly, quarterly, etc.
  fee DECIMAL(10,2) DEFAULT 0,
  estimated_hours DECIMAL(5,2) DEFAULT 0,
  assigned_to INTEGER,
  backup_assignee INTEGER,
  start_month INTEGER,               -- 開始月份
  execution_day INTEGER,             -- 每月執行日
  advance_days INTEGER DEFAULT 7,   -- 提前生成天數
  due_days INTEGER DEFAULT 15,      -- 任務期限天數
  invoice_count INTEGER DEFAULT 0,
  difficulty_level INTEGER,          -- 1-5
  is_active BOOLEAN DEFAULT 1,
  notes TEXT,
  special_requirements TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  last_generated_at DATETIME,
  FOREIGN KEY (assigned_to) REFERENCES users(id)
);
```

#### service_checklist_templates (服務檢查清單範本)
```sql
CREATE TABLE service_checklist_templates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  service_type TEXT NOT NULL,
  template_name TEXT NOT NULL,
  version INTEGER DEFAULT 1,
  checklist_data TEXT NOT NULL,     -- JSON 格式
  is_active BOOLEAN DEFAULT 1,
  is_default BOOLEAN DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  created_by INTEGER,
  FOREIGN KEY (created_by) REFERENCES users(id)
);
```

#### task_execution_log (任務執行記錄)
```sql
CREATE TABLE task_execution_log (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  task_id INTEGER NOT NULL,
  multi_stage_task_id INTEGER,
  client_service_id INTEGER,
  execution_period TEXT,             -- '2025-10', '2025-Q1'
  status TEXT DEFAULT 'pending',
  executor_id INTEGER,
  approver_id INTEGER,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  started_at DATETIME,
  completed_at DATETIME,
  approved_at DATETIME,
  actual_hours DECIMAL(5,2),
  billed_amount DECIMAL(10,2),
  notes TEXT,
  attachments TEXT,
  FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE,
  FOREIGN KEY (client_service_id) REFERENCES client_services(id)
);
```

#### task_generation_log (任務生成記錄 - 防重複)
```sql
CREATE TABLE task_generation_log (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_service_id INTEGER NOT NULL,
  execution_period TEXT NOT NULL,    -- '2025-10'
  generated_task_id INTEGER,
  generated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  generation_method TEXT,            -- 'auto' 或 'manual'
  FOREIGN KEY (client_service_id) REFERENCES client_services(id),
  FOREIGN KEY (generated_task_id) REFERENCES tasks(id),
  UNIQUE(client_service_id, execution_period)
);
```

### 工時管理相關

#### timesheets (工時記錄)
```sql
CREATE TABLE timesheets (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  employee_id INTEGER NOT NULL,
  date DATE NOT NULL,
  regular_hours REAL DEFAULT 0,
  overtime_hours REAL DEFAULT 0,
  status TEXT DEFAULT 'draft',
  notes TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(employee_id, date)
);
```

### 其他重要資料表

#### 完整遷移檔案列表

所有資料表結構定義於以下遷移檔案：

| 檔案 | 說明 | 建立的資料表 |
|------|------|-------------|
| 001_complete_schema.sql | 基礎架構 | users, sessions, employees, timesheets, leave_events, holidays, overtime_rates, annual_leave_rules, annual_leave_carryover, other_leave_rules, clients, client_assignments, business_types, system_parameters, task_reminders |
| 002_seed_data.sql | 初始資料 | 插入預設的業務類型、假別類型、系統參數等 |
| 003_clients_expansion.sql | 客戶擴展 | client_service_schedules, client_interactions |
| 004_sop_system.sql | SOP系統 | sop_categories, sops, sop_versions |
| 004a_sop_business_integration.sql | SOP整合 | 為 sops 表添加 business_type 欄位 |
| 005_media_library.sql | 媒體庫 | media_library |
| 006_project_management.sql | 專案管理 | projects, project_tasks, project_checklist |
| 007_add_timestamps.sql | 時間戳 | 為多個表添加 created_at, updated_at |
| 007a_report_cache.sql | 報表快取 | report_cache |
| 008_cms.sql | 內容管理 | posts |
| 010_multi_stage_tasks.sql | 多階段任務 | tasks, multi_stage_tasks, task_stages, multi_stage_templates, template_stages |
| 011_recurring_tasks.sql | 周期任務 | recurring_task_templates, recurring_task_instances, recurring_task_generation_log |
| 012_add_project_category.sql | 專案分類 | 為 projects 表添加 category 欄位 |
| 013_client_services_integration_补充.sql | 客戶服務自動化 | service_checklist_templates, task_execution_log, task_generation_log, v_client_services_overview |
| 015_rebuild_client_services.sql | 重建客戶服務表 | 重建 client_services 表結構 |

#### 遷移檔案執行順序

**重要**：遷移檔案必須按編號順序執行。

```bash
# 本地環境
cd timesheet-api
npx wrangler d1 execute timesheet-db --local --file=migrations/001_complete_schema.sql
npx wrangler d1 execute timesheet-db --local --file=migrations/002_seed_data.sql
# ... 依序執行

# 生產環境
npx wrangler d1 execute timesheet-db --remote --file=migrations/001_complete_schema.sql
# ... 依序執行
```

**注意**：
- 004a 和 007a 是因為編號重複暫時使用的命名
- 已刪除的遷移：009（大量CSV數據）、016（測試數據）
- 已刪除的遷移：013原始版本、014測試數據

---

## 🔄 資料流程

### 任務自動生成流程
```
1. GitHub Actions 每日執行 (或手動觸發)
   ↓
2. 呼叫 API: POST /api/automated-tasks/generate
   ↓
3. 查詢 client_services 表，找出需要生成的服務
   ↓
4. 檢查 task_generation_log，避免重複生成
   ↓
5. 載入 service_checklist_templates 範本
   ↓
6. 創建 task, multi_stage_task, task_stages
   ↓
7. 記錄到 task_execution_log 和 task_generation_log
```

### 使用者認證流程
```
1. 使用者輸入帳號密碼
   ↓
2. POST /api/login
   ↓
3. 驗證密碼 (bcrypt)
   ↓
4. 創建 session，返回 token
   ↓
5. 前端儲存 token 到 localStorage
   ↓
6. 後續請求帶 Authorization header
```

---

## 📁 專案目錄結構

```
horgoscpa/
├── assets/
│   ├── css/                    # 樣式檔案
│   ├── js/                     # 前端 JavaScript
│   │   ├── unified-tasks.js   # 統一任務管理
│   │   ├── navbar.js          # 導航列
│   │   └── ...
│   └── images/                # 圖片資源
├── timesheet-api/
│   ├── src/
│   │   ├── index.js           # API 主入口
│   │   ├── auth.js            # 認證模組
│   │   ├── automated-tasks.js # 自動任務
│   │   ├── clients.js         # 客戶管理
│   │   ├── multi-stage-tasks.js
│   │   ├── recurring-tasks.js
│   │   ├── projects.js
│   │   ├── sop.js
│   │   ├── cms.js
│   │   ├── media.js
│   │   ├── reports.js
│   │   └── utils.js
│   ├── migrations/            # 資料庫遷移
│   ├── scripts/               # 工具腳本
│   ├── test/                  # 測試檔案
│   └── wrangler.jsonc         # Cloudflare 配置
├── docs/                      # 文檔
├── .github/workflows/         # GitHub Actions
├── *.html                     # 前端頁面
└── README.md
```

---

## 🔌 API 設計原則

### 路由結構
```
/api/login                          # 登入
/api/logout                         # 登出
/api/verify                         # 驗證 session
/api/資源複數/:id                    # RESTful 資源操作
/api/multi-stage-tasks              # 多階段任務
/api/automated-tasks/generate       # 自動生成任務
```

### 回應格式
```javascript
// 成功
{ "success": true, "data": {...} }

// 失敗
{ "success": false, "error": "錯誤訊息" }
```

---

## 🚀 部署架構

```
Cloudflare Pages (前端靜態檔案)
         ↓
Cloudflare Workers (API)
         ↓
Cloudflare D1 (資料庫)
```

### 環境區分
- **本地開發**: `npx wrangler dev --local`
- **預覽環境**: `--env preview`
- **生產環境**: 預設

---

## 📝 開發流程原則

### ⚠️ 重要：先改設計，再改代碼

1. **第一步：修改設計文檔**
   - 在 `docs/` 目錄找到對應的設計文檔
   - 更新功能描述、資料表結構、API 設計
   - 確保設計文檔完整清晰

2. **第二步：按照設計實施**
   - 根據更新後的設計文檔進行開發
   - 資料庫遷移、後端 API、前端介面

3. **第三步：測試驗證**
   - 測試功能是否符合設計
   - 測試通過後刪除測試腳本

4. **第四步：更新文檔**
   - 如有設計變更，回頭更新設計文檔
   - 保持文檔與代碼同步

### 禁止事項
- ❌ 不生成完成報告
- ❌ 不生成總結文件
- ❌ 不保留測試腳本
- ❌ 不創建臨時文檔
- ❌ 不在未更新設計的情況下修改代碼

---

## 📚 相關文檔

詳細的功能設計請參考：
- [客戶服務自動化系統設計.md](./客戶服務自動化系統設計.md)
- [API端點文檔.md](./API端點文檔.md)
- [開發與部署指南.md](./開發與部署指南.md)

---

**本文檔作為整個系統的總覽，修改任何功能前請先確認並更新相關設計文檔。**

