# 系統設定與工作台設計

**版本**: 1.0  
**最後更新**: 2025-10-26

---

## 📋 功能概述

### 系統設定 (settings.html)
統一管理系統各項設定，包含員工管理、客戶管理、系統參數等。

**核心優化** - ✅ 已實施：
- ✅ **網頁化配置管理**：所有系統參數都能在網頁中修改，無需編輯代碼（✅ 已實施 2025-10-26）
- ✅ **視覺化編輯器**：提供多種編輯器類型（數字、開關、下拉選單等）（✅ 已實施 2025-10-26）
- ✅ **即時驗證**：輸入時即時檢查有效性（✅ 資料表支援，前端部分實施）
- ✅ **批量操作**：支援批量修改和重置（✅ API已實施 2025-10-26）

### 工作台 (dashboard.html)
提供個人化的工作儀表板，顯示待辦任務、工時統計等。

---

## 🗄️ 資料表結構

### employees (員工資料)
```sql
CREATE TABLE employees (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,                -- 員工姓名
  employee_id TEXT UNIQUE,           -- 員工編號
  department TEXT,                   -- 部門
  position TEXT,                     -- 職位
  hire_date DATE,                    -- 到職日期
  birth_date DATE,                   -- 生日
  phone TEXT,
  email TEXT,
  address TEXT,
  emergency_contact TEXT,            -- 緊急聯絡人
  emergency_phone TEXT,              -- 緊急聯絡電話
  status TEXT DEFAULT 'active',      -- active, resigned, on_leave
  resignation_date DATE,             -- 離職日期
  notes TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### system_parameters (系統參數) - 已優化
```sql
CREATE TABLE system_parameters (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  param_key TEXT NOT NULL UNIQUE,    -- 參數鍵值
  param_value TEXT,                  -- 參數值
  param_type TEXT,                   -- string, number, boolean, json
  editor_type TEXT DEFAULT 'text',   -- 編輯器類型（新增）
  description TEXT,                  -- 參數說明
  category TEXT,                     -- 參數分類
  validation_rule TEXT,              -- 驗證規則 JSON（新增）
  help_text TEXT,                    -- 幫助提示（新增）
  display_order INTEGER DEFAULT 0,   -- 顯示順序（新增）
  is_editable BOOLEAN DEFAULT 1,     -- 是否可編輯
  is_visible BOOLEAN DEFAULT 1,      -- 是否在設定頁面顯示（新增）
  updated_by TEXT,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**支援的編輯器類型**：
- `text` - 文字輸入框
- `number` - 數字輸入框
- `boolean` - 開關按鈕
- `select` - 下拉選單
- `textarea` - 多行文字
- `time` - 時間選擇器
- `date` - 日期選擇器
- `email` - Email 輸入框
- `password` - 密碼輸入框

**系統參數範例**：
```sql
INSERT INTO system_parameters (param_key, param_value, param_type, description, category) VALUES
  ('company_name', '霍爾果斯會計師事務所', 'string', '公司名稱', 'general'),
  ('work_hours_per_day', '8', 'number', '每日標準工時', 'timesheet'),
  ('annual_leave_enabled', 'true', 'boolean', '啟用年假管理', 'leave'),
  ('overtime_rates', '{"weekday": 1.34, "weekend": 1.67}', 'json', '加班費率', 'timesheet');
```

### user_reminders (用戶提醒) - 簡化版
```sql
-- 簡化的提醒表，直接在工作台顯示
CREATE TABLE user_reminders (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  reminder_type TEXT NOT NULL,       -- annual_leave_expiry, task_due, timesheet_reminder
  message TEXT NOT NULL,             -- 提醒訊息
  related_id INTEGER,                -- 相關任務或記錄 ID
  is_read BOOLEAN DEFAULT 0,
  priority TEXT DEFAULT 'normal',    -- low, normal, high
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  expires_at DATETIME,               -- 提醒過期時間
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

**提醒類型**：
- `annual_leave_expiry` - 年假即將到期
- `task_due` - 任務即將到期
- `timesheet_reminder` - 工時未填寫提醒
- `overtime_alert` - 加班時數提醒

---

## 💻 系統設定頁面設計

### settings.html 標籤結構（已優化）

```
[員工管理] [客戶管理] [系統參數] [任務範本] [業務類型] [配置管理]
```

**新增：配置管理標籤**
- 工時規則（每日工時、加班費率）
- 年假規則（年假天數、結轉規則）
- 自動化設定（任務生成時間、提前天數）

#### 標籤 1: 員工管理
```
員工列表
─────────────────────

[+ 新增員工]  搜尋: [搜尋員工...]

┌─────────────────────────────────────┐
│ 張紜蓁                              │
│ 會計部 | 會計師 | 2020-01-15 到職  │
│ user1@example.com                   │
└─────────────────────────────────────┘

[編輯] [停用] [查看工時]
```

#### 標籤 2: 客戶管理
```
客戶列表
─────────────────────

[+ 新增客戶]  搜尋: [搜尋客戶...]  狀態: [全部▾]

┌─────────────────────────────────────┐
│ ABC科技公司                         │
│ 統編: 12345678 | 聯絡人: 王小明     │
│ 服務: 記帳(月)、營業稅(雙月)        │
│ 負責: 紜蓁                         │
└─────────────────────────────────────┘

[查看詳情] [編輯] [服務配置]
```

#### 標籤 3: 系統參數（已優化為動態表單）
```
系統參數設定
─────────────────────

[工時規則] [年假規則] [自動化設定] 子標籤切換

=== 工時規則 ===
✏️ 標準工時
├─ 每日標準工時: [8] 小時 (範圍: 1-24)
├─ 每週工作天數: [5] 天
└─ 午休時間: [12:00] 至 [13:00]

✏️ 加班費率
├─ 平日延長: [1.34] 倍 💡 勞基法規定
├─ 休息日: [1.67] 倍
└─ 國定假日: [2.00] 倍

=== 年假規則 ===
✏️ 年假計算
├─ 啟用年假管理: ☑
├─ 允許結轉: ☑
├─ 最多結轉天數: [5] 天 (範圍: 0-30)
└─ 結轉期限: [次年 12 月 31 日]

=== 自動化設定 ===
✏️ 任務自動生成
├─ 啟用自動生成: ☑
├─ 執行時間: [00:00] (台北時間)
├─ 預設提前天數: [7] 天
├─ 預設任務期限: [15] 天
└─ 遇假日處理: [提前至假日前 ▾]

💾 [儲存所有設定] [重置為預設值]

提示：所有參數都有即時驗證和幫助說明
```

#### 標籤 4: 任務範本
```
任務範本管理
─────────────────────

[+ 新增範本]  分類: [全部▾]

多階段任務範本:
┌─────────────────────────────────────┐
│ 營業稅申報流程                      │
│ 8 個階段 | 使用次數: 45            │
│ 預估工時: 7.5 小時                 │
└─────────────────────────────────────┘

[編輯] [複製] [刪除] [查看統計]
```

#### 標籤 5: 業務類型
```
業務類型管理
─────────────────────

[+ 新增業務類型]

┌─────────────────────────────────────┐
│ 會計服務                            │
│ 代碼: accounting                    │
│ 客戶數: 25 | SOP 數: 8             │
└─────────────────────────────────────┘

[編輯] [查看客戶] [查看 SOP]
```

---

## 💻 工作台頁面設計

### dashboard.html 佈局

```
┌─────────────────────────────────────────────────┐
│                 歡迎回來，張紜蓁                 │
└─────────────────────────────────────────────────┘

┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ 我的任務     │ │ 本月工時     │ │ 年假餘額     │
│              │ │              │ │              │
│   5 個       │ │  168 小時    │ │   10 天      │
│   待處理     │ │  +15 加班    │ │   /15 天     │
└──────────────┘ └──────────────┘ └──────────────┘

┌─────────────────────────────────────────────────┐
│ 📋 今日待辦 (3)                                 │
├─────────────────────────────────────────────────┤
│ □ ABC公司 - 10月營業稅申報 (今天截止)          │
│ □ XYZ公司 - 記帳服務 (明天截止)                │
│ □ 審核李四的請假申請                           │
└─────────────────────────────────────────────────┘

┌──────────────────────┐ ┌─────────────────────┐
│ 📊 本週工時分析      │ │ 📅 近期排程         │
│                      │ │                     │
│ [工時趨勢圖]         │ │ 10/28 - 2個任務     │
│                      │ │ 10/29 - 1個任務     │
│                      │ │ 10/30 - 3個任務     │
└──────────────────────┘ └─────────────────────┘

┌─────────────────────────────────────────────────┐
│ ⚠️ 重要提醒                                     │
├─────────────────────────────────────────────────┤
│ • 年假將於 2025-12-31 到期，剩餘 10 天未休     │
│ • ABC公司任務即將於今天截止                     │
│ • 本月工時已達 168 小時                        │
└─────────────────────────────────────────────────┘
```

---

## 🔌 工作台 API 設計

### 取得工作台資料（含提醒）
```
GET /api/dashboard/summary

Response:
{
  "success": true,
  "summary": {
    "my_tasks": {
      "total": 5,
      "pending": 3,
      "in_progress": 2,
      "due_today": 1
    },
    "timesheet": {
      "current_month": {
        "regular_hours": 168,
        "overtime_hours": 15,
        "work_days": 21
      }
    },
    "annual_leave": {
      "remaining_days": 10,
      "total_days": 15,
      "expiry_date": "2025-12-31",
      "days_until_expiry": 65
    },
    "upcoming_tasks": [
      {
        "task_id": 123,
        "title": "ABC公司 - 營業稅申報",
        "due_date": "2025-10-28",
        "priority": "high"
      }
    ],
    "reminders": [
      {
        "id": 1,
        "type": "annual_leave_expiry",
        "message": "年假將於 2025-12-31 到期，剩餘 10 天未休",
        "priority": "high",
        "is_read": false
      },
      {
        "id": 2,
        "type": "task_due",
        "message": "ABC公司任務即將於今天截止",
        "priority": "high",
        "is_read": false,
        "related_id": 123
      }
    ]
  }
}
```

---

## 📊 工作台統計

### 個人效能統計
```sql
-- 本月任務完成數
SELECT 
  COUNT(*) as completed_tasks,
  SUM(actual_hours) as total_hours
FROM tasks t
JOIN task_stages ts ON t.id = ts.multi_stage_task_id
WHERE ts.completed_by = ?
  AND strftime('%Y-%m', ts.completed_at) = strftime('%Y-%m', 'now');
```

### 待辦提醒
```sql
-- 即將到期的任務
SELECT 
  t.id,
  t.title,
  t.due_date,
  t.priority,
  julianday(t.due_date) - julianday('now') as days_until_due
FROM tasks t
WHERE t.assigned_user = ?
  AND t.status IN ('pending', 'in_progress')
  AND t.due_date >= date('now')
  AND t.due_date <= date('now', '+7 days')
ORDER BY t.due_date;
```

---

## 🔧 實施細節

### 系統參數讀取
```javascript
async function getSystemParameter(key) {
  const param = await db.get(
    'SELECT param_value, param_type FROM system_parameters WHERE param_key = ?',
    [key]
  );
  
  if (!param) return null;
  
  // 根據類型轉換值
  switch (param.param_type) {
    case 'number':
      return parseFloat(param.param_value);
    case 'boolean':
      return param.param_value === 'true';
    case 'json':
      return JSON.parse(param.param_value);
    default:
      return param.param_value;
  }
}
```

### 工作台數據聚合
```javascript
async function getDashboardData(userId) {
  // 並行查詢多個數據源
  const [myTasks, timesheet, annualLeave, notifications] = await Promise.all([
    getMyTasksSummary(userId),
    getCurrentMonthTimesheet(userId),
    getAnnualLeaveSummary(userId),
    getUnreadNotifications(userId)
  ]);
  
  return {
    my_tasks: myTasks,
    timesheet: timesheet,
    annual_leave: annualLeave,
    notifications: notifications,
    updated_at: new Date().toISOString()
  };
}
```

---

## 💻 前端設計

### 工作台小部件 (Widgets)

#### 任務統計小部件
```javascript
class TaskStatsWidget {
  async render() {
    const stats = await fetchTaskStats();
    return `
      <div class="widget">
        <h3>我的任務</h3>
        <div class="stat-number">${stats.total}</div>
        <div class="stat-detail">
          待處理: ${stats.pending} | 
          進行中: ${stats.in_progress}
        </div>
      </div>
    `;
  }
}
```

#### 工時統計小部件
```javascript
class TimesheetWidget {
  async render() {
    const timesheet = await fetchMonthlyTimesheet();
    return `
      <div class="widget">
        <h3>本月工時</h3>
        <div class="stat-number">${timesheet.regular_hours}h</div>
        <div class="stat-detail">
          加班: ${timesheet.overtime_hours}h
        </div>
        <canvas id="timesheetChart"></canvas>
      </div>
    `;
  }
}
```

#### 年假小部件
```javascript
class AnnualLeaveWidget {
  async render() {
    const leave = await fetchAnnualLeave();
    const percentage = (leave.remaining / leave.total) * 100;
    
    return `
      <div class="widget">
        <h3>年假餘額</h3>
        <div class="stat-number">${leave.remaining}天</div>
        <div class="progress-ring" data-progress="${percentage}">
          <svg>...</svg>
        </div>
      </div>
    `;
  }
}
```

---

---

## 📊 工作台統計

### 個人工作量視圖
```sql
-- 本週任務分布
SELECT 
  date(due_date) as date,
  COUNT(*) as task_count,
  SUM(estimated_hours) as estimated_hours
FROM tasks
WHERE assigned_user = ?
  AND due_date >= date('now', 'weekday 0', '-6 days')
  AND due_date <= date('now', 'weekday 0')
GROUP BY date
ORDER BY date;
```

### 團隊工作量平衡
```sql
-- 各員工當前任務數與工時
SELECT 
  u.employee_name,
  COUNT(DISTINCT t.id) as task_count,
  SUM(CASE WHEN t.status = 'pending' THEN 1 ELSE 0 END) as pending_tasks,
  SUM(ts.estimated_hours - COALESCE(ts.actual_hours, 0)) as remaining_hours
FROM users u
LEFT JOIN tasks t ON u.id = t.assigned_user
LEFT JOIN task_stages ts ON t.id = ts.task_id AND ts.status != 'completed'
WHERE u.role IN ('employee', 'accountant')
  AND t.status IN ('pending', 'in_progress')
GROUP BY u.id
ORDER BY remaining_hours DESC;
```

---

## 🔌 API 設計（已優化）

### 配置管理 API

#### 取得配置分類
```
GET /api/system-config/categories

Response:
{
  "success": true,
  "categories": [
    {"category": "timesheet", "param_count": 5},
    {"category": "annual_leave", "param_count": 4},
    {"category": "automation", "param_count": 6}
  ]
}
```

#### 取得特定分類配置
```
GET /api/system-config/:category

Response:
{
  "success": true,
  "category": "timesheet",
  "parameters": [
    {
      "param_key": "work_hours_per_day",
      "param_value": "8",
      "param_type": "number",
      "editor_type": "number",
      "description": "每日標準工時",
      "validation_rule": {"min": 1, "max": 24},
      "help_text": "員工每日應工作時數",
      "is_editable": true
    }
  ]
}
```

#### 更新單個配置
```
PUT /api/system-config/:key

Request:
{
  "param_value": "8.5"
}

Response:
{
  "success": true,
  "message": "參數已更新",
  "param_key": "work_hours_per_day",
  "new_value": "8.5"
}
```

#### 批量更新配置
```
PUT /api/system-config/batch

Request:
{
  "updates": [
    {"param_key": "work_hours_per_day", "param_value": "8"},
    {"param_key": "overtime_rate_weekday", "param_value": "1.34"}
  ]
}

Response:
{
  "success": true,
  "total": 2,
  "success_count": 2,
  "fail_count": 0
}
```

#### 重置為預設值
```
POST /api/system-config/:key/reset

Response:
{
  "success": true,
  "message": "已重置為預設值"
}
```

---

## 🎨 工作台視覺化

### 工時趨勢圖
```javascript
// 使用 Chart.js 繪製工時趨勢
new Chart(ctx, {
  type: 'bar',
  data: {
    labels: ['週一', '週二', '週三', '週四', '週五'],
    datasets: [{
      label: '正常工時',
      data: [8, 8, 8, 8, 8],
      backgroundColor: 'rgba(75, 192, 192, 0.5)'
    }, {
      label: '加班工時',
      data: [0, 2, 1, 0, 3],
      backgroundColor: 'rgba(255, 99, 132, 0.5)'
    }]
  }
});
```

### 任務完成率環形圖
```javascript
new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: ['已完成', '進行中', '未開始'],
    datasets: [{
      data: [12, 5, 3],
      backgroundColor: [
        'rgba(75, 192, 192, 0.8)',
        'rgba(54, 162, 235, 0.8)',
        'rgba(201, 203, 207, 0.8)'
      ]
    }]
  }
});
```

---

## 🚀 未來擴展

### 系統設定擴展
- [ ] 權限細部控制（欄位級別權限）
- [ ] 主題色彩自訂
- [ ] 資料匯入/匯出設定
- [ ] 稽核日誌（追蹤配置變更）

### 工作台擴展
- [ ] 可自訂小部件配置
- [ ] 拖曳排版
- [ ] 效能分析（本月 vs 上月）

---

**相關文檔**：
- [系統架構設計.md](./系統架構設計.md) - 整體架構
- [工時管理系統設計.md](./工時管理系統設計.md) - 工時資料
- [API端點文檔.md](./API端點文檔.md) - API 參考

