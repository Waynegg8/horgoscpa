# 安全設計

**最後更新：** 2025年10月27日

---

## 認證層級

### 1. Cookie 驗證
每個 API 請求檢查 HttpOnly Cookie

```typescript
// middlewares/auth.middleware.ts
export async function authMiddleware(c) {
  const token = c.req.cookie('auth_token');
  
  if (!token) {
    throw new HTTPException(401, { message: '未登入' });
  }
  
  const user = await verifyJWT(token);
  c.set('user', user);
}
```

### 2. 權限檢查
根據 `Users.is_admin` 和 `ModulePermissions` 雙重驗證

```typescript
// middlewares/permission.middleware.ts
export async function checkModulePermission(c, moduleName) {
  const user = c.get('user');
  
  // 管理員永遠通過
  if (user.is_admin) return;
  
  // 員工需檢查權限
  const hasPermission = await db.query(
    'SELECT has_access FROM ModulePermissions WHERE user_id = ? AND module_name = ?',
    [user.user_id, moduleName]
  );
  
  if (!hasPermission) {
    throw new HTTPException(403, { message: '無權存取' });
  }
}
```

### 3. CSRF 保護
表單提交需要 CSRF Token

### 4. Rate Limiting
防止 API 濫用

| API 類型 | 限制 |
|---------|------|
| 登入 API | 每 IP 每分鐘最多 5 次 |
| 一般 API | 每使用者每分鐘最多 60 次 |

---

## 資料保護

### 密碼安全
- **演算法**：Argon2（業界最安全的密碼雜湊）
- **Salt**：自動生成隨機 Salt
- **儲存**：僅存雜湊值，永不存明文

```typescript
import { hash, verify } from '@node-rs/argon2';

// 註冊時
const hashedPassword = await hash(plainPassword);
await db.insert('Users', { hashed_password: hashedPassword });

// 登入時
const isValid = await verify(user.hashed_password, plainPassword);
```

### 會話安全
```typescript
// Cookie 設定
{
  httpOnly: true,      // 防止 XSS
  secure: true,        // 僅 HTTPS
  sameSite: 'strict',  // 防止 CSRF
  maxAge: 86400        // 24 小時
}
```

### 備份安全
- **每日備份**：自動備份到 R2
- **保留政策**：保留最近 30 天
- **加密**：R2 自動加密

---

## 安全檢查清單

### 部署前必檢
- [ ] 所有 Cookie 設定 HttpOnly + Secure + SameSite
- [ ] API 有 Rate Limiting
- [ ] 密碼使用 Argon2 雜湊
- [ ] 所有資料庫查詢使用參數化查詢（防 SQL Injection）
- [ ] 環境變數正確設定（JWT Secret）
- [ ] HTTPS 強制啟用

### 運行時監控
- [ ] 監控異常登入嘗試
- [ ] 監控 API 異常流量
- [ ] 定期檢查備份完整性

---

## 相關文檔

- [架構設計](../架構設計.md)
- [認證 API](../API設計/認證API.md)
- [權限系統設計](../權限系統設計.md)

---

**最後更新：** 2025年10月27日



**最後更新：** 2025年10月27日

---

## 認證層級

### 1. Cookie 驗證
每個 API 請求檢查 HttpOnly Cookie

```typescript
// middlewares/auth.middleware.ts
export async function authMiddleware(c) {
  const token = c.req.cookie('auth_token');
  
  if (!token) {
    throw new HTTPException(401, { message: '未登入' });
  }
  
  const user = await verifyJWT(token);
  c.set('user', user);
}
```

### 2. 權限檢查
根據 `Users.is_admin` 和 `ModulePermissions` 雙重驗證

```typescript
// middlewares/permission.middleware.ts
export async function checkModulePermission(c, moduleName) {
  const user = c.get('user');
  
  // 管理員永遠通過
  if (user.is_admin) return;
  
  // 員工需檢查權限
  const hasPermission = await db.query(
    'SELECT has_access FROM ModulePermissions WHERE user_id = ? AND module_name = ?',
    [user.user_id, moduleName]
  );
  
  if (!hasPermission) {
    throw new HTTPException(403, { message: '無權存取' });
  }
}
```

### 3. CSRF 保護
表單提交需要 CSRF Token

### 4. Rate Limiting
防止 API 濫用

| API 類型 | 限制 |
|---------|------|
| 登入 API | 每 IP 每分鐘最多 5 次 |
| 一般 API | 每使用者每分鐘最多 60 次 |

---

## 資料保護

### 密碼安全
- **演算法**：Argon2（業界最安全的密碼雜湊）
- **Salt**：自動生成隨機 Salt
- **儲存**：僅存雜湊值，永不存明文

```typescript
import { hash, verify } from '@node-rs/argon2';

// 註冊時
const hashedPassword = await hash(plainPassword);
await db.insert('Users', { hashed_password: hashedPassword });

// 登入時
const isValid = await verify(user.hashed_password, plainPassword);
```

### 會話安全
```typescript
// Cookie 設定
{
  httpOnly: true,      // 防止 XSS
  secure: true,        // 僅 HTTPS
  sameSite: 'strict',  // 防止 CSRF
  maxAge: 86400        // 24 小時
}
```

### 備份安全
- **每日備份**：自動備份到 R2
- **保留政策**：保留最近 30 天
- **加密**：R2 自動加密

---

## 安全檢查清單

### 部署前必檢
- [ ] 所有 Cookie 設定 HttpOnly + Secure + SameSite
- [ ] API 有 Rate Limiting
- [ ] 密碼使用 Argon2 雜湊
- [ ] 所有資料庫查詢使用參數化查詢（防 SQL Injection）
- [ ] 環境變數正確設定（JWT Secret）
- [ ] HTTPS 強制啟用

### 運行時監控
- [ ] 監控異常登入嘗試
- [ ] 監控 API 異常流量
- [ ] 定期檢查備份完整性

---

## 相關文檔

- [架構設計](../架構設計.md)
- [認證 API](../API設計/認證API.md)
- [權限系統設計](../權限系統設計.md)

---

**最後更新：** 2025年10月27日



