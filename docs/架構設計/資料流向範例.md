# 資料流向範例

**最後更新：** 2025年10月27日

---

## 範例一：員工填寫工時表

```
1. 前端：員工在 TimesheetGrid 組件輸入工時
   ↓
2. 前端：點擊「儲存」→ POST /api/v1/timesheets
   ↓
3. Worker：TimesheetService.save()
   ├── 驗證資料格式
   ├── 根據 OvertimeRates 計算加權工時
   └── TimesheetRepository.insert()
   ↓
4. D1：INSERT INTO TimeLogs
   ↓
5. Worker：返回 { success: true, data: {...} }
   ↓
6. 前端：顯示儲存成功訊息
```

---

## 範例二：自動建立任務（Cron）

```
1. Cron：每月 1 號凌晨 01:00 觸發
   ↓
2. Worker：task-generator.ts 執行
   ├── SELECT * FROM ClientServices WHERE is_active = 1
   ├── 檢查 trigger_months 是否包含本月
   └── 如果符合 ↓
   ↓
3. D1：
   ├── INSERT INTO ActiveTasks (建立任務實例)
   └── INSERT INTO ActiveTaskStages (建立所有階段)
   ↓
4. 員工登入時：
   ├── GET /api/v1/tasks
   └── 儀表板自動顯示新任務
```

---

## 範例三：更新任務階段進度

```
1. 前端：員工在任務看板中點擊「標記完成」
   ↓
2. 前端：PUT /api/v1/tasks/stages/:stageId
   Body: { status: '已完成', completed_date: '2025-10-27' }
   ↓
3. Worker：TaskService.updateStage()
   ├── 驗證權限（是否為負責員工）
   ├── 檢查依賴階段是否完成
   ├── 更新階段狀態
   └── 檢查任務是否全部完成 → 更新任務狀態
   ↓
4. D1：
   ├── UPDATE ActiveTaskStages SET status = '已完成'
   └── UPDATE ActiveTasks SET status = '已完成' (如果所有階段完成)
   ↓
5. Worker：返回更新後的任務資料
   ↓
6. 前端：任務看板即時更新
```

---

## 範例四：員工申請補休

```
1. 前端：員工在工時表中填寫補休
   ↓
2. 前端：POST /api/v1/timesheets
   Body: { leave_type: '補休', leave_hours: 2 }
   ↓
3. Worker：LeaveService.useCompensatoryLeave()
   ├── 檢查補休餘額是否足夠
   ├── 使用 FIFO 方法從最早的補休扣除
   ├── 更新 CompensatoryLeaveBalance
   └── 記錄 CompensatoryLeaveUsage
   ↓
4. D1：
   ├── UPDATE CompensatoryLeaveBalance SET balance = balance - 2
   ├── INSERT INTO CompensatoryLeaveUsage
   └── INSERT INTO TimeLogs (記錄請假)
   ↓
5. Worker：返回更新後的補休餘額
   ↓
6. 前端：顯示剩餘補休時數
```

---

## 相關文檔

- [架構設計](../架構設計.md)
- [API 設計](../API設計/README.md)
- [自動化流程](../自動化流程.md)

---

**最後更新：** 2025年10月27日



**最後更新：** 2025年10月27日

---

## 範例一：員工填寫工時表

```
1. 前端：員工在 TimesheetGrid 組件輸入工時
   ↓
2. 前端：點擊「儲存」→ POST /api/v1/timesheets
   ↓
3. Worker：TimesheetService.save()
   ├── 驗證資料格式
   ├── 根據 OvertimeRates 計算加權工時
   └── TimesheetRepository.insert()
   ↓
4. D1：INSERT INTO TimeLogs
   ↓
5. Worker：返回 { success: true, data: {...} }
   ↓
6. 前端：顯示儲存成功訊息
```

---

## 範例二：自動建立任務（Cron）

```
1. Cron：每月 1 號凌晨 01:00 觸發
   ↓
2. Worker：task-generator.ts 執行
   ├── SELECT * FROM ClientServices WHERE is_active = 1
   ├── 檢查 trigger_months 是否包含本月
   └── 如果符合 ↓
   ↓
3. D1：
   ├── INSERT INTO ActiveTasks (建立任務實例)
   └── INSERT INTO ActiveTaskStages (建立所有階段)
   ↓
4. 員工登入時：
   ├── GET /api/v1/tasks
   └── 儀表板自動顯示新任務
```

---

## 範例三：更新任務階段進度

```
1. 前端：員工在任務看板中點擊「標記完成」
   ↓
2. 前端：PUT /api/v1/tasks/stages/:stageId
   Body: { status: '已完成', completed_date: '2025-10-27' }
   ↓
3. Worker：TaskService.updateStage()
   ├── 驗證權限（是否為負責員工）
   ├── 檢查依賴階段是否完成
   ├── 更新階段狀態
   └── 檢查任務是否全部完成 → 更新任務狀態
   ↓
4. D1：
   ├── UPDATE ActiveTaskStages SET status = '已完成'
   └── UPDATE ActiveTasks SET status = '已完成' (如果所有階段完成)
   ↓
5. Worker：返回更新後的任務資料
   ↓
6. 前端：任務看板即時更新
```

---

## 範例四：員工申請補休

```
1. 前端：員工在工時表中填寫補休
   ↓
2. 前端：POST /api/v1/timesheets
   Body: { leave_type: '補休', leave_hours: 2 }
   ↓
3. Worker：LeaveService.useCompensatoryLeave()
   ├── 檢查補休餘額是否足夠
   ├── 使用 FIFO 方法從最早的補休扣除
   ├── 更新 CompensatoryLeaveBalance
   └── 記錄 CompensatoryLeaveUsage
   ↓
4. D1：
   ├── UPDATE CompensatoryLeaveBalance SET balance = balance - 2
   ├── INSERT INTO CompensatoryLeaveUsage
   └── INSERT INTO TimeLogs (記錄請假)
   ↓
5. Worker：返回更新後的補休餘額
   ↓
6. 前端：顯示剩餘補休時數
```

---

## 相關文檔

- [架構設計](../架構設計.md)
- [API 設計](../API設計/README.md)
- [自動化流程](../自動化流程.md)

---

**最後更新：** 2025年10月27日



