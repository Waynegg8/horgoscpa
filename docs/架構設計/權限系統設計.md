# 權限系統設計（優化版）

**最後更新：** 2025年10月28日  
**文檔版本：** 3.0（架構優化版）

---

## 系統概述

本系統採用「兩級權限」的極簡設計，僅用 `Users.is_admin` 控制所有權限。

**設計原則：**
- ✓ 只有兩種角色：管理員和員工
- ✓ 使用 `is_admin` 布林值控制
- ✓ 功能權限固定（不可調整）
- ✓ 資料範圍由業務邏輯控制

---

## 角色定義

### 管理員 (Admin)
- **識別：** `Users.is_admin = 1`
- **權限：** 所有功能、所有資料
- **數量：** 1-3人（事務所負責人）

### 員工 (Employee)  
- **識別：** `Users.is_admin = 0`
- **權限：** 基本操作功能、自己的資料
- **數量：** 事務所全體員工

---

## 功能權限分配

### 所有人可訪問

| 功能 | 資料範圍 |
|------|---------|
| 儀表板 | 員工看自己，管理員看全部 |
| 個人資料設定 | 僅自己 |
| 工時表填寫 | 員工看自己，管理員看全部 |
| 加權工時計算 | 員工看自己，管理員看全部 |
| 假期登記 | 員工登記自己，管理員看全部 |
| 生活事件登記 | 員工登記自己，管理員看全部 |
| 假期餘額查詢 | 員工查自己，管理員查全部 |
| 任務管理 | 員工看自己，管理員看全部 |
| 客戶管理 | 員工看負責的，管理員看全部 |
| 報表中心 | 員工看自己，管理員看全部 |
| 知識庫（查看）| 所有內容 |
| SOP（查看）| 所有內容 |

### 僅管理員可訪問

| 功能 | 說明 |
|------|------|
| 業務規則管理 | 假期規則、加班費率、週期類型等 |
| 服務項目管理 | 定義服務類型 |
| 員工帳號管理 | 新增/編輯/刪除員工 |
| CSV 導入功能 | 批量導入客戶 |
| 外部內容管理 | 公開網站文章、資源 |
| 知識庫編輯 | 編輯 SOP、知識庫 |

---

## 實現方式

### 1. 資料庫設計（極簡）

```sql
-- 只需要 Users 表中的一個欄位！
CREATE TABLE Users (
  user_id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  name TEXT NOT NULL,
  is_admin BOOLEAN DEFAULT 0,  -- ⭐ 核心：0=員工, 1=管理員
  -- ... 其他欄位
);
```

**不需要：**
- ❌ ModulePermissions 表
- ❌ 14個模塊權限欄位
- ❌ 預設模板機制
- ❌ 個別權限覆蓋

---

### 2. 前端路由保護

```typescript
// router/index.ts
const routes = [
  // 所有人可訪問（員工會看到過濾後的資料）
  { path: '/dashboard', component: DashboardPage },
  { path: '/timesheet', component: TimesheetPage },
  { path: '/leave', component: LeavePage },
  { path: '/tasks', component: TasksPage },
  { path: '/clients', component: ClientsPage },
  { path: '/reports', component: ReportsPage },
  { path: '/knowledge', component: KnowledgePage },
  
  // 管理員專屬
  { 
    path: '/admin/settings', 
    component: SettingsPage,
    meta: { requireAdmin: true }  // ⭐ 簡單標記
  },
  { 
    path: '/admin/business-rules', 
    component: BusinessRulesPage,
    meta: { requireAdmin: true }
  },
  { 
    path: '/admin/users', 
    component: UsersManagementPage,
    meta: { requireAdmin: true }
  },
  { 
    path: '/admin/content', 
    component: ContentManagementPage,
    meta: { requireAdmin: true }
  }
];

// 路由守衛（極簡）
router.beforeEach((to, from, next) => {
  const user = store.state.user;
  
  // 管理員專屬路由檢查
  if (to.meta.requireAdmin && !user.is_admin) {
    return next('/403');
  }
  
  next();
});
```

---

### 3. 後端 API 保護

#### Middleware
```typescript
// middleware/auth.ts

// 基本認證（所有 API 都需要）
export const authMiddleware = async (c, next) => {
  const token = c.req.cookie('auth_token');
  
  if (!token) {
    return c.json(errorResponse('UNAUTHORIZED', '請先登入'), 401);
  }
  
  const user = await verifyTokenAndGetUser(token, c.env.DB);
  if (!user) {
    return c.json(errorResponse('UNAUTHORIZED', '請先登入'), 401);
  }
  
  c.set('user', user);
  await next();
};

// 管理員檢查（簡單！）
export const requireAdmin = (c, next) => {
  const user = c.get('user');
  
  if (!user.is_admin) {
    return c.json(
      errorResponse('FORBIDDEN', '僅管理員可訪問'),
      403
    );
  }
  
  return next();
};
```

#### API 路由
```typescript
// routes/admin.ts - 管理員專屬 API
app.post('/api/v1/admin/users', 
  authMiddleware, 
  requireAdmin,  // ⭐ 簡單添加
  createUserHandler
);

app.put('/api/v1/admin/business-rules/holidays/:id',
  authMiddleware,
  requireAdmin,
  updateHolidayHandler
);

// routes/user.ts - 所有人可訪問
app.get('/api/v1/timelogs',
  authMiddleware,  // 僅需認證
  getTimeLogsHandler  // Service層自動過濾資料
);

app.post('/api/v1/leave/applications',
  authMiddleware,
  createLeaveApplicationHandler  // Service層自動使用當前user_id
);
```

---

### 4. Service 層資料過濾

```typescript
// services/TimeLogService.ts
class TimeLogService {
  async getTimeLogs(filters, user) {
    const baseQuery = 'SELECT * FROM TimeLogs WHERE is_deleted = 0';
    
    // ⭐ 核心：自動資料範圍控制
    if (!user.is_admin) {
      filters.user_id = user.user_id;  // 員工只能看自己
    }
    
    return await this.repository.findAll(filters);
  }
}

// services/ClientService.ts
class ClientService {
  async getClients(filters, user) {
    const baseQuery = 'SELECT * FROM Clients WHERE is_deleted = 0';
    
    // ⭐ 員工只能看自己負責的客戶
    if (!user.is_admin) {
      filters.assignee_user_id = user.user_id;
    }
    
    return await this.repository.findAll(filters);
  }
}
```

---

## 權限矩陣

| 功能 | 路由 | 管理員 | 員工 | 資料範圍 |
|------|------|--------|------|---------|
| 儀表板 | `/dashboard` | ✅ | ✅ | 員工看自己，管理員看全部 |
| 個人資料 | `/profile` | ✅ | ✅ | 僅自己 |
| 工時表 | `/timesheet` | ✅ | ✅ | 員工填自己，管理員看全部 |
| 假期管理 | `/leave` | ✅ | ✅ | 員工登自己，管理員看全部 |
| 任務管理 | `/tasks` | ✅ | ✅ | 員工看自己，管理員看全部 |
| 客戶管理 | `/clients` | ✅ | ✅ | 員工看負責的，管理員看全部 |
| 報表中心 | `/reports` | ✅ | ✅ | 員工看自己，管理員看全部 |
| 知識庫 | `/knowledge` | ✅ | ✅（僅查看）| 所有內容 |
| **業務規則** | `/admin/rules` | ✅ | ❌ | - |
| **服務項目** | `/admin/services` | ✅ | ❌ | - |
| **員工管理** | `/admin/users` | ✅ | ❌ | - |
| **CSV導入** | `/admin/import` | ✅ | ❌ | - |
| **外部內容** | `/admin/content` | ✅ | ❌ | - |

---

## 與舊設計的對比

### 舊設計（ModulePermissions）

**優點：**
- 靈活（可為每個員工自訂權限）

**缺點：**
- ❌ 複雜（14個布林欄位）
- ❌ 需要額外的權限表
- ❌ 預設模板機制複雜
- ❌ 查詢邏輯複雜
- ❌ 新增功能需要修改表結構
- ❌ 需要8個API端點管理權限
- ❌ 需要專門的UI頁面管理權限

### 新設計（is_admin）

**優點：**
- ✅ 極簡（只需1個布林欄位）
- ✅ 不需要額外的表
- ✅ 邏輯清晰直接
- ✅ 查詢效率高
- ✅ 易於維護
- ✅ 不需要額外的API
- ✅ 不需要權限管理UI

**缺點：**
- 不夠靈活（但對小型事務所已足夠）

---

## 遷移計劃

### 移除的內容

#### 資料庫
- ❌ `ModulePermissions` 表

#### API 端點（8個）
- ❌ GET `/api/v1/settings/module-permissions/default`
- ❌ PUT `/api/v1/settings/module-permissions/default`
- ❌ POST `/api/v1/settings/module-permissions/sync`
- ❌ GET `/api/v1/settings/module-permissions/users`
- ❌ GET `/api/v1/settings/module-permissions/users/:id`
- ❌ PUT `/api/v1/settings/module-permissions/users/:id`
- ❌ DELETE `/api/v1/settings/module-permissions/users/:id`
- ❌ GET `/api/v1/settings/module-permissions/me`

#### 功能模塊
- ❌ `01-員工權限設定.md`

#### 文檔
- ❌ `員工權限API.md`（移除）
- ✅ 更新所有提到 ModulePermissions 的文檔

---

## 優化成果

### 減少的複雜度
- 資料表：32個 → 31個（減少1個）
- API端點：80+ → 72+（減少8個）
- 功能模塊：15個 → 14個（減少1個）
- 權限判斷邏輯：複雜 → 簡單（1行代碼）

### 提升的清晰度
- ✅ 權限邏輯一目了然
- ✅ 不需要理解預設模板機制
- ✅ 不需要理解權限覆蓋邏輯
- ✅ 新手3分鐘就能理解

---

## 相關文檔

- [核心業務表](../資料庫設計/核心業務表.md#users---使用者員工)
- [後端開發規範](../開發規範/後端開發規範.md#middleware-設計)

---

**最後更新：** 2025年10月28日  
**文檔版本：** 3.0（架構優化版 - 移除 ModulePermissions）
