# 權限系統設計

**最後更新：** 2025年10月27日  
**文檔版本：** 2.0

---

## 系統概述

本系統採用「兩級權限 + 模塊控制」的簡化設計，避免複雜的權限樹，專注於實際使用場景。

**設計原則：**
- ✓ 只有兩種角色：管理員 (admin) 和員工 (employee)
- ✓ 管理員擁有所有權限
- ✓ 員工權限由模塊可見性控制
- ✓ 能看見就能編輯 (See = Edit)
- ✓ 資料範圍由業務邏輯控制（員工看自己，管理員看全部）

---

## 角色定義

### 管理員 (Admin)
- **識別：** `Users.is_admin = true`
- **權限：** 所有模塊、所有功能、所有資料
- **數量：** 1-3人（事務所負責人）

### 員工 (Employee)  
- **識別：** `Users.is_admin = false`
- **權限：** 由 `ModulePermissions` 表控制
- **數量：** 事務所全體員工

---

## 模塊權限機制

### 預設模板機制

**資料庫記錄：**
```sql
-- 預設模板（user_id = NULL）
INSERT INTO ModulePermissions (user_id, dashboard, timesheet, reports, ...)
VALUES (NULL, true, true, false, ...);
```

**作用：**
- 新員工自動繼承預設模板
- 管理員可隨時調整預設值
- 可選擇是否同步到現有員工

### 個別調整機制

**資料庫記錄：**
```sql
-- 特定員工（user_id = 123）
INSERT INTO ModulePermissions (user_id, dashboard, timesheet, reports, ...)
VALUES (123, true, true, true, ...);
```

**作用：**
- 覆蓋預設模板
- 實現個性化權限
- 可隨時恢復為預設

### 權限查詢邏輯

```typescript
function getUserPermissions(userId: number, isAdmin: boolean) {
  // 管理員：所有權限
  if (isAdmin) {
    return getAllModulesEnabled();
  }
  
  // 員工：查詢順序
  // 1. 查詢個別設定
  const userPerm = await db.query(
    `SELECT * FROM ModulePermissions WHERE user_id = ?`, [userId]
  );
  
  if (userPerm) {
    return userPerm;  // 有個別設定，使用個別設定
  }
  
  // 2. 無個別設定，使用預設模板
  const defaultPerm = await db.query(
    `SELECT * FROM ModulePermissions WHERE user_id IS NULL`
  );
  
  return defaultPerm || getAllModulesDisabled();
}
```

---

## 可控制的模塊

### 管理員專屬（8個，不可開放）

| 模塊 | 說明 |
|------|------|
| 員工權限設定 | 控制員工模塊可見性 |
| 業務規則管理 | 假期規則、加班費率等 |
| 員工帳號管理 | 新增、編輯員工帳號 |
| 外部文章管理 | 管理公開網站文章 |
| 外部FAQ管理 | 管理公開網站FAQ |
| 外部圖片管理 | 管理公開網站圖片 |
| 外部資源管理 | 管理公開網站下載資源 |
| 預約表單設定 | 設定預約表單欄位 |

### 可開放給員工（14個）

| 模塊代號 | 模塊名稱 | 預設開放 |
|---------|---------|---------|
| `dashboard` | 儀表板 | ✓ |
| `personal_settings` | 個人資料設定 | ✓ |
| `timesheet` | 工時表填寫 | ✓ |
| `reports` | 報表中心 | ✗ |
| `life_events` | 生活事件登記 | ✗ |
| `task_templates` | 任務模板管理 | ✗ |
| `tasks` | 任務進度追蹤 | ✗ |
| `stage_updates` | 階段進度更新 | ✗ |
| `client_services` | 客戶服務設定 | ✗ |
| `booking_records` | 預約記錄查看 | ✗ |
| `sop_management` | SOP文件管理 | ✗ |
| `knowledge_base` | 通用知識庫 | ✗ |
| `service_management` | 服務項目管理 | ✗ |
| `csv_import` | CSV導入功能 | ✗ |

---

## 資料範圍控制

**原則：** 不在權限表控制，由業務邏輯控制

### 員工看自己

```typescript
// 工時表、假期記錄、任務
if (!isAdmin) {
  query += ` WHERE user_id = ?`;
  params.push(currentUserId);
}
```

### 管理員看全部

```typescript
// 不加 WHERE user_id = ? 條件
const allRecords = await db.query(`SELECT * FROM TimeLogs`);
```

### 客戶資料（全員可見）

```typescript
// 所有員工都能看到所有客戶
// 由模塊權限控制是否能進入客戶管理模塊
const clients = await db.query(`SELECT * FROM Clients`);
```

---

## 前端路由保護

### Vue Router Guard

```typescript
router.beforeEach(async (to, from, next) => {
  const { isAdmin, permissions } = await fetchCurrentUserPermissions();
  
  // 管理員專屬路由
  if (to.meta.adminOnly && !isAdmin) {
    return next('/403');
  }
  
  // 員工模塊權限檢查
  const requiredModule = to.meta.requiredModule;
  if (requiredModule && !permissions[requiredModule]) {
    return next('/403');
  }
  
  next();
});
```

### 路由配置範例

```typescript
{
  path: '/settings/permissions',
  component: PermissionsPage,
  meta: { adminOnly: true }  // 管理員專屬
},
{
  path: '/tasks',
  component: TasksPage,
  meta: { requiredModule: 'tasks' }  // 需要 tasks 模塊權限
}
```

---

## API 權限驗證

### 中間件設計

```typescript
// 1. 管理員專屬 API
app.get('/api/v1/admin/*', requireAdmin, handler);

// 2. 需要特定模塊權限的 API
app.get('/api/v1/tasks', requireModule('tasks'), handler);

// 3. 所有登入用戶都可訪問
app.get('/api/v1/dashboard', authMiddleware, handler);
```

### Middleware 實作

```typescript
function requireAdmin(c, next) {
  if (!c.user.is_admin) {
    return c.json({ success: false, error: '僅管理員可訪問' }, 403);
  }
  return next();
}

function requireModule(moduleName: string) {
  return async (c, next) => {
    if (c.user.is_admin) {
      return next();  // 管理員跳過檢查
    }
    
    const hasPermission = await checkModulePermission(c.user.user_id, moduleName);
    if (!hasPermission) {
      return c.json({ success: false, error: '無此模塊權限' }, 403);
    }
    
    return next();
  };
}
```

---

## 權限變更立即生效

### 機制

**前端：**
```typescript
// 每次進入頁面時重新獲取權限
onMounted(async () => {
  const newPerms = await fetchUserPermissions();
  store.updatePermissions(newPerms);
});
```

**後端：**
```typescript
// 不使用緩存，每次都查詢資料庫
// Cloudflare Workers 天生無狀態，無需特別處理
```

---

## 資料表設計

### ModulePermissions

| 欄位 | 類型 | 說明 |
|------|------|------|
| `permission_id` | INTEGER PK | 權限記錄 ID |
| `user_id` | INTEGER FK | 員工 ID（NULL = 預設模板） |
| `dashboard` | BOOLEAN | 儀表板 |
| `personal_settings` | BOOLEAN | 個人資料設定 |
| `timesheet` | BOOLEAN | 工時表 |
| `reports` | BOOLEAN | 報表中心 |
| `life_events` | BOOLEAN | 生活事件 |
| `task_templates` | BOOLEAN | 任務模板 |
| `tasks` | BOOLEAN | 任務追蹤 |
| `stage_updates` | BOOLEAN | 階段進度 |
| `client_services` | BOOLEAN | 客戶服務 |
| `booking_records` | BOOLEAN | 預約記錄 |
| `sop_management` | BOOLEAN | SOP 管理 |
| `knowledge_base` | BOOLEAN | 知識庫 |
| `service_management` | BOOLEAN | 服務項目 |
| `csv_import` | BOOLEAN | CSV 導入 |

**索引：**
```sql
CREATE UNIQUE INDEX idx_user_permissions ON ModulePermissions(user_id);
```

詳細資料表設計請參考：[ModulePermissions](../資料庫設計/權限系統/ModulePermissions.md)

---

## 相關文檔

- [功能模塊：員工權限設定](../功能模塊/01-員工權限設定.md)
- [技術規格：員工權限](../技術規格/員工權限/)
- [API規格：員工權限](../API規格/員工權限/)
- [資料庫設計：權限系統](../資料庫設計/權限系統/)

---

**最後更新：** 2025年10月27日  
**文檔版本：** 2.0（模塊化重組版）

