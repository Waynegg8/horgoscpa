# 效能優化

**最後更新：** 2025年10月27日

---

## 快取策略

### Cloudflare Cache API

```typescript
// services/cache.service.ts
export class CacheService {
  async get(key: string): Promise<any | null> {
    const cache = await caches.open('app-cache');
    const response = await cache.match(key);
    
    if (!response) return null;
    
    return await response.json();
  }
  
  async set(key: string, data: any, ttl: number): Promise<void> {
    const cache = await caches.open('app-cache');
    const response = new Response(JSON.stringify(data), {
      headers: {
        'Cache-Control': `max-age=${ttl}`,
        'Content-Type': 'application/json'
      }
    });
    
    await cache.put(key, response);
  }
  
  async invalidate(pattern: string): Promise<void> {
    const cache = await caches.open('app-cache');
    const keys = await cache.keys();
    
    for (const request of keys) {
      if (request.url.includes(pattern)) {
        await cache.delete(request);
      }
    }
  }
}
```

---

## 快取策略表

| 資料類型 | TTL | 說明 |
|----------|-----|------|
| 系統設定 | 1 小時 | 模塊可見性、業務規則 |
| 客戶列表 | 5 分鐘 | 客戶基本資料 |
| 使用者權限 | 15 分鐘 | 登入使用者的權限資訊 |
| 業務規則 | 1 小時 | 加班費率、假別類型 |

---

## 快取使用範例

```typescript
// 系統設定（TTL: 1 小時）
const settings = await cache.get('system_settings');
if (!settings) {
  const data = await db.query('SELECT * FROM SystemSettings');
  await cache.set('system_settings', data, 3600);
}

// 業務規則（TTL: 1 小時）
const overtimeRates = await cache.get('overtime_rates');
if (!overtimeRates) {
  const data = await db.query('SELECT * FROM OvertimeRates');
  await cache.set('overtime_rates', data, 3600);
}

// 客戶列表（TTL: 5 分鐘）
const clients = await cache.get(`clients_page_${page}`);
if (!clients) {
  const data = await clientRepo.findAll({ page });
  await cache.set(`clients_page_${page}`, data, 300);
}
```

---

## 快取失效規則

```typescript
// 當系統設定被更新時，清除快取
await settingsRepo.update(key, value);
await cache.invalidate('system_settings');

// 當客戶資料被修改時，清除客戶列表快取
await clientRepo.update(clientId, data);
await cache.invalidate('clients_page');
```

---

## 資料庫優化

### 索引策略

```sql
-- 工時表索引
CREATE INDEX idx_timelogs_user_date ON TimeLogs(user_id, work_date);
CREATE INDEX idx_timelogs_client ON TimeLogs(client_id);

-- 客戶索引
CREATE INDEX idx_clients_assignee ON Clients(assignee_user_id);

-- 任務索引
CREATE INDEX idx_activetasks_user ON ActiveTasks(assigned_user_id);
CREATE INDEX idx_activetasks_status ON ActiveTasks(status);

-- 階段索引
CREATE INDEX idx_stages_task ON ActiveTaskStages(active_task_id);
```

### JOIN 優化
- 避免 N+1 查詢問題
- 使用適當的 JOIN 減少查詢次數
- Cloudflare Workers 自動管理 D1 連線

---

## 前端優化

### 組件懶加載
```typescript
// router/index.ts
const routes = [
  {
    path: '/tasks',
    component: () => import('@/pages/Tasks.vue')  // 懶加載
  }
];
```

### 虛擬滾動（大列表）
對於客戶列表、工時記錄等大量資料，使用虛擬滾動減少 DOM 節點

---

## 相關文檔

- [架構設計](../架構設計.md)
- [資料庫設計](../資料庫設計.md)
- [開發規範](../開發規範.md)

---

**最後更新：** 2025年10月27日



**最後更新：** 2025年10月27日

---

## 快取策略

### Cloudflare Cache API

```typescript
// services/cache.service.ts
export class CacheService {
  async get(key: string): Promise<any | null> {
    const cache = await caches.open('app-cache');
    const response = await cache.match(key);
    
    if (!response) return null;
    
    return await response.json();
  }
  
  async set(key: string, data: any, ttl: number): Promise<void> {
    const cache = await caches.open('app-cache');
    const response = new Response(JSON.stringify(data), {
      headers: {
        'Cache-Control': `max-age=${ttl}`,
        'Content-Type': 'application/json'
      }
    });
    
    await cache.put(key, response);
  }
  
  async invalidate(pattern: string): Promise<void> {
    const cache = await caches.open('app-cache');
    const keys = await cache.keys();
    
    for (const request of keys) {
      if (request.url.includes(pattern)) {
        await cache.delete(request);
      }
    }
  }
}
```

---

## 快取策略表

| 資料類型 | TTL | 說明 |
|----------|-----|------|
| 系統設定 | 1 小時 | 模塊可見性、業務規則 |
| 客戶列表 | 5 分鐘 | 客戶基本資料 |
| 使用者權限 | 15 分鐘 | 登入使用者的權限資訊 |
| 業務規則 | 1 小時 | 加班費率、假別類型 |

---

## 快取使用範例

```typescript
// 系統設定（TTL: 1 小時）
const settings = await cache.get('system_settings');
if (!settings) {
  const data = await db.query('SELECT * FROM SystemSettings');
  await cache.set('system_settings', data, 3600);
}

// 業務規則（TTL: 1 小時）
const overtimeRates = await cache.get('overtime_rates');
if (!overtimeRates) {
  const data = await db.query('SELECT * FROM OvertimeRates');
  await cache.set('overtime_rates', data, 3600);
}

// 客戶列表（TTL: 5 分鐘）
const clients = await cache.get(`clients_page_${page}`);
if (!clients) {
  const data = await clientRepo.findAll({ page });
  await cache.set(`clients_page_${page}`, data, 300);
}
```

---

## 快取失效規則

```typescript
// 當系統設定被更新時，清除快取
await settingsRepo.update(key, value);
await cache.invalidate('system_settings');

// 當客戶資料被修改時，清除客戶列表快取
await clientRepo.update(clientId, data);
await cache.invalidate('clients_page');
```

---

## 資料庫優化

### 索引策略

```sql
-- 工時表索引
CREATE INDEX idx_timelogs_user_date ON TimeLogs(user_id, work_date);
CREATE INDEX idx_timelogs_client ON TimeLogs(client_id);

-- 客戶索引
CREATE INDEX idx_clients_assignee ON Clients(assignee_user_id);

-- 任務索引
CREATE INDEX idx_activetasks_user ON ActiveTasks(assigned_user_id);
CREATE INDEX idx_activetasks_status ON ActiveTasks(status);

-- 階段索引
CREATE INDEX idx_stages_task ON ActiveTaskStages(active_task_id);
```

### JOIN 優化
- 避免 N+1 查詢問題
- 使用適當的 JOIN 減少查詢次數
- Cloudflare Workers 自動管理 D1 連線

---

## 前端優化

### 組件懶加載
```typescript
// router/index.ts
const routes = [
  {
    path: '/tasks',
    component: () => import('@/pages/Tasks.vue')  // 懶加載
  }
];
```

### 虛擬滾動（大列表）
對於客戶列表、工時記錄等大量資料，使用虛擬滾動減少 DOM 節點

---

## 相關文檔

- [架構設計](../架構設計.md)
- [資料庫設計](../資料庫設計.md)
- [開發規範](../開發規範.md)

---

**最後更新：** 2025年10月27日



