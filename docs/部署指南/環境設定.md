# 環境設定

**文檔類型：** 部署指南  
**最後更新：** 2025年10月27日

---

## Cloudflare 環境配置

### 1. 建立 Cloudflare 帳號

訪問 https://dash.cloudflare.com/ 註冊帳號

---

### 2. 安裝 Wrangler CLI

```bash
npm install -g wrangler

# 登入
wrangler login
```

---

### 3. 建立 D1 資料庫

```bash
wrangler d1 create accounting_db
```

**輸出：**
```
✅ Successfully created DB 'accounting_db'

[[d1_databases]]
binding = "DB"
database_name = "accounting_db"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

**複製 `database_id` 備用**

---

### 4. 建立 R2 儲存桶

```bash
wrangler r2 bucket create accounting-files
```

---

### 5. 環境變數管理

**檔案結構：**
```
/.env.example          # 環境變數範本（不含敏感資訊，可提交 Git）
/.env.development      # 開發環境
/.env.production       # 正式環境
/.gitignore            # 確保 .env.* 不被提交
```

**`.env.example` 內容：**
```bash
# JWT 設定
JWT_SECRET=your-secret-key-here-please-change
JWT_EXPIRES_IN=86400

# Cloudflare D1
DATABASE_ID=your-database-id-here

# Cloudflare R2
R2_BUCKET_NAME=accounting-files

# 系統設定
ALLOWED_ORIGINS=https://admin.yourfirm.com
DEFAULT_ADMIN_PASSWORD=ChangeThisPassword123

# Rate Limiting
MAX_REQUESTS_PER_MINUTE=60
LOGIN_MAX_ATTEMPTS=5

# 其他
TIME_ZONE=Asia/Taipei
```

**`.env.production` 內容（實際使用）：**
```bash
JWT_SECRET=your-actual-super-secure-random-string-here-32-chars-minimum
JWT_EXPIRES_IN=86400

DATABASE_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
R2_BUCKET_NAME=accounting-files

ALLOWED_ORIGINS=https://admin.yourfirm.com
TIME_ZONE=Asia/Taipei
```

---

### 6. 配置 wrangler.toml

```toml
name = "accounting-platform-api"
main = "src/index.ts"
compatibility_date = "2025-10-27"

# Cron Triggers
[triggers]
crons = [
  "0 1 * * *",  # task-generator（每日 01:00）
  "0 2 * * *",  # overdue-detector（每日 02:00）
  "0 3 * * *"   # backup（每日 03:00）
]

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "accounting_db"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"  # 從步驟 3 取得

# R2 Bucket
[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "accounting-files"

# Environment Variables (Secrets)
[vars]
ALLOWED_ORIGINS = "https://admin.yourfirm.com"

# 敏感資訊使用 Secrets（不放在 wrangler.toml）
# 使用指令設定：
# wrangler secret put JWT_SECRET
```

---

### 7. 設定 Secrets

```bash
# 設定 JWT 密鑰
wrangler secret put JWT_SECRET
# 輸入一個強隨機字串（至少 32 字元）

# 確認已設定
wrangler secret list
```

**產生安全的 JWT_SECRET：**
```bash
# 使用 Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# 輸出範例：
# a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6
```

---

### 8. 前端環境變數（Cloudflare Pages）

**檔案：** `/frontend/.env.production`

```bash
VITE_API_BASE_URL=https://api.yourfirm.com
VITE_APP_NAME=會計師事務所管理平台
```

---

### 9. 安全設定

#### CSP Header

在 Cloudflare Workers 中設定：

```typescript
// middlewares/security.middleware.ts
app.use('*', async (c, next) => {
  await next();
  
  c.header('Content-Security-Policy', 
    "default-src 'self'; " +
    "script-src 'self' 'unsafe-inline'; " +
    "style-src 'self' 'unsafe-inline'; " +
    "img-src 'self' https://files.yourfirm.com data:; " +
    "connect-src 'self'"
  );
});
```

---

#### CORS 設定

```typescript
import { cors } from 'hono/cors';

app.use('*', cors({
  origin: process.env.ALLOWED_ORIGINS.split(','),
  credentials: true
}));
```

---

### 10. Cloudflare Dashboard 設定

1. **SSL/TLS 模式**：Full (strict)
2. **WAF 規則**：啟用
3. **DNS 設定**：
   - `admin.yourfirm.com` → Cloudflare Pages
   - `api.yourfirm.com` → Cloudflare Workers

---

**相關文檔：**
- [初始化流程](./初始化流程.md)
- [部署檢查清單](./部署檢查清單.md)

