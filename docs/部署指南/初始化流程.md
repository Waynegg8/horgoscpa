# 系統初始化流程

**文檔類型：** 部署指南  
**最後更新：** 2025年10月27日

---

## 初始化概述

本文檔說明系統首次上線時的初始化步驟，包括資料庫設定、管理員帳號建立、業務規則配置等。

---

## 步驟一：Cloudflare 環境設定

### 1.1 建立 D1 資料庫

```bash
# 建立資料庫
wrangler d1 create accounting_db

# 記錄 database_id
# 將 database_id 填入 wrangler.toml
```

### 1.2 建立 R2 儲存桶

```bash
wrangler r2 bucket create accounting-files
```

### 1.3 執行 Schema 初始化

```bash
# 執行所有 CREATE TABLE 語句
wrangler d1 execute accounting_db --file=./schema.sql
```

---

## 步驟二：建立管理員帳號

### 2.1 插入管理員資料

```sql
INSERT INTO Users (name, username, hashed_password, is_admin, gender) 
VALUES (
  '系統管理員',
  'admin@yourfirm.com',
  '$argon2id$v=19$m=65536,t=3,p=4$...',  -- 使用 Argon2 雜湊後的密碼
  1,
  'female'
);
```

**密碼雜湊工具：**
```typescript
// 使用 Node.js 腳本產生雜湊
import argon2 from 'argon2';

const password = 'YourSecurePassword123';
const hash = await argon2.hash(password);
console.log(hash);
```

---

## 步驟三：初始化業務規則

### 3.1 匯入國定假日

```sql
INSERT INTO Holidays (holiday_date, name) VALUES 
  ('2025-01-01', '元旦'),
  ('2025-01-28', '農曆春節'),
  ('2025-02-28', '和平紀念日'),
  ('2025-04-04', '清明節'),
  ('2025-05-01', '勞動節'),
  ('2025-06-10', '端午節'),
  ('2025-09-17', '中秋節'),
  ('2025-10-10', '國慶日');
```

---

### 3.2 設定假別類型

```sql
INSERT INTO LeaveTypes (name, is_gender_specific) VALUES 
  ('特休', 0),
  ('病假', 0),
  ('事假', 0),
  ('生理假', 1),  -- 性別專屬
  ('婚假', 0),
  ('喪假', 0),
  ('產假', 1),
  ('陪產假', 0);
```

---

### 3.3 設定業務類型

```sql
INSERT INTO BusinessTypes (name) VALUES 
  ('記帳'),
  ('工商'),
  ('稅務'),
  ('簽證'),
  ('審計');
```

---

### 3.4 設定加班費率

```sql
INSERT INTO OvertimeRates (overtime_type, start_hour, end_hour, rate) VALUES 
  ('平日加班', 18, 22, 1.34),
  ('平日加班', 22, 24, 1.67),
  ('假日加班', 0, 24, 2.00);
```

---

### 3.5 設定特休規則

```sql
INSERT INTO AnnualLeaveRules (min_seniority_years, grant_days) VALUES 
  (0, 3),   -- 滿半年
  (1, 7),   -- 滿1年
  (2, 10),  -- 滿2年
  (3, 14),  -- 滿3年
  (5, 15);  -- 滿5年
```

---

### 3.6 設定其他假期規則

```sql
INSERT INTO OtherLeaveRules (name, grant_days, grant_type) VALUES 
  ('病假', 30, '年度給假'),
  ('事假', 14, '年度給假'),
  ('生理假', 12, '年度給假'),
  ('婚假', 8, '事件給假'),
  ('喪假', 3, '事件給假');
```

---

## 步驟四：建立服務項目

### 4.1 建立服務模板

```sql
INSERT INTO ServiceTemplates (name, description) VALUES 
  ('記帳服務', '月度或雙月記帳服務'),
  ('工商登記服務', '公司設立、變更等工商業務'),
  ('稅務申報服務', '營所稅、營業稅申報');
```

---

## 步驟五：建立任務模板

### 5.1 記帳服務任務模板

```sql
-- 建立模板
INSERT INTO TaskTemplates (name, service_template_id, description) 
VALUES (
  '記帳標準流程（雙月）', 
  1, 
  '雙月記帳服務的標準作業流程'
);

-- 取得 template_id（假設為 1）

-- 建立階段
INSERT INTO TaskStageTemplates 
  (task_template_id, stage_name, stage_order, estimated_days, description) 
VALUES 
  (1, '資料收集與核對', 1, 3, '收集發票、銀行對帳單等資料'),
  (1, '營業稅過帳', 2, 2, '營業稅申報與過帳'),
  (1, '提列折舊', 3, 1, '計算並提列折舊'),
  (1, '財務報表產出', 4, 2, '產生資產負債表、損益表');
```

---

## 步驟六：設定模塊可見性

```sql
INSERT INTO SystemSettings (key, value) VALUES 
  ('module_visibility_dashboard', 'true'),
  ('module_visibility_timesheet', 'true'),
  ('module_visibility_tasks', 'true'),
  ('module_visibility_leave', 'true'),
  ('module_visibility_sop', 'false'),
  ('module_visibility_knowledge', 'false'),
  ('module_visibility_clients', 'false'),
  ('module_visibility_cms', 'false');
```

**說明：** 預設讓員工可見基本功能，其他進階功能需管理員手動開啟

---

## 步驟七：導入客戶資料

### 7.1 準備 CSV 檔案

使用「模塊一：系統設定」中的 CSV 導入功能，或手動執行：

```sql
INSERT INTO Clients 
  (client_id, company_name, assignee_user_id, contact_person_1, phone) 
VALUES 
  ('12345678', '仟鑽企業', 2, '王先生', '02-1234-5678'),
  ('87654321', '宏達公司', 3, '李小姐', '02-8765-4321');
```

---

## 步驟八：為客戶設定服務

### 8.1 設定週期性服務

```sql
INSERT INTO ClientServices 
  (client_id, service_template_id, frequency, fee, trigger_months, is_active) 
VALUES 
  ('12345678', 1, '雙月', 15000, '[1,3,5,7,9,11]', 1),  -- 仟鑽的雙月記帳
  ('87654321', 1, '每月', 20000, '[1,2,3,4,5,6,7,8,9,10,11,12]', 1);  -- 宏達的每月記帳
```

---

## 步驟九：新增員工帳號

```sql
INSERT INTO Users (name, username, hashed_password, is_admin, gender) 
VALUES 
  ('紜蓁', 'yunzhen@firm.com', '$argon2...', 0, 'female'),
  ('凱閔', 'kaimin@firm.com', '$argon2...', 0, 'male'),
  ('欣怡', 'xinyi@firm.com', '$argon2...', 0, 'female');
```

---

## 步驟十：驗證系統

### 10.1 登入測試

1. 使用管理員帳號登入
2. 檢查是否可存取「系統設定」
3. 使用員工帳號登入
4. 檢查導航欄是否正確（僅顯示允許的模塊）

### 10.2 Cron Job 測試

```bash
# 手動觸發 Cron Job（開發環境）
wrangler dev --test-scheduled
```

**檢查：**
- 是否正確建立任務實例
- 階段是否正確產生
- 到期日是否正確計算

---

## 步驟十一：部署至正式環境

### 11.1 部署前檢查

參閱 [部署檢查清單](./部署檢查清單.md)

### 11.2 部署指令

```bash
# 部署 Workers
wrangler deploy

# 部署 Pages (前端)
npm run build
wrangler pages deploy dist
```

---

## 初始化檢查清單

- [ ] Cloudflare D1 資料庫已建立
- [ ] R2 儲存桶已建立
- [ ] Schema 已執行（所有表格已建立）
- [ ] 管理員帳號已建立
- [ ] 國定假日已匯入
- [ ] 假別類型已設定
- [ ] 業務類型已設定
- [ ] 加班費率已設定
- [ ] 假期規則已設定
- [ ] 服務項目已建立
- [ ] 至少建立 1 個任務模板
- [ ] 模塊可見性已設定
- [ ] 客戶資料已導入
- [ ] 客戶服務已設定
- [ ] 員工帳號已建立
- [ ] 登入測試通過
- [ ] Cron Job 測試通過
- [ ] 已部署至正式環境

---

**相關文檔：**
- [資料庫設計](../資料庫設計.md)
- [部署檢查清單](./部署檢查清單.md)
- [環境設定](./環境設定.md)

