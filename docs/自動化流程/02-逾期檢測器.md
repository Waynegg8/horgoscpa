# 02 - é€¾æœŸæª¢æ¸¬å™¨ (Overdue Detector)

**Cron Jobåç¨±ï¼š** Overdue Detector  
**åŸ·è¡Œé »ç‡ï¼š** æ¯å¤©å‡Œæ™¨ 2:00 AM  
**Cronè¡¨é”å¼ï¼š** `0 2 * * *`  
**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´10æœˆ27æ—¥

---

## åŠŸèƒ½æ¦‚è¿°

æ¯æ—¥è‡ªå‹•æª¢æŸ¥æ‰€æœ‰é€²è¡Œä¸­çš„ä»»å‹™éšæ®µï¼ˆ`ActiveTaskStages`ï¼‰ï¼Œå°‡å·²è¶…éåˆ°æœŸæ—¥ï¼ˆ`due_date`ï¼‰çš„éšæ®µæ¨™è¨˜ç‚ºã€Œé€¾æœŸã€ç‹€æ…‹ã€‚

**ç›®çš„ï¼š**
- è‡ªå‹•è­˜åˆ¥é€¾æœŸä»»å‹™
- æä¾›è¦–è¦ºåŒ–é€¾æœŸæé†’ï¼ˆç´…è‰²æ¨™è¨˜ï¼‰
- ç‚ºç®¡ç†å“¡æä¾›é€¾æœŸå ±è¡¨æ•¸æ“š

---

## åŸ·è¡Œé‚è¼¯

### æ­¥é©Ÿ 1ï¼šæŸ¥è©¢éœ€è¦æª¢æŸ¥çš„éšæ®µ

```typescript
const today = new Date().toISOString().split('T')[0];  // YYYY-MM-DD

const stages = await db.prepare(`
  SELECT 
    ats.active_stage_id,
    ats.active_task_id,
    ats.stage_name,
    ats.due_date,
    ats.status,
    at.task_name,
    c.name as client_name
  FROM ActiveTaskStages ats
  JOIN ActiveTasks at ON ats.active_task_id = at.active_task_id
  JOIN Clients c ON at.client_id = c.client_id
  WHERE ats.status IN ('not_started', 'in_progress')
    AND ats.due_date IS NOT NULL
    AND ats.due_date < ?
`).bind(today).all();

console.log(`Found ${stages.results.length} overdue stages`);
```

**æŸ¥è©¢æ¢ä»¶ï¼š**
- `status IN ('not_started', 'in_progress')` - åªæª¢æŸ¥æœªå®Œæˆçš„éšæ®µ
- `due_date IS NOT NULL` - æœ‰è¨­å®šåˆ°æœŸæ—¥çš„éšæ®µ
- `due_date < today` - å·²è¶…éåˆ°æœŸæ—¥

---

### æ­¥é©Ÿ 2ï¼šæ›´æ–°é€¾æœŸç‹€æ…‹

```typescript
let updatedCount = 0;

for (const stage of stages.results) {
  try {
    await db.prepare(`
      UPDATE ActiveTaskStages
      SET status = 'overdue',
          updated_at = datetime('now')
      WHERE active_stage_id = ?
    `).bind(stage.active_stage_id).run();
    
    updatedCount++;
    
    console.log(
      `âœ“ Marked overdue: ${stage.client_name} - ${stage.task_name} - ${stage.stage_name}`
    );
    
  } catch (error) {
    console.error(`âœ— Failed to update stage ${stage.active_stage_id}:`, error);
  }
}

console.log(`Updated ${updatedCount} stages to overdue status`);
```

---

### æ­¥é©Ÿ 3ï¼šæ›´æ–°ä»»å‹™æ•´é«”ç‹€æ…‹ï¼ˆå¯é¸ï¼‰

```typescript
// å¦‚æœä»»å‹™çš„æ‰€æœ‰éšæ®µéƒ½å®Œæˆï¼Œæ¨™è¨˜ä»»å‹™ç‚ºå®Œæˆ
// å¦‚æœä»»å‹™æœ‰ä»»ä½•éšæ®µé€¾æœŸï¼Œæ¨™è¨˜ä»»å‹™ç‚ºé€¾æœŸ

for (const stage of stages.results) {
  const taskStages = await db.prepare(`
    SELECT status FROM ActiveTaskStages
    WHERE active_task_id = ?
  `).bind(stage.active_task_id).all();
  
  const allStatuses = taskStages.results.map(s => s.status);
  
  // åˆ¤æ–·ä»»å‹™ç‹€æ…‹
  let taskStatus;
  if (allStatuses.every(s => s === 'completed')) {
    taskStatus = 'completed';
  } else if (allStatuses.some(s => s === 'overdue')) {
    taskStatus = 'overdue';
  } else if (allStatuses.some(s => s === 'in_progress')) {
    taskStatus = 'in_progress';
  } else {
    taskStatus = 'pending';
  }
  
  // æ›´æ–°ä»»å‹™ç‹€æ…‹
  await db.prepare(`
    UPDATE ActiveTasks
    SET status = ?,
        updated_at = datetime('now')
    WHERE active_task_id = ?
  `).bind(taskStatus, stage.active_task_id).run();
}
```

---

### æ­¥é©Ÿ 4ï¼šç”¢ç”Ÿé€¾æœŸå ±è¡¨ï¼ˆå¯é¸ï¼‰

```typescript
// çµ±è¨ˆé€¾æœŸæ•¸æ“š
const overdueStats = await db.prepare(`
  SELECT 
    COUNT(*) as total_overdue,
    COUNT(DISTINCT active_task_id) as tasks_affected,
    MIN(due_date) as earliest_overdue
  FROM ActiveTaskStages
  WHERE status = 'overdue'
`).first();

// æŒ‰å®¢æˆ¶åˆ†çµ„çµ±è¨ˆ
const byClient = await db.prepare(`
  SELECT 
    c.name as client_name,
    COUNT(*) as overdue_count
  FROM ActiveTaskStages ats
  JOIN ActiveTasks at ON ats.active_task_id = at.active_task_id
  JOIN Clients c ON at.client_id = c.client_id
  WHERE ats.status = 'overdue'
  GROUP BY c.client_id
  ORDER BY overdue_count DESC
  LIMIT 10
`).all();

console.log('Overdue Statistics:', {
  total: overdueStats.total_overdue,
  tasks: overdueStats.tasks_affected,
  topClients: byClient.results
});
```

---

### æ­¥é©Ÿ 5ï¼šç™¼é€é€šçŸ¥ï¼ˆå¯é¸ï¼‰

```typescript
// å¦‚æœé€¾æœŸæ•¸é‡è¶…éé–¾å€¼ï¼Œç™¼é€é€šçŸ¥çµ¦ç®¡ç†å“¡
if (overdueStats.total_overdue > 10) {
  await sendNotification({
    to: 'admin@accounting-firm.com',
    subject: `âš ï¸ ${overdueStats.total_overdue} å€‹ä»»å‹™éšæ®µå·²é€¾æœŸ`,
    body: `
      é€¾æœŸéšæ®µç¸½æ•¸ï¼š${overdueStats.total_overdue}
      å½±éŸ¿çš„ä»»å‹™æ•¸ï¼š${overdueStats.tasks_affected}
      æœ€æ—©é€¾æœŸæ—¥æœŸï¼š${overdueStats.earliest_overdue}
      
      è«‹ç™»å…¥ç³»çµ±æŸ¥çœ‹è©³æƒ…ã€‚
    `
  });
}
```

---

## å³å°‡åˆ°æœŸæé†’ï¼ˆæ“´å±•åŠŸèƒ½ï¼‰

### æå‰3å¤©æé†’

```typescript
const threeDaysLater = new Date();
threeDaysLater.setDate(threeDaysLater.getDate() + 3);
const targetDate = threeDaysLater.toISOString().split('T')[0];

const approachingStages = await db.prepare(`
  SELECT 
    ats.stage_name,
    ats.due_date,
    at.task_name,
    c.name as client_name,
    u.email as assignee_email
  FROM ActiveTaskStages ats
  JOIN ActiveTasks at ON ats.active_task_id = at.active_task_id
  JOIN Clients c ON at.client_id = c.client_id
  LEFT JOIN Users u ON at.assignee_user_id = u.user_id
  WHERE ats.status IN ('not_started', 'in_progress')
    AND ats.due_date = ?
`).bind(targetDate).all();

// ç™¼é€æé†’çµ¦è² è²¬å“¡å·¥
for (const stage of approachingStages.results) {
  if (stage.assignee_email) {
    await sendNotification({
      to: stage.assignee_email,
      subject: `ğŸ“… æé†’ï¼š${stage.stage_name} å°‡åœ¨3å¤©å¾Œåˆ°æœŸ`,
      body: `
        ä»»å‹™ï¼š${stage.task_name}
        å®¢æˆ¶ï¼š${stage.client_name}
        éšæ®µï¼š${stage.stage_name}
        åˆ°æœŸæ—¥ï¼š${stage.due_date}
      `
    });
  }
}
```

---

## æ•ˆèƒ½å„ªåŒ–

### ä½¿ç”¨ç´¢å¼•

**ç¢ºä¿æœ‰ç´¢å¼•ï¼š**
```sql
-- ActiveTaskStages è¡¨
CREATE INDEX idx_stages_status_due 
ON ActiveTaskStages(status, due_date);
```

**æŸ¥è©¢å„ªåŒ–ï¼š**
```typescript
// ä½¿ç”¨ç´¢å¼•çš„æŸ¥è©¢
WHERE status IN ('not_started', 'in_progress')  -- ä½¿ç”¨ç´¢å¼•
  AND due_date < ?                              -- ä½¿ç”¨ç´¢å¼•
```

---

### æ‰¹æ¬¡æ›´æ–°

```typescript
// ä½¿ç”¨å–®ä¸€ UPDATE èªå¥æ‰¹æ¬¡æ›´æ–°
await db.prepare(`
  UPDATE ActiveTaskStages
  SET status = 'overdue',
      updated_at = datetime('now')
  WHERE status IN ('not_started', 'in_progress')
    AND due_date IS NOT NULL
    AND due_date < ?
`).bind(today).run();
```

---

## éŒ¯èª¤è™•ç†

### è³‡æ–™åº«é–å®š

```typescript
try {
  await updateOverdueStatus();
} catch (error) {
  if (error.message.includes('database is locked')) {
    console.warn('Database locked, retrying in 5 seconds...');
    await sleep(5000);
    await updateOverdueStatus();
  } else {
    throw error;
  }
}
```

### éƒ¨åˆ†å¤±æ•—è™•ç†

```typescript
// å³ä½¿éƒ¨åˆ†æ›´æ–°å¤±æ•—ï¼Œä¹Ÿç¹¼çºŒè™•ç†å‰©é¤˜é …ç›®
// è¨˜éŒ„å¤±æ•—é …ç›®ä¾›å¾ŒçºŒäººå·¥è™•ç†
const failures = [];

for (const stage of stages.results) {
  try {
    await updateStage(stage);
  } catch (error) {
    failures.push({
      stageId: stage.active_stage_id,
      error: error.message
    });
  }
}

if (failures.length > 0) {
  console.error('Failed to update stages:', failures);
  // è¨˜éŒ„åˆ°æ—¥èªŒè¡¨
  await logFailures(failures);
}
```

---

## æ¸¬è©¦æ–¹å¼

### æ‰‹å‹•è§¸ç™¼

```bash
# Cloudflare Workers Dashboard
# Triggers â†’ Cron Triggers â†’ æ‰‹å‹•è§¸ç™¼ "Overdue Detector"
```

### æœ¬åœ°æ¸¬è©¦

```typescript
// å»ºç«‹æ¸¬è©¦æ•¸æ“š
await db.prepare(`
  INSERT INTO ActiveTaskStages (
    active_task_id, stage_name, status, due_date
  ) VALUES (1, 'Test Stage', 'in_progress', '2024-01-01')
`).run();

// åŸ·è¡Œæª¢æ¸¬å™¨
await overdueDetector();

// é©—è­‰ç‹€æ…‹å·²æ›´æ–°
const updated = await db.prepare(`
  SELECT status FROM ActiveTaskStages WHERE stage_name = 'Test Stage'
`).first();

console.assert(updated.status === 'overdue', 'Status should be overdue');
```

---

## ç›£æ§èˆ‡æ—¥èªŒ

### é—œéµæŒ‡æ¨™

```typescript
const metrics = {
  executionTime: endTime - startTime,
  stagesChecked: stages.results.length,
  stagesUpdated: updatedCount,
  tasksAffected: affectedTasks.size,
  errors: errorCount
};

console.log('Overdue Detection Complete:', metrics);

// è¨˜éŒ„åˆ°å¯©è¨ˆæ—¥èªŒ
await db.prepare(`
  INSERT INTO AuditLogs (action, details, created_at)
  VALUES ('overdue_detection', ?, datetime('now'))
`).bind(JSON.stringify(metrics)).run();
```

---

## å‰ç«¯é¡¯ç¤º

### é€¾æœŸæ¨™è¨˜

**CSSæ¨£å¼ï¼š**
```css
.stage-overdue {
  border-left: 4px solid #ef4444;
  background-color: #fee2e2;
}

.stage-overdue .due-date {
  color: #dc2626;
  font-weight: 600;
}
```

**Vueçµ„ä»¶ï¼š**
```vue
<div :class="['stage-card', { 'stage-overdue': stage.status === 'overdue' }]">
  <span class="stage-name">{{ stage.stage_name }}</span>
  <span class="due-date">
    {{ stage.status === 'overdue' ? 'å·²é€¾æœŸ' : stage.due_date }}
  </span>
</div>
```

---

## ç›¸é—œæ–‡æª”

- [åŠŸèƒ½æ¨¡å¡Šï¼šä»»å‹™é€²åº¦è¿½è¹¤](../åŠŸèƒ½æ¨¡å¡Š/16-ä»»å‹™é€²åº¦è¿½è¹¤.md)
- [åŠŸèƒ½æ¨¡å¡Šï¼šéšæ®µé€²åº¦æ›´æ–°](../åŠŸèƒ½æ¨¡å¡Š/17-éšæ®µé€²åº¦æ›´æ–°.md)
- [è³‡æ–™åº«è¨­è¨ˆï¼šActiveTaskStages](../è³‡æ–™åº«è¨­è¨ˆ/ä»»å‹™ç³»çµ±/ActiveTaskStages.md)

---

**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´10æœˆ27æ—¥  
**æ–‡æª”ç‰ˆæœ¬ï¼š** 2.0ï¼ˆæ¨¡å¡ŠåŒ–é‡çµ„ç‰ˆï¼‰

