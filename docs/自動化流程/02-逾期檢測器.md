# 02 - 逾期檢測器 (Overdue Detector)

**Cron Job名稱：** Overdue Detector  
**執行頻率：** 每天凌晨 2:00 AM  
**Cron表達式：** `0 2 * * *`  
**最後更新：** 2025年10月27日

---

## 功能概述

每日自動檢查所有進行中的任務階段（`ActiveTaskStages`），將已超過到期日（`due_date`）的階段標記為「逾期」狀態。

**目的：**
- 自動識別逾期任務
- 提供視覺化逾期提醒（紅色標記）
- 為管理員提供逾期報表數據

---

## 執行邏輯

### 步驟 1：查詢需要檢查的階段

```typescript
const today = new Date().toISOString().split('T')[0];  // YYYY-MM-DD

const stages = await db.prepare(`
  SELECT 
    ats.active_stage_id,
    ats.active_task_id,
    ats.stage_name,
    ats.due_date,
    ats.status,
    at.task_name,
    c.name as client_name
  FROM ActiveTaskStages ats
  JOIN ActiveTasks at ON ats.active_task_id = at.active_task_id
  JOIN Clients c ON at.client_id = c.client_id
  WHERE ats.status IN ('not_started', 'in_progress')
    AND ats.due_date IS NOT NULL
    AND ats.due_date < ?
`).bind(today).all();

console.log(`Found ${stages.results.length} overdue stages`);
```

**查詢條件：**
- `status IN ('not_started', 'in_progress')` - 只檢查未完成的階段
- `due_date IS NOT NULL` - 有設定到期日的階段
- `due_date < today` - 已超過到期日

---

### 步驟 2：更新逾期狀態

```typescript
let updatedCount = 0;

for (const stage of stages.results) {
  try {
    await db.prepare(`
      UPDATE ActiveTaskStages
      SET status = 'overdue',
          updated_at = datetime('now')
      WHERE active_stage_id = ?
    `).bind(stage.active_stage_id).run();
    
    updatedCount++;
    
    console.log(
      `✓ Marked overdue: ${stage.client_name} - ${stage.task_name} - ${stage.stage_name}`
    );
    
  } catch (error) {
    console.error(`✗ Failed to update stage ${stage.active_stage_id}:`, error);
  }
}

console.log(`Updated ${updatedCount} stages to overdue status`);
```

---

### 步驟 3：更新任務整體狀態（可選）

```typescript
// 如果任務的所有階段都完成，標記任務為完成
// 如果任務有任何階段逾期，標記任務為逾期

for (const stage of stages.results) {
  const taskStages = await db.prepare(`
    SELECT status FROM ActiveTaskStages
    WHERE active_task_id = ?
  `).bind(stage.active_task_id).all();
  
  const allStatuses = taskStages.results.map(s => s.status);
  
  // 判斷任務狀態
  let taskStatus;
  if (allStatuses.every(s => s === 'completed')) {
    taskStatus = 'completed';
  } else if (allStatuses.some(s => s === 'overdue')) {
    taskStatus = 'overdue';
  } else if (allStatuses.some(s => s === 'in_progress')) {
    taskStatus = 'in_progress';
  } else {
    taskStatus = 'pending';
  }
  
  // 更新任務狀態
  await db.prepare(`
    UPDATE ActiveTasks
    SET status = ?,
        updated_at = datetime('now')
    WHERE active_task_id = ?
  `).bind(taskStatus, stage.active_task_id).run();
}
```

---

### 步驟 4：產生逾期報表（可選）

```typescript
// 統計逾期數據
const overdueStats = await db.prepare(`
  SELECT 
    COUNT(*) as total_overdue,
    COUNT(DISTINCT active_task_id) as tasks_affected,
    MIN(due_date) as earliest_overdue
  FROM ActiveTaskStages
  WHERE status = 'overdue'
`).first();

// 按客戶分組統計
const byClient = await db.prepare(`
  SELECT 
    c.name as client_name,
    COUNT(*) as overdue_count
  FROM ActiveTaskStages ats
  JOIN ActiveTasks at ON ats.active_task_id = at.active_task_id
  JOIN Clients c ON at.client_id = c.client_id
  WHERE ats.status = 'overdue'
  GROUP BY c.client_id
  ORDER BY overdue_count DESC
  LIMIT 10
`).all();

console.log('Overdue Statistics:', {
  total: overdueStats.total_overdue,
  tasks: overdueStats.tasks_affected,
  topClients: byClient.results
});
```

---

### 步驟 5：發送通知（可選）

```typescript
// 如果逾期數量超過閾值，發送通知給管理員
if (overdueStats.total_overdue > 10) {
  await sendNotification({
    to: 'admin@accounting-firm.com',
    subject: `⚠️ ${overdueStats.total_overdue} 個任務階段已逾期`,
    body: `
      逾期階段總數：${overdueStats.total_overdue}
      影響的任務數：${overdueStats.tasks_affected}
      最早逾期日期：${overdueStats.earliest_overdue}
      
      請登入系統查看詳情。
    `
  });
}
```

---

## 即將到期提醒（擴展功能）

### 提前3天提醒

```typescript
const threeDaysLater = new Date();
threeDaysLater.setDate(threeDaysLater.getDate() + 3);
const targetDate = threeDaysLater.toISOString().split('T')[0];

const approachingStages = await db.prepare(`
  SELECT 
    ats.stage_name,
    ats.due_date,
    at.task_name,
    c.name as client_name,
    u.email as assignee_email
  FROM ActiveTaskStages ats
  JOIN ActiveTasks at ON ats.active_task_id = at.active_task_id
  JOIN Clients c ON at.client_id = c.client_id
  LEFT JOIN Users u ON at.assignee_user_id = u.user_id
  WHERE ats.status IN ('not_started', 'in_progress')
    AND ats.due_date = ?
`).bind(targetDate).all();

// 發送提醒給負責員工
for (const stage of approachingStages.results) {
  if (stage.assignee_email) {
    await sendNotification({
      to: stage.assignee_email,
      subject: `📅 提醒：${stage.stage_name} 將在3天後到期`,
      body: `
        任務：${stage.task_name}
        客戶：${stage.client_name}
        階段：${stage.stage_name}
        到期日：${stage.due_date}
      `
    });
  }
}
```

---

## 效能優化

### 使用索引

**確保有索引：**
```sql
-- ActiveTaskStages 表
CREATE INDEX idx_stages_status_due 
ON ActiveTaskStages(status, due_date);
```

**查詢優化：**
```typescript
// 使用索引的查詢
WHERE status IN ('not_started', 'in_progress')  -- 使用索引
  AND due_date < ?                              -- 使用索引
```

---

### 批次更新

```typescript
// 使用單一 UPDATE 語句批次更新
await db.prepare(`
  UPDATE ActiveTaskStages
  SET status = 'overdue',
      updated_at = datetime('now')
  WHERE status IN ('not_started', 'in_progress')
    AND due_date IS NOT NULL
    AND due_date < ?
`).bind(today).run();
```

---

## 錯誤處理

### 資料庫鎖定

```typescript
try {
  await updateOverdueStatus();
} catch (error) {
  if (error.message.includes('database is locked')) {
    console.warn('Database locked, retrying in 5 seconds...');
    await sleep(5000);
    await updateOverdueStatus();
  } else {
    throw error;
  }
}
```

### 部分失敗處理

```typescript
// 即使部分更新失敗，也繼續處理剩餘項目
// 記錄失敗項目供後續人工處理
const failures = [];

for (const stage of stages.results) {
  try {
    await updateStage(stage);
  } catch (error) {
    failures.push({
      stageId: stage.active_stage_id,
      error: error.message
    });
  }
}

if (failures.length > 0) {
  console.error('Failed to update stages:', failures);
  // 記錄到日誌表
  await logFailures(failures);
}
```

---

## 測試方式

### 手動觸發

```bash
# Cloudflare Workers Dashboard
# Triggers → Cron Triggers → 手動觸發 "Overdue Detector"
```

### 本地測試

```typescript
// 建立測試數據
await db.prepare(`
  INSERT INTO ActiveTaskStages (
    active_task_id, stage_name, status, due_date
  ) VALUES (1, 'Test Stage', 'in_progress', '2024-01-01')
`).run();

// 執行檢測器
await overdueDetector();

// 驗證狀態已更新
const updated = await db.prepare(`
  SELECT status FROM ActiveTaskStages WHERE stage_name = 'Test Stage'
`).first();

console.assert(updated.status === 'overdue', 'Status should be overdue');
```

---

## 監控與日誌

### 關鍵指標

```typescript
const metrics = {
  executionTime: endTime - startTime,
  stagesChecked: stages.results.length,
  stagesUpdated: updatedCount,
  tasksAffected: affectedTasks.size,
  errors: errorCount
};

console.log('Overdue Detection Complete:', metrics);

// 記錄到審計日誌
await db.prepare(`
  INSERT INTO AuditLogs (action, details, created_at)
  VALUES ('overdue_detection', ?, datetime('now'))
`).bind(JSON.stringify(metrics)).run();
```

---

## 前端顯示

### 逾期標記

**CSS樣式：**
```css
.stage-overdue {
  border-left: 4px solid #ef4444;
  background-color: #fee2e2;
}

.stage-overdue .due-date {
  color: #dc2626;
  font-weight: 600;
}
```

**Vue組件：**
```vue
<div :class="['stage-card', { 'stage-overdue': stage.status === 'overdue' }]">
  <span class="stage-name">{{ stage.stage_name }}</span>
  <span class="due-date">
    {{ stage.status === 'overdue' ? '已逾期' : stage.due_date }}
  </span>
</div>
```

---

## 相關文檔

- [功能模塊：任務進度追蹤](../功能模塊/16-任務進度追蹤.md)
- [功能模塊：階段進度更新](../功能模塊/17-階段進度更新.md)
- [資料庫設計：ActiveTaskStages](../資料庫設計/任務系統/ActiveTaskStages.md)

---

**最後更新：** 2025年10月27日  
**文檔版本：** 2.0（模塊化重組版）

