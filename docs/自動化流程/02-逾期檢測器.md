# Cron Job #2：自動更新逾期狀態

**執行時間：** 每天凌晨 02:00  
**Cron 表達式：** `0 2 * * *`  
**檔案位置：** `/worker/src/cron/overdue-detector.ts`  
**最後更新：** 2025年10月27日

---

## 功能概述

每天檢查所有進行中的任務階段，將逾期的階段標記為「逾期」狀態，並更新對應任務的整體狀態。

---

## 執行邏輯

```typescript
export async function detectOverdueTasks(env) {
  const today = new Date().toISOString().split('T')[0];
  
  // 1. 查詢所有進行中或未開始的階段
  const stages = await env.DB.prepare(`
    SELECT active_stage_id, due_date, status 
    FROM ActiveTaskStages 
    WHERE status IN ('未開始', '進行中') 
      AND due_date IS NOT NULL
  `).all();
  
  let overdueCount = 0;
  
  for (const stage of stages.results) {
    if (stage.due_date < today) {
      // 2. 更新為逾期狀態
      await env.DB.prepare(
        'UPDATE ActiveTaskStages SET status = ? WHERE active_stage_id = ?'
      ).bind('逾期', stage.active_stage_id).run();
      
      overdueCount++;
    }
  }
  
  // 3. 更新任務整體狀態
  await env.DB.prepare(`
    UPDATE ActiveTasks 
    SET status = '逾期' 
    WHERE active_task_id IN (
      SELECT active_task_id FROM ActiveTaskStages WHERE status = '逾期'
    )
  `).run();
  
  return { 
    message: `已標記 ${overdueCount} 個逾期階段` 
  };
}
```

---

## 到期提醒邏輯

### 前端顯示規則

| 剩餘天數 | 顯示顏色 | 樣式 |
|----------|----------|------|
| ≥ 2 天 | 綠色 | `bg-green-100 text-green-800` |
| 1 天 | 黃色 | `bg-yellow-100 text-yellow-800` |
| 0 天（當天） | 橙色 | `bg-orange-100 text-orange-800` |
| < 0（逾期） | 紅色 | `bg-red-100 text-red-800` |

---

## 相關文檔

- [任務進度追蹤](../功能模塊/16-任務進度追蹤.md)
- [階段進度更新](../功能模塊/17-階段進度更新.md)

---

**最後更新：** 2025年10月27日



**執行時間：** 每天凌晨 02:00  
**Cron 表達式：** `0 2 * * *`  
**檔案位置：** `/worker/src/cron/overdue-detector.ts`  
**最後更新：** 2025年10月27日

---

## 功能概述

每天檢查所有進行中的任務階段，將逾期的階段標記為「逾期」狀態，並更新對應任務的整體狀態。

---

## 執行邏輯

```typescript
export async function detectOverdueTasks(env) {
  const today = new Date().toISOString().split('T')[0];
  
  // 1. 查詢所有進行中或未開始的階段
  const stages = await env.DB.prepare(`
    SELECT active_stage_id, due_date, status 
    FROM ActiveTaskStages 
    WHERE status IN ('未開始', '進行中') 
      AND due_date IS NOT NULL
  `).all();
  
  let overdueCount = 0;
  
  for (const stage of stages.results) {
    if (stage.due_date < today) {
      // 2. 更新為逾期狀態
      await env.DB.prepare(
        'UPDATE ActiveTaskStages SET status = ? WHERE active_stage_id = ?'
      ).bind('逾期', stage.active_stage_id).run();
      
      overdueCount++;
    }
  }
  
  // 3. 更新任務整體狀態
  await env.DB.prepare(`
    UPDATE ActiveTasks 
    SET status = '逾期' 
    WHERE active_task_id IN (
      SELECT active_task_id FROM ActiveTaskStages WHERE status = '逾期'
    )
  `).run();
  
  return { 
    message: `已標記 ${overdueCount} 個逾期階段` 
  };
}
```

---

## 到期提醒邏輯

### 前端顯示規則

| 剩餘天數 | 顯示顏色 | 樣式 |
|----------|----------|------|
| ≥ 2 天 | 綠色 | `bg-green-100 text-green-800` |
| 1 天 | 黃色 | `bg-yellow-100 text-yellow-800` |
| 0 天（當天） | 橙色 | `bg-orange-100 text-orange-800` |
| < 0（逾期） | 紅色 | `bg-red-100 text-red-800` |

---

## 相關文檔

- [任務進度追蹤](../功能模塊/16-任務進度追蹤.md)
- [階段進度更新](../功能模塊/17-階段進度更新.md)

---

**最後更新：** 2025年10月27日



