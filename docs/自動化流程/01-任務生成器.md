# 01 - 任務生成器 (Task Generator)

**Cron Job名稱：** Task Generator  
**執行頻率：** 每天凌晨 1:00 AM  
**Cron表達式：** `0 1 * * *`  
**最後更新：** 2025年10月27日

---

## 功能概述

自動根據客戶訂閱的服務（`ClientServices`），在指定月份的第1天自動建立任務實例（`ActiveTasks`）及其所有階段（`ActiveTaskStages`）。

**目的：**
- 自動化週期性任務的建立
- 確保員工每月都能看到需要處理的任務
- 避免手動建立任務的遺漏

---

## 執行時機

### 觸發條件

```typescript
// 每天凌晨1點執行，但只在每月1號才實際建立任務
if (today.getDate() === 1) {
  // 執行任務生成邏輯
}
```

**為什麼每天都執行？**
- Cloudflare Cron無法設定「每月1號」
- 所以每天都檢查，但只在1號才執行

---

## 執行邏輯

### 步驟 1：檢查日期

```typescript
const today = new Date();
const currentMonth = today.getMonth() + 1;  // 1-12
const dayOfMonth = today.getDate();

if (dayOfMonth !== 1) {
  console.log('Not the 1st day of month, skipping task generation');
  return;
}
```

---

### 步驟 2：查詢需要觸發的服務

```typescript
// 獲取所有啟用的客戶服務
const services = await db.prepare(`
  SELECT 
    cs.client_service_id,
    cs.client_id,
    cs.service_id,
    cs.task_template_id,
    cs.trigger_months,
    c.assignee_user_id,
    c.name as client_name,
    s.service_name
  FROM ClientServices cs
  JOIN Clients c ON cs.client_id = c.client_id
  JOIN Services s ON cs.service_id = s.service_id
  WHERE cs.is_active = true
    AND cs.task_template_id IS NOT NULL
`).all();

console.log(`Found ${services.results.length} active services`);
```

---

### 步驟 3：篩選本月需要觸發的服務

```typescript
const servicesToTrigger = [];

for (const service of services.results) {
  const triggerMonths = JSON.parse(service.trigger_months || '[]');
  
  // 檢查本月是否在觸發月份中
  if (triggerMonths.includes(currentMonth)) {
    servicesToTrigger.push(service);
  }
}

console.log(`${servicesToTrigger.length} services to trigger this month`);
```

**觸發月份範例：**
```json
// 每月觸發
[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

// 雙月觸發（1,3,5,7,9,11月）
[1, 3, 5, 7, 9, 11]

// 季度觸發（3,6,9,12月）
[3, 6, 9, 12]

// 半年觸發（6,12月）
[6, 12]

// 年度觸發（12月）
[12]
```

---

### 步驟 4：為每個服務建立任務實例

```typescript
for (const service of servicesToTrigger) {
  try {
    // (A) 建立任務實例
    const taskResult = await db.prepare(`
      INSERT INTO ActiveTasks (
        client_id,
        task_template_id,
        task_name,
        assignee_user_id,
        start_date,
        status,
        created_at
      ) VALUES (?, ?, ?, ?, ?, 'pending', datetime('now'))
    `).bind(
      service.client_id,
      service.task_template_id,
      `${service.service_name} - ${today.getFullYear()}年${currentMonth}月`,
      service.assignee_user_id,
      today.toISOString().split('T')[0]  // YYYY-MM-DD
    ).run();
    
    const activeTaskId = taskResult.meta.last_row_id;
    
    // (B) 獲取該模板的所有階段
    const stages = await db.prepare(`
      SELECT * FROM TaskStageTemplates
      WHERE task_template_id = ?
      ORDER BY stage_order
    `).bind(service.task_template_id).all();
    
    // (C) 批次建立階段實例
    for (const stage of stages.results) {
      await db.prepare(`
        INSERT INTO ActiveTaskStages (
          active_task_id,
          stage_template_id,
          stage_name,
          stage_order,
          estimated_days,
          status,
          created_at
        ) VALUES (?, ?, ?, ?, ?, 'not_started', datetime('now'))
      `).bind(
        activeTaskId,
        stage.stage_template_id,
        stage.stage_name,
        stage.stage_order,
        stage.estimated_days
      ).run();
    }
    
    console.log(`✓ Created task for client: ${service.client_name}, service: ${service.service_name}`);
    
  } catch (error) {
    console.error(`✗ Failed to create task for service ${service.client_service_id}:`, error);
    // 繼續處理下一個服務，不中斷整個流程
  }
}
```

---

### 步驟 5：記錄執行結果

```typescript
const summary = {
  executionDate: today.toISOString(),
  month: currentMonth,
  totalServicesChecked: services.results.length,
  servicesTriggered: servicesToTrigger.length,
  tasksCreated: successCount,
  errors: errorCount
};

// 記錄到系統日誌表（可選）
await db.prepare(`
  INSERT INTO AuditLogs (action, details, created_at)
  VALUES ('task_generation', ?, datetime('now'))
`).bind(JSON.stringify(summary)).run();

console.log('Task generation complete:', summary);
```

---

## 錯誤處理

### 常見錯誤

#### 錯誤 1：客戶未指派負責人

```typescript
if (!service.assignee_user_id) {
  console.warn(`Client ${service.client_id} has no assignee, skipping task creation`);
  continue;
}
```

#### 錯誤 2：任務模板不存在

```typescript
const template = await db.prepare(
  `SELECT * FROM TaskTemplates WHERE task_template_id = ?`
).bind(service.task_template_id).first();

if (!template) {
  console.error(`Template ${service.task_template_id} not found`);
  continue;
}
```

#### 錯誤 3：重複建立任務

**防止機制：**
```typescript
// 檢查本月是否已建立過任務
const existing = await db.prepare(`
  SELECT active_task_id FROM ActiveTasks
  WHERE client_id = ?
    AND task_template_id = ?
    AND strftime('%Y-%m', start_date) = ?
`).bind(
  service.client_id,
  service.task_template_id,
  `${today.getFullYear()}-${currentMonth.toString().padStart(2, '0')}`
).first();

if (existing) {
  console.log(`Task already exists for this month, skipping`);
  continue;
}
```

---

## 效能考量

### 批次處理

**避免一次處理太多：**
```typescript
// 如果服務數量 > 100，分批處理
const BATCH_SIZE = 100;
for (let i = 0; i < servicesToTrigger.length; i += BATCH_SIZE) {
  const batch = servicesToTrigger.slice(i, i + BATCH_SIZE);
  await processBatch(batch);
  
  // 避免超時，每批次間隔
  await sleep(100);
}
```

### 資料庫事務

```typescript
// 使用事務確保任務和階段一起建立
await db.batch([
  // INSERT INTO ActiveTasks
  // INSERT INTO ActiveTaskStages (多筆)
]);
```

---

## 測試方式

### 手動觸發

```bash
# 在 Cloudflare Workers Dashboard
# Triggers → Cron Triggers → 手動觸發
```

### 本地測試

```typescript
// 建立測試腳本
// test-task-generator.ts

import { taskGenerator } from './cron/task-generator';

async function test() {
  const result = await taskGenerator({
    // 模擬環境
    env: {
      DB: mockD1Database
    }
  });
  
  console.log(result);
}

test();
```

---

## 監控與日誌

### 關鍵指標

- 執行時間
- 檢查的服務數量
- 成功建立的任務數量
- 失敗的服務數量

### Cloudflare 日誌

```typescript
// 所有 console.log 會出現在 Cloudflare Workers 日誌中
// Cloudflare Dashboard → Workers → [Your Worker] → Logs
```

---

## 相關文檔

- [功能模塊：任務模板管理](../功能模塊/14-任務模板管理.md)
- [功能模塊：客戶服務設定](../功能模塊/15-客戶服務設定.md)
- [資料庫設計：ActiveTasks](../資料庫設計/任務系統/ActiveTasks.md)
- [資料庫設計：ActiveTaskStages](../資料庫設計/任務系統/ActiveTaskStages.md)

---

**最後更新：** 2025年10月27日  
**文檔版本：** 2.0（模塊化重組版）

