# Cron Job #1：自動建立任務

**執行時間：** 每天凌晨 01:00  
**Cron 表達式：** `0 1 * * *`  
**檔案位置：** `/worker/src/cron/task-generator.ts`  
**最後更新：** 2025年10月27日

---

## 功能概述

每月1號自動為所有啟用的客戶服務建立任務實例，並根據任務模板生成所有階段。

---

## 執行邏輯

```typescript
export async function generateTasksForMonth(env) {
  const today = new Date();
  
  // 僅在每月 1 號執行
  if (today.getDate() !== 1) {
    return { message: '非月初，跳過' };
  }
  
  const currentMonth = today.getMonth() + 1; // 1-12
  
  // 1. 查詢所有啟用的客戶服務
  const services = await env.DB.prepare(
    'SELECT * FROM ClientServices WHERE is_active = 1'
  ).all();
  
  let createdCount = 0;
  
  for (const service of services.results) {
    // 2. 檢查本月是否需要觸發
    const triggerMonths = JSON.parse(service.trigger_months);
    
    if (!triggerMonths.includes(currentMonth)) {
      continue; // 跳過本月不需要的服務
    }
    
    // 3. 獲取客戶的負責員工
    const client = await env.DB.prepare(
      'SELECT assignee_user_id FROM Clients WHERE client_id = ?'
    ).bind(service.client_id).first();
    
    // 4. 建立任務實例
    const taskTitle = `${service.client_id}-${service.service_name}-${today.getFullYear()}年${currentMonth}月`;
    
    const taskResult = await env.DB.prepare(`
      INSERT INTO ActiveTasks 
        (client_id, client_service_id, task_template_id, title, 
         assigned_user_id, start_date, year, period, status)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, '進行中')
    `).bind(
      service.client_id,
      service.client_service_id,
      service.task_template_id,
      taskTitle,
      client.assignee_user_id,
      today.toISOString().split('T')[0],
      today.getFullYear(),
      `${currentMonth}月`,
    ).run();
    
    const newTaskId = taskResult.meta.last_row_id;
    
    // 5. 建立所有階段實例
    const stages = await env.DB.prepare(
      'SELECT * FROM TaskStageTemplates WHERE task_template_id = ? ORDER BY stage_order'
    ).bind(service.task_template_id).all();
    
    for (const stage of stages.results) {
      await env.DB.prepare(`
        INSERT INTO ActiveTaskStages 
          (active_task_id, stage_template_id, stage_name, stage_order, 
           estimated_days, status)
        VALUES (?, ?, ?, ?, ?, '未開始')
      `).bind(
        newTaskId,
        stage.stage_template_id,
        stage.stage_name,
        stage.stage_order,
        stage.estimated_days
      ).run();
    }
    
    // 6. 計算任務總到期日
    const totalDays = stages.results.reduce(
      (sum, stage) => sum + stage.estimated_days, 
      0
    );
    
    const dueDate = new Date(today);
    dueDate.setDate(dueDate.getDate() + totalDays);
    
    await env.DB.prepare(
      'UPDATE ActiveTasks SET due_date = ? WHERE active_task_id = ?'
    ).bind(
      dueDate.toISOString().split('T')[0],
      newTaskId
    ).run();
    
    createdCount++;
  }
  
  return { 
    message: `已為本月建立 ${createdCount} 個任務` 
  };
}
```

---

## 執行範例

### 假設情境

**今天是 2025-11-01，系統有以下客戶服務：**

| 客戶 | 服務 | 頻率 | 觸發月份 |
|------|------|------|----------|
| 仟鑽企業 | 記帳服務 | 雙月 | [1,3,5,7,9,11] |
| 宏達公司 | 記帳服務 | 每月 | [1,2,3,...,12] |
| 新創科技 | 工商服務 | 單次 | [6] |

### 執行結果

- ✅ 為「仟鑽企業」建立任務（11 月在觸發月份中）
- ✅ 為「宏達公司」建立任務（每月都觸發）
- ❌ 跳過「新創科技」（僅 6 月觸發）

---

## 相關文檔

- [任務進度追蹤](../功能模塊/16-任務進度追蹤.md)
- [客戶服務設定](../功能模塊/15-客戶服務設定.md)
- [任務模板管理](../功能模塊/14-任務模板管理.md)

---

**最後更新：** 2025年10月27日



**執行時間：** 每天凌晨 01:00  
**Cron 表達式：** `0 1 * * *`  
**檔案位置：** `/worker/src/cron/task-generator.ts`  
**最後更新：** 2025年10月27日

---

## 功能概述

每月1號自動為所有啟用的客戶服務建立任務實例，並根據任務模板生成所有階段。

---

## 執行邏輯

```typescript
export async function generateTasksForMonth(env) {
  const today = new Date();
  
  // 僅在每月 1 號執行
  if (today.getDate() !== 1) {
    return { message: '非月初，跳過' };
  }
  
  const currentMonth = today.getMonth() + 1; // 1-12
  
  // 1. 查詢所有啟用的客戶服務
  const services = await env.DB.prepare(
    'SELECT * FROM ClientServices WHERE is_active = 1'
  ).all();
  
  let createdCount = 0;
  
  for (const service of services.results) {
    // 2. 檢查本月是否需要觸發
    const triggerMonths = JSON.parse(service.trigger_months);
    
    if (!triggerMonths.includes(currentMonth)) {
      continue; // 跳過本月不需要的服務
    }
    
    // 3. 獲取客戶的負責員工
    const client = await env.DB.prepare(
      'SELECT assignee_user_id FROM Clients WHERE client_id = ?'
    ).bind(service.client_id).first();
    
    // 4. 建立任務實例
    const taskTitle = `${service.client_id}-${service.service_name}-${today.getFullYear()}年${currentMonth}月`;
    
    const taskResult = await env.DB.prepare(`
      INSERT INTO ActiveTasks 
        (client_id, client_service_id, task_template_id, title, 
         assigned_user_id, start_date, year, period, status)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, '進行中')
    `).bind(
      service.client_id,
      service.client_service_id,
      service.task_template_id,
      taskTitle,
      client.assignee_user_id,
      today.toISOString().split('T')[0],
      today.getFullYear(),
      `${currentMonth}月`,
    ).run();
    
    const newTaskId = taskResult.meta.last_row_id;
    
    // 5. 建立所有階段實例
    const stages = await env.DB.prepare(
      'SELECT * FROM TaskStageTemplates WHERE task_template_id = ? ORDER BY stage_order'
    ).bind(service.task_template_id).all();
    
    for (const stage of stages.results) {
      await env.DB.prepare(`
        INSERT INTO ActiveTaskStages 
          (active_task_id, stage_template_id, stage_name, stage_order, 
           estimated_days, status)
        VALUES (?, ?, ?, ?, ?, '未開始')
      `).bind(
        newTaskId,
        stage.stage_template_id,
        stage.stage_name,
        stage.stage_order,
        stage.estimated_days
      ).run();
    }
    
    // 6. 計算任務總到期日
    const totalDays = stages.results.reduce(
      (sum, stage) => sum + stage.estimated_days, 
      0
    );
    
    const dueDate = new Date(today);
    dueDate.setDate(dueDate.getDate() + totalDays);
    
    await env.DB.prepare(
      'UPDATE ActiveTasks SET due_date = ? WHERE active_task_id = ?'
    ).bind(
      dueDate.toISOString().split('T')[0],
      newTaskId
    ).run();
    
    createdCount++;
  }
  
  return { 
    message: `已為本月建立 ${createdCount} 個任務` 
  };
}
```

---

## 執行範例

### 假設情境

**今天是 2025-11-01，系統有以下客戶服務：**

| 客戶 | 服務 | 頻率 | 觸發月份 |
|------|------|------|----------|
| 仟鑽企業 | 記帳服務 | 雙月 | [1,3,5,7,9,11] |
| 宏達公司 | 記帳服務 | 每月 | [1,2,3,...,12] |
| 新創科技 | 工商服務 | 單次 | [6] |

### 執行結果

- ✅ 為「仟鑽企業」建立任務（11 月在觸發月份中）
- ✅ 為「宏達公司」建立任務（每月都觸發）
- ❌ 跳過「新創科技」（僅 6 月觸發）

---

## 相關文檔

- [任務進度追蹤](../功能模塊/16-任務進度追蹤.md)
- [客戶服務設定](../功能模塊/15-客戶服務設定.md)
- [任務模板管理](../功能模塊/14-任務模板管理.md)

---

**最後更新：** 2025年10月27日



