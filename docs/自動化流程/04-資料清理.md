# Cron Job #4：清理過期資料

**執行時間：** 每週日凌晨 04:00  
**Cron 表達式：** `0 4 * * 0`  
**檔案位置：** `/worker/src/cron/cleanup.ts`  
**最後更新：** 2025年10月27日

---

## 功能概述

每週日自動清理一年前已完成的任務和相關資料，保持資料庫精簡。

---

## 執行邏輯

```typescript
export async function cleanupOldData(env) {
  const oneYearAgo = new Date();
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
  const cutoffDate = oneYearAgo.toISOString().split('T')[0];
  
  // 刪除一年前已完成的任務
  const result = await env.DB.prepare(`
    DELETE FROM ActiveTasks 
    WHERE status = '已完成' 
      AND due_date < ?
  `).bind(cutoffDate).run();
  
  return { 
    message: `已清理 ${result.meta.changes} 個舊任務` 
  };
}
```

---

## 清理策略

### 清理範圍
- **已完成任務**：一年前完成的任務
- **關聯階段**：透過外鍵自動級聯刪除
- **保留資料**：
  - 所有工時記錄（永久保留）
  - 所有客戶資料（永久保留）
  - 近一年內的任務

### 清理頻率
- **每週一次**：週日凌晨執行
- **避免影響**：選在系統使用量最低時段

---

## 注意事項

### 資料完整性
- 清理前已有每日備份保護
- 軟刪除的資料不受影響
- 審計日誌永久保留

---

## 相關文檔

- [任務進度追蹤](../功能模塊/16-任務進度追蹤.md)
- [資料庫備份](./03-資料庫備份.md)

---

**最後更新：** 2025年10月27日



**執行時間：** 每週日凌晨 04:00  
**Cron 表達式：** `0 4 * * 0`  
**檔案位置：** `/worker/src/cron/cleanup.ts`  
**最後更新：** 2025年10月27日

---

## 功能概述

每週日自動清理一年前已完成的任務和相關資料，保持資料庫精簡。

---

## 執行邏輯

```typescript
export async function cleanupOldData(env) {
  const oneYearAgo = new Date();
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
  const cutoffDate = oneYearAgo.toISOString().split('T')[0];
  
  // 刪除一年前已完成的任務
  const result = await env.DB.prepare(`
    DELETE FROM ActiveTasks 
    WHERE status = '已完成' 
      AND due_date < ?
  `).bind(cutoffDate).run();
  
  return { 
    message: `已清理 ${result.meta.changes} 個舊任務` 
  };
}
```

---

## 清理策略

### 清理範圍
- **已完成任務**：一年前完成的任務
- **關聯階段**：透過外鍵自動級聯刪除
- **保留資料**：
  - 所有工時記錄（永久保留）
  - 所有客戶資料（永久保留）
  - 近一年內的任務

### 清理頻率
- **每週一次**：週日凌晨執行
- **避免影響**：選在系統使用量最低時段

---

## 注意事項

### 資料完整性
- 清理前已有每日備份保護
- 軟刪除的資料不受影響
- 審計日誌永久保留

---

## 相關文檔

- [任務進度追蹤](../功能模塊/16-任務進度追蹤.md)
- [資料庫備份](./03-資料庫備份.md)

---

**最後更新：** 2025年10月27日



