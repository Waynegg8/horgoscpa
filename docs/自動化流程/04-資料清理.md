# 04 - è³‡æ–™æ¸…ç† (Data Cleanup)

**Cron Jobåç¨±ï¼š** Data Cleanup  
**åŸ·è¡Œé »ç‡ï¼š** æ¯é€±æ—¥å‡Œæ™¨ 4:00 AM  
**Cronè¡¨é”å¼ï¼š** `0 4 * * 0`  
**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´10æœˆ27æ—¥

---

## åŠŸèƒ½æ¦‚è¿°

å®šæœŸæ¸…ç†ç³»çµ±ä¸­çš„éæœŸè³‡æ–™ã€è»Ÿåˆªé™¤è¨˜éŒ„ã€å¯©è¨ˆæ—¥èªŒç­‰ï¼Œé¿å…è³‡æ–™åº«ç„¡é™è†¨è„¹ï¼Œä¿æŒç³»çµ±æ•ˆèƒ½ã€‚

**ç›®çš„ï¼š**
- æ§åˆ¶è³‡æ–™åº«å¤§å°
- æå‡æŸ¥è©¢æ•ˆèƒ½
- ç¬¦åˆè³‡æ–™ä¿ç•™æ”¿ç­–
- ä¿è­·ç”¨æˆ¶éš±ç§

---

## æ¸…ç†é …ç›®

### 1. è»Ÿåˆªé™¤è¨˜éŒ„ï¼ˆä¿ç•™90å¤©ï¼‰

```typescript
async function cleanupSoftDeleted(db: D1Database): Promise<number> {
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - 90);
  const threshold = cutoffDate.toISOString();
  
  let totalDeleted = 0;
  
  // éœ€è¦æ¸…ç†çš„è¡¨æ ¼
  const tables = [
    'Clients',
    'Users',
    'SOPDocuments',
    'KnowledgeBase',
    'ServiceTemplates',
    'TaskTemplates'
  ];
  
  for (const table of tables) {
    const result = await db.prepare(`
      DELETE FROM ${table}
      WHERE is_deleted = true
        AND deleted_at < ?
    `).bind(threshold).run();
    
    totalDeleted += result.meta.changes;
    console.log(`âœ“ Cleaned ${result.meta.changes} records from ${table}`);
  }
  
  return totalDeleted;
}
```

**ç‚ºä»€éº¼æ˜¯90å¤©ï¼Ÿ**
- æä¾›è¶³å¤ æ™‚é–“é€²è¡Œè³‡æ–™æ¢å¾©
- ç¬¦åˆä¸€èˆ¬è³‡æ–™ä¿ç•™è¦ç¯„
- å¹³è¡¡å„²å­˜æˆæœ¬èˆ‡å®‰å…¨æ€§

---

### 2. å¯©è¨ˆæ—¥èªŒï¼ˆä¿ç•™1å¹´ï¼‰

```typescript
async function cleanupAuditLogs(db: D1Database): Promise<number> {
  const oneYearAgo = new Date();
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
  const threshold = oneYearAgo.toISOString();
  
  // åªä¿ç•™é‡è¦çš„å¯©è¨ˆæ—¥èªŒ
  const result = await db.prepare(`
    DELETE FROM AuditLogs
    WHERE created_at < ?
      AND action NOT IN (
        'user_login',
        'password_change',
        'permission_change',
        'data_export'
      )
  `).bind(threshold).run();
  
  console.log(`âœ“ Cleaned ${result.meta.changes} audit logs`);
  
  return result.meta.changes;
}
```

**ä¿ç•™é‡è¦æ—¥èªŒï¼š**
- ç™»å…¥è¨˜éŒ„
- å¯†ç¢¼è®Šæ›´
- æ¬Šé™è®Šæ›´
- è³‡æ–™åŒ¯å‡º

---

### 3. å·²å®Œæˆä»»å‹™ï¼ˆä¿ç•™6å€‹æœˆï¼‰

```typescript
async function cleanupCompletedTasks(db: D1Database): Promise<number> {
  const sixMonthsAgo = new Date();
  sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
  const threshold = sixMonthsAgo.toISOString();
  
  // å…ˆç²å–è¦åˆªé™¤çš„ä»»å‹™ID
  const tasksToDelete = await db.prepare(`
    SELECT active_task_id FROM ActiveTasks
    WHERE status = 'completed'
      AND completed_date < ?
  `).bind(threshold).all();
  
  if (tasksToDelete.results.length === 0) {
    console.log('No completed tasks to clean up');
    return 0;
  }
  
  const taskIds = tasksToDelete.results.map(t => t.active_task_id);
  
  // åˆªé™¤ä»»å‹™éšæ®µ
  await db.prepare(`
    DELETE FROM ActiveTaskStages
    WHERE active_task_id IN (${taskIds.join(',')})
  `).run();
  
  // åˆªé™¤ä»»å‹™
  const result = await db.prepare(`
    DELETE FROM ActiveTasks
    WHERE active_task_id IN (${taskIds.join(',')})
  `).run();
  
  console.log(`âœ“ Cleaned ${result.meta.changes} completed tasks`);
  
  return result.meta.changes;
}
```

**ç‚ºä»€éº¼ä¿ç•™6å€‹æœˆï¼Ÿ**
- æä¾›è¶³å¤ çš„æ­·å²æŸ¥è©¢æœŸé–“
- å¯ç”¨æ–¼è¶¨å‹¢åˆ†æå’Œå ±è¡¨
- å¹³è¡¡è³‡æ–™é‡èˆ‡å¯¦ç”¨æ€§

---

### 4. éæœŸæœƒè©±ï¼ˆä¿ç•™7å¤©ï¼‰

```typescript
async function cleanupExpiredSessions(db: D1Database): Promise<number> {
  const sevenDaysAgo = new Date();
  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
  const threshold = sevenDaysAgo.toISOString();
  
  const result = await db.prepare(`
    DELETE FROM Sessions
    WHERE expires_at < ?
  `).bind(threshold).run();
  
  console.log(`âœ“ Cleaned ${result.meta.changes} expired sessions`);
  
  return result.meta.changes;
}
```

---

### 5. è‡¨æ™‚ä¸Šå‚³æª”æ¡ˆï¼ˆR2æ¸…ç†ï¼‰

```typescript
async function cleanupTempFiles(r2: R2Bucket): Promise<number> {
  const oneDayAgo = new Date();
  oneDayAgo.setDate(oneDayAgo.getDate() - 1);
  
  const tempFiles = await r2.list({ prefix: 'temp/' });
  let deletedCount = 0;
  
  for (const file of tempFiles.objects) {
    if (file.uploaded < oneDayAgo) {
      await r2.delete(file.key);
      deletedCount++;
    }
  }
  
  console.log(`âœ“ Cleaned ${deletedCount} temp files from R2`);
  
  return deletedCount;
}
```

---

## å®Œæ•´åŸ·è¡Œæµç¨‹

```typescript
export async function dataCleanup(env: Env): Promise<Response> {
  const startTime = Date.now();
  
  try {
    console.log('Starting data cleanup...');
    
    const results = {
      softDeleted: 0,
      auditLogs: 0,
      completedTasks: 0,
      expiredSessions: 0,
      tempFiles: 0
    };
    
    // 1. æ¸…ç†è»Ÿåˆªé™¤è¨˜éŒ„
    results.softDeleted = await cleanupSoftDeleted(env.DB);
    
    // 2. æ¸…ç†å¯©è¨ˆæ—¥èªŒ
    results.auditLogs = await cleanupAuditLogs(env.DB);
    
    // 3. æ¸…ç†å·²å®Œæˆä»»å‹™
    results.completedTasks = await cleanupCompletedTasks(env.DB);
    
    // 4. æ¸…ç†éæœŸæœƒè©±
    results.expiredSessions = await cleanupExpiredSessions(env.DB);
    
    // 5. æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
    results.tempFiles = await cleanupTempFiles(env.STORAGE_BUCKET);
    
    // 6. è³‡æ–™åº«å„ªåŒ–
    await optimizeDatabase(env.DB);
    
    const duration = Date.now() - startTime;
    const totalCleaned = Object.values(results).reduce((a, b) => a + b, 0);
    
    // è¨˜éŒ„çµæœ
    await env.DB.prepare(`
      INSERT INTO AuditLogs (action, details, created_at)
      VALUES ('data_cleanup', ?, datetime('now'))
    `).bind(JSON.stringify({ ...results, duration, totalCleaned })).run();
    
    console.log(`Cleanup completed in ${duration}ms, cleaned ${totalCleaned} items`);
    
    return new Response(JSON.stringify({ 
      success: true, 
      ...results,
      totalCleaned,
      duration 
    }), {
      headers: { 'Content-Type': 'application/json' }
    });
    
  } catch (error) {
    console.error('Cleanup failed:', error);
    
    return new Response(JSON.stringify({ 
      success: false, 
      error: error.message 
    }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}
```

---

## è³‡æ–™åº«å„ªåŒ–

### VACUUMï¼ˆé‡å»ºè³‡æ–™åº«ï¼‰

```typescript
async function optimizeDatabase(db: D1Database): Promise<void> {
  console.log('Optimizing database...');
  
  // é‡å»ºè³‡æ–™åº«ï¼Œå›æ”¶å·²åˆªé™¤è¨˜éŒ„çš„ç©ºé–“
  await db.prepare('VACUUM').run();
  
  // æ›´æ–°çµ±è¨ˆè³‡è¨Šï¼Œå„ªåŒ–æŸ¥è©¢è¨ˆç•«
  await db.prepare('ANALYZE').run();
  
  console.log('âœ“ Database optimized');
}
```

**VACUUM æ•ˆæœï¼š**
- å›æ”¶å·²åˆªé™¤è¨˜éŒ„çš„ç£ç¢Ÿç©ºé–“
- é‡æ–°çµ„ç¹”è³‡æ–™ï¼Œæ¸›å°‘ç¢ç‰‡
- å¯èƒ½ç¸®å°è³‡æ–™åº«å¤§å° 10-30%

**æ³¨æ„äº‹é …ï¼š**
- VACUUM éœ€è¦é¡å¤–çš„ç£ç¢Ÿç©ºé–“ï¼ˆè‡¨æ™‚ï¼‰
- åŸ·è¡ŒæœŸé–“æœƒé–å®šè³‡æ–™åº«
- å»ºè­°åœ¨ä½æµé‡æ™‚æ®µåŸ·è¡Œï¼ˆå‡Œæ™¨ï¼‰

---

## æ­¸æª”ç­–ç•¥ï¼ˆå¯é¸ï¼‰

### æ­¸æª”èˆŠä»»å‹™åˆ° R2

```typescript
async function archiveOldTasks(db: D1Database, r2: R2Bucket): Promise<number> {
  const sixMonthsAgo = new Date();
  sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
  
  // ç²å–è¦æ­¸æª”çš„ä»»å‹™
  const tasks = await db.prepare(`
    SELECT 
      at.*,
      c.name as client_name,
      GROUP_CONCAT(ats.stage_name) as stages
    FROM ActiveTasks at
    JOIN Clients c ON at.client_id = c.client_id
    LEFT JOIN ActiveTaskStages ats ON at.active_task_id = ats.active_task_id
    WHERE at.status = 'completed'
      AND at.completed_date < ?
    GROUP BY at.active_task_id
  `).bind(sixMonthsAgo.toISOString()).all();
  
  if (tasks.results.length === 0) {
    return 0;
  }
  
  // è½‰æ›ç‚º JSON ä¸¦ä¸Šå‚³åˆ° R2
  const year = sixMonthsAgo.getFullYear();
  const month = (sixMonthsAgo.getMonth() + 1).toString().padStart(2, '0');
  const filename = `archives/tasks/${year}/${month}/tasks.json`;
  
  await r2.put(filename, JSON.stringify(tasks.results, null, 2), {
    httpMetadata: {
      contentType: 'application/json'
    }
  });
  
  console.log(`âœ“ Archived ${tasks.results.length} tasks to ${filename}`);
  
  return tasks.results.length;
}
```

---

## æ¸…ç†å‰å‚™ä»½

```typescript
async function backupBeforeCleanup(db: D1Database, r2: R2Bucket): Promise<void> {
  console.log('Creating pre-cleanup backup...');
  
  // å¿«é€Ÿå‚™ä»½è¦åˆªé™¤çš„è³‡æ–™
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
  const filename = `backups/pre-cleanup/backup_${timestamp}.sql`;
  
  const sqlDump = await exportDatabase(db);
  await r2.put(filename, sqlDump);
  
  console.log(`âœ“ Pre-cleanup backup saved: ${filename}`);
}
```

---

## ç›£æ§èˆ‡å‘Šè­¦

### æ¸…ç†çµ±è¨ˆå ±å‘Š

```typescript
// æ¯é€±ä¸€ç™¼é€æ¸…ç†å ±å‘Š
if (today.getDay() === 1) {
  await sendReport({
    to: 'admin@firm.com',
    subject: 'ğŸ“Š æ¯é€±è³‡æ–™æ¸…ç†å ±å‘Š',
    body: `
      ä¸Šé€±æ¸…ç†çµ±è¨ˆï¼š
      - è»Ÿåˆªé™¤è¨˜éŒ„ï¼š${results.softDeleted}
      - å¯©è¨ˆæ—¥èªŒï¼š${results.auditLogs}
      - å·²å®Œæˆä»»å‹™ï¼š${results.completedTasks}
      - éæœŸæœƒè©±ï¼š${results.expiredSessions}
      - è‡¨æ™‚æª”æ¡ˆï¼š${results.tempFiles}
      
      ç¸½è¨ˆæ¸…ç†ï¼š${totalCleaned} é …
      åŸ·è¡Œæ™‚é–“ï¼š${duration}ms
      
      è³‡æ–™åº«å¥åº·ç‹€æ…‹ï¼šè‰¯å¥½
    `
  });
}
```

---

## æ‰‹å‹•è§¸ç™¼æ¸…ç†

### API ç«¯é»

```typescript
app.post('/api/v1/admin/cleanup', requireAdmin, async (c) => {
  const { type } = await c.req.json();
  
  let result;
  
  switch (type) {
    case 'soft-deleted':
      result = await cleanupSoftDeleted(c.env.DB);
      break;
    case 'audit-logs':
      result = await cleanupAuditLogs(c.env.DB);
      break;
    case 'completed-tasks':
      result = await cleanupCompletedTasks(c.env.DB);
      break;
    case 'all':
      result = await dataCleanup(c.env);
      break;
    default:
      return c.json({ success: false, error: 'Invalid cleanup type' }, 400);
  }
  
  return c.json({ success: true, cleaned: result });
});
```

---

## è³‡æ–™ä¿ç•™æ”¿ç­–

| è³‡æ–™é¡å‹ | ä¿ç•™æœŸé™ | æ¸…ç†é »ç‡ |
|---------|---------|---------|
| è»Ÿåˆªé™¤è¨˜éŒ„ | 90å¤© | æ¯é€± |
| å¯©è¨ˆæ—¥èªŒ | 1å¹´ | æ¯é€± |
| å·²å®Œæˆä»»å‹™ | 6å€‹æœˆ | æ¯é€± |
| éæœŸæœƒè©± | 7å¤© | æ¯é€± |
| è‡¨æ™‚æª”æ¡ˆ | 1å¤© | æ¯é€± |
| å‚™ä»½æª”æ¡ˆ | 30å¤© | æ¯å¤© |

**å¯èª¿æ•´åƒæ•¸ï¼š**
```typescript
// wrangler.toml
[vars]
RETENTION_SOFT_DELETED_DAYS = "90"
RETENTION_AUDIT_LOGS_DAYS = "365"
RETENTION_COMPLETED_TASKS_DAYS = "180"
RETENTION_SESSIONS_DAYS = "7"
RETENTION_TEMP_FILES_DAYS = "1"
```

---

## ç›¸é—œæ–‡æª”

- [è‡ªå‹•åŒ–æµç¨‹ï¼šè³‡æ–™åº«å‚™ä»½](./03-è³‡æ–™åº«å‚™ä»½.md)
- [è³‡æ–™åº«è¨­è¨ˆï¼šå¯©è¨ˆæ—¥èªŒ](../è³‡æ–™åº«è¨­è¨ˆ/æ¨™æº–åŒ–æ“´å±•/AuditLogs.md)

---

**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´10æœˆ27æ—¥  
**æ–‡æª”ç‰ˆæœ¬ï¼š** 2.0ï¼ˆæ¨¡å¡ŠåŒ–é‡çµ„ç‰ˆï¼‰

