# 04 - 資料清理 (Data Cleanup)

**Cron Job名稱：** Data Cleanup  
**執行頻率：** 每週日凌晨 4:00 AM  
**Cron表達式：** `0 4 * * 0`  
**最後更新：** 2025年10月27日

---

## 功能概述

定期清理系統中的過期資料、軟刪除記錄、審計日誌等，避免資料庫無限膨脹，保持系統效能。

**目的：**
- 控制資料庫大小
- 提升查詢效能
- 符合資料保留政策
- 保護用戶隱私

---

## 清理項目

### 1. 軟刪除記錄（保留90天）

```typescript
async function cleanupSoftDeleted(db: D1Database): Promise<number> {
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - 90);
  const threshold = cutoffDate.toISOString();
  
  let totalDeleted = 0;
  
  // 需要清理的表格
  const tables = [
    'Clients',
    'Users',
    'SOPDocuments',
    'KnowledgeBase',
    'ServiceTemplates',
    'TaskTemplates'
  ];
  
  for (const table of tables) {
    const result = await db.prepare(`
      DELETE FROM ${table}
      WHERE is_deleted = true
        AND deleted_at < ?
    `).bind(threshold).run();
    
    totalDeleted += result.meta.changes;
    console.log(`✓ Cleaned ${result.meta.changes} records from ${table}`);
  }
  
  return totalDeleted;
}
```

**為什麼是90天？**
- 提供足夠時間進行資料恢復
- 符合一般資料保留規範
- 平衡儲存成本與安全性

---

### 2. 審計日誌（保留1年）

```typescript
async function cleanupAuditLogs(db: D1Database): Promise<number> {
  const oneYearAgo = new Date();
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
  const threshold = oneYearAgo.toISOString();
  
  // 只保留重要的審計日誌
  const result = await db.prepare(`
    DELETE FROM AuditLogs
    WHERE created_at < ?
      AND action NOT IN (
        'user_login',
        'password_change',
        'permission_change',
        'data_export'
      )
  `).bind(threshold).run();
  
  console.log(`✓ Cleaned ${result.meta.changes} audit logs`);
  
  return result.meta.changes;
}
```

**保留重要日誌：**
- 登入記錄
- 密碼變更
- 權限變更
- 資料匯出

---

### 3. 已完成任務（保留6個月）

```typescript
async function cleanupCompletedTasks(db: D1Database): Promise<number> {
  const sixMonthsAgo = new Date();
  sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
  const threshold = sixMonthsAgo.toISOString();
  
  // 先獲取要刪除的任務ID
  const tasksToDelete = await db.prepare(`
    SELECT active_task_id FROM ActiveTasks
    WHERE status = 'completed'
      AND completed_date < ?
  `).bind(threshold).all();
  
  if (tasksToDelete.results.length === 0) {
    console.log('No completed tasks to clean up');
    return 0;
  }
  
  const taskIds = tasksToDelete.results.map(t => t.active_task_id);
  
  // 刪除任務階段
  await db.prepare(`
    DELETE FROM ActiveTaskStages
    WHERE active_task_id IN (${taskIds.join(',')})
  `).run();
  
  // 刪除任務
  const result = await db.prepare(`
    DELETE FROM ActiveTasks
    WHERE active_task_id IN (${taskIds.join(',')})
  `).run();
  
  console.log(`✓ Cleaned ${result.meta.changes} completed tasks`);
  
  return result.meta.changes;
}
```

**為什麼保留6個月？**
- 提供足夠的歷史查詢期間
- 可用於趨勢分析和報表
- 平衡資料量與實用性

---

### 4. 過期會話（保留7天）

```typescript
async function cleanupExpiredSessions(db: D1Database): Promise<number> {
  const sevenDaysAgo = new Date();
  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
  const threshold = sevenDaysAgo.toISOString();
  
  const result = await db.prepare(`
    DELETE FROM Sessions
    WHERE expires_at < ?
  `).bind(threshold).run();
  
  console.log(`✓ Cleaned ${result.meta.changes} expired sessions`);
  
  return result.meta.changes;
}
```

---

### 5. 臨時上傳檔案（R2清理）

```typescript
async function cleanupTempFiles(r2: R2Bucket): Promise<number> {
  const oneDayAgo = new Date();
  oneDayAgo.setDate(oneDayAgo.getDate() - 1);
  
  const tempFiles = await r2.list({ prefix: 'temp/' });
  let deletedCount = 0;
  
  for (const file of tempFiles.objects) {
    if (file.uploaded < oneDayAgo) {
      await r2.delete(file.key);
      deletedCount++;
    }
  }
  
  console.log(`✓ Cleaned ${deletedCount} temp files from R2`);
  
  return deletedCount;
}
```

---

## 完整執行流程

```typescript
export async function dataCleanup(env: Env): Promise<Response> {
  const startTime = Date.now();
  
  try {
    console.log('Starting data cleanup...');
    
    const results = {
      softDeleted: 0,
      auditLogs: 0,
      completedTasks: 0,
      expiredSessions: 0,
      tempFiles: 0
    };
    
    // 1. 清理軟刪除記錄
    results.softDeleted = await cleanupSoftDeleted(env.DB);
    
    // 2. 清理審計日誌
    results.auditLogs = await cleanupAuditLogs(env.DB);
    
    // 3. 清理已完成任務
    results.completedTasks = await cleanupCompletedTasks(env.DB);
    
    // 4. 清理過期會話
    results.expiredSessions = await cleanupExpiredSessions(env.DB);
    
    // 5. 清理臨時檔案
    results.tempFiles = await cleanupTempFiles(env.STORAGE_BUCKET);
    
    // 6. 資料庫優化
    await optimizeDatabase(env.DB);
    
    const duration = Date.now() - startTime;
    const totalCleaned = Object.values(results).reduce((a, b) => a + b, 0);
    
    // 記錄結果
    await env.DB.prepare(`
      INSERT INTO AuditLogs (action, details, created_at)
      VALUES ('data_cleanup', ?, datetime('now'))
    `).bind(JSON.stringify({ ...results, duration, totalCleaned })).run();
    
    console.log(`Cleanup completed in ${duration}ms, cleaned ${totalCleaned} items`);
    
    return new Response(JSON.stringify({ 
      success: true, 
      ...results,
      totalCleaned,
      duration 
    }), {
      headers: { 'Content-Type': 'application/json' }
    });
    
  } catch (error) {
    console.error('Cleanup failed:', error);
    
    return new Response(JSON.stringify({ 
      success: false, 
      error: error.message 
    }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}
```

---

## 資料庫優化

### VACUUM（重建資料庫）

```typescript
async function optimizeDatabase(db: D1Database): Promise<void> {
  console.log('Optimizing database...');
  
  // 重建資料庫，回收已刪除記錄的空間
  await db.prepare('VACUUM').run();
  
  // 更新統計資訊，優化查詢計畫
  await db.prepare('ANALYZE').run();
  
  console.log('✓ Database optimized');
}
```

**VACUUM 效果：**
- 回收已刪除記錄的磁碟空間
- 重新組織資料，減少碎片
- 可能縮小資料庫大小 10-30%

**注意事項：**
- VACUUM 需要額外的磁碟空間（臨時）
- 執行期間會鎖定資料庫
- 建議在低流量時段執行（凌晨）

---

## 歸檔策略（可選）

### 歸檔舊任務到 R2

```typescript
async function archiveOldTasks(db: D1Database, r2: R2Bucket): Promise<number> {
  const sixMonthsAgo = new Date();
  sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
  
  // 獲取要歸檔的任務
  const tasks = await db.prepare(`
    SELECT 
      at.*,
      c.name as client_name,
      GROUP_CONCAT(ats.stage_name) as stages
    FROM ActiveTasks at
    JOIN Clients c ON at.client_id = c.client_id
    LEFT JOIN ActiveTaskStages ats ON at.active_task_id = ats.active_task_id
    WHERE at.status = 'completed'
      AND at.completed_date < ?
    GROUP BY at.active_task_id
  `).bind(sixMonthsAgo.toISOString()).all();
  
  if (tasks.results.length === 0) {
    return 0;
  }
  
  // 轉換為 JSON 並上傳到 R2
  const year = sixMonthsAgo.getFullYear();
  const month = (sixMonthsAgo.getMonth() + 1).toString().padStart(2, '0');
  const filename = `archives/tasks/${year}/${month}/tasks.json`;
  
  await r2.put(filename, JSON.stringify(tasks.results, null, 2), {
    httpMetadata: {
      contentType: 'application/json'
    }
  });
  
  console.log(`✓ Archived ${tasks.results.length} tasks to ${filename}`);
  
  return tasks.results.length;
}
```

---

## 清理前備份

```typescript
async function backupBeforeCleanup(db: D1Database, r2: R2Bucket): Promise<void> {
  console.log('Creating pre-cleanup backup...');
  
  // 快速備份要刪除的資料
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
  const filename = `backups/pre-cleanup/backup_${timestamp}.sql`;
  
  const sqlDump = await exportDatabase(db);
  await r2.put(filename, sqlDump);
  
  console.log(`✓ Pre-cleanup backup saved: ${filename}`);
}
```

---

## 監控與告警

### 清理統計報告

```typescript
// 每週一發送清理報告
if (today.getDay() === 1) {
  await sendReport({
    to: 'admin@firm.com',
    subject: '📊 每週資料清理報告',
    body: `
      上週清理統計：
      - 軟刪除記錄：${results.softDeleted}
      - 審計日誌：${results.auditLogs}
      - 已完成任務：${results.completedTasks}
      - 過期會話：${results.expiredSessions}
      - 臨時檔案：${results.tempFiles}
      
      總計清理：${totalCleaned} 項
      執行時間：${duration}ms
      
      資料庫健康狀態：良好
    `
  });
}
```

---

## 手動觸發清理

### API 端點

```typescript
app.post('/api/v1/admin/cleanup', requireAdmin, async (c) => {
  const { type } = await c.req.json();
  
  let result;
  
  switch (type) {
    case 'soft-deleted':
      result = await cleanupSoftDeleted(c.env.DB);
      break;
    case 'audit-logs':
      result = await cleanupAuditLogs(c.env.DB);
      break;
    case 'completed-tasks':
      result = await cleanupCompletedTasks(c.env.DB);
      break;
    case 'all':
      result = await dataCleanup(c.env);
      break;
    default:
      return c.json({ success: false, error: 'Invalid cleanup type' }, 400);
  }
  
  return c.json({ success: true, cleaned: result });
});
```

---

## 資料保留政策

| 資料類型 | 保留期限 | 清理頻率 |
|---------|---------|---------|
| 軟刪除記錄 | 90天 | 每週 |
| 審計日誌 | 1年 | 每週 |
| 已完成任務 | 6個月 | 每週 |
| 過期會話 | 7天 | 每週 |
| 臨時檔案 | 1天 | 每週 |
| 備份檔案 | 30天 | 每天 |

**可調整參數：**
```typescript
// wrangler.toml
[vars]
RETENTION_SOFT_DELETED_DAYS = "90"
RETENTION_AUDIT_LOGS_DAYS = "365"
RETENTION_COMPLETED_TASKS_DAYS = "180"
RETENTION_SESSIONS_DAYS = "7"
RETENTION_TEMP_FILES_DAYS = "1"
```

---

## 相關文檔

- [自動化流程：資料庫備份](./03-資料庫備份.md)
- [資料庫設計：審計日誌](../資料庫設計/標準化擴展/AuditLogs.md)

---

**最後更新：** 2025年10月27日  
**文檔版本：** 2.0（模塊化重組版）

