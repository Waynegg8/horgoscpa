# 客戶專屬SOP連結 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 關聯 SOP 到客戶

```typescript
async function linkSOPToClient(
  userId: number,
  clientId: string,
  sopId: number,
  notes?: string
) {
  // 1. 權限檢查
  const user = await getUser(userId);
  if (user.role !== 'admin') {
    throw new Error('無權限操作');
  }
  
  // 2. 檢查客戶是否存在
  const client = await db.prepare(
    'SELECT * FROM Clients WHERE tax_registration_number = ?'
  ).bind(clientId).first();
  
  if (!client) {
    throw new Error('客戶不存在');
  }
  
  // 3. 檢查 SOP 是否存在
  const sop = await db.prepare(
    'SELECT * FROM SOPDocuments WHERE sop_id = ?'
  ).bind(sopId).first();
  
  if (!sop) {
    throw new Error('SOP 不存在');
  }
  
  // 4. 檢查是否已關聯
  const existing = await db.prepare(`
    SELECT * FROM ClientSOPLinks 
    WHERE client_id = ? AND sop_id = ?
  `).bind(clientId, sopId).first();
  
  if (existing) {
    throw new Error('此 SOP 已關聯到該客戶');
  }
  
  // 5. 建立關聯
  const result = await db.prepare(`
    INSERT INTO ClientSOPLinks (
      client_id, sop_id, notes, created_by
    ) VALUES (?, ?, ?, ?)
  `).bind(clientId, sopId, notes || null, userId).run();
  
  return { link_id: result.meta.last_row_id };
}
```

---

## 查詢客戶的 SOP 列表

```typescript
async function getClientSOPs(clientId: string) {
  const links = await db.prepare(`
    SELECT 
      csl.*,
      sop.title as sop_title,
      sop.category as sop_category,
      sop.version as sop_version,
      sop.content as sop_content
    FROM ClientSOPLinks csl
    JOIN SOPDocuments sop ON csl.sop_id = sop.sop_id
    WHERE csl.client_id = ?
      AND sop.is_deleted = 0
      AND sop.is_published = 1
    ORDER BY csl.created_at DESC
  `).bind(clientId).all();
  
  return links.results;
}
```

---

## 解除 SOP 關聯

```typescript
async function unlinkSOPFromClient(
  userId: number,
  linkId: number
) {
  // 1. 權限檢查
  const user = await getUser(userId);
  if (user.role !== 'admin') {
    throw new Error('無權限操作');
  }
  
  // 2. 刪除關聯
  await db.prepare(
    'DELETE FROM ClientSOPLinks WHERE link_id = ?'
  ).bind(linkId).run();
  
  return { success: true };
}
```

---

## 相關文檔

- [功能模塊 - 客戶專屬SOP連結](../../功能模塊/19-客戶專屬SOP連結.md)
- [UI 設計](./UI設計.md)

