# 儀表板 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 查詢儀表板數據

```typescript
async function getDashboardData(userId: number) {
  // 1. 我的任務（進行中，按到期日排序，最多5筆）
  const tasks = await db.prepare(`
    SELECT * FROM ActiveTasks 
    WHERE assigned_to = ? 
      AND status IN ('pending', 'in_progress')
      AND is_deleted = 0
    ORDER BY expected_due_date ASC
    LIMIT 5
  `).bind(userId).all();
  
  // 2. 待辦階段（進行中的階段）
  const stages = await db.prepare(`
    SELECT 
      ats.*,
      at.task_name
    FROM ActiveTaskStages ats
    JOIN ActiveTasks at ON ats.task_id = at.task_id
    WHERE at.assigned_to = ?
      AND ats.status = 'in_progress'
    ORDER BY ats.expected_due_date ASC
    LIMIT 10
  `).bind(userId).all();
  
  // 3. 本月工時統計
  const currentMonth = new Date().toISOString().slice(0, 7);
  const timeStats = await db.prepare(`
    SELECT 
      SUM(hours) as normal_hours,
      SUM(weighted_hours) as weighted_hours
    FROM TimeLogs
    WHERE user_id = ?
      AND strftime('%Y-%m', work_date) = ?
  `).bind(userId, currentMonth).first();
  
  // 4. 假期餘額
  const currentYear = new Date().getFullYear();
  const leaveBalances = await db.prepare(`
    SELECT 
      lb.*,
      lt.leave_type_name
    FROM LeaveBalances lb
    JOIN LeaveTypes lt ON lb.leave_type_id = lt.leave_type_id
    WHERE lb.user_id = ? AND lb.year = ?
    ORDER BY lt.sort_order
  `).bind(userId, currentYear).all();
  
  return {
    tasks: tasks.results,
    stages: stages.results,
    monthlyHours: {
      normal: timeStats.normal_hours || 0,
      weighted: timeStats.weighted_hours || 0
    },
    leaveBalances: leaveBalances.results
  };
}
```

---

## 相關文檔

- [功能模塊 - 儀表板](../../功能模塊/06-儀表板.md)
- [UI 設計](./UI設計.md)


