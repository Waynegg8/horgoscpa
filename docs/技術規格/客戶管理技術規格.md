# 客戶管理技術規格

**包含內容：** UI設計、業務邏輯、驗證規則、標籤系統、測試案例 (合併5個文檔)  
**最後更新：** 2025年10月27日

---

## 📋 目錄
- [UI設計](#ui設計)
  - [客戶列表頁面](#客戶列表頁面)
  - [客戶表單頁面](#客戶表單頁面)
- [業務邏輯](#業務邏輯)
- [驗證規則](#驗證規則)
- [標籤系統](#標籤系統)
- [測試案例](#測試案例)

---

## UI設計

### 客戶列表頁面

#### 頁面結構
```
┌─────────────────────────────────────────────────┐
│ 🏢 客戶管理                      [+ 新增客戶]    │
├─────────────────────────────────────────────────┤
│ 搜尋: [_________] 篩選: [營業狀況▼] [組織類型▼]│
├─────────────────────────────────────────────────┤
│ ☑ | 統一編號  | 公司名稱        | 負責人 | 標籤  │
│ ☐ | 86753078 | 冠群資訊公司    | 紜蓁   | VIP  │
│ ☐ | 12345678 | 測試公司        | 曉明   |      │
├─────────────────────────────────────────────────┤
│ 顯示 1-20 / 共 150 筆        [上一頁] [下一頁]  │
└─────────────────────────────────────────────────┘
```

#### Vue 組件
```vue
<template>
  <div class="客戶列表-page">
    <!-- 標題列 -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">客戶管理</h1>
      <StyledButton 
        variant="primary" 
        @click="showCreateModal = true"
      >
        + 新增客戶
      </StyledButton>
    </div>

    <!-- 搜尋與篩選 -->
    <div class="flex gap-4 mb-4">
      <StyledInput
        v-model="searchQuery"
        placeholder="搜尋公司名稱或統一編號"
        @input="handleSearch"
      />
      <select v-model="filters.businessStatus" class="form-select">
        <option value="">所有營業狀況</option>
        <option value="營業中">營業中</option>
        <option value="停業">停業</option>
        <option value="歇業">歇業</option>
      </select>
    </div>

    <!-- 資料表格 -->
    <DataTable
      :columns="columns"
      :data="clients"
      :loading="isLoading"
      @row-click="handleRowClick"
    />

    <!-- 分頁 -->
    <Pagination
      :total="totalCount"
      :current-page="currentPage"
      :page-size="pageSize"
      @page-change="handlePageChange"
    />
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { getClients } from '@/api/clients';

const columns = [
  { key: 'client_id', label: '統一編號', width: '120px' },
  { key: 'company_name', label: '公司名稱' },
  { key: 'assignee_name', label: '負責人', width: '100px' },
  { key: 'tags', label: '標籤', width: '150px' }
];

const clients = ref([]);
const isLoading = ref(false);
const searchQuery = ref('');
const currentPage = ref(1);
const pageSize = ref(50);

onMounted(() => {
  fetchClients();
});

async function fetchClients() {
  isLoading.value = true;
  try {
    const response = await getClients({
      search: searchQuery.value,
      limit: pageSize.value,
      offset: (currentPage.value - 1) * pageSize.value
    });
    clients.value = response.data;
  } finally {
    isLoading.value = false;
  }
}
</script>
```

---

### 客戶表單頁面

#### 表單結構
```
┌─────────────────────────────────────────┐
│ 基本資料                                 │
├─────────────────────────────────────────┤
│ 統一編號*: [________]                   │
│ 公司名稱*: [________________________]   │
│ 負責員工*: [紜蓁 ▼]                     │
├─────────────────────────────────────────┤
│ 稅務資料                                 │
├─────────────────────────────────────────┤
│ 稅籍編號: [________]                    │
│ 營業狀況: [營業中 ▼]                    │
│ 組織種類: [股份有限公司 ▼]              │
├─────────────────────────────────────────┤
│ 聯絡資訊                                 │
├─────────────────────────────────────────┤
│ 電話: [__________]                      │
│ Email: [__________]                     │
├─────────────────────────────────────────┤
│ 標籤                                     │
├─────────────────────────────────────────┤
│ [VIP客戶] [長期合作] [+ 新增標籤]       │
├─────────────────────────────────────────┤
│          [取消]          [儲存]          │
└─────────────────────────────────────────┘
```

#### Vue 組件
```vue
<template>
  <form @submit.prevent="handleSubmit">
    <FormLayout title="客戶資料">
      <!-- 基本資料 -->
      <div class="space-y-4">
        <StyledInput
          v-model="form.client_id"
          label="統一編號"
          :required="true"
          :error="errors.client_id"
          maxlength="8"
          @blur="validateClientId"
        />
        
        <StyledInput
          v-model="form.company_name"
          label="公司名稱"
          :required="true"
          :error="errors.company_name"
        />
        
        <div>
          <label class="block text-sm font-medium mb-1">
            負責員工 <span class="text-red-500">*</span>
          </label>
          <select 
            v-model="form.assignee_user_id" 
            class="form-select w-full"
          >
            <option value="">請選擇</option>
            <option 
              v-for="user in users" 
              :key="user.user_id" 
              :value="user.user_id"
            >
              {{ user.name }}
            </option>
          </select>
        </div>
      </div>

      <!-- 標籤 -->
      <div class="mt-6">
        <label class="block text-sm font-medium mb-2">標籤</label>
        <div class="flex flex-wrap gap-2">
          <span 
            v-for="tag in selectedTags" 
            :key="tag.tag_id"
            class="badge"
          >
            {{ tag.tag_name }}
            <button @click="removeTag(tag.tag_id)">×</button>
          </span>
          <button 
            type="button" 
            class="badge-add"
            @click="showTagModal = true"
          >
            + 新增標籤
          </button>
        </div>
      </div>

      <!-- 按鈕 -->
      <div class="mt-8 flex justify-end gap-4">
        <StyledButton 
          variant="ghost" 
          type="button"
          @click="$router.back()"
        >
          取消
        </StyledButton>
        <StyledButton 
          variant="primary" 
          type="submit"
          :loading="isSubmitting"
        >
          儲存
        </StyledButton>
      </div>
    </FormLayout>
  </form>
</template>
```

---

## 業務邏輯

### 新增客戶流程
```
1. 驗證統一編號格式（8位數字）
   ↓
2. 檢查統一編號是否重複
   ↓
3. 驗證必填欄位
   ↓
4. 插入 Clients 表
   ↓
5. 插入標籤關聯（若有）
   ↓
6. 返回成功訊息
```

### 權限控制
- **管理員**：可以新增、編輯、刪除所有客戶
- **員工**：只能查看自己負責的客戶

---

## 驗證規則

### 統一編號驗證
```javascript
function validateClientId(clientId) {
  // 必須是 8 位數字
  if (!/^\d{8}$/.test(clientId)) {
    return '統一編號必須為 8 位數字';
  }
  
  // 檢查重複（需調用 API）
  const exists = await checkClientIdExists(clientId);
  if (exists) {
    return '統一編號已存在';
  }
  
  return null;
}
```

### Email 驗證
```javascript
function validateEmail(email) {
  if (!email) return null; // 非必填
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return 'Email 格式錯誤';
  }
  
  return null;
}
```

### 電話驗證
```javascript
function validatePhone(phone) {
  if (!phone) return null; // 非必填
  
  const phoneRegex = /^0\d{1,2}-?\d{7,8}$/;
  if (!phoneRegex.test(phone)) {
    return '電話格式錯誤（如：02-12345678）';
  }
  
  return null;
}
```

---

## 標籤系統

### 標籤管理
- 管理員可新增、編輯、刪除標籤
- 標籤名稱唯一
- 標籤可設定顏色

### 標籤關聯
- 一個客戶可以有多個標籤
- 同一客戶不能重複同一標籤
- 刪除客戶時自動刪除關聯

### 標籤搜尋
```javascript
// 查詢有特定標籤的客戶
async function getClientsByTags(tagIds) {
  const response = await api.get('/clients', {
    params: { tag_ids: tagIds.join(',') }
  });
  return response.data;
}
```

---

## 測試案例

### 測試 1：新增客戶 - 成功
```javascript
test('應該成功新增客戶', async () => {
  const clientData = {
    client_id: '12345678',
    company_name: '測試公司',
    assignee_user_id: 1
  };
  
  const response = await createClient(clientData);
  
  expect(response.success).toBe(true);
  expect(response.data.client_id).toBe('12345678');
});
```

### 測試 2：統一編號重複
```javascript
test('應該拒絕重複的統一編號', async () => {
  const clientData = {
    client_id: '12345678', // 已存在
    company_name: '測試公司2',
    assignee_user_id: 1
  };
  
  await expect(createClient(clientData))
    .rejects
    .toThrow('統一編號已存在');
});
```

### 測試 3：驗證必填欄位
```javascript
test('應該要求必填欄位', async () => {
  const clientData = {
    client_id: '12345678'
    // 缺少 company_name
  };
  
  await expect(createClient(clientData))
    .rejects
    .toThrow('公司名稱為必填欄位');
});
```

### 測試 4：權限檢查
```javascript
test('非管理員只能看自己負責的客戶', async () => {
  // 以員工身份登入
  const user = { user_id: 2, is_admin: false };
  
  const response = await getClients({ user });
  
  // 所有客戶的 assignee_user_id 應該都是 2
  response.data.forEach(client => {
    expect(client.assignee_user_id).toBe(2);
  });
});
```

---

## 🔗 相關文檔

- **API 規格：** [客戶管理API](../API規格/客戶管理API.md)
- **功能模塊：** [客戶管理](../功能模塊/23-客戶管理.md)
- **資料庫設計：** [核心業務表](../資料庫設計/核心業務表.md#clients---客戶資料)

---

**最後更新：** 2025年10月27日  
**本文檔合併了以下 5 個文檔：**
1. 客戶列表UI.md
2. 客戶表單UI.md
3. 業務邏輯.md
4. 標籤系統.md
5. 驗證規則.md
6. 測試案例.md

