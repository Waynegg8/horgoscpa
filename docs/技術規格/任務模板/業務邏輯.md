# 任務模板管理 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 核心業務規則

### 1. 階段順序規則

#### 順序編號
- 階段順序從 1 開始
- 同一模板下的階段順序不可重複
- 建議連續編號（1, 2, 3...）

#### 驗證邏輯
```typescript
function validateStageOrder(stages: Stage[]): boolean {
  const orders = stages.map(s => s.stage_order);
  const uniqueOrders = new Set(orders);
  
  if (orders.length !== uniqueOrders.size) {
    throw new Error('階段順序不可重複');
  }
  
  return true;
}
```

---

### 2. 階段依賴規則

#### 依賴限制
- `depends_on` 必須指向同一模板的其他階段
- 不允許循環依賴（A依賴B，B依賴A）
- 依賴階段的順序必須小於當前階段

#### 循環依賴檢查
```typescript
async function checkCircularDependency(
  templateId: number,
  stageId: number, 
  dependsOn: number
): Promise<boolean> {
  const visited = new Set<number>();
  
  async function traverse(currentId: number): Promise<boolean> {
    if (currentId === stageId) {
      return true;  // 發現循環
    }
    
    if (visited.has(currentId)) {
      return false;
    }
    
    visited.add(currentId);
    
    const stage = await db.prepare(`
      SELECT depends_on 
      FROM TaskStageTemplates 
      WHERE stage_template_id = ? AND task_template_id = ?
    `).bind(currentId, templateId).first();
    
    if (stage?.depends_on) {
      return await traverse(stage.depends_on);
    }
    
    return false;
  }
  
  return await traverse(dependsOn);
}
```

#### 依賴順序檢查
```typescript
async function validateDependencyOrder(
  templateId: number,
  stageOrder: number,
  dependsOnId: number
): Promise<boolean> {
  const dependentStage = await db.prepare(`
    SELECT stage_order 
    FROM TaskStageTemplates 
    WHERE stage_template_id = ?
  `).bind(dependsOnId).first();
  
  if (dependentStage.stage_order >= stageOrder) {
    throw new Error('依賴階段必須在當前階段之前');
  }
  
  return true;
}
```

---

### 3. 總天數自動計算

#### 計算邏輯
```typescript
async function updateTemplateTotalDays(templateId: number) {
  const result = await db.prepare(`
    SELECT SUM(estimated_days) as total
    FROM TaskStageTemplates
    WHERE task_template_id = ?
  `).bind(templateId).first();
  
  await db.prepare(`
    UPDATE TaskTemplates 
    SET total_days = ?, updated_at = datetime('now')
    WHERE task_template_id = ?
  `).bind(result.total || 0, templateId).run();
}
```

#### 觸發器（自動更新）
已在資料庫設計中定義，每次新增/更新/刪除階段時自動執行。

---

## CRUD 業務流程

### 新增任務模板
```typescript
async function createTaskTemplate(
  input: CreateTemplateInput,
  userId: number
) {
  // 1. 驗證服務項目（如果有關聯）
  if (input.service_template_id) {
    const service = await db.prepare(
      'SELECT * FROM Services WHERE service_id = ? AND is_deleted = 0'
    ).bind(input.service_template_id).first();
    
    if (!service) {
      throw new Error('服務項目不存在');
    }
  }
  
  // 2. 建立模板
  const result = await db.prepare(`
    INSERT INTO TaskTemplates (
      name, service_template_id, description, created_by
    ) VALUES (?, ?, ?, ?)
  `).bind(
    input.name,
    input.service_template_id || null,
    input.description || null,
    userId
  ).run();
  
  const templateId = result.meta.last_row_id;
  
  // 3. 建立階段
  if (input.stages && input.stages.length > 0) {
    for (let i = 0; i < input.stages.length; i++) {
      const stage = input.stages[i];
      
      // 驗證依賴
      if (stage.depends_on !== null) {
        if (stage.depends_on >= i) {
          throw new Error('依賴階段必須在當前階段之前');
        }
      }
      
      await db.prepare(`
        INSERT INTO TaskStageTemplates (
          task_template_id, stage_name, stage_order,
          estimated_days, description, depends_on
        ) VALUES (?, ?, ?, ?, ?, ?)
      `).bind(
        templateId,
        stage.stage_name,
        i + 1,  // 階段順序從1開始
        stage.estimated_days,
        stage.description || null,
        stage.depends_on !== null ? input.stages[stage.depends_on].stage_template_id : null
      ).run();
    }
  }
  
  return templateId;
}
```

### 更新任務模板
```typescript
async function updateTaskTemplate(
  id: number,
  input: UpdateTemplateInput,
  userId: number
) {
  // 1. 檢查是否存在
  const existing = await db.prepare(
    'SELECT * FROM TaskTemplates WHERE task_template_id = ? AND is_deleted = 0'
  ).bind(id).first();
  
  if (!existing) {
    throw new Error('任務模板不存在');
  }
  
  // 2. 更新基本資訊
  await db.prepare(`
    UPDATE TaskTemplates 
    SET 
      name = COALESCE(?, name),
      service_template_id = COALESCE(?, service_template_id),
      description = COALESCE(?, description),
      updated_at = datetime('now')
    WHERE task_template_id = ?
  `).bind(
    input.name,
    input.service_template_id,
    input.description,
    id
  ).run();
  
  // 3. 如果有階段更新，重新建立所有階段
  if (input.stages) {
    // 刪除舊階段
    await db.prepare(
      'DELETE FROM TaskStageTemplates WHERE task_template_id = ?'
    ).bind(id).run();
    
    // 建立新階段
    for (let i = 0; i < input.stages.length; i++) {
      const stage = input.stages[i];
      
      await db.prepare(`
        INSERT INTO TaskStageTemplates (
          task_template_id, stage_name, stage_order,
          estimated_days, description, depends_on
        ) VALUES (?, ?, ?, ?, ?, ?)
      `).bind(
        id,
        stage.stage_name,
        i + 1,
        stage.estimated_days,
        stage.description || null,
        stage.depends_on !== null ? input.stages[stage.depends_on].stage_template_id : null
      ).run();
    }
  }
}
```

### 複製任務模板
```typescript
async function copyTaskTemplate(
  sourceId: number,
  userId: number
): Promise<number> {
  // 1. 查詢來源模板
  const source = await db.prepare(`
    SELECT * FROM TaskTemplates WHERE task_template_id = ? AND is_deleted = 0
  `).bind(sourceId).first();
  
  if (!source) {
    throw new Error('來源模板不存在');
  }
  
  // 2. 建立新模板
  const result = await db.prepare(`
    INSERT INTO TaskTemplates (
      name, service_template_id, description, created_by
    ) VALUES (?, ?, ?, ?)
  `).bind(
    `${source.name} (副本)`,
    source.service_template_id,
    source.description,
    userId
  ).run();
  
  const newTemplateId = result.meta.last_row_id;
  
  // 3. 複製階段
  const stages = await db.prepare(`
    SELECT * FROM TaskStageTemplates 
    WHERE task_template_id = ?
    ORDER BY stage_order
  `).bind(sourceId).all();
  
  const stageIdMapping = new Map(); // 舊ID -> 新ID
  
  for (const stage of stages.results) {
    const stageResult = await db.prepare(`
      INSERT INTO TaskStageTemplates (
        task_template_id, stage_name, stage_order,
        estimated_days, description, depends_on
      ) VALUES (?, ?, ?, ?, ?, ?)
    `).bind(
      newTemplateId,
      stage.stage_name,
      stage.stage_order,
      stage.estimated_days,
      stage.description,
      null  // 稍後更新依賴
    ).run();
    
    stageIdMapping.set(stage.stage_template_id, stageResult.meta.last_row_id);
  }
  
  // 4. 更新依賴關係
  for (const stage of stages.results) {
    if (stage.depends_on) {
      const newStageId = stageIdMapping.get(stage.stage_template_id);
      const newDependsOn = stageIdMapping.get(stage.depends_on);
      
      await db.prepare(`
        UPDATE TaskStageTemplates 
        SET depends_on = ?
        WHERE stage_template_id = ?
      `).bind(newDependsOn, newStageId).run();
    }
  }
  
  return newTemplateId;
}
```

### 刪除任務模板
```typescript
async function deleteTaskTemplate(id: number, userId: number) {
  // 1. 檢查是否存在
  const existing = await db.prepare(
    'SELECT * FROM TaskTemplates WHERE task_template_id = ? AND is_deleted = 0'
  ).bind(id).first();
  
  if (!existing) {
    throw new Error('任務模板不存在');
  }
  
  // 2. 檢查是否有客戶服務使用此模板
  const usedInServices = await db.prepare(`
    SELECT COUNT(*) as count 
    FROM ClientServices 
    WHERE task_template_id = ? AND is_deleted = 0
  `).bind(id).first();
  
  if (usedInServices.count > 0) {
    throw new Error('此模板正被客戶服務使用，無法刪除');
  }
  
  // 3. 檢查是否有進行中的任務使用此模板
  const usedInTasks = await db.prepare(`
    SELECT COUNT(*) as count 
    FROM ActiveTasks 
    WHERE task_template_id = ? 
      AND status IN ('pending', 'in_progress')
      AND is_deleted = 0
  `).bind(id).first();
  
  if (usedInTasks.count > 0) {
    throw new Error('此模板有進行中的任務，無法刪除');
  }
  
  // 4. 軟刪除模板
  await db.prepare(`
    UPDATE TaskTemplates 
    SET is_deleted = 1, deleted_at = datetime('now'), deleted_by = ?
    WHERE task_template_id = ?
  `).bind(userId, id).run();
  
  // 5. 軟刪除階段（可選，因為已經通過外鍵級聯）
  // 此處選擇不刪除階段，保留歷史記錄
}
```

---

## 相關文檔

- [功能模塊 - 任務模板管理](../../功能模塊/14-任務模板管理.md)
- [UI 設計](./UI設計.md)
- [測試案例](./測試案例.md)
- [TaskTemplates 資料表](../../資料庫設計/任務系統/TaskTemplates.md)
- [TaskStageTemplates 資料表](../../資料庫設計/任務系統/TaskStageTemplates.md)





