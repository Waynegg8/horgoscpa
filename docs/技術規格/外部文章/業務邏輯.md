# 外部文章管理 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 新增外部文章

```typescript
async function createExternalArticle(
  userId: number,
  input: CreateExternalArticleInput
) {
  // 1. 權限檢查
  const user = await getUser(userId);
  if (user.role !== 'admin') {
    throw new Error('無權限操作');
  }
  
  // 2. 驗證 URL 格式
  try {
    new URL(input.url);
  } catch {
    throw new Error('無效的 URL 格式');
  }
  
  // 3. 插入資料
  const result = await db.prepare(`
    INSERT INTO ExternalArticles (
      title, url, source, summary, category, tags, 
      published_date, created_by
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
  `).bind(
    input.title,
    input.url,
    input.source || null,
    input.summary || null,
    input.category || null,
    JSON.stringify(input.tags || []),
    input.published_date || null,
    userId
  ).run();
  
  return { external_article_id: result.meta.last_row_id };
}
```

---

## 查詢外部文章列表

```typescript
async function getExternalArticles(filters: {
  source?: string;
  category?: string;
  search?: string;
}) {
  let sql = `
    SELECT * FROM ExternalArticles
    WHERE is_deleted = 0
  `;
  
  const params = [];
  
  if (filters.source) {
    sql += ' AND source = ?';
    params.push(filters.source);
  }
  
  if (filters.category) {
    sql += ' AND category = ?';
    params.push(filters.category);
  }
  
  if (filters.search) {
    sql += ' AND title LIKE ?';
    params.push(`%${filters.search}%`);
  }
  
  sql += ' ORDER BY published_date DESC, created_at DESC';
  
  const result = await db.prepare(sql).bind(...params).all();
  return result.results;
}
```

---

## 記錄點擊次數

```typescript
async function trackArticleClick(externalArticleId: number) {
  await db.prepare(`
    UPDATE ExternalArticles 
    SET click_count = click_count + 1
    WHERE external_article_id = ?
  `).bind(externalArticleId).run();
  
  return { success: true };
}
```

---

## 相關文檔

- [功能模塊 - 外部文章管理](../../功能模塊/21-外部文章管理.md)
- [UI 設計](./UI設計.md)

