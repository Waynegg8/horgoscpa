# 階段進度更新 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 核心業務規則

### 1. 階段依賴檢查

#### 檢查邏輯
```typescript
async function canStartStage(stageId: number): Promise<boolean> {
  const stage = await db.prepare(`
    SELECT depends_on FROM ActiveTaskStages WHERE active_stage_id = ?
  `).bind(stageId).first();
  
  if (!stage.depends_on) {
    return true;  // 沒有依賴，可直接開始
  }
  
  // 檢查依賴階段是否已完成
  const dependentStage = await db.prepare(`
    SELECT status FROM ActiveTaskStages WHERE active_stage_id = ?
  `).bind(stage.depends_on).first();
  
  return dependentStage?.status === 'completed';
}
```

---

### 2. 階段日期計算

#### 開始階段時
```typescript
async function startStage(stageId: number, userId: number) {
  // 1. 檢查是否可以開始
  const canStart = await canStartStage(stageId);
  if (!canStart) {
    throw new Error('需先完成依賴階段');
  }
  
  // 2. 檢查階段狀態
  const stage = await db.prepare(
    'SELECT * FROM ActiveTaskStages WHERE active_stage_id = ?'
  ).bind(stageId).first();
  
  if (stage.status !== 'pending') {
    throw new Error('階段已開始');
  }
  
  // 3. 計算日期
  const today = new Date().toISOString().split('T')[0];
  const startDate = new Date(today);
  startDate.setDate(startDate.getDate() + stage.estimated_days);
  const dueDate = startDate.toISOString().split('T')[0];
  
  // 4. 更新階段
  await db.prepare(`
    UPDATE ActiveTaskStages 
    SET 
      status = 'in_progress',
      actual_start_date = ?,
      expected_due_date = ?,
      updated_at = datetime('now')
    WHERE active_stage_id = ?
  `).bind(today, dueDate, stageId).run();
  
  // 5. 如果是第一個階段，更新任務開始日期
  const task = await db.prepare(`
    SELECT at.* FROM ActiveTasks at
    JOIN ActiveTaskStages ats ON at.task_id = ats.task_id
    WHERE ats.active_stage_id = ?
  `).bind(stageId).first();
  
  if (!task.actual_start_date) {
    await db.prepare(`
      UPDATE ActiveTasks 
      SET 
        actual_start_date = ?,
        status = 'in_progress',
        updated_at = datetime('now')
      WHERE task_id = ?
    `).bind(today, task.task_id).run();
  }
}
```

#### 完成階段時
```typescript
async function completeStage(stageId: number, notes?: string, userId?: number) {
  const stage = await db.prepare(
    'SELECT * FROM ActiveTaskStages WHERE active_stage_id = ?'
  ).bind(stageId).first();
  
  if (stage.status === 'completed') {
    throw new Error('階段已完成');
  }
  
  const today = new Date().toISOString().split('T')[0];
  
  await db.prepare(`
    UPDATE ActiveTaskStages 
    SET 
      status = 'completed',
      actual_completion_date = ?,
      notes = COALESCE(?, notes),
      updated_at = datetime('now')
    WHERE active_stage_id = ?
  `).bind(today, notes, stageId).run();
  
  // 更新任務進度
  await updateTaskProgress(stage.task_id);
}
```

---

### 3. 剩餘天數計算

```typescript
function calculateDaysRemaining(dueDate: string): number | null {
  if (!dueDate) return null;
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const due = new Date(dueDate);
  due.setHours(0, 0, 0, 0);
  
  const diff = due.getTime() - today.getTime();
  return Math.ceil(diff / (1000 * 60 * 60 * 24));
}
```

---

## 查詢階段列表

```typescript
async function getTaskStages(taskId: number) {
  const stages = await db.prepare(`
    SELECT 
      ats.*,
      dep_stage.stage_name as depends_on_name
    FROM ActiveTaskStages ats
    LEFT JOIN ActiveTaskStages dep_stage ON ats.depends_on = dep_stage.active_stage_id
    WHERE ats.task_id = ?
    ORDER BY ats.stage_order
  `).bind(taskId).all();
  
  // 計算每階段的剩餘天數和可否開始
  const result = await Promise.all(stages.results.map(async (stage) => {
    const daysRemaining = calculateDaysRemaining(stage.expected_due_date);
    const canStart = await canStartStage(stage.active_stage_id);
    
    return {
      ...stage,
      days_remaining: daysRemaining,
      can_start: canStart
    };
  }));
  
  return result;
}
```

---

## 更新階段備註

```typescript
async function updateStageNotes(stageId: number, notes: string, userId: number) {
  const stage = await db.prepare(
    'SELECT * FROM ActiveTaskStages WHERE active_stage_id = ?'
  ).bind(stageId).first();
  
  if (!stage) {
    throw new Error('階段不存在');
  }
  
  await db.prepare(`
    UPDATE ActiveTaskStages 
    SET notes = ?, updated_at = datetime('now')
    WHERE active_stage_id = ?
  `).bind(notes, stageId).run();
}
```

---

## 自動更新任務進度

```typescript
async function updateTaskProgress(taskId: number) {
  const stages = await db.prepare(`
    SELECT status FROM ActiveTaskStages WHERE task_id = ?
  `).bind(taskId).all();
  
  const total = stages.results.length;
  const completed = stages.results.filter(s => s.status === 'completed').length;
  const progress = Math.round((completed / total) * 100);
  
  // 檢查是否全部完成
  if (progress === 100) {
    const today = new Date().toISOString().split('T')[0];
    
    await db.prepare(`
      UPDATE ActiveTasks 
      SET 
        progress = 100,
        status = 'completed',
        actual_completion_date = ?,
        updated_at = datetime('now')
      WHERE task_id = ?
    `).bind(today, taskId).run();
  } else {
    await db.prepare(`
      UPDATE ActiveTasks 
      SET progress = ?, updated_at = datetime('now')
      WHERE task_id = ?
    `).bind(progress, taskId).run();
  }
}
```

---

## 相關文檔

- [功能模塊 - 階段進度更新](../../功能模塊/17-階段進度更新.md)
- [UI 設計](./UI設計.md)
- [測試案例](./測試案例.md)





