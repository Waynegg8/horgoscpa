# 補休機制完整設計

**所屬功能：** [業務規則管理](../../功能模塊/02-業務規則管理.md)  
**最後更新：** 2025年10月27日

---

## 概述

員工加班後自動累積補休時數，可在工時表選擇「補休」請假。月底未使用的補休自動轉為加班費發放。

**核心特點：**
- ✅ 自動累積（符合勞基法的加班類型）
- ✅ FIFO 扣除（先進先出）
- ✅ 月底清零（自動轉加班費）
- ✅ 計入加權工時
- ✅ 顯示在假期餘額報表

---

## 補休流程

### 流程 1：累積補休

```
員工填寫加班工時
↓
系統檢查：此加班類型是否可累積補休？
├─ 是 → 計算補休時數
│  ├─ 平日加班：1小時累積1小時補休
│  ├─ 休息日加班：1小時累積1小時補休
│  ├─ 國定假日加班：1小時累積1小時補休
│  └─ 例假日加班：需額外補休（勞基法規定）
│
└─ 否 → 不累積補休
↓
寫入 CompensatoryLeaveTransactions
  - transaction_type: 'earn'
  - hours: 補休時數
  - original_work_day_type: 原始加班類型
  - original_overtime_rate: 原始費率
↓
更新 CompensatoryLeaveBalance
  - earned_hours += 補休時數
  - current_balance += 補休時數
```

---

### 流程 2：使用補休

```
員工在工時表選擇「補休」類型請假
↓
系統檢查補休餘額
├─ 餘額不足 → 拒絕申請
└─ 餘額充足 → 繼續處理
↓
FIFO 扣除補休時數
  1. 按 created_at 排序找到最早的「累積」記錄
  2. 扣除該記錄的補休時數
  3. 如果不足，繼續扣除下一筆
  4. 記錄扣除明細到 CompensatoryLeaveUsage
↓
寫入 CompensatoryLeaveTransactions
  - transaction_type: 'use'
  - hours: 使用時數
↓
更新 CompensatoryLeaveBalance
  - used_hours += 使用時數
  - current_balance -= 使用時數
↓
寫入 TimeLogs
  - leave_type: 'compensatory_leave'
  - hours: 使用時數
  - work_type_hours: 使用時數（計入加權工時）
```

---

### 流程 3：月底結算

```
每月最後一天 23:59 (自動任務)
↓
查詢所有員工的當月補休餘額
↓
對每個有餘額的員工：
  1. 計算未使用時數 = current_balance
  2. 按照原始費率計算加班費
     - 從 FIFO 順序找到未使用的「累積」記錄
     - 按其 original_overtime_rate 計算
     - 例如：2H×1.34倍 + 1H×1.67倍
  3. 記錄到薪資系統（待實作）
  4. 寫入 CompensatoryLeaveTransactions
     - transaction_type: 'expire'
     - hours: 清零時數
  5. 更新 CompensatoryLeaveBalance
     - expired_hours = current_balance
     - current_balance = 0
↓
產生月結報告供管理員檢視
```

---

## FIFO 扣除邏輯

### 範例情境

**員工補休累積記錄：**
| ID | 日期 | 類型 | 時數 | 原始費率 | 已使用 | 剩餘 |
|----|------|------|------|---------|--------|------|
| 1  | 10/01 | 平日 | 2H   | 1.34    | 0H     | 2H   |
| 2  | 10/05 | 休息日 | 3H | 1.67    | 0H     | 3H   |
| 3  | 10/10 | 平日 | 2H   | 1.34    | 0H     | 2H   |

**員工申請補休 4H：**

```
步驟 1：從最早的記錄開始扣除
  - 記錄 ID=1：剩餘 2H
  - 扣除 2H
  - 剩餘需扣除：4H - 2H = 2H
  - 記錄 ID=1 完全使用

步驟 2：繼續扣除下一筆
  - 記錄 ID=2：剩餘 3H
  - 扣除 2H
  - 剩餘需扣除：2H - 2H = 0H
  - 記錄 ID=2 剩餘 1H

結果：
  - 記錄 ID=1：2H 已全部使用
  - 記錄 ID=2：2H 已使用，1H 剩餘
  - 記錄 ID=3：0H 已使用，2H 剩餘
```

**寫入 CompensatoryLeaveUsage：**
```sql
INSERT INTO CompensatoryLeaveUsage (earn_transaction_id, use_transaction_id, used_hours)
VALUES 
  (1, 999, 2.0),  -- 從累積記錄1扣除2H
  (2, 999, 2.0);  -- 從累積記錄2扣除2H
```

---

## 月底結算費率計算

### 範例情境

**員工補休累積記錄（月底未使用）：**
| ID | 類型 | 時數 | 原始費率 | 已使用 | 剩餘 |
|----|------|------|---------|--------|------|
| 1  | 平日 | 2H   | 1.34    | 0H     | 2H   |
| 2  | 休息日 | 3H | 1.67    | 2H     | 1H   |
| 3  | 平日 | 2H   | 1.34    | 0H     | 2H   |

**計算加班費：**
```
總剩餘：5H (2H + 1H + 2H)

按原始費率計算：
  - 記錄 1：2H × 1.34倍 = 2.68倍時薪
  - 記錄 2：1H × 1.67倍 = 1.67倍時薪
  - 記錄 3：2H × 1.34倍 = 2.68倍時薪

總加班費 = (2.68 + 1.67 + 2.68) × 時薪
         = 7.03 × 時薪
```

---

## 資料表設計

### CompensatoryLeaveBalance（補休餘額）

**用途：** 快速查詢員工當月補休餘額

```sql
CREATE TABLE CompensatoryLeaveBalance (
  balance_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  year_month TEXT NOT NULL,              -- 2025-10
  earned_hours REAL DEFAULT 0,           -- 本月累積
  used_hours REAL DEFAULT 0,             -- 本月使用
  expired_hours REAL DEFAULT 0,          -- 月底清零
  current_balance REAL DEFAULT 0,        -- 當前餘額
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE(user_id, year_month),
  FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE
);
```

---

### CompensatoryLeaveTransactions（補休異動明細）

**用途：** 記錄所有補休的累積、使用、清零

```sql
CREATE TABLE CompensatoryLeaveTransactions (
  transaction_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  transaction_type TEXT CHECK (transaction_type IN ('earn', 'use', 'expire')),
  hours REAL NOT NULL,
  original_work_day_type TEXT,           -- 原始加班類型
  original_overtime_rate REAL,           -- 原始費率
  year_month TEXT NOT NULL,
  transaction_date TEXT NOT NULL,
  related_timelog_id INTEGER,
  notes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE,
  FOREIGN KEY (related_timelog_id) REFERENCES TimeLogs(log_id)
);
```

---

### CompensatoryLeaveUsage（補休使用明細 - FIFO追蹤）

**用途：** 追蹤每次使用補休時從哪些累積記錄扣除

```sql
CREATE TABLE CompensatoryLeaveUsage (
  usage_id INTEGER PRIMARY KEY AUTOINCREMENT,
  earn_transaction_id INTEGER NOT NULL,   -- 對應哪筆「累積」
  use_transaction_id INTEGER NOT NULL,    -- 對應哪筆「使用」
  used_hours REAL NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (earn_transaction_id) REFERENCES CompensatoryLeaveTransactions(transaction_id),
  FOREIGN KEY (use_transaction_id) REFERENCES CompensatoryLeaveTransactions(transaction_id)
);
```

---

## 關鍵查詢

### 查詢 1：獲取員工當月補休餘額

```sql
SELECT current_balance
FROM CompensatoryLeaveBalance
WHERE user_id = ? AND year_month = ?;
```

---

### 查詢 2：FIFO 查找可扣除的累積記錄

```sql
SELECT 
  t.transaction_id,
  t.hours AS total_hours,
  COALESCE(SUM(u.used_hours), 0) AS used_hours,
  t.hours - COALESCE(SUM(u.used_hours), 0) AS remaining_hours,
  t.original_work_day_type,
  t.original_overtime_rate
FROM CompensatoryLeaveTransactions t
LEFT JOIN CompensatoryLeaveUsage u ON t.transaction_id = u.earn_transaction_id
WHERE t.user_id = ?
  AND t.year_month = ?
  AND t.transaction_type = 'earn'
GROUP BY t.transaction_id
HAVING remaining_hours > 0
ORDER BY t.created_at ASC;
```

---

### 查詢 3：月底結算 - 查找未使用的補休

```sql
-- 與查詢2相同，用於計算月底結算的加班費
```

---

## 前端顯示

### 假期餘額報表

```
補休餘額：8.0 小時

本月明細：
  累積：10.0H
  使用：2.0H
  到期：0H
  餘額：8.0H

累積明細：
  2025/10/01 平日加班 +2.0H (費率1.34)
  2025/10/05 休息日加班 +3.0H (費率1.67)
  2025/10/10 平日加班 +2.0H (費率1.34)
  
使用明細：
  2025/10/15 使用補休 -2.0H
```

---

## 測試案例

見 [業務規則測試案例](./測試案例.md) 中的補休相關測試。

---

## 相關文檔

- [功能模塊 - 業務規則管理](../../功能模塊/02-業務規則管理.md)
- [資料庫設計 - CompensatoryLeaveBalance](../../資料庫設計/補休系統/CompensatoryLeaveBalance.md)
- [資料庫設計 - CompensatoryLeaveTransactions](../../資料庫設計/補休系統/CompensatoryLeaveTransactions.md)
- [資料庫設計 - CompensatoryLeaveUsage](../../資料庫設計/補休系統/CompensatoryLeaveUsage.md)

---

**最後更新：** 2025年10月27日



**所屬功能：** [業務規則管理](../../功能模塊/02-業務規則管理.md)  
**最後更新：** 2025年10月27日

---

## 概述

員工加班後自動累積補休時數，可在工時表選擇「補休」請假。月底未使用的補休自動轉為加班費發放。

**核心特點：**
- ✅ 自動累積（符合勞基法的加班類型）
- ✅ FIFO 扣除（先進先出）
- ✅ 月底清零（自動轉加班費）
- ✅ 計入加權工時
- ✅ 顯示在假期餘額報表

---

## 補休流程

### 流程 1：累積補休

```
員工填寫加班工時
↓
系統檢查：此加班類型是否可累積補休？
├─ 是 → 計算補休時數
│  ├─ 平日加班：1小時累積1小時補休
│  ├─ 休息日加班：1小時累積1小時補休
│  ├─ 國定假日加班：1小時累積1小時補休
│  └─ 例假日加班：需額外補休（勞基法規定）
│
└─ 否 → 不累積補休
↓
寫入 CompensatoryLeaveTransactions
  - transaction_type: 'earn'
  - hours: 補休時數
  - original_work_day_type: 原始加班類型
  - original_overtime_rate: 原始費率
↓
更新 CompensatoryLeaveBalance
  - earned_hours += 補休時數
  - current_balance += 補休時數
```

---

### 流程 2：使用補休

```
員工在工時表選擇「補休」類型請假
↓
系統檢查補休餘額
├─ 餘額不足 → 拒絕申請
└─ 餘額充足 → 繼續處理
↓
FIFO 扣除補休時數
  1. 按 created_at 排序找到最早的「累積」記錄
  2. 扣除該記錄的補休時數
  3. 如果不足，繼續扣除下一筆
  4. 記錄扣除明細到 CompensatoryLeaveUsage
↓
寫入 CompensatoryLeaveTransactions
  - transaction_type: 'use'
  - hours: 使用時數
↓
更新 CompensatoryLeaveBalance
  - used_hours += 使用時數
  - current_balance -= 使用時數
↓
寫入 TimeLogs
  - leave_type: 'compensatory_leave'
  - hours: 使用時數
  - work_type_hours: 使用時數（計入加權工時）
```

---

### 流程 3：月底結算

```
每月最後一天 23:59 (自動任務)
↓
查詢所有員工的當月補休餘額
↓
對每個有餘額的員工：
  1. 計算未使用時數 = current_balance
  2. 按照原始費率計算加班費
     - 從 FIFO 順序找到未使用的「累積」記錄
     - 按其 original_overtime_rate 計算
     - 例如：2H×1.34倍 + 1H×1.67倍
  3. 記錄到薪資系統（待實作）
  4. 寫入 CompensatoryLeaveTransactions
     - transaction_type: 'expire'
     - hours: 清零時數
  5. 更新 CompensatoryLeaveBalance
     - expired_hours = current_balance
     - current_balance = 0
↓
產生月結報告供管理員檢視
```

---

## FIFO 扣除邏輯

### 範例情境

**員工補休累積記錄：**
| ID | 日期 | 類型 | 時數 | 原始費率 | 已使用 | 剩餘 |
|----|------|------|------|---------|--------|------|
| 1  | 10/01 | 平日 | 2H   | 1.34    | 0H     | 2H   |
| 2  | 10/05 | 休息日 | 3H | 1.67    | 0H     | 3H   |
| 3  | 10/10 | 平日 | 2H   | 1.34    | 0H     | 2H   |

**員工申請補休 4H：**

```
步驟 1：從最早的記錄開始扣除
  - 記錄 ID=1：剩餘 2H
  - 扣除 2H
  - 剩餘需扣除：4H - 2H = 2H
  - 記錄 ID=1 完全使用

步驟 2：繼續扣除下一筆
  - 記錄 ID=2：剩餘 3H
  - 扣除 2H
  - 剩餘需扣除：2H - 2H = 0H
  - 記錄 ID=2 剩餘 1H

結果：
  - 記錄 ID=1：2H 已全部使用
  - 記錄 ID=2：2H 已使用，1H 剩餘
  - 記錄 ID=3：0H 已使用，2H 剩餘
```

**寫入 CompensatoryLeaveUsage：**
```sql
INSERT INTO CompensatoryLeaveUsage (earn_transaction_id, use_transaction_id, used_hours)
VALUES 
  (1, 999, 2.0),  -- 從累積記錄1扣除2H
  (2, 999, 2.0);  -- 從累積記錄2扣除2H
```

---

## 月底結算費率計算

### 範例情境

**員工補休累積記錄（月底未使用）：**
| ID | 類型 | 時數 | 原始費率 | 已使用 | 剩餘 |
|----|------|------|---------|--------|------|
| 1  | 平日 | 2H   | 1.34    | 0H     | 2H   |
| 2  | 休息日 | 3H | 1.67    | 2H     | 1H   |
| 3  | 平日 | 2H   | 1.34    | 0H     | 2H   |

**計算加班費：**
```
總剩餘：5H (2H + 1H + 2H)

按原始費率計算：
  - 記錄 1：2H × 1.34倍 = 2.68倍時薪
  - 記錄 2：1H × 1.67倍 = 1.67倍時薪
  - 記錄 3：2H × 1.34倍 = 2.68倍時薪

總加班費 = (2.68 + 1.67 + 2.68) × 時薪
         = 7.03 × 時薪
```

---

## 資料表設計

### CompensatoryLeaveBalance（補休餘額）

**用途：** 快速查詢員工當月補休餘額

```sql
CREATE TABLE CompensatoryLeaveBalance (
  balance_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  year_month TEXT NOT NULL,              -- 2025-10
  earned_hours REAL DEFAULT 0,           -- 本月累積
  used_hours REAL DEFAULT 0,             -- 本月使用
  expired_hours REAL DEFAULT 0,          -- 月底清零
  current_balance REAL DEFAULT 0,        -- 當前餘額
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE(user_id, year_month),
  FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE
);
```

---

### CompensatoryLeaveTransactions（補休異動明細）

**用途：** 記錄所有補休的累積、使用、清零

```sql
CREATE TABLE CompensatoryLeaveTransactions (
  transaction_id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  transaction_type TEXT CHECK (transaction_type IN ('earn', 'use', 'expire')),
  hours REAL NOT NULL,
  original_work_day_type TEXT,           -- 原始加班類型
  original_overtime_rate REAL,           -- 原始費率
  year_month TEXT NOT NULL,
  transaction_date TEXT NOT NULL,
  related_timelog_id INTEGER,
  notes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE,
  FOREIGN KEY (related_timelog_id) REFERENCES TimeLogs(log_id)
);
```

---

### CompensatoryLeaveUsage（補休使用明細 - FIFO追蹤）

**用途：** 追蹤每次使用補休時從哪些累積記錄扣除

```sql
CREATE TABLE CompensatoryLeaveUsage (
  usage_id INTEGER PRIMARY KEY AUTOINCREMENT,
  earn_transaction_id INTEGER NOT NULL,   -- 對應哪筆「累積」
  use_transaction_id INTEGER NOT NULL,    -- 對應哪筆「使用」
  used_hours REAL NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (earn_transaction_id) REFERENCES CompensatoryLeaveTransactions(transaction_id),
  FOREIGN KEY (use_transaction_id) REFERENCES CompensatoryLeaveTransactions(transaction_id)
);
```

---

## 關鍵查詢

### 查詢 1：獲取員工當月補休餘額

```sql
SELECT current_balance
FROM CompensatoryLeaveBalance
WHERE user_id = ? AND year_month = ?;
```

---

### 查詢 2：FIFO 查找可扣除的累積記錄

```sql
SELECT 
  t.transaction_id,
  t.hours AS total_hours,
  COALESCE(SUM(u.used_hours), 0) AS used_hours,
  t.hours - COALESCE(SUM(u.used_hours), 0) AS remaining_hours,
  t.original_work_day_type,
  t.original_overtime_rate
FROM CompensatoryLeaveTransactions t
LEFT JOIN CompensatoryLeaveUsage u ON t.transaction_id = u.earn_transaction_id
WHERE t.user_id = ?
  AND t.year_month = ?
  AND t.transaction_type = 'earn'
GROUP BY t.transaction_id
HAVING remaining_hours > 0
ORDER BY t.created_at ASC;
```

---

### 查詢 3：月底結算 - 查找未使用的補休

```sql
-- 與查詢2相同，用於計算月底結算的加班費
```

---

## 前端顯示

### 假期餘額報表

```
補休餘額：8.0 小時

本月明細：
  累積：10.0H
  使用：2.0H
  到期：0H
  餘額：8.0H

累積明細：
  2025/10/01 平日加班 +2.0H (費率1.34)
  2025/10/05 休息日加班 +3.0H (費率1.67)
  2025/10/10 平日加班 +2.0H (費率1.34)
  
使用明細：
  2025/10/15 使用補休 -2.0H
```

---

## 測試案例

見 [業務規則測試案例](./測試案例.md) 中的補休相關測試。

---

## 相關文檔

- [功能模塊 - 業務規則管理](../../功能模塊/02-業務規則管理.md)
- [資料庫設計 - CompensatoryLeaveBalance](../../資料庫設計/補休系統/CompensatoryLeaveBalance.md)
- [資料庫設計 - CompensatoryLeaveTransactions](../../資料庫設計/補休系統/CompensatoryLeaveTransactions.md)
- [資料庫設計 - CompensatoryLeaveUsage](../../資料庫設計/補休系統/CompensatoryLeaveUsage.md)

---

**最後更新：** 2025年10月27日



