# 業務規則管理 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 國定假日判定

```typescript
async function isNationalHoliday(date: string): Promise<boolean> {
  const holiday = await db.prepare(`
    SELECT * FROM NationalHolidays 
    WHERE holiday_date = ? 
      AND holiday_type = 'holiday'
      AND is_active = 1
  `).bind(date).first();
  
  return !!holiday;
}

async function isWorkday(date: string): Promise<boolean> {
  // 檢查是否為補班日
  const workday = await db.prepare(`
    SELECT * FROM NationalHolidays 
    WHERE holiday_date = ? 
      AND holiday_type = 'workday'
      AND is_active = 1
  `).bind(date).first();
  
  if (workday) return true;
  
  // 檢查是否為國定假日
  const isHoliday = await isNationalHoliday(date);
  if (isHoliday) return false;
  
  // 檢查是否為週末
  const dayOfWeek = new Date(date).getDay();
  return dayOfWeek !== 0 && dayOfWeek !== 6;
}
```

---

## 年資計算（精確到月）

```typescript
function calculateMonthsOfService(hireDate: string): number {
  const hire = new Date(hireDate);
  const now = new Date();
  
  let months = (now.getFullYear() - hire.getFullYear()) * 12;
  months += now.getMonth() - hire.getMonth();
  
  // 如果當月日期小於到職日期，減去一個月
  if (now.getDate() < hire.getDate()) {
    months--;
  }
  
  return Math.max(0, months);
}
```

---

## 特休天數計算

```typescript
async function calculateAnnualLeaveDays(userId: number): Promise<number> {
  // 1. 查詢員工到職日
  const user = await db.prepare(
    'SELECT hire_date FROM Users WHERE user_id = ?'
  ).bind(userId).first();
  
  if (!user || !user.hire_date) {
    return 0;
  }
  
  // 2. 計算年資（月數）
  const monthsOfService = calculateMonthsOfService(user.hire_date);
  
  // 3. 根據年資查詢特休規則
  const rule = await db.prepare(`
    SELECT annual_leave_days 
    FROM AnnualLeaveRules 
    WHERE months_of_service <= ?
    ORDER BY months_of_service DESC
    LIMIT 1
  `).bind(monthsOfService).first();
  
  return rule ? rule.annual_leave_days : 0;
}
```

---

## 加班費率判定

```typescript
async function getOvertimeRate(
  workDate: string,
  hours: number
): Promise<{ rate: number; type: string }> {
  // 1. 檢查是否為國定假日
  const isHoliday = await isNationalHoliday(workDate);
  if (isHoliday) {
    return { rate: 2.0, type: '國定假日加班' };
  }
  
  // 2. 檢查是否為週末
  const dayOfWeek = new Date(workDate).getDay();
  if (dayOfWeek === 0 || dayOfWeek === 6) {
    return { rate: 1.67, type: '假日加班' };
  }
  
  // 3. 平日加班（根據時數）
  if (hours <= 2) {
    return { rate: 1.34, type: '平日加班（前2小時）' };
  } else {
    return { rate: 1.67, type: '平日加班（超過2小時）' };
  }
}
```

---

## 補休機制（FIFO）

```typescript
async function accumulateCompTime(
  userId: number,
  overtimeHours: number,
  rate: number,
  workDate: string
) {
  // 累積補休時數（記錄原始費率）
  await db.prepare(`
    INSERT INTO CompTimeBalances (
      user_id, hours, rate, earned_date, expires_at
    ) VALUES (?, ?, ?, ?, ?)
  `).bind(
    userId,
    overtimeHours,
    rate,
    workDate,
    getMonthEnd(workDate) // 月底到期
  ).run();
}

async function useCompTime(
  userId: number,
  requestedHours: number,
  useDate: string
): Promise<{ used: number; remaining: number }> {
  // 1. 查詢可用的補休（FIFO 先進先出）
  const compTimes = await db.prepare(`
    SELECT * FROM CompTimeBalances 
    WHERE user_id = ? 
      AND used = 0
      AND expires_at >= ?
    ORDER BY earned_date ASC
  `).bind(userId, useDate).all();
  
  let remainingToUse = requestedHours;
  let totalUsed = 0;
  
  // 2. 依序扣除
  for (const ct of compTimes.results) {
    if (remainingToUse <= 0) break;
    
    const available = ct.hours;
    const toUse = Math.min(available, remainingToUse);
    
    await db.prepare(`
      UPDATE CompTimeBalances 
      SET used = 1, used_date = ?
      WHERE comp_time_id = ?
    `).bind(useDate, ct.comp_time_id).run();
    
    totalUsed += toUse;
    remainingToUse -= toUse;
  }
  
  return { 
    used: totalUsed, 
    remaining: remainingToUse 
  };
}
```

---

## 月底補休清算

```typescript
async function settleMontlyCompTime(month: string) {
  // 查詢當月到期且未使用的補休
  const expiredCompTimes = await db.prepare(`
    SELECT * FROM CompTimeBalances 
    WHERE expires_at = ?
      AND used = 0
  `).bind(getMonthEnd(month)).all();
  
  for (const ct of expiredCompTimes.results) {
    // 轉為加班費（按原始費率計算）
    const overtimePay = ct.hours * ct.rate * HOURLY_BASE_RATE;
    
    // 記錄到薪資表（需整合薪資模組）
    await recordOvertimePay(ct.user_id, overtimePay, month);
    
    // 標記為已過期
    await db.prepare(`
      UPDATE CompTimeBalances 
      SET expired = 1
      WHERE comp_time_id = ?
    `).bind(ct.comp_time_id).run();
  }
}
```

---

## 相關文檔

- [功能模塊 - 業務規則管理](../../功能模塊/02-業務規則管理.md)
- [UI 設計](./UI設計.md)

