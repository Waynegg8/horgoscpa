# 任務進度追蹤 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 核心業務規則

### 1. 任務狀態管理

#### 狀態定義
- **pending（待開始）**：尚未開始
- **in_progress（進行中）**：至少一個階段已開始
- **completed（已完成）**：所有階段已完成
- **overdue（逾期）**：超過預計到期日且未完成

#### 狀態計算邏輯
```typescript
function calculateTaskStatus(task: ActiveTask): string {
  // 已完成
  if (task.actual_completion_date) {
    return 'completed';
  }
  
  // 逾期
  if (task.expected_due_date && new Date(task.expected_due_date) < new Date()) {
    return 'overdue';
  }
  
  // 進行中
  if (task.actual_start_date) {
    return 'in_progress';
  }
  
  // 待開始
  return 'pending';
}
```

---

### 2. 進度計算

#### 計算方式
```typescript
function calculateTaskProgress(task: ActiveTask): number {
  const stages = await db.prepare(`
    SELECT status FROM ActiveTaskStages WHERE task_id = ?
  `).bind(task.task_id).all();
  
  if (stages.results.length === 0) {
    return 0;
  }
  
  const completedCount = stages.results.filter(s => s.status === 'completed').length;
  return Math.round((completedCount / stages.results.length) * 100);
}
```

---

### 3. 到期日計算

#### 任務到期日
```typescript
function calculateExpectedDueDate(task: ActiveTask): string {
  if (!task.actual_start_date) {
    return null;
  }
  
  const startDate = new Date(task.actual_start_date);
  startDate.setDate(startDate.getDate() + task.estimated_days);
  return startDate.toISOString().split('T')[0];
}
```

---

## CRUD 業務流程

### 查詢任務列表
```typescript
async function getTasks(userId: number, isAdmin: boolean, filters: any) {
  let sql = `
    SELECT 
      at.*,
      c.company_name as client_name,
      tt.name as template_name
    FROM ActiveTasks at
    JOIN Clients c ON at.client_id = c.client_id
    LEFT JOIN TaskTemplates tt ON at.task_template_id = tt.task_template_id
    WHERE at.is_deleted = 0
  `;
  
  // 權限過濾
  if (!isAdmin) {
    sql += ` AND at.assigned_to = ${userId}`;
  }
  
  // 狀態篩選
  if (filters.status) {
    sql += ` AND at.status = '${filters.status}'`;
  }
  
  // 客戶篩選
  if (filters.client_id) {
    sql += ` AND at.client_id = '${filters.client_id}'`;
  }
  
  // 月份篩選
  if (filters.month) {
    sql += ` AND strftime('%Y-%m', at.expected_due_date) = '${filters.month}'`;
  }
  
  sql += ' ORDER BY at.expected_due_date ASC, at.status DESC';
  
  const tasks = await db.prepare(sql).all();
  
  // 計算進度和剩餘天數
  return await Promise.all(tasks.results.map(async (task) => {
    const progress = await calculateTaskProgress(task);
    const daysRemaining = calculateDaysRemaining(task.expected_due_date);
    const overdueDays = daysRemaining < 0 ? Math.abs(daysRemaining) : null;
    
    return {
      ...task,
      progress,
      days_remaining: daysRemaining >= 0 ? daysRemaining : null,
      overdue_days: overdueDays
    };
  }));
}

function calculateDaysRemaining(dueDate: string): number {
  if (!dueDate) return null;
  
  const today = new Date();
  const due = new Date(dueDate);
  const diff = due.getTime() - today.getTime();
  return Math.ceil(diff / (1000 * 60 * 60 * 24));
}
```

### 開始任務
```typescript
async function startTask(taskId: number, userId: number) {
  const task = await db.prepare(
    'SELECT * FROM ActiveTasks WHERE task_id = ? AND is_deleted = 0'
  ).bind(taskId).first();
  
  if (!task) {
    throw new Error('任務不存在');
  }
  
  if (task.actual_start_date) {
    throw new Error('任務已開始');
  }
  
  const today = new Date().toISOString().split('T')[0];
  const dueDate = calculateExpectedDueDate({
    ...task,
    actual_start_date: today
  });
  
  await db.prepare(`
    UPDATE ActiveTasks 
    SET 
      actual_start_date = ?,
      expected_due_date = ?,
      status = 'in_progress',
      updated_at = datetime('now')
    WHERE task_id = ?
  `).bind(today, dueDate, taskId).run();
}
```

### 批量更新階段狀態
```typescript
async function batchUpdateStages(
  stageIds: number[], 
  status: string, 
  notes?: string,
  userId?: number
) {
  const completedDate = new Date().toISOString().split('T')[0];
  
  for (const stageId of stageIds) {
    await db.prepare(`
      UPDATE ActiveTaskStages 
      SET 
        status = ?,
        actual_completion_date = ?,
        notes = COALESCE(?, notes),
        updated_at = datetime('now')
      WHERE active_stage_id = ?
    `).bind(
      status,
      status === 'completed' ? completedDate : null,
      notes,
      stageId
    ).run();
    
    // 更新任務進度
    const stage = await db.prepare(
      'SELECT task_id FROM ActiveTaskStages WHERE active_stage_id = ?'
    ).bind(stageId).first();
    
    await updateTaskProgress(stage.task_id);
  }
}

async function updateTaskProgress(taskId: number) {
  const stages = await db.prepare(`
    SELECT status FROM ActiveTaskStages WHERE task_id = ?
  `).bind(taskId).all();
  
  const completedCount = stages.results.filter(s => s.status === 'completed').length;
  const progress = Math.round((completedCount / stages.results.length) * 100);
  
  // 檢查是否全部完成
  const status = progress === 100 ? 'completed' : 'in_progress';
  const completionDate = progress === 100 
    ? new Date().toISOString().split('T')[0] 
    : null;
  
  await db.prepare(`
    UPDATE ActiveTasks 
    SET 
      progress = ?,
      status = ?,
      actual_completion_date = ?,
      updated_at = datetime('now')
    WHERE task_id = ?
  `).bind(progress, status, completionDate, taskId).run();
}
```

---

## 相關文檔

- [功能模塊 - 任務進度追蹤](../../功能模塊/16-任務進度追蹤.md)
- [UI 設計](./UI設計.md)
- [測試案例](./測試案例.md)





