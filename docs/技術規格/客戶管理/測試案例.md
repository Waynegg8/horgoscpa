# 客戶管理 - 測試案例

**最後更新：** 2025年10月27日

---

## 測試案例 1：新增客戶（正常流程）

**測試目標：** 驗證完整新增客戶流程

**前置條件：**
- 管理員已登入
- 統一編號 88888888 不存在

**測試步驟：**
1. POST `/api/v1/clients` 
2. Body 包含所有必填欄位和部分選填欄位
3. 包含 2 個營業項目
4. 包含 2 個標籤

**預期結果：**
- ✅ HTTP 200
- ✅ 客戶資料成功插入
- ✅ 營業項目以 JSON 格式儲存
- ✅ 2 個標籤關聯成功建立

---

## 測試案例 2：新增客戶（統一編號重複）

**測試目標：** 驗證統一編號唯一性約束

**前置條件：**
- 統一編號 86753078 已存在

**測試步驟：**
1. POST `/api/v1/clients` 
2. client_id = '86753078'

**預期結果：**
- ✅ HTTP 409
- ✅ 錯誤代碼：DUPLICATE_CLIENT_ID
- ✅ 錯誤訊息：統一編號已存在

---

## 測試案例 3：新增客戶（統一編號格式錯誤）

**測試目標：** 驗證統一編號格式驗證

**測試步驟：**
1. POST `/api/v1/clients` 
2. client_id = '12345' （少於8位）

**預期結果：**
- ✅ HTTP 400
- ✅ 錯誤代碼：INVALID_CLIENT_ID_FORMAT

---

## 測試案例 4：查詢客戶列表（管理員）

**測試目標：** 管理員可查看所有客戶

**前置條件：**
- 管理員已登入
- 資料庫有 10 個客戶

**測試步驟：**
1. GET `/api/v1/clients`

**預期結果：**
- ✅ HTTP 200
- ✅ 返回所有 10 個客戶
- ✅ 包含標籤資料

---

## 測試案例 5：查詢客戶列表（會計師）

**測試目標：** 會計師只能查看自己負責的客戶

**前置條件：**
- 會計師（user_id=2）已登入
- 該會計師負責 3 個客戶

**測試步驟：**
1. GET `/api/v1/clients`

**預期結果：**
- ✅ HTTP 200
- ✅ 只返回 3 個客戶（自己負責的）

---

## 測試案例 6：更新客戶（有權限）

**測試目標：** 會計師可更新自己負責的客戶

**前置條件：**
- 會計師（user_id=2）已登入
- 客戶 86753078 的負責人是 user_id=2

**測試步驟：**
1. PUT `/api/v1/clients/86753078`
2. 更新電話和收款時間

**預期結果：**
- ✅ HTTP 200
- ✅ 資料成功更新
- ✅ updated_at 時間更新

---

## 測試案例 7：更新客戶（無權限）

**測試目標：** 會計師不能更新他人負責的客戶

**前置條件：**
- 會計師（user_id=2）已登入
- 客戶 86753078 的負責人是 user_id=1

**測試步驟：**
1. PUT `/api/v1/clients/86753078`

**預期結果：**
- ✅ HTTP 403
- ✅ 錯誤代碼：PERMISSION_DENIED

---

## 測試案例 8：更新客戶標籤

**測試目標：** 驗證標籤更新（替換所有標籤）

**前置條件：**
- 客戶原本有標籤 [1, 2]

**測試步驟：**
1. PUT `/api/v1/clients/86753078`
2. tag_ids = [3, 4]

**預期結果：**
- ✅ 舊標籤關聯被刪除
- ✅ 新標籤關聯被建立
- ✅ 最終客戶有標籤 [3, 4]

---

## 測試案例 9：刪除客戶

**測試目標：** 管理員可刪除客戶（軟刪除）

**前置條件：**
- 管理員已登入
- 客戶 86753078 存在

**測試步驟：**
1. DELETE `/api/v1/clients/86753078`

**預期結果：**
- ✅ HTTP 200
- ✅ is_deleted = 1
- ✅ deleted_at 有值
- ✅ deleted_by = 管理員 ID
- ✅ ClientTagAssignments 被刪除
- ✅ 客戶在列表中不顯示

---

## 測試案例 10：標籤管理（新增重複名稱）

**測試目標：** 標籤名稱唯一性約束

**前置條件：**
- 標籤「VIP客戶」已存在

**測試步驟：**
1. POST `/api/v1/customer-tags`
2. tag_name = 'VIP客戶'

**預期結果：**
- ✅ HTTP 409
- ✅ 錯誤代碼：DUPLICATE_TAG_NAME

---

## 測試案例 11：標籤指派（重複指派）

**測試目標：** 客戶-標籤唯一性約束

**前置條件：**
- 客戶 86753078 已有標籤 1

**測試步驟：**
1. POST `/api/v1/clients/86753078/tags`
2. tag_id = 1

**預期結果：**
- ✅ HTTP 409
- ✅ 錯誤代碼：TAG_ALREADY_ASSIGNED

---

## 測試案例 12：查詢客戶詳情

**測試目標：** 完整顯示客戶資料

**測試步驟：**
1. GET `/api/v1/clients/86753078`

**預期結果：**
- ✅ 包含所有基本資料
- ✅ 營業項目 JSON 已解析為陣列
- ✅ 包含所有標籤（含顏色）
- ✅ 包含負責員工姓名

---

## 測試案例 13：標籤篩選

**測試目標：** 按標籤篩選客戶

**前置條件：**
- 3 個客戶有「VIP客戶」標籤（tag_id=1）

**測試步驟：**
1. GET `/api/v1/clients?tag_ids=1`

**預期結果：**
- ✅ 只返回這 3 個客戶

---

## 測試案例 14：營業項目驗證

**測試目標：** 驗證營業項目格式

**測試步驟：**
1. POST `/api/v1/clients`
2. registered_business_items = [{"name": "測試"}] （缺少 code）

**預期結果：**
- ✅ HTTP 400
- ✅ 錯誤訊息：每個營業項目必須包含名稱和代碼

---

## 測試案例 15：批次指派標籤

**測試目標：** 一次指派多個標籤

**測試步驟：**
1. POST `/api/v1/clients/86753078/tags/batch`
2. tag_ids = [1, 2, 3]

**預期結果：**
- ✅ HTTP 200
- ✅ 3 個標籤關聯成功建立
- ✅ added_count = 3

---

**相關文檔：**
- [業務邏輯](./業務邏輯.md)
- [驗證規則](./驗證規則.md)


