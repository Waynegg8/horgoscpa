# 標籤系統設計

**最後更新：** 2025年10月27日

---

## 系統架構

### 三表設計

```
CustomerTags (標籤主表)
  ├─ tag_id (PK)
  ├─ tag_name (UNIQUE)
  ├─ tag_color
  └─ sort_order

ClientTagAssignments (關聯表)
  ├─ assignment_id (PK)
  ├─ client_id (FK → Clients)
  ├─ tag_id (FK → CustomerTags)
  └─ UNIQUE(client_id, tag_id)

Clients (客戶主表)
  └─ client_id (PK)
```

---

## 預設標籤

系統初始化時自動創建：

```sql
INSERT INTO CustomerTags (tag_name, tag_color, sort_order) VALUES
  ('VIP客戶', '#FF5733', 1),
  ('重點客戶', '#FFC300', 2),
  ('潛在客戶', '#DAF7A6', 3),
  ('長期合作', '#33A1FF', 4),
  ('新客戶', '#C70039', 5),
  ('需關注', '#FF33F6', 6);
```

---

## 標籤管理功能

### 權限控制

| 功能 | 管理員 | 會計師 | 助理 |
|-----|--------|--------|------|
| 查看標籤列表 | ✅ | ✅ | ✅ |
| 新增標籤 | ✅ | ❌ | ❌ |
| 編輯標籤 | ✅ | ❌ | ❌ |
| 刪除標籤 | ✅ | ❌ | ❌ |
| 為客戶指派標籤 | ✅ | ✅ | ✅ |
| 移除客戶標籤 | ✅ | ✅ | ✅ |

---

## 標籤指派規則

### 唯一性約束

```sql
UNIQUE(client_id, tag_id)
```

- 同一客戶不能重複指派同一標籤
- 嘗試重複指派會返回 409 錯誤

### 級聯刪除

```sql
ON DELETE CASCADE
```

- 刪除客戶時，自動移除所有標籤關聯
- 刪除標籤時，自動移除所有客戶關聯

---

## 標籤使用統計

### 查詢標籤使用次數

```sql
SELECT 
  ct.tag_id,
  ct.tag_name,
  COUNT(cta.assignment_id) as usage_count
FROM CustomerTags ct
LEFT JOIN ClientTagAssignments cta ON ct.tag_id = cta.tag_id
WHERE ct.is_deleted = 0
GROUP BY ct.tag_id
ORDER BY usage_count DESC;
```

---

## 前端顯示

### 標籤顏色

```html
<span 
  class="tag" 
  :style="{ backgroundColor: tag.tag_color }">
  {{ tag.tag_name }}
</span>
```

### 標籤選擇器

```html
<div class="tag-selector">
  <div v-for="tag in selectedTags" :key="tag.tag_id">
    <span :style="{ background: tag.tag_color }">
      {{ tag.tag_name }}
      <button @click="removeTag(tag.tag_id)">×</button>
    </span>
  </div>
  <button @click="showTagModal = true">+ 新增標籤</button>
</div>
```

---

**相關文檔：**
- [CustomerTags 資料表](../../資料庫設計/核心業務/CustomerTags.md)
- [ClientTagAssignments 資料表](../../資料庫設計/核心業務/ClientTagAssignments.md)


