# 客戶管理 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 新增客戶流程

### 流程圖

```
開始
  ↓
驗證資料（統一編號格式、必填欄位）
  ↓
檢查統一編號是否重複
  ↓
驗證負責員工是否存在
  ↓
驗證標籤是否存在
  ↓
插入 Clients 表
  ↓
批次插入標籤關聯（如有）
  ↓
記錄操作日誌
  ↓
返回成功
```

### 關鍵邏輯

#### 1. 統一編號重複檢查
```javascript
const existing = await db.get(
  'SELECT client_id FROM Clients WHERE client_id = ? AND is_deleted = 0',
  [clientId]
);
if (existing) {
  throw new ConflictError('統一編號已存在');
}
```

#### 2. 營業項目處理
```javascript
if (data.registered_business_items) {
  // 前端傳入陣列，後端轉為JSON字串儲存
  data.registered_business_items = JSON.stringify(
    data.registered_business_items
  );
}
```

---

## 更新客戶流程

### 權限檢查

```javascript
// 非管理員只能編輯自己負責的客戶
if (user.role_id !== ROLE_ADMIN && client.assignee_user_id !== userId) {
  throw new ForbiddenError('無權限編輯此客戶');
}
```

### 標籤更新邏輯

```javascript
// 如果有傳 tag_ids，先刪除舊標籤再新增
if (updateData.tag_ids !== undefined) {
  await db.run('DELETE FROM ClientTagAssignments WHERE client_id = ?', [clientId]);
  
  if (updateData.tag_ids.length > 0) {
    for (const tagId of updateData.tag_ids) {
      await db.run(
        'INSERT INTO ClientTagAssignments (client_id, tag_id, assigned_by) VALUES (?, ?, ?)',
        [clientId, tagId, userId]
      );
    }
  }
}
```

---

## 刪除客戶流程

### 軟刪除

```javascript
await db.run(`
  UPDATE Clients 
  SET 
    is_deleted = 1,
    deleted_at = datetime('now'),
    deleted_by = ?
  WHERE client_id = ?
`, [userId, clientId]);
```

### 級聯處理

- ✅ ClientTagAssignments 自動刪除（ON DELETE CASCADE）
- ❌ Tasks 不刪除（保留歷史記錄）
- ❌ TimeLogs 不刪除（保留歷史記錄）
- ❌ ClientServices 不刪除（標記為停用）

---

## 查詢客戶列表

### 權限過濾

```javascript
// 非管理員只能看自己負責的客戶
if (user.role_id !== ROLE_ADMIN) {
  whereConditions.push('c.assignee_user_id = ?');
  params.push(userId);
}
```

### 標籤篩選

```javascript
// 支援多標籤篩選（AND邏輯）
if (filters.tag_ids && filters.tag_ids.length > 0) {
  const tagJoin = `
    INNER JOIN ClientTagAssignments cta ON c.client_id = cta.client_id
    INNER JOIN CustomerTags ct ON cta.tag_id = ct.tag_id AND ct.is_deleted = 0
  `;
  whereConditions.push(`cta.tag_id IN (${filters.tag_ids.map(() => '?').join(',')})`);
  params.push(...filters.tag_ids);
}
```

---

## 標籤管理

### 新增標籤

```javascript
// 檢查名稱唯一性
const existing = await db.get(
  'SELECT tag_id FROM CustomerTags WHERE tag_name = ? AND is_deleted = 0',
  [tagName]
);
if (existing) {
  throw new ConflictError('標籤名稱已存在');
}
```

### 刪除標籤

```javascript
// 軟刪除
await db.run(`
  UPDATE CustomerTags 
  SET is_deleted = 1, deleted_at = datetime('now'), deleted_by = ?
  WHERE tag_id = ?
`, [userId, tagId]);

// 移除所有客戶關聯（自動觸發，ON DELETE CASCADE）
```

---

## 批次操作

### 批次指派標籤

```javascript
for (const tagId of tagIds) {
  try {
    await db.run(
      'INSERT INTO ClientTagAssignments (client_id, tag_id, assigned_by) VALUES (?, ?, ?)',
      [clientId, tagId, userId]
    );
  } catch (e) {
    // 忽略重複錯誤（UNIQUE constraint）
    if (!e.message.includes('UNIQUE constraint')) {
      throw e;
    }
  }
}
```

---

**相關文檔：**
- [驗證規則](./驗證規則.md)
- [客戶 CRUD API](../../API規格/客戶管理/客戶CRUD.md)


