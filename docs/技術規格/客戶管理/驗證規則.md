# 客戶管理 - 資料驗證規則

**最後更新：** 2025年10月27日

---

## 前端驗證

### 統一編號
```javascript
{
  required: true,
  pattern: /^\d{8}$/,
  message: "統一編號必須是8位數字"
}
```

### 公司名稱
```javascript
{
  required: true,
  minLength: 2,
  maxLength: 200,
  message: "公司名稱為必填，長度2-200字元"
}
```

### Email
```javascript
{
  required: false,
  pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
  message: "Email 格式不正確"
}
```

### 設立日期
```javascript
{
  required: false,
  pattern: /^\d{7}$/,  // YYYMMDD
  message: "設立日期格式：YYYMMDD（7位數字）"
}
```

### 資本額
```javascript
{
  required: false,
  type: "number",
  min: 0,
  message: "資本額必須大於等於0"
}
```

### 營業項目
```javascript
function validateBusinessItems(items) {
  if (!items || !Array.isArray(items)) {
    return "營業項目格式錯誤";
  }
  
  for (const item of items) {
    if (!item.name || !item.code) {
      return "每個營業項目必須包含名稱和代碼";
    }
    if (item.name.length > 200) {
      return "營業項目名稱不可超過200字元";
    }
    if (item.code.length > 20) {
      return "營業項目代碼不可超過20字元";
    }
  }
  
  return null;
}
```

---

## 後端驗證

### 統一編號重複檢查
```javascript
async function checkDuplicateClientId(clientId, excludeId = null) {
  const query = excludeId
    ? 'SELECT client_id FROM Clients WHERE client_id = ? AND client_id != ? AND is_deleted = 0'
    : 'SELECT client_id FROM Clients WHERE client_id = ? AND is_deleted = 0';
  
  const params = excludeId ? [clientId, excludeId] : [clientId];
  const existing = await db.get(query, params);
  
  if (existing) {
    throw new Error('統一編號已存在');
  }
}
```

### 負責員工存在檢查
```javascript
async function validateAssignee(userId) {
  const user = await db.get(
    'SELECT user_id FROM Users WHERE user_id = ? AND is_deleted = 0',
    [userId]
  );
  
  if (!user) {
    throw new Error('負責員工不存在');
  }
}
```

### 標籤存在檢查
```javascript
async function validateTags(tagIds) {
  if (!tagIds || tagIds.length === 0) return;
  
  const placeholders = tagIds.map(() => '?').join(',');
  const tags = await db.all(
    `SELECT tag_id FROM CustomerTags 
     WHERE tag_id IN (${placeholders}) AND is_deleted = 0`,
    tagIds
  );
  
  if (tags.length !== tagIds.length) {
    throw new Error('部分標籤不存在');
  }
}
```

---

## 完整驗證流程

### 新增客戶
```javascript
async function validateCreateClient(data, userId) {
  // 1. 必填欄位檢查
  if (!data.client_id || !data.company_name || !data.assignee_user_id) {
    throw new ValidationError('缺少必填欄位');
  }
  
  // 2. 格式驗證
  if (!/^\d{8}$/.test(data.client_id)) {
    throw new ValidationError('統一編號格式錯誤');
  }
  
  if (data.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
    throw new ValidationError('Email 格式不正確');
  }
  
  // 3. 營業項目驗證
  if (data.registered_business_items) {
    const error = validateBusinessItems(
      JSON.parse(data.registered_business_items)
    );
    if (error) throw new ValidationError(error);
  }
  
  // 4. 重複檢查
  await checkDuplicateClientId(data.client_id);
  
  // 5. 關聯資料檢查
  await validateAssignee(data.assignee_user_id);
  
  if (data.tag_ids) {
    await validateTags(data.tag_ids);
  }
}
```

### 更新客戶
```javascript
async function validateUpdateClient(clientId, data, userId) {
  // 1. 客戶存在檢查
  const client = await db.get(
    'SELECT * FROM Clients WHERE client_id = ? AND is_deleted = 0',
    [clientId]
  );
  if (!client) {
    throw new NotFoundError('客戶不存在');
  }
  
  // 2. 權限檢查
  const user = await getUserById(userId);
  if (user.role_id !== ROLE_ADMIN && client.assignee_user_id !== userId) {
    throw new ForbiddenError('無權限編輯此客戶');
  }
  
  // 3. 格式驗證（與新增相同）
  if (data.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
    throw new ValidationError('Email 格式不正確');
  }
  
  // 4. 營業項目驗證
  if (data.registered_business_items) {
    const error = validateBusinessItems(
      JSON.parse(data.registered_business_items)
    );
    if (error) throw new ValidationError(error);
  }
  
  // 5. 關聯資料檢查
  if (data.assignee_user_id) {
    await validateAssignee(data.assignee_user_id);
  }
  
  if (data.tag_ids !== undefined) {
    await validateTags(data.tag_ids);
  }
}
```

---

## 錯誤訊息標準

### 前端錯誤訊息
```javascript
const ERROR_MESSAGES = {
  REQUIRED_FIELD: '此為必填欄位',
  INVALID_FORMAT: '格式不正確',
  INVALID_CLIENT_ID: '統一編號必須是8位數字',
  INVALID_EMAIL: 'Email 格式不正確',
  INVALID_DATE: '日期格式錯誤',
  MIN_VALUE: '數值必須大於等於 {min}',
  MAX_LENGTH: '字數不可超過 {max} 字元'
};
```

### 後端錯誤代碼
```javascript
const CLIENT_ERRORS = {
  DUPLICATE_CLIENT_ID: {
    code: 'DUPLICATE_CLIENT_ID',
    message: '統一編號已存在',
    status: 409
  },
  INVALID_CLIENT_ID_FORMAT: {
    code: 'INVALID_CLIENT_ID_FORMAT',
    message: '統一編號格式錯誤（必須是8位數字）',
    status: 400
  },
  CLIENT_NOT_FOUND: {
    code: 'CLIENT_NOT_FOUND',
    message: '客戶不存在',
    status: 404
  },
  PERMISSION_DENIED: {
    code: 'PERMISSION_DENIED',
    message: '無權限執行此操作',
    status: 403
  }
};
```

---

**相關文檔：**
- [客戶表單 UI](./客戶表單UI.md)
- [業務邏輯](./業務邏輯.md)





