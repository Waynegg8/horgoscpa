# 生活事件登記 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 事件登記與假期給予

```typescript
async function registerLeaveEvent(
  userId: number,
  eventType: string,
  eventDate: string,
  notes?: string
) {
  // 1. 根據事件類型計算給予的假期時數
  const grantedHours = calculateGrantedHours(eventType);
  
  // 2. 登記事件
  const result = await db.prepare(`
    INSERT INTO LeaveEvents (
      user_id, event_type, event_date, granted_hours, notes
    ) VALUES (?, ?, ?, ?, ?)
  `).bind(userId, eventType, eventDate, grantedHours, notes || null).run();
  
  const eventId = result.meta.last_row_id;
  
  // 3. 更新假期餘額
  await updateLeaveBalance(userId, eventType, grantedHours);
  
  return { eventId, grantedHours };
}
```

---

## 假期時數計算

```typescript
function calculateGrantedHours(eventType: string): number {
  const eventHours = {
    '結婚': 8 * 8,          // 8天 = 64小時
    '喪假-父母': 3 * 8,     // 3天 = 24小時
    '喪假-配偶': 3 * 8,
    '喪假-子女': 3 * 8,
    '產假': 8 * 7 * 8,      // 8週 = 56天 = 448小時
    '陪產假': 7 * 8         // 7天 = 56小時
  };
  
  return eventHours[eventType] || 0;
}
```

---

## 更新假期餘額

```typescript
async function updateLeaveBalance(
  userId: number,
  eventType: string,
  hours: number
) {
  const currentYear = new Date().getFullYear();
  
  // 找到對應的假別ID
  const leaveTypeMap = {
    '結婚': 3,          // 婚假
    '喪假-父母': 4,     // 喪假
    '喪假-配偶': 4,
    '喪假-子女': 4,
    '產假': 5,          // 產假
    '陪產假': 6         // 陪產假
  };
  
  const leaveTypeId = leaveTypeMap[eventType];
  
  if (!leaveTypeId) return;
  
  // 新增或更新餘額
  await db.prepare(`
    INSERT INTO LeaveBalances (user_id, leave_type_id, balance, year)
    VALUES (?, ?, ?, ?)
    ON CONFLICT(user_id, leave_type_id, year) 
    DO UPDATE SET balance = balance + ?
  `).bind(userId, leaveTypeId, hours, currentYear, hours).run();
}
```

---

## 相關文檔

- [功能模塊 - 生活事件登記](../../功能模塊/12-生活事件登記.md)
- [UI 設計](./UI設計.md)


