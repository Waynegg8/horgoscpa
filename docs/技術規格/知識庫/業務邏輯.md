# 通用知識庫 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 創建知識文章

```typescript
async function createKnowledgeArticle(
  userId: number,
  input: CreateArticleInput
) {
  // 1. 權限檢查
  const user = await getUser(userId);
  if (user.role !== 'admin') {
    throw new Error('無權限操作');
  }
  
  // 2. 插入資料
  const result = await db.prepare(`
    INSERT INTO KnowledgeArticles (
      title, content, category, tags, is_pinned, created_by
    ) VALUES (?, ?, ?, ?, ?, ?)
  `).bind(
    input.title,
    input.content,
    input.category || null,
    JSON.stringify(input.tags || []),
    input.is_pinned ? 1 : 0,
    userId
  ).run();
  
  return { article_id: result.meta.last_row_id };
}
```

---

## 查詢知識文章列表

```typescript
async function getKnowledgeArticles(filters: {
  category?: string;
  search?: string;
  pinned_only?: boolean;
}) {
  let sql = `
    SELECT 
      ka.*,
      u.name as author_name
    FROM KnowledgeArticles ka
    JOIN Users u ON ka.created_by = u.user_id
    WHERE ka.is_deleted = 0
  `;
  
  const params = [];
  
  if (filters.category) {
    sql += ' AND ka.category = ?';
    params.push(filters.category);
  }
  
  if (filters.pinned_only) {
    sql += ' AND ka.is_pinned = 1';
  }
  
  if (filters.search) {
    sql += ' AND (ka.title LIKE ? OR ka.content LIKE ?)';
    const searchTerm = `%${filters.search}%`;
    params.push(searchTerm, searchTerm);
  }
  
  sql += ' ORDER BY ka.is_pinned DESC, ka.created_at DESC';
  
  const result = await db.prepare(sql).bind(...params).all();
  return result.results;
}
```

---

## 查看文章（增加瀏覽計數）

```typescript
async function viewArticle(articleId: number) {
  // 1. 查詢文章
  const article = await db.prepare(`
    SELECT 
      ka.*,
      u.name as author_name
    FROM KnowledgeArticles ka
    JOIN Users u ON ka.created_by = u.user_id
    WHERE ka.article_id = ? AND ka.is_deleted = 0
  `).bind(articleId).first();
  
  if (!article) {
    throw new Error('文章不存在');
  }
  
  // 2. 增加瀏覽次數
  await db.prepare(`
    UPDATE KnowledgeArticles 
    SET view_count = view_count + 1
    WHERE article_id = ?
  `).bind(articleId).run();
  
  return article;
}
```

---

## 置頂/取消置頂

```typescript
async function togglePinArticle(
  userId: number,
  articleId: number,
  isPinned: boolean
) {
  // 1. 權限檢查
  const user = await getUser(userId);
  if (user.role !== 'admin') {
    throw new Error('無權限操作');
  }
  
  // 2. 更新置頂狀態
  await db.prepare(`
    UPDATE KnowledgeArticles 
    SET is_pinned = ?, updated_at = datetime('now')
    WHERE article_id = ?
  `).bind(isPinned ? 1 : 0, articleId).run();
  
  return { success: true };
}
```

---

## 相關文檔

- [功能模塊 - 通用知識庫](../../功能模塊/20-通用知識庫.md)
- [UI 設計](./UI設計.md)

