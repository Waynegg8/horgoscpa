# CSV導入功能 - 業務邏輯

**最後更新：** 2025年10月27日

---

## CSV 解析與驗證

```typescript
import Papa from 'papaparse';

async function parseCSV(file: File, type: string) {
  return new Promise((resolve, reject) => {
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        const validation = validateData(results.data, type);
        resolve({
          data: results.data,
          validation
        });
      },
      error: (error) => {
        reject(new Error(`CSV 解析失敗：${error.message}`));
      }
    });
  });
}
```

---

## 資料驗證規則

```typescript
function validateData(rows: any[], type: string) {
  const errors = [];
  let validCount = 0;
  
  rows.forEach((row, index) => {
    const rowNumber = index + 2; // +2 因為有標題列且從1開始
    const rowErrors = [];
    
    switch (type) {
      case 'clients':
        rowErrors.push(...validateClientRow(row, rowNumber));
        break;
      case 'services':
        rowErrors.push(...validateServiceRow(row, rowNumber));
        break;
      case 'employees':
        rowErrors.push(...validateEmployeeRow(row, rowNumber));
        break;
    }
    
    if (rowErrors.length === 0) {
      validCount++;
    } else {
      errors.push(...rowErrors);
    }
  });
  
  return {
    total: rows.length,
    valid: validCount,
    invalid: errors.length,
    errors
  };
}
```

---

## 客戶資料驗證

```typescript
function validateClientRow(row: any, rowNumber: number) {
  const errors = [];
  
  // 必填欄位
  if (!row.tax_registration_number) {
    errors.push({
      row: rowNumber,
      field: 'tax_registration_number',
      message: '統一編號不可為空'
    });
  } else if (!/^\d{8}$/.test(row.tax_registration_number)) {
    errors.push({
      row: rowNumber,
      field: 'tax_registration_number',
      message: '統一編號格式錯誤（應為8位數字）'
    });
  }
  
  if (!row.name) {
    errors.push({
      row: rowNumber,
      field: 'name',
      message: '公司名稱不可為空'
    });
  }
  
  // Email 格式驗證
  if (row.contact_email && !isValidEmail(row.contact_email)) {
    errors.push({
      row: rowNumber,
      field: 'contact_email',
      message: 'Email 格式錯誤'
    });
  }
  
  return errors;
}
```

---

## 批量導入

```typescript
async function batchImport(
  userId: number,
  data: any[],
  type: string
) {
  // 1. 權限檢查
  const user = await getUser(userId);
  if (user.role !== 'admin') {
    throw new Error('無權限操作');
  }
  
  // 2. 開始事務
  let successCount = 0;
  let failCount = 0;
  const errors = [];
  
  for (const [index, row] of data.entries()) {
    try {
      switch (type) {
        case 'clients':
          await importClientRow(row, userId);
          break;
        case 'services':
          await importServiceRow(row, userId);
          break;
        case 'employees':
          await importEmployeeRow(row, userId);
          break;
      }
      successCount++;
    } catch (error) {
      failCount++;
      errors.push({
        row: index + 2,
        data: row,
        error: error.message
      });
    }
  }
  
  return {
    success: successCount,
    failed: failCount,
    errors
  };
}
```

---

## 導入單筆客戶資料

```typescript
async function importClientRow(row: any, userId: number) {
  // 檢查是否已存在
  const existing = await db.prepare(
    'SELECT * FROM Clients WHERE tax_registration_number = ?'
  ).bind(row.tax_registration_number).first();
  
  if (existing) {
    // 更新
    await db.prepare(`
      UPDATE Clients SET
        name = ?,
        contact_person = ?,
        contact_phone = ?,
        contact_email = ?,
        updated_at = datetime('now')
      WHERE tax_registration_number = ?
    `).bind(
      row.name,
      row.contact_person || null,
      row.contact_phone || null,
      row.contact_email || null,
      row.tax_registration_number
    ).run();
  } else {
    // 新增
    await db.prepare(`
      INSERT INTO Clients (
        tax_registration_number, name, contact_person,
        contact_phone, contact_email, created_by
      ) VALUES (?, ?, ?, ?, ?, ?)
    `).bind(
      row.tax_registration_number,
      row.name,
      row.contact_person || null,
      row.contact_phone || null,
      row.contact_email || null,
      userId
    ).run();
  }
}
```

---

## 相關文檔

- [功能模塊 - CSV導入功能](../../功能模塊/05-CSV導入功能.md)
- [UI 設計](./UI設計.md)

