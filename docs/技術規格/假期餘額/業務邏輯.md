# 假期餘額查詢 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 查詢員工假期餘額

```typescript
async function getLeaveBalances(userId: number, year: number) {
  const balances = await db.prepare(`
    SELECT 
      lb.*,
      lt.leave_type_name
    FROM LeaveBalances lb
    JOIN LeaveTypes lt ON lb.leave_type_id = lt.leave_type_id
    WHERE lb.user_id = ? AND lb.year = ?
    ORDER BY lt.sort_order
  `).bind(userId, year).all();
  
  return balances.results;
}
```

---

## 扣除餘額

```typescript
async function deductLeaveBalance(
  userId: number,
  leaveTypeId: number,
  hours: number,
  year: number
) {
  await db.prepare(`
    UPDATE LeaveBalances 
    SET 
      balance = balance - ?,
      used = used + ?,
      updated_at = datetime('now')
    WHERE user_id = ? AND leave_type_id = ? AND year = ?
  `).bind(hours, hours, userId, leaveTypeId, year).run();
}
```


