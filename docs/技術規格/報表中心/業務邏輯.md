# 報表中心 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 員工工時統計（詳細版）

```typescript
async function generateEmployeeTimesheetReport(
  userId: number,
  month: string
) {
  // 查詢該員工該月的所有工時記錄
  const logs = await db.prepare(`
    SELECT 
      business_type,
      work_type,
      SUM(hours) as total_hours,
      SUM(weighted_hours) as total_weighted_hours
    FROM TimeLogs
    WHERE user_id = ?
      AND strftime('%Y-%m', work_date) = ?
      AND is_deleted = 0
      AND leave_type IS NULL
    GROUP BY business_type, work_type
    ORDER BY business_type, work_type
  `).bind(userId, month).all();
  
  // 按業務類型分組
  const byBusinessType = {};
  
  for (const log of logs.results) {
    if (!byBusinessType[log.business_type]) {
      byBusinessType[log.business_type] = {
        breakdown: [],
        subtotal: { hours: 0, weighted_hours: 0 }
      };
    }
    
    // 計算倍率
    const rate = log.total_weighted_hours / log.total_hours;
    
    byBusinessType[log.business_type].breakdown.push({
      work_type: log.work_type,
      hours: log.total_hours,
      weighted_hours: log.total_weighted_hours,
      rate
    });
    
    byBusinessType[log.business_type].subtotal.hours += log.total_hours;
    byBusinessType[log.business_type].subtotal.weighted_hours += log.total_weighted_hours;
  }
  
  // 計算總計
  let totalHours = 0;
  let totalWeightedHours = 0;
  
  for (const bt of Object.values(byBusinessType)) {
    totalHours += bt.subtotal.hours;
    totalWeightedHours += bt.subtotal.weighted_hours;
  }
  
  return {
    employee: await getUser(userId),
    month,
    by_business_type: byBusinessType,
    total: {
      hours: totalHours,
      weighted_hours: totalWeightedHours,
      weighted_ratio: (totalWeightedHours / totalHours) * 100
    }
  };
}
```

---

## 客戶服務分析

```typescript
async function generateClientAnalysisReport(month: string) {
  // 查詢該月各客戶的工時投入
  const clientHours = await db.prepare(`
    SELECT 
      t.client_id,
      c.name as client_name,
      t.business_type as service_type,
      SUM(t.hours) as total_hours,
      SUM(t.weighted_hours) as total_weighted_hours
    FROM TimeLogs t
    JOIN Clients c ON t.client_id = c.tax_registration_number
    WHERE strftime('%Y-%m', t.work_date) = ?
      AND t.is_deleted = 0
    GROUP BY t.client_id, t.business_type
  `).bind(month).all();
  
  // 查詢客戶服務收費（從 ClientServices 表）
  const clientFees = await db.prepare(`
    SELECT 
      client_id,
      service_id,
      monthly_fee
    FROM ClientServices
    WHERE is_active = 1
  `).all();
  
  // 建立收費映射
  const feeMap = {};
  for (const cs of clientFees.results) {
    feeMap[cs.client_id] = cs.monthly_fee;
  }
  
  // 計算效益比（假設時薪為 500）
  const hourlyRate = 500;
  const results = [];
  
  for (const ch of clientHours.results) {
    const fee = feeMap[ch.client_id] || 0;
    const costEstimate = ch.total_weighted_hours * hourlyRate;
    const efficiencyRatio = costEstimate > 0 ? fee / costEstimate : 0;
    
    results.push({
      client_id: ch.client_id,
      client_name: ch.client_name,
      service_type: ch.service_type,
      hours: ch.total_hours,
      weighted_hours: ch.total_weighted_hours,
      fee,
      cost_estimate: costEstimate,
      efficiency_ratio: efficiencyRatio
    });
  }
  
  // 按效益比排序
  results.sort((a, b) => b.efficiency_ratio - a.efficiency_ratio);
  
  return {
    month,
    hourly_rate: hourlyRate,
    clients: results
  };
}
```

---

## 業務類型分佈

```typescript
async function generateBusinessDistributionReport(period: string) {
  // 查詢業務類型分佈
  const distribution = await db.prepare(`
    SELECT 
      business_type,
      SUM(hours) as total_hours,
      SUM(weighted_hours) as total_weighted_hours
    FROM TimeLogs
    WHERE strftime('%Y-%m', work_date) = ?
      AND is_deleted = 0
    GROUP BY business_type
    ORDER BY total_weighted_hours DESC
  `).bind(period).all();
  
  // 計算百分比
  const totalWeightedHours = distribution.results.reduce(
    (sum, item) => sum + item.total_weighted_hours, 
    0
  );
  
  const results = distribution.results.map(item => ({
    business_type: item.business_type,
    hours: item.total_hours,
    weighted_hours: item.total_weighted_hours,
    percentage: (item.total_weighted_hours / totalWeightedHours) * 100
  }));
  
  return {
    period,
    distribution: results,
    total: totalWeightedHours
  };
}
```

---

## 匯出 Excel

```typescript
import ExcelJS from 'exceljs';

async function exportReportToExcel(reportData: any, reportType: string) {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('報表');
  
  switch (reportType) {
    case 'employee_timesheet':
      generateEmployeeTimesheetExcel(worksheet, reportData);
      break;
    case 'client_analysis':
      generateClientAnalysisExcel(worksheet, reportData);
      break;
  }
  
  // 生成 Buffer
  const buffer = await workbook.xlsx.writeBuffer();
  return buffer;
}

function generateEmployeeTimesheetExcel(ws, data) {
  // 標題行
  ws.addRow([`員工工時統計報表 - ${data.month} - ${data.employee.name}`]);
  ws.addRow([]);
  
  // 業務類型明細
  for (const [businessType, businessData] of Object.entries(data.by_business_type)) {
    ws.addRow([businessType]);
    ws.addRow(['工時類型', '原始工時', '倍率', '加權工時']);
    
    for (const item of businessData.breakdown) {
      ws.addRow([
        item.work_type,
        item.hours,
        item.rate,
        item.weighted_hours
      ]);
    }
    
    ws.addRow(['業務小計', businessData.subtotal.hours, '', businessData.subtotal.weighted_hours]);
    ws.addRow([]);
  }
  
  // 總計
  ws.addRow(['總計']);
  ws.addRow(['原始工時總計', data.total.hours]);
  ws.addRow(['加權工時總計', data.total.weighted_hours]);
  ws.addRow(['加權比例', `${data.total.weighted_ratio}%`]);
}
```

---

## 相關文檔

- [功能模塊 - 報表中心](../../功能模塊/10-報表中心.md)
- [UI 設計](./UI設計.md)

