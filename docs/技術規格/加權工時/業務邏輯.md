# 加權工時計算 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 加權工時計算邏輯

```typescript
async function calculateWeightedHours(
  hours: number,
  workTypeId: number,
  workDate: string
): Promise<number> {
  // 1. 查詢工時類型的加權比率
  const workType = await db.prepare(
    'SELECT multiplier FROM WorkTypes WHERE work_type_id = ?'
  ).bind(workTypeId).first();
  
  if (!workType) {
    throw new Error('工時類型不存在');
  }
  
  // 2. 基本加權
  let weighted = hours * workType.multiplier;
  
  // 3. 檢查是否為國定假日（額外加成）
  const isNationalHoliday = await db.prepare(`
    SELECT COUNT(*) as count 
    FROM NationalHolidays 
    WHERE holiday_date = ? AND is_active = 1
  `).bind(workDate).first();
  
  if (isNationalHoliday.count > 0) {
    // 國定假日額外 1.5 倍
    weighted *= 1.5;
  }
  
  return Math.round(weighted * 100) / 100; // 保留2位小數
}
```

---

## 範例計算

### 正常工時
```
工時類型：正常工時（倍數 1.0）
實際工時：8 小時
加權工時：8 × 1.0 = 8 小時
```

### 平日加班
```
工時類型：平日加班（倍數 1.34）
實際工時：2 小時
加權工時：2 × 1.34 = 2.68 小時
```

### 假日加班
```
工時類型：假日加班（倍數 1.67）
實際工時：4 小時
加權工時：4 × 1.67 = 6.68 小時
```

### 國定假日加班（額外加成）
```
工時類型：正常工時（倍數 1.0）
實際工時：8 小時
國定假日加成：× 1.5
加權工時：8 × 1.0 × 1.5 = 12 小時
```

---

## 相關文檔

- [功能模塊 - 加權工時計算](../../功能模塊/09-加權工時計算.md)
- [WorkTypes 資料表](../../資料庫設計/業務規則/WorkTypes.md)





