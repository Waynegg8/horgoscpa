# 資源中心管理 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 上傳檔案資源

```typescript
async function uploadFileResource(
  userId: number,
  file: File,
  metadata: ResourceMetadata
) {
  // 1. 權限檢查
  const user = await getUser(userId);
  if (user.role !== 'admin') {
    throw new Error('無權限操作');
  }
  
  // 2. 檔案大小限制（例如：50MB）
  const MAX_FILE_SIZE = 50 * 1024 * 1024;
  if (file.size > MAX_FILE_SIZE) {
    throw new Error('檔案大小超過限制（50MB）');
  }
  
  // 3. 上傳檔案到 Cloudflare R2 或其他儲存服務
  const fileUrl = await uploadToStorage(file);
  
  // 4. 取得檔案資訊
  const fileExtension = file.name.split('.').pop();
  
  // 5. 插入資料
  const result = await db.prepare(`
    INSERT INTO ResourceCenter (
      title, description, resource_type, file_url,
      file_size, file_extension, category, tags, created_by
    ) VALUES (?, ?, 'file', ?, ?, ?, ?, ?, ?)
  `).bind(
    metadata.title,
    metadata.description || null,
    fileUrl,
    file.size,
    fileExtension,
    metadata.category || null,
    JSON.stringify(metadata.tags || []),
    userId
  ).run();
  
  return { resource_id: result.meta.last_row_id };
}
```

---

## 新增連結資源

```typescript
async function createLinkResource(
  userId: number,
  input: CreateLinkResourceInput
) {
  // 1. 權限檢查
  const user = await getUser(userId);
  if (user.role !== 'admin') {
    throw new Error('無權限操作');
  }
  
  // 2. 驗證 URL
  try {
    new URL(input.external_url);
  } catch {
    throw new Error('無效的 URL 格式');
  }
  
  // 3. 插入資料
  const result = await db.prepare(`
    INSERT INTO ResourceCenter (
      title, description, resource_type, external_url,
      category, tags, created_by
    ) VALUES (?, ?, 'link', ?, ?, ?, ?)
  `).bind(
    input.title,
    input.description || null,
    input.external_url,
    input.category || null,
    JSON.stringify(input.tags || []),
    userId
  ).run();
  
  return { resource_id: result.meta.last_row_id };
}
```

---

## 下載/訪問資源（增加計數）

```typescript
async function accessResource(resourceId: number) {
  // 1. 查詢資源
  const resource = await db.prepare(`
    SELECT * FROM ResourceCenter 
    WHERE resource_id = ? AND is_deleted = 0
  `).bind(resourceId).first();
  
  if (!resource) {
    throw new Error('資源不存在');
  }
  
  // 2. 增加下載/點擊次數
  await db.prepare(`
    UPDATE ResourceCenter 
    SET download_count = download_count + 1
    WHERE resource_id = ?
  `).bind(resourceId).run();
  
  // 3. 返回資源資訊
  if (resource.resource_type === 'file') {
    return { download_url: resource.file_url };
  } else {
    return { external_url: resource.external_url };
  }
}
```

---

## 檔案上傳到 Cloudflare R2

```typescript
async function uploadToStorage(file: File): Promise<string> {
  // 使用 Cloudflare R2 或其他雲端儲存
  const fileName = `${Date.now()}-${file.name}`;
  const key = `resources/${fileName}`;
  
  // 上傳到 R2
  await env.R2_BUCKET.put(key, file, {
    httpMetadata: {
      contentType: file.type
    }
  });
  
  // 返回公開 URL
  return `https://your-domain.com/files/${key}`;
}
```

---

## 相關文檔

- [功能模塊 - 資源中心管理](../../功能模塊/22-資源中心管理.md)
- [UI 設計](./UI設計.md)

