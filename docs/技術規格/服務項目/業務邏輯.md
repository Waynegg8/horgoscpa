# 服務項目管理 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 核心業務規則

### 1. 層級結構規則

#### 兩層限制
- **主項目**：`parent_service_id = NULL`
- **子項目**：`parent_service_id` 指向主項目
- **不允許三層**：子項目不能再有子項目

#### 驗證邏輯
```typescript
async function validateServiceHierarchy(service: CreateServiceInput) {
  if (service.parent_service_id) {
    const parent = await db.prepare(
      'SELECT parent_service_id FROM Services WHERE service_id = ?'
    ).bind(service.parent_service_id).first();
    
    if (parent.parent_service_id !== null) {
      throw new Error('不允許三層結構，子項目不能再有子項目');
    }
  }
}
```

---

### 2. 唯一性規則

#### 主項目名稱唯一
```sql
SELECT COUNT(*) FROM Services 
WHERE parent_service_id IS NULL 
  AND service_name = ? 
  AND is_deleted = 0;
```

#### 同一主項目下子項目名稱唯一
```sql
SELECT COUNT(*) FROM Services 
WHERE parent_service_id = ? 
  AND service_name = ? 
  AND is_deleted = 0;
```

#### 驗證邏輯
```typescript
async function validateUniqueness(service: CreateServiceInput) {
  let sql, params;
  
  if (service.parent_service_id === null) {
    // 檢查主項目名稱
    sql = `SELECT COUNT(*) as count FROM Services 
           WHERE parent_service_id IS NULL 
             AND service_name = ? 
             AND is_deleted = 0`;
    params = [service.service_name];
  } else {
    // 檢查子項目名稱
    sql = `SELECT COUNT(*) as count FROM Services 
           WHERE parent_service_id = ? 
             AND service_name = ? 
             AND is_deleted = 0`;
    params = [service.parent_service_id, service.service_name];
  }
  
  const result = await db.prepare(sql).bind(...params).first();
  
  if (result.count > 0) {
    throw new Error('服務名稱已存在');
  }
}
```

---

### 3. 刪除規則

#### 檢查依賴
刪除前必須檢查以下依賴：

1. **客戶服務設定（ClientServices）**
```sql
SELECT COUNT(*) FROM ClientServices 
WHERE service_id = ? AND is_deleted = 0;
```

2. **工時記錄（TimeLogs）**
```sql
SELECT COUNT(*) FROM TimeLogs 
WHERE service_id = ? AND is_deleted = 0;
```

3. **任務模板（TaskTemplates）**
```sql
SELECT COUNT(*) FROM TaskTemplates 
WHERE service_template_id = ? AND is_deleted = 0;
```

#### 刪除邏輯
```typescript
async function deleteService(serviceId: number, userId: number) {
  // 1. 檢查依賴
  const hasClientServices = await checkDependency('ClientServices', serviceId);
  const hasTimeLogs = await checkDependency('TimeLogs', serviceId);
  const hasTaskTemplates = await checkDependency('TaskTemplates', serviceId);
  
  if (hasClientServices || hasTimeLogs || hasTaskTemplates) {
    throw new Error('此服務項目已被使用，無法刪除');
  }
  
  // 2. 查詢是否為主項目
  const service = await db.prepare(
    'SELECT parent_service_id FROM Services WHERE service_id = ?'
  ).bind(serviceId).first();
  
  // 3. 如果是主項目，同時軟刪除所有子項目
  if (service.parent_service_id === null) {
    await db.prepare(`
      UPDATE Services 
      SET is_deleted = 1, deleted_at = datetime('now'), deleted_by = ?
      WHERE parent_service_id = ?
    `).bind(userId, serviceId).run();
  }
  
  // 4. 軟刪除主項目/子項目
  await db.prepare(`
    UPDATE Services 
    SET is_deleted = 1, deleted_at = datetime('now'), deleted_by = ?
    WHERE service_id = ?
  `).bind(userId, serviceId).run();
}
```

---

### 4. 排序邏輯

#### 預設排序
- 按 `sort_order` 升序
- 相同 `sort_order` 則按 `service_name` 字母順序

#### 查詢範例
```sql
SELECT * FROM Services 
WHERE is_deleted = 0
ORDER BY 
  CASE WHEN parent_service_id IS NULL THEN 0 ELSE 1 END,
  sort_order ASC, 
  service_name ASC;
```

---

## CRUD 業務流程

### 新增服務項目
```typescript
async function createService(input: CreateServiceInput, userId: number) {
  // 1. 驗證層級結構
  await validateServiceHierarchy(input);
  
  // 2. 驗證唯一性
  await validateUniqueness(input);
  
  // 3. 驗證欄位
  if (!input.service_name || input.service_name.trim().length === 0) {
    throw new Error('服務名稱不可為空');
  }
  
  if (input.service_name.length > 100) {
    throw new Error('服務名稱不可超過 100 字元');
  }
  
  // 4. 插入資料
  const result = await db.prepare(`
    INSERT INTO Services (
      parent_service_id, service_name, description, 
      sort_order, created_by
    )
    VALUES (?, ?, ?, ?, ?)
  `).bind(
    input.parent_service_id,
    input.service_name,
    input.description || null,
    input.sort_order || 0,
    userId
  ).run();
  
  return result.meta.last_row_id;
}
```

### 更新服務項目
```typescript
async function updateService(
  serviceId: number, 
  input: UpdateServiceInput,
  userId: number
) {
  // 1. 檢查服務是否存在
  const existing = await db.prepare(
    'SELECT * FROM Services WHERE service_id = ? AND is_deleted = 0'
  ).bind(serviceId).first();
  
  if (!existing) {
    throw new Error('服務項目不存在');
  }
  
  // 2. 如果修改名稱，驗證唯一性
  if (input.service_name && input.service_name !== existing.service_name) {
    await validateUniqueness({
      ...existing,
      ...input
    });
  }
  
  // 3. 更新資料
  await db.prepare(`
    UPDATE Services 
    SET 
      service_name = COALESCE(?, service_name),
      description = COALESCE(?, description),
      sort_order = COALESCE(?, sort_order),
      updated_at = datetime('now')
    WHERE service_id = ?
  `).bind(
    input.service_name,
    input.description,
    input.sort_order,
    serviceId
  ).run();
}
```

### 查詢服務列表
```typescript
async function getServices() {
  const services = await db.prepare(`
    SELECT 
      s.service_id,
      s.parent_service_id,
      s.service_name,
      s.description,
      s.sort_order,
      s.is_active,
      u.name as created_by_name
    FROM Services s
    LEFT JOIN Users u ON s.created_by = u.user_id
    WHERE s.is_deleted = 0
    ORDER BY 
      CASE WHEN s.parent_service_id IS NULL THEN 0 ELSE 1 END,
      s.sort_order ASC,
      s.service_name ASC
  `).all();
  
  return buildTree(services.results);
}

function buildTree(flatList: Service[]): Service[] {
  const tree: Service[] = [];
  const map = new Map<number, Service>();
  
  // 建立映射
  flatList.forEach(item => {
    map.set(item.service_id, { ...item, children: [] });
  });
  
  // 建立層級
  map.forEach(item => {
    if (item.parent_service_id === null) {
      tree.push(item);
    } else {
      const parent = map.get(item.parent_service_id);
      if (parent) {
        parent.children.push(item);
      }
    }
  });
  
  return tree;
}
```

---

## 權限檢查

### 檢查邏輯
```typescript
async function checkServicePermission(userId: number, isAdmin: boolean) {
  if (isAdmin) {
    return true;
  }
  
  // 檢查模塊權限
  const hasPermission = await db.prepare(`
    SELECT is_enabled FROM ModulePermissions 
    WHERE module_name = 'service_management' 
      AND (user_id = ? OR user_id IS NULL)
    ORDER BY user_id DESC LIMIT 1
  `).bind(userId).first();
  
  return hasPermission?.is_enabled === 1;
}
```

---

## 相關文檔

- [功能模塊 - 服務項目管理](../../功能模塊/03-服務項目管理.md)
- [UI 設計](./UI設計.md)
- [測試案例](./測試案例.md)
- [Services 資料表](../../資料庫設計/服務項目/Services.md)





