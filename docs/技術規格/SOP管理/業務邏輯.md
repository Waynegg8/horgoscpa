# SOP文件管理 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 創建 SOP

```typescript
async function createSOP(
  userId: number,
  input: CreateSOPInput
) {
  // 1. 權限檢查：僅管理員可建立
  const user = await getUser(userId);
  if (user.role !== 'admin') {
    throw new Error('無權限操作');
  }
  
  // 2. 驗證輸入
  if (!input.title || !input.content) {
    throw new Error('標題和內容不可為空');
  }
  
  // 3. 插入資料
  const result = await db.prepare(`
    INSERT INTO SOPDocuments (
      title, content, category, tags, version, 
      is_published, created_by
    ) VALUES (?, ?, ?, ?, ?, ?, ?)
  `).bind(
    input.title,
    input.content,
    input.category || null,
    JSON.stringify(input.tags || []),
    input.version || '1.0',
    input.is_published ? 1 : 0,
    userId
  ).run();
  
  return { sop_id: result.meta.last_row_id };
}
```

---

## 更新 SOP

```typescript
async function updateSOP(
  userId: number,
  sopId: number,
  input: UpdateSOPInput
) {
  // 1. 權限檢查
  const user = await getUser(userId);
  if (user.role !== 'admin') {
    throw new Error('無權限操作');
  }
  
  // 2. 更新資料
  await db.prepare(`
    UPDATE SOPDocuments 
    SET 
      title = ?,
      content = ?,
      category = ?,
      tags = ?,
      version = ?,
      is_published = ?,
      updated_by = ?,
      updated_at = datetime('now')
    WHERE sop_id = ? AND is_deleted = 0
  `).bind(
    input.title,
    input.content,
    input.category,
    JSON.stringify(input.tags || []),
    input.version,
    input.is_published ? 1 : 0,
    userId,
    sopId
  ).run();
  
  return { success: true };
}
```

---

## 查看 SOP（增加瀏覽計數）

```typescript
async function viewSOP(sopId: number) {
  // 1. 查詢 SOP
  const sop = await db.prepare(`
    SELECT * FROM SOPDocuments 
    WHERE sop_id = ? AND is_deleted = 0
  `).bind(sopId).first();
  
  if (!sop) {
    throw new Error('SOP 不存在');
  }
  
  // 2. 增加瀏覽次數
  await db.prepare(`
    UPDATE SOPDocuments 
    SET view_count = view_count + 1
    WHERE sop_id = ?
  `).bind(sopId).run();
  
  return sop;
}
```

---

## 相關文檔

- [功能模塊 - SOP文件管理](../../功能模塊/18-SOP文件管理.md)
- [UI 設計](./UI設計.md)

