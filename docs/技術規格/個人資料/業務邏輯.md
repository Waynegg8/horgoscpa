# 個人資料設定 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 更新個人資料

```typescript
async function updateProfile(
  userId: number,
  input: UpdateProfileInput
) {
  // 1. 驗證輸入
  if (!input.name || input.name.trim().length === 0) {
    throw new Error('姓名不可為空');
  }
  
  if (!['男', '女'].includes(input.gender)) {
    throw new Error('性別格式錯誤');
  }
  
  // 2. 更新資料
  await db.prepare(`
    UPDATE Users 
    SET 
      name = ?,
      gender = ?,
      updated_at = datetime('now')
    WHERE user_id = ?
  `).bind(input.name, input.gender, userId).run();
  
  return { success: true };
}
```

---

## 修改密碼

```typescript
import argon2 from 'argon2';

async function changePassword(
  userId: number,
  currentPassword: string,
  newPassword: string
) {
  // 1. 查詢當前密碼雜湊
  const user = await db.prepare(
    'SELECT password FROM Users WHERE user_id = ?'
  ).bind(userId).first();
  
  if (!user) {
    throw new Error('用戶不存在');
  }
  
  // 2. 驗證當前密碼
  const isValid = await argon2.verify(user.password, currentPassword);
  if (!isValid) {
    throw new Error('當前密碼錯誤');
  }
  
  // 3. 驗證新密碼強度
  if (newPassword.length < 8) {
    throw new Error('新密碼至少需8個字元');
  }
  
  // 4. 雜湊新密碼
  const hashedPassword = await argon2.hash(newPassword, {
    type: argon2.argon2id,
    memoryCost: 65536,
    timeCost: 3,
    parallelism: 4
  });
  
  // 5. 更新密碼
  await db.prepare(`
    UPDATE Users 
    SET password = ?, updated_at = datetime('now')
    WHERE user_id = ?
  `).bind(hashedPassword, userId).run();
  
  return { success: true };
}
```

---

## 性別變更影響

當員工修改性別時，系統需要：

```typescript
async function handleGenderChange(userId: number, newGender: string) {
  // 1. 更新 Users 表
  await updateProfile(userId, { gender: newGender });
  
  // 2. 重新計算可用假別
  // 男性：移除生理假、產假等
  // 女性：新增生理假、產假等
  
  // 注意：不影響已申請的假期記錄
}
```

---

## 相關文檔

- [功能模塊 - 個人資料設定](../../功能模塊/07-個人資料設定.md)
- [UI 設計](./UI設計.md)
- [測試案例](./測試案例.md)


