# 客戶服務設定 - 業務邏輯

**最後更新：** 2025年10月27日

---

## 核心業務規則

### 1. 唯一性規則

#### 客戶服務唯一性
- 同一客戶不能重複訂閱同一服務項目
- 透過資料庫 UNIQUE INDEX 強制執行

#### 驗證邏輯
```typescript
async function validateUniqueness(clientId: string, serviceId: number) {
  const existing = await db.prepare(`
    SELECT COUNT(*) as count 
    FROM ClientServices 
    WHERE client_id = ? 
      AND service_id = ? 
      AND is_deleted = 0
  `).bind(clientId, serviceId).first();
  
  if (existing.count > 0) {
    throw new Error('此客戶已訂閱該服務項目');
  }
}
```

---

### 2. 觸發月份規則

#### 週期性服務
- 必須設定 `trigger_months`（JSON陣列）
- 值範圍：1-12
- 至少選擇1個月份

#### 單次性服務
- `trigger_months` 可為 `NULL`
- 不自動建立任務（需手動建立）

#### 驗證邏輯
```typescript
async function validateTriggerMonths(frequencyTypeId: number, triggerMonths: number[] | null) {
  // 查詢頻率類型
  const frequency = await db.prepare(
    'SELECT is_recurring FROM ServiceFrequencyTypes WHERE frequency_type_id = ?'
  ).bind(frequencyTypeId).first();
  
  // 週期性服務必須設定觸發月份
  if (frequency.is_recurring && (!triggerMonths || triggerMonths.length === 0)) {
    throw new Error('週期性服務必須設定觸發月份');
  }
  
  // 驗證月份範圍
  if (triggerMonths) {
    for (const month of triggerMonths) {
      if (month < 1 || month > 12) {
        throw new Error('觸發月份必須在 1-12 之間');
      }
    }
  }
}
```

---

### 3. 服務狀態管理

#### 服務狀態
- **啟用中**：`is_active = 1`, `end_date IS NULL`
- **已停用**：`is_active = 0`
- **已結束**：`end_date < 今天`

#### 狀態轉換邏輯
```typescript
function getServiceStatus(service: ClientService): string {
  if (service.end_date && new Date(service.end_date) < new Date()) {
    return '已結束';
  }
  
  if (!service.is_active) {
    return '已停用';
  }
  
  return '啟用中';
}
```

---

### 4. 自動建立任務規則

#### Cron Job 邏輯
每月1日 00:00 執行：

```typescript
async function createMonthlyTasks() {
  const currentMonth = new Date().getMonth() + 1;
  
  // 查詢本月需執行的服務
  const services = await db.prepare(`
    SELECT 
      cs.*,
      c.company_name,
      s.service_name,
      tt.task_template_id
    FROM ClientServices cs
    JOIN Clients c ON cs.client_id = c.client_id
    JOIN Services s ON cs.service_id = s.service_id
    LEFT JOIN TaskTemplates tt ON cs.task_template_id = tt.task_template_id
    WHERE cs.is_deleted = 0 
      AND cs.is_active = 1
      AND (cs.end_date IS NULL OR cs.end_date >= date('now'))
      AND json_extract(cs.trigger_months, '$') LIKE ?
  `).bind(`%${currentMonth}%`).all();
  
  for (const service of services.results) {
    await createTaskInstance(service);
  }
}

async function createTaskInstance(service: ClientService) {
  // 1. 建立任務實例
  const taskResult = await db.prepare(`
    INSERT INTO ActiveTasks (
      client_id, task_template_id, task_name,
      estimated_days, actual_start_date, status
    ) VALUES (?, ?, ?, ?, date('now'), 'pending')
  `).bind(
    service.client_id,
    service.task_template_id,
    `${service.service_name} - ${new Date().toLocaleDateString()}`,
    service.task_template_id ? null : 7,  // 預設7天
    service.client_id
  ).run();
  
  const taskId = taskResult.meta.last_row_id;
  
  // 2. 複製任務階段（若有模板）
  if (service.task_template_id) {
    await copyTaskStages(service.task_template_id, taskId);
  }
}

async function copyTaskStages(templateId: number, taskId: number) {
  const stages = await db.prepare(`
    SELECT * FROM TaskStageTemplates 
    WHERE task_template_id = ?
    ORDER BY stage_order
  `).bind(templateId).all();
  
  for (const stage of stages.results) {
    await db.prepare(`
      INSERT INTO ActiveTaskStages (
        task_id, stage_name, stage_order,
        estimated_days, status
      ) VALUES (?, ?, ?, ?, 'pending')
    `).bind(
      taskId,
      stage.stage_name,
      stage.stage_order,
      stage.estimated_days
    ).run();
  }
}
```

---

## CRUD 業務流程

### 新增客戶服務
```typescript
async function createClientService(
  clientId: string, 
  input: CreateClientServiceInput,
  userId: number
) {
  // 1. 驗證客戶是否存在
  const client = await db.prepare(
    'SELECT * FROM Clients WHERE client_id = ? AND is_deleted = 0'
  ).bind(clientId).first();
  
  if (!client) {
    throw new Error('客戶不存在');
  }
  
  // 2. 驗證服務項目是否存在
  const service = await db.prepare(
    'SELECT * FROM Services WHERE service_id = ? AND is_deleted = 0'
  ).bind(input.service_id).first();
  
  if (!service) {
    throw new Error('服務項目不存在');
  }
  
  // 3. 驗證唯一性
  await validateUniqueness(clientId, input.service_id);
  
  // 4. 驗證觸發月份
  await validateTriggerMonths(input.frequency_type_id, input.trigger_months);
  
  // 5. 插入資料
  const result = await db.prepare(`
    INSERT INTO ClientServices (
      client_id, service_id, frequency_type_id,
      trigger_months, fee_amount, task_template_id,
      difficulty, start_date, end_date, notes, created_by
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
  `).bind(
    clientId,
    input.service_id,
    input.frequency_type_id,
    JSON.stringify(input.trigger_months || []),
    input.fee_amount || null,
    input.task_template_id || null,
    input.difficulty || null,
    input.start_date || null,
    input.end_date || null,
    input.notes || null,
    userId
  ).run();
  
  return result.meta.last_row_id;
}
```

### 更新客戶服務
```typescript
async function updateClientService(
  id: number,
  input: UpdateClientServiceInput,
  userId: number
) {
  // 1. 檢查服務是否存在
  const existing = await db.prepare(
    'SELECT * FROM ClientServices WHERE client_service_id = ? AND is_deleted = 0'
  ).bind(id).first();
  
  if (!existing) {
    throw new Error('客戶服務不存在');
  }
  
  // 2. 若修改頻率或觸發月份，驗證
  if (input.frequency_type_id || input.trigger_months) {
    await validateTriggerMonths(
      input.frequency_type_id || existing.frequency_type_id,
      input.trigger_months !== undefined ? input.trigger_months : JSON.parse(existing.trigger_months)
    );
  }
  
  // 3. 更新資料
  await db.prepare(`
    UPDATE ClientServices 
    SET 
      frequency_type_id = COALESCE(?, frequency_type_id),
      trigger_months = COALESCE(?, trigger_months),
      fee_amount = COALESCE(?, fee_amount),
      task_template_id = COALESCE(?, task_template_id),
      difficulty = COALESCE(?, difficulty),
      start_date = COALESCE(?, start_date),
      end_date = COALESCE(?, end_date),
      is_active = COALESCE(?, is_active),
      notes = COALESCE(?, notes),
      updated_at = datetime('now')
    WHERE client_service_id = ?
  `).bind(
    input.frequency_type_id,
    input.trigger_months ? JSON.stringify(input.trigger_months) : null,
    input.fee_amount,
    input.task_template_id,
    input.difficulty,
    input.start_date,
    input.end_date,
    input.is_active,
    input.notes,
    id
  ).run();
}
```

### 刪除客戶服務
```typescript
async function deleteClientService(id: number, userId: number) {
  // 1. 檢查是否存在
  const existing = await db.prepare(
    'SELECT * FROM ClientServices WHERE client_service_id = ? AND is_deleted = 0'
  ).bind(id).first();
  
  if (!existing) {
    throw new Error('客戶服務不存在');
  }
  
  // 2. 檢查是否有關聯的任務
  const hasTasks = await db.prepare(`
    SELECT COUNT(*) as count 
    FROM ActiveTasks 
    WHERE client_id = ? 
      AND task_template_id = ?
      AND is_deleted = 0
  `).bind(existing.client_id, existing.task_template_id).first();
  
  if (hasTasks.count > 0) {
    throw new Error('此服務有關聯的任務，無法刪除');
  }
  
  // 3. 軟刪除
  await db.prepare(`
    UPDATE ClientServices 
    SET is_deleted = 1, deleted_at = datetime('now'), deleted_by = ?
    WHERE client_service_id = ?
  `).bind(userId, id).run();
}
```

### 查詢客戶服務列表
```typescript
async function getClientServices(clientId: string) {
  const services = await db.prepare(`
    SELECT 
      cs.*,
      s.service_name,
      ps.service_name as parent_service_name,
      ft.frequency_name,
      tt.name as task_template_name
    FROM ClientServices cs
    JOIN Services s ON cs.service_id = s.service_id
    LEFT JOIN Services ps ON s.parent_service_id = ps.service_id
    LEFT JOIN ServiceFrequencyTypes ft ON cs.frequency_type_id = ft.frequency_type_id
    LEFT JOIN TaskTemplates tt ON cs.task_template_id = tt.task_template_id
    WHERE cs.client_id = ? 
      AND cs.is_deleted = 0
    ORDER BY cs.is_active DESC, cs.created_at DESC
  `).bind(clientId).all();
  
  return services.results.map(s => ({
    ...s,
    trigger_months: s.trigger_months ? JSON.parse(s.trigger_months) : null,
    status: getServiceStatus(s)
  }));
}
```

---

## 權限檢查

### 檢查邏輯
```typescript
async function checkServicePermission(userId: number, clientId: string, isAdmin: boolean) {
  if (isAdmin) {
    return true;
  }
  
  // 檢查客戶是否由該員工負責
  const client = await db.prepare(
    'SELECT assignee_user_id FROM Clients WHERE client_id = ?'
  ).bind(clientId).first();
  
  return client.assignee_user_id === userId;
}
```

---

## 相關文檔

- [功能模塊 - 客戶服務設定](../../功能模塊/15-客戶服務設定.md)
- [UI 設計](./UI設計.md)
- [測試案例](./測試案例.md)
- [ClientServices 資料表](../../資料庫設計/業務服務/ClientServices.md)





