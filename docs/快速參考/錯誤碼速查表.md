# 錯誤碼速查表

**所有 API 錯誤碼一覽** | 快速診斷問題

---

## 🔍 快速查找

| HTTP | 錯誤碼 | 錯誤訊息 | 常見原因 | 解決方案 |
|------|--------|---------|---------|---------|
| 400 | `INVALID_REQUEST` | 請求格式錯誤 | Body 不是有效 JSON | 檢查 JSON 格式 |
| 400 | `INVALID_HIERARCHY` | 不允許三層結構 | 子項目下再建子項目 | 只允許兩層結構 |
| 400 | `INVALID_DATE_RANGE` | 日期區間錯誤 | 結束日期早於開始日期 | 調整日期順序 |
| 401 | `UNAUTHORIZED` | 未登入 | Token 過期或無效 | 重新登入 |
| 401 | `INVALID_CREDENTIALS` | 帳號或密碼錯誤 | 登入資訊錯誤 | 檢查帳密 |
| 403 | `FORBIDDEN` | 無權限 | 非管理員嘗試管理功能 | 聯繫管理員 |
| 403 | `INSUFFICIENT_PERMISSIONS` | 權限不足 | 模塊權限未開啟 | 請管理員開啟權限 |
| 404 | `CLIENT_NOT_FOUND` | 客戶不存在 | client_id 不存在 | 確認客戶 ID |
| 404 | `USER_NOT_FOUND` | 員工不存在 | user_id 不存在 | 確認員工 ID |
| 404 | `SERVICE_NOT_FOUND` | 服務項目不存在 | service_id 不存在 | 確認服務 ID |
| 404 | `TASK_NOT_FOUND` | 任務不存在 | task_id 不存在 | 確認任務 ID |
| 404 | `TEMPLATE_NOT_FOUND` | 模板不存在 | template_id 不存在 | 確認模板 ID |
| 409 | `DUPLICATE_CLIENT_ID` | 統一編號已存在 | 新增重複客戶 | 使用其他統一編號 |
| 409 | `DUPLICATE_USERNAME` | 使用者名稱已存在 | 新增重複員工 | 使用其他使用者名稱 |
| 409 | `DUPLICATE_SERVICE_NAME` | 服務名稱已存在 | 服務名稱重複 | 使用其他名稱 |
| 409 | `DUPLICATE_TAG_NAME` | 標籤名稱已存在 | 標籤名稱重複 | 使用其他名稱 |
| 422 | `VALIDATION_ERROR` | 驗證錯誤 | 欄位格式錯誤 | 檢查欄位格式 |
| 422 | `MISSING_REQUIRED_FIELD` | 缺少必填欄位 | 未提供必填欄位 | 補充必填欄位 |
| 422 | `INVALID_EMAIL_FORMAT` | Email 格式錯誤 | Email 不符合格式 | 使用正確 Email |
| 422 | `INVALID_PHONE_FORMAT` | 電話格式錯誤 | 電話號碼不符合格式 | 使用正確電話號碼 |
| 422 | `INVALID_CLIENT_ID_FORMAT` | 統一編號格式錯誤 | 不是 8 位數字 | 使用 8 位數字 |
| 500 | `INTERNAL_ERROR` | 伺服器錯誤 | 資料庫或系統錯誤 | 聯繫技術人員 |
| 500 | `DATABASE_ERROR` | 資料庫錯誤 | SQL 執行失敗 | 聯繫技術人員 |

---

## 📋 按 HTTP 狀態碼分類

### 4xx 客戶端錯誤

#### 400 Bad Request（請求格式錯誤）
```json
{
  "success": false,
  "error": {
    "code": "INVALID_REQUEST",
    "message": "請求格式錯誤"
  }
}
```

**常見原因：**
- JSON 格式錯誤（缺少引號、逗號等）
- Content-Type 不是 `application/json`
- Body 為空但 API 需要 Body

**解決方案：**
1. 使用 JSON 驗證工具檢查格式
2. 確認 Content-Type header
3. 確認 Body 不為空

---

#### 401 Unauthorized（未登入）
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "請先登入"
  }
}
```

**常見原因：**
- Token 已過期
- Token 無效或被篡改
- Cookie 已清除

**解決方案：**
1. 重新登入
2. 檢查 Cookie 是否存在
3. 確認 Token 未過期

---

#### 403 Forbidden（無權限）
```json
{
  "success": false,
  "error": {
    "code": "FORBIDDEN",
    "message": "您沒有權限執行此操作"
  }
}
```

**常見原因：**
- 非管理員嘗試管理功能
- 員工嘗試訪問未開啟的模塊
- 員工嘗試查看其他人的資料

**解決方案：**
1. 確認自己的角色（管理員/員工）
2. 請管理員開啟模塊權限
3. 只訪問自己有權限的資源

---

#### 404 Not Found（資源不存在）
```json
{
  "success": false,
  "error": {
    "code": "CLIENT_NOT_FOUND",
    "message": "客戶不存在"
  }
}
```

**常見原因：**
- ID 錯誤
- 資源已被刪除
- URL 路徑錯誤

**解決方案：**
1. 確認 ID 正確
2. 檢查資源是否已刪除
3. 確認 API 路徑正確

---

#### 409 Conflict（資源衝突）
```json
{
  "success": false,
  "error": {
    "code": "DUPLICATE_CLIENT_ID",
    "message": "統一編號已存在"
  }
}
```

**常見原因：**
- 唯一性欄位重複（統一編號、使用者名稱等）
- 資源已存在

**解決方案：**
1. 使用其他唯一值
2. 確認資源是否已存在
3. 若需更新，使用 PUT 而非 POST

---

#### 422 Unprocessable Entity（驗證錯誤）
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "client_id 必須為 8 位數字"
  }
}
```

**常見原因：**
- 欄位格式錯誤
- 缺少必填欄位
- 數值超出範圍

**解決方案：**
1. 檢查欄位格式
2. 補充必填欄位
3. 確認數值範圍

---

### 5xx 伺服器錯誤

#### 500 Internal Server Error（伺服器錯誤）
```json
{
  "success": false,
  "error": {
    "code": "INTERNAL_ERROR",
    "message": "伺服器內部錯誤"
  }
}
```

**常見原因：**
- 資料庫連線失敗
- SQL 語法錯誤
- 程式邏輯錯誤

**解決方案：**
1. 聯繫技術人員
2. 提供完整的錯誤訊息
3. 提供重現步驟

---

## 🎯 按功能模塊分類

### 認證相關
| 錯誤碼 | 說明 | HTTP |
|--------|------|------|
| `UNAUTHORIZED` | 未登入 | 401 |
| `INVALID_CREDENTIALS` | 帳密錯誤 | 401 |
| `WEAK_PASSWORD` | 密碼強度不足 | 422 |
| `PASSWORD_MISMATCH` | 密碼不匹配 | 422 |

### 權限相關
| 錯誤碼 | 說明 | HTTP |
|--------|------|------|
| `FORBIDDEN` | 無權限 | 403 |
| `INSUFFICIENT_PERMISSIONS` | 權限不足 | 403 |
| `MODULE_DISABLED` | 模塊未啟用 | 403 |

### 客戶管理相關
| 錯誤碼 | 說明 | HTTP |
|--------|------|------|
| `CLIENT_NOT_FOUND` | 客戶不存在 | 404 |
| `DUPLICATE_CLIENT_ID` | 統一編號已存在 | 409 |
| `INVALID_CLIENT_ID_FORMAT` | 統一編號格式錯誤 | 422 |
| `CLIENT_HAS_ACTIVE_SERVICES` | 客戶有進行中服務 | 409 |

### 服務項目相關
| 錯誤碼 | 說明 | HTTP |
|--------|------|------|
| `SERVICE_NOT_FOUND` | 服務項目不存在 | 404 |
| `DUPLICATE_SERVICE_NAME` | 服務名稱已存在 | 409 |
| `INVALID_HIERARCHY` | 不允許三層結構 | 400 |
| `SERVICE_IN_USE` | 服務項目使用中 | 409 |

### 任務管理相關
| 錯誤碼 | 說明 | HTTP |
|--------|------|------|
| `TASK_NOT_FOUND` | 任務不存在 | 404 |
| `TEMPLATE_NOT_FOUND` | 模板不存在 | 404 |
| `STAGE_NOT_FOUND` | 階段不存在 | 404 |
| `INVALID_STAGE_TRANSITION` | 階段狀態轉換錯誤 | 400 |
| `TEMPLATE_IN_USE` | 模板使用中 | 409 |

### 工時管理相關
| 錯誤碼 | 說明 | HTTP |
|--------|------|------|
| `TIMELOG_NOT_FOUND` | 工時記錄不存在 | 404 |
| `INVALID_DATE_RANGE` | 日期區間錯誤 | 400 |
| `DUPLICATE_TIMELOG` | 工時記錄重複 | 409 |
| `HOURS_EXCEED_LIMIT` | 工時超過上限 | 422 |

### 假期管理相關
| 錯誤碼 | 說明 | HTTP |
|--------|------|------|
| `INSUFFICIENT_LEAVE_BALANCE` | 假期餘額不足 | 422 |
| `LEAVE_TYPE_NOT_FOUND` | 假別類型不存在 | 404 |
| `INVALID_LEAVE_DATE` | 假期日期錯誤 | 400 |
| `LEAVE_OVERLAP` | 假期重疊 | 409 |

### 員工管理相關
| 錯誤碼 | 說明 | HTTP |
|--------|------|------|
| `USER_NOT_FOUND` | 員工不存在 | 404 |
| `DUPLICATE_USERNAME` | 使用者名稱已存在 | 409 |
| `DUPLICATE_EMAIL` | Email 已存在 | 409 |
| `INVALID_EMAIL_FORMAT` | Email 格式錯誤 | 422 |

---

## 🔧 調試技巧

### 1. 使用瀏覽器開發者工具
```
1. 打開 F12 開發者工具
2. 切換到 Network 標籤
3. 重現錯誤
4. 查看 Response 中的詳細錯誤訊息
```

### 2. 檢查請求格式
```javascript
// 正確的請求格式
fetch('/api/v1/clients', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    client_id: '12345678',
    company_name: '測試公司'
  })
});
```

### 3. 驗證 JSON 格式
使用線上工具：https://jsonlint.com/

### 4. 檢查認證狀態
```javascript
// 檢查是否已登入
fetch('/api/v1/auth/verify')
  .then(res => res.json())
  .then(data => console.log(data));
```

---

## 📝 錯誤處理最佳實踐

### 前端錯誤處理範例
```javascript
async function createClient(data) {
  try {
    const response = await fetch('/api/v1/clients', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (!result.success) {
      // 根據錯誤碼顯示對應訊息
      switch (result.error.code) {
        case 'DUPLICATE_CLIENT_ID':
          alert('統一編號已存在，請使用其他編號');
          break;
        case 'VALIDATION_ERROR':
          alert(`驗證錯誤：${result.error.message}`);
          break;
        case 'UNAUTHORIZED':
          // 重定向到登入頁
          window.location.href = '/login';
          break;
        default:
          alert(`錯誤：${result.error.message}`);
      }
      return null;
    }
    
    return result.data;
  } catch (error) {
    console.error('請求失敗：', error);
    alert('網路錯誤，請稍後再試');
    return null;
  }
}
```

### 統一錯誤處理函式
```javascript
function handleApiError(error) {
  const errorMessages = {
    'UNAUTHORIZED': '請重新登入',
    'FORBIDDEN': '您沒有權限執行此操作',
    'VALIDATION_ERROR': '資料格式錯誤，請檢查輸入',
    'DUPLICATE_CLIENT_ID': '統一編號已存在',
    'INTERNAL_ERROR': '系統錯誤，請聯繫技術人員'
  };
  
  const message = errorMessages[error.code] || error.message;
  return message;
}
```

---

## 🔗 相關文檔

- **[API 速查表](./API速查表.md)** - 所有 API 端點
- **[API 共用規範](../API規格/API共用規範.md)** - 響應格式、錯誤處理標準
- **[快速開發指南](./快速開發指南.md)** - 開發流程指引

---

**最後更新：** 2025年10月27日  
**錯誤碼總數：** 30+

