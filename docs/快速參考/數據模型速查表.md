# 數據模型速查表

**所有資料表結構一覽** | ER 圖與關聯關係

---

## 📊 核心 ER 圖

```
┌─────────────┐
│   Users     │ 員工/用戶
│  (27個表)   │
└──────┬──────┘
       │
       ├───────────────────────────────────────────────────┐
       │                                                   │
       │                                                   │
┌──────▼──────┐         ┌─────────────┐         ┌────────▼────────┐
│  Clients    │◄────────┤ClientServices│────────►│   Services      │
│  客戶資料    │         │  客戶服務    │         │   服務項目      │
└──────┬──────┘         └──────┬──────┘         └─────────────────┘
       │                       │
       │                       │
       │                ┌──────▼──────┐
       │                │ActiveTasks  │
       │                │  執行中任務  │
       │                └──────┬──────┘
       │                       │
       │                ┌──────▼──────────────┐
       │                │ActiveTaskStages     │
       │                │  任務階段進度        │
       │                └─────────────────────┘
       │
┌──────▼──────┐
│  TimeLogs   │ 工時記錄
└─────────────┘

┌─────────────┐
│LeaveBalances│ 假期餘額
└──────┬──────┘
       │
┌──────▼───────────┐
│LeaveApplications │ 假期申請
└──────────────────┘
```

---

## 🗂️ 資料表分類

### 核心業務（5 個表）
| 表名 | 說明 | 主鍵 | 重要欄位 | 關聯 |
|------|------|------|---------|------|
| `Users` | 員工/用戶 | `user_id` | username, name, is_admin | → TimeLogs, Clients |
| `Clients` | 客戶資料 | `client_id` | company_name, assignee_user_id | → ClientServices, TimeLogs |
| `TimeLogs` | 工時記錄 | `log_id` | user_id, client_id, hours, log_date | Users ←, Clients ← |
| `CustomerTags` | 客戶標籤 | `tag_id` | tag_name | → ClientTagAssignments |
| `ClientTagAssignments` | 標籤關聯 | `assignment_id` | client_id, tag_id | Clients ←, CustomerTags ← |

→ [詳細文檔](../資料庫設計/核心業務表.md)

---

### 服務項目（2 個表）
| 表名 | 說明 | 主鍵 | 重要欄位 | 關聯 |
|------|------|------|------|------|
| `Services` | 服務項目定義 | `service_id` | service_name, parent_service_id | 自關聯（樹狀結構）|
| `ClientServices` | 客戶服務配置 | `client_service_id` | client_id, service_id, frequency_id | Clients ←, Services ← |

→ [詳細文檔](../資料庫設計/服務項目表.md)

---

### 任務系統（4 個表）
| 表名 | 說明 | 主鍵 | 重要欄位 | 關聯 |
|------|------|------|------|------|
| `TaskTemplates` | 任務模板 | `template_id` | template_name, service_id | Services ← |
| `TaskStageTemplates` | 階段模板 | `stage_template_id` | template_id, stage_name | TaskTemplates ← |
| `ActiveTasks` | 執行中任務 | `task_id` | client_service_id, template_id | ClientServices ←, TaskTemplates ← |
| `ActiveTaskStages` | 任務階段進度 | `active_stage_id` | task_id, stage_template_id, status | ActiveTasks ←, TaskStageTemplates ← |

→ [詳細文檔](../資料庫設計/任務系統表.md)

---

### 假期系統（3 個表）
| 表名 | 說明 | 主鍵 | 重要欄位 | 關聯 |
|------|------|------|------|------|
| `LeaveBalances` | 假期餘額 | `balance_id` | user_id, leave_type_id, balance | Users ←, LeaveTypes ← |
| `LeaveApplications` | 假期申請 | `application_id` | user_id, leave_type_id, days | Users ←, LeaveTypes ← |
| `LeaveEvents` | 生活事件 | `event_id` | user_id, event_type, event_date | Users ← |

→ [詳細文檔](../資料庫設計/假期系統表.md)

---

### 業務規則（7 個表）
| 表名 | 說明 | 主鍵 | 重要欄位 | 可配置 |
|------|------|------|------|-------|
| `Holidays` | 國定假日 | `holiday_id` | holiday_date, name | ✅ 管理員 |
| `LeaveTypes` | 假別類型 | `leave_type_id` | type_name, deduct_leave | ✅ 管理員 |
| `OvertimeRates` | 加班費率 | `rate_id` | work_type_id, rate_multiplier | ✅ 管理員 |
| `AnnualLeaveRules` | 特休規則 | `rule_id` | min_months, max_months, days | ✅ 管理員 |
| `OtherLeaveRules` | 其他假期規則 | `rule_id` | leave_type_id, event_type, days | ✅ 管理員 |
| `ServiceFrequencyTypes` | 週期類型 | `frequency_id` | name, days_interval | ✅ 管理員 |
| `WorkTypes` | 工作類型 | `work_type_id` | type_name, is_overtime | ✅ 管理員 |

→ [詳細文檔](../資料庫設計/業務規則表.md)

---

### 補休系統（3 個表）
| 表名 | 說明 | 主鍵 | 重要欄位 |
|------|------|------|---------|
| `CompensatoryLeaveBalance` | 補休餘額 | `balance_id` | user_id, balance_hours |
| `CompensatoryLeaveTransactions` | 補休交易 | `transaction_id` | user_id, hours, transaction_type |
| `CompensatoryLeaveUsage` | 補休使用 | `usage_id` | user_id, hours_used, usage_date |

→ [詳細文檔](../資料庫設計/補休系統表.md)

---

### 知識管理（5 個表）
| 表名 | 說明 | 主鍵 | 重要欄位 | 用途 |
|------|------|------|---------|------|
| `SOPDocuments` | SOP 文件 | `sop_id` | title, content | 標準作業流程 |
| `ClientSOPLinks` | 客戶專屬 SOP | `link_id` | client_id, sop_id | 客戶專用 SOP |
| `KnowledgeArticles` | 知識庫文章 | `article_id` | title, content | 內部知識庫 |
| `ExternalArticles` | 外部文章 | `external_id` | title, slug | 公開網站文章 |
| `ResourceCenter` | 資源中心 | `resource_id` | title, file_url | 下載資源 |

→ [詳細文檔](../資料庫設計/知識管理表.md)

---

### ~~權限系統~~ ⭐ 已優化移除

**原設計：** ModulePermissions 表（14個布林欄位）  
**優化後：** 使用 `Users.is_admin` 控制所有權限

**移除原因：**
- 模塊權限過於複雜
- 對小型事務所，兩級權限已足夠
- 減少1個表，減少8個API端點

→ [詳細說明](../架構設計/權限系統設計.md)

---

### 系統設定（2 個表）
| 表名 | 說明 | 主鍵 | 重要欄位 |
|------|------|------|---------|
| `SystemSettings` | 系統設定 | `setting_id` | setting_key, setting_value |
| `AuditLogs` | 審計日誌 | `log_id` | user_id, action, table_name |

→ [詳細文檔](../資料庫設計/系統設定表.md)

---

## 🔗 關聯關係圖

### 客戶相關資料流
```
Users (員工)
  │
  ├─► Clients (客戶)
  │     │
  │     ├─► ClientServices (客戶服務)
  │     │     │
  │     │     └─► ActiveTasks (執行中任務)
  │     │           │
  │     │           └─► ActiveTaskStages (階段進度)
  │     │
  │     └─► TimeLogs (工時記錄) ◄─── Users
  │
  └─► ClientTagAssignments (標籤關聯) ◄─── CustomerTags (標籤)
```

### 假期相關資料流
```
Users (員工)
  │
  ├─► LeaveBalances (假期餘額) ◄─── LeaveTypes (假別類型)
  │
  ├─► LeaveApplications (假期申請) ◄─── LeaveTypes
  │
  ├─► LeaveEvents (生活事件)
  │
  └─► CompensatoryLeaveBalance (補休餘額)
        │
        ├─► CompensatoryLeaveTransactions (補休交易)
        │
        └─► CompensatoryLeaveUsage (補休使用)
```

### 任務相關資料流
```
Services (服務項目)
  │
  ├─► TaskTemplates (任務模板)
  │     │
  │     └─► TaskStageTemplates (階段模板)
  │
  └─► ClientServices (客戶服務)
        │
        └─► ActiveTasks (執行中任務)
              │
              └─► ActiveTaskStages (階段進度)
```

---

## 🎯 常見查詢場景

### 場景 1：查詢客戶的所有服務
```sql
SELECT 
  c.company_name,
  s.service_name,
  cs.start_date,
  ft.name AS frequency
FROM Clients c
JOIN ClientServices cs ON c.client_id = cs.client_id
JOIN Services s ON cs.service_id = s.service_id
JOIN ServiceFrequencyTypes ft ON cs.frequency_id = ft.frequency_id
WHERE c.client_id = ?
```

### 場景 2：查詢員工的工時統計
```sql
SELECT 
  u.name,
  SUM(t.hours) AS total_hours,
  COUNT(*) AS log_count
FROM Users u
JOIN TimeLogs t ON u.user_id = t.user_id
WHERE t.log_date BETWEEN ? AND ?
GROUP BY u.user_id
```

### 場景 3：查詢任務進度
```sql
SELECT 
  t.task_name,
  s.stage_name,
  ats.status,
  ats.started_at,
  ats.completed_at
FROM ActiveTasks t
JOIN ActiveTaskStages ats ON t.task_id = ats.task_id
JOIN TaskStageTemplates s ON ats.stage_template_id = s.stage_template_id
WHERE t.client_service_id = ?
ORDER BY s.stage_order
```

### 場景 4：查詢假期餘額
```sql
SELECT 
  u.name,
  lt.type_name,
  lb.entitled_days,
  lb.used_days,
  (lb.entitled_days - lb.used_days) AS remaining_days
FROM Users u
JOIN LeaveBalances lb ON u.user_id = lb.user_id
JOIN LeaveTypes lt ON lb.leave_type_id = lt.leave_type_id
WHERE u.user_id = ?
```

---

## 📝 資料表設計原則

### ✅ 遵循的設計原則
1. **標準化欄位**：所有表都有 `created_at`, `updated_at`
2. **軟刪除**：使用 `is_deleted` 而非實際刪除
3. **審計追蹤**：記錄 `created_by`, `updated_by`
4. **唯一約束**：重要欄位加上唯一索引
5. **外鍵關聯**：明確定義表之間關係

### 🔍 命名規範
- **表名**：PascalCase，複數形式（`Users`, `Clients`）
- **欄位名**：snake_case（`user_id`, `company_name`）
- **主鍵**：表名單數 + `_id`（`user_id`, `client_id`）
- **外鍵**：關聯表的主鍵名（`user_id` 關聯到 `Users.user_id`）
- **布林值**：`is_` 或 `has_` 開頭（`is_admin`, `has_children`）

---

## 🔧 索引策略

### 必須建立索引的欄位
1. **主鍵**：自動建立
2. **外鍵**：提升 JOIN 效能
3. **唯一欄位**：client_id, username, email
4. **常用查詢欄位**：log_date, status, is_deleted

### 複合索引
```sql
-- 工時查詢優化
CREATE INDEX idx_timelogs_user_date ON TimeLogs(user_id, log_date);

-- 任務查詢優化
CREATE INDEX idx_tasks_client_status ON ActiveTasks(client_service_id, status);

-- 假期查詢優化
CREATE INDEX idx_leave_user_type ON LeaveBalances(user_id, leave_type_id);
```

---

## 📊 資料量預估

| 表名 | 預估增長速度 | 1年後預估 | 5年後預估 |
|------|-------------|----------|----------|
| `Users` | 慢 | 50 | 100 |
| `Clients` | 中 | 500 | 2,000 |
| `TimeLogs` | 快 | 50,000 | 250,000 |
| `ActiveTasks` | 中 | 5,000 | 25,000 |
| `LeaveApplications` | 中 | 1,000 | 5,000 |
| `AuditLogs` | 快 | 100,000 | 500,000 |

---

## 🔗 相關文檔

- **[資料庫設計總覽](../資料庫設計/README.md)** - 完整的 Schema 定義
- **[API 速查表](./API速查表.md)** - 如何透過 API 訪問這些資料
- **[快速開發指南](./快速開發指南.md)** - 開發流程指引

---

**最後更新：** 2025年10月27日  
**資料表總數：** 27 個

