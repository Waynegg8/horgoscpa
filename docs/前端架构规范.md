# 前端架构规范

**版本**: 1.0  
**最后更新**: 2025-10-26  
**适用范围**: 内部管理系统

---

## 📋 总体架构

### 技术栈
- **HTML5**: 语义化标签
- **CSS3**: 现代化样式，使用CSS变量
- **JavaScript**: Vanilla JS（无框架）
- **图标**: Google Material Symbols

### 设计原则
1. **组件化**: 通过CSS组件库实现样式复用
2. **响应式**: 移动优先，支持768px、480px断点
3. **一致性**: 统一的颜色、间距、圆角系统
4. **可维护性**: 分离样式与结构，避免内嵌CSS

---

## 🎨 CSS架构

### 文件结构

```
assets/css/
├── 对外网站（不修改）
│   ├── common.css          # 对外网站共用样式
│   ├── navbar.css          # 对外导航栏
│   ├── footer.css          # 对外页脚
│   └── ...                 # 其他对外页面样式
│
└── 内部系统
    ├── internal-system.css      # 内部系统基础样式
    ├── internal-components.css  # 统一组件库（核心）
    ├── tasks-page.css           # 任务页面特定样式
    ├── settings-page.css        # 设定页面特定样式
    ├── knowledge-page.css       # 知识库页面特定样式
    └── [其他页面].css           # 按需添加
```

### 引入顺序

所有内部系统页面应按以下顺序引入CSS：

```html
<link rel="stylesheet" href="assets/css/internal-system.css">
<link rel="stylesheet" href="assets/css/internal-components.css">
<link rel="stylesheet" href="assets/css/[页面特定].css">
```

---

## 🎯 CSS变量系统

### 主色系
```css
--primary-color: #2c5f7c;      /* 主色 */
--primary-hover: #1e4258;      /* 主色悬停 */
--primary-light: #4a7fa0;      /* 主色浅色 */
```

### 功能色
```css
--success-color: #4caf50;      /* 成功 */
--danger-color: #f44336;       /* 危险 */
--warning-color: #ff9800;      /* 警告 */
--info-color: #2196F3;         /* 信息 */
```

### 文字色
```css
--text-primary: #333;          /* 主文字 */
--text-secondary: #666;        /* 次要文字 */
--text-light: #999;            /* 浅色文字 */
```

### 背景色
```css
--light-bg: #f5f5f5;           /* 浅色背景 */
--bg-white: #ffffff;           /* 白色背景 */
--bg-card: #ffffff;            /* 卡片背景 */
```

### 边框和分隔
```css
--border-color: #ddd;          /* 边框颜色 */
--border-light: #eee;          /* 浅色边框 */
```

### 阴影
```css
--shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
--shadow-md: 0 2px 8px rgba(0,0,0,0.08);
--shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
```

### 圆角
```css
--radius-sm: 4px;              /* 小圆角 */
--radius-md: 8px;              /* 中圆角 */
--radius-lg: 12px;             /* 大圆角 */
```

### 过渡
```css
--transition-fast: all 0.2s ease;
--transition-standard: all 0.3s ease;
```

---

## 🧩 组件库

### 1. 标签页组件 (Tabs)

**HTML结构**:
```html
<div class="tabs-container">
    <div class="tab-nav">
        <button class="tab-button active">标签1</button>
        <button class="tab-button">标签2</button>
    </div>
    
    <div class="tab-content active">内容1</div>
    <div class="tab-content">内容2</div>

</div>
```

**CSS类**:
- `.tabs-container` - 容器
- `.tab-nav` - 标签导航
- `.tab-button` - 标签按钮
- `.tab-button.active` - 激活状态
- `.tab-content` - 内容区域
- `.tab-content.active` - 显示内容

#### Tabs JS 行为规范
- 使用 `data-tab` 属性标识按钮目标，例如：`<button class="tab-button" data-tab="work-analysis">`。
- 对应内容容器采用 `id="<tab-name>-tab"`，例如：`id="work-analysis-tab"`。
- 切换逻辑：点击 `.tab-button` 时，为当前按钮添加 `.active`，移除其他按钮的 `.active`；同时为对应 `.tab-content` 添加 `.active`，移除其他内容的 `.active`。
- 禁止在 HTML 写行内脚本切换标签；统一由页面脚本（例如 `assets/js/reports.js`）初始化并控制。

```js
function initTabs() {
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      const tabName = button.dataset.tab;
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      button.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`${tabName}-tab`).classList.add('active');
    });
  });
}
```

### 2. 工具栏组件 (Toolbar)

**HTML结构**:
```html
<div class="toolbar">
    <div class="toolbar-left">
        <button class="btn btn-primary">+ 新增</button>
    </div>
    <div class="toolbar-right">
        <div class="search-box">
            <input type="text" placeholder="搜索...">
            <span class="search-icon">🔍</span>
        </div>
    </div>
</div>
```

### 3. 表格组件 (Table)

**HTML结构**:
```html
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>列1</th>
                <th>列2</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>数据1</td>
                <td>数据2</td>
                <td>
                    <div class="table-actions">
                        <button class="btn-edit">编辑</button>
                        <button class="btn-delete">删除</button>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
```

### 4. 卡片组件 (Card)

**HTML结构**:
```html
<div class="card">
    <div class="card-header">
        <h3>卡片标题</h3>
    </div>
    <div class="card-body">
        卡片内容
    </div>
    <div class="card-footer">
        <button class="btn btn-primary">确定</button>
    </div>
</div>
```

### 5. 表单组件 (Form)

**HTML结构**:
```html
<div class="form-group">
    <label class="required">字段名称</label>
    <input type="text" class="form-control">
    <small>帮助文本</small>
</div>
```

### 6. 按钮组件 (Button)

**CSS类**:
- `.btn` - 基础按钮
- `.btn-primary` - 主按钮
- `.btn-success` - 成功按钮
- `.btn-danger` - 危险按钮
- `.btn-secondary` - 次要按钮
- `.btn-outline` - 边框按钮
- `.btn-sm` - 小按钮
- `.btn-lg` - 大按钮

### 7. 状态徽章 (Badge)

**CSS类**:
- `.badge` - 基础徽章
- `.badge-pending` - 待处理
- `.badge-in-progress` - 进行中
- `.badge-completed` - 已完成
- `.badge-cancelled` - 已取消

### 8. 模态框组件 (Modal)

**HTML结构**:
```html
<div class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3>标题</h3>
            <button class="modal-close">×</button>
        </div>
        <div class="modal-body">
            内容
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary">取消</button>
            <button class="btn btn-primary">确定</button>
        </div>
    </div>
</div>
```

---

## 📐 布局规范

### 防止多重滚动条

**核心原则**: 只在主容器上设置 `overflow-y: auto`

```css
/* 正确的做法 */
body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

.internal-main {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    height: calc(100vh - 60px); /* 60px是导航栏高度 */
}

.internal-container {
    max-width: 1600px;
    margin: 0 auto;
    /* 不要设置 overflow */
}

.tab-content {
    padding: 20px;
    /* 不要设置 overflow 和 max-height */
}
```

### 响应式断点

```css
/* 平板 */
@media (max-width: 768px) {
    /* 调整布局 */
}

/* 手机 */
@media (max-width: 480px) {
    /* 进一步简化 */
}
```

---

## 📝 命名规范

### CSS类命名

**BEM风格**（推荐）:
```css
.block {}
.block__element {}
.block--modifier {}
```

**实例**:
```css
.task-card {}
.task-card__header {}
.task-card__title {}
.task-card--urgent {}
```

### 通用前缀

- `.internal-` - 内部系统专用
- `.btn-` - 按钮相关
- `.badge-` - 徽章相关
- `.status-` - 状态相关
- `.modal-` - 模态框相关

---

## 🚫 禁止事项

1. ❌ **禁止内嵌样式**: 不要使用 `<style>` 标签在HTML中写CSS
2. ❌ **禁止行内样式**: 避免使用 `style="..."` 属性
3. ❌ **禁止!important**: 除非绝对必要
4. ❌ **禁止多重滚动条**: 不要在嵌套容器上都设置overflow
5. ❌ **禁止硬编码颜色**: 使用CSS变量
6. ❌ **禁止魔法数字**: 使用变量或注释说明

---

## ✅ 最佳实践

1. ✅ **使用CSS变量**: 保持样式一致性
2. ✅ **组件化思维**: 复用组件库的类
3. ✅ **移动优先**: 先设计手机版，再增强桌面版
4. ✅ **语义化HTML**: 使用正确的标签
5. ✅ **渐进增强**: 基础功能先实现，再添加高级特性
6. ✅ **性能优化**: 减少重绘和重排
7. ✅ **可访问性**: 使用ARIA标签，确保键盘导航

---

## 🔧 开发工作流

### 创建新页面

1. **HTML结构**: 使用语义化标签
2. **引入CSS**: 按标准顺序引入
3. **使用组件**: 优先使用组件库的类
4. **特定样式**: 仅在必要时创建页面特定CSS
5. **测试**: 在不同屏幕尺寸测试

### 修改现有页面

1. **检查设计文档**: 了解现有架构
2. **移除内嵌样式**: 提取到CSS文件
3. **应用组件类**: 替换为组件库的类
4. **测试**: 确保功能正常

---

## 📊 已重构页面

| 页面 | 状态 | 移除的内嵌样式行数 |
|------|------|-------------------|
| tasks.html | ✅ 完成 | ~270行 |
| settings.html | ✅ 完成 | ~250行 |
| knowledge.html | ✅ 完成 | ~210行 |
| timesheet.html | ✅ 完成 | - |
| reports.html | ✅ 完成 | - |
| content-editor.html | ⏳ 待处理 | - |
| dashboard.html | ⏳ 待处理 | - |

---

## 📚 相关文档

- [系统架构设计.md](./系统架构设计.md) - 整体系统架构
- [开发与部署指南.md](./开发与部署指南.md) - 开发规范
- [API端点文档.md](./API端点文檔.md) - API参考

---

**记住**: 一致性比完美更重要。遵循这些规范可以让团队协作更顺畅！

## 全局變數與腳本載入順序（認證模組）
- 使用 `auth-common.js` 提供的全局變數：
  - `window.sessionToken`：由 `checkAuth()` 設定並暴露到全局
  - `window.currentUser`：由 `checkAuth()` 設定並暴露到全局
- 前端頁面不得再次以 `let currentUser`、`let sessionToken` 在全局（非函式或 IIFE 內）重新宣告，避免瀏覽器報錯「Identifier has already been declared」。
- 建議腳本載入順序（於 `<body>` 結尾）：
  1) `assets/js/config.js`
  2) `assets/js/common-utils.js`
  3) `assets/js/auth-common.js`
  4) `assets/js/error-handler.js`
  5) 頁面專屬腳本（如 `dashboard.js`, `reports.js`, `settings.js`, `unified-tasks.js`）
- 於頁面專屬腳本內，直接使用 `currentUser` 與 `sessionToken`（由 `initPage()` → `checkAuth()` 設定），勿重新宣告。必要時可在函式內使用區域別名，例如：
  ```javascript
  const user = currentUser; // 由 auth-common.js 設定並暴露到 window
  ```

### 認證快取機制（2025-10-26）
- `checkAuth()` 在驗證成功時會將用戶資料保存到 `localStorage.user_info`
- 當遇到以下情況時，會嘗試使用快取的用戶資料以保持使用者體驗：
  - 後端返回 500 等臨時錯誤
  - 網絡連接失敗
- 只有在遇到 401 未授權錯誤時，才會清除 token 並強制跳轉到登入頁
- 此機制可防止因後端臨時故障或網絡波動導致已登入用戶被強制登出

### 頁面初始化與 currentUser 可用性（2025-10-26）
- 所有內部頁面必須使用 `initPage(callback)` 包裹初始化邏輯
- `initPage` 會先執行 `checkAuth()`，成功後才執行 `callback`
- 在 `callback` 執行時，`window.currentUser` 和 `window.sessionToken` 已經設定完成
- 若頁面腳本需要在 callback 外訪問 `currentUser`，應實作重試機制：
  ```javascript
  let retries = 0;
  while (!window.currentUser && retries < 50) {
    await new Promise(resolve => setTimeout(resolve, 100));
    retries++;
  }
  ```
- 此機制確保即使 `checkAuth` 較慢或使用快取資料，頁面也能正確取得用戶資訊

