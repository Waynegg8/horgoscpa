# 客戶服務自動化系統 - 最終設計方案

> **⚠️ 設計文檔 - 尚未實施**  
> 整合 CSV 資料，實現客戶服務任務自動生成與智能分配

**創建日期**: 2025-10-26  
**版本**: 1.0 Final  
**狀態**: 設計完成，待實施

---

## 📋 目錄

1. [系統概述](#系統概述)
2. [架構重新設計](#架構重新設計)
3. [資料庫設計](#資料庫設計)
4. [統一任務管理介面](#統一任務管理介面)
5. [自動化排程](#自動化排程)
6. [API 設計](#api-設計)
7. [實施步驟](#實施步驟)

---

## 📖 系統概述

### 核心功能

本系統將 CSV 客戶服務資料整合進現有系統，並**重新設計任務管理架構**：

✅ **統一任務管理**: 所有任務（週期、工商、財稅、客戶服務）集中在一個頁面  
✅ **分類標籤視圖**: 用標籤切換不同業務類型，而非分散頁面  
✅ **全面多階段化**: 所有任務都使用多階段系統（含檢查點）  
✅ **自動任務生成**: 根據客戶服務配置，GitHub Actions 每日自動生成  
✅ **客製化模板**: 全域模板（網頁可編輯）+ 客戶專屬模板（執行時可調整）  
✅ **網頁端排程**: 可設定執行日期（例如每月15日）  
✅ **工作量查看**: 視覺化顯示工作量（僅供參考，手動分配）  
✅ **難易度評分**: 標記任務複雜度（協助手動決策）

### 資料來源

從 7 個 CSV 檔案匯入：
- **活頁簿6**: 68 個客戶的服務項目配置
- **活頁簿7**: 227 筆服務排程與收費明細
- **活頁簿3/4**: 營業稅申報檢查清單

### 整合方式

**利用現有功能**：
- ✅ 使用現有的 `multi_stage_tasks` 系統
- ✅ 整合進現有的 `tasks.html` 頁面（新增標籤）
- ✅ 在 `settings.html` 添加配置功能
- ✅ 在 `dashboard.html` 添加工作量視圖
- ✅ 使用現有的認證和 API 架構

---

## 🏗️ 架構重新設計

### 現有架構問題

**目前狀態**：
```
tasks.html (週期任務、工商、財稅) - 使用 iframe
multi-stage-tasks.html (多階段任務) - 獨立頁面
recurring-tasks.html (週期任務詳情) - iframe 載入
```

**問題**：
- 任務分散在多個頁面
- 有些是多階段，有些不是
- 使用 iframe，體驗不佳
- 難以統一管理

### 新架構設計

**統一後的架構**：

```
┌─────────────────────────────────────────────────────────┐
│              tasks.html - 統一任務管理中心                │
│                                                         │
│  ┌──────┬──────┬──────┬──────┬──────────┐              │
│  │週期  │工商  │財稅  │客戶  │我的任務  │ ← 標籤切換   │
│  └──────┴──────┴──────┴──────┴──────────┘              │
│                                                         │
│  ┌─────────────────────────────────────────────┐       │
│  │  所有任務都使用多階段系統                    │       │
│  │                                             │       │
│  │  任務卡片：                                  │       │
│  │  ┌─────────────────────────────────┐        │       │
│  │  │ 仟鑽公司 - 營業稅申報 2025-02   │        │       │
│  │  │ 難度：⭐⭐⭐ | 負責：紜蓁          │        │       │
│  │  │ ○──○──●──○──○──○──○──○        │        │       │
│  │  │ 階段 3/8 進行中                 │        │       │
│  │  └─────────────────────────────────┘        │       │
│  │                                             │       │
│  │  點擊任務 → 展開詳情（不跳轉頁面）   │       │
│  │  或點擊「查看詳情」→ 全螢幕模式      │       │
│  └─────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────┘
```

**改動說明**：

| 項目 | 現在 | 改為 |
|------|------|------|
| tasks.html | 3個標籤 + iframe | 5個標籤，無 iframe |
| multi-stage-tasks.html | 獨立頁面 | 改為模態對話框或側邊面板 |
| recurring-tasks.html | iframe 內容 | 整合進 tasks.html |
| 任務系統 | 部分多階段 | **全部多階段** |

### 標籤分類

```
標籤1: 週期任務 (recurring)
  - 原本的週期任務
  - 全部改為多階段

標籤2: 工商 (business)
  - 公司設立、變更等
  - 已是多階段

標籤3: 財稅簽證 (finance)
  - 稅務申報、簽證
  - 已是多階段

標籤4: 客戶服務 (client-services) ← 新增
  - 記帳、營業稅等
  - 自動生成的多階段任務

標籤5: 我的任務 (my-tasks) ← 新增
  - 顯示分配給當前用戶的所有任務
  - 跨類別顯示
```

---

## 🗄️ 資料庫設計

### 新增資料表

#### 1. 客戶服務配置表

```sql
CREATE TABLE IF NOT EXISTS client_services (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_id INTEGER NOT NULL,
  service_type TEXT NOT NULL,  -- 'accounting', 'vat', 'income_tax', etc.
  frequency TEXT NOT NULL,     -- 'monthly', 'bimonthly', 'quarterly', 'annual'
  
  -- 費用與工時
  fee DECIMAL(10,2) DEFAULT 0,
  estimated_hours DECIMAL(5,2) DEFAULT 0,
  
  -- 負責人（由管理員手動設定）
  assigned_to INTEGER,         -- user_id，必須手動指定
  backup_assignee INTEGER,     -- 備援負責人（選填）
  
  -- 排程設定
  execution_day INTEGER DEFAULT 15,      -- 每月執行日 (1-31)
  advance_days INTEGER DEFAULT 7,        -- 提前生成天數
  due_days INTEGER DEFAULT 15,           -- 任務期限天數
  start_month INTEGER DEFAULT 1,         -- 開始月份 (1-12)
  
  -- 難易度評分
  difficulty_level INTEGER DEFAULT 3 CHECK (difficulty_level BETWEEN 1 AND 5),
  manual_difficulty_override BOOLEAN DEFAULT 0,
  difficulty_factors TEXT,               -- JSON: 評分因素
  
  -- 客戶特性
  invoice_count INTEGER DEFAULT 0,
  client_cooperation TEXT DEFAULT 'normal', -- 'poor', 'normal', 'good'
  avg_actual_hours DECIMAL(5,2),
  requires_audit BOOLEAN DEFAULT 0,
  has_special_items BOOLEAN DEFAULT 0,
  
  -- 模板相關
  has_custom_template BOOLEAN DEFAULT 0,
  prefer_custom_template BOOLEAN DEFAULT 1,
  
  -- 狀態
  is_active BOOLEAN DEFAULT 1,
  notes TEXT,
  
  -- 時間戳
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  last_generated_at DATETIME,
  
  FOREIGN KEY (client_id) REFERENCES clients(id) ON DELETE CASCADE,
  FOREIGN KEY (assigned_to) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (backup_assignee) REFERENCES users(id) ON DELETE SET NULL
);

CREATE INDEX idx_cs_client ON client_services(client_id);
CREATE INDEX idx_cs_assigned ON client_services(assigned_to);
CREATE INDEX idx_cs_type ON client_services(service_type);
CREATE INDEX idx_cs_active ON client_services(is_active);
```

#### 2. 全域模板表（擴展現有）

```sql
-- 擴展 service_checklist_templates
ALTER TABLE service_checklist_templates ADD COLUMN created_by INTEGER;
ALTER TABLE service_checklist_templates ADD COLUMN last_modified_by INTEGER;
ALTER TABLE service_checklist_templates ADD COLUMN modification_reason TEXT;
ALTER TABLE service_checklist_templates ADD COLUMN is_locked BOOLEAN DEFAULT 0;

-- 全域模板歷史
CREATE TABLE IF NOT EXISTS global_template_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  template_id INTEGER NOT NULL,
  version INTEGER NOT NULL,
  template_name TEXT,
  checklist_data TEXT,
  modified_by INTEGER,
  modification_reason TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (template_id) REFERENCES service_checklist_templates(id)
);
```

#### 3. 客戶專屬模板表

```sql
CREATE TABLE IF NOT EXISTS client_service_templates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_service_id INTEGER NOT NULL,
  template_name TEXT NOT NULL,
  service_type TEXT NOT NULL,
  based_on_template_id INTEGER,
  
  -- 模板內容（JSON）
  template_data TEXT NOT NULL,
  
  -- 版本控制
  version INTEGER DEFAULT 1,
  is_active BOOLEAN DEFAULT 1,
  
  -- 修改追蹤
  created_by INTEGER,
  last_modified_by INTEGER,
  modification_reason TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (client_service_id) REFERENCES client_services(id) ON DELETE CASCADE,
  FOREIGN KEY (based_on_template_id) REFERENCES service_checklist_templates(id),
  
  UNIQUE(client_service_id, is_active)
);

-- 客戶模板歷史
CREATE TABLE IF NOT EXISTS client_template_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_service_template_id INTEGER NOT NULL,
  version INTEGER NOT NULL,
  template_data TEXT NOT NULL,
  modified_by INTEGER,
  modification_reason TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (client_service_template_id) REFERENCES client_service_templates(id)
);
```

#### 4. 任務生成記錄表

```sql
CREATE TABLE IF NOT EXISTS task_generation_log (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  client_service_id INTEGER NOT NULL,
  execution_period TEXT NOT NULL,  -- '2025-01', '2025-Q1' 等
  generated_task_id INTEGER,
  generated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  generation_method TEXT DEFAULT 'auto', -- 'auto' 或 'manual'
  
  FOREIGN KEY (client_service_id) REFERENCES client_services(id),
  FOREIGN KEY (generated_task_id) REFERENCES tasks(id),
  
  UNIQUE(client_service_id, execution_period)
);
```

#### 5. 用戶權限擴展

```sql
-- 擴展 users 表（僅添加必要權限）
ALTER TABLE users ADD COLUMN can_edit_global_templates BOOLEAN DEFAULT 0;
-- 是否可編輯全域模板

-- 工作量統計表（僅用於顯示，不用於分配）
CREATE TABLE IF NOT EXISTS user_workload_stats (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  period TEXT NOT NULL, -- 'YYYY-MM'
  total_tasks INTEGER DEFAULT 0,
  completed_tasks INTEGER DEFAULT 0,
  total_hours DECIMAL(6,2) DEFAULT 0,
  actual_hours DECIMAL(6,2) DEFAULT 0,
  avg_difficulty DECIMAL(3,2) DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (user_id) REFERENCES users(id),
  UNIQUE(user_id, period)
);

-- 注意：不需要 skill_level, specialty_services 等欄位
-- 因為不使用自動分配功能
```

#### 6. 擴展多階段任務表

```sql
-- 擴展 multi_stage_tasks
ALTER TABLE multi_stage_tasks ADD COLUMN template_type TEXT; -- 'global' 或 'custom'
ALTER TABLE multi_stage_tasks ADD COLUMN template_id INTEGER;
ALTER TABLE multi_stage_tasks ADD COLUMN template_version INTEGER;
ALTER TABLE multi_stage_tasks ADD COLUMN client_service_id INTEGER;

-- FOREIGN KEY (client_service_id) REFERENCES client_services(id)
```

---

## 🎯 功能設計

### 功能 1: 自動任務生成

**核心邏輯**：

```javascript
// 每日自動執行（GitHub Actions）
async function dailyTaskGeneration() {
  const today = new Date();
  
  // 1. 查詢所有啟用的服務配置
  const services = await db.all(`
    SELECT * FROM client_services 
    WHERE is_active = 1
  `);
  
  for (const service of services) {
    // 2. 計算下次執行日期
    const nextDate = calculateNextExecutionDate(service, today);
    const generateDate = new Date(nextDate);
    generateDate.setDate(generateDate.getDate() - service.advance_days);
    
    // 3. 檢查是否該生成
    if (today >= generateDate) {
      const period = calculatePeriod(service, nextDate);
      
      // 4. 檢查是否已生成
      const exists = await db.get(
        'SELECT id FROM task_generation_log WHERE client_service_id = ? AND execution_period = ?',
        [service.id, period]
      );
      
      if (!exists) {
        // 5. 選擇模板（優先客戶專屬）
        const template = await selectTemplate(service.id, service.service_type);
        
        // 6. 生成多階段任務
        const taskId = await createMultiStageTask(service, template, nextDate);
        
        // 7. 記錄生成日誌
        await db.run(
          'INSERT INTO task_generation_log (client_service_id, execution_period, generated_task_id) VALUES (?, ?, ?)',
          [service.id, period, taskId]
        );
      }
    }
  }
}
```

### 功能 2: 模板系統

**雙層模板架構**：

```
全域預設模板（9種標準流程）
  ├─ 營業稅申報（8階段）
  ├─ 記帳服務（4階段）
  ├─ 營所稅申報（5階段）
  └─ ... 其他服務
        ↓ 可客製化
客戶專屬模板（針對特定客戶）
  ├─ 仟鑽-營業稅 v2（9階段 - 新增特殊審核）
  ├─ 日央-記帳 v1（5階段 - 增加額外步驟）
  └─ ...
```

**模板選擇邏輯**：

```javascript
async function selectTemplate(clientServiceId, serviceType) {
  // 優先級 1: 客戶專屬模板
  const custom = await db.get(
    'SELECT * FROM client_service_templates WHERE client_service_id = ? AND is_active = 1',
    [clientServiceId]
  );
  
  if (custom) {
    return { type: 'custom', data: JSON.parse(custom.template_data), id: custom.id };
  }
  
  // 優先級 2: 全域預設模板
  const global = await db.get(
    'SELECT * FROM service_checklist_templates WHERE service_type = ? AND is_default = 1',
    [serviceType]
  );
  
  return { type: 'global', data: JSON.parse(global.checklist_data), id: global.id };
}
```

### 功能 3: 難易度評分（輔助手動分配）

**難易度計算（可自動或手動）**：

```javascript
function calculateDifficulty(service) {
  let score = 0;
  
  // 發票數量 (30%)
  if (service.invoice_count > 100) score += 1.5;
  else if (service.invoice_count > 50) score += 1.0;
  else if (service.invoice_count > 20) score += 0.5;
  
  // 服務類型 (25%)
  const typeWeights = {
    'accounting': 0.5, 'vat': 0.8, 'income_tax': 1.2, 
    'audit': 1.5, 'withholding': 0.6
  };
  score += typeWeights[service.service_type] || 0.5;
  
  // 歷史工時 (20%)
  if (service.avg_actual_hours > 8) score += 1.0;
  else if (service.avg_actual_hours > 5) score += 0.6;
  
  // 特殊需求 (15%)
  if (service.requires_audit) score += 0.8;
  
  // 客戶配合度 (10%)
  if (service.client_cooperation === 'poor') score += 0.5;
  
  // 轉換為 1-5 級
  return Math.min(5, Math.max(1, Math.ceil(score)));
}

// 注意：此功能僅提供建議難易度，管理員可手動覆寫
// 難易度用於：
// 1. 顯示在任務卡片上（視覺化）
// 2. 工作量統計時作為權重
// 3. 協助管理員手動分配決策（僅供參考）
```

---

## 🖥️ 統一任務管理介面

### 重新設計 tasks.html

**整合所有任務到一個頁面，用標籤分類**：

```html
<!-- tasks.html - 統一任務管理中心 -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>任務管理 - 霍爾果斯會計師事務所</title>
  <link rel="stylesheet" href="assets/css/internal-system.css">
</head>
<body>
  <nav class="internal-navbar">
    <!-- 使用現有導航欄 -->
  </nav>

  <main class="internal-main">
    <div class="internal-container">
      <h1>📋 任務管理中心</h1>
      
      <!-- 統一的標籤導航 -->
      <div class="tabs-container">
        <div class="tab-nav">
          <button class="tab-button active" onclick="switchTab('all')">
            <span class="material-symbols-outlined">list</span>
            全部任務
          </button>
          <button class="tab-button" onclick="switchTab('my-tasks')">
            <span class="material-symbols-outlined">person</span>
            我的任務
          </button>
          <button class="tab-button" onclick="switchTab('recurring')">
            <span class="material-symbols-outlined">repeat</span>
            週期任務
          </button>
          <button class="tab-button" onclick="switchTab('business')">
            <span class="material-symbols-outlined">business_center</span>
            工商登記
          </button>
          <button class="tab-button" onclick="switchTab('finance')">
            <span class="material-symbols-outlined">account_balance</span>
            財稅簽證
          </button>
          <button class="tab-button" onclick="switchTab('client-service')">
            <span class="material-symbols-outlined">groups</span>
            客戶服務
          </button>
          <button class="tab-button" onclick="switchTab('config')">
            <span class="material-symbols-outlined">settings</span>
            服務配置
          </button>
        </div>
        
        <!-- 所有標籤共用的工具列 -->
        <div class="toolbar">
          <button onclick="createNewTask()" class="btn-primary">
            <span class="material-symbols-outlined">add</span>
            創建新任務
          </button>
          <select id="statusFilter" onchange="filterTasks()">
            <option value="">全部狀態</option>
            <option value="pending">未開始</option>
            <option value="in_progress">進行中</option>
            <option value="completed">已完成</option>
          </select>
          <input type="text" id="searchInput" placeholder="搜尋客戶或任務..." 
                 onkeyup="searchTasks()">
        </div>
        
        <!-- 標籤內容 -->
        <div id="all-tab" class="tab-content active">
          <div id="allTasksList">
            <!-- 顯示所有多階段任務 -->
          </div>
        </div>
        
        <div id="my-tasks-tab" class="tab-content">
          <div id="myTasksList">
            <!-- 顯示分配給當前用戶的任務（跨類別） -->
          </div>
        </div>
        
        <div id="recurring-tab" class="tab-content">
          <div id="recurringTasksList">
            <!-- 僅顯示週期類別的任務 -->
          </div>
        </div>
        
        <div id="business-tab" class="tab-content">
          <div id="businessTasksList">
            <!-- 僅顯示工商類別的任務 -->
          </div>
        </div>
        
        <div id="finance-tab" class="tab-content">
          <div id="financeTasksList">
            <!-- 僅顯示財稅類別的任務 -->
          </div>
        </div>
        
        <div id="client-service-tab" class="tab-content">
          <div id="clientServiceTasksList">
            <!-- 僅顯示客戶服務類別的任務 -->
          </div>
        </div>
        
        <div id="config-tab" class="tab-content">
          <!-- 服務配置管理（原本要放在這的功能） -->
          <div class="config-section">
            <h2>📅 客戶服務配置</h2>
            <div class="config-toolbar">
              <button onclick="importCSV()" class="btn-secondary">
                <span class="material-symbols-outlined">upload_file</span>
                匯入 CSV
              </button>
              <button onclick="manualGenerate()" class="btn-secondary">
                <span class="material-symbols-outlined">autorenew</span>
                手動生成任務
              </button>
            </div>
            <div id="serviceConfigList">
              <!-- 客戶服務配置卡片 -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- 任務詳情側邊面板（取代原本的獨立頁面） -->
  <div id="taskDetailPanel" class="side-panel">
    <div class="panel-header">
      <h2 id="taskDetailTitle">任務詳情</h2>
      <button onclick="closeTaskDetail()">&times;</button>
    </div>
    <div class="panel-body" id="taskDetailContent">
      <!-- 動態載入任務詳情和階段編輯器 -->
    </div>
  </div>
  
  <script src="assets/js/unified-tasks.js"></script>
</body>
</html>
```

### 標籤功能說明

| 標籤 | 顯示內容 | 資料來源 |
|------|---------|---------|
| **全部任務** | 所有多階段任務（跨類別） | `multi_stage_tasks` 全部 |
| **我的任務** | 當前用戶的任務 | `WHERE assigned_to = current_user` |
| **週期任務** | 週期性業務 | `WHERE category = 'recurring'` |
| **工商登記** | 公司設立、變更 | `WHERE category = 'business'` |
| **財稅簽證** | 稅務、簽證 | `WHERE category = 'finance'` |
| **客戶服務** | 自動生成的服務任務 | `WHERE category = 'client_service'` |
| **服務配置** | 配置管理（不是任務列表） | `client_services` 配置表 |

### 統一的任務卡片

**所有標籤都使用相同的卡片樣式**：

```html
<div class="task-card" onclick="openTaskDetail(123)">
  <div class="task-header">
    <div>
      <h3 class="task-title">仟鑽公司 - 營業稅申報 2025-02</h3>
      <div class="task-meta">
        <span class="category-badge">客戶服務</span>
        <span class="difficulty-badge level-3">⭐⭐⭐</span>
        <span>負責：紜蓁</span>
        <span>截止：2025-02-28</span>
      </div>
    </div>
    <span class="status-badge in_progress">進行中</span>
  </div>
  
  <!-- 階段進度時間軸 -->
  <div class="stage-timeline">
    <div class="stage-item completed">
      <div class="stage-number">1</div>
      <div class="stage-name">資料收集</div>
    </div>
    <div class="stage-item completed">
      <div class="stage-number">2</div>
      <div class="stage-name">資料審核</div>
    </div>
    <div class="stage-item in_progress">
      <div class="stage-number">3</div>
      <div class="stage-name">計算稅額</div>
    </div>
    <div class="stage-item pending">
      <div class="stage-number">4</div>
      <div class="stage-name">填寫申報書</div>
    </div>
    <!-- ... 更多階段 -->
  </div>
  
  <div class="task-footer">
    <div class="progress-info">
      階段 3/8 進行中 | 已用 4.5h / 預估 7.5h
    </div>
    <button onclick="openTaskDetail(123); event.stopPropagation();" class="btn-primary">
      查看詳情
    </button>
  </div>
</div>
```

**客戶服務卡片設計**：

```html
<div class="service-card">
  <div class="card-header">
    <h3>仟鑽公司 - 營業稅申報</h3>
    <div class="card-badges">
      <span class="difficulty-badge level-3">難度 ⭐⭐⭐</span>
      <span class="status-badge active">啟用中</span>
      <span class="template-badge custom">客戶專屬模板 v2</span>
    </div>
  </div>
  
  <div class="card-body">
    <div class="service-row">
      <span class="label">負責人:</span>
      <select onchange="updateAssignee(123, this.value)">
        <option value="">-- 請選擇 --</option>
        <option value="1" selected>紜蓁</option>
        <option value="2">柏澄</option>
        <option value="3">凱閔</option>
      </select>
      <button onclick="viewWorkload()" class="btn-icon" title="查看工作量">📊</button>
    </div>
    
    <div class="service-row">
      <span class="label">執行頻率:</span>
      <span>雙月 (1,3,5,7,9,11月)</span>
    </div>
    
    <div class="service-row">
      <span class="label">每月執行日:</span>
      <input type="number" value="15" min="1" max="31" 
             onchange="updateExecutionDay(123, this.value)">
      <span>日</span>
    </div>
    
    <div class="service-row">
      <span class="label">提前生成:</span>
      <input type="number" value="7" min="1" max="30"
             onchange="updateAdvanceDays(123, this.value)">
      <span>天</span>
    </div>
    
    <div class="service-row">
      <span class="label">下次執行:</span>
      <span class="highlight">2025-02-15</span>
      <small>(將在 2025-02-08 生成任務)</small>
    </div>
    
    <div class="service-row">
      <span class="label">費用:</span>
      <span>$2,000</span>
    </div>
  </div>
  
  <div class="card-footer">
    <button onclick="editTemplate(123)" class="btn-secondary">
      <span class="material-symbols-outlined">edit</span>
      編輯模板
    </button>
    <button onclick="viewHistory(123)" class="btn-secondary">
      <span class="material-symbols-outlined">history</span>
      執行歷史
    </button>
    <button onclick="testGenerate(123)" class="btn-secondary">
      <span class="material-symbols-outlined">play_arrow</span>
      測試生成
    </button>
    <button onclick="toggleService(123)" class="btn-toggle">
      停用
    </button>
  </div>
</div>
```

### 重新設計 settings.html

**在設定頁面添加模板管理標籤**：

```html
<!-- settings.html 標籤頁 -->
<div class="tab-nav">
  <button class="tab-button active">基本設定</button>
  <button class="tab-button">SOP 管理</button>
  
  <!-- 新增：模板管理標籤 -->
  <button class="tab-button" onclick="switchTab('templates')">
    <span class="material-symbols-outlined">library_books</span>
    任務模板
  </button>
</div>

<!-- 模板管理標籤內容 -->
<div id="templates-tab" class="tab-content">
  <h2>📋 任務模板管理</h2>
  
  <div class="template-toolbar">
    <button onclick="createNewTemplate()" class="btn-primary">
      <span class="material-symbols-outlined">add</span>
      創建新模板
    </button>
  </div>
  
  <!-- 全域模板列表 -->
  <div class="templates-grid">
    <div class="template-card">
      <div class="template-header">
        <h4>標準營業稅申報流程</h4>
        <span class="version-badge">v3</span>
      </div>
      <div class="template-info">
        <p>階段數: 8 | 總工時: 7.5h</p>
        <p>使用中: 34 個客戶 | 客製化: 8 個</p>
        <p>最後修改: 2025-01-15</p>
      </div>
      <div class="template-actions">
        <button onclick="editTemplate(1)">
          <span class="material-symbols-outlined">edit</span>
          編輯
        </button>
        <button onclick="viewTemplateHistory(1)">
          <span class="material-symbols-outlined">history</span>
          歷史
        </button>
        <button onclick="viewImpact(1)">
          <span class="material-symbols-outlined">analytics</span>
          影響分析
        </button>
      </div>
    </div>
    <!-- 更多模板 -->
  </div>
</div>
```

### 擴展 dashboard.html

**在工作台添加工作量視圖**：

```html
<!-- dashboard.html 管理員視圖 -->
<div id="adminView">
  <div class="dashboard-grid">
    <!-- 現有：團隊工作進度 -->
    <div class="tasks-container">...</div>
    
    <!-- 新增：工作量平衡儀表板 -->
    <div class="workload-container">
      <h2>
        <span class="material-symbols-outlined">scale</span>
        工作量平衡
      </h2>
      
      <div class="employee-workload">
        <!-- 紜蓁 -->
        <div class="employee-bar">
          <div class="employee-info">
            <span class="name">紜蓁</span>
            <span class="stats">18任務 | 120h/160h</span>
          </div>
          <div class="workload-bar">
            <div class="workload-fill" style="width: 75%">75%</div>
          </div>
          <div class="difficulty-dist">
            <span class="diff-1">Lv1:3</span>
            <span class="diff-2">Lv2:5</span>
            <span class="diff-3">Lv3:6</span>
            <span class="diff-4">Lv4:3</span>
            <span class="diff-5">Lv5:1</span>
          </div>
        </div>
        
        <!-- 柏澄 -->
        <div class="employee-bar warning">
          <div class="employee-info">
            <span class="name">柏澄 ⚠️</span>
            <span class="stats">22任務 | 140h/160h</span>
          </div>
          <div class="workload-bar">
            <div class="workload-fill warning" style="width: 88%">88%</div>
          </div>
        </div>
        
        <!-- 凱閔 -->
        <div class="employee-bar">
          <div class="employee-info">
            <span class="name">凱閔</span>
            <span class="stats">15任務 | 90h/160h</span>
          </div>
          <div class="workload-bar">
            <div class="workload-fill" style="width: 56%">56%</div>
          </div>
        </div>
      </div>
      
      <!-- 工作量總覽 -->
      <div class="workload-summary">
        <p>總計：55 個任務 | 350 小時</p>
        <p>平均利用率：73%</p>
      </div>
    </div>
  </div>
</div>
```

### 任務詳情側邊面板

**取代原本的 multi-stage-tasks.html 獨立頁面，改為側邊面板**：

```html
<!-- 側邊面板設計（在 tasks.html 中） -->
<div id="taskDetailPanel" class="side-panel">
  <div class="panel-header">
    <button onclick="closePanel()" class="btn-back">
      <span class="material-symbols-outlined">arrow_back</span>
      返回
    </button>
    <h2 id="panelTitle">任務詳情</h2>
    <button onclick="closePanel()" class="btn-close">&times;</button>
  </div>
  
  <div class="panel-body">
    <!-- 模板資訊條 -->
    <div class="template-info-bar">
  <div class="template-indicator">
    <span class="material-symbols-outlined">description</span>
    <span class="template-name">使用模板: 仟鑽-營業稅 v2（客戶專屬）</span>
    <small>最後更新: 2025-01-15</small>
  </div>
  
  <div class="template-actions">
    <button onclick="enterEditMode()" class="btn-secondary">
      <span class="material-symbols-outlined">edit</span>
      編輯此客戶模板
    </button>
    <button onclick="viewTemplateHistory()" class="btn-secondary">
      <span class="material-symbols-outlined">history</span>
      查看歷史
    </button>
    <button onclick="compareWithGlobal()" class="btn-secondary">
      <span class="material-symbols-outlined">compare</span>
      與標準比較
    </button>
  </div>
</div>

<!-- 編輯模式面板（摺疊式） -->
<div id="editModePanel" class="edit-panel collapsed">
  <div class="panel-header">
    <h3>📝 編輯模板</h3>
    <button onclick="exitEditMode()">✕</button>
  </div>
  
  <div class="panel-body">
    <!-- 階段列表（可拖曳） -->
    <div class="stages-editor sortable">
      <div class="stage-edit-item" draggable="true">
        <span class="drag-handle">⋮⋮</span>
        <input type="text" value="資料收集" class="stage-name-input">
        <input type="number" value="2.0" step="0.5" class="stage-hours-input">
        <button onclick="editStageDetail(1)">✏️</button>
        <button onclick="deleteStage(1)">🗑️</button>
      </div>
      <!-- 更多階段 -->
    </div>
    
    <button onclick="addStage()" class="btn-add">
      ➕ 新增階段
    </button>
  </div>
  
  <div class="panel-footer">
    <textarea placeholder="修改原因（選填）" id="modificationReason"></textarea>
    <label>
      <input type="checkbox" checked> 套用到未來任務
    </label>
    <button onclick="saveAsClientTemplate()" class="btn-primary">
      💾 儲存為客戶專屬模板
    </button>
  </div>
</div>
```

---

## ⚙️ 自動化排程

### GitHub Actions 定時執行

**創建文件**（待實施）: `.github/workflows/auto-generate-tasks.yml`

```yaml
name: 自動生成客戶服務任務

on:
  schedule:
    # 每天凌晨 00:00 (台北時間 UTC+8)
    - cron: '0 16 * * *'  # UTC 16:00
  
  workflow_dispatch:
    inputs:
      target_date:
        description: '目標日期 (YYYY-MM-DD)'
        required: false

jobs:
  generate-tasks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: 設置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: 安裝依賴
        run: cd timesheet-api && npm ci
      
      - name: 生成任務
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd timesheet-api
          node scripts/generate-tasks.js --date "${{ github.event.inputs.target_date }}"
      
      - name: 發送通知
        if: always()
        run: |
          echo "任務生成完成"
```

**執行腳本**（待實施）: `timesheet-api/scripts/generate-tasks.js`

```javascript
#!/usr/bin/env node
import { generateAutomatedTasks } from '../src/automated-tasks.js';

async function main() {
  const targetDate = process.argv[2] || new Date().toISOString();
  console.log(`🚀 執行任務生成: ${targetDate}`);
  
  const results = await generateAutomatedTasks({ targetDate: new Date(targetDate) });
  
  console.log(`✅ 已生成: ${results.generated.length} 個任務`);
  console.log(`⏭️  已跳過: ${results.skipped.length} 個`);
  console.log(`❌ 錯誤: ${results.errors.length} 個`);
  
  process.exit(results.errors.length > 0 ? 1 : 0);
}

main();
```

---

## 🔌 API 設計

### 新增 API 端點

```javascript
// ============= 客戶服務配置 API =============

// GET /api/client-services
// 查詢客戶服務配置
app.get('/api/client-services', async (req, res) => {
  const { assigned_to, service_type, client_id } = req.query;
  // 返回篩選後的服務列表
});

// PUT /api/client-services/:id
// 更新服務配置（執行日、提前天數、難易度等）
app.put('/api/client-services/:id', async (req, res) => {
  const { execution_day, advance_days, difficulty_level, assigned_to } = req.body;
  // 更新配置並記錄
});

// POST /api/client-services/:id/toggle
// 啟用/停用服務
app.post('/api/client-services/:id/toggle', async (req, res) => {
  // 切換 is_active 狀態
});

// ============= 自動任務生成 API =============

// POST /api/automated-tasks/generate
// 手動觸發任務生成
app.post('/api/automated-tasks/generate', async (req, res) => {
  const { date, service_type, client_id } = req.body;
  const results = await generateAutomatedTasks({ targetDate: new Date(date) });
  // 返回生成結果
});

// GET /api/automated-tasks/preview
// 預覽將要生成的任務
app.get('/api/automated-tasks/preview', async (req, res) => {
  const { date } = req.query;
  // 返回待生成任務列表（不實際生成）
});

// POST /api/automated-tasks/generate/:serviceId
// 為特定服務立即生成任務
app.post('/api/automated-tasks/generate/:serviceId', async (req, res) => {
  // 單一服務生成
});

// ============= 模板管理 API =============

// GET /api/templates/global
// 取得所有全域模板
app.get('/api/templates/global', async (req, res) => {
  // 返回全域模板列表及使用統計
});

// PUT /api/templates/global/:id
// 更新全域模板
app.put('/api/templates/global/:id', async (req, res) => {
  const { template_data, modification_reason } = req.body;
  // 1. 權限檢查
  // 2. 儲存歷史版本
  // 3. 更新模板
  // 4. 返回影響分析
});

// GET /api/templates/client/:clientServiceId
// 取得客戶專屬模板
app.get('/api/templates/client/:clientServiceId', async (req, res) => {
  // 返回客戶模板或 null
});

// POST /api/templates/client
// 創建/更新客戶專屬模板
app.post('/api/templates/client', async (req, res) => {
  const { client_service_id, template_data, modification_reason } = req.body;
  // 儲存並記錄版本
});

// GET /api/templates/client/:id/compare
// 比較客戶模板與全域模板
app.get('/api/templates/client/:id/compare', async (req, res) => {
  // 返回差異分析
});

// ============= 工作量管理 API =============

// GET /api/workload/overview
// 取得團隊工作量概覽
app.get('/api/workload/overview', async (req, res) => {
  const { period } = req.query; // 'YYYY-MM'
  // 返回所有員工的工作量統計
});

// POST /api/workload/reassign
// 手動重新分配任務
app.post('/api/workload/reassign', async (req, res) => {
  const { task_id, from_user, to_user, reason } = req.body;
  // 執行任務轉移
});
```

---

## 📋 實施步驟

### Phase 1: 資料庫準備（第1週）

```bash
# 1. 備份資料庫
cd timesheet-api/backups
powershell -File ../backup-database.ps1

# 2. 執行遷移
cd ..
sqlite3 database.db < migrations/013_client_services_integration.sql

# 3. 插入預設模板
# （在 migration 中已包含）

# 4. 設定測試用戶
sqlite3 database.db
```

```sql
-- 設定員工能力等級
UPDATE users SET skill_level = 4, specialty_services = '["vat","audit"]' WHERE username = 'yunzhen';
UPDATE users SET skill_level = 3, specialty_services = '["accounting"]' WHERE username = 'bocheng';
UPDATE users SET skill_level = 5, specialty_services = '["income_tax","audit"]' WHERE username = 'kaimin';

-- 設定模板編輯權限
UPDATE users SET can_edit_global_templates = 1 WHERE role IN ('admin', 'senior_accountant');
```

### Phase 2: 匯入 CSV 資料（第1週）

```bash
# 執行匯入腳本
cd scripts
python import_client_services.py

# 預期結果：
# - 68 個客戶
# - 220+ 個服務配置
# - 自動計算難易度
# - 自動分配負責人
```

### Phase 3: 後端開發（第2-3週）

**需要創建/修改的檔案**（待實施）：

```
timesheet-api/src/
├── automated-tasks.js        (新建) 自動任務生成邏輯
├── client-services.js        (新建) 客戶服務 API
├── templates-api.js          (新建) 模板管理 API
├── workload-api.js          (新建) 工作量管理 API
└── index.js                  (修改) 添加新路由
```

### Phase 4: 前端開發（第3-4週）

**需要修改的現有檔案**（待實施）：

```
重新設計:
├── tasks.html               (完全重新設計為統一任務中心)
│   - 移除 iframe
│   - 改為 7 個標籤
│   - 所有任務都顯示多階段進度
│   - 添加側邊面板顯示詳情
│
├── settings.html            (添加「任務模板」標籤)
│   - 管理全域模板
│   - 查看客戶專屬模板列表
│
└── dashboard.html           (添加工作量視圖)
    - 顯示每人的任務數和工時
    - 僅供查看參考

棄用（整合進 tasks.html）:
├── multi-stage-tasks.html   (改為側邊面板，不再獨立頁面)
└── recurring-tasks.html     (整合進標籤，不再用 iframe)

新增 JavaScript:
├── assets/js/unified-tasks.js        (統一任務管理邏輯)
├── assets/js/template-editor.js      (模板編輯器)
└── assets/js/service-config.js       (服務配置管理)
```

### Phase 5: GitHub Actions（第4週）

**需要創建的檔案**（待實施）：

```
.github/workflows/
└── auto-generate-tasks.yml   (定時執行)

timesheet-api/scripts/
└── generate-tasks.js         (執行腳本)
```

### Phase 6: 測試與部署（第5週）

```bash
# 1. 測試自動生成
curl -X POST http://localhost:8787/api/automated-tasks/preview

# 2. 測試手動生成
curl -X POST http://localhost:8787/api/automated-tasks/generate

# 3. 驗證資料正確性
# 4. 用戶驗收測試
# 5. 正式部署
```

---

## 🎯 核心流程圖

### 完整自動化流程

```
CSV 檔案
    ↓
[Python 匯入腳本]
    ↓
資料庫 (client_services)
  • 客戶: 仟鑽公司
  • 服務: 營業稅申報
  • 頻率: 雙月
  • 執行日: 每月15日
  • 提前: 7天
  • 負責人: 紜蓁（由管理員手動設定）
  • 難易度: Lv.3（僅供參考）
    ↓
[GitHub Actions] 每日 00:00 檢查
    ↓
計算: 今天是 2/8，15-7=8，該生成了！
    ↓
檢查: 2025-02 期間尚未生成 ✓
    ↓
選擇模板:
  ├─ 檢查客戶專屬模板
  │   └─ 找到「仟鑽-營業稅 v2」✓
  └─ 使用客戶專屬模板（9階段）
    ↓
生成多階段任務:
  • 任務名: 仟鑽公司 - 營業稅申報
  • 期間: 2025-02
  • 負責人: 紜蓁
  • 截止日: 2025-02-28
  • 階段: 9 個（含特殊審核）
    ↓
記錄:
  ✓ task_generation_log
  ✓ 更新 last_generated_at
    ↓
通知紜蓁: 新任務已分配
```

---

## 💡 關鍵設計決策

### 1. 利用現有功能

**不重新發明輪子**：
- ✅ 使用現有的 `multi_stage_tasks` 表和邏輯
- ✅ 使用現有的 `tasks.html` 標籤頁系統
- ✅ 使用現有的 `settings.html` 設定頁面
- ✅ 使用現有的認證和 API 架構
- ✅ 使用現有的樣式系統 (internal-system.css)

### 2. 頁面整合策略

| 功能 | 整合位置 | 方式 |
|------|---------|------|
| **統一任務管理** | **tasks.html** | **重新設計為7個標籤的統一介面** |
| 客戶服務任務 | tasks.html | 「客戶服務」標籤 |
| 服務配置管理 | tasks.html | 「服務配置」標籤 |
| 任務詳情 | tasks.html | 側邊面板（取代獨立頁面） |
| 模板管理 | settings.html | 新增「任務模板」標籤 |
| 工作量儀表板 | dashboard.html | 管理員視圖中添加區塊 |
| 模板編輯 | tasks.html 側邊面板 | 在任務詳情中可編輯 |

### 3. 模板優先級

```
生成任務時的模板選擇：
1️⃣ 客戶專屬模板（如果存在且啟用）
2️⃣ 全域預設模板
```

### 4. 自動 vs 手動

| 操作 | 自動 | 手動 |
|------|------|------|
| 任務生成 | ✅ GitHub Actions 每日執行 | ✅ 網頁按鈕觸發 |
| 負責人分配 | ❌ 無（不使用自動分配） | ✅ 完全由管理員決定 |
| 難易度評分 | ✅ 自動計算（僅供參考） | ✅ 手動覆寫優先 |
| 模板套用 | ✅ 自動選擇（客戶→全域） | ✅ 可手動切換 |

---

## 🎨 UI/UX 設計重點

### 1. 保持一致性

使用現有的設計語言：
- ✅ Material Symbols 圖標
- ✅ 相同的卡片樣式
- ✅ 相同的按鈕和表單樣式
- ✅ 相同的顏色系統
- ✅ 相同的響應式設計

### 2. 直覺操作

```
查看 → 編輯 → 儲存 → 自動套用
```

- 所有操作即時儲存
- 提供即時反饋
- 顯示變更預覽
- 支援撤銷還原

### 3. 視覺化

- 工作量：進度條
- 難易度：星星評級
- 階段：時間軸
- 模板：對比視圖

---

## ✅ 最終檢查清單

### 資料庫 (1週)
- [ ] 執行 migration 013
- [ ] 匯入 CSV 資料
- [ ] 設定員工能力
- [ ] 驗證資料完整性

### 後端 (2週)
- [ ] 自動任務生成邏輯
- [ ] 客戶服務 API
- [ ] 模板管理 API
- [ ] 工作量計算 API
- [ ] 整合現有 API

### 前端 (2週)
- [ ] tasks.html - 新增「客戶服務」標籤
- [ ] settings.html - 新增「模板管理」和「員工能力」
- [ ] dashboard.html - 新增工作量視圖
- [ ] multi-stage-tasks.html - 新增模板編輯面板
- [ ] 開發 JavaScript 邏輯

### 自動化 (1週)
- [ ] GitHub Actions workflow
- [ ] 執行腳本
- [ ] 設定 Secrets
- [ ] 測試定時執行

### 測試 (1週)
- [ ] 功能測試
- [ ] 整合測試
- [ ] 用戶驗收
- [ ] 性能測試

---

## 📊 預期效益

- **時間節省**: 每月節省 17 小時（任務自動生成）
- **錯誤減少**: 降低 90%（自動套用正確模板和流程）
- **流程標準化**: 100% 一致性（模板系統）
- **工作透明化**: 100% 可見（工作量儀表板）

---

---

## 🎯 設計總結

### 核心改進

**之前的問題**：
- ❌ 任務分散在多個頁面（tasks.html, multi-stage-tasks.html, recurring-tasks.html）
- ❌ 使用 iframe 載入，體驗差
- ❌ 部分任務有多階段，部分沒有，不一致
- ❌ 難以統一管理和查看

**現在的設計**：
- ✅ **統一介面**: 所有任務集中在 tasks.html，用標籤分類
- ✅ **全面多階段**: 所有任務都使用多階段系統（含檢查點）
- ✅ **側邊面板**: 點擊任務打開側邊面板（不跳頁），或全螢幕模式
- ✅ **移除 iframe**: 直接渲染，體驗更好
- ✅ **簡潔明瞭**: 一個頁面管理所有任務

### 7 個標籤的作用

```
┌─────────────────────────────────────────────┐
│  全部 | 我的 | 週期 | 工商 | 財稅 | 客戶 | 配置 │
└─────────────────────────────────────────────┘

1. 全部任務 - 查看所有任務（跨類別）
2. 我的任務 - 我負責的任務（最常用）
3. 週期任務 - 原有的週期業務
4. 工商登記 - 公司設立、變更
5. 財稅簽證 - 稅務、簽證
6. 客戶服務 - 自動生成的服務任務（記帳、報稅等）
7. 服務配置 - 設定排程、難易度、負責人
```

### 自動化範圍

| 功能 | 自動 | 手動 |
|------|------|------|
| 任務生成 | ✅ GitHub Actions 每日自動執行 | ✅ 也可手動觸發 |
| 模板套用 | ✅ 優先客戶專屬，次用全域 | ✅ 可手動切換 |
| 負責人分配 | ❌ **完全不自動** | ✅ 管理員手動指定 |
| 難易度評分 | ✅ 自動計算（僅建議） | ✅ 可手動覆寫 |
| 執行日期 | ✅ 按配置自動計算 | ✅ 可網頁修改 |

### 實施優先級

**Phase 1** (1週): 資料庫 + 匯入
- 執行 migration
- 匯入 CSV 資料
- 驗證資料

**Phase 2** (2週): 後端 API
- 自動任務生成邏輯
- 模板選擇邏輯
- 客戶服務 API

**Phase 3** (2週): 前端重新設計
- **重點**: 重新設計 tasks.html
- 移除 iframe，改為標籤
- 添加側邊面板
- 整合所有任務顯示

**Phase 4** (1週): GitHub Actions
- 設定定時執行
- 測試自動生成

**Phase 5** (1週): 測試與上線
- 完整測試
- 用戶培訓
- 正式部署

---

**設計完成！** 🚀

這個設計的最大優勢：
- ✅ **統一管理** - 一個頁面看所有任務
- ✅ **分類清晰** - 標籤切換不同業務
- ✅ **體驗優化** - 移除 iframe，速度更快
- ✅ **完全多階段** - 所有任務都有檢查點
- ✅ **手動控制** - 分配、排程完全由您決定

**版本**: 1.0 Final  
**狀態**: 設計階段 - 尚未實施  
**下一步**: 確認設計無誤後，開始 Phase 1

