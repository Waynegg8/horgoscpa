# 後端開發規範

**最後更新：** 2025年10月27日

---

## API 路由規範

### 命名標準

```typescript
// ✅ 正確：使用 /api/v1/ 前綴
app.get('/api/v1/tasks', ...)
app.post('/api/v1/tasks', ...)

// ❌ 錯誤：缺少版本號
app.get('/api/tasks', ...)
```

### 路由檔案結構

```typescript
// routes/tasks.routes.ts
import { Hono } from 'hono';
import { authMiddleware } from '../middlewares/auth.middleware';
import { TaskService } from '../services/task.service';

const app = new Hono();

app.get('/api/v1/tasks',
  authMiddleware,
  async (c) => {
    const taskService = new TaskService(c.env.DB);
    const tasks = await taskService.getUserTasks(c.get('user').user_id);
    
    return c.json({ success: true, data: tasks });
  }
);

export default app;
```

---

## Service 層規範

```typescript
// services/task.service.ts
import { TaskRepository } from '../repositories/task.repository';

export class TaskService {
  constructor(private db: D1Database) {}
  
  async getUserTasks(userId: number) {
    const repo = new TaskRepository(this.db);
    const tasks = await repo.findByUserId(userId);
    
    // 業務邏輯：計算進度百分比
    return tasks.map(task => ({
      ...task,
      progress: this.calculateProgress(task)
    }));
  }
  
  private calculateProgress(task: any): string {
    const completedStages = task.stages.filter(s => s.status === '已完成').length;
    const totalStages = task.stages.length;
    return `${Math.round((completedStages / totalStages) * 100)}%`;
  }
}
```

---

## Repository 層規範

```typescript
// repositories/task.repository.ts
import { BaseRepository } from './base.repository';

export class TaskRepository extends BaseRepository {
  async findByUserId(userId: number) {
    return await this.db.prepare(`
      SELECT 
        t.*,
        c.company_name,
        (SELECT COUNT(*) FROM ActiveTaskStages 
         WHERE active_task_id = t.active_task_id 
           AND status = '已完成') as completed_stages
      FROM ActiveTasks t
      LEFT JOIN Clients c ON t.client_id = c.client_id
      WHERE t.assigned_user_id = ?
      ORDER BY t.due_date ASC
    `).bind(userId).all();
  }
}
```

---

## API 回應標準

### 成功回應

```typescript
{
  "success": true,
  "data": { ... },
  "meta": {
    "page": 1,
    "total": 50,
    "timestamp": "2025-10-27T12:00:00Z"
  }
}
```

### 錯誤回應

```typescript
{
  "success": false,
  "error": {
    "code": "TASK_NOT_FOUND",
    "message": "找不到指定的任務",
    "details": { "task_id": 123 }
  }
}
```

### 統一回應工具

```typescript
// utils/response.util.ts
export function successResponse(data: any, meta?: any) {
  return {
    success: true,
    data,
    ...(meta && { meta: { ...meta, timestamp: new Date().toISOString() } })
  };
}

export function errorResponse(code: string, message: string, details?: any) {
  return {
    success: false,
    error: { code, message, details }
  };
}
```

---

## 相關文檔

- [開發規範](../開發規範.md)
- [代碼規範](./代碼規範.md)
- [錯誤處理規範](./錯誤處理規範.md)

---

**最後更新：** 2025年10月27日



**最後更新：** 2025年10月27日

---

## API 路由規範

### 命名標準

```typescript
// ✅ 正確：使用 /api/v1/ 前綴
app.get('/api/v1/tasks', ...)
app.post('/api/v1/tasks', ...)

// ❌ 錯誤：缺少版本號
app.get('/api/tasks', ...)
```

### 路由檔案結構

```typescript
// routes/tasks.routes.ts
import { Hono } from 'hono';
import { authMiddleware } from '../middlewares/auth.middleware';
import { TaskService } from '../services/task.service';

const app = new Hono();

app.get('/api/v1/tasks',
  authMiddleware,
  async (c) => {
    const taskService = new TaskService(c.env.DB);
    const tasks = await taskService.getUserTasks(c.get('user').user_id);
    
    return c.json({ success: true, data: tasks });
  }
);

export default app;
```

---

## Service 層規範

```typescript
// services/task.service.ts
import { TaskRepository } from '../repositories/task.repository';

export class TaskService {
  constructor(private db: D1Database) {}
  
  async getUserTasks(userId: number) {
    const repo = new TaskRepository(this.db);
    const tasks = await repo.findByUserId(userId);
    
    // 業務邏輯：計算進度百分比
    return tasks.map(task => ({
      ...task,
      progress: this.calculateProgress(task)
    }));
  }
  
  private calculateProgress(task: any): string {
    const completedStages = task.stages.filter(s => s.status === '已完成').length;
    const totalStages = task.stages.length;
    return `${Math.round((completedStages / totalStages) * 100)}%`;
  }
}
```

---

## Repository 層規範

```typescript
// repositories/task.repository.ts
import { BaseRepository } from './base.repository';

export class TaskRepository extends BaseRepository {
  async findByUserId(userId: number) {
    return await this.db.prepare(`
      SELECT 
        t.*,
        c.company_name,
        (SELECT COUNT(*) FROM ActiveTaskStages 
         WHERE active_task_id = t.active_task_id 
           AND status = '已完成') as completed_stages
      FROM ActiveTasks t
      LEFT JOIN Clients c ON t.client_id = c.client_id
      WHERE t.assigned_user_id = ?
      ORDER BY t.due_date ASC
    `).bind(userId).all();
  }
}
```

---

## API 回應標準

### 成功回應

```typescript
{
  "success": true,
  "data": { ... },
  "meta": {
    "page": 1,
    "total": 50,
    "timestamp": "2025-10-27T12:00:00Z"
  }
}
```

### 錯誤回應

```typescript
{
  "success": false,
  "error": {
    "code": "TASK_NOT_FOUND",
    "message": "找不到指定的任務",
    "details": { "task_id": 123 }
  }
}
```

### 統一回應工具

```typescript
// utils/response.util.ts
export function successResponse(data: any, meta?: any) {
  return {
    success: true,
    data,
    ...(meta && { meta: { ...meta, timestamp: new Date().toISOString() } })
  };
}

export function errorResponse(code: string, message: string, details?: any) {
  return {
    success: false,
    error: { code, message, details }
  };
}
```

---

## 相關文檔

- [開發規範](../開發規範.md)
- [代碼規範](./代碼規範.md)
- [錯誤處理規範](./錯誤處理規範.md)

---

**最後更新：** 2025年10月27日



