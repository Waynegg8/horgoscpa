# å¾Œç«¯é–‹ç™¼è¦ç¯„

**é©ç”¨ç¯„åœï¼š** Cloudflare Workers + Hono å¾Œç«¯é–‹ç™¼  
**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´10æœˆ27æ—¥

---

## ğŸ“‹ ç›®éŒ„
- [æ¶æ§‹åˆ†å±¤](#æ¶æ§‹åˆ†å±¤)
- [Route å±¤](#route-å±¤)
- [Service å±¤](#service-å±¤)
- [Repository å±¤](#repository-å±¤)
- [éŒ¯èª¤è™•ç†](#éŒ¯èª¤è™•ç†)

---

## æ¶æ§‹åˆ†å±¤

### ä¸‰å±¤æ¶æ§‹
```
Routes (è·¯ç”±å±¤)
  â†“ æ¥æ”¶è«‹æ±‚ã€é©—è­‰æ¬Šé™
Service (æ¥­å‹™é‚è¼¯å±¤)
  â†“ è™•ç†æ¥­å‹™é‚è¼¯ã€å”èª¿è³‡æº
Repository (è³‡æ–™å­˜å–å±¤)
  â†“ åŸ·è¡Œè³‡æ–™åº«æ“ä½œ
Database (è³‡æ–™åº«)
```

### åˆ†å±¤è·è²¬

| å±¤ç´š | è·è²¬ | ç¦æ­¢äº‹é … |
|------|------|---------|
| **Routes** | æ¥æ”¶è«‹æ±‚ã€é©—è­‰æ¬Šé™ã€èª¿ç”¨ Service | âŒ ä¸å¯«æ¥­å‹™é‚è¼¯ã€ä¸ç›´æ¥è¨ªå•è³‡æ–™åº« |
| **Service** | æ¥­å‹™é‚è¼¯ã€è³‡æ–™é©—è­‰ã€å”èª¿å¤šå€‹ Repository | âŒ ä¸ç›´æ¥å¯« SQL |
| **Repository** | åŸ·è¡Œ SQLã€è³‡æ–™è½‰æ› | âŒ ä¸å¯«æ¥­å‹™é‚è¼¯ |

---

## Route å±¤

### æ¨™æº– Route çµæ§‹
```typescript
import { Hono } from 'hono';
import { authMiddleware, requireAdmin } from '../middleware/auth';
import { ClientService } from '../services/ClientService';

const app = new Hono();
const clientService = new ClientService();

// GET åˆ—è¡¨
app.get('/api/v1/clients', 
  authMiddleware,
  async (c) => {
    const user = c.get('user');
    const query = c.req.query();
    
    const result = await clientService.getClients(query, user);
    
    return c.json(successResponse(result.data, result.pagination));
  }
);

// POST æ–°å¢
app.post('/api/v1/clients',
  authMiddleware,
  requireAdmin,
  async (c) => {
    const user = c.get('user');
    const input = await c.req.json();
    
    const client = await clientService.createClient(input, user.user_id);
    
    return c.json(successResponse({
      client_id: client.client_id,
      message: 'å®¢æˆ¶æ–°å¢æˆåŠŸ'
    }), 201);
  }
);

export default app;
```

### Route å±¤è·è²¬
```typescript
// âœ… æ‡‰è©²åš
- æ¥æ”¶è«‹æ±‚åƒæ•¸
- é©—è­‰æ¬Šé™ï¼ˆä½¿ç”¨ middlewareï¼‰
- èª¿ç”¨ Service å±¤
- è¿”å›éŸ¿æ‡‰

// âŒ ä¸æ‡‰è©²åš
- å¯«æ¥­å‹™é‚è¼¯
- ç›´æ¥è¨ªå•è³‡æ–™åº«
- ç›´æ¥å¯« SQL
```

---

## Service å±¤

### æ¨™æº– Service çµæ§‹
```typescript
import { ClientRepository } from '../repositories/ClientRepository';
import { ValidationError, ConflictError } from '../errors';

export class ClientService {
  private repository: ClientRepository;
  
  constructor(db) {
    this.repository = new ClientRepository(db);
  }
  
  async createClient(data, userId) {
    // 1. é©—è­‰å¿…å¡«æ¬„ä½
    this.validateRequired(data, ['client_id', 'company_name', 'assignee_user_id']);
    
    // 2. é©—è­‰æ¬„ä½æ ¼å¼
    if (!this.isValidClientId(data.client_id)) {
      throw new ValidationError('çµ±ä¸€ç·¨è™Ÿå¿…é ˆç‚º 8 ä½æ•¸å­—');
    }
    
    // 3. æª¢æŸ¥å”¯ä¸€æ€§
    const existing = await this.repository.findByClientId(data.client_id);
    if (existing) {
      throw new ConflictError('çµ±ä¸€ç·¨è™Ÿå·²å­˜åœ¨');
    }
    
    // 4. æ’å…¥è³‡æ–™
    const client = await this.repository.create({
      ...data,
      created_by: userId,
      created_at: new Date(),
      is_deleted: 0
    });
    
    // 5. è¨˜éŒ„å¯©è¨ˆæ—¥èªŒï¼ˆè‹¥éœ€è¦ï¼‰
    await this.auditLog.log({
      user_id: userId,
      action: 'CREATE',
      table_name: 'Clients',
      record_id: client.client_id
    });
    
    return client;
  }
  
  async getClients(filters, user) {
    // æ¬Šé™æ§åˆ¶
    if (!user.is_admin) {
      filters.assignee_user_id = user.user_id;
    }
    
    return await this.repository.findAll(filters);
  }
  
  // é©—è­‰æ–¹æ³•
  private validateRequired(data, fields) {
    for (const field of fields) {
      if (!data[field]) {
        throw new ValidationError(`${field} ç‚ºå¿…å¡«æ¬„ä½`);
      }
    }
  }
  
  private isValidClientId(clientId) {
    return /^\d{8}$/.test(clientId);
  }
}
```

### Service å±¤è·è²¬
```typescript
// âœ… æ‡‰è©²åš
- é©—è­‰æ¥­å‹™è¦å‰‡
- æª¢æŸ¥å”¯ä¸€æ€§
- å”èª¿å¤šå€‹ Repository
- è¨˜éŒ„å¯©è¨ˆæ—¥èªŒ
- æ‹‹å‡ºæ¥­å‹™ç•°å¸¸

// âŒ ä¸æ‡‰è©²åš
- ç›´æ¥å¯« SQL
- è™•ç† HTTP è«‹æ±‚/éŸ¿æ‡‰
- è¿”å› HTTP ç‹€æ…‹ç¢¼
```

---

## Repository å±¤

### æ¨™æº– Repository çµæ§‹
```typescript
export class ClientRepository {
  private db;
  private tableName = 'Clients';
  private primaryKey = 'client_id';
  
  constructor(db) {
    this.db = db;
  }
  
  async findAll(filters = {}) {
    let query = `SELECT * FROM ${this.tableName} WHERE is_deleted = 0`;
    const params = [];
    
    if (filters.assignee_user_id) {
      query += ' AND assignee_user_id = ?';
      params.push(filters.assignee_user_id);
    }
    
    if (filters.company_name) {
      query += ' AND company_name LIKE ?';
      params.push(`%${filters.company_name}%`);
    }
    
    query += ' ORDER BY created_at DESC LIMIT ? OFFSET ?';
    params.push(filters.limit || 50, filters.offset || 0);
    
    const result = await this.db.prepare(query).bind(...params).all();
    return result.results;
  }
  
  async findById(id) {
    return await this.db.prepare(
      `SELECT * FROM ${this.tableName} WHERE ${this.primaryKey} = ? AND is_deleted = 0`
    ).bind(id).first();
  }
  
  async findByClientId(clientId) {
    return await this.db.prepare(
      'SELECT * FROM Clients WHERE client_id = ? AND is_deleted = 0'
    ).bind(clientId).first();
  }
  
  async create(data) {
    const fields = Object.keys(data);
    const placeholders = fields.map(() => '?').join(', ');
    const values = Object.values(data);
    
    const result = await this.db.prepare(`
      INSERT INTO ${this.tableName} (${fields.join(', ')})
      VALUES (${placeholders})
    `).bind(...values).run();
    
    return await this.findById(result.meta.last_row_id || data[this.primaryKey]);
  }
  
  async update(id, data) {
    const fields = Object.keys(data);
    const setClause = fields.map(f => `${f} = ?`).join(', ');
    const values = [...Object.values(data), id];
    
    await this.db.prepare(`
      UPDATE ${this.tableName}
      SET ${setClause}, updated_at = CURRENT_TIMESTAMP
      WHERE ${this.primaryKey} = ?
    `).bind(...values).run();
    
    return await this.findById(id);
  }
  
  async softDelete(id, userId) {
    await this.db.prepare(`
      UPDATE ${this.tableName}
      SET is_deleted = 1,
          deleted_at = CURRENT_TIMESTAMP,
          deleted_by = ?
      WHERE ${this.primaryKey} = ?
    `).bind(userId, id).run();
  }
}
```

### Repository å±¤è·è²¬
```typescript
// âœ… æ‡‰è©²åš
- åŸ·è¡Œ SQL æŸ¥è©¢
- ä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢ï¼ˆé˜² SQL æ³¨å…¥ï¼‰
- è‡ªå‹•éæ¿¾ is_deleted = 0
- è¿”å›è³‡æ–™ç‰©ä»¶

// âŒ ä¸æ‡‰è©²åš
- é©—è­‰æ¥­å‹™è¦å‰‡
- æ‹‹å‡ºæ¥­å‹™ç•°å¸¸
- è™•ç†æ¬Šé™æª¢æŸ¥
```

---

## éŒ¯èª¤è™•ç†

### è‡ªå®šç¾©éŒ¯èª¤é¡åˆ¥
```typescript
// errors/index.ts
export class ValidationError extends Error {
  statusCode = 422;
  code = 'VALIDATION_ERROR';
  
  constructor(message: string) {
    super(message);
    this.name = 'ValidationError';
  }
}

export class NotFoundError extends Error {
  statusCode = 404;
  code = 'RESOURCE_NOT_FOUND';
  
  constructor(message: string) {
    super(message);
    this.name = 'NotFoundError';
  }
}

export class ConflictError extends Error {
  statusCode = 409;
  code = 'RESOURCE_CONFLICT';
  
  constructor(message: string) {
    super(message);
    this.name = 'ConflictError';
  }
}

export class ForbiddenError extends Error {
  statusCode = 403;
  code = 'FORBIDDEN';
  
  constructor(message: string) {
    super(message);
    this.name = 'ForbiddenError';
  }
}
```

### çµ±ä¸€éŒ¯èª¤è™•ç† Middleware
```typescript
app.onError((err, c) => {
  console.error('Error:', err);
  
  // å·²çŸ¥éŒ¯èª¤é¡å‹
  if (err.statusCode) {
    return c.json(
      errorResponse(err.code, err.message),
      err.statusCode
    );
  }
  
  // æœªçŸ¥éŒ¯èª¤
  return c.json(
    errorResponse('INTERNAL_ERROR', 'ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤'),
    500
  );
});
```

### Service å±¤éŒ¯èª¤è™•ç†
```typescript
async createClient(data, userId) {
  // é©—è­‰å¤±æ•— â†’ æ‹‹å‡º ValidationError
  if (!this.isValidClientId(data.client_id)) {
    throw new ValidationError('çµ±ä¸€ç·¨è™Ÿå¿…é ˆç‚º 8 ä½æ•¸å­—');
  }
  
  // è³‡æºè¡çª â†’ æ‹‹å‡º ConflictError
  const existing = await this.repository.findByClientId(data.client_id);
  if (existing) {
    throw new ConflictError('çµ±ä¸€ç·¨è™Ÿå·²å­˜åœ¨');
  }
  
  // è³‡æºä¸å­˜åœ¨ â†’ æ‹‹å‡º NotFoundError
  const user = await this.userRepository.findById(userId);
  if (!user) {
    throw new NotFoundError('ä½¿ç”¨è€…ä¸å­˜åœ¨');
  }
  
  // æ¬Šé™ä¸è¶³ â†’ æ‹‹å‡º ForbiddenError
  if (!user.is_admin) {
    throw new ForbiddenError('åƒ…ç®¡ç†å“¡å¯åŸ·è¡Œæ­¤æ“ä½œ');
  }
}
```

---

## Middleware è¨­è¨ˆ

### authMiddlewareï¼ˆèªè­‰ï¼‰
```typescript
export const authMiddleware = async (c, next) => {
  const token = c.req.cookie('auth_token');
  
  if (!token) {
    return c.json(errorResponse('UNAUTHORIZED', 'è«‹å…ˆç™»å…¥'), 401);
  }
  
  try {
    const payload = await verifyJWT(token, c.env.JWT_SECRET);
    const user = await c.env.DB.prepare(
      'SELECT * FROM Users WHERE user_id = ? AND is_deleted = 0'
    ).bind(payload.user_id).first();
    
    if (!user) {
      return c.json(errorResponse('UNAUTHORIZED', 'è«‹å…ˆç™»å…¥'), 401);
    }
    
    c.set('user', user);
    await next();
  } catch (error) {
    return c.json(errorResponse('UNAUTHORIZED', 'è«‹å…ˆç™»å…¥'), 401);
  }
};
```

### requireAdminï¼ˆç®¡ç†å“¡æª¢æŸ¥ï¼‰
```typescript
export const requireAdmin = async (c, next) => {
  const user = c.get('user');
  
  if (!user.is_admin) {
    return c.json(errorResponse('FORBIDDEN', 'åƒ…ç®¡ç†å“¡å¯è¨ªå•'), 403);
  }
  
  await next();
};
```

### checkPermissionï¼ˆæ¨¡å¡Šæ¬Šé™æª¢æŸ¥ï¼‰
```typescript
export function checkPermission(moduleName: string) {
  return async (c, next) => {
    const user = c.get('user');
    
    // ç®¡ç†å“¡è·³éæª¢æŸ¥
    if (user.is_admin) {
      await next();
      return;
    }
    
    // æŸ¥è©¢æ¬Šé™
    const permission = await c.env.DB.prepare(`
      SELECT can_access FROM ModulePermissions
      WHERE (user_id = ? OR user_id IS NULL) AND module_name = ?
      ORDER BY user_id DESC NULLS LAST
      LIMIT 1
    `).bind(user.user_id, moduleName).first();
    
    if (!permission || !permission.can_access) {
      return c.json(
        errorResponse('INSUFFICIENT_PERMISSIONS', 'æ¨¡å¡Šæ¬Šé™æœªé–‹å•Ÿ'),
        403
      );
    }
    
    await next();
  };
}
```

---

## æœ€ä½³å¯¦è¸

### âœ… å¿…é ˆéµå®ˆ
1. æ¸…æ™°çš„åˆ†å±¤æ¶æ§‹ï¼ˆRoutes â†’ Services â†’ Repositoriesï¼‰
2. ä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢ï¼ˆé˜² SQL æ³¨å…¥ï¼‰
3. æ‰€æœ‰æŸ¥è©¢è‡ªå‹•éæ¿¾ `is_deleted = 0`
4. ä½¿ç”¨è‡ªå®šç¾©éŒ¯èª¤é¡åˆ¥
5. å¯¦ç¾è»Ÿåˆªé™¤ï¼ˆä¸å¯¦éš›åˆªé™¤è³‡æ–™ï¼‰
6. è¨˜éŒ„å¯©è¨ˆæ—¥èªŒï¼ˆé‡è¦æ“ä½œï¼‰
7. çµ±ä¸€éŸ¿æ‡‰æ ¼å¼

### âŒ ç¦æ­¢äº‹é …
1. Route å±¤ä¸å¯«æ¥­å‹™é‚è¼¯
2. Service å±¤ä¸ç›´æ¥å¯« SQL
3. ä¸ä½¿ç”¨å­—ä¸²æ‹¼æ¥ SQL
4. ä¸åœ¨ç¨‹å¼ç¢¼ä¸­ç¡¬ç·¨ç¢¼æ¥­å‹™è¦å‰‡
5. ä¸è·³éæ¬Šé™æª¢æŸ¥

---

## å®Œæ•´ç¯„ä¾‹

### é …ç›®çµæ§‹
```
src/
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ clients.routes.js
â”‚   â”œâ”€â”€ auth.routes.js
â”‚   â””â”€â”€ index.js
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ ClientService.service.js
â”‚   â”œâ”€â”€ AuthService.service.js
â”‚   â””â”€â”€ index.js
â”œâ”€â”€ repositories/
â”‚   â”œâ”€â”€ ClientRepository.repository.js
â”‚   â”œâ”€â”€ UserRepository.repository.js
â”‚   â””â”€â”€ index.js
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ auth.middleware.js
â”‚   â”œâ”€â”€ permission.middleware.js
â”‚   â””â”€â”€ index.js
â”œâ”€â”€ errors/
â”‚   â””â”€â”€ index.js
â””â”€â”€ utils/
    â”œâ”€â”€ response.js
    â””â”€â”€ validation.js
```

### å®Œæ•´å¯¦ç¾ç¯„ä¾‹
```typescript
// routes/clients.routes.js
import { Hono } from 'hono';
import { authMiddleware, requireAdmin } from '../middleware/auth';
import { ClientService } from '../services/ClientService';

const app = new Hono();

app.post('/api/v1/clients',
  authMiddleware,
  requireAdmin,
  async (c) => {
    const service = new ClientService(c.env.DB);
    const user = c.get('user');
    const input = await c.req.json();
    
    try {
      const client = await service.createClient(input, user.user_id);
      return c.json(successResponse(client), 201);
    } catch (error) {
      // éŒ¯èª¤ç”±å…¨å±€ error handler è™•ç†
      throw error;
    }
  }
);

export default app;
```

```typescript
// services/ClientService.service.js
import { ClientRepository } from '../repositories/ClientRepository';
import { ValidationError, ConflictError } from '../errors';

export class ClientService {
  constructor(db) {
    this.repository = new ClientRepository(db);
  }
  
  async createClient(data, userId) {
    // é©—è­‰
    this.validateClientData(data);
    
    // æª¢æŸ¥å”¯ä¸€æ€§
    const exists = await this.repository.findByClientId(data.client_id);
    if (exists) {
      throw new ConflictError('çµ±ä¸€ç·¨è™Ÿå·²å­˜åœ¨');
    }
    
    // å‰µå»º
    return await this.repository.create({
      ...data,
      created_by: userId
    });
  }
  
  private validateClientData(data) {
    if (!data.client_id || !/^\d{8}$/.test(data.client_id)) {
      throw new ValidationError('çµ±ä¸€ç·¨è™Ÿå¿…é ˆç‚º 8 ä½æ•¸å­—');
    }
    
    if (!data.company_name) {
      throw new ValidationError('å…¬å¸åç¨±ç‚ºå¿…å¡«');
    }
  }
}
```

```typescript
// repositories/ClientRepository.repository.js
export class ClientRepository {
  constructor(db) {
    this.db = db;
  }
  
  async findAll(filters = {}) {
    let query = 'SELECT * FROM Clients WHERE is_deleted = 0';
    const params = [];
    
    if (filters.assignee_user_id) {
      query += ' AND assignee_user_id = ?';
      params.push(filters.assignee_user_id);
    }
    
    const result = await this.db.prepare(query).bind(...params).all();
    return result.results;
  }
  
  async findByClientId(clientId) {
    return await this.db.prepare(
      'SELECT * FROM Clients WHERE client_id = ? AND is_deleted = 0'
    ).bind(clientId).first();
  }
  
  async create(data) {
    const result = await this.db.prepare(`
      INSERT INTO Clients (
        client_id, company_name, assignee_user_id, created_by, created_at
      )
      VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)
    `).bind(
      data.client_id,
      data.company_name,
      data.assignee_user_id,
      data.created_by
    ).run();
    
    return await this.findByClientId(data.client_id);
  }
}
```

---

## ğŸ”— ç›¸é—œæ–‡æª”

- [API å…±ç”¨è¦ç¯„](../APIè¦æ ¼/APIå…±ç”¨è¦ç¯„.md)
- [å…±ç”¨æ¥­å‹™é‚è¼¯](../æŠ€è¡“è¦æ ¼/å…±ç”¨æ¥­å‹™é‚è¼¯.md)
- [å‘½åèˆ‡æ ¼å¼è¦ç¯„](./å‘½åèˆ‡æ ¼å¼è¦ç¯„.md)

---

**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´10æœˆ27æ—¥  
**æœ¬æ–‡æª”åˆä½µäº†å¾Œç«¯é–‹ç™¼ä¸‹çš„æ‰€æœ‰å­æ–‡æª”ï¼ˆ3å€‹ï¼‰**

