# 錯誤處理規範

**適用範圍：** 前後端統一錯誤處理  
**最後更新：** 2025年10月27日

---

## AppError 錯誤類別

```typescript
// errors/AppError.ts
export class AppError extends Error {
  constructor(
    public code: string,
    public message: string,
    public statusCode: number = 500,
    public details?: any
  ) {
    super(message);
    this.name = 'AppError';
  }
}
```

---

## 標準錯誤代碼

| 錯誤代碼 | HTTP | 說明 | 範例 |
|----------|------|------|------|
| `VALIDATION_ERROR` | 422 | 驗證失敗 | 欄位格式不正確 |
| `UNAUTHORIZED` | 401 | 未登入 | Token 無效 |
| `FORBIDDEN` | 403 | 無權限 | 非管理員 |
| `NOT_FOUND` | 404 | 資源不存在 | 客戶不存在 |
| `CONFLICT` | 409 | 資源衝突 | 統一編號已存在 |
| `INTERNAL_ERROR` | 500 | 伺服器錯誤 | 未預期的錯誤 |

---

## 使用範例

### Service 層
```typescript
async getClient(clientId: string): Promise<Client> {
  const client = await this.repository.findById(clientId);
  
  if (!client) {
    throw new AppError('NOT_FOUND', '客戶不存在', 404);
  }
  
  return client;
}

async createClient(data: CreateClientRequest): Promise<Client> {
  if (!data.company_name) {
    throw new AppError('VALIDATION_ERROR', '公司名稱為必填', 422);
  }

  const existing = await this.repository.findById(data.client_id);
  if (existing) {
    throw new AppError('CONFLICT', '統一編號已存在', 409);
  }

  return this.repository.create(data);
}
```

### 全局錯誤處理
```typescript
app.onError((err, c) => {
  console.error('Error:', err);
  
  if (err instanceof AppError) {
    return c.json({
      success: false,
      error: {
        code: err.code,
        message: err.message,
        details: err.details
      }
    }, err.statusCode);
  }
  
  return c.json({
    success: false,
    error: {
      code: 'INTERNAL_ERROR',
      message: '伺服器內部錯誤'
    }
  }, 500);
});
```

---

## 錯誤回應格式

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "客戶不存在",
    "details": {
      "clientId": "12345678"
    }
  }
}
```

---

## 🔗 相關文檔

- [API 共用規範](../API規格/API共用規範.md)
- [錯誤碼速查表](../快速參考/錯誤碼速查表.md)

---

**最後更新：** 2025年10月27日

