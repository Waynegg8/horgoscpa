# 錯誤處理規範

**最後更新：** 2025年10月27日

---

## 統一錯誤類別

```typescript
// utils/errors.ts

export class ValidationError extends Error {
  constructor(message: string, public field?: string) {
    super(message);
    this.name = 'ValidationError';
  }
}

export class NotFoundError extends Error {
  constructor(resource: string, id: any) {
    super(`${resource} ${id} 不存在`);
    this.name = 'NotFoundError';
  }
}

export class UnauthorizedError extends Error {
  constructor(message: string = '未授權') {
    super(message);
    this.name = 'UnauthorizedError';
  }
}

export class ForbiddenError extends Error {
  constructor(message: string = '無權存取') {
    super(message);
    this.name = 'ForbiddenError';
  }
}
```

---

## 統一錯誤處理中間件

```typescript
// middlewares/error.middleware.ts

app.onError((err, c) => {
  if (err instanceof ValidationError) {
    return c.json(errorResponse('VALIDATION_ERROR', err.message), 422);
  }
  
  if (err instanceof NotFoundError) {
    return c.json(errorResponse('NOT_FOUND', err.message), 404);
  }
  
  if (err instanceof UnauthorizedError) {
    return c.json(errorResponse('UNAUTHORIZED', err.message), 401);
  }
  
  if (err instanceof ForbiddenError) {
    return c.json(errorResponse('FORBIDDEN', err.message), 403);
  }
  
  // 未知錯誤
  console.error('Unhandled error:', err);
  return c.json(errorResponse('INTERNAL_ERROR', '系統錯誤'), 500);
});
```

---

## 錯誤回應格式

```typescript
// utils/response.util.ts

export function errorResponse(code: string, message: string, details?: any) {
  return {
    success: false,
    error: { code, message, details }
  };
}
```

### 範例

```json
{
  "success": false,
  "error": {
    "code": "TASK_NOT_FOUND",
    "message": "找不到指定的任務",
    "details": { "task_id": 123 }
  }
}
```

---

## HTTP 狀態碼標準

| 狀態碼 | 用途 | 範例 |
|--------|------|------|
| 200 | 成功 | GET 資料成功 |
| 201 | 建立成功 | POST 新增資料 |
| 204 | 無內容成功 | DELETE 刪除成功 |
| 400 | 請求錯誤 | 參數格式錯誤 |
| 401 | 未授權 | 未登入 |
| 403 | 禁止存取 | 無權限 |
| 404 | 找不到 | 資源不存在 |
| 422 | 驗證錯誤 | 資料驗證失敗 |
| 500 | 伺服器錯誤 | 系統錯誤 |

---

## 使用範例

```typescript
// services/task.service.ts

async getTask(taskId: number) {
  const task = await repo.findById(taskId);
  
  if (!task) {
    throw new NotFoundError('Task', taskId);
  }
  
  return task;
}

async updateTask(taskId: number, data: any) {
  if (!data.title || data.title.length < 3) {
    throw new ValidationError('標題至少需要 3 個字元', 'title');
  }
  
  return await repo.update(taskId, data);
}
```

---

## 相關文檔

- [開發規範](../開發規範.md)
- [後端開發規範](./後端開發規範.md)
- [API 設計](../API設計/README.md)

---

**最後更新：** 2025年10月27日



**最後更新：** 2025年10月27日

---

## 統一錯誤類別

```typescript
// utils/errors.ts

export class ValidationError extends Error {
  constructor(message: string, public field?: string) {
    super(message);
    this.name = 'ValidationError';
  }
}

export class NotFoundError extends Error {
  constructor(resource: string, id: any) {
    super(`${resource} ${id} 不存在`);
    this.name = 'NotFoundError';
  }
}

export class UnauthorizedError extends Error {
  constructor(message: string = '未授權') {
    super(message);
    this.name = 'UnauthorizedError';
  }
}

export class ForbiddenError extends Error {
  constructor(message: string = '無權存取') {
    super(message);
    this.name = 'ForbiddenError';
  }
}
```

---

## 統一錯誤處理中間件

```typescript
// middlewares/error.middleware.ts

app.onError((err, c) => {
  if (err instanceof ValidationError) {
    return c.json(errorResponse('VALIDATION_ERROR', err.message), 422);
  }
  
  if (err instanceof NotFoundError) {
    return c.json(errorResponse('NOT_FOUND', err.message), 404);
  }
  
  if (err instanceof UnauthorizedError) {
    return c.json(errorResponse('UNAUTHORIZED', err.message), 401);
  }
  
  if (err instanceof ForbiddenError) {
    return c.json(errorResponse('FORBIDDEN', err.message), 403);
  }
  
  // 未知錯誤
  console.error('Unhandled error:', err);
  return c.json(errorResponse('INTERNAL_ERROR', '系統錯誤'), 500);
});
```

---

## 錯誤回應格式

```typescript
// utils/response.util.ts

export function errorResponse(code: string, message: string, details?: any) {
  return {
    success: false,
    error: { code, message, details }
  };
}
```

### 範例

```json
{
  "success": false,
  "error": {
    "code": "TASK_NOT_FOUND",
    "message": "找不到指定的任務",
    "details": { "task_id": 123 }
  }
}
```

---

## HTTP 狀態碼標準

| 狀態碼 | 用途 | 範例 |
|--------|------|------|
| 200 | 成功 | GET 資料成功 |
| 201 | 建立成功 | POST 新增資料 |
| 204 | 無內容成功 | DELETE 刪除成功 |
| 400 | 請求錯誤 | 參數格式錯誤 |
| 401 | 未授權 | 未登入 |
| 403 | 禁止存取 | 無權限 |
| 404 | 找不到 | 資源不存在 |
| 422 | 驗證錯誤 | 資料驗證失敗 |
| 500 | 伺服器錯誤 | 系統錯誤 |

---

## 使用範例

```typescript
// services/task.service.ts

async getTask(taskId: number) {
  const task = await repo.findById(taskId);
  
  if (!task) {
    throw new NotFoundError('Task', taskId);
  }
  
  return task;
}

async updateTask(taskId: number, data: any) {
  if (!data.title || data.title.length < 3) {
    throw new ValidationError('標題至少需要 3 個字元', 'title');
  }
  
  return await repo.update(taskId, data);
}
```

---

## 相關文檔

- [開發規範](../開發規範.md)
- [後端開發規範](./後端開發規範.md)
- [API 設計](../API設計/README.md)

---

**最後更新：** 2025年10月27日



