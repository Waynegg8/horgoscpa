# 代碼規範

**最後更新：** 2025年10月27日

---

## 命名規範

### 資料庫命名

```sql
-- 資料表名稱：PascalCase
CREATE TABLE ModulePermissions (...);
CREATE TABLE CompensatoryLeaveBalance (...);
CREATE TABLE OvertimeRates (...);

-- 欄位名稱：snake_case
user_id
is_enabled
created_at
module_name

-- 外鍵欄位：{table}_id
user_id          -- 對應 Users 表
client_id        -- 對應 Clients 表
task_id          -- 對應 Tasks 表

-- 布林欄位：is_{name}
is_active        -- 是否啟用
is_deleted       -- 是否刪除
is_admin         -- 是否管理員
is_enabled       -- 是否啟用

-- 時間欄位：{action}_at
created_at       -- 創建時間
updated_at       -- 更新時間
deleted_at       -- 刪除時間
submitted_at     -- 提交時間
approved_at      -- 批准時間

-- 數量欄位：{name}_count / {name}_hours
hours_worked     -- 工作時數
leave_days       -- 請假天數
task_count       -- 任務數量
```

---

### API 命名

```
-- 路徑：kebab-case
GET  /api/v1/module-permissions
POST /api/v1/leave-types
GET  /api/v1/compensatory-leave/balance

-- 參數和 Body：snake_case
{
  "user_id": 123,
  "is_enabled": true,
  "created_at": "2025-10-27T10:00:00Z"
}

-- 查詢參數：snake_case
?user_id=123&is_active=true&year_month=2025-10
```

---

### TypeScript/JavaScript 命名

```typescript
// 變數：camelCase
const userId = 123;
const leaveBalance = 10;
const isActive = true;

// 函數：camelCase（動詞開頭）
function getUserPermissions() {}
function calculateOvertimePay() {}
function validateLeaveRequest() {}

// 類別：PascalCase
class PermissionService {}
class LeaveCalculator {}
class TimesheetValidator {}

// 介面：PascalCase
interface UserPermission {}
interface LeaveType {}
interface OvertimeRate {}

// 列舉：PascalCase（成員 UPPER_SNAKE_CASE）
enum LeaveStatus {
  PENDING = 'pending',
  APPROVED = 'approved',
  REJECTED = 'rejected'
}

// 常數：UPPER_SNAKE_CASE
const MAX_RETRY_COUNT = 3;
const DEFAULT_PAGE_SIZE = 20;
const API_BASE_URL = '/api/v1';

// 私有變數：前綴 _ (可選)
private _internalState = {};

// 布林變數：is/has/can 開頭
const isAdmin = true;
const hasPermission = false;
const canEdit = true;
```

---

## 檔案命名

### 前端檔案

```
components/
├─ UserCard.tsx           # 元件：PascalCase
├─ LeaveTypeForm.tsx
└─ PermissionTable.tsx

services/
├─ permissionService.ts   # 服務：camelCase + Service
├─ leaveService.ts
└─ timesheetService.ts

utils/
├─ dateHelper.ts          # 工具：camelCase + Helper
├─ validationHelper.ts
└─ formatHelper.ts

types/
├─ permission.types.ts    # 型別：小寫 + .types
├─ leave.types.ts
└─ timesheet.types.ts

pages/
├─ Dashboard.tsx          # 頁面：PascalCase
├─ Settings.tsx
└─ Reports.tsx
```

### 後端檔案

```
repositories/
├─ permissionRepository.ts    # Repository模式
├─ leaveRepository.ts
└─ timesheetRepository.ts

services/
├─ permissionService.ts       # Service模式
├─ leaveService.ts
└─ timesheetService.ts

handlers/
├─ permissionHandler.ts       # Handler模式
├─ leaveHandler.ts
└─ timesheetHandler.ts

routes/
├─ permissionRoutes.ts        # Routes模式
├─ leaveRoutes.ts
└─ timesheetRoutes.ts

middleware/
├─ auth.ts                    # 中介軟體：小寫
├─ validation.ts
└─ errorHandler.ts
```

---

## 架構規範

### 前端架構（Core-Components-Modules-Pages）

```
src/
├─ core/                  # 核心功能
│  ├─ api/                # API 客戶端
│  ├─ auth/               # 認證邏輯
│  └─ utils/              # 共用工具
│
├─ components/            # 共用元件
│  ├─ Button/
│  ├─ Table/
│  └─ Modal/
│
├─ modules/               # 功能模塊
│  ├─ permissions/
│  │  ├─ components/      # 模塊內元件
│  │  ├─ services/        # API 呼叫
│  │  └─ types/           # TypeScript 型別
│  ├─ leave/
│  └─ timesheet/
│
└─ pages/                 # 頁面（路由對應）
   ├─ Dashboard/
   ├─ Settings/
   └─ Reports/
```

---

### 後端架構（Repository-Service-Handler-Routes）

```
src/
├─ repositories/          # 資料存取層
│  └─ permissionRepository.ts
│     // 只負責資料庫操作
│     // 不包含業務邏輯
│
├─ services/             # 業務邏輯層
│  └─ permissionService.ts
│     // 包含業務邏輯
│     // 呼叫 repository
│     // 不直接處理 HTTP
│
├─ handlers/             # 請求處理層
│  └─ permissionHandler.ts
│     // 處理 HTTP 請求/回應
│     // 呼叫 service
│     // 驗證輸入
│
├─ routes/               # 路由定義
│  └─ permissionRoutes.ts
│     // 定義路由
│     // 套用中介軟體
│     // 連接 handler
│
├─ middleware/           # 中介軟體
│  ├─ auth.ts            # 認證
│  ├─ validation.ts      # 驗證
│  └─ errorHandler.ts    # 錯誤處理
│
└─ utils/                # 工具函數
   ├─ db.ts              # 資料庫連接
   └─ logger.ts          # 日誌
```

---

## 代碼風格

### 函數長度

```typescript
// ❌ 錯誤：函數太長（超過 50 行）
function processTimesheet() {
  // 100 行代碼...
}

// ✅ 正確：拆分成多個小函數
function processTimesheet() {
  validateInput();
  calculateHours();
  updateDatabase();
  sendNotification();
}

function validateInput() {
  // 10 行代碼
}
```

---

### 檔案長度

```typescript
// ❌ 錯誤：單一檔案超過 300 行
// permissionService.ts (500 行)

// ✅ 正確：拆分成多個檔案
// permissionService.ts (150 行) - 核心邏輯
// permissionValidator.ts (100 行) - 驗證邏輯
// permissionHelper.ts (80 行) - 輔助函數
```

---

### 註解風格

```typescript
// ✅ 好的註解：說明「為什麼」
// 使用 FIFO 扣除補休，符合勞基法規定
function deductCompensatoryLeave() {}

// ❌ 不好的註解：重複代碼內容
// 設定 userId 為 123
const userId = 123;

/**
 * 計算員工特休天數
 * @param {Date} hireDate - 到職日
 * @param {Date} currentDate - 計算日期
 * @returns {number} 特休天數
 */
function calculateAnnualLeave(hireDate, currentDate) {}
```

---

### 錯誤處理

```typescript
// ✅ 正確：具體的錯誤訊息
if (!userId) {
  throw new Error('USER_ID_REQUIRED');
}

if (leaveBalance < requestedHours) {
  throw new Error('INSUFFICIENT_LEAVE_BALANCE');
}

// ❌ 錯誤：模糊的錯誤訊息
if (!userId) {
  throw new Error('Invalid input');
}
```

---

### 驗證邏輯

```typescript
// ✅ 正確：集中驗證
function validateLeaveRequest(request) {
  const errors = [];
  
  if (!request.userId) {
    errors.push('USER_ID_REQUIRED');
  }
  
  if (!request.leaveType) {
    errors.push('LEAVE_TYPE_REQUIRED');
  }
  
  if (errors.length > 0) {
    throw new ValidationError(errors);
  }
}

// ❌ 錯誤：分散驗證
if (!request.userId) throw new Error('...');
// ... 中間有其他代碼 ...
if (!request.leaveType) throw new Error('...');
```

---

## RESTful API 規範

### HTTP 方法

```
GET    /api/v1/permissions          # 獲取列表
GET    /api/v1/permissions/:id      # 獲取單一資源
POST   /api/v1/permissions          # 創建資源
PUT    /api/v1/permissions/:id      # 完全更新資源
PATCH  /api/v1/permissions/:id      # 部分更新資源
DELETE /api/v1/permissions/:id      # 刪除資源
```

---

### 路徑設計

```
✅ 正確：
GET  /api/v1/users/123/permissions
POST /api/v1/leave-types
GET  /api/v1/compensatory-leave/balance

❌ 錯誤：
GET  /api/v1/getUserPermissions
POST /api/v1/create-leave-type
GET  /api/v1/getCompLeaveBalance
```

---

### 狀態碼

```typescript
200 OK                  // 成功（GET、PATCH、PUT）
201 Created             // 創建成功（POST）
204 No Content          // 刪除成功（DELETE）
400 Bad Request         // 請求參數錯誤
401 Unauthorized        // 未認證
403 Forbidden           // 無權限
404 Not Found           // 資源不存在
409 Conflict            // 資源衝突
422 Unprocessable       // 驗證失敗
500 Internal Error      // 伺服器錯誤
```

---

### 回應格式

```typescript
// ✅ 正確：統一的回應格式
{
  "success": true,
  "data": { ... },
  "message": "操作成功"
}

{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "驗證失敗",
    "details": [...]
  }
}

// ❌ 錯誤：不一致的回應格式
{ "result": ..., "ok": true }
{ "data": ..., "status": "success" }
```

---

## 資料庫規範

### 資料表設計

```sql
-- ✅ 正確：完整的資料表定義
CREATE TABLE ModulePermissions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER,
  module_name TEXT NOT NULL,
  is_enabled BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE(user_id, module_name),
  FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE
);

-- 必備索引
CREATE INDEX idx_permissions_user ON ModulePermissions(user_id);
CREATE INDEX idx_permissions_module ON ModulePermissions(module_name);
```

---

### 查詢規範

```sql
-- ✅ 正確：使用參數化查詢
SELECT * FROM ModulePermissions 
WHERE user_id = ? AND is_enabled = ?;

-- ❌ 錯誤：字串拼接（SQL注入風險）
SELECT * FROM ModulePermissions 
WHERE user_id = ${userId};
```

---

## 檔案大小限制

**嚴格遵守：**
- 每個函數：< 50 行（理想 20-30 行）
- 每個檔案：< 300 行（理想 150-200 行）
- 每個文檔：< 200 行（理想 100-150 行）

**超過限制必須拆分：**
- 函數 > 50 行 → 拆成多個小函數
- 檔案 > 300 行 → 拆成多個模組
- 文檔 > 200 行 → 拆成多個子文檔

---

## Git Commit 規範

```bash
# 格式：<type>: <subject>

# Type 類型：
feat:     # 新功能
fix:      # 修復問題
docs:     # 文檔更新
style:    # 代碼格式（不影響功能）
refactor: # 重構（不是新功能也不是修復）
test:     # 測試相關
chore:    # 建置或工具相關

# 範例：
feat: 新增補休機制
fix: 修復補休餘額計算錯誤
docs: 更新 API 文檔
refactor: 重構權限驗證邏輯
```

---

## 相關文檔

- [AI開發指南](../AI開發指南.md)
- [文檔結構指南](./文檔結構指南.md)
- [開發流程詳解](./開發流程詳解.md)

---

**最後更新：** 2025年10月27日



**最後更新：** 2025年10月27日

---

## 命名規範

### 資料庫命名

```sql
-- 資料表名稱：PascalCase
CREATE TABLE ModulePermissions (...);
CREATE TABLE CompensatoryLeaveBalance (...);
CREATE TABLE OvertimeRates (...);

-- 欄位名稱：snake_case
user_id
is_enabled
created_at
module_name

-- 外鍵欄位：{table}_id
user_id          -- 對應 Users 表
client_id        -- 對應 Clients 表
task_id          -- 對應 Tasks 表

-- 布林欄位：is_{name}
is_active        -- 是否啟用
is_deleted       -- 是否刪除
is_admin         -- 是否管理員
is_enabled       -- 是否啟用

-- 時間欄位：{action}_at
created_at       -- 創建時間
updated_at       -- 更新時間
deleted_at       -- 刪除時間
submitted_at     -- 提交時間
approved_at      -- 批准時間

-- 數量欄位：{name}_count / {name}_hours
hours_worked     -- 工作時數
leave_days       -- 請假天數
task_count       -- 任務數量
```

---

### API 命名

```
-- 路徑：kebab-case
GET  /api/v1/module-permissions
POST /api/v1/leave-types
GET  /api/v1/compensatory-leave/balance

-- 參數和 Body：snake_case
{
  "user_id": 123,
  "is_enabled": true,
  "created_at": "2025-10-27T10:00:00Z"
}

-- 查詢參數：snake_case
?user_id=123&is_active=true&year_month=2025-10
```

---

### TypeScript/JavaScript 命名

```typescript
// 變數：camelCase
const userId = 123;
const leaveBalance = 10;
const isActive = true;

// 函數：camelCase（動詞開頭）
function getUserPermissions() {}
function calculateOvertimePay() {}
function validateLeaveRequest() {}

// 類別：PascalCase
class PermissionService {}
class LeaveCalculator {}
class TimesheetValidator {}

// 介面：PascalCase
interface UserPermission {}
interface LeaveType {}
interface OvertimeRate {}

// 列舉：PascalCase（成員 UPPER_SNAKE_CASE）
enum LeaveStatus {
  PENDING = 'pending',
  APPROVED = 'approved',
  REJECTED = 'rejected'
}

// 常數：UPPER_SNAKE_CASE
const MAX_RETRY_COUNT = 3;
const DEFAULT_PAGE_SIZE = 20;
const API_BASE_URL = '/api/v1';

// 私有變數：前綴 _ (可選)
private _internalState = {};

// 布林變數：is/has/can 開頭
const isAdmin = true;
const hasPermission = false;
const canEdit = true;
```

---

## 檔案命名

### 前端檔案

```
components/
├─ UserCard.tsx           # 元件：PascalCase
├─ LeaveTypeForm.tsx
└─ PermissionTable.tsx

services/
├─ permissionService.ts   # 服務：camelCase + Service
├─ leaveService.ts
└─ timesheetService.ts

utils/
├─ dateHelper.ts          # 工具：camelCase + Helper
├─ validationHelper.ts
└─ formatHelper.ts

types/
├─ permission.types.ts    # 型別：小寫 + .types
├─ leave.types.ts
└─ timesheet.types.ts

pages/
├─ Dashboard.tsx          # 頁面：PascalCase
├─ Settings.tsx
└─ Reports.tsx
```

### 後端檔案

```
repositories/
├─ permissionRepository.ts    # Repository模式
├─ leaveRepository.ts
└─ timesheetRepository.ts

services/
├─ permissionService.ts       # Service模式
├─ leaveService.ts
└─ timesheetService.ts

handlers/
├─ permissionHandler.ts       # Handler模式
├─ leaveHandler.ts
└─ timesheetHandler.ts

routes/
├─ permissionRoutes.ts        # Routes模式
├─ leaveRoutes.ts
└─ timesheetRoutes.ts

middleware/
├─ auth.ts                    # 中介軟體：小寫
├─ validation.ts
└─ errorHandler.ts
```

---

## 架構規範

### 前端架構（Core-Components-Modules-Pages）

```
src/
├─ core/                  # 核心功能
│  ├─ api/                # API 客戶端
│  ├─ auth/               # 認證邏輯
│  └─ utils/              # 共用工具
│
├─ components/            # 共用元件
│  ├─ Button/
│  ├─ Table/
│  └─ Modal/
│
├─ modules/               # 功能模塊
│  ├─ permissions/
│  │  ├─ components/      # 模塊內元件
│  │  ├─ services/        # API 呼叫
│  │  └─ types/           # TypeScript 型別
│  ├─ leave/
│  └─ timesheet/
│
└─ pages/                 # 頁面（路由對應）
   ├─ Dashboard/
   ├─ Settings/
   └─ Reports/
```

---

### 後端架構（Repository-Service-Handler-Routes）

```
src/
├─ repositories/          # 資料存取層
│  └─ permissionRepository.ts
│     // 只負責資料庫操作
│     // 不包含業務邏輯
│
├─ services/             # 業務邏輯層
│  └─ permissionService.ts
│     // 包含業務邏輯
│     // 呼叫 repository
│     // 不直接處理 HTTP
│
├─ handlers/             # 請求處理層
│  └─ permissionHandler.ts
│     // 處理 HTTP 請求/回應
│     // 呼叫 service
│     // 驗證輸入
│
├─ routes/               # 路由定義
│  └─ permissionRoutes.ts
│     // 定義路由
│     // 套用中介軟體
│     // 連接 handler
│
├─ middleware/           # 中介軟體
│  ├─ auth.ts            # 認證
│  ├─ validation.ts      # 驗證
│  └─ errorHandler.ts    # 錯誤處理
│
└─ utils/                # 工具函數
   ├─ db.ts              # 資料庫連接
   └─ logger.ts          # 日誌
```

---

## 代碼風格

### 函數長度

```typescript
// ❌ 錯誤：函數太長（超過 50 行）
function processTimesheet() {
  // 100 行代碼...
}

// ✅ 正確：拆分成多個小函數
function processTimesheet() {
  validateInput();
  calculateHours();
  updateDatabase();
  sendNotification();
}

function validateInput() {
  // 10 行代碼
}
```

---

### 檔案長度

```typescript
// ❌ 錯誤：單一檔案超過 300 行
// permissionService.ts (500 行)

// ✅ 正確：拆分成多個檔案
// permissionService.ts (150 行) - 核心邏輯
// permissionValidator.ts (100 行) - 驗證邏輯
// permissionHelper.ts (80 行) - 輔助函數
```

---

### 註解風格

```typescript
// ✅ 好的註解：說明「為什麼」
// 使用 FIFO 扣除補休，符合勞基法規定
function deductCompensatoryLeave() {}

// ❌ 不好的註解：重複代碼內容
// 設定 userId 為 123
const userId = 123;

/**
 * 計算員工特休天數
 * @param {Date} hireDate - 到職日
 * @param {Date} currentDate - 計算日期
 * @returns {number} 特休天數
 */
function calculateAnnualLeave(hireDate, currentDate) {}
```

---

### 錯誤處理

```typescript
// ✅ 正確：具體的錯誤訊息
if (!userId) {
  throw new Error('USER_ID_REQUIRED');
}

if (leaveBalance < requestedHours) {
  throw new Error('INSUFFICIENT_LEAVE_BALANCE');
}

// ❌ 錯誤：模糊的錯誤訊息
if (!userId) {
  throw new Error('Invalid input');
}
```

---

### 驗證邏輯

```typescript
// ✅ 正確：集中驗證
function validateLeaveRequest(request) {
  const errors = [];
  
  if (!request.userId) {
    errors.push('USER_ID_REQUIRED');
  }
  
  if (!request.leaveType) {
    errors.push('LEAVE_TYPE_REQUIRED');
  }
  
  if (errors.length > 0) {
    throw new ValidationError(errors);
  }
}

// ❌ 錯誤：分散驗證
if (!request.userId) throw new Error('...');
// ... 中間有其他代碼 ...
if (!request.leaveType) throw new Error('...');
```

---

## RESTful API 規範

### HTTP 方法

```
GET    /api/v1/permissions          # 獲取列表
GET    /api/v1/permissions/:id      # 獲取單一資源
POST   /api/v1/permissions          # 創建資源
PUT    /api/v1/permissions/:id      # 完全更新資源
PATCH  /api/v1/permissions/:id      # 部分更新資源
DELETE /api/v1/permissions/:id      # 刪除資源
```

---

### 路徑設計

```
✅ 正確：
GET  /api/v1/users/123/permissions
POST /api/v1/leave-types
GET  /api/v1/compensatory-leave/balance

❌ 錯誤：
GET  /api/v1/getUserPermissions
POST /api/v1/create-leave-type
GET  /api/v1/getCompLeaveBalance
```

---

### 狀態碼

```typescript
200 OK                  // 成功（GET、PATCH、PUT）
201 Created             // 創建成功（POST）
204 No Content          // 刪除成功（DELETE）
400 Bad Request         // 請求參數錯誤
401 Unauthorized        // 未認證
403 Forbidden           // 無權限
404 Not Found           // 資源不存在
409 Conflict            // 資源衝突
422 Unprocessable       // 驗證失敗
500 Internal Error      // 伺服器錯誤
```

---

### 回應格式

```typescript
// ✅ 正確：統一的回應格式
{
  "success": true,
  "data": { ... },
  "message": "操作成功"
}

{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "驗證失敗",
    "details": [...]
  }
}

// ❌ 錯誤：不一致的回應格式
{ "result": ..., "ok": true }
{ "data": ..., "status": "success" }
```

---

## 資料庫規範

### 資料表設計

```sql
-- ✅ 正確：完整的資料表定義
CREATE TABLE ModulePermissions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER,
  module_name TEXT NOT NULL,
  is_enabled BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE(user_id, module_name),
  FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE
);

-- 必備索引
CREATE INDEX idx_permissions_user ON ModulePermissions(user_id);
CREATE INDEX idx_permissions_module ON ModulePermissions(module_name);
```

---

### 查詢規範

```sql
-- ✅ 正確：使用參數化查詢
SELECT * FROM ModulePermissions 
WHERE user_id = ? AND is_enabled = ?;

-- ❌ 錯誤：字串拼接（SQL注入風險）
SELECT * FROM ModulePermissions 
WHERE user_id = ${userId};
```

---

## 檔案大小限制

**嚴格遵守：**
- 每個函數：< 50 行（理想 20-30 行）
- 每個檔案：< 300 行（理想 150-200 行）
- 每個文檔：< 200 行（理想 100-150 行）

**超過限制必須拆分：**
- 函數 > 50 行 → 拆成多個小函數
- 檔案 > 300 行 → 拆成多個模組
- 文檔 > 200 行 → 拆成多個子文檔

---

## Git Commit 規範

```bash
# 格式：<type>: <subject>

# Type 類型：
feat:     # 新功能
fix:      # 修復問題
docs:     # 文檔更新
style:    # 代碼格式（不影響功能）
refactor: # 重構（不是新功能也不是修復）
test:     # 測試相關
chore:    # 建置或工具相關

# 範例：
feat: 新增補休機制
fix: 修復補休餘額計算錯誤
docs: 更新 API 文檔
refactor: 重構權限驗證邏輯
```

---

## 相關文檔

- [AI開發指南](../AI開發指南.md)
- [文檔結構指南](./文檔結構指南.md)
- [開發流程詳解](./開發流程詳解.md)

---

**最後更新：** 2025年10月27日



