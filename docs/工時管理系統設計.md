# å·¥æ™‚ç®¡ç†ç³»çµ±è¨­è¨ˆ

**ç‰ˆæœ¬**: 1.0  
**æœ€å¾Œæ›´æ–°**: 2025-10-26

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·¥æ™‚ç®¡ç†ç³»çµ±ç”¨æ–¼è¨˜éŒ„å“¡å·¥æ¯æ—¥å·¥ä½œæ™‚æ•¸ã€åŠ ç­æ™‚æ•¸ã€è«‹å‡è¨˜éŒ„ï¼Œä¸¦è‡ªå‹•è¨ˆç®—å¹´å‡ã€åŠ ç­è²»ç­‰ã€‚

### æ ¸å¿ƒåŠŸèƒ½
- æ¯æ—¥å·¥æ™‚è¨˜éŒ„
- åŠ ç­æ™‚æ•¸ç®¡ç†
- è«‹å‡ç”³è«‹èˆ‡è¨˜éŒ„
- å¹´å‡è‡ªå‹•è©¦ç®—èˆ‡çµè½‰
- å·¥æ™‚å ±è¡¨çµ±è¨ˆ

---

## ğŸ—„ï¸ è³‡æ–™è¡¨çµæ§‹

### employees (å“¡å·¥åŸºæœ¬è³‡æ–™)
```sql
CREATE TABLE employees (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  department TEXT,
  position TEXT,
  hire_date DATE,
  status TEXT DEFAULT 'active',      -- active, resigned
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### timesheets (å·¥æ™‚è¨˜éŒ„)
```sql
CREATE TABLE timesheets (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  employee_id INTEGER NOT NULL,
  date DATE NOT NULL,                -- å·¥ä½œæ—¥æœŸ
  regular_hours REAL DEFAULT 0,      -- æ­£å¸¸å·¥æ™‚
  overtime_hours REAL DEFAULT 0,     -- åŠ ç­å·¥æ™‚
  status TEXT DEFAULT 'draft',       -- draft, submitted, approved
  notes TEXT,                        -- å‚™è¨»
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(employee_id, date),         -- æ¯äººæ¯å¤©ä¸€ç­†è¨˜éŒ„
  FOREIGN KEY (employee_id) REFERENCES employees(id)
);
```

### leave_events (è«‹å‡è¨˜éŒ„)
```sql
CREATE TABLE leave_events (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  employee_id INTEGER NOT NULL,
  leave_type TEXT NOT NULL,          -- annual, sick, personal, etc.
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  hours REAL NOT NULL,               -- è«‹å‡æ™‚æ•¸
  status TEXT DEFAULT 'pending',     -- pending, approved, rejected
  reason TEXT,
  approved_by INTEGER,
  approved_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (employee_id) REFERENCES employees(id),
  FOREIGN KEY (approved_by) REFERENCES users(id)
);
```

### leave_types (å‡åˆ¥é¡å‹)
```sql
CREATE TABLE leave_types (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  code TEXT NOT NULL UNIQUE,         -- annual, sick, personal
  name TEXT NOT NULL,                -- å¹´å‡ã€ç—…å‡ã€äº‹å‡
  is_paid BOOLEAN DEFAULT 1,         -- æ˜¯å¦æ”¯è–ª
  requires_approval BOOLEAN DEFAULT 1,
  max_hours_per_year REAL,           -- å¹´åº¦ä¸Šé™æ™‚æ•¸
  description TEXT
);
```

### annual_leave_rules (å¹´å‡è¦å‰‡)
```sql
CREATE TABLE annual_leave_rules (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  years_of_service_min INTEGER NOT NULL,  -- å¹´è³‡ä¸‹é™
  years_of_service_max INTEGER,           -- å¹´è³‡ä¸Šé™
  days INTEGER NOT NULL,                  -- å‡å¤©æ•¸
  description TEXT
);
```

### annual_leave_carryover (å¹´å‡çµè½‰)
```sql
CREATE TABLE annual_leave_carryover (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  employee_id INTEGER NOT NULL,
  year INTEGER NOT NULL,             -- å¹´åº¦
  earned_days REAL,                  -- ç•¶å¹´æ‡‰å¾—å¤©æ•¸
  carried_over_days REAL,            -- ä¸Šå¹´çµè½‰å¤©æ•¸
  used_days REAL,                    -- å·²ä½¿ç”¨å¤©æ•¸
  remaining_days REAL,               -- å‰©é¤˜å¤©æ•¸
  UNIQUE(employee_id, year),
  FOREIGN KEY (employee_id) REFERENCES employees(id)
);
```

### overtime_rates (åŠ ç­è²»ç‡)
```sql
CREATE TABLE overtime_rates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  day_type TEXT NOT NULL,            -- weekday, weekend, holiday
  rate_multiplier REAL NOT NULL,     -- å€ç‡ï¼š1.34, 1.67, 2.0
  description TEXT
);
```

### holidays (åœ‹å®šå‡æ—¥)
```sql
CREATE TABLE holidays (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  date DATE NOT NULL UNIQUE,
  name TEXT NOT NULL,                -- å‡æ—¥åç¨±
  is_compensatory BOOLEAN DEFAULT 0  -- æ˜¯å¦ç‚ºè£œå‡
);
```

---

## ğŸ”„ æ¥­å‹™æµç¨‹

### å·¥æ™‚è¨˜éŒ„æµç¨‹
```
1. å“¡å·¥æ¯æ—¥è¨˜éŒ„å·¥æ™‚
   - é¸æ“‡æ—¥æœŸ
   - è¼¸å…¥æ­£å¸¸å·¥æ™‚
   - è¼¸å…¥åŠ ç­å·¥æ™‚ï¼ˆå¦‚æœ‰ï¼‰
   - å¡«å¯«å‚™è¨»
   â†“
2. å„²å­˜å·¥æ™‚è¨˜éŒ„
   - INSERT OR UPDATE timesheets
   - ç‹€æ…‹è¨­ç‚º draft
   â†“
3. æäº¤å¯©æ ¸ï¼ˆå¯é¸ï¼‰
   - UPDATE status = 'submitted'
   â†“
4. ä¸»ç®¡å¯©æ ¸
   - æŸ¥çœ‹å·¥æ™‚è¨˜éŒ„
   - UPDATE status = 'approved'
```

### è«‹å‡ç”³è«‹æµç¨‹
```
1. å“¡å·¥æäº¤è«‹å‡ç”³è«‹
   - é¸æ“‡å‡åˆ¥
   - é¸æ“‡æ—¥æœŸç¯„åœ
   - è¼¸å…¥è«‹å‡åŸå› 
   â†“
2. ç³»çµ±è¨ˆç®—è«‹å‡æ™‚æ•¸
   - è¨ˆç®—å·¥ä½œæ—¥å¤©æ•¸
   - æ’é™¤å‡æ—¥
   â†“
3. æª¢æŸ¥å¹´å‡é¤˜é¡ï¼ˆå¦‚ç‚ºå¹´å‡ï¼‰
   - æŸ¥è©¢ annual_leave_carryover
   - ç¢ºèªé¤˜é¡è¶³å¤ 
   â†“
4. æäº¤å¯©æ ¸
   - INSERT INTO leave_events
   - status = 'pending'
   â†“
5. ä¸»ç®¡å¯©æ ¸
   - æ‰¹å‡†ï¼šUPDATE status = 'approved'
   - æ‹’çµ•ï¼šUPDATE status = 'rejected'
   â†“
6. æ‰£é™¤å‡æœŸé¤˜é¡
   - UPDATE annual_leave_carryover
   - used_days += è«‹å‡å¤©æ•¸
```

### å¹´å‡è©¦ç®—æµç¨‹
```
1. è¨ˆç®—å¹´è³‡
   - å¾ hire_date è¨ˆç®—åˆ°ç•¶å‰æ—¥æœŸ
   â†“
2. æŸ¥è©¢å¹´å‡è¦å‰‡
   - SELECT FROM annual_leave_rules
   - ä¾å¹´è³‡åŒ¹é…è¦å‰‡
   â†“
3. è¨ˆç®—ç•¶å¹´æ‡‰å¾—å¤©æ•¸
   - ä¾è¦å‰‡è¨ˆç®—
   - è€ƒæ…®åˆ°è·æœˆä»½ï¼ˆæŒ‰æ¯”ä¾‹ï¼‰
   â†“
4. æŸ¥è©¢å·²ä½¿ç”¨å¤©æ•¸
   - SUM leave_events WHERE leave_type = 'annual'
   â†“
5. è¨ˆç®—å‰©é¤˜å¤©æ•¸
   - å‰©é¤˜ = æ‡‰å¾— + çµè½‰ - å·²ä½¿ç”¨
```

---

## ğŸ”Œ API è¨­è¨ˆ

### è¨˜éŒ„å·¥æ™‚
```
POST /api/timesheets

Request:
{
  "employee_id": 1,
  "date": "2025-10-26",
  "regular_hours": 8,
  "overtime_hours": 2,
  "notes": "å°ˆæ¡ˆåŠ ç­"
}

Response:
{
  "success": true,
  "timesheet_id": 123
}
```

### ç²å–å·¥æ™‚è¨˜éŒ„
```
GET /api/timesheets?employee_id=1&month=2025-10

Response:
{
  "success": true,
  "timesheets": [
    {
      "id": 123,
      "date": "2025-10-26",
      "regular_hours": 8,
      "overtime_hours": 2,
      "status": "approved"
    }
  ],
  "summary": {
    "total_regular_hours": 160,
    "total_overtime_hours": 20,
    "total_days": 20
  }
}
```

### è«‹å‡ç”³è«‹
```
POST /api/leave-events

Request:
{
  "employee_id": 1,
  "leave_type": "annual",
  "start_date": "2025-11-01",
  "end_date": "2025-11-03",
  "reason": "å®¶åº­æ—…éŠ"
}

Response:
{
  "success": true,
  "leave_event_id": 45,
  "hours": 24,
  "remaining_annual_leave": 56
}
```

### å¹´å‡è©¦ç®—
```
GET /api/annual-leave/calculate?employee_id=1

Response:
{
  "success": true,
  "employee_id": 1,
  "years_of_service": 3.5,
  "earned_days": 10,
  "carried_over_days": 5,
  "used_days": 4,
  "remaining_days": 11,
  "expiry_date": "2025-12-31"
}
```

---

## ğŸ’» å‰ç«¯è¨­è¨ˆ

### é é¢ï¼štimesheet.html

#### æœˆæ›†è¦–åœ–
```
é¡¯ç¤ºç•¶æœˆæ¯æ—¥å·¥æ™‚
- æ­£å¸¸å·¥æ™‚ï¼šç¶ è‰²
- åŠ ç­å·¥æ™‚ï¼šæ©™è‰²
- è«‹å‡ï¼šè—è‰²
- å‡æ—¥ï¼šç°è‰²
```

#### å·¥æ™‚è¼¸å…¥è¡¨å–®
```
æ—¥æœŸé¸æ“‡å™¨
æ­£å¸¸å·¥æ™‚è¼¸å…¥
åŠ ç­å·¥æ™‚è¼¸å…¥
å‚™è¨»æ¬„ä½
[å„²å­˜] [æäº¤å¯©æ ¸]
```

#### çµ±è¨ˆé¢æ¿
```
æœ¬æœˆçµ±è¨ˆï¼š
- ç¸½å·¥æ™‚ï¼š168 å°æ™‚
- åŠ ç­æ™‚æ•¸ï¼š20 å°æ™‚
- è«‹å‡å¤©æ•¸ï¼š2 å¤©

å¹´å‡é¤˜é¡ï¼š
- å¯ç”¨ï¼š11 å¤©
- å·²ç”¨ï¼š4 å¤©
- ç¸½è¨ˆï¼š15 å¤©
```

---

## ğŸ“Š å ±è¡¨åŠŸèƒ½

### å€‹äººå·¥æ™‚å ±è¡¨
```sql
-- æœˆåº¦å·¥æ™‚çµ±è¨ˆ
SELECT 
  strftime('%Y-%m', date) as month,
  SUM(regular_hours) as total_regular,
  SUM(overtime_hours) as total_overtime,
  COUNT(DISTINCT date) as work_days
FROM timesheets
WHERE employee_id = ?
GROUP BY month
ORDER BY month DESC;
```

### éƒ¨é–€å·¥æ™‚çµ±è¨ˆ
```sql
-- éƒ¨é–€åŠ ç­çµ±è¨ˆ
SELECT 
  e.department,
  COUNT(DISTINCT e.id) as employee_count,
  SUM(t.overtime_hours) as total_overtime
FROM employees e
JOIN timesheets t ON e.id = t.employee_id
WHERE strftime('%Y-%m', t.date) = ?
GROUP BY e.department
ORDER BY total_overtime DESC;
```

### å¹´å‡ä½¿ç”¨çµ±è¨ˆ
```sql
-- å¹´å‡ä½¿ç”¨ç‡
SELECT 
  e.id,
  e.name,
  alc.earned_days,
  alc.used_days,
  alc.remaining_days,
  ROUND(alc.used_days * 100.0 / alc.earned_days, 2) as usage_rate
FROM employees e
JOIN annual_leave_carryover alc ON e.id = alc.employee_id
WHERE alc.year = ?
ORDER BY usage_rate DESC;
```

---

## ğŸ”§ è¨ˆç®—é‚è¼¯

### å¹´å‡è¨ˆç®—è¦å‰‡ï¼ˆå°ç£å‹åŸºæ³•ï¼‰
```javascript
function calculateAnnualLeave(hireDate) {
  const yearsOfService = calculateYearsOfService(hireDate);
  
  // æœªæ»¿åŠå¹´ï¼š0å¤©
  if (yearsOfService < 0.5) return 0;
  
  // 6å€‹æœˆä»¥ä¸Šæœªæ»¿1å¹´ï¼š3å¤©
  if (yearsOfService < 1) return 3;
  
  // 1å¹´ä»¥ä¸Šæœªæ»¿2å¹´ï¼š7å¤©
  if (yearsOfService < 2) return 7;
  
  // 2å¹´ä»¥ä¸Šæœªæ»¿3å¹´ï¼š10å¤©
  if (yearsOfService < 3) return 10;
  
  // 3å¹´ä»¥ä¸Šï¼Œæ¯å¹´åŠ 1å¤©ï¼Œæœ€å¤š30å¤©
  const days = 10 + Math.floor(yearsOfService - 2);
  return Math.min(days, 30);
}
```

### åŠ ç­è²»è¨ˆç®—
```javascript
function calculateOvertimePay(hours, dayType, hourlyRate) {
  const rates = {
    weekday: 1.34,  // å¹³æ—¥å»¶é•·å·¥æ™‚
    weekend: 1.67,  // ä¼‘æ¯æ—¥
    holiday: 2.0    // ä¾‹å‡æ—¥
  };
  
  return hours * hourlyRate * rates[dayType];
}
```

### å·¥ä½œæ—¥è¨ˆç®—ï¼ˆæ’é™¤å‡æ—¥ï¼‰
```javascript
async function calculateWorkDays(startDate, endDate) {
  // å–å¾—æœŸé–“å…§çš„å‡æ—¥
  const holidays = await getHolidays(startDate, endDate);
  
  let workDays = 0;
  let currentDate = new Date(startDate);
  
  while (currentDate <= endDate) {
    const dayOfWeek = currentDate.getDay();
    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
    const isHoliday = holidays.includes(currentDate.toISOString().split('T')[0]);
    
    if (!isWeekend && !isHoliday) {
      workDays++;
    }
    
    currentDate.setDate(currentDate.getDate() + 1);
  }
  
  return workDays;
}
```

---

## âš ï¸ å¯¦æ–½å•é¡Œèˆ‡ä¿®å¾©

### ç™¼ç¾çš„å•é¡Œï¼ˆ2025-10-26ï¼‰

**å•é¡Œï¼štimesheet-page.js ä»£ç¢¼ä¸å®Œæ•´**

ç¼ºå¤±çš„é—œéµå‡½æ•¸ï¼ˆåœ¨ HTML ä¸­è¢«å¼•ç”¨ä½†æœªå¯¦ç¾ï¼‰ï¼š
1. `showAddWorkModal()` - é¡¯ç¤ºæ–°å¢å·¥æ™‚å°è©±æ¡†
2. `hideAddWorkModal()` - éš±è—æ–°å¢å·¥æ™‚å°è©±æ¡†  
3. `showAddLeaveModal()` - é¡¯ç¤ºæ–°å¢è«‹å‡å°è©±æ¡†
4. `hideAddLeaveModal()` - éš±è—æ–°å¢è«‹å‡å°è©±æ¡†
5. `confirmAddWork()` - ç¢ºèªæ–°å¢å·¥æ™‚è¨˜éŒ„
6. `confirmAddLeave()` - ç¢ºèªæ–°å¢è«‹å‡è¨˜éŒ„
7. `deleteEntry(type, index)` - åˆªé™¤å·¥æ™‚/è«‹å‡è¨˜éŒ„
8. `updateCellValue(type, index, day, value)` - æ›´æ–°å–®å…ƒæ ¼æ•¸å€¼
9. `addDailyTotalRow(daysInMonth)` - æ–°å¢æ¯æ—¥ç¸½è¨ˆåˆ—ï¼ˆåªæœ‰ç©ºæ®¼ï¼‰

**ä¿®å¾©æ–¹æ¡ˆ**ï¼š
- è£œå…¨æ‰€æœ‰ç¼ºå¤±å‡½æ•¸çš„å¯¦ç¾
- ç¢ºä¿èˆ‡ HTML ä¸­çš„äº‹ä»¶ç¶å®šåŒ¹é…
- ä½¿ç”¨å…±ç”¨æ¨¡çµ„çš„ `apiRequest`, `showNotification` ç­‰å‡½æ•¸
- æ·»åŠ é©ç•¶çš„éŒ¯èª¤è™•ç†

**å„ªå…ˆç´š**ï¼šé«˜ï¼ˆå½±éŸ¿æ ¸å¿ƒåŠŸèƒ½ï¼‰

---

## ğŸš€ æœªä¾†æ“´å±•

### è¨ˆåŠƒåŠŸèƒ½
- [ ] è¡Œå‹•è£ç½®æ‰“å¡æ•´åˆ
- [ ] GPS å®šä½æ‰“å¡
- [ ] æ’ç­ç®¡ç†
- [ ] è–ªè³‡æ•´åˆ
- [ ] å½ˆæ€§å·¥æ™‚åˆ¶åº¦
- [ ] é è·å·¥ä½œæ™‚æ•¸è¿½è¹¤

---

**ç›¸é—œæ–‡æª”**ï¼š
- [ç³»çµ±æ¶æ§‹è¨­è¨ˆ.md](./ç³»çµ±æ¶æ§‹è¨­è¨ˆ.md) - æ•´é«”æ¶æ§‹
- [APIç«¯é»æ–‡æª”.md](./APIç«¯é»æ–‡æª”.md) - å®Œæ•´ API åƒè€ƒ

