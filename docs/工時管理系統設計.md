# 工時管理系統設計

**版本**: 1.0  
**最後更新**: 2025-10-26

---

## 📋 功能概述

工時管理系統用於記錄員工每日工作時數、加班時數、請假記錄，並自動計算年假、加班費等。

### 核心功能
- 每日工時記錄
- 加班時數管理
- 請假申請與記錄
- 年假自動試算與結轉
- 工時報表統計

---

## 🗄️ 資料表結構

### employees (員工基本資料)
```sql
CREATE TABLE employees (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  department TEXT,
  position TEXT,
  hire_date DATE,
  status TEXT DEFAULT 'active',      -- active, resigned
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### timesheets (工時記錄)
```sql
CREATE TABLE timesheets (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  employee_id INTEGER NOT NULL,
  date DATE NOT NULL,                -- 工作日期
  regular_hours REAL DEFAULT 0,      -- 正常工時
  overtime_hours REAL DEFAULT 0,     -- 加班工時
  status TEXT DEFAULT 'draft',       -- draft, submitted, approved
  notes TEXT,                        -- 備註
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(employee_id, date),         -- 每人每天一筆記錄
  FOREIGN KEY (employee_id) REFERENCES employees(id)
);
```

### leave_events (請假記錄)
```sql
CREATE TABLE leave_events (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  employee_id INTEGER NOT NULL,
  leave_type TEXT NOT NULL,          -- annual, sick, personal, etc.
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  hours REAL NOT NULL,               -- 請假時數
  status TEXT DEFAULT 'pending',     -- pending, approved, rejected
  reason TEXT,
  approved_by INTEGER,
  approved_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (employee_id) REFERENCES employees(id),
  FOREIGN KEY (approved_by) REFERENCES users(id)
);
```

### leave_types (假別類型)
```sql
CREATE TABLE leave_types (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  code TEXT NOT NULL UNIQUE,         -- annual, sick, personal
  name TEXT NOT NULL,                -- 年假、病假、事假
  is_paid BOOLEAN DEFAULT 1,         -- 是否支薪
  requires_approval BOOLEAN DEFAULT 1,
  max_hours_per_year REAL,           -- 年度上限時數
  description TEXT
);
```

### annual_leave_rules (年假規則)
```sql
CREATE TABLE annual_leave_rules (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  years_of_service_min INTEGER NOT NULL,  -- 年資下限
  years_of_service_max INTEGER,           -- 年資上限
  days INTEGER NOT NULL,                  -- 假天數
  description TEXT
);
```

### annual_leave_carryover (年假結轉)
```sql
CREATE TABLE annual_leave_carryover (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  employee_id INTEGER NOT NULL,
  year INTEGER NOT NULL,             -- 年度
  earned_days REAL,                  -- 當年應得天數
  carried_over_days REAL,            -- 上年結轉天數
  used_days REAL,                    -- 已使用天數
  remaining_days REAL,               -- 剩餘天數
  UNIQUE(employee_id, year),
  FOREIGN KEY (employee_id) REFERENCES employees(id)
);
```

### overtime_rates (加班費率)
```sql
CREATE TABLE overtime_rates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  day_type TEXT NOT NULL,            -- weekday, weekend, holiday
  rate_multiplier REAL NOT NULL,     -- 倍率：1.34, 1.67, 2.0
  description TEXT
);
```

### holidays (國定假日)
```sql
CREATE TABLE holidays (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  date DATE NOT NULL UNIQUE,
  name TEXT NOT NULL,                -- 假日名稱
  is_compensatory BOOLEAN DEFAULT 0  -- 是否為補假
);
```

---

## 🔄 業務流程

### 工時記錄流程
```
1. 員工每日記錄工時
   - 選擇日期
   - 輸入正常工時
   - 輸入加班工時（如有）
   - 填寫備註
   ↓
2. 儲存工時記錄
   - INSERT OR UPDATE timesheets
   - 狀態設為 draft
   ↓
3. 提交審核（可選）
   - UPDATE status = 'submitted'
   ↓
4. 主管審核
   - 查看工時記錄
   - UPDATE status = 'approved'
```

### 請假申請流程
```
1. 員工提交請假申請
   - 選擇假別
   - 選擇日期範圍
   - 輸入請假原因
   ↓
2. 系統計算請假時數
   - 計算工作日天數
   - 排除假日
   ↓
3. 檢查年假餘額（如為年假）
   - 查詢 annual_leave_carryover
   - 確認餘額足夠
   ↓
4. 提交審核
   - INSERT INTO leave_events
   - status = 'pending'
   ↓
5. 主管審核
   - 批准：UPDATE status = 'approved'
   - 拒絕：UPDATE status = 'rejected'
   ↓
6. 扣除假期餘額
   - UPDATE annual_leave_carryover
   - used_days += 請假天數
```

### 年假試算流程
```
1. 計算年資
   - 從 hire_date 計算到當前日期
   ↓
2. 查詢年假規則
   - SELECT FROM annual_leave_rules
   - 依年資匹配規則
   ↓
3. 計算當年應得天數
   - 依規則計算
   - 考慮到職月份（按比例）
   ↓
4. 查詢已使用天數
   - SUM leave_events WHERE leave_type = 'annual'
   ↓
5. 計算剩餘天數
   - 剩餘 = 應得 + 結轉 - 已使用
```

---

## 🔌 API 設計

### 記錄工時
```
POST /api/timesheets

Request:
{
  "employee_id": 1,
  "date": "2025-10-26",
  "regular_hours": 8,
  "overtime_hours": 2,
  "notes": "專案加班"
}

Response:
{
  "success": true,
  "timesheet_id": 123
}
```

### 獲取工時記錄
```
GET /api/timesheets?employee_id=1&month=2025-10

Response:
{
  "success": true,
  "timesheets": [
    {
      "id": 123,
      "date": "2025-10-26",
      "regular_hours": 8,
      "overtime_hours": 2,
      "status": "approved"
    }
  ],
  "summary": {
    "total_regular_hours": 160,
    "total_overtime_hours": 20,
    "total_days": 20
  }
}
```

### 請假申請
```
POST /api/leave-events

Request:
{
  "employee_id": 1,
  "leave_type": "annual",
  "start_date": "2025-11-01",
  "end_date": "2025-11-03",
  "reason": "家庭旅遊"
}

Response:
{
  "success": true,
  "leave_event_id": 45,
  "hours": 24,
  "remaining_annual_leave": 56
}
```

### 年假試算
```
GET /api/annual-leave/calculate?employee_id=1

Response:
{
  "success": true,
  "employee_id": 1,
  "years_of_service": 3.5,
  "earned_days": 10,
  "carried_over_days": 5,
  "used_days": 4,
  "remaining_days": 11,
  "expiry_date": "2025-12-31"
}
```

---

## 💻 前端設計

### 頁面：timesheet.html

#### 月曆視圖
```
顯示當月每日工時
- 正常工時：綠色
- 加班工時：橙色
- 請假：藍色
- 假日：灰色
```

#### 工時輸入表單
```
日期選擇器
正常工時輸入
加班工時輸入
備註欄位
[儲存] [提交審核]
```

#### 統計面板
```
本月統計：
- 總工時：168 小時
- 加班時數：20 小時
- 請假天數：2 天

年假餘額：
- 可用：11 天
- 已用：4 天
- 總計：15 天
```

---

## 📊 報表功能

### 個人工時報表
```sql
-- 月度工時統計
SELECT 
  strftime('%Y-%m', date) as month,
  SUM(regular_hours) as total_regular,
  SUM(overtime_hours) as total_overtime,
  COUNT(DISTINCT date) as work_days
FROM timesheets
WHERE employee_id = ?
GROUP BY month
ORDER BY month DESC;
```

### 部門工時統計
```sql
-- 部門加班統計
SELECT 
  e.department,
  COUNT(DISTINCT e.id) as employee_count,
  SUM(t.overtime_hours) as total_overtime
FROM employees e
JOIN timesheets t ON e.id = t.employee_id
WHERE strftime('%Y-%m', t.date) = ?
GROUP BY e.department
ORDER BY total_overtime DESC;
```

### 年假使用統計
```sql
-- 年假使用率
SELECT 
  e.id,
  e.name,
  alc.earned_days,
  alc.used_days,
  alc.remaining_days,
  ROUND(alc.used_days * 100.0 / alc.earned_days, 2) as usage_rate
FROM employees e
JOIN annual_leave_carryover alc ON e.id = alc.employee_id
WHERE alc.year = ?
ORDER BY usage_rate DESC;
```

---

## 🔧 計算邏輯

### 年假計算規則（台灣勞基法）
```javascript
function calculateAnnualLeave(hireDate) {
  const yearsOfService = calculateYearsOfService(hireDate);
  
  // 未滿半年：0天
  if (yearsOfService < 0.5) return 0;
  
  // 6個月以上未滿1年：3天
  if (yearsOfService < 1) return 3;
  
  // 1年以上未滿2年：7天
  if (yearsOfService < 2) return 7;
  
  // 2年以上未滿3年：10天
  if (yearsOfService < 3) return 10;
  
  // 3年以上，每年加1天，最多30天
  const days = 10 + Math.floor(yearsOfService - 2);
  return Math.min(days, 30);
}
```

### 加班費計算
```javascript
function calculateOvertimePay(hours, dayType, hourlyRate) {
  const rates = {
    weekday: 1.34,  // 平日延長工時
    weekend: 1.67,  // 休息日
    holiday: 2.0    // 例假日
  };
  
  return hours * hourlyRate * rates[dayType];
}
```

### 工作日計算（排除假日）
```javascript
async function calculateWorkDays(startDate, endDate) {
  // 取得期間內的假日
  const holidays = await getHolidays(startDate, endDate);
  
  let workDays = 0;
  let currentDate = new Date(startDate);
  
  while (currentDate <= endDate) {
    const dayOfWeek = currentDate.getDay();
    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
    const isHoliday = holidays.includes(currentDate.toISOString().split('T')[0]);
    
    if (!isWeekend && !isHoliday) {
      workDays++;
    }
    
    currentDate.setDate(currentDate.getDate() + 1);
  }
  
  return workDays;
}
```

---

## ⚠️ 實施問題與修復

### 發現的問題（2025-10-26）

**問題：timesheet-page.js 代碼不完整**

缺失的關鍵函數（在 HTML 中被引用但未實現）：
1. `showAddWorkModal()` - 顯示新增工時對話框
2. `hideAddWorkModal()` - 隱藏新增工時對話框  
3. `showAddLeaveModal()` - 顯示新增請假對話框
4. `hideAddLeaveModal()` - 隱藏新增請假對話框
5. `confirmAddWork()` - 確認新增工時記錄
6. `confirmAddLeave()` - 確認新增請假記錄
7. `deleteEntry(type, index)` - 刪除工時/請假記錄
8. `updateCellValue(type, index, day, value)` - 更新單元格數值
9. `addDailyTotalRow(daysInMonth)` - 新增每日總計列（只有空殼）

**修復方案**：
- 補全所有缺失函數的實現
- 確保與 HTML 中的事件綁定匹配
- 使用共用模組的 `apiRequest`, `showNotification` 等函數
- 添加適當的錯誤處理

**優先級**：高（影響核心功能）

---

## 🚀 未來擴展

### 計劃功能
- [ ] 行動裝置打卡整合
- [ ] GPS 定位打卡
- [ ] 排班管理
- [ ] 薪資整合
- [ ] 彈性工時制度
- [ ] 遠距工作時數追蹤

---

**相關文檔**：
- [系統架構設計.md](./系統架構設計.md) - 整體架構
- [API端點文檔.md](./API端點文檔.md) - 完整 API 參考

