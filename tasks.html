<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="任務管理" />
    <title>任務管理｜列表/看板</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/tasks-page.css" />
    <style>
      /* 日期選擇器 - 整框可點擊 */
      input[type="date"] {
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        line-height: 1 !important;
        cursor: pointer !important;
        position: relative !important;
      }
      
      input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        opacity: 0 !important;
        cursor: pointer !important;
      }
      
      input[type="date"]::-webkit-inner-spin-button {
        display: none !important;
      }
      
      input[type="date"]::-webkit-datetime-edit {
        padding: 0 !important;
        line-height: 1 !important;
      }
    </style>
  </head>
  <body>
    <main class="clients-content" style="padding:24px;">
      <section class="clients-card" style="background:#fff;border:1px solid rgba(15,23,42,0.08);border-radius:10px;padding:16px;">
        <header style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
          <h1 style="margin:0;font-size:22px;font-weight:700;">任務</h1>
          <div class="toolbar" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <input id="q" type="search" placeholder="搜尋任務/客戶/統編…" aria-label="搜尋" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;min-width:220px;" />
            <select id="f_assignee" aria-label="負責人">
              <option value="all">全部負責人</option>
            </select>
            <select id="f_tags" aria-label="客戶標籤">
              <option value="all">全部標籤</option>
            </select>
            <select id="f_status" aria-label="狀態">
              <option value="all">全部狀態</option>
              <option value="pending">待開始</option>
              <option value="in_progress">進行中</option>
              <option value="completed">已完成</option>
            </select>
            <select id="f_due" aria-label="到期狀態">
              <option value="all">全部到期狀態</option>
              <option value="soon">即將到期（≤3天）</option>
              <option value="overdue">已逾期</option>
            </select>
            <button id="btn-batch-assign" type="button" class="clients-btn btn-secondary" style="padding:8px 12px;display:none;">批量分配</button>
            <button id="btn-new-task" type="button" class="clients-btn" style="padding:8px 12px;">新增任務</button>
          </div>
        </header>

        <p id="tasks-error" style="color:#c0392b;min-height:1.25rem;margin:8px 0 0 0;"></p>

        <!-- 列表視圖 - 按客戶和服務分組 -->
        <div id="view-list" class="tasks-grid">
          <div id="grouped-content" style="margin-top:16px;"></div>
        </div>
      </section>
    </main>

    <!-- 批量分配負責人彈窗 -->
    <div class="modal-overlay" id="batchAssignModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal" role="document">
        <div class="modal__header">
          <h2 class="modal__title">批量分配負責人</h2>
          <button class="modal__close" type="button" id="batch-close">✕</button>
        </div>
        <div class="modal__body">
          <p style="margin-bottom:16px;color:#6b7280;">已選擇 <strong id="selected-count">0</strong> 個任務</p>
          <div class="field">
            <label for="batch_assignee">選擇負責人</label>
            <select id="batch_assignee" name="batch_assignee">
              <option value="">請選擇負責人</option>
            </select>
          </div>
          <div class="modal__actions" style="margin-top:20px;">
            <button class="btn-secondary" type="button" id="batch-cancel">取消</button>
            <button class="clients-btn" type="button" id="batch-submit">確認分配</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 新增任務彈窗 -->
    <div class="modal-overlay" id="taskModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal" role="document">
        <div class="modal__header">
          <h2 class="modal__title">新增任務</h2>
          <button class="modal__close" type="button" id="task-close">✕</button>
        </div>
        <div class="modal__body">
          <form id="taskForm" class="form-grid">
            <div class="field">
              <label for="tf_client_service_id">客戶服務 ID（必填）</label>
              <input id="tf_client_service_id" name="client_service_id" type="number" min="1" required />
              <div class="field__error" id="te_client_service_id"></div>
            </div>
            <div class="field">
              <label for="tf_task_name">任務名稱（必填）</label>
              <input id="tf_task_name" name="task_name" type="text" maxlength="200" required />
              <div class="field__error" id="te_task_name"></div>
            </div>
            <div class="field">
              <label for="tf_due">到期日（YYYY-MM-DD，可留空）</label>
              <input id="tf_due" name="due_date" type="date" />
              <div class="field__error" id="te_due"></div>
            </div>
            <div class="field">
              <label for="tf_assignee">負責人員（可留空）</label>
              <select id="tf_assignee" name="assignee_user_id">
                <option value="">請選擇負責人</option>
              </select>
              <div class="field__error" id="te_assignee"></div>
            </div>
            <div class="field" style="grid-column:1 / -1;">
              <label for="tf_stages">階段名稱（每行一個，可留空）</label>
              <textarea id="tf_stages" name="stage_names" placeholder="收資料\n記帳\n覆核"></textarea>
              <div class="field__error" id="te_stages"></div>
            </div>
            <div class="modal__actions" style="grid-column:1 / -1;">
              <button class="btn-secondary" type="button" id="task-cancel">取消</button>
              <button class="clients-btn" type="submit" id="task-submit">建立</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
        const qEl = document.getElementById('q');
        const statusEl = document.getElementById('f_status');
        const dueEl = document.getElementById('f_due');
        const assigneeEl = document.getElementById('f_assignee');
        const tagsEl = document.getElementById('f_tags');
        const errEl = document.getElementById('tasks-error');
        const modal = document.getElementById('taskModal');
        const form = document.getElementById('taskForm');
        const btnOpen = document.getElementById('btn-new-task');
        const btnClose = document.getElementById('task-close');
        const btnCancel = document.getElementById('task-cancel');
        const batchModal = document.getElementById('batchAssignModal');
        const btnBatchAssign = document.getElementById('btn-batch-assign');
        const btnBatchClose = document.getElementById('batch-close');
        const btnBatchCancel = document.getElementById('batch-cancel');
        const btnBatchSubmit = document.getElementById('batch-submit');

        let state = { q:'', status:'all', due:'all', assignee:'all', tags:'all' };
        let allTasks = [];
        let allClients = [];
        let allTags = [];
        let employeesList = [];
        let selectedTaskIds = new Set();

        const zhStatus = { pending:'待開始', in_progress:'進行中', completed:'已完成', cancelled:'已取消' };

        function setError(m){ if (errEl) errEl.textContent = m || ''; }

        // 加载员工列表
        async function loadEmployees(){
          try {
            const res = await fetch(`${apiBase}/users`, { credentials: 'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/tasks'); return; }
            const json = await res.json();
            if (res.ok && json && json.ok === true) {
              employeesList = json.data || [];
              
              // 填充任務表單的負責人下拉
              const assigneeSelect = document.getElementById('tf_assignee');
              if (assigneeSelect) {
                assigneeSelect.innerHTML = '<option value="">請選擇負責人</option>';
                employeesList.forEach(emp => {
                  const opt = document.createElement('option');
                  opt.value = emp.user_id;
                  opt.textContent = emp.name;
                  assigneeSelect.appendChild(opt);
                });
              }
              
              // 填充批量分配的負責人下拉
              const batchSelect = document.getElementById('batch_assignee');
              if (batchSelect) {
                batchSelect.innerHTML = '<option value="">請選擇負責人</option>';
                employeesList.forEach(emp => {
                  const opt = document.createElement('option');
                  opt.value = emp.user_id;
                  opt.textContent = emp.name;
                  batchSelect.appendChild(opt);
                });
              }
              
              // 填充篩選的負責人下拉
              if (assigneeEl) {
                assigneeEl.innerHTML = '<option value="all">全部負責人</option>';
                employeesList.forEach(emp => {
                  const opt = document.createElement('option');
                  opt.value = emp.user_id;
                  opt.textContent = emp.name;
                  assigneeEl.appendChild(opt);
                });
              }
            }
          } catch (e) {
            console.error('載入員工列表失敗', e);
          }
        }
        
        // 加載所有客戶
        async function loadAllClients() {
          try {
            const res = await fetch(`${apiBase}/clients?perPage=1000`, { credentials: 'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/tasks'); return; }
            const json = await res.json();
            if (res.ok && json && json.ok === true) {
              allClients = json.data || [];
            }
          } catch (e) {
            console.error('載入客戶列表失敗', e);
          }
        }
        
        // 加載所有標籤
        async function loadAllTags() {
          try {
            const res = await fetch(`${apiBase}/tags`, { credentials: 'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/tasks'); return; }
            const json = await res.json();
            if (res.ok && json && json.ok === true) {
              allTags = json.data || [];
              
              // 填充標籤篩選下拉
              if (tagsEl) {
                tagsEl.innerHTML = '<option value="all">全部標籤</option>';
                allTags.forEach(tag => {
                  const opt = document.createElement('option');
                  opt.value = tag.tag_id;
                  opt.textContent = tag.tag_name;
                  tagsEl.appendChild(opt);
                });
              }
            }
          } catch (e) {
            console.error('載入標籤列表失敗', e);
          }
        }

        async function load(){
          setError('');
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          if (state.q) params.set('q', state.q);
          if (state.status !== 'all') params.set('status', state.status === 'todo' ? 'pending' : (state.status === 'doing' ? 'in_progress' : state.status));
          if (state.due !== 'all') params.set('due', state.due);
          try {
            const res = await fetch(`${apiBase}/tasks?${params.toString()}`, { credentials: 'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/tasks'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error((json && json.message) || '載入失敗');
            cacheRows = json.data || [];
            state.total = (json.meta && json.meta.total) || 0;
            render();
          } catch (e) {
            setError('載入失敗，請稍後再試');
          }
        }

        function renderPager(){
          prevBtn.disabled = state.page <= 1;
          nextBtn.disabled = state.page * state.perPage >= state.total;
        }
        
        // 按客戶和服務分組任務
        function groupTasksByClientAndService(tasks) {
          const grouped = {};
          
          tasks.forEach(task => {
            const clientName = task.clientName || '未指定客戶';
            const serviceName = task.serviceName || '一般任務';
            
            if (!grouped[clientName]) {
              grouped[clientName] = {};
            }
            
            if (!grouped[clientName][serviceName]) {
              grouped[clientName][serviceName] = [];
            }
            
            grouped[clientName][serviceName].push(task);
          });
          
          return grouped;
        }
        
        // 渲染分組視圖
        function renderGrouped() {
          const container = document.getElementById('grouped-content');
          const grouped = groupTasksByClientAndService(cacheRows);
          
          let html = '';
          
          Object.keys(grouped).sort().forEach(clientName => {
            const clientTasks = grouped[clientName];
            const totalTasks = Object.values(clientTasks).flat().length;
            
            html += `
              <div style="margin-bottom:24px;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;">
                <div style="background:#f9fafb;padding:12px 16px;border-bottom:1px solid #e5e7eb;cursor:pointer;" onclick="toggleClientGroup('${clientName.replace(/'/g, "\\'")}')">
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div style="display:flex;align-items:center;gap:12px;">
                      <span id="icon-${clientName.replace(/[^a-zA-Z0-9]/g, '_')}" style="font-size:16px;">▼</span>
                      <strong style="font-size:16px;color:#1f2937;">${clientName}</strong>
                      <span style="background:#e5e7eb;color:#374151;padding:4px 10px;border-radius:12px;font-size:13px;font-weight:500;">${totalTasks} 個任務</span>
                    </div>
                  </div>
                </div>
                <div id="group-${clientName.replace(/[^a-zA-Z0-9]/g, '_')}" style="display:block;">
            `;
            
            Object.keys(clientTasks).sort().forEach(serviceName => {
              const tasks = clientTasks[serviceName];
              
              html += `
                <div style="border-bottom:1px solid #f3f4f6;">
                  <div style="background:#ffffff;padding:10px 16px;border-bottom:1px solid #f9fafb;cursor:pointer;" onclick="toggleServiceGroup('${clientName.replace(/'/g, "\\'")}', '${serviceName.replace(/'/g, "\\'")}')">
                    <div style="display:flex;align-items:center;gap:8px;">
                      <span id="icon-${clientName.replace(/[^a-zA-Z0-9]/g, '_')}-${serviceName.replace(/[^a-zA-Z0-9]/g, '_')}" style="font-size:14px;color:#6b7280;">▼</span>
                      <strong style="font-size:14px;color:#374151;">${serviceName}</strong>
                      <span style="color:#9ca3af;font-size:13px;">(${tasks.length})</span>
                    </div>
                  </div>
                  <div id="tasks-${clientName.replace(/[^a-zA-Z0-9]/g, '_')}-${serviceName.replace(/[^a-zA-Z0-9]/g, '_')}" style="display:block;">
              `;
              
              tasks.forEach(r => {
                const assigneeSelect = createAssigneeSelect(r);
                
                html += `
                  <div style="display:grid;grid-template-columns:2fr 100px 1fr 80px 100px 90px 100px;gap:12px;padding:12px 16px;border-bottom:1px solid #f9fafb;align-items:center;">
                    <div>
                      <div style="font-weight:500;color:#1f2937;margin-bottom:4px;">${r.taskName}</div>
                      <div style="font-size:12px;color:#6b7280;">進度：${r.progress.completed}/${r.progress.total}</div>
                    </div>
                    <div style="font-size:13px;color:#6b7280;">${r.clientTaxId||'—'}</div>
                    <div id="assignee-${r.taskId}"></div>
                    <div style="font-size:13px;color:#4b5563;">${r.dueDate ? r.dueDate.slice(5) : '—'}</div>
                    <div><span style="display:inline-block;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;${getStatusStyle(r.status)}">${zhStatus[r.status]||r.status}</span></div>
                    <div><a href="/internal/task-detail?id=${r.taskId}" style="color:#3b82f6;text-decoration:none;font-size:14px;">查看詳情</a></div>
                  </div>
                `;
              });
              
              html += `
                  </div>
                </div>
              `;
            });
            
            html += `
                </div>
              </div>
            `;
          });
          
          if (Object.keys(grouped).length === 0) {
            html = '<div style="text-align:center;padding:48px;color:#9ca3af;">沒有任務</div>';
          }
          
          container.innerHTML = html;
          
          // 為每個任務添加負責人下拉選單
          cacheRows.forEach(r => {
            const assigneeContainer = document.getElementById(`assignee-${r.taskId}`);
            if (assigneeContainer) {
              const select = createAssigneeSelectElement(r);
              assigneeContainer.appendChild(select);
            }
          });
          
          renderPager();
        }
        
        // 創建負責人下拉選單元素
        function createAssigneeSelectElement(task) {
          const select = document.createElement('select');
          select.style.cssText = 'padding:6px 10px;border:1px solid #d1d5db;border-radius:4px;font-size:13px;width:100%;';
          select.innerHTML = '<option value="">未分配</option>';
          employeesList.forEach(emp => {
            const opt = document.createElement('option');
            opt.value = emp.userId;
            opt.textContent = emp.name;
            opt.selected = (task.assigneeName && task.assigneeName === emp.name);
            select.appendChild(opt);
          });
          
          select.addEventListener('change', async function() {
            const newAssigneeId = this.value ? Number(this.value) : null;
            const prevValue = this.value;
            try {
              this.disabled = true;
              const res = await fetch(`${apiBase}/tasks/${task.taskId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ assignee_user_id: newAssigneeId })
              });
              if (res.status === 401) { location.assign('/login?redirect=/internal/tasks'); return; }
              const json = await res.json();
              if (!res.ok || !json || json.ok !== true) throw new Error((json && json.message) || '分配失敗');
              load();
            } catch (e) {
              alert(e.message || '分配失敗，請稍後再試');
              this.value = prevValue;
              this.disabled = false;
            }
          });
          
          return select;
        }
        
        // 獲取狀態樣式
        function getStatusStyle(status) {
          const styles = {
            'pending': 'background:#f3f4f6;color:#6b7280;',
            'in_progress': 'background:#fef3c7;color:#d97706;',
            'completed': 'background:#d1fae5;color:#059669;',
            'cancelled': 'background:#fee2e2;color:#dc2626;'
          };
          return styles[status] || styles['pending'];
        }
        
        // 切換客戶分組
        window.toggleClientGroup = function(clientName) {
          const groupId = 'group-' + clientName.replace(/[^a-zA-Z0-9]/g, '_');
          const iconId = 'icon-' + clientName.replace(/[^a-zA-Z0-9]/g, '_');
          const group = document.getElementById(groupId);
          const icon = document.getElementById(iconId);
          
          if (group && icon) {
            if (group.style.display === 'none') {
              group.style.display = 'block';
              icon.textContent = '▼';
            } else {
              group.style.display = 'none';
              icon.textContent = '▶';
            }
          }
        };
        
        // 切換服務分組
        window.toggleServiceGroup = function(clientName, serviceName) {
          const tasksId = 'tasks-' + clientName.replace(/[^a-zA-Z0-9]/g, '_') + '-' + serviceName.replace(/[^a-zA-Z0-9]/g, '_');
          const iconId = 'icon-' + clientName.replace(/[^a-zA-Z0-9]/g, '_') + '-' + serviceName.replace(/[^a-zA-Z0-9]/g, '_');
          const tasks = document.getElementById(tasksId);
          const icon = document.getElementById(iconId);
          
          if (tasks && icon) {
            if (tasks.style.display === 'none') {
              tasks.style.display = 'block';
              icon.textContent = '▼';
            } else {
              tasks.style.display = 'none';
              icon.textContent = '▶';
            }
          }
        };

        function renderKanban(){
          colTodo.innerHTML = ''; colDoing.innerHTML = ''; colDone.innerHTML = '';
          cacheRows.forEach(r => {
            const card = document.createElement('div');
            const cls = r.status==='completed' ? 'completed' : (r.status==='pending' ? 'low-priority' : 'medium-priority');
            card.className = 'task-card ' + cls;
            card.style.cursor = 'pointer';
            card.innerHTML = `
              <div class="task-card-header"><h4 class="task-card-title">${r.taskName}</h4></div>
              <div class="task-card-meta">
                <div class="task-card-meta-item">客戶：${r.clientName||''}</div>
                ${r.clientTaxId ? `<div class="task-card-meta-item">統編：${r.clientTaxId}</div>` : ''}
                <div class="task-card-meta-item">進度：${r.progress.completed}/${r.progress.total}</div>
                <div class="task-card-meta-item">到期：${r.dueDate? r.dueDate.slice(5):''}</div>
              </div>`;
            card.addEventListener('click', () => { location.href = `/internal/task-detail?id=${r.taskId}`; });
            if (r.status==='pending') colTodo.appendChild(card); else if (r.status==='in_progress') colDoing.appendChild(card); else colDone.appendChild(card);
          });
          renderPager();
        }

        function render(){ 
          if (state.view==='list') {
            renderGrouped();
          } else {
            renderKanban();
          }
        }
        
        function switchView(v){ 
          state.view = v; 
          if (v==='list'){ 
            viewList.style.display='block'; 
            viewKanban.style.display='none';
          } else { 
            viewList.style.display='none'; 
            viewKanban.style.display='grid'; 
          } 
          render(); 
        }

        // events
        let timer = null;
        qEl.addEventListener('input', () => { clearTimeout(timer); timer = setTimeout(()=>{ state.q = qEl.value.trim(); state.page=1; load(); }, 300); });
        statusEl.addEventListener('change', () => { const v = statusEl.value; state.status = v; state.page=1; load(); });
        dueEl.addEventListener('change', () => { state.due = dueEl.value; state.page=1; load(); });
        prevBtn.addEventListener('click', () => { if (state.page>1){ state.page--; load(); } });
        nextBtn.addEventListener('click', () => { state.page++; load(); });
        btnList.addEventListener('click', () => switchView('list'));
        btnKanban.addEventListener('click', () => switchView('kanban'));

        // init
        switchView('list');
        loadEmployees(); // 載入員工列表
        load();

        // ===== 新增任務：開關與送出 =====
        function openModal(){ modal.classList.add('active'); modal.setAttribute('aria-hidden','false'); }
        function closeModal(){ modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); form.reset(); clearTaskErrors(); }
        btnOpen.addEventListener('click', openModal);
        btnClose.addEventListener('click', closeModal);
        btnCancel.addEventListener('click', closeModal);

        function clearTaskErrors(){ ['client_service_id','task_name','due','assignee','stages'].forEach(k=>{ const el=document.getElementById('te_'+k); if (el) el.textContent=''; }); }
        function parseStages(str){ if (!str) return []; return str.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }

        form.addEventListener('submit', async function(e){
          e.preventDefault();
          clearTaskErrors();
          const client_service_id = parseInt(document.getElementById('tf_client_service_id').value, 10);
          const task_name = document.getElementById('tf_task_name').value.trim();
          const due_date = document.getElementById('tf_due').value.trim();
          const assignee_raw = document.getElementById('tf_assignee').value.trim();
          const assignee_user_id = assignee_raw ? parseInt(assignee_raw, 10) : null;
          const stage_names = parseStages(document.getElementById('tf_stages').value);

          let hasErr = false;
          if (!Number.isInteger(client_service_id) || client_service_id<=0) { document.getElementById('te_client_service_id').textContent='請輸入有效的客戶服務 ID'; hasErr=true; }
          if (task_name.length<1 || task_name.length>200) { document.getElementById('te_task_name').textContent='任務名稱必填（1–200字）'; hasErr=true; }
          if (due_date && !/^\d{4}-\d{2}-\d{2}$/.test(due_date)) { document.getElementById('te_due').textContent='日期格式需為 YYYY-MM-DD'; hasErr=true; }
          if (assignee_raw && (!Number.isInteger(assignee_user_id) || assignee_user_id<=0)) { document.getElementById('te_assignee').textContent='負責人員 ID 格式錯誤'; hasErr=true; }
          if (hasErr) return;

          const payload = { client_service_id, task_name, due_date: due_date || undefined, assignee_user_id: assignee_user_id || undefined, stage_names };
          const submitBtn = document.getElementById('task-submit');
          submitBtn.disabled = true; submitBtn.textContent = '建立中…';
          try {
            const res = await fetch(`${apiBase}/tasks`, { method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify(payload) });
            if (res.status === 401) { location.assign('/login?redirect=/internal/tasks'); return; }
            const json = await res.json().catch(()=>null);
            if (!res.ok || !json || json.ok!==true) {
              const msg = (json && json.message) || '建立失敗';
              if (json && Array.isArray(json.errors) && json.errors.length>0) {
                const e0 = json.errors[0]; const el = document.getElementById('te_'+(e0.field||'')); if (el) el.textContent = e0.message || msg; else setError(msg);
              } else { setError(msg); }
              return;
            }
            alert('已建立任務');
            closeModal();
            state.page = 1; load();
          } catch (_) {
            setError('建立失敗，請稍後再試');
          } finally {
            submitBtn.disabled = false; submitBtn.textContent = '建立';
          }
        });
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


