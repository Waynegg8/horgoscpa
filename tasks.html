<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="ä»»å‹™ç®¡ç†" />
    <title>ä»»å‹™ç®¡ç†</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/tasks-page.css" />
    <style>
      /* æ—¥æœŸé¸æ“‡å™¨ - æ•´æ¡†å¯é»æ“Š */
      input[type="date"] {
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        cursor: pointer !important;
        position: relative !important;
      }
      
      input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute !important;
        top: 0; left: 0; right: 0; bottom: 0;
        width: 100% !important; height: 100% !important;
        margin: 0; padding: 0; opacity: 0; cursor: pointer !important;
      }
      
      .client-group {
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
      }
      
      .client-header {
        background: #f9fafb;
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .client-header:hover {
        background: #f3f4f6;
      }
      
      .service-group {
        border-bottom: 1px solid #f3f4f6;
      }
      
      .service-header {
        background: #ffffff;
        padding: 10px 16px 10px 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .service-header:hover {
        background: #f9fafb;
      }
      
      .task-row {
        display: grid;
        grid-template-columns: 40px 2fr 140px 90px 110px 110px 100px;
        gap: 12px;
        padding: 12px 16px 12px 56px;
        border-bottom: 1px solid #f9fafb;
        align-items: center;
      }
      
      .task-row:hover {
        background: #f9fafb;
      }
    </style>
  </head>
  <body>
    <main class="clients-content" style="padding:24px;">
      <section class="clients-card" style="background:#fff;border:1px solid rgba(15,23,42,0.08);border-radius:10px;padding:16px;">
        <header style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
          <h1 style="margin:0;font-size:22px;font-weight:700;">ä»»å‹™</h1>
          <div class="toolbar" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <input id="q" type="search" placeholder="æœå°‹ä»»å‹™/å®¢æˆ¶/çµ±ç·¨â€¦" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;min-width:220px;" />
            <select id="f_year" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
              <option value="all">å…¨éƒ¨å¹´ä»½</option>
            </select>
            <select id="f_month" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
              <option value="all">å…¨éƒ¨æœˆä»½</option>
              <option value="1">1æœˆ</option>
              <option value="2">2æœˆ</option>
              <option value="3">3æœˆ</option>
              <option value="4">4æœˆ</option>
              <option value="5">5æœˆ</option>
              <option value="6">6æœˆ</option>
              <option value="7">7æœˆ</option>
              <option value="8">8æœˆ</option>
              <option value="9">9æœˆ</option>
              <option value="10">10æœˆ</option>
              <option value="11">11æœˆ</option>
              <option value="12">12æœˆ</option>
            </select>
            <select id="f_assignee" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
              <option value="all">å…¨éƒ¨è² è²¬äºº</option>
            </select>
            <select id="f_tags" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
              <option value="all">å…¨éƒ¨æ¨™ç±¤</option>
            </select>
            <select id="f_status" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
              <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
              <option value="in_progress">é€²è¡Œä¸­</option>
              <option value="completed">å·²å®Œæˆ</option>
            </select>
            <select id="f_due" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
              <option value="all">å…¨éƒ¨åˆ°æœŸç‹€æ…‹</option>
              <option value="soon">å³å°‡åˆ°æœŸï¼ˆâ‰¤3å¤©ï¼‰</option>
              <option value="overdue">å·²é€¾æœŸ</option>
            </select>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;background:#fff;">
              <input type="checkbox" id="f_hide_completed" style="cursor:pointer;" />
              <span style="font-size:14px;">éšè—å·²å®Œæˆ</span>
            </label>
            <button id="btn-batch-assign" type="button" class="clients-btn btn-secondary" style="padding:8px 12px;display:none;">æ‰¹é‡åˆ†é…</button>
            <button id="btn-new-task" type="button" class="clients-btn" style="padding:8px 12px;">æ–°å¢ä»»å‹™</button>
          </div>
        </header>

        <p id="tasks-error" style="color:#c0392b;min-height:1.25rem;margin:8px 0 0 0;"></p>

        <div id="tasks-list" style="margin-top:16px;"></div>
      </section>
    </main>

    <!-- æ‰¹é‡åˆ†é…å½ˆçª— -->
    <div class="modal-overlay" id="batchModal" aria-hidden="true">
      <div class="modal">
        <div class="modal__header">
          <h2 class="modal__title">æ‰¹é‡åˆ†é…è² è²¬äºº</h2>
          <button class="modal__close" id="batch-close">âœ•</button>
        </div>
        <div class="modal__body">
          <p style="margin-bottom:16px;color:#6b7280;">å·²é¸æ“‡ <strong id="selected-count">0</strong> å€‹ä»»å‹™</p>
            <div class="field">
            <label for="batch_assignee">é¸æ“‡è² è²¬äºº</label>
            <select id="batch_assignee">
                <option value="">è«‹é¸æ“‡è² è²¬äºº</option>
              </select>
            </div>
          <div class="modal__actions" style="margin-top:20px;">
            <button class="btn-secondary" id="batch-cancel">å–æ¶ˆ</button>
            <button class="clients-btn" id="batch-submit">ç¢ºèªåˆ†é…</button>
            </div>
        </div>
      </div>
    </div>

    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
        
        let allTasks = [];
        let allClients = [];
        let allTags = [];
        let employeesList = [];
        let selectedTaskIds = new Set();

        const zhStatus = { in_progress:'é€²è¡Œä¸­', completed:'å·²å®Œæˆ', cancelled:'å·²å–æ¶ˆ' };

        // åˆå§‹åŒ–
        async function init() {
          // åˆå§‹åŒ–å¹´ä»½ä¸‹æ‹‰ï¼ˆæœ€è¿‘5å¹´ï¼‰
          const currentYear = new Date().getFullYear();
          const yearSelect = document.getElementById('f_year');
          yearSelect.innerHTML = '<option value="all">å…¨éƒ¨å¹´ä»½</option>';
          for (let i = 0; i < 5; i++) {
            const year = currentYear - i;
            const selected = i === 0 ? ' selected' : '';
            yearSelect.innerHTML += `<option value="${year}"${selected}>${year}å¹´</option>`;
          }
          
          // é»˜è®¤è®¾ç½®ï¼šæ˜¾ç¤ºå½“å‰å¹´ + å…¨éƒ¨æœˆä»½ + éšè—å·²å®Œæˆ
          // è¿™æ ·èƒ½çœ‹åˆ°å½“å‰å¹´æ‰€æœ‰æœªå®Œæˆçš„ä»»åŠ¡ï¼ˆåŒ…æ‹¬å†å²é—ç•™çš„ï¼‰
          document.getElementById('f_month').value = 'all';  // å…¨éƒ¨æœˆä»½
          document.getElementById('f_hide_completed').checked = true;  // é»˜è®¤éšè—å·²å®Œæˆ
          
          await Promise.all([
            loadEmployees(),
            loadAllClients(),
            loadAllTags(),
            loadAllTasks()
          ]);
        }
        
        // åŠ è¼‰å“¡å·¥
        async function loadEmployees() {
          try {
            const res = await fetch(`${apiBase}/users`, { credentials: 'include' });
            if (res.status === 401) { location.href = '/login?redirect=/internal/tasks'; return; }
            const json = await res.json();
            if (json.ok) {
              employeesList = json.data || [];
              
              // å¡«å……ç¯©é¸ä¸‹æ‹‰
              document.getElementById('f_assignee').innerHTML = '<option value="all">å…¨éƒ¨è² è²¬äºº</option>' +
                employeesList.map(e => `<option value="${e.user_id}">${e.name}</option>`).join('');
              
              // å¡«å……æ‰¹é‡åˆ†é…ä¸‹æ‹‰
              document.getElementById('batch_assignee').innerHTML = '<option value="">è«‹é¸æ“‡è² è²¬äºº</option>' +
                employeesList.map(e => `<option value="${e.user_id}">${e.name}</option>`).join('');
              
              // å¡«å……å¿«é€Ÿæ–°å¢ä»»åŠ¡çš„è´Ÿè´£äººä¸‹æ‹‰æ¡†
              document.getElementById('quick-assignee').innerHTML = '<option value="">æœªæŒ‡å®š</option>' +
                employeesList.map(e => `<option value="${e.user_id}">${e.name}</option>`).join('');
            }
          } catch (e) {
            console.error('è¼‰å…¥å“¡å·¥å¤±æ•—', e);
          }
        }
        
        // åŠ è¼‰å®¢æˆ¶
        async function loadAllClients() {
          try {
            const res = await fetch(`${apiBase}/clients?perPage=1000`, { credentials: 'include' });
            if (res.status === 401) { location.href = '/login?redirect=/internal/tasks'; return; }
            const json = await res.json();
            if (json.ok) {
              allClients = json.data || [];
            }
          } catch (e) {
            console.error('è¼‰å…¥å®¢æˆ¶å¤±æ•—', e);
          }
        }
        
        // åŠ è¼‰æ¨™ç±¤
        async function loadAllTags() {
          try {
            const res = await fetch(`${apiBase}/tags`, { credentials: 'include' });
            if (res.status === 401) { location.href = '/login?redirect=/internal/tasks'; return; }
            const json = await res.json();
            if (json.ok) {
              allTags = json.data || [];
              document.getElementById('f_tags').innerHTML = '<option value="all">å…¨éƒ¨æ¨™ç±¤</option>' +
                allTags.map(t => `<option value="${t.tag_id}">${t.tag_name}</option>`).join('');
            }
          } catch (e) {
            console.error('è¼‰å…¥æ¨™ç±¤å¤±æ•—', e);
          }
        }
        
        // åŠ è¼‰ä»»å‹™
        async function loadAllTasks() {
          try {
            const params = new URLSearchParams({ perPage: '1000' });
            
            // å¹´æœˆç­›é€‰
            const year = document.getElementById('f_year').value;
            const month = document.getElementById('f_month').value;
            if (year !== 'all') params.append('service_year', year);
            if (month !== 'all') params.append('service_month', month);
            
            // æ³¨æ„ï¼šä¸ä¼  hide_completed ç»™åç«¯ï¼Œå‰ç«¯è‡ªå·±å¤„ç†
            // è¿™æ ·æ‰èƒ½å®ç°"æ˜¾ç¤ºæœ‰æœªå®Œæˆä»»åŠ¡çš„ç»„çš„æ‰€æœ‰ä»»åŠ¡"çš„é€»è¾‘
            
            const res = await fetch(`${apiBase}/tasks?${params}`, { credentials: 'include' });
            if (res.status === 401) { location.href = '/login?redirect=/internal/tasks'; return; }
            const json = await res.json();
            if (json.ok) {
              allTasks = json.data || [];
            render();
            }
          } catch (e) {
            console.error('è¼‰å…¥ä»»å‹™å¤±æ•—', e);
            document.getElementById('tasks-error').textContent = 'è¼‰å…¥å¤±æ•—';
          }
        }
        
        // ç¯©é¸ä»»å‹™
        function filterTasks() {
          const q = document.getElementById('q').value.toLowerCase();
          const assignee = document.getElementById('f_assignee').value;
          const tags = document.getElementById('f_tags').value;
          const status = document.getElementById('f_status').value;
          const due = document.getElementById('f_due').value;
          
          return allTasks.filter(task => {
            // æœç´¢
            if (q && !task.taskName.toLowerCase().includes(q) && 
                !task.clientName.toLowerCase().includes(q) &&
                !(task.clientTaxId && task.clientTaxId.includes(q))) {
              return false;
            }
            
            // è² è²¬äºº
            if (assignee !== 'all' && String(task.assigneeUserId) !== assignee) {
              return false;
            }
            
            // ç‹€æ…‹
            if (status !== 'all' && task.status !== status) {
              return false;
            }
            
            // åˆ°æœŸ
            if (due === 'soon') {
              const dueDate = new Date(task.dueDate);
              const today = new Date();
              const diff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
              if (diff > 3 || diff < 0) return false;
            } else if (due === 'overdue') {
              const dueDate = new Date(task.dueDate);
              const today = new Date();
              if (dueDate >= today || task.status === 'completed') return false;
            }
            
            return true;
          });
        }
        
        // æŒ‰å®¢æˆ¶å’Œæœå‹™+æœˆä»½åˆ†çµ„
        function groupByClientAndService(tasks) {
          const hideCompleted = document.getElementById('f_hide_completed').checked;
          const grouped = new Map();
          
          // å…ˆæ·»åŠ æ‰€æœ‰å®¢æˆ¶
          allClients.sort((a, b) => (a.companyName || '').localeCompare(b.companyName || '', 'zh-TW')).forEach(client => {
            grouped.set(client.clientId, {
              clientId: client.clientId,
              clientName: client.companyName || 'æœªå‘½åå®¢æˆ¶',
              clientTaxId: client.taxId || 'â€”',
              serviceGroups: new Map()
            });
          });
          
          // æ·»åŠ ä»»å‹™ï¼ˆæŒ‰æœå‹™+æœˆä»½åˆ†çµ„ï¼‰
          tasks.forEach(task => {
            const clientId = task.clientId || 'unknown';
            if (!grouped.has(clientId)) {
              grouped.set(clientId, {
                clientId,
                clientName: task.clientName || 'æœªå‘½åå®¢æˆ¶',
                clientTaxId: task.clientTaxId || 'â€”',
                serviceGroups: new Map()
              });
            }
            
            const client = grouped.get(clientId);
            const serviceName = task.serviceName || 'ä¸€èˆ¬ä»»å‹™';
            const serviceMonth = task.serviceMonth || '';
            
            // ç»„åˆé”®ï¼šæœå‹™å + æœˆä»½
            const groupKey = serviceMonth ? `${serviceName}|||${serviceMonth}` : serviceName;
            
            if (!client.serviceGroups.has(groupKey)) {
              client.serviceGroups.set(groupKey, {
                serviceName,
                serviceMonth,
                clientServiceId: task.clientServiceId,
                serviceId: task.serviceId,
                clientId: task.clientId,
                tasks: []
              });
            }
            
            client.serviceGroups.get(groupKey).tasks.push(task);
          });
          
          // å¦‚æœå‹¾é€‰"éšè—å·²å®Œæˆ"ï¼Œè¿‡æ»¤æ‰å…¨éƒ¨å®Œæˆçš„ç»„
          if (hideCompleted) {
            grouped.forEach(client => {
              const filteredGroups = new Map();
              
              client.serviceGroups.forEach((group, key) => {
                // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆä»»åŠ¡
                const hasIncomplete = group.tasks.some(t => t.status !== 'completed');
                
                // åªä¿ç•™æœ‰æœªå®Œæˆä»»åŠ¡çš„ç»„
                if (hasIncomplete) {
                  filteredGroups.set(key, group);
                }
              });
              
              client.serviceGroups = filteredGroups;
            });
          }
          
          // æ’åºæœå‹™çµ„å’Œä»»å‹™
          grouped.forEach(client => {
            const sortedGroups = new Map([...client.serviceGroups.entries()].sort((a, b) => {
              // å…ˆæŒ‰æœåŠ¡åæ’åº
              const serviceCompare = a[1].serviceName.localeCompare(b[1].serviceName, 'zh-TW');
              if (serviceCompare !== 0) return serviceCompare;
              
              // å†æŒ‰æœˆä»½é™åºæ’åºï¼ˆæœ€æ–°æœˆä»½åœ¨å‰ï¼‰
              return (b[1].serviceMonth || '').localeCompare(a[1].serviceMonth || '');
            }));
            
            client.serviceGroups = sortedGroups;
          });
          
          return grouped;
        }
        
        // æ¸²æŸ“
        function render() {
          const filtered = filterTasks();
          const grouped = groupByClientAndService(filtered);
          const container = document.getElementById('tasks-list');
          
          let html = '';
          
          grouped.forEach((client, clientId) => {
            const hasGroups = client.serviceGroups.size > 0;
            const clientIdSafe = clientId.replace(/[^a-zA-Z0-9]/g, '_');
            
            html += `
              <div class="client-group">
                <div class="client-header" onclick="toggleClient('${clientIdSafe}')">
                  <span id="icon-${clientIdSafe}" style="font-size:16px;">â–¶</span>
                  <strong style="font-size:16px;color:#1f2937;">${client.clientName} ${client.clientTaxId !== 'â€”' ? `(${client.clientTaxId})` : ''}</strong>
                </div>
                <div id="group-${clientIdSafe}" style="display:none;">
            `;
            
            if (!hasGroups) {
              html += `
                <div style="padding:16px;text-align:center;color:#9ca3af;font-size:14px;">
                  æ­¤å®¢æˆ¶ç›®å‰æ²’æœ‰ä»»å‹™
                </div>
              `;
            } else {
              client.serviceGroups.forEach((group, groupKey) => {
                const tasks = group.tasks;
                if (tasks.length === 0) return;
                
                // è®¡ç®—å®Œæˆæƒ…å†µ
                const completed = tasks.filter(t => t.status === 'completed').length;
                const total = tasks.length;
                
                // æ ¼å¼åŒ–æœåŠ¡+æœˆä»½æ ‡é¢˜
                const monthText = group.serviceMonth ? ` - ${group.serviceMonth.slice(0, 4)}å¹´${parseInt(group.serviceMonth.slice(5))}æœˆ` : '';
                const serviceTitle = `${group.serviceName}${monthText}`;
                
                // ç”Ÿæˆå”¯ä¸€IDï¼šå®¢æˆ·ID + æœåŠ¡ç»„é”®
                const groupIdSafe = `${clientIdSafe}_${groupKey.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                html += `
                  <div class="service-group">
                    <div class="service-header" style="display:flex;align-items:center;justify-content:space-between;">
                      <div onclick="toggleService('${groupIdSafe}')" style="flex:1;cursor:pointer;display:flex;align-items:center;gap:8px;">
                        <span id="icon-${groupIdSafe}" style="font-size:14px;">â–¶</span>
                        <strong style="font-size:14px;color:#374151;">${serviceTitle}</strong>
                        <span style="color:#9ca3af;font-size:13px;">(${total}å€‹ä»»å‹™: ${completed}å·²å®Œæˆ, ${total - completed}æœªå®Œæˆ)</span>
                      </div>
                      <button onclick="openQuickAddTask('${group.clientId}', '${group.clientServiceId}', '${group.serviceId}', '${group.serviceName}', '${group.serviceMonth}', event)" 
                              style="padding:4px 12px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:4px;"
                              title="ç‚ºæ­¤æœå‹™æ–°å¢ä»»å‹™">
                        <span style="font-size:14px;">â•</span> æ–°å¢ä»»å‹™
                      </button>
                    </div>
                    <div id="group-${groupIdSafe}" style="display:none;">
                `;
                
                tasks.forEach(task => {
                  const checked = selectedTaskIds.has(task.taskId) ? 'checked' : '';
                  html += `
                    <div class="task-row">
                      <div><input type="checkbox" ${checked} onchange="toggleTaskSelection('${task.taskId}', this.checked)" /></div>
                      <div>
                        <div style="font-weight:500;color:#1f2937;margin-bottom:4px;">${task.taskName}</div>
                        <div style="font-size:12px;color:#6b7280;">é€²åº¦ï¼š${task.progress.completed}/${task.progress.total}</div>
                      </div>
                      <div style="font-size:13px;color:#6b7280;">${task.assigneeName || 'æœªåˆ†é…'}</div>
                      <div style="font-size:13px;color:#4b5563;">${task.dueDate ? task.dueDate.slice(5) : 'â€”'}</div>
                      <div><span style="display:inline-block;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;${getStatusStyle(task.status)}">${zhStatus[task.status]}</span></div>
                      <div><a href="/internal/task-detail?id=${task.taskId}" style="color:#3b82f6;text-decoration:none;font-size:14px;">æŸ¥çœ‹è©³æƒ…</a></div>
                    </div>
                  `;
                });
                
                html += `
                    </div>
                  </div>
                `;
              });
            }
            
            html += `
                </div>
              </div>
            `;
          });
          
          if (html === '') {
            html = '<div style="text-align:center;padding:48px;color:#9ca3af;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ä»»å‹™</div>';
          }
          
          container.innerHTML = html;
          updateBatchButton();
        }
        
        // ç‹€æ…‹æ¨£å¼
        function getStatusStyle(status) {
          const styles = {
            'in_progress': 'background:#fef3c7;color:#d97706;',
            'completed': 'background:#d1fae5;color:#059669;',
            'cancelled': 'background:#fee2e2;color:#dc2626;'
          };
          return styles[status] || styles['in_progress'];
        }
        
        // åˆ‡æ›å®¢æˆ¶åˆ†çµ„
        window.toggleClient = function(id) {
          const group = document.getElementById('group-' + id);
          const icon = document.getElementById('icon-' + id);
          if (group && icon) {
            const isHidden = group.style.display === 'none';
            group.style.display = isHidden ? 'block' : 'none';
            icon.textContent = isHidden ? 'â–¼' : 'â–¶';
          }
        };
        
        // åˆ‡æ›æœå‹™åˆ†çµ„
        window.toggleService = function(id) {
          const group = document.getElementById('group-' + id);
          const icon = document.getElementById('icon-' + id);
          if (group && icon) {
            const isHidden = group.style.display === 'none';
            group.style.display = isHidden ? 'block' : 'none';
            icon.textContent = isHidden ? 'â–¼' : 'â–¶';
          }
        };
        
        // ä»»å‹™é¸æ“‡
        window.toggleTaskSelection = function(taskId, checked) {
          if (checked) {
            selectedTaskIds.add(taskId);
          } else {
            selectedTaskIds.delete(taskId);
          }
          updateBatchButton();
        };
        
        function updateBatchButton() {
          const btn = document.getElementById('btn-batch-assign');
          const count = document.getElementById('selected-count');
          btn.style.display = selectedTaskIds.size > 0 ? 'inline-block' : 'none';
          if (count) count.textContent = selectedTaskIds.size;
        }
        
        // æ‰¹é‡åˆ†é…
        document.getElementById('btn-batch-assign').addEventListener('click', () => {
          document.getElementById('batchModal').classList.add('active');
          document.getElementById('batchModal').setAttribute('aria-hidden', 'false');
        });
        
        document.getElementById('batch-close').addEventListener('click', () => {
          document.getElementById('batchModal').classList.remove('active');
          document.getElementById('batchModal').setAttribute('aria-hidden', 'true');
        });
        
        document.getElementById('batch-cancel').addEventListener('click', () => {
          document.getElementById('batchModal').classList.remove('active');
          document.getElementById('batchModal').setAttribute('aria-hidden', 'true');
        });
        
        document.getElementById('batch-submit').addEventListener('click', async () => {
          const assigneeId = document.getElementById('batch_assignee').value;
          if (!assigneeId) {
            alert('è«‹é¸æ“‡è² è²¬äºº');
              return;
            }
          
          try {
            const tasks = Array.from(selectedTaskIds);
            await Promise.all(tasks.map(taskId =>
              fetch(`${apiBase}/tasks/${taskId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ assignee_user_id: parseInt(assigneeId) })
              })
            ));
            
            alert('å·²æˆåŠŸåˆ†é…');
            selectedTaskIds.clear();
            document.getElementById('batchModal').classList.remove('active');
            await loadAllTasks();
          } catch (e) {
            alert('åˆ†é…å¤±æ•—');
          }
        });
        
        // ç¯©é¸äº‹ä»¶
        let timer;
        document.getElementById('q').addEventListener('input', () => {
          clearTimeout(timer);
          timer = setTimeout(render, 300);
        });
        document.getElementById('f_assignee').addEventListener('change', render);
        document.getElementById('f_tags').addEventListener('change', render);
        document.getElementById('f_status').addEventListener('change', render);
        document.getElementById('f_due').addEventListener('change', render);
        
        // å¹´æœˆç­›é€‰å’Œéšè—å·²å®Œæˆ - éœ€è¦é‡æ–°åŠ è½½ä»»åŠ¡
        document.getElementById('f_year').addEventListener('change', loadAllTasks);
        document.getElementById('f_month').addEventListener('change', loadAllTasks);
        document.getElementById('f_hide_completed').addEventListener('change', loadAllTasks);
        
        // æ–°å¢ä»»åŠ¡æŒ‰é’®
        document.getElementById('btn-new-task').addEventListener('click', () => {
          window.location.href = '/internal/tasks-new';
        });
        
        // å¿«é€Ÿæ–°å¢ä»»å‹™
        let quickAddContext = null;
        
        window.openQuickAddTask = function(clientId, clientServiceId, serviceId, serviceName, serviceMonth, event) {
          event.stopPropagation(); // é˜²æ­¢è§¦å‘æŠ˜å 
          
          // æ‰¾å‡ºè¯¥æœåŠ¡ç»„ä¸‹çš„æ‰€æœ‰ä»»åŠ¡ï¼ˆç”¨äºå‰ç½®ä»»åŠ¡é€‰æ‹©ï¼‰
          const sameServiceTasks = allTasks.filter(t => 
            t.clientId === clientId && 
            t.serviceName === serviceName && 
            t.serviceMonth === serviceMonth &&
            t.status !== 'cancelled'
          );
          
          // æ„å»ºä»»åŠ¡ä¾èµ–å…³ç³»å›¾ï¼ˆç”¨äºæ£€æµ‹åç»­ä»»åŠ¡ï¼‰
          const taskDependencyMap = new Map(); // taskId -> [ä¾èµ–å®ƒçš„ä»»åŠ¡åˆ—è¡¨]
          sameServiceTasks.forEach(task => {
            if (task.prerequisiteTaskId) {
              if (!taskDependencyMap.has(task.prerequisiteTaskId)) {
                taskDependencyMap.set(task.prerequisiteTaskId, []);
              }
              taskDependencyMap.get(task.prerequisiteTaskId).push(task);
            }
          });
          
          quickAddContext = { 
            clientId, 
            clientServiceId, 
            serviceId, 
            serviceName, 
            serviceMonth,
            sameServiceTasks,
            taskDependencyMap,
            selectedSOPs: [],
            affectedTasks: []
          };
          
          // è®¾ç½®æ ‡é¢˜
          const monthText = serviceMonth ? ` - ${serviceMonth.slice(0, 4)}å¹´${parseInt(serviceMonth.slice(5))}æœˆ` : '';
          document.getElementById('quick-modal-title').textContent = `æ–°å¢ä»»å‹™ï¼š${serviceName}${monthText}`;
          
          // æ¸…ç©ºè¡¨å•
          document.getElementById('quick-task-name').value = '';
          document.getElementById('quick-assignee').value = '';
          document.getElementById('quick-due-date').value = '';
          document.getElementById('quick-prerequisite').value = '';
          document.getElementById('quick-notes').value = '';
          document.getElementById('quick-selected-sops').innerHTML = '';
          document.getElementById('quick-affected-tasks').style.display = 'none';
          
          // å¡«å……ä»»åŠ¡ç±»å‹ä¸‹æ‹‰æ¡†ï¼ˆä»æœåŠ¡é¡¹ç›®ä¸­è·å–ï¼‰
          console.log('[Quick Add] serviceId:', serviceId, 'type:', typeof serviceId);
          console.log('[Quick Add] allServiceItems:', allServiceItems.length);
          console.log('[Quick Add] Sample item:', allServiceItems[0]);
          
          const serviceItems = allServiceItems.filter(item => {
            // ç¡®ä¿ç±»å‹åŒ¹é…ï¼ˆå¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–æ•°å­—ï¼‰
            const match = String(item.service_id) === String(serviceId) && item.is_active !== false;
            if (match) console.log('[Quick Add] Matched item:', item);
            return match;
          });
          
          console.log('[Quick Add] Filtered serviceItems:', serviceItems.length);
          
          if (serviceItems.length > 0) {
            document.getElementById('quick-task-name').innerHTML = '<option value="">è«‹é¸æ“‡ä»»å‹™é¡å‹</option>' +
              serviceItems.map(item => `<option value="${item.item_name}">${item.item_name}</option>`).join('');
          } else {
            // å¦‚æœæ²¡æœ‰ä»»åŠ¡ç±»å‹ï¼Œæç¤ºç”¨æˆ·å…ˆè®¾ç½®
            document.getElementById('quick-task-name').innerHTML = '<option value="">è«‹å…ˆåœ¨ç³»çµ±è¨­å®šä¸­ç‚ºæ­¤æœå‹™æ–°å¢ä»»å‹™é¡å‹</option>';
          }
          
          // å¡«å……å‰ç½®ä»»åŠ¡ä¸‹æ‹‰æ¡†
          if (sameServiceTasks.length > 0) {
            document.getElementById('quick-prerequisite').innerHTML = '<option value="">ç„¡å‰ç½®ä»»å‹™</option>' +
              sameServiceTasks.map(t => {
                const dueInfo = t.dueDate ? ` (åˆ°æœŸï¼š${t.dueDate})` : '';
                return `<option value="${t.taskId}">${t.taskName}${dueInfo}</option>`;
              }).join('');
            document.getElementById('quick-prerequisite-group').style.display = 'block';
          } else {
            document.getElementById('quick-prerequisite-group').style.display = 'none';
          }
          
          // æ˜¾ç¤ºæ¨¡æ€æ¡†
          document.getElementById('quick-add-modal').style.display = 'flex';
        };
        
        window.closeQuickAddModal = function() {
          document.getElementById('quick-add-modal').style.display = 'none';
          quickAddContext = null;
        };
        
        // æ£€æŸ¥é€‰æ‹©çš„å‰ç½®ä»»åŠ¡æ˜¯å¦æœ‰åç»­ä»»åŠ¡
        window.checkAffectedTasks = function() {
          if (!quickAddContext) return;
          
          const prerequisiteTaskId = document.getElementById('quick-prerequisite').value;
          const newTaskDueDate = document.getElementById('quick-due-date').value;
          
          if (!prerequisiteTaskId || !newTaskDueDate) {
            document.getElementById('quick-affected-tasks').style.display = 'none';
            quickAddContext.affectedTasks = [];
            return;
          }
          
          // æ‰¾å‡ºæ‰€æœ‰ä¾èµ–é€‰ä¸­çš„å‰ç½®ä»»åŠ¡çš„åç»­ä»»åŠ¡
          const affectedTasks = quickAddContext.taskDependencyMap.get(prerequisiteTaskId) || [];
          
          // æ£€æŸ¥å“ªäº›åç»­ä»»åŠ¡çš„åˆ°æœŸæ—¥æ—©äºæˆ–ç­‰äºæ–°ä»»åŠ¡çš„åˆ°æœŸæ—¥
          const conflictTasks = affectedTasks.filter(t => {
            if (!t.dueDate) return false;
            return new Date(t.dueDate) <= new Date(newTaskDueDate);
          });
          
          quickAddContext.affectedTasks = conflictTasks;
          
          if (conflictTasks.length > 0) {
            // æ˜¾ç¤ºå—å½±å“çš„ä»»åŠ¡åˆ—è¡¨
            let html = `
              <div style="padding:12px;background:#fef3c7;border:1px solid #fbbf24;border-radius:6px;">
                <div style="font-weight:600;color:#92400e;margin-bottom:8px;">
                  âš ï¸ æª¢æ¸¬åˆ°å¾ŒçºŒä»»å‹™åˆ°æœŸæ—¥è¡çª
                </div>
                <div style="font-size:13px;color:#78350f;margin-bottom:8px;">
                  ä»¥ä¸‹å¾ŒçºŒä»»å‹™çš„åˆ°æœŸæ—¥éœ€è¦å»¶å¾Œï¼š
                </div>
            `;
            
            conflictTasks.forEach(t => {
              html += `
                <div style="padding:4px 8px;background:white;border-radius:4px;margin-bottom:4px;font-size:13px;">
                  ğŸ“Œ ${t.taskName} <span style="color:#dc2626;">ï¼ˆç•¶å‰ï¼š${t.dueDate}ï¼‰</span>
                </div>
              `;
            });
            
            html += `
                <div style="margin-top:12px;padding:8px;background:white;border-radius:4px;">
                  <label style="display:block;margin-bottom:8px;cursor:pointer;">
                    <input type="checkbox" id="quick-adjust-subsequent" checked style="margin-right:6px;" />
                    <span style="font-size:13px;color:#78350f;font-weight:500;">è‡ªå‹•å»¶å¾Œå¾ŒçºŒä»»å‹™åˆ°æœŸæ—¥</span>
                  </label>
                  <div style="display:flex;align-items:center;gap:8px;padding-left:24px;">
                    <label style="font-size:13px;color:#78350f;">å»¶å¾Œ</label>
                    <input type="number" id="quick-delay-days" value="1" min="1" max="30" 
                           style="width:60px;padding:4px 8px;border:1px solid #d1d5db;border-radius:4px;text-align:center;" />
                    <label style="font-size:13px;color:#78350f;">å¤©</label>
                  </div>
                </div>
              </div>
            `;
            
            document.getElementById('quick-affected-tasks').innerHTML = html;
            document.getElementById('quick-affected-tasks').style.display = 'block';
          } else if (affectedTasks.length > 0) {
            // æœ‰åç»­ä»»åŠ¡ä½†æ²¡æœ‰å†²çª
            document.getElementById('quick-affected-tasks').innerHTML = `
              <div style="padding:12px;background:#dbeafe;border:1px solid #3b82f6;border-radius:6px;">
                <div style="font-size:13px;color:#1e40af;">
                  â„¹ï¸ æ­¤å‰ç½®ä»»å‹™æœ‰ ${affectedTasks.length} å€‹å¾ŒçºŒä»»å‹™ï¼Œåˆ°æœŸæ—¥ç„¡è¡çª
                </div>
              </div>
            `;
            document.getElementById('quick-affected-tasks').style.display = 'block';
          } else {
            document.getElementById('quick-affected-tasks').style.display = 'none';
          }
        };
        
        window.submitQuickTask = async function() {
          if (!quickAddContext) return;
          
          const taskName = document.getElementById('quick-task-name').value.trim();
          const assigneeUserId = document.getElementById('quick-assignee').value || null;
          const dueDate = document.getElementById('quick-due-date').value || null;
          const prerequisiteTaskId = document.getElementById('quick-prerequisite').value || null;
          const notes = document.getElementById('quick-notes').value.trim() || null;
          
          if (!taskName) {
            alert('è«‹é¸æ“‡ä»»å‹™é¡å‹');
            return;
          }
          
          // æ£€æŸ¥æ˜¯å¦éœ€è¦è°ƒæ•´åç»­ä»»åŠ¡
          const adjustSubsequent = document.getElementById('quick-adjust-subsequent')?.checked;
          const delayDays = parseInt(document.getElementById('quick-delay-days')?.value) || 1;
          
          try {
            const payload = {
              client_service_id: quickAddContext.clientServiceId,
              task_name: taskName,
              assignee_user_id: assigneeUserId,
              due_date: dueDate,
              prerequisite_task_id: prerequisiteTaskId,
              service_month: quickAddContext.serviceMonth,
              notes: notes
            };
            
            // å¦‚æœæœ‰é€‰æ‹©SOPï¼Œæ·»åŠ åˆ°payload
            if (quickAddContext.selectedSOPs && quickAddContext.selectedSOPs.length > 0) {
              payload.sop_ids = quickAddContext.selectedSOPs;
            }
            
            const res = await fetch(`${apiBase}/tasks`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload)
            });
            
            const json = await res.json();
            
            if (json.ok) {
              // å¦‚æœéœ€è¦è°ƒæ•´åç»­ä»»åŠ¡çš„åˆ°æœŸæ—¥
              if (adjustSubsequent && quickAddContext.affectedTasks.length > 0 && dueDate) {
                const newDueDate = new Date(dueDate);
                newDueDate.setDate(newDueDate.getDate() + delayDays); // æ ¹æ®ç”¨æˆ·è®¾ç½®çš„å¤©æ•°å»¶å
                const minNextDueDate = newDueDate.toISOString().split('T')[0];
                
                // æ‰¹é‡æ›´æ–°åç»­ä»»åŠ¡çš„åˆ°æœŸæ—¥
                const updatePromises = quickAddContext.affectedTasks.map(async (task) => {
                  if (new Date(task.dueDate) <= new Date(dueDate)) {
                    try {
                      await fetch(`${apiBase}/tasks/${task.taskId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ due_date: minNextDueDate })
                      });
                    } catch (e) {
                      console.error(`æ›´æ–°ä»»å‹™ ${task.taskId} å¤±æ•—:`, e);
                    }
                  }
                });
                
                await Promise.all(updatePromises);
                alert(`âœ… ä»»å‹™æ–°å¢æˆåŠŸï¼Œå·²è‡ªå‹•å°‡å¾ŒçºŒä»»å‹™å»¶å¾Œ ${delayDays} å¤©`);
              } else {
                alert('âœ… ä»»å‹™æ–°å¢æˆåŠŸ');
              }
              
              closeQuickAddModal();
              loadAllTasks(); // é‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
            } else {
              alert('âŒ æ–°å¢å¤±æ•—ï¼š' + (json.message || 'æœªçŸ¥éŒ¯èª¤'));
            }
          } catch (err) {
            console.error('æ–°å¢ä»»å‹™å¤±æ•—', err);
            alert('âŒ æ–°å¢å¤±æ•—ï¼š' + err.message);
          }
        };
        
        // SOP å’ŒæœåŠ¡é¡¹ç›®ç›¸å…³åŠŸèƒ½
        let allSOPs = [];
        let allServices = [];
        let allServiceItems = [];
        
        // åŠ è½½SOPs
        async function loadAllSOPs() {
          try {
            const res = await fetch(`${apiBase}/sop?perPage=500`, { credentials: 'include' });
            if (res.ok) {
              const json = await res.json();
              allSOPs = json.data || [];
            }
          } catch (e) {
            console.error('è¼‰å…¥SOPå¤±æ•—', e);
          }
        }
        
        // åŠ è½½æ‰€æœ‰æœåŠ¡
        async function loadAllServices() {
          try {
            const res = await fetch(`${apiBase}/services`, { credentials: 'include' });
            if (res.ok) {
              const json = await res.json();
              allServices = json.data || [];
            }
          } catch (e) {
            console.error('è¼‰å…¥æœå‹™å¤±æ•—', e);
          }
        }
        
        // åŠ è½½æ‰€æœ‰æœåŠ¡é¡¹ç›®ï¼ˆä»»åŠ¡ç±»å‹ï¼‰
        async function loadAllServiceItems() {
          try {
            const res = await fetch(`${apiBase}/services/items`, { credentials: 'include' });
            if (res.ok) {
              const json = await res.json();
              allServiceItems = json.data || [];
            }
          } catch (e) {
            console.error('è¼‰å…¥æœå‹™é …ç›®å¤±æ•—', e);
          }
        }
        
        // æ‰“å¼€SOPé€‰æ‹©å™¨
        window.openQuickSOPSelector = function() {
          if (!quickAddContext) return;
          
          // æ‰¾åˆ°å½“å‰æœåŠ¡çš„service_codeï¼ˆä½¿ç”¨Stringè½¬æ¢ç¡®ä¿ç±»å‹åŒ¹é…ï¼‰
          const currentService = allServices.find(s => String(s.service_id) === String(quickAddContext.serviceId));
          const serviceCode = currentService?.service_code || '';
          
          console.log('[SOP Filter] serviceId:', quickAddContext.serviceId, 'type:', typeof quickAddContext.serviceId);
          console.log('[SOP Filter] currentService:', currentService);
          console.log('[SOP Filter] serviceCode:', serviceCode);
          
          if (!serviceCode) {
            console.error('[SOP Filter] æ— æ³•æ‰¾åˆ°æœåŠ¡ä¿¡æ¯ï¼allServices:', allServices.map(s => ({id: s.service_id, name: s.service_name})));
          }
          
          // æ ¹æ®æœåŠ¡ç±»å‹å’Œscopeè¿‡æ»¤SOPï¼ˆåªæ˜¾ç¤ºä»»åŠ¡å±‚çº§ä¸”åŒ¹é…æœåŠ¡ç±»å‹çš„SOPï¼‰
          const filteredSOPs = allSOPs.filter(s => 
            s.scope === 'task' && 
            serviceCode && 
            (s.category === serviceCode || s.category === serviceCode.toLowerCase() || s.category === serviceCode.toUpperCase())
          );
          
          console.log('[SOP Filter] Filtered SOPs count:', filteredSOPs.length);
          
          // ç›´æ¥æ¸²æŸ“SOPåˆ—è¡¨ï¼ˆä¸éœ€è¦åˆ†ç±»ï¼Œå› ä¸ºå·²ç»åœ¨ç‰¹å®šæœåŠ¡ä¸‹äº†ï¼‰
          let html = '';
          
          // æŒ‰æ ‡é¢˜æ’åº
          const sortedSOPs = filteredSOPs.sort((a, b) => a.title.localeCompare(b.title));
          
          sortedSOPs.forEach(sop => {
            const isSelected = quickAddContext.selectedSOPs.includes(sop.sop_id);
            html += `
              <div onclick="toggleQuickSOP(${sop.sop_id})" style="cursor:pointer;padding:12px;border:1px solid ${isSelected ? '#3b82f6' : '#e5e7eb'};border-radius:6px;margin-bottom:8px;background:${isSelected ? '#eff6ff' : 'white'};transition:all 0.2s;">
                <div style="display:flex;align-items:center;">
                  <span style="font-size:20px;margin-right:12px;">${isSelected ? 'â˜‘ï¸' : 'â¬œ'}</span>
                  <span style="font-weight:500;color:#1f2937;font-size:14px;">${sop.title}</span>
                </div>
              </div>
            `;
          });
          
          if (html === '') {
            const serviceName = currentService?.service_name || 'æ­¤æœå‹™';
            html = `
              <div style="text-align:center;padding:24px;color:#9ca3af;">
                <div style="font-size:48px;margin-bottom:16px;">ğŸ“‹</div>
                <div style="font-size:14px;color:#6b7280;">
                  æš«ç„¡é©ç”¨æ–¼ <strong>${serviceName}</strong> çš„ä»»å‹™å±¤ç´šSOPæ–‡æª”
                </div>
                <div style="font-size:13px;color:#9ca3af;margin-top:8px;">
                  è«‹å…ˆåœ¨çŸ¥è­˜åº«ä¸­æ–°å¢ç›¸é—œSOP
                </div>
              </div>
            `;
          }
          
          document.getElementById('quick-sop-list').innerHTML = html;
          document.getElementById('quick-sop-modal').style.display = 'flex';
        };
        
        // åˆ‡æ¢SOPé€‰æ‹©
        window.toggleQuickSOP = function(sopId) {
          if (!quickAddContext) return;
          
          const idx = quickAddContext.selectedSOPs.indexOf(sopId);
          if (idx > -1) {
            quickAddContext.selectedSOPs.splice(idx, 1);
          } else {
            quickAddContext.selectedSOPs.push(sopId);
          }
          
          // é‡æ–°æ¸²æŸ“SOPåˆ—è¡¨
          openQuickSOPSelector();
        };
        
        // ç¡®è®¤SOPé€‰æ‹©
        window.confirmQuickSOPSelection = function() {
          // æ˜¾ç¤ºå·²é€‰æ‹©çš„SOP
          if (quickAddContext.selectedSOPs.length > 0) {
            const selectedSOPObjects = allSOPs.filter(s => quickAddContext.selectedSOPs.includes(s.sop_id));
            const html = selectedSOPObjects.map(s => `
              <span style="display:inline-block;padding:4px 10px;background:#eff6ff;color:#3b82f6;border-radius:12px;font-size:12px;margin:2px;">
                ğŸ“„ ${s.title}
                <span onclick="removeQuickSOP(${s.sop_id})" style="cursor:pointer;margin-left:4px;font-weight:bold;">Ã—</span>
              </span>
            `).join('');
            document.getElementById('quick-selected-sops').innerHTML = html;
          } else {
            document.getElementById('quick-selected-sops').innerHTML = '<span style="color:#9ca3af;font-size:13px;">æœªé¸æ“‡</span>';
          }
          
          closeQuickSOPModal();
        };
        
        // ç§»é™¤SOP
        window.removeQuickSOP = function(sopId) {
          if (!quickAddContext) return;
          const idx = quickAddContext.selectedSOPs.indexOf(sopId);
          if (idx > -1) {
            quickAddContext.selectedSOPs.splice(idx, 1);
          }
          confirmQuickSOPSelection();
        };
        
        // å…³é—­SOPæ¨¡æ€æ¡†
        window.closeQuickSOPModal = function() {
          document.getElementById('quick-sop-modal').style.display = 'none';
        };
        
        // å•Ÿå‹•
        init();
        loadAllSOPs(); // åŠ è½½SOPs
        loadAllServices(); // åŠ è½½æœåŠ¡
        loadAllServiceItems(); // åŠ è½½æœåŠ¡é¡¹ç›®
      })();
    </script>
    
    <!-- å¿«é€Ÿæ–°å¢ä»»å‹™æ¨¡æ…‹æ¡† -->
    <div id="quick-add-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;">
      <div style="background:white;border-radius:12px;width:90%;max-width:550px;padding:24px;box-shadow:0 4px 20px rgba(0,0,0,0.15);max-height:90vh;overflow-y:auto;">
        <h3 id="quick-modal-title" style="margin:0 0 20px 0;font-size:18px;color:#1f2937;">æ–°å¢ä»»å‹™</h3>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">
            ä»»å‹™é¡å‹ <span style="color:#dc2626;">*</span>
            <span style="font-size:12px;color:#6b7280;font-weight:normal;">ï¼ˆå¾æœå‹™é …ç›®ä¸­é¸æ“‡ï¼‰</span>
          </label>
          <select id="quick-task-name" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
            <option value="">è«‹é¸æ“‡ä»»å‹™é¡å‹</option>
          </select>
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">è² è²¬äºº</label>
          <select id="quick-assignee" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
            <option value="">æœªæŒ‡å®š</option>
          </select>
        </div>
        
        <div id="quick-prerequisite-group" style="margin-bottom:16px;display:none;">
          <label style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">
            ğŸ”— å‰ç½®ä»»å‹™
            <span style="font-size:12px;color:#6b7280;font-weight:normal;">ï¼ˆæ­¤ä»»å‹™éœ€è¦ç­‰å¾…å“ªå€‹ä»»å‹™å®Œæˆï¼Ÿï¼‰</span>
          </label>
          <select id="quick-prerequisite" onchange="checkAffectedTasks()" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
            <option value="">ç„¡å‰ç½®ä»»å‹™</option>
          </select>
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">åˆ°æœŸæ—¥</label>
          <input type="date" id="quick-due-date" onchange="checkAffectedTasks()"
                 style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;" />
        </div>
        
        <!-- åç»­ä»»åŠ¡å†²çªæç¤ºåŒºåŸŸ -->
        <div id="quick-affected-tasks" style="margin-bottom:16px;display:none;">
          <!-- åŠ¨æ€å¡«å…… -->
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">
            ğŸ“„ ç›¸é—œSOPæ–‡æª”
            <span style="font-size:12px;color:#6b7280;font-weight:normal;">ï¼ˆä»»å‹™å±¤ç´šï¼‰</span>
          </label>
          <div id="quick-selected-sops" style="min-height:28px;padding:8px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;margin-bottom:8px;">
            <span style="color:#9ca3af;font-size:13px;">æœªé¸æ“‡</span>
          </div>
          <button type="button" onclick="openQuickSOPSelector()" 
                  style="padding:6px 12px;background:#f3f4f6;color:#374151;border:1px solid #d1d5db;border-radius:6px;cursor:pointer;font-size:13px;">
            ğŸ“š é¸æ“‡SOPæ–‡æª”
          </button>
        </div>
        
        <div style="margin-bottom:20px;">
          <label style="display:block;margin-bottom:6px;font-weight:500;color:#374151;">å‚™è¨»</label>
          <textarea id="quick-notes" rows="3" placeholder="é¸å¡«..." 
                    style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;resize:vertical;"></textarea>
        </div>
        
        <div style="display:flex;gap:12px;justify-content:flex-end;">
          <button onclick="closeQuickAddModal()" 
                  style="padding:10px 20px;background:#f3f4f6;color:#374151;border:none;border-radius:6px;cursor:pointer;font-size:14px;">
            å–æ¶ˆ
          </button>
          <button onclick="submitQuickTask()" 
                  style="padding:10px 20px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;">
            âœ… å»ºç«‹ä»»å‹™
          </button>
        </div>
      </div>
    </div>
    
    <!-- SOPé¸æ“‡æ¨¡æ…‹æ¡† -->
    <div id="quick-sop-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;align-items:center;justify-content:center;">
      <div style="background:white;border-radius:12px;width:90%;max-width:600px;padding:24px;box-shadow:0 4px 20px rgba(0,0,0,0.15);max-height:80vh;display:flex;flex-direction:column;">
        <h3 style="margin:0 0 16px 0;font-size:18px;color:#1f2937;">é¸æ“‡SOPæ–‡æª”</h3>
        
        <div id="quick-sop-list" style="flex:1;overflow-y:auto;margin-bottom:16px;">
          <!-- SOPåˆ—è¡¨å°†åŠ¨æ€å¡«å…… -->
        </div>
        
        <div style="display:flex;gap:12px;justify-content:flex-end;border-top:1px solid #e5e7eb;padding-top:16px;">
          <button onclick="closeQuickSOPModal()" 
                  style="padding:10px 20px;background:#f3f4f6;color:#374151;border:none;border-radius:6px;cursor:pointer;font-size:14px;">
            å–æ¶ˆ
          </button>
          <button onclick="confirmQuickSOPSelection()" 
                  style="padding:10px 20px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500;">
            âœ… ç¢ºèªé¸æ“‡
          </button>
        </div>
      </div>
    </div>
  </body>
  </html>

