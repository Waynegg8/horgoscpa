<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="任務管理" />
    <title>任務管理｜列表/看板</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/tasks-page.css" />
  </head>
  <body>
    <main class="clients-content" style="padding:24px;">
      <section class="clients-card" style="background:#fff;border:1px solid rgba(15,23,42,0.08);border-radius:10px;padding:16px;">
        <header style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
          <h1 style="margin:0;font-size:22px;font-weight:700;">任務</h1>
          <div class="toolbar" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <div style="display:flex;gap:6px;">
              <button id="btn-list" type="button" class="clients-btn" style="padding:8px 12px;">列表視圖</button>
              <button id="btn-kanban" type="button" class="clients-btn btn-secondary" style="padding:8px 12px;">看板視圖</button>
            </div>
            <input id="q" type="search" placeholder="搜尋任務/客戶…" aria-label="搜尋" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;min-width:220px;" />
            <select id="f_status" aria-label="狀態">
              <option value="all">全部狀態</option>
              <option value="todo">待開始</option>
              <option value="doing">進行中</option>
              <option value="done">已完成</option>
            </select>
            <select id="f_due" aria-label="到期狀態">
              <option value="all">全部到期狀態</option>
              <option value="soon">即將到期（≤3天）</option>
              <option value="overdue">已逾期</option>
            </select>
            <button id="btn-new-task" type="button" class="clients-btn" style="padding:8px 12px;">新增任務</button>
          </div>
        </header>

        <p id="tasks-error" style="color:#c0392b;min-height:1.25rem;margin:8px 0 0 0;"></p>

        <!-- 列表視圖 -->
        <div id="view-list" class="tasks-grid">
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left;padding:10px 8px;border-bottom:1px solid #eee;">任務名稱</th>
                <th style="text-align:left;padding:10px 8px;border-bottom:1px solid #eee;">客戶</th>
                <th style="text-align:left;padding:10px 8px;border-bottom:1px solid #eee;">負責人</th>
                <th style="text-align:left;padding:10px 8px;border-bottom:1px solid #eee;">進度</th>
                <th style="text-align:left;padding:10px 8px;border-bottom:1px solid #eee;">到期日</th>
                <th style="text-align:left;padding:10px 8px;border-bottom:1px solid #eee;">狀態</th>
                <th style="text-align:left;padding:10px 8px;border-bottom:1px solid #eee;">SOP</th>
                <th style="text-align:left;padding:10px 8px;border-bottom:1px solid #eee;">操作</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <!-- 看板視圖 -->
        <div id="view-kanban" style="display:none;gap:16px;grid-template-columns:repeat(3,1fr);" class="tasks-grid">
          <div>
            <h3>待開始</h3>
            <div id="col-todo"></div>
          </div>
          <div>
            <h3>進行中</h3>
            <div id="col-doing"></div>
          </div>
          <div>
            <h3>已完成</h3>
            <div id="col-done"></div>
          </div>
        </div>

        <div class="clients-pagination" id="pager" style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px;">
          <button type="button" id="prev">上一頁</button>
          <button type="button" id="next">下一頁</button>
        </div>
      </section>
    </main>

    <!-- 新增任務彈窗 -->
    <div class="modal-overlay" id="taskModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal" role="document">
        <div class="modal__header">
          <h2 class="modal__title">新增任務</h2>
          <button class="modal__close" type="button" id="task-close">✕</button>
        </div>
        <div class="modal__body">
          <form id="taskForm" class="form-grid">
            <div class="field">
              <label for="tf_client_service_id">客戶服務 ID（必填）</label>
              <input id="tf_client_service_id" name="client_service_id" type="number" min="1" required />
              <div class="field__error" id="te_client_service_id"></div>
            </div>
            <div class="field">
              <label for="tf_task_name">任務名稱（必填）</label>
              <input id="tf_task_name" name="task_name" type="text" maxlength="200" required />
              <div class="field__error" id="te_task_name"></div>
            </div>
            <div class="field">
              <label for="tf_due">到期日（YYYY-MM-DD，可留空）</label>
              <input id="tf_due" name="due_date" type="date" />
              <div class="field__error" id="te_due"></div>
            </div>
            <div class="field">
              <label for="tf_assignee">負責人員 ID（可留空）</label>
              <input id="tf_assignee" name="assignee_user_id" type="number" min="1" />
              <div class="field__error" id="te_assignee"></div>
            </div>
            <div class="field" style="grid-column:1 / -1;">
              <label for="tf_stages">階段名稱（每行一個，可留空）</label>
              <textarea id="tf_stages" name="stage_names" placeholder="收資料\n記帳\n覆核"></textarea>
              <div class="field__error" id="te_stages"></div>
            </div>
            <div class="modal__actions" style="grid-column:1 / -1;">
              <button class="btn-secondary" type="button" id="task-cancel">取消</button>
              <button class="clients-btn" type="submit" id="task-submit">建立</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
        const qEl = document.getElementById('q');
        const statusEl = document.getElementById('f_status');
        const dueEl = document.getElementById('f_due');
        const tbody = document.getElementById('tbody');
        const colTodo = document.getElementById('col-todo');
        const colDoing = document.getElementById('col-doing');
        const colDone = document.getElementById('col-done');
        const viewList = document.getElementById('view-list');
        const viewKanban = document.getElementById('view-kanban');
        const btnList = document.getElementById('btn-list');
        const btnKanban = document.getElementById('btn-kanban');
        const prevBtn = document.getElementById('prev');
        const nextBtn = document.getElementById('next');
        const errEl = document.getElementById('tasks-error');
        const modal = document.getElementById('taskModal');
        const form = document.getElementById('taskForm');
        const btnOpen = document.getElementById('btn-new-task');
        const btnClose = document.getElementById('task-close');
        const btnCancel = document.getElementById('task-cancel');

        let state = { page:1, perPage:20, q:'', status:'all', due:'all', view:'list', total:0 };
        let cacheRows = [];

        const zhStatus = { pending:'待開始', in_progress:'進行中', completed:'已完成', cancelled:'已取消' };

        function setError(m){ if (errEl) errEl.textContent = m || ''; }

        async function load(){
          setError('');
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          if (state.q) params.set('q', state.q);
          if (state.status !== 'all') params.set('status', state.status === 'todo' ? 'pending' : (state.status === 'doing' ? 'in_progress' : state.status));
          if (state.due !== 'all') params.set('due', state.due);
          try {
            const res = await fetch(`${apiBase}/tasks?${params.toString()}`, { credentials: 'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/tasks'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error((json && json.message) || '載入失敗');
            cacheRows = json.data || [];
            state.total = (json.meta && json.meta.total) || 0;
            render();
          } catch (e) {
            setError('載入失敗，請稍後再試');
          }
        }

        function renderPager(){
          prevBtn.disabled = state.page <= 1;
          nextBtn.disabled = state.page * state.perPage >= state.total;
        }

        function renderList(){
          tbody.innerHTML = '';
          cacheRows.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td style="padding:10px 8px;border-bottom:1px solid #f0f0f0;">${r.taskName}</td>
              <td style="padding:10px 8px;border-bottom:1px solid #f0f0f0;">${r.clientName||''}</td>
              <td style="padding:10px 8px;border-bottom:1px solid #f0f0f0;">${r.assigneeName||''}</td>
              <td style="padding:10px 8px;border-bottom:1px solid #f0f0f0;">${r.progress.completed}/${r.progress.total}</td>
              <td style="padding:10px 8px;border-bottom:1px solid #f0f0f0;">${r.dueDate? r.dueDate.slice(5) : ''}</td>
              <td style="padding:10px 8px;border-bottom:1px solid #f0f0f0;">${zhStatus[r.status]||r.status}</td>
              <td style="padding:10px 8px;border-bottom:1px solid #f0f0f0;">${r.hasSop? '有 SOP':'—'}</td>
              <td style="padding:10px 8px;border-bottom:1px solid #f0f0f0;"><button type="button">查看</button></td>
            `;
            tbody.appendChild(tr);
          });
          renderPager();
        }

        function renderKanban(){
          colTodo.innerHTML = ''; colDoing.innerHTML = ''; colDone.innerHTML = '';
          cacheRows.forEach(r => {
            const card = document.createElement('div');
            const cls = r.status==='completed' ? 'completed' : (r.status==='pending' ? 'low-priority' : 'medium-priority');
            card.className = 'task-card ' + cls;
            card.innerHTML = `
              <div class="task-card-header"><h4 class="task-card-title">${r.taskName}</h4></div>
              <div class="task-card-meta">
                <div class="task-card-meta-item">客戶：${r.clientName||''}</div>
                <div class="task-card-meta-item">進度：${r.progress.completed}/${r.progress.total}</div>
                <div class="task-card-meta-item">到期：${r.dueDate? r.dueDate.slice(5):''}</div>
              </div>`;
            if (r.status==='pending') colTodo.appendChild(card); else if (r.status==='in_progress') colDoing.appendChild(card); else colDone.appendChild(card);
          });
          renderPager();
        }

        function render(){ if (state.view==='list') renderList(); else renderKanban(); }
        function switchView(v){ state.view = v; if (v==='list'){ viewList.style.display='block'; viewKanban.style.display='none'; } else { viewList.style.display='none'; viewKanban.style.display='grid'; } render(); }

        // events
        let timer = null;
        qEl.addEventListener('input', () => { clearTimeout(timer); timer = setTimeout(()=>{ state.q = qEl.value.trim(); state.page=1; load(); }, 300); });
        statusEl.addEventListener('change', () => { const v = statusEl.value; state.status = v; state.page=1; load(); });
        dueEl.addEventListener('change', () => { state.due = dueEl.value; state.page=1; load(); });
        prevBtn.addEventListener('click', () => { if (state.page>1){ state.page--; load(); } });
        nextBtn.addEventListener('click', () => { state.page++; load(); });
        btnList.addEventListener('click', () => switchView('list'));
        btnKanban.addEventListener('click', () => switchView('kanban'));

        // init
        switchView('list');
        load();

        // ===== 新增任務：開關與送出 =====
        function openModal(){ modal.classList.add('active'); modal.setAttribute('aria-hidden','false'); }
        function closeModal(){ modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); form.reset(); clearTaskErrors(); }
        btnOpen.addEventListener('click', openModal);
        btnClose.addEventListener('click', closeModal);
        btnCancel.addEventListener('click', closeModal);

        function clearTaskErrors(){ ['client_service_id','task_name','due','assignee','stages'].forEach(k=>{ const el=document.getElementById('te_'+k); if (el) el.textContent=''; }); }
        function parseStages(str){ if (!str) return []; return str.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }

        form.addEventListener('submit', async function(e){
          e.preventDefault();
          clearTaskErrors();
          const client_service_id = parseInt(document.getElementById('tf_client_service_id').value, 10);
          const task_name = document.getElementById('tf_task_name').value.trim();
          const due_date = document.getElementById('tf_due').value.trim();
          const assignee_raw = document.getElementById('tf_assignee').value.trim();
          const assignee_user_id = assignee_raw ? parseInt(assignee_raw, 10) : null;
          const stage_names = parseStages(document.getElementById('tf_stages').value);

          let hasErr = false;
          if (!Number.isInteger(client_service_id) || client_service_id<=0) { document.getElementById('te_client_service_id').textContent='請輸入有效的客戶服務 ID'; hasErr=true; }
          if (task_name.length<1 || task_name.length>200) { document.getElementById('te_task_name').textContent='任務名稱必填（1–200字）'; hasErr=true; }
          if (due_date && !/^\d{4}-\d{2}-\d{2}$/.test(due_date)) { document.getElementById('te_due').textContent='日期格式需為 YYYY-MM-DD'; hasErr=true; }
          if (assignee_raw && (!Number.isInteger(assignee_user_id) || assignee_user_id<=0)) { document.getElementById('te_assignee').textContent='負責人員 ID 格式錯誤'; hasErr=true; }
          if (hasErr) return;

          const payload = { client_service_id, task_name, due_date: due_date || undefined, assignee_user_id: assignee_user_id || undefined, stage_names };
          const submitBtn = document.getElementById('task-submit');
          submitBtn.disabled = true; submitBtn.textContent = '建立中…';
          try {
            const res = await fetch(`${apiBase}/tasks`, { method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify(payload) });
            if (res.status === 401) { location.assign('/login?redirect=/internal/tasks'); return; }
            const json = await res.json().catch(()=>null);
            if (!res.ok || !json || json.ok!==true) {
              const msg = (json && json.message) || '建立失敗';
              if (json && Array.isArray(json.errors) && json.errors.length>0) {
                const e0 = json.errors[0]; const el = document.getElementById('te_'+(e0.field||'')); if (el) el.textContent = e0.message || msg; else setError(msg);
              } else { setError(msg); }
              return;
            }
            alert('已建立任務');
            closeModal();
            state.page = 1; load();
          } catch (_) {
            setError('建立失敗，請稍後再試');
          } finally {
            submitBtn.disabled = false; submitBtn.textContent = '建立';
          }
        });
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


