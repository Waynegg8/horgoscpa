<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="任務管理" />
    <title>任務管理</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/tasks-page.css" />
    <style>
      /* 日期選擇器 - 整框可點擊 */
      input[type="date"] {
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        cursor: pointer !important;
        position: relative !important;
      }
      
      input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute !important;
        top: 0; left: 0; right: 0; bottom: 0;
        width: 100% !important; height: 100% !important;
        margin: 0; padding: 0; opacity: 0; cursor: pointer !important;
      }
      
      .client-group {
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
      }
      
      .client-header {
        background: #f9fafb;
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .client-header:hover {
        background: #f3f4f6;
      }
      
      .service-group {
        border-bottom: 1px solid #f3f4f6;
      }
      
      .service-header {
        background: #ffffff;
        padding: 10px 16px 10px 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .service-header:hover {
        background: #f9fafb;
      }
      
      .task-row {
        display: grid;
        grid-template-columns: 40px 2fr 140px 90px 110px 110px 100px;
        gap: 12px;
        padding: 12px 16px 12px 56px;
        border-bottom: 1px solid #f9fafb;
        align-items: center;
      }
      
      .task-row:hover {
        background: #f9fafb;
      }
    </style>
  </head>
  <body>
    <main class="clients-content" style="padding:24px;">
      <section class="clients-card" style="background:#fff;border:1px solid rgba(15,23,42,0.08);border-radius:10px;padding:16px;">
        <header style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
          <h1 style="margin:0;font-size:22px;font-weight:700;">任務</h1>
          <div class="toolbar" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <input id="q" type="search" placeholder="搜尋任務/客戶/統編…" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;min-width:220px;" />
            <select id="f_year" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
              <option value="all">全部年份</option>
            </select>
            <select id="f_month" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
              <option value="all">全部月份</option>
              <option value="1">1月</option>
              <option value="2">2月</option>
              <option value="3">3月</option>
              <option value="4">4月</option>
              <option value="5">5月</option>
              <option value="6">6月</option>
              <option value="7">7月</option>
              <option value="8">8月</option>
              <option value="9">9月</option>
              <option value="10">10月</option>
              <option value="11">11月</option>
              <option value="12">12月</option>
            </select>
            <select id="f_assignee" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
              <option value="all">全部負責人</option>
            </select>
            <select id="f_tags" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
              <option value="all">全部標籤</option>
            </select>
            <select id="f_status" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
              <option value="all">全部狀態</option>
              <option value="pending">待開始</option>
              <option value="in_progress">進行中</option>
              <option value="completed">已完成</option>
            </select>
            <select id="f_due" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
              <option value="all">全部到期狀態</option>
              <option value="soon">即將到期（≤3天）</option>
              <option value="overdue">已逾期</option>
            </select>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;background:#fff;">
              <input type="checkbox" id="f_hide_completed" style="cursor:pointer;" />
              <span style="font-size:14px;">隐藏已完成</span>
            </label>
            <button id="btn-batch-assign" type="button" class="clients-btn btn-secondary" style="padding:8px 12px;display:none;">批量分配</button>
            <button id="btn-new-task" type="button" class="clients-btn" style="padding:8px 12px;">新增任務</button>
          </div>
        </header>

        <p id="tasks-error" style="color:#c0392b;min-height:1.25rem;margin:8px 0 0 0;"></p>

        <div id="tasks-list" style="margin-top:16px;"></div>
      </section>
    </main>

    <!-- 批量分配彈窗 -->
    <div class="modal-overlay" id="batchModal" aria-hidden="true">
      <div class="modal">
        <div class="modal__header">
          <h2 class="modal__title">批量分配負責人</h2>
          <button class="modal__close" id="batch-close">✕</button>
        </div>
        <div class="modal__body">
          <p style="margin-bottom:16px;color:#6b7280;">已選擇 <strong id="selected-count">0</strong> 個任務</p>
            <div class="field">
            <label for="batch_assignee">選擇負責人</label>
            <select id="batch_assignee">
                <option value="">請選擇負責人</option>
              </select>
            </div>
          <div class="modal__actions" style="margin-top:20px;">
            <button class="btn-secondary" id="batch-cancel">取消</button>
            <button class="clients-btn" id="batch-submit">確認分配</button>
            </div>
        </div>
      </div>
    </div>

    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
        
        let allTasks = [];
        let allClients = [];
        let allTags = [];
        let employeesList = [];
        let selectedTaskIds = new Set();

        const zhStatus = { pending:'待開始', in_progress:'進行中', completed:'已完成', cancelled:'已取消' };

        // 初始化
        async function init() {
          // 初始化年份下拉（最近5年）
          const currentYear = new Date().getFullYear();
          const yearSelect = document.getElementById('f_year');
          yearSelect.innerHTML = '<option value="all">全部年份</option>';
          for (let i = 0; i < 5; i++) {
            const year = currentYear - i;
            const selected = i === 0 ? ' selected' : '';
            yearSelect.innerHTML += `<option value="${year}"${selected}>${year}年</option>`;
          }
          
          // 默认设置：显示当前年 + 全部月份 + 隐藏已完成
          // 这样能看到当前年所有未完成的任务（包括历史遗留的）
          document.getElementById('f_month').value = 'all';  // 全部月份
          document.getElementById('f_hide_completed').checked = true;  // 默认隐藏已完成
          
          await Promise.all([
            loadEmployees(),
            loadAllClients(),
            loadAllTags(),
            loadAllTasks()
          ]);
        }
        
        // 加載員工
        async function loadEmployees() {
          try {
            const res = await fetch(`${apiBase}/users`, { credentials: 'include' });
            if (res.status === 401) { location.href = '/login?redirect=/internal/tasks'; return; }
            const json = await res.json();
            if (json.ok) {
              employeesList = json.data || [];
              
              // 填充篩選下拉
              document.getElementById('f_assignee').innerHTML = '<option value="all">全部負責人</option>' +
                employeesList.map(e => `<option value="${e.user_id}">${e.name}</option>`).join('');
              
              // 填充批量分配下拉
              document.getElementById('batch_assignee').innerHTML = '<option value="">請選擇負責人</option>' +
                employeesList.map(e => `<option value="${e.user_id}">${e.name}</option>`).join('');
            }
          } catch (e) {
            console.error('載入員工失敗', e);
          }
        }
        
        // 加載客戶
        async function loadAllClients() {
          try {
            const res = await fetch(`${apiBase}/clients?perPage=1000`, { credentials: 'include' });
            if (res.status === 401) { location.href = '/login?redirect=/internal/tasks'; return; }
            const json = await res.json();
            if (json.ok) {
              allClients = json.data || [];
            }
          } catch (e) {
            console.error('載入客戶失敗', e);
          }
        }
        
        // 加載標籤
        async function loadAllTags() {
          try {
            const res = await fetch(`${apiBase}/tags`, { credentials: 'include' });
            if (res.status === 401) { location.href = '/login?redirect=/internal/tasks'; return; }
            const json = await res.json();
            if (json.ok) {
              allTags = json.data || [];
              document.getElementById('f_tags').innerHTML = '<option value="all">全部標籤</option>' +
                allTags.map(t => `<option value="${t.tag_id}">${t.tag_name}</option>`).join('');
            }
          } catch (e) {
            console.error('載入標籤失敗', e);
          }
        }
        
        // 加載任務
        async function loadAllTasks() {
          try {
            const params = new URLSearchParams({ perPage: '1000' });
            
            // 年月筛选
            const year = document.getElementById('f_year').value;
            const month = document.getElementById('f_month').value;
            if (year !== 'all') params.append('service_year', year);
            if (month !== 'all') params.append('service_month', month);
            
            // 注意：不传 hide_completed 给后端，前端自己处理
            // 这样才能实现"显示有未完成任务的组的所有任务"的逻辑
            
            const res = await fetch(`${apiBase}/tasks?${params}`, { credentials: 'include' });
            if (res.status === 401) { location.href = '/login?redirect=/internal/tasks'; return; }
            const json = await res.json();
            if (json.ok) {
              allTasks = json.data || [];
            render();
            }
          } catch (e) {
            console.error('載入任務失敗', e);
            document.getElementById('tasks-error').textContent = '載入失敗';
          }
        }
        
        // 篩選任務
        function filterTasks() {
          const q = document.getElementById('q').value.toLowerCase();
          const assignee = document.getElementById('f_assignee').value;
          const tags = document.getElementById('f_tags').value;
          const status = document.getElementById('f_status').value;
          const due = document.getElementById('f_due').value;
          
          return allTasks.filter(task => {
            // 搜索
            if (q && !task.taskName.toLowerCase().includes(q) && 
                !task.clientName.toLowerCase().includes(q) &&
                !(task.clientTaxId && task.clientTaxId.includes(q))) {
              return false;
            }
            
            // 負責人
            if (assignee !== 'all' && String(task.assigneeUserId) !== assignee) {
              return false;
            }
            
            // 狀態
            if (status !== 'all' && task.status !== status) {
              return false;
            }
            
            // 到期
            if (due === 'soon') {
              const dueDate = new Date(task.dueDate);
              const today = new Date();
              const diff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
              if (diff > 3 || diff < 0) return false;
            } else if (due === 'overdue') {
              const dueDate = new Date(task.dueDate);
              const today = new Date();
              if (dueDate >= today || task.status === 'completed') return false;
            }
            
            return true;
          });
        }
        
        // 按客戶和服務+月份分組
        function groupByClientAndService(tasks) {
          const hideCompleted = document.getElementById('f_hide_completed').checked;
          const grouped = new Map();
          
          // 先添加所有客戶
          allClients.sort((a, b) => (a.companyName || '').localeCompare(b.companyName || '', 'zh-TW')).forEach(client => {
            grouped.set(client.clientId, {
              clientId: client.clientId,
              clientName: client.companyName || '未命名客戶',
              clientTaxId: client.taxId || '—',
              serviceGroups: new Map()
            });
          });
          
          // 添加任務（按服務+月份分組）
          tasks.forEach(task => {
            const clientId = task.clientId || 'unknown';
            if (!grouped.has(clientId)) {
              grouped.set(clientId, {
                clientId,
                clientName: task.clientName || '未命名客戶',
                clientTaxId: task.clientTaxId || '—',
                serviceGroups: new Map()
              });
            }
            
            const client = grouped.get(clientId);
            const serviceName = task.serviceName || '一般任務';
            const serviceMonth = task.serviceMonth || '';
            
            // 组合键：服務名 + 月份
            const groupKey = serviceMonth ? `${serviceName}|||${serviceMonth}` : serviceName;
            
            if (!client.serviceGroups.has(groupKey)) {
              client.serviceGroups.set(groupKey, {
                serviceName,
                serviceMonth,
                tasks: []
              });
            }
            
            client.serviceGroups.get(groupKey).tasks.push(task);
          });
          
          // 如果勾选"隐藏已完成"，过滤掉全部完成的组
          if (hideCompleted) {
            grouped.forEach(client => {
              const filteredGroups = new Map();
              
              client.serviceGroups.forEach((group, key) => {
                // 检查是否有未完成任务
                const hasIncomplete = group.tasks.some(t => t.status !== 'completed');
                
                // 只保留有未完成任务的组
                if (hasIncomplete) {
                  filteredGroups.set(key, group);
                }
              });
              
              client.serviceGroups = filteredGroups;
            });
          }
          
          // 排序服務組和任務
          grouped.forEach(client => {
            const sortedGroups = new Map([...client.serviceGroups.entries()].sort((a, b) => {
              // 先按服务名排序
              const serviceCompare = a[1].serviceName.localeCompare(b[1].serviceName, 'zh-TW');
              if (serviceCompare !== 0) return serviceCompare;
              
              // 再按月份降序排序（最新月份在前）
              return (b[1].serviceMonth || '').localeCompare(a[1].serviceMonth || '');
            }));
            
            client.serviceGroups = sortedGroups;
          });
          
          return grouped;
        }
        
        // 渲染
        function render() {
          const filtered = filterTasks();
          const grouped = groupByClientAndService(filtered);
          const container = document.getElementById('tasks-list');
          
          let html = '';
          
          grouped.forEach((client, clientId) => {
            const hasGroups = client.serviceGroups.size > 0;
            const clientIdSafe = clientId.replace(/[^a-zA-Z0-9]/g, '_');
            
            html += `
              <div class="client-group">
                <div class="client-header" onclick="toggleClient('${clientIdSafe}')">
                  <span id="icon-${clientIdSafe}" style="font-size:16px;">▶</span>
                  <strong style="font-size:16px;color:#1f2937;">${client.clientName} ${client.clientTaxId !== '—' ? `(${client.clientTaxId})` : ''}</strong>
                </div>
                <div id="group-${clientIdSafe}" style="display:none;">
            `;
            
            if (!hasGroups) {
              html += `
                <div style="padding:16px;text-align:center;color:#9ca3af;font-size:14px;">
                  此客戶目前沒有任務
                </div>
              `;
            } else {
              client.serviceGroups.forEach((group, groupKey) => {
                const tasks = group.tasks;
                if (tasks.length === 0) return;
                
                // 计算完成情况
                const completed = tasks.filter(t => t.status === 'completed').length;
                const total = tasks.length;
                
                // 格式化服务+月份标题
                const monthText = group.serviceMonth ? ` - ${group.serviceMonth.slice(0, 4)}年${parseInt(group.serviceMonth.slice(5))}月` : '';
                const serviceTitle = `${group.serviceName}${monthText}`;
                
                // 生成唯一ID：客户ID + 服务组键
                const groupIdSafe = `${clientIdSafe}_${groupKey.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                html += `
                  <div class="service-group">
                    <div class="service-header" onclick="toggleService('${groupIdSafe}')">
                      <span id="icon-${groupIdSafe}" style="font-size:14px;">▶</span>
                      <strong style="font-size:14px;color:#374151;">${serviceTitle}</strong>
                      <span style="color:#9ca3af;font-size:13px;">(${total}個任務: ${completed}已完成, ${total - completed}未完成)</span>
                    </div>
                    <div id="group-${groupIdSafe}" style="display:none;">
                `;
                
                tasks.forEach(task => {
                  const checked = selectedTaskIds.has(task.taskId) ? 'checked' : '';
                  html += `
                    <div class="task-row">
                      <div><input type="checkbox" ${checked} onchange="toggleTaskSelection('${task.taskId}', this.checked)" /></div>
                      <div>
                        <div style="font-weight:500;color:#1f2937;margin-bottom:4px;">${task.taskName}</div>
                        <div style="font-size:12px;color:#6b7280;">進度：${task.progress.completed}/${task.progress.total}</div>
                      </div>
                      <div style="font-size:13px;color:#6b7280;">${task.assigneeName || '未分配'}</div>
                      <div style="font-size:13px;color:#4b5563;">${task.dueDate ? task.dueDate.slice(5) : '—'}</div>
                      <div><span style="display:inline-block;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;${getStatusStyle(task.status)}">${zhStatus[task.status]}</span></div>
                      <div><a href="/internal/task-detail?id=${task.taskId}" style="color:#3b82f6;text-decoration:none;font-size:14px;">查看詳情</a></div>
                    </div>
                  `;
                });
                
                html += `
                    </div>
                  </div>
                `;
              });
            }
            
            html += `
                </div>
              </div>
            `;
          });
          
          if (html === '') {
            html = '<div style="text-align:center;padding:48px;color:#9ca3af;">沒有符合條件的任務</div>';
          }
          
          container.innerHTML = html;
          updateBatchButton();
        }
        
        // 狀態樣式
        function getStatusStyle(status) {
          const styles = {
            'pending': 'background:#f3f4f6;color:#6b7280;',
            'in_progress': 'background:#fef3c7;color:#d97706;',
            'completed': 'background:#d1fae5;color:#059669;',
            'cancelled': 'background:#fee2e2;color:#dc2626;'
          };
          return styles[status] || styles['pending'];
        }
        
        // 切換客戶分組
        window.toggleClient = function(id) {
          const group = document.getElementById('group-' + id);
          const icon = document.getElementById('icon-' + id);
          if (group && icon) {
            const isHidden = group.style.display === 'none';
            group.style.display = isHidden ? 'block' : 'none';
            icon.textContent = isHidden ? '▼' : '▶';
          }
        };
        
        // 切換服務分組
        window.toggleService = function(id) {
          const group = document.getElementById('group-' + id);
          const icon = document.getElementById('icon-' + id);
          if (group && icon) {
            const isHidden = group.style.display === 'none';
            group.style.display = isHidden ? 'block' : 'none';
            icon.textContent = isHidden ? '▼' : '▶';
          }
        };
        
        // 任務選擇
        window.toggleTaskSelection = function(taskId, checked) {
          if (checked) {
            selectedTaskIds.add(taskId);
          } else {
            selectedTaskIds.delete(taskId);
          }
          updateBatchButton();
        };
        
        function updateBatchButton() {
          const btn = document.getElementById('btn-batch-assign');
          const count = document.getElementById('selected-count');
          btn.style.display = selectedTaskIds.size > 0 ? 'inline-block' : 'none';
          if (count) count.textContent = selectedTaskIds.size;
        }
        
        // 批量分配
        document.getElementById('btn-batch-assign').addEventListener('click', () => {
          document.getElementById('batchModal').classList.add('active');
          document.getElementById('batchModal').setAttribute('aria-hidden', 'false');
        });
        
        document.getElementById('batch-close').addEventListener('click', () => {
          document.getElementById('batchModal').classList.remove('active');
          document.getElementById('batchModal').setAttribute('aria-hidden', 'true');
        });
        
        document.getElementById('batch-cancel').addEventListener('click', () => {
          document.getElementById('batchModal').classList.remove('active');
          document.getElementById('batchModal').setAttribute('aria-hidden', 'true');
        });
        
        document.getElementById('batch-submit').addEventListener('click', async () => {
          const assigneeId = document.getElementById('batch_assignee').value;
          if (!assigneeId) {
            alert('請選擇負責人');
              return;
            }
          
          try {
            const tasks = Array.from(selectedTaskIds);
            await Promise.all(tasks.map(taskId =>
              fetch(`${apiBase}/tasks/${taskId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ assignee_user_id: parseInt(assigneeId) })
              })
            ));
            
            alert('已成功分配');
            selectedTaskIds.clear();
            document.getElementById('batchModal').classList.remove('active');
            await loadAllTasks();
          } catch (e) {
            alert('分配失敗');
          }
        });
        
        // 篩選事件
        let timer;
        document.getElementById('q').addEventListener('input', () => {
          clearTimeout(timer);
          timer = setTimeout(render, 300);
        });
        document.getElementById('f_assignee').addEventListener('change', render);
        document.getElementById('f_tags').addEventListener('change', render);
        document.getElementById('f_status').addEventListener('change', render);
        document.getElementById('f_due').addEventListener('change', render);
        
        // 年月筛选和隐藏已完成 - 需要重新加载任务
        document.getElementById('f_year').addEventListener('change', loadAllTasks);
        document.getElementById('f_month').addEventListener('change', loadAllTasks);
        document.getElementById('f_hide_completed').addEventListener('change', loadAllTasks);
        
        // 啟動
        init();
      })();
    </script>
  </body>
  </html>

