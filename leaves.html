<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="å‡æœŸç®¡ç†" />
    <title>å‡æœŸç®¡ç†ï½œæˆ‘çš„å‡æœŸèˆ‡ç”³è«‹</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/leaves-page.css" />
    
    <!-- âš¡ é åŠ è¼‰ç³»çµ±ï¼ˆå¿…é ˆåœ¨æ‰€æœ‰å…¶ä»–è…³æœ¬ä¹‹å‰åŠ è¼‰ï¼‰ -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <script src="/assets/js/prerender.js"></script>
    <script src="/assets/js/page-prerender.js"></script>
    
    <style>
      /* ç»Ÿä¸€è¡¨å•æ§ä»¶æ ·å¼ - å¼ºåˆ¶æ‰€æœ‰è¾“å…¥æ¡†ç›¸åŒé«˜åº¦ */
      .form-control,
      input.form-control,
      select.form-control,
      input[type="text"].form-control,
      input[type="date"].form-control {
        height: 44px !important;
        min-height: 44px !important;
        max-height: 44px !important;
        padding: 0 12px !important;
        font-size: 14px !important;
        line-height: 44px !important;
        border: 1px solid rgba(15, 23, 42, 0.15) !important;
        border-radius: 8px !important;
        width: 100% !important;
        box-sizing: border-box !important;
        transition: border-color 0.2s;
        vertical-align: middle !important;
        background-color: white !important;
        display: block !important;
        margin: 0 !important;
      }
      
      /* textarea ä½¿ç”¨è‡ªå®šä¹‰é«˜åº¦ */
      textarea.form-control {
        height: 80px !important;
        min-height: 80px !important;
        max-height: 200px !important;
        padding: 10px 12px !important;
        line-height: 1.5 !important;
        resize: vertical !important;
      }
      
      .form-control:focus {
        outline: none !important;
        border-color: #2563eb !important;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1) !important;
      }
      
      .form-control:disabled,
      .form-control[readonly] {
        background-color: #f1f5f9 !important;
        cursor: not-allowed;
      }
      
      /* ç¡®ä¿selectä¸‹æ‹‰ç®­å¤´ä¸è¢«é®æŒ¡ */
      select.form-control {
        appearance: none !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23334155' d='M6 9L1 4h10z'/%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: right 12px center !important;
        padding-right: 36px !important;
        line-height: 1 !important;
      }
      
      /* æ—¥æœŸé€‰æ‹©å™¨ - ç»Ÿä¸€é«˜åº¦å¹¶ç§»é™¤æµè§ˆå™¨é»˜è®¤æ ·å¼ */
      input[type="date"].form-control {
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        line-height: 1 !important;
        cursor: pointer !important;
        position: relative !important;
      }
      
      /* è®©æ—¥å†å›¾æ ‡è¦†ç›–æ•´ä¸ªè¾“å…¥æ¡†ï¼Œä½¿æ•´ä¸ªåŒºåŸŸéƒ½å¯ä»¥ç‚¹å‡» */
      input[type="date"].form-control::-webkit-calendar-picker-indicator {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        opacity: 0 !important;
        cursor: pointer !important;
      }
      
      /* ç§»é™¤æ—¥æœŸé€‰æ‹©å™¨çš„å†…éƒ¨æ§ä»¶å½±å“é«˜åº¦ */
      input[type="date"].form-control::-webkit-inner-spin-button {
        display: none !important;
      }
      
      /* ç§»é™¤ WebKit çš„æ—¥æœŸè¾“å…¥æ¡†é»˜è®¤æ ·å¼ */
      input[type="date"].form-control::-webkit-datetime-edit {
        padding: 0 !important;
        line-height: 1 !important;
      }
      
      input[type="date"].form-control::-webkit-datetime-edit-fields-wrapper {
        padding: 0 !important;
      }
      
      /* ç¡®ä¿å­—æ®µæç¤ºä¸å½±å“è¾“å…¥æ¡†å¯¹é½ */
      .field__hint {
        min-height: 20px !important;
        margin-top: 4px !important;
        font-size: 12px !important;
        color: rgba(15, 23, 42, 0.6) !important;
      }
      
      /* ç¡®ä¿æ²¡æœ‰æç¤ºçš„å­—æ®µä¹Ÿä¿æŒå¯¹é½ */
      .field {
        display: flex !important;
        flex-direction: column !important;
      }
      
      .field label {
        margin-bottom: 6px !important;
      }
      
      /* ä¿®å¤æ¨¡æ€æ¡†å†…å®¹æº¢å‡ºé—®é¢˜ */
      .modal {
        box-sizing: border-box !important;
      }
      
      .modal__body {
        box-sizing: border-box !important;
        overflow: hidden !important;
      }
      
      /* ç¡®ä¿è¡¨å•ç½‘æ ¼ä¸ä¼šæº¢å‡º */
      .form-grid {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 16px !important;
        box-sizing: border-box !important;
        margin: 0 !important;
      }
      
      /* æŒ‰é’®å®¹å™¨æ ·å¼ */
      .modal__actions {
        display: flex !important;
        justify-content: flex-end !important;
        gap: 12px !important;
        margin: 0 !important;
        padding: 0 !important;
        box-sizing: border-box !important;
      }
      
      .modal__actions button {
        flex-shrink: 0 !important;
      }
    </style>
  </head>
  <body class="leaves-page">
    <div style="padding:24px 24px 8px 24px;">
      <div class="leaves-toolbar" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:flex-start;">
        <select id="user-select" aria-label="é¸æ“‡å“¡å·¥" style="display:none;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;min-width:180px;">
          <option value="">å…¨éƒ¨å“¡å·¥</option>
        </select>
        <select id="leave-type-filter" aria-label="ç¯©é¸å‡åˆ¥" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;min-width:180px;">
          <option value="">å…¨éƒ¨å‡åˆ¥</option>
          <option value="annual">ç‰¹ä¼‘</option>
          <option value="sick">ç—…å‡</option>
          <option value="personal">äº‹å‡</option>
          <option value="comp">è£œä¼‘</option>
          <option value="menstrual">ç”Ÿç†å‡</option>
          <option value="maternity">ç”¢å‡</option>
          <option value="prenatal_checkup">ç”¢æª¢å‡</option>
          <option value="paternity">é™ªç”¢æª¢åŠé™ªç”¢å‡</option>
          <option value="marriage">å©šå‡</option>
          <option value="funeral">å–ªå‡</option>
          <option value="public">å…¬å‡</option>
        </select>
        <button id="btn-apply" class="clients-btn" type="button">ç”³è«‹å‡æœŸ</button>
        <button id="btn-event" class="clients-btn btn-secondary" type="button">ç™»è¨˜ç”Ÿæ´»äº‹ä»¶</button>
      </div>
    </div>

    <main style="padding:24px; display:grid; gap:16px;">
      <section class="leaves-card">
        <h2 style="margin:0 0 8px 0; font-size:16px;">é¤˜é¡ç¸½è¦½</h2>
        <div class="balance-grid" id="balances">
          <!-- éª¨æ¶ï¼šé¤˜é¡å¡ -->
        </div>
      </section>

      <section class="leaves-card">
        <h2 style="margin:0 0 8px 0; font-size:16px;">æˆ‘çš„ç”³è«‹</h2>
        <table class="leaves-table" aria-label="ç”³è«‹åˆ—è¡¨">
          <thead>
            <tr>
              <th>å‡åˆ¥</th>
              <th>æ—¥æœŸèˆ‡æ™‚é–“</th>
              <th>æ™‚æ•¸</th>
              <th>æäº¤æ—¥æœŸ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="clients-pagination" id="pager" style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
          <button type="button" id="prev">ä¸Šä¸€é </button>
          <button type="button" id="next">ä¸‹ä¸€é </button>
        </div>
      </section>
    </main>

    <!-- ç™»è¨˜ç”Ÿæ´»äº‹ä»¶å°è©±æ¡† -->
    <div class="modal-overlay" id="eventModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal" role="document">
        <div class="modal__header">
          <h2 class="modal__title">ç™»è¨˜ç”Ÿæ´»äº‹ä»¶</h2>
          <button class="modal__close" type="button" id="btn-event-close">âœ•</button>
        </div>
        <div class="modal__body">
          <form id="eventForm" class="form-grid">
            <div class="field">
              <label for="event_type">äº‹ä»¶é¡å‹</label>
              <select id="event_type" name="event_type" required class="form-control">
                <option value="">è«‹é¸æ“‡</option>
                <option value="marriage">çµå©š</option>
                <option value="funeral_parent">çˆ¶æ¯/é¤Šçˆ¶æ¯/ç¹¼çˆ¶æ¯/é…å¶å–ªäº¡</option>
                <option value="funeral_grandparent">ç¥–çˆ¶æ¯/å­å¥³/é…å¶ä¹‹çˆ¶æ¯å–ªäº¡</option>
                <option value="funeral_sibling">æ›¾ç¥–çˆ¶æ¯/å…„å¼Ÿå§Šå¦¹/é…å¶ä¹‹ç¥–çˆ¶æ¯å–ªäº¡</option>
                <option value="maternity" data-gender="F">åˆ†å¨©</option>
                <option value="miscarriage" data-gender="F">å¦Šå¨ 3å€‹æœˆä»¥ä¸Šæµç”¢</option>
                <option value="pregnancy" data-gender="F">å¦Šå¨ </option>
                <option value="paternity" data-gender="M">é…å¶åˆ†å¨©æˆ–æ‡·å­•</option>
              </select>
              <div class="field__hint">é¸é …æœƒä¾æ‚¨çš„æ€§åˆ¥è‡ªå‹•éæ¿¾ã€‚</div>
              <div class="field__error" id="e_event_type"></div>
            </div>
            <div class="field">
              <label for="event_date">äº‹ä»¶æ—¥æœŸ</label>
              <input id="event_date" name="event_date" type="date" required class="form-control" />
              <div class="field__hint" style="visibility:hidden;">å ä½</div>
              <div class="field__error" id="e_event_date"></div>
            </div>
            <div class="field">
              <label for="event_notes">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
              <textarea id="event_notes" name="notes" maxlength="200" placeholder="ä¾‹å¦‚ï¼šé—œä¿‚ã€è­‰æ˜æ–‡ä»¶ç­‰" class="form-control"></textarea>
              <div class="field__error" id="e_event_notes"></div>
            </div>
            <div class="field" style="display:flex; align-items:flex-end; padding-top:80px; padding-bottom:20px;">
              <div class="modal__actions" style="width:100%;">
                <button class="btn-secondary" type="button" id="btn-event-cancel">å–æ¶ˆ</button>
                <button class="clients-btn" type="submit" id="btn-event-submit">ç™»è¨˜</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ç”³è«‹å‡æœŸå°è©±æ¡†ï¼ˆéª¨æ¶ï¼‰ -->
    <div class="modal-overlay" id="applyModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal" role="document">
        <div class="modal__header">
          <h2 class="modal__title">ç”³è«‹å‡æœŸ</h2>
          <button class="modal__close" type="button" id="btn-close">âœ•</button>
        </div>
        <div class="modal__body">
          <form id="applyForm" class="form-grid">
            <div class="field">
              <label for="leave_type">å‡åˆ¥</label>
              <select id="leave_type" name="leave_type" required class="form-control">
                <option value="">è«‹é¸æ“‡</option>
                <option value="annual">ç‰¹ä¼‘</option>
                <option value="sick">ç—…å‡</option>
                <option value="personal">äº‹å‡</option>
                <option value="comp">è£œä¼‘</option>
                <option value="menstrual" data-gender="F">ç”Ÿç†å‡</option>
                <option value="maternity" data-gender="F" data-life-event="true" style="display:none;">ç”¢å‡</option>
                <option value="prenatal_checkup" data-gender="F" data-life-event="true" style="display:none;">ç”¢æª¢å‡</option>
                <option value="paternity" data-gender="M" data-life-event="true" style="display:none;">é™ªç”¢æª¢åŠé™ªç”¢å‡</option>
                <option value="marriage" data-life-event="true" style="display:none;">å©šå‡</option>
                <option value="funeral" data-life-event="true" style="display:none;">å–ªå‡</option>
                <option value="public">å…¬å‡</option>
              </select>
              <div class="field__hint">å‡åˆ¥æœƒä¾æ‚¨çš„æ€§åˆ¥å’Œå·²ç™»è¨˜çš„ç”Ÿæ´»äº‹ä»¶è‡ªå‹•éæ¿¾ã€‚</div>
              <div class="field__error" id="e_type"></div>
            </div>
            <div class="field">
              <label for="start_date">è«‹å‡æ—¥æœŸ</label>
              <input id="start_date" name="start_date" type="date" required class="form-control" />
              <div class="field__error" id="e_start"></div>
            </div>
            <div class="field">
              <label for="start_time">é–‹å§‹æ™‚é–“</label>
              <select id="start_time" name="start_time" required class="form-control">
                <option value="">è«‹é¸æ“‡</option>
              </select>
              <div class="field__error" id="e_start_time"></div>
            </div>
            <div class="field">
              <label for="end_time">çµæŸæ™‚é–“</label>
              <select id="end_time" name="end_time" required class="form-control">
                <option value="">è«‹é¸æ“‡</option>
              </select>
              <div class="field__error" id="e_end_time"></div>
            </div>
            <div class="field">
              <label for="hours_display">è«‹å‡æ™‚æ•¸</label>
              <input id="hours_display" type="text" readonly class="form-control" style="background:#f1f5f9;cursor:not-allowed;" placeholder="è‡ªå‹•è¨ˆç®—" />
              <div class="field__hint">æ™‚æ•¸å°‡æ ¹æ“šé–‹å§‹å’ŒçµæŸæ™‚é–“è‡ªå‹•è¨ˆç®—ï¼ˆæ‰£é™¤åˆä¼‘ï¼‰</div>
            </div>
            <div class="field" style="display:flex; align-items:flex-end; padding-top:48px; padding-bottom:20px;">
              <div class="modal__actions" style="width:100%;">
                <button class="btn-secondary" type="button" id="btn-cancel">å–æ¶ˆ</button>
                <button class="clients-btn" type="submit" id="btn-submit">é€å‡ºç”³è«‹</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const balanceEl = document.getElementById('balances');
        const tbody = document.getElementById('tbody');
        const leaveTypeFilterEl = document.getElementById('leave-type-filter');
        const prevBtn = document.getElementById('prev');
        const nextBtn = document.getElementById('next');
        const userSelectEl = document.getElementById('user-select');

        const zhType = { 
          annual:'ç‰¹ä¼‘', 
          sick:'ç—…å‡', 
          personal:'äº‹å‡', 
          comp:'è£œä¼‘', 
          menstrual:'ç”Ÿç†å‡', 
          maternity:'ç”¢å‡', 
          prenatal_checkup:'ç”¢æª¢å‡',
          paternity:'é™ªç”¢æª¢åŠé™ªç”¢å‡', 
          marriage:'å©šå‡', 
          funeral:'å–ªå‡',
          public:'å…¬å‡'
        };
        const zhStatus = { pending:'å¾…å¯©', approved:'å·²æ ¸å‡†', rejected:'å·²é§å›' };

        let state = { page:1, perPage:20, total:0, isAdmin: false, selectedUserId: null };

        async function loadBalances(){
          balanceEl.innerHTML = '';
          const year = new Date().getFullYear();
          try {
            const params = new URLSearchParams();
            params.set('year', year);
            if (state.isAdmin && state.selectedUserId) {
              params.set('user_id', state.selectedUserId);
            }
            const res = await fetch(`${apiBase}/leaves/balances?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/leaves'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || [];
            if (data.length === 0) {
              balanceEl.innerHTML = '<p style="color:rgba(15,23,42,0.7);">ç„¡é¤˜é¡è³‡æ–™</p>';
              return;
            }
            // å»é‡ï¼šå¦‚æœæœ‰é‡è¤‡çš„å‡æœŸé¡å‹ï¼Œåªä¿ç•™ç¬¬ä¸€å€‹
            const seen = new Set();
            data.forEach(b => {
              if (seen.has(b.type)) return; // è·³éé‡è¤‡çš„
              seen.add(b.type);
              
              const el = document.createElement('div');
              el.className = 'balance-card';
              const label = zhType[b.type] || b.type;
              const unit = b.type === 'comp' ? 'å°æ™‚' : 'å¤©';
              
              // è£œä¼‘é¡¯ç¤ºä¸åŒçš„èªªæ˜æ–‡å­—ï¼ˆç•¶æœˆæœ‰æ•ˆï¼Œæ¬¡æœˆè½‰åŠ ç­è²»ï¼‰
              if (b.type === 'comp') {
                el.innerHTML = `<h4>${label}</h4><p>ç•¶æœˆå‰©é¤˜ ${b.remain} å°æ™‚<br><small style="color:rgba(15,23,42,0.6);">æ¬¡æœˆè½‰åŠ ç­è²»</small></p>`;
              } else {
                el.innerHTML = `<h4>${label}</h4><p>å‰©é¤˜ ${b.remain} / é¡åº¦ ${b.total} å¤©</p>`;
              }
              
              balanceEl.appendChild(el);
            });
          } catch (_) {
            balanceEl.innerHTML = '<p style="color:#c0392b;">é¤˜é¡è¼‰å…¥å¤±æ•—</p>';
          }
        }

        function renderPager(){
          prevBtn.disabled = state.page <= 1;
          nextBtn.disabled = state.page * state.perPage >= state.total;
        }

        function renderRows(rows){
          tbody.innerHTML = '';
          rows.forEach(r => {
            const tr = document.createElement('tr');
            const typeText = zhType[r.type] || r.type;
            const dateTimeText = r.start + (r.startTime && r.endTime ? ` ${r.startTime}-${r.endTime}` : '');
            const hours = `${r.amount} å°æ™‚`;
            tr.innerHTML = `<td>${typeText}</td><td>${dateTimeText}</td><td>${hours}</td><td>${r.submittedAt?.slice(0,10) || ''}</td>`;
            tbody.appendChild(tr);
          });
        }

        async function loadLeaves(){
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          const selectedType = leaveTypeFilterEl.value.trim();
          if (selectedType) params.set('type', selectedType);
          if (state.isAdmin && state.selectedUserId) {
            params.set('user_id', state.selectedUserId);
          }
          try {
            const res = await fetch(`${apiBase}/leaves?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/leaves'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            state.total = (json.meta && json.meta.total) || 0;
            renderRows(json.data || []);
            renderPager();
          } catch (_) {
            tbody.innerHTML = '<tr><td colspan="4" style="color:#c0392b;">è¼‰å…¥å¤±æ•—</td></tr>';
            renderPager();
          }
        }

        // ç™»è¨˜ç”Ÿæ´»äº‹ä»¶å°è©±æ¡†
        const eventModal = document.getElementById('eventModal');
        const eventOpenBtn = document.getElementById('btn-event');
        const eventCloseBtn = document.getElementById('btn-event-close');
        const eventCancelBtn = document.getElementById('btn-event-cancel');
        const eventForm = document.getElementById('eventForm');
        function openEventModal(){ eventModal.classList.add('active'); eventModal.setAttribute('aria-hidden','false'); document.getElementById('event_type').focus(); }
        function closeEventModal(){ eventModal.classList.remove('active'); eventModal.setAttribute('aria-hidden','true'); eventForm.reset(); clearEventErrors(); }
        function clearEventErrors(){ ['event_type','event_date','event_notes'].forEach(k=>{ const el=document.getElementById('e_'+k); if(el) el.textContent=''; }); }
        eventOpenBtn.addEventListener('click', openEventModal);
        eventCloseBtn.addEventListener('click', closeEventModal);
        eventCancelBtn.addEventListener('click', closeEventModal);

        eventForm.addEventListener('submit', async function(e){
          e.preventDefault();
          clearEventErrors();
          const eventType = document.getElementById('event_type').value;
          const eventDate = document.getElementById('event_date').value;
          const notes = document.getElementById('event_notes').value.trim();
          let hasErr = false;
          if (!eventType) { document.getElementById('e_event_type').textContent='è«‹é¸æ“‡äº‹ä»¶é¡å‹'; hasErr = true; }
          if (!eventDate) { document.getElementById('e_event_date').textContent='è«‹é¸æ“‡æ—¥æœŸ'; hasErr = true; }
          if (hasErr) return;
          const payload = { event_type: eventType, event_date: eventDate, notes };
          const submitBtn = document.getElementById('btn-event-submit');
          submitBtn.disabled = true; submitBtn.textContent = 'ç™»è¨˜ä¸­â€¦';
          try {
            const res = await fetch(`${apiBase}/leaves/life-events`, { method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify(payload) });
            if (res.status === 401) { location.assign('/login?redirect=/internal/leaves'); return; }
            const json = await res.json().catch(()=>null);
            if (!res.ok || !json || json.ok !== true) {
              const msg = (json && json.message) || 'ç™»è¨˜å¤±æ•—';
              alert(msg);
              return;
            }
            alert(json.message || 'ç™»è¨˜æˆåŠŸ');
            closeEventModal();
            await loadBalances();
            // é‡æ–°è¼‰å…¥å¯ç”¨å‡æœŸé¸é …
            const meRes = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (meRes.ok) {
              const meJson = await meRes.json();
              const userGender = meJson.data?.gender || null;
              await showAvailableLifeEventLeaves(userGender);
            }
          } catch (_) {
            alert('ç™»è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          } finally {
            submitBtn.disabled = false; submitBtn.textContent = 'ç™»è¨˜';
          }
        });
        
        // ç”³è«‹å‡æœŸå°è©±æ¡†ï¼ˆéª¨æ¶ï¼‰
        const modal = document.getElementById('applyModal');
        const openBtn = document.getElementById('btn-apply');
        const closeBtn = document.getElementById('btn-close');
        const cancelBtn = document.getElementById('btn-cancel');
        const form = document.getElementById('applyForm');
        function openModal(){ modal.classList.add('active'); modal.setAttribute('aria-hidden','false'); document.getElementById('leave_type').focus(); }
        function closeModal(){ modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); form.reset(); clearErrors(); document.getElementById('hours_display').value = ''; }
        function clearErrors(){ ['type','start','start_time','end_time'].forEach(k=>{ const el=document.getElementById('e_'+k); if(el) el.textContent=''; }); }
        
        // ç”Ÿæˆä¸Šç­æ™‚é–“é¸é …ï¼ˆ8:30-12:30, 13:30-17:30ï¼ŒåŠå°æ™‚é–“éš”ï¼‰
        function populateTimeOptions() {
          const startTimeSelect = document.getElementById('start_time');
          const endTimeSelect = document.getElementById('end_time');
          
          const times = [];
          // ä¸Šåˆæ™‚æ®µï¼š8:30-12:30
          for (let h = 8; h <= 12; h++) {
            if (h === 8) {
              times.push({ value: '08:30', label: '08:30' });
            } else if (h === 12) {
              times.push({ value: '12:00', label: '12:00' });
              times.push({ value: '12:30', label: '12:30' });
            } else {
              times.push({ value: `${String(h).padStart(2,'0')}:00`, label: `${String(h).padStart(2,'0')}:00` });
              times.push({ value: `${String(h).padStart(2,'0')}:30`, label: `${String(h).padStart(2,'0')}:30` });
            }
          }
          // ä¸‹åˆæ™‚æ®µï¼š13:30-17:30
          for (let h = 13; h <= 17; h++) {
            if (h === 13) {
              times.push({ value: '13:30', label: '13:30' });
            } else {
              times.push({ value: `${String(h).padStart(2,'0')}:00`, label: `${String(h).padStart(2,'0')}:00` });
              times.push({ value: `${String(h).padStart(2,'0')}:30`, label: `${String(h).padStart(2,'0')}:30` });
            }
          }
          
          times.forEach(t => {
            const opt1 = document.createElement('option');
            opt1.value = t.value;
            opt1.textContent = t.label;
            startTimeSelect.appendChild(opt1);
            
            const opt2 = document.createElement('option');
            opt2.value = t.value;
            opt2.textContent = t.label;
            endTimeSelect.appendChild(opt2);
          });
        }
        
        // è¨ˆç®—è«‹å‡æ™‚æ•¸ï¼ˆæ‰£é™¤åˆä¼‘æ™‚é–“ï¼‰
        function calculateHours(startTime, endTime) {
          if (!startTime || !endTime) return 0;
          
          const [sh, sm] = startTime.split(':').map(Number);
          const [eh, em] = endTime.split(':').map(Number);
          
          const startMinutes = sh * 60 + sm;
          const endMinutes = eh * 60 + em;
          
          if (endMinutes <= startMinutes) return 0;
          
          const lunchStart = 12 * 60 + 30; // 12:30
          const lunchEnd = 13 * 60 + 30;   // 13:30
          
          let totalMinutes = endMinutes - startMinutes;
          
          // æ‰£é™¤åˆä¼‘æ™‚é–“
          if (startMinutes < lunchEnd && endMinutes > lunchStart) {
            const lunchOverlap = Math.min(endMinutes, lunchEnd) - Math.max(startMinutes, lunchStart);
            if (lunchOverlap > 0) {
              totalMinutes -= lunchOverlap;
            }
          }
          
          return totalMinutes / 60;
        }
        openBtn.addEventListener('click', openModal);
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);

        // åˆå§‹åŒ–æ™‚é–“é¸é …
        populateTimeOptions();
        
        // ç›£è½æ™‚é–“è®ŠåŒ–ï¼Œè‡ªå‹•è¨ˆç®—æ™‚æ•¸
        const startTimeSelect = document.getElementById('start_time');
        const endTimeSelect = document.getElementById('end_time');
        const hoursDisplay = document.getElementById('hours_display');
        
        function updateHoursDisplay() {
          const hours = calculateHours(startTimeSelect.value, endTimeSelect.value);
          if (hours > 0) {
            hoursDisplay.value = `${hours} å°æ™‚`;
          } else {
            hoursDisplay.value = '';
          }
        }
        
        startTimeSelect.addEventListener('change', updateHoursDisplay);
        endTimeSelect.addEventListener('change', updateHoursDisplay);

        form.addEventListener('submit', async function(e){
          e.preventDefault();
          clearErrors();
          const t = document.getElementById('leave_type').value;
          const s = document.getElementById('start_date').value;
          const startTime = document.getElementById('start_time').value;
          const endTime = document.getElementById('end_time').value;
          let hasErr = false;
          if (!t) { document.getElementById('e_type').textContent='è«‹é¸æ“‡å‡åˆ¥'; hasErr = true; }
          if (!s) { document.getElementById('e_start').textContent='è«‹é¸æ“‡æ—¥æœŸ'; hasErr = true; }
          if (!startTime) { document.getElementById('e_start_time').textContent='è«‹é¸æ“‡é–‹å§‹æ™‚é–“'; hasErr = true; }
          if (!endTime) { document.getElementById('e_end_time').textContent='è«‹é¸æ“‡çµæŸæ™‚é–“'; hasErr = true; }
          
          // è¨ˆç®—æ™‚æ•¸
          const hours = calculateHours(startTime, endTime);
          if (hours <= 0) { 
            document.getElementById('e_end_time').textContent='çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“'; 
            hasErr = true; 
          }
          
          if (hasErr) return;
          
          // æª¢æŸ¥é¡åº¦æ˜¯å¦è¶…å‡ºä¸Šé™
          try {
            const year = new Date().getFullYear();
            const balRes = await fetch(`${apiBase}/leaves/balances?year=${year}`, { credentials:'include' });
            if (balRes.ok) {
              const balJson = await balRes.json();
              if (balJson.ok && balJson.data) {
                const balance = balJson.data.find(b => b.type === t);
                if (balance) {
                  const remainHours = balance.remain * 8; // å‡è¨­é¤˜é¡æ˜¯å¤©æ•¸ï¼Œè½‰æ›ç‚ºå°æ™‚ï¼ˆç‰¹ä¼‘ã€ç”Ÿæ´»äº‹ä»¶å‡ï¼‰
                  const remainActual = ['comp'].includes(t) ? balance.remain : remainHours;
                  
                  if (hours > remainActual) {
                    const typeName = zhType[t] || t;
                    const unit = ['comp'].includes(t) ? 'å°æ™‚' : 'å¤©';
                    const remain = ['comp'].includes(t) ? remainActual : balance.remain;
                    if (!confirm(`${typeName}é¤˜é¡ä¸è¶³ï¼\nå‰©é¤˜ï¼š${remain} ${unit}\nç”³è«‹ï¼š${hours} å°æ™‚\n\næ˜¯å¦ä»è¦é€å‡ºç”³è«‹ï¼Ÿ`)) {
                      return;
                    }
                  }
                }
              }
            }
          } catch (err) {
            console.error('æª¢æŸ¥é¡åº¦å¤±æ•—:', err);
          }
          const payload = { 
            leave_type: t, 
            start_date: s, 
            start_time: startTime,
            end_time: endTime,
            amount: hours
          };
          const submitBtn = document.getElementById('btn-submit');
          submitBtn.disabled = true; submitBtn.textContent = 'é€å‡ºä¸­â€¦';
          try {
            const res = await fetch(`${apiBase}/leaves`, { method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify(payload) });
            if (res.status === 401) { location.assign('/login?redirect=/internal/leaves'); return; }
            const json = await res.json().catch(()=>null);
            if (!res.ok || !json || json.ok !== true) {
              const msg = (json && json.message) || 'é€å‡ºå¤±æ•—';
              if (json && Array.isArray(json.errors) && json.errors.length>0) {
                const e0 = json.errors[0]; const el = document.getElementById('e_'+(e0.field||'')); if (el) el.textContent = e0.message || msg; else alert(msg);
              } else { alert(msg); }
              return;
            }
            alert('ç”³è«‹æˆåŠŸ');
            closeModal();
            state.page = 1; await loadBalances(); await loadLeaves();
          } catch (_) {
            alert('é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          } finally {
            submitBtn.disabled = false; submitBtn.textContent = 'é€å‡ºç”³è«‹';
          }
        });

        // å‡åˆ¥ç¯©é¸
        leaveTypeFilterEl.addEventListener('change', ()=>{ state.page=1; loadLeaves(); });
        prevBtn.addEventListener('click', ()=>{ if (state.page>1) { state.page--; loadLeaves(); } });
        nextBtn.addEventListener('click', ()=>{ state.page++; loadLeaves(); });
        
        // å“¡å·¥é¸æ“‡å™¨è®Šæ›´
        userSelectEl.addEventListener('change', function() {
          state.selectedUserId = this.value || null;
          state.page = 1;
          loadBalances();
          loadLeaves();
        });

        // æ ¹æ“šæ€§åˆ¥éæ¿¾å‡æœŸé¸é …
        function filterLeaveTypesByGender(gender) {
          const leaveTypeSelect = document.getElementById('leave_type');
          const options = leaveTypeSelect.querySelectorAll('option');
          options.forEach(option => {
            const requiredGender = option.getAttribute('data-gender');
            const isLifeEvent = option.getAttribute('data-life-event');
            // ç”Ÿæ´»äº‹ä»¶å‡æœŸä¸åœ¨è¿™é‡Œè¿‡æ»¤ï¼Œç”± showAvailableLifeEventLeaves å¤„ç†
            if (!isLifeEvent && requiredGender && requiredGender !== gender) {
              option.style.display = 'none';
              option.disabled = true;
            } else if (!isLifeEvent && requiredGender && requiredGender === gender) {
              option.style.display = '';
              option.disabled = false;
            }
          });
        }
        
        // æ ¹æ“šç”Ÿæ´»äº‹ä»¶é¤˜é¡é¡¯ç¤ºå¯ç”¨çš„å‡æœŸé¸é …ï¼ˆä¸¦è€ƒæ…®æ€§åˆ¥é™åˆ¶ï¼‰
        async function showAvailableLifeEventLeaves(userGender) {
          const leaveTypeSelect = document.getElementById('leave_type');
          const lifeEventOptions = leaveTypeSelect.querySelectorAll('option[data-life-event="true"]');
          
          try {
            // ç²å–å‡æœŸé¤˜é¡
            const year = new Date().getFullYear();
            const res = await fetch(`${apiBase}/leaves/balances?year=${year}`, { credentials:'include' });
            if (!res.ok) return;
            const json = await res.json();
            if (!json.ok || !json.data) return;
            
            // å–å¾—æœ‰é¤˜é¡çš„ç”Ÿæ´»äº‹ä»¶å‡æœŸé¡å‹
            const availableTypes = new Set();
            json.data.forEach(balance => {
              if (balance.remain > 0 && ['marriage', 'funeral', 'maternity', 'prenatal_checkup', 'paternity'].includes(balance.type)) {
                availableTypes.add(balance.type);
              }
            });
            
            // é¡¯ç¤ºæœ‰é¤˜é¡ä¸”ç¬¦åˆæ€§åˆ¥çš„é¸é …
            lifeEventOptions.forEach(option => {
              const leaveType = option.value;
              const requiredGender = option.getAttribute('data-gender');
              
              // æª¢æŸ¥æ€§åˆ¥é™åˆ¶
              const genderMatches = !requiredGender || requiredGender === userGender;
              
              if (availableTypes.has(leaveType) && genderMatches) {
                option.style.display = '';
                option.disabled = false;
              } else {
                option.style.display = 'none';
                option.disabled = true;
              }
            });
          } catch (err) {
            console.error('è¼‰å…¥ç”Ÿæ´»äº‹ä»¶å‡æœŸé¸é …å¤±æ•—:', err);
          }
        }

        // æ ¹æ“šæ€§åˆ¥éæ¿¾ç”Ÿæ´»äº‹ä»¶é¸é …
        function filterEventTypesByGender(gender) {
          const eventTypeSelect = document.getElementById('event_type');
          const options = eventTypeSelect.querySelectorAll('option');
          options.forEach(option => {
            const requiredGender = option.getAttribute('data-gender');
            if (requiredGender && requiredGender !== gender) {
              option.style.display = 'none';
              option.disabled = true;
            } else {
              option.style.display = '';
              option.disabled = false;
            }
          });
        }

        // åˆå§‹åŒ–ï¼šæª¢æŸ¥ç”¨æˆ¶æ¬Šé™ä¸¦è¼‰å…¥å“¡å·¥åˆ—è¡¨
        async function init() {
          try {
            // ç²å–ç•¶å‰ç”¨æˆ¶ä¿¡æ¯
            const meRes = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (meRes.status === 401) { location.assign('/login?redirect=/internal/leaves'); return; }
            const meJson = await meRes.json();
            if (meJson.ok && meJson.data) {
              state.isAdmin = meJson.data.isAdmin || false;
              const userGender = meJson.data.gender || null;
              
              // æ ¹æ“šæ€§åˆ¥éæ¿¾å‡æœŸé¸é …
              if (userGender) {
                filterLeaveTypesByGender(userGender);
                filterEventTypesByGender(userGender);
                // è¼‰å…¥å¯ç”¨çš„ç”Ÿæ´»äº‹ä»¶å‡æœŸé¸é …ï¼ˆè€ƒæ…®æ€§åˆ¥ï¼‰
                await showAvailableLifeEventLeaves(userGender);
              } else {
                await showAvailableLifeEventLeaves(null);
              }
              
              // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œé¡¯ç¤ºå“¡å·¥é¸æ“‡å™¨ä¸¦è¼‰å…¥å“¡å·¥åˆ—è¡¨
              if (state.isAdmin) {
                userSelectEl.style.display = 'block';
                
                // è¼‰å…¥å“¡å·¥åˆ—è¡¨
                const usersRes = await fetch(`${apiBase}/users`, { credentials:'include' });
                if (usersRes.ok) {
                  const usersJson = await usersRes.json();
                  if (usersJson.ok && usersJson.data) {
                    usersJson.data.forEach(user => {
                      const option = document.createElement('option');
                      option.value = user.user_id;
                      option.textContent = user.name;
                      userSelectEl.appendChild(option);
                    });
                  }
                }
              }
            }
          } catch (err) {
            console.error('åˆå§‹åŒ–å¤±æ•—:', err);
          }
          
          // è¼‰å…¥æ•¸æ“š
          loadBalances();
          loadLeaves();
        }
        
        init();
      })();
    </script>
    
    <!-- âš¡ é¢„æ¸²æŸ“åˆå§‹åŒ– -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (window.PagePrerender) {
        // å°è¯•åŠ è½½é¢„æ¸²æŸ“ HTML
        window.PagePrerender.init('main.internal-container', function(isBackgroundUpdate) {
          if (isBackgroundUpdate) {
            console.log('[Leaves] ğŸ”„ åå°æ›´æ–°æ•°æ®');
          }
        });
        
        // å¯ç”¨è‡ªåŠ¨ä¿å­˜
        window.PagePrerender.autoSave('main.internal-container');
      }
    });
    </script>
    
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


