<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="假期管理" />
    <title>假期管理｜我的假期與申請</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/leaves-page.css" />
    <style>
      /* 统一表单控件样式 - 强制所有输入框相同高度 */
      .form-control,
      input.form-control,
      select.form-control,
      input[type="text"].form-control,
      input[type="date"].form-control {
        height: 44px !important;
        min-height: 44px !important;
        max-height: 44px !important;
        padding: 0 12px !important;
        font-size: 14px !important;
        line-height: 44px !important;
        border: 1px solid rgba(15, 23, 42, 0.15) !important;
        border-radius: 8px !important;
        width: 100% !important;
        box-sizing: border-box !important;
        transition: border-color 0.2s;
        vertical-align: middle !important;
        background-color: white !important;
        display: block !important;
        margin: 0 !important;
      }
      
      /* textarea 使用自定义高度 */
      textarea.form-control {
        height: 80px !important;
        min-height: 80px !important;
        max-height: 200px !important;
        padding: 10px 12px !important;
        line-height: 1.5 !important;
        resize: vertical !important;
      }
      
      .form-control:focus {
        outline: none !important;
        border-color: #2563eb !important;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1) !important;
      }
      
      .form-control:disabled,
      .form-control[readonly] {
        background-color: #f1f5f9 !important;
        cursor: not-allowed;
      }
      
      /* 确保select下拉箭头不被遮挡 */
      select.form-control {
        appearance: none !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23334155' d='M6 9L1 4h10z'/%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: right 12px center !important;
        padding-right: 36px !important;
        line-height: 1 !important;
      }
      
      /* 日期选择器 - 统一高度并移除浏览器默认样式 */
      input[type="date"].form-control {
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        line-height: 1 !important;
        cursor: pointer !important;
        position: relative !important;
      }
      
      /* 让日历图标覆盖整个输入框，使整个区域都可以点击 */
      input[type="date"].form-control::-webkit-calendar-picker-indicator {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        opacity: 0 !important;
        cursor: pointer !important;
      }
      
      /* 移除日期选择器的内部控件影响高度 */
      input[type="date"].form-control::-webkit-inner-spin-button {
        display: none !important;
      }
      
      /* 移除 WebKit 的日期输入框默认样式 */
      input[type="date"].form-control::-webkit-datetime-edit {
        padding: 0 !important;
        line-height: 1 !important;
      }
      
      input[type="date"].form-control::-webkit-datetime-edit-fields-wrapper {
        padding: 0 !important;
      }
      
      /* 确保字段提示不影响输入框对齐 */
      .field__hint {
        min-height: 20px !important;
        margin-top: 4px !important;
        font-size: 12px !important;
        color: rgba(15, 23, 42, 0.6) !important;
      }
      
      /* 确保没有提示的字段也保持对齐 */
      .field {
        display: flex !important;
        flex-direction: column !important;
      }
      
      .field label {
        margin-bottom: 6px !important;
      }
      
      /* 修复模态框内容溢出问题 */
      .modal {
        box-sizing: border-box !important;
      }
      
      .modal__body {
        box-sizing: border-box !important;
        overflow: hidden !important;
      }
      
      /* 确保表单网格不会溢出 */
      .form-grid {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 16px !important;
        box-sizing: border-box !important;
        margin: 0 !important;
      }
      
      /* 按钮容器样式 */
      .modal__actions {
        display: flex !important;
        justify-content: flex-end !important;
        gap: 12px !important;
        margin: 0 !important;
        padding: 0 !important;
        box-sizing: border-box !important;
      }
      
      .modal__actions button {
        flex-shrink: 0 !important;
      }
    </style>
  </head>
  <body class="leaves-page">
    <header class="leaves-header">
      <h1 class="leaves-title">假期管理</h1>
      <div class="leaves-toolbar">
        <select id="user-select" aria-label="選擇員工" style="display:none;padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;min-width:180px;">
          <option value="">全部員工</option>
        </select>
        <select id="leave-type-filter" aria-label="篩選假別" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;min-width:180px;">
          <option value="">全部假別</option>
          <option value="annual">特休</option>
          <option value="sick">病假</option>
          <option value="personal">事假</option>
          <option value="comp">補休</option>
          <option value="menstrual">生理假</option>
          <option value="maternity">產假</option>
          <option value="prenatal_checkup">產檢假</option>
          <option value="paternity">陪產檢及陪產假</option>
          <option value="marriage">婚假</option>
          <option value="funeral">喪假</option>
          <option value="public">公假</option>
        </select>
        <button id="btn-apply" class="clients-btn" type="button">申請假期</button>
        <button id="btn-event" class="clients-btn btn-secondary" type="button">登記生活事件</button>
      </div>
    </header>

    <main style="padding:24px; display:grid; gap:16px;">
      <section class="leaves-card">
        <h2 style="margin:0 0 8px 0; font-size:16px;">餘額總覽</h2>
        <div class="balance-grid" id="balances">
          <!-- 骨架：餘額卡 -->
        </div>
      </section>

      <section class="leaves-card">
        <h2 style="margin:0 0 8px 0; font-size:16px;">我的申請</h2>
        <table class="leaves-table" aria-label="申請列表">
          <thead>
            <tr>
              <th>假別</th>
              <th>日期與時間</th>
              <th>時數</th>
              <th>提交日期</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="clients-pagination" id="pager" style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
          <button type="button" id="prev">上一頁</button>
          <button type="button" id="next">下一頁</button>
        </div>
      </section>
    </main>

    <!-- 登記生活事件對話框 -->
    <div class="modal-overlay" id="eventModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal" role="document">
        <div class="modal__header">
          <h2 class="modal__title">登記生活事件</h2>
          <button class="modal__close" type="button" id="btn-event-close">✕</button>
        </div>
        <div class="modal__body">
          <form id="eventForm" class="form-grid">
            <div class="field">
              <label for="event_type">事件類型</label>
              <select id="event_type" name="event_type" required class="form-control">
                <option value="">請選擇</option>
                <option value="marriage">結婚</option>
                <option value="funeral_parent">父母/養父母/繼父母/配偶喪亡</option>
                <option value="funeral_grandparent">祖父母/子女/配偶之父母喪亡</option>
                <option value="funeral_sibling">曾祖父母/兄弟姊妹/配偶之祖父母喪亡</option>
                <option value="maternity" data-gender="F">分娩</option>
                <option value="miscarriage" data-gender="F">妊娠3個月以上流產</option>
                <option value="pregnancy" data-gender="F">妊娠</option>
                <option value="paternity" data-gender="M">配偶分娩或懷孕</option>
              </select>
              <div class="field__hint">選項會依您的性別自動過濾。</div>
              <div class="field__error" id="e_event_type"></div>
            </div>
            <div class="field">
              <label for="event_date">事件日期</label>
              <input id="event_date" name="event_date" type="date" required class="form-control" />
              <div class="field__hint" style="visibility:hidden;">占位</div>
              <div class="field__error" id="e_event_date"></div>
            </div>
            <div class="field">
              <label for="event_notes">備註（選填）</label>
              <textarea id="event_notes" name="notes" maxlength="200" placeholder="例如：關係、證明文件等" class="form-control"></textarea>
              <div class="field__error" id="e_event_notes"></div>
            </div>
            <div class="field" style="display:flex; align-items:flex-end; padding-top:80px; padding-bottom:20px;">
              <div class="modal__actions" style="width:100%;">
                <button class="btn-secondary" type="button" id="btn-event-cancel">取消</button>
                <button class="clients-btn" type="submit" id="btn-event-submit">登記</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 申請假期對話框（骨架） -->
    <div class="modal-overlay" id="applyModal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="modal" role="document">
        <div class="modal__header">
          <h2 class="modal__title">申請假期</h2>
          <button class="modal__close" type="button" id="btn-close">✕</button>
        </div>
        <div class="modal__body">
          <form id="applyForm" class="form-grid">
            <div class="field">
              <label for="leave_type">假別</label>
              <select id="leave_type" name="leave_type" required class="form-control">
                <option value="">請選擇</option>
                <option value="annual">特休</option>
                <option value="sick">病假</option>
                <option value="personal">事假</option>
                <option value="comp">補休</option>
                <option value="menstrual" data-gender="F">生理假</option>
                <option value="maternity" data-gender="F" data-life-event="true" style="display:none;">產假</option>
                <option value="prenatal_checkup" data-gender="F" data-life-event="true" style="display:none;">產檢假</option>
                <option value="paternity" data-gender="M" data-life-event="true" style="display:none;">陪產檢及陪產假</option>
                <option value="marriage" data-life-event="true" style="display:none;">婚假</option>
                <option value="funeral" data-life-event="true" style="display:none;">喪假</option>
                <option value="public">公假</option>
              </select>
              <div class="field__hint">假別會依您的性別和已登記的生活事件自動過濾。</div>
              <div class="field__error" id="e_type"></div>
            </div>
            <div class="field">
              <label for="start_date">請假日期</label>
              <input id="start_date" name="start_date" type="date" required class="form-control" />
              <div class="field__error" id="e_start"></div>
            </div>
            <div class="field">
              <label for="start_time">開始時間</label>
              <select id="start_time" name="start_time" required class="form-control">
                <option value="">請選擇</option>
              </select>
              <div class="field__error" id="e_start_time"></div>
            </div>
            <div class="field">
              <label for="end_time">結束時間</label>
              <select id="end_time" name="end_time" required class="form-control">
                <option value="">請選擇</option>
              </select>
              <div class="field__error" id="e_end_time"></div>
            </div>
            <div class="field">
              <label for="hours_display">請假時數</label>
              <input id="hours_display" type="text" readonly class="form-control" style="background:#f1f5f9;cursor:not-allowed;" placeholder="自動計算" />
              <div class="field__hint">時數將根據開始和結束時間自動計算（扣除午休）</div>
            </div>
            <div class="field" style="display:flex; align-items:flex-end; padding-top:48px; padding-bottom:20px;">
              <div class="modal__actions" style="width:100%;">
                <button class="btn-secondary" type="button" id="btn-cancel">取消</button>
                <button class="clients-btn" type="submit" id="btn-submit">送出申請</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const balanceEl = document.getElementById('balances');
        const tbody = document.getElementById('tbody');
        const leaveTypeFilterEl = document.getElementById('leave-type-filter');
        const prevBtn = document.getElementById('prev');
        const nextBtn = document.getElementById('next');
        const userSelectEl = document.getElementById('user-select');

        const zhType = { 
          annual:'特休', 
          sick:'病假', 
          personal:'事假', 
          comp:'補休', 
          menstrual:'生理假', 
          maternity:'產假', 
          prenatal_checkup:'產檢假',
          paternity:'陪產檢及陪產假', 
          marriage:'婚假', 
          funeral:'喪假',
          public:'公假'
        };
        const zhStatus = { pending:'待審', approved:'已核准', rejected:'已駁回' };

        let state = { page:1, perPage:20, total:0, isAdmin: false, selectedUserId: null };

        async function loadBalances(){
          balanceEl.innerHTML = '';
          const year = new Date().getFullYear();
          try {
            const params = new URLSearchParams();
            params.set('year', year);
            if (state.isAdmin && state.selectedUserId) {
              params.set('user_id', state.selectedUserId);
            }
            const res = await fetch(`${apiBase}/leaves/balances?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/leaves'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || [];
            if (data.length === 0) {
              balanceEl.innerHTML = '<p style="color:rgba(15,23,42,0.7);">無餘額資料</p>';
              return;
            }
            // 去重：如果有重複的假期類型，只保留第一個
            const seen = new Set();
            data.forEach(b => {
              if (seen.has(b.type)) return; // 跳過重複的
              seen.add(b.type);
              
              const el = document.createElement('div');
              el.className = 'balance-card';
              const label = zhType[b.type] || b.type;
              const unit = b.type === 'comp' ? '小時' : '天';
              
              // 補休顯示不同的說明文字（當月有效，次月轉加班費）
              if (b.type === 'comp') {
                el.innerHTML = `<h4>${label}</h4><p>當月剩餘 ${b.remain} 小時<br><small style="color:rgba(15,23,42,0.6);">次月轉加班費</small></p>`;
              } else {
                el.innerHTML = `<h4>${label}</h4><p>剩餘 ${b.remain} / 額度 ${b.total} 天</p>`;
              }
              
              balanceEl.appendChild(el);
            });
          } catch (_) {
            balanceEl.innerHTML = '<p style="color:#c0392b;">餘額載入失敗</p>';
          }
        }

        function renderPager(){
          prevBtn.disabled = state.page <= 1;
          nextBtn.disabled = state.page * state.perPage >= state.total;
        }

        function renderRows(rows){
          tbody.innerHTML = '';
          rows.forEach(r => {
            const tr = document.createElement('tr');
            const typeText = zhType[r.type] || r.type;
            const dateTimeText = r.start + (r.startTime && r.endTime ? ` ${r.startTime}-${r.endTime}` : '');
            const hours = `${r.amount} 小時`;
            tr.innerHTML = `<td>${typeText}</td><td>${dateTimeText}</td><td>${hours}</td><td>${r.submittedAt?.slice(0,10) || ''}</td>`;
            tbody.appendChild(tr);
          });
        }

        async function loadLeaves(){
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          const selectedType = leaveTypeFilterEl.value.trim();
          if (selectedType) params.set('type', selectedType);
          if (state.isAdmin && state.selectedUserId) {
            params.set('user_id', state.selectedUserId);
          }
          try {
            const res = await fetch(`${apiBase}/leaves?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/leaves'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            state.total = (json.meta && json.meta.total) || 0;
            renderRows(json.data || []);
            renderPager();
          } catch (_) {
            tbody.innerHTML = '<tr><td colspan="4" style="color:#c0392b;">載入失敗</td></tr>';
            renderPager();
          }
        }

        // 登記生活事件對話框
        const eventModal = document.getElementById('eventModal');
        const eventOpenBtn = document.getElementById('btn-event');
        const eventCloseBtn = document.getElementById('btn-event-close');
        const eventCancelBtn = document.getElementById('btn-event-cancel');
        const eventForm = document.getElementById('eventForm');
        function openEventModal(){ eventModal.classList.add('active'); eventModal.setAttribute('aria-hidden','false'); document.getElementById('event_type').focus(); }
        function closeEventModal(){ eventModal.classList.remove('active'); eventModal.setAttribute('aria-hidden','true'); eventForm.reset(); clearEventErrors(); }
        function clearEventErrors(){ ['event_type','event_date','event_notes'].forEach(k=>{ const el=document.getElementById('e_'+k); if(el) el.textContent=''; }); }
        eventOpenBtn.addEventListener('click', openEventModal);
        eventCloseBtn.addEventListener('click', closeEventModal);
        eventCancelBtn.addEventListener('click', closeEventModal);

        eventForm.addEventListener('submit', async function(e){
          e.preventDefault();
          clearEventErrors();
          const eventType = document.getElementById('event_type').value;
          const eventDate = document.getElementById('event_date').value;
          const notes = document.getElementById('event_notes').value.trim();
          let hasErr = false;
          if (!eventType) { document.getElementById('e_event_type').textContent='請選擇事件類型'; hasErr = true; }
          if (!eventDate) { document.getElementById('e_event_date').textContent='請選擇日期'; hasErr = true; }
          if (hasErr) return;
          const payload = { event_type: eventType, event_date: eventDate, notes };
          const submitBtn = document.getElementById('btn-event-submit');
          submitBtn.disabled = true; submitBtn.textContent = '登記中…';
          try {
            const res = await fetch(`${apiBase}/leaves/life-events`, { method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify(payload) });
            if (res.status === 401) { location.assign('/login?redirect=/internal/leaves'); return; }
            const json = await res.json().catch(()=>null);
            if (!res.ok || !json || json.ok !== true) {
              const msg = (json && json.message) || '登記失敗';
              alert(msg);
              return;
            }
            alert(json.message || '登記成功');
            closeEventModal();
            await loadBalances();
            // 重新載入可用假期選項
            const meRes = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (meRes.ok) {
              const meJson = await meRes.json();
              const userGender = meJson.data?.gender || null;
              await showAvailableLifeEventLeaves(userGender);
            }
          } catch (_) {
            alert('登記失敗，請稍後再試');
          } finally {
            submitBtn.disabled = false; submitBtn.textContent = '登記';
          }
        });
        
        // 申請假期對話框（骨架）
        const modal = document.getElementById('applyModal');
        const openBtn = document.getElementById('btn-apply');
        const closeBtn = document.getElementById('btn-close');
        const cancelBtn = document.getElementById('btn-cancel');
        const form = document.getElementById('applyForm');
        function openModal(){ modal.classList.add('active'); modal.setAttribute('aria-hidden','false'); document.getElementById('leave_type').focus(); }
        function closeModal(){ modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); form.reset(); clearErrors(); document.getElementById('hours_display').value = ''; }
        function clearErrors(){ ['type','start','start_time','end_time'].forEach(k=>{ const el=document.getElementById('e_'+k); if(el) el.textContent=''; }); }
        
        // 生成上班時間選項（8:30-12:30, 13:30-17:30，半小時間隔）
        function populateTimeOptions() {
          const startTimeSelect = document.getElementById('start_time');
          const endTimeSelect = document.getElementById('end_time');
          
          const times = [];
          // 上午時段：8:30-12:30
          for (let h = 8; h <= 12; h++) {
            if (h === 8) {
              times.push({ value: '08:30', label: '08:30' });
            } else if (h === 12) {
              times.push({ value: '12:00', label: '12:00' });
              times.push({ value: '12:30', label: '12:30' });
            } else {
              times.push({ value: `${String(h).padStart(2,'0')}:00`, label: `${String(h).padStart(2,'0')}:00` });
              times.push({ value: `${String(h).padStart(2,'0')}:30`, label: `${String(h).padStart(2,'0')}:30` });
            }
          }
          // 下午時段：13:30-17:30
          for (let h = 13; h <= 17; h++) {
            if (h === 13) {
              times.push({ value: '13:30', label: '13:30' });
            } else {
              times.push({ value: `${String(h).padStart(2,'0')}:00`, label: `${String(h).padStart(2,'0')}:00` });
              times.push({ value: `${String(h).padStart(2,'0')}:30`, label: `${String(h).padStart(2,'0')}:30` });
            }
          }
          
          times.forEach(t => {
            const opt1 = document.createElement('option');
            opt1.value = t.value;
            opt1.textContent = t.label;
            startTimeSelect.appendChild(opt1);
            
            const opt2 = document.createElement('option');
            opt2.value = t.value;
            opt2.textContent = t.label;
            endTimeSelect.appendChild(opt2);
          });
        }
        
        // 計算請假時數（扣除午休時間）
        function calculateHours(startTime, endTime) {
          if (!startTime || !endTime) return 0;
          
          const [sh, sm] = startTime.split(':').map(Number);
          const [eh, em] = endTime.split(':').map(Number);
          
          const startMinutes = sh * 60 + sm;
          const endMinutes = eh * 60 + em;
          
          if (endMinutes <= startMinutes) return 0;
          
          const lunchStart = 12 * 60 + 30; // 12:30
          const lunchEnd = 13 * 60 + 30;   // 13:30
          
          let totalMinutes = endMinutes - startMinutes;
          
          // 扣除午休時間
          if (startMinutes < lunchEnd && endMinutes > lunchStart) {
            const lunchOverlap = Math.min(endMinutes, lunchEnd) - Math.max(startMinutes, lunchStart);
            if (lunchOverlap > 0) {
              totalMinutes -= lunchOverlap;
            }
          }
          
          return totalMinutes / 60;
        }
        openBtn.addEventListener('click', openModal);
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);

        // 初始化時間選項
        populateTimeOptions();
        
        // 監聽時間變化，自動計算時數
        const startTimeSelect = document.getElementById('start_time');
        const endTimeSelect = document.getElementById('end_time');
        const hoursDisplay = document.getElementById('hours_display');
        
        function updateHoursDisplay() {
          const hours = calculateHours(startTimeSelect.value, endTimeSelect.value);
          if (hours > 0) {
            hoursDisplay.value = `${hours} 小時`;
          } else {
            hoursDisplay.value = '';
          }
        }
        
        startTimeSelect.addEventListener('change', updateHoursDisplay);
        endTimeSelect.addEventListener('change', updateHoursDisplay);

        form.addEventListener('submit', async function(e){
          e.preventDefault();
          clearErrors();
          const t = document.getElementById('leave_type').value;
          const s = document.getElementById('start_date').value;
          const startTime = document.getElementById('start_time').value;
          const endTime = document.getElementById('end_time').value;
          let hasErr = false;
          if (!t) { document.getElementById('e_type').textContent='請選擇假別'; hasErr = true; }
          if (!s) { document.getElementById('e_start').textContent='請選擇日期'; hasErr = true; }
          if (!startTime) { document.getElementById('e_start_time').textContent='請選擇開始時間'; hasErr = true; }
          if (!endTime) { document.getElementById('e_end_time').textContent='請選擇結束時間'; hasErr = true; }
          
          // 計算時數
          const hours = calculateHours(startTime, endTime);
          if (hours <= 0) { 
            document.getElementById('e_end_time').textContent='結束時間必須晚於開始時間'; 
            hasErr = true; 
          }
          
          if (hasErr) return;
          
          // 檢查額度是否超出上限
          try {
            const year = new Date().getFullYear();
            const balRes = await fetch(`${apiBase}/leaves/balances?year=${year}`, { credentials:'include' });
            if (balRes.ok) {
              const balJson = await balRes.json();
              if (balJson.ok && balJson.data) {
                const balance = balJson.data.find(b => b.type === t);
                if (balance) {
                  const remainHours = balance.remain * 8; // 假設餘額是天數，轉換為小時（特休、生活事件假）
                  const remainActual = ['comp'].includes(t) ? balance.remain : remainHours;
                  
                  if (hours > remainActual) {
                    const typeName = zhType[t] || t;
                    const unit = ['comp'].includes(t) ? '小時' : '天';
                    const remain = ['comp'].includes(t) ? remainActual : balance.remain;
                    if (!confirm(`${typeName}餘額不足！\n剩餘：${remain} ${unit}\n申請：${hours} 小時\n\n是否仍要送出申請？`)) {
                      return;
                    }
                  }
                }
              }
            }
          } catch (err) {
            console.error('檢查額度失敗:', err);
          }
          const payload = { 
            leave_type: t, 
            start_date: s, 
            start_time: startTime,
            end_time: endTime,
            amount: hours
          };
          const submitBtn = document.getElementById('btn-submit');
          submitBtn.disabled = true; submitBtn.textContent = '送出中…';
          try {
            const res = await fetch(`${apiBase}/leaves`, { method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'include', body: JSON.stringify(payload) });
            if (res.status === 401) { location.assign('/login?redirect=/internal/leaves'); return; }
            const json = await res.json().catch(()=>null);
            if (!res.ok || !json || json.ok !== true) {
              const msg = (json && json.message) || '送出失敗';
              if (json && Array.isArray(json.errors) && json.errors.length>0) {
                const e0 = json.errors[0]; const el = document.getElementById('e_'+(e0.field||'')); if (el) el.textContent = e0.message || msg; else alert(msg);
              } else { alert(msg); }
              return;
            }
            alert('申請成功');
            closeModal();
            state.page = 1; await loadBalances(); await loadLeaves();
          } catch (_) {
            alert('送出失敗，請稍後再試');
          } finally {
            submitBtn.disabled = false; submitBtn.textContent = '送出申請';
          }
        });

        // 假別篩選
        leaveTypeFilterEl.addEventListener('change', ()=>{ state.page=1; loadLeaves(); });
        prevBtn.addEventListener('click', ()=>{ if (state.page>1) { state.page--; loadLeaves(); } });
        nextBtn.addEventListener('click', ()=>{ state.page++; loadLeaves(); });
        
        // 員工選擇器變更
        userSelectEl.addEventListener('change', function() {
          state.selectedUserId = this.value || null;
          state.page = 1;
          loadBalances();
          loadLeaves();
        });

        // 根據性別過濾假期選項
        function filterLeaveTypesByGender(gender) {
          const leaveTypeSelect = document.getElementById('leave_type');
          const options = leaveTypeSelect.querySelectorAll('option');
          options.forEach(option => {
            const requiredGender = option.getAttribute('data-gender');
            const isLifeEvent = option.getAttribute('data-life-event');
            // 生活事件假期不在这里过滤，由 showAvailableLifeEventLeaves 处理
            if (!isLifeEvent && requiredGender && requiredGender !== gender) {
              option.style.display = 'none';
              option.disabled = true;
            } else if (!isLifeEvent && requiredGender && requiredGender === gender) {
              option.style.display = '';
              option.disabled = false;
            }
          });
        }
        
        // 根據生活事件餘額顯示可用的假期選項（並考慮性別限制）
        async function showAvailableLifeEventLeaves(userGender) {
          const leaveTypeSelect = document.getElementById('leave_type');
          const lifeEventOptions = leaveTypeSelect.querySelectorAll('option[data-life-event="true"]');
          
          try {
            // 獲取假期餘額
            const year = new Date().getFullYear();
            const res = await fetch(`${apiBase}/leaves/balances?year=${year}`, { credentials:'include' });
            if (!res.ok) return;
            const json = await res.json();
            if (!json.ok || !json.data) return;
            
            // 取得有餘額的生活事件假期類型
            const availableTypes = new Set();
            json.data.forEach(balance => {
              if (balance.remain > 0 && ['marriage', 'funeral', 'maternity', 'prenatal_checkup', 'paternity'].includes(balance.type)) {
                availableTypes.add(balance.type);
              }
            });
            
            // 顯示有餘額且符合性別的選項
            lifeEventOptions.forEach(option => {
              const leaveType = option.value;
              const requiredGender = option.getAttribute('data-gender');
              
              // 檢查性別限制
              const genderMatches = !requiredGender || requiredGender === userGender;
              
              if (availableTypes.has(leaveType) && genderMatches) {
                option.style.display = '';
                option.disabled = false;
              } else {
                option.style.display = 'none';
                option.disabled = true;
              }
            });
          } catch (err) {
            console.error('載入生活事件假期選項失敗:', err);
          }
        }

        // 根據性別過濾生活事件選項
        function filterEventTypesByGender(gender) {
          const eventTypeSelect = document.getElementById('event_type');
          const options = eventTypeSelect.querySelectorAll('option');
          options.forEach(option => {
            const requiredGender = option.getAttribute('data-gender');
            if (requiredGender && requiredGender !== gender) {
              option.style.display = 'none';
              option.disabled = true;
            } else {
              option.style.display = '';
              option.disabled = false;
            }
          });
        }

        // 初始化：檢查用戶權限並載入員工列表
        async function init() {
          try {
            // 獲取當前用戶信息
            const meRes = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (meRes.status === 401) { location.assign('/login?redirect=/internal/leaves'); return; }
            const meJson = await meRes.json();
            if (meJson.ok && meJson.data) {
              state.isAdmin = meJson.data.isAdmin || false;
              const userGender = meJson.data.gender || null;
              
              // 根據性別過濾假期選項
              if (userGender) {
                filterLeaveTypesByGender(userGender);
                filterEventTypesByGender(userGender);
                // 載入可用的生活事件假期選項（考慮性別）
                await showAvailableLifeEventLeaves(userGender);
              } else {
                await showAvailableLifeEventLeaves(null);
              }
              
              // 如果是管理員，顯示員工選擇器並載入員工列表
              if (state.isAdmin) {
                userSelectEl.style.display = 'block';
                
                // 載入員工列表
                const usersRes = await fetch(`${apiBase}/users`, { credentials:'include' });
                if (usersRes.ok) {
                  const usersJson = await usersRes.json();
                  if (usersJson.ok && usersJson.data) {
                    usersJson.data.forEach(user => {
                      const option = document.createElement('option');
                      option.value = user.user_id;
                      option.textContent = user.name;
                      userSelectEl.appendChild(option);
                    });
                  }
                }
              }
            }
          } catch (err) {
            console.error('初始化失敗:', err);
          }
          
          // 載入數據
          loadBalances();
          loadLeaves();
        }
        
        init();
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


