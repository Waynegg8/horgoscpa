<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="收據收款管理" />
    <title>收據收款｜列表</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/receipts-page.css" />
    <style>
      /* 日期選擇器 - 整框可點擊 */
      input[type="date"] {
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        line-height: 1 !important;
        cursor: pointer !important;
        position: relative !important;
      }
      
      input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        opacity: 0 !important;
        cursor: pointer !important;
      }
      
      input[type="date"]::-webkit-inner-spin-button {
        display: none !important;
      }
      
      input[type="date"]::-webkit-datetime-edit {
        padding: 0 !important;
        line-height: 1 !important;
      }
      
      /* 提醒通知樣式 */
      .reminder-banner {
        background: #fef3c7;
        border: 1px solid #fbbf24;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        display: flex;
        align-items: start;
        gap: 12px;
      }
      
      .reminder-banner-icon {
        font-size: 24px;
        flex-shrink: 0;
      }
      
      .reminder-banner-content {
        flex: 1;
      }
      
      .reminder-banner-title {
        font-weight: 600;
        color: #92400e;
        margin-bottom: 8px;
      }
      
      .reminder-banner-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      
      .reminder-banner-item {
        padding: 6px 0;
        color: #78350f;
        font-size: 14px;
      }
      
      .reminder-banner-item a {
        color: #d97706;
        text-decoration: underline;
        cursor: pointer;
      }
      
      .reminder-banner-item a:hover {
        color: #b45309;
      }
    </style>
  </head>
  <body class="receipts-page">
    <header class="receipts-header">
      <h1 class="receipts-title">收據與收款</h1>
      <div class="receipts-toolbar">
        <input id="q" type="search" placeholder="搜尋客戶/收據號…" aria-label="搜尋" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;min-width:220px;" />
        <label>起</label><input id="dateFrom" type="date" />
        <label>迄</label><input id="dateTo" type="date" />
        <select id="status">
          <option value="all">全部狀態</option>
          <option value="unpaid">未收款</option>
          <option value="paid">已收款</option>
          <option value="overdue">逾期</option>
        </select>
        <button id="btn-new" class="clients-btn" type="button">新增收據</button>
      </div>
    </header>

    <main class="receipts-content">
      <!-- 開收據提醒 -->
      <div id="reminderBanner" style="display: none;"></div>
      
      <section class="receipts-card">
        <table class="receipts-table" aria-label="收據列表">
          <thead>
            <tr>
              <th>收據號</th>
              <th>客戶</th>
              <th>金額</th>
              <th>貨幣</th>
              <th>開立日期</th>
              <th>狀態</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="clients-pagination" id="pager">
          <button type="button" id="prev">上一頁</button>
          <button type="button" id="next">下一頁</button>
        </div>
      </section>
    </main>

    <!-- 新增收據 Modal -->
    <div id="modalOverlay" class="modal-overlay" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-header" id="modalTitle">新增收據</div>
        <div class="modal-body">
          <div id="formError" class="form-error" style="display:none;"></div>
          
          <div class="modal-row">
            <label for="receiptType">收據類型</label>
            <select id="receiptType">
              <option value="normal">正常收據</option>
              <option value="prepayment">預收款</option>
              <option value="deposit">訂金</option>
            </select>
          </div>
          
          <div class="modal-row">
            <label for="clientSelect">選擇客戶（必填）</label>
            <select id="clientSelect">
              <option value="">載入中...</option>
            </select>
          </div>
          
          <div class="modal-row" style="display: none;">
            <label for="clientId">客戶ID（自動填入）</label>
            <input id="clientId" type="text" placeholder="例如 c_001" readonly />
          </div>
          
          <div class="modal-row" id="serviceRow" style="display:none;">
            <label for="clientService">客戶服務（選填）</label>
            <select id="clientService">
              <option value="">請選擇服務</option>
            </select>
            <small style="color:#666;margin-top:4px;display:block;">選擇服務後可自動帶入金額</small>
          </div>
          
          <div class="modal-row" id="billingMonthRow" style="display:none;">
            <label for="billingMonth">計費月份（選填）</label>
            <select id="billingMonth">
              <option value="">請選擇月份</option>
              <option value="1">1月</option>
              <option value="2">2月</option>
              <option value="3">3月</option>
              <option value="4">4月</option>
              <option value="5">5月</option>
              <option value="6">6月</option>
              <option value="7">7月</option>
              <option value="8">8月</option>
              <option value="9">9月</option>
              <option value="10">10月</option>
              <option value="11">11月</option>
              <option value="12">12月</option>
            </select>
            <small style="color:#666;margin-top:4px;display:block;">選擇月份後可自動建議金額</small>
          </div>
          
          <div class="modal-row">
            <label for="receiptDate">開立日期</label>
            <input id="receiptDate" type="date" />
          </div>
          
          <div class="modal-row">
            <label for="dueDate">到期日（自動計算）</label>
            <input id="dueDate" type="date" />
            <small style="color:#666;margin-top:4px;display:block;">根據服務收費明細或預設30天</small>
          </div>
          
          <div class="modal-row">
            <label for="amount">金額</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="amount" type="number" min="1" step="1" placeholder="例如 10000" style="flex:1;" />
              <button type="button" id="btn-suggest-amount" class="btn" style="display:none;">建議金額</button>
            </div>
            <div id="suggestedAmountInfo" style="color:#10b981;margin-top:4px;display:none;"></div>
          </div>
          
          <div class="modal-row">
            <label for="statusNew">狀態</label>
            <select id="statusNew">
              <option value="unpaid">未收款</option>
              <option value="partial">部分收款</option>
              <option value="paid">已收款</option>
              <option value="cancelled">作廢</option>
            </select>
          </div>
          
          <div class="modal-row">
            <label for="notes">備註</label>
            <textarea id="notes" rows="3" placeholder="可留空"></textarea>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn" id="btn-cancel">取消</button>
          <button type="button" class="btn primary" id="btn-create">建立</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const tbody = document.getElementById('tbody');
        const q = document.getElementById('q');
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const statusEl = document.getElementById('status');
        const prevBtn = document.getElementById('prev');
        const nextBtn = document.getElementById('next');
        const btnNew = document.getElementById('btn-new');
        const modal = document.getElementById('modalOverlay');
        const btnCancel = document.getElementById('btn-cancel');
        const btnCreate = document.getElementById('btn-create');
        const inputReceiptType = document.getElementById('receiptType');
        const inputClientId = document.getElementById('clientId');
        const inputClientService = document.getElementById('clientService');
        const inputBillingMonth = document.getElementById('billingMonth');
        const inputReceiptDate = document.getElementById('receiptDate');
        const inputDueDate = document.getElementById('dueDate');
        const inputAmount = document.getElementById('amount');
        const inputStatusNew = document.getElementById('statusNew');
        const inputNotes = document.getElementById('notes');
        const formError = document.getElementById('formError');
        const serviceRow = document.getElementById('serviceRow');
        const billingMonthRow = document.getElementById('billingMonthRow');
        const btnSuggestAmount = document.getElementById('btn-suggest-amount');
        const suggestedAmountInfo = document.getElementById('suggestedAmountInfo');

        let state = { page:1, perPage:20, total:0 };
        let currentClientServices = [];
        let allClients = [];

        // 載入應開收據提醒
        async function loadReceiptReminders() {
          try {
            const res = await fetch(`${apiBase}/receipts/reminders`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            
            const banner = document.getElementById('reminderBanner');
            
            if (!json.ok || !json.data || json.data.length === 0) {
              banner.style.display = 'none';
              return;
            }
            
            const reminders = json.data;
            banner.innerHTML = `
              <div class="reminder-banner">
                <div class="reminder-banner-icon">⚠️</div>
                <div class="reminder-banner-content">
                  <div class="reminder-banner-title">待開收據提醒（${reminders.length} 項）</div>
                  <ul class="reminder-banner-list">
                    ${reminders.map(r => `
                      <li class="reminder-banner-item">
                        <strong>${r.client_name}</strong> - ${r.service_name}
                        （${r.billing_month}月，金額：$${(r.amount || 0).toLocaleString()}）
                        <a onclick="createReceiptFromReminder('${r.client_id}', ${r.client_service_id}, ${r.billing_month}, ${r.amount})">立即開收據</a>
                      </li>
                    `).join('')}
                  </ul>
                </div>
              </div>
            `;
            banner.style.display = 'block';
            
          } catch (err) {
            console.error('載入提醒失敗:', err);
          }
        }

        // 從提醒快速創建收據
        window.createReceiptFromReminder = function(clientId, clientServiceId, billingMonth, amount) {
          // 打開彈窗
          openModal();
          
          // 自動填充數據
          inputReceiptType.value = 'normal';
          inputClientId.value = clientId;
          inputBillingMonth.value = String(billingMonth);
          inputAmount.value = String(amount);
          
          // 設置客戶選擇
          const clientSelectEl = document.getElementById('clientSelect');
          if (clientSelectEl) {
            clientSelectEl.value = clientId;
            clientSelectEl.dispatchEvent(new Event('change'));
          }
          
          // 等待服務列表載入後選擇對應服務
          setTimeout(() => {
            if (clientServiceId) {
              inputClientService.value = String(clientServiceId);
              inputClientService.dispatchEvent(new Event('change'));
            }
          }, 1000);
        };

        // 載入客戶列表
        async function loadClients() {
          try {
            const res = await fetch(`${apiBase}/clients?perPage=1000`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            
            if (json.ok && json.data) {
              allClients = json.data;
              
              // 填充客戶下拉選單
              const clientSelect = document.getElementById('clientSelect');
              if (clientSelect) {
                clientSelect.innerHTML = '<option value="">請選擇客戶</option>' +
                  allClients.map(c => 
                    `<option value="${c.client_id}">${c.company_name}${c.tax_id ? ' (' + c.tax_id + ')' : ''}</option>`
                  ).join('');
              }
            }
          } catch (err) {
            console.error('載入客戶列表失敗:', err);
          }
        }
        
        // 監聽客戶選擇變化
        const clientSelectEl = document.getElementById('clientSelect');
        if (clientSelectEl) {
          clientSelectEl.addEventListener('change', async function() {
            const clientId = this.value;
            inputClientId.value = clientId;
            
            if (!clientId) {
              inputClientService.innerHTML = '<option value="">請選擇服務</option>';
              currentClientServices = [];
              serviceRow.style.display = 'none';
              billingMonthRow.style.display = 'none';
              return;
            }
            
            // 如果是正常收據，加載客戶服務
            if (inputReceiptType.value === 'normal') {
              try {
                const res = await fetch(`${apiBase}/clients/${clientId}`, { credentials: 'include' });
                if (!res.ok) {
                  inputClientService.innerHTML = '<option value="">請選擇服務</option>';
                  currentClientServices = [];
                  return;
                }
                
                const json = await res.json();
                if (json.ok && json.data && json.data.services) {
                  currentClientServices = json.data.services.filter(s => s.status === 'active');
                  inputClientService.innerHTML = '<option value="">請選擇服務</option>' +
                    currentClientServices.map(s => 
                      `<option value="${s.client_service_id}">${s.service_name}</option>`
                    ).join('');
                    
                  serviceRow.style.display = 'block';
                  billingMonthRow.style.display = 'block';
                }
              } catch (err) {
                console.error('載入客戶服務失敗:', err);
              }
            }
          });
        }

        function render(rows){
          tbody.innerHTML = '';
          rows.forEach(r => {
            const tr = document.createElement('tr');
            const isOverdue = r.dueDate && (new Date(r.dueDate) < new Date()) && (r.status==='unpaid' || r.status==='partial');
            const badgeCls = r.status==='paid' ? 'badge paid' : (isOverdue ? 'badge overdue' : 'badge unpaid');
            const txt = r.status==='paid' ? '已收款' : (isOverdue ? '逾期' : (r.status==='partial' ? '部分收款' : '未收款'));
            tr.innerHTML = `
              <td>${r.receiptId}</td>
              <td>${r.clientName||''}</td>
              <td>${(r.totalAmount||0).toLocaleString()}</td>
              <td>TWD</td>
              <td>${r.receiptDate||''}</td>
              <td><span class="${badgeCls}">${txt}</span></td>
              <td><button type="button">查看</button></td>
            `;
            tbody.appendChild(tr);
          });
        }

        function renderPager(){
          prevBtn.disabled = state.page <= 1;
          nextBtn.disabled = state.page * state.perPage >= state.total;
        }

        async function load(){
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          if (q.value.trim()) params.set('q', q.value.trim());
          const st = statusEl.value;
          if (st !== 'all' && st !== 'overdue') params.set('status', st);
          if (dateFrom.value) params.set('dateFrom', dateFrom.value);
          if (dateTo.value) params.set('dateTo', dateTo.value);
          try {
            const res = await fetch(`${apiBase}/receipts?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            let rows = json.data || [];
            if (st === 'overdue') {
              const today = new Date();
              rows = rows.filter(r => r.dueDate && new Date(r.dueDate) < today && (r.status==='unpaid' || r.status==='partial'));
            }
            state.total = (json.meta && json.meta.total) || rows.length;
            render(rows);
            renderPager();
          } catch (_) {
            tbody.innerHTML = '<tr><td colspan="7" style="color:#c0392b;">載入失敗</td></tr>';
            renderPager();
          }
        }

        let timer = null;
        q.addEventListener('input', ()=>{ clearTimeout(timer); timer = setTimeout(()=>{ state.page=1; load(); }, 300); });
        statusEl.addEventListener('change', ()=>{ state.page=1; load(); });
        dateFrom.addEventListener('change', ()=>{ state.page=1; load(); });
        dateTo.addEventListener('change', ()=>{ state.page=1; load(); });
        prevBtn.addEventListener('click', ()=>{ if (state.page>1) { state.page--; load(); } });
        nextBtn.addEventListener('click', ()=>{ state.page++; load(); });

        function openModal(){
          formError.style.display = 'none';
          formError.textContent = '';
          const today = new Date();
          const yyyy = today.getFullYear();
          const mm = String(today.getMonth()+1).padStart(2,'0');
          const dd = String(today.getDate()).padStart(2,'0');
          inputReceiptDate.value = `${yyyy}-${mm}-${dd}`;
          const d2 = new Date(Date.UTC(yyyy, Number(mm)-1, Number(dd)));
          d2.setUTCDate(d2.getUTCDate()+30);
          const yyyy2 = d2.getUTCFullYear();
          const mm2 = String(d2.getUTCMonth()+1).padStart(2,'0');
          const dd2 = String(d2.getUTCDate()).padStart(2,'0');
          inputDueDate.value = `${yyyy2}-${mm2}-${dd2}`;
          
          // 重置新字段
          inputReceiptType.value = 'normal';
          inputClientId.value = '';
          inputClientService.innerHTML = '<option value="">請選擇服務</option>';
          inputBillingMonth.value = '';
          inputAmount.value = '';
          inputStatusNew.value = 'unpaid';
          inputNotes.value = '';
          currentClientServices = [];
          
          // 隱藏服務和月份選擇
          serviceRow.style.display = 'none';
          billingMonthRow.style.display = 'none';
          btnSuggestAmount.style.display = 'none';
          suggestedAmountInfo.style.display = 'none';
          
          modal.classList.add('show');
          modal.setAttribute('aria-hidden', 'false');
        }

        function closeModal(){
          modal.classList.remove('show');
          modal.setAttribute('aria-hidden', 'true');
        }

        btnNew.addEventListener('click', openModal);
        btnCancel.addEventListener('click', closeModal);
        modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

        // 監聽收據類型變化
        inputReceiptType.addEventListener('change', () => {
          const isNormal = inputReceiptType.value === 'normal';
          serviceRow.style.display = isNormal ? 'block' : 'none';
          billingMonthRow.style.display = isNormal ? 'block' : 'none';
          if (!isNormal) {
            inputClientService.value = '';
            inputBillingMonth.value = '';
            btnSuggestAmount.style.display = 'none';
            suggestedAmountInfo.style.display = 'none';
          }
        });

        // 監聽客戶ID變化，載入客戶服務
        let loadServicesTimer = null;
        inputClientId.addEventListener('input', () => {
          clearTimeout(loadServicesTimer);
          loadServicesTimer = setTimeout(async () => {
            const clientId = inputClientId.value.trim();
            if (!clientId || inputReceiptType.value !== 'normal') return;
            
            try {
              const res = await fetch(`${apiBase}/clients/${clientId}`, { credentials: 'include' });
              if (!res.ok) {
                inputClientService.innerHTML = '<option value="">請選擇服務</option>';
                currentClientServices = [];
                return;
              }
              
              const json = await res.json();
              if (json.ok && json.data && json.data.services) {
                currentClientServices = json.data.services.filter(s => s.status === 'active');
                inputClientService.innerHTML = '<option value="">請選擇服務</option>' +
                  currentClientServices.map(s => 
                    `<option value="${s.client_service_id}">${s.service_name}</option>`
                  ).join('');
              }
            } catch (err) {
              console.error('載入客戶服務失敗:', err);
            }
          }, 500);
        });

        // 監聽服務和月份變化，顯示建議金額按鈕
        function updateSuggestButton() {
          const hasService = inputClientService.value;
          const hasMonth = inputBillingMonth.value;
          btnSuggestAmount.style.display = (hasService && hasMonth) ? 'inline-block' : 'none';
          suggestedAmountInfo.style.display = 'none';
        }

        inputClientService.addEventListener('change', updateSuggestButton);
        inputBillingMonth.addEventListener('change', updateSuggestButton);

        // 建議金額按鈕
        btnSuggestAmount.addEventListener('click', async () => {
          const clientServiceId = inputClientService.value;
          const billingMonth = inputBillingMonth.value;
          
          if (!clientServiceId || !billingMonth) return;
          
          try {
            const res = await fetch(
              `${apiBase}/receipts/suggest-amount?client_service_id=${clientServiceId}&billing_month=${billingMonth}`,
              { credentials: 'include' }
            );
            
            if (!res.ok) {
              alert('獲取建議金額失敗');
              return;
            }
            
            const json = await res.json();
            if (json.ok && json.data) {
              const { suggested_amount, payment_due_days, has_schedule } = json.data;
              
              if (has_schedule && suggested_amount > 0) {
                inputAmount.value = suggested_amount;
                suggestedAmountInfo.textContent = `已自動帶入金額：$${suggested_amount.toLocaleString()}`;
                suggestedAmountInfo.style.display = 'block';
                
                // 根據收費明細更新到期日
                if (payment_due_days && inputReceiptDate.value) {
                  const receiptDate = new Date(inputReceiptDate.value);
                  receiptDate.setDate(receiptDate.getDate() + payment_due_days);
                  const yyyy = receiptDate.getFullYear();
                  const mm = String(receiptDate.getMonth() + 1).padStart(2, '0');
                  const dd = String(receiptDate.getDate()).padStart(2, '0');
                  inputDueDate.value = `${yyyy}-${mm}-${dd}`;
                }
              } else {
                alert('該月份未設定收費明細');
              }
            }
          } catch (err) {
            console.error('獲取建議金額失敗:', err);
            alert('獲取建議金額失敗');
          }
        });

        async function createReceipt(){
          formError.style.display = 'none';
          formError.textContent = '';
          const client_id = inputClientId.value.trim();
          const receipt_date = inputReceiptDate.value;
          const due_date = inputDueDate.value;
          const total_amount = Number(inputAmount.value);
          const status = inputStatusNew.value;
          const notes = inputNotes.value.trim();
          
          // 新字段
          const receipt_type = inputReceiptType.value;
          const client_service_id = inputClientService.value ? parseInt(inputClientService.value, 10) : null;
          const billing_month = inputBillingMonth.value ? parseInt(inputBillingMonth.value, 10) : null;
          
          const errors = [];
          if (!client_id) errors.push('客戶ID必填');
          if (!/^\d{4}-\d{2}-\d{2}$/.test(receipt_date)) errors.push('開立日期格式錯誤');
          if (!Number.isFinite(total_amount) || total_amount <= 0) errors.push('金額需大於 0');
          if (errors.length){
            formError.textContent = errors.join('；');
            formError.style.display = 'block';
            return;
          }
          btnCreate.disabled = true;
          try {
            const payload = {
              client_id,
              receipt_date,
              due_date,
              total_amount,
              status,
              notes,
              receipt_type
            };
            
            // 只在有值時添加可選字段
            if (client_service_id) payload.client_service_id = client_service_id;
            if (billing_month) payload.billing_month = billing_month;
            
            const res = await fetch(`${apiBase}/receipts`, {
              method:'POST', credentials:'include', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify(payload)
            });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error(json?.message || '建立失敗');
            closeModal();
            state.page = 1;
            await load();
          } catch (err) {
            formError.textContent = String(err?.message || '建立失敗');
            formError.style.display = 'block';
          } finally {
            btnCreate.disabled = false;
          }
        }

        btnCreate.addEventListener('click', createReceipt);

        // 初始化
        loadReceiptReminders();
        loadClients();
        load();
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


