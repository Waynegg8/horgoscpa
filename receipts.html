<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="收據收款管理" />
    <title>收據收款｜列表</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/receipts-page.css" />
  </head>
  <body class="receipts-page">
    <header class="receipts-header">
      <h1 class="receipts-title">收據與收款</h1>
      <div class="receipts-toolbar">
        <input id="q" type="search" placeholder="搜尋客戶/收據號…" aria-label="搜尋" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;min-width:220px;" />
        <label>起</label><input id="dateFrom" type="date" />
        <label>迄</label><input id="dateTo" type="date" />
        <select id="status">
          <option value="all">全部狀態</option>
          <option value="unpaid">未收款</option>
          <option value="paid">已收款</option>
          <option value="overdue">逾期</option>
        </select>
        <button id="btn-new" class="clients-btn" type="button">新增收據</button>
      </div>
    </header>

    <main class="receipts-content">
      <section class="receipts-card">
        <table class="receipts-table" aria-label="收據列表">
          <thead>
            <tr>
              <th>收據號</th>
              <th>客戶</th>
              <th>金額</th>
              <th>貨幣</th>
              <th>開立日期</th>
              <th>狀態</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="clients-pagination" id="pager">
          <button type="button" id="prev">上一頁</button>
          <button type="button" id="next">下一頁</button>
        </div>
      </section>
    </main>

    <!-- 新增收據 Modal -->
    <div id="modalOverlay" class="modal-overlay" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-header" id="modalTitle">新增收據</div>
        <div class="modal-body">
          <div id="formError" class="form-error" style="display:none;"></div>
          <div class="modal-row">
            <label for="clientId">客戶ID</label>
            <input id="clientId" type="text" placeholder="例如 c_001" />
          </div>
          <div class="modal-row">
            <label for="receiptDate">開立日期</label>
            <input id="receiptDate" type="date" />
          </div>
          <div class="modal-row">
            <label for="dueDate">到期日（預設 +30 天）</label>
            <input id="dueDate" type="date" />
          </div>
          <div class="modal-row">
            <label for="amount">金額</label>
            <input id="amount" type="number" min="1" step="1" placeholder="例如 10000" />
          </div>
          <div class="modal-row">
            <label for="statusNew">狀態</label>
            <select id="statusNew">
              <option value="unpaid">未收款</option>
              <option value="partial">部分收款</option>
              <option value="paid">已收款</option>
              <option value="cancelled">作廢</option>
            </select>
          </div>
          <div class="modal-row">
            <label for="notes">備註</label>
            <textarea id="notes" rows="3" placeholder="可留空"></textarea>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn" id="btn-cancel">取消</button>
          <button type="button" class="btn primary" id="btn-create">建立</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const tbody = document.getElementById('tbody');
        const q = document.getElementById('q');
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const statusEl = document.getElementById('status');
        const prevBtn = document.getElementById('prev');
        const nextBtn = document.getElementById('next');
        const btnNew = document.getElementById('btn-new');
        const modal = document.getElementById('modalOverlay');
        const btnCancel = document.getElementById('btn-cancel');
        const btnCreate = document.getElementById('btn-create');
        const inputClientId = document.getElementById('clientId');
        const inputReceiptDate = document.getElementById('receiptDate');
        const inputDueDate = document.getElementById('dueDate');
        const inputAmount = document.getElementById('amount');
        const inputStatusNew = document.getElementById('statusNew');
        const inputNotes = document.getElementById('notes');
        const formError = document.getElementById('formError');

        let state = { page:1, perPage:20, total:0 };

        function render(rows){
          tbody.innerHTML = '';
          rows.forEach(r => {
            const tr = document.createElement('tr');
            const isOverdue = r.dueDate && (new Date(r.dueDate) < new Date()) && (r.status==='unpaid' || r.status==='partial');
            const badgeCls = r.status==='paid' ? 'badge paid' : (isOverdue ? 'badge overdue' : 'badge unpaid');
            const txt = r.status==='paid' ? '已收款' : (isOverdue ? '逾期' : (r.status==='partial' ? '部分收款' : '未收款'));
            tr.innerHTML = `
              <td>${r.receiptId}</td>
              <td>${r.clientName||''}</td>
              <td>${(r.totalAmount||0).toLocaleString()}</td>
              <td>TWD</td>
              <td>${r.receiptDate||''}</td>
              <td><span class="${badgeCls}">${txt}</span></td>
              <td><button type="button">查看</button></td>
            `;
            tbody.appendChild(tr);
          });
        }

        function renderPager(){
          prevBtn.disabled = state.page <= 1;
          nextBtn.disabled = state.page * state.perPage >= state.total;
        }

        async function load(){
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          if (q.value.trim()) params.set('q', q.value.trim());
          const st = statusEl.value;
          if (st !== 'all' && st !== 'overdue') params.set('status', st);
          if (dateFrom.value) params.set('dateFrom', dateFrom.value);
          if (dateTo.value) params.set('dateTo', dateTo.value);
          try {
            const res = await fetch(`${apiBase}/receipts?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            let rows = json.data || [];
            if (st === 'overdue') {
              const today = new Date();
              rows = rows.filter(r => r.dueDate && new Date(r.dueDate) < today && (r.status==='unpaid' || r.status==='partial'));
            }
            state.total = (json.meta && json.meta.total) || rows.length;
            render(rows);
            renderPager();
          } catch (_) {
            tbody.innerHTML = '<tr><td colspan="7" style="color:#c0392b;">載入失敗</td></tr>';
            renderPager();
          }
        }

        let timer = null;
        q.addEventListener('input', ()=>{ clearTimeout(timer); timer = setTimeout(()=>{ state.page=1; load(); }, 300); });
        statusEl.addEventListener('change', ()=>{ state.page=1; load(); });
        dateFrom.addEventListener('change', ()=>{ state.page=1; load(); });
        dateTo.addEventListener('change', ()=>{ state.page=1; load(); });
        prevBtn.addEventListener('click', ()=>{ if (state.page>1) { state.page--; load(); } });
        nextBtn.addEventListener('click', ()=>{ state.page++; load(); });

        function openModal(){
          formError.style.display = 'none';
          formError.textContent = '';
          const today = new Date();
          const yyyy = today.getFullYear();
          const mm = String(today.getMonth()+1).padStart(2,'0');
          const dd = String(today.getDate()).padStart(2,'0');
          inputReceiptDate.value = `${yyyy}-${mm}-${dd}`;
          const d2 = new Date(Date.UTC(yyyy, Number(mm)-1, Number(dd)));
          d2.setUTCDate(d2.getUTCDate()+30);
          const yyyy2 = d2.getUTCFullYear();
          const mm2 = String(d2.getUTCMonth()+1).padStart(2,'0');
          const dd2 = String(d2.getUTCDate()).padStart(2,'0');
          inputDueDate.value = `${yyyy2}-${mm2}-${dd2}`;
          inputClientId.value = '';
          inputAmount.value = '';
          inputStatusNew.value = 'unpaid';
          inputNotes.value = '';
          modal.classList.add('show');
          modal.setAttribute('aria-hidden', 'false');
        }

        function closeModal(){
          modal.classList.remove('show');
          modal.setAttribute('aria-hidden', 'true');
        }

        btnNew.addEventListener('click', openModal);
        btnCancel.addEventListener('click', closeModal);
        modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

        async function createReceipt(){
          formError.style.display = 'none';
          formError.textContent = '';
          const client_id = inputClientId.value.trim();
          const receipt_date = inputReceiptDate.value;
          const due_date = inputDueDate.value;
          const total_amount = Number(inputAmount.value);
          const status = inputStatusNew.value;
          const notes = inputNotes.value.trim();
          const errors = [];
          if (!client_id) errors.push('客戶ID必填');
          if (!/^\d{4}-\d{2}-\d{2}$/.test(receipt_date)) errors.push('開立日期格式錯誤');
          if (!Number.isFinite(total_amount) || total_amount <= 0) errors.push('金額需大於 0');
          if (errors.length){
            formError.textContent = errors.join('；');
            formError.style.display = 'block';
            return;
          }
          btnCreate.disabled = true;
          try {
            const res = await fetch(`${apiBase}/receipts`, {
              method:'POST', credentials:'include', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ client_id, receipt_date, due_date, total_amount, status, notes })
            });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error(json?.message || '建立失敗');
            closeModal();
            state.page = 1;
            await load();
          } catch (err) {
            formError.textContent = String(err?.message || '建立失敗');
            formError.style.display = 'block';
          } finally {
            btnCreate.disabled = false;
          }
        }

        btnCreate.addEventListener('click', createReceipt);

        load();
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


