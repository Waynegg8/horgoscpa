<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="收據收款管理" />
    <title>收據收款｜列表</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/internal-system.css" />
    <link rel="stylesheet" href="/assets/css/receipts-page.css" />
    <style>
      /* 日期選擇器 - 整框可點擊 */
      input[type="date"] {
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        line-height: 1 !important;
        cursor: pointer !important;
        position: relative !important;
      }
      
      input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        opacity: 0 !important;
        cursor: pointer !important;
      }
      
      input[type="date"]::-webkit-inner-spin-button {
        display: none !important;
      }
      
      input[type="date"]::-webkit-datetime-edit {
        padding: 0 !important;
        line-height: 1 !important;
      }
      
      /* 提醒通知樣式 */
      .reminder-banner {
        background: #fef3c7;
        border: 1px solid #fbbf24;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        display: flex;
        align-items: start;
        gap: 12px;
      }
      
      .reminder-banner-icon {
        font-size: 24px;
        flex-shrink: 0;
      }
      
      .reminder-banner-content {
        flex: 1;
      }
      
      .reminder-banner-title {
        font-weight: 600;
        color: #92400e;
        margin-bottom: 8px;
      }
      
      .reminder-banner-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      
      .reminder-banner-item {
        padding: 6px 0;
        color: #78350f;
        font-size: 14px;
      }
      
      .reminder-banner-item a {
        color: #d97706;
        text-decoration: underline;
        cursor: pointer;
      }
      
      .reminder-banner-item a:hover {
        color: #b45309;
      }
    </style>
  </head>
  <body>
    <div id="navbar-placeholder"></div>
    
    <div class="page-container">
      <div class="page-header">
        <h1 class="page-title">收據與收款</h1>
        <div class="page-actions">
          <button id="btn-new" class="btn btn-primary" type="button">+ 新增收據</button>
        </div>
      </div>

      <!-- 搜尋篩選工具列 -->
      <div class="content-card" style="margin-bottom: 16px;">
        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
          <input id="q" type="search" placeholder="搜尋客戶/收據號…" aria-label="搜尋" style="padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;min-width:220px;flex:1;" />
          <div style="display: flex; gap: 8px; align-items: center;">
            <label style="font-size: 14px; color: #6b7280;">起</label>
            <input id="dateFrom" type="date" style="padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;" />
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <label style="font-size: 14px; color: #6b7280;">迄</label>
            <input id="dateTo" type="date" style="padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;" />
          </div>
          <select id="status" style="padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;">
            <option value="all">全部狀態</option>
            <option value="unpaid">未收款</option>
            <option value="paid">已收款</option>
            <option value="overdue">逾期</option>
          </select>
        </div>
      </div>

      <main style="margin-bottom: 24px;">
      <!-- 開收據提醒 -->
      <div id="reminderBanner" style="display: none;"></div>
      
      <div class="content-card">
        <div class="table-wrapper">
          <table class="data-table" aria-label="收據列表">
            <thead>
              <tr>
                <th>收據號</th>
                <th>客戶</th>
                <th>金額</th>
                <th>貨幣</th>
                <th>開立日期</th>
                <th>狀態</th>
                <th style="width: 100px;">操作</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div style="margin-top: 16px; display: flex; justify-content: flex-end; gap: 8px;" id="pager">
          <button type="button" id="prev" class="btn btn-secondary">上一頁</button>
          <button type="button" id="next" class="btn btn-secondary">下一頁</button>
        </div>
      </div>
    </main>
    </div>
    
    <div id="footer-placeholder"></div>

    <!-- 新增收據 Modal -->
    <div id="modalOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;" aria-hidden="true">
      <div style="background: white; border-radius: 8px; padding: 24px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;" id="modalTitle">新增收據</h3>
          <button id="btn-modal-close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
        </div>
        <div style="display: grid; gap: 16px;">
          <div id="formError" class="form-error" style="display:none;"></div>
          
          <div style="display: grid; gap: 6px;">
            <label for="receiptType" style="font-weight: 500; font-size: 14px;">收據類型</label>
            <select id="receiptType" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;">
              <option value="normal">正常收據</option>
              <option value="prepayment">預收款</option>
              <option value="deposit">訂金</option>
            </select>
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="clientSelect" style="font-weight: 500; font-size: 14px;">選擇客戶（必填）</label>
            <select id="clientSelect" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;">
              <option value="">載入中...</option>
            </select>
          </div>
          
          <input id="clientId" type="hidden" />
          
          <div id="serviceRow" style="display:none;">
            <label for="clientService" style="font-weight: 500; font-size: 14px; display: block; margin-bottom: 6px;">客戶服務（選填）</label>
            <select id="clientService" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;">
              <option value="">請選擇服務</option>
            </select>
            <small style="color:#6b7280;margin-top:4px;display:block;font-size:12px;">選擇服務後可自動帶入金額</small>
          </div>
          
          <div id="billingMonthRow" style="display:none;">
            <label for="billingMonth" style="font-weight: 500; font-size: 14px; display: block; margin-bottom: 6px;">計費月份（選填）</label>
            <select id="billingMonth" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;">
              <option value="">請選擇月份</option>
              <option value="1">1月</option>
              <option value="2">2月</option>
              <option value="3">3月</option>
              <option value="4">4月</option>
              <option value="5">5月</option>
              <option value="6">6月</option>
              <option value="7">7月</option>
              <option value="8">8月</option>
              <option value="9">9月</option>
              <option value="10">10月</option>
              <option value="11">11月</option>
              <option value="12">12月</option>
            </select>
            <small style="color:#6b7280;margin-top:4px;display:block;font-size:12px;">選擇月份後可自動建議金額</small>
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="receiptDate" style="font-weight: 500; font-size: 14px;">開立日期</label>
            <input id="receiptDate" type="date" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="dueDate" style="font-weight: 500; font-size: 14px;">到期日（自動計算）</label>
            <input id="dueDate" type="date" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
            <small style="color:#6b7280;margin-top:4px;display:block;font-size:12px;">根據服務收費明細或預設30天</small>
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="amount" style="font-weight: 500; font-size: 14px;">金額</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="amount" type="number" min="1" step="1" placeholder="例如 10000" style="flex:1;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
              <button type="button" id="btn-suggest-amount" class="btn btn-secondary" style="display:none;">建議金額</button>
            </div>
            <div id="suggestedAmountInfo" style="color:#10b981;margin-top:4px;display:none;font-size:12px;"></div>
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="statusNew" style="font-weight: 500; font-size: 14px;">狀態</label>
            <select id="statusNew" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;">
              <option value="unpaid">未收款</option>
              <option value="partial">部分收款</option>
              <option value="paid">已收款</option>
              <option value="cancelled">作廢</option>
            </select>
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="notes" style="font-weight: 500; font-size: 14px;">備註</label>
            <textarea id="notes" rows="3" placeholder="可留空" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;"></textarea>
          </div>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" id="btn-cancel">取消</button>
          <button type="button" class="btn btn-primary" id="btn-create">建立</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const tbody = document.getElementById('tbody');
        const q = document.getElementById('q');
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const statusEl = document.getElementById('status');
        const prevBtn = document.getElementById('prev');
        const nextBtn = document.getElementById('next');
        const btnNew = document.getElementById('btn-new');
        const modal = document.getElementById('modalOverlay');
        const btnCancel = document.getElementById('btn-cancel');
        const btnCreate = document.getElementById('btn-create');
        const inputReceiptType = document.getElementById('receiptType');
        const inputClientId = document.getElementById('clientId');
        const inputClientService = document.getElementById('clientService');
        const inputBillingMonth = document.getElementById('billingMonth');
        const inputReceiptDate = document.getElementById('receiptDate');
        const inputDueDate = document.getElementById('dueDate');
        const inputAmount = document.getElementById('amount');
        const inputStatusNew = document.getElementById('statusNew');
        const inputNotes = document.getElementById('notes');
        const formError = document.getElementById('formError');
        const serviceRow = document.getElementById('serviceRow');
        const billingMonthRow = document.getElementById('billingMonthRow');
        const btnSuggestAmount = document.getElementById('btn-suggest-amount');
        const suggestedAmountInfo = document.getElementById('suggestedAmountInfo');

        let state = { page:1, perPage:20, total:0 };
        let currentClientServices = [];
        let allClients = [];

        // 載入應開收據提醒
        async function loadReceiptReminders() {
          try {
            const res = await fetch(`${apiBase}/receipts/reminders`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            
            const banner = document.getElementById('reminderBanner');
            
            if (!json.ok || !json.data || json.data.length === 0) {
              banner.style.display = 'none';
              return;
            }
            
            const reminders = json.data;
            banner.innerHTML = `
              <div class="reminder-banner">
                <div class="reminder-banner-icon">⚠️</div>
                <div class="reminder-banner-content">
                  <div class="reminder-banner-title">待開收據提醒（${reminders.length} 項）</div>
                  <ul class="reminder-banner-list">
                    ${reminders.map(r => `
                      <li class="reminder-banner-item">
                        <strong>${r.client_name}</strong> - ${r.service_name}
                        （${r.billing_month}月，金額：$${(r.amount || 0).toLocaleString()}）
                        <a onclick="createReceiptFromReminder('${r.client_id}', ${r.client_service_id}, ${r.billing_month}, ${r.amount})">立即開收據</a>
                      </li>
                    `).join('')}
                  </ul>
                </div>
              </div>
            `;
            banner.style.display = 'block';
            
          } catch (err) {
            console.error('載入提醒失敗:', err);
          }
        }

        // 從提醒快速創建收據
        window.createReceiptFromReminder = function(clientId, clientServiceId, billingMonth, amount) {
          // 打開彈窗
          openModal();
          
          // 自動填充數據
          inputReceiptType.value = 'normal';
          inputClientId.value = clientId;
          inputBillingMonth.value = String(billingMonth);
          inputAmount.value = String(amount);
          
          // 設置客戶選擇
          const clientSelectEl = document.getElementById('clientSelect');
          if (clientSelectEl) {
            clientSelectEl.value = clientId;
            clientSelectEl.dispatchEvent(new Event('change'));
          }
          
          // 等待服務列表載入後選擇對應服務
          setTimeout(() => {
            if (clientServiceId) {
              inputClientService.value = String(clientServiceId);
              inputClientService.dispatchEvent(new Event('change'));
            }
          }, 1000);
        };

        // 載入客戶列表
        async function loadClients() {
          try {
            const res = await fetch(`${apiBase}/clients?perPage=1000`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            
            if (json.ok && json.data) {
              allClients = json.data;
              
              // 填充客戶下拉選單
              const clientSelect = document.getElementById('clientSelect');
              if (clientSelect) {
                clientSelect.innerHTML = '<option value="">請選擇客戶</option>' +
                  allClients.map(c => 
                    `<option value="${c.clientId || c.client_id}">${c.companyName || c.company_name}${(c.taxId || c.tax_id) ? ' (' + (c.taxId || c.tax_id) + ')' : ''}</option>`
                  ).join('');
              }
            }
          } catch (err) {
            console.error('載入客戶列表失敗:', err);
          }
        }
        
        // 監聽客戶選擇變化
        const clientSelectEl = document.getElementById('clientSelect');
        if (clientSelectEl) {
          clientSelectEl.addEventListener('change', async function() {
            const clientId = this.value;
            inputClientId.value = clientId;
            
            console.log('客戶選擇變化:', clientId); // Debug
            
            if (!clientId) {
              inputClientService.innerHTML = '<option value="">請選擇服務</option>';
              currentClientServices = [];
              serviceRow.style.display = 'none';
              billingMonthRow.style.display = 'none';
              btnSuggestAmount.style.display = 'none';
              suggestedAmountInfo.style.display = 'none';
              return;
            }
            
            // 如果是正常收據，加載客戶服務
            if (inputReceiptType.value === 'normal') {
              try {
                const res = await fetch(`${apiBase}/clients/${encodeURIComponent(clientId)}`, { credentials: 'include' });
                if (!res.ok) {
                  console.error('載入客戶服務失敗: HTTP', res.status);
                  inputClientService.innerHTML = '<option value="">請選擇服務</option>';
                  currentClientServices = [];
                  serviceRow.style.display = 'block'; // 仍然顯示，但沒有服務選項
                  billingMonthRow.style.display = 'block';
                  return;
                }
                
                const json = await res.json();
                if (json.ok && json.data && json.data.services) {
                  currentClientServices = json.data.services.filter(s => s.status === 'active');
                  inputClientService.innerHTML = '<option value="">請選擇服務</option>' +
                    currentClientServices.map(s => 
                      `<option value="${s.client_service_id}">${s.service_name}</option>`
                    ).join('');
                    
                  serviceRow.style.display = 'block';
                  billingMonthRow.style.display = 'block';
                } else {
                  inputClientService.innerHTML = '<option value="">該客戶暫無啟用的服務</option>';
                  serviceRow.style.display = 'block';
                  billingMonthRow.style.display = 'block';
                }
              } catch (err) {
                console.error('載入客戶服務失敗:', err);
                inputClientService.innerHTML = '<option value="">載入失敗</option>';
                serviceRow.style.display = 'block';
                billingMonthRow.style.display = 'block';
              }
            }
          });
        }

        function render(rows){
          tbody.innerHTML = '';
          if (rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#6b7280;padding:24px;">暫無數據</td></tr>';
            return;
          }
          rows.forEach(r => {
            const tr = document.createElement('tr');
            const isOverdue = r.dueDate && (new Date(r.dueDate) < new Date()) && (r.status==='unpaid' || r.status==='partial');
            
            let badgeStyle = '';
            let txt = '';
            if (r.status === 'paid') {
              badgeStyle = 'background:#d1fae5;color:#065f46;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;';
              txt = '已收款';
            } else if (isOverdue) {
              badgeStyle = 'background:#fee2e2;color:#991b1b;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;';
              txt = '逾期';
            } else if (r.status === 'partial') {
              badgeStyle = 'background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;';
              txt = '部分收款';
            } else {
              badgeStyle = 'background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;';
              txt = '未收款';
            }
            
            tr.innerHTML = `
              <td>${r.receiptId}</td>
              <td>${r.clientName||''}</td>
              <td style="text-align:right;">$${(r.totalAmount||0).toLocaleString()}</td>
              <td>TWD</td>
              <td>${r.receiptDate||''}</td>
              <td><span style="${badgeStyle}">${txt}</span></td>
              <td><a href="/internal/receipt-detail?id=${encodeURIComponent(r.receiptId)}" class="btn-link">查看</a></td>
            `;
            tbody.appendChild(tr);
          });
        }

        function renderPager(){
          prevBtn.disabled = state.page <= 1;
          nextBtn.disabled = state.page * state.perPage >= state.total;
        }

        async function load(){
          const params = new URLSearchParams();
          params.set('page', String(state.page));
          params.set('perPage', String(state.perPage));
          if (q.value.trim()) params.set('q', q.value.trim());
          const st = statusEl.value;
          if (st !== 'all' && st !== 'overdue') params.set('status', st);
          if (dateFrom.value) params.set('dateFrom', dateFrom.value);
          if (dateTo.value) params.set('dateTo', dateTo.value);
          try {
            const res = await fetch(`${apiBase}/receipts?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            let rows = json.data || [];
            if (st === 'overdue') {
              const today = new Date();
              rows = rows.filter(r => r.dueDate && new Date(r.dueDate) < today && (r.status==='unpaid' || r.status==='partial'));
            }
            state.total = (json.meta && json.meta.total) || rows.length;
            render(rows);
            renderPager();
          } catch (_) {
            tbody.innerHTML = '<tr><td colspan="7" style="color:#c0392b;">載入失敗</td></tr>';
            renderPager();
          }
        }

        let timer = null;
        q.addEventListener('input', ()=>{ clearTimeout(timer); timer = setTimeout(()=>{ state.page=1; load(); }, 300); });
        statusEl.addEventListener('change', ()=>{ state.page=1; load(); });
        dateFrom.addEventListener('change', ()=>{ state.page=1; load(); });
        dateTo.addEventListener('change', ()=>{ state.page=1; load(); });
        prevBtn.addEventListener('click', ()=>{ if (state.page>1) { state.page--; load(); } });
        nextBtn.addEventListener('click', ()=>{ state.page++; load(); });

        function openModal(){
          formError.style.display = 'none';
          formError.textContent = '';
          const today = new Date();
          const yyyy = today.getFullYear();
          const mm = String(today.getMonth()+1).padStart(2,'0');
          const dd = String(today.getDate()).padStart(2,'0');
          inputReceiptDate.value = `${yyyy}-${mm}-${dd}`;
          const d2 = new Date(Date.UTC(yyyy, Number(mm)-1, Number(dd)));
          d2.setUTCDate(d2.getUTCDate()+30);
          const yyyy2 = d2.getUTCFullYear();
          const mm2 = String(d2.getUTCMonth()+1).padStart(2,'0');
          const dd2 = String(d2.getUTCDate()).padStart(2,'0');
          inputDueDate.value = `${yyyy2}-${mm2}-${dd2}`;
          
          // 重置新字段
          inputReceiptType.value = 'normal';
          const clientSelectEl = document.getElementById('clientSelect');
          if (clientSelectEl) clientSelectEl.value = '';
          inputClientId.value = '';
          inputClientService.innerHTML = '<option value="">請選擇服務</option>';
          inputBillingMonth.value = '';
          inputAmount.value = '';
          inputStatusNew.value = 'unpaid';
          inputNotes.value = '';
          currentClientServices = [];
          
          // 隱藏服務和月份選擇
          serviceRow.style.display = 'none';
          billingMonthRow.style.display = 'none';
          btnSuggestAmount.style.display = 'none';
          suggestedAmountInfo.style.display = 'none';
          
          modal.style.display = 'flex';
          modal.setAttribute('aria-hidden', 'false');
        }

        function closeModal(){
          modal.style.display = 'none';
          modal.setAttribute('aria-hidden', 'true');
        }

        btnNew.addEventListener('click', openModal);
        btnCancel.addEventListener('click', closeModal);
        
        // 添加关闭按钮事件
        const btnModalClose = document.getElementById('btn-modal-close');
        if (btnModalClose) {
          btnModalClose.addEventListener('click', closeModal);
        }
        
        modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

        // 監聽收據類型變化
        inputReceiptType.addEventListener('change', () => {
          const isNormal = inputReceiptType.value === 'normal';
          serviceRow.style.display = isNormal ? 'block' : 'none';
          billingMonthRow.style.display = isNormal ? 'block' : 'none';
          if (!isNormal) {
            inputClientService.value = '';
            inputBillingMonth.value = '';
            btnSuggestAmount.style.display = 'none';
            suggestedAmountInfo.style.display = 'none';
          }
        });

        // 監聽客戶ID變化，載入客戶服務
        let loadServicesTimer = null;
        inputClientId.addEventListener('input', () => {
          clearTimeout(loadServicesTimer);
          loadServicesTimer = setTimeout(async () => {
            const clientId = inputClientId.value.trim();
            if (!clientId || inputReceiptType.value !== 'normal') return;
            
            try {
              const res = await fetch(`${apiBase}/clients/${clientId}`, { credentials: 'include' });
              if (!res.ok) {
                inputClientService.innerHTML = '<option value="">請選擇服務</option>';
                currentClientServices = [];
                return;
              }
              
              const json = await res.json();
              if (json.ok && json.data && json.data.services) {
                currentClientServices = json.data.services.filter(s => s.status === 'active');
                inputClientService.innerHTML = '<option value="">請選擇服務</option>' +
                  currentClientServices.map(s => 
                    `<option value="${s.client_service_id}">${s.service_name}</option>`
                  ).join('');
              }
            } catch (err) {
              console.error('載入客戶服務失敗:', err);
            }
          }, 500);
        });

        // 監聽服務和月份變化，顯示建議金額按鈕
        function updateSuggestButton() {
          const hasService = inputClientService.value;
          const hasMonth = inputBillingMonth.value;
          btnSuggestAmount.style.display = (hasService && hasMonth) ? 'inline-block' : 'none';
          suggestedAmountInfo.style.display = 'none';
        }

        inputClientService.addEventListener('change', updateSuggestButton);
        inputBillingMonth.addEventListener('change', updateSuggestButton);

        // 建議金額按鈕
        btnSuggestAmount.addEventListener('click', async () => {
          const clientServiceId = inputClientService.value;
          const billingMonth = inputBillingMonth.value;
          
          if (!clientServiceId || !billingMonth) return;
          
          try {
            const res = await fetch(
              `${apiBase}/receipts/suggest-amount?client_service_id=${clientServiceId}&billing_month=${billingMonth}`,
              { credentials: 'include' }
            );
            
            if (!res.ok) {
              alert('獲取建議金額失敗');
              return;
            }
            
            const json = await res.json();
            if (json.ok && json.data) {
              const { suggested_amount, payment_due_days, has_schedule } = json.data;
              
              if (has_schedule && suggested_amount > 0) {
                inputAmount.value = suggested_amount;
                suggestedAmountInfo.textContent = `已自動帶入金額：$${suggested_amount.toLocaleString()}`;
                suggestedAmountInfo.style.display = 'block';
                
                // 根據收費明細更新到期日
                if (payment_due_days && inputReceiptDate.value) {
                  const receiptDate = new Date(inputReceiptDate.value);
                  receiptDate.setDate(receiptDate.getDate() + payment_due_days);
                  const yyyy = receiptDate.getFullYear();
                  const mm = String(receiptDate.getMonth() + 1).padStart(2, '0');
                  const dd = String(receiptDate.getDate()).padStart(2, '0');
                  inputDueDate.value = `${yyyy}-${mm}-${dd}`;
                }
              } else {
                alert('該月份未設定收費明細');
              }
            }
          } catch (err) {
            console.error('獲取建議金額失敗:', err);
            alert('獲取建議金額失敗');
          }
        });

        async function createReceipt(){
          formError.style.display = 'none';
          formError.textContent = '';
          
          // 從下拉選單獲取客戶ID
          const clientSelectEl = document.getElementById('clientSelect');
          const client_id = clientSelectEl ? clientSelectEl.value.trim() : inputClientId.value.trim();
          
          const receipt_date = inputReceiptDate.value;
          const due_date = inputDueDate.value;
          const total_amount = Number(inputAmount.value);
          const status = inputStatusNew.value;
          const notes = inputNotes.value.trim();
          
          // 新字段
          const receipt_type = inputReceiptType.value;
          const client_service_id = inputClientService.value ? parseInt(inputClientService.value, 10) : null;
          const billing_month = inputBillingMonth.value ? parseInt(inputBillingMonth.value, 10) : null;
          
          console.log('創建收據 - 客戶ID:', client_id); // Debug
          
          const errors = [];
          if (!client_id) errors.push('請選擇客戶');
          if (!/^\d{4}-\d{2}-\d{2}$/.test(receipt_date)) errors.push('請選擇開立日期');
          if (!Number.isFinite(total_amount) || total_amount <= 0) errors.push('金額需大於 0');
          if (errors.length){
            formError.textContent = errors.join('；');
            formError.style.display = 'block';
            return;
          }
          btnCreate.disabled = true;
          try {
            const payload = {
              client_id,
              receipt_date,
              due_date,
              total_amount,
              status,
              notes,
              receipt_type
            };
            
            // 只在有值時添加可選字段
            if (client_service_id) payload.client_service_id = client_service_id;
            if (billing_month) payload.billing_month = billing_month;
            
            console.log('發送請求:', payload); // Debug
            
            const res = await fetch(`${apiBase}/receipts`, {
              method:'POST', credentials:'include', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify(payload)
            });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            console.log('回應:', json); // Debug
            if (!res.ok || !json || json.ok !== true) throw new Error(json?.message || '建立失敗');
            closeModal();
            state.page = 1;
            await load();
            await loadReceiptReminders(); // 刷新提醒
          } catch (err) {
            console.error('創建收據失敗:', err); // Debug
            formError.textContent = String(err?.message || '建立失敗');
            formError.style.display = 'block';
          } finally {
            btnCreate.disabled = false;
          }
        }

        btnCreate.addEventListener('click', createReceipt);

        // 初始化
        loadReceiptReminders();
        loadClients();
        load();
      })();
    </script>
    <script src="/assets/js/components/bootstrap.js?v=3"></script>
  </body>
</html>


