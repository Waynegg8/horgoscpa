<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="收據收款管理" />
    <title>收據收款｜列表</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/internal-system.css" />
    <link rel="stylesheet" href="/assets/css/receipts-page.css" />
    
    <!-- ⚡ 预加载与缓存系统 -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <script src="/assets/js/prerender.js"></script>
    <script src="/assets/js/page-prerender.js"></script>
    
    <style>
      /* 日期選擇器 - 整框可點擊 */
      input[type="date"] {
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        line-height: 1 !important;
        cursor: pointer !important;
        position: relative !important;
      }
      
      input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        opacity: 0 !important;
        cursor: pointer !important;
      }
      
      input[type="date"]::-webkit-inner-spin-button {
        display: none !important;
      }
      
      input[type="date"]::-webkit-datetime-edit {
        padding: 0 !important;
        line-height: 1 !important;
      }
      
      /* 提醒通知樣式 - 绿色系（任务完成） */
      .reminder-banner {
        background: #d1fae5;
        border: 1px solid #10b981;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        display: flex;
        align-items: start;
        gap: 12px;
      }
      
      .reminder-banner-icon {
        font-size: 24px;
        flex-shrink: 0;
      }
      
      .reminder-banner-content {
        flex: 1;
      }
      
      .reminder-banner-title {
        font-weight: 600;
        color: #065f46;
        margin-bottom: 8px;
      }
      
      .reminder-banner-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      
      .reminder-banner-item {
        padding: 6px 0;
        color: #047857;
        font-size: 14px;
      }
      
      .reminder-banner-item a {
        color: #059669;
        text-decoration: underline;
        cursor: pointer;
        font-weight: 500;
      }
      
      .reminder-banner-item a:hover {
        color: #047857;
      }
      
      /* 客户分组样式 - 与任务页面一致 */
      .client-group {
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
      }
      
      .client-header {
        background: #f9fafb;
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .client-header:hover {
        background: #f3f4f6;
      }
      
      .receipt-row {
        display: grid;
        grid-template-columns: 2fr 1.5fr 120px 120px 120px 100px 100px;
        gap: 12px;
        padding: 12px 16px;
        border-bottom: 1px solid #f9fafb;
        align-items: center;
      }
      
      .receipt-row:hover {
        background: #f9fafb;
      }
    </style>
  </head>
  <body>
    <div id="navbar-placeholder"></div>
    
    <main class="clients-content" style="padding:24px;">
      <section class="clients-card" style="background:#fff;border:1px solid rgba(15,23,42,0.08);border-radius:10px;padding:16px;">
        <!-- 搜尋篩選工具列 -->
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
          <div class="toolbar" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <input id="q" type="search" placeholder="搜尋客戶/統編/收據號…" aria-label="搜尋" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;min-width:240px;" />
            <div style="display: flex; gap: 8px; align-items: center;">
              <label style="font-size: 14px; color: #6b7280;">起</label>
              <input id="dateFrom" type="date" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;" />
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <label style="font-size: 14px; color: #6b7280;">迄</label>
              <input id="dateTo" type="date" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;" />
            </div>
            <select id="status" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
              <option value="all">全部狀態</option>
              <option value="unpaid">未收款</option>
              <option value="paid">已收款</option>
              <option value="overdue">逾期</option>
            </select>
            <button id="btn-new" class="clients-btn" style="padding:8px 12px;" type="button">+ 新增收據</button>
          </div>
        </div>

        <!-- 開收據提醒 -->
        <div id="reminderBanner" style="display: none; margin-top: 16px;"></div>

        <p id="receipts-error" style="color:#c0392b;min-height:1.25rem;margin:8px 0 0 0;"></p>

        <!-- 收據列表 -->
        <div id="receipts-list" style="margin-top:16px;">
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:2px solid #e5e7eb;">
                <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">收據號</th>
                <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">客戶</th>
                <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">統編</th>
                <th style="padding:12px;text-align:right;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">金額</th>
                <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">開立日期</th>
                <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">到期日</th>
                <th style="padding:12px;text-align:center;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">狀態</th>
                <th style="padding:12px;text-align:center;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;width:100px;">操作</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </main>
    
    <div id="footer-placeholder"></div>

    <!-- 新增收據 Modal -->
    <div id="modalOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;" aria-hidden="true">
      <div style="background: white; border-radius: 8px; padding: 24px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;" id="modalTitle">新增收據</h3>
          <button id="btn-modal-close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
        </div>
        <div style="display: grid; gap: 16px;">
          <div id="formError" class="form-error" style="display:none;"></div>
          
          <div style="display: grid; gap: 6px;">
            <label for="receiptType" style="font-weight: 500; font-size: 14px;">收據類型</label>
            <select id="receiptType" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;">
              <option value="normal">正常收據</option>
              <option value="prepayment">預收款（訂金）</option>
            </select>
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="clientSelect" style="font-weight: 500; font-size: 14px;">選擇客戶（必填）</label>
            <select id="clientSelect" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;">
              <option value="">載入中...</option>
            </select>
          </div>
          
          <input id="clientId" type="hidden" />
          
          <div id="serviceRow" style="display:none;">
            <label for="clientService" style="font-weight: 500; font-size: 14px; display: block; margin-bottom: 6px;">客戶服務（選填）</label>
            <select id="clientService" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;">
              <option value="">請選擇服務</option>
            </select>
            <small style="color:#6b7280;margin-top:4px;display:block;font-size:12px;">選擇服務後可自動帶入金額</small>
          </div>
          
          <div id="billingMonthRow" style="display:none;">
            <label for="billingMonth" style="font-weight: 500; font-size: 14px; display: block; margin-bottom: 6px;">計費月份（選填）</label>
            <select id="billingMonth" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;">
              <option value="">請選擇月份</option>
              <option value="1">1月</option>
              <option value="2">2月</option>
              <option value="3">3月</option>
              <option value="4">4月</option>
              <option value="5">5月</option>
              <option value="6">6月</option>
              <option value="7">7月</option>
              <option value="8">8月</option>
              <option value="9">9月</option>
              <option value="10">10月</option>
              <option value="11">11月</option>
              <option value="12">12月</option>
            </select>
            <small style="color:#6b7280;margin-top:4px;display:block;font-size:12px;">選擇月份後可自動建議金額</small>
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="receiptDate" style="font-weight: 500; font-size: 14px;">開立日期</label>
            <input id="receiptDate" type="date" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="dueDate" style="font-weight: 500; font-size: 14px;">到期日（自動計算）</label>
            <input id="dueDate" type="date" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
            <small style="color:#6b7280;margin-top:4px;display:block;font-size:12px;">根據服務收費明細或預設30天</small>
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="amount" style="font-weight: 500; font-size: 14px;">金額</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="amount" type="number" min="1" step="1" placeholder="例如 10000" style="flex:1;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
              <button type="button" id="btn-suggest-amount" class="btn btn-secondary" style="display:none;">建議金額</button>
            </div>
            <div id="suggestedAmountInfo" style="color:#10b981;margin-top:4px;display:none;font-size:12px;"></div>
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="notes" style="font-weight: 500; font-size: 14px;">備註</label>
            <textarea id="notes" rows="3" placeholder="可留空" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;"></textarea>
          </div>
          
          <div style="background:#eff6ff;border:1px solid #3b82f6;border-radius:8px;padding:12px;margin-top:8px;">
            <div style="display:flex;align-items:start;gap:8px;">
              <span style="font-size:16px;">ℹ️</span>
              <div style="flex:1;font-size:13px;color:#1e40af;">
                <strong>收款流程：</strong>創建收據後，請到收據詳情頁點擊「新增收款」記錄實際收款，系統會自動更新狀態。
              </div>
            </div>
          </div>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" id="btn-cancel">取消</button>
          <button type="button" class="btn btn-primary" id="btn-create">建立</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const q = document.getElementById('q');
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const statusEl = document.getElementById('status');
        const btnNew = document.getElementById('btn-new');
        const modal = document.getElementById('modalOverlay');
        const btnCancel = document.getElementById('btn-cancel');
        const btnCreate = document.getElementById('btn-create');
        const inputReceiptType = document.getElementById('receiptType');
        const inputClientId = document.getElementById('clientId');
        const inputClientService = document.getElementById('clientService');
        const inputBillingMonth = document.getElementById('billingMonth');
        const inputReceiptDate = document.getElementById('receiptDate');
        const inputDueDate = document.getElementById('dueDate');
        const inputAmount = document.getElementById('amount');
        const inputNotes = document.getElementById('notes');
        const formError = document.getElementById('formError');
        const serviceRow = document.getElementById('serviceRow');
        const billingMonthRow = document.getElementById('billingMonthRow');
        const btnSuggestAmount = document.getElementById('btn-suggest-amount');
        const suggestedAmountInfo = document.getElementById('suggestedAmountInfo');

        let allReceipts = [];
        let allClients = [];
        let currentClientServices = [];
        const tbody = document.getElementById('tbody');

        // 載入應開收據提醒
        async function loadReceiptReminders() {
          try {
            const res = await fetch(`${apiBase}/receipts/reminders`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            
            const banner = document.getElementById('reminderBanner');
            
            if (!json.ok || !json.data || json.data.length === 0) {
              banner.innerHTML = '';
              banner.style.display = 'none';
              console.log('[提醒] 無待開收據，隱藏橫幅');
              return;
            }
            
            const reminders = json.data;
            console.log('[提醒] 載入', reminders.length, '個待開收據');
            
            banner.innerHTML = `
              <div class="reminder-banner">
                <div class="reminder-banner-icon">✅</div>
                <div class="reminder-banner-content">
                  <div class="reminder-banner-title">服務已完成，待開收據（${reminders.length} 項）</div>
                  <ul class="reminder-banner-list">
                    ${reminders.map(r => `
                      <li class="reminder-banner-item">
                        <strong>${r.client_name}</strong> - ${r.service_name}
                        （${r.billing_month}月，金額：$${(r.amount || 0).toLocaleString()}${r.total_tasks ? `，${r.completed_tasks}/${r.total_tasks} 任務已完成` : ''}）
                        <a onclick="createReceiptFromReminder('${r.client_id}', ${r.client_service_id}, ${r.billing_month}, ${r.amount})">立即開收據</a>
                      </li>
                    `).join('')}
                  </ul>
                </div>
              </div>
            `;
            banner.style.display = 'block';
            
          } catch (err) {
            console.error('載入提醒失敗:', err);
            const banner = document.getElementById('reminderBanner');
            banner.innerHTML = '';
            banner.style.display = 'none';
          }
        }

        // 從提醒快速創建收據
        window.createReceiptFromReminder = async function(clientId, clientServiceId, billingMonth, amount) {
          // 打開彈窗
          openModal();
          
          // 自動填充數據
          inputReceiptType.value = 'normal';
          inputClientId.value = clientId;
          inputBillingMonth.value = String(billingMonth);
          inputAmount.value = String(amount);
          
          // 設置客戶選擇
          const clientSelectEl = document.getElementById('clientSelect');
          if (clientSelectEl) {
            clientSelectEl.value = clientId;
            clientSelectEl.dispatchEvent(new Event('change'));
          }
          
          // 等待服務列表載入後選擇對應服務
          setTimeout(() => {
            if (clientServiceId) {
              inputClientService.value = String(clientServiceId);
              inputClientService.dispatchEvent(new Event('change'));
            }
          }, 1000);
        };

        // 載入客戶列表
        async function loadClients() {
          try {
            const res = await fetch(`${apiBase}/clients?perPage=1000`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            
            if (json.ok && json.data) {
              allClients = json.data;
              
              // 填充客戶下拉選單
              const clientSelect = document.getElementById('clientSelect');
              if (clientSelect) {
                clientSelect.innerHTML = '<option value="">請選擇客戶</option>' +
                  allClients.map(c => 
                    `<option value="${c.clientId || c.client_id}">${c.companyName || c.company_name}${(c.taxId || c.tax_id) ? ' (' + (c.taxId || c.tax_id) + ')' : ''}</option>`
                  ).join('');
              }
            }
          } catch (err) {
            console.error('載入客戶列表失敗:', err);
          }
        }
        
        // 監聽客戶選擇變化
        const clientSelectEl = document.getElementById('clientSelect');
        if (clientSelectEl) {
          clientSelectEl.addEventListener('change', async function() {
            const clientId = this.value;
            inputClientId.value = clientId;
            
            console.log('客戶選擇變化:', clientId); // Debug
            
            if (!clientId) {
              inputClientService.innerHTML = '<option value="">請選擇服務</option>';
              currentClientServices = [];
              serviceRow.style.display = 'none';
              billingMonthRow.style.display = 'none';
              btnSuggestAmount.style.display = 'none';
              suggestedAmountInfo.style.display = 'none';
              return;
            }
            
            // 如果是正常收據，加載客戶服務
            if (inputReceiptType.value === 'normal') {
              try {
                const res = await fetch(`${apiBase}/clients/${encodeURIComponent(clientId)}`, { credentials: 'include' });
                if (!res.ok) {
                  console.error('載入客戶服務失敗: HTTP', res.status);
                  inputClientService.innerHTML = '<option value="">請選擇服務</option>';
                  currentClientServices = [];
                  serviceRow.style.display = 'block'; // 仍然顯示，但沒有服務選項
                  billingMonthRow.style.display = 'block';
                  return;
                }
                
                const json = await res.json();
                if (json.ok && json.data && json.data.services) {
                  currentClientServices = json.data.services.filter(s => s.status === 'active');
                  inputClientService.innerHTML = '<option value="">請選擇服務</option>' +
                    currentClientServices.map(s => 
                      `<option value="${s.client_service_id}">${s.service_name}</option>`
                    ).join('');
                    
                  serviceRow.style.display = 'block';
                  billingMonthRow.style.display = 'block';
                } else {
                  inputClientService.innerHTML = '<option value="">該客戶暫無啟用的服務</option>';
                  serviceRow.style.display = 'block';
                  billingMonthRow.style.display = 'block';
                }
              } catch (err) {
                console.error('載入客戶服務失敗:', err);
                inputClientService.innerHTML = '<option value="">載入失敗</option>';
                serviceRow.style.display = 'block';
                billingMonthRow.style.display = 'block';
              }
            }
          });
        }

        // 篩選收據
        function filterReceipts() {
          const query = q.value.toLowerCase();
          const st = statusEl.value;
          const from = dateFrom.value;
          const to = dateTo.value;
          const today = new Date();
          
          return allReceipts.filter(r => {
            // 搜索（支持客户名、收据号、统编）
            if (query) {
              const matchName = r.clientName && r.clientName.toLowerCase().includes(query);
              const matchReceiptId = r.receiptId && r.receiptId.toLowerCase().includes(query);
              const matchTaxId = r.clientTaxId && r.clientTaxId.includes(query);
              
              if (!matchName && !matchReceiptId && !matchTaxId) {
                return false;
              }
            }
            
            // 狀態篩選
            const isOverdue = r.dueDate && (new Date(r.dueDate) < today) && (r.status==='unpaid' || r.status==='partial');
            if (st === 'overdue') {
              if (!isOverdue) return false;
            } else if (st !== 'all') {
              if (r.status !== st) return false;
            }
            
            // 日期篩選
            if (from && r.receiptDate < from) return false;
            if (to && r.receiptDate > to) return false;
            
            return true;
          });
        }
        
        // 渲染收據列表
        function render() {
          const filtered = filterReceipts();
          tbody.innerHTML = '';
          
          if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#9ca3af;padding:48px;font-size:14px;">沒有符合條件的收據</td></tr>';
            return;
          }
          
          const today = new Date();
          filtered.forEach(r => {
            const tr = document.createElement('tr');
            tr.style.borderBottom = '1px solid #f3f4f6';
            
            const isOverdue = r.dueDate && (new Date(r.dueDate) < today) && (r.status==='unpaid' || r.status==='partial');
            
            let badgeStyle = '';
            let txt = '';
            if (r.status === 'paid') {
              badgeStyle = 'background:#d1fae5;color:#065f46;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;';
              txt = '已收款';
            } else if (isOverdue) {
              badgeStyle = 'background:#fee2e2;color:#991b1b;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;';
              txt = '逾期';
            } else if (r.status === 'partial') {
              badgeStyle = 'background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;';
              txt = '部分收款';
            } else if (r.status === 'cancelled') {
              badgeStyle = 'background:#f3f4f6;color:#6b7280;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;';
              txt = '作廢';
            } else {
              badgeStyle = 'background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;';
              txt = '未收款';
            }
            
            tr.innerHTML = `
              <td style="padding:12px;font-size:14px;color:#1f2937;">${r.receiptId || '—'}</td>
              <td style="padding:12px;font-size:14px;color:#1f2937;">${r.clientName || '—'}</td>
              <td style="padding:12px;font-size:14px;color:#6b7280;">${r.clientTaxId || '—'}</td>
              <td style="padding:12px;text-align:right;font-size:14px;font-weight:600;color:#1f2937;">$${(r.totalAmount||0).toLocaleString()}</td>
              <td style="padding:12px;font-size:14px;color:#6b7280;">${r.receiptDate || '—'}</td>
              <td style="padding:12px;font-size:14px;color:#6b7280;">${r.dueDate || '—'}</td>
              <td style="padding:12px;text-align:center;"><span style="${badgeStyle}">${txt}</span></td>
              <td style="padding:12px;text-align:center;"><a href="/internal/receipt-detail?id=${encodeURIComponent(r.receiptId)}" style="color:#3b82f6;text-decoration:none;font-size:14px;">查看詳情</a></td>
            `;
            
            // hover效果
            tr.addEventListener('mouseenter', () => {
              tr.style.background = '#f9fafb';
            });
            tr.addEventListener('mouseleave', () => {
              tr.style.background = '';
            });
            
            tbody.appendChild(tr);
          });
        }

        // 加載所有收據
        async function loadAllReceipts() {
          try {
            const params = new URLSearchParams({ perPage: '1000' });
            const res = await fetch(`${apiBase}/receipts?${params}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            if (json.ok) {
              allReceipts = json.data || [];
              render();
            }
          } catch (err) {
            console.error('載入收據失敗', err);
            document.getElementById('receipts-error').textContent = '載入失敗';
          }
        }

        // 篩選事件
        let timer = null;
        q.addEventListener('input', ()=>{ clearTimeout(timer); timer = setTimeout(render, 300); });
        statusEl.addEventListener('change', render);
        dateFrom.addEventListener('change', render);
        dateTo.addEventListener('change', render);

        function openModal(){
          formError.style.display = 'none';
          formError.textContent = '';
          const today = new Date();
          const yyyy = today.getFullYear();
          const mm = String(today.getMonth()+1).padStart(2,'0');
          const dd = String(today.getDate()).padStart(2,'0');
          inputReceiptDate.value = `${yyyy}-${mm}-${dd}`;
          const d2 = new Date(Date.UTC(yyyy, Number(mm)-1, Number(dd)));
          d2.setUTCDate(d2.getUTCDate()+30);
          const yyyy2 = d2.getUTCFullYear();
          const mm2 = String(d2.getUTCMonth()+1).padStart(2,'0');
          const dd2 = String(d2.getUTCDate()).padStart(2,'0');
          inputDueDate.value = `${yyyy2}-${mm2}-${dd2}`;
          
          // 重置新字段
          inputReceiptType.value = 'normal';
          const clientSelectEl = document.getElementById('clientSelect');
          if (clientSelectEl) clientSelectEl.value = '';
          inputClientId.value = '';
          inputClientService.innerHTML = '<option value="">請選擇服務</option>';
          inputBillingMonth.value = '';
          inputAmount.value = '';
          inputStatusNew.value = 'unpaid';
          inputNotes.value = '';
          currentClientServices = [];
          
          // 隱藏服務和月份選擇
          serviceRow.style.display = 'none';
          billingMonthRow.style.display = 'none';
          btnSuggestAmount.style.display = 'none';
          suggestedAmountInfo.style.display = 'none';
          
          modal.style.display = 'flex';
          modal.setAttribute('aria-hidden', 'false');
        }

        function closeModal(){
          modal.style.display = 'none';
          modal.setAttribute('aria-hidden', 'true');
        }

        btnNew.addEventListener('click', openModal);
        btnCancel.addEventListener('click', closeModal);
        
        // 添加关闭按钮事件
        const btnModalClose = document.getElementById('btn-modal-close');
        if (btnModalClose) {
          btnModalClose.addEventListener('click', closeModal);
        }
        
        modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

        // 監聽收據類型變化
        inputReceiptType.addEventListener('change', () => {
          const isNormal = inputReceiptType.value === 'normal';
          serviceRow.style.display = isNormal ? 'block' : 'none';
          billingMonthRow.style.display = isNormal ? 'block' : 'none';
          if (!isNormal) {
            inputClientService.value = '';
            inputBillingMonth.value = '';
            btnSuggestAmount.style.display = 'none';
            suggestedAmountInfo.style.display = 'none';
          }
        });

        // 監聽客戶ID變化，載入客戶服務
        let loadServicesTimer = null;
        inputClientId.addEventListener('input', () => {
          clearTimeout(loadServicesTimer);
          loadServicesTimer = setTimeout(async () => {
            const clientId = inputClientId.value.trim();
            if (!clientId || inputReceiptType.value !== 'normal') return;
            
            try {
              const res = await fetch(`${apiBase}/clients/${clientId}`, { credentials: 'include' });
              if (!res.ok) {
                inputClientService.innerHTML = '<option value="">請選擇服務</option>';
                currentClientServices = [];
                return;
              }
              
              const json = await res.json();
              if (json.ok && json.data && json.data.services) {
                currentClientServices = json.data.services.filter(s => s.status === 'active');
                inputClientService.innerHTML = '<option value="">請選擇服務</option>' +
                  currentClientServices.map(s => 
                    `<option value="${s.client_service_id}">${s.service_name}</option>`
                  ).join('');
              }
            } catch (err) {
              console.error('載入客戶服務失敗:', err);
            }
          }, 500);
        });

        // 監聽服務和月份變化，顯示建議金額按鈕
        function updateSuggestButton() {
          const hasService = inputClientService.value;
          const hasMonth = inputBillingMonth.value;
          btnSuggestAmount.style.display = (hasService && hasMonth) ? 'inline-block' : 'none';
          suggestedAmountInfo.style.display = 'none';
        }

        inputClientService.addEventListener('change', updateSuggestButton);
        inputBillingMonth.addEventListener('change', updateSuggestButton);

        // 建議金額按鈕
        btnSuggestAmount.addEventListener('click', async () => {
          const clientServiceId = inputClientService.value;
          const billingMonth = inputBillingMonth.value;
          
          if (!clientServiceId || !billingMonth) return;
          
          try {
            const res = await fetch(
              `${apiBase}/receipts/suggest-amount?client_service_id=${clientServiceId}&billing_month=${billingMonth}`,
              { credentials: 'include' }
            );
            
            if (!res.ok) {
              alert('獲取建議金額失敗');
              return;
            }
            
            const json = await res.json();
            if (json.ok && json.data) {
              const { suggested_amount, payment_due_days, has_schedule } = json.data;
              
              if (has_schedule && suggested_amount > 0) {
                inputAmount.value = suggested_amount;
                suggestedAmountInfo.textContent = `已自動帶入金額：$${suggested_amount.toLocaleString()}`;
                suggestedAmountInfo.style.display = 'block';
                
                // 根據收費明細更新到期日
                if (payment_due_days && inputReceiptDate.value) {
                  const receiptDate = new Date(inputReceiptDate.value);
                  receiptDate.setDate(receiptDate.getDate() + payment_due_days);
                  const yyyy = receiptDate.getFullYear();
                  const mm = String(receiptDate.getMonth() + 1).padStart(2, '0');
                  const dd = String(receiptDate.getDate()).padStart(2, '0');
                  inputDueDate.value = `${yyyy}-${mm}-${dd}`;
                }
              } else {
                alert('該月份未設定收費明細');
              }
            }
          } catch (err) {
            console.error('獲取建議金額失敗:', err);
            alert('獲取建議金額失敗');
          }
        });

        async function createReceipt(){
          formError.style.display = 'none';
          formError.textContent = '';
          
          // 從下拉選單獲取客戶ID
          const clientSelectEl = document.getElementById('clientSelect');
          const client_id = clientSelectEl ? clientSelectEl.value.trim() : inputClientId.value.trim();
          
          const receipt_date = inputReceiptDate.value;
          const due_date = inputDueDate.value;
          const total_amount = Number(inputAmount.value);
          const notes = inputNotes.value.trim();
          
          // 新字段
          const receipt_type = inputReceiptType.value;
          const client_service_id = inputClientService.value ? parseInt(inputClientService.value, 10) : null;
          const billing_month = inputBillingMonth.value ? parseInt(inputBillingMonth.value, 10) : null;
          
          // 所有收據創建時統一為"未收款"，後續透過收款記錄來更新狀態
          const status = 'unpaid';
          
          console.log('創建收據 - 客戶ID:', client_id); // Debug
          
          const errors = [];
          if (!client_id) errors.push('請選擇客戶');
          if (!/^\d{4}-\d{2}-\d{2}$/.test(receipt_date)) errors.push('請選擇開立日期');
          if (!Number.isFinite(total_amount) || total_amount <= 0) errors.push('金額需大於 0');
          if (errors.length){
            formError.textContent = errors.join('；');
            formError.style.display = 'block';
            return;
          }
          btnCreate.disabled = true;
          try {
            const payload = {
              client_id,
              receipt_date,
              due_date,
              total_amount,
              status,
              notes,
              receipt_type
            };
            
            // 只在有值時添加可選字段
            if (client_service_id) payload.client_service_id = client_service_id;
            if (billing_month) payload.billing_month = billing_month;
            
            console.log('發送請求:', payload); // Debug
            
            const res = await fetch(`${apiBase}/receipts`, {
              method:'POST', credentials:'include', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify(payload)
            });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            console.log('回應:', json); // Debug
            if (!res.ok || !json || json.ok !== true) throw new Error(json?.message || '建立失敗');
            
            // 顯示成功提示
            alert('✅ 收據建立成功');
            
            closeModal();
            
            // 刷新列表和提醒
            await Promise.all([
              loadAllReceipts(),
              loadReceiptReminders()
            ]);
          } catch (err) {
            console.error('創建收據失敗:', err); // Debug
            formError.textContent = String(err?.message || '建立失敗');
            formError.style.display = 'block';
          } finally {
            btnCreate.disabled = false;
          }
        }

        btnCreate.addEventListener('click', createReceipt);

        // ⚡ 预渲染初始化
        if (window.PagePrerender) {
          window.PagePrerender.init('.receipts-container');
        }

        // 初始化
        async function init() {
          await Promise.all([
            loadReceiptReminders(),
            loadClients(),
            loadAllReceipts()
          ]);
          
          // ⚡ 自动保存预渲染
          if (window.PagePrerender) {
            setTimeout(() => window.PagePrerender.autoSave('.receipts-container', 2000), 1000);
          }
        }
        
        init();
      })();
    </script>
    <script src="/assets/js/components/bootstrap.js?v=3"></script>
  </body>
  </html>


