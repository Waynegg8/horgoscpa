<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="æ”¶æ“šæ”¶æ¬¾ç®¡ç†" />
    <title>æ”¶æ“šæ”¶æ¬¾ï½œåˆ—è¡¨</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/internal-system.css" />
    <link rel="stylesheet" href="/assets/css/receipts-page.css" />
    
    <!-- âš¡ é¢„åŠ è½½ä¸ç¼“å­˜ç³»ç»Ÿ -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <script src="/assets/js/prerender.js"></script>
    <script src="/assets/js/page-prerender.js"></script>
    
    
    <style>
      /* Sticky Footer */
      html, body {
        height: 100%;
        margin: 0;
      }
      
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      
      .clients-content {
        flex: 1 0 auto;
      }
      
      #navbar-placeholder,
      footer,
      #footer-placeholder {
        flex-shrink: 0;
      }
      
      /* æ—¥æœŸé¸æ“‡å™¨ - æ•´æ¡†å¯é»æ“Š */
      input[type="date"] {
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        line-height: 1 !important;
        cursor: pointer !important;
        position: relative !important;
      }
      
      input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        opacity: 0 !important;
        cursor: pointer !important;
      }
      
      input[type="date"]::-webkit-inner-spin-button {
        display: none !important;
      }
      
      input[type="date"]::-webkit-datetime-edit {
        padding: 0 !important;
        line-height: 1 !important;
      }
      
      /* æé†’é€šçŸ¥æ¨£å¼ - ç»¿è‰²ç³»ï¼ˆä»»åŠ¡å®Œæˆï¼‰ */
      .reminder-banner {
        background: #d1fae5;
        border: 1px solid #10b981;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        display: flex;
        align-items: start;
        gap: 12px;
      }
      
      .reminder-banner-icon {
        font-size: 24px;
        flex-shrink: 0;
      }
      
      .reminder-banner-content {
        flex: 1;
      }
      
      .reminder-banner-title {
        font-weight: 600;
        color: #065f46;
        margin-bottom: 8px;
      }
      
      .reminder-banner-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      
      .reminder-banner-item {
        padding: 6px 0;
        color: #047857;
        font-size: 14px;
      }
      
      .reminder-banner-item a {
        color: #059669;
        text-decoration: underline;
        cursor: pointer;
        font-weight: 500;
      }
      
      .reminder-banner-item a:hover {
        color: #047857;
      }
      
      /* å®¢æˆ·åˆ†ç»„æ ·å¼ - ä¸ä»»åŠ¡é¡µé¢ä¸€è‡´ */
      .client-group {
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
      }
      
      .client-header {
        background: #f9fafb;
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .client-header:hover {
        background: #f3f4f6;
      }
      
      .receipt-row {
        display: grid;
        grid-template-columns: 2fr 1.5fr 120px 120px 120px 100px 100px;
        gap: 12px;
        padding: 12px 16px;
        border-bottom: 1px solid #f9fafb;
        align-items: center;
      }
      
      .receipt-row:hover {
        background: #f9fafb;
      }
    </style>
  </head>
  <body>
    <div id="navbar-placeholder"></div>
    
    <main class="clients-content" style="padding:24px;">
      <section class="clients-card" style="background:#fff;border:1px solid rgba(15,23,42,0.08);border-radius:10px;padding:16px;">
        <!-- æœå°‹ç¯©é¸å·¥å…·åˆ— -->
        <div class="toolbar" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <input id="q" type="search" placeholder="æœå°‹å®¢æˆ¶/çµ±ç·¨/æ”¶æ“šè™Ÿâ€¦" aria-label="æœå°‹" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;min-width:240px;" />
          <div style="display: flex; gap: 8px; align-items: center;">
            <label style="font-size: 14px; color: #6b7280;">èµ·</label>
            <input id="dateFrom" type="date" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;" />
          </div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <label style="font-size: 14px; color: #6b7280;">è¿„</label>
            <input id="dateTo" type="date" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;" />
          </div>
          <select id="status" style="padding:10px 12px;border:1px solid rgba(15,23,42,0.15);border-radius:8px;">
            <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
            <option value="unpaid">æœªæ”¶æ¬¾</option>
            <option value="paid">å·²æ”¶æ¬¾</option>
            <option value="overdue">é€¾æœŸ</option>
          </select>
          <button id="btn-new" class="clients-btn" style="padding:8px 12px;" type="button">+ æ–°å¢æ”¶æ“š</button>
        </div>

        <!-- é–‹æ”¶æ“šæé†’ -->
        <div id="reminderBanner" style="display: none; margin-top: 16px;"></div>

        <p id="receipts-error" style="color:#c0392b;min-height:1.25rem;margin:8px 0 0 0;"></p>

        <!-- æ”¶æ“šåˆ—è¡¨ -->
        <div id="receipts-list" style="margin-top:16px;">
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:2px solid #e5e7eb;">
                <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">æ”¶æ“šè™Ÿ</th>
                <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">å®¢æˆ¶</th>
                <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">çµ±ç·¨</th>
                <th style="padding:12px;text-align:center;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">æœå‹™æœŸé–“</th>
                <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">æœå‹™é¡å‹</th>
                <th style="padding:12px;text-align:right;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">é‡‘é¡</th>
                <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">é–‹ç«‹æ—¥æœŸ</th>
                <th style="padding:12px;text-align:left;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">åˆ°æœŸæ—¥</th>
                <th style="padding:12px;text-align:center;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">ç‹€æ…‹</th>
                <th style="padding:12px;text-align:center;font-size:13px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;width:100px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </main>
    
    <div id="footer-placeholder"></div>

    <!-- æ–°å¢æ”¶æ“š Modal -->
    <div id="modalOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;" aria-hidden="true">
      <div style="background: white; border-radius: 8px; padding: 24px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;" id="modalTitle">æ–°å¢æ”¶æ“š</h3>
          <button id="btn-modal-close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
        </div>
        
        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:14px;margin-bottom:16px;border-radius:6px;">
          <div style="display:flex;align-items:start;gap:10px;">
            <span style="font-size:20px;">ğŸ“–</span>
            <div style="flex:1;">
              <div style="font-weight:700;font-size:14px;color:#92400e;margin-bottom:6px;">ğŸ’¼ æ”¶æ“šèˆ‡è«‹æ¬¾å–®ä½¿ç”¨èªªæ˜</div>
              <div style="font-size:12px;color:#78350f;line-height:1.7;">
                <strong>1ï¸âƒ£ å‰µå»ºæ”¶æ“š</strong>ï¼šé¸æ“‡å®¢æˆ¶ã€å¡«å¯«æ—¥æœŸå’Œé‡‘é¡ï¼ˆå¿…å¡«ï¼‰ï¼Œæ˜ç´°é …ç›®ç‚ºé¸å¡«<br>
                <strong>2ï¸âƒ£ åˆ—å°è«‹æ¬¾å–®</strong>ï¼šå‘å®¢æˆ¶è«‹æ¬¾æ™‚ä½¿ç”¨ï¼Œæœƒé¡¯ç¤ºã€Œä»£è¾¦è²»ã€è¦è²»ã€é›œè²»ã€ä¸‰æ¬„æ˜ç´°<br>
                <strong>3ï¸âƒ£ åˆ—å°æ”¶æ“š</strong>ï¼šæ”¶åˆ°æ¬¾é …å¾Œä½¿ç”¨ï¼Œé¡¯ç¤ºç¸½é‡‘é¡ï¼ˆå…©è¯ï¼šæ”¶ç¨…è¯ã€å­˜æŸ¥è¯ï¼‰<br>
                <strong>4ï¸âƒ£ è¨˜éŒ„æ”¶æ¬¾</strong>ï¼šåˆ°æ”¶æ“šè©³æƒ…é é»æ“Šã€Œæ–°å¢æ”¶æ¬¾ã€ç™»è¨˜å¯¦éš›æ”¶æ¬¾
              </div>
            </div>
          </div>
        </div>
        
        <div style="display: grid; gap: 16px;">
          <div id="formError" class="form-error" style="display:none;"></div>
          
          <div style="display: grid; gap: 6px;">
            <label for="receiptType" style="font-weight: 500; font-size: 14px;">æ”¶æ“šé¡å‹</label>
            <select id="receiptType" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;">
              <option value="normal">æ­£å¸¸æ”¶æ“š</option>
              <option value="prepayment">é æ”¶æ¬¾ï¼ˆè¨‚é‡‘ï¼‰</option>
            </select>
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="clientSelect" style="font-weight: 500; font-size: 14px;">é¸æ“‡å®¢æˆ¶ï¼ˆå¿…å¡«ï¼‰</label>
            <select id="clientSelect" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;">
              <option value="">è¼‰å…¥ä¸­...</option>
            </select>
          </div>
          
          <input id="clientId" type="hidden" />
          
          <div id="billingMonthRow" style="display:none;">
            <label for="billingMonth" style="font-weight: 500; font-size: 14px; display: block; margin-bottom: 6px;">è¨ˆè²»æœˆä»½ï¼ˆé¸å¡«ï¼‰</label>
            <select id="billingMonth" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;">
              <option value="">è«‹é¸æ“‡æœˆä»½</option>
              <option value="1">1æœˆ</option>
              <option value="2">2æœˆ</option>
              <option value="3">3æœˆ</option>
              <option value="4">4æœˆ</option>
              <option value="5">5æœˆ</option>
              <option value="6">6æœˆ</option>
              <option value="7">7æœˆ</option>
              <option value="8">8æœˆ</option>
              <option value="9">9æœˆ</option>
              <option value="10">10æœˆ</option>
              <option value="11">11æœˆ</option>
              <option value="12">12æœˆ</option>
            </select>
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="receiptDate" style="font-weight: 500; font-size: 14px;">é–‹ç«‹æ—¥æœŸ</label>
            <input id="receiptDate" type="date" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="dueDate" style="font-weight: 500; font-size: 14px;">åˆ°æœŸæ—¥ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</label>
            <input id="dueDate" type="date" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
            <small style="color:#6b7280;margin-top:4px;display:block;font-size:12px;">æ ¹æ“šæœå‹™æ”¶è²»æ˜ç´°æˆ–é è¨­30å¤©</small>
          </div>
          
          <!-- æœåŠ¡æœŸé—´é€‰æ‹©å™¨ï¼ˆåº”è®¡åˆ¶ï¼Œå¿…å¡«ï¼‰ -->
          <div style="background:#fff8dc;border:2px solid #ffa500;border-radius:8px;padding:16px;margin:8px 0;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
              <span style="font-size:20px;">ğŸ“…</span>
              <label style="font-weight:600;font-size:14px;color:#d97706;margin:0;">æœå‹™æœŸé–“ï¼ˆå¿…å¡«ï¼‰</label>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:8px;">
              <div>
                <label for="serviceStartMonth" style="font-size:13px;color:#d97706;display:block;margin-bottom:4px;">æœå‹™é–‹å§‹æœˆä»½ <span style="color:red;">*</span></label>
                <input id="serviceStartMonth" type="month" required style="width:100%;padding:8px;border:2px solid #fbbf24;border-radius:6px;font-size:14px;" />
              </div>
              <div>
                <label for="serviceEndMonth" style="font-size:13px;color:#d97706;display:block;margin-bottom:4px;">æœå‹™çµæŸæœˆä»½ <span style="color:red;">*</span></label>
                <input id="serviceEndMonth" type="month" required style="width:100%;padding:8px;border:2px solid #fbbf24;border-radius:6px;font-size:14px;" />
              </div>
            </div>
            
            <div style="background:#fef3c7;padding:10px;border-radius:6px;font-size:12px;color:#92400e;line-height:1.6;">
              <strong>ğŸ’¡ å¡«å¯«èªªæ˜ï¼š</strong>
              <ul style="margin:4px 0 0 20px;padding:0;">
                <li><strong>å–®æœˆæœå‹™</strong>ï¼šå…©å€‹æœˆä»½é¸æ“‡ç›¸åŒï¼ˆå¦‚ 2025-11 åˆ° 2025-11ï¼‰</li>
                <li><strong>å­£åº¦æœå‹™</strong>ï¼šé¸æ“‡å­£åº¦ç¯„åœï¼ˆå¦‚ 2025-10 åˆ° 2025-12 ç‚º Q4ï¼‰</li>
                <li><strong>å¹´åº¦æœå‹™</strong>ï¼šé¸æ“‡å…¨å¹´ï¼ˆå¦‚ 2025-01 åˆ° 2025-12ï¼‰</li>
                <li><strong>å¥—é¤æœå‹™</strong>ï¼šé¸æ“‡å¯¦éš›æœå‹™æœŸé–“ï¼ˆç³»çµ±æœƒæŒ‰å·¥æ™‚æ¯”ä¾‹åˆ†æ”¤æ”¶å…¥ï¼‰</li>
              </ul>
            </div>
          </div>
          
          <!-- æœåŠ¡ç±»å‹å¤šé€‰ï¼ˆé€‰å¡«ï¼‰ -->
          <div style="background:#fef2f2;border:2px solid #fca5a5;border-radius:8px;padding:16px;margin:8px 0;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
              <span style="font-size:20px;">ğŸ·ï¸</span>
              <label style="font-weight:600;font-size:14px;color:#991b1b;margin:0;">æœå‹™é¡å‹ï¼ˆé¸å¡«ï¼‰</label>
            </div>
            
            <div id="serviceTypesContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;margin-bottom:8px;">
              <!-- æœåŠ¡ç±»å‹å¤é€‰æ¡†å°†åŠ¨æ€åŠ è½½ -->
            </div>
            
            <div style="background:#fee2e2;padding:10px;border-radius:6px;font-size:12px;color:#991b1b;line-height:1.6;">
              <strong>ğŸ’¡ å¡«å¯«èªªæ˜ï¼š</strong>
              <ul style="margin:4px 0 0 20px;padding:0;">
                <li>å¦‚æœæ˜¯<strong>å¥—é¤æ”¶æ“š</strong>ï¼Œè«‹å‹¾é¸åŒ…å«çš„æœå‹™é¡å‹ï¼ˆå¯å¤šé¸ï¼‰</li>
                <li>å¦‚æœæ˜¯<strong>å–®ä¸€æœå‹™</strong>ï¼Œå‹¾é¸å°æ‡‰çš„æœå‹™é¡å‹</li>
                <li>ç•™ç©ºæ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•å¾å·¥æ™‚è¨˜éŒ„æ¨æ–·æœå‹™é¡å‹</li>
                <li>æ‰‹å‹•é¸æ“‡çš„æœå‹™é¡å‹å„ªå…ˆæ–¼è‡ªå‹•æ¨æ–·</li>
              </ul>
            </div>
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label style="font-weight: 500; font-size: 14px;">æ”¶æ“šæ˜ç´°ï¼ˆé¸å¡«ï¼‰</label>
            
            <!-- è¯´æ˜åŒºåŸŸ -->
            <div style="background:#eff6ff;border:1px solid #3b82f6;border-radius:6px;padding:12px;margin-bottom:8px;">
              <div style="font-size:13px;color:#1e40af;">
                <strong>ğŸ“ å¡«å¯«èªªæ˜ï¼š</strong>
                <ul style="margin:8px 0 0 20px;line-height:1.8;">
                  <li><strong>é …ç›®åç¨±</strong>ï¼šæœå‹™é …ç›®æˆ–è²»ç”¨åç¨±ï¼ˆä¾‹å¦‚ï¼šå…¬å¸ç™»è¨˜ã€ç¨…å‹™ç”³å ±ï¼‰</li>
                  <li><strong>ä»£è¾¦è²»</strong>ï¼šæœƒè¨ˆå¸«æˆ–äº‹å‹™æ‰€çš„æœå‹™è²»ç”¨</li>
                  <li><strong>è¦è²»</strong>ï¼šéœ€ç¹³äº¤çµ¦æ”¿åºœæ©Ÿé—œçš„è²»ç”¨ï¼ˆä¾‹å¦‚ï¼šç™»è¨˜è¦è²»ï¼‰</li>
                  <li><strong>é›œè²»</strong>ï¼šå…¶ä»–ç›¸é—œè²»ç”¨ï¼ˆä¾‹å¦‚ï¼šæ–‡ä»¶è¤‡å°è²»ã€éƒµè³‡ï¼‰</li>
                </ul>
                <div style="margin-top:8px;padding-top:8px;border-top:1px solid #93c5fd;">
                  <strong>ğŸ’¡ è«‹æ¬¾å–® vs æ”¶æ“šï¼š</strong><br>
                  â€¢ <strong>è«‹æ¬¾å–®</strong>ï¼šå‘å®¢æˆ¶è«‹æ¬¾æ™‚ä½¿ç”¨ï¼Œæœƒé¡¯ç¤ºä¸‰æ¬„æ˜ç´°ï¼ˆä»£è¾¦è²»ã€è¦è²»ã€é›œè²»ï¼‰<br>
                  â€¢ <strong>æ”¶æ“š</strong>ï¼šæ”¶åˆ°æ¬¾é …å¾Œä½¿ç”¨ï¼Œåƒ…é¡¯ç¤ºé …ç›®å’Œç¸½é‡‘é¡
                </div>
              </div>
            </div>
            
            <div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:16px;">
              <div id="receiptItems" style="display:grid;gap:12px;margin-bottom:12px;">
                <!-- æ˜ç»†é¡¹ç›®å°†åŠ¨æ€æ·»åŠ åœ¨è¿™é‡Œ -->
              </div>
              <button type="button" id="btn-add-item" style="width:100%;padding:8px;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;">+ æ–°å¢æ˜ç´°é …ç›®</button>
              <small style="color:#6b7280;margin-top:8px;display:block;font-size:12px;">ğŸ’¡ å¦‚ä¸å¡«å¯«æ˜ç´°ï¼Œå°‡ä½¿ç”¨ä¸‹æ–¹ç¸½é‡‘é¡ï¼ˆæ‰€æœ‰é‡‘é¡æœƒé¡¯ç¤ºåœ¨ã€Œä»£è¾¦è²»ã€æ¬„ä½ï¼‰</small>
            </div>
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="amount" style="font-weight: 500; font-size: 14px;">ç¸½é‡‘é¡ï¼ˆå¿…å¡«ï¼‰</label>
            <input id="amount" type="number" min="1" step="1" placeholder="ä¾‹å¦‚ 10000" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
            <div id="itemsTotalInfo" style="color:#6b7280;margin-top:4px;display:none;font-size:12px;"></div>
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="withholdingAmount" style="font-weight: 500; font-size: 14px;">æ‰£ç¹³é‡‘é¡ï¼ˆé¸å¡«ï¼‰</label>
            <input id="withholdingAmount" type="number" min="0" step="1" value="0" placeholder="é è¨­ç‚º 0" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;" />
            <small style="color:#6b7280;margin-top:4px;display:block;font-size:12px;">ğŸ’¡ å¦‚æœ‰æ‰£ç¹³ç¨…é¡è«‹å¡«å¯«ï¼Œå¦å‰‡ä¿æŒç‚º 0</small>
          </div>
          
          <div style="display: grid; gap: 6px;">
            <label for="notes" style="font-weight: 500; font-size: 14px;">å‚™è¨»</label>
            <textarea id="notes" rows="3" placeholder="å¯ç•™ç©º" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;"></textarea>
          </div>
          
          <div style="background:#eff6ff;border:1px solid #3b82f6;border-radius:8px;padding:12px;margin-top:8px;">
            <div style="display:flex;align-items:start;gap:8px;">
              <span style="font-size:16px;">â„¹ï¸</span>
              <div style="flex:1;font-size:13px;color:#1e40af;">
                <strong>æ”¶æ¬¾æµç¨‹ï¼š</strong>å‰µå»ºæ”¶æ“šå¾Œï¼Œè«‹åˆ°æ”¶æ“šè©³æƒ…é é»æ“Šã€Œæ–°å¢æ”¶æ¬¾ã€è¨˜éŒ„å¯¦éš›æ”¶æ¬¾ï¼Œç³»çµ±æœƒè‡ªå‹•æ›´æ–°ç‹€æ…‹ã€‚
              </div>
            </div>
          </div>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" id="btn-cancel">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="btn-create">å»ºç«‹</button>
        </div>
      </div>
    </div>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const q = document.getElementById('q');
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const statusEl = document.getElementById('status');
        const btnNew = document.getElementById('btn-new');
        const modal = document.getElementById('modalOverlay');
        const btnCancel = document.getElementById('btn-cancel');
        const btnCreate = document.getElementById('btn-create');
        const inputReceiptType = document.getElementById('receiptType');
        const inputClientId = document.getElementById('clientId');
        const inputBillingMonth = document.getElementById('billingMonth');
        const inputReceiptDate = document.getElementById('receiptDate');
        const inputDueDate = document.getElementById('dueDate');
        const inputAmount = document.getElementById('amount');
        const inputWithholdingAmount = document.getElementById('withholdingAmount');
        const inputNotes = document.getElementById('notes');
        const formError = document.getElementById('formError');
        const billingMonthRow = document.getElementById('billingMonthRow');

        let allReceipts = [];
        let allClients = [];
        let receiptItems = []; // æ”¶æ®æ˜ç»†é¡¹ç›®
        let allServiceTypes = []; // æ‰€æœ‰æœåŠ¡ç±»å‹
        const tbody = document.getElementById('tbody');
        const receiptItemsContainer = document.getElementById('receiptItems');
        const btnAddItem = document.getElementById('btn-add-item');
        const itemsTotalInfo = document.getElementById('itemsTotalInfo');
        const serviceTypesContainer = document.getElementById('serviceTypesContainer');

        // è¼‰å…¥æ‡‰é–‹æ”¶æ“šæé†’
        async function loadReceiptReminders() {
          try {
            const res = await fetch(`${apiBase}/receipts/reminders`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            
            const banner = document.getElementById('reminderBanner');
            
            if (!json.ok || !json.data || json.data.length === 0) {
              banner.innerHTML = '';
              banner.style.display = 'none';
              console.log('[æé†’] ç„¡å¾…é–‹æ”¶æ“šï¼Œéš±è—æ©«å¹…');
              return;
            }
            
            const reminders = json.data;
            console.log('[æé†’] è¼‰å…¥', reminders.length, 'å€‹å¾…é–‹æ”¶æ“š');
            
            banner.innerHTML = `
              <div class="reminder-banner">
                <div class="reminder-banner-icon">âœ…</div>
                <div class="reminder-banner-content">
                  <div class="reminder-banner-title">æœå‹™å·²å®Œæˆï¼Œå¾…é–‹æ”¶æ“šï¼ˆ${reminders.length} é …ï¼‰</div>
                  <ul class="reminder-banner-list">
                    ${reminders.map(r => `
                      <li class="reminder-banner-item">
                        <strong>${r.client_name}</strong> - ${r.service_name}
                        ï¼ˆ${r.billing_month}æœˆï¼Œé‡‘é¡ï¼š$${(r.amount || 0).toLocaleString()}${r.total_tasks ? `ï¼Œ${r.completed_tasks}/${r.total_tasks} ä»»å‹™å·²å®Œæˆ` : ''}ï¼‰
                        <a onclick="createReceiptFromReminder('${r.client_id}', ${r.client_service_id}, ${r.billing_month}, ${r.amount})">ç«‹å³é–‹æ”¶æ“š</a>
                        <span style="color:#d1d5db;margin:0 4px;">|</span>
                        <a onclick="postponeReminder(${r.client_service_id}, '${r.billing_month}', '${r.service_name}')" style="color:#f59e0b;">æš«ç·©</a>
                      </li>
                    `).join('')}
                  </ul>
                </div>
              </div>
            `;
            banner.style.display = 'block';
            
          } catch (err) {
            console.error('è¼‰å…¥æé†’å¤±æ•—:', err);
            const banner = document.getElementById('reminderBanner');
            banner.innerHTML = '';
            banner.style.display = 'none';
          }
        }

        // å¾æé†’å¿«é€Ÿå‰µå»ºæ”¶æ“š
        window.createReceiptFromReminder = async function(clientId, clientServiceId, billingMonth, amount) {
          // æ‰“é–‹å½ˆçª—
          openModal();
          
          // è‡ªå‹•å¡«å……æ•¸æ“š
          inputReceiptType.value = 'normal';
          inputClientId.value = clientId;
          inputBillingMonth.value = String(billingMonth);
          inputAmount.value = String(amount);
          
          // è¨­ç½®å®¢æˆ¶é¸æ“‡
          const clientSelectEl = document.getElementById('clientSelect');
          if (clientSelectEl) {
            clientSelectEl.value = clientId;
            clientSelectEl.dispatchEvent(new Event('change'));
          }
        };
        
        // æš«ç·©é–‹ç¥¨æé†’
        window.postponeReminder = async function(clientServiceId, billingMonth, serviceName) {
          const reason = prompt(`ç¢ºå®šè¦æš«ç·©ã€Œ${serviceName}ã€çš„é–‹ç¥¨æé†’å—ï¼Ÿ\n\nå¯é¸å¡«åŸå› ï¼ˆä¾‹å¦‚ï¼šç­‰å…¶ä»–æœå‹™å®Œæˆå¾Œä¸€èµ·é–‹æ”¶æ“šï¼‰ï¼š`);
          
          // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ
          if (reason === null) return;
          
          try {
            const now = new Date();
            const currentYear = now.getFullYear();
            const serviceMonth = `${currentYear}-${String(billingMonth).padStart(2, '0')}`;
            
            const res = await fetch(`${apiBase}/receipts/reminders/postpone`, {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                client_service_id: clientServiceId,
                service_month: serviceMonth,
                postpone_reason: reason.trim()
              })
            });
            
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/receipts');
              return;
            }
            
            const json = await res.json();
            
            if (json.ok) {
              alert('å·²æš«ç·©é–‹ç¥¨æé†’');
              // é‡æ–°è¼‰å…¥æé†’åˆ—è¡¨
              await loadReceiptReminders();
            } else {
              alert(`æš«ç·©å¤±æ•—ï¼š${json.message || 'æœªçŸ¥éŒ¯èª¤'}`);
            }
          } catch (err) {
            console.error('æš«ç·©æé†’å¤±æ•—:', err);
            alert('æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
        };

        // è¼‰å…¥å®¢æˆ¶åˆ—è¡¨
        async function loadClients() {
          try {
            const res = await fetch(`${apiBase}/clients?perPage=1000`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            
            if (json.ok && json.data) {
              allClients = json.data;
              
              // å¡«å……å®¢æˆ¶ä¸‹æ‹‰é¸å–®
              const clientSelect = document.getElementById('clientSelect');
              if (clientSelect) {
                clientSelect.innerHTML = '<option value="">è«‹é¸æ“‡å®¢æˆ¶</option>' +
                  allClients.map(c => 
                    `<option value="${c.clientId || c.client_id}">${c.companyName || c.company_name}${(c.taxId || c.tax_id) ? ' (' + (c.taxId || c.tax_id) + ')' : ''}</option>`
                  ).join('');
              }
            }
          } catch (err) {
            console.error('è¼‰å…¥å®¢æˆ¶åˆ—è¡¨å¤±æ•—:', err);
          }
        }
        
        // è¼‰å…¥æ‰€æœ‰æœå‹™é¡å‹
        async function loadServiceTypes() {
          try {
            const res = await fetch(`${apiBase}/services/types`, { credentials:'include' });
            if (res.status === 401) return;
            const json = await res.json();
            
            if (json.ok && json.data) {
              allServiceTypes = json.data;
              renderServiceTypeCheckboxes();
            }
          } catch (err) {
            console.error('è¼‰å…¥æœå‹™é¡å‹å¤±æ•—:', err);
          }
        }
        
        // æ¸²æŸ“æœå‹™é¡å‹è¤‡é¸æ¡†
        function renderServiceTypeCheckboxes() {
          if (!serviceTypesContainer || allServiceTypes.length === 0) {
            if (serviceTypesContainer) {
              serviceTypesContainer.innerHTML = '<p style="color:#6b7280;margin:0;font-size:13px;">æš«ç„¡å¯ç”¨æœå‹™é¡å‹</p>';
            }
            return;
          }
          
          serviceTypesContainer.innerHTML = allServiceTypes.map(st => `
            <label style="display:flex;align-items:center;gap:6px;padding:8px;background:white;border:1px solid #e5e7eb;border-radius:6px;cursor:pointer;font-size:13px;">
              <input type="checkbox" name="serviceType" value="${st.service_id}" style="cursor:pointer;" />
              <span>${st.service_name}</span>
            </label>
          `).join('');
        }
        
        // ç²å–é¸ä¸­çš„æœå‹™é¡å‹ID
        function getSelectedServiceTypeIds() {
          const checkboxes = document.querySelectorAll('input[name="serviceType"]:checked');
          return Array.from(checkboxes).map(cb => parseInt(cb.value, 10));
        }
        
        // ç›£è½å®¢æˆ¶é¸æ“‡è®ŠåŒ–
        const clientSelectEl = document.getElementById('clientSelect');
        if (clientSelectEl) {
          clientSelectEl.addEventListener('change', async function() {
            const clientId = this.value;
            inputClientId.value = clientId;
            
            console.log('å®¢æˆ¶é¸æ“‡è®ŠåŒ–:', clientId); // Debug
            
            if (!clientId) {
              billingMonthRow.style.display = 'none';
              return;
            }
            
            // å¦‚æœæ˜¯æ­£å¸¸æ”¶æ“šï¼Œé¡¯ç¤ºè¨ˆè²»æœˆä»½é¸æ“‡
            if (inputReceiptType.value === 'normal') {
              billingMonthRow.style.display = 'block';
            }
          });
        }

        // ç¯©é¸æ”¶æ“š
        function filterReceipts() {
          const query = q.value.toLowerCase();
          const st = statusEl.value;
          const from = dateFrom.value;
          const to = dateTo.value;
          const today = new Date();
          
          return allReceipts.filter(r => {
            // æœç´¢ï¼ˆæ”¯æŒå®¢æˆ·åã€æ”¶æ®å·ã€ç»Ÿç¼–ï¼‰
            if (query) {
              const matchName = r.clientName && r.clientName.toLowerCase().includes(query);
              const matchReceiptId = r.receiptId && r.receiptId.toLowerCase().includes(query);
              const matchTaxId = r.clientTaxId && r.clientTaxId.includes(query);
              
              if (!matchName && !matchReceiptId && !matchTaxId) {
                return false;
              }
            }
            
            // ç‹€æ…‹ç¯©é¸
            const isOverdue = r.dueDate && (new Date(r.dueDate) < today) && (r.status==='unpaid' || r.status==='partial');
            if (st === 'overdue') {
              if (!isOverdue) return false;
            } else if (st !== 'all') {
              if (r.status !== st) return false;
            }
            
            // æ—¥æœŸç¯©é¸
            if (from && r.receiptDate < from) return false;
            if (to && r.receiptDate > to) return false;
            
            return true;
          });
        }
        
        // æ¸²æŸ“æ”¶æ“šåˆ—è¡¨
        function render() {
          const filtered = filterReceipts();
          tbody.innerHTML = '';
          
          if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#9ca3af;padding:48px;font-size:14px;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ”¶æ“š</td></tr>';
            return;
          }
          
          const today = new Date();
          filtered.forEach(r => {
            const tr = document.createElement('tr');
            tr.style.borderBottom = '1px solid #f3f4f6';
            
            const isOverdue = r.dueDate && (new Date(r.dueDate) < today) && (r.status==='unpaid' || r.status==='partial');
            
            let badgeStyle = '';
            let txt = '';
            if (r.status === 'paid') {
              badgeStyle = 'background:#d1fae5;color:#065f46;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;';
              txt = 'å·²æ”¶æ¬¾';
            } else if (isOverdue) {
              badgeStyle = 'background:#fee2e2;color:#991b1b;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;';
              txt = 'é€¾æœŸ';
            } else if (r.status === 'partial') {
              badgeStyle = 'background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;';
              txt = 'éƒ¨åˆ†æ”¶æ¬¾';
            } else if (r.status === 'cancelled') {
              badgeStyle = 'background:#f3f4f6;color:#6b7280;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;';
              txt = 'ä½œå»¢';
            } else {
              badgeStyle = 'background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:500;';
              txt = 'æœªæ”¶æ¬¾';
            }
            
            // æœåŠ¡æœŸé—´æ˜¾ç¤º
            let servicePeriod = 'â€”';
            if (r.serviceStartMonth && r.serviceEndMonth) {
              if (r.serviceStartMonth === r.serviceEndMonth) {
                servicePeriod = r.serviceStartMonth;
              } else {
                servicePeriod = `${r.serviceStartMonth}<br/>è‡³<br/>${r.serviceEndMonth}`;
              }
            } else if (r.serviceStartMonth) {
              servicePeriod = r.serviceStartMonth;
            }
            
            // æœåŠ¡ç±»å‹æ˜¾ç¤º
            let serviceTypesHTML = 'â€”';
            if (r.serviceTypes && r.serviceTypes.length > 0) {
              serviceTypesHTML = r.serviceTypes.map(st => 
                `<span style="background:#eff6ff;color:#1e40af;padding:2px 8px;border-radius:4px;font-size:12px;display:inline-block;margin:2px;">${st.serviceName}</span>`
              ).join(' ');
            }
            
            tr.innerHTML = `
              <td style="padding:12px;font-size:14px;color:#1f2937;">${r.receiptId || 'â€”'}</td>
              <td style="padding:12px;font-size:14px;color:#1f2937;">${r.clientName || 'â€”'}</td>
              <td style="padding:12px;font-size:14px;color:#6b7280;">${r.clientTaxId || 'â€”'}</td>
              <td style="padding:12px;text-align:center;font-size:13px;color:#6b7280;line-height:1.4;">${servicePeriod}</td>
              <td style="padding:12px;font-size:14px;">${serviceTypesHTML}</td>
              <td style="padding:12px;text-align:right;font-size:14px;font-weight:600;color:#1f2937;">$${(r.totalAmount||0).toLocaleString()}</td>
              <td style="padding:12px;font-size:14px;color:#6b7280;">${r.receiptDate || 'â€”'}</td>
              <td style="padding:12px;font-size:14px;color:#6b7280;">${r.dueDate || 'â€”'}</td>
              <td style="padding:12px;text-align:center;"><span style="${badgeStyle}">${txt}</span></td>
              <td style="padding:12px;text-align:center;">
                <div style="display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap;">
                  <a href="/internal/receipt-detail?id=${encodeURIComponent(r.receiptId)}" style="color:#3b82f6;text-decoration:none;font-size:14px;">æŸ¥çœ‹</a>
                  <span style="color:#d1d5db;">|</span>
                  <button onclick="printInvoice('${r.receiptId}')" style="background:none;border:none;color:#10b981;cursor:pointer;font-size:14px;padding:0;">åˆ—å°è«‹æ¬¾å–®</button>
                  <span style="color:#d1d5db;">|</span>
                  <button onclick="printReceipt('${r.receiptId}')" style="background:none;border:none;color:#ea580c;cursor:pointer;font-size:14px;padding:0;">åˆ—å°æ”¶æ“š</button>
                </div>
              </td>
            `;
            
            // hoveræ•ˆæœ
            tr.addEventListener('mouseenter', () => {
              tr.style.background = '#f9fafb';
            });
            tr.addEventListener('mouseleave', () => {
              tr.style.background = '';
            });
            
            tbody.appendChild(tr);
          });
        }

        // åŠ è¼‰æ‰€æœ‰æ”¶æ“š
        async function loadAllReceipts(bypassCache = false) {
          try {
            const params = new URLSearchParams({ perPage: '1000' });
            
            // ç»•è¿‡ç¼“å­˜ï¼šæ·»åŠ æ—¶é—´æˆ³æˆ–ä½¿ç”¨ cache: 'no-cache'
            const fetchOptions = { 
              credentials: 'include',
              cache: bypassCache ? 'no-cache' : 'default'
            };
            
            const res = await fetch(`${apiBase}/receipts?${params}`, fetchOptions);
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            if (json.ok) {
              allReceipts = json.data || [];
              console.log('[æ”¶æ“šåˆ—è¡¨] è¼‰å…¥', allReceipts.length, 'ç­†æ”¶æ“š');
              if (allReceipts.length > 0) {
                console.log('[æ”¶æ“šç¯„ä¾‹ - å®Œæ•´çµæ§‹]', JSON.stringify(allReceipts[0], null, 2));
                console.log('[æœå‹™æœŸé–“]', allReceipts[0].serviceStartMonth, 'è‡³', allReceipts[0].serviceEndMonth);
                console.log('[æœå‹™é¡å‹]', allReceipts[0].serviceTypes);
              }
              render();
            }
          } catch (err) {
            console.error('è¼‰å…¥æ”¶æ“šå¤±æ•—', err);
            document.getElementById('receipts-error').textContent = 'è¼‰å…¥å¤±æ•—';
          }
        }

        // ç¯©é¸äº‹ä»¶
        let timer = null;
        q.addEventListener('input', ()=>{ clearTimeout(timer); timer = setTimeout(render, 300); });
        statusEl.addEventListener('change', render);
        dateFrom.addEventListener('change', render);
        dateTo.addEventListener('change', render);

        // === æ˜ç»†é¡¹ç›®ç®¡ç† ===
        function addReceiptItem() {
          const item = {
            id: Date.now(),
            serviceName: '',
            serviceFee: 0,
            governmentFee: 0,
            miscellaneousFee: 0,
            notes: ''
          };
          receiptItems.push(item);
          renderReceiptItems();
          updateItemsTotal();
        }
        
        function removeReceiptItem(id) {
          receiptItems = receiptItems.filter(item => item.id !== id);
          renderReceiptItems();
          updateItemsTotal();
        }
        
        function renderReceiptItems() {
          if (receiptItems.length === 0) {
            receiptItemsContainer.innerHTML = '';
            return;
          }
          
          receiptItemsContainer.innerHTML = receiptItems.map((item, index) => `
            <div style="background:white;border:1px solid #e5e7eb;border-radius:6px;padding:12px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <span style="font-weight:600;font-size:14px;color:#374151;">ğŸ“‹ é …ç›® ${index + 1}</span>
                <button type="button" onclick="removeReceiptItem(${item.id})" style="background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:12px;">åˆªé™¤</button>
              </div>
              <div style="display:grid;gap:10px;">
                <div>
                  <label style="display:block;font-size:12px;font-weight:500;color:#374151;margin-bottom:4px;">é …ç›®åç¨± <span style="color:#ef4444;">*</span></label>
                  <input type="text" placeholder="ä¾‹å¦‚ï¼šå…¬å¸ç™»è¨˜ã€ç‡Ÿæ¥­ç¨…ç”³å ±" value="${item.serviceName || ''}" 
                    onchange="updateReceiptItem(${item.id}, 'serviceName', this.value)"
                    style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:13px;" />
                </div>
                <div>
                  <label style="display:block;font-size:12px;font-weight:500;color:#374151;margin-bottom:4px;">è²»ç”¨æ˜ç´°</label>
                  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
                    <div>
                      <label style="display:block;font-size:11px;color:#6b7280;margin-bottom:2px;">ä»£è¾¦è²» (NT$)</label>
                      <input type="number" placeholder="0" value="${item.serviceFee || 0}" min="0" step="1"
                        onchange="updateReceiptItem(${item.id}, 'serviceFee', parseFloat(this.value) || 0)"
                        style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:13px;" />
                    </div>
                    <div>
                      <label style="display:block;font-size:11px;color:#6b7280;margin-bottom:2px;">è¦è²» (NT$)</label>
                      <input type="number" placeholder="0" value="${item.governmentFee || 0}" min="0" step="1"
                        onchange="updateReceiptItem(${item.id}, 'governmentFee', parseFloat(this.value) || 0)"
                        style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:13px;" />
                    </div>
                    <div>
                      <label style="display:block;font-size:11px;color:#6b7280;margin-bottom:2px;">é›œè²» (NT$)</label>
                      <input type="number" placeholder="0" value="${item.miscellaneousFee || 0}" min="0" step="1"
                        onchange="updateReceiptItem(${item.id}, 'miscellaneousFee', parseFloat(this.value) || 0)"
                        style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:13px;" />
                    </div>
                  </div>
                </div>
                <div>
                  <label style="display:block;font-size:12px;font-weight:500;color:#374151;margin-bottom:4px;">å‚™è¨»</label>
                  <input type="text" placeholder="é¸å¡«ï¼Œä¾‹å¦‚ï¼šå«è­‰æ›¸è²»ç”¨" value="${item.notes || ''}"
                    onchange="updateReceiptItem(${item.id}, 'notes', this.value)"
                    style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:13px;" />
                </div>
                <div style="text-align:right;color:#10b981;font-size:14px;padding:8px;background:#f0fdf4;border-radius:4px;">
                  å°è¨ˆï¼š<span style="font-weight:700;">NT$ ${((item.serviceFee || 0) + (item.governmentFee || 0) + (item.miscellaneousFee || 0)).toLocaleString()}</span>
                </div>
              </div>
            </div>
          `).join('');
        }
        
        function updateReceiptItem(id, field, value) {
          const item = receiptItems.find(i => i.id === id);
          if (item) {
            item[field] = value;
            renderReceiptItems();
            updateItemsTotal();
          }
        }
        
        function updateItemsTotal() {
          if (receiptItems.length === 0) {
            itemsTotalInfo.style.display = 'none';
            return;
          }
          
          const total = receiptItems.reduce((sum, item) => {
            return sum + (item.serviceFee || 0) + (item.governmentFee || 0) + (item.miscellaneousFee || 0);
          }, 0);
          
          if (total > 0) {
            itemsTotalInfo.textContent = `æ˜ç´°é …ç›®ç¸½è¨ˆï¼š$${total.toLocaleString()} ï¼ˆç¸½é‡‘é¡å°‡ä½¿ç”¨æ­¤æ•¸å€¼ï¼‰`;
            itemsTotalInfo.style.display = 'block';
            inputAmount.value = total;
          } else {
            itemsTotalInfo.style.display = 'none';
          }
        }
        
        // ç»‘å®šæ·»åŠ æ˜ç»†æŒ‰é’®
        btnAddItem.addEventListener('click', addReceiptItem);
        
        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼ˆä¾›inlineäº‹ä»¶ä½¿ç”¨ï¼‰
        window.updateReceiptItem = updateReceiptItem;
        window.removeReceiptItem = removeReceiptItem;
        
        function openModal(){
          formError.style.display = 'none';
          formError.textContent = '';
          const today = new Date();
          const yyyy = today.getFullYear();
          const mm = String(today.getMonth()+1).padStart(2,'0');
          const dd = String(today.getDate()).padStart(2,'0');
          inputReceiptDate.value = `${yyyy}-${mm}-${dd}`;
          const d2 = new Date(Date.UTC(yyyy, Number(mm)-1, Number(dd)));
          d2.setUTCDate(d2.getUTCDate()+30);
          const yyyy2 = d2.getUTCFullYear();
          const mm2 = String(d2.getUTCMonth()+1).padStart(2,'0');
          const dd2 = String(d2.getUTCDate()).padStart(2,'0');
          inputDueDate.value = `${yyyy2}-${mm2}-${dd2}`;
          
          // é‡ç½®æ–°å­—æ®µ
          inputReceiptType.value = 'normal';
          const clientSelectEl = document.getElementById('clientSelect');
          if (clientSelectEl) clientSelectEl.value = '';
          inputClientId.value = '';
          inputClientService.innerHTML = '<option value="">è«‹é¸æ“‡æœå‹™</option>';
          inputBillingMonth.value = '';
          inputAmount.value = '';
          inputNotes.value = '';
          currentClientServices = [];
          
          // é‡ç½®æ˜ç»†é¡¹ç›®
          receiptItems = [];
          renderReceiptItems();
          updateItemsTotal();
          
          // éš±è—æœå‹™å’Œæœˆä»½é¸æ“‡
          billingMonthRow.style.display = 'none';
          
          modal.style.display = 'flex';
          modal.setAttribute('aria-hidden', 'false');
        }

        function closeModal(){
          modal.style.display = 'none';
          modal.setAttribute('aria-hidden', 'true');
        }

        btnNew.addEventListener('click', openModal);
        btnCancel.addEventListener('click', closeModal);
        
        // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶
        const btnModalClose = document.getElementById('btn-modal-close');
        if (btnModalClose) {
          btnModalClose.addEventListener('click', closeModal);
        }
        
        modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

        // ç›£è½æ”¶æ“šé¡å‹è®ŠåŒ–
        inputReceiptType.addEventListener('change', () => {
          const isNormal = inputReceiptType.value === 'normal';
          billingMonthRow.style.display = isNormal ? 'block' : 'none';
          if (!isNormal) {
            inputBillingMonth.value = '';
          }
        });


        async function createReceipt(){
          formError.style.display = 'none';
          formError.textContent = '';
          
          // å¾ä¸‹æ‹‰é¸å–®ç²å–å®¢æˆ¶ID
          const clientSelectEl = document.getElementById('clientSelect');
          const client_id = clientSelectEl ? clientSelectEl.value.trim() : inputClientId.value.trim();
          
          const receipt_date = inputReceiptDate.value;
          const due_date = inputDueDate.value;
          const total_amount = Number(inputAmount.value);
          const withholding_amount = Number(inputWithholdingAmount.value) || 0;
          const notes = inputNotes.value.trim();
          
          // æ–°å­—æ®µ
          const receipt_type = inputReceiptType.value;
          const client_service_id = inputClientService.value ? parseInt(inputClientService.value, 10) : null;
          const billing_month = inputBillingMonth.value ? parseInt(inputBillingMonth.value, 10) : null;
          
          // æœåŠ¡æœŸé—´ï¼ˆåº”è®¡åˆ¶ï¼‰
          const service_start_month = document.getElementById('serviceStartMonth').value || null;
          const service_end_month = document.getElementById('serviceEndMonth').value || null;
          
          // æ‰€æœ‰æ”¶æ“šå‰µå»ºæ™‚çµ±ä¸€ç‚º"æœªæ”¶æ¬¾"ï¼Œå¾ŒçºŒé€éæ”¶æ¬¾è¨˜éŒ„ä¾†æ›´æ–°ç‹€æ…‹
          const status = 'unpaid';
          
          console.log('å‰µå»ºæ”¶æ“š - å®¢æˆ¶ID:', client_id); // Debug
          
          const errors = [];
          if (!client_id) errors.push('è«‹é¸æ“‡å®¢æˆ¶');
          if (!/^\d{4}-\d{2}-\d{2}$/.test(receipt_date)) errors.push('è«‹é¸æ“‡é–‹ç«‹æ—¥æœŸ');
          if (!service_start_month) errors.push('è«‹é¸æ“‡æœå‹™é–‹å§‹æœˆä»½');
          if (!service_end_month) errors.push('è«‹é¸æ“‡æœå‹™çµæŸæœˆä»½');
          if (service_start_month && service_end_month && service_start_month > service_end_month) {
            errors.push('æœå‹™çµæŸæœˆä»½ä¸èƒ½æ—©æ–¼é–‹å§‹æœˆä»½');
          }
          if (!Number.isFinite(total_amount) || total_amount <= 0) errors.push('é‡‘é¡éœ€å¤§æ–¼ 0');
          if (errors.length){
            formError.textContent = errors.join('ï¼›');
            formError.style.display = 'block';
            return;
          }
          btnCreate.disabled = true;
          try {
            const payload = {
              client_id,
              receipt_date,
              due_date,
              total_amount,
              withholding_amount,
              status,
              notes,
              receipt_type
            };
            
            // åªåœ¨æœ‰å€¼æ™‚æ·»åŠ å¯é¸å­—æ®µ
            if (client_service_id) payload.client_service_id = client_service_id;
            if (billing_month) payload.billing_month = billing_month;
            if (service_start_month) payload.service_start_month = service_start_month;
            if (service_end_month) payload.service_end_month = service_end_month;
            
            // æ·»åŠ æ˜ç»†é¡¹ç›®ï¼ˆå¦‚æœæœ‰ï¼‰
            if (receiptItems.length > 0) {
              // éªŒè¯æ˜ç»†é¡¹ç›®
              const validItems = receiptItems.filter(item => item.serviceName && item.serviceName.trim());
              if (validItems.length > 0) {
                payload.items = validItems.map(item => ({
                  service_name: item.serviceName.trim(),
                  service_fee: item.serviceFee || 0,
                  government_fee: item.governmentFee || 0,
                  miscellaneous_fee: item.miscellaneousFee || 0,
                  notes: item.notes ? item.notes.trim() : ''
                }));
              }
            }
            
            // æ·»åŠ æœåŠ¡ç±»å‹ï¼ˆå¦‚æœç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©äº†ï¼‰
            const selectedServiceTypeIds = getSelectedServiceTypeIds();
            if (selectedServiceTypeIds.length > 0) {
              payload.service_type_ids = selectedServiceTypeIds;
            }
            
            console.log('ç™¼é€è«‹æ±‚:', payload); // Debug
            
            const res = await fetch(`${apiBase}/receipts`, {
              method:'POST', credentials:'include', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify(payload)
            });
            if (res.status === 401) { location.assign('/login?redirect=/internal/receipts'); return; }
            const json = await res.json();
            console.log('å›æ‡‰:', json); // Debug
            if (!res.ok || !json || json.ok !== true) throw new Error(json?.message || 'å»ºç«‹å¤±æ•—');
            
            // é¡¯ç¤ºæˆåŠŸæç¤º
            alert('âœ… æ”¶æ“šå»ºç«‹æˆåŠŸ');
            
            closeModal();
            
            // åˆ·æ–°åˆ—è¡¨å’Œæé†’ï¼ˆå¼ºåˆ¶ç»•è¿‡ç¼“å­˜ï¼‰
            await Promise.all([
              loadAllReceipts(true),  // bypassCache = true
              loadReceiptReminders()
            ]);
          } catch (err) {
            console.error('å‰µå»ºæ”¶æ“šå¤±æ•—:', err); // Debug
            formError.textContent = String(err?.message || 'å»ºç«‹å¤±æ•—');
            formError.style.display = 'block';
          } finally {
            btnCreate.disabled = false;
          }
        }

        btnCreate.addEventListener('click', createReceipt);

        // âš¡ é¢„æ¸²æŸ“åˆå§‹åŒ–
        if (window.PagePrerender) {
          window.PagePrerender.init('.clients-content');
        }

        // åˆå§‹åŒ–
        async function init() {
          await Promise.all([
            loadReceiptReminders(),
            loadClients(),
            loadServiceTypes(),
            loadAllReceipts()
          ]);
          
          // âš¡ è‡ªåŠ¨ä¿å­˜é¢„æ¸²æŸ“
          if (window.PagePrerender) {
            setTimeout(() => window.PagePrerender.autoSave('.clients-content', 2000), 1000);
          }
        }
        
        init();
      })();
      
      // === å…¬å¸ä¿¡æ¯é…ç½® ===
      let COMPANY_INFO = {
        name: 'éœçˆ¾æœæ–¯æœƒè¨ˆå¸«äº‹å‹™æ‰€',
        nameEn: 'HorgosCPA',
        address: 'è‡ºä¸­å¸‚è¥¿å€å»ºåœ‹è·¯21è™Ÿ',
        addressLine2: '3æ¨“ä¹‹1',
        phone: '04-22205606',
        taxId: '92254178',
        bank: 'æ°¸è±éŠ€è¡Œå°ä¸­åˆ†è¡Œ',
        bankCode: '807',
        accountNumber: '003-018-0019011-7'
      };
      
      // åŠ è½½å…¬å¸èµ„æ–™
      async function loadCompanyInfo(setNumber) {
        try {
          const category = `company${setNumber}`;
          const res = await fetch(`/internal/api/v1/settings?category=${category}`, { credentials: 'include' });
          const json = await res.json();
          
          if (json.ok && json.data) {
            const companyInfo = {};
            json.data.forEach(setting => {
              // ç§»é™¤categoryå‰ç¼€
              const key = setting.settingKey.replace(`${category}_`, '');
              if (key === 'name') companyInfo.name = setting.settingValue;
              if (key === 'name_en') companyInfo.nameEn = setting.settingValue;
              if (key === 'address') companyInfo.address = setting.settingValue;
              if (key === 'address_line2') companyInfo.addressLine2 = setting.settingValue;
              if (key === 'phone') companyInfo.phone = setting.settingValue;
              if (key === 'tax_id') companyInfo.taxId = setting.settingValue;
              if (key === 'bank') companyInfo.bank = setting.settingValue;
              if (key === 'bank_code') companyInfo.bankCode = setting.settingValue;
              if (key === 'account_number') companyInfo.accountNumber = setting.settingValue;
            });
            return companyInfo;
          }
          return null;
        } catch (e) {
          console.error('è¼‰å…¥å…¬å¸è³‡æ–™å¤±æ•—:', e);
          return null;
        }
      }
      
      // æ˜¾ç¤ºå…¬å¸èµ„æ–™é€‰æ‹©å¯¹è¯æ¡†
      function showCompanySelector(callback) {
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
        modal.innerHTML = `
          <div style="background:white;border-radius:12px;padding:32px;max-width:400px;width:90%;">
            <h3 style="margin:0 0 20px 0;font-size:20px;font-weight:600;">é¸æ“‡å…¬å¸è³‡æ–™</h3>
            <p style="color:#666;margin-bottom:24px;font-size:14px;">è«‹é¸æ“‡è¦ç”¨æ–¼æ­¤æ–‡ä»¶çš„å…¬å¸è³‡æ–™</p>
            <div style="display:flex;gap:12px;">
              <button id="selectCompany1" style="flex:1;padding:16px;border:2px solid #3b82f6;background:#3b82f6;color:white;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;">å…¬å¸è³‡æ–™ 1</button>
              <button id="selectCompany2" style="flex:1;padding:16px;border:2px solid #3b82f6;background:white;color:#3b82f6;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;">å…¬å¸è³‡æ–™ 2</button>
            </div>
            <button id="cancelSelect" style="width:100%;margin-top:12px;padding:12px;border:1px solid #d1d5db;background:white;color:#666;border-radius:8px;font-size:14px;cursor:pointer;">å–æ¶ˆ</button>
          </div>
        `;
        document.body.appendChild(modal);
        
        document.getElementById('selectCompany1').onclick = () => {
          document.body.removeChild(modal);
          callback(1);
        };
        document.getElementById('selectCompany2').onclick = () => {
          document.body.removeChild(modal);
          callback(2);
        };
        document.getElementById('cancelSelect').onclick = () => {
          document.body.removeChild(modal);
        };
      }
      
      // === æ‰“å°åŠŸèƒ½ ===
      async function printInvoice(receiptId) {
        showCompanySelector(async (setNumber) => {
          const companyInfo = await loadCompanyInfo(setNumber);
          if (!companyInfo || !companyInfo.name) {
            alert(`å…¬å¸è³‡æ–™ ${setNumber} å°šæœªè¨­å®šï¼Œè«‹å…ˆè‡³è¨­å®šé é¢è¨­å®šå…¬å¸è³‡æ–™`);
            return;
          }
          await printInvoiceWithCompany(receiptId, companyInfo);
        });
      }
      
      async function printInvoiceWithCompany(receiptId, companyInfo) {
        try {
        const printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>åˆ—å°è«‹æ¬¾å–®</title>');
        printWindow.document.write('<meta charset="utf-8">');
        printWindow.document.write('<!-- v20251107 -->');
        printWindow.document.write(`<style>
          @page { size: A4; margin: 20mm 25mm; }
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body { 
            font-family: "DFKai-SB", "æ¨™æ¥·é«”", "Microsoft JhengHei", "PingFang TC", serif; 
            font-size: 12pt;
            line-height: 1.8;
            padding: 0;
          }
          .company-header {
            margin-bottom: 10mm;
          }
          .company-name-zh { 
            font-size: 20pt; 
            font-weight: bold; 
            color: #8B6914;
            letter-spacing: 2pt;
            margin-bottom: 6pt;
          }
          .company-name-zh span {
            border-bottom: 2.5px solid #8B6914;
          }
          .company-name-en { 
            font-size: 13pt; 
            font-weight: bold; 
            color: #000;
            font-family: "Times New Roman", serif;
          }
          .company-name-en span {
            border-bottom: 2.5px solid #000;
          }
          .doc-title { 
            font-size: 18pt; 
            font-weight: bold; 
            text-align: center;
            letter-spacing: 8pt;
            border-bottom: 2px solid #000;
            padding-bottom: 3mm;
            margin-bottom: 8mm;
          }
          .customer-name { 
            font-size: 12pt;
            margin-bottom: 8mm;
          }
          table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 8mm 0;
          }
          th, td { 
            border: 1px solid #000; 
            padding: 8pt;
            font-size: 12pt;
          }
          th { 
            text-align: center; 
            font-weight: normal;
          }
          td { 
            text-align: left;
          }
          .text-right { text-align: right !important; }
          .text-center { text-align: center !important; }
          .total-amount { 
            font-size: 13pt;
            font-weight: bold;
            color: #000;
            margin: 8mm 0 3mm 0;
          }
          .withholding { 
            font-size: 12pt;
            margin-bottom: 8mm;
          }
          .bank-section { 
            font-size: 12pt;
            margin-bottom: 8mm;
          }
          .bank-info { 
            font-size: 12pt;
            line-height: 2;
            display: inline-block;
            vertical-align: top;
          }
          .stamp-area {
            display: inline-block;
            width: 80pt;
            height: 80pt;
            margin-left: 30pt;
            vertical-align: top;
          }
          .date-row {
            font-size: 12pt;
            text-align: center;
            letter-spacing: 6pt;
            margin: 15mm 0 10mm 0;
          }
          .page-end {
            text-align: center;
            font-size: 11pt;
            margin-top: 15mm;
            color: #666;
          }
          @media print { 
            button { display: none !important; }
            body { padding: 0; }
          }
        </style>`);
        printWindow.document.write('</head><body>');
        printWindow.document.write('<button onclick="window.print()" style="position:fixed;top:10px;right:10px;padding:8px 16px;background:#10b981;color:white;border:none;border-radius:4px;cursor:pointer;z-index:1000;">åˆ—å°</button>');
        
        try {
          const response = await fetch(`/internal/api/v1/receipts/${receiptId}`);
          const result = await response.json();
          
          if (!result.ok || !result.data) {
            printWindow.close();
            alert('ç„¡æ³•è¼‰å…¥æ”¶æ“šè³‡æ–™');
            return;
          }
          
          const receipt = result.data;
          
          // æ°‘å›½çºªå¹´è½¬æ¢
          const convertToROCDateInvoice = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const rocYear = date.getFullYear() - 1911;
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            // è½¬æ¢ä¸ºä¸­æ–‡æ•°å­—
            const numberToChinese = (num) => {
              const digits = ['â—‹', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹'];
              if (num < 10) return digits[num];
              if (num === 10) return 'å';
              if (num < 20) return 'å' + digits[num - 10];
              const tens = Math.floor(num / 10);
              const ones = num % 10;
              if (tens === 0) return digits[ones];
              if (ones === 0) return digits[tens] + 'å';
              return digits[tens] + 'å' + digits[ones];
            };
            
            // è½¬æ¢å¹´ä»½ä¸ºå•ç‹¬æ•°å­—ï¼ˆå¦‚114å¹´ -> ä¸€ä¸€å››å¹´ï¼‰
            const convertYear = (year) => {
              const digits = ['â—‹', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹'];
              const yearStr = String(year);
              let result = '';
              for (let i = 0; i < yearStr.length; i++) {
                result += digits[parseInt(yearStr[i])];
              }
              return result;
            };
            
            return `ä¸­ã€€è¯ã€€æ°‘ã€€åœ‹ã€€${convertYear(rocYear)}ã€€å¹´ã€€${numberToChinese(month)}ã€€æœˆã€€${numberToChinese(day)}ã€€æ—¥`;
          };
          
          let totalServiceFee = 0;
          let totalGovFee = 0;
          let totalMiscFee = 0;
          
          printWindow.document.write(`
            <div class="company-header">
              <div class="company-name-zh"><span>${companyInfo.name}</span></div>
              <div class="company-name-en"><span>${companyInfo.nameEn || ''}</span></div>
            </div>
            
            <div class="doc-title">è«‹æ¬¾å–®</div>
            
            <div class="customer-name"><strong>å®¢æˆ¶åç¨±ï¼š</strong>${receipt.clientName}</div>
            
            <table>
              <thead>
                <tr>
                  <th style="width:40%">é …ç›®</th>
                  <th style="width:20%">ä»£è¾¦è²»<br>ï¼ˆæ–°å°å¹£ï¼‰</th>
                  <th style="width:20%">è¦è²»<br>ï¼ˆæ–°å°å¹£ï¼‰</th>
                  <th style="width:20%">é›œè²»<br>ï¼ˆæ–°å°å¹£ï¼‰</th>
                </tr>
              </thead>
              <tbody>
          `);
          
          // æ·»åŠ æ˜ç»†
          if (receipt.items && receipt.items.length > 0) {
            receipt.items.forEach(item => {
              const serviceFee = item.serviceFee || 0;
              const govFee = item.governmentFee || 0;
              const miscFee = item.miscellaneousFee || 0;
              
              totalServiceFee += serviceFee;
              totalGovFee += govFee;
              totalMiscFee += miscFee;
              
              printWindow.document.write(`
                <tr>
                  <td>${item.serviceName}${item.notes ? 'ï¼Œ' + item.notes : ''}</td>
                  <td class="text-right">${serviceFee > 0 ? '$' + serviceFee.toLocaleString() : '$-'}</td>
                  <td class="text-right">${govFee > 0 ? '$' + govFee.toLocaleString() : '$-'}</td>
                  <td class="text-right">${miscFee > 0 ? '$' + miscFee.toLocaleString() : '$-'}</td>
                </tr>
              `);
            });
          } else {
            totalServiceFee = receipt.totalAmount;
            printWindow.document.write(`
              <tr>
                <td>${receipt.notes || 'æœå‹™è²»ç”¨'}</td>
                <td class="text-right">$${receipt.totalAmount.toLocaleString()}</td>
                <td class="text-right">$-</td>
                <td class="text-right">$-</td>
              </tr>
            `);
          }
          
          // åˆè®¡è¡Œ
          printWindow.document.write(`
                <tr>
                  <td class="text-center">åˆè¨ˆ</td>
                  <td class="text-right">$${totalServiceFee.toLocaleString()}</td>
                  <td class="text-right">$${totalGovFee > 0 ? totalGovFee.toLocaleString() : '-'}</td>
                  <td class="text-right">$${totalMiscFee > 0 ? totalMiscFee.toLocaleString() : '-'}</td>
                </tr>
              </tbody>
            </table>
            
            <div class="total-amount">è²»ç”¨ç¸½è¨ˆï¼š${receipt.totalAmount.toLocaleString()} å…ƒ</div>
            
            <div class="withholding">ï¼ˆæœ¬æ¬¡æ‰£ç¹³é‡‘é¡ï¼š${receipt.withholdingAmount || 0} å…ƒï¼‰</div>
            
            <div class="bank-section">æ¬¾é …è«‹åŒ¯å…¥ä¸‹åˆ—å¸³æˆ¶ï¼Œè¬è¬ï¼</div>
            
            <div class="bank-info">
              æˆ¶åï¼š${companyInfo.name}<br>
              éŠ€è¡Œï¼š${companyInfo.bank}<br>
              éŠ€è¡Œä»£è™Ÿï¼š${companyInfo.bankCode}<br>
              å¸³è™Ÿï¼š${companyInfo.accountNumber}
            </div>
            <div class="stamp-area">
              <!-- å°ç« åŒºåŸŸ -->
            </div>
            
            <div class="date-row">${convertToROCDateInvoice(receipt.receiptDate)}</div>
            
            <div class="page-end">â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”æœ¬é å®Œâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</div>
          `);
          
          printWindow.document.write('</body></html>');
          printWindow.document.close();
        } catch (error) {
          console.error('åˆ—å°è«‹æ¬¾å–®å¤±æ•—:', error);
          alert('åˆ—å°è«‹æ¬¾å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      }
      
      async function printReceipt(receiptId) {
        showCompanySelector(async (setNumber) => {
          const companyInfo = await loadCompanyInfo(setNumber);
          if (!companyInfo || !companyInfo.name) {
            alert(`å…¬å¸è³‡æ–™ ${setNumber} å°šæœªè¨­å®šï¼Œè«‹å…ˆè‡³è¨­å®šé é¢è¨­å®šå…¬å¸è³‡æ–™`);
            return;
          }
          await printReceiptWithCompany(receiptId, companyInfo);
        });
      }
      
      async function printReceiptWithCompany(receiptId, companyInfo) {
        try {
        const printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>åˆ—å°æ”¶æ“š</title>');
        printWindow.document.write('<meta charset="utf-8">');
        printWindow.document.write('<!-- v20251107 -->');
        printWindow.document.write(`<style>
          @page { size: A4; margin: 12mm 20mm; }
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body { 
            font-family: "DFKai-SB", "æ¨™æ¥·é«”", "BiauKai", serif; 
            font-size: 10pt;
            padding: 0;
          }
          .receipt-page { page-break-after: auto; }
          .receipt-copy { 
            position: relative;
            border: 2px solid #000; 
            padding: 8mm 10mm 8mm 10mm;
            padding-right: 15mm;
            margin-bottom: 8mm;
            min-height: auto;
          }
          .receipt-copy:last-child { margin-bottom: 0; page-break-after: avoid; }
          .copy-label { 
            position: absolute; 
            right: 3mm; 
            top: 50%; 
            transform: translateY(-50%); 
            writing-mode: vertical-rl;
            font-size: 16pt; 
            font-weight: bold;
            letter-spacing: 8pt;
          }
          .company-name { 
            font-size: 20pt; 
            font-weight: bold; 
            text-align: center; 
            margin-bottom: 1mm;
          }
          .company-name span {
            border-bottom: 2px solid #000;
          }
          .company-info { 
            font-size: 9pt; 
            text-align: right; 
            margin-bottom: 2mm;
            margin-top: 1mm;
            line-height: 1.3;
          }
          .title { 
            font-size: 20pt; 
            font-weight: bold; 
            text-align: center; 
            margin: 2mm 0 2mm 0;
          }
          .title span {
            border-bottom: 2px solid #000;
            display: inline-block;
          }
          .date { text-align: center; font-size: 10pt; margin-bottom: 3mm; }
          .received-from { font-size: 11pt; margin: 3mm 0; }
          table { width: 100%; border-collapse: collapse; margin: 3mm 0; border: 2px solid #000; }
          th, td { border: 1.5px solid #000; padding: 4pt 6pt; }
          th { text-align: center; font-weight: normal; font-size: 10pt; }
          td { font-size: 10pt; }
          .amount-chinese { font-weight: bold; padding: 6pt; font-size: 11pt; }
          .signature { 
            display: flex; 
            justify-content: space-around; 
            margin: 4mm 0 3mm 0; 
            font-size: 11pt; 
          }
          @media print { 
            button { display: none !important; }
            body { padding: 0; }
          }
        </style>`);
        printWindow.document.write('</head><body>');
        printWindow.document.write('<button onclick="window.print()" style="position:fixed;top:10px;right:10px;padding:8px 16px;background:#10b981;color:white;border:none;border-radius:4px;cursor:pointer;z-index:1000;">åˆ—å°</button>');
        
        try {
          const response = await fetch(`/internal/api/v1/receipts/${receiptId}`);
          const result = await response.json();
          
          if (!result.ok || !result.data) {
            printWindow.close();
            alert('ç„¡æ³•è¼‰å…¥æ”¶æ“šè³‡æ–™');
            return;
          }
          
          const receipt = result.data;
          
          // æ°‘å›½çºªå¹´è½¬æ¢
          const convertToROCDate = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const rocYear = date.getFullYear() - 1911;
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `ä¸­è¯æ°‘åœ‹${rocYear}å¹´${month}æœˆ${day}æ—¥`;
          };
          
          // æ•°å­—è½¬ä¸­æ–‡å¤§å†™
          const convertAmountToChinese = (amount) => {
            const digits = ['é›¶', 'å£¹', 'è²³', 'åƒ', 'è‚†', 'ä¼', 'é™¸', 'æŸ’', 'æŒ', 'ç–'];
            const units = ['', 'æ‹¾', 'ä½°', 'ä»Ÿ'];
            
            if (amount === 0) return 'é›¶';
            
            const amountInt = Math.floor(amount);
            
            // è½¬æ¢ä¸€ä¸ª4ä½æ•°æ®µ
            const convertSection = (num) => {
              if (num === 0) return '';
              const str = num.toString().padStart(4, '0');
              let result = '';
              let hasNonZero = false;
              
              for (let i = 0; i < 4; i++) {
                const digit = parseInt(str[i]);
                const unitIndex = 3 - i;
                
                if (digit === 0) {
                  if (hasNonZero && i < 3) {
                    // åªåœ¨æœ‰éé›¶æ•°å­—ä¹‹åä¸”ä¸æ˜¯æœ€åä¸€ä½æ—¶å¯èƒ½åŠ é›¶
                    const hasNextNonZero = str.slice(i + 1).split('').some(d => d !== '0');
                    if (hasNextNonZero) {
                      result += 'é›¶';
                      hasNonZero = false;
                    }
                  }
                } else {
                  result += digits[digit] + units[unitIndex];
                  hasNonZero = true;
                }
              }
              
              return result;
            };
            
            // åˆ†æ®µï¼šäº¿ã€ä¸‡ã€ä¸ª
            const yi = Math.floor(amountInt / 100000000);
            const wan = Math.floor((amountInt % 100000000) / 10000);
            const ge = amountInt % 10000;
            
            let result = '';
            
            if (yi > 0) {
              result += convertSection(yi) + 'å„„';
            }
            
            if (wan > 0) {
              if (result && wan < 1000) {
                result += 'é›¶';
              }
              result += convertSection(wan) + 'è¬';
            } else if (yi > 0 && ge > 0) {
              result += 'é›¶';
            }
            
            if (ge > 0) {
              if (result && ge < 1000) {
                result += 'é›¶';
              }
              result += convertSection(ge);
            }
            
            return result || 'é›¶';
          };
          
          const rocDate = convertToROCDate(receipt.receiptDate);
          const amountChinese = convertAmountToChinese(receipt.totalAmount);
          
          // ç”Ÿæˆä¸¤è”æ”¶æ®ï¼ˆæ”¶æ‰§è”å’Œå­˜æŸ¥è”ï¼‰åœ¨åŒä¸€é¡µ
          printWindow.document.write('<div class="receipt-page">');
          
          const copies = ['æ”¶åŸ·è¯', 'å­˜æŸ¥è¯'];
          
          copies.forEach((copyLabel, index) => {
            printWindow.document.write(`
              <div class="receipt-copy">
                <div class="copy-label">${copyLabel}</div>
                
                <div class="company-name"><span>${companyInfo.name}</span></div>
                
                <div class="company-info">
                  ${companyInfo.address}${companyInfo.addressLine2 || ''}<br>
                  é›»è©±ï¼š${companyInfo.phone}<br>
                  çµ±ä¸€ç·¨è™Ÿï¼š${companyInfo.taxId}<br>
                  æ”¶æ“šç·¨è™Ÿï¼š${receiptId}
                </div>
                
                <div class="title"><span>æ”¶ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€æ“š</span></div>
                
                <div class="date">${rocDate}</div>
                
                <div class="received-from">
                  èŒ²æ”¶åˆ°ã€€<strong>${receipt.clientName}</strong>
                </div>
                
                <table>
                  <thead>
                    <tr>
                      <th style="width:50%">é …ã€€ã€€ç›®</th>
                      <th style="width:20%">é‡‘ã€€ã€€é¡</th>
                      <th style="width:15%">æ”¯ç¥¨è™Ÿç¢¼</th>
                      <th style="width:15%">å‚™ã€€ã€€è¨»</th>
                    </tr>
                  </thead>
                  <tbody>
            `);
            
            // æ·»åŠ æ˜ç»†æˆ–æ€»é‡‘é¢
            if (receipt.items && receipt.items.length > 0) {
              receipt.items.forEach(item => {
                const itemTotal = (item.serviceFee || 0) + (item.governmentFee || 0) + (item.miscellaneousFee || 0);
                printWindow.document.write(`
                  <tr>
                    <td>${item.serviceName}</td>
                    <td style="text-align:right">${itemTotal.toLocaleString()}</td>
                    <td style="text-align:center"></td>
                    <td>${item.notes || ''}</td>
                  </tr>
                `);
              });
            } else {
              printWindow.document.write(`
                <tr>
                  <td>${receipt.notes || 'æœå‹™è²»ç”¨'}</td>
                  <td style="text-align:right">${receipt.totalAmount.toLocaleString()}</td>
                  <td style="text-align:center"></td>
                  <td></td>
                </tr>
              `);
            }
            
            // æ·»åŠ ç©ºç™½è¡Œï¼ˆè‡³å°‘3è¡Œï¼‰
            const itemCount = receipt.items ? receipt.items.length : 1;
            const emptyRows = Math.max(3 - itemCount, 0);
            for (let i = 0; i < emptyRows; i++) {
              printWindow.document.write('<tr><td>&nbsp;</td><td></td><td></td><td></td></tr>');
            }
            
            // åˆè®¡è¡Œ
            printWindow.document.write(`
                    <tr>
                      <td colspan="4" class="amount-chinese">
                        åˆè¨ˆé‡‘é¡(å¤§å¯«)æ–°å°å¹£ï¼š${amountChinese}å…ƒæ•´
                      </td>
                    </tr>
                  </tbody>
                </table>
                
                <div class="signature">
                  <div>æœƒè¨ˆå¸«ï¼šã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€</div>
                  <div>ç¶“æ”¶äººï¼šã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€</div>
                </div>
              </div>
            `);
          });
          
          printWindow.document.write('</div>'); // å…³é—­ receipt-page
          printWindow.document.write('</body></html>');
          printWindow.document.close();
        } catch (error) {
          console.error('åˆ—å°æ”¶æ“šå¤±æ•—:', error);
          alert('åˆ—å°æ”¶æ“šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      }
      
      
      // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
      window.printInvoice = printInvoice;
      window.printReceipt = printReceipt;
    </script>
    <script src="/assets/js/components/bootstrap.js?v=3"></script>
  </body>
  </html>


