# 假期系统测试清单

## 测试环境
- URL: https://www.horgoscpa.com/internal/leaves
- 测试日期: 2025-11-01

---

## 1. 页面初始化测试

### 1.1 余额显示
- [ ] 余额总览正确显示（不重复显示补休）
- [ ] 补休显示单位为"小时"
- [ ] 其他假期显示单位为"天"
- [ ] 如果没有余额，显示"無餘額資料"

### 1.2 性别过滤测试
**测试用户性别：______（F/M）**

#### 如果是女性（F）：
- [ ] 可以看到：特休、病假、事假、补休、生理假、公假
- [ ] 看不到：陪产检及陪产假

#### 如果是男性（M）：
- [ ] 可以看到：特休、病假、事假、补休、公假
- [ ] 看不到：生理假

### 1.3 生活事件假期显示
- [ ] 未登记生活事件时，婚假/丧假/产假/产检假/陪产假不显示
- [ ] 登记后且有余额时才显示相应假期选项

---

## 2. 时间选择测试

### 2.1 时间下拉选项
- [ ] 开始时间选项：08:30, 09:00, 09:30... 12:30, 13:30, 14:00... 17:30
- [ ] 结束时间选项：同上
- [ ] 所有时间都是半小时间隔

### 2.2 时间计算（自动扣除午休12:30-13:30）

**测试用例 1：不跨午休**
- 开始：09:00，结束：11:00
- [ ] 显示：2 小時

**测试用例 2：跨午休（完整午休）**
- 开始：10:00，结束：14:00
- [ ] 显示：3 小時（10:00-12:30=2.5小時 + 13:30-14:00=0.5小時）

**测试用例 3：跨午休（部分午休）**
- 开始：12:00，结束：14:00
- [ ] 显示：1.5 小時（12:00-12:30=0.5小時 + 13:30-14:00=0.5小時）

**测试用例 4：上午时段**
- 开始：08:30，结束：12:30
- [ ] 显示：4 小時

**测试用例 5：下午时段**
- 开始：13:30，结束：17:30
- [ ] 显示：4 小時

**测试用例 6：全天**
- 开始：08:30，结束：17:30
- [ ] 显示：8 小時（午休扣除1小時）

**测试用例 7：结束早于开始**
- 开始：14:00，结束：10:00
- [ ] 显示：空白
- [ ] 提交时错误提示："結束時間必須晚於開始時間"

---

## 3. 生活事件登记测试

### 3.1 性别过滤
**女性用户应该看到：**
- [ ] 结婚
- [ ] 各类丧假
- [ ] 分娩
- [ ] 妊娠3个月以上流产
- [ ] 妊娠

**男性用户应该看到：**
- [ ] 结婚
- [ ] 各类丧假
- [ ] 配偶分娩或怀孕

### 3.2 登记后余额显示
- [ ] 登记婚假后，假期下拉选项出现"婚假"
- [ ] 余额总览显示"婚假 剩余 8 天 / 年度额度 8 天"
- [ ] 登记后可以在假期申请中选择该假期

---

## 4. 假期申请测试

### 4.1 基本申请流程
- [ ] 选择假别
- [ ] 选择日期
- [ ] 选择开始时间
- [ ] 选择结束时间
- [ ] 自动计算并显示时数
- [ ] 点击"送出申請"

### 4.2 余额检查

**测试场景 1：余额充足**
- 补休余额：8 小时
- 申请：2 小时
- [ ] 正常提交，不显示警告

**测试场景 2：余额不足**
- 特休余额：0.5 天（4 小时）
- 申请：6 小时
- [ ] 弹出提醒："特休餘額不足！剩餘：0.5 天，申請：6 小時，是否仍要送出申請？"
- [ ] 点击"取消"可以返回修改
- [ ] 点击"确定"继续提交（后端会验证）

**测试场景 3：补休余额检查（FIFO）**
- 补休余额：3 小时
- 申请：5 小时
- [ ] 弹出提醒："補休餘額不足！"
- [ ] 后端应该拒绝（返回错误）

### 4.3 性别限制检查
**女性用户申请陪产假：**
- [ ] 后端返回错误："此假別僅限男性"

**男性用户申请生理假：**
- [ ] 后端返回错误："此假別僅限女性"

### 4.4 生活事件假期余额
**未登记婚假但尝试申请婚假：**
- [ ] 下拉选项中看不到"婚假"

**登记婚假（8天）后申请10小时：**
- [ ] 可以申请
- [ ] 余额应该扣减：8天 - 10小时 = 8天 - 1.25天 = 6.75天

---

## 5. 补休特殊逻辑测试

### 5.1 补休FIFO扣减
**前置条件：**
- 有3笔补休记录：
  - 10月5日：3小时（最早）
  - 10月15日：2小时
  - 10月25日：1小时（最晚）
- 总共：6小时

**申请4小时补休：**
- [ ] 先扣 10月5日的 3小时（全部用完）
- [ ] 再扣 10月15日的 1小时（剩余1小时）
- [ ] 10月25日的 1小时不动
- [ ] 剩余补休：2小时（1+1）

### 5.2 补休到期转加班费
**测试场景：**
- 10月31日有2小时补休未使用
- [ ] 11月1日 Cron 执行后
- [ ] 补休记录状态变为 'expired'
- [ ] 写入 CompensatoryOvertimePay 表
- [ ] 计算加班费 = 2小时 × 时薪 × 倍率

---

## 6. 列表显示测试

### 6.1 表格结构
- [ ] 列标题：假别、日期与时间、时数、提交日期
- [ ] 没有"状态"列
- [ ] 没有"原因"列
- [ ] 没有"迄日"列

### 6.2 显示格式
- [ ] 日期与时间：2025-10-30 08:30-12:00
- [ ] 时数：2 小时
- [ ] 提交日期：2025-10-30

### 6.3 搜索功能
- [ ] 输入假别关键字可以搜索
- [ ] 实时搜索（300ms 延迟）

---

## 7. 管理员功能测试

### 7.1 员工选择器
**管理员登录：**
- [ ] 可以看到"選擇員工"下拉选项
- [ ] 可以选择"全部員工"
- [ ] 可以选择特定员工

**普通员工登录：**
- [ ] 看不到"選擇員工"下拉选项
- [ ] 只能看到自己的假期

### 7.2 权限验证
- [ ] 管理员可以查看任何员工的假期
- [ ] 普通员工尝试用 URL 参数 `?user_id=2` 查看他人假期
- [ ] 后端应该忽略该参数，只返回自己的数据

---

## 8. 边界条件测试

### 8.1 时间边界
- [ ] 08:30 是最早可选时间
- [ ] 17:30 是最晚可选时间
- [ ] 12:30-13:30 午休时段会自动扣除

### 8.2 数值精度
- [ ] 0.5 小时正确计算
- [ ] 非0.5倍数的时间段（如1.75小时）正确显示

### 8.3 空值处理
- [ ] 未选择假别时提示："請選擇假別"
- [ ] 未选择日期时提示："請選擇日期"
- [ ] 未选择时间时提示："請選擇開始時間"/"請選擇結束時間"

---

## 9. 后端验证测试

### 9.1 数据验证
发送 POST 请求测试：
```json
{
  "leave_type": "annual",
  "start_date": "2025-11-01",
  "start_time": "09:00",
  "end_time": "11:00",
  "amount": 2
}
```
- [ ] 成功返回 201
- [ ] 返回消息："申請成功"

### 9.2 错误处理
**无效时间格式：**
- [ ] start_time: "9:00" (应该是 "09:00")
- [ ] 返回错误："請選擇開始時間（格式 HH:MM）"

**非半小时倍数：**
- [ ] start_time: "09:15"
- [ ] 返回错误："時間必須是整點或半點"

---

## 10. 前端状态管理测试

### 10.1 模态框状态
- [ ] 打开申请假期对话框
- [ ] 选择时间后显示计算的时数
- [ ] 关闭对话框后表单重置
- [ ] 再次打开时数显示清空

### 10.2 数据刷新
- [ ] 提交申请后余额自动更新
- [ ] 提交申请后列表自动刷新
- [ ] 登记生活事件后可用假期选项自动更新

---

## 测试结果汇总

### 通过的测试：_______ / _______
### 失败的测试：
1. _______________________________________________
2. _______________________________________________
3. _______________________________________________

### 发现的问题：
1. _______________________________________________
2. _______________________________________________
3. _______________________________________________

---

## 测试建议

1. **按顺序测试**：从基础功能到复杂逻辑
2. **使用不同角色**：分别用男性和女性账号测试
3. **测试边界条件**：空值、最大值、最小值
4. **测试错误处理**：故意输入错误数据
5. **测试权限**：普通员工和管理员分别测试

---

## 快速测试脚本

如果需要快速测试后端 API，可以使用以下 curl 命令：

```bash
# 1. 测试余额查询
curl -X GET "https://www.horgoscpa.com/internal/api/v1/leaves/balances?year=2025" \
  --cookie "your-session-cookie"

# 2. 测试申请假期
curl -X POST "https://www.horgoscpa.com/internal/api/v1/leaves" \
  -H "Content-Type: application/json" \
  --cookie "your-session-cookie" \
  -d '{
    "leave_type": "annual",
    "start_date": "2025-11-01",
    "start_time": "09:00",
    "end_time": "11:00",
    "amount": 2
  }'

# 3. 测试登记生活事件
curl -X POST "https://www.horgoscpa.com/internal/api/v1/leaves/life-events" \
  -H "Content-Type: application/json" \
  --cookie "your-session-cookie" \
  -d '{
    "event_type": "marriage",
    "event_date": "2025-11-01",
    "notes": "结婚登记"
  }'
```

