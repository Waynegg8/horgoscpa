<!doctype html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ä»»å‹™ç¸½è¦½ï½œå…§éƒ¨ç³»çµ±</title>
    <link rel="stylesheet" href="/assets/css/common.css">
    <link rel="stylesheet" href="/assets/css/internal-system.css">
    <link rel="stylesheet" href="/assets/css/internal-components.css">
    <link rel="stylesheet" href="/assets/css/tasks-page.css">
    
    <!-- é¢„åŠ è½½ä¸ç¼“å­˜ç³»ç»Ÿ -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
    <script src="/assets/js/prerender.js"></script>
    <script src="/assets/js/page-prerender.js"></script>
    <script src="/assets/js/components/bootstrap.js"></script>
    
    <style>
        .month-tag {
            padding: 8px 16px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .month-tag:hover {
            border-color: #3b82f6;
        }
        
        .month-tag.selected {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .client-group {
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .client-header {
            padding: 16px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .client-header:hover {
            background: #f3f4f6;
        }
        
        .client-header.has-overdue {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }
        
        .service-group {
            border-bottom: 1px solid #e5e7eb;
        }
        
        .service-header {
            padding: 12px 16px;
            background: #fafafa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .service-header:hover {
            background: #f5f5f5;
        }
        
        .task-card {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.2s;
        }
        
        .task-card:last-child {
            border-bottom: none;
        }
        
        .task-card:hover {
            background: #fafafa;
        }
        
        .task-card.auto-generated {
            border-left: 4px solid #3b82f6;
            background: #f0f9ff;
        }
        
        .task-card.manual-created {
            border-left: 4px solid #10b981;
            background: #f0fdf4;
        }
        
        .task-card.overdue {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .status-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .status-button {
            padding: 4px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-button:hover {
            border-color: #3b82f6;
        }
        
        .status-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            z-index: 10;
            min-width: 120px;
            margin-top: 4px;
        }
        
        .status-menu.show {
            display: block;
        }
        
        .status-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        
        .status-menu-item:hover {
            background: #f3f4f6;
        }
        
        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 13px;
            color: #6b7280;
            margin-top: 8px;
        }
        
        .task-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .collapse-icon {
            transition: transform 0.2s;
        }
        
        .collapse-icon.expanded {
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <main class="internal-container" style="padding: 24px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
            <div>
                <h1 style="margin:0;font-size:28px;">ğŸ“Š ä»»å‹™ç¸½è¦½</h1>
                <p style="margin:8px 0 0 0;color:#6b7280;">æŒ‰å®¢æˆ¶å’Œæœå‹™æŸ¥çœ‹æ‰€æœ‰ä»»å‹™</p>
            </div>
            <div>
                <span style="color:#6b7280;font-size:14px;margin-right:12px;">ğŸ”„ æœ€å¾Œæ›´æ–°: <span id="lastUpdateTime">--</span></span>
                <button class="btn btn-secondary" onclick="loadTaskOverview()">ç«‹å³åˆ·æ–°</button>
            </div>
        </div>
        
        <!-- ç­›é€‰åŒºåŸŸ -->
        <div class="card" style="margin-bottom:20px;">
            <div class="card-body">
                <!-- æœˆä»½ç­›é€‰ -->
                <div style="margin-bottom:16px;">
                    <label style="display:block;margin-bottom:8px;font-weight:600;">ğŸ“… æœå‹™æœˆä»½</label>
                    <div id="monthSelector" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px;">
                        <!-- åŠ¨æ€ç”Ÿæˆæœˆä»½æ ‡ç­¾ -->
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-sm btn-secondary" onclick="selectQuickMonths('current')">æœ¬æœˆ</button>
                        <button class="btn btn-sm btn-secondary" onclick="selectQuickMonths('last')">ä¸Šæœˆ</button>
                        <button class="btn btn-sm btn-secondary" onclick="selectQuickMonths('recent3')">æœ€è¿‘3å€‹æœˆ</button>
                        <button class="btn btn-sm btn-secondary" onclick="selectQuickMonths('currentAndLast')">æœ¬æœˆ+ä¸Šæœˆ</button>
                        <button class="btn btn-sm btn-secondary" onclick="selectQuickMonths('clear')">æ¸…é™¤</button>
                    </div>
                </div>
                
                <!-- æœç´¢ + çŠ¶æ€ + æ¥æº -->
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px;">
                    <div>
                        <label style="display:block;margin-bottom:8px;font-weight:600;">ğŸ” æœç´¢å®¢æˆ¶</label>
                        <input type="text" id="taskOverviewSearch" class="form-control" placeholder="è¼¸å…¥å®¢æˆ¶åç¨±...">
                    </div>
                    
                    <div>
                        <label style="display:block;margin-bottom:8px;font-weight:600;">ğŸ“Š ä»»å‹™ç‹€æ…‹</label>
                        <div id="statusCheckboxes" style="display:flex;flex-wrap:wrap;gap:8px;">
                            <label style="cursor:pointer;"><input type="checkbox" class="status-filter" value="pending" checked> å¾…è™•ç†</label>
                            <label style="cursor:pointer;"><input type="checkbox" class="status-filter" value="in_progress" checked> é€²è¡Œä¸­</label>
                            <label style="cursor:pointer;"><input type="checkbox" class="status-filter" value="completed"> å·²å®Œæˆ</label>
                            <label style="cursor:pointer;"><input type="checkbox" class="status-filter" value="cancelled"> å·²å–æ¶ˆ</label>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:8px;">
                            <button class="btn btn-sm btn-secondary" onclick="quickSelectStatus('unfinished')">æœªå®Œæˆçš„</button>
                            <button class="btn btn-sm btn-secondary" onclick="quickSelectStatus('all')">å…¨éƒ¨</button>
                            <button class="btn btn-sm btn-secondary" onclick="quickSelectStatus('overdue')">åªçœ‹é€¾æœŸ</button>
                        </div>
                    </div>
                    
                    <div>
                        <label style="display:block;margin-bottom:8px;font-weight:600;">ğŸ·ï¸ ä»»å‹™ä¾†æº</label>
                        <div style="display:flex;gap:12px;">
                            <label style="cursor:pointer;"><input type="checkbox" class="source-filter" value="auto" checked> è‡ªå‹•ç”Ÿæˆ</label>
                            <label style="cursor:pointer;"><input type="checkbox" class="source-filter" value="manual" checked> æ‰‹å‹•å»ºç«‹</label>
                        </div>
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-primary" onclick="applyFiltersAndLoad()">ğŸ”„ å¥—ç”¨ç¯©é¸</button>
                        <button class="btn btn-secondary" onclick="expandAllClients(true)">å…¨éƒ¨å±•é–‹</button>
                        <button class="btn btn-secondary" onclick="expandAllClients(false)">å…¨éƒ¨æŠ˜ç–Š</button>
                        <button class="btn btn-secondary" onclick="expandOnlyOverdue()">åªå±•é–‹é€¾æœŸ</button>
                    </div>
                    <div>
                        <label style="cursor:pointer;">
                            <input type="checkbox" id="enableBatchMode" onchange="toggleBatchMode()"> æ‰¹é‡æ“ä½œæ¨¡å¼
                        </label>
                    </div>
                </div>
                
                <!-- æ‰¹é‡æ“ä½œæ  -->
                <div id="batchActionsBar" style="display:none;margin-top:16px;padding:12px;background:#f0f9ff;border-radius:6px;border:1px solid #bfdbfe;">
                    <span style="margin-right:12px;font-weight:600;">å·²é¸æ“‡ <span id="batchCount">0</span> å€‹ä»»å‹™</span>
                    <button class="btn btn-sm btn-primary" onclick="batchChangeStatus()">æ‰¹é‡è®Šæ›´ç‹€æ…‹</button>
                    <button class="btn btn-sm btn-primary" onclick="batchChangeDueDate()">æ‰¹é‡èª¿æ•´åˆ°æœŸæ—¥</button>
                    <button class="btn btn-sm btn-primary" onclick="batchChangeAssignee()">æ‰¹é‡åˆ†é…è² è²¬äºº</button>
                    <button class="btn btn-sm btn-secondary" onclick="clearBatchSelection()">æ¸…é™¤é¸æ“‡</button>
                </div>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡æ‘˜è¦ -->
        <div class="card" style="margin-bottom:20px;">
            <div class="card-body">
                <div id="taskOverviewStats" style="display:flex;gap:24px;flex-wrap:wrap;font-size:14px;">
                    <div>ğŸ“Š å…± <strong id="stat-total">0</strong> å€‹ä»»å‹™</div>
                    <div>â° æœªå®Œæˆ: <strong id="stat-unfinished">0</strong></div>
                    <div>âœ… å·²å®Œæˆ: <strong id="stat-completed">0</strong></div>
                    <div>ğŸ”´ é€¾æœŸ: <strong id="stat-overdue" style="color:#ef4444;">0</strong></div>
                    <div>ğŸ¤– è‡ªå‹•ç”Ÿæˆ: <strong id="stat-auto">0</strong></div>
                    <div>ğŸ‘¤ æ‰‹å‹•å»ºç«‹: <strong id="stat-manual">0</strong></div>
                    <div id="stat-months" style="color:#6b7280;"></div>
                </div>
            </div>
        </div>
        
        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div id="taskOverviewList">
            <div style="text-align:center;padding:60px 20px;color:#6b7280;">
                <div style="font-size:48px;margin-bottom:16px;">ğŸ“‹</div>
                <div style="font-size:16px;margin-bottom:8px;">è«‹é¸æ“‡ç¯©é¸æ¢ä»¶</div>
                <div style="font-size:14px;">é»æ“Šã€Œå¥—ç”¨ç¯©é¸ã€è¼‰å…¥ä»»å‹™æ•¸æ“š</div>
            </div>
        </div>
    </main>
    
    <script>
        // å…¨å±€å˜é‡
        let allTasksData = [];
        let selectedMonths = [];
        let batchSelectedTasks = [];
        const FILTER_STORAGE_KEY = 'taskOverview_filters';
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // åˆå§‹åŒ–æœˆä»½é€‰æ‹©å™¨
            initMonthSelector();
            
            // ä»localStorageæ¢å¤ç­›é€‰æ¡ä»¶
            restoreFilters();
            
            // å¦‚æœæœ‰ä¿å­˜çš„ç­›é€‰æ¡ä»¶ï¼Œè‡ªåŠ¨åŠ è½½
            if (selectedMonths.length > 0) {
                loadTaskOverview();
            }
        });
        
        // åˆå§‹åŒ–æœˆä»½é€‰æ‹©å™¨ï¼ˆåªæ˜¾ç¤ºæœ¬æœˆå’Œä¸Šæœˆï¼‰
        function initMonthSelector() {
            const container = document.getElementById('monthSelector');
            const now = new Date();
            
            // æœ¬æœˆ
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const currentText = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ`;
            
            // ä¸Šæœˆ
            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonth = `${lastMonthDate.getFullYear()}-${String(lastMonthDate.getMonth() + 1).padStart(2, '0')}`;
            const lastText = `${lastMonthDate.getFullYear()}å¹´${lastMonthDate.getMonth() + 1}æœˆ`;
            
            // æ·»åŠ æœˆä»½æŒ‰é’®å’Œè¾“å…¥æ¡†
            container.innerHTML = `
                <button class="month-tag" data-month="${lastMonth}" onclick="toggleMonth('${lastMonth}')">
                    ${lastText}
                </button>
                <button class="month-tag" data-month="${currentMonth}" onclick="toggleMonth('${currentMonth}')">
                    ${currentText}
                </button>
                <input type="month" id="customMonth" class="form-control" style="width:160px;" 
                       onchange="addCustomMonth(this.value)" placeholder="é¸æ“‡å…¶ä»–æœˆä»½">
            `;
        }
        
        // æ·»åŠ è‡ªå®šä¹‰æœˆä»½
        function addCustomMonth(yearMonth) {
            if (!yearMonth) return;
            
            // å¦‚æœè¯¥æœˆä»½æŒ‰é’®ä¸å­˜åœ¨ï¼Œæ·»åŠ å®ƒ
            if (!document.querySelector(`[data-month="${yearMonth}"]`)) {
                const [year, month] = yearMonth.split('-');
                const displayText = `${year}å¹´${parseInt(month)}æœˆ`;
                
                const btn = document.createElement('button');
                btn.className = 'month-tag selected';
                btn.dataset.month = yearMonth;
                btn.onclick = () => toggleMonth(yearMonth);
                btn.textContent = displayText;
                
                const input = document.getElementById('customMonth');
                input.parentNode.insertBefore(btn, input);
                
                selectedMonths.push(yearMonth);
            } else {
                // å¦‚æœå·²å­˜åœ¨ï¼Œç›´æ¥é€‰ä¸­
                toggleMonth(yearMonth);
            }
            
            document.getElementById('customMonth').value = '';
            saveFilters();
        }
        
        // åˆ‡æ¢æœˆä»½é€‰æ‹©
        function toggleMonth(month) {
            const btn = document.querySelector(`[data-month="${month}"]`);
            if (selectedMonths.includes(month)) {
                selectedMonths = selectedMonths.filter(m => m !== month);
                btn.classList.remove('selected');
            } else {
                selectedMonths.push(month);
                btn.classList.add('selected');
            }
            saveFilters();
        }
        
        // å¿«é€Ÿé€‰æ‹©æœˆä»½
        function selectQuickMonths(type) {
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const lastMonth = `${now.getFullYear()}-${String(now.getMonth()).padStart(2, '0')}`;
            
            // æ¸…é™¤æ‰€æœ‰é€‰æ‹©
            document.querySelectorAll('.month-tag').forEach(btn => btn.classList.remove('selected'));
            selectedMonths = [];
            
            if (type === 'current') {
                selectedMonths = [currentMonth];
            } else if (type === 'last') {
                selectedMonths = [lastMonth];
            } else if (type === 'currentAndLast') {
                selectedMonths = [lastMonth, currentMonth];
            } else if (type === 'recent3') {
                for (let i = 0; i < 3; i++) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    selectedMonths.push(month);
                }
            } else if (type === 'clear') {
                // å·²æ¸…é™¤
            }
            
            // æ›´æ–°UI
            selectedMonths.forEach(month => {
                const btn = document.querySelector(`[data-month="${month}"]`);
                if (btn) btn.classList.add('selected');
            });
            
            saveFilters();
        }
        
        // å¿«é€Ÿé€‰æ‹©çŠ¶æ€
        function quickSelectStatus(type) {
            const checkboxes = document.querySelectorAll('.status-filter');
            
            if (type === 'unfinished') {
                checkboxes.forEach(cb => {
                    cb.checked = cb.value === 'pending' || cb.value === 'in_progress';
                });
            } else if (type === 'all') {
                checkboxes.forEach(cb => cb.checked = true);
            } else if (type === 'overdue') {
                // è¿™ä¸ªç”±åç«¯ç­›é€‰
                checkboxes.forEach(cb => {
                    cb.checked = cb.value === 'pending' || cb.value === 'in_progress';
                });
            }
            
            saveFilters();
        }
        
        // å¥—ç”¨ç­›é€‰å¹¶åŠ è½½
        function applyFiltersAndLoad() {
            if (selectedMonths.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æœˆä»½');
                return;
            }
            
            saveFilters();
            loadTaskOverview();
        }
        
        // åŠ è½½ä»»åŠ¡æ€»è§ˆ
        async function loadTaskOverview() {
            const listContainer = document.getElementById('taskOverviewList');
            listContainer.innerHTML = '<div style="text-align:center;padding:40px;"><div class="loading-spinner"></div><div style="margin-top:12px;color:#6b7280;">è¼‰å…¥ä¸­...</div></div>';
            
            try {
                // è·å–ç­›é€‰æ¡ä»¶
                const selectedStatuses = Array.from(document.querySelectorAll('.status-filter:checked')).map(cb => cb.value);
                const selectedSources = Array.from(document.querySelectorAll('.source-filter:checked')).map(cb => cb.value);
                const searchText = document.getElementById('taskOverviewSearch').value.trim();
                
                // æ„å»ºæŸ¥è¯¢å‚æ•°
                const params = new URLSearchParams();
                selectedMonths.forEach(m => params.append('months', m));
                selectedStatuses.forEach(s => params.append('statuses', s));
                selectedSources.forEach(s => params.append('sources', s));
                if (searchText) params.append('search', searchText);
                
                // è°ƒç”¨API
                const res = await fetch(`/internal/api/v1/tasks/overview?${params.toString()}`, {
                    credentials: 'include'
                });
                
                const json = await res.json();
                
                if (!json.ok) {
                    throw new Error(json.message || 'è¼‰å…¥å¤±æ•—');
                }
                
                allTasksData = json.data || [];
                
                // æ›´æ–°ç»Ÿè®¡
                updateStats(allTasksData);
                
                // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
                renderTaskList(allTasksData);
                
                // æ›´æ–°æ—¶é—´
                document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString('zh-TW');
                
            } catch (err) {
                console.error('è½½å…¥ä»»åŠ¡æ€»è§ˆå¤±è´¥:', err);
                listContainer.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#ef4444;">
                        <div style="font-size:48px;margin-bottom:16px;">âŒ</div>
                        <div style="font-size:16px;margin-bottom:8px;">è¼‰å…¥å¤±æ•—</div>
                        <div style="font-size:14px;">${err.message}</div>
                    </div>
                `;
            }
        }
        
        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTaskList(data) {
            const listContainer = document.getElementById('taskOverviewList');
            
            if (!data || data.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align:center;padding:60px 20px;color:#6b7280;">
                        <div style="font-size:48px;margin-bottom:16px;">ğŸ“­</div>
                        <div style="font-size:16px;margin-bottom:8px;">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ä»»å‹™</div>
                        <div style="font-size:14px;">è«‹èª¿æ•´ç¯©é¸æ¢ä»¶å¾Œé‡è©¦</div>
                    </div>
                `;
                return;
            }
            
            // æŒ‰å®¢æˆ·åˆ†ç»„
            const groupedByClient = {};
            data.forEach(task => {
                const clientKey = task.client_id;
                if (!groupedByClient[clientKey]) {
                    groupedByClient[clientKey] = {
                        client_id: task.client_id,
                        company_name: task.company_name,
                        tax_id: task.client_tax_id,
                        services: {},
                        hasOverdue: false
                    };
                }
                
                // æŒ‰æœåŠ¡åˆ†ç»„
                const serviceKey = `${task.service_name || 'æœªåˆ†é¡'}_${task.service_month}`;
                if (!groupedByClient[clientKey].services[serviceKey]) {
                    groupedByClient[clientKey].services[serviceKey] = {
                        service_name: task.service_name || 'æœªåˆ†é¡',
                        service_month: task.service_month,
                        tasks: []
                    };
                }
                
                groupedByClient[clientKey].services[serviceKey].tasks.push(task);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é€¾æœŸ
                if (task.is_overdue) {
                    groupedByClient[clientKey].hasOverdue = true;
                }
            });
            
            // æ¸²æŸ“HTML
            const html = Object.values(groupedByClient).map(client => {
                const serviceCount = Object.keys(client.services).length;
                const taskCount = Object.values(client.services).reduce((sum, svc) => sum + svc.tasks.length, 0);
                const unfinishedCount = Object.values(client.services).reduce((sum, svc) => 
                    sum + svc.tasks.filter(t => t.status === 'pending' || t.status === 'in_progress').length, 0
                );
                const overdueCount = Object.values(client.services).reduce((sum, svc) => 
                    sum + svc.tasks.filter(t => t.is_overdue).length, 0
                );
                
                const batchCheckbox = document.getElementById('enableBatchMode')?.checked ? 
                    `<input type="checkbox" class="client-batch-checkbox" value="${client.client_id}" 
                            onchange="toggleClientBatch('${client.client_id}')" onclick="event.stopPropagation()" 
                            style="margin-right:8px;width:18px;height:18px;">` : '';
                
                return `
                    <div class="client-group" id="client-${client.client_id}">
                        <div class="client-header ${client.hasOverdue ? 'has-overdue' : ''}" onclick="toggleClient('${client.client_id}')">
                            <div style="display:flex;align-items:center;">
                                ${batchCheckbox}
                                <span class="collapse-icon" id="icon-${client.client_id}">â–¶</span>
                                <strong style="font-size:16px;margin-left:8px;">ğŸ¢ ${client.company_name}</strong>
                                <span style="color:#6b7280;font-size:13px;margin-left:12px;">${client.tax_id || ''}</span>
                                <span style="margin-left:16px;font-size:14px;">
                                    ${taskCount} å€‹ä»»å‹™ | ${unfinishedCount} æœªå®Œæˆ
                                    ${overdueCount > 0 ? `| <span style="color:#ef4444;font-weight:600;">âš ï¸ ${overdueCount} é€¾æœŸ</span>` : ''}
                                </span>
                            </div>
                            <div>
                                ${client.hasOverdue ? '<button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); viewOverdueTasks(\''+client.client_id+'\')">æŸ¥çœ‹é€¾æœŸ</button>' : ''}
                            </div>
                        </div>
                        <div id="services-${client.client_id}" style="display:none;">
                            ${Object.values(client.services).map(service => renderService(client.client_id, service)).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = html || '<div style="text-align:center;padding:40px;">æš«ç„¡æ•¸æ“š</div>';
        }
        
        // æ¸²æŸ“æœåŠ¡ç»„
        function renderService(clientId, service) {
            const taskCount = service.tasks.length;
            const completedCount = service.tasks.filter(t => t.status === 'completed').length;
            const inProgressCount = service.tasks.filter(t => t.status === 'in_progress').length;
            
            const serviceKey = `${clientId}-${service.service_name}-${service.service_month}`;
            const batchCheckbox = document.getElementById('enableBatchMode')?.checked ? 
                `<input type="checkbox" class="service-batch-checkbox" value="${serviceKey}" 
                        data-client-id="${clientId}"
                        data-service-name="${service.service_name}"
                        data-service-month="${service.service_month}"
                        onchange="toggleServiceBatch('${clientId}', '${service.service_name}', '${service.service_month}')" 
                        onclick="event.stopPropagation()" 
                        style="margin-right:8px;width:18px;height:18px;">` : '';
            
            return `
                <div class="service-group">
                    <div class="service-header" onclick="toggleService('${clientId}', '${service.service_name}_${service.service_month}')">
                        <div style="display:flex;align-items:center;">
                            ${batchCheckbox}
                            <span class="collapse-icon" id="icon-service-${clientId}-${service.service_name}_${service.service_month}">â–¶</span>
                            <strong style="margin-left:8px;">ğŸ“¦ ${service.service_name} Â· ${service.service_month}</strong>
                            <span style="color:#6b7280;font-size:13px;margin-left:12px;">
                                ${taskCount} å€‹ä»»å‹™: ${completedCount} å·²å®Œæˆ, ${inProgressCount} é€²è¡Œä¸­
                            </span>
                        </div>
                    </div>
                    <div id="tasks-${clientId}-${service.service_name}_${service.service_month}" style="display:none;">
                        ${service.tasks.map(task => renderTaskCard(task)).join('')}
                    </div>
                </div>
            `;
        }
        
        // æ¸²æŸ“ä»»åŠ¡å¡ç‰‡
        function renderTaskCard(task) {
            const isAuto = task.component_id ? true : false;
            const cardClass = task.is_overdue ? 'overdue' : (isAuto ? 'auto-generated' : 'manual-created');
            const statusIcon = {
                'pending': 'â°',
                'in_progress': 'ğŸŸ¡',
                'completed': 'âœ…',
                'cancelled': 'âŒ'
            }[task.status] || 'âšª';
            
            const statusText = {
                'pending': 'å¾…è™•ç†',
                'in_progress': 'é€²è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'cancelled': 'å·²å–æ¶ˆ'
            }[task.status] || task.status;
            
            const isTaskSelected = batchSelectedTasks.includes(task.task_id);
            const batchCheckbox = document.getElementById('enableBatchMode')?.checked ? 
                `<input type="checkbox" class="task-batch-checkbox" value="${task.task_id}" 
                        ${isTaskSelected ? 'checked' : ''} 
                        onchange="toggleTaskBatch(${task.task_id})" 
                        onclick="event.stopPropagation()" 
                        style="margin-right:8px;width:16px;height:16px;">` : '';
            
            return `
                <div class="task-card ${cardClass}" data-task-id="${task.task_id}">
                    <div style="display:flex;justify-content:space-between;align-items:start;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                                ${batchCheckbox}
                                <div class="status-dropdown">
                                    <button class="status-button" onclick="toggleStatusMenu(${task.task_id}, event)">
                                        ${statusIcon} ${statusText} â–¼
                                    </button>
                                    <div class="status-menu" id="status-menu-${task.task_id}">
                                        <div class="status-menu-item" onclick="changeTaskStatus(${task.task_id}, 'pending', event)">â° å¾…è™•ç†</div>
                                        <div class="status-menu-item" onclick="changeTaskStatus(${task.task_id}, 'in_progress', event)">ğŸŸ¡ é€²è¡Œä¸­</div>
                                        <div class="status-menu-item" onclick="changeTaskStatus(${task.task_id}, 'completed', event)">âœ… å·²å®Œæˆ</div>
                                        <div class="status-menu-item" onclick="changeTaskStatus(${task.task_id}, 'cancelled', event)">âŒ å·²å–æ¶ˆ</div>
                                    </div>
                                </div>
                                <strong style="font-size:15px;">${task.task_name}</strong>
                                <span style="font-size:12px;padding:2px 8px;background:#f3f4f6;border-radius:4px;">
                                    ${isAuto ? 'ğŸ¤– è‡ªå‹•ç”Ÿæˆ' : 'ğŸ‘¤ æ‰‹å‹•å»ºç«‹'}
                                </span>
                                ${task.is_overdue ? '<span style="color:#ef4444;font-weight:600;font-size:13px;">âš ï¸ å·²é€¾æœŸ</span>' : ''}
                            </div>
                            
                            <div class="task-meta">
                                <div class="task-meta-item">ğŸ‘¤ è² è²¬äºº: <strong>${task.assignee_name || 'æœªæŒ‡æ´¾'}</strong></div>
                                <div class="task-meta-item">ğŸ“… åˆ°æœŸ: <strong>${task.due_date || '-'}</strong></div>
                                ${task.is_overdue ? `<div class="task-meta-item" style="color:#ef4444;">â° é€¾æœŸ ${calculateOverdueDays(task.due_date)} å¤©</div>` : ''}
                                ${(task.total_stages && task.total_stages > 0) ? `<div class="task-meta-item">ğŸ“Š é€²åº¦: <strong>${task.completed_stages || 0}/${task.total_stages} éšæ®µ</strong></div>` : ''}
                                <div class="task-meta-item">ğŸ†” ${task.task_id}</div>
                            </div>
                            
                            ${task.notes ? `<div style="margin-top:8px;font-size:13px;color:#6b7280;">ğŸ“ ${task.notes}</div>` : ''}
                            
                            <div class="task-actions">
                                <a href="/internal/task-detail?id=${task.task_id}" class="btn btn-sm btn-primary">æŸ¥çœ‹è©³æƒ…</a>
                                <button class="btn btn-sm btn-secondary" onclick="adjustDueDate(${task.task_id})">èª¿æ•´åˆ°æœŸæ—¥</button>
                                ${task.is_overdue ? `<button class="btn btn-sm btn-danger" onclick="recordOverdueReason(${task.task_id})">è¨˜éŒ„é€¾æœŸåŸå› </button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // æ›´æ–°ç»Ÿè®¡
        function updateStats(tasks) {
            const total = tasks.length;
            const unfinished = tasks.filter(t => t.status === 'pending' || t.status === 'in_progress').length;
            const completed = tasks.filter(t => t.status === 'completed').length;
            const overdue = tasks.filter(t => t.is_overdue).length;
            const auto = tasks.filter(t => t.component_id).length;
            const manual = total - auto;
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-unfinished').textContent = unfinished;
            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-overdue').textContent = overdue;
            document.getElementById('stat-auto').textContent = auto;
            document.getElementById('stat-manual').textContent = manual;
            document.getElementById('stat-months').textContent = `é¸ä¸­æœˆä»½: ${selectedMonths.join(', ')}`;
        }
        
        // æŠ˜å /å±•å¼€æ§åˆ¶
        function toggleClient(clientId) {
            const content = document.getElementById(`services-${clientId}`);
            const icon = document.getElementById(`icon-${clientId}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.add('expanded');
            } else {
                content.style.display = 'none';
                icon.classList.remove('expanded');
            }
        }
        
        function toggleService(clientId, serviceKey) {
            const content = document.getElementById(`tasks-${clientId}-${serviceKey}`);
            const icon = document.getElementById(`icon-service-${clientId}-${serviceKey}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.add('expanded');
            } else {
                content.style.display = 'none';
                icon.classList.remove('expanded');
            }
        }
        
        function expandAllClients(expand) {
            document.querySelectorAll('.client-group').forEach(group => {
                const clientId = group.id.replace('client-', '');
                const content = document.getElementById(`services-${clientId}`);
                const icon = document.getElementById(`icon-${clientId}`);
                
                if (expand) {
                    content.style.display = 'block';
                    icon.classList.add('expanded');
                } else {
                    content.style.display = 'none';
                    icon.classList.remove('expanded');
                }
            });
        }
        
        function expandOnlyOverdue() {
            // å…ˆå…¨éƒ¨æŠ˜å 
            expandAllClients(false);
            
            // åªå±•å¼€æœ‰é€¾æœŸä»»åŠ¡çš„å®¢æˆ·
            document.querySelectorAll('.client-header.has-overdue').forEach(header => {
                const clientId = header.parentElement.id.replace('client-', '');
                const content = document.getElementById(`services-${clientId}`);
                const icon = document.getElementById(`icon-${clientId}`);
                content.style.display = 'block';
                icon.classList.add('expanded');
            });
        }
        
        // çŠ¶æ€ä¿®æ”¹
        function toggleStatusMenu(taskId, event) {
            event.stopPropagation();
            const menu = document.getElementById(`status-menu-${taskId}`);
            
            // å…³é—­æ‰€æœ‰å…¶ä»–èœå•
            document.querySelectorAll('.status-menu').forEach(m => {
                if (m.id !== `status-menu-${taskId}`) {
                    m.classList.remove('show');
                }
            });
            
            menu.classList.toggle('show');
        }
        
        async function changeTaskStatus(taskId, newStatus, event) {
            event.stopPropagation();
            
            try {
                // å¦‚æœæ”¹ä¸ºå·²å®Œæˆï¼Œä½¿ç”¨æ—¥æœŸé€‰æ‹©å™¨
                let completedDate = null;
                if (newStatus === 'completed') {
                    const today = new Date().toISOString().split('T')[0];
                    completedDate = today; // é»˜è®¤ä½¿ç”¨ä»Šå¤©
                }
                
                const res = await fetch(`/internal/api/v1/tasks/${taskId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        status: newStatus,
                        completed_date: completedDate
                    })
                });
                
                const json = await res.json();
                
                if (!json.ok) {
                    throw new Error(json.message || 'æ›´æ–°å¤±æ•—');
                }
                
                // ç›´æ¥æ›´æ–°é¡µé¢ä¸Šçš„çŠ¶æ€ï¼Œä¸é‡æ–°åŠ è½½æ•´ä¸ªåˆ—è¡¨
                updateTaskStatusInUI(taskId, newStatus);
                
            } catch (err) {
                console.error('ä¿®æ”¹çŠ¶æ€å¤±è´¥:', err);
                alert('âŒ ä¿®æ”¹å¤±æ•—: ' + err.message);
            }
            
            // å…³é—­èœå•
            document.querySelectorAll('.status-menu').forEach(m => m.classList.remove('show'));
        }
        
        // æ›´æ–°UIä¸­çš„ä»»åŠ¡çŠ¶æ€ï¼ˆé¿å…é‡æ–°åŠ è½½ï¼‰
        function updateTaskStatusInUI(taskId, newStatus) {
            const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
            if (!taskCard) return;
            
            const statusIcon = {
                'pending': 'â°',
                'in_progress': 'ğŸŸ¡',
                'completed': 'âœ…',
                'cancelled': 'âŒ'
            }[newStatus] || 'âšª';
            
            const statusText = {
                'pending': 'å¾…è™•ç†',
                'in_progress': 'é€²è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'cancelled': 'å·²å–æ¶ˆ'
            }[newStatus] || newStatus;
            
            const statusButton = taskCard.querySelector('.status-button');
            if (statusButton) {
                statusButton.innerHTML = `${statusIcon} ${statusText} â–¼`;
            }
            
            // æ›´æ–°ç»Ÿè®¡
            loadTaskOverview();
        }
        
        // è°ƒæ•´åˆ°æœŸæ—¥
        async function adjustDueDate(taskId) {
            const newDate = prompt('è«‹è¼¸å…¥æ–°çš„åˆ°æœŸæ—¥ï¼ˆYYYY-MM-DDï¼‰');
            if (!newDate) return;
            
            const reason = prompt('è«‹èªªæ˜èª¿æ•´åŸå› ');
            if (!reason) {
                alert('è«‹è¼¸å…¥èª¿æ•´åŸå› ');
                return;
            }
            
            try {
                const res = await fetch(`/internal/api/v1/tasks/${taskId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        due_date: newDate,
                        adjustment_reason: reason
                    })
                });
                
                const json = await res.json();
                
                if (!json.ok) {
                    throw new Error(json.message || 'èª¿æ•´å¤±æ•—');
                }
                
                alert('âœ… åˆ°æœŸæ—¥å·²èª¿æ•´');
                loadTaskOverview();
                
            } catch (err) {
                console.error('è°ƒæ•´åˆ°æœŸæ—¥å¤±è´¥:', err);
                alert('âŒ èª¿æ•´å¤±æ•—: ' + err.message);
            }
        }
        
        // è®°å½•é€¾æœŸåŸå› 
        async function recordOverdueReason(taskId) {
            const reason = prompt('è«‹èªªæ˜æ­¤ä»»å‹™é€¾æœŸçš„åŸå› ');
            if (!reason) return;
            
            try {
                const res = await fetch(`/internal/api/v1/tasks/${taskId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        overdue_reason: reason
                    })
                });
                
                const json = await res.json();
                
                if (!json.ok) {
                    throw new Error(json.message || 'è¨˜éŒ„å¤±æ•—');
                }
                
                alert('âœ… é€¾æœŸåŸå› å·²è¨˜éŒ„');
                
            } catch (err) {
                console.error('è®°å½•é€¾æœŸåŸå› å¤±è´¥:', err);
                alert('âŒ è¨˜éŒ„å¤±æ•—: ' + err.message);
            }
        }
        
        // æ‰¹é‡æ“ä½œ
        function toggleBatchMode() {
            const enabled = document.getElementById('enableBatchMode').checked;
            document.getElementById('batchActionsBar').style.display = enabled ? 'block' : 'none';
            
            if (!enabled) {
                clearBatchSelection();
            } else {
                // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºå¤é€‰æ¡†
                renderTaskList(allTasksData);
            }
        }
        
        // åˆ‡æ¢å•ä¸ªä»»åŠ¡çš„æ‰¹é‡é€‰æ‹©
        function toggleTaskBatch(taskId) {
            const taskCheckbox = document.querySelector(`.task-batch-checkbox[value="${taskId}"]`);
            const isChecked = taskCheckbox.checked;
            
            if (isChecked) {
                if (!batchSelectedTasks.includes(taskId)) {
                    batchSelectedTasks.push(taskId);
                }
            } else {
                batchSelectedTasks = batchSelectedTasks.filter(id => id !== taskId);
            }
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æœåŠ¡/å®¢æˆ·çº§åˆ«çš„å¤é€‰æ¡†çŠ¶æ€
            const task = allTasksData.find(t => t.task_id === taskId);
            if (task) {
                // æ£€æŸ¥åŒä¸€æœåŠ¡çš„æ‰€æœ‰ä»»åŠ¡æ˜¯å¦éƒ½è¢«é€‰ä¸­
                const serviceTasks = allTasksData.filter(t => 
                    t.client_id === task.client_id && 
                    t.service_name === task.service_name && 
                    t.service_month === task.service_month
                );
                const allServiceTasksSelected = serviceTasks.every(t => batchSelectedTasks.includes(t.task_id));
                const serviceKey = `${task.client_id}-${task.service_name}-${task.service_month}`;
                const serviceCheckbox = document.querySelector(`.service-batch-checkbox[value="${serviceKey}"]`);
                if (serviceCheckbox) {
                    serviceCheckbox.checked = allServiceTasksSelected;
                }
                
                // æ£€æŸ¥åŒä¸€å®¢æˆ·çš„æ‰€æœ‰ä»»åŠ¡æ˜¯å¦éƒ½è¢«é€‰ä¸­
                const clientTasks = allTasksData.filter(t => t.client_id === task.client_id);
                const allClientTasksSelected = clientTasks.every(t => batchSelectedTasks.includes(t.task_id));
                const clientCheckbox = document.querySelector(`.client-batch-checkbox[value="${task.client_id}"]`);
                if (clientCheckbox) {
                    clientCheckbox.checked = allClientTasksSelected;
                }
            }
            
            updateBatchCount();
        }
        
        // åˆ‡æ¢æœåŠ¡çº§åˆ«çš„æ‰¹é‡é€‰æ‹©ï¼ˆé€‰ä¸­è¯¥æœåŠ¡çš„æ‰€æœ‰ä»»åŠ¡ï¼‰
        function toggleServiceBatch(clientId, serviceName, serviceMonth) {
            const serviceKey = `${clientId}-${serviceName}-${serviceMonth}`;
            const serviceCheckbox = document.querySelector(`.service-batch-checkbox[value="${serviceKey}"]`);
            const isChecked = serviceCheckbox.checked;
            
            // è·å–è¯¥æœåŠ¡çš„æ‰€æœ‰ä»»åŠ¡ID
            const serviceTasks = allTasksData.filter(task => 
                task.client_id === clientId && 
                task.service_name === serviceName && 
                task.service_month === serviceMonth
            );
            
            // æ›´æ–°æ‰¹é‡é€‰æ‹©åˆ—è¡¨
            serviceTasks.forEach(task => {
                if (isChecked) {
                    if (!batchSelectedTasks.includes(task.task_id)) {
                        batchSelectedTasks.push(task.task_id);
                    }
                } else {
                    batchSelectedTasks = batchSelectedTasks.filter(id => id !== task.task_id);
                }
            });
            
            // æ›´æ–°ä»»åŠ¡å¤é€‰æ¡†çŠ¶æ€ï¼ˆå¦‚æœä»»åŠ¡å¯è§ï¼‰
            serviceTasks.forEach(task => {
                const taskCheckbox = document.querySelector(`.task-batch-checkbox[value="${task.task_id}"]`);
                if (taskCheckbox) {
                    taskCheckbox.checked = isChecked;
                }
            });
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°å®¢æˆ·çº§åˆ«çš„å¤é€‰æ¡†çŠ¶æ€
            const clientTasks = allTasksData.filter(t => t.client_id === clientId);
            const allClientTasksSelected = clientTasks.every(t => batchSelectedTasks.includes(t.task_id));
            const clientCheckbox = document.querySelector(`.client-batch-checkbox[value="${clientId}"]`);
            if (clientCheckbox) {
                clientCheckbox.checked = allClientTasksSelected;
            }
            
            updateBatchCount();
        }
        
        // åˆ‡æ¢å®¢æˆ·çº§åˆ«çš„æ‰¹é‡é€‰æ‹©ï¼ˆé€‰ä¸­å®¢æˆ·çš„æ‰€æœ‰ä»»åŠ¡ï¼‰
        function toggleClientBatch(clientId) {
            const clientCheckbox = document.querySelector(`.client-batch-checkbox[value="${clientId}"]`);
            const isChecked = clientCheckbox.checked;
            
            // è·å–è¯¥å®¢æˆ·çš„æ‰€æœ‰ä»»åŠ¡ID
            const clientTasks = allTasksData.filter(task => task.client_id === clientId);
            
            // æ›´æ–°æ‰¹é‡é€‰æ‹©åˆ—è¡¨
            clientTasks.forEach(task => {
                if (isChecked) {
                    if (!batchSelectedTasks.includes(task.task_id)) {
                        batchSelectedTasks.push(task.task_id);
                    }
                } else {
                    batchSelectedTasks = batchSelectedTasks.filter(id => id !== task.task_id);
                }
            });
            
            // æ›´æ–°ä»»åŠ¡å¤é€‰æ¡†çŠ¶æ€ï¼ˆå¦‚æœä»»åŠ¡å¯è§ï¼‰
            clientTasks.forEach(task => {
                const taskCheckbox = document.querySelector(`.task-batch-checkbox[value="${task.task_id}"]`);
                if (taskCheckbox) {
                    taskCheckbox.checked = isChecked;
                }
            });
            
            // åŒæ—¶æ›´æ–°æœåŠ¡å¤é€‰æ¡†çŠ¶æ€
            const clientServices = {};
            clientTasks.forEach(task => {
                const serviceKey = `${task.client_id}-${task.service_name}-${task.service_month}`;
                if (!clientServices[serviceKey]) {
                    clientServices[serviceKey] = [];
                }
                clientServices[serviceKey].push(task.task_id);
            });
            
            Object.keys(clientServices).forEach(serviceKey => {
                const serviceCheckbox = document.querySelector(`.service-batch-checkbox[value="${serviceKey}"]`);
                if (serviceCheckbox) {
                    serviceCheckbox.checked = isChecked;
                }
            });
            
            updateBatchCount();
        }
        
        function updateBatchCount() {
            document.getElementById('batchCount').textContent = batchSelectedTasks.length;
        }
        
        function clearBatchSelection() {
            document.querySelectorAll('.task-batch-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.service-batch-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.client-batch-checkbox').forEach(cb => cb.checked = false);
            batchSelectedTasks = [];
            updateBatchCount();
        }
        
        async function batchChangeStatus() {
            if (batchSelectedTasks.length === 0) {
                alert('è«‹å…ˆé¸æ“‡ä»»å‹™');
                return;
            }
            
            // åˆ›å»ºçŠ¶æ€é€‰æ‹©å¯¹è¯æ¡†
            const statusOptions = [
                { value: 'pending', label: 'â° æœªé–‹å§‹' },
                { value: 'in_progress', label: 'ğŸŸ¡ é€²è¡Œä¸­' },
                { value: 'completed', label: 'âœ… å·²å®Œæˆ' },
                { value: 'cancelled', label: 'âŒ å·²å–æ¶ˆ' }
            ];
            
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
            
            const dialog = document.createElement('div');
            dialog.style.cssText = 'background:white;padding:24px;border-radius:8px;min-width:300px;max-width:400px;';
            
            dialog.innerHTML = `
                <h3 style="margin:0 0 16px 0;">æ‰¹é‡ä¿®æ”¹ç‹€æ…‹</h3>
                <p style="margin:0 0 16px 0;color:#6b7280;">å·²é¸æ“‡ ${batchSelectedTasks.length} å€‹ä»»å‹™</p>
                <div style="margin-bottom:16px;">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">é¸æ“‡æ–°ç‹€æ…‹</label>
                    <select id="batchStatusSelect" class="form-control" style="width:100%;">
                        ${statusOptions.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
                    </select>
                </div>
                <div style="display:flex;gap:8px;justify-content:flex-end;">
                    <button class="btn btn-secondary" id="cancelBatchStatus">å–æ¶ˆ</button>
                    <button class="btn btn-primary" id="confirmBatchStatus">ç¢ºå®š</button>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('cancelBatchStatus').onclick = () => {
                document.body.removeChild(overlay);
            };
            
            document.getElementById('confirmBatchStatus').onclick = async () => {
                const newStatus = document.getElementById('batchStatusSelect').value;
                document.body.removeChild(overlay);
                
                try {
                    // æ‰¹é‡ä¿®æ”¹æ‰€æœ‰é€‰ä¸­çš„ä»»åŠ¡
                    const promises = batchSelectedTasks.map(taskId => 
                        fetch(`/internal/api/v1/tasks/${taskId}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ status: newStatus })
                        })
                    );
                    
                    await Promise.all(promises);
                    alert('âœ… æ‰¹é‡ä¿®æ”¹æˆåŠŸï¼');
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    await loadTaskOverview();
                    
                    // æ¸…é™¤æ‰¹é‡é€‰æ‹©
                    clearBatchSelection();
                } catch (err) {
                    console.error('æ‰¹é‡ä¿®æ”¹å¤±è´¥:', err);
                    alert('âŒ æ‰¹é‡ä¿®æ”¹å¤±è´¥ï¼š' + err.message);
                }
            };
        }
        
        async function batchChangeDueDate() {
            if (batchSelectedTasks.length === 0) {
                alert('è«‹å…ˆé¸æ“‡ä»»å‹™');
                return;
            }
            
            // åˆ›å»ºæ—¥æœŸé€‰æ‹©å¯¹è¯æ¡†
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
            
            const dialog = document.createElement('div');
            dialog.style.cssText = 'background:white;padding:24px;border-radius:8px;min-width:300px;max-width:400px;';
            
            dialog.innerHTML = `
                <h3 style="margin:0 0 16px 0;">æ‰¹é‡ä¿®æ”¹åˆ°æœŸæ—¥</h3>
                <p style="margin:0 0 16px 0;color:#6b7280;">å·²é¸æ“‡ ${batchSelectedTasks.length} å€‹ä»»å‹™</p>
                <div style="margin-bottom:16px;">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">æ–°çš„åˆ°æœŸæ—¥</label>
                    <input type="date" id="batchDueDateInput" class="form-control" style="width:100%;">
                </div>
                <div style="margin-bottom:16px;">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">èª¿æ•´åŸå› </label>
                    <textarea id="batchDueDateReason" class="form-control" rows="3" placeholder="è«‹èªªæ˜èª¿æ•´åŸå› " style="width:100%;resize:vertical;"></textarea>
                </div>
                <div style="display:flex;gap:8px;justify-content:flex-end;">
                    <button class="btn btn-secondary" id="cancelBatchDueDate">å–æ¶ˆ</button>
                    <button class="btn btn-primary" id="confirmBatchDueDate">ç¢ºå®š</button>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('cancelBatchDueDate').onclick = () => {
                document.body.removeChild(overlay);
            };
            
            document.getElementById('confirmBatchDueDate').onclick = async () => {
                const newDate = document.getElementById('batchDueDateInput').value;
                const reason = document.getElementById('batchDueDateReason').value.trim();
                
                if (!newDate) {
                    alert('è«‹é¸æ“‡æ–°çš„åˆ°æœŸæ—¥');
                    return;
                }
                
                if (!reason) {
                    alert('è«‹è¼¸å…¥èª¿æ•´åŸå› ');
                    return;
                }
                
                document.body.removeChild(overlay);
                
                try {
                    // æ‰¹é‡ä¿®æ”¹æ‰€æœ‰é€‰ä¸­çš„ä»»åŠ¡
                    const promises = batchSelectedTasks.map(taskId => 
                        fetch(`/internal/api/v1/tasks/${taskId}/adjust-due-date`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ 
                                new_due_date: newDate,
                                reason: reason
                            })
                        })
                    );
                    
                    await Promise.all(promises);
                    alert('âœ… æ‰¹é‡ä¿®æ”¹æˆåŠŸï¼');
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    await loadTaskOverview();
                    
                    // æ¸…é™¤æ‰¹é‡é€‰æ‹©
                    clearBatchSelection();
                } catch (err) {
                    console.error('æ‰¹é‡ä¿®æ”¹å¤±è´¥:', err);
                    alert('âŒ æ‰¹é‡ä¿®æ”¹å¤±è´¥ï¼š' + err.message);
                }
            };
        }
        
        async function batchChangeAssignee() {
            if (batchSelectedTasks.length === 0) {
                alert('è«‹å…ˆé¸æ“‡ä»»å‹™');
                return;
            }
            
            try {
                // è·å–ç”¨æˆ·åˆ—è¡¨
                const usersRes = await fetch('/internal/api/v1/users', {
                    credentials: 'include'
                });
                const usersData = await usersRes.json();
                const users = usersData.data || [];
                
                // åˆ›å»ºè´Ÿè´£äººé€‰æ‹©å¯¹è¯æ¡†
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
                
                const dialog = document.createElement('div');
                dialog.style.cssText = 'background:white;padding:24px;border-radius:8px;min-width:300px;max-width:400px;';
                
                dialog.innerHTML = `
                    <h3 style="margin:0 0 16px 0;">æ‰¹é‡ä¿®æ”¹è² è²¬äºº</h3>
                    <p style="margin:0 0 16px 0;color:#6b7280;">å·²é¸æ“‡ ${batchSelectedTasks.length} å€‹ä»»å‹™</p>
                    <div style="margin-bottom:16px;">
                        <label style="display:block;margin-bottom:8px;font-weight:500;">é¸æ“‡æ–°è² è²¬äºº</label>
                        <select id="batchAssigneeSelect" class="form-control" style="width:100%;">
                            <option value="">æœªæŒ‡æ´¾</option>
                            ${users.map(u => `<option value="${u.user_id}">${u.name || u.username}</option>`).join('')}
                        </select>
                    </div>
                    <div style="display:flex;gap:8px;justify-content:flex-end;">
                        <button class="btn btn-secondary" id="cancelBatchAssignee">å–æ¶ˆ</button>
                        <button class="btn btn-primary" id="confirmBatchAssignee">ç¢ºå®š</button>
                    </div>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                // ç»‘å®šäº‹ä»¶
                document.getElementById('cancelBatchAssignee').onclick = () => {
                    document.body.removeChild(overlay);
                };
                
                document.getElementById('confirmBatchAssignee').onclick = async () => {
                    const assigneeId = document.getElementById('batchAssigneeSelect').value;
                    document.body.removeChild(overlay);
                    
                    try {
                        // æ‰¹é‡ä¿®æ”¹æ‰€æœ‰é€‰ä¸­çš„ä»»åŠ¡
                        const promises = batchSelectedTasks.map(taskId => 
                            fetch(`/internal/api/v1/tasks/${taskId}`, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({ 
                                    assignee_user_id: assigneeId || null
                                })
                            })
                        );
                        
                        await Promise.all(promises);
                        alert('âœ… æ‰¹é‡ä¿®æ”¹æˆåŠŸï¼');
                        
                        // é‡æ–°åŠ è½½æ•°æ®
                        await loadTaskOverview();
                        
                        // æ¸…é™¤æ‰¹é‡é€‰æ‹©
                        clearBatchSelection();
                    } catch (err) {
                        console.error('æ‰¹é‡ä¿®æ”¹å¤±è´¥:', err);
                        alert('âŒ æ‰¹é‡ä¿®æ”¹å¤±è´¥ï¼š' + err.message);
                    }
                };
            } catch (err) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', err);
                alert('âŒ åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
            }
        }
        
        // ç­›é€‰å™¨æŒä¹…åŒ–
        function saveFilters() {
            const filters = {
                months: selectedMonths,
                statuses: Array.from(document.querySelectorAll('.status-filter:checked')).map(cb => cb.value),
                sources: Array.from(document.querySelectorAll('.source-filter:checked')).map(cb => cb.value),
                search: document.getElementById('taskOverviewSearch').value
            };
            localStorage.setItem(FILTER_STORAGE_KEY, JSON.stringify(filters));
        }
        
        function restoreFilters() {
            try {
                const saved = localStorage.getItem(FILTER_STORAGE_KEY);
                if (!saved) {
                    // é»˜è®¤é€‰æ‹©æœ¬æœˆ+ä¸Šæœˆ
                    selectQuickMonths('currentAndLast');
                    return;
                }
                
                const filters = JSON.parse(saved);
                
                // æ¢å¤æœˆä»½
                selectedMonths = filters.months || [];
                selectedMonths.forEach(month => {
                    const btn = document.querySelector(`[data-month="${month}"]`);
                    if (btn) btn.classList.add('selected');
                });
                
                // æ¢å¤çŠ¶æ€
                document.querySelectorAll('.status-filter').forEach(cb => {
                    cb.checked = filters.statuses?.includes(cb.value) || false;
                });
                
                // æ¢å¤æ¥æº
                document.querySelectorAll('.source-filter').forEach(cb => {
                    cb.checked = filters.sources?.includes(cb.value) || false;
                });
                
                // æ¢å¤æœç´¢
                if (filters.search) {
                    document.getElementById('taskOverviewSearch').value = filters.search;
                }
                
            } catch (err) {
                console.error('æ¢å¤ç­›é€‰æ¡ä»¶å¤±è´¥:', err);
                selectQuickMonths('currentAndLast');
            }
        }
        
        // å·¥å…·å‡½æ•°
        function calculateOverdueDays(dueDate) {
            if (!dueDate) return 0;
            const due = new Date(dueDate);
            const now = new Date();
            const diff = Math.floor((now - due) / (1000 * 60 * 60 * 24));
            return diff > 0 ? diff : 0;
        }
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­çŠ¶æ€èœå•
        document.addEventListener('click', function() {
            document.querySelectorAll('.status-menu').forEach(m => m.classList.remove('show'));
        });
    </script>
</body>
</html>

