# MASTER PLAN v2 - 详细任务拆分版

**版本：** v2.0 (详细拆分版)  
**目标：** 每个任务对应规格文档的具体功能点

---

## 📋 详细任务拆分示例

### 模块 1 示例：系统基础（详细拆分）

#### 1.1 Users 表创建 [規格:L11-L42]

**1.1.1 创建基础字段**
- [ ] 1.1.1.1 创建主键 `user_id` (INTEGER PRIMARY KEY AUTOINCREMENT) [規格:L12]
- [ ] 1.1.1.2 创建 `username` (TEXT UNIQUE NOT NULL) [規格:L13]
- [ ] 1.1.1.3 创建 `password_hash` (TEXT NOT NULL) [規格:L14]
- [ ] 1.1.1.4 创建 `name` (TEXT NOT NULL) [規格:L15]
- [ ] 1.1.1.5 创建 `email` (TEXT NOT NULL) [規格:L16]

**1.1.2 创建权限和性别字段**
- [ ] 1.1.2.1 创建 `is_admin` (BOOLEAN DEFAULT 0) 含注释：0=员工, 1=管理员 [規格:L17]
- [ ] 1.1.2.2 创建 `gender` (TEXT NOT NULL) 含注释：'M', 'F'（影响假期选项）[規格:L18]
- [ ] 1.1.2.3 创建 `birth_date` (TEXT) [規格:L19]
- [ ] 1.1.2.4 创建 `start_date` (TEXT NOT NULL) 含注释：用于计算年资和特休 [規格:L20]

**1.1.3 创建联系信息字段**
- [ ] 1.1.3.1 创建 `phone` (TEXT) [規格:L21]
- [ ] 1.1.3.2 创建 `address` (TEXT) [規格:L22]
- [ ] 1.1.3.3 创建 `emergency_contact_name` (TEXT) [規格:L23]
- [ ] 1.1.3.4 创建 `emergency_contact_phone` (TEXT) [規格:L24]

**1.1.4 创建登入控制字段**
- [ ] 1.1.4.1 创建 `login_attempts` (INTEGER DEFAULT 0) [規格:L27]
- [ ] 1.1.4.2 创建 `last_failed_login` (TEXT) [規格:L28]
- [ ] 1.1.4.3 创建 `last_login` (TEXT) [規格:L29]

**1.1.5 创建审计字段**
- [ ] 1.1.5.1 创建 `created_at` (TEXT DEFAULT datetime('now')) [規格:L32]
- [ ] 1.1.5.2 创建 `updated_at` (TEXT DEFAULT datetime('now')) [規格:L33]
- [ ] 1.1.5.3 创建 `is_deleted` (BOOLEAN DEFAULT 0) [規格:L34]
- [ ] 1.1.5.4 创建 `deleted_at` (TEXT) [規格:L35]
- [ ] 1.1.5.5 创建 `deleted_by` (INTEGER) 含外键约束 [規格:L36]

**1.1.6 创建索引**
- [ ] 1.1.6.1 创建唯一索引 `idx_users_username` ON Users(username) [規格:L39]
- [ ] 1.1.6.2 创建索引 `idx_users_email` ON Users(email) [規格:L40]
- [ ] 1.1.6.3 创建索引 `idx_users_is_admin` ON Users(is_admin) [規格:L41]

---

#### 1.2 POST /api/v1/auth/login 实现 [規格:L246]

**1.2.1 创建 AuthService.login() 方法**

**1.2.1.1 验证阶段**
- [ ] 1.2.1.1.1 验证 username 必填 [規格:業務邏輯]
- [ ] 1.2.1.1.2 验证 password 必填 [規格:業務邏輯]

**1.2.1.2 查询用户**
- [ ] 1.2.1.2.1 从数据库查询用户（WHERE username = ? AND is_deleted = 0）[規格:實現細節]
- [ ] 1.2.1.2.2 用户不存在时返回 401 错误 [規格:錯誤處理]

**1.2.1.3 检查账号锁定**
- [ ] 1.2.1.3.1 检查 login_attempts >= 5 [規格:L156-L165]
- [ ] 1.2.1.3.2 检查距离 last_failed_login 是否小于 15 分钟 [規格:L156-L165]
- [ ] 1.2.1.3.3 锁定期间返回 403 错误："账号已锁定，请15分钟后再试" [規格:L156-L165]

**1.2.1.4 验证密码**
- [ ] 1.2.1.4.1 使用 bcrypt.compare() 验证密码 [規格:L167]
- [ ] 1.2.1.4.2 密码错误时增加 login_attempts [規格:L156-L165]
- [ ] 1.2.1.4.3 密码错误时更新 last_failed_login [規格:L156-L165]
- [ ] 1.2.1.4.4 密码错误时返回 401 错误 [規格:錯誤處理]

**1.2.1.5 登入成功处理**
- [ ] 1.2.1.5.1 重置 login_attempts 为 0 [規格:L156-L165]
- [ ] 1.2.1.5.2 更新 last_login 为当前时间 [規格:L156-L165]
- [ ] 1.2.1.5.3 生成 JWT token（包含 user_id, username, is_admin）[規格:L169-L178]
- [ ] 1.2.1.5.4 设置 HttpOnly Cookie（过期时间 7 天）[規格:L169-L178]

**1.2.1.6 审计日志**
- [ ] 1.2.1.6.1 记录 LOGIN 操作到 AuditLogs [規格:L180-L188]
- [ ] 1.2.1.6.2 记录 IP 地址和 User-Agent [規格:L180-L188]

**1.2.2 创建 POST /api/v1/auth/login 路由**
- [ ] 1.2.2.1 创建路由处理函数 [規格:L246]
- [ ] 1.2.2.2 解析请求 Body（username, password）[規格:L246]
- [ ] 1.2.2.3 调用 AuthService.login() [規格:L246]
- [ ] 1.2.2.4 返回成功响应（包含用户信息）[規格:L246]
- [ ] 1.2.2.5 添加 OpenAPI 注解 [核心原則]

**1.2.3 错误处理**
- [ ] 1.2.3.1 捕获 ValidationError 返回 422 [規格:錯誤處理]
- [ ] 1.2.3.2 捕获 UnauthorizedError 返回 401 [規格:錯誤處理]
- [ ] 1.2.3.3 捕获 ForbiddenError 返回 403 [規格:錯誤處理]

---

#### 1.3 GET /api/v1/admin/users 实现 [規格:L260]

**1.3.1 创建 UserRepository.findAll() 方法**

**1.3.1.1 构建查询条件**
- [ ] 1.3.1.1.1 添加基础 WHERE 条件：is_deleted = 0 [規格:軟刪除]
- [ ] 1.3.1.1.2 支持 name 模糊查询（LIKE）[規格:查詢參數]
- [ ] 1.3.1.1.3 支持 is_admin 精确查询 [規格:查詢參數]
- [ ] 1.3.1.1.4 支持 limit 和 offset 分页 [規格:分頁]

**1.3.1.2 执行查询**
- [ ] 1.3.1.2.1 查询总数（COUNT）[規格:分頁]
- [ ] 1.3.1.2.2 查询数据（SELECT * 排除 password_hash）[規格:安全性]
- [ ] 1.3.1.2.3 按 created_at DESC 排序 [規格:排序]

**1.3.2 创建 UserService.getUsers() 方法**
- [ ] 1.3.2.1 验证用户权限（必须是管理员）[規格:權限]
- [ ] 1.3.2.2 调用 UserRepository.findAll() [規格:服務層]
- [ ] 1.3.2.3 返回用户列表和总数 [規格:響應格式]

**1.3.3 创建 GET /api/v1/admin/users 路由**
- [ ] 1.3.3.1 创建路由处理函数 [規格:L260]
- [ ] 1.3.3.2 应用 authMiddleware（验证登入）[規格:中間件]
- [ ] 1.3.3.3 应用 adminMiddleware（验证管理员）[規格:中間件]
- [ ] 1.3.3.4 解析查询参数（name, is_admin, limit, offset）[規格:L260]
- [ ] 1.3.3.5 调用 UserService.getUsers() [規格:L260]
- [ ] 1.3.3.6 返回 successResponse（包含 pagination）[規格:響應格式]
- [ ] 1.3.3.7 添加 OpenAPI 注解 [核心原則]

---

## 📋 对比：粗糙拆分 vs 详细拆分

### ❌ 粗糙拆分（现在的方式）
```markdown
#### 1.2 認證功能
- [x] 1.2.1 實現 `POST /api/v1/auth/login` 路由（含帐号锁定机制）
```

**问题：**
- 没有拆分具体步骤
- 无法追踪每个细节的实现
- 容易遗漏关键功能

---

### ✅ 详细拆分（应该的方式）
```markdown
#### 1.2 POST /api/v1/auth/login 实现 [規格:L246]

**1.2.1 创建 AuthService.login() 方法**

**1.2.1.1 验证阶段**
- [ ] 1.2.1.1.1 验证 username 必填
- [ ] 1.2.1.1.2 验证 password 必填

**1.2.1.2 查询用户**
- [ ] 1.2.1.2.1 从数据库查询用户
- [ ] 1.2.1.2.2 用户不存在时返回 401 错误

**1.2.1.3 检查账号锁定**
- [ ] 1.2.1.3.1 检查 login_attempts >= 5
- [ ] 1.2.1.3.2 检查距离 last_failed_login 是否小于 15 分钟
- [ ] 1.2.1.3.3 锁定期间返回 403 错误

**1.2.1.4 验证密码**
- [ ] 1.2.1.4.1 使用 bcrypt.compare() 验证密码
- [ ] 1.2.1.4.2 密码错误时增加 login_attempts
- [ ] 1.2.1.4.3 密码错误时更新 last_failed_login
- [ ] 1.2.1.4.4 密码错误时返回 401 错误

**1.2.1.5 登入成功处理**
- [ ] 1.2.1.5.1 重置 login_attempts 为 0
- [ ] 1.2.1.5.2 更新 last_login 为当前时间
- [ ] 1.2.1.5.3 生成 JWT token
- [ ] 1.2.1.5.4 设置 HttpOnly Cookie

**1.2.1.6 审计日志**
- [ ] 1.2.1.6.1 记录 LOGIN 操作到 AuditLogs
- [ ] 1.2.1.6.2 记录 IP 地址和 User-Agent

**1.2.2 创建 POST /api/v1/auth/login 路由**
- [ ] 1.2.2.1 创建路由处理函数
- [ ] 1.2.2.2 解析请求 Body
- [ ] 1.2.2.3 调用 AuthService.login()
- [ ] 1.2.2.4 返回成功响应
- [ ] 1.2.2.5 添加 OpenAPI 注解

**1.2.3 错误处理**
- [ ] 1.2.3.1 捕获 ValidationError 返回 422
- [ ] 1.2.3.2 捕获 UnauthorizedError 返回 401
- [ ] 1.2.3.3 捕获 ForbiddenError 返回 403
```

**优点：**
- 每个步骤清晰可追踪
- 不会遗漏任何细节
- 完成时可以逐一验证

---

## 🎯 详细拆分的原则

### 原则 1：资料表拆分到字段级别
每个表的创建应该拆分为：
1. 基础字段创建
2. 业务字段创建
3. 审计字段创建
4. 索引创建
5. 外键约束创建

### 原则 2：API 拆分到方法级别
每个 API 的实现应该拆分为：
1. Repository 方法实现
2. Service 方法实现（包含业务逻辑的每个步骤）
3. Route 处理函数实现
4. 错误处理实现
5. OpenAPI 注解添加

### 原则 3：Service 方法拆分到逻辑步骤
每个 Service 方法应该拆分为：
1. 输入验证
2. 权限验证
3. 业务逻辑处理（每个步骤独立）
4. 数据库操作
5. 审计日志记录
6. 返回响应

### 原则 4：Cron Job 拆分到执行步骤
每个 Cron Job 应该拆分为：
1. Cron 配置（时间表达式）
2. 冪等性检查
3. 查询需要处理的数据
4. 处理逻辑（每个步骤独立）
5. 更新数据库
6. 记录执行历史
7. 发送通知（如需要）

---

## 📝 任务编号规则

**4 级编号系统：**
```
模块.功能.子功能.具体步骤

例如：
1.2.1.3.2 = 模块1 > 功能2 > 子功能1 > 步骤3 > 细节2
         = 系统基础 > 登入 > Service方法 > 账号锁定检查 > 检查时间间隔
```

---

## ✅ 完成标记的验证清单

标记任务完成前，必须确认：
- [ ] 已打开规格文档
- [ ] 已跳到标记的行号
- [ ] 已完整阅读该行号范围的规格
- [ ] 已对照实现逐一验证每个子任务
- [ ] 所有子任务都已完成
- [ ] 响应格式符合规格示例
- [ ] 业务逻辑符合规格说明
- [ ] 已测试该功能
- [ ] 已记录审计日志（如需要）

---

**这份详细拆分的 MASTER_PLAN 能够确保：**
1. ✅ 不遗漏任何功能细节
2. ✅ 每个步骤都可以独立追踪
3. ✅ 完成时能够系统性验证
4. ✅ 新手也能理解完整的实现流程

