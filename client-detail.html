<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>客戶詳情 - 內部系統</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
  <link rel="stylesheet" href="/assets/css/client-detail-page.css?v=30">
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container">
    <div class="page-header-simple">
      <a href="/internal/clients" class="back-link">← 返回客戶列表</a>
      <h1 class="page-title" id="clientTitle">客戶資料</h1>
    </div>

    <!-- 客戶基本信息 - 可編輯表單 -->
    <div class="content-card">
      <h2 class="card-title">基本信息</h2>
      <form id="clientForm" class="edit-form">
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputCompanyName">公司名稱（必填）</label>
            <input type="text" id="inputCompanyName" required />
            <span class="error-text" id="error_company_name"></span>
          </div>
          <div class="form-field">
            <label for="inputTaxId">統一編號</label>
            <input type="text" id="inputTaxId" maxlength="8" />
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputAssignee">負責人員</label>
            <select id="inputAssignee">
              <option value="">載入中...</option>
            </select>
            <span class="error-text" id="error_assignee"></span>
          </div>
          <div class="form-field">
            <label for="inputPhone">聯絡電話</label>
            <input type="text" id="inputPhone" />
            <span class="error-text" id="error_phone"></span>
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputEmail">Email</label>
            <input type="email" id="inputEmail" />
            <span class="error-text" id="error_email"></span>
          </div>
          <div class="form-field">
            <label>標籤</label>
            <div id="tagsDisplay">-</div>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputClientNotes">客戶備註</label>
            <textarea id="inputClientNotes" rows="3"></textarea>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputPaymentNotes">收款備註</label>
            <textarea id="inputPaymentNotes" rows="3"></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="cancelEdit()">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveClient()">儲存變更</button>
        </div>
      </form>
    </div>

    <!-- 客戶服務 -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">客戶服務</h2>
        <button class="btn btn-primary" onclick="showAddServiceRow()">+ 新增服務</button>
      </div>
      <div class="table-wrapper">
        <table class="services-table" id="servicesTable">
          <thead>
            <tr>
              <th style="width: 30px;"></th>
              <th>服務名稱</th>
              <th>狀態</th>
              <th>服務週期</th>
              <th>年度總額</th>
              <th>開始日期</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="servicesList">
            <tr>
              <td colspan="7" class="loading-text">載入中...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script src="/assets/js/components/bootstrap.js?v=3"></script>
  <script>
    let currentClientId = null;
    let currentEditingServiceId = null;
    let currentBillingServiceId = null;
    let allServices = [];
    let allTemplates = [];

    // 頁面初始化
    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      currentClientId = urlParams.get('id');
      
      if (!currentClientId) {
        alert('缺少客戶ID');
        window.location.href = '/internal/clients';
        return;
      }

      // 先加載服務選項和模板，再加載客戶詳情
      await Promise.all([
        loadServices(),
        loadTemplates()
      ]);
      
      await loadClientDetail();
    }

    // 載入客戶詳情
    async function loadClientDetail() {
      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}`);
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '載入失敗');
          return;
        }

        const client = json.data;
        
        // 更新頁面標題
        document.getElementById('clientTitle').textContent = client.companyName || '客戶資料';
        
        // 預填表單
        document.getElementById('inputCompanyName').value = client.companyName || '';
        document.getElementById('inputTaxId').value = client.taxId || '';
        document.getElementById('inputPhone').value = client.phone || '';
        document.getElementById('inputEmail').value = client.email || '';
        document.getElementById('inputClientNotes').value = client.clientNotes || '';
        document.getElementById('inputPaymentNotes').value = client.paymentNotes || '';
        
        // 載入並設置負責人
        await loadEmployees();
        document.getElementById('inputAssignee').value = client.assigneeUserId || '';
        
        // 標籤顯示
        if (client.tags && client.tags.length > 0) {
          document.getElementById('tagsDisplay').innerHTML = client.tags.map(t => 
            `<span class="tag">${t.tag_name}</span>`
          ).join(' ');
        } else {
          document.getElementById('tagsDisplay').textContent = '-';
        }

        // 顯示服務列表
        renderServices(client.services || []);
        
      } catch (err) {
        console.error('載入客戶詳情失敗:', err);
        alert('載入失敗');
      }
    }
    
    // 載入員工列表
    async function loadEmployees() {
      try {
        const res = await fetch('/internal/api/v1/users');
        const json = await res.json();
        
        if (json.ok && json.data) {
          const select = document.getElementById('inputAssignee');
          select.innerHTML = '<option value="">請選擇負責人員</option>' +
            json.data.map(u => 
              `<option value="${u.user_id}">${u.name || u.username}</option>`
            ).join('');
        }
      } catch (err) {
        console.error('載入員工列表失敗:', err);
      }
    }

    // 渲染服務列表
    function renderServices(services) {
      const tbody = document.getElementById('servicesList');
      
      console.log('渲染服務列表，allServices數量:', allServices.length);
      
      const serviceOptions = allServices && allServices.length > 0
        ? allServices.filter(s => s.is_active).map(s => 
            `<option value="${s.service_id}">${s.service_name}</option>`
          ).join('')
        : '';
      
      console.log('可用服務選項數量:', serviceOptions ? serviceOptions.split('</option>').length - 1 : 0);
      
      const addServiceRowHtml = `
        <tr id="add-service-row" style="display: none;">
          <td></td>
          <td>
            <select id="new-service-id" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="">請選擇服務</option>
              ${serviceOptions}
            </select>
          </td>
          <td>
            <select id="new-service-status" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="active">使用中</option>
              <option value="suspended">暫停</option>
              <option value="expired">已到期</option>
              <option value="cancelled">已取消</option>
            </select>
          </td>
          <td>
            <select id="new-service-cycle" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="monthly">每月</option>
              <option value="quarterly">每季</option>
              <option value="yearly">每年</option>
              <option value="one-time">一次性</option>
            </select>
          </td>
          <td>-</td>
          <td>
            <input type="date" id="new-service-start-date" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </td>
          <td>
            <button class="table-btn-link" onclick="saveNewService()">儲存</button>
            <button class="table-btn-link danger" onclick="cancelAddService()">取消</button>
          </td>
        </tr>
      `;
      
      if (!services || services.length === 0) {
        tbody.innerHTML = addServiceRowHtml + '<tr><td colspan="7" class="no-data">暫無服務</td></tr>';
        return;
      }

      const serviceRows = services.map((svc, index) => {
        const statusClass = {
          'active': 'status-active',
          'suspended': 'status-suspended',
          'expired': 'status-expired',
          'cancelled': 'status-cancelled'
        }[svc.status] || '';
        
        const statusText = {
          'active': '使用中',
          'suspended': '暫停',
          'expired': '已到期',
          'cancelled': '已取消'
        }[svc.status] || svc.status;

        const cycleText = {
          'monthly': '每月',
          'quarterly': '每季',
          'yearly': '每年',
          'one-time': '一次性'
        }[svc.service_cycle] || svc.service_cycle;

        return `
          <tr class="service-main-row">
            <td class="expand-cell">
              <button class="expand-btn" onclick="toggleBilling(${index}, ${svc.client_service_id})">
                <span class="expand-icon" id="expand-icon-${index}">▶</span>
              </button>
            </td>
            <td><strong>${svc.service_name || '-'}</strong></td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${cycleText}</td>
            <td class="amount">$${(svc.year_total || 0).toLocaleString('zh-TW')}</td>
            <td>${svc.start_date || '-'}</td>
            <td class="actions-cell">
              <button type="button" class="table-btn table-btn-primary" onclick="showAddBillingRow(${svc.client_service_id})">新增收費</button>
              <button type="button" class="table-btn table-btn-secondary" onclick="editService(${svc.client_service_id})">編輯</button>
              <button type="button" class="table-btn table-btn-danger" onclick="deleteService(${svc.client_service_id}, '${svc.service_name}')">刪除</button>
            </td>
          </tr>
          <tr class="billing-detail-row" id="billing-row-${index}" style="display: none;">
            <td colspan="7" class="billing-detail-cell">
              <div class="billing-content" id="billing-content-${index}">
                <p class="loading-text">載入中...</p>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = addServiceRowHtml + serviceRows;
      
      // 初始載入所有收費明細
      services.forEach((svc, index) => {
        loadBillingInline(index, svc.client_service_id);
      });
    }

    // 切換收費明細顯示
    function toggleBilling(index, clientServiceId) {
      const detailRow = document.getElementById(`billing-row-${index}`);
      const icon = document.getElementById(`expand-icon-${index}`);
      
      if (detailRow.style.display === 'none') {
        detailRow.style.display = 'table-row';
        icon.textContent = '▼';
      } else {
        detailRow.style.display = 'none';
        icon.textContent = '▶';
      }
    }

    // 載入內嵌收費明細
    async function loadBillingInline(index, clientServiceId) {
      const container = document.getElementById(`billing-content-${index}`);
      
      try {
        const res = await fetch(`/internal/api/v1/billing/service/${clientServiceId}`);
        const json = await res.json();
        
        if (!json.ok) {
          container.innerHTML = '<p class="error-text">載入失敗</p>';
          return;
        }

        const schedules = json.data.schedules || [];
        
        // 排序by月份
        schedules.sort((a, b) => a.billing_month - b.billing_month);

        container.innerHTML = `
          <table class="billing-table" id="billing-table-${clientServiceId}">
            <thead>
              <tr>
                <th style="width: 80px;">月份</th>
                <th>金額</th>
                <th style="width: 100px;">期限</th>
                <th>備註</th>
                <th style="width: 130px;">操作</th>
              </tr>
            </thead>
            <tbody>
              ${schedules.map(s => `
                <tr data-schedule-id="${s.schedule_id}">
                  <td>${s.billing_month}月</td>
                  <td class="amount">$${s.billing_amount.toLocaleString('zh-TW')}</td>
                  <td>${s.payment_due_days}天</td>
                  <td>${s.notes || '-'}</td>
                  <td>
                    <button class="table-btn-link" onclick="startEditBilling(${clientServiceId}, ${s.schedule_id}, ${s.billing_month}, ${s.billing_amount}, ${s.payment_due_days}, '${(s.notes || '').replace(/'/g, "\\'")}')">編輯</button>
                    <button class="table-btn-link danger" onclick="deleteBillingInline(${clientServiceId}, ${s.schedule_id}, ${s.billing_month})">刪除</button>
                  </td>
                </tr>
              `).join('')}
              <tr id="add-row-${clientServiceId}" style="display: none;"></tr>
            </tbody>
          </table>
        `;
        
      } catch (err) {
        console.error('載入收費明細失敗:', err);
        container.innerHTML = '<p class="error-text">載入失敗</p>';
      }
    }

    // 暴露函數到全局
    window.toggleBilling = toggleBilling;
    window.loadBillingInline = loadBillingInline;

    // 載入服務類型選項
    async function loadServices() {
      try {
        const res = await fetch('/internal/api/v1/services');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allServices = json.data;
          console.log('已載入服務選項:', allServices.length, '項');
        }
      } catch (err) {
        console.error('載入服務選項失敗:', err);
      }
    }

    // 載入任務模板選項
    async function loadTemplates() {
      try {
        const res = await fetch('/internal/api/v1/task-templates');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allTemplates = json.data;
        }
      } catch (err) {
        console.error('載入模板選項失敗:', err);
      }
    }

    // 顯示新增服務行
    function showAddServiceRow() {
      const addRow = document.getElementById('add-service-row');
      addRow.style.display = 'table-row';
    }

    // 取消新增服務
    function cancelAddService() {
      const addRow = document.getElementById('add-service-row');
      addRow.style.display = 'none';
      document.getElementById('new-service-id').value = '';
      document.getElementById('new-service-status').value = 'active';
      document.getElementById('new-service-cycle').value = 'monthly';
      document.getElementById('new-service-start-date').value = '';
    }

    // 儲存新服務
    async function saveNewService() {
      const serviceId = document.getElementById('new-service-id').value;
      const status = document.getElementById('new-service-status').value;
      const cycle = document.getElementById('new-service-cycle').value;
      const startDate = document.getElementById('new-service-start-date').value;

      console.log('=== 新增服務 DEBUG START ===');
      console.log('表單值:', { serviceId, status, cycle, startDate });
      console.log('currentClientId:', currentClientId);

      if (!serviceId) {
        alert('請選擇服務');
        return;
      }

      const data = {
        service_id: parseInt(serviceId),
        status: status,
        service_cycle: cycle,
        start_date: startDate || null
      };

      const apiUrl = `/internal/api/v1/clients/${currentClientId}/services`;
      
      console.log('準備發送請求:');
      console.log('  - URL:', apiUrl);
      console.log('  - Method: POST');
      console.log('  - Data:', JSON.stringify(data, null, 2));

      try {
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        console.log('收到響應:');
        console.log('  - Status:', res.status);
        console.log('  - URL:', res.url);
        
        const json = await res.json();
        console.log('  - JSON:', json);
        console.log('=== 新增服務 DEBUG END ===');
        
        if (!json.ok) {
          if (json.errors && json.errors.length > 0) {
            const errorMsg = json.errors.map(e => `${e.field}: ${e.message}`).join('\n');
            alert(`${json.message}\n\n${errorMsg}`);
          } else {
            alert(json.message || '新增失敗');
          }
          return;
        }

        alert('服務已新增');
        cancelAddService();
        await loadClientDetail();
        
      } catch (err) {
        console.error('新增服務失敗:', err);
        alert('操作失敗');
      }
    }

    // 編輯服務（內嵌）
    async function editService(clientServiceId) {
      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}`);
        const json = await res.json();
        
        if (!json.ok || !json.data) {
          alert('載入服務資料失敗');
          return;
        }

        const services = json.data.services || [];
        const service = services.find(s => s.client_service_id === clientServiceId);
        if (!service) {
          alert('找不到服務');
          return;
        }

        const index = services.findIndex(s => s.client_service_id === clientServiceId);
        const serviceRow = document.querySelectorAll('.service-main-row')[index];
        
        serviceRow.innerHTML = `
          <td></td>
          <td>
            <select id="edit-service-id-${clientServiceId}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              ${allServices.filter(s => s.is_active).map(s => 
                `<option value="${s.service_id}" ${s.service_id == service.service_id ? 'selected' : ''}>${s.service_name}</option>`
              ).join('')}
            </select>
          </td>
          <td>
            <select id="edit-service-status-${clientServiceId}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="active" ${service.status == 'active' ? 'selected' : ''}>使用中</option>
              <option value="suspended" ${service.status == 'suspended' ? 'selected' : ''}>暫停</option>
              <option value="expired" ${service.status == 'expired' ? 'selected' : ''}>已到期</option>
              <option value="cancelled" ${service.status == 'cancelled' ? 'selected' : ''}>已取消</option>
            </select>
          </td>
          <td>
            <select id="edit-service-cycle-${clientServiceId}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="monthly" ${service.service_cycle == 'monthly' ? 'selected' : ''}>每月</option>
              <option value="quarterly" ${service.service_cycle == 'quarterly' ? 'selected' : ''}>每季</option>
              <option value="yearly" ${service.service_cycle == 'yearly' ? 'selected' : ''}>每年</option>
              <option value="one-time" ${service.service_cycle == 'one-time' ? 'selected' : ''}>一次性</option>
            </select>
          </td>
          <td>$${(service.year_total || 0).toLocaleString('zh-TW')}</td>
          <td>
            <input type="date" id="edit-service-start-date-${clientServiceId}" value="${service.start_date || ''}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </td>
          <td>
            <button class="table-btn-link" onclick="saveEditService(${clientServiceId})">儲存</button>
            <button class="table-btn-link danger" onclick="cancelEditService()">取消</button>
          </td>
        `;
      } catch (err) {
        console.error('載入服務失敗:', err);
        alert('載入失敗');
      }
    }

    // 儲存編輯的服務
    async function saveEditService(clientServiceId) {
      const serviceId = document.getElementById(`edit-service-id-${clientServiceId}`).value;
      const status = document.getElementById(`edit-service-status-${clientServiceId}`).value;
      const cycle = document.getElementById(`edit-service-cycle-${clientServiceId}`).value;
      const startDate = document.getElementById(`edit-service-start-date-${clientServiceId}`).value;

      const data = {
        service_id: parseInt(serviceId),
        status: status,
        service_cycle: cycle,
        start_date: startDate || null
      };

      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}/services/${clientServiceId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '更新失敗');
          return;
        }

        alert('服務已更新');
        await loadClientDetail();
        
      } catch (err) {
        console.error('更新服務失敗:', err);
        alert('操作失敗');
      }
    }

    // 取消編輯服務
    async function cancelEditService() {
      await loadClientDetail();
    }

    // 刪除服務
    async function deleteService(clientServiceId, serviceName) {
      if (!confirm(`確定要刪除服務「${serviceName}」嗎？`)) return;
      
      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}/services/${clientServiceId}`, {
          method: 'DELETE'
        });
        
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '刪除失敗');
          return;
        }

        alert('服務已刪除');
        await loadClientDetail();
        
      } catch (err) {
        console.error('刪除服務失敗:', err);
        alert('刪除失敗');
      }
    }

    // 顯示新增收費行
    async function showAddBillingRow(clientServiceId) {
      // 獲取當前客戶的所有服務
      const res = await fetch(`/internal/api/v1/clients/${currentClientId}`);
      const json = await res.json();
      
      if (!json.ok) {
        alert('載入服務失敗');
        return;
      }
      
      const services = json.data.services || [];
      const index = services.findIndex(s => s.client_service_id === clientServiceId);
      
      if (index === -1) {
        alert('找不到該服務');
        return;
      }
      
      // 自動展開收費明細行
      const detailRow = document.getElementById(`billing-row-${index}`);
      const icon = document.getElementById(`expand-icon-${index}`);
      
      if (detailRow.style.display === 'none') {
        detailRow.style.display = 'table-row';
        icon.textContent = '▼';
      }
      
      // 顯示新增表單
      const addRow = document.getElementById(`add-row-${clientServiceId}`);
      addRow.style.display = 'table-row';
      addRow.innerHTML = `
        <td>
          <input type="number" id="new-month-${clientServiceId}" placeholder="月份" min="1" max="12" required />
        </td>
        <td>
          <input type="number" id="new-amount-${clientServiceId}" placeholder="金額" step="0.01" min="0" required />
        </td>
        <td>
          <input type="number" id="new-due-${clientServiceId}" value="30" min="1" required />
        </td>
        <td>
          <input type="text" id="new-notes-${clientServiceId}" placeholder="備註" />
        </td>
        <td>
          <button class="table-btn-link" onclick="saveBilling(${clientServiceId}, null)">儲存</button>
          <button class="table-btn-link danger" onclick="cancelBillingEdit(${clientServiceId}, null)">取消</button>
        </td>
      `;
    }

    // 開始編輯收費明細
    function startEditBilling(clientServiceId, scheduleId, month, amount, dueDays, notes) {
      const row = document.querySelector(`[data-schedule-id="${scheduleId}"]`);
      row.innerHTML = `
        <td>
          <input type="number" id="edit-month-${scheduleId}" value="${month}" min="1" max="12" required />
        </td>
        <td>
          <input type="number" id="edit-amount-${scheduleId}" value="${amount}" step="0.01" min="0" required />
        </td>
        <td>
          <input type="number" id="edit-due-${scheduleId}" value="${dueDays}" min="1" required />
        </td>
        <td>
          <input type="text" id="edit-notes-${scheduleId}" value="${notes}" placeholder="備註" />
        </td>
        <td>
          <button class="table-btn-link" onclick="saveBilling(${clientServiceId}, ${scheduleId})">儲存</button>
          <button class="table-btn-link danger" onclick="cancelBillingEdit(${clientServiceId}, ${scheduleId})">取消</button>
        </td>
      `;
    }

    // 儲存收費明細（新增或編輯）
    async function saveBilling(clientServiceId, scheduleId) {
      const isEdit = scheduleId !== null;
      
      let month, amount, dueDays, notes;
      
      if (isEdit) {
        month = document.getElementById(`edit-month-${scheduleId}`).value;
        amount = document.getElementById(`edit-amount-${scheduleId}`).value;
        dueDays = document.getElementById(`edit-due-${scheduleId}`).value;
        notes = document.getElementById(`edit-notes-${scheduleId}`).value;
      } else {
        month = document.getElementById(`new-month-${clientServiceId}`).value;
        amount = document.getElementById(`new-amount-${clientServiceId}`).value;
        dueDays = document.getElementById(`new-due-${clientServiceId}`).value;
        notes = document.getElementById(`new-notes-${clientServiceId}`).value;
      }
      
      if (!month || !amount || !dueDays) {
        alert('請填寫必填欄位');
        return;
      }
      
      const data = {
        billing_month: parseInt(month),
        billing_amount: parseFloat(amount),
        payment_due_days: parseInt(dueDays),
        notes: notes || null
      };
      
      try {
        const url = isEdit 
          ? `/internal/api/v1/billing/${scheduleId}`
          : `/internal/api/v1/billing/service/${clientServiceId}`;
        
        const res = await fetch(url, {
          method: isEdit ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '操作失敗');
          return;
        }

        alert(isEdit ? '收費明細已更新' : '收費明細已新增');
        
        // 重新載入該服務的收費明細
        const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
        const index = services.findIndex(s => s.client_service_id === clientServiceId);
        if (index !== -1) {
          await loadBillingInline(index, clientServiceId);
        }
        
        // 重新載入客戶以更新年度總額
        await loadClientDetail();
        
      } catch (err) {
        console.error('儲存收費明細失敗:', err);
        alert('操作失敗');
      }
    }

    // 取消編輯收費明細
    async function cancelBillingEdit(clientServiceId, scheduleId) {
      // 重新載入該服務的收費明細
      const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
      const index = services.findIndex(s => s.client_service_id === clientServiceId);
      if (index !== -1) {
        await loadBillingInline(index, clientServiceId);
      }
    }

    // 刪除收費明細（內嵌）
    async function deleteBillingInline(clientServiceId, scheduleId, month) {
      if (!confirm(`確定要刪除${month}月的收費明細嗎？`)) return;
      
      try {
        const res = await fetch(`/internal/api/v1/billing/${scheduleId}`, {
          method: 'DELETE'
        });
        
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '刪除失敗');
          return;
        }

        alert('收費明細已刪除');
        
        // 重新載入該服務的收費明細
        const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
        const index = services.findIndex(s => s.client_service_id === clientServiceId);
        if (index !== -1) {
          await loadBillingInline(index, clientServiceId);
        }
        
        // 重新載入客戶以更新年度總額
        await loadClientDetail();
        
      } catch (err) {
        console.error('刪除收費明細失敗:', err);
        alert('刪除失敗');
      }
    }

    // 暴露函數到全局
    window.showAddBillingRow = showAddBillingRow;
    window.startEditBilling = startEditBilling;
    window.saveBilling = saveBilling;
    window.cancelBillingEdit = cancelBillingEdit;
    window.deleteBillingInline = deleteBillingInline;



    // 取消編輯
    function cancelEdit() {
      window.location.href = '/internal/clients';
    }
    
    // 儲存客戶資料
    async function saveClient() {
      clearFormErrors();
      
      const assigneeValue = document.getElementById('inputAssignee').value;
      const assigneeUserId = assigneeValue ? parseInt(assigneeValue) : 0;
      
      const payload = {
        company_name: document.getElementById('inputCompanyName').value.trim(),
        assignee_user_id: assigneeUserId,
        phone: document.getElementById('inputPhone').value.trim() || null,
        email: document.getElementById('inputEmail').value.trim() || null,
        client_notes: document.getElementById('inputClientNotes').value.trim() || null,
        payment_notes: document.getElementById('inputPaymentNotes').value.trim() || null
      };
      
      // 驗證
      let hasError = false;
      if (!payload.company_name) {
        showFieldError('company_name', '公司名稱為必填');
        hasError = true;
      }
      if (!assigneeUserId || assigneeUserId <= 0) {
        showFieldError('assignee', '請選擇負責人員');
        hasError = true;
      }
      
      if (hasError) return;
      
      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        
        const json = await res.json();
        
        if (!res.ok || !json.ok) {
          if (json.errors && Array.isArray(json.errors)) {
            json.errors.forEach(err => {
              showFieldError(err.field, err.message);
            });
          } else {
            alert(json.message || '儲存失敗');
          }
          return;
        }
        
        alert('已儲存');
        loadClientDetail(); // 重新載入
        
      } catch (err) {
        console.error('儲存失敗:', err);
        alert('儲存失敗，請稍後再試');
      }
    }

    // 顯示欄位錯誤
    function showFieldError(field, message) {
      const errorEl = document.getElementById(`error_${field}`);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
    }

    // 清除表單錯誤
    function clearFormErrors(formPrefix) {
      document.querySelectorAll('.error-message, .error-text').forEach(el => {
        el.textContent = '';
        el.style.display = 'none';
      });
    }

    // 點擊Modal外部關閉
    window.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });

    // 初始化
    init();
  </script>
</body>
</html>

