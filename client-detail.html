<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>客戶詳情 - 內部系統</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
  <link rel="stylesheet" href="/assets/css/client-detail-page.css?v=30">
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container">
    <div class="page-header-simple">
      <a href="/internal/clients" class="back-link">← 返回客戶列表</a>
      <h1 class="page-title" id="clientTitle">客戶資料</h1>
    </div>

    <!-- 客戶基本信息 - 可編輯表單 -->
    <div class="content-card">
      <h2 class="card-title">基本信息</h2>
      <form id="clientForm" class="edit-form">
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputCompanyName">公司名稱（必填）</label>
            <input type="text" id="inputCompanyName" required />
            <span class="error-text" id="error_company_name"></span>
          </div>
          <div class="form-field">
            <label for="inputTaxId">統一編號</label>
            <input type="text" id="inputTaxId" maxlength="8" />
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputContactPerson1">公司聯絡人1</label>
            <input type="text" id="inputContactPerson1" placeholder="例如：張先生" />
          </div>
          <div class="form-field">
            <label for="inputContactPerson2">公司聯絡人2</label>
            <input type="text" id="inputContactPerson2" placeholder="例如：李小姐" />
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputAssignee">負責人員</label>
            <select id="inputAssignee">
              <option value="">載入中...</option>
            </select>
            <span class="error-text" id="error_assignee"></span>
          </div>
          <div class="form-field">
            <label for="inputPhone">聯絡電話</label>
            <input type="text" id="inputPhone" />
            <span class="error-text" id="error_phone"></span>
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputEmail">Email</label>
            <input type="email" id="inputEmail" />
            <span class="error-text" id="error_email"></span>
          </div>
          <div class="form-field">
            <label>標籤管理</label>
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;" id="tagsDisplay">
              <span style="color: #9ca3af;">載入中...</span>
            </div>
            <button type="button" class="btn btn-sm btn-secondary" onclick="showTagsModal()" style="margin-top: 8px;">+ 管理標籤</button>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputClientNotes">客戶備註</label>
            <textarea id="inputClientNotes" rows="3"></textarea>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputPaymentNotes">收款備註</label>
            <textarea id="inputPaymentNotes" rows="3"></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="cancelEdit()">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveClient()">儲存變更</button>
        </div>
      </form>
    </div>

    <!-- 客戶服務 -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">客戶服務</h2>
        <button class="btn btn-primary" onclick="showAddServiceRow()">+ 新增服務</button>
      </div>
      <div class="table-wrapper">
        <table class="services-table" id="servicesTable">
          <thead>
            <tr>
              <th style="width: 30px;"></th>
              <th>服務名稱</th>
              <th>狀態</th>
              <th>年度總額</th>
              <th>開始日期</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="servicesList">
            <tr>
              <td colspan="7" class="loading-text">載入中...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 收費設定 -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">💰 收費設定</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
          <select id="billing-service-filter" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
            <option value="">全部服務</option>
          </select>
          <button class="btn btn-primary" onclick="showAddBillingModal()">+ 新增收費</button>
        </div>
      </div>
      <div class="table-wrapper">
        <table class="billing-table" id="billingTable">
          <thead>
            <tr>
              <th>服務名稱</th>
              <th style="width: 80px;">月份</th>
              <th style="width: 120px;">金額</th>
              <th style="width: 100px;">付款期限</th>
              <th>備註</th>
              <th style="width: 130px;">操作</th>
            </tr>
          </thead>
          <tbody id="billingList">
            <tr>
              <td colspan="6" class="loading-text">載入中...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <!-- 新增/編輯收費彈窗 -->
  <div id="billingModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 24px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;" id="billingModalTitle">新增收費</h3>
        <button onclick="closeBillingModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      
      <!-- 选择服务 -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">選擇服務 *</label>
        <select id="modal-service-select" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
          <option value="">請選擇服務</option>
        </select>
      </div>
      
      <!-- 收费类型选择 -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">收費類型 *</label>
        <div style="display: flex; gap: 12px;">
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 10px 16px; border: 2px solid #d1d5db; border-radius: 6px; flex: 1;">
            <input type="radio" name="billing-type" value="monthly" checked onchange="switchBillingType('monthly')" style="cursor: pointer;" />
            <div>
              <div style="font-weight: 500; font-size: 14px;">按月收費</div>
              <div style="font-size: 12px; color: #6b7280;">每月固定金額</div>
            </div>
          </label>
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 10px 16px; border: 2px solid #d1d5db; border-radius: 6px; flex: 1;">
            <input type="radio" name="billing-type" value="one-time" onchange="switchBillingType('one-time')" style="cursor: pointer;" />
            <div>
              <div style="font-weight: 500; font-size: 14px;">一次性收費</div>
              <div style="font-size: 12px; color: #6b7280;">設立費、顧問費等</div>
            </div>
          </label>
        </div>
      </div>
      
      <!-- 按月收费表单 -->
      <div id="monthly-billing-form" style="margin-bottom: 20px;">
        <h4 style="margin: 0 0 12px 0; font-size: 16px; color: #1f2937;">批量設定收費</h4>
        <p style="margin: 0 0 15px 0; font-size: 13px; color: #6b7280;">一次設定多個月份的收費金額</p>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">每月金額 *</label>
            <input type="number" id="modal-batch-amount" placeholder="2000" step="0.01" min="0" required 
                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">付款期限（天）</label>
            <input type="number" id="modal-batch-due" value="30" min="1" 
                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">月份範圍</label>
            <select id="modal-batch-range" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="all">全年（1-12月）</option>
              <option value="custom">自選月份</option>
            </select>
          </div>
        </div>
        
        <div id="modal-month-checkboxes" style="display: none; margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500;">選擇月份：</label>
          <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="1" checked style="cursor: pointer;" /><span>1月</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="2" checked style="cursor: pointer;" /><span>2月</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="3" checked style="cursor: pointer;" /><span>3月</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="4" checked style="cursor: pointer;" /><span>4月</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="5" checked style="cursor: pointer;" /><span>5月</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="6" checked style="cursor: pointer;" /><span>6月</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="7" checked style="cursor: pointer;" /><span>7月</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="8" checked style="cursor: pointer;" /><span>8月</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="9" checked style="cursor: pointer;" /><span>9月</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="10" checked style="cursor: pointer;" /><span>10月</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="11" checked style="cursor: pointer;" /><span>11月</span></label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input type="checkbox" class="modal-month-checkbox" value="12" checked style="cursor: pointer;" /><span>12月</span></label>
          </div>
        </div>
      </div>
      
      <!-- 一次性收费表单 -->
      <div id="onetime-billing-form" style="display: none; margin-bottom: 20px;">
        <h4 style="margin: 0 0 12px 0; font-size: 16px; color: #1f2937;">設定一次性收費</h4>
        <p style="margin: 0 0 15px 0; font-size: 13px; color: #6b7280;">例如：設立費、顧問費、專案費用等</p>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">項目名稱 *</label>
            <input type="text" id="modal-onetime-description" placeholder="例如：設立費" maxlength="100"
                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
            <small style="display: block; margin-top: 4px; color: #6b7280; font-size: 12px;">用於識別這筆收費</small>
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">收費金額 *</label>
            <input type="number" id="modal-onetime-amount" placeholder="5000" step="0.01" min="0" required 
                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">收費日期 *</label>
            <input type="date" id="modal-onetime-date" required 
                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">付款期限（天）</label>
            <input type="number" id="modal-onetime-due" value="30" min="1" 
                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>
        </div>
        
        <div>
          <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">備註</label>
          <textarea id="modal-onetime-notes" rows="3" placeholder="選填：補充說明"
                    style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeBillingModal()">取消</button>
        <button class="btn btn-primary" onclick="saveBillingFromModal()">確認新增</button>
      </div>
    </div>
  </div>

  <!-- 標籤管理彈窗 -->
  <div id="tagsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">管理標籤</h3>
        <button onclick="closeTagsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #6b7280;">已選標籤</h4>
        <div id="selectedTagsList" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 40px; padding: 12px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
          <!-- 已选标签 -->
        </div>
      </div>
      
      <div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h4 style="margin: 0; font-size: 14px; color: #6b7280;">所有標籤（點擊選擇/取消）</h4>
          <button class="btn btn-sm btn-secondary" onclick="toggleNewTagForm()" id="btnShowNewTag">+ 新增標籤</button>
        </div>
        
        <!-- 新增標籤表單 -->
        <div id="newTagForm" style="display: none; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 16px; margin-bottom: 16px;">
          <div style="margin-bottom: 12px;">
            <label style="display: block; font-size: 14px; color: #374151; margin-bottom: 6px;">標籤名稱</label>
            <input type="text" id="newTagName" placeholder="請輸入標籤名稱" maxlength="50" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" />
          </div>
          <div style="margin-bottom: 12px;">
            <label style="display: block; font-size: 14px; color: #374151; margin-bottom: 6px;">顏色</label>
            <select id="newTagColor" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
              <option value="#3b82f6" style="color: #3b82f6;">🔵 藍色</option>
              <option value="#10b981" style="color: #10b981;">🟢 綠色</option>
              <option value="#f59e0b" style="color: #f59e0b;">🟠 橙色</option>
              <option value="#ef4444" style="color: #ef4444;">🔴 紅色</option>
              <option value="#8b5cf6" style="color: #8b5cf6;">🟣 紫色</option>
              <option value="#ec4899" style="color: #ec4899;">🩷 粉色</option>
              <option value="#06b6d4" style="color: #06b6d4;">🔷 青色</option>
              <option value="#84cc16" style="color: #84cc16;">🟢 黃綠色</option>
              <option value="#6b7280" style="color: #6b7280;">⚫ 灰色</option>
            </select>
          </div>
          <div style="display: flex; gap: 8px; justify-content: flex-end;">
            <button class="btn btn-sm btn-secondary" onclick="cancelNewTag()">取消</button>
            <button class="btn btn-sm btn-primary" onclick="saveNewTag()">建立</button>
          </div>
        </div>
        
        <div id="allTagsList" style="display: flex; flex-wrap: wrap; gap: 8px;">
          <span style="color: #9ca3af;">載入中...</span>
        </div>
      </div>
      
      <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
        <button class="btn btn-secondary" onclick="closeTagsModal()">取消</button>
        <button class="btn btn-primary" onclick="saveTags()">儲存</button>
      </div>
    </div>
  </div>

  <script src="/assets/js/components/bootstrap.js?v=3"></script>
  <script>
    let currentClientId = null;
    let currentEditingServiceId = null;
    let currentBillingServiceId = null;
    let allServices = [];
    let allServiceItems = [];  // 存储所有服务项
    let allTemplates = [];
    let allUsers = [];  // 存储所有员工
    let allSOPs = [];  // 存储所有SOP
    
    // 辅助函数：获取分类文本
    function getCategoryText(category) {
      const categoryMap = {
        'accounting': '記帳流程',
        'tax': '稅務流程',
        'business': '工商登記',
        'internal': '內部流程'
      };
      return categoryMap[category] || category;
    }

    // 頁面初始化
    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      currentClientId = urlParams.get('id');
      
      if (!currentClientId) {
        alert('缺少客戶ID');
        window.location.href = '/internal/clients';
        return;
      }

      // 先加載服務選項、服務項、模板、員工和SOP，再加載客戶詳情
      await Promise.all([
        loadServices(),
        loadServiceItems(),
        loadTemplates(),
        loadAllUsers(),
        loadAllSOPs()
      ]);
      
      await loadClientDetail();
      await loadAllBilling();
      
      // 绑定收费服务筛选事件
      const billingServiceFilter = document.getElementById('billing-service-filter');
      if (billingServiceFilter) {
        billingServiceFilter.addEventListener('change', function() {
          renderBillingList(this.value);
        });
      }
    }

    // 載入客戶詳情
    async function loadClientDetail() {
      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}`);
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '載入失敗');
          return;
        }

        const client = json.data;
        
        // 更新頁面標題
        document.getElementById('clientTitle').textContent = client.companyName || '客戶資料';
        
        // 預填表單
        document.getElementById('inputCompanyName').value = client.companyName || '';
        document.getElementById('inputTaxId').value = client.taxId || '';
        document.getElementById('inputContactPerson1').value = client.contact_person_1 || client.contactPerson1 || '';
        document.getElementById('inputContactPerson2').value = client.contact_person_2 || client.contactPerson2 || '';
        document.getElementById('inputPhone').value = client.phone || '';
        document.getElementById('inputEmail').value = client.email || '';
        document.getElementById('inputClientNotes').value = client.clientNotes || '';
        document.getElementById('inputPaymentNotes').value = client.paymentNotes || '';
        
        // 載入並設置負責人
        await loadEmployees();
        document.getElementById('inputAssignee').value = client.assigneeUserId || '';
        
        // 標籤顯示
        window.currentClientTags = client.tags || [];
        renderTagsDisplay();
        
        // 載入所有標籤
        loadAllTags();

        // 顯示服務列表
        renderServices(client.services || []);
        
      } catch (err) {
        console.error('載入客戶詳情失敗:', err);
        alert('載入失敗');
      }
    }
    
    // 載入員工列表
    async function loadEmployees() {
      try {
        const res = await fetch('/internal/api/v1/users');
        const json = await res.json();
        
        if (json.ok && json.data) {
          const select = document.getElementById('inputAssignee');
          select.innerHTML = '<option value="">請選擇負責人員</option>' +
            json.data.map(u => 
              `<option value="${u.user_id}">${u.name || u.username}</option>`
            ).join('');
        }
      } catch (err) {
        console.error('載入員工列表失敗:', err);
      }
    }

    // 渲染服務列表
    function renderServices(services) {
      const tbody = document.getElementById('servicesList');
      
      console.log('渲染服務列表，allServices數量:', allServices.length);
      
      const serviceOptions = allServices && allServices.length > 0
        ? allServices.map(s => 
            `<option value="${s.service_id}">${s.service_name}</option>`
          ).join('')
        : '';
      
      console.log('可用服務選項數量:', serviceOptions ? serviceOptions.split('</option>').length - 1 : 0);
      
      const addServiceRowHtml = `
        <tr id="add-service-row" style="display: none;">
          <td></td>
          <td>
            <select id="new-service-id" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="">請選擇服務</option>
              ${serviceOptions}
            </select>
          </td>
          <td>
            <select id="new-service-status" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="active">使用中</option>
              <option value="suspended">暫停</option>
              <option value="expired">已到期</option>
              <option value="cancelled">已取消</option>
            </select>
          </td>
          <td>-</td>
          <td>
            <input type="date" id="new-service-start-date" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </td>
          <td>
            <button class="table-btn-link" onclick="saveNewService()">儲存</button>
            <button class="table-btn-link danger" onclick="cancelAddService()">取消</button>
          </td>
        </tr>
      `;
      
      if (!services || services.length === 0) {
        tbody.innerHTML = addServiceRowHtml + '<tr><td colspan="6" class="no-data">暫無服務</td></tr>';
        return;
      }

      const serviceRows = services.map((svc, index) => {
        const statusClass = {
          'active': 'status-active',
          'suspended': 'status-suspended',
          'expired': 'status-expired',
          'cancelled': 'status-cancelled'
        }[svc.status] || '';
        
        const statusText = {
          'active': '使用中',
          'suspended': '暫停',
          'expired': '已到期',
          'cancelled': '已取消'
        }[svc.status] || svc.status;

        return `
          <tr class="service-main-row">
            <td class="expand-cell">
              <button class="expand-btn" onclick="toggleBilling(${index}, ${svc.client_service_id})">
                <span class="expand-icon" id="expand-icon-${index}">▶</span>
              </button>
            </td>
            <td><strong>${svc.service_name || '-'}</strong></td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td class="amount">$${(svc.year_total || 0).toLocaleString('zh-TW')}</td>
            <td>${svc.start_date || '-'}</td>
            <td class="actions-cell">
              <button type="button" class="table-btn table-btn-primary" onclick="showComponentsSection(${index}, ${svc.client_service_id})">配置服務內容</button>
              <button type="button" class="table-btn table-btn-secondary" onclick="editService(${svc.client_service_id})">編輯</button>
              <button type="button" class="table-btn table-btn-danger" onclick="deleteService(${svc.client_service_id}, '${svc.service_name}')">刪除</button>
            </td>
          </tr>
          <tr class="component-detail-row" id="component-row-${index}" style="display: none;">
            <td colspan="6" class="component-detail-cell">
              <div class="component-content" id="component-content-${index}">
                <p class="loading-text">載入中...</p>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = addServiceRowHtml + serviceRows;
    }

    // ==================== 收費配置管理（獨立區塊）====================
    
    let allBillingData = [];  // 存储所有收费数据
    
    // 加载所有收费数据
    async function loadAllBilling() {
      const billingList = document.getElementById('billingList');
      const serviceFilter = document.getElementById('billing-service-filter');
      
      try {
        // 获取当前客户的所有服务
        const clientRes = await fetch(`/internal/api/v1/clients/${currentClientId}`);
        const clientJson = await clientRes.json();
        
        if (!clientJson.ok) {
          billingList.innerHTML = '<tr><td colspan="6" class="error-text">載入失敗</td></tr>';
          return;
        }
        
        const services = clientJson.data.services || [];
        
        // 更新服务筛选下拉选单
        serviceFilter.innerHTML = '<option value="">全部服務</option>';
        services.forEach(svc => {
          const option = document.createElement('option');
          option.value = svc.client_service_id;
          option.textContent = svc.service_name;
          serviceFilter.appendChild(option);
        });
        
        // 获取所有收费数据
        allBillingData = [];
        for (const svc of services) {
          const billingRes = await fetch(`/internal/api/v1/billing/service/${svc.client_service_id}`);
          const billingJson = await billingRes.json();
          
          if (billingJson.ok && billingJson.data.schedules) {
            billingJson.data.schedules.forEach(schedule => {
              allBillingData.push({
                ...schedule,
                service_name: svc.service_name,
                client_service_id: svc.client_service_id
              });
            });
          }
        }
        
        // 排序：先按服务名称，再按月份
        allBillingData.sort((a, b) => {
          if (a.service_name !== b.service_name) {
            return a.service_name.localeCompare(b.service_name);
          }
          return a.billing_month - b.billing_month;
        });
        
        renderBillingList();
        
      } catch (err) {
        console.error('載入收費數據失敗:', err);
        billingList.innerHTML = '<tr><td colspan="6" class="error-text">載入失敗</td></tr>';
      }
    }
    
    // 渲染收费列表
    function renderBillingList(filterServiceId = '') {
      const billingList = document.getElementById('billingList');
      
      // 按服务筛选
      let filteredData = allBillingData;
      if (filterServiceId) {
        filteredData = allBillingData.filter(b => b.client_service_id == filterServiceId);
      }
      
      if (filteredData.length === 0) {
        billingList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">尚未設定收費</td></tr>';
        return;
      }
      
      billingList.innerHTML = filteredData.map(billing => {
        // 判断是按月收费还是一次性收费
        const isOneTime = billing.billing_type === 'one-time' || billing.billing_month === 0;
        
        // 月份/类型显示
        let monthDisplay = '';
        if (isOneTime) {
          // 一次性收费：显示项目名称和日期
          const dateStr = billing.billing_date ? new Date(billing.billing_date).toLocaleDateString('zh-TW') : '';
          monthDisplay = `<div style="font-weight: 500; color: #f59e0b;">一次性</div><div style="font-size: 12px; color: #6b7280;">${billing.description || dateStr}</div>`;
        } else {
          // 按月收费：显示月份
          monthDisplay = `${billing.billing_month}月`;
        }
        
        // 备注显示
        const notesDisplay = billing.notes || billing.description || '-';
        
        // 删除时的标识
        const deleteLabel = isOneTime ? `一次性收費（${billing.description || ''}）` : `${billing.billing_month}月`;
        
        return `
          <tr>
            <td><strong>${billing.service_name}</strong></td>
            <td>${monthDisplay}</td>
            <td class="amount">$${billing.billing_amount.toLocaleString('zh-TW')}</td>
            <td>${billing.payment_due_days}天</td>
            <td>${notesDisplay}</td>
            <td>
              <button class="table-btn-link" onclick="editBillingRow(${billing.schedule_id}, ${billing.client_service_id}, ${billing.billing_month}, ${billing.billing_amount}, ${billing.payment_due_days}, '${(billing.notes || '').replace(/'/g, "\\'")}')">編輯</button>
              <button class="table-btn-link danger" onclick="deleteBillingRow(${billing.schedule_id}, '${billing.service_name}', '${deleteLabel}')">刪除</button>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    // 切换收费类型
    function switchBillingType(type) {
      const monthlyForm = document.getElementById('monthly-billing-form');
      const onetimeForm = document.getElementById('onetime-billing-form');
      
      if (type === 'monthly') {
        monthlyForm.style.display = 'block';
        onetimeForm.style.display = 'none';
      } else if (type === 'one-time') {
        monthlyForm.style.display = 'none';
        onetimeForm.style.display = 'block';
      }
    }
    
    // 显示新增收费弹窗
    async function showAddBillingModal() {
      const modal = document.getElementById('billingModal');
      const modalTitle = document.getElementById('billingModalTitle');
      const serviceSelect = document.getElementById('modal-service-select');
      const rangeSelect = document.getElementById('modal-batch-range');
      const monthCheckboxes = document.getElementById('modal-month-checkboxes');
      
      modalTitle.textContent = '新增收費';
      
      // 重置收费类型为按月
      document.querySelector('input[name="billing-type"][value="monthly"]').checked = true;
      switchBillingType('monthly');
      
      // 加载服务选项
      const clientRes = await fetch(`/internal/api/v1/clients/${currentClientId}`);
      const clientJson = await clientRes.json();
      
      if (clientJson.ok) {
        const services = clientJson.data.services || [];
        serviceSelect.innerHTML = '<option value="">請選擇服務</option>';
        services.forEach(svc => {
          const option = document.createElement('option');
          option.value = svc.client_service_id;
          option.textContent = svc.service_name;
          serviceSelect.appendChild(option);
        });
      }
      
      // 绑定月份范围切换事件
      rangeSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
          monthCheckboxes.style.display = 'block';
        } else {
          monthCheckboxes.style.display = 'none';
        }
      });
      
      // 设置一次性收费日期为今天
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('modal-onetime-date').value = today;
      
      modal.style.display = 'flex';
    }
    
    // 关闭收费弹窗
    function closeBillingModal() {
      const modal = document.getElementById('billingModal');
      modal.style.display = 'none';
      
      // 重置收费类型
      document.querySelector('input[name="billing-type"][value="monthly"]').checked = true;
      switchBillingType('monthly');
      
      // 重置按月收费表单
      document.getElementById('modal-service-select').value = '';
      document.getElementById('modal-batch-amount').value = '';
      document.getElementById('modal-batch-due').value = '30';
      document.getElementById('modal-batch-range').value = 'all';
      document.getElementById('modal-month-checkboxes').style.display = 'none';
      document.querySelectorAll('.modal-month-checkbox').forEach(cb => cb.checked = true);
      
      // 重置一次性收费表单
      document.getElementById('modal-onetime-description').value = '';
      document.getElementById('modal-onetime-amount').value = '';
      document.getElementById('modal-onetime-date').value = '';
      document.getElementById('modal-onetime-due').value = '30';
      document.getElementById('modal-onetime-notes').value = '';
    }
    
    // 从弹窗保存收费
    async function saveBillingFromModal() {
      const serviceId = document.getElementById('modal-service-select').value;
      const billingType = document.querySelector('input[name="billing-type"]:checked').value;
      
      if (!serviceId) {
        alert('請選擇服務');
        return;
      }
      
      try {
        if (billingType === 'monthly') {
          // 按月收费
          await saveMonthlyBilling(serviceId);
        } else if (billingType === 'one-time') {
          // 一次性收费
          await saveOneTimeBilling(serviceId);
        }
        
        closeBillingModal();
        
        // 重新加载收费列表和服务列表
        await loadAllBilling();
        await loadClientDetail();
        
      } catch (err) {
        alert(err.message || '新增失敗，請稍後再試');
      }
    }
    
    // 保存按月收费
    async function saveMonthlyBilling(serviceId) {
      const amount = parseFloat(document.getElementById('modal-batch-amount').value);
      const dueDays = parseInt(document.getElementById('modal-batch-due').value);
      const range = document.getElementById('modal-batch-range').value;
      
      if (!amount || amount <= 0) {
        throw new Error('請輸入有效的金額');
      }
      
      // 确定要新增的月份
      let months = [];
      if (range === 'all') {
        months = Array.from({length: 12}, (_, i) => i + 1);
      } else {
        const checkboxes = document.querySelectorAll('.modal-month-checkbox:checked');
        months = Array.from(checkboxes).map(cb => parseInt(cb.value));
      }
      
      if (months.length === 0) {
        throw new Error('請至少選擇一個月份');
      }
      
      // 批量创建收费
      for (const month of months) {
        const res = await fetch('/internal/api/v1/billing', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            client_service_id: parseInt(serviceId),
            billing_type: 'monthly',
            billing_month: month,
            billing_amount: amount,
            payment_due_days: dueDays
          })
        });
        
        if (!res.ok) {
          const json = await res.json();
          throw new Error(json.message || `${month}月新增失敗`);
        }
      }
      
      alert(`已成功新增 ${months.length} 個月份的收費`);
    }
    
    // 保存一次性收费
    async function saveOneTimeBilling(serviceId) {
      const description = document.getElementById('modal-onetime-description').value.trim();
      const amount = parseFloat(document.getElementById('modal-onetime-amount').value);
      const date = document.getElementById('modal-onetime-date').value;
      const dueDays = parseInt(document.getElementById('modal-onetime-due').value);
      const notes = document.getElementById('modal-onetime-notes').value.trim();
      
      if (!description) {
        throw new Error('請輸入項目名稱');
      }
      
      if (!amount || amount <= 0) {
        throw new Error('請輸入有效的金額');
      }
      
      if (!date) {
        throw new Error('請選擇收費日期');
      }
      
      const res = await fetch('/internal/api/v1/billing', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          client_service_id: parseInt(serviceId),
          billing_type: 'one-time',
          billing_month: 0,  // 一次性收费不使用月份
          billing_amount: amount,
          payment_due_days: dueDays,
          billing_date: date,
          description: description,
          notes: notes || null
        })
      });
      
      const json = await res.json();
      
      if (!json.ok) {
        throw new Error(json.message || '新增一次性收費失敗');
      }
      
      alert('已成功新增一次性收費');
    }
    
    // 编辑收费
    function editBillingRow(scheduleId, serviceId, month, amount, dueDays, notes) {
      // TODO: 实现编辑功能
      alert('編輯功能開發中');
    }
    
    // 删除收费
    async function deleteBillingRow(scheduleId, serviceName, deleteLabel) {
      if (!confirm(`確定要刪除「${serviceName}」的${deleteLabel}收費嗎？`)) {
        return;
      }
      
      try {
        const res = await fetch(`/internal/api/v1/billing/${scheduleId}`, {
          method: 'DELETE'
        });
        
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '刪除失敗');
          return;
        }
        
        alert('已刪除收費');
        
        // 重新加载
        await loadAllBilling();
        await loadClientDetail();
        
      } catch (err) {
        console.error('刪除收費失敗:', err);
        alert('刪除失敗');
      }
    }
    
    // 旧代码（保留兼容性）
    async function loadBillingInline(index, clientServiceId) {
      const container = document.getElementById(`billing-content-${index}`);
      
      try {
        const res = await fetch(`/internal/api/v1/billing/service/${clientServiceId}`);
        const json = await res.json();
        
        if (!json.ok) {
          container.innerHTML = '<p class="error-text">載入失敗</p>';
          return;
        }

        const schedules = json.data.schedules || [];
        
        // 排序by月份
        schedules.sort((a, b) => a.billing_month - b.billing_month);

        container.innerHTML = `
          <div style="padding: 20px; background: #f9fafb; border-radius: 8px;">
            <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px;">
              <button class="table-btn table-btn-primary" onclick="showBatchBillingForm(${clientServiceId})">+ 批量新增收費</button>
            </div>
            
            <!-- 批量新增表單 -->
            <div id="batch-billing-form-${clientServiceId}" style="display: none; background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #3b82f6;">
              <h5 style="margin-top: 0;">💰 批量設定收費</h5>
              <p style="margin: 0 0 15px 0; font-size: 13px; color: #6b7280;">一次設定多個月份的收費金額</p>
              
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">每月金額 *</label>
                  <input type="number" id="batch-amount-${clientServiceId}" placeholder="2000" step="0.01" min="0" required 
                         style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
                </div>
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">付款期限（天）</label>
                  <input type="number" id="batch-due-${clientServiceId}" value="30" min="1" 
                         style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" />
                </div>
                <div>
                  <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">月份範圍</label>
                  <select id="batch-range-${clientServiceId}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option value="all">全年（1-12月）</option>
                    <option value="custom">自選月份</option>
                  </select>
                </div>
              </div>
              
              <div id="month-checkboxes-${clientServiceId}" style="display: none; margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500;">選擇月份：</label>
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                  ${Array.from({length: 12}, (_, i) => i + 1).map(month => `
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                      <input type="checkbox" class="month-checkbox-${clientServiceId}" value="${month}" checked 
                             style="cursor: pointer;" />
                      <span>${month}月</span>
                    </label>
                  `).join('')}
                </div>
              </div>
              
              <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="table-btn table-btn-secondary" onclick="closeBatchBillingForm(${clientServiceId})">取消</button>
                <button class="table-btn table-btn-primary" onclick="saveBatchBilling(${clientServiceId})">確認新增</button>
              </div>
            </div>
            
            <!-- 收費列表表格 -->
            ${schedules.length > 0 ? `
              <table class="billing-table" id="billing-table-${clientServiceId}" style="background: white;">
                <thead>
                  <tr>
                    <th style="width: 80px;">月份</th>
                    <th>金額</th>
                    <th style="width: 100px;">期限</th>
                    <th>備註</th>
                    <th style="width: 130px;">操作</th>
                  </tr>
                </thead>
                <tbody>
                  ${schedules.map(s => `
                    <tr data-schedule-id="${s.schedule_id}">
                      <td>${s.billing_month}月</td>
                      <td class="amount">$${s.billing_amount.toLocaleString('zh-TW')}</td>
                      <td>${s.payment_due_days}天</td>
                      <td>${s.notes || '-'}</td>
                      <td>
                        <button class="table-btn-link" onclick="startEditBilling(${clientServiceId}, ${s.schedule_id}, ${s.billing_month}, ${s.billing_amount}, ${s.payment_due_days}, '${(s.notes || '').replace(/'/g, "\\'")}')">編輯</button>
                        <button class="table-btn-link danger" onclick="deleteBillingInline(${clientServiceId}, ${s.schedule_id}, ${s.billing_month})">刪除</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            ` : '<p style="text-align: center; color: #9ca3af; padding: 40px 0; background: white; border-radius: 8px;">尚未設定收費，請點擊上方按鈕新增</p>'}
          </div>
        `;
        
        // 綁定月份範圍切換事件
        const rangeSelect = document.getElementById(`batch-range-${clientServiceId}`);
        if (rangeSelect) {
          rangeSelect.addEventListener('change', function() {
            const checkboxesDiv = document.getElementById(`month-checkboxes-${clientServiceId}`);
            if (this.value === 'custom') {
              checkboxesDiv.style.display = 'block';
            } else {
              checkboxesDiv.style.display = 'none';
            }
          });
        }
        
      } catch (err) {
        console.error('載入收費明細失敗:', err);
        container.innerHTML = '<p class="error-text">載入失敗</p>';
      }
    }
    
    // 顯示批量新增表單
    function showBatchBillingForm(clientServiceId) {
      const form = document.getElementById(`batch-billing-form-${clientServiceId}`);
      form.style.display = 'block';
    }
    
    // 關閉批量新增表單
    function closeBatchBillingForm(clientServiceId) {
      const form = document.getElementById(`batch-billing-form-${clientServiceId}`);
      form.style.display = 'none';
      // 重置表單
      document.getElementById(`batch-amount-${clientServiceId}`).value = '';
      document.getElementById(`batch-due-${clientServiceId}`).value = '30';
      document.getElementById(`batch-range-${clientServiceId}`).value = 'all';
      document.getElementById(`month-checkboxes-${clientServiceId}`).style.display = 'none';
    }
    
    // 儲存批量收費
    async function saveBatchBilling(clientServiceId) {
      const amount = parseFloat(document.getElementById(`batch-amount-${clientServiceId}`).value);
      const dueDays = parseInt(document.getElementById(`batch-due-${clientServiceId}`).value);
      const range = document.getElementById(`batch-range-${clientServiceId}`).value;
      
      if (!amount || amount <= 0) {
        alert('請輸入有效的金額');
        return;
      }
      
      // 確定要新增的月份
      let months = [];
      if (range === 'all') {
        months = Array.from({length: 12}, (_, i) => i + 1);
      } else {
        const checkboxes = document.querySelectorAll(`.month-checkbox-${clientServiceId}:checked`);
        months = Array.from(checkboxes).map(cb => parseInt(cb.value));
      }
      
      if (months.length === 0) {
        alert('請至少選擇一個月份');
        return;
      }
      
      try {
        // 批量創建收費
        for (const month of months) {
          const res = await fetch('/internal/api/v1/billing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              client_service_id: clientServiceId,
              billing_month: month,
              billing_amount: amount,
              payment_due_days: dueDays
            })
          });
          
          if (!res.ok) {
            const json = await res.json();
            throw new Error(json.message || `${month}月新增失敗`);
          }
        }
        
        alert('批量新增成功');
        closeBatchBillingForm(clientServiceId);
        
        // 重新載入收費列表
        const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
        const index = services.findIndex(s => s.client_service_id === clientServiceId);
        if (index !== -1) {
          await loadBillingInline(index, clientServiceId);
        }
        
        // 重新載入服務列表以更新年度總額
        await loadClientDetail();
      } catch (err) {
        alert(err.message || '批量新增失敗，請稍後再試');
      }
    }


    // 載入服務類型選項
    async function loadServices() {
      try {
        const res = await fetch('/internal/api/v1/services');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allServices = json.data;
          console.log('已載入服務選項:', allServices.length, '項');
        }
      } catch (err) {
        console.error('載入服務選項失敗:', err);
      }
    }
    
    // 載入服務項選項
    async function loadServiceItems() {
      try {
        const res = await fetch('/internal/api/v1/services/items');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allServiceItems = json.data;
          console.log('已載入服務項:', allServiceItems.length, '項');
        }
      } catch (err) {
        console.error('載入服務項失敗:', err);
      }
    }

    // 載入任務模板選項
    async function loadTemplates() {
      try {
        const res = await fetch('/internal/api/v1/task-templates');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allTemplates = json.data;
          // 保存到全局，供模板选择时使用
          window.taskTemplatesData = json.data;
        }
      } catch (err) {
        console.error('載入模板選項失敗:', err);
      }
    }
    
    // 載入所有員工
    async function loadAllUsers() {
      try {
        const res = await fetch('/internal/api/v1/users');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allUsers = json.data;
          console.log('已載入員工列表:', allUsers.length, '人');
        }
      } catch (err) {
        console.error('載入員工列表失敗:', err);
      }
    }
    
    // 載入所有SOP
    async function loadAllSOPs() {
      try {
        const res = await fetch('/internal/api/v1/sop');
        const json = await res.json();
        
        if (json.ok && json.data) {
          // 内部知识库不需要发布状态，所有SOP都可用
          allSOPs = json.data.filter(sop => !sop.is_deleted);
          console.log('已載入SOP列表:', allSOPs.length, '篇');
        }
      } catch (err) {
        console.error('載入SOP列表失敗:', err);
      }
    }

    // 顯示新增服務行
    function showAddServiceRow() {
      const addRow = document.getElementById('add-service-row');
      addRow.style.display = 'table-row';
    }

    // 取消新增服務
    function cancelAddService() {
      const addRow = document.getElementById('add-service-row');
      addRow.style.display = 'none';
      document.getElementById('new-service-id').value = '';
      document.getElementById('new-service-status').value = 'active';
      document.getElementById('new-service-start-date').value = '';
    }

    // 儲存新服務
    async function saveNewService() {
      const serviceId = document.getElementById('new-service-id').value;
      const status = document.getElementById('new-service-status').value;
      const startDate = document.getElementById('new-service-start-date').value;

      console.log('=== 新增服務 DEBUG START ===');
      console.log('表單值:', { serviceId, status, startDate });
      console.log('currentClientId:', currentClientId);

      if (!serviceId) {
        alert('請選擇服務');
        return;
      }

      const data = {
        service_id: parseInt(serviceId),
        status: status,
        start_date: startDate || null
      };

      const apiUrl = `/internal/api/v1/clients/${currentClientId}/services`;
      
      console.log('準備發送請求:');
      console.log('  - URL:', apiUrl);
      console.log('  - Method: POST');
      console.log('  - Data:', JSON.stringify(data, null, 2));

      try {
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        console.log('收到響應:');
        console.log('  - Status:', res.status);
        console.log('  - URL:', res.url);
        
        const json = await res.json();
        console.log('  - JSON:', json);
        console.log('=== 新增服務 DEBUG END ===');
        
        if (!json.ok) {
          if (json.errors && json.errors.length > 0) {
            const errorMsg = json.errors.map(e => `${e.field}: ${e.message}`).join('\n');
            alert(`${json.message}\n\n${errorMsg}`);
          } else {
            alert(json.message || '新增失敗');
          }
          return;
        }

        alert('服務已新增');
        cancelAddService();
        await loadClientDetail();
        
      } catch (err) {
        console.error('新增服務失敗:', err);
        alert('操作失敗');
      }
    }

    // 編輯服務（內嵌）
    async function editService(clientServiceId) {
      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}`);
        const json = await res.json();
        
        if (!json.ok || !json.data) {
          alert('載入服務資料失敗');
          return;
        }

        const services = json.data.services || [];
        const service = services.find(s => s.client_service_id === clientServiceId);
        if (!service) {
          alert('找不到服務');
          return;
        }

        const index = services.findIndex(s => s.client_service_id === clientServiceId);
        const serviceRow = document.querySelectorAll('.service-main-row')[index];
        
        serviceRow.innerHTML = `
          <td></td>
          <td>
            <select id="edit-service-id-${clientServiceId}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              ${allServices.map(s => 
                `<option value="${s.service_id}" ${s.service_id == service.service_id ? 'selected' : ''}>${s.service_name}</option>`
              ).join('')}
            </select>
          </td>
          <td>
            <select id="edit-service-status-${clientServiceId}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="active" ${service.status == 'active' ? 'selected' : ''}>使用中</option>
              <option value="suspended" ${service.status == 'suspended' ? 'selected' : ''}>暫停</option>
              <option value="expired" ${service.status == 'expired' ? 'selected' : ''}>已到期</option>
              <option value="cancelled" ${service.status == 'cancelled' ? 'selected' : ''}>已取消</option>
            </select>
          </td>
          <td>$${(service.year_total || 0).toLocaleString('zh-TW')}</td>
          <td>
            <input type="date" id="edit-service-start-date-${clientServiceId}" value="${service.start_date || ''}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </td>
          <td>
            <button class="table-btn-link" onclick="saveEditService(${clientServiceId})">儲存</button>
            <button class="table-btn-link danger" onclick="cancelEditService()">取消</button>
          </td>
        `;
      } catch (err) {
        console.error('載入服務失敗:', err);
        alert('載入失敗');
      }
    }

    // 儲存編輯的服務
    async function saveEditService(clientServiceId) {
      const serviceId = document.getElementById(`edit-service-id-${clientServiceId}`).value;
      const status = document.getElementById(`edit-service-status-${clientServiceId}`).value;
      const startDate = document.getElementById(`edit-service-start-date-${clientServiceId}`).value;

      const data = {
        service_id: parseInt(serviceId),
        status: status,
        start_date: startDate || null
      };

      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}/services/${clientServiceId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '更新失敗');
          return;
        }

        alert('服務已更新');
        await loadClientDetail();
        
      } catch (err) {
        console.error('更新服務失敗:', err);
        alert('操作失敗');
      }
    }

    // 取消編輯服務
    async function cancelEditService() {
      await loadClientDetail();
    }

    // 刪除服務
    async function deleteService(clientServiceId, serviceName) {
      if (!confirm(`確定要刪除服務「${serviceName}」嗎？`)) return;
      
      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}/services/${clientServiceId}`, {
          method: 'DELETE'
        });
        
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '刪除失敗');
          return;
        }

        alert('服務已刪除');
        await loadClientDetail();
        
      } catch (err) {
        console.error('刪除服務失敗:', err);
        alert('刪除失敗');
      }
    }

    // 顯示批量新增收費對話框
    // 開始編輯收費明細
    function startEditBilling(clientServiceId, scheduleId, month, amount, dueDays, notes) {
      const row = document.querySelector(`[data-schedule-id="${scheduleId}"]`);
      row.innerHTML = `
        <td>
          <input type="number" id="edit-month-${scheduleId}" value="${month}" min="1" max="12" required />
        </td>
        <td>
          <input type="number" id="edit-amount-${scheduleId}" value="${amount}" step="0.01" min="0" required />
        </td>
        <td>
          <input type="number" id="edit-due-${scheduleId}" value="${dueDays}" min="1" required />
        </td>
        <td>
          <input type="text" id="edit-notes-${scheduleId}" value="${notes}" placeholder="備註" />
        </td>
        <td>
          <button class="table-btn-link" onclick="saveBilling(${clientServiceId}, ${scheduleId})">儲存</button>
          <button class="table-btn-link danger" onclick="cancelBillingEdit(${clientServiceId}, ${scheduleId})">取消</button>
        </td>
      `;
    }

    // 儲存收費明細（新增或編輯）
    async function saveBilling(clientServiceId, scheduleId) {
      const isEdit = scheduleId !== null;
      
      let month, amount, dueDays, notes;
      
      if (isEdit) {
        month = document.getElementById(`edit-month-${scheduleId}`).value;
        amount = document.getElementById(`edit-amount-${scheduleId}`).value;
        dueDays = document.getElementById(`edit-due-${scheduleId}`).value;
        notes = document.getElementById(`edit-notes-${scheduleId}`).value;
      } else {
        month = document.getElementById(`new-month-${clientServiceId}`).value;
        amount = document.getElementById(`new-amount-${clientServiceId}`).value;
        dueDays = document.getElementById(`new-due-${clientServiceId}`).value;
        notes = document.getElementById(`new-notes-${clientServiceId}`).value;
      }
      
      if (!month || !amount || !dueDays) {
        alert('請填寫必填欄位');
        return;
      }
      
      const data = {
        billing_month: parseInt(month),
        billing_amount: parseFloat(amount),
        payment_due_days: parseInt(dueDays),
        notes: notes || null
      };
      
      try {
        const url = isEdit 
          ? `/internal/api/v1/billing/${scheduleId}`
          : `/internal/api/v1/billing/service/${clientServiceId}`;
        
        const res = await fetch(url, {
          method: isEdit ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '操作失敗');
          return;
        }

        alert(isEdit ? '收費明細已更新' : '收費明細已新增');
        
        // 重新載入該服務的收費明細
        const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
        const index = services.findIndex(s => s.client_service_id === clientServiceId);
        if (index !== -1) {
          await loadBillingInline(index, clientServiceId);
        }
        
        // 重新載入客戶以更新年度總額
        await loadClientDetail();
        
      } catch (err) {
        console.error('儲存收費明細失敗:', err);
        alert('操作失敗');
      }
    }

    // 取消編輯收費明細
    async function cancelBillingEdit(clientServiceId, scheduleId) {
      // 重新載入該服務的收費明細
      const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
      const index = services.findIndex(s => s.client_service_id === clientServiceId);
      if (index !== -1) {
        await loadBillingInline(index, clientServiceId);
      }
    }

    // 刪除收費明細（內嵌）
    async function deleteBillingInline(clientServiceId, scheduleId, month) {
      if (!confirm(`確定要刪除${month}月的收費明細嗎？`)) return;
      
      try {
        const res = await fetch(`/internal/api/v1/billing/${scheduleId}`, {
          method: 'DELETE'
        });
        
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || '刪除失敗');
          return;
        }

        alert('收費明細已刪除');
        
        // 重新載入該服務的收費明細
        const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
        const index = services.findIndex(s => s.client_service_id === clientServiceId);
        if (index !== -1) {
          await loadBillingInline(index, clientServiceId);
        }
        
        // 重新載入客戶以更新年度總額
        await loadClientDetail();
        
      } catch (err) {
        console.error('刪除收費明細失敗:', err);
        alert('刪除失敗');
      }
    }

    // 暴露函數到全局（新的独立收费功能）
    window.switchBillingType = switchBillingType;
    window.showAddBillingModal = showAddBillingModal;
    window.closeBillingModal = closeBillingModal;
    window.saveBillingFromModal = saveBillingFromModal;
    window.editBillingRow = editBillingRow;
    window.deleteBillingRow = deleteBillingRow;

    // ==================== 服務組成部分管理 ====================

    // 顯示服務組成部分配置區域
    async function showComponentsSection(index, clientServiceId) {
      const componentRow = document.getElementById(`component-row-${index}`);
      
      if (componentRow.style.display === 'none') {
        componentRow.style.display = 'table-row';
        await loadComponentsInline(index, clientServiceId);
      } else {
        componentRow.style.display = 'none';
      }
    }

    // 載入服務組成部分列表
    async function loadComponentsInline(index, clientServiceId) {
      const container = document.getElementById(`component-content-${index}`);
      
      try {
        const res = await fetch(`/internal/api/v1/client-services/${clientServiceId}/components`);
        const json = await res.json();
        
        if (!json.ok) {
          container.innerHTML = '<p class="error-text">載入失敗</p>';
          return;
        }

        const components = json.data || [];
        
        // 從clientDetail中找到當前服務，獲取其service_id
        const currentService = clientDetail.services.find(s => s.client_service_id === clientServiceId);
        const currentServiceId = currentService?.service_id;
        
        if (!currentServiceId) {
          container.innerHTML = '<p class="error-text">無法獲取服務信息</p>';
          return;
        }
        
        // 只顯示當前服務下的服務項目
        let serviceItemsHtml = '';
        const currentServiceItems = allServiceItems.filter(item => item.service_id === currentServiceId);
        
        if (currentServiceItems.length === 0) {
          serviceItemsHtml = '<option value="">此服務暫無可用項目</option>';
        } else {
          currentServiceItems.forEach(item => {
            serviceItemsHtml += `<option value="${item.item_id}" data-service-id="${item.service_id}">${item.item_name}</option>`;
          });
        }

        container.innerHTML = `
          <div style="padding: 20px; background: #f9fafb; border-radius: 8px;">
            <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px;">
              <button class="table-btn table-btn-primary" onclick="showAddComponentForm(${clientServiceId})">+ 新增服務項目</button>
            </div>
            
            <div id="add-component-form-${clientServiceId}" style="display: none; background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #3b82f6;">
              <h5 style="margin-top: 0;">新增服務組成部分</h5>
              <div class="form-row-2col">
                <div class="form-field">
                  <label>服務項目 *</label>
                  <select id="new-comp-service-item-${clientServiceId}" onchange="filterTemplatesByServiceItem${clientServiceId}()">
                    <option value="">請選擇服務項目</option>
                    ${serviceItemsHtml}
                  </select>
                </div>
                <div class="form-field">
                  <label>提供頻率</label>
                  <select id="new-comp-freq-${clientServiceId}">
                    <option value="monthly">每月</option>
                    <option value="bi-monthly">每兩個月</option>
                    <option value="quarterly">每季</option>
                    <option value="yearly">每年</option>
                    <option value="one-time">一次性</option>
                  </select>
                </div>
              </div>
              <div class="form-row-2col">
                <div class="form-field">
                  <label>任務模板（可選）</label>
                  <select id="new-comp-template-${clientServiceId}" onchange="loadTemplateStages${clientServiceId}(this.value)">
                    <option value="">請先選擇服務項目</option>
                  </select>
                  <small style="display: block; margin-top: 5px; color: #3b82f6;">
                    ✨ 選擇模板後可編輯任務內容，或手動配置
                  </small>
                </div>
              </div>
              
              <!-- 任务配置区域（统一界面） -->
              <div id="tasks-config-${clientServiceId}" style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px solid #3b82f6;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <div>
                    <strong style="color: #1e40af; font-size: 15px;">📋 任務配置</strong>
                    <p style="margin: 5px 0 0 0; font-size: 13px; color: #3b82f6;">
                      <span id="template-hint-${clientServiceId}">已選擇模板，可自由編輯或添加任務</span>
                    </p>
                  </div>
                  <button type="button" class="table-btn table-btn-primary" onclick="addCustomTask${clientServiceId}()">+ 新增任務</button>
                </div>
                
                <!-- 批量设置负责人 -->
                <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #3b82f6;">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <label style="font-size: 13px; font-weight: 500; color: #1e40af; white-space: nowrap;">👥 批量設置負責人：</label>
                    <select id="batch-assignee-${clientServiceId}" style="flex: 1; max-width: 200px; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;">
                      <option value="">請選擇員工</option>
                      ${allUsers.map(u => `<option value="${u.user_id}">${u.username}</option>`).join('')}
                    </select>
                    <button type="button" class="table-btn" style="background: #3b82f6; color: white; padding: 6px 12px; font-size: 13px;" 
                            onclick="batchAssignTasks${clientServiceId}()">
                      套用到所有任務
                    </button>
                    <small style="color: #6b7280; font-size: 12px;">💡 之後可單獨修改個別任務</small>
                  </div>
                </div>
                
                <div id="tasks-list-${clientServiceId}">
                  <!-- 任务列表会动态加载到这里 -->
                </div>
              </div>
              
              <div class="form-field">
                <label>📖 服務SOP（可選，可多選）</label>
                
                <!-- 已选择的SOP标签 -->
                <div id="selected-comp-sops-${clientServiceId}" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; min-height: 32px; padding: 8px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                  <span style="color: #9ca3af; font-size: 12px;">尚未選擇SOP</span>
                </div>
                
                <!-- 搜索框 -->
                <input type="text" 
                       id="comp-sop-search-${clientServiceId}"
                       placeholder="🔍 搜尋SOP..." 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; margin-bottom: 8px;"
                       onkeyup="filterCompSOPs${clientServiceId}(this.value)" />
                
                <!-- SOP列表 -->
                <div id="new-comp-sop-list-${clientServiceId}" style="max-height: 200px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px; background: #f9fafb;">
                  ${allSOPs.length > 0 ? (() => {
                    // 按分类分组
                    const grouped = {};
                    allSOPs.forEach(sop => {
                      const cat = sop.category || 'other';
                      if (!grouped[cat]) grouped[cat] = [];
                      grouped[cat].push(sop);
                    });
                    
                    return Object.entries(grouped).map(([category, sops]) => {
                      const catName = getCategoryText(category);
                      return `
                        <div style="margin-bottom: 12px;">
                          <div style="font-weight: 600; font-size: 12px; color: #6b7280; margin-bottom: 6px; padding: 4px 6px; background: #f3f4f6; border-radius: 4px;">${catName}</div>
                          ${sops.map(sop => `
                            <label class="comp-sop-option" data-sop-title="${sop.title.toLowerCase()}" data-sop-category="${category}"
                                   style="display: flex; align-items: start; gap: 8px; padding: 6px; cursor: pointer; border-radius: 4px; margin-bottom: 4px; margin-left: 8px;" 
                                   onmouseover="this.style.background='#f3f4f6'" 
                                   onmouseout="this.style.background='transparent'">
                              <input type="checkbox" class="comp-sop-checkbox" value="${sop.sop_id}" 
                                     style="margin-top: 3px; cursor: pointer;" 
                                     onchange="updateCompSOPSelection${clientServiceId}()" />
                              <div style="flex: 1;">
                                <div style="font-weight: 500; font-size: 14px; color: #1f2937;">${sop.title}</div>
                                ${sop.category ? `<div style="font-size: 12px; color: #6b7280; margin-top: 2px;">分類：${getCategoryText(sop.category)}</div>` : ''}
                              </div>
                            </label>
                          `).join('')}
                        </div>
                      `;
                    }).join('');
                  })() : '<div style="color: #9ca3af; text-align: center; padding: 20px;">暫無SOP</div>'}
                </div>
                <small style="display: block; margin-top: 5px; color: #6b7280;">💡 可選擇多個SOP作為服務流程參考</small>
              </div>
              
              <div class="form-field">
                <label>備註</label>
                <textarea id="new-comp-notes-${clientServiceId}" rows="2"></textarea>
              </div>
              <div style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="saveNewComponent(${clientServiceId})">儲存</button>
                <button class="btn btn-secondary" onclick="cancelAddComponent(${clientServiceId})">取消</button>
              </div>
            </div>
            
            ${components.map((comp, i) => `
              <div class="component-item" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #3b82f6;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div style="flex: 1;">
                    <h5 style="margin: 0 0 10px 0; color: #1f2937;">${comp.component_name}</h5>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 14px; color: #6b7280;">
                      <div>📋 <strong>服務類型：</strong>${comp.service_name || '-'}</div>
                      <div>🔄 <strong>提供頻率：</strong>${getFrequencyText(comp.delivery_frequency)}</div>
                      <div>📝 <strong>任務模板：</strong>${comp.template_name || '無'}</div>
                      <div>⏰ <strong>預估工時：</strong>${comp.estimated_hours || '-'}小時</div>
                      <div>📅 <strong>期限規則：</strong>${getDueRuleText(comp.due_date_rule)}</div>
                      <div>⚡ <strong>提前生成：</strong>${comp.advance_days}天</div>
                    </div>
                    ${comp.notes ? `<div style="margin-top: 8px; font-size: 13px; color: #9ca3af;">💡 ${comp.notes}</div>` : ''}
                    
                    <!-- 任务明细区域 -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong style="font-size: 13px; color: #374151;">📋 相關任務</strong>
                        <button class="table-btn-link" onclick="toggleComponentTasks(${comp.component_id})" style="font-size: 12px;">
                          <span id="tasks-toggle-${comp.component_id}">展開</span>
                        </button>
                      </div>
                      <div id="tasks-list-${comp.component_id}" style="display: none; margin-top: 8px;">
                        <div class="loading-text" style="font-size: 13px;">載入中...</div>
                      </div>
                    </div>
                  </div>
                  <div style="display: flex; gap: 5px;">
                    <button class="table-btn-link" onclick="editComponent(${comp.component_id})">編輯</button>
                    <button class="table-btn-link danger" onclick="deleteComponent(${comp.component_id}, '${comp.component_name}')">刪除</button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        
      } catch (err) {
        console.error('載入服務組成部分失敗:', err);
        container.innerHTML = '<p class="error-text">載入失敗</p>';
      }
    }

    // 輔助函數：頻率文字
    function getFrequencyText(freq) {
      const map = {
        'monthly': '每月',
        'bi-monthly': '每兩個月',
        'quarterly': '每季',
        'yearly': '每年',
        'one-time': '一次性'
      };
      return map[freq] || freq;
    }

    // 輔助函數：期限規則文字
    function getDueRuleText(rule) {
      const map = {
        'end_of_month': '當月月底',
        'specific_day': '當月指定日',
        'next_month_day': '次月指定日',
        'days_after_start': '相對天數'
      };
      return map[rule] || '-';
    }

    // 顯示新增表單
    function showAddComponentForm(clientServiceId) {
      const form = document.getElementById(`add-component-form-${clientServiceId}`);
      form.style.display = 'block';
      
      // 创建服务项过滤模板的函数
      window[`filterTemplatesByServiceItem${clientServiceId}`] = function() {
        const serviceItemSelect = document.getElementById(`new-comp-service-item-${clientServiceId}`);
        const templateSelect = document.getElementById(`new-comp-template-${clientServiceId}`);
        const selectedOption = serviceItemSelect.options[serviceItemSelect.selectedIndex];
        
        if (!selectedOption || !selectedOption.value) {
          // 如果没有选择服务项，清空模板选项
          templateSelect.innerHTML = '<option value="">請先選擇服務項目</option>';
          return;
        }
        
        // 获取选中服务项的 service_id
        const serviceId = selectedOption.getAttribute('data-service-id');
        
        // 过滤模板：只显示匹配的服务类型或没有指定服务类型的模板
        const filteredTemplates = allTemplates.filter(t => !t.service_id || t.service_id == serviceId);
        
        // 更新模板选项
        templateSelect.innerHTML = '<option value="">不使用模板（手動配置）</option>';
        filteredTemplates.forEach(t => {
          const option = document.createElement('option');
          option.value = t.template_id;
          option.textContent = t.template_name;
          templateSelect.appendChild(option);
        });
      };
      
      // 创建期限日期预览函数
      window[`updateDueDatePreview${clientServiceId}`] = function() {
        const rule = document.getElementById(`new-comp-due-rule-${clientServiceId}`).value;
        const value = document.getElementById(`new-comp-due-value-${clientServiceId}`).value;
        const previewText = document.getElementById(`preview-text-${clientServiceId}`);
        const valueField = document.getElementById(`due-value-field-${clientServiceId}`);
        
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth() + 1;
        const nextMonth = currentMonth === 12 ? 1 : currentMonth + 1;
        
        let examples = [];
        
        switch(rule) {
          case 'end_of_month':
            valueField.style.display = 'none';
            examples = [
              `1月執行 → 1/31到期`,
              `2月執行 → 2/28到期`,
              `3月執行 → 3/31到期`
            ];
            previewText.innerHTML = examples.join('<br>');
            break;
            
          case 'specific_day':
            valueField.style.display = 'block';
            if (value && value >= 1 && value <= 31) {
              examples = [
                `1月執行 → 1/${value}到期`,
                `2月執行 → 2/${value}到期`,
                `${currentMonth}月執行 → ${currentMonth}/${value}到期`
              ];
              previewText.innerHTML = `<span style="color: #059669; font-weight: 600;">每月${value}日到期</span><br><span style="font-size: 13px;">${examples.join(' | ')}</span>`;
            } else {
              previewText.innerHTML = '請輸入1-31的日期，例如：5（代表每月5日到期）';
              previewText.style.color = '#9ca3af';
            }
            break;
            
          case 'next_month_day':
            valueField.style.display = 'block';
            if (value && value >= 1 && value <= 31) {
              examples = [
                `1月執行 → 2/${value}到期`,
                `2月執行 → 3/${value}到期`,
                `${currentMonth}月執行 → ${nextMonth}/${value}到期`
              ];
              previewText.innerHTML = `<span style="color: #059669; font-weight: 600;">次月${value}日到期</span><br><span style="font-size: 13px;">${examples.join(' | ')}</span>`;
            } else {
              previewText.innerHTML = '請輸入1-31的日期，例如：15（代表次月15日到期）';
              previewText.style.color = '#9ca3af';
            }
            break;
            
          case 'days_after_start':
            valueField.style.display = 'block';
            if (value && value >= 1) {
              const exampleDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
              exampleDate.setDate(exampleDate.getDate() + parseInt(value));
              examples = [
                `1月1日 + ${value}天 → ${exampleDate.getMonth() === 0 ? '1' : exampleDate.getMonth() + 1}/${exampleDate.getDate()}`,
                `從每月1日起算${value}天後到期`
              ];
              previewText.innerHTML = `<span style="color: #059669; font-weight: 600;">月初後${value}天到期</span><br><span style="font-size: 13px;">${examples.join('<br>')}</span>`;
            } else {
              previewText.innerHTML = '請輸入天數，例如：30（代表從月初起算30天後到期）';
              previewText.style.color = '#9ca3af';
            }
            break;
        }
      };
      
      // 创建加载模板阶段的函数
      window[`loadTemplateStages${clientServiceId}`] = async function(templateId) {
        const tasksContainer = document.getElementById(`tasks-config-${clientServiceId}`);
        const tasksList = document.getElementById(`tasks-list-${clientServiceId}`);
        const templateHint = document.getElementById(`template-hint-${clientServiceId}`);
        
        // 初始化任务数组
        if (!window[`customTasks${clientServiceId}`]) {
          window[`customTasks${clientServiceId}`] = [];
        }
        
        if (!templateId) {
          // 没有选择模板
          templateHint.textContent = '未使用模板，手動配置任務';
          window[`customTasks${clientServiceId}`] = [];
          // 初始化一个空任务
          window[`addCustomTask${clientServiceId}`]();
          return;
        }
        
        // 选择了模板
        templateHint.innerHTML = '<strong>✨ 已選擇模板</strong>，以下任務來自模板並可自由編輯（不影響原始模板）';
        
        tasksList.innerHTML = '<p style="color: #6b7280; font-size: 14px;">載入中...</p>';
        
        try {
          const res = await fetch(`/internal/api/v1/task-templates/${templateId}/stages`);
          const json = await res.json();
          
          if (!json.ok || !json.data) {
            tasksList.innerHTML = '<p style="color: #ef4444; font-size: 14px;">載入失敗</p>';
            return;
          }
          
          const stages = json.data;
          
          if (stages.length === 0) {
            tasksList.innerHTML = '<p style="color: #6b7280; font-size: 14px;">此模板暫無階段設定</p>';
            window[`addCustomTask${clientServiceId}`]();
            return;
          }
          
          // 将模板阶段转换为可编辑任务
          window[`customTasks${clientServiceId}`] = stages.map((stage, idx) => ({
            name: stage.stage_name,
            description: stage.description || '',
            due_rule: stage.due_date_rule || 'end_of_month',
            due_value: stage.due_date_value || '',
            estimated_hours: stage.estimated_hours || '',
            advance_days: stage.advance_days || 7,
            assignee_user_id: '',
            sop_ids: stage.sop_id ? [stage.sop_id] : [],  // 兼容旧的单一SOP
            stage_order: stage.stage_order || (idx + 1),
            fromTemplate: true
          }));
          
          // 渲染任务列表
          window[`renderTasksList${clientServiceId}`]();
          
        } catch (err) {
          console.error('載入模板階段失敗:', err);
          tasksList.innerHTML = '<p style="color: #ef4444; font-size: 14px;">載入失敗</p>';
        }
      };
      
      // 创建统一的任务列表渲染函数
      window[`renderTasksList${clientServiceId}`] = function() {
        const tasksList = document.getElementById(`tasks-list-${clientServiceId}`);
        const tasks = window[`customTasks${clientServiceId}`] || [];
        
        if (tasks.length === 0) {
          tasksList.innerHTML = '<p style="color: #9ca3af; font-size: 13px;">點擊上方「+ 新增任務」按鈕開始配置</p>';
          return;
        }
        
        tasksList.innerHTML = tasks.map((task, idx) => `
          <div id="custom-task-${idx}-${clientServiceId}" style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid ${task.fromTemplate ? '#3b82f6' : '#d1d5db'};">
            <div style="display: flex; align-items: start; gap: 15px;">
              <div style="flex-shrink: 0; width: 30px; height: 30px; background: ${task.fromTemplate ? '#3b82f6' : '#6b7280'}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                ${task.stage_order || idx + 1}
              </div>
              <div style="flex: 1;">
                <div style="margin-bottom: 10px;">
                  <input type="text" placeholder="任務名稱" value="${task.name || ''}"
                         style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; font-weight: 500;"
                         onchange="window.customTasks${clientServiceId}[${idx}].name = this.value" />
                  ${task.description ? `<p style="margin: 4px 0 0 0; font-size: 12px; color: #6b7280;">${task.description}</p>` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">👤 負責人員</label>
                    <select style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                            onchange="window.customTasks${clientServiceId}[${idx}].assignee_user_id = this.value">
                      <option value="">未指定</option>
                      ${allUsers.map(u => `<option value="${u.user_id}" ${task.assignee_user_id == u.user_id ? 'selected' : ''}>${u.username}</option>`).join('')}
                    </select>
                  </div>
                  <div style="grid-column: span 2;">
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">📖 任務SOP（可選，可多選）</label>
                    
                    <!-- 已选择的SOP标签 -->
                    <div id="selected-sops-${idx}-${clientServiceId}" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; min-height: 28px;">
                      <!-- 动态填充已选择的SOP标签 -->
                    </div>
                    
                    <!-- 搜索框 -->
                    <input type="text" 
                           id="sop-search-${idx}-${clientServiceId}"
                           placeholder="🔍 搜尋SOP..." 
                           style="width: 100%; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; margin-bottom: 6px;"
                           onkeyup="filterTaskSOPs${clientServiceId}(${idx}, this.value)" />
                    
                    <!-- SOP列表 -->
                    <div id="task-sop-list-${idx}-${clientServiceId}" style="max-height: 150px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 4px; padding: 8px; background: white;">
                      ${allSOPs.length > 0 ? (() => {
                        // 按分类分组
                        const grouped = {};
                        allSOPs.forEach(sop => {
                          const cat = sop.category || 'other';
                          if (!grouped[cat]) grouped[cat] = [];
                          grouped[cat].push(sop);
                        });
                        
                        return Object.entries(grouped).map(([category, sops]) => {
                          const catName = getCategoryText(category);
                          return \`
                            <div style="margin-bottom: 8px;">
                              <div style="font-weight: 600; font-size: 11px; color: #6b7280; margin-bottom: 4px; padding: 2px 4px; background: #f3f4f6; border-radius: 3px;">\${catName}</div>
                              \${sops.map(sop => {
                                const isChecked = task.sop_ids && task.sop_ids.includes(sop.sop_id);
                                return \`
                                  <label class="sop-option" data-sop-title="\${sop.title.toLowerCase()}" data-sop-category="\${category}"
                                         style="display: flex; align-items: center; gap: 6px; padding: 4px; cursor: pointer; font-size: 12px; margin-left: 8px;" 
                                         onmouseover="this.style.background='#f3f4f6'" 
                                         onmouseout="this.style.background='transparent'">
                                    <input type="checkbox" value="\${sop.sop_id}" 
                                           \${isChecked ? 'checked' : ''}
                                           onchange="updateTaskSOPs${clientServiceId}(${idx}, this)"
                                           style="cursor: pointer;" />
                                    <span style="color: #374151;">\${sop.title}</span>
                                  </label>
                                \`;
                              }).join('')}
                            </div>
                          \`;
                        }).join('');
                      })() : '<div style="color: #9ca3af; font-size: 12px; text-align: center; padding: 10px;">暫無SOP</div>'}
                    </div>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">⏱️ 預估工時</label>
                    <input type="number" min="0" step="0.5" value="${task.estimated_hours || ''}" placeholder="例如：2"
                           style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                           onchange="window.customTasks${clientServiceId}[${idx}].estimated_hours = this.value" />
                    <small style="display: block; margin-top: 3px; font-size: 11px; color: #6b7280;">小時</small>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">📆 提前生成</label>
                    <input type="number" min="0" value="${task.advance_days || 7}" placeholder="7"
                           style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                           onchange="window.customTasks${clientServiceId}[${idx}].advance_days = this.value" />
                    <small style="display: block; margin-top: 3px; font-size: 11px; color: #6b7280;">天前生成</small>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">📅 期限規則</label>
                    <select style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                            onchange="window.customTasks${clientServiceId}[${idx}].due_rule = this.value; window.updateCustomTaskDisplay${clientServiceId}(${idx})">
                      <option value="end_of_month" ${task.due_rule === 'end_of_month' ? 'selected' : ''}>每月最後一天</option>
                      <option value="specific_day" ${task.due_rule === 'specific_day' ? 'selected' : ''}>每月固定日期</option>
                      <option value="next_month_day" ${task.due_rule === 'next_month_day' ? 'selected' : ''}>次月固定日期</option>
                      <option value="days_after_start" ${task.due_rule === 'days_after_start' ? 'selected' : ''}>從月初起算天數</option>
                    </select>
                    <small id="custom-task-display-${idx}-${clientServiceId}" style="display: block; margin-top: 3px; font-size: 11px; color: #3b82f6;"></small>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">📊 日期/天數</label>
                    <input type="number" min="1" max="31" placeholder="請輸入" value="${task.due_value || ''}"
                           style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                           onchange="window.customTasks${clientServiceId}[${idx}].due_value = this.value; window.updateCustomTaskDisplay${clientServiceId}(${idx})" />
                  </div>
                </div>
                
                <div style="margin-top: 10px; display: flex; justify-content: flex-end;">
                  <button type="button" class="table-btn-link danger" onclick="removeCustomTask${clientServiceId}(${idx})">🗑️ 刪除此任務</button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
        // 初始化期限显示和已选择SOP标签
        tasks.forEach((task, idx) => {
          setTimeout(() => {
            window[`updateCustomTaskDisplay${clientServiceId}`](idx);
            window[`renderSelectedTaskSOPs${clientServiceId}`](idx);
          }, 50);
        });
      };
      
      // 创建手动添加任务的函数
      window[`addCustomTask${clientServiceId}`] = function() {
        if (!window[`customTasks${clientServiceId}`]) {
          window[`customTasks${clientServiceId}`] = [];
        }
        
        const tasks = window[`customTasks${clientServiceId}`];
        tasks.push({
          name: '',
          due_rule: 'end_of_month',
          due_value: '',
          estimated_hours: '',
          advance_days: 7,
          assignee_user_id: '',
          sop_ids: [],
          fromTemplate: false
        });
        
        // 重新渲染任务列表
        window[`renderTasksList${clientServiceId}`]();
      };
      
      // 删除自定义任务
      window[`removeCustomTask${clientServiceId}`] = function(idx) {
        if (window[`customTasks${clientServiceId}`]) {
          window[`customTasks${clientServiceId}`].splice(idx, 1);
          // 重新渲染任务列表
          window[`renderTasksList${clientServiceId}`]();
        }
      };
      
      // 更新任务的SOP列表
      window[`updateTaskSOPs${clientServiceId}`] = function(idx, checkbox) {
        const task = window[`customTasks${clientServiceId}`]?.[idx];
        if (!task) return;
        
        if (!task.sop_ids) {
          task.sop_ids = [];
        }
        
        const sopId = parseInt(checkbox.value);
        if (checkbox.checked) {
          if (!task.sop_ids.includes(sopId)) {
            task.sop_ids.push(sopId);
          }
        } else {
          task.sop_ids = task.sop_ids.filter(id => id !== sopId);
        }
        
        // 更新已选择的SOP标签显示
        window[`renderSelectedTaskSOPs${clientServiceId}`](idx);
      };
      
      // 渲染已选择的任务SOP标签
      window[`renderSelectedTaskSOPs${clientServiceId}`] = function(idx) {
        const task = window[`customTasks${clientServiceId}`]?.[idx];
        if (!task) return;
        
        const container = document.getElementById(`selected-sops-${idx}-${clientServiceId}`);
        if (!container) return;
        
        if (!task.sop_ids || task.sop_ids.length === 0) {
          container.innerHTML = '<span style="color: #9ca3af; font-size: 11px;">尚未選擇SOP</span>';
          return;
        }
        
        // 渲染标签
        const tags = task.sop_ids.map(sopId => {
          const sop = allSOPs.find(s => s.sop_id === sopId);
          if (!sop) return '';
          
          return `
            <span style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 11px;">
              ${sop.title}
              <button type="button" 
                      onclick="removeTaskSOP${clientServiceId}(${idx}, ${sopId})"
                      style="border: none; background: none; color: #1e40af; cursor: pointer; padding: 0; font-size: 14px; line-height: 1;"
                      title="移除">×</button>
            </span>
          `;
        }).join('');
        
        container.innerHTML = tags;
      };
      
      // 移除任务SOP
      window[`removeTaskSOP${clientServiceId}`] = function(idx, sopId) {
        const task = window[`customTasks${clientServiceId}`]?.[idx];
        if (!task) return;
        
        task.sop_ids = task.sop_ids.filter(id => id !== sopId);
        
        // 取消对应的checkbox
        const listContainer = document.getElementById(`task-sop-list-${idx}-${clientServiceId}`);
        if (listContainer) {
          const checkbox = listContainer.querySelector(`input[value="${sopId}"]`);
          if (checkbox) checkbox.checked = false;
        }
        
        // 更新标签显示
        window[`renderSelectedTaskSOPs${clientServiceId}`](idx);
      };
      
      // 过滤任务SOP列表
      window[`filterTaskSOPs${clientServiceId}`] = function(idx, searchTerm) {
        const listContainer = document.getElementById(`task-sop-list-${idx}-${clientServiceId}`);
        if (!listContainer) return;
        
        const term = searchTerm.toLowerCase().trim();
        const options = listContainer.querySelectorAll('.sop-option');
        
        let visibleCount = 0;
        options.forEach(option => {
          const title = option.getAttribute('data-sop-title');
          if (!term || title.includes(term)) {
            option.style.display = 'flex';
            visibleCount++;
          } else {
            option.style.display = 'none';
          }
        });
        
        // 隐藏空分类
        const categories = listContainer.querySelectorAll('div > div[style*="font-weight: 600"]');
        categories.forEach(catHeader => {
          const categoryDiv = catHeader.parentElement;
          const visibleOptions = Array.from(categoryDiv.querySelectorAll('.sop-option')).filter(o => o.style.display !== 'none');
          categoryDiv.style.display = visibleOptions.length > 0 ? 'block' : 'none';
        });
      };
      
      // 更新服务组件SOP选择（渲染已选择的标签）
      window[`updateCompSOPSelection${clientServiceId}`] = function() {
        const container = document.getElementById(`selected-comp-sops-${clientServiceId}`);
        if (!container) return;
        
        const checkboxes = document.querySelectorAll('.comp-sop-checkbox:checked');
        
        if (checkboxes.length === 0) {
          container.innerHTML = '<span style="color: #9ca3af; font-size: 12px;">尚未選擇SOP</span>';
          return;
        }
        
        const tags = Array.from(checkboxes).map(checkbox => {
          const sopId = parseInt(checkbox.value);
          const sop = allSOPs.find(s => s.sop_id === sopId);
          if (!sop) return '';
          
          return `
            <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: #dbeafe; color: #1e40af; border-radius: 6px; font-size: 12px;">
              ${sop.title}
              <button type="button" 
                      onclick="removeCompSOP${clientServiceId}(${sopId})"
                      style="border: none; background: none; color: #1e40af; cursor: pointer; padding: 0; font-size: 16px; line-height: 1;"
                      title="移除">×</button>
            </span>
          `;
        }).join('');
        
        container.innerHTML = tags;
      };
      
      // 移除服务组件SOP
      window[`removeCompSOP${clientServiceId}`] = function(sopId) {
        const checkbox = document.querySelector(`.comp-sop-checkbox[value="${sopId}"]`);
        if (checkbox) {
          checkbox.checked = false;
          window[`updateCompSOPSelection${clientServiceId}`]();
        }
      };
      
      // 过滤服务组件SOP列表
      window[`filterCompSOPs${clientServiceId}`] = function(searchTerm) {
        const listContainer = document.getElementById(`new-comp-sop-list-${clientServiceId}`);
        if (!listContainer) return;
        
        const term = searchTerm.toLowerCase().trim();
        const options = listContainer.querySelectorAll('.comp-sop-option');
        
        options.forEach(option => {
          const title = option.getAttribute('data-sop-title');
          if (!term || title.includes(term)) {
            option.style.display = 'flex';
          } else {
            option.style.display = 'none';
          }
        });
        
        // 隐藏空分类
        const categories = listContainer.querySelectorAll('div > div[style*="font-weight: 600"]');
        categories.forEach(catHeader => {
          const categoryDiv = catHeader.parentElement;
          const visibleOptions = Array.from(categoryDiv.querySelectorAll('.comp-sop-option')).filter(o => o.style.display !== 'none');
          categoryDiv.style.display = visibleOptions.length > 0 ? 'block' : 'none';
        });
      };
      
      // 批量设置负责人
      window[`batchAssignTasks${clientServiceId}`] = function() {
        const batchAssigneeSelect = document.getElementById(`batch-assignee-${clientServiceId}`);
        const assigneeUserId = batchAssigneeSelect.value;
        
        if (!assigneeUserId) {
          alert('請先選擇負責人員');
          return;
        }
        
        const tasks = window[`customTasks${clientServiceId}`];
        if (!tasks || tasks.length === 0) {
          alert('目前沒有任務可以設置');
          return;
        }
        
        // 获取选中的员工名称
        const selectedOption = batchAssigneeSelect.options[batchAssigneeSelect.selectedIndex];
        const assigneeName = selectedOption.textContent;
        
        if (confirm(\`確定要將所有 \${tasks.length} 個任務的負責人設置為「\${assigneeName}」嗎？\\n\\n之後您仍可單獨修改個別任務的負責人。\`)) {
          // 批量设置所有任务的负责人
          tasks.forEach(task => {
            task.assignee_user_id = assigneeUserId;
          });
          
          // 重新渲染任务列表
          window[`renderTasksList${clientServiceId}`]();
          
          alert(\`已成功將所有任務的負責人設置為「\${assigneeName}」\`);
        }
      };
      
      // 更新自定义任务的期限显示
      window[`updateCustomTaskDisplay${clientServiceId}`] = function(idx) {
        const task = window[`customTasks${clientServiceId}`]?.[idx];
        if (!task) return;
        
        const display = document.getElementById(`custom-task-display-${idx}-${clientServiceId}`);
        if (!display) return;
        
        let text = '';
        switch(task.due_rule) {
          case 'end_of_month':
            text = '例：1月31日、2月28日、3月31日';
            break;
          case 'specific_day':
            text = task.due_value ? `例：每月${task.due_value}日` : '請填寫日期';
            break;
          case 'next_month_day':
            text = task.due_value ? `例：1月執行→2/${task.due_value}、2月執行→3/${task.due_value}` : '請填寫日期';
            break;
          case 'days_after_start':
            text = task.due_value ? `例：月初後第${task.due_value}天` : '請填寫天數';
            break;
        }
        display.textContent = text;
      };
      
      // 创建期限显示更新函数
      window[`updateDueDateDisplay${clientServiceId}`] = function(idx) {
        const rule = document.getElementById(`stage-due-rule-${idx}-${clientServiceId}`)?.value;
        const value = document.getElementById(`stage-due-value-${idx}-${clientServiceId}`)?.value;
        const display = document.getElementById(`due-display-${idx}-${clientServiceId}`);
        
        if (!display) return;
        
        let text = '';
        switch(rule) {
          case 'end_of_month':
            text = '例：1月31日、2月28日、3月31日';
            break;
          case 'specific_day':
            if (value) {
              text = `例：每月${value}日`;
            } else {
              text = '請填寫日期';
            }
            break;
          case 'next_month_day':
            if (value) {
              text = `例：1月執行→2/${value}、2月執行→3/${value}`;
            } else {
              text = '請填寫日期';
            }
            break;
          case 'days_after_start':
            if (value) {
              text = `例：月初後第${value}天`;
            } else {
              text = '請填寫天數';
            }
            break;
        }
        display.textContent = text;
      };
      
      // 创建动态帮助函数
      window[`updateDueDateHelp${clientServiceId}`] = function(rule) {
        const valueLabel = document.getElementById(`due-value-label-${clientServiceId}`);
        const valueHelp = document.getElementById(`due-value-help-${clientServiceId}`);
        const dueHelp = document.getElementById(`due-help-${clientServiceId}`);
        
        switch(rule) {
          case 'end_of_month':
            valueLabel.textContent = '期限日期值（不需要填寫）';
            valueHelp.textContent = '系統會自動使用當月最後一天';
            dueHelp.innerHTML = '✅ 例如：1月執行的任務 → 截止日期 1/31';
            break;
          case 'specific_day':
            valueLabel.textContent = '📅 指定日期（必填）';
            valueHelp.textContent = '填寫1-31，表示每月的幾號';
            dueHelp.innerHTML = '✅ 例如：填寫 <strong>5</strong>，1月執行 → 截止日期 1/5';
            break;
          case 'next_month_day':
            valueLabel.textContent = '📅 下月日期（必填）';
            valueHelp.textContent = '填寫1-31，表示下個月的幾號';
            dueHelp.innerHTML = '✅ 例如：填寫 <strong>15</strong>，1月執行 → 截止日期 2/15';
            break;
          case 'days_after_start':
            valueLabel.textContent = '⏱️ 天數（必填）';
            valueHelp.textContent = '填寫天數，從執行月份1日開始計算';
            dueHelp.innerHTML = '✅ 例如：填寫 <strong>30</strong>，1月執行 → 截止日期 1/31';
            break;
        }
      };
      
      // 初始化任务配置区域（默认手动模式）
      window[`loadTemplateStages${clientServiceId}`]('');
    }

    // 取消新增
    function cancelAddComponent(clientServiceId) {
      const form = document.getElementById(`add-component-form-${clientServiceId}`);
      form.style.display = 'none';
      // 清空表單
      document.getElementById(`new-comp-name-${clientServiceId}`).value = '';
      document.getElementById(`new-comp-service-item-${clientServiceId}`).value = '';
      document.getElementById(`new-comp-template-${clientServiceId}`).innerHTML = '<option value="">請先選擇服務項目</option>';
      document.getElementById(`new-comp-hours-${clientServiceId}`).value = '';
      document.getElementById(`new-comp-notes-${clientServiceId}`).value = '';
    }

    // 儲存新服務組成部分
    async function saveNewComponent(clientServiceId) {
      const name = document.getElementById(`new-comp-name-${clientServiceId}`).value.trim();
      const serviceItemId = document.getElementById(`new-comp-service-item-${clientServiceId}`).value;
      const frequency = document.getElementById(`new-comp-freq-${clientServiceId}`).value;
      const templateId = document.getElementById(`new-comp-template-${clientServiceId}`).value;
      const dueRule = document.getElementById(`new-comp-due-rule-${clientServiceId}`).value;
      const dueValue = document.getElementById(`new-comp-due-value-${clientServiceId}`).value;
      const hours = document.getElementById(`new-comp-hours-${clientServiceId}`).value;
      const advance = document.getElementById(`new-comp-advance-${clientServiceId}`).value;
      const notes = document.getElementById(`new-comp-notes-${clientServiceId}`).value.trim();
      
      // 收集选中的多个SOP
      const sopCheckboxes = document.querySelectorAll(`#new-comp-sop-list-${clientServiceId} .comp-sop-checkbox:checked`);
      const sopIds = Array.from(sopCheckboxes).map(cb => parseInt(cb.value));

      if (!name) {
        alert('請輸入服務名稱');
        return;
      }
      if (!serviceItemId) {
        alert('請選擇服務項目');
        return;
      }
      
      // 獲取選中服務項的 service_id
      const serviceItemSelect = document.getElementById(`new-comp-service-item-${clientServiceId}`);
      const selectedOption = serviceItemSelect.options[serviceItemSelect.selectedIndex];
      const serviceId = selectedOption.getAttribute('data-service-id');
      
      // 獲取自定義任務配置
      const tasks = window[`customTasks${clientServiceId}`] || [];

      const data = {
        component_name: name,
        service_id: parseInt(serviceId),
        service_item_id: parseInt(serviceItemId),
        delivery_frequency: frequency,
        task_template_id: templateId ? parseInt(templateId) : null,
        due_date_rule: dueRule,
        due_date_value: dueValue ? parseInt(dueValue) : null,
        estimated_hours: hours ? parseFloat(hours) : null,
        advance_days: advance ? parseInt(advance) : 7,
        notes: notes || null,
        sop_ids: sopIds,  // 多个SOP
        auto_generate_task: true,
        tasks: tasks.map(task => ({
          name: task.name,
          due_rule: task.due_rule,
          due_value: task.due_value ? parseInt(task.due_value) : null,
          estimated_hours: task.estimated_hours ? parseFloat(task.estimated_hours) : null,
          advance_days: task.advance_days ? parseInt(task.advance_days) : 7,
          assignee_user_id: task.assignee_user_id ? parseInt(task.assignee_user_id) : null,
          sop_ids: task.sop_ids || []  // 多个SOP
        }))
      };

      try {
        const res = await fetch(`/internal/api/v1/client-services/${clientServiceId}/components`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const json = await res.json();

        if (!json.ok) {
          alert(json.message || '新增失敗');
          return;
        }

        alert('服務組成部分已新增');
        cancelAddComponent(clientServiceId);
        
        // 重新載入組成部分列表
        const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
        const index = services.findIndex(s => s.client_service_id === clientServiceId);
        if (index !== -1) {
          await loadComponentsInline(index, clientServiceId);
        }

      } catch (err) {
        console.error('新增服務組成部分失敗:', err);
        alert('操作失敗');
      }
    }

    // 刪除服務組成部分
    async function deleteComponent(componentId, componentName) {
      if (!confirm(`確定要刪除服務組成部分「${componentName}」嗎？`)) return;

      try {
        const res = await fetch(`/internal/api/v1/service-components/${componentId}`, {
          method: 'DELETE'
        });

        const json = await res.json();

        if (!json.ok) {
          alert(json.message || '刪除失敗');
          return;
        }

        alert('服務組成部分已刪除');
        await loadClientDetail();

      } catch (err) {
        console.error('刪除失敗:', err);
        alert('刪除失敗');
      }
    }

    // 編輯服務組成部分（簡化版，可以擴展）
    function editComponent(componentId) {
      alert('編輯功能開發中，請先刪除後重新新增');
    }

    // 切換任務列表顯示
    async function toggleComponentTasks(componentId) {
      const tasksList = document.getElementById(`tasks-list-${componentId}`);
      const toggleText = document.getElementById(`tasks-toggle-${componentId}`);
      
      if (tasksList.style.display === 'none') {
        // 展開並載入任務
        tasksList.style.display = 'block';
        toggleText.textContent = '收起';
        await loadComponentTasks(componentId);
      } else {
        // 收起
        tasksList.style.display = 'none';
        toggleText.textContent = '展開';
      }
    }

    // 載入服務組成的任務列表
    async function loadComponentTasks(componentId) {
      const container = document.getElementById(`tasks-list-${componentId}`);
      
      try {
        const res = await fetch(`/internal/api/v1/tasks?component_id=${componentId}`);
        const json = await res.json();
        
        if (!json.ok) {
          container.innerHTML = '<p style="color: #ef4444; font-size: 13px;">載入失敗</p>';
          return;
        }

        const tasks = json.data || [];
        
        if (tasks.length === 0) {
          container.innerHTML = '<p style="color: #6b7280; font-size: 13px;">尚未生成任務（任務會在接近期限時自動生成）</p>';
          return;
        }

        // 渲染任務列表
        container.innerHTML = tasks.map(task => {
          const statusColors = {
            'pending': { bg: '#fef3c7', text: '#92400e', label: '待處理' },
            'in_progress': { bg: '#dbeafe', text: '#1e40af', label: '進行中' },
            'completed': { bg: '#d1fae5', text: '#065f46', label: '已完成' },
            'cancelled': { bg: '#f3f4f6', text: '#6b7280', label: '已取消' }
          };
          
          const statusStyle = statusColors[task.status] || statusColors['pending'];
          
          return `
            <div style="background: #f9fafb; padding: 10px; border-radius: 6px; margin-bottom: 6px; font-size: 13px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                  <strong style="color: #1f2937;">${task.task_name}</strong>
                  <div style="color: #6b7280; margin-top: 4px; display: flex; gap: 12px;">
                    <span>📅 截止：${task.due_date || '-'}</span>
                    <span>👤 負責：${task.assignee_name || '未分配'}</span>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="background: ${statusStyle.bg}; color: ${statusStyle.text}; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                    ${statusStyle.label}
                  </span>
                  <a href="/internal/tasks?task_id=${task.task_id}" class="table-btn-link" style="font-size: 12px;" target="_blank">查看</a>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
      } catch (err) {
        console.error('載入任務失敗:', err);
        container.innerHTML = '<p style="color: #ef4444; font-size: 13px;">載入失敗</p>';
      }
    }

    // 暴露函數到全局
    window.showComponentsSection = showComponentsSection;
    window.loadComponentsInline = loadComponentsInline;
    window.showAddComponentForm = showAddComponentForm;
    window.cancelAddComponent = cancelAddComponent;
    window.saveNewComponent = saveNewComponent;
    window.deleteComponent = deleteComponent;
    window.editComponent = editComponent;
    window.toggleComponentTasks = toggleComponentTasks;
    window.loadComponentTasks = loadComponentTasks;

    // 取消編輯
    function cancelEdit() {
      window.location.href = '/internal/clients';
    }
    
    // 儲存客戶資料
    async function saveClient() {
      clearFormErrors();
      
      const assigneeValue = document.getElementById('inputAssignee').value;
      const assigneeUserId = assigneeValue ? parseInt(assigneeValue) : 0;
      
      const payload = {
        company_name: document.getElementById('inputCompanyName').value.trim(),
        contact_person_1: document.getElementById('inputContactPerson1').value.trim() || null,
        contact_person_2: document.getElementById('inputContactPerson2').value.trim() || null,
        assignee_user_id: assigneeUserId,
        phone: document.getElementById('inputPhone').value.trim() || null,
        email: document.getElementById('inputEmail').value.trim() || null,
        client_notes: document.getElementById('inputClientNotes').value.trim() || null,
        payment_notes: document.getElementById('inputPaymentNotes').value.trim() || null
      };
      
      // 驗證
      let hasError = false;
      if (!payload.company_name) {
        showFieldError('company_name', '公司名稱為必填');
        hasError = true;
      }
      if (!assigneeUserId || assigneeUserId <= 0) {
        showFieldError('assignee', '請選擇負責人員');
        hasError = true;
      }
      
      if (hasError) return;
      
      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        
        const json = await res.json();
        
        if (!res.ok || !json.ok) {
          if (json.errors && Array.isArray(json.errors)) {
            json.errors.forEach(err => {
              showFieldError(err.field, err.message);
            });
          } else {
            alert(json.message || '儲存失敗');
          }
          return;
        }
        
        alert('已儲存');
        loadClientDetail(); // 重新載入
        
      } catch (err) {
        console.error('儲存失敗:', err);
        alert('儲存失敗，請稍後再試');
      }
    }

    // 顯示欄位錯誤
    function showFieldError(field, message) {
      const errorEl = document.getElementById(`error_${field}`);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
    }

    // 清除表單錯誤
    function clearFormErrors(formPrefix) {
      document.querySelectorAll('.error-message, .error-text').forEach(el => {
        el.textContent = '';
        el.style.display = 'none';
      });
    }

    // ==================== 標籤管理 ====================
    
    let allTags = [];
    window.currentClientTags = [];
    window.selectedTagIds = new Set();
    
    // 載入所有標籤
    async function loadAllTags() {
      try {
        const res = await fetch('/internal/api/v1/tags');
        const json = await res.json();
        if (json.ok && json.data) {
          allTags = json.data;
        }
      } catch (err) {
        console.error('載入標籤失敗:', err);
      }
    }
    
    // 渲染標籤顯示
    function renderTagsDisplay() {
      const container = document.getElementById('tagsDisplay');
      if (!window.currentClientTags || window.currentClientTags.length === 0) {
        container.innerHTML = '<span style="color: #9ca3af;">尚未設定標籤</span>';
      } else {
        container.innerHTML = window.currentClientTags.map(t => 
          `<span style="display: inline-flex; align-items: center; padding: 4px 12px; background: ${t.tag_color || '#6b7280'}; color: white; border-radius: 4px; font-size: 13px;">${t.tag_name}</span>`
        ).join('');
      }
    }
    
    // 顯示標籤管理彈窗
    function showTagsModal() {
      const modal = document.getElementById('tagsModal');
      modal.style.display = 'flex';
      
      // 初始化選中的標籤
      window.selectedTagIds = new Set(window.currentClientTags.map(t => t.tag_id));
      
      // 渲染所有標籤
      renderAllTags();
      renderSelectedTags();
    }
    
    // 關閉標籤管理彈窗
    function closeTagsModal() {
      document.getElementById('tagsModal').style.display = 'none';
      // 關閉時重置新增表單
      const form = document.getElementById('newTagForm');
      if (form.style.display !== 'none') {
        cancelNewTag();
      }
    }
    
    // 切換新增標籤表單
    function toggleNewTagForm() {
      const form = document.getElementById('newTagForm');
      const btn = document.getElementById('btnShowNewTag');
      if (form.style.display === 'none') {
        form.style.display = 'block';
        btn.textContent = '− 取消新增';
      } else {
        form.style.display = 'none';
        btn.textContent = '+ 新增標籤';
        document.getElementById('newTagName').value = '';
        document.getElementById('newTagColor').value = '#3b82f6';
      }
    }
    
    // 取消新增標籤
    function cancelNewTag() {
      const form = document.getElementById('newTagForm');
      const btn = document.getElementById('btnShowNewTag');
      form.style.display = 'none';
      btn.textContent = '+ 新增標籤';
      document.getElementById('newTagName').value = '';
      document.getElementById('newTagColor').value = '#3b82f6';
    }
    
    // 儲存新標籤
    async function saveNewTag() {
      const name = document.getElementById('newTagName').value.trim();
      const color = document.getElementById('newTagColor').value;
      
      if (!name) {
        alert('請輸入標籤名稱');
        return;
      }
      
      if (name.length > 50) {
        alert('標籤名稱不能超過50字');
        return;
      }
      
      try {
        const res = await fetch('/internal/api/v1/tags', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tag_name: name,
            tag_color: color
          })
        });
        
        const json = await res.json();
        if (!json.ok) {
          alert(json.message || '建立失敗');
          return;
        }
        
        alert('標籤已建立');
        cancelNewTag();
        
        // 重新載入所有標籤
        await loadAllTags();
        renderAllTags();
      } catch (err) {
        console.error('建立標籤失敗:', err);
        alert('建立失敗，請稍後再試');
      }
    }
    
    // 渲染所有標籤列表
    function renderAllTags() {
      const container = document.getElementById('allTagsList');
      if (allTags.length === 0) {
        container.innerHTML = '<span style="color: #9ca3af;">暫無標籤</span>';
        return;
      }
      
      container.innerHTML = allTags.map(tag => {
        const isSelected = window.selectedTagIds.has(tag.tag_id);
        return `
          <button type="button" 
                  onclick="toggleTag(${tag.tag_id})"
                  style="display: inline-flex; align-items: center; padding: 6px 14px; 
                         background: ${isSelected ? tag.tag_color || '#3b82f6' : '#f3f4f6'}; 
                         color: ${isSelected ? 'white' : '#374151'}; 
                         border: ${isSelected ? 'none' : '1px solid #d1d5db'};
                         border-radius: 4px; font-size: 13px; cursor: pointer; 
                         transition: all 0.2s;">
            ${isSelected ? '✓ ' : ''}${tag.tag_name}
          </button>
        `;
      }).join('');
    }
    
    // 渲染已選標籤
    function renderSelectedTags() {
      const container = document.getElementById('selectedTagsList');
      const selectedTags = allTags.filter(t => window.selectedTagIds.has(t.tag_id));
      
      if (selectedTags.length === 0) {
        container.innerHTML = '<span style="color: #9ca3af;">尚未選擇標籤</span>';
      } else {
        container.innerHTML = selectedTags.map(tag => 
          `<span style="display: inline-flex; align-items: center; padding: 4px 12px; 
                  background: ${tag.tag_color || '#6b7280'}; color: white; 
                  border-radius: 4px; font-size: 13px;">
            ${tag.tag_name}
          </span>`
        ).join('');
      }
    }
    
    // 切換標籤選擇狀態
    function toggleTag(tagId) {
      if (window.selectedTagIds.has(tagId)) {
        window.selectedTagIds.delete(tagId);
      } else {
        window.selectedTagIds.add(tagId);
      }
      renderAllTags();
      renderSelectedTags();
    }
    
    // 儲存標籤
    async function saveTags() {
      const tagIds = Array.from(window.selectedTagIds);
      
      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}/tags`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tag_ids: tagIds })
        });
        
        const json = await res.json();
        if (!json.ok) {
          alert(json.message || '儲存失敗');
          return;
        }
        
        alert('標籤已更新');
        closeTagsModal();
        
        // 重新載入客戶資料
        await loadClientDetail();
        
      } catch (err) {
        console.error('儲存標籤失敗:', err);
        alert('儲存失敗');
      }
    }

    // 點擊Modal外部關閉
    window.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });

    // 初始化
    init();
  </script>
</body>
</html>


