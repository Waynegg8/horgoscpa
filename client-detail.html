<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®¢æˆ¶è©³æƒ… - å…§éƒ¨ç³»çµ±</title>
  <link rel="stylesheet" href="/assets/css/common.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-system.css?v=3">
  <link rel="stylesheet" href="/assets/css/internal-components.css?v=3">
  <link rel="stylesheet" href="/assets/css/client-detail-page.css?v=30">
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="page-container">
    <div class="page-header-simple">
      <a href="/internal/clients" class="back-link">â† è¿”å›å®¢æˆ¶åˆ—è¡¨</a>
      <h1 class="page-title" id="clientTitle">å®¢æˆ¶è³‡æ–™</h1>
    </div>

    <!-- å®¢æˆ¶åŸºæœ¬ä¿¡æ¯ - å¯ç·¨è¼¯è¡¨å–® -->
    <div class="content-card">
      <h2 class="card-title">åŸºæœ¬ä¿¡æ¯</h2>
      <form id="clientForm" class="edit-form">
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputCompanyName">å…¬å¸åç¨±ï¼ˆå¿…å¡«ï¼‰</label>
            <input type="text" id="inputCompanyName" required />
            <span class="error-text" id="error_company_name"></span>
          </div>
          <div class="form-field">
            <label for="inputTaxId">çµ±ä¸€ç·¨è™Ÿ</label>
            <input type="text" id="inputTaxId" maxlength="8" />
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputAssignee">è² è²¬äººå“¡</label>
            <select id="inputAssignee">
              <option value="">è¼‰å…¥ä¸­...</option>
            </select>
            <span class="error-text" id="error_assignee"></span>
          </div>
          <div class="form-field">
            <label for="inputPhone">è¯çµ¡é›»è©±</label>
            <input type="text" id="inputPhone" />
            <span class="error-text" id="error_phone"></span>
          </div>
        </div>
        <div class="form-row-2col">
          <div class="form-field">
            <label for="inputEmail">Email</label>
            <input type="email" id="inputEmail" />
            <span class="error-text" id="error_email"></span>
          </div>
          <div class="form-field">
            <label>æ¨™ç±¤</label>
            <div id="tagsDisplay">-</div>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputClientNotes">å®¢æˆ¶å‚™è¨»</label>
            <textarea id="inputClientNotes" rows="3"></textarea>
          </div>
        </div>
        <div class="form-row-1col">
          <div class="form-field">
            <label for="inputPaymentNotes">æ”¶æ¬¾å‚™è¨»</label>
            <textarea id="inputPaymentNotes" rows="3"></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="cancelEdit()">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="saveClient()">å„²å­˜è®Šæ›´</button>
        </div>
      </form>
    </div>

    <!-- å®¢æˆ¶æœå‹™ -->
    <div class="content-card">
      <div class="card-header-with-action">
        <h2 class="card-title">å®¢æˆ¶æœå‹™</h2>
        <button class="btn btn-primary" onclick="showAddServiceRow()">+ æ–°å¢æœå‹™</button>
      </div>
      <div class="table-wrapper">
        <table class="services-table" id="servicesTable">
          <thead>
            <tr>
              <th style="width: 30px;"></th>
              <th>æœå‹™åç¨±</th>
              <th>ç‹€æ…‹</th>
              <th>å¹´åº¦ç¸½é¡</th>
              <th>é–‹å§‹æ—¥æœŸ</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="servicesList">
            <tr>
              <td colspan="7" class="loading-text">è¼‰å…¥ä¸­...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script src="/assets/js/components/bootstrap.js?v=3"></script>
  <script>
    let currentClientId = null;
    let currentEditingServiceId = null;
    let currentBillingServiceId = null;
    let allServices = [];
    let allTemplates = [];

    // é é¢åˆå§‹åŒ–
    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      currentClientId = urlParams.get('id');
      
      if (!currentClientId) {
        alert('ç¼ºå°‘å®¢æˆ¶ID');
        window.location.href = '/internal/clients';
        return;
      }

      // å…ˆåŠ è¼‰æœå‹™é¸é …å’Œæ¨¡æ¿ï¼Œå†åŠ è¼‰å®¢æˆ¶è©³æƒ…
      await Promise.all([
        loadServices(),
        loadTemplates()
      ]);
      
      await loadClientDetail();
    }

    // è¼‰å…¥å®¢æˆ¶è©³æƒ…
    async function loadClientDetail() {
      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}`);
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || 'è¼‰å…¥å¤±æ•—');
          return;
        }

        const client = json.data;
        
        // æ›´æ–°é é¢æ¨™é¡Œ
        document.getElementById('clientTitle').textContent = client.companyName || 'å®¢æˆ¶è³‡æ–™';
        
        // é å¡«è¡¨å–®
        document.getElementById('inputCompanyName').value = client.companyName || '';
        document.getElementById('inputTaxId').value = client.taxId || '';
        document.getElementById('inputPhone').value = client.phone || '';
        document.getElementById('inputEmail').value = client.email || '';
        document.getElementById('inputClientNotes').value = client.clientNotes || '';
        document.getElementById('inputPaymentNotes').value = client.paymentNotes || '';
        
        // è¼‰å…¥ä¸¦è¨­ç½®è² è²¬äºº
        await loadEmployees();
        document.getElementById('inputAssignee').value = client.assigneeUserId || '';
        
        // æ¨™ç±¤é¡¯ç¤º
        if (client.tags && client.tags.length > 0) {
          document.getElementById('tagsDisplay').innerHTML = client.tags.map(t => 
            `<span class="tag">${t.tag_name}</span>`
          ).join(' ');
        } else {
          document.getElementById('tagsDisplay').textContent = '-';
        }

        // é¡¯ç¤ºæœå‹™åˆ—è¡¨
        renderServices(client.services || []);
        
      } catch (err) {
        console.error('è¼‰å…¥å®¢æˆ¶è©³æƒ…å¤±æ•—:', err);
        alert('è¼‰å…¥å¤±æ•—');
      }
    }
    
    // è¼‰å…¥å“¡å·¥åˆ—è¡¨
    async function loadEmployees() {
      try {
        const res = await fetch('/internal/api/v1/users');
        const json = await res.json();
        
        if (json.ok && json.data) {
          const select = document.getElementById('inputAssignee');
          select.innerHTML = '<option value="">è«‹é¸æ“‡è² è²¬äººå“¡</option>' +
            json.data.map(u => 
              `<option value="${u.user_id}">${u.name || u.username}</option>`
            ).join('');
        }
      } catch (err) {
        console.error('è¼‰å…¥å“¡å·¥åˆ—è¡¨å¤±æ•—:', err);
      }
    }

    // æ¸²æŸ“æœå‹™åˆ—è¡¨
    function renderServices(services) {
      const tbody = document.getElementById('servicesList');
      
      console.log('æ¸²æŸ“æœå‹™åˆ—è¡¨ï¼ŒallServicesæ•¸é‡:', allServices.length);
      
      const serviceOptions = allServices && allServices.length > 0
        ? allServices.map(s => 
            `<option value="${s.service_id}">${s.service_name}</option>`
          ).join('')
        : '';
      
      console.log('å¯ç”¨æœå‹™é¸é …æ•¸é‡:', serviceOptions ? serviceOptions.split('</option>').length - 1 : 0);
      
      const addServiceRowHtml = `
        <tr id="add-service-row" style="display: none;">
          <td></td>
          <td>
            <select id="new-service-id" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="">è«‹é¸æ“‡æœå‹™</option>
              ${serviceOptions}
            </select>
          </td>
          <td>
            <select id="new-service-status" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="active">ä½¿ç”¨ä¸­</option>
              <option value="suspended">æš«åœ</option>
              <option value="expired">å·²åˆ°æœŸ</option>
              <option value="cancelled">å·²å–æ¶ˆ</option>
            </select>
          </td>
          <td>-</td>
          <td>
            <input type="date" id="new-service-start-date" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </td>
          <td>
            <button class="table-btn-link" onclick="saveNewService()">å„²å­˜</button>
            <button class="table-btn-link danger" onclick="cancelAddService()">å–æ¶ˆ</button>
          </td>
        </tr>
      `;
      
      if (!services || services.length === 0) {
        tbody.innerHTML = addServiceRowHtml + '<tr><td colspan="6" class="no-data">æš«ç„¡æœå‹™</td></tr>';
        return;
      }

      const serviceRows = services.map((svc, index) => {
        const statusClass = {
          'active': 'status-active',
          'suspended': 'status-suspended',
          'expired': 'status-expired',
          'cancelled': 'status-cancelled'
        }[svc.status] || '';
        
        const statusText = {
          'active': 'ä½¿ç”¨ä¸­',
          'suspended': 'æš«åœ',
          'expired': 'å·²åˆ°æœŸ',
          'cancelled': 'å·²å–æ¶ˆ'
        }[svc.status] || svc.status;

        return `
          <tr class="service-main-row">
            <td class="expand-cell">
              <button class="expand-btn" onclick="toggleBilling(${index}, ${svc.client_service_id})">
                <span class="expand-icon" id="expand-icon-${index}">â–¶</span>
              </button>
            </td>
            <td><strong>${svc.service_name || '-'}</strong></td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td class="amount">$${(svc.year_total || 0).toLocaleString('zh-TW')}</td>
            <td>${svc.start_date || '-'}</td>
            <td class="actions-cell">
              <button type="button" class="table-btn table-btn-primary" onclick="showComponentsSection(${index}, ${svc.client_service_id})">é…ç½®æœå‹™å…§å®¹</button>
              <button type="button" class="table-btn table-btn-secondary" onclick="showAddBillingRow(${svc.client_service_id})">æ”¶è²»è¨­å®š</button>
              <button type="button" class="table-btn table-btn-secondary" onclick="editService(${svc.client_service_id})">ç·¨è¼¯</button>
              <button type="button" class="table-btn table-btn-danger" onclick="deleteService(${svc.client_service_id}, '${svc.service_name}')">åˆªé™¤</button>
            </td>
          </tr>
          <tr class="billing-detail-row" id="billing-row-${index}" style="display: none;">
            <td colspan="6" class="billing-detail-cell">
              <div class="billing-content" id="billing-content-${index}">
                <p class="loading-text">è¼‰å…¥ä¸­...</p>
              </div>
            </td>
          </tr>
          <tr class="component-detail-row" id="component-row-${index}" style="display: none;">
            <td colspan="6" class="component-detail-cell">
              <div class="component-content" id="component-content-${index}">
                <p class="loading-text">è¼‰å…¥ä¸­...</p>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = addServiceRowHtml + serviceRows;
      
      // åˆå§‹è¼‰å…¥æ‰€æœ‰æ”¶è²»æ˜ç´°
      services.forEach((svc, index) => {
        loadBillingInline(index, svc.client_service_id);
      });
    }

    // åˆ‡æ›æ”¶è²»æ˜ç´°é¡¯ç¤º
    function toggleBilling(index, clientServiceId) {
      const detailRow = document.getElementById(`billing-row-${index}`);
      const icon = document.getElementById(`expand-icon-${index}`);
      
      if (detailRow.style.display === 'none') {
        detailRow.style.display = 'table-row';
        icon.textContent = 'â–¼';
      } else {
        detailRow.style.display = 'none';
        icon.textContent = 'â–¶';
      }
    }

    // è¼‰å…¥å…§åµŒæ”¶è²»æ˜ç´°
    async function loadBillingInline(index, clientServiceId) {
      const container = document.getElementById(`billing-content-${index}`);
      
      try {
        const res = await fetch(`/internal/api/v1/billing/service/${clientServiceId}`);
        const json = await res.json();
        
        if (!json.ok) {
          container.innerHTML = '<p class="error-text">è¼‰å…¥å¤±æ•—</p>';
          return;
        }

        const schedules = json.data.schedules || [];
        
        // æ’åºbyæœˆä»½
        schedules.sort((a, b) => a.billing_month - b.billing_month);

        container.innerHTML = `
          <table class="billing-table" id="billing-table-${clientServiceId}">
            <thead>
              <tr>
                <th style="width: 80px;">æœˆä»½</th>
                <th>é‡‘é¡</th>
                <th style="width: 100px;">æœŸé™</th>
                <th>å‚™è¨»</th>
                <th style="width: 130px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${schedules.map(s => `
                <tr data-schedule-id="${s.schedule_id}">
                  <td>${s.billing_month}æœˆ</td>
                  <td class="amount">$${s.billing_amount.toLocaleString('zh-TW')}</td>
                  <td>${s.payment_due_days}å¤©</td>
                  <td>${s.notes || '-'}</td>
                  <td>
                    <button class="table-btn-link" onclick="startEditBilling(${clientServiceId}, ${s.schedule_id}, ${s.billing_month}, ${s.billing_amount}, ${s.payment_due_days}, '${(s.notes || '').replace(/'/g, "\\'")}')">ç·¨è¼¯</button>
                    <button class="table-btn-link danger" onclick="deleteBillingInline(${clientServiceId}, ${s.schedule_id}, ${s.billing_month})">åˆªé™¤</button>
                  </td>
                </tr>
              `).join('')}
              <tr id="add-row-${clientServiceId}" style="display: none;"></tr>
            </tbody>
          </table>
        `;
        
      } catch (err) {
        console.error('è¼‰å…¥æ”¶è²»æ˜ç´°å¤±æ•—:', err);
        container.innerHTML = '<p class="error-text">è¼‰å…¥å¤±æ•—</p>';
      }
    }

    // æš´éœ²å‡½æ•¸åˆ°å…¨å±€
    window.toggleBilling = toggleBilling;
    window.loadBillingInline = loadBillingInline;

    // è¼‰å…¥æœå‹™é¡å‹é¸é …
    async function loadServices() {
      try {
        const res = await fetch('/internal/api/v1/services');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allServices = json.data;
          console.log('å·²è¼‰å…¥æœå‹™é¸é …:', allServices.length, 'é …');
        }
      } catch (err) {
        console.error('è¼‰å…¥æœå‹™é¸é …å¤±æ•—:', err);
      }
    }

    // è¼‰å…¥ä»»å‹™æ¨¡æ¿é¸é …
    async function loadTemplates() {
      try {
        const res = await fetch('/internal/api/v1/task-templates');
        const json = await res.json();
        
        if (json.ok && json.data) {
          allTemplates = json.data;
          // ä¿å­˜åˆ°å…¨å±€ï¼Œä¾›æ¨¡æ¿é€‰æ‹©æ—¶ä½¿ç”¨
          window.taskTemplatesData = json.data;
        }
      } catch (err) {
        console.error('è¼‰å…¥æ¨¡æ¿é¸é …å¤±æ•—:', err);
      }
    }

    // é¡¯ç¤ºæ–°å¢æœå‹™è¡Œ
    function showAddServiceRow() {
      const addRow = document.getElementById('add-service-row');
      addRow.style.display = 'table-row';
    }

    // å–æ¶ˆæ–°å¢æœå‹™
    function cancelAddService() {
      const addRow = document.getElementById('add-service-row');
      addRow.style.display = 'none';
      document.getElementById('new-service-id').value = '';
      document.getElementById('new-service-status').value = 'active';
      document.getElementById('new-service-start-date').value = '';
    }

    // å„²å­˜æ–°æœå‹™
    async function saveNewService() {
      const serviceId = document.getElementById('new-service-id').value;
      const status = document.getElementById('new-service-status').value;
      const startDate = document.getElementById('new-service-start-date').value;

      console.log('=== æ–°å¢æœå‹™ DEBUG START ===');
      console.log('è¡¨å–®å€¼:', { serviceId, status, startDate });
      console.log('currentClientId:', currentClientId);

      if (!serviceId) {
        alert('è«‹é¸æ“‡æœå‹™');
        return;
      }

      const data = {
        service_id: parseInt(serviceId),
        status: status,
        start_date: startDate || null
      };

      const apiUrl = `/internal/api/v1/clients/${currentClientId}/services`;
      
      console.log('æº–å‚™ç™¼é€è«‹æ±‚:');
      console.log('  - URL:', apiUrl);
      console.log('  - Method: POST');
      console.log('  - Data:', JSON.stringify(data, null, 2));

      try {
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        console.log('æ”¶åˆ°éŸ¿æ‡‰:');
        console.log('  - Status:', res.status);
        console.log('  - URL:', res.url);
        
        const json = await res.json();
        console.log('  - JSON:', json);
        console.log('=== æ–°å¢æœå‹™ DEBUG END ===');
        
        if (!json.ok) {
          if (json.errors && json.errors.length > 0) {
            const errorMsg = json.errors.map(e => `${e.field}: ${e.message}`).join('\n');
            alert(`${json.message}\n\n${errorMsg}`);
          } else {
            alert(json.message || 'æ–°å¢å¤±æ•—');
          }
          return;
        }

        alert('æœå‹™å·²æ–°å¢');
        cancelAddService();
        await loadClientDetail();
        
      } catch (err) {
        console.error('æ–°å¢æœå‹™å¤±æ•—:', err);
        alert('æ“ä½œå¤±æ•—');
      }
    }

    // ç·¨è¼¯æœå‹™ï¼ˆå…§åµŒï¼‰
    async function editService(clientServiceId) {
      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}`);
        const json = await res.json();
        
        if (!json.ok || !json.data) {
          alert('è¼‰å…¥æœå‹™è³‡æ–™å¤±æ•—');
          return;
        }

        const services = json.data.services || [];
        const service = services.find(s => s.client_service_id === clientServiceId);
        if (!service) {
          alert('æ‰¾ä¸åˆ°æœå‹™');
          return;
        }

        const index = services.findIndex(s => s.client_service_id === clientServiceId);
        const serviceRow = document.querySelectorAll('.service-main-row')[index];
        
        serviceRow.innerHTML = `
          <td></td>
          <td>
            <select id="edit-service-id-${clientServiceId}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              ${allServices.map(s => 
                `<option value="${s.service_id}" ${s.service_id == service.service_id ? 'selected' : ''}>${s.service_name}</option>`
              ).join('')}
            </select>
          </td>
          <td>
            <select id="edit-service-status-${clientServiceId}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="active" ${service.status == 'active' ? 'selected' : ''}>ä½¿ç”¨ä¸­</option>
              <option value="suspended" ${service.status == 'suspended' ? 'selected' : ''}>æš«åœ</option>
              <option value="expired" ${service.status == 'expired' ? 'selected' : ''}>å·²åˆ°æœŸ</option>
              <option value="cancelled" ${service.status == 'cancelled' ? 'selected' : ''}>å·²å–æ¶ˆ</option>
            </select>
          </td>
          <td>$${(service.year_total || 0).toLocaleString('zh-TW')}</td>
          <td>
            <input type="date" id="edit-service-start-date-${clientServiceId}" value="${service.start_date || ''}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </td>
          <td>
            <button class="table-btn-link" onclick="saveEditService(${clientServiceId})">å„²å­˜</button>
            <button class="table-btn-link danger" onclick="cancelEditService()">å–æ¶ˆ</button>
          </td>
        `;
      } catch (err) {
        console.error('è¼‰å…¥æœå‹™å¤±æ•—:', err);
        alert('è¼‰å…¥å¤±æ•—');
      }
    }

    // å„²å­˜ç·¨è¼¯çš„æœå‹™
    async function saveEditService(clientServiceId) {
      const serviceId = document.getElementById(`edit-service-id-${clientServiceId}`).value;
      const status = document.getElementById(`edit-service-status-${clientServiceId}`).value;
      const startDate = document.getElementById(`edit-service-start-date-${clientServiceId}`).value;

      const data = {
        service_id: parseInt(serviceId),
        status: status,
        start_date: startDate || null
      };

      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}/services/${clientServiceId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || 'æ›´æ–°å¤±æ•—');
          return;
        }

        alert('æœå‹™å·²æ›´æ–°');
        await loadClientDetail();
        
      } catch (err) {
        console.error('æ›´æ–°æœå‹™å¤±æ•—:', err);
        alert('æ“ä½œå¤±æ•—');
      }
    }

    // å–æ¶ˆç·¨è¼¯æœå‹™
    async function cancelEditService() {
      await loadClientDetail();
    }

    // åˆªé™¤æœå‹™
    async function deleteService(clientServiceId, serviceName) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤æœå‹™ã€Œ${serviceName}ã€å—ï¼Ÿ`)) return;
      
      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}/services/${clientServiceId}`, {
          method: 'DELETE'
        });
        
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || 'åˆªé™¤å¤±æ•—');
          return;
        }

        alert('æœå‹™å·²åˆªé™¤');
        await loadClientDetail();
        
      } catch (err) {
        console.error('åˆªé™¤æœå‹™å¤±æ•—:', err);
        alert('åˆªé™¤å¤±æ•—');
      }
    }

    // é¡¯ç¤ºæ–°å¢æ”¶è²»è¡Œ
    async function showAddBillingRow(clientServiceId) {
      // ç²å–ç•¶å‰å®¢æˆ¶çš„æ‰€æœ‰æœå‹™
      const res = await fetch(`/internal/api/v1/clients/${currentClientId}`);
      const json = await res.json();
      
      if (!json.ok) {
        alert('è¼‰å…¥æœå‹™å¤±æ•—');
        return;
      }
      
      const services = json.data.services || [];
      const index = services.findIndex(s => s.client_service_id === clientServiceId);
      
      if (index === -1) {
        alert('æ‰¾ä¸åˆ°è©²æœå‹™');
        return;
      }
      
      // è‡ªå‹•å±•é–‹æ”¶è²»æ˜ç´°è¡Œ
      const detailRow = document.getElementById(`billing-row-${index}`);
      const icon = document.getElementById(`expand-icon-${index}`);
      
      if (detailRow.style.display === 'none') {
        detailRow.style.display = 'table-row';
        icon.textContent = 'â–¼';
      }
      
      // é¡¯ç¤ºæ–°å¢è¡¨å–®
      const addRow = document.getElementById(`add-row-${clientServiceId}`);
      addRow.style.display = 'table-row';
      addRow.innerHTML = `
        <td>
          <input type="number" id="new-month-${clientServiceId}" placeholder="æœˆä»½" min="1" max="12" required />
        </td>
        <td>
          <input type="number" id="new-amount-${clientServiceId}" placeholder="é‡‘é¡" step="0.01" min="0" required />
        </td>
        <td>
          <input type="number" id="new-due-${clientServiceId}" value="30" min="1" required />
        </td>
        <td>
          <input type="text" id="new-notes-${clientServiceId}" placeholder="å‚™è¨»" />
        </td>
        <td>
          <button class="table-btn-link" onclick="saveBilling(${clientServiceId}, null)">å„²å­˜</button>
          <button class="table-btn-link danger" onclick="cancelBillingEdit(${clientServiceId}, null)">å–æ¶ˆ</button>
        </td>
      `;
    }

    // é–‹å§‹ç·¨è¼¯æ”¶è²»æ˜ç´°
    function startEditBilling(clientServiceId, scheduleId, month, amount, dueDays, notes) {
      const row = document.querySelector(`[data-schedule-id="${scheduleId}"]`);
      row.innerHTML = `
        <td>
          <input type="number" id="edit-month-${scheduleId}" value="${month}" min="1" max="12" required />
        </td>
        <td>
          <input type="number" id="edit-amount-${scheduleId}" value="${amount}" step="0.01" min="0" required />
        </td>
        <td>
          <input type="number" id="edit-due-${scheduleId}" value="${dueDays}" min="1" required />
        </td>
        <td>
          <input type="text" id="edit-notes-${scheduleId}" value="${notes}" placeholder="å‚™è¨»" />
        </td>
        <td>
          <button class="table-btn-link" onclick="saveBilling(${clientServiceId}, ${scheduleId})">å„²å­˜</button>
          <button class="table-btn-link danger" onclick="cancelBillingEdit(${clientServiceId}, ${scheduleId})">å–æ¶ˆ</button>
        </td>
      `;
    }

    // å„²å­˜æ”¶è²»æ˜ç´°ï¼ˆæ–°å¢æˆ–ç·¨è¼¯ï¼‰
    async function saveBilling(clientServiceId, scheduleId) {
      const isEdit = scheduleId !== null;
      
      let month, amount, dueDays, notes;
      
      if (isEdit) {
        month = document.getElementById(`edit-month-${scheduleId}`).value;
        amount = document.getElementById(`edit-amount-${scheduleId}`).value;
        dueDays = document.getElementById(`edit-due-${scheduleId}`).value;
        notes = document.getElementById(`edit-notes-${scheduleId}`).value;
      } else {
        month = document.getElementById(`new-month-${clientServiceId}`).value;
        amount = document.getElementById(`new-amount-${clientServiceId}`).value;
        dueDays = document.getElementById(`new-due-${clientServiceId}`).value;
        notes = document.getElementById(`new-notes-${clientServiceId}`).value;
      }
      
      if (!month || !amount || !dueDays) {
        alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½');
        return;
      }
      
      const data = {
        billing_month: parseInt(month),
        billing_amount: parseFloat(amount),
        payment_due_days: parseInt(dueDays),
        notes: notes || null
      };
      
      try {
        const url = isEdit 
          ? `/internal/api/v1/billing/${scheduleId}`
          : `/internal/api/v1/billing/service/${clientServiceId}`;
        
        const res = await fetch(url, {
          method: isEdit ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || 'æ“ä½œå¤±æ•—');
          return;
        }

        alert(isEdit ? 'æ”¶è²»æ˜ç´°å·²æ›´æ–°' : 'æ”¶è²»æ˜ç´°å·²æ–°å¢');
        
        // é‡æ–°è¼‰å…¥è©²æœå‹™çš„æ”¶è²»æ˜ç´°
        const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
        const index = services.findIndex(s => s.client_service_id === clientServiceId);
        if (index !== -1) {
          await loadBillingInline(index, clientServiceId);
        }
        
        // é‡æ–°è¼‰å…¥å®¢æˆ¶ä»¥æ›´æ–°å¹´åº¦ç¸½é¡
        await loadClientDetail();
        
      } catch (err) {
        console.error('å„²å­˜æ”¶è²»æ˜ç´°å¤±æ•—:', err);
        alert('æ“ä½œå¤±æ•—');
      }
    }

    // å–æ¶ˆç·¨è¼¯æ”¶è²»æ˜ç´°
    async function cancelBillingEdit(clientServiceId, scheduleId) {
      // é‡æ–°è¼‰å…¥è©²æœå‹™çš„æ”¶è²»æ˜ç´°
      const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
      const index = services.findIndex(s => s.client_service_id === clientServiceId);
      if (index !== -1) {
        await loadBillingInline(index, clientServiceId);
      }
    }

    // åˆªé™¤æ”¶è²»æ˜ç´°ï¼ˆå…§åµŒï¼‰
    async function deleteBillingInline(clientServiceId, scheduleId, month) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤${month}æœˆçš„æ”¶è²»æ˜ç´°å—ï¼Ÿ`)) return;
      
      try {
        const res = await fetch(`/internal/api/v1/billing/${scheduleId}`, {
          method: 'DELETE'
        });
        
        const json = await res.json();
        
        if (!json.ok) {
          alert(json.message || 'åˆªé™¤å¤±æ•—');
          return;
        }

        alert('æ”¶è²»æ˜ç´°å·²åˆªé™¤');
        
        // é‡æ–°è¼‰å…¥è©²æœå‹™çš„æ”¶è²»æ˜ç´°
        const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
        const index = services.findIndex(s => s.client_service_id === clientServiceId);
        if (index !== -1) {
          await loadBillingInline(index, clientServiceId);
        }
        
        // é‡æ–°è¼‰å…¥å®¢æˆ¶ä»¥æ›´æ–°å¹´åº¦ç¸½é¡
        await loadClientDetail();
        
      } catch (err) {
        console.error('åˆªé™¤æ”¶è²»æ˜ç´°å¤±æ•—:', err);
        alert('åˆªé™¤å¤±æ•—');
      }
    }

    // æš´éœ²å‡½æ•¸åˆ°å…¨å±€
    window.showAddBillingRow = showAddBillingRow;
    window.startEditBilling = startEditBilling;
    window.saveBilling = saveBilling;
    window.cancelBillingEdit = cancelBillingEdit;
    window.deleteBillingInline = deleteBillingInline;

    // ==================== æœå‹™çµ„æˆéƒ¨åˆ†ç®¡ç† ====================

    // é¡¯ç¤ºæœå‹™çµ„æˆéƒ¨åˆ†é…ç½®å€åŸŸ
    async function showComponentsSection(index, clientServiceId) {
      const componentRow = document.getElementById(`component-row-${index}`);
      
      if (componentRow.style.display === 'none') {
        componentRow.style.display = 'table-row';
        await loadComponentsInline(index, clientServiceId);
      } else {
        componentRow.style.display = 'none';
      }
    }

    // è¼‰å…¥æœå‹™çµ„æˆéƒ¨åˆ†åˆ—è¡¨
    async function loadComponentsInline(index, clientServiceId) {
      const container = document.getElementById(`component-content-${index}`);
      
      try {
        const res = await fetch(`/internal/api/v1/client-services/${clientServiceId}/components`);
        const json = await res.json();
        
        if (!json.ok) {
          container.innerHTML = '<p class="error-text">è¼‰å…¥å¤±æ•—</p>';
          return;
        }

        const components = json.data || [];
        
        // ç²å–æœå‹™å’Œæ¨¡æ¿é¸é …
        const servicesHtml = allServices.map(s => `<option value="${s.service_id}">${s.service_name}</option>`).join('');
        const templatesHtml = allTemplates.map(t => `<option value="${t.template_id}">${t.template_name}</option>`).join('');

        container.innerHTML = `
          <div style="padding: 20px; background: #f9fafb; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h4 style="margin: 0;">ğŸ“¦ æœå‹™åŒ…å«å…§å®¹</h4>
              <button class="table-btn table-btn-primary" onclick="showAddComponentForm(${clientServiceId})">+ æ–°å¢æœå‹™é …ç›®</button>
            </div>
            
            <div id="add-component-form-${clientServiceId}" style="display: none; background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #3b82f6;">
              <h5 style="margin-top: 0;">æ–°å¢æœå‹™çµ„æˆéƒ¨åˆ†</h5>
              <div class="form-row-2col">
                <div class="form-field">
                  <label>æœå‹™åç¨±</label>
                  <input type="text" id="new-comp-name-${clientServiceId}" placeholder="ä¾‹å¦‚ï¼šæ¯æœˆè¨˜å¸³" />
                </div>
                <div class="form-field">
                  <label>æœå‹™é¡å‹</label>
                  <select id="new-comp-service-${clientServiceId}" onchange="updateTemplateOptions${clientServiceId}(this.value)">
                    <option value="">è«‹é¸æ“‡</option>
                    ${servicesHtml}
                  </select>
                </div>
              </div>
              <div class="form-row-2col">
                <div class="form-field">
                  <label>æä¾›é »ç‡</label>
                  <select id="new-comp-freq-${clientServiceId}">
                    <option value="monthly">æ¯æœˆ</option>
                    <option value="bi-monthly">æ¯å…©å€‹æœˆ</option>
                    <option value="quarterly">æ¯å­£</option>
                    <option value="yearly">æ¯å¹´</option>
                    <option value="one-time">ä¸€æ¬¡æ€§</option>
                  </select>
                </div>
                <div class="form-field">
                  <label>ä»»å‹™æ¨¡æ¿</label>
                  <select id="new-comp-template-${clientServiceId}" onchange="loadTemplateStages${clientServiceId}(this.value)">
                    <option value="">è«‹å…ˆé¸æ“‡æœå‹™é¡å‹</option>
                  </select>
                  <small style="display: block; margin-top: 5px; color: #3b82f6;">
                    âœ¨ é¸æ“‡æ¨¡æ¿å¾Œï¼Œæœƒè‡ªå‹•å¸¶å…¥å»ºè­°çš„æœŸé™è¦å‰‡ï¼Œæ‚¨å¯ä»¥å†èª¿æ•´
                  </small>
                </div>
              </div>
              
              <!-- ç‹¬ç«‹ä»»åŠ¡åˆ—è¡¨ -->
              <div id="template-stages-${clientServiceId}" style="display: none; margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <div>
                    <strong style="color: #856404; font-size: 15px;">ğŸ“‹ å°‡è‡ªå‹•ç”Ÿæˆä»¥ä¸‹ç¨ç«‹ä»»å‹™</strong>
                    <p style="margin: 5px 0 0 0; font-size: 13px; color: #856404;">æ¯å€‹ä»»å‹™å¯å–®ç¨è¨­å®šæœŸé™å’Œé ä¼°å·¥æ™‚</p>
                  </div>
                  <button type="button" class="table-btn table-btn-secondary" onclick="addCustomTask${clientServiceId}()">+ æ–°å¢ä»»å‹™</button>
                </div>
                <div id="stages-list-${clientServiceId}">
                  <!-- ä»»åŠ¡åˆ—è¡¨ä¼šåŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
                </div>
              </div>
              
              <!-- æ‰‹åŠ¨é…ç½®ä»»åŠ¡åŒºåŸŸï¼ˆä¸ä½¿ç”¨æ¨¡æ¿æ—¶æ˜¾ç¤ºï¼‰ -->
              <div id="manual-tasks-${clientServiceId}" style="display: none; margin-top: 15px; padding: 15px; background: #f3f4f6; border-radius: 8px; border: 2px solid #9ca3af;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <div>
                    <strong style="color: #374151; font-size: 15px;">ğŸ“ æ‰‹å‹•é…ç½®ä»»å‹™</strong>
                    <p style="margin: 5px 0 0 0; font-size: 13px; color: #6b7280;">æœªä½¿ç”¨æ¨¡æ¿ï¼Œè«‹æ‰‹å‹•æ·»åŠ ä»»å‹™</p>
                  </div>
                  <button type="button" class="table-btn table-btn-primary" onclick="addCustomTask${clientServiceId}()">+ æ–°å¢ä»»å‹™</button>
                </div>
                <div id="manual-tasks-list-${clientServiceId}">
                  <!-- æ‰‹åŠ¨ä»»åŠ¡åˆ—è¡¨ -->
                </div>
              </div>
              
              <div class="form-field">
                <label>å‚™è¨»</label>
                <textarea id="new-comp-notes-${clientServiceId}" rows="2"></textarea>
              </div>
              <div style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="saveNewComponent(${clientServiceId})">å„²å­˜</button>
                <button class="btn btn-secondary" onclick="cancelAddComponent(${clientServiceId})">å–æ¶ˆ</button>
              </div>
            </div>
            
            ${components.length === 0 ? '<p style="color: #6b7280;">æš«ç„¡æœå‹™çµ„æˆéƒ¨åˆ†ï¼Œè«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢</p>' : ''}
            
            ${components.map((comp, i) => `
              <div class="component-item" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #3b82f6;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div style="flex: 1;">
                    <h5 style="margin: 0 0 10px 0; color: #1f2937;">${comp.component_name}</h5>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 14px; color: #6b7280;">
                      <div>ğŸ“‹ <strong>æœå‹™é¡å‹ï¼š</strong>${comp.service_name || '-'}</div>
                      <div>ğŸ”„ <strong>æä¾›é »ç‡ï¼š</strong>${getFrequencyText(comp.delivery_frequency)}</div>
                      <div>ğŸ“ <strong>ä»»å‹™æ¨¡æ¿ï¼š</strong>${comp.template_name || 'ç„¡'}</div>
                      <div>â° <strong>é ä¼°å·¥æ™‚ï¼š</strong>${comp.estimated_hours || '-'}å°æ™‚</div>
                      <div>ğŸ“… <strong>æœŸé™è¦å‰‡ï¼š</strong>${getDueRuleText(comp.due_date_rule)}</div>
                      <div>âš¡ <strong>æå‰ç”Ÿæˆï¼š</strong>${comp.advance_days}å¤©</div>
                    </div>
                    ${comp.notes ? `<div style="margin-top: 8px; font-size: 13px; color: #9ca3af;">ğŸ’¡ ${comp.notes}</div>` : ''}
                    
                    <!-- ä»»åŠ¡æ˜ç»†åŒºåŸŸ -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong style="font-size: 13px; color: #374151;">ğŸ“‹ ç›¸é—œä»»å‹™</strong>
                        <button class="table-btn-link" onclick="toggleComponentTasks(${comp.component_id})" style="font-size: 12px;">
                          <span id="tasks-toggle-${comp.component_id}">å±•é–‹</span>
                        </button>
                      </div>
                      <div id="tasks-list-${comp.component_id}" style="display: none; margin-top: 8px;">
                        <div class="loading-text" style="font-size: 13px;">è¼‰å…¥ä¸­...</div>
                      </div>
                    </div>
                  </div>
                  <div style="display: flex; gap: 5px;">
                    <button class="table-btn-link" onclick="editComponent(${comp.component_id})">ç·¨è¼¯</button>
                    <button class="table-btn-link danger" onclick="deleteComponent(${comp.component_id}, '${comp.component_name}')">åˆªé™¤</button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        
      } catch (err) {
        console.error('è¼‰å…¥æœå‹™çµ„æˆéƒ¨åˆ†å¤±æ•—:', err);
        container.innerHTML = '<p class="error-text">è¼‰å…¥å¤±æ•—</p>';
      }
    }

    // è¼”åŠ©å‡½æ•¸ï¼šé »ç‡æ–‡å­—
    function getFrequencyText(freq) {
      const map = {
        'monthly': 'æ¯æœˆ',
        'bi-monthly': 'æ¯å…©å€‹æœˆ',
        'quarterly': 'æ¯å­£',
        'yearly': 'æ¯å¹´',
        'one-time': 'ä¸€æ¬¡æ€§'
      };
      return map[freq] || freq;
    }

    // è¼”åŠ©å‡½æ•¸ï¼šæœŸé™è¦å‰‡æ–‡å­—
    function getDueRuleText(rule) {
      const map = {
        'end_of_month': 'ç•¶æœˆæœˆåº•',
        'specific_day': 'ç•¶æœˆæŒ‡å®šæ—¥',
        'next_month_day': 'æ¬¡æœˆæŒ‡å®šæ—¥',
        'days_after_start': 'ç›¸å°å¤©æ•¸'
      };
      return map[rule] || '-';
    }

    // é¡¯ç¤ºæ–°å¢è¡¨å–®
    function showAddComponentForm(clientServiceId) {
      const form = document.getElementById(`add-component-form-${clientServiceId}`);
      form.style.display = 'block';
      
      // åˆ›å»ºæœŸé™æ—¥æœŸé¢„è§ˆå‡½æ•°
      window[`updateDueDatePreview${clientServiceId}`] = function() {
        const rule = document.getElementById(`new-comp-due-rule-${clientServiceId}`).value;
        const value = document.getElementById(`new-comp-due-value-${clientServiceId}`).value;
        const previewText = document.getElementById(`preview-text-${clientServiceId}`);
        const valueField = document.getElementById(`due-value-field-${clientServiceId}`);
        
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth() + 1;
        const nextMonth = currentMonth === 12 ? 1 : currentMonth + 1;
        
        let examples = [];
        
        switch(rule) {
          case 'end_of_month':
            valueField.style.display = 'none';
            examples = [
              `1æœˆåŸ·è¡Œ â†’ 1/31åˆ°æœŸ`,
              `2æœˆåŸ·è¡Œ â†’ 2/28åˆ°æœŸ`,
              `3æœˆåŸ·è¡Œ â†’ 3/31åˆ°æœŸ`
            ];
            previewText.innerHTML = examples.join('<br>');
            break;
            
          case 'specific_day':
            valueField.style.display = 'block';
            if (value && value >= 1 && value <= 31) {
              examples = [
                `1æœˆåŸ·è¡Œ â†’ 1/${value}åˆ°æœŸ`,
                `2æœˆåŸ·è¡Œ â†’ 2/${value}åˆ°æœŸ`,
                `${currentMonth}æœˆåŸ·è¡Œ â†’ ${currentMonth}/${value}åˆ°æœŸ`
              ];
              previewText.innerHTML = `<span style="color: #059669; font-weight: 600;">æ¯æœˆ${value}æ—¥åˆ°æœŸ</span><br><span style="font-size: 13px;">${examples.join(' | ')}</span>`;
            } else {
              previewText.innerHTML = 'è«‹è¼¸å…¥1-31çš„æ—¥æœŸï¼Œä¾‹å¦‚ï¼š5ï¼ˆä»£è¡¨æ¯æœˆ5æ—¥åˆ°æœŸï¼‰';
              previewText.style.color = '#9ca3af';
            }
            break;
            
          case 'next_month_day':
            valueField.style.display = 'block';
            if (value && value >= 1 && value <= 31) {
              examples = [
                `1æœˆåŸ·è¡Œ â†’ 2/${value}åˆ°æœŸ`,
                `2æœˆåŸ·è¡Œ â†’ 3/${value}åˆ°æœŸ`,
                `${currentMonth}æœˆåŸ·è¡Œ â†’ ${nextMonth}/${value}åˆ°æœŸ`
              ];
              previewText.innerHTML = `<span style="color: #059669; font-weight: 600;">æ¬¡æœˆ${value}æ—¥åˆ°æœŸ</span><br><span style="font-size: 13px;">${examples.join(' | ')}</span>`;
            } else {
              previewText.innerHTML = 'è«‹è¼¸å…¥1-31çš„æ—¥æœŸï¼Œä¾‹å¦‚ï¼š15ï¼ˆä»£è¡¨æ¬¡æœˆ15æ—¥åˆ°æœŸï¼‰';
              previewText.style.color = '#9ca3af';
            }
            break;
            
          case 'days_after_start':
            valueField.style.display = 'block';
            if (value && value >= 1) {
              const exampleDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
              exampleDate.setDate(exampleDate.getDate() + parseInt(value));
              examples = [
                `1æœˆ1æ—¥ + ${value}å¤© â†’ ${exampleDate.getMonth() === 0 ? '1' : exampleDate.getMonth() + 1}/${exampleDate.getDate()}`,
                `å¾æ¯æœˆ1æ—¥èµ·ç®—${value}å¤©å¾Œåˆ°æœŸ`
              ];
              previewText.innerHTML = `<span style="color: #059669; font-weight: 600;">æœˆåˆå¾Œ${value}å¤©åˆ°æœŸ</span><br><span style="font-size: 13px;">${examples.join('<br>')}</span>`;
            } else {
              previewText.innerHTML = 'è«‹è¼¸å…¥å¤©æ•¸ï¼Œä¾‹å¦‚ï¼š30ï¼ˆä»£è¡¨å¾æœˆåˆèµ·ç®—30å¤©å¾Œåˆ°æœŸï¼‰';
              previewText.style.color = '#9ca3af';
            }
            break;
        }
      };
      
      // åˆ›å»ºæ ¹æ®æœåŠ¡ç±»å‹æ›´æ–°æ¨¡æ¿é€‰é¡¹çš„å‡½æ•°
      window[`updateTemplateOptions${clientServiceId}`] = function(serviceId) {
        const templateSelect = document.getElementById(`new-comp-template-${clientServiceId}`);
        
        if (!serviceId) {
          templateSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æœå‹™é¡å‹</option>';
          return;
        }
        
        // ç­›é€‰åŒ¹é…çš„æ¨¡æ¿ï¼ˆservice_idåŒ¹é…æˆ–é€šç”¨æ¨¡æ¿service_idä¸ºnullï¼‰
        const filteredTemplates = allTemplates.filter(t => 
          t.service_id == serviceId || t.service_id === null
        );
        
        if (filteredTemplates.length === 0) {
          templateSelect.innerHTML = '<option value="">ä¸ä½¿ç”¨æ¨¡æ¿ï¼ˆæ‰‹å‹•é…ç½®ï¼‰</option>';
        } else {
          templateSelect.innerHTML = '<option value="">ä¸ä½¿ç”¨æ¨¡æ¿ï¼ˆæ‰‹å‹•é…ç½®ï¼‰</option>' + 
            filteredTemplates.map(t => `<option value="${t.template_id}">${t.template_name}</option>`).join('');
        }
        
        // è§¦å‘ä¸€æ¬¡åŠ è½½ä»¥æ˜¾ç¤ºæ‰‹åŠ¨é…ç½®åŒºåŸŸ
        loadTemplateStages${clientServiceId}('');
      };
      
      // åˆ›å»ºåŠ è½½æ¨¡æ¿é˜¶æ®µçš„å‡½æ•°
      window[`loadTemplateStages${clientServiceId}`] = async function(templateId) {
        const stagesContainer = document.getElementById(`template-stages-${clientServiceId}`);
        const stagesList = document.getElementById(`stages-list-${clientServiceId}`);
        const manualContainer = document.getElementById(`manual-tasks-${clientServiceId}`);
        
        if (!templateId) {
          // æ²¡æœ‰é€‰æ‹©æ¨¡æ¿ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨é…ç½®åŒºåŸŸ
          stagesContainer.style.display = 'none';
          manualContainer.style.display = 'block';
          // åˆå§‹åŒ–ä¸€ä¸ªç©ºä»»åŠ¡
          if (!window[`customTasks${clientServiceId}`]) {
            window[`customTasks${clientServiceId}`] = [];
            addCustomTask${clientServiceId}();
          }
          return;
        }
        
        // é€‰æ‹©äº†æ¨¡æ¿ï¼Œéšè—æ‰‹åŠ¨é…ç½®åŒºåŸŸ
        manualContainer.style.display = 'none';
        
        // å…ˆä»å·²åŠ è½½çš„æ¨¡æ¿åˆ—è¡¨ä¸­è·å–æ¨¡æ¿ä¿¡æ¯ï¼Œè‡ªåŠ¨å¡«å……æœŸé™è§„åˆ™
        const templateData = window.taskTemplatesData?.find(t => t.template_id == templateId);
        if (templateData) {
          // è‡ªåŠ¨å¡«å……æœŸé™è§„åˆ™
          if (templateData.default_due_date_rule) {
            document.getElementById(`new-comp-due-rule-${clientServiceId}`).value = templateData.default_due_date_rule;
            // è§¦å‘å¸®åŠ©ä¿¡æ¯æ›´æ–°
            window[`updateDueDateHelp${clientServiceId}`](templateData.default_due_date_rule);
          }
          if (templateData.default_due_date_value) {
            document.getElementById(`new-comp-due-value-${clientServiceId}`).value = templateData.default_due_date_value;
          }
          if (templateData.default_advance_days != null) {
            document.getElementById(`new-comp-advance-${clientServiceId}`).value = templateData.default_advance_days;
          }
        }
        
        // æ˜¾ç¤ºå®¹å™¨
        stagesContainer.style.display = 'block';
        stagesList.innerHTML = '<p style="color: #6b7280; font-size: 14px;">è¼‰å…¥ä¸­...</p>';
        
        try {
          const res = await fetch(`/internal/api/v1/task-templates/${templateId}/stages`);
          const json = await res.json();
          
          if (!json.ok || !json.data) {
            stagesList.innerHTML = '<p style="color: #ef4444; font-size: 14px;">è¼‰å…¥å¤±æ•—</p>';
            return;
          }
          
          const stages = json.data;
          
          if (stages.length === 0) {
            stagesList.innerHTML = '<p style="color: #6b7280; font-size: 14px;">æ­¤æ¨¡æ¿æš«ç„¡éšæ®µè¨­å®š</p>';
            return;
          }
          
          // æ¸²æŸ“ç‹¬ç«‹ä»»åŠ¡åˆ—è¡¨ï¼ˆå¸¦é»˜è®¤å€¼ï¼‰
          stagesList.innerHTML = stages.map((stage, idx) => `
            <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #e5e7eb;">
              <div style="display: flex; align-items: start; gap: 15px;">
                <div style="flex-shrink: 0; width: 30px; height: 30px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                  ${stage.stage_order || idx + 1}
                </div>
                <div style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div>
                      <h6 style="margin: 0; font-size: 15px; color: #1f2937;">${stage.stage_name}</h6>
                      ${stage.description ? `<p style="margin: 4px 0 0 0; font-size: 13px; color: #6b7280;">${stage.description}</p>` : ''}
                    </div>
                    ${(stage.sop_id || stage.attachment_id) ? '<span style="background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 4px; font-size: 12px;">ğŸ“„ æœ‰SOP</span>' : ''}
                  </div>
                  
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                    <div>
                      <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“… æœŸé™è¦å‰‡</label>
                      <select style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; background: #f0f9ff;" 
                              id="stage-due-rule-${idx}-${clientServiceId}"
                              onchange="updateDueDateDisplay${clientServiceId}(${idx})">
                        <option value="end_of_month" ${stage.due_date_rule === 'end_of_month' ? 'selected' : ''}>æ¯æœˆæœ€å¾Œä¸€å¤©</option>
                        <option value="specific_day" ${stage.due_date_rule === 'specific_day' ? 'selected' : ''}>æ¯æœˆå›ºå®šæ—¥æœŸ</option>
                        <option value="next_month_day" ${stage.due_date_rule === 'next_month_day' ? 'selected' : ''}>æ¬¡æœˆå›ºå®šæ—¥æœŸ</option>
                        <option value="days_after_start" ${stage.due_date_rule === 'days_after_start' ? 'selected' : ''}>å¾æœˆåˆèµ·ç®—å¤©æ•¸</option>
                      </select>
                      <small id="due-display-${idx}-${clientServiceId}" style="display: block; margin-top: 3px; font-size: 11px; color: #3b82f6;"></small>
                    </div>
                    <div>
                      <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“Š æ—¥æœŸ/å¤©æ•¸</label>
                      <input type="number" min="1" max="31" placeholder="è«‹è¼¸å…¥" value="${stage.due_date_value || ''}"
                             style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; background: #f0f9ff;"
                             id="stage-due-value-${idx}-${clientServiceId}"
                             onchange="updateDueDateDisplay${clientServiceId}(${idx})" />
                    </div>
                    <div>
                      <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">â±ï¸ é ä¼°å·¥æ™‚</label>
                      <input type="number" min="0" step="0.5" value="${stage.estimated_hours || ''}" placeholder="ä¾‹å¦‚ï¼š2"
                             style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                             id="stage-hours-${idx}-${clientServiceId}" />
                      <small style="display: block; margin-top: 3px; font-size: 11px; color: #6b7280;">å°æ™‚</small>
                    </div>
                    <div>
                      <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“† æå‰ç”Ÿæˆ</label>
                      <input type="number" min="0" value="${stage.advance_days || 7}" placeholder="7"
                             style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                             id="stage-advance-${idx}-${clientServiceId}" />
                      <small style="display: block; margin-top: 3px; font-size: 11px; color: #6b7280;">å¤©å‰ç”Ÿæˆ</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `).join('') + `
            <div style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #3b82f6;">
              <p style="margin: 0; font-size: 13px; color: #1e40af;">
                <strong>ğŸ’¡ èªªæ˜ï¼š</strong>é€™äº›ä»»å‹™æœƒæ ¹æ“šã€Œæä¾›é »ç‡ã€è‡ªå‹•ç”Ÿæˆã€‚ä¾‹å¦‚é¸æ“‡ã€Œæ¯æœˆã€ï¼Œå°±æœƒæ¯æœˆè‡ªå‹•å‰µå»ºé€™${stages.length}å€‹ä»»å‹™ã€‚
              </p>
            </div>
          `;
          
          // åˆå§‹åŒ–æœŸé™æ˜¾ç¤º
          stages.forEach((stage, idx) => {
            setTimeout(() => {
              window[`updateDueDateDisplay${clientServiceId}`](idx);
            }, 50);
          });
          
        } catch (err) {
          console.error('è¼‰å…¥æ¨¡æ¿éšæ®µå¤±æ•—:', err);
          stagesList.innerHTML = '<p style="color: #ef4444; font-size: 14px;">è¼‰å…¥å¤±æ•—</p>';
        }
      };
      
      // åˆ›å»ºæ‰‹åŠ¨æ·»åŠ ä»»åŠ¡çš„å‡½æ•°
      window[`addCustomTask${clientServiceId}`] = function() {
        if (!window[`customTasks${clientServiceId}`]) {
          window[`customTasks${clientServiceId}`] = [];
        }
        
        const tasks = window[`customTasks${clientServiceId}`];
        const taskIdx = tasks.length;
        tasks.push({
          name: '',
          due_rule: 'end_of_month',
          due_value: null,
          hours: null,
          advance_days: 7
        });
        
        const manualTasksList = document.getElementById(`manual-tasks-list-${clientServiceId}`);
        
        const taskHtml = `
          <div id="custom-task-${taskIdx}-${clientServiceId}" style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #d1d5db;">
            <div style="display: flex; align-items: start; gap: 15px;">
              <div style="flex-shrink: 0; width: 30px; height: 30px; background: #6b7280; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                ${taskIdx + 1}
              </div>
              <div style="flex: 1;">
                <div style="margin-bottom: 10px;">
                  <label style="display: block; font-size: 13px; color: #374151; margin-bottom: 4px; font-weight: 500;">ä»»å‹™åç¨± *</label>
                  <input type="text" placeholder="ä¾‹å¦‚ï¼šæ”¶é›†æ†‘è­‰" 
                         style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;"
                         id="custom-task-name-${taskIdx}-${clientServiceId}" />
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“… æœŸé™è¦å‰‡</label>
                    <select style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                            id="custom-task-due-rule-${taskIdx}-${clientServiceId}"
                            onchange="updateCustomTaskDisplay${clientServiceId}(${taskIdx})">
                      <option value="end_of_month">æ¯æœˆæœ€å¾Œä¸€å¤©</option>
                      <option value="specific_day">æ¯æœˆå›ºå®šæ—¥æœŸ</option>
                      <option value="next_month_day">æ¬¡æœˆå›ºå®šæ—¥æœŸ</option>
                      <option value="days_after_start">å¾æœˆåˆèµ·ç®—å¤©æ•¸</option>
                    </select>
                    <small id="custom-task-display-${taskIdx}-${clientServiceId}" style="display: block; margin-top: 3px; font-size: 11px; color: #3b82f6;">ä¾‹ï¼š1æœˆ31æ—¥ã€2æœˆ28æ—¥</small>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“Š æ—¥æœŸ/å¤©æ•¸</label>
                    <input type="number" min="1" max="31" placeholder="è«‹è¼¸å…¥"
                           style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                           id="custom-task-due-value-${taskIdx}-${clientServiceId}"
                           onchange="updateCustomTaskDisplay${clientServiceId}(${taskIdx})" />
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">â±ï¸ é ä¼°å·¥æ™‚</label>
                    <input type="number" min="0" step="0.5" placeholder="ä¾‹å¦‚ï¼š2"
                           style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                           id="custom-task-hours-${taskIdx}-${clientServiceId}" />
                    <small style="display: block; margin-top: 3px; font-size: 11px; color: #6b7280;">å°æ™‚</small>
                  </div>
                  <div>
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px;">ğŸ“† æå‰ç”Ÿæˆ</label>
                    <input type="number" min="0" value="7" placeholder="7"
                           style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                           id="custom-task-advance-${taskIdx}-${clientServiceId}" />
                    <small style="display: block; margin-top: 3px; font-size: 11px; color: #6b7280;">å¤©å‰ç”Ÿæˆ</small>
                  </div>
                </div>
                
                <div style="margin-top: 10px; text-align: right;">
                  <button type="button" class="table-btn-link danger" onclick="removeCustomTask${clientServiceId}(${taskIdx})">ğŸ—‘ï¸ åˆªé™¤æ­¤ä»»å‹™</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        manualTasksList.insertAdjacentHTML('beforeend', taskHtml);
        updateCustomTaskDisplay${clientServiceId}(taskIdx);
      };
      
      // åˆ é™¤è‡ªå®šä¹‰ä»»åŠ¡
      window[`removeCustomTask${clientServiceId}`] = function(idx) {
        const taskEl = document.getElementById(`custom-task-${idx}-${clientServiceId}`);
        if (taskEl) taskEl.remove();
        if (window[`customTasks${clientServiceId}`]) {
          window[`customTasks${clientServiceId}`][idx] = null;
        }
      };
      
      // æ›´æ–°è‡ªå®šä¹‰ä»»åŠ¡çš„æœŸé™æ˜¾ç¤º
      window[`updateCustomTaskDisplay${clientServiceId}`] = function(idx) {
        const rule = document.getElementById(`custom-task-due-rule-${idx}-${clientServiceId}`)?.value;
        const value = document.getElementById(`custom-task-due-value-${idx}-${clientServiceId}`)?.value;
        const display = document.getElementById(`custom-task-display-${idx}-${clientServiceId}`);
        
        if (!display) return;
        
        let text = '';
        switch(rule) {
          case 'end_of_month':
            text = 'ä¾‹ï¼š1æœˆ31æ—¥ã€2æœˆ28æ—¥ã€3æœˆ31æ—¥';
            break;
          case 'specific_day':
            text = value ? `ä¾‹ï¼šæ¯æœˆ${value}æ—¥` : 'è«‹å¡«å¯«æ—¥æœŸ';
            break;
          case 'next_month_day':
            text = value ? `ä¾‹ï¼š1æœˆåŸ·è¡Œâ†’2/${value}ã€2æœˆåŸ·è¡Œâ†’3/${value}` : 'è«‹å¡«å¯«æ—¥æœŸ';
            break;
          case 'days_after_start':
            text = value ? `ä¾‹ï¼šæœˆåˆå¾Œç¬¬${value}å¤©` : 'è«‹å¡«å¯«å¤©æ•¸';
            break;
        }
        display.textContent = text;
      };
      
      // åˆ›å»ºæœŸé™æ˜¾ç¤ºæ›´æ–°å‡½æ•°
      window[`updateDueDateDisplay${clientServiceId}`] = function(idx) {
        const rule = document.getElementById(`stage-due-rule-${idx}-${clientServiceId}`)?.value;
        const value = document.getElementById(`stage-due-value-${idx}-${clientServiceId}`)?.value;
        const display = document.getElementById(`due-display-${idx}-${clientServiceId}`);
        
        if (!display) return;
        
        let text = '';
        switch(rule) {
          case 'end_of_month':
            text = 'ä¾‹ï¼š1æœˆ31æ—¥ã€2æœˆ28æ—¥ã€3æœˆ31æ—¥';
            break;
          case 'specific_day':
            if (value) {
              text = `ä¾‹ï¼šæ¯æœˆ${value}æ—¥`;
            } else {
              text = 'è«‹å¡«å¯«æ—¥æœŸ';
            }
            break;
          case 'next_month_day':
            if (value) {
              text = `ä¾‹ï¼š1æœˆåŸ·è¡Œâ†’2/${value}ã€2æœˆåŸ·è¡Œâ†’3/${value}`;
            } else {
              text = 'è«‹å¡«å¯«æ—¥æœŸ';
            }
            break;
          case 'days_after_start':
            if (value) {
              text = `ä¾‹ï¼šæœˆåˆå¾Œç¬¬${value}å¤©`;
            } else {
              text = 'è«‹å¡«å¯«å¤©æ•¸';
            }
            break;
        }
        display.textContent = text;
      };
      
      // åˆ›å»ºåŠ¨æ€å¸®åŠ©å‡½æ•°
      window[`updateDueDateHelp${clientServiceId}`] = function(rule) {
        const valueLabel = document.getElementById(`due-value-label-${clientServiceId}`);
        const valueHelp = document.getElementById(`due-value-help-${clientServiceId}`);
        const dueHelp = document.getElementById(`due-help-${clientServiceId}`);
        
        switch(rule) {
          case 'end_of_month':
            valueLabel.textContent = 'æœŸé™æ—¥æœŸå€¼ï¼ˆä¸éœ€è¦å¡«å¯«ï¼‰';
            valueHelp.textContent = 'ç³»çµ±æœƒè‡ªå‹•ä½¿ç”¨ç•¶æœˆæœ€å¾Œä¸€å¤©';
            dueHelp.innerHTML = 'âœ… ä¾‹å¦‚ï¼š1æœˆåŸ·è¡Œçš„ä»»å‹™ â†’ æˆªæ­¢æ—¥æœŸ 1/31';
            break;
          case 'specific_day':
            valueLabel.textContent = 'ğŸ“… æŒ‡å®šæ—¥æœŸï¼ˆå¿…å¡«ï¼‰';
            valueHelp.textContent = 'å¡«å¯«1-31ï¼Œè¡¨ç¤ºæ¯æœˆçš„å¹¾è™Ÿ';
            dueHelp.innerHTML = 'âœ… ä¾‹å¦‚ï¼šå¡«å¯« <strong>5</strong>ï¼Œ1æœˆåŸ·è¡Œ â†’ æˆªæ­¢æ—¥æœŸ 1/5';
            break;
          case 'next_month_day':
            valueLabel.textContent = 'ğŸ“… ä¸‹æœˆæ—¥æœŸï¼ˆå¿…å¡«ï¼‰';
            valueHelp.textContent = 'å¡«å¯«1-31ï¼Œè¡¨ç¤ºä¸‹å€‹æœˆçš„å¹¾è™Ÿ';
            dueHelp.innerHTML = 'âœ… ä¾‹å¦‚ï¼šå¡«å¯« <strong>15</strong>ï¼Œ1æœˆåŸ·è¡Œ â†’ æˆªæ­¢æ—¥æœŸ 2/15';
            break;
          case 'days_after_start':
            valueLabel.textContent = 'â±ï¸ å¤©æ•¸ï¼ˆå¿…å¡«ï¼‰';
            valueHelp.textContent = 'å¡«å¯«å¤©æ•¸ï¼Œå¾åŸ·è¡Œæœˆä»½1æ—¥é–‹å§‹è¨ˆç®—';
            dueHelp.innerHTML = 'âœ… ä¾‹å¦‚ï¼šå¡«å¯« <strong>30</strong>ï¼Œ1æœˆåŸ·è¡Œ â†’ æˆªæ­¢æ—¥æœŸ 1/31';
            break;
        }
      };
    }

    // å–æ¶ˆæ–°å¢
    function cancelAddComponent(clientServiceId) {
      const form = document.getElementById(`add-component-form-${clientServiceId}`);
      form.style.display = 'none';
      // æ¸…ç©ºè¡¨å–®
      document.getElementById(`new-comp-name-${clientServiceId}`).value = '';
      document.getElementById(`new-comp-service-${clientServiceId}`).value = '';
      document.getElementById(`new-comp-hours-${clientServiceId}`).value = '';
      document.getElementById(`new-comp-notes-${clientServiceId}`).value = '';
    }

    // å„²å­˜æ–°æœå‹™çµ„æˆéƒ¨åˆ†
    async function saveNewComponent(clientServiceId) {
      const name = document.getElementById(`new-comp-name-${clientServiceId}`).value.trim();
      const serviceId = document.getElementById(`new-comp-service-${clientServiceId}`).value;
      const frequency = document.getElementById(`new-comp-freq-${clientServiceId}`).value;
      const templateId = document.getElementById(`new-comp-template-${clientServiceId}`).value;
      const dueRule = document.getElementById(`new-comp-due-rule-${clientServiceId}`).value;
      const dueValue = document.getElementById(`new-comp-due-value-${clientServiceId}`).value;
      const hours = document.getElementById(`new-comp-hours-${clientServiceId}`).value;
      const advance = document.getElementById(`new-comp-advance-${clientServiceId}`).value;
      const notes = document.getElementById(`new-comp-notes-${clientServiceId}`).value.trim();

      if (!name) {
        alert('è«‹è¼¸å…¥æœå‹™åç¨±');
        return;
      }
      if (!serviceId) {
        alert('è«‹é¸æ“‡æœå‹™é¡å‹');
        return;
      }

      const data = {
        component_name: name,
        service_id: parseInt(serviceId),
        delivery_frequency: frequency,
        task_template_id: templateId ? parseInt(templateId) : null,
        due_date_rule: dueRule,
        due_date_value: dueValue ? parseInt(dueValue) : null,
        estimated_hours: hours ? parseFloat(hours) : null,
        advance_days: advance ? parseInt(advance) : 7,
        notes: notes || null,
        auto_generate_task: true
      };

      try {
        const res = await fetch(`/internal/api/v1/client-services/${clientServiceId}/components`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const json = await res.json();

        if (!json.ok) {
          alert(json.message || 'æ–°å¢å¤±æ•—');
          return;
        }

        alert('æœå‹™çµ„æˆéƒ¨åˆ†å·²æ–°å¢');
        cancelAddComponent(clientServiceId);
        
        // é‡æ–°è¼‰å…¥çµ„æˆéƒ¨åˆ†åˆ—è¡¨
        const services = (await (await fetch(`/internal/api/v1/clients/${currentClientId}`)).json()).data.services;
        const index = services.findIndex(s => s.client_service_id === clientServiceId);
        if (index !== -1) {
          await loadComponentsInline(index, clientServiceId);
        }

      } catch (err) {
        console.error('æ–°å¢æœå‹™çµ„æˆéƒ¨åˆ†å¤±æ•—:', err);
        alert('æ“ä½œå¤±æ•—');
      }
    }

    // åˆªé™¤æœå‹™çµ„æˆéƒ¨åˆ†
    async function deleteComponent(componentId, componentName) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤æœå‹™çµ„æˆéƒ¨åˆ†ã€Œ${componentName}ã€å—ï¼Ÿ`)) return;

      try {
        const res = await fetch(`/internal/api/v1/service-components/${componentId}`, {
          method: 'DELETE'
        });

        const json = await res.json();

        if (!json.ok) {
          alert(json.message || 'åˆªé™¤å¤±æ•—');
          return;
        }

        alert('æœå‹™çµ„æˆéƒ¨åˆ†å·²åˆªé™¤');
        await loadClientDetail();

      } catch (err) {
        console.error('åˆªé™¤å¤±æ•—:', err);
        alert('åˆªé™¤å¤±æ•—');
      }
    }

    // ç·¨è¼¯æœå‹™çµ„æˆéƒ¨åˆ†ï¼ˆç°¡åŒ–ç‰ˆï¼Œå¯ä»¥æ“´å±•ï¼‰
    function editComponent(componentId) {
      alert('ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œè«‹å…ˆåˆªé™¤å¾Œé‡æ–°æ–°å¢');
    }

    // åˆ‡æ›ä»»å‹™åˆ—è¡¨é¡¯ç¤º
    async function toggleComponentTasks(componentId) {
      const tasksList = document.getElementById(`tasks-list-${componentId}`);
      const toggleText = document.getElementById(`tasks-toggle-${componentId}`);
      
      if (tasksList.style.display === 'none') {
        // å±•é–‹ä¸¦è¼‰å…¥ä»»å‹™
        tasksList.style.display = 'block';
        toggleText.textContent = 'æ”¶èµ·';
        await loadComponentTasks(componentId);
      } else {
        // æ”¶èµ·
        tasksList.style.display = 'none';
        toggleText.textContent = 'å±•é–‹';
      }
    }

    // è¼‰å…¥æœå‹™çµ„æˆçš„ä»»å‹™åˆ—è¡¨
    async function loadComponentTasks(componentId) {
      const container = document.getElementById(`tasks-list-${componentId}`);
      
      try {
        const res = await fetch(`/internal/api/v1/tasks?component_id=${componentId}`);
        const json = await res.json();
        
        if (!json.ok) {
          container.innerHTML = '<p style="color: #ef4444; font-size: 13px;">è¼‰å…¥å¤±æ•—</p>';
          return;
        }

        const tasks = json.data || [];
        
        if (tasks.length === 0) {
          container.innerHTML = '<p style="color: #6b7280; font-size: 13px;">å°šæœªç”Ÿæˆä»»å‹™ï¼ˆä»»å‹™æœƒåœ¨æ¥è¿‘æœŸé™æ™‚è‡ªå‹•ç”Ÿæˆï¼‰</p>';
          return;
        }

        // æ¸²æŸ“ä»»å‹™åˆ—è¡¨
        container.innerHTML = tasks.map(task => {
          const statusColors = {
            'pending': { bg: '#fef3c7', text: '#92400e', label: 'å¾…è™•ç†' },
            'in_progress': { bg: '#dbeafe', text: '#1e40af', label: 'é€²è¡Œä¸­' },
            'completed': { bg: '#d1fae5', text: '#065f46', label: 'å·²å®Œæˆ' },
            'cancelled': { bg: '#f3f4f6', text: '#6b7280', label: 'å·²å–æ¶ˆ' }
          };
          
          const statusStyle = statusColors[task.status] || statusColors['pending'];
          
          return `
            <div style="background: #f9fafb; padding: 10px; border-radius: 6px; margin-bottom: 6px; font-size: 13px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                  <strong style="color: #1f2937;">${task.task_name}</strong>
                  <div style="color: #6b7280; margin-top: 4px; display: flex; gap: 12px;">
                    <span>ğŸ“… æˆªæ­¢ï¼š${task.due_date || '-'}</span>
                    <span>ğŸ‘¤ è² è²¬ï¼š${task.assignee_name || 'æœªåˆ†é…'}</span>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="background: ${statusStyle.bg}; color: ${statusStyle.text}; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                    ${statusStyle.label}
                  </span>
                  <a href="/internal/tasks?task_id=${task.task_id}" class="table-btn-link" style="font-size: 12px;" target="_blank">æŸ¥çœ‹</a>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
      } catch (err) {
        console.error('è¼‰å…¥ä»»å‹™å¤±æ•—:', err);
        container.innerHTML = '<p style="color: #ef4444; font-size: 13px;">è¼‰å…¥å¤±æ•—</p>';
      }
    }

    // æš´éœ²å‡½æ•¸åˆ°å…¨å±€
    window.showComponentsSection = showComponentsSection;
    window.loadComponentsInline = loadComponentsInline;
    window.showAddComponentForm = showAddComponentForm;
    window.cancelAddComponent = cancelAddComponent;
    window.saveNewComponent = saveNewComponent;
    window.deleteComponent = deleteComponent;
    window.editComponent = editComponent;
    window.toggleComponentTasks = toggleComponentTasks;
    window.loadComponentTasks = loadComponentTasks;

    // å–æ¶ˆç·¨è¼¯
    function cancelEdit() {
      window.location.href = '/internal/clients';
    }
    
    // å„²å­˜å®¢æˆ¶è³‡æ–™
    async function saveClient() {
      clearFormErrors();
      
      const assigneeValue = document.getElementById('inputAssignee').value;
      const assigneeUserId = assigneeValue ? parseInt(assigneeValue) : 0;
      
      const payload = {
        company_name: document.getElementById('inputCompanyName').value.trim(),
        assignee_user_id: assigneeUserId,
        phone: document.getElementById('inputPhone').value.trim() || null,
        email: document.getElementById('inputEmail').value.trim() || null,
        client_notes: document.getElementById('inputClientNotes').value.trim() || null,
        payment_notes: document.getElementById('inputPaymentNotes').value.trim() || null
      };
      
      // é©—è­‰
      let hasError = false;
      if (!payload.company_name) {
        showFieldError('company_name', 'å…¬å¸åç¨±ç‚ºå¿…å¡«');
        hasError = true;
      }
      if (!assigneeUserId || assigneeUserId <= 0) {
        showFieldError('assignee', 'è«‹é¸æ“‡è² è²¬äººå“¡');
        hasError = true;
      }
      
      if (hasError) return;
      
      try {
        const res = await fetch(`/internal/api/v1/clients/${currentClientId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        
        const json = await res.json();
        
        if (!res.ok || !json.ok) {
          if (json.errors && Array.isArray(json.errors)) {
            json.errors.forEach(err => {
              showFieldError(err.field, err.message);
            });
          } else {
            alert(json.message || 'å„²å­˜å¤±æ•—');
          }
          return;
        }
        
        alert('å·²å„²å­˜');
        loadClientDetail(); // é‡æ–°è¼‰å…¥
        
      } catch (err) {
        console.error('å„²å­˜å¤±æ•—:', err);
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // é¡¯ç¤ºæ¬„ä½éŒ¯èª¤
    function showFieldError(field, message) {
      const errorEl = document.getElementById(`error_${field}`);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
    }

    // æ¸…é™¤è¡¨å–®éŒ¯èª¤
    function clearFormErrors(formPrefix) {
      document.querySelectorAll('.error-message, .error-text').forEach(el => {
        el.textContent = '';
        el.style.display = 'none';
      });
    }

    // é»æ“ŠModalå¤–éƒ¨é—œé–‰
    window.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });

    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>


