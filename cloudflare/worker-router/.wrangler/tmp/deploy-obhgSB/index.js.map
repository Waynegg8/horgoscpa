{
  "version": 3,
  "sources": ["../../../src/utils.js", "../../../src/auth.js", "../../../src/cache-helper.js", "../../../src/api/clients.js", "../../../src/api/task_adjustments.js", "../../../src/api/tasks.js", "../../../src/api/timesheets.js", "../../../src/api/receipts.js", "../../../src/api/payroll.js", "../../../src/api/leaves.js", "../../../src/api/dev.js", "../../../src/api/overhead.js", "../../../src/api/reports.js", "../../../src/api/attachments.js", "../../../src/api/sop.js", "../../../src/api/faq.js", "../../../src/api/documents.js", "../../../src/api/client_services.js", "../../../src/api/cms.js", "../../../src/api/settings.js", "../../../src/api/dashboard.js", "../../../src/api/automation.js", "../../../src/api/holidays.js", "../../../src/api/tags.js", "../../../src/api/billing.js", "../../../src/api/task_templates.js", "../../../src/api/services.js", "../../../src/api/service_components.js", "../../../src/api/task_generator.js", "../../../src/api/timesheet_stats.js", "../../../src/index.js"],
  "sourceRoot": "C:\\Users\\miama\\Desktop\\horgoscpa\\cloudflare\\worker-router\\.wrangler\\tmp\\deploy-obhgSB",
  "sourcesContent": ["// \u5DE5\u5177\uFF1AJSON \u56DE\u61C9\uFF08\u7B26\u5408 Envelope\uFF09\r\nexport function jsonResponse(status, body, extraHeaders = {}) {\r\n\treturn new Response(JSON.stringify(body), {\r\n\t\tstatus,\r\n\t\theaders: {\r\n\t\t\t\"Content-Type\": \"application/json; charset=utf-8\",\r\n\t\t\t...extraHeaders,\r\n\t\t},\r\n\t});\r\n}\r\n\r\n// \u5DE5\u5177\uFF1A\u751F\u6210 Request Id\uFF08\u7C21\u6613\uFF09\r\nexport function generateRequestId() {\r\n\tconst random = crypto.getRandomValues(new Uint8Array(8));\r\n\treturn (\r\n\t\t\"req_\" + Array.from(random).map((b) => b.toString(16).padStart(2, \"0\")).join(\"\")\r\n\t);\r\n}\r\n\r\n// \u5DE5\u5177\uFF1APBKDF2-SHA256 \u9A57\u8B49\uFF08\u5132\u5B58\u683C\u5F0F\uFF1Apbkdf2$<iterations>$<saltBase64>$<hashBase64>\uFF09\r\nexport async function verifyPasswordPBKDF2(password, stored) {\r\n\tif (!stored || typeof stored !== \"string\") return false;\r\n\tconst parts = stored.split(\"$\");\r\n\tif (parts.length !== 4 || parts[0] !== \"pbkdf2\") return false;\r\n\tconst iterations = parseInt(parts[1], 10);\r\n\t// Cloudflare Workers \u9650\u5236\uFF1A\u8FED\u4EE3\u4E0A\u9650\u8F03\u4F4E\uFF1B\u653E\u5BEC\u4E0B\u9650\u81F3 100k\r\n\tif (!Number.isFinite(iterations) || iterations < 100000) return false;\r\n\tconst salt = Uint8Array.from(atob(parts[2]), (c) => c.charCodeAt(0));\r\n\tconst expected = Uint8Array.from(atob(parts[3]), (c) => c.charCodeAt(0));\r\n\r\n\tconst enc = new TextEncoder();\r\n\tconst keyMaterial = await crypto.subtle.importKey(\r\n\t\t\"raw\",\r\n\t\tenc.encode(password),\r\n\t\t{ name: \"PBKDF2\" },\r\n\t\tfalse,\r\n\t\t[\"deriveBits\"]\r\n\t);\r\n\tconst derivedBits = await crypto.subtle.deriveBits(\r\n\t\t{\r\n\t\t\tname: \"PBKDF2\",\r\n\t\t\thash: \"SHA-256\",\r\n\t\t\tsalt,\r\n\t\t\titerations,\r\n\t\t},\r\n\t\tkeyMaterial,\r\n\t\texpected.byteLength * 8\r\n\t);\r\n\tconst derived = new Uint8Array(derivedBits);\r\n\tif (derived.byteLength !== expected.byteLength) return false;\r\n\tlet diff = 0;\r\n\tfor (let i = 0; i < derived.byteLength; i++) diff |= derived[i] ^ expected[i];\r\n\treturn diff === 0;\r\n}\r\n\r\n// \u5DE5\u5177\uFF1APBKDF2-SHA256 \u7522\u751F\u96DC\u6E4A\uFF08\u5132\u5B58\u683C\u5F0F\uFF1Apbkdf2$<iterations>$<saltBase64>$<hashBase64>\uFF09\r\nexport async function hashPasswordPBKDF2(password, iterations = 100000, keyLen = 32) {\r\n\tconst salt = crypto.getRandomValues(new Uint8Array(16));\r\n\tconst enc = new TextEncoder();\r\n\tconst keyMaterial = await crypto.subtle.importKey(\r\n\t\t\"raw\",\r\n\t\tenc.encode(password),\r\n\t\t{ name: \"PBKDF2\" },\r\n\t\tfalse,\r\n\t\t[\"deriveBits\"]\r\n\t);\r\n\tconst derivedBits = await crypto.subtle.deriveBits(\r\n\t\t{ name: \"PBKDF2\", hash: \"SHA-256\", salt, iterations },\r\n\t\tkeyMaterial,\r\n\t\tkeyLen * 8\r\n\t);\r\n\tconst derived = new Uint8Array(derivedBits);\r\n\tconst b64 = (u8) => btoa(String.fromCharCode(...u8));\r\n\treturn `pbkdf2${\"$\"}${iterations}${\"$\"}${b64(salt)}${\"$\"}${b64(derived)}`;\r\n}\r\n\r\n// \u5DE5\u5177\uFF1A\u96A8\u6A5F Session Id\uFF0832 bytes base64\uFF09\r\nexport function generateSessionId() {\r\n\tconst bytes = crypto.getRandomValues(new Uint8Array(32));\r\n\treturn btoa(String.fromCharCode(...bytes)).replaceAll(\"=\", \"\").replaceAll(\"+\", \"-\").replaceAll(\"/\", \"_\");\r\n}\r\n\r\n// CORS\uFF1A\u5141\u8A31\u7279\u5B9A\u4F86\u6E90\uFF08pages.dev \u8207\u4E3B\u7AD9\uFF09\uFF0C\u56DE\u50B3\u6A19\u982D\r\nexport function getCorsHeadersForRequest(request, env) {\r\n\tconst origin = request.headers.get(\"Origin\") || \"\";\r\n\tif (!origin) return {};\r\n\ttry {\r\n\t\tconst o = new URL(origin);\r\n\t\tconst host = o.hostname || \"\";\r\n\t\tif (host.endsWith(\".pages.dev\") || host.endsWith(\"horgoscpa.com\")) {\r\n\t\t\treturn {\r\n\t\t\t\t\"Access-Control-Allow-Origin\": origin,\r\n\t\t\t\t\"Access-Control-Allow-Credentials\": \"true\",\r\n\t\t\t\t\"Vary\": \"Origin\",\r\n\t\t\t};\r\n\t\t}\r\n\t} catch (_) {}\r\n\treturn {};\r\n}\r\n\r\nexport function corsPreflightResponse(request, env) {\r\n\tconst headers = {\r\n\t\t...getCorsHeadersForRequest(request, env),\r\n\t\t\"Access-Control-Allow-Methods\": \"GET,POST,OPTIONS\",\r\n\t\t\"Access-Control-Allow-Headers\": request.headers.get(\"Access-Control-Request-Headers\") || \"Content-Type, X-Request-Id\",\r\n\t\t\"Access-Control-Max-Age\": \"600\",\r\n\t};\r\n\treturn new Response(null, { status: 204, headers });\r\n}\r\n\r\n// Cookie \u8B80\u53D6\r\nexport function getCookie(request, name) {\r\n\tconst raw = request.headers.get(\"Cookie\") || \"\";\r\n\tconst parts = raw.split(\";\");\r\n\tfor (const p of parts) {\r\n\t\tconst [k, ...v] = p.trim().split(\"=\");\r\n\t\tif (k === name) return v.join(\"=\");\r\n\t}\r\n\treturn null;\r\n}\r\n\r\n// \u53D6\u5F97\u76EE\u524D\u6703\u8A71\u7684\u4F7F\u7528\u8005\uFF08\u82E5\u7121\u6216\u904E\u671F\uFF0C\u56DE null\uFF09\r\nexport async function getSessionUser(request, env) {\r\n\tconst cookieName = String(env.SESSION_COOKIE_NAME || \"session\");\r\n\tconst sessionId = getCookie(request, cookieName);\r\n\tif (!sessionId || !env.DATABASE) return null;\r\n\tconst row = await env.DATABASE.prepare(\r\n\t\t\"SELECT s.id as session_id, s.user_id, s.expires_at, u.username, u.name, u.email, u.is_admin, u.gender FROM sessions s JOIN Users u ON u.user_id = s.user_id WHERE s.id = ? LIMIT 1\"\r\n\t).bind(sessionId).first();\r\n\tif (!row) return null;\r\n\tconst exp = Date.parse(row.expires_at);\r\n\tif (Number.isNaN(exp) || exp <= Date.now()) return null;\r\n\treturn row;\r\n}\r\n\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest, verifyPasswordPBKDF2, generateSessionId, getSessionUser } from \"./utils.js\";\r\n\r\nexport async function handleLogin(request, env, requestId) {\r\n\tif (request.method.toUpperCase() !== \"POST\") {\r\n\t\treturn jsonResponse(405, { ok: false, code: \"METHOD_NOT_ALLOWED\", message: \"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta: { requestId } }, getCorsHeadersForRequest(request, env));\r\n\t}\r\n\tlet payload;\r\n\ttry {\r\n\t\tpayload = await request.json();\r\n\t} catch (_) {\r\n\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, getCorsHeadersForRequest(request, env));\r\n\t}\r\n\tconst username = (payload?.username || \"\").trim().toLowerCase();\r\n\tconst password = payload?.password || \"\";\r\n\tconst errors = [];\r\n\tif (!username) errors.push({ field: \"username\", message: \"\u5FC5\u586B\" });\r\n\tif (!password) errors.push({ field: \"password\", message: \"\u5FC5\u586B\" });\r\n\tif (errors.length > 0) {\r\n\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, getCorsHeadersForRequest(request, env));\r\n\t}\r\n\r\n\tif (!env.DATABASE) {\r\n\t\treturn jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u8CC7\u6599\u5EAB\u672A\u7D81\u5B9A\", meta: { requestId } }, getCorsHeadersForRequest(request, env));\r\n\t}\r\n\r\n\ttry {\r\n\t\t// \u8B80\u53D6\u4F7F\u7528\u8005\r\n\t\tconst userRow = await env.DATABASE.prepare(\r\n\t\t\t\"SELECT user_id, username, password_hash, name, email, is_admin, is_deleted FROM Users WHERE LOWER(username) = ? LIMIT 1\"\r\n\t\t).bind(username).first();\r\n\r\n\t\t// \u907F\u514D\u6D29\u6F0F\u5E33\u865F\u5B58\u5728\u8207\u5426\r\n\t\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\t\tconst unauthorized = () => jsonResponse(401, { ok: false, code: \"UNAUTHORIZED\", message: \"\u5E33\u865F\u6216\u5BC6\u78BC\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\r\n\r\n\t\tif (!userRow || userRow.is_deleted === 1) {\r\n\t\t\treturn unauthorized();\r\n\t\t}\r\n\r\n\t\t// \u5BC6\u78BC\u9A57\u8B49\r\n\t\tconst hash = userRow.password_hash || \"\";\r\n\t\tconst passOk = await verifyPasswordPBKDF2(password, hash);\r\n\t\tif (!passOk) {\r\n\t\t\treturn unauthorized();\r\n\t\t}\r\n\r\n\t\t// \u6210\u529F\uFF1A\u66F4\u65B0 last_login\r\n\t\tawait env.DATABASE.prepare(\r\n\t\t\t\"UPDATE Users SET last_login = ? WHERE user_id = ?\"\r\n\t\t).bind(new Date().toISOString(), userRow.user_id).run();\r\n\r\n\t\t// \u5EFA\u7ACB\u6703\u8A71\r\n\t\tconst sessionId = generateSessionId();\r\n\t\tconst ttlSec = parseInt(env.SESSION_TTL_SECONDS || \"2592000\", 10);\r\n\t\tconst createdAt = new Date();\r\n\t\tconst expiresAt = new Date(createdAt.getTime() + ttlSec * 1000);\r\n\t\tawait env.DATABASE.prepare(\r\n\t\t\t\"INSERT INTO sessions (id, user_id, created_at, expires_at, meta_json) VALUES (?, ?, ?, ?, ?)\"\r\n\t\t).bind(sessionId, String(userRow.user_id), createdAt.toISOString(), expiresAt.toISOString(), JSON.stringify({ ua: request.headers.get(\"User-Agent\") || \"\" })).run();\r\n\r\n\t\t// \u8A2D\u5B9A Cookie\r\n\t\tconst cookieName = String(env.SESSION_COOKIE_NAME || \"session\");\r\n\t\tconst cookie = [\r\n\t\t\t`${cookieName}=${sessionId}`,\r\n\t\t\t\"Domain=horgoscpa.com\",\r\n\t\t\t\"Path=/\",\r\n\t\t\t\"HttpOnly\",\r\n\t\t\t\"Secure\",\r\n\t\t\t\"SameSite=Lax\",\r\n\t\t\t`Max-Age=${ttlSec}`,\r\n\t\t].join(\"; \");\r\n\r\n\t\tconst data = {\r\n\t\t\tuserId: String(userRow.user_id),\r\n\t\t\tusername: userRow.username,\r\n\t\t\tname: userRow.name,\r\n\t\t\temail: userRow.email,\r\n\t\t\tisAdmin: userRow.is_admin === 1,\r\n\t\t};\r\n\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u6210\u529F\", data, meta: { requestId } }, { \"Set-Cookie\": cookie, ...corsHeaders });\r\n\t} catch (err) {\r\n\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: \"/internal/api/v1/auth/login\", err: String(err) }));\r\n\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\treturn jsonResponse(500, body, getCorsHeadersForRequest(request, env));\r\n\t}\r\n}\r\n\r\nexport async function handleAuthMe(request, env, requestId) {\r\n\tif (request.method.toUpperCase() !== \"GET\") {\r\n\t\treturn jsonResponse(405, { ok: false, code: \"METHOD_NOT_ALLOWED\", message: \"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta: { requestId } }, getCorsHeadersForRequest(request, env));\r\n\t}\r\n\ttry {\r\n\t\tconst row = await getSessionUser(request, env);\r\n\t\tif (!row) {\r\n\t\t\treturn jsonResponse(401, { ok: false, code: \"UNAUTHORIZED\", message: \"\u672A\u767B\u5165\", meta: { requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t}\r\n\t\tconst data = {\r\n\t\t\tuserId: String(row.user_id),\r\n\t\t\tusername: row.username,\r\n\t\t\tname: row.name,\r\n\t\t\temail: row.email,\r\n\t\t\tisAdmin: row.is_admin === 1,\r\n\t\t\tgender: row.gender || 'M',\r\n\t\t};\r\n\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u6210\u529F\", data, meta: { requestId } }, getCorsHeadersForRequest(request, env));\r\n\t} catch (err) {\r\n\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: \"/internal/api/v1/auth/me\", err: String(err) }));\r\n\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\treturn jsonResponse(500, body, getCorsHeadersForRequest(request, env));\r\n\t}\r\n}\r\n\r\nexport async function handleLogout(request, env, requestId) {\r\n\tif (request.method.toUpperCase() !== \"POST\") {\r\n\t\treturn jsonResponse(405, { ok: false, code: \"METHOD_NOT_ALLOWED\", message: \"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta: { requestId } }, getCorsHeadersForRequest(request, env));\r\n\t}\r\n\ttry {\r\n\t\t// \u53D6\u5F97\u7576\u524D session\r\n\t\tconst cookieName = String(env.SESSION_COOKIE_NAME || \"session\");\r\n\t\tconst cookie = request.headers.get(\"Cookie\") || \"\";\r\n\t\tconst sessionId = cookie.split(\";\").map(s => s.trim()).find(s => s.startsWith(`${cookieName}=`))?.split(\"=\")[1];\r\n\r\n\t\t// \u82E5\u6709 session\uFF0C\u5F9E\u8CC7\u6599\u5EAB\u4E2D\u522A\u9664\r\n\t\tif (sessionId && env.DATABASE) {\r\n\t\t\tawait env.DATABASE.prepare(\"DELETE FROM sessions WHERE id = ?\").bind(sessionId).run();\r\n\t\t}\r\n\r\n\t\t// \u6E05\u9664 Cookie\r\n\t\tconst clearCookie = [\r\n\t\t\t`${cookieName}=`,\r\n\t\t\t\"Domain=horgoscpa.com\",\r\n\t\t\t\"Path=/\",\r\n\t\t\t\"HttpOnly\",\r\n\t\t\t\"Secure\",\r\n\t\t\t\"SameSite=Lax\",\r\n\t\t\t\"Max-Age=0\",\r\n\t\t].join(\"; \");\r\n\r\n\t\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u5DF2\u767B\u51FA\", meta: { requestId } }, { \"Set-Cookie\": clearCookie, ...corsHeaders });\r\n\t} catch (err) {\r\n\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: \"/internal/api/v1/auth/logout\", err: String(err) }));\r\n\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\treturn jsonResponse(500, body, getCorsHeadersForRequest(request, env));\r\n\t}\r\n}\r\n\r\n\r\n\r\n", "/**\r\n * \u26A1 \u901A\u7528\u6570\u636E\u7F13\u5B58\u8F85\u52A9\u6A21\u5757\r\n * \u7B56\u7565\uFF1A\u7F13\u5B58\u6C38\u4E45\u6709\u6548\uFF0C\u76F4\u5230\u6570\u636E\u53D8\u52A8\u65F6\u4E3B\u52A8\u5931\u6548\r\n */\r\n\r\n/**\r\n * \u751F\u6210\u7F13\u5B58\u952E\r\n * @param {string} cacheType - \u7F13\u5B58\u7C7B\u578B\uFF08\u5982 'clients_list', 'holidays_all'\uFF09\r\n * @param {object} params - \u53C2\u6570\u5BF9\u8C61\uFF08\u53EF\u9009\uFF09\r\n */\r\nexport function generateCacheKey(cacheType, params = {}) {\r\n\tif (!params || Object.keys(params).length === 0) {\r\n\t\treturn cacheType;\r\n\t}\r\n\t\r\n\t// \u6309\u5B57\u6BCD\u987A\u5E8F\u6392\u5E8F\u53C2\u6570\uFF0C\u786E\u4FDD\u76F8\u540C\u53C2\u6570\u751F\u6210\u76F8\u540C\u7684key\r\n\tconst sortedParams = Object.keys(params)\r\n\t\t.sort()\r\n\t\t.map(k => `${k}=${params[k]}`)\r\n\t\t.join('&');\r\n\t\r\n\treturn `${cacheType}:${sortedParams}`;\r\n}\r\n\r\n/**\r\n * \u83B7\u53D6\u7F13\u5B58\r\n * @param {object} env - Cloudflare\u73AF\u5883\r\n * @param {string} cacheKey - \u7F13\u5B58\u952E\r\n * @returns {Promise<object|null>} \u7F13\u5B58\u6570\u636E\u6216null\r\n */\r\nexport async function getCache(env, cacheKey) {\r\n\ttry {\r\n\t\tconst cache = await env.DATABASE.prepare(\r\n\t\t\t`SELECT cached_data, last_updated_at, hit_count, data_version\r\n\t\t\t FROM UniversalDataCache\r\n\t\t\t WHERE cache_key = ? AND invalidated = 0`\r\n\t\t).bind(cacheKey).first();\r\n\t\t\r\n\t\tif (!cache) return null;\r\n\t\t\r\n\t\t// \u66F4\u65B0\u8BBF\u95EE\u65F6\u95F4\u548C\u547D\u4E2D\u6B21\u6570\r\n\t\tawait env.DATABASE.prepare(\r\n\t\t\t`UPDATE UniversalDataCache \r\n\t\t\t SET last_accessed_at = datetime('now'), \r\n\t\t\t     hit_count = hit_count + 1 \r\n\t\t\t WHERE cache_key = ?`\r\n\t\t).bind(cacheKey).run();\r\n\t\t\r\n\t\tconst data = JSON.parse(cache.cached_data || '{}');\r\n\t\t\r\n\t\tconsole.log('[Cache] \u2713 \u7F13\u5B58\u547D\u4E2D', {\r\n\t\t\tkey: cacheKey,\r\n\t\t\thits: (cache.hit_count || 0) + 1,\r\n\t\t\tversion: cache.data_version,\r\n\t\t\tupdated: cache.last_updated_at\r\n\t\t});\r\n\t\t\r\n\t\treturn {\r\n\t\t\tdata,\r\n\t\t\tmeta: {\r\n\t\t\t\tcached: true,\r\n\t\t\t\thit_count: (cache.hit_count || 0) + 1,\r\n\t\t\t\tversion: cache.data_version,\r\n\t\t\t\tlast_updated: cache.last_updated_at\r\n\t\t\t}\r\n\t\t};\r\n\t} catch (err) {\r\n\t\tconsole.error('[Cache] \u8BFB\u53D6\u5931\u8D25:', err);\r\n\t\treturn null;\r\n\t}\r\n}\r\n\r\n/**\r\n * \u4FDD\u5B58\u7F13\u5B58\r\n * @param {object} env - Cloudflare\u73AF\u5883\r\n * @param {string} cacheKey - \u7F13\u5B58\u952E\r\n * @param {string} cacheType - \u7F13\u5B58\u7C7B\u578B\r\n * @param {any} data - \u8981\u7F13\u5B58\u7684\u6570\u636E\r\n * @param {object} options - \u53EF\u9009\u53C2\u6570\r\n */\r\nexport async function saveCache(env, cacheKey, cacheType, data, options = {}) {\r\n\ttry {\r\n\t\tconst now = new Date().toISOString();\r\n\t\tconst cachedData = JSON.stringify(data);\r\n\t\tconst dataSize = new Blob([cachedData]).size;\r\n\t\tconst userId = options.userId || null;\r\n\t\tconst scopeParams = options.scopeParams ? JSON.stringify(options.scopeParams) : null;\r\n\t\t\r\n\t\t// UPSERT\uFF1A\u5982\u679C\u5B58\u5728\u5219\u66F4\u65B0\uFF0C\u5426\u5219\u63D2\u5165\uFF08\u540C\u65F6\u9012\u589E\u7248\u672C\u53F7\u5E76\u91CD\u7F6E\u5931\u6548\u6807\u8BB0\uFF09\r\n\t\tawait env.DATABASE.prepare(\r\n\t\t\t`INSERT INTO UniversalDataCache (cache_key, cache_type, cached_data, data_version, invalidated, user_id, scope_params, data_size, last_updated_at, last_accessed_at, created_at)\r\n\t\t\t VALUES (?, ?, ?, 1, 0, ?, ?, ?, ?, ?, ?)\r\n\t\t\t ON CONFLICT(cache_key) DO UPDATE SET\r\n\t\t\t   cached_data = excluded.cached_data,\r\n\t\t\t   data_version = data_version + 1,\r\n\t\t\t   invalidated = 0,\r\n\t\t\t   data_size = excluded.data_size,\r\n\t\t\t   last_updated_at = excluded.last_updated_at,\r\n\t\t\t   last_accessed_at = excluded.last_accessed_at`\r\n\t\t).bind(cacheKey, cacheType, cachedData, userId, scopeParams, dataSize, now, now, now).run();\r\n\t\t\r\n\t\tconsole.log('[Cache] \u2713 \u7F13\u5B58\u5DF2\u4FDD\u5B58', {\r\n\t\t\tkey: cacheKey,\r\n\t\t\ttype: cacheType,\r\n\t\t\tsize: `${(dataSize / 1024).toFixed(1)}KB`\r\n\t\t});\r\n\t\t\r\n\t\treturn true;\r\n\t} catch (err) {\r\n\t\tconsole.error('[Cache] \u4FDD\u5B58\u5931\u8D25:', err);\r\n\t\treturn false;\r\n\t}\r\n}\r\n\r\n/**\r\n * \u5931\u6548\u7F13\u5B58\uFF08\u6309\u7F13\u5B58\u952E\uFF09\r\n * @param {object} env - Cloudflare\u73AF\u5883\r\n * @param {string} cacheKey - \u7F13\u5B58\u952E\r\n */\r\nexport async function invalidateCache(env, cacheKey) {\r\n\ttry {\r\n\t\tawait env.DATABASE.prepare(\r\n\t\t\t`UPDATE UniversalDataCache \r\n\t\t\t SET invalidated = 1 \r\n\t\t\t WHERE cache_key = ?`\r\n\t\t).bind(cacheKey).run();\r\n\t\t\r\n\t\tconsole.log('[Cache] \u2713 \u7F13\u5B58\u5DF2\u5931\u6548', { key: cacheKey });\r\n\t} catch (err) {\r\n\t\tconsole.error('[Cache] \u5931\u6548\u5931\u8D25:', err);\r\n\t}\r\n}\r\n\r\n/**\r\n * \u6279\u91CF\u5931\u6548\u7F13\u5B58\uFF08\u6309\u7F13\u5B58\u7C7B\u578B\uFF09\r\n * @param {object} env - Cloudflare\u73AF\u5883\r\n * @param {string} cacheType - \u7F13\u5B58\u7C7B\u578B\r\n * @param {object} filters - \u8FC7\u6EE4\u6761\u4EF6\uFF08\u53EF\u9009\uFF09\r\n */\r\nexport async function invalidateCacheByType(env, cacheType, filters = {}) {\r\n\ttry {\r\n\t\tlet sql = `UPDATE UniversalDataCache SET invalidated = 1 WHERE cache_type = ?`;\r\n\t\tconst binds = [cacheType];\r\n\t\t\r\n\t\t// \u5982\u679C\u6709 user_id \u8FC7\u6EE4\r\n\t\tif (filters.userId) {\r\n\t\t\tsql += ` AND user_id = ?`;\r\n\t\t\tbinds.push(filters.userId);\r\n\t\t}\r\n\t\t\r\n\t\tconst result = await env.DATABASE.prepare(sql).bind(...binds).run();\r\n\t\t\r\n\t\tconsole.log('[Cache] \u2713 \u6279\u91CF\u5931\u6548', {\r\n\t\t\ttype: cacheType,\r\n\t\t\tfilters,\r\n\t\t\taffected: result.changes || 0\r\n\t\t});\r\n\t} catch (err) {\r\n\t\tconsole.error('[Cache] \u6279\u91CF\u5931\u6548\u5931\u8D25:', err);\r\n\t}\r\n}\r\n\r\n/**\r\n * \u6E05\u7406\u8FC7\u671F\u7684\u5931\u6548\u7F13\u5B58\uFF08\u5B9A\u671F\u7EF4\u62A4\uFF09\r\n * @param {object} env - Cloudflare\u73AF\u5883\r\n * @param {number} daysOld - \u4FDD\u7559\u5929\u6570\uFF08\u9ED8\u8BA47\u5929\uFF09\r\n */\r\nexport async function cleanupInvalidatedCache(env, daysOld = 7) {\r\n\ttry {\r\n\t\tconst result = await env.DATABASE.prepare(\r\n\t\t\t`DELETE FROM UniversalDataCache \r\n\t\t\t WHERE invalidated = 1 \r\n\t\t\t   AND datetime(last_updated_at) < datetime('now', '-' || ? || ' days')`\r\n\t\t).bind(daysOld).run();\r\n\t\t\r\n\t\tconsole.log('[Cache] \u2713 \u6E05\u7406\u5B8C\u6210', {\r\n\t\t\tdeleted: result.changes || 0,\r\n\t\t\tolder_than_days: daysOld\r\n\t\t});\r\n\t} catch (err) {\r\n\t\tconsole.error('[Cache] \u6E05\u7406\u5931\u8D25:', err);\r\n\t}\r\n}\r\n\r\n/**\r\n * \u83B7\u53D6\u7F13\u5B58\u7EDF\u8BA1\u4FE1\u606F\r\n * @param {object} env - Cloudflare\u73AF\u5883\r\n */\r\nexport async function getCacheStats(env) {\r\n\ttry {\r\n\t\tconst stats = await env.DATABASE.prepare(\r\n\t\t\t`SELECT * FROM CacheStats`\r\n\t\t).all();\r\n\t\t\r\n\t\treturn stats.results || [];\r\n\t} catch (err) {\r\n\t\tconsole.error('[Cache] \u83B7\u53D6\u7EDF\u8BA1\u5931\u8D25:', err);\r\n\t\treturn [];\r\n\t}\r\n}\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\nimport { generateCacheKey, getCache, saveCache, invalidateCache, invalidateCacheByType } from \"../cache-helper.js\";\n\nexport async function handleClients(request, env, me, requestId, url) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\tconst method = request.method.toUpperCase();\n\t\n\t// \uD83D\uDD0D \u8C03\u8BD5\u65E5\u5FD7\uFF1A\u663E\u793A\u6536\u5230\u7684\u8DEF\u5F84\n\tconsole.log(`[CLIENTS.JS] \u6536\u5230\u8ACB\u6C42: ${method} ${url.pathname}`);\n\t\n\t// \u2B50 \u8DEF\u7531\u4F18\u5148\u7EA7 1: GET /api/v1/clients/:clientId/services/:serviceId/items\n\tconst matchItems = url.pathname.match(/^\\/internal\\/api\\/v1\\/clients\\/([^\\/]+)\\/services\\/(\\d+)\\/items$/);\n\tconsole.log(`[CLIENTS.JS] \u8DEF\u75311\u5339\u914D\u7D50\u679C (items):`, matchItems);\n\tif (method === \"GET\" && matchItems) {\n\t\tconst clientId = matchItems[1];\n\t\tconst serviceId = parseInt(matchItems[2]);\n\t\t\n\t\ttry {\n\t\t\tconst client = await env.DATABASE.prepare(\n\t\t\t\t`SELECT client_id FROM Clients WHERE client_id = ? AND is_deleted = 0`\n\t\t\t).bind(clientId).first();\n\t\t\t\n\t\t\tif (!client) {\n\t\t\t\treturn jsonResponse(404, {\n\t\t\t\t\tok: false,\n\t\t\t\t\tcode: \"NOT_FOUND\",\n\t\t\t\t\tmessage: \"\u5BA2\u6236\u4E0D\u5B58\u5728\",\n\t\t\t\t\tmeta: { requestId }\n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\tconst items = await env.DATABASE.prepare(\n\t\t\t\t`SELECT item_id, item_name, item_code, description, sort_order\n\t\t\t\t FROM ServiceItems\n\t\t\t\t WHERE service_id = ? AND is_active = 1\n\t\t\t\t ORDER BY sort_order ASC, item_id ASC`\n\t\t\t).bind(serviceId).all();\n\t\t\t\n\t\t\tconst data = items.results.map(item => ({\n\t\t\t\titem_id: item.item_id,\n\t\t\t\titem_name: item.item_name,\n\t\t\t\titem_code: item.item_code,\n\t\t\t\tdescription: item.description || \"\"\n\t\t\t}));\n\t\t\t\n\t\t\treturn jsonResponse(200, {\n\t\t\t\tok: true,\n\t\t\t\tcode: \"SUCCESS\",\n\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\",\n\t\t\t\tdata,\n\t\t\t\tmeta: { requestId }\n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\t\n\t// \u2B50 \u8DEF\u7531\u4F18\u5148\u7EA7 2: GET /api/v1/clients/:clientId/services\n\tconst matchServices = url.pathname.match(/^\\/internal\\/api\\/v1\\/clients\\/([^\\/]+)\\/services$/);\n\tconsole.log(`[CLIENTS.JS] \u8DEF\u75312\u5339\u914D\u7D50\u679C (services):`, matchServices);\n\tif (method === \"GET\" && matchServices) {\n\t\tconst clientId = matchServices[1];\n\t\t\n\t\tconsole.log('[API DEBUG] \u670D\u52D9\u9805\u76EE\u8DEF\u7531\u5339\u914D\uFF01clientId:', clientId);\n\t\t\n\t\t// \u26A1 \u5C1D\u8BD5\u4ECE\u7F13\u5B58\u8BFB\u53D6\n\t\tconst cacheKey = generateCacheKey('client_services', { clientId });\n\t\tconst cached = await getCache(env, cacheKey);\n\t\t\n\t\tif (cached && cached.data) {\n\t\t\tconsole.log('[API DEBUG] \u2713 \u4F7F\u7528\u7F13\u5B58\u7684\u670D\u52A1\u9879\u76EE');\n\t\t\treturn jsonResponse(200, {\n\t\t\t\tok: true,\n\t\t\t\tcode: \"SUCCESS\",\n\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\uFF08\u7F13\u5B58\uFF09\",\n\t\t\t\tdata: cached.data,\n\t\t\t\tmeta: { requestId, ...cached.meta }\n\t\t\t}, corsHeaders);\n\t\t}\n\t\t\n\t\ttry {\n\t\t\tconst client = await env.DATABASE.prepare(\n\t\t\t\t`SELECT client_id FROM Clients WHERE client_id = ? AND is_deleted = 0`\n\t\t\t).bind(clientId).first();\n\t\t\t\n\t\t\tif (!client) {\n\t\t\t\treturn jsonResponse(404, {\n\t\t\t\t\tok: false,\n\t\t\t\t\tcode: \"NOT_FOUND\",\n\t\t\t\t\tmessage: \"\u5BA2\u6236\u4E0D\u5B58\u5728\",\n\t\t\t\t\tmeta: { requestId }\n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\tconst clientServices = await env.DATABASE.prepare(\n\t\t\t\t`SELECT DISTINCT cs.service_id\n\t\t\t\t FROM ClientServices cs\n\t\t\t\t WHERE cs.client_id = ? AND cs.is_deleted = 0 AND cs.service_id IS NOT NULL`\n\t\t\t).bind(clientId).all();\n\t\t\t\n\t\t\tconsole.log('[API DEBUG] ClientServices \u67E5\u8A62\u7D50\u679C:', clientServices.results);\n\t\t\t\n\t\t\tlet services;\n\t\t\t\n\t\t\tif (clientServices.results && clientServices.results.length > 0) {\n\t\t\t\tconst serviceIds = clientServices.results.map(r => r.service_id);\n\t\t\t\tconst placeholders = serviceIds.map(() => '?').join(',');\n\t\t\t\t\n\t\t\t\tconsole.log('[API DEBUG] \u5BA2\u6236\u6709\u6307\u5B9A\u670D\u52D9\uFF0CserviceIds:', serviceIds);\n\t\t\t\t\n\t\t\t\tservices = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT service_id, service_name, service_code, description\n\t\t\t\t\t FROM Services\n\t\t\t\t\t WHERE service_id IN (${placeholders}) AND is_active = 1\n\t\t\t\t\t ORDER BY sort_order ASC, service_id ASC`\n\t\t\t\t).bind(...serviceIds).all();\n\t\t\t} else {\n\t\t\t\tconsole.log('[API DEBUG] \u5BA2\u6236\u6C92\u6709\u6307\u5B9A\u670D\u52D9\uFF0C\u8FD4\u56DE\u6240\u6709\u53EF\u7528\u670D\u52D9');\n\t\t\t\tservices = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT service_id, service_name, service_code, description\n\t\t\t\t\t FROM Services\n\t\t\t\t\t WHERE is_active = 1\n\t\t\t\t\t ORDER BY sort_order ASC, service_id ASC`\n\t\t\t\t).all();\n\t\t\t}\n\t\t\t\n\t\t\tconst data = services.results.map(service => ({\n\t\t\t\tservice_id: service.service_id,\n\t\t\t\tservice_name: service.service_name,\n\t\t\t\tservice_code: service.service_code,\n\t\t\t\tdescription: service.description || \"\"\n\t\t\t}));\n\t\t\t\n\t\t\tconsole.log('[API DEBUG] \u6700\u7D42\u8FD4\u56DE\u670D\u52D9\u5217\u8868:', data);\n\t\t\t\n\t\t\t// \u26A1 \u4FDD\u5B58\u5230\u7F13\u5B58\uFF08\u4E0D\u7B49\u5F85\u5B8C\u6210\uFF09\n\t\t\tsaveCache(env, cacheKey, 'client_services', data, {\n\t\t\t\tscopeParams: { clientId }\n\t\t\t}).catch(err => console.error('[CLIENTS] \u670D\u52A1\u9879\u76EE\u7F13\u5B58\u4FDD\u5B58\u5931\u8D25:', err));\n\t\t\t\n\t\t\treturn jsonResponse(200, {\n\t\t\t\tok: true,\n\t\t\t\tcode: \"SUCCESS\",\n\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\",\n\t\t\t\tdata,\n\t\t\t\tmeta: { requestId }\n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\t\n\t// \u2B50 \u8DEF\u7531\u4F18\u5148\u7EA7 3: GET /api/v1/clients/:id - \u5BA2\u6236\u8A73\u60C5\n\tconst matchSingle = url.pathname.match(/\\/clients\\/[^\\/]+$/);\n\tconsole.log(`[CLIENTS.JS] \u8DEF\u75313\u5339\u914D\u7D50\u679C (single):`, matchSingle);\n\tif (method === \"GET\" && matchSingle) {\n\t\tconst clientId = url.pathname.split(\"/\").pop();\n\t\ttry {\n\t\t\tconst row = await env.DATABASE.prepare(\n\t\t\t\t`SELECT c.client_id, c.company_name, c.tax_registration_number, c.contact_person_1, c.contact_person_2, c.phone, c.email, \n\t\t\t\t        c.client_notes, c.payment_notes, c.created_at, c.updated_at,\n\t\t\t\t        u.user_id as assignee_id, u.name as assignee_name,\n\t\t\t\t        GROUP_CONCAT(t.tag_id || ':' || t.tag_name || ':' || COALESCE(t.tag_color, ''), '|') as tags\n\t\t\t\t FROM Clients c\n\t\t\t\t LEFT JOIN Users u ON u.user_id = c.assignee_user_id\n\t\t\t\t LEFT JOIN ClientTagAssignments a ON a.client_id = c.client_id\n\t\t\t\t LEFT JOIN CustomerTags t ON t.tag_id = a.tag_id\n\t\t\t\t WHERE c.client_id = ? AND c.is_deleted = 0\n\t\t\t\t GROUP BY c.client_id`\n\t\t\t).bind(clientId).first();\n\t\t\t\n\t\t\tif (!row) {\n\t\t\t\treturn jsonResponse(404, { \n\t\t\t\t\tok: false, \n\t\t\t\t\tcode: \"NOT_FOUND\", \n\t\t\t\t\tmessage: \"\u5BA2\u6236\u4E0D\u5B58\u5728\", \n\t\t\t\t\tmeta: { requestId } \n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u89E3\u6790\u6A19\u7C64\n\t\t\tconst tags = [];\n\t\t\tif (row.tags) {\n\t\t\t\tconst tagParts = String(row.tags).split('|');\n\t\t\t\ttagParts.forEach(part => {\n\t\t\t\t\tconst [id, name, color] = part.split(':');\n\t\t\t\t\tif (id && name) {\n\t\t\t\t\t\ttags.push({\n\t\t\t\t\t\t\ttag_id: parseInt(id),\n\t\t\t\t\t\t\ttag_name: name,\n\t\t\t\t\t\t\ttag_color: color || null\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\t\n\t\t\t// \u67E5\u8BE2\u5BA2\u6237\u670D\u52A1\u5217\u8868\uFF08\u65B0\u7ED3\u6784\uFF09\n\t\t\tconst servicesRows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT cs.client_service_id, cs.service_id, cs.status, cs.service_cycle,\n\t\t\t\t        cs.task_template_id, cs.auto_generate_tasks,\n\t\t\t\t        cs.start_date, cs.end_date, cs.service_notes,\n\t\t\t\t        s.service_name, s.service_code\n\t\t\t\t FROM ClientServices cs\n\t\t\t\t LEFT JOIN Services s ON s.service_id = cs.service_id\n\t\t\t\t WHERE cs.client_id = ? AND cs.is_deleted = 0\n\t\t\t\t ORDER BY cs.client_service_id ASC`\n\t\t\t).bind(clientId).all();\n\t\t\t\n\t\t\t// \u4E3A\u6BCF\u4E2A\u670D\u52A1\u67E5\u8BE2\u6536\u8D39\u660E\u7EC6\u548C\u5E74\u5EA6\u603B\u989D\n\t\t\tconst services = await Promise.all((servicesRows?.results || []).map(async (svc) => {\n\t\t\t\tconst billingRows = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT billing_month, billing_amount, payment_due_days, notes\n\t\t\t\t\t FROM ServiceBillingSchedule\n\t\t\t\t\t WHERE client_service_id = ?\n\t\t\t\t\t ORDER BY billing_month ASC`\n\t\t\t\t).bind(svc.client_service_id).all();\n\t\t\t\t\n\t\t\t\tconst billing_schedule = (billingRows?.results || []).map(b => ({\n\t\t\t\t\tbilling_month: b.billing_month,\n\t\t\t\t\tbilling_amount: Number(b.billing_amount || 0),\n\t\t\t\t\tpayment_due_days: Number(b.payment_due_days || 30),\n\t\t\t\t\tnotes: b.notes || \"\"\n\t\t\t\t}));\n\t\t\t\t\n\t\t\t\tconst year_total = billing_schedule.reduce((sum, b) => sum + b.billing_amount, 0);\n\t\t\t\t\n\t\t\t\treturn {\n\t\t\t\t\tclient_service_id: svc.client_service_id,\n\t\t\t\t\tservice_id: svc.service_id,\n\t\t\t\t\tservice_name: svc.service_name || \"\",\n\t\t\t\t\tservice_code: svc.service_code || \"\",\n\t\t\t\t\tstatus: svc.status || \"active\",\n\t\t\t\t\tservice_cycle: svc.service_cycle || \"monthly\",\n\t\t\t\t\ttask_template_id: svc.task_template_id || null,\n\t\t\t\t\tauto_generate_tasks: Boolean(svc.auto_generate_tasks),\n\t\t\t\t\tstart_date: svc.start_date || null,\n\t\t\t\t\tend_date: svc.end_date || null,\n\t\t\t\t\tservice_notes: svc.service_notes || \"\",\n\t\t\t\t\tbilling_schedule: billing_schedule,\n\t\t\t\t\tyear_total: year_total\n\t\t\t\t};\n\t\t\t}));\n\t\t\t\n\t\t\tconst data = {\n\t\t\t\tclientId: row.client_id,\n\t\t\t\tcompanyName: row.company_name,\n\t\t\t\ttaxId: row.tax_registration_number,\n\t\t\t\tcontact_person_1: row.contact_person_1 || \"\",\n\t\t\t\tcontact_person_2: row.contact_person_2 || \"\",\n\t\t\t\tassigneeUserId: row.assignee_id,\n\t\t\t\tassigneeName: row.assignee_name || \"\",\n\t\t\t\tphone: row.phone || \"\",\n\t\t\t\temail: row.email || \"\",\n\t\t\t\tclientNotes: row.client_notes || \"\",\n\t\t\t\tpaymentNotes: row.payment_notes || \"\",\n\t\t\t\ttags: tags,\n\t\t\t\tservices: services,\n\t\t\t\tcreatedAt: row.created_at,\n\t\t\t\tupdatedAt: row.updated_at\n\t\t\t};\n\t\t\t\n\t\t\treturn jsonResponse(200, { \n\t\t\t\tok: true, \n\t\t\t\tcode: \"SUCCESS\", \n\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\", \n\t\t\t\tdata, \n\t\t\t\tmeta: { requestId } \n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\t\n\t// \u2B50 \u8DEF\u7531\u4F18\u5148\u7EA7 4: GET /api/v1/clients - \u5BA2\u6236\u5217\u8868\uFF08\u5FC5\u987B\u660E\u786E\u68C0\u67E5\u8DEF\u5F84\uFF09\n\tconst matchList = (url.pathname === \"/internal/api/v1/clients\");\n\tconsole.log(`[CLIENTS.JS] \u8DEF\u75314\u5339\u914D\u7D50\u679C (list):`, matchList, 'pathname:', url.pathname);\n\tif (method === \"GET\" && matchList) {\n\t\tconst params = url.searchParams;\n\t\tconst page = Math.max(1, parseInt(params.get(\"page\") || \"1\", 10));\n\t\tconst perPage = Math.min(100, Math.max(1, parseInt(params.get(\"perPage\") || \"50\", 10)));\n\t\tconst offset = (page - 1) * perPage;\n\t\tconst searchQuery = (params.get(\"q\") || \"\").trim();\n\t\tconst tagId = params.get(\"tag_id\") || \"\";\n\t\t\n\t\t// \u26A1 \u5C1D\u8BD5\u4ECE\u7F13\u5B58\u8BFB\u53D6\n\t\tconst cacheKey = generateCacheKey('clients_list', { page, perPage, q: searchQuery, tag_id: tagId });\n\t\tconst cached = await getCache(env, cacheKey);\n\t\t\n\t\tif (cached && cached.data) {\n\t\t\treturn jsonResponse(200, { \n\t\t\t\tok: true, \n\t\t\t\tcode: \"OK\", \n\t\t\t\tmessage: \"\u6210\u529F\uFF08\u7F13\u5B58\uFF09\", \n\t\t\t\tdata: cached.data.list, \n\t\t\t\tmeta: { ...cached.data.meta, requestId, ...cached.meta } \n\t\t\t}, corsHeaders);\n\t\t}\n\t\t\n\t\ttry {\n\t\t\tconst where = [\"is_deleted = 0\"];\n\t\t\tconst binds = [];\n\t\t\t\n\t\t\t// \u641C\u7D22\uFF1A\u652F\u6301\u516C\u53F8\u540D\u79F0\u548C\u7EDF\u7F16\n\t\t\tif (searchQuery) {\n\t\t\t\twhere.push(\"(company_name LIKE ? OR tax_registration_number LIKE ?)\");\n\t\t\t\tbinds.push(`%${searchQuery}%`, `%${searchQuery}%`);\n\t\t\t}\n\t\t\t\n\t\t\t// \u6807\u7B7E\u7B5B\u9009\n\t\t\tif (tagId) {\n\t\t\t\twhere.push(\"EXISTS (SELECT 1 FROM ClientTagAssignments cta WHERE cta.client_id = Clients.client_id AND cta.tag_id = ?)\");\n\t\t\t\tbinds.push(tagId);\n\t\t\t}\n\t\t\t\n\t\t\tconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\n\t\t\tconst countRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT COUNT(*) as total FROM Clients ${whereSql}`\n\t\t\t).bind(...binds).first();\n\t\t\tconst total = Number(countRow?.total || 0);\n\t\t\t\n\t\t\t// \u7B80\u5316\u67E5\u8BE2\uFF1A\u53EA\u67E5\u5BA2\u6237\u57FA\u7840\u6570\u636E\n\t\t\tconst rows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT client_id, company_name, tax_registration_number, contact_person_1, \n\t\t\t\t        phone, email, created_at, assignee_user_id\n\t\t\t\t FROM Clients\n\t\t\t\t ${whereSql}\n\t\t\t\t ORDER BY created_at DESC\n\t\t\t\t LIMIT ? OFFSET ?`\n\t\t\t).bind(...binds, perPage, offset).all();\n\t\t\t\n\t\t\t// \u6620\u5C04\u6570\u636E\uFF08\u7B80\u5316\u7248\u672C\uFF09\n\t\t\tconst data = (rows?.results || []).map(r => ({\n\t\t\t\tclientId: r.client_id,\n\t\t\t\tcompanyName: r.company_name,\n\t\t\t\ttaxId: r.tax_registration_number,\n\t\t\t\tcontact_person_1: r.contact_person_1 || \"\",\n\t\t\t\tassigneeName: \"\", // \u6682\u65F6\u4E3A\u7A7A\uFF0C\u907F\u514D\u989D\u5916\u67E5\u8BE2\n\t\t\t\ttags: [], // \u6682\u65F6\u4E3A\u7A7A\uFF0C\u907F\u514D\u989D\u5916\u67E5\u8BE2\n\t\t\t\tphone: r.phone || \"\",\n\t\t\t\temail: r.email || \"\",\n\t\t\t\tcreatedAt: r.created_at,\n\t\t\t\tyear_total: 0\n\t\t\t}));\n\t\t\t\n\t\t\tconst meta = { requestId, page, perPage, total, hasNext: offset + perPage < total };\n\t\t\t\n\t\t\t// \u26A1 \u4FDD\u5B58\u5230\u7F13\u5B58\uFF08\u4E0D\u7B49\u5F85\u5B8C\u6210\uFF09\n\t\t\tsaveCache(env, cacheKey, 'clients_list', { list: data, meta }, {\n\t\t\t\tscopeParams: { page, perPage, q: searchQuery, tag_id: tagId }\n\t\t\t}).catch(err => console.error('[CLIENTS] \u7F13\u5B58\u4FDD\u5B58\u5931\u8D25:', err));\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u6210\u529F\", data, meta }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\n\t// POST /api/v1/clients - \u65B0\u589E\u5BA2\u6237\uFF08\u5FC5\u987B\u5728/clients/:id/services\u4E4B\u524D\u68C0\u67E5\uFF0C\u5E76\u786E\u4FDD\u4E0D\u5339\u914D\u5B50\u8DEF\u5F84\uFF09\n\tconsole.log(`[CLIENTS.JS] \u6AA2\u67E5\u5275\u5EFA\u5BA2\u6236\u8DEF\u7531: ${method} === \"POST\" && ${url.pathname} === \"/internal/api/v1/clients\" => ${method === \"POST\" && url.pathname === \"/internal/api/v1/clients\"}`);\n\tif (method === \"POST\" && url.pathname === \"/internal/api/v1/clients\") {\n\t\tconsole.log('[CLIENTS.JS] \u2705 \u5339\u914D\u5275\u5EFA\u5BA2\u6236\u8DEF\u7531');\n\t\tlet body;\n\t\ttry {\n\t\t\tbody = await request.json();\n\t\t} catch (_) {\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t\tconst errors = [];\n\t\tconst clientId = String(body?.client_id || \"\").trim();\n\t\tconst companyName = String(body?.company_name || \"\").trim();\n\t\tconst assigneeUserId = Number(body?.assignee_user_id || 0);\n\t\tconst phone = (body?.phone || \"\").trim();\n\t\tconst email = (body?.email || \"\").trim();\n\t\tconst clientNotes = (body?.client_notes || \"\").trim();\n\t\tconst paymentNotes = (body?.payment_notes || \"\").trim();\n\t\tconst tagIds = Array.isArray(body?.tag_ids) ? body.tag_ids.map((x) => Number(x)).filter((n) => Number.isFinite(n)) : [];\n\n\t\tif (!/^\\d{8}$/.test(clientId)) errors.push({ field: \"client_id\", message: \"\u5FC5\u586B\u4E14\u9808\u70BA8\u4F4D\u6578\u5B57\" });\n\t\tif (companyName.length < 1 || companyName.length > 100) errors.push({ field: \"company_name\", message: \"\u9577\u5EA6\u9700 1\u2013100\" });\n\t\tif (!Number.isInteger(assigneeUserId) || assigneeUserId <= 0) errors.push({ field: \"assignee_user_id\", message: \"\u5FC5\u586B\" });\n\t\tif (email && !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) errors.push({ field: \"email\", message: \"Email \u683C\u5F0F\u932F\u8AA4\" });\n\t\tif (phone && !/^[-+()\\s0-9]{6,}$/.test(phone)) errors.push({ field: \"phone\", message: \"\u96FB\u8A71\u683C\u5F0F\u932F\u8AA4\" });\n\t\tif (errors.length) {\n\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, corsHeaders);\n\t\t}\n\t\ttry {\n\t\t\t// \u6AA2\u67E5\u552F\u4E00/\u5B58\u5728\n\t\t\tconst dup = await env.DATABASE.prepare(\"SELECT 1 FROM Clients WHERE client_id = ? AND is_deleted = 0 LIMIT 1\").bind(clientId).first();\n\t\t\tif (dup) {\n\t\t\t\treturn jsonResponse(409, { ok: false, code: \"CONFLICT\", message: \"\u5BA2\u6236\u5DF2\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\tconst assExist = await env.DATABASE.prepare(\"SELECT 1 FROM Users WHERE user_id = ? AND is_deleted = 0 LIMIT 1\").bind(assigneeUserId).first();\n\t\t\tif (!assExist) {\n\t\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8CA0\u8CAC\u4EBA\u4E0D\u5B58\u5728\", errors: [{ field: \"assignee_user_id\", message: \"\u4E0D\u5B58\u5728\" }], meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\tif (tagIds.length > 0) {\n\t\t\t\tconst placeholders = tagIds.map(() => \"?\").join(\",\");\n\t\t\t\tconst row = await env.DATABASE.prepare(`SELECT COUNT(1) as cnt FROM CustomerTags WHERE tag_id IN (${placeholders})`).bind(...tagIds).first();\n\t\t\t\tif (Number(row?.cnt || 0) !== tagIds.length) {\n\t\t\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u6A19\u7C64\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst contactPerson1 = (body?.contact_person_1 || \"\").trim();\n\t\t\tconst contactPerson2 = (body?.contact_person_2 || \"\").trim();\n\t\t\tconst now = new Date().toISOString();\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\"INSERT INTO Clients (client_id, company_name, contact_person_1, contact_person_2, assignee_user_id, phone, email, client_notes, payment_notes, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\"\n\t\t\t).bind(clientId, companyName, contactPerson1, contactPerson2, assigneeUserId, phone, email, clientNotes, paymentNotes, now, now).run();\n\t\t\tfor (const tagId of tagIds) {\n\t\t\t\tawait env.DATABASE.prepare(\"INSERT OR IGNORE INTO ClientTagAssignments (client_id, tag_id, assigned_at) VALUES (?, ?, ?)\").bind(clientId, tagId, now).run();\n\t\t\t}\n\t\t\tconst data = { clientId, companyName, assigneeUserId, phone, email, clientNotes, paymentNotes, tags: tagIds };\n\t\t\t\n\t\t\t// \u26A1 \u5931\u6548\u5BA2\u6237\u5217\u8868\u7F13\u5B58\n\t\t\tinvalidateCacheByType(env, 'clients_list').catch(err => \n\t\t\t\tconsole.error('[CLIENTS] \u5931\u6548\u7F13\u5B58\u5931\u8D25:', err)\n\t\t\t);\n\t\t\t\n\t\t\treturn jsonResponse(201, { ok: true, code: \"CREATED\", message: \"\u5DF2\u5EFA\u7ACB\", data, meta: { requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\n\t// PUT /api/v1/clients/:id - \u7DE8\u8F2F\u5BA2\u6236\n\tif (method === \"PUT\" && url.pathname.match(/\\/clients\\/[^\\/]+$/)) {\n\t\tconst clientId = url.pathname.split(\"/\").pop();\n\t\tlet body;\n\t\ttry {\n\t\t\tbody = await request.json();\n\t\t} catch (_) {\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tconst errors = [];\n\t\tconst companyName = String(body?.company_name || \"\").trim();\n\t\tconst contactPerson1 = (body?.contact_person_1 || \"\").trim();\n\t\tconst contactPerson2 = (body?.contact_person_2 || \"\").trim();\n\t\tconst assigneeUserId = Number(body?.assignee_user_id || 0);\n\t\tconst phone = (body?.phone || \"\").trim();\n\t\tconst email = (body?.email || \"\").trim();\n\t\tconst clientNotes = (body?.client_notes || \"\").trim();\n\t\tconst paymentNotes = (body?.payment_notes || \"\").trim();\n\t\tconst tagIds = Array.isArray(body?.tag_ids) ? body.tag_ids.map((x) => Number(x)).filter((n) => Number.isFinite(n)) : [];\n\n\t\t// \u9A57\u8B49\n\t\tif (companyName.length < 1 || companyName.length > 100) errors.push({ field: \"company_name\", message: \"\u9577\u5EA6\u9700 1\u2013100\" });\n\t\tif (!Number.isInteger(assigneeUserId) || assigneeUserId <= 0) errors.push({ field: \"assignee_user_id\", message: \"\u5FC5\u586B\" });\n\t\tif (email && !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) errors.push({ field: \"email\", message: \"Email \u683C\u5F0F\u932F\u8AA4\" });\n\t\tif (phone && !/^[-+()\\s0-9]{6,}$/.test(phone)) errors.push({ field: \"phone\", message: \"\u96FB\u8A71\u683C\u5F0F\u932F\u8AA4\" });\n\t\tif (errors.length) {\n\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, corsHeaders);\n\t\t}\n\n\t\ttry {\n\t\t\t// \u6AA2\u67E5\u5BA2\u6236\u662F\u5426\u5B58\u5728\n\t\t\tconst existing = await env.DATABASE.prepare(\"SELECT 1 FROM Clients WHERE client_id = ? AND is_deleted = 0 LIMIT 1\").bind(clientId).first();\n\t\t\tif (!existing) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u5BA2\u6236\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u6AA2\u67E5\u8CA0\u8CAC\u4EBA\u54E1\u662F\u5426\u5B58\u5728\n\t\t\tconst assExist = await env.DATABASE.prepare(\"SELECT 1 FROM Users WHERE user_id = ? AND is_deleted = 0 LIMIT 1\").bind(assigneeUserId).first();\n\t\t\tif (!assExist) {\n\t\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8CA0\u8CAC\u4EBA\u4E0D\u5B58\u5728\", errors: [{ field: \"assignee_user_id\", message: \"\u4E0D\u5B58\u5728\" }], meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u6AA2\u67E5\u6A19\u7C64\u662F\u5426\u5B58\u5728\n\t\t\tif (tagIds.length > 0) {\n\t\t\t\tconst placeholders = tagIds.map(() => \"?\").join(\",\");\n\t\t\t\tconst row = await env.DATABASE.prepare(`SELECT COUNT(1) as cnt FROM CustomerTags WHERE tag_id IN (${placeholders})`).bind(...tagIds).first();\n\t\t\t\tif (Number(row?.cnt || 0) !== tagIds.length) {\n\t\t\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u6A19\u7C64\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tconst now = new Date().toISOString();\n\t\t\t\n\t\t\t// \u66F4\u65B0\u5BA2\u6236\u8CC7\u6599\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\"UPDATE Clients SET company_name = ?, contact_person_1 = ?, contact_person_2 = ?, assignee_user_id = ?, phone = ?, email = ?, client_notes = ?, payment_notes = ?, updated_at = ? WHERE client_id = ?\"\n\t\t\t).bind(companyName, contactPerson1, contactPerson2, assigneeUserId, phone, email, clientNotes, paymentNotes, now, clientId).run();\n\t\t\t\n\t\t\t// \u522A\u9664\u820A\u7684\u6A19\u7C64\u95DC\u806F\n\t\t\tawait env.DATABASE.prepare(\"DELETE FROM ClientTagAssignments WHERE client_id = ?\").bind(clientId).run();\n\t\t\t\n\t\t\t// \u65B0\u589E\u65B0\u7684\u6A19\u7C64\u95DC\u806F\n\t\t\tfor (const tagId of tagIds) {\n\t\t\t\tawait env.DATABASE.prepare(\"INSERT INTO ClientTagAssignments (client_id, tag_id, assigned_at) VALUES (?, ?, ?)\").bind(clientId, tagId, now).run();\n\t\t\t}\n\t\t\t\n\t\t\tconst data = { clientId, companyName, assigneeUserId, phone, email, clientNotes, paymentNotes, tags: tagIds, updatedAt: now };\n\t\t\t\n\t\t\t// \u26A1 \u5931\u6548\u5BA2\u6237\u5217\u8868\u7F13\u5B58\n\t\t\tinvalidateCacheByType(env, 'clients_list').catch(err => \n\t\t\t\tconsole.error('[CLIENTS] \u5931\u6548\u7F13\u5B58\u5931\u8D25:', err)\n\t\t\t);\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok: true, code: \"SUCCESS\", message: \"\u5DF2\u66F4\u65B0\", data, meta: { requestId } }, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\n\t// DELETE /api/v1/clients/:id - \u522A\u9664\u5BA2\u6236\uFF08\u8EDF\u522A\u9664\uFF09\n\tif (method === \"DELETE\" && url.pathname.match(/\\/clients\\/[^\\/]+$/)) {\n\t\tconst clientId = url.pathname.split(\"/\").pop();\n\t\ttry {\n\t\t\t// \u6AA2\u67E5\u5BA2\u6236\u662F\u5426\u5B58\u5728\n\t\t\tconst existing = await env.DATABASE.prepare(\"SELECT 1 FROM Clients WHERE client_id = ? AND is_deleted = 0 LIMIT 1\").bind(clientId).first();\n\t\t\tif (!existing) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u5BA2\u6236\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\tconst now = new Date().toISOString();\n\t\t\t\n\t\t\t// \u8EDF\u522A\u9664\uFF1A\u8A2D\u7F6E is_deleted = 1\uFF0C\u8A18\u9304 deleted_at \u548C deleted_by\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\"UPDATE Clients SET is_deleted = 1, deleted_at = ?, deleted_by = ? WHERE client_id = ?\"\n\t\t\t).bind(now, me.user_id, clientId).run();\n\t\t\t\n\t\t\t// \u26A1 \u5931\u6548\u5BA2\u6237\u5217\u8868\u7F13\u5B58\n\t\t\tinvalidateCacheByType(env, 'clients_list').catch(err => \n\t\t\t\tconsole.error('[CLIENTS] \u5931\u6548\u7F13\u5B58\u5931\u8D25:', err)\n\t\t\t);\n\t\t\t\n\t\t\treturn jsonResponse(200, { \n\t\t\t\tok: true, \n\t\t\t\tcode: \"SUCCESS\", \n\t\t\t\tmessage: \"\u5DF2\u522A\u9664\", \n\t\t\t\tmeta: { requestId } \n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\n\t// POST /api/v1/clients/batch-assign - \u6279\u91CF\u5206\u914D\u8CA0\u8CAC\u4EBA\uFF08\u50C5\u7BA1\u7406\u54E1\uFF09\n\tif (method === \"POST\" && url.pathname === \"/internal/api/v1/clients/batch-assign\") {\n\t\t// \u6AA2\u67E5\u7BA1\u7406\u54E1\u6B0A\u9650\n\t\tif (!me.is_admin) {\n\t\t\treturn jsonResponse(403, { \n\t\t\t\tok: false, \n\t\t\t\tcode: \"FORBIDDEN\", \n\t\t\t\tmessage: \"\u6B0A\u9650\u4E0D\u8DB3\uFF0C\u50C5\u7BA1\u7406\u54E1\u53EF\u57F7\u884C\", \n\t\t\t\tmeta: { requestId } \n\t\t\t}, corsHeaders);\n\t\t}\n\t\t\n\t\tlet body;\n\t\ttry {\n\t\t\tbody = await request.json();\n\t\t} catch (_) {\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tconst errors = [];\n\t\tconst clientIds = Array.isArray(body?.client_ids) ? body.client_ids : [];\n\t\tconst assigneeUserId = Number(body?.assignee_user_id || 0);\n\t\t\n\t\t// \u9A57\u8B49\n\t\tif (clientIds.length === 0) {\n\t\t\terrors.push({ field: \"client_ids\", message: \"\u8ACB\u9078\u64C7\u81F3\u5C11\u4E00\u500B\u5BA2\u6236\" });\n\t\t}\n\t\tif (clientIds.length > 100) {\n\t\t\terrors.push({ field: \"client_ids\", message: \"\u4E00\u6B21\u6700\u591A\u5206\u914D 100 \u500B\u5BA2\u6236\" });\n\t\t}\n\t\tif (!Number.isInteger(assigneeUserId) || assigneeUserId <= 0) {\n\t\t\terrors.push({ field: \"assignee_user_id\", message: \"\u8ACB\u9078\u64C7\u8CA0\u8CAC\u4EBA\u54E1\" });\n\t\t}\n\t\tif (errors.length) {\n\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\ttry {\n\t\t\t// \u6AA2\u67E5\u8CA0\u8CAC\u4EBA\u54E1\u662F\u5426\u5B58\u5728\n\t\t\tconst assExist = await env.DATABASE.prepare(\"SELECT 1 FROM Users WHERE user_id = ? AND is_deleted = 0 LIMIT 1\").bind(assigneeUserId).first();\n\t\t\tif (!assExist) {\n\t\t\t\treturn jsonResponse(422, { \n\t\t\t\t\tok: false, \n\t\t\t\t\tcode: \"VALIDATION_ERROR\", \n\t\t\t\t\tmessage: \"\u8CA0\u8CAC\u4EBA\u4E0D\u5B58\u5728\", \n\t\t\t\t\terrors: [{ field: \"assignee_user_id\", message: \"\u4E0D\u5B58\u5728\" }], \n\t\t\t\t\tmeta: { requestId } \n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\tconst now = new Date().toISOString();\n\t\t\tconst placeholders = clientIds.map(() => \"?\").join(\",\");\n\t\t\t\n\t\t\t// \u6279\u91CF\u66F4\u65B0\n\t\t\tconst result = await env.DATABASE.prepare(\n\t\t\t\t`UPDATE Clients SET assignee_user_id = ?, updated_at = ? WHERE client_id IN (${placeholders}) AND is_deleted = 0`\n\t\t\t).bind(assigneeUserId, now, ...clientIds).run();\n\t\t\t\n\t\t\tconst updatedCount = result?.meta?.changes || 0;\n\t\t\t\n\t\t\treturn jsonResponse(200, { \n\t\t\t\tok: true, \n\t\t\t\tcode: \"SUCCESS\", \n\t\t\t\tmessage: `\u5DF2\u66F4\u65B0 ${updatedCount} \u500B\u5BA2\u6236`, \n\t\t\t\tdata: { updated_count: updatedCount },\n\t\t\t\tmeta: { requestId } \n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\n\t// ==================== \u5BA2\u6237\u670D\u52A1\u7BA1\u7406 API ====================\n\t\n\t// POST /api/v1/clients/:clientId/services - \u65B0\u589E\u5BA2\u6237\u670D\u52A1\uFF08\u65B0\u7ED3\u6784\uFF09\n\tconst matchAddService = url.pathname.match(/^\\/internal\\/api\\/v1\\/clients\\/([^\\/]+)\\/services$/);\n\tconsole.log(`[CLIENTS.JS] \u6AA2\u67E5\u65B0\u589E\u670D\u52D9\u8DEF\u7531: matchAddService =`, matchAddService, `method = ${method}`);\n\tif (method === \"POST\" && matchAddService) {\n\t\tconsole.log('[CLIENTS.JS] \u2705 \u5339\u914D\u65B0\u589E\u670D\u52D9\u8DEF\u7531');\n\t\tconsole.log('[CLIENTS.JS] \u65B0\u589E\u670D\u52D9 - pathname =', url.pathname);\n\t\tconst clientId = matchAddService[1];\n\t\tlet body;\n\t\ttry {\n\t\t\tbody = await request.json();\n\t\t} catch (_) {\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\n\t\tconsole.log('[CLIENTS.JS] \u65B0\u589E\u670D\u52D9 - clientId =', clientId, ' body =', JSON.stringify({\n\t\t\tservice_id: body?.service_id,\n\t\t\tstatus: body?.status,\n\t\t\tservice_cycle: body?.service_cycle,\n\t\t\tstart_date: body?.start_date,\n\t\t\tend_date: body?.end_date\n\t\t}));\n\t\t\n\t\tconst errors = [];\n\t\tconst serviceId = Number(body?.service_id || 0);\n\t\tconst serviceCycle = String(body?.service_cycle || \"monthly\").trim();\n\t\tconst status = String(body?.status || \"active\").trim();\n\t\tconst taskTemplateId = body?.task_template_id ? Number(body.task_template_id) : null;\n\t\tconst autoGenerateTasks = body?.auto_generate_tasks !== false; // \u9ED8\u8BA4true\n\t\tconst startDate = String(body?.start_date || \"\").trim();\n\t\tconst endDate = String(body?.end_date || \"\").trim();\n\t\tconst serviceNotes = String(body?.service_notes || \"\").trim();\n\t\t\n\t\t// \u9A8C\u8BC1\n\t\tif (!serviceId || serviceId <= 0) {\n\t\t\terrors.push({ field: \"service_id\", message: \"\u8ACB\u9078\u64C7\u670D\u52D9\u9805\u76EE\" });\n\t\t}\n\t\tif (![\"monthly\", \"quarterly\", \"yearly\", \"one-time\"].includes(serviceCycle)) {\n\t\t\terrors.push({ field: \"service_cycle\", message: \"\u670D\u52D9\u9031\u671F\u683C\u5F0F\u932F\u8AA4\" });\n\t\t}\n\t\tif (![\"active\", \"suspended\", \"expired\", \"cancelled\"].includes(status)) {\n\t\t\terrors.push({ field: \"status\", message: \"\u72C0\u614B\u683C\u5F0F\u932F\u8AA4\" });\n\t\t}\n\t\tif (startDate && !/^\\d{4}-\\d{2}-\\d{2}$/.test(startDate)) {\n\t\t\terrors.push({ field: \"start_date\", message: \"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD\" });\n\t\t}\n\t\tif (endDate && !/^\\d{4}-\\d{2}-\\d{2}$/.test(endDate)) {\n\t\t\terrors.push({ field: \"end_date\", message: \"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD\" });\n\t\t}\n\t\tif (errors.length) {\n\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\ttry {\n\t\t\t// \u68C0\u67E5\u5BA2\u6237\u662F\u5426\u5B58\u5728\n\t\t\tconst client = await env.DATABASE.prepare(\n\t\t\t\t\"SELECT client_id FROM Clients WHERE client_id = ? AND is_deleted = 0\"\n\t\t\t).bind(clientId).first();\n\t\t\tif (!client) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u5BA2\u6236\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u68C0\u67E5\u670D\u52A1\u662F\u5426\u5B58\u5728\n\t\t\tconst service = await env.DATABASE.prepare(\n\t\t\t\t\"SELECT service_id FROM Services WHERE service_id = ? AND is_active = 1\"\n\t\t\t).bind(serviceId).first();\n\t\t\tif (!service) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u670D\u52D9\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u63D2\u5165\u5BA2\u6237\u670D\u52A1\uFF08\u65B0\u7ED3\u6784\uFF09\n\t\t\tconst result = await env.DATABASE.prepare(\n\t\t\t\t`INSERT INTO ClientServices (client_id, service_id, status, service_cycle, \n\t\t\t\t task_template_id, auto_generate_tasks, start_date, end_date, service_notes)\n\t\t\t\t VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`\n\t\t\t).bind(clientId, serviceId, status, serviceCycle, taskTemplateId, autoGenerateTasks ? 1 : 0,\n\t\t\t\tstartDate || null, endDate || null, serviceNotes).run();\n\n\t\t\tconsole.log('[CLIENTS.JS] \u65B0\u589E\u670D\u52D9 - \u63D2\u5165\u6210\u529F client_service_id =', result?.meta?.last_row_id);\n\t\t\t\n\t\t\tconst clientServiceId = result?.meta?.last_row_id;\n\t\t\t\n\t\t\t// \u26A1 \u5931\u6548\u8BE5\u5BA2\u6237\u7684\u670D\u52A1\u9879\u76EE\u7F13\u5B58\n\t\t\tconst invalidateCacheKey = generateCacheKey('client_services', { clientId });\n\t\t\tinvalidateCache(env, invalidateCacheKey).catch(err => \n\t\t\t\tconsole.error('[CLIENTS] \u5931\u6548\u670D\u52A1\u9879\u76EE\u7F13\u5B58\u5931\u8D25:', err)\n\t\t\t);\n\t\t\t\n\t\t\treturn jsonResponse(201, {\n\t\t\t\tok: true,\n\t\t\t\tcode: \"CREATED\",\n\t\t\t\tmessage: \"\u670D\u52D9\u5DF2\u65B0\u589E\",\n\t\t\t\tdata: { client_service_id: clientServiceId },\n\t\t\t\tmeta: { requestId }\n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\t\n\t// PUT /api/v1/clients/:clientId/services/:serviceId - \u66F4\u65B0\u5BA2\u6237\u670D\u52A1\uFF08\u65B0\u7ED3\u6784\uFF09\n\tconst matchUpdateService = url.pathname.match(/^\\/internal\\/api\\/v1\\/clients\\/([^\\/]+)\\/services\\/(\\d+)$/);\n\tif (method === \"PUT\" && matchUpdateService) {\n\t\tconst clientId = matchUpdateService[1];\n\t\tconst clientServiceId = Number(matchUpdateService[2]);\n\t\tlet body;\n\t\ttry {\n\t\t\tbody = await request.json();\n\t\t} catch (_) {\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tconst errors = [];\n\t\tconst serviceCycle = String(body?.service_cycle || \"monthly\").trim();\n\t\tconst taskTemplateId = body?.task_template_id ? Number(body.task_template_id) : null;\n\t\tconst autoGenerateTasks = body?.auto_generate_tasks !== false; // \u9ED8\u8BA4true\n\t\tconst startDate = String(body?.start_date || \"\").trim();\n\t\tconst endDate = String(body?.end_date || \"\").trim();\n\t\tconst serviceNotes = String(body?.service_notes || \"\").trim();\n\t\tconst status = String(body?.status || \"active\").trim();\n\t\t\n\t\t// \u9A8C\u8BC1\n\t\tif (![\"monthly\", \"quarterly\", \"yearly\", \"one-time\"].includes(serviceCycle)) {\n\t\t\terrors.push({ field: \"service_cycle\", message: \"\u670D\u52D9\u9031\u671F\u683C\u5F0F\u932F\u8AA4\" });\n\t\t}\n\t\tif (![\"active\", \"suspended\", \"expired\", \"cancelled\"].includes(status)) {\n\t\t\terrors.push({ field: \"status\", message: \"\u72C0\u614B\u683C\u5F0F\u932F\u8AA4\" });\n\t\t}\n\t\tif (errors.length) {\n\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\ttry {\n\t\t\t// \u68C0\u67E5\u5BA2\u6237\u670D\u52A1\u662F\u5426\u5B58\u5728\n\t\t\tconst existing = await env.DATABASE.prepare(\n\t\t\t\t\"SELECT client_service_id FROM ClientServices WHERE client_service_id = ? AND client_id = ? AND is_deleted = 0\"\n\t\t\t).bind(clientServiceId, clientId).first();\n\t\t\tif (!existing) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u5BA2\u6236\u670D\u52D9\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u66F4\u65B0\u5BA2\u6237\u670D\u52A1\uFF08\u65B0\u7ED3\u6784\uFF09\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`UPDATE ClientServices SET service_cycle = ?, task_template_id = ?, auto_generate_tasks = ?,\n\t\t\t\t start_date = ?, end_date = ?, service_notes = ?, status = ?\n\t\t\t\t WHERE client_service_id = ?`\n\t\t\t).bind(serviceCycle, taskTemplateId, autoGenerateTasks ? 1 : 0,\n\t\t\t\tstartDate || null, endDate || null, serviceNotes, status, clientServiceId).run();\n\t\t\t\n\t\t\treturn jsonResponse(200, {\n\t\t\t\tok: true,\n\t\t\t\tcode: \"SUCCESS\",\n\t\t\t\tmessage: \"\u670D\u52D9\u5DF2\u66F4\u65B0\",\n\t\t\t\tdata: { client_service_id: clientServiceId },\n\t\t\t\tmeta: { requestId }\n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\t\n\t// DELETE /api/v1/clients/:clientId/services/:serviceId - \u5220\u9664\u5BA2\u6237\u670D\u52A1\n\tif (method === \"DELETE\" && matchUpdateService) {\n\t\tconst clientId = matchUpdateService[1];\n\t\tconst clientServiceId = Number(matchUpdateService[2]);\n\t\t\n\t\ttry {\n\t\t\t// \u68C0\u67E5\u5BA2\u6237\u670D\u52A1\u662F\u5426\u5B58\u5728\n\t\t\tconst existing = await env.DATABASE.prepare(\n\t\t\t\t\"SELECT client_service_id FROM ClientServices WHERE client_service_id = ? AND client_id = ? AND is_deleted = 0\"\n\t\t\t).bind(clientServiceId, clientId).first();\n\t\t\tif (!existing) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u5BA2\u6236\u670D\u52D9\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u8F6F\u5220\u9664\u5BA2\u6237\u670D\u52A1\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\"UPDATE ClientServices SET is_deleted = 1 WHERE client_service_id = ?\"\n\t\t\t).bind(clientServiceId).run();\n\t\t\t\n\t\t\treturn jsonResponse(200, {\n\t\t\t\tok: true,\n\t\t\t\tcode: \"SUCCESS\",\n\t\t\t\tmessage: \"\u670D\u52D9\u5DF2\u522A\u9664\",\n\t\t\t\tmeta: { requestId }\n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\n\treturn jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\n}\n\n\n\n", "/**\r\n * \u4EFB\u52A1\u671F\u9650\u8C03\u6574\u8F85\u52A9\u51FD\u6570\r\n */\r\n\r\n/**\r\n * \u8BA1\u7B97\u65E5\u671F\u5DEE\uFF08\u5929\u6570\uFF09\r\n */\r\nfunction daysBetween(date1Str, date2Str) {\r\n  const d1 = new Date(date1Str);\r\n  const d2 = new Date(date2Str);\r\n  return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));\r\n}\r\n\r\n/**\r\n * \u6DFB\u52A0\u5929\u6570\u5230\u65E5\u671F\r\n */\r\nfunction addDays(dateStr, days) {\r\n  const date = new Date(dateStr);\r\n  date.setDate(date.getDate() + days);\r\n  return date.toISOString().split('T')[0];\r\n}\r\n\r\n/**\r\n * \u68C0\u67E5\u4EFB\u52A1\u662F\u5426\u903E\u671F\r\n */\r\nfunction isTaskOverdue(dueDate, status) {\r\n  if (status === 'completed' || status === 'cancelled') {\r\n    return false;\r\n  }\r\n  const today = new Date().toISOString().split('T')[0];\r\n  return dueDate && dueDate < today;\r\n}\r\n\r\n/**\r\n * \u81EA\u52A8\u8C03\u6574\u540E\u7EED\u4EFB\u52A1\u7684\u5230\u671F\u65E5\uFF08\u5F53\u524D\u7F6E\u4EFB\u52A1\u5B8C\u6210\u5EF6\u8FDF\u65F6\uFF09\r\n * @param {*} env \r\n * @param {*} taskId \u5B8C\u6210\u7684\u4EFB\u52A1ID\r\n * @param {*} userId \u64CD\u4F5C\u7528\u6237ID\r\n */\r\nexport async function autoAdjustDependentTasks(env, taskId, userId) {\r\n  try {\r\n    // \u83B7\u53D6\u521A\u5B8C\u6210\u7684\u4EFB\u52A1\u4FE1\u606F\r\n    const completedTask = await env.DATABASE.prepare(`\r\n      SELECT task_id, due_date, completed_at, original_due_date\r\n      FROM ActiveTasks\r\n      WHERE task_id = ? AND status = 'completed'\r\n    `).bind(taskId).first();\r\n    \r\n    if (!completedTask || !completedTask.due_date || !completedTask.completed_at) {\r\n      return { adjusted: 0, errors: [] };\r\n    }\r\n    \r\n    // \u8BA1\u7B97\u5EF6\u8FDF\u5929\u6570\r\n    const completedDate = completedTask.completed_at.split('T')[0];\r\n    const dueDate = completedTask.due_date;\r\n    const delayDays = daysBetween(dueDate, completedDate);\r\n    \r\n    if (delayDays <= 0) {\r\n      // \u6CA1\u6709\u5EF6\u8FDF\uFF0C\u4E0D\u9700\u8981\u8C03\u6574\r\n      return { adjusted: 0, errors: [] };\r\n    }\r\n    \r\n    console.log(`[\u4EFB\u52A1\u8C03\u6574] \u4EFB\u52A1 ${taskId} \u5EF6\u8FDF\u4E86 ${delayDays} \u5929`);\r\n    \r\n    // \u67E5\u627E\u6240\u6709\u4F9D\u8D56\u6B64\u4EFB\u52A1\u7684\u540E\u7EED\u4EFB\u52A1\r\n    const dependentTasks = await env.DATABASE.prepare(`\r\n      SELECT task_id, task_name, due_date, status\r\n      FROM ActiveTasks\r\n      WHERE prerequisite_task_id = ?\r\n        AND is_deleted = 0\r\n        AND status NOT IN ('completed', 'cancelled')\r\n    `).bind(taskId).all();\r\n    \r\n    const results = { adjusted: 0, errors: [] };\r\n    \r\n    for (const task of (dependentTasks.results || [])) {\r\n      try {\r\n        // \u6700\u591A\u5EF6\u957F7\u5929\uFF08\u53EF\u914D\u7F6E\u7684\u9650\u5236\uFF09\r\n        const adjustDays = Math.min(delayDays, 7);\r\n        const newDueDate = addDays(task.due_date, adjustDays);\r\n        \r\n        // \u66F4\u65B0\u4EFB\u52A1\u5230\u671F\u65E5\r\n        await env.DATABASE.prepare(`\r\n          UPDATE ActiveTasks\r\n          SET due_date = ?,\r\n              due_date_adjusted = 1,\r\n              adjustment_count = adjustment_count + 1,\r\n              last_adjustment_date = datetime('now'),\r\n              can_start_date = ?\r\n          WHERE task_id = ?\r\n        `).bind(newDueDate, completedDate, task.task_id).run();\r\n        \r\n        // \u8BB0\u5F55\u8C03\u6574\u5386\u53F2\r\n        await env.DATABASE.prepare(`\r\n          INSERT INTO TaskDueDateAdjustments (\r\n            task_id, old_due_date, new_due_date, days_changed,\r\n            adjustment_reason, adjustment_type,\r\n            requested_by, is_system_auto\r\n          ) VALUES (?, ?, ?, ?, ?, ?, ?, 1)\r\n        `).bind(\r\n          task.task_id,\r\n          task.due_date,\r\n          newDueDate,\r\n          adjustDays,\r\n          `\u7CFB\u7EDF\u81EA\u52A8\u8C03\u6574\uFF1A\u524D\u7F6E\u4EFB\u52A1 ${completedTask.task_id} \u5EF6\u8FDF ${delayDays} \u5929\u5B8C\u6210`,\r\n          'system_auto',\r\n          userId\r\n        ).run();\r\n        \r\n        results.adjusted++;\r\n        console.log(`[\u4EFB\u52A1\u8C03\u6574] \u5DF2\u81EA\u52A8\u8C03\u6574\u4EFB\u52A1 ${task.task_id} \u7684\u5230\u671F\u65E5\uFF1A${task.due_date} \u2192 ${newDueDate}`);\r\n        \r\n      } catch (err) {\r\n        console.error(`[\u4EFB\u52A1\u8C03\u6574] \u8C03\u6574\u4EFB\u52A1 ${task.task_id} \u5931\u8D25:`, err);\r\n        results.errors.push({\r\n          task_id: task.task_id,\r\n          error: String(err)\r\n        });\r\n      }\r\n    }\r\n    \r\n    return results;\r\n    \r\n  } catch (err) {\r\n    console.error('[\u4EFB\u52A1\u8C03\u6574] autoAdjustDependentTasks \u5931\u8D25:', err);\r\n    throw err;\r\n  }\r\n}\r\n\r\n/**\r\n * \u8BB0\u5F55\u4EFB\u52A1\u72B6\u6001\u66F4\u65B0\r\n */\r\nexport async function recordStatusUpdate(env, taskId, newStatus, userId, notes = {}) {\r\n  try {\r\n    // \u5148\u83B7\u53D6\u5F53\u524D\u72B6\u6001\r\n    const task = await env.DATABASE.prepare(`\r\n      SELECT status FROM ActiveTasks WHERE task_id = ?\r\n    `).bind(taskId).first();\r\n    \r\n    const oldStatus = task?.status || 'pending';\r\n    \r\n    await env.DATABASE.prepare(`\r\n      INSERT INTO TaskStatusUpdates (\r\n        task_id, old_status, new_status, status, updated_by,\r\n        progress_note, blocker_reason, overdue_reason,\r\n        expected_completion_date\r\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `).bind(\r\n      taskId,\r\n      oldStatus,\r\n      newStatus,\r\n      newStatus, // \u4FDD\u6301\u517C\u5BB9\u6027\r\n      userId,\r\n      notes.progress_note || null,\r\n      notes.blocker_reason || null,\r\n      notes.overdue_reason || null,\r\n      notes.expected_completion_date || null\r\n    ).run();\r\n    \r\n    // \u540C\u65F6\u66F4\u65B0\u4EFB\u52A1\u8868\u7684\u5FEB\u7167\u5B57\u6BB5\r\n    await env.DATABASE.prepare(`\r\n      UPDATE ActiveTasks\r\n      SET status_note = ?,\r\n          blocker_reason = ?,\r\n          overdue_reason = ?,\r\n          expected_completion_date = ?,\r\n          last_status_update = datetime('now')\r\n      WHERE task_id = ?\r\n    `).bind(\r\n      notes.progress_note || null,\r\n      notes.blocker_reason || null,\r\n      notes.overdue_reason || null,\r\n      notes.expected_completion_date || null,\r\n      taskId\r\n    ).run();\r\n    \r\n    return { success: true };\r\n  } catch (err) {\r\n    console.error('[\u4EFB\u52A1\u8C03\u6574] recordStatusUpdate \u5931\u8D25:', err);\r\n    throw err;\r\n  }\r\n}\r\n\r\n/**\r\n * \u8BB0\u5F55\u5230\u671F\u65E5\u8C03\u6574\r\n */\r\nexport async function recordDueDateAdjustment(env, taskId, oldDueDate, newDueDate, reason, adjustmentType, userId, isOverdue = false, isInitial = false) {\r\n  try {\r\n    const daysChanged = daysBetween(oldDueDate, newDueDate);\r\n    \r\n    await env.DATABASE.prepare(`\r\n      INSERT INTO TaskDueDateAdjustments (\r\n        task_id, old_due_date, new_due_date, days_changed,\r\n        adjustment_reason, adjustment_type,\r\n        requested_by, is_overdue_adjustment, is_initial_creation\r\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `).bind(\r\n      taskId,\r\n      oldDueDate,\r\n      newDueDate,\r\n      daysChanged,\r\n      reason,\r\n      adjustmentType,\r\n      userId,\r\n      isOverdue ? 1 : 0,\r\n      isInitial ? 1 : 0\r\n    ).run();\r\n    \r\n    // \u66F4\u65B0\u4EFB\u52A1\u8868\r\n    await env.DATABASE.prepare(`\r\n      UPDATE ActiveTasks\r\n      SET due_date = ?,\r\n          due_date_adjusted = 1,\r\n          adjustment_count = adjustment_count + 1,\r\n          last_adjustment_date = datetime('now'),\r\n          adjustment_reason = ?\r\n      WHERE task_id = ?\r\n    `).bind(newDueDate, reason, taskId).run();\r\n    \r\n    return { success: true };\r\n  } catch (err) {\r\n    console.error('[\u4EFB\u52A1\u8C03\u6574] recordDueDateAdjustment \u5931\u8D25:', err);\r\n    throw err;\r\n  }\r\n}\r\n\r\n/**\r\n * \u83B7\u53D6\u4EFB\u52A1\u8C03\u6574\u5386\u53F2\uFF08\u5305\u542B\u5230\u671F\u65E5\u8C03\u6574\u548C\u72B6\u6001\u66F4\u65B0\uFF09\r\n */\r\nexport async function getAdjustmentHistory(env, taskId) {\r\n  try {\r\n    console.log('[\u8C03\u6574\u5386\u53F2] \u5F00\u59CB\u67E5\u8BE2, taskId:', taskId);\r\n    \r\n    // \u83B7\u53D6\u5230\u671F\u65E5\u8C03\u6574\u8BB0\u5F55\r\n    let dueDateAdjustments;\r\n    try {\r\n      dueDateAdjustments = await env.DATABASE.prepare(`\r\n        SELECT \r\n          adjustment_id as id,\r\n          old_due_date,\r\n          new_due_date,\r\n          days_changed,\r\n          adjustment_reason as reason,\r\n          adjustment_type,\r\n          is_overdue_adjustment,\r\n          is_initial_creation,\r\n          is_system_auto,\r\n          requested_at,\r\n          u.name as requested_by_name\r\n        FROM TaskDueDateAdjustments tda\r\n        LEFT JOIN Users u ON u.user_id = tda.requested_by\r\n        WHERE tda.task_id = ?\r\n          AND tda.old_due_date IS NOT NULL\r\n          AND tda.new_due_date IS NOT NULL\r\n          AND tda.adjustment_type IS NOT NULL\r\n        ORDER BY tda.requested_at DESC\r\n      `).bind(taskId).all();\r\n      console.log('[\u8C03\u6574\u5386\u53F2] \u5230\u671F\u65E5\u8C03\u6574\u67E5\u8BE2\u6210\u529F, \u8BB0\u5F55\u6570:', dueDateAdjustments?.results?.length || 0);\r\n    } catch (err) {\r\n      console.error('[\u8C03\u6574\u5386\u53F2] \u5230\u671F\u65E5\u8C03\u6574\u67E5\u8BE2\u5931\u8D25:', err.message);\r\n      throw new Error('\u67E5\u8BE2\u5230\u671F\u65E5\u8C03\u6574\u5931\u8D25: ' + err.message);\r\n    }\r\n    \r\n    // \u83B7\u53D6\u72B6\u6001\u66F4\u65B0\u8BB0\u5F55\r\n    let statusUpdates;\r\n    try {\r\n      statusUpdates = await env.DATABASE.prepare(`\r\n        SELECT \r\n          tsu.update_id as id,\r\n          tsu.old_status,\r\n          tsu.new_status,\r\n          tsu.progress_note,\r\n          tsu.blocker_reason,\r\n          tsu.overdue_reason,\r\n          tsu.updated_at as requested_at,\r\n          u.name as requested_by_name\r\n        FROM TaskStatusUpdates tsu\r\n        LEFT JOIN Users u ON u.user_id = tsu.updated_by\r\n        WHERE tsu.task_id = ?\r\n          AND tsu.old_status IS NOT NULL\r\n          AND tsu.new_status IS NOT NULL\r\n        ORDER BY tsu.updated_at DESC\r\n      `).bind(taskId).all();\r\n      console.log('[\u8C03\u6574\u5386\u53F2] \u72B6\u6001\u66F4\u65B0\u67E5\u8BE2\u6210\u529F, \u8BB0\u5F55\u6570:', statusUpdates?.results?.length || 0);\r\n    } catch (err) {\r\n      console.error('[\u8C03\u6574\u5386\u53F2] \u72B6\u6001\u66F4\u65B0\u67E5\u8BE2\u5931\u8D25:', err.message);\r\n      throw new Error('\u67E5\u8BE2\u72B6\u6001\u66F4\u65B0\u5931\u8D25: ' + err.message);\r\n    }\r\n    \r\n    // \u5408\u5E76\u4E24\u79CD\u8BB0\u5F55\r\n    let allRecords;\r\n    try {\r\n      allRecords = [\r\n        ...(dueDateAdjustments.results || []).map(adj => ({\r\n          record_type: 'due_date',\r\n          id: adj.id,\r\n          old_due_date: adj.old_due_date,\r\n          new_due_date: adj.new_due_date,\r\n          days_changed: adj.days_changed,\r\n          reason: adj.reason || '',\r\n          adjustment_type: adj.adjustment_type,\r\n          is_overdue_adjustment: adj.is_overdue_adjustment === 1,\r\n          is_initial_creation: adj.is_initial_creation === 1,\r\n          is_system_auto: adj.is_system_auto === 1,\r\n          requested_at: adj.requested_at,\r\n          requested_by_name: adj.requested_by_name || ''\r\n        })),\r\n        ...(statusUpdates.results || []).map(upd => ({\r\n          record_type: 'status_update',\r\n          id: upd.id,\r\n          old_status: upd.old_status,\r\n          new_status: upd.new_status,\r\n          progress_note: upd.progress_note || '',\r\n          blocker_reason: upd.blocker_reason || '',\r\n          overdue_reason: upd.overdue_reason || '',\r\n          requested_at: upd.requested_at,\r\n          requested_by_name: upd.requested_by_name || ''\r\n        }))\r\n      ];\r\n      console.log('[\u8C03\u6574\u5386\u53F2] \u5408\u5E76\u8BB0\u5F55\u6210\u529F, \u603B\u6570:', allRecords.length);\r\n    } catch (err) {\r\n      console.error('[\u8C03\u6574\u5386\u53F2] \u5408\u5E76\u8BB0\u5F55\u5931\u8D25:', err.message);\r\n      throw new Error('\u5408\u5E76\u8BB0\u5F55\u5931\u8D25: ' + err.message);\r\n    }\r\n    \r\n    // \u6309\u65F6\u95F4\u6392\u5E8F\uFF08\u6700\u65B0\u7684\u5728\u524D\uFF09\r\n    try {\r\n      allRecords.sort((a, b) => {\r\n        if (!a.requested_at) return 1;\r\n        if (!b.requested_at) return -1;\r\n        return (b.requested_at || '').localeCompare(a.requested_at || '');\r\n      });\r\n      console.log('[\u8C03\u6574\u5386\u53F2] \u6392\u5E8F\u6210\u529F, \u8FD4\u56DE', allRecords.length, '\u6761\u8BB0\u5F55');\r\n    } catch (err) {\r\n      console.error('[\u8C03\u6574\u5386\u53F2] \u6392\u5E8F\u5931\u8D25:', err.message);\r\n      throw new Error('\u6392\u5E8F\u5931\u8D25: ' + err.message);\r\n    }\r\n    \r\n    return allRecords;\r\n  } catch (err) {\r\n    console.error('[\u4EFB\u52A1\u8C03\u6574] getAdjustmentHistory \u5931\u8D25:', err);\r\n    console.error('[\u4EFB\u52A1\u8C03\u6574] \u9519\u8BEF\u5806\u6808:', err.stack);\r\n    throw err;\r\n  }\r\n}\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\nimport { autoAdjustDependentTasks, recordStatusUpdate, recordDueDateAdjustment, getAdjustmentHistory } from \"./task_adjustments.js\";\n\nexport async function handleTasks(request, env, me, requestId, url) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\tconst method = request.method.toUpperCase();\n\t\n\t// GET /api/v1/tasks/:id - \u7372\u53D6\u4EFB\u52D9\u8A73\u60C5\uFF08\u5FC5\u987B\u5728\u5217\u8868\u67E5\u8BE2\u4E4B\u524D\u68C0\u67E5\uFF09\n\tif (method === \"GET\" && url.pathname.match(/\\/tasks\\/\\d+$/)) {\n\t\tconst taskId = url.pathname.split(\"/\").pop();\n\t\ttry {\n\t\tconst task = await env.DATABASE.prepare(\n\t\t\t`SELECT t.task_id, t.task_name, t.due_date, t.status, t.assignee_user_id, t.notes, t.client_service_id,\n\t\t\t        t.completed_date, t.created_at, t.service_month, t.component_id,\n\t\t\t        t.prerequisite_task_id, t.original_due_date, t.due_date_adjusted, t.adjustment_reason,\n\t\t\t        t.adjustment_count, t.last_adjustment_date, t.can_start_date, t.estimated_work_days,\n\t\t\t        t.status_note, t.blocker_reason, t.overdue_reason, t.expected_completion_date,\n\t\t\t        t.is_overdue, t.completed_at, t.last_status_update,\n\t\t\t        c.company_name AS client_name, c.tax_registration_number AS client_tax_id, c.client_id,\n\t\t\t        s.service_name,\n\t\t\t        (SELECT COUNT(1) FROM ActiveTaskStages s WHERE s.task_id = t.task_id) AS total_stages,\n\t\t\t        (SELECT COUNT(1) FROM ActiveTaskStages s WHERE s.task_id = t.task_id AND s.status = 'completed') AS completed_stages,\n\t\t\t        u.name AS assignee_name,\n\t\t\t        pt.task_name AS prerequisite_task_name\n\t\t\t FROM ActiveTasks t\n\t\t\t LEFT JOIN ClientServices cs ON cs.client_service_id = t.client_service_id\n\t\t\t LEFT JOIN Clients c ON c.client_id = cs.client_id\n\t\t\t LEFT JOIN Services s ON s.service_id = cs.service_id\n\t\t\t LEFT JOIN Users u ON u.user_id = t.assignee_user_id\n\t\t\t LEFT JOIN ActiveTasks pt ON pt.task_id = t.prerequisite_task_id AND pt.is_deleted = 0\n\t\t\t WHERE t.task_id = ? AND t.is_deleted = 0`\n\t\t).bind(taskId).first();\n\t\t\t\n\t\t\tif (!task) {\n\t\t\t\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4EFB\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\tconst data = {\n\t\t\t\ttask_id: String(task.task_id),\n\t\t\t\ttask_name: task.task_name,\n\t\t\t\tclient_name: task.client_name || \"\",\n\t\t\t\tclient_tax_id: task.client_tax_id || \"\",\n\t\t\t\tclient_id: task.client_id || \"\",\n\t\t\t\tservice_name: task.service_name || \"\",\n\t\t\t\tservice_month: task.service_month || \"\",\n\t\t\t\tassignee_name: task.assignee_name || \"\",\n\t\t\t\tassignee_user_id: task.assignee_user_id || null,\n\t\t\t\tclient_service_id: task.client_service_id || null,\n\t\t\t\tcomponent_id: task.component_id || null,\n\t\t\t\tcompleted_stages: Number(task.completed_stages || 0),\n\t\t\t\ttotal_stages: Number(task.total_stages || 0),\n\t\t\t\tdue_date: task.due_date || null,\n\t\t\t\toriginal_due_date: task.original_due_date || null,\n\t\t\t\tdue_date_adjusted: Boolean(task.due_date_adjusted),\n\t\t\t\tadjustment_reason: task.adjustment_reason || \"\",\n\t\t\t\tadjustment_count: Number(task.adjustment_count || 0),\n\t\t\t\tlast_adjustment_date: task.last_adjustment_date || null,\n\t\t\t\tcan_start_date: task.can_start_date || null,\n\t\t\t\testimated_work_days: Number(task.estimated_work_days || 3),\n\t\t\t\tprerequisite_task_id: task.prerequisite_task_id || null,\n\t\t\t\tprerequisite_task_name: task.prerequisite_task_name || null,\n\t\t\t\tstatus: task.status,\n\t\t\t\tstatus_note: task.status_note || \"\",\n\t\t\t\tblocker_reason: task.blocker_reason || \"\",\n\t\t\t\toverdue_reason: task.overdue_reason || \"\",\n\t\t\t\texpected_completion_date: task.expected_completion_date || null,\n\t\t\t\tis_overdue: Boolean(task.is_overdue),\n\t\t\t\tlast_status_update: task.last_status_update || null,\n\t\t\t\tnotes: task.notes || \"\",\n\t\t\t\tcompleted_date: task.completed_date || null,\n\t\t\t\tcompleted_at: task.completed_at || null,\n\t\t\t\tcreated_at: task.created_at || null\n\t\t\t};\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err) }));\n\t\t\tconst body = { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\t\n\t// GET /api/v1/tasks/:id/sops - \u7372\u53D6\u4EFB\u52D9\u95DC\u806F\u7684SOP\uFF08\u5FC5\u987B\u5728\u5217\u8868\u67E5\u8BE2\u4E4B\u524D\uFF09\n\tif (method === \"GET\" && url.pathname.match(/\\/tasks\\/\\d+\\/sops$/)) {\n\t\tconst taskId = url.pathname.split(\"/\")[url.pathname.split(\"/\").length - 2];\n\t\ttry {\n\t\t\tconst sops = await env.DATABASE.prepare(\n\t\t\t\t`SELECT s.sop_id, s.title, s.category, s.version\n\t\t\t\t FROM ActiveTaskSOPs ats\n\t\t\t\t JOIN SOPDocuments s ON s.sop_id = ats.sop_id\n\t\t\t\t WHERE ats.task_id = ? AND s.is_deleted = 0\n\t\t\t\t ORDER BY ats.sort_order ASC`\n\t\t\t).bind(taskId).all();\n\t\t\t\n\t\t\tconst data = (sops?.results || []).map(s => ({\n\t\t\t\tid: s.sop_id,\n\t\t\t\ttitle: s.title,\n\t\t\t\tcategory: s.category || \"\",\n\t\t\t\tversion: s.version || 1\n\t\t\t}));\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// PUT /api/v1/tasks/:id/sops - \u66F4\u65B0\u4EFB\u52D9\u95DC\u806F\u7684SOP\uFF08\u5FC5\u987B\u5728\u5217\u8868\u67E5\u8BE2\u4E4B\u524D\uFF09\n\tif (method === \"PUT\" && url.pathname.match(/\\/tasks\\/\\d+\\/sops$/)) {\n\t\tconst taskId = url.pathname.split(\"/\")[url.pathname.split(\"/\").length - 2];\n\t\tlet body;\n\t\ttry { body = await request.json(); } catch (_) {\n\t\t\treturn jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tconst sopIds = Array.isArray(body?.sop_ids) ? body.sop_ids : [];\n\t\t\n\t\ttry {\n\t\t\t// \u522A\u9664\u73FE\u6709\u95DC\u806F\n\t\t\tawait env.DATABASE.prepare(`DELETE FROM ActiveTaskSOPs WHERE task_id = ?`).bind(taskId).run();\n\t\t\t\n\t\t\t// \u6DFB\u52A0\u65B0\u95DC\u806F\n\t\t\tfor (let i = 0; i < sopIds.length; i++) {\n\t\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\t`INSERT INTO ActiveTaskSOPs (task_id, sop_id, sort_order) VALUES (?, ?, ?)`\n\t\t\t\t).bind(taskId, sopIds[i], i).run();\n\t\t\t}\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u66F4\u65B0\", meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\t\n\t// GET /api/v1/tasks - \u7372\u53D6\u4EFB\u52D9\u5217\u8868\uFF08\u5FC5\u987B\u7CBE\u786E\u5339\u914D\uFF0C\u907F\u514D\u62E6\u622A\u5B50\u8DEF\u5F84\uFF09\n\tif (method === \"GET\" && url.pathname.match(/\\/tasks$/)) {\n\t\ttry {\n\t\t\tconst params = url.searchParams;\n\t\t\tconst page = Math.max(1, parseInt(params.get(\"page\") || \"1\", 10));\n\t\t\tconst perPage = Math.min(100, Math.max(1, parseInt(params.get(\"perPage\") || \"20\", 10)));\n\t\t\tconst offset = (page - 1) * perPage;\n\t\t\tconst q = (params.get(\"q\") || \"\").trim();\n\t\t\tconst status = (params.get(\"status\") || \"\").trim();\n\t\t\tconst due = (params.get(\"due\") || \"\").trim();\n\t\t\tconst componentId = (params.get(\"component_id\") || \"\").trim();\n\t\t\tconst serviceYear = (params.get(\"service_year\") || \"\").trim();\n\t\t\tconst serviceMonth = (params.get(\"service_month\") || \"\").trim();\n\t\t\tconst hideCompleted = params.get(\"hide_completed\") === \"1\";\n\t\t\tconst where = [\"t.is_deleted = 0\"];\n\t\t\tconst binds = [];\n\t\t\tif (!me.is_admin && !componentId) {\n\t\t\t\twhere.push(\"t.assignee_user_id = ?\");\n\t\t\t\tbinds.push(String(me.user_id));\n\t\t\t}\n\t\t\tif (componentId) {\n\t\t\t\twhere.push(\"t.component_id = ?\");\n\t\t\t\tbinds.push(componentId);\n\t\t\t}\n\t\t\tif (q) {\n\t\t\t\twhere.push(\"(t.task_name LIKE ? OR c.company_name LIKE ? OR c.tax_registration_number LIKE ?)\");\n\t\t\t\tbinds.push(`%${q}%`, `%${q}%`, `%${q}%`);\n\t\t\t}\n\t\t\tif (status && [\"in_progress\",\"completed\",\"cancelled\"].includes(status)) {\n\t\t\t\twhere.push(\"t.status = ?\");\n\t\t\t\tbinds.push(status);\n\t\t\t}\n\t\t\tif (due === \"overdue\") {\n\t\t\t\twhere.push(\"date(t.due_date) < date('now') AND t.status != 'completed'\");\n\t\t\t}\n\t\t\tif (due === \"soon\") {\n\t\t\t\twhere.push(\"date(t.due_date) BETWEEN date('now') AND date('now','+3 days')\");\n\t\t\t}\n\t\t\t// \u6309\u670D\u52A1\u6708\u4EFD\u7B5B\u9009\n\t\t\tif (serviceYear && serviceMonth) {\n\t\t\t\twhere.push(\"t.service_month = ?\");\n\t\t\t\tbinds.push(`${serviceYear}-${serviceMonth.padStart(2, '0')}`);\n\t\t\t} else if (serviceYear) {\n\t\t\t\twhere.push(\"t.service_month LIKE ?\");\n\t\t\t\tbinds.push(`${serviceYear}-%`);\n\t\t\t}\n\t\t\t// \u9690\u85CF\u5DF2\u5B8C\u6210\u4EFB\u52A1\n\t\t\tif (hideCompleted) {\n\t\t\t\twhere.push(\"t.status != 'completed'\");\n\t\t\t}\n\t\t\tconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\n\t\t\tconst countRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT COUNT(1) as total\n\t\t\t\t FROM ActiveTasks t\n\t\t\t\t LEFT JOIN ClientServices cs ON cs.client_service_id = t.client_service_id\n\t\t\t\t LEFT JOIN Clients c ON c.client_id = cs.client_id\n\t\t\t\t ${whereSql}`\n\t\t\t).bind(...binds).first();\n\t\t\tconst total = Number(countRow?.total || 0);\n\t\t\tconst rows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT t.task_id, t.task_name, t.due_date, t.original_due_date, t.status, t.assignee_user_id, t.notes, t.service_month, t.component_id,\n\t\t\t\t        t.prerequisite_task_id, t.is_overdue, t.due_date_adjusted, t.adjustment_count, t.overdue_reason,\n\t\t\t\t        t.client_service_id, cs.service_id,\n\t\t\t\t        c.company_name AS client_name, c.tax_registration_number AS client_tax_id, c.client_id,\n\t\t\t\t        s.service_name,\n\t\t\t\t        (SELECT COUNT(1) FROM ActiveTaskStages s WHERE s.task_id = t.task_id) AS total_stages,\n\t\t\t\t        (SELECT COUNT(1) FROM ActiveTaskStages s WHERE s.task_id = t.task_id AND s.status = 'completed') AS completed_stages,\n\t\t\t\t        (CASE WHEN t.related_sop_id IS NOT NULL OR t.client_specific_sop_id IS NOT NULL THEN 1 ELSE 0 END) AS has_sop,\n\t\t\t\t        u.name AS assignee_name,\n\t\t\t\t        pt.task_name AS prerequisite_task_name\n\t\t\t\t FROM ActiveTasks t\n\t\t\t\t LEFT JOIN ClientServices cs ON cs.client_service_id = t.client_service_id\n\t\t\t\t LEFT JOIN Clients c ON c.client_id = cs.client_id\n\t\t\t\t LEFT JOIN Services s ON s.service_id = cs.service_id\n\t\t\t\t LEFT JOIN Users u ON u.user_id = t.assignee_user_id\n\t\t\t\t LEFT JOIN ActiveTasks pt ON pt.task_id = t.prerequisite_task_id AND pt.is_deleted = 0\n\t\t\t\t ${whereSql}\n\t\t\t\t ORDER BY c.company_name ASC, s.service_name ASC, t.service_month DESC, date(t.due_date) ASC NULLS LAST, t.task_id DESC\n\t\t\t\t LIMIT ? OFFSET ?`\n\t\t\t).bind(...binds, perPage, offset).all();\n\t\t\tconst data = (rows?.results || []).map((r) => ({\n\t\t\t\ttaskId: String(r.task_id),\n\t\t\t\ttaskName: r.task_name,\n\t\t\t\tclientName: r.client_name || \"\",\n\t\t\t\tclientTaxId: r.client_tax_id || \"\",\n\t\t\t\tclientId: r.client_id || \"\",\n\t\t\t\tclientServiceId: r.client_service_id || null,\n\t\t\t\tserviceId: r.service_id || null,\n\t\t\t\tserviceName: r.service_name || \"\",\n\t\t\t\tserviceMonth: r.service_month || \"\",\n\t\t\t\tcomponentId: r.component_id || null,\n\t\t\t\tassigneeName: r.assignee_name || \"\",\n\t\t\t\tassigneeUserId: r.assignee_user_id || null,\n\t\t\t\tprogress: { completed: Number(r.completed_stages || 0), total: Number(r.total_stages || 0) },\n\t\t\t\tdueDate: r.due_date || null,\n\t\t\t\toriginalDueDate: r.original_due_date || null,\n\t\t\t\tdueDateAdjusted: Boolean(r.due_date_adjusted),\n\t\t\t\tadjustmentCount: Number(r.adjustment_count || 0),\n\t\t\t\tprerequisiteTaskId: r.prerequisite_task_id || null,\n\t\t\t\tprerequisiteTaskName: r.prerequisite_task_name || null,\n\t\t\t\tisOverdue: Boolean(r.is_overdue),\n\t\t\t\toverdueReason: r.overdue_reason || \"\",\n\t\t\t\tstatus: r.status,\n\t\t\t\tnotes: r.notes || \"\",\n\t\t\t\thasSop: Number(r.has_sop || 0) === 1,\n\t\t\t}));\n\t\t\tconst meta = { requestId, page, perPage, total, hasNext: offset + perPage < total };\n\t\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u6210\u529F\", data, meta }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, getCorsHeadersForRequest(request, env));\n\t\t}\n\t}\n\n\t// POST /api/v1/tasks - \u65B0\u589E\u4EFB\u52A1\uFF08\u5FC5\u987B\u7CBE\u786E\u5339\u914D\u8DEF\u5F84\uFF0C\u907F\u514D\u5339\u914D\u5230\u5B50\u8DEF\u5F84\uFF09\n\tif (method === \"POST\" && url.pathname.match(/\\/tasks$/)) {\n\t\tlet body;\n\t\ttry { body = await request.json(); } catch (_) {\n\t\t\treturn jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\tconst clientServiceId = Number(body?.client_service_id || 0);\n\t\tconst taskName = String(body?.task_name || \"\").trim();\n\t\tconst dueDate = body?.due_date ? String(body.due_date) : null;\n\t\tconst assigneeUserId = body?.assignee_user_id ? Number(body.assignee_user_id) : null;\n\t\tconst stageNames = Array.isArray(body?.stage_names) ? body.stage_names.filter(s => typeof s === 'string' && s.trim().length > 0).map(s => s.trim()) : [];\n\t\tconst prerequisiteTaskId = body?.prerequisite_task_id ? Number(body.prerequisite_task_id) : null;\n\t\t\n\t\t// \u671F\u9650\u8C03\u6574\u76F8\u5173\n\t\tconst defaultDueDate = body?.default_due_date ? String(body.default_due_date) : null; // \u7CFB\u7EDF\u9884\u8BBE\u671F\u9650\n\t\tconst adjustmentReason = body?.adjustment_reason ? String(body.adjustment_reason).trim() : null; // \u8C03\u6574\u539F\u56E0\n\t\t\n\t\t// service_month: \u9ED8\u8BA4\u5F53\u524D\u6708\u4EFD\uFF0C\u4F46\u5141\u8BB8\u7528\u6237\u6307\u5B9A\n\t\tlet serviceMonth = body?.service_month ? String(body.service_month).trim() : null;\n\t\tif (!serviceMonth) {\n\t\t\tconst now = new Date();\n\t\t\tconst year = now.getFullYear();\n\t\t\tconst month = String(now.getMonth() + 1).padStart(2, '0');\n\t\t\tserviceMonth = `${year}-${month}`;\n\t\t}\n\t\t\n\t\tconst errors = [];\n\t\tif (!Number.isInteger(clientServiceId) || clientServiceId <= 0) errors.push({ field:\"client_service_id\", message:\"\u5FC5\u586B\" });\n\t\tif (taskName.length < 1 || taskName.length > 200) errors.push({ field:\"task_name\", message:\"\u9577\u5EA6\u9700 1\u2013200\" });\n\t\tif (dueDate && !/^\\d{4}-\\d{2}-\\d{2}$/.test(dueDate)) errors.push({ field:\"due_date\", message:\"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD\" });\n\t\tif (serviceMonth && !/^\\d{4}-\\d{2}$/.test(serviceMonth)) errors.push({ field:\"service_month\", message:\"\u683C\u5F0F\u9700 YYYY-MM\" });\n\t\tif (assigneeUserId !== null && (!Number.isInteger(assigneeUserId) || assigneeUserId <= 0)) errors.push({ field:\"assignee_user_id\", message:\"\u683C\u5F0F\u932F\u8AA4\" });\n\t\t\n\t\t// \u5982\u679C\u63D0\u4F9B\u4E86default_due_date\u4E14\u5B9E\u9645due_date\u4E0E\u4E4B\u4E0D\u540C\uFF0C\u5FC5\u987B\u586B\u5199\u539F\u56E0\n\t\tif (defaultDueDate && dueDate && defaultDueDate !== dueDate && !adjustmentReason) {\n\t\t\terrors.push({ field:\"adjustment_reason\", message:\"\u8ABF\u6574\u9810\u8A2D\u671F\u9650\u6642\u5FC5\u9808\u586B\u5BEB\u539F\u56E0\" });\n\t\t}\n\t\t\n\t\tif (errors.length) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\n\n\t\ttry {\n\t\t\tconst cs = await env.DATABASE.prepare(\"SELECT client_service_id FROM ClientServices WHERE client_service_id = ? LIMIT 1\").bind(clientServiceId).first();\n\t\t\tif (!cs) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u5BA2\u6236\u670D\u52D9\u4E0D\u5B58\u5728\", errors:[{ field:\"client_service_id\", message:\"\u4E0D\u5B58\u5728\" }], meta:{ requestId } }, corsHeaders);\n\t\t\tif (assigneeUserId) {\n\t\t\t\tconst u = await env.DATABASE.prepare(\"SELECT 1 FROM Users WHERE user_id = ? AND is_deleted = 0 LIMIT 1\").bind(assigneeUserId).first();\n\t\t\t\tif (!u) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8CA0\u8CAC\u4EBA\u4E0D\u5B58\u5728\", errors:[{ field:\"assignee_user_id\", message:\"\u4E0D\u5B58\u5728\" }], meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\tconst now = new Date().toISOString();\n\t\tconst originalDueDate = defaultDueDate || dueDate; // \u4FDD\u5B58\u539F\u59CB\u671F\u9650\n\t\t\n\t\t// \u9884\u8BA1\u5B8C\u6210\u65E5\u671F\u9ED8\u8BA4\u7B49\u4E8E\u5230\u671F\u65E5\n\t\tconst expectedCompletionDate = dueDate;\n\t\t\n\t\tawait env.DATABASE.prepare(`\n\t\t\tINSERT INTO ActiveTasks (\n\t\t\t\tclient_service_id, template_id, task_name, start_date, due_date, service_month, \n\t\t\t\tstatus, assignee_user_id, prerequisite_task_id, original_due_date, \n\t\t\t\texpected_completion_date, created_at\n\t\t\t) VALUES (?, NULL, ?, NULL, ?, ?, 'in_progress', ?, ?, ?, ?, ?)\n\t\t`).bind(clientServiceId, taskName, dueDate, serviceMonth, assigneeUserId, prerequisiteTaskId, originalDueDate, expectedCompletionDate, now).run();\n\t\t\t\n\t\t\tconst idRow = await env.DATABASE.prepare(\"SELECT last_insert_rowid() AS id\").first();\n\t\t\tconst taskId = String(idRow?.id);\n\t\t\t\n\t\t\t// \u5982\u679C\u8C03\u6574\u4E86\u9ED8\u8BA4\u671F\u9650\uFF0C\u8BB0\u5F55\u8C03\u6574\u5386\u53F2\n\t\t\tif (defaultDueDate && dueDate && defaultDueDate !== dueDate && adjustmentReason) {\n\t\t\t\tawait recordDueDateAdjustment(\n\t\t\t\t\tenv,\n\t\t\t\t\ttaskId,\n\t\t\t\t\tdefaultDueDate,\n\t\t\t\t\tdueDate,\n\t\t\t\t\tadjustmentReason,\n\t\t\t\t\t'initial_create',\n\t\t\t\t\tme.user_id,\n\t\t\t\t\tfalse,\n\t\t\t\t\ttrue // \u6807\u8BB0\u4E3A\u521D\u59CB\u521B\u5EFA\u65F6\u7684\u8C03\u6574\n\t\t\t\t);\n\t\t\t}\n\t\t\t\n\t\t\tif (stageNames.length > 0) {\n\t\t\t\tlet order = 1;\n\t\t\t\tfor (const s of stageNames) {\n\t\t\t\t\tawait env.DATABASE.prepare(\"INSERT INTO ActiveTaskStages (task_id, stage_name, stage_order, status) VALUES (?, ?, ?, 'pending')\").bind(taskId, s, order++).run();\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\treturn jsonResponse(201, { ok:true, code:\"CREATED\", message:\"\u5DF2\u5EFA\u7ACB\", data:{ taskId, taskName, clientServiceId, dueDate, serviceMonth, assigneeUserId }, meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err) }));\n\t\t\tconst body = { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\n\t// PUT /api/v1/tasks/:id - \u66F4\u65B0\u4EFB\u52D9\uFF08\u542B\u5206\u914D\u8CA0\u8CAC\u4EBA\uFF09\n\tif (method === \"PUT\" && url.pathname.match(/\\/tasks\\/\\d+$/)) {\n\t\tconst taskId = url.pathname.split(\"/\").pop();\n\t\tlet body;\n\t\ttry { body = await request.json(); } catch (_) {\n\t\t\treturn jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\n\t\tconst errors = [];\n\t\tconst updates = [];\n\t\tconst binds = [];\n\n\t\t// \u53EF\u66F4\u65B0\u7684\u6B04\u4F4D\n\t\tif (body.hasOwnProperty('task_name')) {\n\t\t\tconst taskName = String(body.task_name || \"\").trim();\n\t\t\tif (taskName.length < 1 || taskName.length > 200) errors.push({ field:\"task_name\", message:\"\u9577\u5EA6\u9700 1\u2013200\" });\n\t\t\telse { updates.push(\"task_name = ?\"); binds.push(taskName); }\n\t\t}\n\t\tif (body.hasOwnProperty('due_date')) {\n\t\t\tconst dueDate = body.due_date ? String(body.due_date) : null;\n\t\t\tif (dueDate && !/^\\d{4}-\\d{2}-\\d{2}$/.test(dueDate)) errors.push({ field:\"due_date\", message:\"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD\" });\n\t\t\telse { updates.push(\"due_date = ?\"); binds.push(dueDate); }\n\t\t}\n\t\tif (body.hasOwnProperty('status')) {\n\t\t\tconst status = String(body.status || \"\").trim();\n\t\t\tif (![\"in_progress\",\"completed\",\"cancelled\"].includes(status)) errors.push({ field:\"status\", message:\"\u72C0\u614B\u7121\u6548\" });\n\t\t\telse { \n\t\t\t\tupdates.push(\"status = ?\"); \n\t\t\t\tbinds.push(status);\n\t\t\t\tif (status === \"completed\") {\n\t\t\t\t\tupdates.push(\"completed_date = ?\");\n\t\t\t\t\tbinds.push(new Date().toISOString());\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (body.hasOwnProperty('assignee_user_id')) {\n\t\t\tconst assigneeUserId = body.assignee_user_id ? Number(body.assignee_user_id) : null;\n\t\t\tif (assigneeUserId !== null && (!Number.isInteger(assigneeUserId) || assigneeUserId <= 0)) {\n\t\t\t\terrors.push({ field:\"assignee_user_id\", message:\"\u683C\u5F0F\u932F\u8AA4\" });\n\t\t\t} else {\n\t\t\t\t// \u9A57\u8B49\u8CA0\u8CAC\u4EBA\u662F\u5426\u5B58\u5728\n\t\t\t\tif (assigneeUserId) {\n\t\t\t\t\tconst u = await env.DATABASE.prepare(\"SELECT 1 FROM Users WHERE user_id = ? AND is_deleted = 0 LIMIT 1\").bind(assigneeUserId).first();\n\t\t\t\t\tif (!u) {\n\t\t\t\t\t\terrors.push({ field:\"assignee_user_id\", message:\"\u8CA0\u8CAC\u4EBA\u4E0D\u5B58\u5728\" });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (errors.length === 0) {\n\t\t\t\t\tupdates.push(\"assignee_user_id = ?\");\n\t\t\t\t\tbinds.push(assigneeUserId);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (body.hasOwnProperty('notes')) {\n\t\t\tconst notes = String(body.notes || \"\").trim();\n\t\t\tupdates.push(\"notes = ?\");\n\t\t\tbinds.push(notes || null);\n\t\t}\n\t\tif (body.hasOwnProperty('service_month')) {\n\t\t\tconst serviceMonth = body.service_month ? String(body.service_month).trim() : null;\n\t\t\tif (serviceMonth && !/^\\d{4}-\\d{2}$/.test(serviceMonth)) {\n\t\t\t\terrors.push({ field:\"service_month\", message:\"\u683C\u5F0F\u9700 YYYY-MM\" });\n\t\t\t} else {\n\t\t\t\tupdates.push(\"service_month = ?\");\n\t\t\t\tbinds.push(serviceMonth);\n\t\t\t}\n\t\t}\n\n\t\tif (errors.length) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\n\t\tif (updates.length === 0) return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u6C92\u6709\u8981\u66F4\u65B0\u7684\u6B04\u4F4D\", meta:{ requestId } }, corsHeaders);\n\n\t\ttry {\n\t\t\t// \u6AA2\u67E5\u4EFB\u52D9\u662F\u5426\u5B58\u5728\n\t\t\tconst task = await env.DATABASE.prepare(\"SELECT task_id, assignee_user_id FROM ActiveTasks WHERE task_id = ? AND is_deleted = 0 LIMIT 1\").bind(taskId).first();\n\t\t\tif (!task) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4EFB\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\n\n\t\t\t// \u6B0A\u9650\u6AA2\u67E5\uFF1A\u53EA\u6709\u7BA1\u7406\u54E1\u6216\u4EFB\u52D9\u8CA0\u8CAC\u4EBA\u53EF\u4EE5\u66F4\u65B0\n\t\t\tif (!me.is_admin && Number(task.assignee_user_id) !== Number(me.user_id)) {\n\t\t\t\treturn jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u7121\u6B0A\u9650\u66F4\u65B0\u6B64\u4EFB\u52D9\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\n\t\t\t// \u57F7\u884C\u66F4\u65B0\n\t\t\tconst sql = `UPDATE ActiveTasks SET ${updates.join(\", \")} WHERE task_id = ?`;\n\t\t\tawait env.DATABASE.prepare(sql).bind(...binds, taskId).run();\n\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u66F4\u65B0\", data:{ taskId }, meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err) }));\n\t\t\tconst body = { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\n\t// GET /api/v1/tasks/:id/stages - \u7372\u53D6\u4EFB\u52D9\u968E\u6BB5\n\tif (method === \"GET\" && url.pathname.match(/\\/tasks\\/\\d+\\/stages$/)) {\n\t\tconst taskId = url.pathname.split(\"/\")[url.pathname.split(\"/\").length - 2];\n\t\ttry {\n\t\t\tconst stages = await env.DATABASE.prepare(\n\t\t\t\t`SELECT active_stage_id, stage_name, stage_order, status, started_at, completed_at\n\t\t\t\t FROM ActiveTaskStages\n\t\t\t\t WHERE task_id = ?\n\t\t\t\t ORDER BY stage_order ASC`\n\t\t\t).bind(taskId).all();\n\t\t\t\n\t\t\tconst data = (stages?.results || []).map(s => ({\n\t\t\t\tstage_id: s.active_stage_id,\n\t\t\t\tstage_name: s.stage_name,\n\t\t\t\tstage_order: s.stage_order,\n\t\t\t\tstatus: s.status,\n\t\t\t\tstarted_at: s.started_at,\n\t\t\t\tcompleted_at: s.completed_at\n\t\t\t}));\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// POST /api/v1/tasks/:id/stages/:stageId/start - \u958B\u59CB\u968E\u6BB5\n\tif (method === \"POST\" && url.pathname.match(/\\/tasks\\/\\d+\\/stages\\/\\d+\\/start$/)) {\n\t\tconst parts = url.pathname.split(\"/\");\n\t\tconst taskId = parts[parts.length - 4];\n\t\tconst stageId = parts[parts.length - 2];\n\t\ttry {\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`UPDATE ActiveTaskStages SET status = 'in_progress', started_at = ? WHERE active_stage_id = ?`\n\t\t\t).bind(new Date().toISOString(), stageId).run();\n\t\t\t\n\t\t\t// \u6CE8\u610F\uFF1A\u5DF2\u79FB\u9664 pending \u72B6\u6001\uFF0C\u65B0\u4EFB\u52A1\u9ED8\u8BA4\u4E3A in_progress\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u958B\u59CB\", meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// POST /api/v1/tasks/:id/stages/:stageId/complete - \u5B8C\u6210\u968E\u6BB5\n\tif (method === \"POST\" && url.pathname.match(/\\/tasks\\/\\d+\\/stages\\/\\d+\\/complete$/)) {\n\t\tconst parts = url.pathname.split(\"/\");\n\t\tconst taskId = parts[parts.length - 4];\n\t\tconst stageId = parts[parts.length - 2];\n\t\ttry {\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`UPDATE ActiveTaskStages SET status = 'completed', completed_at = ? WHERE active_stage_id = ?`\n\t\t\t).bind(new Date().toISOString(), stageId).run();\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u5B8C\u6210\", meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\t\n\t// POST /api/v1/tasks/:id/update-status - \u66F4\u65B0\u4EFB\u52A1\u72B6\u6001\uFF08\u903E\u671F\u5FC5\u586B\u539F\u56E0\uFF09\n\tif (method === \"POST\" && url.pathname.match(/\\/tasks\\/\\d+\\/update-status$/)) {\n\t\tconst taskId = url.pathname.split(\"/\")[url.pathname.split(\"/\").length - 2];\n\t\tlet body;\n\t\ttry { body = await request.json(); } catch (_) {\n\t\t\treturn jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tconst status = body?.status;\n\t\tconst progress_note = (body?.progress_note || '').trim() || null;\n\t\tconst blocker_reason = (body?.blocker_reason || '').trim() || null;\n\t\tconst overdue_reason = (body?.overdue_reason || '').trim() || null;\n\t\tconst expected_completion_date = body?.expected_completion_date || null;\n\t\t\n\t\tconsole.log('[\u4EFB\u52A1\u72B6\u6001\u66F4\u65B0] \u6536\u5230\u6570\u636E:', { status, progress_note, overdue_reason, blocker_reason, expected_completion_date });\n\t\t\n\t\tconst errors = [];\n\t\tif (!['in_progress', 'completed', 'cancelled'].includes(status)) {\n\t\t\terrors.push({ field: 'status', message: '\u72B6\u6001\u65E0\u6548' });\n\t\t}\n\t\t\n\t\ttry {\n\t\t\t// \u83B7\u53D6\u4EFB\u52A1\u4FE1\u606F\n\t\t\tconst task = await env.DATABASE.prepare(`\n\t\t\t\tSELECT task_id, due_date, status as current_status\n\t\t\t\tFROM ActiveTasks\n\t\t\t\tWHERE task_id = ? AND is_deleted = 0\n\t\t\t`).bind(taskId).first();\n\t\t\t\n\t\t\tif (!task) {\n\t\t\t\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4EFB\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u68C0\u67E5\u662F\u5426\u903E\u671F\n\t\t\tconst today = new Date().toISOString().split('T')[0];\n\t\t\tconst isOverdue = task.due_date && task.due_date < today && task.current_status !== 'completed';\n\t\t\t\n\t\t\tconsole.log('[\u4EFB\u52A1\u72B6\u6001\u66F4\u65B0] \u903E\u671F\u68C0\u67E5:', { due_date: task.due_date, today, isOverdue, overdue_reason });\n\t\t\t\n\t\t\t// \u5982\u679C\u4EFB\u52A1\u903E\u671F\uFF0C\u5FC5\u987B\u586B\u5199\u903E\u671F\u539F\u56E0\n\t\t\tif (isOverdue && !overdue_reason) {\n\t\t\t\terrors.push({ field: 'overdue_reason', message: '\u4EFB\u52A1\u903E\u671F\uFF0C\u5FC5\u987B\u586B\u5199\u903E\u671F\u539F\u56E0' });\n\t\t\t}\n\t\t\t\n\t\t\tif (errors.length) {\n\t\t\t\tconsole.log('[\u4EFB\u52A1\u72B6\u6001\u66F4\u65B0] \u9A8C\u8BC1\u5931\u8D25:', errors);\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u8BB0\u5F55\u72B6\u6001\u66F4\u65B0\n\t\t\tawait recordStatusUpdate(env, taskId, status, me.user_id, {\n\t\t\t\tprogress_note,\n\t\t\t\tblocker_reason,\n\t\t\t\toverdue_reason,\n\t\t\t\texpected_completion_date\n\t\t\t});\n\t\t\t\n\t\t\t// \u66F4\u65B0\u4EFB\u52A1\u72B6\u6001\n\t\t\tlet completedAt = null;\n\t\t\tif (status === 'completed') {\n\t\t\t\tcompletedAt = new Date().toISOString();\n\t\t\t}\n\t\t\t\n\t\t\tawait env.DATABASE.prepare(`\n\t\t\t\tUPDATE ActiveTasks\n\t\t\t\tSET status = ?,\n\t\t\t\t\tcompleted_at = ?,\n\t\t\t\t\tis_overdue = ?\n\t\t\t\tWHERE task_id = ?\n\t\t\t`).bind(status, completedAt, isOverdue ? 1 : 0, taskId).run();\n\t\t\t\n\t\t\t// \u5982\u679C\u4EFB\u52A1\u5B8C\u6210\uFF0C\u81EA\u52A8\u8C03\u6574\u540E\u7EED\u4F9D\u8D56\u4EFB\u52A1\n\t\t\tif (status === 'completed') {\n\t\t\t\ttry {\n\t\t\t\t\tconst adjustResult = await autoAdjustDependentTasks(env, taskId, me.user_id);\n\t\t\t\t\tconsole.log(`[\u4EFB\u52A1\u5B8C\u6210] \u81EA\u52A8\u8C03\u6574\u4E86 ${adjustResult.adjusted} \u4E2A\u540E\u7EED\u4EFB\u52A1`);\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconsole.error('[\u4EFB\u52A1\u5B8C\u6210] \u81EA\u52A8\u8C03\u6574\u540E\u7EED\u4EFB\u52A1\u5931\u8D25:', err);\n\t\t\t\t\t// \u4E0D\u963B\u585E\u4E3B\u6D41\u7A0B\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u66F4\u65B0\u72C0\u614B\", meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err) }));\n\t\t\tconst resBody = { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") resBody.error = String(err);\n\t\t\treturn jsonResponse(500, resBody, corsHeaders);\n\t\t}\n\t}\n\t\n\t// POST /api/v1/tasks/:id/adjust-due-date - \u8C03\u6574\u5230\u671F\u65E5\uFF08\u5FC5\u586B\u539F\u56E0\uFF09\n\tif (method === \"POST\" && url.pathname.match(/\\/tasks\\/\\d+\\/adjust-due-date$/)) {\n\t\tconst taskId = url.pathname.split(\"/\")[url.pathname.split(\"/\").length - 2];\n\t\tlet body;\n\t\ttry { body = await request.json(); } catch (_) {\n\t\t\treturn jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tconst new_due_date = body?.new_due_date;\n\t\tconst reason = (body?.reason || '').trim();\n\t\t\n\t\tconsole.log('[\u8C03\u6574\u5230\u671F\u65E5] \u6536\u5230\u6570\u636E:', { taskId, new_due_date, reason });\n\t\t\n\t\tconst errors = [];\n\t\tif (!new_due_date || !/^\\d{4}-\\d{2}-\\d{2}$/.test(new_due_date)) {\n\t\t\terrors.push({ field: 'new_due_date', message: '\u65E5\u671F\u683C\u5F0F\u65E0\u6548 (YYYY-MM-DD)' });\n\t\t}\n\t\tif (!reason) {\n\t\t\terrors.push({ field: 'reason', message: '\u5FC5\u987B\u586B\u5199\u8C03\u6574\u539F\u56E0' });\n\t\t}\n\t\t\n\t\tif (errors.length) {\n\t\t\tconsole.log('[\u8C03\u6574\u5230\u671F\u65E5] \u9A8C\u8BC1\u5931\u8D25:', errors);\n\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\ttry {\n\t\t\t// \u83B7\u53D6\u4EFB\u52A1\u4FE1\u606F\n\t\t\tconst task = await env.DATABASE.prepare(`\n\t\t\t\tSELECT task_id, due_date, status\n\t\t\t\tFROM ActiveTasks\n\t\t\t\tWHERE task_id = ? AND is_deleted = 0\n\t\t\t`).bind(taskId).first();\n\t\t\t\n\t\t\tif (!task) {\n\t\t\t\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4EFB\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u68C0\u67E5\u662F\u5426\u903E\u671F\n\t\t\tconst today = new Date().toISOString().split('T')[0];\n\t\t\tconst isOverdue = task.due_date && task.due_date < today && task.status !== 'completed';\n\t\t\t\n\t\t\t// \u8BB0\u5F55\u8C03\u6574\n\t\t\tawait recordDueDateAdjustment(\n\t\t\t\tenv,\n\t\t\t\ttaskId,\n\t\t\t\ttask.due_date,\n\t\t\t\tnew_due_date,\n\t\t\t\treason,\n\t\t\t\tisOverdue ? 'overdue_adjust' : 'manual_adjust',\n\t\t\t\tme.user_id,\n\t\t\t\tisOverdue,\n\t\t\t\tfalse\n\t\t\t);\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u8ABF\u6574\u5230\u671F\u65E5\", meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err) }));\n\t\t\tconst resBody = { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") resBody.error = String(err);\n\t\t\treturn jsonResponse(500, resBody, corsHeaders);\n\t\t}\n\t}\n\t\n\t// GET /api/v1/tasks/:id/adjustment-history - \u67E5\u8BE2\u8C03\u6574\u5386\u53F2\n\tif (method === \"GET\" && url.pathname.match(/\\/tasks\\/\\d+\\/adjustment-history$/)) {\n\t\tconst taskId = url.pathname.split(\"/\")[url.pathname.split(\"/\").length - 2];\n\t\tconsole.log('[\u8DEF\u7531] \u8FDB\u5165\u8C03\u6574\u5386\u53F2\u8DEF\u7531, taskId:', taskId, 'path:', url.pathname);\n\t\t\n\t\ttry {\n\t\t\tconsole.log('[\u8DEF\u7531] \u5F00\u59CB\u8C03\u7528 getAdjustmentHistory');\n\t\t\tconst history = await getAdjustmentHistory(env, taskId);\n\t\t\tconsole.log('[\u8DEF\u7531] getAdjustmentHistory \u8FD4\u56DE\u6210\u529F, \u8BB0\u5F55\u6570:', history?.length);\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data: history, meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error('[\u8DEF\u7531] getAdjustmentHistory \u5931\u8D25');\n\t\t\tconsole.error('[\u8DEF\u7531] \u9519\u8BEF\u4FE1\u606F:', err.message);\n\t\t\tconsole.error('[\u8DEF\u7531] \u9519\u8BEF\u5806\u6808:', err.stack);\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err), stack: err.stack }));\n\t\t\tconst resBody = { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") {\n\t\t\t\tresBody.error = String(err);\n\t\t\t\tresBody.errorMessage = err.message;\n\t\t\t\tresBody.stack = err.stack;\n\t\t\t}\n\t\t\treturn jsonResponse(500, resBody, corsHeaders);\n\t\t}\n\t}\n\n\treturn jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\n}\n\n\n\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\nimport { generateCacheKey, getCache, saveCache, invalidateCacheByType } from \"../cache-helper.js\";\n\n/**\n * \u5DE5\u6642\u985E\u578B\u5B9A\u7FA9\uFF08\u7B26\u5408\u52DE\u57FA\u6CD5\u898F\u5B9A\uFF09\n */\nconst WORK_TYPES = {\n\t1: { name: '\u6B63\u5E38\u5DE5\u6642', multiplier: 1.0, isOvertime: false },\n\t2: { name: '\u5E73\u65E5\u52A0\u73ED\uFF08\u524D2\u5C0F\u6642\uFF09', multiplier: 1.34, isOvertime: true },\n\t3: { name: '\u5E73\u65E5\u52A0\u73ED\uFF08\u5F8C2\u5C0F\u6642\uFF09', multiplier: 1.67, isOvertime: true },\n\t4: { name: '\u4F11\u606F\u65E5\u52A0\u73ED\uFF08\u524D2\u5C0F\u6642\uFF09', multiplier: 1.34, isOvertime: true },\n\t5: { name: '\u4F11\u606F\u65E5\u52A0\u73ED\uFF08\u7B2C3-8\u5C0F\u6642\uFF09', multiplier: 1.67, isOvertime: true },\n\t6: { name: '\u4F11\u606F\u65E5\u52A0\u73ED\uFF08\u7B2C9-12\u5C0F\u6642\uFF09', multiplier: 2.67, isOvertime: true },\n\t7: { name: '\u570B\u5B9A\u5047\u65E5\u52A0\u73ED\uFF088\u5C0F\u6642\u5167\uFF09', multiplier: 2.0, isOvertime: true, maxHours: 8, special: 'fixed_8h' },\n\t8: { name: '\u570B\u5B9A\u5047\u65E5\u52A0\u73ED\uFF08\u7B2C9-10\u5C0F\u6642\uFF09', multiplier: 1.34, isOvertime: true },\n\t9: { name: '\u570B\u5B9A\u5047\u65E5\u52A0\u73ED\uFF08\u7B2C11-12\u5C0F\u6642\uFF09', multiplier: 1.67, isOvertime: true },\n\t10: { name: '\u4F8B\u5047\u65E5\u52A0\u73ED\uFF088\u5C0F\u6642\u5167\uFF09', multiplier: 2.0, isOvertime: true, maxHours: 8, special: 'fixed_8h' },\n\t11: { name: '\u4F8B\u5047\u65E5\u52A0\u73ED\uFF08\u7B2C9-12\u5C0F\u6642\uFF09', multiplier: 2.0, isOvertime: true },\n};\n\n/**\n * \u8A08\u7B97\u52A0\u6B0A\u5DE5\u6642\n */\nfunction calculateWeightedHours(workTypeId, hours) {\n\tconst workType = WORK_TYPES[workTypeId];\n\tif (!workType) return hours;\n\t\n\t// \u7279\u6B8A\u60C5\u6CC1\uFF1A\u570B\u5B9A\u5047\u65E5/\u4F8B\u5047\u65E5 8\u5C0F\u6642\u5167\u985E\u578B\uFF0C\u56FA\u5B9A\u70BA 8.0 \u52A0\u6B0A\u5DE5\u6642\n\tif (workType.special === 'fixed_8h') {\n\t\treturn 8.0;\n\t}\n\t\n\t// \u4E00\u822C\u60C5\u6CC1\uFF1A\u5BE6\u969B\u5DE5\u6642 \u00D7 \u500D\u7387\n\treturn hours * workType.multiplier;\n}\n\n/**\n * \u26A1 \u5931\u6548\u6307\u5B9A\u5468\u7684\u7F13\u5B58\n */\nasync function invalidateWeekCache(env, userId, weekStart) {\n\ttry {\n\t\tawait env.DATABASE.prepare(\n\t\t\t`UPDATE WeeklyTimesheetCache \n\t\t\t SET invalidated = 1 \n\t\t\t WHERE user_id = ? AND week_start_date = ?`\n\t\t).bind(userId, weekStart).run();\n\t\t\n\t\tconsole.log('[WeekCache] \u2713 \u7F13\u5B58\u5DF2\u5931\u6548', { userId, week: weekStart });\n\t} catch (err) {\n\t\tconsole.error('[WeekCache] \u5931\u6548\u7F13\u5B58\u5931\u8D25:', err);\n\t}\n}\n\n/**\n * \u26A1 \u68C0\u67E5\u5E76\u83B7\u53D6\u5468\u7F13\u5B58\uFF08\u57FA\u4E8E\u6570\u636E\u53D8\u52A8\uFF09\n */\nasync function getWeekCache(env, userId, weekStart) {\n\ttry {\n\t\tconst cache = await env.DATABASE.prepare(\n\t\t\t`SELECT rows_data, last_updated_at, rows_count, total_hours, hit_count, data_version\n\t\t\t FROM WeeklyTimesheetCache\n\t\t\t WHERE user_id = ? AND week_start_date = ? AND invalidated = 0`\n\t\t).bind(userId, weekStart).first();\n\t\t\n\t\tif (!cache) return null;\n\t\t\n\t\t// \u66F4\u65B0\u8BBF\u95EE\u65F6\u95F4\u548C\u547D\u4E2D\u6B21\u6570\n\t\tawait env.DATABASE.prepare(\n\t\t\t`UPDATE WeeklyTimesheetCache \n\t\t\t SET last_accessed_at = datetime('now'), \n\t\t\t     hit_count = hit_count + 1 \n\t\t\t WHERE user_id = ? AND week_start_date = ?`\n\t\t).bind(userId, weekStart).run();\n\t\t\n\t\treturn {\n\t\t\tdata: JSON.parse(cache.rows_data || '[]'),\n\t\t\tmeta: {\n\t\t\t\tcached: true,\n\t\t\t\trows_count: cache.rows_count,\n\t\t\t\ttotal_hours: cache.total_hours,\n\t\t\t\tlast_updated: cache.last_updated_at,\n\t\t\t\thit_count: (cache.hit_count || 0) + 1,\n\t\t\t\tversion: cache.data_version\n\t\t\t}\n\t\t};\n\t} catch (err) {\n\t\tconsole.error('[WeekCache] \u8BFB\u53D6\u7F13\u5B58\u5931\u8D25:', err);\n\t\treturn null;\n\t}\n}\n\n/**\n * GET /api/v1/timelogs - \u67E5\u8A62\u5DE5\u6642\u8A18\u9304\uFF08\u652F\u6301\u5468\u7F13\u5B58\uFF09\n */\nasync function handleGetTimelogs(request, env, me, requestId, url) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\t\n\ttry {\n\t\tconst params = url.searchParams;\n\t\tconst startDate = (params.get(\"start_date\") || \"\").trim();\n\t\tconst endDate = (params.get(\"end_date\") || \"\").trim();\n\t\tconst useCache = params.get(\"use_cache\") !== 'false'; // \u9ED8\u8BA4\u4F7F\u7528\u7F13\u5B58\n\t\t\n\t\t// \u26A1 \u5C1D\u8BD5\u4F7F\u7528\u5468\u7F13\u5B58\uFF08\u4EC5\u5F53\u67E5\u8BE27\u5929\u8303\u56F4\u4E14\u975E\u7BA1\u7406\u5458\u65F6\uFF09\n\t\tif (useCache && !me.is_admin && startDate && endDate) {\n\t\t\tconst start = new Date(startDate);\n\t\t\tconst end = new Date(endDate);\n\t\t\tconst daysDiff = (end - start) / (1000 * 60 * 60 * 24);\n\t\t\t\n\t\t\t// \u68C0\u67E5\u662F\u5426\u662F\u5B8C\u6574\u7684\u4E00\u5468\uFF087\u5929\uFF09\n\t\t\tif (daysDiff === 6 && start.getDay() === 1) { // \u5468\u4E00\u5F00\u59CB\n\t\t\t\tconst weekCache = await getWeekCache(env, me.user_id, startDate);\n\t\t\t\tif (weekCache) {\n\t\t\t\t\tconsole.log('[WeekCache] \u2713 \u7F13\u5B58\u547D\u4E2D', { userId: me.user_id, week: startDate });\n\t\t\t\t\treturn jsonResponse(200, { \n\t\t\t\t\t\tok: true, \n\t\t\t\t\t\tcode: \"SUCCESS\", \n\t\t\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\uFF08\u4F7F\u7528\u7F13\u5B58\uFF09\", \n\t\t\t\t\t\tdata: weekCache.data, \n\t\t\t\t\t\tmeta: { requestId, ...weekCache.meta } \n\t\t\t\t\t}, corsHeaders);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\t// \u6B63\u5E38\u67E5\u8BE2\u6D41\u7A0B\uFF08\u7F13\u5B58\u672A\u547D\u4E2D\u6216\u4E0D\u9002\u7528\uFF09\n\t\tconst where = [\"t.is_deleted = 0\"];\n\t\tconst binds = [];\n\t\t\n\t\t// \u6B0A\u9650\u63A7\u5236\uFF1A\u54E1\u5DE5\u53EA\u80FD\u770B\u81EA\u5DF1\u7684\n\t\tif (!me.is_admin) {\n\t\t\twhere.push(\"t.user_id = ?\");\n\t\t\tbinds.push(String(me.user_id));\n\t\t}\n\t\t\n\t\t// \u65E5\u671F\u7BC4\u570D\u7BE9\u9078\n\t\tif (startDate) {\n\t\t\twhere.push(\"t.work_date >= ?\");\n\t\t\tbinds.push(startDate);\n\t\t}\n\t\tif (endDate) {\n\t\t\twhere.push(\"t.work_date <= ?\");\n\t\t\tbinds.push(endDate);\n\t\t}\n\t\t\n\t\tconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\n\t\t\n\t\tconst rows = await env.DATABASE.prepare(\n\t\t\t`SELECT t.timesheet_id, t.user_id, t.work_date, t.client_id, t.service_id, t.service_item_id, t.service_name, t.work_type, t.hours, t.note,\n\t\t\t        u.name as user_name, u.username\n\t\t\t FROM Timesheets t\n\t\t\t LEFT JOIN Users u ON t.user_id = u.user_id\n\t\t\t ${whereSql}\n\t\t\t ORDER BY t.work_date ASC, t.timesheet_id ASC`\n\t\t).bind(...binds).all();\n\t\t\n\t\tconst data = (rows?.results || []).map(r => ({\n\t\t\tlog_id: r.timesheet_id,\n\t\t\ttimesheet_id: r.timesheet_id,\n\t\t\tuser_id: r.user_id,\n\t\t\tuser_name: r.user_name || r.username || '\u672A\u77E5',\n\t\t\twork_date: r.work_date,\n\t\t\tclient_id: r.client_id || \"\",\n\t\t\tservice_id: parseInt(r.service_id) || parseInt(r.service_name) || 1,\n\t\t\tservice_item_id: parseInt(r.service_item_id) || 1,\n\t\t\twork_type_id: parseInt(r.work_type) || 1,\n\t\t\thours: Number(r.hours || 0),\n\t\t\tnotes: r.note || \"\",\n\t\t}));\n\t\t\n\t\treturn jsonResponse(200, { \n\t\t\tok: true, \n\t\t\tcode: \"SUCCESS\", \n\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\", \n\t\t\tdata, \n\t\t\tmeta: { requestId, cached: false } \n\t\t}, corsHeaders);\n\t\t\n\t} catch (err) {\n\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\treturn jsonResponse(500, body, getCorsHeadersForRequest(request, env));\n\t}\n}\n\n/**\n * POST /api/v1/timelogs - \u65B0\u589E/\u66F4\u65B0\u5DE5\u6642\uFF08UPSERT\uFF09\n */\nasync function handlePostTimelogs(request, env, me, requestId, url) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\t\n\tlet body;\n\ttry { \n\t\tbody = await request.json(); \n\t} catch (_) {\n\t\treturn jsonResponse(400, { \n\t\t\tok: false, \n\t\t\tcode: \"BAD_REQUEST\", \n\t\t\tmessage: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", \n\t\t\tmeta: { requestId } \n\t\t}, corsHeaders);\n\t}\n\t\n\t// \u89E3\u6790\u6B04\u4F4D\n\tconst work_date = String(body?.work_date || \"\").trim();\n\tconst client_id = String(body?.client_id || \"\").trim();\n\tconst service_id = parseInt(body?.service_id) || 0;\n\tconst service_item_id = parseInt(body?.service_item_id) || 0;\n\tconst work_type_id = parseInt(body?.work_type_id) || 0;\n\tconst hours = Number(body?.hours);\n\tconst notes = String(body?.notes || \"\").trim();\n\tconst timesheet_id = body?.timesheet_id ? parseInt(body.timesheet_id) : null;\n\t\n\t// \u9A57\u8B49\n\tconst errors = [];\n\t\n\tif (!/^\\d{4}-\\d{2}-\\d{2}$/.test(work_date)) {\n\t\terrors.push({ field: \"work_date\", message: \"\u65E5\u671F\u683C\u5F0F\u5FC5\u9808\u70BA YYYY-MM-DD\" });\n\t}\n\t\n\tif (!client_id) {\n\t\terrors.push({ field: \"client_id\", message: \"\u8ACB\u9078\u64C7\u5BA2\u6236\" });\n\t}\n\t\n\tif (!service_id) {\n\t\terrors.push({ field: \"service_id\", message: \"\u8ACB\u9078\u64C7\u670D\u52D9\u9805\u76EE\" });\n\t}\n\t\n\tif (!service_item_id) {\n\t\terrors.push({ field: \"service_item_id\", message: \"\u8ACB\u9078\u64C7\u670D\u52D9\u5B50\u9805\u76EE\" });\n\t}\n\t\n\tif (!work_type_id || !WORK_TYPES[work_type_id]) {\n\t\terrors.push({ field: \"work_type_id\", message: \"\u8ACB\u9078\u64C7\u6709\u6548\u7684\u5DE5\u6642\u985E\u578B\" });\n\t}\n\t\n\tif (!Number.isFinite(hours) || hours <= 0) {\n\t\terrors.push({ field: \"hours\", message: \"\u5DE5\u6642\u5FC5\u9808\u5927\u65BC 0\" });\n\t}\n\t\n\t// \u6AA2\u67E5 0.5 \u500D\u6578\n\tif (Math.abs(hours * 2 - Math.round(hours * 2)) > 1e-9) {\n\t\terrors.push({ field: \"hours\", message: \"\u5DE5\u6642\u5FC5\u9808\u662F 0.5 \u7684\u500D\u6578\" });\n\t}\n\t\n\t// \u6AA2\u67E5\u6700\u5927\u503C\u9650\u5236\n\tconst workType = WORK_TYPES[work_type_id];\n\tif (workType && workType.maxHours && hours > workType.maxHours) {\n\t\terrors.push({ \n\t\t\tfield: \"hours\", \n\t\t\tmessage: `${workType.name}\u6700\u591A\u53EA\u80FD\u586B ${workType.maxHours} \u5C0F\u6642` \n\t\t});\n\t}\n\t\n\tif (hours > 12) {\n\t\terrors.push({ field: \"hours\", message: \"\u5DE5\u6642\u4E0D\u53EF\u8D85\u904E 12 \u5C0F\u6642\" });\n\t}\n\t\n\tif (errors.length) {\n\t\treturn jsonResponse(422, { \n\t\t\tok: false, \n\t\t\tcode: \"VALIDATION_ERROR\", \n\t\t\tmessage: \"\u8F38\u5165\u6709\u8AA4\", \n\t\t\terrors, \n\t\t\tmeta: { requestId } \n\t\t}, corsHeaders);\n\t}\n\t\n\ttry {\n\t\t// \u7372\u53D6\u5DE5\u6642\u985E\u578B\n\t\tconst workType = WORK_TYPES[work_type_id];\n\t\tif (!workType) {\n\t\t\treturn jsonResponse(422, {\n\t\t\t\tok: false,\n\t\t\t\tcode: \"VALIDATION_ERROR\",\n\t\t\t\tmessage: \"\u7121\u6548\u7684\u5DE5\u6642\u985E\u578B\",\n\t\t\t\terrors: [{ field: \"work_type_id\", message: \"\u5DE5\u6642\u985E\u578B\u4E0D\u5B58\u5728\" }],\n\t\t\t\tmeta: { requestId }\n\t\t\t}, corsHeaders);\n\t\t}\n\t\t\n\t\t// \u7372\u53D6\u8A72\u65E5\u671F\u7684\u5047\u65E5\u4FE1\u606F\uFF0C\u5224\u65B7\u65E5\u671F\u985E\u578B\n\t\tconst holidayRow = await env.DATABASE.prepare(\n\t\t\t`SELECT is_national_holiday FROM Holidays WHERE holiday_date = ?`\n\t\t).bind(work_date).first();\n\t\t\n\t\tconst date = new Date(work_date + 'T00:00:00');\n\t\tconst dow = date.getDay();\n\t\t\n\t\t// \u5224\u65B7\u65E5\u671F\u985E\u578B\n\t\tlet dateType = 'workday';\n\t\tif (holidayRow?.is_national_holiday === 1) {\n\t\t\tdateType = 'national_holiday';\n\t\t} else if (dow === 0) {\n\t\t\tdateType = 'weekly_restday'; // \u9031\u65E5\uFF08\u4F8B\u5047\uFF09\n\t\t} else if (dow === 6) {\n\t\t\tdateType = 'restday'; // \u9031\u516D\uFF08\u4F11\u606F\u65E5\uFF09\n\t\t}\n\t\t\n\t\t// \u9A57\u8B49\u5DE5\u6642\u985E\u578B\u662F\u5426\u9069\u7528\u65BC\u8A72\u65E5\u671F\u985E\u578B\n\t\tconst allowedTypes = {\n\t\t\t'workday': [1, 2, 3], // \u4E00\u822C\u3001\u5E73\u65E5OT\u524D2h\u3001\u5E73\u65E5OT\u5F8C2h\n\t\t\t'restday': [4, 5, 6], // \u4F11\u606F\u65E5\u524D2h\u3001\u4F11\u606F\u65E53-8h\u3001\u4F11\u606F\u65E59-12h\n\t\t\t'weekly_restday': [10, 11], // \u4F8B\u5047\u65E5\u52A0\u73ED\n\t\t\t'national_holiday': [7, 8, 9] // \u570B\u5B9A\u5047\u65E5\u52A0\u73ED\n\t\t};\n\t\t\n\t\tconst dateTypeNames = {\n\t\t\t'workday': '\u5DE5\u4F5C\u65E5',\n\t\t\t'restday': '\u4F11\u606F\u65E5',\n\t\t\t'weekly_restday': '\u4F8B\u5047\u65E5',\n\t\t\t'national_holiday': '\u570B\u5B9A\u5047\u65E5'\n\t\t};\n\t\t\n\t\tif (!allowedTypes[dateType].includes(work_type_id)) {\n\t\t\tconst dateTypeName = dateTypeNames[dateType] || dateType;\n\t\t\treturn jsonResponse(422, {\n\t\t\t\tok: false,\n\t\t\t\tcode: \"VALIDATION_ERROR\",\n\t\t\t\tmessage: `${work_date}\uFF08${dateTypeName}\uFF09\u4E0D\u53EF\u4F7F\u7528\u300C${workType.name}\u300D`,\n\t\t\t\terrors: [{ \n\t\t\t\t\tfield: \"work_type_id\", \n\t\t\t\t\tmessage: `\u8A72\u65E5\u671F\u985E\u578B\u70BA${dateTypeName}\uFF0C\u8ACB\u9078\u64C7\u9069\u5408\u7684\u5DE5\u6642\u985E\u578B` \n\t\t\t\t}],\n\t\t\t\tmeta: { requestId, work_date, dateType, workType: workType.name }\n\t\t\t}, corsHeaders);\n\t\t}\n\t\t\n\t\t// \u8A08\u7B97\u52A0\u6B0A\u5DE5\u6642\n\t\tconst weighted_hours = calculateWeightedHours(work_type_id, hours);\n\t\t\n\t\tlet log_id;\n\t\tlet isUpdate = false; // \u8FFD\u8E64\u662F\u65B0\u5EFA\u9084\u662F\u66F4\u65B0\n\t\t\n\t\t// \u7B56\u7565\uFF1A\u5982\u679C\u63D0\u4F9B\u4E86 timesheet_id\uFF0C\u76F4\u63A5\u66F4\u65B0\u8A72\u8A18\u9304\u7684\u6240\u6709\u6B04\u4F4D\n\t\t// \u9019\u6A23\u53EF\u4EE5\u652F\u6301\u4FEE\u6539 service_id/service_item_id \u800C\u4E0D\u5275\u5EFA\u91CD\u8907\u8A18\u9304\uFF0C\u4E5F\u4E0D\u6703\u89F8\u767C\u5916\u9375\u7D04\u675F\u554F\u984C\n\t\tif (timesheet_id) {\n\t\t\t// \u9A57\u8B49\u8A72\u8A18\u9304\u5C6C\u65BC\u7576\u524D\u7528\u6236\n\t\t\tconst existingRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT timesheet_id FROM Timesheets \n\t\t\t\t WHERE timesheet_id = ? AND user_id = ? AND is_deleted = 0`\n\t\t\t).bind(timesheet_id, String(me.user_id)).first();\n\t\t\t\n\t\tif (existingRow) {\n\t\t\t// \u76F4\u63A5\u66F4\u65B0\u6240\u6709\u6B04\u4F4D\uFF08\u5305\u62EC service_id, service_item_id, work_type, hours\uFF09\n\t\t\tlog_id = timesheet_id;\n\t\t\tisUpdate = true;\n\t\t\t\n\t\t\t// \u7372\u53D6\u820A\u7684\u5DE5\u6642\u6578\u64DA\uFF0C\u7528\u65BC\u9A57\u8B49\n\t\t\tconst oldData = await env.DATABASE.prepare(\n\t\t\t\t`SELECT hours, work_type FROM Timesheets WHERE timesheet_id = ?`\n\t\t\t).bind(log_id).first();\n\t\t\t\n\t\t\tconst oldHours = Number(oldData?.hours || 0);\n\t\t\tconst hoursDiff = hours - oldHours;  // \u6B63\u6578\u8868\u793A\u589E\u52A0\uFF0C\u8CA0\u6578\u8868\u793A\u6E1B\u5C11\n\t\t\t\n\t\t\t// \u9A57\u8B49\u4FEE\u6539\u5F8C\u7576\u65E5\u7E3D\u5DE5\u6642\u662F\u5426\u8D85\u904E 12 \u5C0F\u6642\n\t\t\tif (hoursDiff > 0) {  // \u53EA\u5728\u589E\u52A0\u5DE5\u6642\u6642\u6AA2\u67E5\n\t\t\t\tconst sumRow = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT COALESCE(SUM(hours), 0) AS s \n\t\t\t\t\t FROM Timesheets \n\t\t\t\t\t WHERE user_id = ? AND work_date = ? AND is_deleted = 0`\n\t\t\t\t).bind(String(me.user_id), work_date).first();\n\t\t\t\t\n\t\t\t\tconst currentTotal = Number(sumRow?.s || 0);\n\t\t\t\tif (currentTotal + hoursDiff > 12 + 1e-9) {\n\t\t\t\t\treturn jsonResponse(422, {\n\t\t\t\t\t\tok: false,\n\t\t\t\t\t\tcode: \"VALIDATION_ERROR\",\n\t\t\t\t\t\tmessage: \"\u4FEE\u6539\u5F8C\u6BCF\u65E5\u5DE5\u6642\u5408\u8A08\u4E0D\u53EF\u8D85\u904E 12 \u5C0F\u6642\",\n\t\t\t\t\t\terrors: [{ field: \"hours\", message: \"\u8D85\u904E\u6BCF\u65E5\u4E0A\u9650\" }],\n\t\t\t\t\t\tmeta: { requestId }\n\t\t\t\t\t}, corsHeaders);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t// \u9A57\u8B49\u4FEE\u6539\u5F8C\u540C\u4E00\u5DE5\u6642\u985E\u578B\u7684\u7D2F\u8A08\u662F\u5426\u8D85\u904E\u4E0A\u9650\n\t\t\tif (workType.maxHours) {\n\t\t\t\tconst workTypeSum = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT COALESCE(SUM(hours), 0) AS s \n\t\t\t\t\t FROM Timesheets \n\t\t\t\t\t WHERE user_id = ? AND work_date = ? AND work_type = ? AND is_deleted = 0`\n\t\t\t\t).bind(String(me.user_id), work_date, String(work_type_id)).first();\n\t\t\t\t\n\t\t\t\tconst currentWorkTypeTotal = Number(workTypeSum?.s || 0);\n\t\t\t\tconst newWorkTypeTotal = currentWorkTypeTotal - oldHours + hours;\n\t\t\t\t\n\t\t\t\tif (newWorkTypeTotal > workType.maxHours + 1e-9) {\n\t\t\t\t\treturn jsonResponse(422, {\n\t\t\t\t\t\tok: false,\n\t\t\t\t\t\tcode: \"VALIDATION_ERROR\",\n\t\t\t\t\t\tmessage: `\u4FEE\u6539\u5F8C\u300C${workType.name}\u300D\u7576\u65E5\u7D2F\u8A08\u4E0D\u53EF\u8D85\u904E ${workType.maxHours} \u5C0F\u6642`,\n\t\t\t\t\t\terrors: [{ \n\t\t\t\t\t\t\tfield: \"hours\", \n\t\t\t\t\t\t\tmessage: `\u7576\u65E5\u5DF2\u6709 ${currentWorkTypeTotal} \u5C0F\u6642\uFF0C\u4FEE\u6539\u5F8C\u5C07\u8B8A\u6210 ${newWorkTypeTotal.toFixed(1)} \u5C0F\u6642\uFF08\u8D85\u904E\u4E0A\u9650\uFF09` \n\t\t\t\t\t\t}],\n\t\t\t\t\t\tmeta: { requestId }\n\t\t\t\t\t}, corsHeaders);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`UPDATE Timesheets \n\t\t\t\t SET client_id = ?, \n\t\t\t\t     service_id = ?, \n\t\t\t\t     service_item_id = ?, \n\t\t\t\t     service_name = ?, \n\t\t\t\t     work_type = ?, \n\t\t\t\t     hours = ?, \n\t\t\t\t     note = ?, \n\t\t\t\t     updated_at = ?\n\t\t\t\t WHERE timesheet_id = ?`\n\t\t\t).bind(\n\t\t\t\tclient_id,\n\t\t\t\tservice_id,\n\t\t\t\tservice_item_id,\n\t\t\t\tString(service_id), // \u4FDD\u7559\u820A\u6B04\u4F4D\u4EE5\u5411\u5F8C\u76F8\u5BB9\n\t\t\t\tString(work_type_id),\n\t\t\t\thours,\n\t\t\t\tnotes,\n\t\t\t\tnew Date().toISOString(),\n\t\t\t\tlog_id\n\t\t\t).run();\n\t\t\t\n\t\t\t// \u5DF2\u66F4\u65B0\uFF0C\u8DF3\u904E\u5F8C\u7E8C\u7684\u63D2\u5165\u908F\u8F2F\n\t\t} else {\n\t\t\t\t// \u5982\u679C\u8A18\u9304\u4E0D\u5B58\u5728\u6216\u4E0D\u5C6C\u65BC\u7576\u524D\u7528\u6236\uFF0C\u5C07 timesheet_id \u8A2D\u70BA null\uFF0C\u5141\u8A31\u65B0\u589E\n\t\t\t\tlog_id = null;\n\t\t\t}\n\t\t}\n\t\t\n\t\t// \u5982\u679C\u6C92\u6709\u63D0\u4F9B timesheet_id\uFF0C\u6216\u8005\u63D0\u4F9B\u7684 timesheet_id \u7121\u6548\uFF0C\u6AA2\u67E5\u662F\u5426\u5DF2\u5B58\u5728\u76F8\u540C\u7D44\u5408\n\t\tif (!log_id) {\n\t\t\tconst duplicateRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT timesheet_id \n\t\t\t\t FROM Timesheets \n\t\t\t\t WHERE user_id = ? \n\t\t\t\t   AND work_date = ? \n\t\t\t\t   AND client_id = ? \n\t\t\t\t   AND service_id = ? \n\t\t\t\t   AND service_item_id = ? \n\t\t\t\t   AND work_type = ? \n\t\t\t\t   AND is_deleted = 0`\n\t\t\t).bind(\n\t\t\t\tString(me.user_id), \n\t\t\t\twork_date, \n\t\t\t\tclient_id, \n\t\t\t\tservice_id,\n\t\t\t\tservice_item_id,\n\t\t\t\tString(work_type_id)\n\t\t\t).first();\n\t\t\t\n\t\tif (duplicateRow) {\n\t\t\t// \u5982\u679C\u5DF2\u5B58\u5728\u76F8\u540C\u7D44\u5408\uFF0C\u7D2F\u52A0\u5DE5\u6642\uFF08\u81EA\u52D5\u5408\u4F75\uFF09\n\t\t\tlog_id = duplicateRow.timesheet_id;\n\t\t\tisUpdate = true;\n\t\t\t\n\t\t\t// \u7372\u53D6\u73FE\u6709\u5DE5\u6642\n\t\t\tconst existingRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT hours FROM Timesheets WHERE timesheet_id = ?`\n\t\t\t).bind(log_id).first();\n\t\t\t\n\t\t\tconst existingHours = Number(existingRow?.hours || 0);\n\t\t\tconst newTotalHours = existingHours + hours;\n\t\t\t\n\t\t\t// \u9A57\u8B49\u7D2F\u52A0\u5F8C\u662F\u5426\u8D85\u904E\u5DE5\u6642\u985E\u578B\u7684\u4E0A\u9650\n\t\t\tif (workType.maxHours && newTotalHours > workType.maxHours) {\n\t\t\t\treturn jsonResponse(422, {\n\t\t\t\t\tok: false,\n\t\t\t\t\tcode: \"VALIDATION_ERROR\",\n\t\t\t\t\tmessage: `\u7D2F\u52A0\u5F8C\u300C${workType.name}\u300D\u5DE5\u6642\u70BA ${newTotalHours} \u5C0F\u6642\uFF0C\u8D85\u904E\u4E0A\u9650 ${workType.maxHours} \u5C0F\u6642`,\n\t\t\t\t\terrors: [{ \n\t\t\t\t\t\tfield: \"hours\", \n\t\t\t\t\t\tmessage: `\u8A72\u65E5\u5DF2\u6709 ${existingHours} \u5C0F\u6642\uFF0C\u6700\u591A\u9084\u53EF\u586B ${workType.maxHours - existingHours} \u5C0F\u6642` \n\t\t\t\t\t}]\n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u9A57\u8B49\u7D2F\u52A0\u5F8C\u7576\u65E5\u7E3D\u5DE5\u6642\u662F\u5426\u8D85\u904E 12 \u5C0F\u6642\n\t\t\tconst sumRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT COALESCE(SUM(hours), 0) AS s \n\t\t\t\t FROM Timesheets \n\t\t\t\t WHERE user_id = ? AND work_date = ? AND is_deleted = 0 AND timesheet_id != ?`\n\t\t\t).bind(String(me.user_id), work_date, log_id).first();\n\t\t\t\n\t\t\tconst otherHoursTotal = Number(sumRow?.s || 0);\n\t\t\tconst dailyTotal = otherHoursTotal + newTotalHours;\n\t\t\t\n\t\t\tif (dailyTotal > 12 + 1e-9) {\n\t\t\t\treturn jsonResponse(422, {\n\t\t\t\t\tok: false,\n\t\t\t\t\tcode: \"VALIDATION_ERROR\",\n\t\t\t\t\tmessage: `\u7D2F\u52A0\u5F8C\u7576\u65E5\u7E3D\u5DE5\u6642\u70BA ${dailyTotal.toFixed(1)} \u5C0F\u6642\uFF0C\u8D85\u904E\u4E0A\u9650 12 \u5C0F\u6642`,\n\t\t\t\t\terrors: [{ \n\t\t\t\t\t\tfield: \"hours\", \n\t\t\t\t\t\tmessage: `\u7576\u65E5\u5DF2\u6709 ${otherHoursTotal.toFixed(1)} \u5C0F\u6642\uFF0C\u672C\u8A18\u9304\u5DF2\u6709 ${existingHours} \u5C0F\u6642\uFF0C\u6700\u591A\u9084\u53EF\u7D2F\u52A0 ${Math.max(0, 12 - otherHoursTotal - existingHours).toFixed(1)} \u5C0F\u6642` \n\t\t\t\t\t}]\n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u7D2F\u52A0\u5DE5\u6642\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`UPDATE Timesheets \n\t\t\t\t SET hours = hours + ?, updated_at = ?\n\t\t\t\t WHERE timesheet_id = ?`\n\t\t\t).bind(hours, new Date().toISOString(), log_id).run();\n\t\t}\n\t\t}\n\t\t\n\t\t// \u5982\u679C\u9084\u662F\u6C92\u6709 log_id\uFF0C\u8868\u793A\u9700\u8981\u65B0\u589E\u8A18\u9304\n\t\tif (!log_id) {\n\t\t\t// INSERT\uFF1A\u65B0\u589E\u8A18\u9304\n\t\t\t// \u5148\u6AA2\u67E5\u55AE\u65E5\u7E3D\u5DE5\u6642\u662F\u5426\u8D85\u904E 12\n\t\t\tconst sumRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT COALESCE(SUM(hours), 0) AS s \n\t\t\t\t FROM Timesheets \n\t\t\t\t WHERE user_id = ? AND work_date = ? AND is_deleted = 0`\n\t\t\t).bind(String(me.user_id), work_date).first();\n\t\t\t\n\t\tconst currentTotal = Number(sumRow?.s || 0);\n\t\tif (currentTotal + hours > 12 + 1e-9) {\n\t\t\treturn jsonResponse(422, { \n\t\t\t\tok: false, \n\t\t\t\tcode: \"VALIDATION_ERROR\", \n\t\t\t\tmessage: \"\u6BCF\u65E5\u5DE5\u6642\u5408\u8A08\u4E0D\u53EF\u8D85\u904E 12 \u5C0F\u6642\", \n\t\t\t\terrors: [{ field: \"hours\", message: \"\u8D85\u904E\u6BCF\u65E5\u4E0A\u9650\" }], \n\t\t\t\tmeta: { requestId } \n\t\t\t}, corsHeaders);\n\t\t}\n\t\t\n\t\t// \u6AA2\u67E5\u540C\u4E00\u5929\u540C\u4E00\u5DE5\u6642\u985E\u578B\u7684\u7D2F\u8A08\u5DE5\u6642\u662F\u5426\u8D85\u904E\u8A72\u985E\u578B\u7684\u4E0A\u9650\n\t\tif (workType.maxHours) {\n\t\t\tconst workTypeSum = await env.DATABASE.prepare(\n\t\t\t\t`SELECT COALESCE(SUM(hours), 0) AS s \n\t\t\t\t FROM Timesheets \n\t\t\t\t WHERE user_id = ? AND work_date = ? AND work_type = ? AND is_deleted = 0`\n\t\t\t).bind(String(me.user_id), work_date, String(work_type_id)).first();\n\t\t\t\n\t\t\tconst existingWorkTypeTotal = Number(workTypeSum?.s || 0);\n\t\t\tconst newWorkTypeTotal = existingWorkTypeTotal + hours;\n\t\t\t\n\t\t\tif (newWorkTypeTotal > workType.maxHours + 1e-9) {\n\t\t\t\treturn jsonResponse(422, {\n\t\t\t\t\tok: false,\n\t\t\t\t\tcode: \"VALIDATION_ERROR\",\n\t\t\t\t\tmessage: `\u300C${workType.name}\u300D\u7576\u65E5\u7D2F\u8A08\u4E0D\u53EF\u8D85\u904E ${workType.maxHours} \u5C0F\u6642`,\n\t\t\t\t\terrors: [{ \n\t\t\t\t\t\tfield: \"hours\", \n\t\t\t\t\t\tmessage: `\u8A72\u65E5\u5DF2\u6709 ${existingWorkTypeTotal} \u5C0F\u6642\u300C${workType.name}\u300D\uFF0C\u6700\u591A\u9084\u53EF\u586B ${Math.max(0, workType.maxHours - existingWorkTypeTotal)} \u5C0F\u6642` \n\t\t\t\t\t}],\n\t\t\t\t\tmeta: { requestId }\n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\t\t}\n\t\t\n\t\tawait env.DATABASE.prepare(\n\t\t\t\t`INSERT INTO Timesheets (user_id, work_date, client_id, service_id, service_item_id, service_name, work_type, hours, note, created_at, updated_at)\n\t\t\t\t VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`\n\t\t\t).bind(\n\t\t\t\tString(me.user_id), \n\t\t\t\twork_date, \n\t\t\t\tclient_id, \n\t\t\t\tservice_id,\n\t\t\t\tservice_item_id,\n\t\t\t\tString(service_id), // \u4FDD\u7559\u820A\u6B04\u4F4D\u4EE5\u5411\u5F8C\u76F8\u5BB9\n\t\t\t\tString(work_type_id),\n\t\t\t\thours, \n\t\t\t\tnotes, \n\t\t\t\tnew Date().toISOString(), \n\t\t\t\tnew Date().toISOString()\n\t\t\t).run();\n\t\t\t\n\t\t\tconst idRow = await env.DATABASE.prepare(\"SELECT last_insert_rowid() AS id\").first();\n\t\t\tlog_id = idRow?.id;\n\t\t}\n\t\t\n\t\t// \u8A08\u7B97\u88DC\u4F11\u5DE5\u6642\uFF08\u5982\u679C\u662F\u52A0\u73ED\uFF09\n\t\tconst comp_hours_generated = workType.isOvertime ? (workType.special === 'fixed_8h' ? 8 : hours) : 0;\n\t\t\n\t\t// \u5982\u679C\u662F\u52A0\u73ED\uFF0C\u5BEB\u5165\u88DC\u4F11\u8FFD\u8E64\u8868\n\t\tif (comp_hours_generated > 0) {\n\t\t\tconst generatedDate = work_date;\n\t\t\t// \u8A08\u7B97\u5230\u671F\u65E5\uFF08\u7576\u6708\u5E95\uFF09\n\t\t\tconst dateObj = new Date(work_date + 'T00:00:00Z');\n\t\t\tconst year = dateObj.getUTCFullYear();\n\t\t\tconst month = dateObj.getUTCMonth();\n\t\t\tconst lastDay = new Date(Date.UTC(year, month + 1, 0));\n\t\t\tconst expiryDate = `${lastDay.getUTCFullYear()}-${String(lastDay.getUTCMonth() + 1).padStart(2, '0')}-${String(lastDay.getUTCDate()).padStart(2, '0')}`;\n\t\t\t\n\t\t\t// \u5BEB\u5165 CompensatoryLeaveGrants (\u4F7F\u7528 timesheet_id \u4F5C\u70BA source_timelog_id)\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`INSERT INTO CompensatoryLeaveGrants \n\t\t\t\t (user_id, source_timelog_id, hours_generated, hours_remaining, generated_date, expiry_date, original_rate, status)\n\t\t\t\t VALUES (?, ?, ?, ?, ?, ?, ?, 'active')`\n\t\t\t).bind(\n\t\t\t\tString(me.user_id),\n\t\t\t\tlog_id,  // log_id \u5C31\u662F timesheet_id\n\t\t\t\tcomp_hours_generated,\n\t\t\t\tcomp_hours_generated,  // \u521D\u59CB\u6642 remaining = generated\n\t\t\t\tgeneratedDate,\n\t\t\t\texpiryDate,\n\t\t\t\tworkType.multiplier\n\t\t\t).run();\n\t\t}\n\t\t\n\t\tconsole.log('[TIMELOG] \u4FDD\u5B58\u6210\u529F:', { log_id, weighted_hours, comp_hours_generated });\n\t\t\n\t\t// \u26A1 \u5931\u6548\u8BE5\u5468\u7684\u7F13\u5B58\u548C\u6708\u5EA6\u7EDF\u8BA1\u7F13\u5B58\uFF08\u4E0D\u7B49\u5F85\u5B8C\u6210\uFF0C\u907F\u514D\u963B\u585E\u54CD\u5E94\uFF09\n\t\tconst workDateObj = new Date(work_date + 'T00:00:00');\n\t\tconst dayOfWeek = workDateObj.getDay();\n\t\tconst mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // \u5468\u65E5\u662F0\uFF0C\u8981\u5F80\u56DE6\u5929\u5230\u5468\u4E00\n\t\tconst monday = new Date(workDateObj);\n\t\tmonday.setDate(monday.getDate() + mondayOffset);\n\t\tconst weekStart = `${monday.getFullYear()}-${String(monday.getMonth() + 1).padStart(2, '0')}-${String(monday.getDate()).padStart(2, '0')}`;\n\t\tconst workMonth = `${workDateObj.getFullYear()}-${String(workDateObj.getMonth() + 1).padStart(2, '0')}`;\n\t\t\n\t\tPromise.all([\n\t\t\tinvalidateWeekCache(env, String(me.user_id), weekStart),\n\t\t\tinvalidateCacheByType(env, 'monthly_summary', { userId: String(me.user_id) })\n\t\t]).catch(err => {\n\t\t\tconsole.error('[TIMELOG] \u5931\u6548\u7F13\u5B58\u5931\u8D25\uFF08\u4E0D\u5F71\u54CD\u4FDD\u5B58\uFF09:', err);\n\t\t});\n\t\t\n\t\treturn jsonResponse(200, { \n\t\t\tok: true, \n\t\t\tcode: \"SUCCESS\", \n\t\t\tmessage: isUpdate ? \"\u5DF2\u66F4\u65B0\" : \"\u5DF2\u5EFA\u7ACB\", \n\t\t\tdata: { \n\t\t\t\tlog_id, \n\t\t\t\tweighted_hours, \n\t\t\t\tcomp_hours_generated \n\t\t\t}, \n\t\t\tmeta: { requestId } \n\t\t}, corsHeaders);\n\t\t\n\t} catch (err) {\n\t\tconsole.error(JSON.stringify({ \n\t\t\tlevel: \"error\", \n\t\t\trequestId, \n\t\t\tpath: url.pathname, \n\t\t\terr: String(err),\n\t\t\tstack: err.stack \n\t\t}));\n\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\treturn jsonResponse(500, body, corsHeaders);\n\t}\n}\n\n/**\n * DELETE /api/v1/timelogs/batch - \u6279\u6B21\u522A\u9664\u5DE5\u6642\uFF08\u522A\u9664\u6574\u5217\uFF09\n */\nasync function handleDeleteTimelogsBatch(request, env, me, requestId, url) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\t\n\tlet body;\n\ttry { \n\t\tbody = await request.json(); \n\t} catch (_) {\n\t\treturn jsonResponse(400, { \n\t\t\tok: false, \n\t\t\tcode: \"BAD_REQUEST\", \n\t\t\tmessage: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", \n\t\t\tmeta: { requestId } \n\t\t}, corsHeaders);\n\t}\n\t\n\tconst start_date = String(body?.start_date || \"\").trim();\n\tconst end_date = String(body?.end_date || \"\").trim();\n\tconst client_id = String(body?.client_id || \"\").trim();\n\tconst service_id = parseInt(body?.service_id) || 0;\n\tconst service_item_id = parseInt(body?.service_item_id) || 0;\n\tconst work_type_id = String(body?.work_type_id || \"\").trim();\n\t\n\tif (!start_date || !end_date || !client_id || !service_id || !service_item_id || !work_type_id) {\n\t\treturn jsonResponse(400, { \n\t\t\tok: false, \n\t\t\tcode: \"BAD_REQUEST\", \n\t\t\tmessage: \"\u7F3A\u5C11\u5FC5\u8981\u53C3\u6578\", \n\t\t\tmeta: { requestId } \n\t\t}, corsHeaders);\n\t}\n\t\n\ttry {\n\t\t// \u8EDF\u522A\u9664\u7B26\u5408\u689D\u4EF6\u7684\u6240\u6709\u8A18\u9304\n\t\tconst result = await env.DATABASE.prepare(\n\t\t\t`UPDATE Timesheets \n\t\t\t SET is_deleted = 1, updated_at = ?\n\t\t\t WHERE user_id = ? \n\t\t\t   AND work_date >= ? \n\t\t\t   AND work_date <= ? \n\t\t\t   AND client_id = ? \n\t\t\t   AND service_id = ? \n\t\t\t   AND service_item_id = ?\n\t\t\t   AND work_type = ?\n\t\t\t   AND is_deleted = 0`\n\t\t).bind(\n\t\t\tnew Date().toISOString(),\n\t\t\tString(me.user_id), \n\t\t\tstart_date, \n\t\t\tend_date, \n\t\t\tclient_id, \n\t\t\tservice_id,\n\t\t\tservice_item_id,\n\t\t\twork_type_id\n\t\t).run();\n\t\t\n\t\tconst deleted_count = result.changes || 0;\n\t\t\n\t\t// \u26A1 \u5931\u6548\u8BE5\u65E5\u671F\u8303\u56F4\u5185\u6240\u6709\u5468\u7684\u7F13\u5B58\n\t\tif (deleted_count > 0) {\n\t\t\tconst startDateObj = new Date(start_date + 'T00:00:00');\n\t\t\tconst endDateObj = new Date(end_date + 'T00:00:00');\n\t\t\t\n\t\t\t// \u8BA1\u7B97\u9700\u8981\u5931\u6548\u7684\u6240\u6709\u5468\uFF08\u5468\u4E00\uFF09\n\t\t\tconst weeksToInvalidate = new Set();\n\t\t\tlet currentDate = new Date(startDateObj);\n\t\t\t\n\t\t\twhile (currentDate <= endDateObj) {\n\t\t\t\tconst dayOfWeek = currentDate.getDay();\n\t\t\t\tconst mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;\n\t\t\t\tconst monday = new Date(currentDate);\n\t\t\t\tmonday.setDate(monday.getDate() + mondayOffset);\n\t\t\t\tconst weekStart = `${monday.getFullYear()}-${String(monday.getMonth() + 1).padStart(2, '0')}-${String(monday.getDate()).padStart(2, '0')}`;\n\t\t\t\tweeksToInvalidate.add(weekStart);\n\t\t\t\t\n\t\t\t\t// \u79FB\u52A8\u5230\u4E0B\u4E00\u5468\n\t\t\t\tcurrentDate.setDate(currentDate.getDate() + 7);\n\t\t\t}\n\t\t\t\n\t\t\t// \u5E76\u53D1\u5931\u6548\u6240\u6709\u5468\n\t\t\tPromise.all([...weeksToInvalidate].map(weekStart => \n\t\t\t\tinvalidateWeekCache(env, String(me.user_id), weekStart)\n\t\t\t)).catch(err => {\n\t\t\t\tconsole.error('[TIMELOG] \u6279\u91CF\u5931\u6548\u7F13\u5B58\u5931\u8D25\uFF08\u4E0D\u5F71\u54CD\u5220\u9664\uFF09:', err);\n\t\t\t});\n\t\t}\n\t\t\n\t\treturn jsonResponse(200, { \n\t\t\tok: true, \n\t\t\tcode: \"SUCCESS\", \n\t\t\tmessage: `\u5DF2\u522A\u9664 ${deleted_count} \u7B46\u8A18\u9304`, \n\t\t\tdata: { deleted_count }, \n\t\t\tmeta: { requestId } \n\t\t}, corsHeaders);\n\t\t\n\t} catch (err) {\n\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\treturn jsonResponse(500, body, corsHeaders);\n\t}\n}\n\n/**\n * GET /api/v1/timelogs/summary - \u6708\u7D71\u8A08\n */\nasync function handleGetMonthlySummary(request, env, me, requestId, url) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\t\n\ttry {\n\t\tconst params = url.searchParams;\n\t\tconst month = (params.get(\"month\") || \"\").trim(); // \u683C\u5F0F\uFF1AYYYY-MM\n\t\t\n\t\t// \u9A57\u8B49\u6708\u4EFD\u683C\u5F0F\n\t\tif (!month || !/^\\d{4}-\\d{2}$/.test(month)) {\n\t\t\treturn jsonResponse(400, {\n\t\t\t\tok: false,\n\t\t\t\tcode: \"INVALID_MONTH\",\n\t\t\t\tmessage: \"\u6708\u4EFD\u683C\u5F0F\u932F\u8AA4\uFF0C\u61C9\u70BA YYYY-MM\",\n\t\t\t\tmeta: { requestId }\n\t\t\t}, corsHeaders);\n\t\t}\n\t\t\n\t\t// \u8A08\u7B97\u6708\u4EFD\u8D77\u59CB\u548C\u7D50\u675F\u65E5\u671F\n\t\tconst [year, monthNum] = month.split('-');\n\t\tconst startDate = `${year}-${monthNum}-01`;\n\t\tconst nextMonth = parseInt(monthNum) === 12 ? `${parseInt(year) + 1}-01` : `${year}-${String(parseInt(monthNum) + 1).padStart(2, '0')}`;\n\t\tconst endDate = `${nextMonth}-01`;\n\t\t\n\t// \u6B0A\u9650\u63A7\u5236\uFF1A\u54E1\u5DE5\u53EA\u80FD\u67E5\u8A62\u81EA\u5DF1\u7684\uFF0C\u7BA1\u7406\u54E1\u53EF\u4EE5\u6307\u5B9A user_id\n\tlet userId = me.user_id;\n\tif (me.is_admin && params.get(\"user_id\")) {\n\t\tuserId = parseInt(params.get(\"user_id\"));\n\t}\n\t\t\n\t\t// \u26A1 \u5C1D\u8BD5\u4ECE\u7F13\u5B58\u8BFB\u53D6\n\t\tconst cacheKey = generateCacheKey('monthly_summary', { userId, month });\n\t\tconst cached = await getCache(env, cacheKey);\n\t\t\n\t\tif (cached && cached.data) {\n\t\t\treturn jsonResponse(200, {\n\t\t\t\tok: true,\n\t\t\t\tcode: \"SUCCESS\",\n\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\uFF08\u7F13\u5B58\uFF09\",\n\t\t\t\tdata: cached.data,\n\t\t\t\tmeta: { requestId, month, userId, ...cached.meta }\n\t\t\t}, corsHeaders);\n\t\t}\n\t\t\n\t\t// \u67E5\u8A62\u7576\u6708\u5DE5\u6642\u8A18\u9304\n\t\tconst timelogs = await env.DATABASE.prepare(\n\t\t\t`SELECT work_type, hours\n\t\t\t FROM Timesheets\n\t\t\t WHERE user_id = ?\n\t\t\t   AND work_date >= ?\n\t\t\t   AND work_date < ?\n\t\t\t   AND is_deleted = 0`\n\t\t).bind(userId, startDate, endDate).all();\n\t\t\n\t\t// \u8A08\u7B97\u7D71\u8A08\u6578\u64DA\n\t\tlet totalHours = 0;\n\t\tlet overtimeHours = 0;\n\t\tlet weightedHours = 0;\n\t\t\n\t\ttimelogs.results.forEach(log => {\n\t\t\tconst hours = parseFloat(log.hours) || 0;\n\t\t\tconst workTypeId = parseInt(log.work_type) || 1;\n\t\t\tconst workType = WORK_TYPES[workTypeId];\n\t\t\t\n\t\t\tif (workType) {\n\t\t\t\ttotalHours += hours;\n\t\t\t\t\n\t\t\t\tif (workType.isOvertime) {\n\t\t\t\t\tovertimeHours += hours;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tweightedHours += calculateWeightedHours(workTypeId, hours);\n\t\t\t}\n\t\t});\n\t\t\n\t// \u67E5\u8A62\u7576\u6708\u8ACB\u5047\u6642\u6578\uFF08\u9700\u8981\u6839\u64DA unit \u8F49\u63DB\uFF09\n\tconst leaveRows = await env.DATABASE.prepare(\n\t\t`SELECT unit, amount\n\t\t FROM LeaveRequests\n\t\t WHERE user_id = ?\n\t\t   AND start_date >= ?\n\t\t   AND start_date < ?\n\t\t   AND status = 'approved'\n\t\t   AND is_deleted = 0`\n\t).bind(userId, startDate, endDate).all();\n\t\n\t// \u8A08\u7B97\u7E3D\u8ACB\u5047\u6642\u6578\uFF08day \u63DB\u7B97\u70BA 8 \u5C0F\u6642\uFF09\n\tlet leaveHours = 0;\n\tif (leaveRows.results) {\n\t\tleaveRows.results.forEach(row => {\n\t\t\tconst amount = parseFloat(row.amount) || 0;\n\t\t\tif (row.unit === 'hour') {\n\t\t\t\tleaveHours += amount;\n\t\t\t} else if (row.unit === 'day') {\n\t\t\t\tleaveHours += amount * 8; // 1\u5929 = 8\u5C0F\u6642\n\t\t\t}\n\t\t});\n\t}\n\t\t\n\t\tconst summaryData = {\n\t\t\tmonth,\n\t\t\ttotal_hours: Math.round(totalHours * 10) / 10,\n\t\t\tovertime_hours: Math.round(overtimeHours * 10) / 10,\n\t\t\tweighted_hours: Math.round(weightedHours * 10) / 10,\n\t\t\tleave_hours: Math.round(leaveHours * 10) / 10\n\t\t};\n\t\t\n\t\t// \u26A1 \u4FDD\u5B58\u5230\u7F13\u5B58\uFF08\u4E0D\u7B49\u5F85\u5B8C\u6210\uFF09\n\t\tsaveCache(env, cacheKey, 'monthly_summary', summaryData, {\n\t\t\tuserId: String(userId),\n\t\t\tscopeParams: { userId, month }\n\t\t}).catch(err => console.error('[TIMELOGS] \u6708\u5EA6\u7EDF\u8BA1\u7F13\u5B58\u4FDD\u5B58\u5931\u8D25:', err));\n\t\t\n\t\t// \u56DE\u50B3\u7D71\u8A08\u7D50\u679C\n\t\treturn jsonResponse(200, {\n\t\t\tok: true,\n\t\t\tcode: \"SUCCESS\",\n\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\",\n\t\t\tdata: summaryData,\n\t\t\tmeta: { requestId }\n\t\t}, corsHeaders);\n\t\t\n\t} catch (err) {\n\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\treturn jsonResponse(500, body, corsHeaders);\n\t}\n}\n\n/**\n * \u26A1 POST /api/v1/timelogs/week-cache - \u4FDD\u5B58\u5468\u7F13\u5B58\n */\nasync function handleSaveWeekCache(request, env, me, requestId, url) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\t\n\tlet body;\n\ttry {\n\t\tbody = await request.json();\n\t} catch (_) {\n\t\treturn jsonResponse(400, {\n\t\t\tok: false,\n\t\t\tcode: \"BAD_REQUEST\",\n\t\t\tmessage: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\",\n\t\t\tmeta: { requestId }\n\t\t}, corsHeaders);\n\t}\n\t\n\tconst weekStart = String(body?.week_start || \"\").trim();\n\tconst rowsData = body?.rows_data || [];\n\t\n\t// \u9A8C\u8BC1\n\tif (!/^\\d{4}-\\d{2}-\\d{2}$/.test(weekStart)) {\n\t\treturn jsonResponse(400, {\n\t\t\tok: false,\n\t\t\tcode: \"INVALID_DATE\",\n\t\t\tmessage: \"\u65E5\u671F\u683C\u5F0F\u932F\u8AA4\",\n\t\t\tmeta: { requestId }\n\t\t}, corsHeaders);\n\t}\n\t\n\tif (!Array.isArray(rowsData)) {\n\t\treturn jsonResponse(400, {\n\t\t\tok: false,\n\t\t\tcode: \"INVALID_DATA\",\n\t\t\tmessage: \"\u6578\u64DA\u683C\u5F0F\u932F\u8AA4\",\n\t\t\tmeta: { requestId }\n\t\t}, corsHeaders);\n\t}\n\t\n\ttry {\n\t\tconst now = new Date().toISOString();\n\t\tconst rowsJson = JSON.stringify(rowsData);\n\t\tconst rowsCount = rowsData.length;\n\t\tconst totalHours = rowsData.reduce((sum, row) => {\n\t\t\tconst rowTotal = (row.hours || []).reduce((s, h) => s + (Number(h) || 0), 0);\n\t\t\treturn sum + rowTotal;\n\t\t}, 0);\n\t\t\n\t\t// UPSERT\uFF1A\u5982\u679C\u5B58\u5728\u5219\u66F4\u65B0\uFF0C\u5426\u5219\u63D2\u5165\uFF08\u540C\u65F6\u9012\u589E\u7248\u672C\u53F7\u5E76\u91CD\u7F6E\u5931\u6548\u6807\u8BB0\uFF09\n\t\tawait env.DATABASE.prepare(\n\t\t\t`INSERT INTO WeeklyTimesheetCache (user_id, week_start_date, rows_data, rows_count, total_hours, data_version, invalidated, last_updated_at, created_at)\n\t\t\t VALUES (?, ?, ?, ?, ?, 1, 0, ?, ?)\n\t\t\t ON CONFLICT(user_id, week_start_date) DO UPDATE SET\n\t\t\t   rows_data = excluded.rows_data,\n\t\t\t   rows_count = excluded.rows_count,\n\t\t\t   total_hours = excluded.total_hours,\n\t\t\t   data_version = data_version + 1,\n\t\t\t   invalidated = 0,\n\t\t\t   last_updated_at = excluded.last_updated_at`\n\t\t).bind(me.user_id, weekStart, rowsJson, rowsCount, totalHours, now, now).run();\n\t\t\n\t\tconsole.log('[WeekCache] \u2713 \u7F13\u5B58\u5DF2\u4FDD\u5B58', {\n\t\t\tuserId: me.user_id,\n\t\t\tweek: weekStart,\n\t\t\trows: rowsCount,\n\t\t\thours: totalHours\n\t\t});\n\t\t\n\t\treturn jsonResponse(200, {\n\t\t\tok: true,\n\t\t\tcode: \"SUCCESS\",\n\t\t\tmessage: \"\u7DE9\u5B58\u5DF2\u4FDD\u5B58\",\n\t\t\tdata: {\n\t\t\t\tweek_start: weekStart,\n\t\t\t\trows_count: rowsCount,\n\t\t\t\ttotal_hours: totalHours\n\t\t\t},\n\t\t\tmeta: { requestId }\n\t\t}, corsHeaders);\n\t\t\n\t} catch (err) {\n\t\tconsole.error('[WeekCache] \u4FDD\u5B58\u7F13\u5B58\u5931\u8D25:', err);\n\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4FDD\u5B58\u7DE9\u5B58\u5931\u6557\", meta: { requestId } };\n\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\treturn jsonResponse(500, body, corsHeaders);\n\t}\n}\n\n/**\n * \u4E3B\u8DEF\u7531\u8655\u7406\n */\nexport async function handleTimesheets(request, env, me, requestId, url) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\tconst method = request.method.toUpperCase();\n\t\n\t// POST /api/v1/timelogs/week-cache - \u4FDD\u5B58\u5468\u7F13\u5B58\n\tif (method === \"POST\" && url.pathname.endsWith(\"/week-cache\")) {\n\t\treturn handleSaveWeekCache(request, env, me, requestId, url);\n\t}\n\t\n\t// GET /api/v1/timelogs/summary - \u6708\u7D71\u8A08\n\tif (method === \"GET\" && url.pathname.endsWith(\"/summary\")) {\n\t\treturn handleGetMonthlySummary(request, env, me, requestId, url);\n\t}\n\t\n\t// GET /api/v1/timelogs\n\tif (method === \"GET\") {\n\t\treturn handleGetTimelogs(request, env, me, requestId, url);\n\t}\n\t\n\t// POST /api/v1/timelogs\n\tif (method === \"POST\") {\n\t\treturn handlePostTimelogs(request, env, me, requestId, url);\n\t}\n\t\n\t// DELETE /api/v1/timelogs/batch\n\tif (method === \"DELETE\" && url.pathname.endsWith(\"/batch\")) {\n\t\treturn handleDeleteTimelogsBatch(request, env, me, requestId, url);\n\t}\n\t\n\treturn jsonResponse(405, { \n\t\tok: false, \n\t\tcode: \"METHOD_NOT_ALLOWED\", \n\t\tmessage: \"\u65B9\u6CD5\u4E0D\u5141\u8A31\", \n\t\tmeta: { requestId } \n\t}, corsHeaders);\n}\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\n\nexport async function handleReceipts(request, env, me, requestId, url) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\tconst method = request.method.toUpperCase();\n\tconst path = url.pathname;\n\n\t// GET /internal/api/v1/receipts/reminders - \u83B7\u53D6\u5E94\u5F00\u6536\u636E\u63D0\u9192\n\tif (method === \"GET\" && path === \"/internal/api/v1/receipts/reminders\") {\n\t\ttry {\n\t\t\t// \u67E5\u8BE2\u5DF2\u5B8C\u6210\u7684\u670D\u52A1\u4EFB\u52A1\uFF0C\u4F46\u8FD8\u6CA1\u5F00\u6536\u636E\u7684\n\t\t\tconst now = new Date();\n\t\t\tconst currentMonth = now.getMonth() + 1;\n\t\t\t\n\t\t\tconst reminders = await env.DATABASE.prepare(\n\t\t\t\t`SELECT DISTINCT\n\t\t\t\t   c.client_id, c.company_name AS client_name,\n\t\t\t\t   cs.client_service_id, s.service_name,\n\t\t\t\t   sbs.billing_month, sbs.billing_amount AS amount\n\t\t\t\t FROM ClientServices cs\n\t\t\t\t JOIN Clients c ON c.client_id = cs.client_id\n\t\t\t\t JOIN Services s ON s.service_id = cs.service_id\n\t\t\t\t JOIN ServiceBillingSchedule sbs ON sbs.client_service_id = cs.client_service_id\n\t\t\t\t WHERE cs.status = 'active'\n\t\t\t\t   AND sbs.billing_month = ?\n\t\t\t\t   AND NOT EXISTS (\n\t\t\t\t     SELECT 1 FROM Receipts r \n\t\t\t\t     WHERE r.client_service_id = cs.client_service_id \n\t\t\t\t       AND r.billing_month = sbs.billing_month\n\t\t\t\t       AND r.is_deleted = 0\n\t\t\t\t   )\n\t\t\t\t ORDER BY c.company_name, s.service_name\n\t\t\t\t LIMIT 20`\n\t\t\t).bind(currentMonth).all();\n\t\t\t\n\t\t\tconst data = (reminders?.results || []).map(r => ({\n\t\t\t\tclient_id: r.client_id,\n\t\t\t\tclient_name: r.client_name,\n\t\t\t\tclient_service_id: r.client_service_id,\n\t\t\t\tservice_name: r.service_name,\n\t\t\t\tbilling_month: r.billing_month,\n\t\t\t\tamount: Number(r.amount || 0)\n\t\t\t}));\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// GET /internal/api/v1/receipts/suggest-amount - \u6839\u636E\u670D\u52A1\u548C\u6708\u4EFD\u5EFA\u8BAE\u91D1\u989D\n\tif (method === \"GET\" && path === \"/internal/api/v1/receipts/suggest-amount\") {\n\t\tconst clientServiceId = parseInt(url.searchParams.get(\"client_service_id\") || \"0\", 10);\n\t\tconst billingMonth = parseInt(url.searchParams.get(\"billing_month\") || \"0\", 10);\n\n\t\tif (!clientServiceId || billingMonth < 1 || billingMonth > 12) {\n\t\t\treturn jsonResponse(400, { \n\t\t\t\tok: false, \n\t\t\t\tcode: \"BAD_REQUEST\", \n\t\t\t\tmessage: \"\u8BF7\u63D0\u4F9B\u6709\u6548\u7684client_service_id\u548Cbilling_month\uFF081-12\uFF09\", \n\t\t\t\tmeta: { requestId } \n\t\t\t}, corsHeaders);\n\t\t}\n\n\t\ttry {\n\t\t\t// \u67E5\u8BE2\u6536\u8D39\u660E\u7EC6\n\t\t\tconst schedule = await env.DATABASE.prepare(\n\t\t\t\t`SELECT billing_amount, payment_due_days \n\t\t\t\t FROM ServiceBillingSchedule \n\t\t\t\t WHERE client_service_id = ? AND billing_month = ?`\n\t\t\t).bind(clientServiceId, billingMonth).first();\n\n\t\t\tif (!schedule) {\n\t\t\t\treturn jsonResponse(200, {\n\t\t\t\t\tok: true,\n\t\t\t\t\tcode: \"OK\",\n\t\t\t\t\tmessage: \"\u8BE5\u6708\u4EFD\u672A\u8BBE\u5B9A\u6536\u8D39\",\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tsuggested_amount: 0,\n\t\t\t\t\t\tpayment_due_days: 30,\n\t\t\t\t\t\thas_schedule: false\n\t\t\t\t\t},\n\t\t\t\t\tmeta: { requestId }\n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\n\t\t\treturn jsonResponse(200, {\n\t\t\t\tok: true,\n\t\t\t\tcode: \"OK\",\n\t\t\t\tmessage: \"\u6210\u529F\u83B7\u53D6\u5EFA\u8BAE\u91D1\u989D\",\n\t\t\t\tdata: {\n\t\t\t\t\tsuggested_amount: Number(schedule.billing_amount || 0),\n\t\t\t\t\tpayment_due_days: Number(schedule.payment_due_days || 30),\n\t\t\t\t\thas_schedule: true\n\t\t\t\t},\n\t\t\t\tmeta: { requestId }\n\t\t\t}, corsHeaders);\n\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\n\t\t\treturn jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// GET /internal/api/v1/receipts - \u6536\u636E\u5217\u8868\n\tif (method === \"GET\" && path === \"/internal/api/v1/receipts\") {\n\t\ttry {\n\t\t\tconst params = url.searchParams;\n\t\t\tconst page = Math.max(1, parseInt(params.get(\"page\") || \"1\", 10));\n\t\t\tconst perPage = Math.min(100, Math.max(1, parseInt(params.get(\"perPage\") || \"20\", 10)));\n\t\t\tconst offset = (page - 1) * perPage;\n\t\t\tconst q = (params.get(\"q\") || \"\").trim();\n\t\t\tconst status = (params.get(\"status\") || \"\").trim();\n\t\t\tconst receiptType = (params.get(\"receipt_type\") || \"\").trim();\n\t\t\tconst dateFrom = (params.get(\"dateFrom\") || \"\").trim();\n\t\t\tconst dateTo = (params.get(\"dateTo\") || \"\").trim();\n\t\t\tconst where = [\"r.is_deleted = 0\"];\n\t\t\tconst binds = [];\n\t\t\tif (q) { where.push(\"(r.receipt_id LIKE ? OR c.company_name LIKE ?)\"); binds.push(`%${q}%`, `%${q}%`); }\n\t\t\tif (status && [\"unpaid\",\"partial\",\"paid\",\"cancelled\"].includes(status)) { where.push(\"r.status = ?\"); binds.push(status); }\n\t\t\tif (receiptType && [\"normal\",\"prepayment\",\"deposit\"].includes(receiptType)) { where.push(\"r.receipt_type = ?\"); binds.push(receiptType); }\n\t\t\tif (dateFrom) { where.push(\"r.receipt_date >= ?\"); binds.push(dateFrom); }\n\t\t\tif (dateTo) { where.push(\"r.receipt_date <= ?\"); binds.push(dateTo); }\n\t\t\tconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\n\t\t\tconst countRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT COUNT(1) AS total FROM Receipts r LEFT JOIN Clients c ON c.client_id = r.client_id ${whereSql}`\n\t\t\t).bind(...binds).first();\n\t\t\tconst total = Number(countRow?.total || 0);\n\t\t\tconst rows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT r.receipt_id, r.client_id, c.company_name AS client_name, r.total_amount, \n\t\t\t\t        r.receipt_date, r.due_date, r.status, r.receipt_type\n\t\t\t\t FROM Receipts r LEFT JOIN Clients c ON c.client_id = r.client_id\n\t\t\t\t ${whereSql}\n\t\t\t\t ORDER BY r.receipt_date DESC, r.receipt_id DESC\n\t\t\t\t LIMIT ? OFFSET ?`\n\t\t\t).bind(...binds, perPage, offset).all();\n\t\t\tconst data = (rows?.results || []).map(r => ({\n\t\t\t\treceiptId: r.receipt_id,\n\t\t\t\tclientId: r.client_id,\n\t\t\t\tclientName: r.client_name || \"\",\n\t\t\t\ttotalAmount: Number(r.total_amount || 0),\n\t\t\t\treceiptDate: r.receipt_date,\n\t\t\t\tdueDate: r.due_date || null,\n\t\t\t\tstatus: r.status,\n\t\t\t\treceiptType: r.receipt_type || \"normal\",\n\t\t\t}));\n\t\t\tconst meta = { requestId, page, perPage, total, hasNext: offset + perPage < total };\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t}\n\t}\n\n\t// GET /internal/api/v1/receipts/statistics - \u5E94\u6536\u8D26\u6B3E\u7EDF\u8BA1\n\tif (method === \"GET\" && path === \"/internal/api/v1/receipts/statistics\") {\n\t\ttry {\n\t\t\tconst today = new Date().toISOString().split('T')[0];\n\t\t\t\n\t\t\t// \u603B\u5E94\u6536\uFF08\u672A\u6536\u6B3E+\u90E8\u5206\u6536\u6B3E\uFF09\n\t\t\tconst totalRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT SUM(total_amount - COALESCE(paid_amount, 0)) as total_receivable\n\t\t\t\t FROM Receipts \n\t\t\t\t WHERE is_deleted = 0 AND status IN ('unpaid', 'partial')`\n\t\t\t).first();\n\t\t\t\n\t\t\t// \u903E\u671F\u5E94\u6536\n\t\t\tconst overdueRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT SUM(total_amount - COALESCE(paid_amount, 0)) as overdue_receivable\n\t\t\t\t FROM Receipts \n\t\t\t\t WHERE is_deleted = 0 AND status IN ('unpaid', 'partial') AND due_date < ?`\n\t\t\t).bind(today).first();\n\t\t\t\n\t\t\t// \u5404\u72B6\u6001\u7EDF\u8BA1\n\t\t\tconst statusStats = await env.DATABASE.prepare(\n\t\t\t\t`SELECT status, COUNT(*) as count, SUM(total_amount) as amount\n\t\t\t\t FROM Receipts \n\t\t\t\t WHERE is_deleted = 0\n\t\t\t\t GROUP BY status`\n\t\t\t).all();\n\t\t\t\n\t\t\tconst data = {\n\t\t\t\ttotalReceivable: Number(totalRow?.total_receivable || 0),\n\t\t\t\toverdueReceivable: Number(overdueRow?.overdue_receivable || 0),\n\t\t\t\tstatusBreakdown: (statusStats?.results || []).map(s => ({\n\t\t\t\t\tstatus: s.status,\n\t\t\t\t\tcount: Number(s.count || 0),\n\t\t\t\t\tamount: Number(s.amount || 0)\n\t\t\t\t}))\n\t\t\t};\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u6210\u529F\", data, meta: { requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\n\t\t\treturn jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// GET /internal/api/v1/receipts/aging-report - \u8D26\u9F84\u5206\u6790\n\tif (method === \"GET\" && path === \"/internal/api/v1/receipts/aging-report\") {\n\t\ttry {\n\t\t\tconst today = new Date().toISOString().split('T')[0];\n\t\t\t\n\t\t\tconst receipts = await env.DATABASE.prepare(\n\t\t\t\t`SELECT r.receipt_id, r.client_id, c.company_name as client_name,\n\t\t\t\t        r.receipt_date, r.due_date, r.total_amount, \n\t\t\t\t        COALESCE(r.paid_amount, 0) as paid_amount,\n\t\t\t\t        (r.total_amount - COALESCE(r.paid_amount, 0)) as outstanding_amount,\n\t\t\t\t        julianday(?) - julianday(r.due_date) as days_overdue\n\t\t\t\t FROM Receipts r\n\t\t\t\t LEFT JOIN Clients c ON c.client_id = r.client_id\n\t\t\t\t WHERE r.is_deleted = 0 AND r.status IN ('unpaid', 'partial')\n\t\t\t\t ORDER BY days_overdue DESC`\n\t\t\t).bind(today).all();\n\t\t\t\n\t\t\tconst aging = {\n\t\t\t\tcurrent: [],      // \u672A\u5230\u671F\n\t\t\t\tdays_30: [],      // 1-30\u5929\n\t\t\t\tdays_60: [],      // 31-60\u5929\n\t\t\t\tdays_90: [],      // 61-90\u5929\n\t\t\t\tover_90: []       // 90\u5929\u4EE5\u4E0A\n\t\t\t};\n\t\t\t\n\t\t\tlet totals = { current: 0, days_30: 0, days_60: 0, days_90: 0, over_90: 0 };\n\t\t\t\n\t\t\t(receipts?.results || []).forEach(r => {\n\t\t\t\tconst item = {\n\t\t\t\t\treceiptId: r.receipt_id,\n\t\t\t\t\tclientId: r.client_id,\n\t\t\t\t\tclientName: r.client_name || \"\",\n\t\t\t\t\treceiptDate: r.receipt_date,\n\t\t\t\t\tdueDate: r.due_date,\n\t\t\t\t\toutstandingAmount: Number(r.outstanding_amount || 0),\n\t\t\t\t\tdaysOverdue: Math.round(Number(r.days_overdue || 0))\n\t\t\t\t};\n\t\t\t\t\n\t\t\t\tconst days = item.daysOverdue;\n\t\t\t\tif (days < 0) {\n\t\t\t\t\taging.current.push(item);\n\t\t\t\t\ttotals.current += item.outstandingAmount;\n\t\t\t\t} else if (days <= 30) {\n\t\t\t\t\taging.days_30.push(item);\n\t\t\t\t\ttotals.days_30 += item.outstandingAmount;\n\t\t\t\t} else if (days <= 60) {\n\t\t\t\t\taging.days_60.push(item);\n\t\t\t\t\ttotals.days_60 += item.outstandingAmount;\n\t\t\t\t} else if (days <= 90) {\n\t\t\t\t\taging.days_90.push(item);\n\t\t\t\t\ttotals.days_90 += item.outstandingAmount;\n\t\t\t\t} else {\n\t\t\t\t\taging.over_90.push(item);\n\t\t\t\t\ttotals.over_90 += item.outstandingAmount;\n\t\t\t\t}\n\t\t\t});\n\t\t\t\n\t\t\tconst data = { aging, totals };\n\t\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u6210\u529F\", data, meta: { requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\n\t\t\treturn jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// GET /internal/api/v1/receipts/:id - \u6536\u636E\u8BE6\u60C5\n\tconst getDetailMatch = path.match(/^\\/internal\\/api\\/v1\\/receipts\\/([^/]+)$/);\n\tif (method === \"GET\" && getDetailMatch) {\n\t\tconst receiptId = decodeURIComponent(getDetailMatch[1]);\n\t\t\n\t\ttry {\n\t\t\t// \u83B7\u53D6\u6536\u636E\u57FA\u672C\u4FE1\u606F\n\t\t\tconst receipt = await env.DATABASE.prepare(\n\t\t\t\t`SELECT r.*, c.company_name as client_name, u.full_name as created_by_name\n\t\t\t\t FROM Receipts r\n\t\t\t\t LEFT JOIN Clients c ON c.client_id = r.client_id\n\t\t\t\t LEFT JOIN Users u ON u.user_id = r.created_by\n\t\t\t\t WHERE r.receipt_id = ? AND r.is_deleted = 0`\n\t\t\t).bind(receiptId).first();\n\t\t\t\n\t\t\tif (!receipt) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6536\u64DA\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u83B7\u53D6\u6536\u636E\u660E\u7EC6\n\t\t\tconst items = await env.DATABASE.prepare(\n\t\t\t\t`SELECT item_id, service_name, quantity, unit_price, subtotal, notes\n\t\t\t\t FROM ReceiptItems\n\t\t\t\t WHERE receipt_id = ?\n\t\t\t\t ORDER BY item_id`\n\t\t\t).bind(receiptId).all();\n\t\t\t\n\t\t\t// \u83B7\u53D6\u6536\u6B3E\u8BB0\u5F55\n\t\t\tconst payments = await env.DATABASE.prepare(\n\t\t\t\t`SELECT p.payment_id, p.payment_date, p.payment_amount, p.payment_method,\n\t\t\t\t        p.reference_number, p.notes, p.created_at, u.full_name as created_by_name\n\t\t\t\t FROM Payments p\n\t\t\t\t LEFT JOIN Users u ON u.user_id = p.created_by\n\t\t\t\t WHERE p.receipt_id = ? AND p.is_deleted = 0\n\t\t\t\t ORDER BY p.payment_date DESC, p.payment_id DESC`\n\t\t\t).bind(receiptId).all();\n\t\t\t\n\t\t\tconst data = {\n\t\t\t\treceiptId: receipt.receipt_id,\n\t\t\t\tclientId: receipt.client_id,\n\t\t\t\tclientName: receipt.client_name || \"\",\n\t\t\t\treceiptDate: receipt.receipt_date,\n\t\t\t\tdueDate: receipt.due_date,\n\t\t\t\ttotalAmount: Number(receipt.total_amount || 0),\n\t\t\t\tpaidAmount: Number(receipt.paid_amount || 0),\n\t\t\t\toutstandingAmount: Number(receipt.total_amount || 0) - Number(receipt.paid_amount || 0),\n\t\t\t\tstatus: receipt.status,\n\t\t\t\treceiptType: receipt.receipt_type || \"normal\",\n\t\t\t\trelatedTaskId: receipt.related_task_id,\n\t\t\t\tclientServiceId: receipt.client_service_id,\n\t\t\t\tbillingMonth: receipt.billing_month,\n\t\t\t\tnotes: receipt.notes || \"\",\n\t\t\t\tcreatedBy: receipt.created_by_name || \"\",\n\t\t\t\tcreatedAt: receipt.created_at,\n\t\t\t\titems: (items?.results || []).map(i => ({\n\t\t\t\t\titemId: i.item_id,\n\t\t\t\t\tserviceName: i.service_name,\n\t\t\t\t\tquantity: Number(i.quantity || 1),\n\t\t\t\t\tunitPrice: Number(i.unit_price || 0),\n\t\t\t\t\tsubtotal: Number(i.subtotal || 0),\n\t\t\t\t\tnotes: i.notes || \"\"\n\t\t\t\t})),\n\t\t\t\tpayments: (payments?.results || []).map(p => ({\n\t\t\t\t\tpaymentId: p.payment_id,\n\t\t\t\t\tpaymentDate: p.payment_date,\n\t\t\t\t\tpaymentAmount: Number(p.payment_amount || 0),\n\t\t\t\t\tpaymentMethod: p.payment_method,\n\t\t\t\t\treferenceNumber: p.reference_number || \"\",\n\t\t\t\t\tnotes: p.notes || \"\",\n\t\t\t\t\tcreatedBy: p.created_by_name || \"\",\n\t\t\t\t\tcreatedAt: p.created_at\n\t\t\t\t}))\n\t\t\t};\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u6210\u529F\", data, meta: { requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\n\t\t\treturn jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// POST /internal/api/v1/receipts/:id/payments - \u65B0\u589E\u6536\u6B3E\u8BB0\u5F55\n\tconst addPaymentMatch = path.match(/^\\/internal\\/api\\/v1\\/receipts\\/([^/]+)\\/payments$/);\n\tif (method === \"POST\" && addPaymentMatch) {\n\t\tconst receiptId = decodeURIComponent(addPaymentMatch[1]);\n\t\t\n\t\tlet body;\n\t\ttry { body = await request.json(); } catch (_) {\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tconst payment_date = String(body?.payment_date || \"\").trim();\n\t\tconst payment_amount = Number(body?.payment_amount);\n\t\tconst payment_method = String(body?.payment_method || \"transfer\").trim();\n\t\tconst reference_number = String(body?.reference_number || \"\").trim();\n\t\tconst notes = String(body?.notes || \"\").trim();\n\t\t\n\t\tconst errors = [];\n\t\tif (!/^\\d{4}-\\d{2}-\\d{2}$/.test(payment_date)) errors.push({ field: \"payment_date\", message: \"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD\" });\n\t\tif (!Number.isFinite(payment_amount) || payment_amount <= 0) errors.push({ field: \"payment_amount\", message: \"\u5FC5\u9808\u5927\u65BC 0\" });\n\t\tif (![\"cash\", \"transfer\", \"check\", \"other\"].includes(payment_method)) errors.push({ field: \"payment_method\", message: \"\u6536\u6B3E\u65B9\u5F0F\u4E0D\u5408\u6CD5\" });\n\t\tif (errors.length) return jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, corsHeaders);\n\t\t\n\t\ttry {\n\t\t\t// \u68C0\u67E5\u6536\u636E\u662F\u5426\u5B58\u5728\n\t\t\tconst receipt = await env.DATABASE.prepare(\n\t\t\t\t\"SELECT receipt_id, total_amount, COALESCE(paid_amount, 0) as paid_amount, status FROM Receipts WHERE receipt_id = ? AND is_deleted = 0\"\n\t\t\t).bind(receiptId).first();\n\t\t\t\n\t\t\tif (!receipt) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6536\u64DA\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\tif (receipt.status === \"cancelled\") {\n\t\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u5DF2\u4F5C\u5EE2\u7684\u6536\u64DA\u4E0D\u53EF\u6536\u6B3E\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\tconst outstanding = Number(receipt.total_amount) - Number(receipt.paid_amount);\n\t\t\tif (payment_amount > outstanding) {\n\t\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: `\u6536\u6B3E\u91D1\u984D\u8D85\u904E\u672A\u6536\u91D1\u984D\uFF08${outstanding}\uFF09`, meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u63D2\u5165\u6536\u6B3E\u8BB0\u5F55\n\t\t\tconst insertResult = await env.DATABASE.prepare(\n\t\t\t\t`INSERT INTO Payments (receipt_id, payment_date, payment_amount, payment_method, reference_number, notes, created_by, created_at, updated_at)\n\t\t\t\t VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`\n\t\t\t).bind(\n\t\t\t\treceiptId, payment_date, payment_amount, payment_method, reference_number, notes,\n\t\t\t\tString(me.user_id), new Date().toISOString(), new Date().toISOString()\n\t\t\t).run();\n\t\t\t\n\t\t\t// \u66F4\u65B0\u6536\u636E\u7684\u5DF2\u6536\u91D1\u989D\u548C\u72B6\u6001\n\t\t\tconst newPaidAmount = Number(receipt.paid_amount) + payment_amount;\n\t\t\tconst newStatus = newPaidAmount >= Number(receipt.total_amount) ? \"paid\" : (newPaidAmount > 0 ? \"partial\" : \"unpaid\");\n\t\t\t\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\"UPDATE Receipts SET paid_amount = ?, status = ?, updated_at = ? WHERE receipt_id = ?\"\n\t\t\t).bind(newPaidAmount, newStatus, new Date().toISOString(), receiptId).run();\n\t\t\t\n\t\t\tconst data = {\n\t\t\t\tpaymentId: insertResult.meta.last_row_id,\n\t\t\t\treceiptId: receiptId,\n\t\t\t\tpaymentDate: payment_date,\n\t\t\t\tpaymentAmount: payment_amount,\n\t\t\t\tpaymentMethod: payment_method,\n\t\t\t\treceiptStatus: newStatus,\n\t\t\t\tpaidAmount: newPaidAmount,\n\t\t\t\toutstandingAmount: Number(receipt.total_amount) - newPaidAmount\n\t\t\t};\n\t\t\t\n\t\t\treturn jsonResponse(201, { ok: true, code: \"CREATED\", message: \"\u5DF2\u8A18\u9304\u6536\u6B3E\", data, meta: { requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\n\t\t\treturn jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\tif (method === \"POST\" && path === \"/internal/api/v1/receipts\") {\n\t\tlet body;\n\t\ttry { body = await request.json(); } catch (_) {\n\t\t\treturn jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\tconst client_id = String(body?.client_id || \"\").trim();\n\t\tconst receipt_date = String(body?.receipt_date || \"\").trim();\n\t\tconst due_date_raw = String(body?.due_date || \"\").trim();\n\t\tconst total_amount = Number(body?.total_amount);\n\t\tlet statusVal = String(body?.status || \"unpaid\").trim();\n\t\tconst notes = (body?.notes || \"\").trim();\n\t\tconst items = Array.isArray(body?.items) ? body.items : [];\n\t\t\n\t\t// \u65B0\u5B57\u6BB5\n\t\tlet receiptType = String(body?.receipt_type || \"normal\").trim();\n\t\tconst relatedTaskId = body?.related_task_id ? parseInt(body.related_task_id, 10) : null;\n\t\tconst clientServiceId = body?.client_service_id ? parseInt(body.client_service_id, 10) : null;\n\t\tconst billingMonth = body?.billing_month ? parseInt(body.billing_month, 10) : null;\n\t\t\n\t\tconst errors = [];\n\t\tif (!client_id) errors.push({ field:\"client_id\", message:\"\u5FC5\u586B\" });\n\t\tif (!/^\\d{4}-\\d{2}-\\d{2}$/.test(receipt_date)) errors.push({ field:\"receipt_date\", message:\"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD\" });\n\t\tif (!Number.isFinite(total_amount) || total_amount <= 0) errors.push({ field:\"total_amount\", message:\"\u5FC5\u9808\u5927\u65BC 0\" });\n\t\tif (!statusVal) statusVal = \"unpaid\";\n\t\tif (![\"unpaid\",\"partial\",\"paid\",\"cancelled\"].includes(statusVal)) errors.push({ field:\"status\", message:\"\u72C0\u614B\u4E0D\u5408\u6CD5\" });\n\t\tif (![\"normal\",\"prepayment\",\"deposit\"].includes(receiptType)) {\n\t\t\treceiptType = \"normal\"; // \u9ED8\u8BA4\u4E3Anormal\n\t\t}\n\t\tif (billingMonth && (billingMonth < 1 || billingMonth > 12)) {\n\t\t\terrors.push({ field:\"billing_month\", message:\"\u6708\u4EFD\u5FC5\u987B\u57281-12\u4E4B\u95F4\" });\n\t\t}\n\t\t\n\t\t// \u9A8C\u8BC1items\n\t\tif (items.length > 0) {\n\t\t\tlet itemsTotal = 0;\n\t\t\titems.forEach((item, idx) => {\n\t\t\t\tconst service_name = String(item?.service_name || \"\").trim();\n\t\t\t\tconst quantity = Number(item?.quantity || 1);\n\t\t\t\tconst unit_price = Number(item?.unit_price || 0);\n\t\t\t\t\n\t\t\t\tif (!service_name) errors.push({ field: `items[${idx}].service_name`, message: \"\u5FC5\u586B\" });\n\t\t\t\tif (!Number.isFinite(quantity) || quantity <= 0) errors.push({ field: `items[${idx}].quantity`, message: \"\u5FC5\u9808\u5927\u65BC 0\" });\n\t\t\t\tif (!Number.isFinite(unit_price) || unit_price < 0) errors.push({ field: `items[${idx}].unit_price`, message: \"\u5FC5\u9808\u5927\u65BC\u7B49\u65BC 0\" });\n\t\t\t\t\n\t\t\t\titemsTotal += quantity * unit_price;\n\t\t\t});\n\t\t\t\n\t\t\t// \u68C0\u67E5items\u603B\u8BA1\u662F\u5426\u4E0Etotal_amount\u4E00\u81F4\uFF08\u5141\u8BB8\u5C0F\u8BEF\u5DEE\uFF09\n\t\t\tif (Math.abs(itemsTotal - total_amount) > 0.01) {\n\t\t\t\terrors.push({ field: \"items\", message: `\u660E\u7D30\u7E3D\u8A08\uFF08${itemsTotal}\uFF09\u8207\u7E3D\u91D1\u984D\uFF08${total_amount}\uFF09\u4E0D\u7B26` });\n\t\t\t}\n\t\t}\n\t\t\n\t\tif (errors.length) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\n\n\t\ttry {\n\t\t\t// \u9A57\u8B49\u5BA2\u6236\u5B58\u5728\n\t\t\tconst c = await env.DATABASE.prepare(\"SELECT 1 FROM Clients WHERE client_id = ? AND is_deleted = 0 LIMIT 1\").bind(client_id).first();\n\t\t\tif (!c) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u5BA2\u6236\u4E0D\u5B58\u5728\", errors:[{ field:\"client_id\", message:\"\u4E0D\u5B58\u5728\" }], meta:{ requestId } }, corsHeaders);\n\n\t\t\t// \u7522\u751F\u6536\u64DA\u865F\uFF1AYYYYMM-XXX\n\t\t\tconst [yyyy, mm] = receipt_date.split(\"-\");\n\t\t\tconst prefix = `${yyyy}${mm}`;\n\t\t\tconst maxRow = await env.DATABASE.prepare(\"SELECT receipt_id FROM Receipts WHERE receipt_id LIKE ? ORDER BY receipt_id DESC LIMIT 1\").bind(`${prefix}-%`).first();\n\t\t\tlet seq = 1;\n\t\t\tif (maxRow && typeof maxRow.receipt_id === \"string\") {\n\t\t\t\tconst m = maxRow.receipt_id.match(/^(\\d{6})-(\\d{3})$/);\n\t\t\t\tif (m) seq = Math.max(seq, parseInt(m[2], 10) + 1);\n\t\t\t}\n\t\t\tconst receipt_id = `${prefix}-${String(seq).padStart(3, \"0\")}`;\n\n\t\t\t// \u5230\u671F\u65E5\uFF1A\u672A\u63D0\u4F9B\u5247\u6839\u636E\u6536\u8D39\u660E\u7EC6\u6216\u9ED8\u8BA4+30\u5929\n\t\t\tlet due_date = due_date_raw;\n\t\t\tif (!due_date) {\n\t\t\t\tlet dueDays = 30; // \u9ED8\u8BA430\u5929\n\t\t\t\t\n\t\t\t\t// \u5982\u679C\u63D0\u4F9B\u4E86client_service_id\u548Cbilling_month\uFF0C\u5C1D\u8BD5\u4ECE\u6536\u8D39\u660E\u7EC6\u83B7\u53D6payment_due_days\n\t\t\t\tif (clientServiceId && billingMonth) {\n\t\t\t\t\tconst schedule = await env.DATABASE.prepare(\n\t\t\t\t\t\t\"SELECT payment_due_days FROM ServiceBillingSchedule WHERE client_service_id = ? AND billing_month = ?\"\n\t\t\t\t\t).bind(clientServiceId, billingMonth).first();\n\t\t\t\t\tif (schedule && schedule.payment_due_days) {\n\t\t\t\t\t\tdueDays = Number(schedule.payment_due_days);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tconst d = new Date(receipt_date + \"T00:00:00Z\");\n\t\t\t\td.setUTCDate(d.getUTCDate() + dueDays);\n\t\t\t\tconst y = d.getUTCFullYear();\n\t\t\t\tconst m2 = String(d.getUTCMonth() + 1).padStart(2, \"0\");\n\t\t\t\tconst day = String(d.getUTCDate()).padStart(2, \"0\");\n\t\t\t\tdue_date = `${y}-${m2}-${day}`;\n\t\t\t}\n\n\t\t\t// \u8BA1\u7B97 service_month (YYYY-MM\u683C\u5F0F\uFF0C\u7528\u4E8E\u5173\u8054\u4EFB\u52A1)\n\t\t\tlet serviceMonth = null;\n\t\t\tif (billingMonth) {\n\t\t\t\t// \u5982\u679C\u6709 billing_month\uFF0C\u4F7F\u7528 receipt_date \u7684\u5E74\u4EFD + billing_month\n\t\t\t\tconst year = receipt_date.split('-')[0];\n\t\t\t\tserviceMonth = `${year}-${String(billingMonth).padStart(2, '0')}`;\n\t\t\t} else {\n\t\t\t\t// \u5426\u5219\u4F7F\u7528 receipt_date \u7684\u5E74\u6708\n\t\t\t\tserviceMonth = receipt_date.substring(0, 7);\n\t\t\t}\n\t\t\t\n\t\t\t// \u63D2\u5165\u6536\u636E\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`INSERT INTO Receipts (receipt_id, client_id, receipt_date, due_date, total_amount, paid_amount, status, \n\t\t\t\t receipt_type, related_task_id, client_service_id, billing_month, service_month,\n\t\t\t\t is_auto_generated, notes, created_by, created_at, updated_at) \n\t\t\t\t VALUES (?, ?, ?, ?, ?, 0, ?, ?, ?, ?, ?, ?, 0, ?, ?, ?, ?)`\n\t\t\t).bind(\n\t\t\t\treceipt_id, client_id, receipt_date, due_date, total_amount, statusVal, \n\t\t\t\treceiptType, relatedTaskId, clientServiceId, billingMonth, serviceMonth,\n\t\t\t\tnotes, String(me.user_id), new Date().toISOString(), new Date().toISOString()\n\t\t\t).run();\n\t\t\t\n\t\t\t// \u63D2\u5165\u6536\u636E\u660E\u7EC6\n\t\t\tif (items.length > 0) {\n\t\t\t\tfor (const item of items) {\n\t\t\t\t\tconst service_name = String(item.service_name).trim();\n\t\t\t\t\tconst quantity = Number(item.quantity || 1);\n\t\t\t\t\tconst unit_price = Number(item.unit_price || 0);\n\t\t\t\t\tconst subtotal = quantity * unit_price;\n\t\t\t\t\tconst item_notes = String(item.notes || \"\").trim();\n\t\t\t\t\t\n\t\t\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\t\t`INSERT INTO ReceiptItems (receipt_id, service_name, quantity, unit_price, subtotal, notes, created_at)\n\t\t\t\t\t\t VALUES (?, ?, ?, ?, ?, ?, ?)`\n\t\t\t\t\t).bind(receipt_id, service_name, quantity, unit_price, subtotal, item_notes, new Date().toISOString()).run();\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tconst data = { \n\t\t\t\treceiptId: receipt_id, \n\t\t\t\tclientId: client_id, \n\t\t\t\ttotalAmount: total_amount, \n\t\t\t\treceiptDate: receipt_date, \n\t\t\t\tdueDate: due_date, \n\t\t\t\tstatus: statusVal,\n\t\t\t\treceiptType: receiptType,\n\t\t\t\trelatedTaskId: relatedTaskId,\n\t\t\t\tclientServiceId: clientServiceId,\n\t\t\t\tbillingMonth: billingMonth,\n\t\t\t\titemsCount: items.length\n\t\t\t};\n\t\t\treturn jsonResponse(201, { ok:true, code:\"CREATED\", message:\"\u5DF2\u5EFA\u7ACB\", data, meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err) }));\n\t\t\tconst body = { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\n\t// PATCH /internal/api/v1/receipts/:id - \u7F16\u8F91\u6536\u636E\n\tconst patchMatch = path.match(/^\\/internal\\/api\\/v1\\/receipts\\/([^/]+)$/);\n\tif (method === \"PATCH\" && patchMatch) {\n\t\tconst receiptId = decodeURIComponent(patchMatch[1]);\n\t\t\n\t\tlet body;\n\t\ttry { body = await request.json(); } catch (_) {\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\ttry {\n\t\t\t// \u68C0\u67E5\u6536\u636E\u662F\u5426\u5B58\u5728\n\t\t\tconst existing = await env.DATABASE.prepare(\n\t\t\t\t\"SELECT * FROM Receipts WHERE receipt_id = ? AND is_deleted = 0\"\n\t\t\t).bind(receiptId).first();\n\t\t\t\n\t\t\tif (!existing) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6536\u64DA\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u6784\u5EFA\u66F4\u65B0\u5B57\u6BB5\n\t\t\tconst updates = [];\n\t\t\tconst binds = [];\n\t\t\t\n\t\t\tif (body.due_date !== undefined) {\n\t\t\t\tconst due_date = String(body.due_date || \"\").trim();\n\t\t\t\tif (due_date && !/^\\d{4}-\\d{2}-\\d{2}$/.test(due_date)) {\n\t\t\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u5230\u671F\u65E5\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t\t\t}\n\t\t\t\tupdates.push(\"due_date = ?\");\n\t\t\t\tbinds.push(due_date || null);\n\t\t\t}\n\t\t\t\n\t\t\tif (body.notes !== undefined) {\n\t\t\t\tupdates.push(\"notes = ?\");\n\t\t\t\tbinds.push(String(body.notes || \"\").trim());\n\t\t\t}\n\t\t\t\n\t\t\tif (body.status !== undefined) {\n\t\t\t\tconst status = String(body.status).trim();\n\t\t\t\tif (![\"unpaid\", \"partial\", \"paid\", \"cancelled\"].includes(status)) {\n\t\t\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u72C0\u614B\u4E0D\u5408\u6CD5\", meta: { requestId } }, corsHeaders);\n\t\t\t\t}\n\t\t\t\tupdates.push(\"status = ?\");\n\t\t\t\tbinds.push(status);\n\t\t\t}\n\t\t\t\n\t\t\tif (updates.length === 0) {\n\t\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u672A\u63D0\u4F9B\u66F4\u65B0\u5B57\u6BB5\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\tupdates.push(\"updated_at = ?\");\n\t\t\tbinds.push(new Date().toISOString());\n\t\t\tbinds.push(receiptId);\n\t\t\t\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`UPDATE Receipts SET ${updates.join(\", \")} WHERE receipt_id = ?`\n\t\t\t).bind(...binds).run();\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u5DF2\u66F4\u65B0\", meta: { requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\n\t\t\treturn jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// DELETE /internal/api/v1/receipts/:id - \u4F5C\u5E9F\u6536\u636E\n\tconst deleteMatch = path.match(/^\\/internal\\/api\\/v1\\/receipts\\/([^/]+)$/);\n\tif (method === \"DELETE\" && deleteMatch) {\n\t\tconst receiptId = decodeURIComponent(deleteMatch[1]);\n\t\t\n\t\ttry {\n\t\t\t// \u68C0\u67E5\u6536\u636E\u662F\u5426\u5B58\u5728\n\t\t\tconst existing = await env.DATABASE.prepare(\n\t\t\t\t\"SELECT receipt_id, status FROM Receipts WHERE receipt_id = ? AND is_deleted = 0\"\n\t\t\t).bind(receiptId).first();\n\t\t\t\n\t\t\tif (!existing) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6536\u64DA\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u6807\u8BB0\u4E3A\u4F5C\u5E9F\uFF08\u8F6F\u5220\u9664+\u72B6\u6001\u6539\u4E3Acancelled\uFF09\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\"UPDATE Receipts SET status = 'cancelled', is_deleted = 1, updated_at = ? WHERE receipt_id = ?\"\n\t\t\t).bind(new Date().toISOString(), receiptId).run();\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u5DF2\u4F5C\u5EE2\", meta: { requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\n\t\t\treturn jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\treturn jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\n}\n\n\n\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nexport async function handlePayroll(request, env, me, requestId, url, path) {\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\t\r\n\t// \u85AA\u8CC7\u529F\u80FD\u5C1A\u672A\u5BE6\u4F5C\r\n\treturn jsonResponse(501, { \r\n\t\tok: false, \r\n\t\tcode: \"NOT_IMPLEMENTED\", \r\n\t\tmessage: \"\u85AA\u8CC7\u529F\u80FD\u5C1A\u672A\u5BE6\u4F5C\", \r\n\t\tmeta: { requestId } \r\n\t}, corsHeaders);\r\n}\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\nimport { generateCacheKey, getCache, saveCache, invalidateCacheByType } from \"../cache-helper.js\";\n\n// \u786E\u4FDD\u7528\u6237\u6709\u57FA\u672C\u5047\u671F\u4F59\u989D\u8BB0\u5F55\nasync function ensureBasicLeaveBalances(env, userId, year) {\n\t// \u75C5\u5047\uFF1A30\u5929/\u5E74\n\tawait env.DATABASE.prepare(\n\t\t\"INSERT OR IGNORE INTO LeaveBalances (user_id, leave_type, year, total, used, remain, updated_at) VALUES (?, 'sick', ?, 30, 0, 30, datetime('now'))\"\n\t).bind(userId, year).run();\n\t\n\t// \u4E8B\u5047\uFF1A14\u5929/\u5E74\n\tawait env.DATABASE.prepare(\n\t\t\"INSERT OR IGNORE INTO LeaveBalances (user_id, leave_type, year, total, used, remain, updated_at) VALUES (?, 'personal', ?, 14, 0, 14, datetime('now'))\"\n\t).bind(userId, year).run();\n}\n\nexport async function handleLeaves(request, env, me, requestId, url, path) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\tconst method = request.method.toUpperCase();\n\n\tif (path === \"/internal/api/v1/leaves/balances\") {\n\t\tif (method !== \"GET\") {\n\t\t\treturn jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\ttry {\n\t\t\tconst params = url.searchParams; \n\t\t\tconst year = parseInt(params.get(\"year\") || String(new Date().getFullYear()), 10);\n\t\t\tconst queryUserId = params.get(\"user_id\");\n\t\t\t\n\t\t\t// \u78BA\u5B9A\u67E5\u8A62\u7684\u7528\u6236ID\uFF1A\u7BA1\u7406\u54E1\u53EF\u4EE5\u6307\u5B9A\uFF0C\u54E1\u5DE5\u53EA\u80FD\u67E5\u81EA\u5DF1\n\t\t\tlet targetUserId = String(me.user_id);\n\t\t\tif (queryUserId && me.is_admin) {\n\t\t\t\ttargetUserId = String(queryUserId);\n\t\t\t}\n\t\t\t\n\t\t\t// \u26A1 \u5C1D\u8BD5\u4ECE\u7F13\u5B58\u8BFB\u53D6\n\t\t\tconst cacheKey = generateCacheKey('leaves_balances', { userId: targetUserId, year });\n\t\t\tconst cached = await getCache(env, cacheKey);\n\t\t\t\n\t\t\tif (cached && cached.data) {\n\t\t\t\treturn jsonResponse(200, { \n\t\t\t\t\tok: true, \n\t\t\t\t\tcode: \"OK\", \n\t\t\t\t\tmessage: \"\u6210\u529F\uFF08\u7F13\u5B58\uFF09\", \n\t\t\t\t\tdata: cached.data, \n\t\t\t\t\tmeta: { requestId, year, userId: targetUserId, ...cached.meta } \n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u786E\u4FDD\u7528\u6237\u6709\u57FA\u672C\u5047\u671F\u4F59\u989D\u8BB0\u5F55\n\t\t\tawait ensureBasicLeaveBalances(env, targetUserId, year);\n\t\t\t\n\t\t\t// \u6392\u9664\u88DC\u4F11\u985E\u578B\uFF08\u88DC\u4F11\u7531 CompensatoryLeaveGrants \u8A08\u7B97\uFF09\n\t\t\tconst rows = await env.DATABASE.prepare(\n\t\t\t\t\"SELECT leave_type, year, total, used, remain FROM LeaveBalances WHERE user_id = ? AND year = ? AND leave_type != 'comp'\"\n\t\t\t).bind(targetUserId, year).all();\n\t\t\tconst data = (rows?.results || []).map(r => ({ type: r.leave_type, year: Number(r.year), total: Number(r.total), used: Number(r.used), remain: Number(r.remain) }));\n\t\t\t\n\t\t\t// \u88DC\u4F11\u9918\u984D\u5F9E CompensatoryLeaveGrants \u8A08\u7B97\uFF08\u7576\u6708\u6709\u6548\uFF09\n\t\t\tconst compRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT SUM(hours_remaining) as total FROM CompensatoryLeaveGrants \n\t\t\t\t WHERE user_id = ? AND status = 'active' AND hours_remaining > 0`\n\t\t\t).bind(targetUserId).first();\n\t\t\tconst compRemain = Number(compRow?.total || 0);\n\t\t\t\n\t\t\tif (compRemain > 0) {\n\t\t\t\tdata.push({ type: 'comp', year, total: compRemain, used: 0, remain: compRemain });\n\t\t\t}\n\t\t\t\n\t\t\t// \u6DFB\u52A0\u751F\u6D3B\u4E8B\u4EF6\u5047\u671F\u9918\u984D\n\t\t\tconst lifeEventRows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT event_type, leave_type, days_granted, days_used, days_remaining, valid_until\n\t\t\t\t FROM LifeEventLeaveGrants \n\t\t\t\t WHERE user_id = ? AND status = 'active' AND days_remaining > 0 \n\t\t\t\t AND date(valid_until) >= date('now')`\n\t\t\t).bind(targetUserId).all();\n\t\t\t\n\t\t\t(lifeEventRows?.results || []).forEach(r => {\n\t\t\t\tconst typeName = r.leave_type;\n\t\t\t\tdata.push({ \n\t\t\t\t\ttype: typeName, \n\t\t\t\t\tyear, \n\t\t\t\t\ttotal: Number(r.days_granted || 0), \n\t\t\t\t\tused: Number(r.days_used || 0), \n\t\t\t\t\tremain: Number(r.days_remaining || 0),\n\t\t\t\t\tvalidUntil: r.valid_until\n\t\t\t\t});\n\t\t\t});\n\t\t\t\n\t\t\t// \u26A1 \u4FDD\u5B58\u5230\u7F13\u5B58\uFF08\u4E0D\u7B49\u5F85\u5B8C\u6210\uFF09\n\t\t\tsaveCache(env, cacheKey, 'leaves_balances', data, {\n\t\t\t\tuserId: targetUserId,\n\t\t\t\tscopeParams: { userId: targetUserId, year }\n\t\t\t}).catch(err => console.error('[LEAVES] \u4F59\u989D\u7F13\u5B58\u4FDD\u5B58\u5931\u8D25:', err));\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, year, userId: targetUserId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\tif (path === \"/internal/api/v1/leaves\") {\n\t\tif (method === \"GET\") {\n\t\t\ttry {\n\t\t\t\tconst params = url.searchParams;\n\t\t\t\tconst page = Math.max(1, parseInt(params.get(\"page\") || \"1\", 10));\n\t\t\t\tconst perPage = Math.min(100, Math.max(1, parseInt(params.get(\"perPage\") || \"20\", 10)));\n\t\t\t\tconst offset = (page - 1) * perPage;\n\t\t\t\tconst q = (params.get(\"q\") || \"\").trim();\n\t\t\t\tconst status = (params.get(\"status\") || \"\").trim();\n\t\t\t\tconst type = (params.get(\"type\") || \"\").trim();\n\t\t\t\tconst dateFrom = (params.get(\"dateFrom\") || \"\").trim();\n\t\t\t\tconst dateTo = (params.get(\"dateTo\") || \"\").trim();\n\t\t\t\tconst queryUserId = params.get(\"user_id\");\n\t\t\t\t\n\t\t\t\t// \u26A1 \u5C1D\u8BD5\u4ECE\u7F13\u5B58\u8BFB\u53D6\n\t\t\t\tconst cacheKey = generateCacheKey('leaves_list', { \n\t\t\t\t\tpage, perPage, q, status, type, dateFrom, dateTo, userId: queryUserId || me.user_id \n\t\t\t\t});\n\t\t\t\tconst cached = await getCache(env, cacheKey);\n\t\t\t\t\n\t\t\t\tif (cached && cached.data) {\n\t\t\t\t\treturn jsonResponse(200, { \n\t\t\t\t\t\tok: true, \n\t\t\t\t\t\tcode: \"OK\", \n\t\t\t\t\t\tmessage: \"\u6210\u529F\uFF08\u7F13\u5B58\uFF09\", \n\t\t\t\t\t\tdata: cached.data.list, \n\t\t\t\t\t\tmeta: { ...cached.data.meta, requestId, ...cached.meta } \n\t\t\t\t\t}, corsHeaders);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tconst where = [\"l.is_deleted = 0\"];\n\t\t\t\tconst binds = [];\n\t\t\t\t\n\t\t\t\t// \u7BA1\u7406\u54E1\u53EF\u4EE5\u6307\u5B9Auser_id\uFF0C\u54E1\u5DE5\u53EA\u80FD\u770B\u81EA\u5DF1\u7684\n\t\t\t\tif (queryUserId && me.is_admin) {\n\t\t\t\t\twhere.push(\"l.user_id = ?\");\n\t\t\t\t\tbinds.push(String(queryUserId));\n\t\t\t\t} else if (!me.is_admin) { \n\t\t\t\t\twhere.push(\"l.user_id = ?\"); \n\t\t\t\t\tbinds.push(String(me.user_id)); \n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif (q) { where.push(\"l.leave_type LIKE ?\"); binds.push(`%${q}%`); }\n\t\t\t\tif (status && [\"pending\",\"approved\",\"rejected\"].includes(status)) { where.push(\"l.status = ?\"); binds.push(status); }\n\t\t\t\tif (type) { where.push(\"l.leave_type = ?\"); binds.push(type); }\n\t\t\t\tif (dateFrom) { where.push(\"l.start_date >= ?\"); binds.push(dateFrom); }\n\t\t\t\tif (dateTo) { where.push(\"l.end_date <= ?\"); binds.push(dateTo); }\n\t\t\t\tconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\n\t\t\t\tconst countRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM LeaveRequests l ${whereSql}`).bind(...binds).first();\n\t\t\t\tconst total = Number(countRow?.total || 0);\n\t\t\t\tconst rows = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT l.leave_id, l.leave_type, l.start_date, l.end_date, l.unit, l.amount, l.start_time, l.end_time, l.status, l.submitted_at\n\t\t\t\t\t FROM LeaveRequests l\n\t\t\t\t\t ${whereSql}\n\t\t\t\t\t ORDER BY l.submitted_at DESC, l.leave_id DESC\n\t\t\t\t\t LIMIT ? OFFSET ?`\n\t\t\t\t).bind(...binds, perPage, offset).all();\n\t\t\t\tconst data = (rows?.results || []).map(r => ({\n\t\t\t\t\tleaveId: String(r.leave_id),\n\t\t\t\t\ttype: r.leave_type,\n\t\t\t\t\tstart: r.start_date,\n\t\t\t\t\tend: r.end_date,\n\t\t\t\t\tunit: r.unit,\n\t\t\t\t\tamount: Number(r.amount || 0),\n\t\t\t\t\tstartTime: r.start_time || null,\n\t\t\t\t\tendTime: r.end_time || null,\n\t\t\t\t\tstatus: r.status,\n\t\t\t\t\tsubmittedAt: r.submitted_at,\n\t\t\t\t}));\n\t\t\t\tconst meta = { requestId, page, perPage, total, hasNext: offset + perPage < total };\n\t\t\t\t\n\t\t\t\t// \u26A1 \u4FDD\u5B58\u5230\u7F13\u5B58\uFF08\u4E0D\u7B49\u5F85\u5B8C\u6210\uFF09\n\t\t\t\tsaveCache(env, cacheKey, 'leaves_list', { list: data, meta }, {\n\t\t\t\t\tuserId: queryUserId || String(me.user_id),\n\t\t\t\t\tscopeParams: { page, perPage, q, status, type, dateFrom, dateTo }\n\t\t\t\t}).catch(err => console.error('[LEAVES] \u5217\u8868\u7F13\u5B58\u4FDD\u5B58\u5931\u8D25:', err));\n\t\t\t\t\n\t\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta }, corsHeaders);\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\t\tconst body = { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } };\n\t\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\t\treturn jsonResponse(500, body, getCorsHeadersForRequest(request, env));\n\t\t\t}\n\t\t}\n\n\t\tif (method === \"POST\") {\n\t\t\tlet body;\n\t\t\ttry { body = await request.json(); } catch (_) {\n\t\t\t\treturn jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t\tconst leave_type = String(body?.leave_type || \"\").trim();\n\t\t\tconst start_date = String(body?.start_date || \"\").trim();\n\t\t\tconst amount = Number(body?.amount);\n\t\t\tconst start_time = String(body?.start_time || \"\").trim();\n\t\t\tconst end_time = String(body?.end_time || \"\").trim();\n\t\t\tconst errors = [];\n\t\t\tif (!leave_type) errors.push({ field:\"leave_type\", message:\"\u5FC5\u9078\u5047\u5225\" });\n\t\t\tif (!/^\\d{4}-\\d{2}-\\d{2}$/.test(start_date)) errors.push({ field:\"start_date\", message:\"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD\" });\n\t\t\tif (!Number.isFinite(amount) || amount <= 0) errors.push({ field:\"amount\", message:\"\u9700\u5927\u65BC 0\" });\n\t\t\t// \u9A57\u8B49\u5FC5\u9808\u662F 0.5 \u7684\u500D\u6578\uFF08\u534A\u5C0F\u6642\uFF09\n\t\t\tif (Math.abs(amount * 2 - Math.round(amount * 2)) > 1e-9) {\n\t\t\t\terrors.push({ field:\"amount\", message:\"\u8ACB\u5047\u5C0F\u6642\u6578\u5FC5\u9808\u662F 0.5 \u7684\u500D\u6578\uFF08\u4F8B\u5982\uFF1A0.5\u30011\u30011.5\u30012\uFF09\" });\n\t\t\t}\n\t\t\t// \u5FC5\u9808\u63D0\u4F9B\u6642\u9593\n\t\t\tif (!/^\\d{2}:\\d{2}$/.test(start_time)) errors.push({ field:\"start_time\", message:\"\u8ACB\u9078\u64C7\u958B\u59CB\u6642\u9593\uFF08\u683C\u5F0F HH:MM\uFF09\" });\n\t\t\tif (!/^\\d{2}:\\d{2}$/.test(end_time)) errors.push({ field:\"end_time\", message:\"\u8ACB\u9078\u64C7\u7D50\u675F\u6642\u9593\uFF08\u683C\u5F0F HH:MM\uFF09\" });\n\t\t\t\n\t\t\t// \u9A57\u8B49\u6642\u9593\u5FC5\u9808\u662F30\u5206\u9418\u7684\u500D\u6578\n\t\t\tif (start_time && /^\\d{2}:\\d{2}$/.test(start_time)) {\n\t\t\t\tconst [h, m] = start_time.split(':').map(Number);\n\t\t\t\tif (m !== 0 && m !== 30) errors.push({ field:\"start_time\", message:\"\u6642\u9593\u5FC5\u9808\u662F\u6574\u9EDE\u6216\u534A\u9EDE\uFF08\u5982 9:00\u30019:30\uFF09\" });\n\t\t\t}\n\t\t\tif (end_time && /^\\d{2}:\\d{2}$/.test(end_time)) {\n\t\t\t\tconst [h, m] = end_time.split(':').map(Number);\n\t\t\t\tif (m !== 0 && m !== 30) errors.push({ field:\"end_time\", message:\"\u6642\u9593\u5FC5\u9808\u662F\u6574\u9EDE\u6216\u534A\u9EDE\uFF08\u5982 9:00\u30019:30\uFF09\" });\n\t\t\t}\n\t\t\t// \u6027\u5225\u9650\u5236\u6AA2\u67E5\n\t\t\tconst femaleOnlyLeaveTypes = ['maternity', 'menstrual', 'prenatal_checkup'];\n\t\t\tconst maleOnlyLeaveTypes = ['paternity'];\n\t\t\t\n\t\t\tif (femaleOnlyLeaveTypes.includes(leave_type) && me.gender === 'M') {\n\t\t\t\terrors.push({ field:\"leave_type\", message:\"\u6B64\u5047\u5225\u50C5\u9650\u5973\u6027\" });\n\t\t\t}\n\t\t\tif (maleOnlyLeaveTypes.includes(leave_type) && me.gender === 'F') {\n\t\t\t\terrors.push({ field:\"leave_type\", message:\"\u6B64\u5047\u5225\u50C5\u9650\u7537\u6027\" });\n\t\t\t}\n\t\t\t\n\t\t\t// \u9700\u8981\u5148\u767B\u8A18\u751F\u6D3B\u4E8B\u4EF6\u7684\u5047\u5225\uFF0C\u6AA2\u67E5\u662F\u5426\u6709\u8DB3\u5920\u9918\u984D\n\t\t\tconst lifeEventLeaveTypes = ['marriage', 'funeral', 'maternity', 'prenatal_checkup', 'paternity'];\n\t\t\tif (lifeEventLeaveTypes.includes(leave_type)) {\n\t\t\t\tconst daysNeeded = amount / 8; // \u7D71\u4E00\u4F7F\u7528\u5C0F\u6642\uFF0C8\u5C0F\u6642=1\u5929\n\t\t\t\tconst grantRow = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT SUM(days_remaining) as available FROM LifeEventLeaveGrants \n\t\t\t\t\t WHERE user_id = ? AND leave_type = ? AND status = 'active' \n\t\t\t\t\t AND date(valid_until) >= date('now')`\n\t\t\t\t).bind(String(me.user_id), leave_type).first();\n\t\t\t\t\n\t\t\t\tconst availableDays = Number(grantRow?.available || 0);\n\t\t\t\tif (availableDays < daysNeeded) {\n\t\t\t\t\terrors.push({ field:\"leave_type\", message:`${leave_type}\u9918\u984D\u4E0D\u8DB3\uFF0C\u8ACB\u5148\u767B\u8A18\u751F\u6D3B\u4E8B\u4EF6\u3002\u5269\u9918\uFF1A${availableDays}\u65E5\uFF0C\u9700\u8981\uFF1A${daysNeeded}\u65E5` });\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t// \u88DC\u4F11\u7279\u6B8A\u8655\u7406\uFF1A\u6AA2\u67E5\u9918\u984D\uFF08FIFO\uFF09\n\t\t\tif (leave_type === 'comp') {\n\t\t\t\tconst hoursNeeded = amount; // \u7D71\u4E00\u4F7F\u7528\u5C0F\u6642\n\t\t\t\tconst compGrants = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT grant_id, hours_remaining FROM CompensatoryLeaveGrants \n\t\t\t\t\t WHERE user_id = ? AND status = 'active' AND hours_remaining > 0 \n\t\t\t\t\t ORDER BY generated_date ASC`\n\t\t\t\t).bind(String(me.user_id)).all();\n\t\t\t\tconst totalAvailable = (compGrants?.results || []).reduce((sum, g) => sum + Number(g.hours_remaining || 0), 0);\n\t\t\t\tif (totalAvailable < hoursNeeded) {\n\t\t\t\t\terrors.push({ field:\"amount\", message:`\u88DC\u4F11\u4E0D\u8DB3\uFF08\u5269\u9918 ${totalAvailable} \u5C0F\u6642\uFF0C\u9700\u8981 ${hoursNeeded} \u5C0F\u6642\uFF09` });\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tif (errors.length) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\n\n\t\t\ttry {\n\t\t\t\t// \u5EFA\u7ACB\u8ACB\u5047\u7533\u8ACB\uFF08\u81EA\u52D5\u6279\u51C6\uFF0C\u7D50\u675F\u65E5\u671F\u7B49\u65BC\u958B\u59CB\u65E5\u671F\uFF0C\u7D71\u4E00\u4F7F\u7528\u5C0F\u6642\u55AE\u4F4D\uFF09\n\t\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\t\"INSERT INTO LeaveRequests (user_id, leave_type, start_date, end_date, unit, amount, start_time, end_time, status, submitted_at, reviewed_at, reviewed_by) VALUES (?, ?, ?, ?, 'hour', ?, ?, ?, 'approved', datetime('now'), datetime('now'), ?)\"\n\t\t\t\t).bind(String(me.user_id), leave_type, start_date, start_date, amount, start_time || null, end_time || null, String(me.user_id)).run();\n\t\t\t\tconst idRow = await env.DATABASE.prepare(\"SELECT last_insert_rowid() AS id\").first();\n\t\t\t\tconst leaveId = String(idRow?.id);\n\t\t\t\t\n\t\t\t\t// \u5982\u679C\u662F\u88DC\u4F11\uFF0C\u7ACB\u5373\u6263\u6E1B\uFF08FIFO\uFF09\n\t\t\t\tif (leave_type === 'comp') {\n\t\t\t\t\tconst hoursNeeded = amount; // \u7D71\u4E00\u4F7F\u7528\u5C0F\u6642\n\t\t\t\t\tconst compGrants = await env.DATABASE.prepare(\n\t\t\t\t\t\t`SELECT grant_id, hours_remaining FROM CompensatoryLeaveGrants \n\t\t\t\t\t\t WHERE user_id = ? AND status = 'active' AND hours_remaining > 0 \n\t\t\t\t\t\t ORDER BY generated_date ASC`\n\t\t\t\t\t).bind(String(me.user_id)).all();\n\t\t\t\t\t\n\t\t\t\t\tlet remaining = hoursNeeded;\n\t\t\t\t\tfor (const grant of (compGrants?.results || [])) {\n\t\t\t\t\t\tif (remaining <= 0) break;\n\t\t\t\t\t\tconst deduct = Math.min(remaining, Number(grant.hours_remaining || 0));\n\t\t\t\t\t\tconst newRemaining = Number(grant.hours_remaining || 0) - deduct;\n\t\t\t\t\t\tconst newUsed = (await env.DATABASE.prepare(`SELECT hours_used FROM CompensatoryLeaveGrants WHERE grant_id = ?`).bind(grant.grant_id).first())?.hours_used || 0;\n\t\t\t\t\t\tconst newStatus = newRemaining <= 0 ? 'fully_used' : 'active';\n\t\t\t\t\t\t\n\t\t\t\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\t\t\t`UPDATE CompensatoryLeaveGrants \n\t\t\t\t\t\t\t SET hours_used = ?, hours_remaining = ?, status = ? \n\t\t\t\t\t\t\t WHERE grant_id = ?`\n\t\t\t\t\t\t).bind(Number(newUsed) + deduct, newRemaining, newStatus, grant.grant_id).run();\n\t\t\t\t\t\t\n\t\t\t\t\tremaining -= deduct;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t// \u26A1 \u5931\u6548\u8BE5\u7528\u6237\u7684\u8BF7\u5047\u5217\u8868\u548C\u4F59\u989D\u7F13\u5B58\n\t\t\tPromise.all([\n\t\t\t\tinvalidateCacheByType(env, 'leaves_list', { userId: String(me.user_id) }),\n\t\t\t\tinvalidateCacheByType(env, 'leaves_balances', { userId: String(me.user_id) })\n\t\t\t]).catch(err => console.error('[LEAVES] \u5931\u6548\u7F13\u5B58\u5931\u8D25:', err));\n\t\t\t\n\t\t\treturn jsonResponse(201, { ok:true, code:\"CREATED\", message:\"\u7533\u8ACB\u6210\u529F\", data:{ leaveId }, meta:{ requestId } }, corsHeaders);\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t}\n\t}\n\n\t// Cron Job: \u624B\u52D5\u89F8\u767C\u88DC\u4F11\u5230\u671F\u8F49\u52A0\u73ED\u8CBB\n\tif (path === \"/internal/api/v1/admin/cron/execute\" && method === \"POST\") {\n\t\tif (!me?.is_admin) {\n\t\t\treturn jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tlet body;\n\t\ttry { body = await request.json(); } catch (_) {\n\t\t\treturn jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tconst jobName = String(body?.job_name || '').trim();\n\t\tif (jobName !== 'comp_leave_expiry') {\n\t\t\treturn jsonResponse(400, { ok:false, code:\"INVALID_JOB\", message:\"\u4E0D\u652F\u63F4\u7684 Job \u540D\u7A31\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\ttry {\n\t\t\t// \u8A08\u7B97\u4E0A\u6708\u5E95\u65E5\u671F\n\t\t\tconst now = new Date();\n\t\t\tconst lastMonth = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() - 1, 1));\n\t\t\tconst lastDayOfLastMonth = new Date(Date.UTC(lastMonth.getUTCFullYear(), lastMonth.getUTCMonth() + 1, 0));\n\t\t\tconst expiryDate = `${lastDayOfLastMonth.getUTCFullYear()}-${String(lastDayOfLastMonth.getUTCMonth() + 1).padStart(2, '0')}-${String(lastDayOfLastMonth.getUTCDate()).padStart(2, '0')}`;\n\t\t\tconst currentMonth = `${now.getUTCFullYear()}-${String(now.getUTCMonth() + 1).padStart(2, '0')}`;\n\t\t\t\n\t\t\t// \u6383\u63CF\u5230\u671F\u7684\u88DC\u4F11\u8A18\u9304\n\t\t\tconst expiredGrants = await env.DATABASE.prepare(\n\t\t\t\t`SELECT g.grant_id, g.user_id, g.hours_remaining, g.original_rate, u.base_salary\n\t\t\t\t FROM CompensatoryLeaveGrants g\n\t\t\t\t LEFT JOIN Users u ON g.user_id = u.user_id\n\t\t\t\t WHERE g.expiry_date = ? AND g.status = 'active' AND g.hours_remaining > 0`\n\t\t\t).bind(expiryDate).all();\n\t\t\t\n\t\t\tlet processedCount = 0;\n\t\t\tconst grantIds = [];\n\t\t\t\n\t\t\tfor (const grant of (expiredGrants?.results || [])) {\n\t\t\t\tconst baseSalary = Number(grant.base_salary || 0);\n\t\t\t\tconst hourlyRate = baseSalary / 240;  // \u6708\u85AA \u00F7 240 = \u6642\u85AA\n\t\t\t\tconst hours = Number(grant.hours_remaining || 0);\n\t\t\t\tconst rate = Number(grant.original_rate || 1);\n\t\t\t\tconst amountCents = Math.round(hours * hourlyRate * rate * 100);  // \u8F49\u70BA\u5206\n\t\t\t\t\n\t\t\t\t// \u5BEB\u5165\u52A0\u73ED\u8CBB\u8A18\u9304\n\t\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\t`INSERT INTO CompensatoryOvertimePay \n\t\t\t\t\t (user_id, year_month, hours_expired, amount_cents, source_grant_ids)\n\t\t\t\t\t VALUES (?, ?, ?, ?, ?)`\n\t\t\t\t).bind(\n\t\t\t\t\tString(grant.user_id),\n\t\t\t\t\tcurrentMonth,\n\t\t\t\t\thours,\n\t\t\t\t\tamountCents,\n\t\t\t\t\tJSON.stringify([grant.grant_id])\n\t\t\t\t).run();\n\t\t\t\t\n\t\t\t\t// \u66F4\u65B0\u88DC\u4F11\u8A18\u9304\u72C0\u614B\u70BA expired\n\t\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\t`UPDATE CompensatoryLeaveGrants SET status = 'expired' WHERE grant_id = ?`\n\t\t\t\t).bind(grant.grant_id).run();\n\t\t\t\t\n\t\t\t\tgrantIds.push(grant.grant_id);\n\t\t\t\tprocessedCount++;\n\t\t\t}\n\t\t\t\n\t\t\t// \u8A18\u9304 Cron \u57F7\u884C\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`INSERT INTO CronJobExecutions \n\t\t\t\t (job_name, status, executed_at, details)\n\t\t\t\t VALUES (?, 'success', datetime('now'), ?)`\n\t\t\t).bind(jobName, JSON.stringify({ \n\t\t\t\texpiryDate, \n\t\t\t\tprocessedCount, \n\t\t\t\tgrantIds,\n\t\t\t\tcurrentMonth \n\t\t\t})).run();\n\t\t\t\n\t\t\treturn jsonResponse(200, { \n\t\t\t\tok:true, \n\t\t\t\tcode:\"SUCCESS\", \n\t\t\t\tmessage:`\u5DF2\u8655\u7406 ${processedCount} \u7B46\u5230\u671F\u88DC\u4F11`, \n\t\t\t\tdata:{ \n\t\t\t\t\tprocessedCount, \n\t\t\t\t\texpiryDate, \n\t\t\t\t\tcurrentMonth \n\t\t\t\t}, \n\t\t\t\tmeta:{ requestId } \n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\t\n\t\t\t// \u8A18\u9304\u5931\u6557\n\t\t\ttry {\n\t\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\t`INSERT INTO CronJobExecutions \n\t\t\t\t\t (job_name, status, executed_at, error_message)\n\t\t\t\t\t VALUES (?, 'failed', datetime('now'), ?)`\n\t\t\t\t).bind(jobName, String(err)).run();\n\t\t\t} catch (_) {}\n\t\t\t\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\t\n\t// Cron Job: \u67E5\u8A62\u57F7\u884C\u6B77\u53F2\n\tif (path === \"/internal/api/v1/admin/cron/history\" && method === \"GET\") {\n\t\tif (!me?.is_admin) {\n\t\t\treturn jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\ttry {\n\t\t\tconst params = url.searchParams;\n\t\t\tconst jobName = params.get('job_name') || '';\n\t\t\tconst page = Math.max(1, parseInt(params.get('page') || '1', 10));\n\t\t\tconst perPage = Math.min(100, Math.max(1, parseInt(params.get('perPage') || '20', 10)));\n\t\t\tconst offset = (page - 1) * perPage;\n\t\t\t\n\t\t\tconst whereSql = jobName ? 'WHERE job_name = ?' : '';\n\t\t\tconst binds = jobName ? [jobName] : [];\n\t\t\t\n\t\t\tconst totalRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT COUNT(1) AS total FROM CronJobExecutions ${whereSql}`\n\t\t\t).bind(...binds).first();\n\t\t\t\n\t\t\tconst rows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT execution_id, job_name, status, executed_at, details, error_message\n\t\t\t\t FROM CronJobExecutions ${whereSql}\n\t\t\t\t ORDER BY executed_at DESC LIMIT ? OFFSET ?`\n\t\t\t).bind(...binds, perPage, offset).all();\n\t\t\t\n\t\t\tconst data = (rows?.results || []).map(r => ({\n\t\t\t\tid: r.execution_id,\n\t\t\t\tjobName: r.job_name,\n\t\t\t\tstatus: r.status,\n\t\t\t\texecutedAt: r.executed_at,\n\t\t\t\tdetails: r.details ? JSON.parse(r.details) : null,\n\t\t\t\terrorMessage: r.error_message\n\t\t\t}));\n\t\t\t\n\t\t\treturn jsonResponse(200, { \n\t\t\t\tok:true, \n\t\t\t\tcode:\"OK\", \n\t\t\t\tmessage:\"\u6210\u529F\", \n\t\t\t\tdata, \n\t\t\t\tmeta:{ \n\t\t\t\t\trequestId, \n\t\t\t\t\tpage, \n\t\t\t\t\tperPage, \n\t\t\t\t\ttotal: Number(totalRow?.total || 0) \n\t\t\t\t} \n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// \u767B\u8A18\u751F\u6D3B\u4E8B\u4EF6\uFF0C\u81EA\u52D5\u6388\u4E88\u5047\u671F\n\tif (path === \"/internal/api/v1/leaves/life-events\" && method === \"POST\") {\n\t\tlet body;\n\t\ttry { body = await request.json(); } catch (_) {\n\t\t\treturn jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tconst event_type = String(body?.event_type || \"\").trim();\n\t\tconst event_date = String(body?.event_date || \"\").trim();\n\t\tconst notes = String(body?.notes || \"\").trim();\n\t\tconst user_id = body?.user_id ? String(body.user_id) : String(me.user_id);\n\t\t\n\t\t// \u6B0A\u9650\u6AA2\u67E5\uFF1A\u975E\u7BA1\u7406\u54E1\u53EA\u80FD\u70BA\u81EA\u5DF1\u767B\u8A18\n\t\tif (!me.is_admin && user_id !== String(me.user_id)) {\n\t\t\treturn jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tconst errors = [];\n\t\tif (!event_type) errors.push({ field:\"event_type\", message:\"\u8ACB\u9078\u64C7\u4E8B\u4EF6\u985E\u578B\" });\n\t\tif (!/^\\d{4}-\\d{2}-\\d{2}$/.test(event_date)) errors.push({ field:\"event_date\", message:\"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD\" });\n\t\t\n\t\t// \u5B9A\u7FA9\u5404\u7A2E\u751F\u6D3B\u4E8B\u4EF6\u7684\u5047\u671F\u898F\u5247\uFF08\u4F9D\u52DE\u57FA\u6CD5\u53CA\u6027\u5225\u5DE5\u4F5C\u5E73\u7B49\u6CD5\uFF09\n\t\tconst eventRules = {\n\t\t\tmarriage: { leave_type: 'marriage', days: 8, valid_days: 365, name: '\u5A5A\u5047', gender: null },\n\t\t\tfuneral_parent: { leave_type: 'funeral', days: 8, valid_days: 365, name: '\u55AA\u5047\uFF08\u7236\u6BCD/\u990A\u7236\u6BCD/\u7E7C\u7236\u6BCD/\u914D\u5076\u55AA\u4EA1\uFF09', gender: null },\n\t\t\tfuneral_grandparent: { leave_type: 'funeral', days: 6, valid_days: 365, name: '\u55AA\u5047\uFF08\u7956\u7236\u6BCD/\u5B50\u5973/\u914D\u5076\u4E4B\u7236\u6BCD\u55AA\u4EA1\uFF09', gender: null },\n\t\t\tfuneral_sibling: { leave_type: 'funeral', days: 3, valid_days: 365, name: '\u55AA\u5047\uFF08\u66FE\u7956\u7236\u6BCD/\u5144\u5F1F\u59CA\u59B9/\u914D\u5076\u4E4B\u7956\u7236\u6BCD\u55AA\u4EA1\uFF09', gender: null },\n\t\t\tmaternity: { leave_type: 'maternity', days: 56, valid_days: 180, name: '\u7522\u5047\uFF08\u5206\u5A29\u524D\u5F8C8\u9031\uFF09', gender: 'F' },\n\t\t\tmiscarriage: { leave_type: 'maternity', days: 28, valid_days: 180, name: '\u7522\u5047\uFF08\u598A\u5A203\u500B\u6708\u4EE5\u4E0A\u6D41\u75224\u9031\uFF09', gender: 'F' },\n\t\t\tpregnancy: { leave_type: 'prenatal_checkup', days: 7, valid_days: 365, name: '\u7522\u6AA2\u5047\uFF08\u598A\u5A20\u671F\u95937\u65E5\uFF09', gender: 'F' },\n\t\t\tpaternity: { leave_type: 'paternity', days: 7, valid_days: 60, name: '\u966A\u7522\u6AA2\u53CA\u966A\u7522\u5047\uFF08\u914D\u5076\u5206\u5A29\u6216\u61F7\u5B557\u65E5\uFF09', gender: 'M' },\n\t\t};\n\t\t\n\t\tconst rule = eventRules[event_type];\n\t\tif (!rule) {\n\t\t\terrors.push({ field:\"event_type\", message:\"\u7121\u6548\u7684\u4E8B\u4EF6\u985E\u578B\" });\n\t\t}\n\t\t\n\t\t// \u6027\u5225\u9650\u5236\u6AA2\u67E5\n\t\tif (rule && rule.gender) {\n\t\t\t// \u7372\u53D6\u76EE\u6A19\u7528\u6236\u7684\u6027\u5225\n\t\t\tconst userRow = await env.DATABASE.prepare(\n\t\t\t\t\"SELECT gender FROM Users WHERE user_id = ?\"\n\t\t\t).bind(user_id).first();\n\t\t\t\n\t\t\tconst userGender = userRow?.gender;\n\t\t\tif (userGender !== rule.gender) {\n\t\t\t\tconst genderName = rule.gender === 'F' ? '\u5973\u6027' : '\u7537\u6027';\n\t\t\t\terrors.push({ field:\"event_type\", message:`\u6B64\u4E8B\u4EF6\u985E\u578B\u50C5\u9650${genderName}` });\n\t\t\t}\n\t\t}\n\t\t\n\t\tif (errors.length) {\n\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\ttry {\n\t\t\t// \u8A08\u7B97\u6709\u6548\u671F\n\t\t\tconst eventDateObj = new Date(event_date);\n\t\t\tconst validFrom = event_date;\n\t\t\tconst validUntilObj = new Date(eventDateObj);\n\t\t\tvalidUntilObj.setDate(validUntilObj.getDate() + rule.valid_days);\n\t\t\tconst validUntil = validUntilObj.toISOString().slice(0, 10);\n\t\t\t\n\t\t\t// \u5EFA\u7ACB\u751F\u6D3B\u4E8B\u4EF6\u5047\u671F\u6388\u4E88\u8A18\u9304\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`INSERT INTO LifeEventLeaveGrants \n\t\t\t\t (user_id, event_type, event_date, leave_type, days_granted, days_used, days_remaining, \n\t\t\t\t  valid_from, valid_until, notes, status, created_by) \n\t\t\t\t VALUES (?, ?, ?, ?, ?, 0, ?, ?, ?, ?, 'active', ?)`\n\t\t\t).bind(\n\t\t\t\tuser_id, \n\t\t\t\tevent_type, \n\t\t\t\tevent_date, \n\t\t\t\trule.leave_type, \n\t\t\t\trule.days, \n\t\t\t\trule.days, \n\t\t\t\tvalidFrom, \n\t\t\t\tvalidUntil, \n\t\t\t\tnotes || null, \n\t\t\t\tString(me.user_id)\n\t\t\t).run();\n\t\t\t\n\t\t\tconst idRow = await env.DATABASE.prepare(\"SELECT last_insert_rowid() AS id\").first();\n\t\t\tconst grantId = String(idRow?.id);\n\t\t\t\n\t\t\treturn jsonResponse(201, { \n\t\t\t\tok:true, \n\t\t\t\tcode:\"CREATED\", \n\t\t\t\tmessage:`\u5DF2\u767B\u8A18${rule.name}\uFF0C\u6388\u4E88 ${rule.days} \u5929\u5047\u671F`, \n\t\t\t\tdata:{ grantId, daysGranted: rule.days, validUntil }, \n\t\t\t\tmeta:{ requestId } \n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\t\n\treturn jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\n}\n\n\n\n", "import { jsonResponse, getCorsHeadersForRequest, getCookie, hashPasswordPBKDF2 } from \"../utils.js\";\r\n\r\nexport async function handleDevSeeding(request, env, requestId, path) {\r\n\t// \u50C5\u975E prod \u53EF\u7528\r\n\tif (env.APP_ENV === \"prod\") {\r\n\t\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } });\r\n\t}\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\r\n\t// /internal/api/v1/admin/dev-debug-cookie\r\n\tif (path === \"/internal/api/v1/admin/dev-debug-cookie\") {\r\n\t\tconst cookieName = String(env.SESSION_COOKIE_NAME || \"session\");\r\n\t\tconst sid = getCookie(request, cookieName);\r\n\t\tlet exists = null; let exp = null;\r\n\t\tif (sid && env.DATABASE) {\r\n\t\t\tconst row = await env.DATABASE.prepare(\"SELECT id, expires_at FROM sessions WHERE id = ? LIMIT 1\").bind(sid).first();\r\n\t\t\texists = !!row;\r\n\t\t\texp = row?.expires_at || null;\r\n\t\t}\r\n\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data:{ cookieName, sid, exists, exp }, meta:{ requestId } }, corsHeaders);\r\n\t}\r\n\r\n\tif (request.method.toUpperCase() !== \"POST\") {\r\n\t\treturn jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n\t}\r\n\r\n\t// /internal/api/v1/admin/dev-seed-user\r\n\tif (path === \"/internal/api/v1/admin/dev-seed-user\") {\r\n\t\tlet body; try { body = await request.json(); } catch (_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n\t\tconst username = (body?.username || \"\").trim().toLowerCase();\r\n\t\tconst name = (body?.name || \"\u6E2C\u8A66\u7528\u6236\").trim();\r\n\t\tconst password = body?.password || \"changeme\";\r\n\t\tlet email = (body?.email || \"\").trim();\r\n\t\tif (!username || !password) {\r\n\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"username/password \u5FC5\u586B\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t\ttry {\r\n\t\t\tconst exists = await env.DATABASE.prepare(\"SELECT user_id FROM Users WHERE LOWER(username) = ? LIMIT 1\").bind(username).first();\r\n\t\t\tif (!email) email = `${username}@example.com`;\r\n\t\t\tconst passwordHash = await hashPasswordPBKDF2(password);\r\n\t\t\tlet userId;\r\n\t\t\tif (exists) {\r\n\t\t\t\tawait env.DATABASE.prepare(\"UPDATE Users SET username = ?, name = ?, email = ?, password_hash = ?, updated_at = ? WHERE user_id = ?\").bind(username, name, email, passwordHash, new Date().toISOString(), exists.user_id).run();\r\n\t\t\t\tuserId = exists.user_id;\r\n\t\t\t} else {\r\n\t\t\t\tawait env.DATABASE.prepare(\"INSERT INTO Users (username, password_hash, name, email, gender, start_date, created_at, updated_at) VALUES (?, ?, ?, ?, 'M', date('now'), datetime('now'), datetime('now'))\").bind(username, passwordHash, name, email).run();\r\n\t\t\t\tconst idRow = await env.DATABASE.prepare(\"SELECT last_insert_rowid() AS id\").first();\r\n\t\t\t\tuserId = idRow?.id;\r\n\t\t\t\t\r\n\t\t\t\t// \u81EA\u52D5\u70BA\u65B0\u7528\u6236\u521D\u59CB\u5316\u57FA\u672C\u5047\u671F\u4F59\u984D\r\n\t\t\t\tconst currentYear = new Date().getFullYear();\r\n\t\t\t\t// \u75C5\u5047\uFF1A30\u5929/\u5E74\r\n\t\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\t\"INSERT OR IGNORE INTO LeaveBalances (user_id, leave_type, year, total, used, remain, updated_at) VALUES (?, 'sick', ?, 30, 0, 30, datetime('now'))\"\r\n\t\t\t\t).bind(userId, currentYear).run();\r\n\t\t\t\t// \u4E8B\u5047\uFF1A14\u5929/\u5E74\r\n\t\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\t\"INSERT OR IGNORE INTO LeaveBalances (user_id, leave_type, year, total, used, remain, updated_at) VALUES (?, 'personal', ?, 14, 0, 14, datetime('now'))\"\r\n\t\t\t\t).bind(userId, currentYear).run();\r\n\t\t\t}\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u5EFA\u7ACB/\u66F4\u65B0\u6E2C\u8A66\u7528\u6236\", data:{ username, email, userId }, meta:{ requestId } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\tconst body = { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\t// /internal/api/v1/admin/dev-seed-clients\r\n\tif (path === \"/internal/api/v1/admin/dev-seed-clients\") {\r\n\t\ttry {\r\n\t\t\tawait env.DATABASE.prepare(\"INSERT OR IGNORE INTO CustomerTags(tag_id, tag_name, tag_color) VALUES (1,'\u4E00\u822C','#3b5bdb'),(2,'VIP','#ef4444')\").run();\r\n\t\t\tconst now = new Date().toISOString();\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\"INSERT OR IGNORE INTO Clients(client_id, company_name, tax_registration_number, assignee_user_id, phone, email, created_at, updated_at) VALUES \" +\r\n\t\t\t\t\"('c_001','\u661F\u6CB3\u8CC7\u8A0A\u80A1\u4EFD\u6709\u9650\u516C\u53F8','12345678',1,'02-1234-5678','contact@galaxy.com',?,?),\" +\r\n\t\t\t\t\"('c_002','\u677E\u67CF\u6709\u9650\u516C\u53F8','87654321',1,'02-8765-4321','service@pine.com',?,?),\" +\r\n\t\t\t\t\"('c_003','\u5B89\u548C\u9867\u554F\u80A1\u4EFD\u6709\u9650\u516C\u53F8','11223344',1,'02-5566-7788','info@anhe.com',?,?)\"\r\n\t\t\t).bind(now, now, now, now, now, now).run();\r\n\t\t\tawait env.DATABASE.prepare(\"INSERT OR IGNORE INTO ClientTagAssignments(client_id, tag_id) VALUES ('c_001',1),('c_001',2),('c_002',2),('c_003',1)\").run();\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u5EFA\u7ACB\u6E2C\u8A66\u5BA2\u6236/\u6A19\u7C64\", meta:{ requestId } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n\t\t\tconst body = { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body);\r\n\t\t}\r\n\t}\r\n\r\n\t// /internal/api/v1/admin/dev-seed-tasks\r\n\tif (path === \"/internal/api/v1/admin/dev-seed-tasks\") {\r\n\t\ttry {\r\n\t\t\tawait env.DATABASE.prepare(\"INSERT OR IGNORE INTO ClientServices(client_id, service_id, status) VALUES ('c_001',1,'active'),('c_002',1,'active'),('c_003',1,'active')\").run();\r\n\t\t\tconst cs1 = await env.DATABASE.prepare(\"SELECT client_service_id FROM ClientServices WHERE client_id='c_001' LIMIT 1\").first();\r\n\t\t\tconst cs2 = await env.DATABASE.prepare(\"SELECT client_service_id FROM ClientServices WHERE client_id='c_002' LIMIT 1\").first();\r\n\t\t\tconst cs3 = await env.DATABASE.prepare(\"SELECT client_service_id FROM ClientServices WHERE client_id='c_003' LIMIT 1\").first();\r\n\t\t\tconst today = new Date();\r\n\t\t\tconst fmt = (d)=> new Date(today.getTime()+d*86400000).toISOString().slice(0,10);\r\n\t\t\tawait env.DATABASE.prepare(\"INSERT INTO ActiveTasks (client_service_id, task_name, due_date, status, assignee_user_id, created_at) VALUES (?,?,?,?,?,datetime('now'))\").bind(cs1.client_service_id, '\u661F\u6CB3\u8CC7\u8A0A \u2212 12 \u6708\u8A18\u5E33', fmt(2), 'pending', 1).run();\r\n\t\t\tawait env.DATABASE.prepare(\"INSERT INTO ActiveTasks (client_service_id, task_name, due_date, status, assignee_user_id, created_at) VALUES (?,?,?,?,?,datetime('now'))\").bind(cs2.client_service_id, '\u677E\u67CF \u2212 12 \u6708\u71DF\u696D\u7A05', fmt(-1), 'in_progress', 1).run();\r\n\t\t\tawait env.DATABASE.prepare(\"INSERT INTO ActiveTasks (client_service_id, task_name, due_date, status, assignee_user_id, created_at) VALUES (?,?,?,?,?,datetime('now'))\").bind(cs3.client_service_id, '\u5B89\u548C \u2212 \u5E74\u5EA6\u7D50\u7B97', fmt(10), 'completed', 1).run();\r\n\t\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u5DF2\u5EFA\u7ACB\u6E2C\u8A66\u4EFB\u52D9\", meta: { requestId } });\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body);\r\n\t\t}\r\n\t}\r\n\r\n\t// /internal/api/v1/admin/dev-seed-timesheets\r\n\tif (path === \"/internal/api/v1/admin/dev-seed-timesheets\") {\r\n\t\ttry {\r\n\t\t\tconst today = new Date();\r\n\t\t\tconst d = (off)=> new Date(today.getTime()+off*86400000).toISOString().slice(0,10);\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\"INSERT INTO Timesheets (user_id, work_date, client_id, service_name, work_type, hours, note) VALUES \"+\r\n\t\t\t\t\"(1, ?, 'c_001', '\u8A18\u5E33', 'normal', 2.5, ''),\"+\r\n\t\t\t\t\"(1, ?, 'c_002', '\u71DF\u696D\u7A05', 'ot-weekday', 1.0, '\u52A0\u73ED'),\"+\r\n\t\t\t\t\"(1, ?, 'c_003', '\u7D50\u7B97', 'normal', 3.0, '\u6574\u7406')\"\r\n\t\t\t).bind(d(-2), d(-1), d(0)).run();\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u5EFA\u7ACB\u6E2C\u8A66\u5DE5\u6642\", meta:{ requestId } });\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } });\r\n\t\t}\r\n\t}\r\n\r\n\t// /internal/api/v1/admin/dev-seed-leaves\r\n\tif (path === \"/internal/api/v1/admin/dev-seed-leaves\") {\r\n\t\ttry {\r\n\t\t\tconst y = new Date().getFullYear();\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\"INSERT OR REPLACE INTO LeaveBalances(user_id, leave_type, year, total, used, remain, updated_at) VALUES \"+\r\n\t\t\t\t\"(1,'annual',?,30,3,27,datetime('now')),\"+\r\n\t\t\t\t\"(1,'sick',?,30,1,29,datetime('now')),\"+\r\n\t\t\t\t\"(1,'personal',?,14,0,14,datetime('now'))\"\r\n\t\t\t).bind(y, y, y).run();\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\"INSERT INTO LeaveRequests (user_id, leave_type, start_date, end_date, unit, amount, reason, status, submitted_at) VALUES \"+\r\n\t\t\t\t\"(1,'annual',date('now','-10 day'),date('now','-10 day'),'day',1,'', 'approved', datetime('now','-10 day')),\"+\r\n\t\t\t\t\"(1,'sick',date('now','-25 day'),date('now','-25 day'),'half',0.5,'\u770B\u91AB\u751F','approved', datetime('now','-25 day')),\"+\r\n\t\t\t\t\"(1,'comp',date('now','-5 day'),date('now','-5 day'),'hour',2,'\u52A0\u73ED\u88DC\u4F11','pending', datetime('now','-5 day'))\"\r\n\t\t\t).run();\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u5EFA\u7ACB\u5047\u671F\u9918\u984D\u8207\u7533\u8ACB\u8CC7\u6599\", meta:{ requestId, year:y } });\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } });\r\n\t\t}\r\n\t}\r\n\r\n\t// /internal/api/v1/admin/dev-seed-receipts\r\n\tif (path === \"/internal/api/v1/admin/dev-seed-receipts\") {\r\n\t\ttry {\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\"INSERT OR IGNORE INTO Receipts (receipt_id, client_id, receipt_date, due_date, total_amount, status, is_auto_generated, created_by) VALUES \"+\r\n\t\t\t\t\"('202510-001','c_001','2025-10-01','2025-10-31',12000,'paid',1,1),\"+\r\n\t\t\t\t\"('202510-002','c_002','2025-10-10','2025-10-30',8000,'unpaid',1,1),\"+\r\n\t\t\t\t\"('202509-003','c_003','2025-09-20','2025-10-05',5000,'unpaid',1,1)\"\r\n\t\t\t).run();\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u5EFA\u7ACB\u6E2C\u8A66\u6536\u64DA\", meta:{ requestId } });\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } });\r\n\t\t}\r\n\t}\r\n\r\n\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nexport async function handleOverhead(request, env, me, requestId, url, path) {\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\tconst method = request.method.toUpperCase();\r\n\r\n\tif (path === \"/internal/api/v1/admin/overhead-types\") {\r\n\t\tif (method === \"GET\") {\r\n\t\t\ttry {\r\n\t\t\t\tconst params = url.searchParams;\r\n\t\t\t\tconst page = Math.max(1, parseInt(params.get(\"page\") || \"1\", 10));\r\n\t\t\t\tconst perPage = Math.min(100, Math.max(1, parseInt(params.get(\"perPage\") || \"50\", 10)));\r\n\t\t\t\tconst offset = (page - 1) * perPage;\r\n\t\t\t\tconst q = (params.get(\"q\") || \"\").trim();\r\n\t\t\t\tconst category = (params.get(\"category\") || \"\").trim();\r\n\t\t\t\tconst isActive = params.get(\"is_active\");\r\n\t\t\t\tconst where = [];\r\n\t\t\t\tconst binds = [];\r\n\t\t\t\tif (q) { where.push(\"(cost_code LIKE ? OR cost_name LIKE ?)\"); binds.push(`%${q}%`, `%${q}%`); }\r\n\t\t\t\tif (category && [\"fixed\",\"variable\"].includes(category)) { where.push(\"category = ?\"); binds.push(category); }\r\n\t\t\t\tif (isActive === \"0\" || isActive === \"1\") { where.push(\"is_active = ?\"); binds.push(parseInt(isActive,10)); }\r\n\t\t\t\tconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n\t\t\t\tconst countRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM OverheadCostTypes ${whereSql}`).bind(...binds).first();\r\n\t\t\t\tconst total = Number(countRow?.total || 0);\r\n\t\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t\t`SELECT cost_type_id, cost_code, cost_name, category, allocation_method, description, is_active, display_order, created_at, updated_at\r\n\t\t\t\t\t FROM OverheadCostTypes\r\n\t\t\t\t\t ${whereSql}\r\n\t\t\t\t\t ORDER BY display_order ASC, cost_code ASC\r\n\t\t\t\t\t LIMIT ? OFFSET ?`\r\n\t\t\t\t).bind(...binds, perPage, offset).all();\r\n\t\t\t\tconst data = (rows?.results || []).map(r => ({\r\n\t\t\t\t\tid: r.cost_type_id,\r\n\t\t\t\t\tcode: r.cost_code,\r\n\t\t\t\t\tname: r.cost_name,\r\n\t\t\t\t\tcategory: r.category,\r\n\t\t\t\t\tallocationMethod: r.allocation_method,\r\n\t\t\t\t\tdescription: r.description || \"\",\r\n\t\t\t\t\tisActive: r.is_active === 1,\r\n\t\t\t\t\tdisplayOrder: Number(r.display_order || 0),\r\n\t\t\t\t\tcreatedAt: r.created_at,\r\n\t\t\t\t\tupdatedAt: r.updated_at,\r\n\t\t\t\t}));\r\n\t\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, page, perPage, total } }, corsHeaders);\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (method === \"POST\") {\r\n\t\t\tlet body; try { body = await request.json(); } catch (_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n\t\t\tconst code = String(body?.cost_code || body?.code || \"\").trim();\r\n\t\t\tconst name = String(body?.cost_name || body?.name || \"\").trim();\r\n\t\t\tconst category = String(body?.category || \"\").trim();\r\n\t\t\tconst methodVal = String(body?.allocation_method || body?.allocationMethod || \"\").trim();\r\n\t\t\tconst description = (body?.description || \"\").trim();\r\n\t\t\tconst errors = [];\r\n\t\t\tif (!/^[A-Z0-9_]{1,20}$/.test(code)) errors.push({ field:\"cost_code\", message:\"\u683C\u5F0F\u9700\u70BA A-Z0-9_\uFF0C\u226420\" });\r\n\t\t\tif (!name || name.length > 50) errors.push({ field:\"cost_name\", message:\"\u5FC5\u586B\u4E14 \u2264 50\" });\r\n\t\t\tif (![\"fixed\",\"variable\"].includes(category)) errors.push({ field:\"category\", message:\"\u4E0D\u5408\u6CD5\" });\r\n\t\t\tif (![\"per_employee\",\"per_hour\",\"per_revenue\"].includes(methodVal)) errors.push({ field:\"allocation_method\", message:\"\u4E0D\u5408\u6CD5\" });\r\n\t\t\tif (errors.length) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\r\n\t\t\ttry {\r\n\t\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\t\"INSERT INTO OverheadCostTypes (cost_code, cost_name, category, allocation_method, description, is_active) VALUES (?, ?, ?, ?, ?, 1)\"\r\n\t\t\t\t).bind(code, name, category, methodVal, description).run();\r\n\t\t\t\tconst row = await env.DATABASE.prepare(\"SELECT cost_type_id FROM OverheadCostTypes WHERE cost_code = ?\").bind(code).first();\r\n\t\t\t\treturn jsonResponse(201, { ok:true, code:\"CREATED\", message:\"\u5DF2\u5EFA\u7ACB\", data:{ id: row?.cost_type_id, code, name, category, allocationMethod: methodVal }, meta:{ requestId } }, corsHeaders);\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconst msg = String(err || \"\");\r\n\t\t\t\tif (msg.includes(\"UNIQUE\") && msg.includes(\"cost_code\")) {\r\n\t\t\t\t\treturn jsonResponse(409, { ok:false, code:\"CONFLICT\", message:\"\u4EE3\u78BC\u5DF2\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t\t}\r\n\t\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (path === \"/internal/api/v1/admin/overhead-costs\") {\r\n\t\tif (method === \"GET\") {\r\n\t\t\ttry {\r\n\t\t\t\tconst params = url.searchParams;\r\n\t\t\t\tconst year = parseInt(params.get(\"year\") || \"0\", 10);\r\n\t\t\t\tconst month = parseInt(params.get(\"month\") || \"0\", 10);\r\n\t\t\t\tif (!Number.isFinite(year) || year < 2000 || month < 1 || month > 12) {\r\n\t\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"year/month \u4E0D\u5408\u6CD5\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t\t}\r\n\t\t\t\tconst q = (params.get(\"q\") || \"\").trim();\r\n\t\t\t\tconst where = [\"m.is_deleted = 0\", \"m.year = ?\", \"m.month = ?\"];\r\n\t\t\t\tconst binds = [year, month];\r\n\t\t\t\tif (q) { where.push(\"(t.cost_code LIKE ? OR t.cost_name LIKE ? OR m.notes LIKE ?)\"); binds.push(`%${q}%`, `%${q}%`, `%${q}%`); }\r\n\t\t\t\tconst whereSql = `WHERE ${where.join(\" AND \")}`;\r\n\t\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t\t`SELECT m.overhead_id, m.cost_type_id, t.cost_name, t.cost_code, t.category, t.allocation_method, m.amount, m.notes, m.recorded_by, m.recorded_at, m.updated_at\r\n\t\t\t\t\t FROM MonthlyOverheadCosts m\r\n\t\t\t\t\t JOIN OverheadCostTypes t ON t.cost_type_id = m.cost_type_id\r\n\t\t\t\t\t ${whereSql}\r\n\t\t\t\t\t ORDER BY t.display_order ASC, t.cost_code ASC`\r\n\t\t\t\t).bind(...binds).all();\r\n\t\t\t\tconst items = (rows?.results || []).map(r => ({\r\n\t\t\t\t\tid: r.overhead_id,\r\n\t\t\t\t\tcostTypeId: r.cost_type_id,\r\n\t\t\t\t\tcostName: r.cost_name,\r\n\t\t\t\t\tcostCode: r.cost_code,\r\n\t\t\t\t\tcategory: r.category,\r\n\t\t\t\t\tallocationMethod: r.allocation_method,\r\n\t\t\t\t\tamount: Number(r.amount || 0),\r\n\t\t\t\t\tnotes: r.notes || \"\",\r\n\t\t\t\t\trecordedBy: r.recorded_by,\r\n\t\t\t\t\trecordedAt: r.recorded_at,\r\n\t\t\t\t\tupdatedAt: r.updated_at,\r\n\t\t\t\t}));\r\n\t\t\t\tconst total = items.reduce((s, x) => s + x.amount, 0);\r\n\t\t\t\tconst totalFixed = items.filter(x => x.category === 'fixed').reduce((s, x) => s + x.amount, 0);\r\n\t\t\t\tconst totalVariable = total - totalFixed;\r\n\t\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data:{ year, month, items, total, totalFixed, totalVariable }, meta:{ requestId, count: items.length } }, corsHeaders);\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (method === \"POST\") {\r\n\t\t\tlet body; try { body = await request.json(); } catch (_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n\t\t\tconst cost_type_id = parseInt(body?.cost_type_id, 10);\r\n\t\t\tconst year = parseInt(body?.year, 10);\r\n\t\t\tconst month = parseInt(body?.month, 10);\r\n\t\t\tconst amount = Number(body?.amount);\r\n\t\t\tconst notes = (body?.notes || \"\").trim();\r\n\t\t\tconst errors = [];\r\n\t\t\tif (!Number.isFinite(cost_type_id)) errors.push({ field:\"cost_type_id\", message:\"\u5FC5\u586B\" });\r\n\t\t\tif (!Number.isFinite(year) || year < 2000) errors.push({ field:\"year\", message:\"\u4E0D\u5408\u6CD5\" });\r\n\t\t\tif (!Number.isFinite(month) || month < 1 || month > 12) errors.push({ field:\"month\", message:\"\u4E0D\u5408\u6CD5\" });\r\n\t\t\tif (!Number.isFinite(amount) || amount <= 0 || amount > 1e9) errors.push({ field:\"amount\", message:\"\u9700\u4ECB\u65BC 0 ~ 1e9\" });\r\n\t\t\tif (errors.length) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\r\n\t\t\ttry {\r\n\t\t\t\tconst t = await env.DATABASE.prepare(\"SELECT cost_type_id FROM OverheadCostTypes WHERE cost_type_id = ? AND is_active = 1 LIMIT 1\").bind(cost_type_id).first();\r\n\t\t\t\tif (!t) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u6210\u672C\u9805\u76EE\u4E0D\u5B58\u5728\u6216\u672A\u555F\u7528\", errors:[{ field:\"cost_type_id\", message:\"\u4E0D\u5B58\u5728\u6216\u672A\u555F\u7528\" }], meta:{ requestId } }, corsHeaders);\r\n\t\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\t\"INSERT INTO MonthlyOverheadCosts (cost_type_id, year, month, amount, notes, recorded_by) VALUES (?, ?, ?, ?, ?, ?)\"\r\n\t\t\t\t).bind(cost_type_id, year, month, amount, notes, String(me.user_id)).run();\r\n\t\t\t\tconst idRow = await env.DATABASE.prepare(\"SELECT last_insert_rowid() AS id\").first();\r\n\t\t\t\treturn jsonResponse(201, { ok:true, code:\"CREATED\", message:\"\u5DF2\u5EFA\u7ACB\", data:{ id:String(idRow?.id) }, meta:{ requestId } }, corsHeaders);\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconst msg = String(err || \"\");\r\n\t\t\t\tif (msg.includes(\"UNIQUE\") && msg.includes(\"MonthlyOverheadCosts\")) {\r\n\t\t\t\t\treturn jsonResponse(409, { ok:false, code:\"CONFLICT\", message:\"\u8A72\u6708\u4EFD\u5DF2\u6709\u6B64\u9805\u76EE\u8A18\u9304\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t\t}\r\n\t\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (path === \"/internal/api/v1/admin/overhead-summary\" || path === \"/internal/api/v1/admin/overhead-analysis\") {\r\n\t\tif (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n\t\ttry {\r\n\t\t\tconst params = url.searchParams;\r\n\t\t\tconst year = parseInt(params.get(\"year\") || \"0\", 10);\r\n\t\t\tconst month = parseInt(params.get(\"month\") || \"0\", 10);\r\n\t\t\tif (!Number.isFinite(year) || year < 2000 || month < 1 || month > 12) {\r\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"year/month \u4E0D\u5408\u6CD5\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT t.category, t.cost_type_id, t.cost_name, SUM(m.amount) AS amt\r\n\t\t\t\t FROM MonthlyOverheadCosts m JOIN OverheadCostTypes t ON t.cost_type_id = m.cost_type_id\r\n\t\t\t\t WHERE m.is_deleted = 0 AND m.year = ? AND m.month = ?\r\n\t\t\t\t GROUP BY t.category, t.cost_type_id, t.cost_name`\r\n\t\t\t).bind(year, month).all();\r\n\t\t\tconst list = rows?.results || [];\r\n\t\t\tconst total = list.reduce((s, r) => s + Number(r.amt || 0), 0);\r\n\t\t\tconst byCategory = { fixed: 0, variable: 0 };\r\n\t\t\tfor (const r of list) { byCategory[r.category] = (byCategory[r.category] || 0) + Number(r.amt || 0); }\r\n\t\t\tconst typeBreakdown = list.map(r => ({ costTypeId: r.cost_type_id, costName: r.cost_name, amount: Number(r.amt || 0), percentage: total ? Number((Number(r.amt||0)/total*100).toFixed(1)) : 0 }));\r\n\t\t\tconst empRow = await env.DATABASE.prepare(\"SELECT COUNT(1) AS c FROM Users WHERE is_deleted = 0\").first();\r\n\t\t\tconst employeeCount = Number(empRow?.c || 0);\r\n\t\t\tconst overheadPerEmployee = employeeCount ? Math.round(total / employeeCount) : 0;\r\n\t\t\tconst data = { year, month, total_overhead: total, employee_count: employeeCount, overhead_per_employee: overheadPerEmployee, breakdown_by_category: byCategory, breakdown_by_type: typeBreakdown };\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\t// ============ \u54E1\u5DE5\u6210\u672C\u5206\u6790 ============\r\n\tif (path === \"/internal/api/v1/admin/costs/employee\") {\r\n\t\tif (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n\t\ttry {\r\n\t\t\tconst params = url.searchParams;\r\n\t\t\tconst year = parseInt(params.get(\"year\") || \"0\", 10);\r\n\t\t\tconst month = parseInt(params.get(\"month\") || \"0\", 10);\r\n\t\t\tif (!Number.isFinite(year) || year < 2000 || month < 1 || month > 12) {\r\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"year/month \u4E0D\u5408\u6CD5\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\r\n\t\t\t// 1. \u7372\u53D6\u6240\u6709\u54E1\u5DE5\r\n\t\t\tconst usersRows = await env.DATABASE.prepare(\r\n\t\t\t\t\"SELECT user_id, full_name, hire_date FROM Users WHERE is_deleted = 0 ORDER BY full_name ASC\"\r\n\t\t\t).all();\r\n\t\t\tconst users = usersRows?.results || [];\r\n\r\n\t\t\tconst employees = [];\r\n\t\t\t\r\n\t\t\tfor (const user of users) {\r\n\t\t\t\tconst userId = user.user_id;\r\n\t\t\t\t\r\n\t\t\t\t// 2. \u8A08\u7B97\u5E74\u5EA6\u7E3D\u85AA\u8CC7\uFF08\u5047\u8A2D\u5F9E\u7CFB\u7D71\u8A2D\u5B9A\u4E2D\u7372\u53D6\uFF0C\u9019\u88E1\u66AB\u6642\u4F7F\u7528\u56FA\u5B9A\u503C40000\u6708\u85AA * 12\uFF09\r\n\t\t\t\t// TODO: \u5F9E\u85AA\u8CC7\u8A2D\u5B9A\u8868\u4E2D\u7372\u53D6\u5BE6\u969B\u85AA\u8CC7\r\n\t\t\t\tconst annualSalary = 40000 * 12; // \u66AB\u6642\u56FA\u5B9A\u503C\r\n\t\t\t\t\r\n\t\t\t\t// 3. \u8A08\u7B97\u5E74\u5EA6\u7E3D\u5DE5\u6642\uFF082080\u5C0F\u6642 = 40\u5C0F\u6642/\u9031 \u00D7 52\u9031\uFF09\r\n\t\t\t\tconst annualHours = 2080;\r\n\t\t\t\t\r\n\t\t\t\t// 4. \u8A08\u7B97\u5E74\u5EA6\u7279\u4F11\u6642\u6578\r\n\t\t\t\tconst leaveBalanceRow = await env.DATABASE.prepare(\r\n\t\t\t\t\t\"SELECT annual_leave_balance FROM LeaveBalances WHERE user_id = ? AND year = ?\"\r\n\t\t\t\t).bind(userId, year).first();\r\n\t\t\t\tconst annualLeaveHours = Number(leaveBalanceRow?.annual_leave_balance || 0);\r\n\t\t\t\t\r\n\t\t\t\t// 5. \u8A08\u7B97\u5BE6\u969B\u5DE5\u6642\r\n\t\t\t\tconst actualHours = annualHours - annualLeaveHours;\r\n\t\t\t\t\r\n\t\t\t\t// 6. \u8A08\u7B97\u54E1\u5DE5\u6642\u85AA\r\n\t\t\t\tconst hourlyRate = actualHours > 0 ? annualSalary / actualHours : 0;\r\n\t\t\t\t\r\n\t\t\t\t// 7. \u7372\u53D6\u672C\u6708\u5BE6\u969B\u5DE5\u6642\u8A18\u9304\r\n\t\t\t\tconst yearMonth = `${year}-${String(month).padStart(2, '0')}`;\r\n\t\t\t\tconst timesheetRows = await env.DATABASE.prepare(\r\n\t\t\t\t\t`SELECT work_type, hours\r\n\t\t\t\t\t FROM Timesheets \r\n\t\t\t\t\t WHERE user_id = ? AND substr(work_date, 1, 7) = ? AND is_deleted = 0`\r\n\t\t\t\t).bind(userId, yearMonth).all();\r\n\t\t\t\tconst timesheets = timesheetRows?.results || [];\r\n\t\t\t\t\r\n\t\t\t\t// \u5DE5\u6642\u985E\u578B\u500D\u7387\u5C0D\u7167\u8868\r\n\t\t\t\tconst WORK_TYPE_MULTIPLIERS = {\r\n\t\t\t\t\t1: 1.0,   // \u6B63\u5E38\u5DE5\u6642\r\n\t\t\t\t\t2: 1.34,  // \u5E73\u65E5\u52A0\u73ED\uFF08\u524D2\u5C0F\u6642\uFF09\r\n\t\t\t\t\t3: 1.67,  // \u5E73\u65E5\u52A0\u73ED\uFF08\u5F8C2\u5C0F\u6642\uFF09\r\n\t\t\t\t\t4: 1.34,  // \u4F11\u606F\u65E5\u52A0\u73ED\uFF08\u524D2\u5C0F\u6642\uFF09\r\n\t\t\t\t\t5: 1.67,  // \u4F11\u606F\u65E5\u52A0\u73ED\uFF08\u7B2C3-8\u5C0F\u6642\uFF09\r\n\t\t\t\t\t6: 2.67,  // \u4F11\u606F\u65E5\u52A0\u73ED\uFF08\u7B2C9-12\u5C0F\u6642\uFF09\r\n\t\t\t\t\t7: 2.0,   // \u570B\u5B9A\u5047\u65E5\u52A0\u73ED\uFF088\u5C0F\u6642\u5167\uFF09- \u7279\u6B8A\u8655\u7406\uFF08\u5F37\u5236\u88DC\u4F11\uFF09\r\n\t\t\t\t\t8: 1.34,  // \u570B\u5B9A\u5047\u65E5\u52A0\u73ED\uFF08\u7B2C9-10\u5C0F\u6642\uFF09\r\n\t\t\t\t\t9: 1.67,  // \u570B\u5B9A\u5047\u65E5\u52A0\u73ED\uFF08\u7B2C11-12\u5C0F\u6642\uFF09\r\n\t\t\t\t\t10: 2.0,  // \u4F8B\u5047\u65E5\u52A0\u73ED\uFF088\u5C0F\u6642\u5167\uFF09- \u7279\u6B8A\u8655\u7406\uFF08\u5F37\u5236\u88DC\u4F11\uFF09\r\n\t\t\t\t\t11: 2.0   // \u4F8B\u5047\u65E5\u52A0\u73ED\uFF08\u7B2C9-12\u5C0F\u6642\uFF09\r\n\t\t\t\t};\r\n\t\t\t\t\r\n\t\t\t\t// \u5FC5\u9808\u7D66\u88DC\u4F11\u7684\u5DE5\u6642\u985E\u578B\uFF08\u9700\u8981\u96D9\u91CD\u8A08\u7B97\u6210\u672C\uFF09\r\n\t\t\t\tconst MANDATORY_COMP_LEAVE_TYPES = [7, 10]; // \u570B\u5B9A\u5047\u65E5\u548C\u4F8B\u5047\u65E58\u5C0F\u6642\u5167\r\n\t\t\t\t\r\n\t\t\t\t// 8. \u8A08\u7B97\u7E3D\u5DE5\u6642\u548C\u52A0\u6B0A\u5DE5\u6642\r\n\t\t\t\tlet monthHours = 0;\r\n\t\t\t\tlet weightedHours = 0;\r\n\t\t\t\t\r\n\t\t\t\tfor (const ts of timesheets) {\r\n\t\t\t\t\tconst hours = Number(ts.hours || 0);\r\n\t\t\t\t\tconst workTypeId = parseInt(ts.work_type) || 1;\r\n\t\t\t\t\tconst multiplier = WORK_TYPE_MULTIPLIERS[workTypeId] || 1.0;\r\n\t\t\t\t\t\r\n\t\t\t\t\tmonthHours += hours;\r\n\t\t\t\t\t\r\n\t\t\t\t\t// \u7279\u6B8A\u60C5\u6CC1\uFF1A\u570B\u5B9A\u5047\u65E5/\u4F8B\u5047\u65E5 8\u5C0F\u6642\u5167\u985E\u578B\r\n\t\t\t\t\t// \u9700\u8981\u652F\u4ED8\u52A0\u73ED\u8CBB + \u5F37\u5236\u7D66\u88DC\u4F11\uFF0C\u6240\u4EE5\u6210\u672C\u662F\u96D9\u500D\r\n\t\t\t\t\tif (MANDATORY_COMP_LEAVE_TYPES.includes(workTypeId)) {\r\n\t\t\t\t\t\t// \u52A0\u73ED\u8CBB\u6210\u672C\uFF08\u56FA\u5B9A8\u5C0F\u6642\u52A0\u6B0A\uFF09+ \u5F37\u5236\u88DC\u4F11\u6210\u672C\uFF088\u5C0F\u6642\uFF09\r\n\t\t\t\t\t\tweightedHours += 8.0 + 8.0; // = 16.0\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// \u4E00\u822C\u60C5\u6CC1\uFF1A\u5BE6\u969B\u5DE5\u6642 \u00D7 \u500D\u7387\r\n\t\t\t\t\t\tweightedHours += hours * multiplier;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t// 9. \u8A08\u7B97\u672C\u6708\u5BE6\u969B\u6210\u672C\r\n\t\t\t\t// \u6CE8\u610F\uFF1A\u4F7F\u7528\u88DC\u4F11\u4E0D\u6E1B\u5C11\u52A0\u6B0A\u5DE5\u6642\u6210\u672C\uFF0C\u56E0\u70BA\u88DC\u4F11\u662F\u7528\u4E4B\u524D\u52A0\u73ED\u7684\u6210\u672C\u62B5\u92B7\r\n\t\t\t\t// \u88DC\u4F11\u4F7F\u7528\u53EA\u5F71\u97FF\u5BE6\u969B\u5DE5\u4F5C\u6642\u6578\uFF0C\u4E0D\u5F71\u97FF\u6210\u672C\u8A08\u7B97\r\n\t\t\t\tconst laborCost = Math.round(hourlyRate * weightedHours);\r\n\t\t\t\t\r\n\t\t\t\t// 10. \u7372\u53D6\u672C\u6708\u88DC\u4F11\u5230\u671F\u8F49\u52A0\u73ED\u8CBB\uFF08\u9700\u8981\u984D\u5916\u8A08\u5165\u6210\u672C\uFF09\r\n\t\t\t\tconst expiredCompRow = await env.DATABASE.prepare(\r\n\t\t\t\t\t`SELECT SUM(amount_cents) as expired_amount \r\n\t\t\t\t\t FROM CompensatoryOvertimePay \r\n\t\t\t\t\t WHERE user_id = ? AND year_month = ?`\r\n\t\t\t\t).bind(userId, `${year}-${String(month).padStart(2, '0')}`).first();\r\n\t\t\t\tconst expiredCompCost = Math.round(Number(expiredCompRow?.expired_amount || 0) / 100);\r\n\t\t\t\t\r\n\t\t\t\t// \u6700\u7D42\u85AA\u8CC7\u6210\u672C = \u672C\u6708\u5DE5\u6642\u6210\u672C + \u88DC\u4F11\u5230\u671F\u8F49\u52A0\u73ED\u8CBB\r\n\t\t\t\tconst totalLaborCost = laborCost + expiredCompCost;\r\n\t\t\t\t\r\n\t\t\t\t// 11. \u8A08\u7B97\u5206\u6524\u7BA1\u7406\u8CBB\u7528\r\n\t\t\t\t// \u6309\u5DE5\u6642\u6BD4\u4F8B\u5206\u6524\r\n\t\t\t\tconst overheadRow = await env.DATABASE.prepare(\r\n\t\t\t\t\t`SELECT SUM(m.amount) as total FROM MonthlyOverheadCosts m\r\n\t\t\t\t\t WHERE m.year = ? AND m.month = ? AND m.is_deleted = 0`\r\n\t\t\t\t).bind(year, month).first();\r\n\t\t\t\tconst totalOverhead = Number(overheadRow?.total || 0);\r\n\t\t\t\t\r\n\t\t\t\tconst totalMonthHoursRow = await env.DATABASE.prepare(\r\n\t\t\t\t\t`SELECT SUM(hours) as total FROM Timesheets \r\n\t\t\t\t\t WHERE year = ? AND month = ? AND is_deleted = 0`\r\n\t\t\t\t).bind(year, month).first();\r\n\t\t\t\tconst totalMonthHours = Number(totalMonthHoursRow?.total || 0);\r\n\t\t\t\t\r\n\t\t\t\tconst overheadAllocation = totalMonthHours > 0 \r\n\t\t\t\t\t? Math.round(totalOverhead * (monthHours / totalMonthHours))\r\n\t\t\t\t\t: 0;\r\n\t\t\t\t\r\n\t\t\t\temployees.push({\r\n\t\t\t\t\tuserId,\r\n\t\t\t\t\tname: user.full_name,\r\n\t\t\t\t\tannualSalary,\r\n\t\t\t\t\tannualHours,\r\n\t\t\t\t\tannualLeaveHours,\r\n\t\t\t\t\tactualHours,\r\n\t\t\t\t\thourlyRate: Math.round(hourlyRate),\r\n\t\t\t\t\tmonthHours,\r\n\t\t\t\t\tweightedHours,\r\n\t\t\t\t\tlaborCost: totalLaborCost,\r\n\t\t\t\t\texpiredCompCost, // \u88DC\u4F11\u5230\u671F\u8F49\u52A0\u73ED\u8CBB\r\n\t\t\t\t\toverheadAllocation,\r\n\t\t\t\t\ttotalCost: totalLaborCost + overheadAllocation\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\treturn jsonResponse(200, { \r\n\t\t\t\tok:true, \r\n\t\t\t\tcode:\"OK\", \r\n\t\t\t\tmessage:\"\u6210\u529F\", \r\n\t\t\t\tdata:{ year, month, employees }, \r\n\t\t\t\tmeta:{ requestId, count: employees.length } \r\n\t\t\t}, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\t// ============ \u5BA2\u6236\u6210\u672C\u5F59\u7E3D ============\r\n\tif (path === \"/internal/api/v1/admin/costs/client\") {\r\n\t\tif (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n\t\ttry {\r\n\t\t\tconst params = url.searchParams;\r\n\t\t\tconst year = parseInt(params.get(\"year\") || \"0\", 10);\r\n\t\t\tconst month = parseInt(params.get(\"month\") || \"0\", 10);\r\n\t\t\tif (!Number.isFinite(year) || year < 2000 || month < 1 || month > 12) {\r\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"year/month \u4E0D\u5408\u6CD5\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\r\n\t\t\t// \u5DE5\u6642\u985E\u578B\u500D\u7387\u5C0D\u7167\u8868\r\n\t\t\tconst WORK_TYPE_MULTIPLIERS = {\r\n\t\t\t\t1: 1.0, 2: 1.34, 3: 1.67, 4: 1.34, 5: 1.67, \r\n\t\t\t\t6: 2.67, 7: 2.0, 8: 1.34, 9: 1.67, 10: 2.0, 11: 2.0\r\n\t\t\t};\r\n\r\n\t\t\t// 1. \u7372\u53D6\u6240\u6709\u5BA2\u6236\r\n\t\t\tconst clientsRows = await env.DATABASE.prepare(\r\n\t\t\t\t\"SELECT client_id, company_name FROM Clients WHERE is_deleted = 0 ORDER BY company_name ASC\"\r\n\t\t\t).all();\r\n\t\t\tconst clientsList = clientsRows?.results || [];\r\n\r\n\t\t\tconst yearMonth = `${year}-${String(month).padStart(2, '0')}`;\r\n\t\t\tconst clients = [];\r\n\r\n\t\t\tfor (const client of clientsList) {\r\n\t\t\t\tconst clientId = client.client_id;\r\n\t\t\t\t\r\n\t\t\t\t// 2. \u7372\u53D6\u8A72\u5BA2\u6236\u672C\u6708\u6240\u6709\u4EFB\u52D9\u7684\u5DE5\u6642\u8A18\u9304\uFF08\u5305\u542Bwork_type\uFF09\r\n\t\t\t\tconst timesheetRows = await env.DATABASE.prepare(\r\n\t\t\t\t\t`SELECT ts.user_id, ts.work_type, ts.hours, ts.task_id\r\n\t\t\t\t\t FROM Timesheets ts\r\n\t\t\t\t\t JOIN Tasks t ON t.task_id = ts.task_id\r\n\t\t\t\t\t WHERE t.client_id = ? AND substr(ts.work_date, 1, 7) = ? \r\n\t\t\t\t\t   AND ts.is_deleted = 0 AND t.is_deleted = 0`\r\n\t\t\t\t).bind(clientId, yearMonth).all();\r\n\t\t\t\tconst timesheets = timesheetRows?.results || [];\r\n\t\t\t\t\r\n\t\t\t\tif (timesheets.length === 0) continue;\r\n\t\t\t\t\r\n\t\t\t\tlet totalHours = 0;\r\n\t\t\t\tlet weightedHours = 0;\r\n\t\t\t\tlet laborCost = 0;\r\n\t\t\t\tconst taskCount = new Set();\r\n\t\t\t\tconst userHourlyRates = {}; // \u5FEB\u53D6\u54E1\u5DE5\u6642\u85AA\r\n\t\t\t\t\r\n\t\t\t\t// 3. \u8A08\u7B97\u6BCF\u7B46\u5DE5\u6642\u7684\u6210\u672C\r\n\t\t\t\tfor (const ts of timesheets) {\r\n\t\t\t\t\tif (!ts.user_id) continue;\r\n\t\t\t\t\ttaskCount.add(ts.task_id);\r\n\t\t\t\t\t\r\n\t\t\t\t\tconst hours = Number(ts.hours || 0);\r\n\t\t\t\t\tconst workTypeId = parseInt(ts.work_type) || 1;\r\n\t\t\t\t\tconst multiplier = WORK_TYPE_MULTIPLIERS[workTypeId] || 1.0;\r\n\t\t\t\t\t\r\n\t\t\t\t\ttotalHours += hours;\r\n\t\t\t\t\t\r\n\t\t\t\t\t// \u8A08\u7B97\u52A0\u6B0A\u5DE5\u6642\r\n\t\t\t\t\tlet tsWeightedHours;\r\n\t\t\t\t\tif (MANDATORY_COMP_LEAVE_TYPES.includes(workTypeId)) {\r\n\t\t\t\t\t\t// \u7279\u6B8A\u60C5\u6CC1\uFF1A\u570B\u5B9A\u5047\u65E5/\u4F8B\u5047\u65E5 8\u5C0F\u6642\u5167\uFF08\u5F37\u5236\u88DC\u4F11\uFF09\r\n\t\t\t\t\t\t// \u6210\u672C = \u52A0\u73ED\u8CBB + \u5F37\u5236\u88DC\u4F11\r\n\t\t\t\t\t\ttsWeightedHours = 8.0 + 8.0; // = 16.0\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\ttsWeightedHours = hours * multiplier;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tweightedHours += tsWeightedHours;\r\n\t\t\t\t\t\r\n\t\t\t\t\t// \u7372\u53D6\u6216\u8A08\u7B97\u54E1\u5DE5\u6642\u85AA\r\n\t\t\t\t\tif (!userHourlyRates[ts.user_id]) {\r\n\t\t\t\t\t\t// \u7C21\u5316\u8A08\u7B97\uFF1A\u4F7F\u7528\u56FA\u5B9A\u6642\u85AA\r\n\t\t\t\t\t\t// TODO: \u5F9E\u54E1\u5DE5\u6210\u672C\u5206\u6790\u7372\u53D6\u5BE6\u969B\u6642\u85AA\uFF08\u8003\u616E\u5E74\u85AA\u548C\u7279\u4F11\uFF09\r\n\t\t\t\t\t\tuserHourlyRates[ts.user_id] = 200;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tlaborCost += Math.round(userHourlyRates[ts.user_id] * tsWeightedHours);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t// 4. \u8A08\u7B97\u5206\u6524\u7BA1\u7406\u8CBB\u7528\uFF08\u6309\u5DE5\u6642\u6BD4\u4F8B\uFF09\r\n\t\t\t\tconst overheadRow = await env.DATABASE.prepare(\r\n\t\t\t\t\t`SELECT SUM(m.amount) as total FROM MonthlyOverheadCosts m\r\n\t\t\t\t\t WHERE m.year = ? AND m.month = ? AND m.is_deleted = 0`\r\n\t\t\t\t).bind(year, month).first();\r\n\t\t\t\tconst totalOverhead = Number(overheadRow?.total || 0);\r\n\t\t\t\t\r\n\t\t\t\tconst totalMonthHoursRow = await env.DATABASE.prepare(\r\n\t\t\t\t\t`SELECT SUM(hours) as total FROM Timesheets \r\n\t\t\t\t\t WHERE year = ? AND month = ? AND is_deleted = 0`\r\n\t\t\t\t).bind(year, month).first();\r\n\t\t\t\tconst totalMonthHours = Number(totalMonthHoursRow?.total || 0);\r\n\t\t\t\t\r\n\t\t\t\tconst overheadAllocation = totalMonthHours > 0 \r\n\t\t\t\t\t? Math.round(totalOverhead * (totalHours / totalMonthHours))\r\n\t\t\t\t\t: 0;\r\n\t\t\t\t\r\n\t\t\t\t// 5. \u7372\u53D6\u672C\u6708\u6536\u5165\uFF08\u5F9E\u6536\u64DA\u7CFB\u7D71\uFF09\r\n\t\t\t\tconst revenueRow = await env.DATABASE.prepare(\r\n\t\t\t\t\t`SELECT SUM(amount_cents) as total FROM Receipts \r\n\t\t\t\t\t WHERE client_id = ? AND year = ? AND month = ? AND is_deleted = 0`\r\n\t\t\t\t).bind(clientId, year, month).first();\r\n\t\t\t\tconst revenue = Math.round(Number(revenueRow?.total || 0) / 100);\r\n\t\t\t\t\r\n\t\t\t\tif (totalHours > 0 || revenue > 0) {\r\n\t\t\t\t\tclients.push({\r\n\t\t\t\t\t\tclientId,\r\n\t\t\t\t\t\tclientName: client.company_name,\r\n\t\t\t\t\t\ttaskCount: taskCount.size,\r\n\t\t\t\t\t\ttotalHours,\r\n\t\t\t\t\t\tweightedHours,\r\n\t\t\t\t\t\tlaborCost,\r\n\t\t\t\t\t\toverheadAllocation,\r\n\t\t\t\t\t\ttotalCost: laborCost + overheadAllocation,\r\n\t\t\t\t\t\trevenue\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn jsonResponse(200, { \r\n\t\t\t\tok:true, \r\n\t\t\t\tcode:\"OK\", \r\n\t\t\t\tmessage:\"\u6210\u529F\", \r\n\t\t\t\tdata:{ year, month, clients }, \r\n\t\t\t\tmeta:{ requestId, count: clients.length } \r\n\t\t\t}, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\t// ============ \u4EFB\u52D9\u6210\u672C\u660E\u7D30 ============\r\n\tif (path === \"/internal/api/v1/admin/costs/task\") {\r\n\t\tif (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n\t\ttry {\r\n\t\t\tconst params = url.searchParams;\r\n\t\t\tconst year = parseInt(params.get(\"year\") || \"0\", 10);\r\n\t\t\tconst month = parseInt(params.get(\"month\") || \"0\", 10);\r\n\t\t\tif (!Number.isFinite(year) || year < 2000 || month < 1 || month > 12) {\r\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"year/month \u4E0D\u5408\u6CD5\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\r\n\t\t\t// \u5DE5\u6642\u985E\u578B\u500D\u7387\u5C0D\u7167\u8868\r\n\t\t\tconst WORK_TYPE_MULTIPLIERS = {\r\n\t\t\t\t1: 1.0, 2: 1.34, 3: 1.67, 4: 1.34, 5: 1.67, \r\n\t\t\t\t6: 2.67, 7: 2.0, 8: 1.34, 9: 1.67, 10: 2.0, 11: 2.0\r\n\t\t\t};\r\n\t\t\t\r\n\t\t\t// \u5FC5\u9808\u7D66\u88DC\u4F11\u7684\u5DE5\u6642\u985E\u578B\r\n\t\t\tconst MANDATORY_COMP_LEAVE_TYPES = [7, 10];\r\n\r\n\t\t\tconst yearMonth = `${year}-${String(month).padStart(2, '0')}`;\r\n\t\t\t\r\n\t\t\t// 1. \u7372\u53D6\u6240\u6709\u6709\u5DE5\u6642\u8A18\u9304\u7684\u4EFB\u52D9\r\n\t\t\tconst taskRows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT DISTINCT\r\n\t\t\t\t\tt.task_id, \r\n\t\t\t\t\tt.title, \r\n\t\t\t\t\tt.client_id,\r\n\t\t\t\t\tc.company_name,\r\n\t\t\t\t\tt.assigned_to,\r\n\t\t\t\t\tu.full_name as assignee_name\r\n\t\t\t\t FROM Tasks t\r\n\t\t\t\t JOIN Clients c ON c.client_id = t.client_id\r\n\t\t\t\t LEFT JOIN Users u ON u.user_id = t.assigned_to\r\n\t\t\t\t JOIN Timesheets ts ON ts.task_id = t.task_id AND substr(ts.work_date, 1, 7) = ? AND ts.is_deleted = 0\r\n\t\t\t\t WHERE t.is_deleted = 0 AND c.is_deleted = 0\r\n\t\t\t\t ORDER BY c.company_name ASC, t.title ASC`\r\n\t\t\t).bind(yearMonth).all();\r\n\t\t\tconst taskList = taskRows?.results || [];\r\n\r\n\t\t\t// 2. \u7372\u53D6\u7E3D\u5DE5\u6642\u548C\u7E3D\u7BA1\u7406\u8CBB\u7528\u7528\u65BC\u5206\u6524\r\n\t\t\tconst totalHoursRow = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT SUM(hours) as total FROM Timesheets \r\n\t\t\t\t WHERE substr(work_date, 1, 7) = ? AND is_deleted = 0`\r\n\t\t\t).bind(yearMonth).first();\r\n\t\t\tconst totalMonthHours = Number(totalHoursRow?.total || 0);\r\n\t\t\t\r\n\t\t\tconst overheadRow = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT SUM(m.amount) as total FROM MonthlyOverheadCosts m\r\n\t\t\t\t WHERE m.year = ? AND m.month = ? AND m.is_deleted = 0`\r\n\t\t\t).bind(year, month).first();\r\n\t\t\tconst totalOverhead = Number(overheadRow?.total || 0);\r\n\r\n\t\t\tconst tasks = [];\r\n\t\t\t\r\n\t\t\t// 3. \u70BA\u6BCF\u500B\u4EFB\u52D9\u8A08\u7B97\u6210\u672C\r\n\t\t\tfor (const task of taskList) {\r\n\t\t\t\t// \u7372\u53D6\u8A72\u4EFB\u52D9\u7684\u6240\u6709\u5DE5\u6642\u8A18\u9304\r\n\t\t\t\tconst timesheetRows = await env.DATABASE.prepare(\r\n\t\t\t\t\t`SELECT work_type, hours\r\n\t\t\t\t\t FROM Timesheets \r\n\t\t\t\t\t WHERE task_id = ? AND substr(work_date, 1, 7) = ? AND is_deleted = 0`\r\n\t\t\t\t).bind(task.task_id, yearMonth).all();\r\n\t\t\t\tconst timesheets = timesheetRows?.results || [];\r\n\t\t\t\t\r\n\t\t\t\tlet hours = 0;\r\n\t\t\t\tlet weightedHours = 0;\r\n\t\t\t\t\r\n\t\t\t\tfor (const ts of timesheets) {\r\n\t\t\t\t\tconst tsHours = Number(ts.hours || 0);\r\n\t\t\t\t\tconst workTypeId = parseInt(ts.work_type) || 1;\r\n\t\t\t\t\tconst multiplier = WORK_TYPE_MULTIPLIERS[workTypeId] || 1.0;\r\n\t\t\t\t\t\r\n\t\t\t\t\thours += tsHours;\r\n\t\t\t\t\t\r\n\t\t\t\t\t// \u8A08\u7B97\u52A0\u6B0A\u5DE5\u6642\r\n\t\t\t\t\tif (MANDATORY_COMP_LEAVE_TYPES.includes(workTypeId)) {\r\n\t\t\t\t\t\t// \u570B\u5B9A\u5047\u65E5/\u4F8B\u5047\u65E58\u5C0F\u6642\u5167\uFF1A\u52A0\u73ED\u8CBB + \u5F37\u5236\u88DC\u4F11\r\n\t\t\t\t\t\tweightedHours += 8.0 + 8.0; // = 16.0\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tweightedHours += tsHours * multiplier;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t// \u7C21\u5316\u8A08\u7B97\uFF1A\u4F7F\u7528\u56FA\u5B9A\u6642\u85AA\r\n\t\t\t\tconst hourlyRate = 200; // TODO: \u5F9E\u54E1\u5DE5\u6210\u672C\u5206\u6790\u7372\u53D6\u5BE6\u969B\u6642\u85AA\r\n\t\t\t\tconst laborCost = Math.round(hourlyRate * weightedHours);\r\n\t\t\t\t\r\n\t\t\t\t// \u6309\u5DE5\u6642\u6BD4\u4F8B\u5206\u6524\u7BA1\u7406\u8CBB\u7528\r\n\t\t\t\tconst overheadAllocation = totalMonthHours > 0 \r\n\t\t\t\t\t? Math.round(totalOverhead * (hours / totalMonthHours))\r\n\t\t\t\t\t: 0;\r\n\t\t\t\t\r\n\t\t\t\ttasks.push({\r\n\t\t\t\t\ttaskId: task.task_id,\r\n\t\t\t\t\ttaskTitle: task.title,\r\n\t\t\t\t\tclientId: task.client_id,\r\n\t\t\t\t\tclientName: task.company_name,\r\n\t\t\t\t\tassigneeId: task.assigned_to,\r\n\t\t\t\t\tassigneeName: task.assignee_name || '\u672A\u6307\u6D3E',\r\n\t\t\t\t\thours,\r\n\t\t\t\t\tweightedHours,\r\n\t\t\t\t\tlaborCost,\r\n\t\t\t\t\toverheadAllocation,\r\n\t\t\t\t\ttotalCost: laborCost + overheadAllocation\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\treturn jsonResponse(200, { \r\n\t\t\t\tok:true, \r\n\t\t\t\tcode:\"OK\", \r\n\t\t\t\tmessage:\"\u6210\u529F\", \r\n\t\t\t\tdata:{ year, month, tasks }, \r\n\t\t\t\tmeta:{ requestId, count: tasks.length } \r\n\t\t\t}, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\n\nexport async function handleReports(request, env, me, requestId, url, path) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\tconst method = request.method.toUpperCase();\n\n\tconst parseDate = (s) => {\n\t\tif (!s || typeof s !== \"string\") return null;\n\t\tconst m = s.match(/^\\d{4}-\\d{2}-\\d{2}$/);\n\t\tif (!m) return null;\n\t\tconst d = new Date(s);\n\t\treturn Number.isNaN(d.getTime()) ? null : s; // keep original yyyy-mm-dd\n\t};\n\n\tconst parseYearMonth = (s) => {\n\t\tif (!s || typeof s !== \"string\") return null;\n\t\tconst m = s.match(/^(\\d{4})-(\\d{2})$/);\n\t\tif (!m) return null;\n\t\tconst y = parseInt(m[1], 10);\n\t\tconst mo = parseInt(m[2], 10);\n\t\tif (!Number.isFinite(y) || !Number.isFinite(mo) || mo < 1 || mo > 12) return null;\n\t\treturn { year: y, month: mo };\n\t};\n\n\t// /internal/api/v1/reports/client-cost-analysis (GET, admin only)\n\tif (path === \"/internal/api/v1/reports/client-cost-analysis\") {\n\t\tif (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\n\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\n\t\ttry {\n\t\t\tconst p = url.searchParams;\n\t\t\tconst start = parseDate(p.get(\"start_date\"));\n\t\t\tconst end = parseDate(p.get(\"end_date\"));\n\t\t\tconst clientId = (p.get(\"client_id\") || \"\").trim() || null;\n\t\t\tconst includeBonus = (p.get(\"include_year_end_bonus\") || \"\").toLowerCase() === \"true\";\n\t\t\tif (!start || !end || start > end) {\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8ACB\u9078\u64C7\u6709\u6548\u65E5\u671F\u5340\u9593\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\n\t\t\t// \u5DE5\u6642\u500D\u7387\u5C0D\u7167\u8868\uFF08\u6839\u64DA\u52DE\u57FA\u6CD5\uFF09\n\t\t\tconst workTypeMultipliers = {\n\t\t\t\t'normal': 1.0,\n\t\t\t\t'ot-weekday': 1.34,\n\t\t\t\t'ot-rest': 1.67,\n\t\t\t\t'holiday': 2.0\n\t\t\t};\n\n\t\t\t// \u7372\u53D6\u6BCF\u500B\u5BA2\u6236\u6BCF\u500B\u54E1\u5DE5\u7684\u5DE5\u6642\u660E\u7D30\uFF08\u6309 work_type\uFF09\n\t\t\tconst binds = [start, end];\n\t\t\tlet where = \"t.is_deleted = 0 AND t.work_date >= ? AND t.work_date <= ?\";\n\t\t\tif (clientId) { where += \" AND t.client_id = ?\"; binds.push(clientId); }\n\t\t\tconst hoursRows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT t.client_id, t.user_id, t.work_type, SUM(t.hours) AS hours\n\t\t\t\t FROM Timesheets t\n\t\t\t\t WHERE ${where}\n\t\t\t\t GROUP BY t.client_id, t.user_id, t.work_type`\n\t\t\t).bind(...binds).all();\n\t\t\t\n\t\t\t// \u6309\u5BA2\u6236\u548C\u54E1\u5DE5\u7D44\u7E54\u6578\u64DA\n\t\t\tconst clientUserHours = new Map(); // Map<client_id, Map<user_id, {actual, weighted, byType}>>\n\t\t\tconst allUserIds = new Set();\n\t\t\tconst allClientIds = new Set();\n\t\t\t\n\t\t\tfor (const r of (hoursRows?.results || [])) {\n\t\t\t\tif (!r.client_id) continue;\n\t\t\t\tallClientIds.add(r.client_id);\n\t\t\t\tallUserIds.add(r.user_id);\n\t\t\t\t\n\t\t\t\tif (!clientUserHours.has(r.client_id)) {\n\t\t\t\t\tclientUserHours.set(r.client_id, new Map());\n\t\t\t\t}\n\t\t\t\tconst userMap = clientUserHours.get(r.client_id);\n\t\t\t\tif (!userMap.has(r.user_id)) {\n\t\t\t\t\tuserMap.set(r.user_id, { actual: 0, weighted: 0, byType: {} });\n\t\t\t\t}\n\t\t\t\tconst userData = userMap.get(r.user_id);\n\t\t\t\tconst hours = Number(r.hours || 0);\n\t\t\t\tconst multiplier = workTypeMultipliers[r.work_type] || 1.0;\n\t\t\t\tuserData.actual += hours;\n\t\t\t\tuserData.weighted += hours * multiplier;\n\t\t\t\tuserData.byType[r.work_type] = hours;\n\t\t\t}\n\n\t\t\t// \u7372\u53D6\u6240\u6709\u6D89\u53CA\u7528\u6236\u7684\u85AA\u8CC7\u4FE1\u606F\n\t\t\tconst userSalaries = new Map();\n\t\t\tif (allUserIds.size > 0) {\n\t\t\t\tconst userIdArray = Array.from(allUserIds);\n\t\t\t\tconst placeholders = userIdArray.map(() => \"?\").join(\",\");\n\t\t\t\tconst salaryRows = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT user_id, username, COALESCE(base_salary, 40000) AS base_salary, \n\t\t\t\t\t COALESCE(regular_allowance, 0) AS regular_allowance\n\t\t\t\t\t FROM Users WHERE user_id IN (${placeholders})`\n\t\t\t\t).bind(...userIdArray).all();\n\t\t\t\tfor (const r of (salaryRows?.results || [])) {\n\t\t\t\t\tconst baseSalary = Number(r.base_salary || 40000);\n\t\t\t\t\tconst allowance = Number(r.regular_allowance || 0);\n\t\t\t\t\tconst salaryHourlyRate = (baseSalary + allowance) / 240;\n\t\t\t\t\tuserSalaries.set(r.user_id, {\n\t\t\t\t\t\tusername: r.username,\n\t\t\t\t\t\tbase_salary: baseSalary,\n\t\t\t\t\t\tregular_allowance: allowance,\n\t\t\t\t\t\tsalary_rate: Number(salaryHourlyRate.toFixed(2))\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// \u8A08\u7B97\u7BA1\u7406\u6210\u672C\u7387\uFF08\u6BCF\u5C0F\u6642\uFF09\n\t\t\tconst startYm = parseInt(start.slice(0,4) + start.slice(5,7), 10);\n\t\t\tconst endYm = parseInt(end.slice(0,4) + end.slice(5,7), 10);\n\t\t\tconst ohRows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT (year*100+month) AS ym, SUM(amount) AS amt\n\t\t\t\t FROM MonthlyOverheadCosts\n\t\t\t\t WHERE is_deleted = 0 AND (year*100+month) >= ? AND (year*100+month) <= ?\n\t\t\t\t GROUP BY ym`\n\t\t\t).bind(startYm, endYm).all();\n\t\t\tconst totalOverhead = (ohRows?.results || []).reduce((s, r) => s + Number(r.amt || 0), 0);\n\t\t\t\n\t\t\t// \u8A08\u7B97\u7E3D\u5DE5\u6642\u4EE5\u5F97\u51FA\u6BCF\u5C0F\u6642\u7BA1\u7406\u6210\u672C\n\t\t\tconst totalActualHours = Array.from(clientUserHours.values())\n\t\t\t\t.reduce((sum, userMap) => {\n\t\t\t\t\treturn sum + Array.from(userMap.values()).reduce((s, u) => s + u.actual, 0);\n\t\t\t\t}, 0);\n\t\t\tconst overheadPerHour = totalActualHours > 0 ? totalOverhead / totalActualHours : 0;\n\n\t\t\tconst warnings = [];\n\t\t\tif (totalOverhead <= 0) warnings.push({ type: \"overhead_missing\", message: \"\u672C\u671F\u9593\u7BA1\u7406\u6210\u672C\u672A\u8F38\u5165\" });\n\n\t\t\t// \u71DF\u6536\uFF08Receipts\uFF1A\u6392\u9664 cancelled\uFF09\n\t\t\tconst recBinds = [start, end];\n\t\t\tlet recWhere = \"is_deleted = 0 AND status != 'cancelled' AND receipt_date >= ? AND receipt_date <= ?\";\n\t\t\tif (clientId) { recWhere += \" AND client_id = ?\"; recBinds.push(clientId); }\n\t\t\tconst recRows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT client_id, SUM(total_amount) AS total_receipts\n\t\t\t\t FROM Receipts\n\t\t\t\t WHERE ${recWhere}\n\t\t\t\t GROUP BY client_id`\n\t\t\t).bind(...recBinds).all();\n\t\t\tconst revenueByClient = new Map();\n\t\t\tfor (const r of (recRows?.results || [])) {\n\t\t\t\trevenueByClient.set(r.client_id, Number(r.total_receipts || 0));\n\t\t\t\tallClientIds.add(r.client_id);\n\t\t\t}\n\n\t\t\t// \u53D6\u516C\u53F8\u540D\u7A31\n\t\t\tconst nameMap = new Map();\n\t\t\tif (allClientIds.size > 0) {\n\t\t\t\tconst clientIdArray = Array.from(allClientIds);\n\t\t\t\tconst placeholders = clientIdArray.map(() => \"?\").join(\",\");\n\t\t\t\tconst nameRows = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT client_id, company_name FROM Clients WHERE client_id IN (${placeholders})`\n\t\t\t\t).bind(...clientIdArray).all();\n\t\t\t\tfor (const r of (nameRows?.results || [])) nameMap.set(r.client_id, r.company_name);\n\t\t\t}\n\n\t\t\t// \u7D44\u88DD\u7D50\u679C\n\t\t\tconst data = [];\n\t\t\tfor (const cid of allClientIds) {\n\t\t\t\tconst userMap = clientUserHours.get(cid) || new Map();\n\t\t\t\tlet totalActual = 0;\n\t\t\t\tlet totalWeighted = 0;\n\t\t\t\tlet totalSalaryCost = 0;\n\t\t\t\tlet totalOverheadCost = 0;\n\t\t\t\tconst userBreakdown = [];\n\n\t\t\t\tfor (const [uid, userData] of userMap.entries()) {\n\t\t\t\t\tconst userInfo = userSalaries.get(uid) || { username: `User${uid}`, salary_rate: 167 };\n\t\t\t\t\tconst actual = userData.actual;\n\t\t\t\t\tconst weighted = userData.weighted;\n\t\t\t\t\tconst overheadRate = Number(overheadPerHour.toFixed(2));\n\t\t\t\t\tconst hourlyCostRate = userInfo.salary_rate + overheadRate;\n\t\t\t\t\t\n\t\t\t\t\t// \u6210\u672C\u8A08\u7B97\uFF1A\u4F7F\u7528\u52A0\u6B0A\u5DE5\u6642 \u00D7 \u85AA\u8CC7\u6642\u85AA + \u5BE6\u969B\u5DE5\u6642 \u00D7 \u7BA1\u7406\u6210\u672C\u6642\u85AA\n\t\t\t\t\tconst salaryCost = Math.round(weighted * userInfo.salary_rate);\n\t\t\t\t\tconst overheadCost = Math.round(actual * overheadRate);\n\t\t\t\t\tconst userTotalCost = salaryCost + overheadCost;\n\t\t\t\t\t\n\t\t\t\t\ttotalActual += actual;\n\t\t\t\t\ttotalWeighted += weighted;\n\t\t\t\t\ttotalSalaryCost += salaryCost;\n\t\t\t\t\ttotalOverheadCost += overheadCost;\n\n\t\t\t\t\tuserBreakdown.push({\n\t\t\t\t\t\tuser_id: uid,\n\t\t\t\t\t\tusername: userInfo.username,\n\t\t\t\t\t\tactual_hours: Number(actual.toFixed(2)),\n\t\t\t\t\t\tweighted_hours: Number(weighted.toFixed(2)),\n\t\t\t\t\t\thourly_cost_rate: Number(hourlyCostRate.toFixed(2)),\n\t\t\t\t\t\tsalary_rate: userInfo.salary_rate,\n\t\t\t\t\t\toverhead_rate: overheadRate,\n\t\t\t\t\t\ttotal_cost: userTotalCost,\n\t\t\t\t\t\tsalary_cost: salaryCost,\n\t\t\t\t\t\toverhead_cost: overheadCost,\n\t\t\t\t\t\tyear_end_bonus_allocated: 0, // \u66AB\u6642\u672A\u5BE6\u73FE\u5E74\u7D42\u5206\u6524\n\t\t\t\t\t\tyear_end_bonus_ratio: 0\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tconst revenue = revenueByClient.get(cid) || 0;\n\t\t\t\tconst totalCost = totalSalaryCost + totalOverheadCost;\n\t\t\t\tconst grossProfit = revenue - totalCost;\n\t\t\t\tconst margin = revenue > 0 ? Number(((grossProfit / revenue) * 100).toFixed(1)) : 0;\n\n\t\t\t\tdata.push({\n\t\t\t\t\tclient_id: cid,\n\t\t\t\t\tcompany_name: nameMap.get(cid) || cid,\n\t\t\t\t\ttotal_actual_hours: Number(totalActual.toFixed(2)),\n\t\t\t\t\ttotal_weighted_hours: Number(totalWeighted.toFixed(2)),\n\t\t\t\t\tcost_breakdown: {\n\t\t\t\t\t\tsalary_cost: totalSalaryCost,\n\t\t\t\t\t\toverhead_cost: totalOverheadCost,\n\t\t\t\t\t\tyear_end_bonus: 0,\n\t\t\t\t\t\ttotal_cost: totalCost,\n\t\t\t\t\t},\n\t\t\t\t\tlabor_cost: totalCost,\n\t\t\t\t\trevenue,\n\t\t\t\t\tgross_profit: grossProfit,\n\t\t\t\t\tprofit_margin: margin,\n\t\t\t\t\tcost_percentage: totalCost > 0 ? { \n\t\t\t\t\t\tsalary: Number(((totalSalaryCost/totalCost)*100).toFixed(1)), \n\t\t\t\t\t\toverhead: Number(((totalOverheadCost/totalCost)*100).toFixed(1)) \n\t\t\t\t\t} : { salary: 0, overhead: 0 },\n\t\t\t\t\tuser_breakdown: userBreakdown,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\t// \u6309\u6BDB\u5229\u7387\u6392\u5E8F\n\t\t\tdata.sort((a, b) => b.profit_margin - a.profit_margin);\n\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, warnings, meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// /internal/api/v1/reports/employee-hours (GET)\n\tif (path === \"/internal/api/v1/reports/employee-hours\") {\n\t\tif (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\n\t\ttry {\n\t\t\tconst p = url.searchParams;\n\t\t\tconst y = parseInt(p.get(\"year\") || \"0\", 10);\n\t\t\tconst m = parseInt(p.get(\"month\") || \"0\", 10);\n\t\t\tlet qUserId = p.get(\"user_id\");\n\t\t\tif (!Number.isFinite(y) || y < 2000 || !Number.isFinite(m) || m < 1 || m > 12) {\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8ACB\u9078\u64C7\u67E5\u8A62\u6708\u4EFD\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t// \u6B0A\u9650\uFF1A\u54E1\u5DE5\u50C5\u80FD\u770B\u81EA\u5DF1\n\t\t\tlet userFilterId = null;\n\t\t\tif (!me.is_admin) userFilterId = String(me.user_id);\n\t\t\telse if (qUserId) userFilterId = String(parseInt(qUserId, 10));\n\n\t\t\tconst ym = `${y}-${String(m).padStart(2,'0')}`;\n\t\t\tconst whereBase = \"t.is_deleted = 0 AND substr(t.work_date,1,7) = ?\";\n\t\t\tlet where = whereBase;\n\t\t\tconst binds = [ym];\n\t\t\tif (userFilterId) { where += \" AND t.user_id = ?\"; binds.push(userFilterId); }\n\n\t\t\t// \u5F59\u7E3D\uFF08\u6BCF\u4EBA\uFF09- \u5340\u5206\u53EF\u8A08\u8CBB/\u975E\u8A08\u8CBB\u5DE5\u6642\n\t\t\tconst aggRows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT t.user_id, \n\t\t\t\t\tSUM(t.hours) AS total_hours,\n\t\t\t\t\tSUM(CASE WHEN t.work_type = 'normal' THEN t.hours ELSE 0 END) AS normal_hours,\n\t\t\t\t\tSUM(CASE WHEN t.work_type LIKE 'ot-%' OR t.work_type = 'holiday' THEN t.hours ELSE 0 END) AS overtime_hours,\n\t\t\t\t\tSUM(CASE WHEN t.client_id IS NOT NULL THEN t.hours ELSE 0 END) AS billable_hours,\n\t\t\t\t\tSUM(CASE WHEN t.client_id IS NULL THEN t.hours ELSE 0 END) AS non_billable_hours\n\t\t\t\t FROM Timesheets t\n\t\t\t\t WHERE ${where}\n\t\t\t\t GROUP BY t.user_id`\n\t\t\t).bind(...binds).all();\n\n\t\t\t// \u6BCF\u65E5\u5DE5\u6642\n\t\t\tconst dailyRows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT t.user_id, t.work_date, SUM(t.hours) AS hours\n\t\t\t\t FROM Timesheets t\n\t\t\t\t WHERE ${where}\n\t\t\t\t GROUP BY t.user_id, t.work_date\n\t\t\t\t ORDER BY t.work_date ASC`\n\t\t\t).bind(...binds).all();\n\n\t\t\t// \u5BA2\u6236\u5206\u5E03\n\t\t\tconst distRows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT t.user_id, t.client_id, SUM(t.hours) AS hours\n\t\t\t\t FROM Timesheets t\n\t\t\t\t WHERE ${where} AND t.client_id IS NOT NULL\n\t\t\t\t GROUP BY t.user_id, t.client_id`\n\t\t\t).bind(...binds).all();\n\n\t\t\t// \u4F7F\u7528\u8005\u540D\u7A31\n\t\t\tconst userIds = (aggRows?.results || []).map(r => r.user_id);\n\t\t\tlet usersMap = new Map();\n\t\t\tif (userIds.length) {\n\t\t\t\tconst placeholders = userIds.map(()=>\"?\").join(\",\");\n\t\t\t\tconst uRows = await env.DATABASE.prepare(`SELECT user_id, username FROM Users WHERE user_id IN (${placeholders})`).bind(...userIds).all();\n\t\t\t\tusersMap = new Map((uRows?.results || []).map(r => [String(r.user_id), r.username]));\n\t\t\t}\n\n\t\t\t// \u5BA2\u6236\u540D\u7A31\n\t\t\tconst clientIds = Array.from(new Set((distRows?.results || []).map(r => r.client_id).filter(Boolean)));\n\t\t\tlet clientMap = new Map();\n\t\t\tif (clientIds.length) {\n\t\t\t\tconst placeholders = clientIds.map(()=>\"?\").join(\",\");\n\t\t\t\tconst cRows = await env.DATABASE.prepare(`SELECT client_id, company_name FROM Clients WHERE client_id IN (${placeholders})`).bind(...clientIds).all();\n\t\t\t\tclientMap = new Map((cRows?.results || []).map(r => [r.client_id, r.company_name]));\n\t\t\t}\n\n\t\t\tconst dailyByUser = new Map();\n\t\t\tfor (const r of (dailyRows?.results || [])) {\n\t\t\t\tconst arr = dailyByUser.get(String(r.user_id)) || [];\n\t\t\t\tarr.push({ date: r.work_date, hours: Number(r.hours || 0) });\n\t\t\t\tdailyByUser.set(String(r.user_id), arr);\n\t\t\t}\n\n\t\t\tconst distByUser = new Map();\n\t\t\tfor (const r of (distRows?.results || [])) {\n\t\t\t\tconst arr = distByUser.get(String(r.user_id)) || [];\n\t\t\t\tconst hours = Number(r.hours || 0);\n\t\t\t\tarr.push({ client_id: r.client_id, company_name: clientMap.get(r.client_id) || r.client_id, hours });\n\t\t\t\tdistByUser.set(String(r.user_id), arr);\n\t\t\t}\n\n\t\t\t// \u8A08\u7B97\u5DE5\u4F5C\u5929\u6578\uFF08\u7C21\u5316\uFF1A\u53D6\u8A72\u6708\u4EFD\u7684\u5DE5\u4F5C\u65E5\u6578\uFF0C\u5047\u8A2D\u6BCF\u6708 22 \u5929\uFF09\n\t\t\tconst workingDays = 22;\n\n\t\t\tconst data = [];\n\t\t\tfor (const r of (aggRows?.results || [])) {\n\t\t\t\tconst uid = String(r.user_id);\n\t\t\t\tconst total = Number(r.total_hours || 0);\n\t\t\t\tconst normal = Number(r.normal_hours || 0);\n\t\t\t\tconst ot = Number(r.overtime_hours || 0);\n\t\t\t\tconst billable = Number(r.billable_hours || 0);\n\t\t\t\tconst nonBillable = Number(r.non_billable_hours || 0);\n\t\t\t\t// \u4F7F\u7528\u7387\uFF1A\u53EF\u8A08\u8CBB\u5DE5\u6642 / (\u5DE5\u4F5C\u5929\u6578 \u00D7 8)\n\t\t\t\tconst utilization = (workingDays * 8) > 0 ? Number(((billable / (workingDays * 8)) * 100).toFixed(2)) : 0;\n\t\t\t\tlet dist = distByUser.get(uid) || [];\n\t\t\t\tconst distTotal = dist.reduce((s,x)=> s + x.hours, 0) || 1;\n\t\t\t\tdist = dist.map(x => ({ client_id: x.client_id, company_name: x.company_name, hours: x.hours, percentage: Number(((x.hours/distTotal)*100).toFixed(2)) }));\n\t\t\t\tconst daily = dailyByUser.get(uid) || [];\n\t\t\t\tdata.push({\n\t\t\t\t\tuser_id: Number(uid),\n\t\t\t\t\tusername: usersMap.get(uid) || uid,\n\t\t\t\t\ttotal_hours: Number(total.toFixed(2)),\n\t\t\t\t\tnormal_hours: Number(normal.toFixed(2)),\n\t\t\t\t\tovertime_hours: Number(ot.toFixed(2)),\n\t\t\t\t\tbillable_hours: Number(billable.toFixed(2)),\n\t\t\t\t\tnon_billable_hours: Number(nonBillable.toFixed(2)),\n\t\t\t\t\tutilization_rate: utilization,\n\t\t\t\t\tclient_distribution: dist,\n\t\t\t\t\tdaily_hours: daily,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, year:y, month:m } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// /internal/api/v1/reports/payroll-summary (GET, admin only)\n\tif (path === \"/internal/api/v1/reports/payroll-summary\") {\n\t\tif (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\n\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\n\t\ttry {\n\t\t\tconst p = url.searchParams;\n\t\t\tconst y = parseInt(p.get(\"year\") || \"0\", 10);\n\t\t\tconst m = parseInt(p.get(\"month\") || \"0\", 10);\n\t\t\tlet userId = p.get(\"user_id\");\n\t\t\tif (!Number.isFinite(y) || y < 2000 || !Number.isFinite(m) || m < 1 || m > 12) {\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8ACB\u9078\u64C7\u67E5\u8A62\u6708\u4EFD\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t\tconst ym = `${y}-${String(m).padStart(2,'0')}`;\n\t\t\tconst run = await env.DATABASE.prepare(\"SELECT run_id FROM PayrollRuns WHERE month = ? LIMIT 1\").bind(ym).first();\n\t\t\tif (!run) {\n\t\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data:{ summary:{ total_base_salary:0, total_allowances:0, total_bonuses:0, total_overtime_pay:0, total_gross_salary:0, total_net_salary:0 }, by_employee:[] }, meta:{ requestId, month:ym } }, corsHeaders);\n\t\t\t}\n\t\t\tlet q = \"SELECT mp.user_id, u.username, mp.base_salary_cents, mp.regular_allowance_cents, mp.bonus_cents, mp.overtime_cents, mp.total_cents, mp.is_full_attendance FROM MonthlyPayroll mp JOIN Users u ON u.user_id = mp.user_id WHERE mp.run_id = ?\";\n\t\t\tconst binds = [run.run_id];\n\t\t\tif (userId) { q += \" AND mp.user_id = ?\"; binds.push(String(parseInt(userId,10))); }\n\t\t\tconst rows = await env.DATABASE.prepare(q).bind(...binds).all();\n\t\t\tconst list = rows?.results || [];\n\t\t\tconst cents = (v)=> Number(v||0);\n\t\t\tconst toAmt = (c)=> Math.round(c/100);\n\t\t\tconst byEmployee = list.map(r => ({\n\t\t\t\tuser_id: r.user_id,\n\t\t\t\tusername: r.username,\n\t\t\t\tbase_salary: toAmt(cents(r.base_salary_cents)),\n\t\t\t\ttotal_allowances: toAmt(cents(r.regular_allowance_cents)),\n\t\t\t\ttotal_bonuses: toAmt(cents(r.bonus_cents)),\n\t\t\t\tovertime_pay: toAmt(cents(r.overtime_cents)),\n\t\t\t\tgross_salary: toAmt(cents(r.total_cents)),\n\t\t\t\tnet_salary: toAmt(cents(r.total_cents)),\n\t\t\t\thas_full_attendance: r.is_full_attendance === 1,\n\t\t\t}));\n\t\t\tconst sum = (k)=> byEmployee.reduce((s,x)=> s + Number(x[k]||0), 0);\n\t\t\tconst summary = {\n\t\t\t\ttotal_base_salary: sum('base_salary'),\n\t\t\t\ttotal_allowances: sum('total_allowances'),\n\t\t\t\ttotal_bonuses: sum('total_bonuses'),\n\t\t\t\ttotal_overtime_pay: sum('overtime_pay'),\n\t\t\t\ttotal_gross_salary: sum('gross_salary'),\n\t\t\t\ttotal_net_salary: sum('net_salary'),\n\t\t\t};\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data:{ summary, by_employee: byEmployee }, meta:{ requestId, month:ym } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// /internal/api/v1/reports/revenue (GET, admin only)\n\tif (path === \"/internal/api/v1/reports/revenue\") {\n\t\tif (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\n\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\n\t\ttry {\n\t\t\tconst p = url.searchParams;\n\t\t\tconst start = parseDate(p.get(\"start_date\"));\n\t\t\tconst end = parseDate(p.get(\"end_date\"));\n\t\t\tif (!start || !end || start > end) {\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8ACB\u9078\u64C7\u6709\u6548\u65E5\u671F\u5340\u9593\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t\tconst rows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT strftime('%Y-%m', receipt_date) AS ym,\n\t\t\t\t\tSUM(total_amount) AS receipts,\n\t\t\t\t\tSUM(CASE WHEN status = 'paid' THEN total_amount ELSE 0 END) AS paid\n\t\t\t\t FROM Receipts\n\t\t\t\t WHERE is_deleted = 0 AND status != 'cancelled' AND receipt_date >= ? AND receipt_date <= ?\n\t\t\t\t GROUP BY ym\n\t\t\t\t ORDER BY ym`\n\t\t\t).bind(start, end).all();\n\t\t\tconst monthly_trend = (rows?.results || []).map(r => ({ month: r.ym, receipts: Number(r.receipts||0), paid: Number(r.paid||0), outstanding: Math.max(0, Number(r.receipts||0) - Number(r.paid||0)) }));\n\t\t\tconst total_receipts = monthly_trend.reduce((s,x)=> s + x.receipts, 0);\n\t\t\tconst total_paid = monthly_trend.reduce((s,x)=> s + x.paid, 0);\n\t\t\tconst total_outstanding = Math.max(0, total_receipts - total_paid);\n\t\t\tconst collection_rate = total_receipts > 0 ? Number(((total_paid/total_receipts)*100).toFixed(1)) : 0;\n\n\t\t\tconst byClientRows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT r.client_id, c.company_name, SUM(r.total_amount) AS total_receipts,\n\t\t\t\t\tSUM(CASE WHEN r.status = 'paid' THEN r.total_amount ELSE 0 END) AS total_paid\n\t\t\t\t FROM Receipts r LEFT JOIN Clients c ON c.client_id = r.client_id\n\t\t\t\t WHERE r.is_deleted = 0 AND r.status != 'cancelled' AND r.receipt_date >= ? AND r.receipt_date <= ?\n\t\t\t\t GROUP BY r.client_id, c.company_name`\n\t\t\t).bind(start, end).all();\n\t\t\tconst by_client = (byClientRows?.results || []).map(r => ({ client_id: r.client_id, company_name: r.company_name || r.client_id, total_receipts: Number(r.total_receipts||0), total_paid: Number(r.total_paid||0), total_outstanding: Math.max(0, Number(r.total_receipts||0) - Number(r.total_paid||0)) }));\n\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data:{ summary:{ total_receipts, total_paid, total_outstanding, collection_rate }, monthly_trend, by_client }, meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\n}\n\n\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\n\nfunction b64urlEncode(u8) {\n\tconst b64 = btoa(String.fromCharCode(...u8));\n\treturn b64.replaceAll(\"+\", \"-\").replaceAll(\"/\", \"_\").replaceAll(\"=\", \"\");\n}\n\nasync function hmacSha256(keyBytes, msgBytes) {\n\tconst key = await crypto.subtle.importKey(\"raw\", keyBytes, { name: \"HMAC\", hash: \"SHA-256\" }, false, [\"sign\"]);\n\tconst sig = await crypto.subtle.sign(\"HMAC\", key, msgBytes);\n\treturn new Uint8Array(sig);\n}\n\nfunction utf8(str) { return new TextEncoder().encode(str); }\n\nfunction sanitizeFilename(name) {\n\tconst n = String(name || \"\");\n\treturn n.replace(/[\\\\/]/g, \"_\").replace(/\\.{2,}/g, \".\").slice(0, 200) || \"file\";\n}\n\nfunction extFromFilename(name) {\n\tconst m = String(name||\"\").toLowerCase().match(/\\.([a-z0-9]{1,10})$/);\n\treturn m ? m[1] : \"\";\n}\n\nexport async function handleAttachments(request, env, me, requestId, url, path) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\tconst method = request.method.toUpperCase();\n\n\t// 1) \u4E0A\u50B3\u7C3D\u540D\uFF08POST\uFF09\n\tif (path === \"/internal/api/v1/attachments/upload-sign\") {\n\t\tif (method !== \"POST\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\n\t\tlet body; try { body = await request.json(); } catch (_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\n\t\tconst entityType = String(body?.entity_type || \"\").trim();\n\t\tconst entityId = String(body?.entity_id || \"\").trim();\n\t\tconst filenameRaw = String(body?.filename || \"\").trim();\n\t\tconst contentType = String(body?.content_type || \"\").trim().toLowerCase();\n\t\tconst contentLength = Number(body?.content_length || 0);\n\t\tif (!['client','receipt','sop','task'].includes(entityType)) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"entity_type \u4E0D\u5408\u6CD5\", meta:{ requestId } }, corsHeaders);\n\t\tif (!entityId) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"entity_id \u5FC5\u586B\", meta:{ requestId } }, corsHeaders);\n\t\tif (!filenameRaw) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"filename \u5FC5\u586B\", meta:{ requestId } }, corsHeaders);\n\t\tif (!Number.isFinite(contentLength) || contentLength <= 0) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"content_length \u4E0D\u5408\u6CD5\", meta:{ requestId } }, corsHeaders);\n\t\tif (contentLength > 10 * 1024 * 1024) return jsonResponse(413, { ok:false, code:\"PAYLOAD_TOO_LARGE\", message:\"\u6A94\u6848\u5927\u5C0F\u8D85\u904E\u9650\u5236\uFF08\u6700\u5927 10MB\uFF09\", meta:{ requestId } }, corsHeaders);\n\t\tconst allowedExt = [\"pdf\",\"jpg\",\"jpeg\",\"png\",\"xlsx\",\"xls\",\"docx\",\"doc\"];\n\t\tconst allowedMime = [\n\t\t\t\"application/pdf\",\"image/jpeg\",\"image/png\",\n\t\t\t\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\"application/vnd.ms-excel\",\n\t\t\t\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\"application/msword\"\n\t\t];\n\t\tconst safeName = sanitizeFilename(filenameRaw);\n\t\tconst ext = extFromFilename(safeName);\n\t\tif (!allowedExt.includes(ext)) return jsonResponse(422, { ok:false, code:\"INVALID_EXTENSION\", message:\"\u4E0D\u652F\u63F4\u7684\u526F\u6A94\u540D\", meta:{ requestId } }, corsHeaders);\n\t\tif (!allowedMime.includes(contentType)) return jsonResponse(422, { ok:false, code:\"INVALID_FILE_TYPE\", message:\"\u4E0D\u652F\u63F4\u7684\u6A94\u6848\u578B\u5225\", meta:{ requestId } }, corsHeaders);\n\t\t// \u6578\u91CF\u4E0A\u9650\n\t\tconst limits = { client:20, receipt:5, sop:10, task:10 };\n\t\tconst limit = limits[entityType] ?? 20;\n\t\tconst cntRow = await env.DATABASE.prepare(\"SELECT COUNT(1) AS c FROM Attachments WHERE is_deleted = 0 AND entity_type = ? AND entity_id = ?\").bind(entityType, entityId).first();\n\t\tif (Number(cntRow?.c || 0) >= limit) return jsonResponse(409, { ok:false, code:\"TOO_MANY_FILES\", message:`\u5DF2\u9054\u5230\u9644\u4EF6\u6578\u91CF\u4E0A\u9650\uFF08\u6700\u591A ${limit} \u500B\uFF09`, meta:{ requestId } }, corsHeaders);\n\t\t// \u7522\u751F objectKey \u8207 token\n\t\tconst envName = String(env.APP_ENV || \"dev\");\n\t\tconst now = Math.floor(Date.now()/1000);\n\t\tconst rand = crypto.getRandomValues(new Uint8Array(6));\n\t\tconst randStr = b64urlEncode(rand);\n\t\tconst folder = `private/${envName}/attachments/${entityType}_${entityId}`;\n\t\tconst objectKey = `${folder}/f_${now}_${randStr}.${ext}`;\n\t\tconst expiresAt = now + 300; // 5 \u5206\u9418\n\t\tconst payload = {\n\t\t\tobjectKey,\n\t\t\tentityType,\n\t\t\tentityId,\n\t\t\tfilename: safeName,\n\t\t\tcontentType,\n\t\t\tcontentLength,\n\t\t\tuserId: String(me.user_id),\n\t\t\texp: expiresAt,\n\t\t};\n\t\tconst secret = String(env.UPLOAD_SIGNING_SECRET || \"change-me\");\n\t\tconst pBytes = utf8(JSON.stringify(payload));\n\t\tconst sig = await hmacSha256(utf8(secret), pBytes);\n\t\tconst token = `${b64urlEncode(pBytes)}.${b64urlEncode(sig)}`;\n\t\tconst uploadUrl = `${url.origin}/internal/api/v1/attachments/upload-direct?token=${token}`;\n\t\tconst data = { uploadUrl, objectKey, headers: { \"Content-Type\": contentType, \"Content-Length\": String(contentLength) } };\n\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, expiresAt } }, corsHeaders);\n\t}\n\n\t// 2) \u76F4\u50B3\u5165\u53E3\uFF08PUT\uFF09\n\tif (path === \"/internal/api/v1/attachments/upload-direct\") {\n\t\tif (method !== \"PUT\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\n\t\ttry {\n\t\t\tconst token = url.searchParams.get(\"token\") || \"\";\n\t\t\tconst parts = token.split(\".\");\n\t\t\tif (parts.length !== 2) return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u7C3D\u540D\u7121\u6548\", meta:{ requestId } }, corsHeaders);\n\t\t\tconst pBytes = Uint8Array.from(atob(parts[0].replaceAll(\"-\",\"+\").replaceAll(\"_\",\"/\")), c => c.charCodeAt(0));\n\t\t\tconst sBytes = Uint8Array.from(atob(parts[1].replaceAll(\"-\",\"+\").replaceAll(\"_\",\"/\")), c => c.charCodeAt(0));\n\t\t\tconst secret = String(env.UPLOAD_SIGNING_SECRET || \"change-me\");\n\t\t\tconst expected = await hmacSha256(utf8(secret), pBytes);\n\t\t\tif (expected.length !== sBytes.length) return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u7C3D\u540D\u7121\u6548\", meta:{ requestId } }, corsHeaders);\n\t\t\tlet okSig = 0; for (let i=0;i<expected.length;i++) okSig |= (expected[i]^sBytes[i]);\n\t\t\tif (okSig !== 0) return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u7C3D\u540D\u7121\u6548\", meta:{ requestId } }, corsHeaders);\n\t\t\tconst payload = JSON.parse(new TextDecoder().decode(pBytes));\n\t\t\tif (!payload || typeof payload !== 'object') return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u7C3D\u540D\u7121\u6548\", meta:{ requestId } }, corsHeaders);\n\t\t\tif (payload.exp < Math.floor(Date.now()/1000)) return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u7C3D\u540D\u5DF2\u904E\u671F\", meta:{ requestId } }, corsHeaders);\n\t\t\t// \u518D\u6B21\u6AA2\u67E5\u7576\u524D\u4F7F\u7528\u8005\u4E00\u81F4\n\t\t\tif (String(payload.userId) !== String(me.user_id)) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u4E0D\u5141\u8A31\u7684\u4F7F\u7528\u8005\", meta:{ requestId } }, corsHeaders);\n\t\t\t// Header \u9A57\u8B49\n\t\t\tconst reqCt = (request.headers.get(\"Content-Type\") || \"\").toLowerCase();\n\t\t\tconst reqLen = parseInt(request.headers.get(\"Content-Length\") || \"0\", 10);\n\t\t\tif (reqCt !== String(payload.contentType).toLowerCase()) return jsonResponse(415, { ok:false, code:\"INVALID_FILE_TYPE\", message:\"Content-Type \u4E0D\u5339\u914D\", meta:{ requestId } }, corsHeaders);\n\t\t\tif (!Number.isFinite(reqLen) || reqLen !== Number(payload.contentLength)) return jsonResponse(400, { ok:false, code:\"VALIDATION_ERROR\", message:\"Content-Length \u4E0D\u5339\u914D\", meta:{ requestId } }, corsHeaders);\n\t\t\tif (!env.R2_BUCKET) return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"R2 \u672A\u7D81\u5B9A\", meta:{ requestId } }, corsHeaders);\n\t\t\t// \u5BEB\u5165 R2\n\t\t\tconst cd = `attachment; filename=\"${sanitizeFilename(payload.filename)}\"`;\n\t\t\tawait env.R2_BUCKET.put(payload.objectKey, request.body, {\n\t\t\t\thttpMetadata: { contentType: payload.contentType, contentDisposition: cd },\n\t\t\t\tcustomMetadata: { ownerId: String(me.user_id), module: \"attachments\", entityId: `${payload.entityType}:${payload.entityId}` },\n\t\t\t});\n\t\t\t\n\t\t\t// \u5EFA\u7ACB DB \u7D00\u9304\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\"INSERT INTO Attachments (entity_type, entity_id, object_key, filename, content_type, size_bytes, uploader_user_id, uploaded_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)\"\n\t\t\t).bind(payload.entityType, payload.entityId, payload.objectKey, payload.filename, payload.contentType, String(payload.contentLength), String(me.user_id), new Date().toISOString()).run();\n\t\t\tconst row = await env.DATABASE.prepare(\"SELECT last_insert_rowid() AS id\").first();\n\t\t\t\n\t\t\t// \u5982\u679C\u662F\u4EFB\u52D9\u9644\u4EF6\uFF0C\u540C\u6642\u4FDD\u5B58\u5230\u77E5\u8B58\u5EAB\n\t\t\tif (payload.entityType === 'task') {\n\t\t\t\ttry {\n\t\t\t\t\t// \u67E5\u8A62\u4EFB\u52D9\u4FE1\u606F\u7372\u53D6\u5BA2\u6236\u3001\u670D\u52D9\u3001\u5E74\u6708\u7B49\u4FE1\u606F\n\t\t\t\t\tconst task = await env.DATABASE.prepare(`\n\t\t\t\t\t\tSELECT \n\t\t\t\t\t\t\tt.task_id,\n\t\t\t\t\t\t\tt.task_title,\n\t\t\t\t\t\t\tcs.client_id,\n\t\t\t\t\t\t\tcs.service_id,\n\t\t\t\t\t\t\tt.service_month,\n\t\t\t\t\t\t\ts.service_code,\n\t\t\t\t\t\t\ts.service_name\n\t\t\t\t\t\tFROM Tasks t\n\t\t\t\t\t\tLEFT JOIN ClientServices cs ON t.client_service_id = cs.client_service_id\n\t\t\t\t\t\tLEFT JOIN Services s ON cs.service_id = s.service_id\n\t\t\t\t\t\tWHERE t.task_id = ?\n\t\t\t\t\t`).bind(payload.entityId).first();\n\t\t\t\t\t\n\t\t\t\t\tif (task) {\n\t\t\t\t\t\t// \u89E3\u6790\u5E74\u6708\n\t\t\t\t\t\tlet docYear = null;\n\t\t\t\t\t\tlet docMonth = null;\n\t\t\t\t\t\tif (task.service_month) {\n\t\t\t\t\t\t\tconst match = task.service_month.match(/^(\\d{4})-(\\d{2})$/);\n\t\t\t\t\t\t\tif (match) {\n\t\t\t\t\t\t\t\tdocYear = parseInt(match[1]);\n\t\t\t\t\t\t\t\tdocMonth = parseInt(match[2]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\t// \u81EA\u52D5\u8A2D\u7F6E\u670D\u52D9\u985E\u578B\uFF08category\uFF09\u548C\u9069\u7528\u5C64\u7D1A\uFF08scope\uFF09\n\t\t\t\t\t\tconst category = task.service_code || null;\n\t\t\t\t\t\tconst scope = 'task'; // \u4EFB\u52D9\u5C64\u7D1A\uFF0C\u81EA\u52D5\u8A2D\u7F6E\n\t\t\t\t\t\t\n\t\t\t\t\t\t// \u751F\u6210\u63CF\u8FF0\uFF0C\u5305\u542B\u4EFB\u52D9\u548C\u670D\u52D9\u4FE1\u606F\n\t\t\t\t\t\tlet description = `\u4F86\u81EA\u4EFB\u52D9\uFF1A${task.task_title || task.task_id}`;\n\t\t\t\t\t\tif (task.service_name) {\n\t\t\t\t\t\t\tdescription += ` | \u670D\u52D9\uFF1A${task.service_name}`;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (task.service_month) {\n\t\t\t\t\t\t\tdescription += ` | \u671F\u5225\uFF1A${task.service_month}`;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\t// \u4FDD\u5B58\u5230\u77E5\u8B58\u5EAB\n\t\t\t\t\t\tconst nowISO = new Date().toISOString();\n\t\t\t\t\t\tawait env.DATABASE.prepare(`\n\t\t\t\t\t\t\tINSERT INTO InternalDocuments (\n\t\t\t\t\t\t\t\ttitle,\n\t\t\t\t\t\t\t\tdescription,\n\t\t\t\t\t\t\t\tfile_name,\n\t\t\t\t\t\t\t\tfile_url,\n\t\t\t\t\t\t\t\tfile_size,\n\t\t\t\t\t\t\t\tfile_type,\n\t\t\t\t\t\t\t\tcategory,\n\t\t\t\t\t\t\t\tscope,\n\t\t\t\t\t\t\t\tclient_id,\n\t\t\t\t\t\t\t\tdoc_year,\n\t\t\t\t\t\t\t\tdoc_month,\n\t\t\t\t\t\t\t\ttask_id,\n\t\t\t\t\t\t\t\ttags,\n\t\t\t\t\t\t\t\tuploaded_by,\n\t\t\t\t\t\t\t\tcreated_at,\n\t\t\t\t\t\t\t\tupdated_at,\n\t\t\t\t\t\t\t\tis_deleted\n\t\t\t\t\t\t\t) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0)\n\t\t\t\t\t\t`).bind(\n\t\t\t\t\t\t\tpayload.filename, // title\n\t\t\t\t\t\t\tdescription, // description (\u5305\u542B\u4EFB\u52D9\u548C\u670D\u52D9\u4FE1\u606F)\n\t\t\t\t\t\t\tpayload.filename, // file_name\n\t\t\t\t\t\t\tpayload.objectKey, // file_url (\u4F7F\u7528\u540C\u4E00\u500BR2\u8DEF\u5F91)\n\t\t\t\t\t\t\tpayload.contentLength, // file_size\n\t\t\t\t\t\t\tpayload.contentType, // file_type\n\t\t\t\t\t\t\tcategory, // category (\u81EA\u52D5\u5F9E\u4EFB\u52D9\u95DC\u806F\u7684\u670D\u52D9\u53D6\u5F97)\n\t\t\t\t\t\t\tscope, // scope (\u81EA\u52D5\u8A2D\u7F6E\u70BA'task')\n\t\t\t\t\t\t\ttask.client_id || null, // client_id (\u81EA\u52D5\u5F9E\u4EFB\u52D9\u53D6\u5F97)\n\t\t\t\t\t\t\tdocYear, // doc_year (\u81EA\u52D5\u5F9Eservice_month\u89E3\u6790)\n\t\t\t\t\t\t\tdocMonth, // doc_month (\u81EA\u52D5\u5F9Eservice_month\u89E3\u6790)\n\t\t\t\t\t\t\ttask.task_id, // task_id (\u95DC\u806F\u4EFB\u52D9)\n\t\t\t\t\t\t\t'\u4EFB\u52D9\u9644\u4EF6', // tags (\u81EA\u52D5\u6A19\u8A18)\n\t\t\t\t\t\t\tme.user_id, // uploaded_by\n\t\t\t\t\t\t\tnowISO, // created_at\n\t\t\t\t\t\t\tnowISO // updated_at\n\t\t\t\t\t\t).run();\n\t\t\t\t\t\t\n\t\t\t\t\t\tconsole.log(`\u2705 \u4EFB\u52D9\u9644\u4EF6\u5DF2\u81EA\u52D5\u540C\u6B65\u5230\u77E5\u8B58\u5EAB:`);\n\t\t\t\t\t\tconsole.log(`   - \u6587\u4EF6: ${payload.filename}`);\n\t\t\t\t\t\tconsole.log(`   - \u4EFB\u52D9: ${task.task_id} (${task.task_title})`);\n\t\t\t\t\t\tconsole.log(`   - \u670D\u52D9\u985E\u578B: ${category || '\u672A\u8A2D\u5B9A'} (${task.service_name || ''})`);\n\t\t\t\t\t\tconsole.log(`   - \u5BA2\u6236: ${task.client_id || '\u672A\u8A2D\u5B9A'}`);\n\t\t\t\t\t\tconsole.log(`   - \u5E74\u6708: ${docYear || '?'}\u5E74${docMonth || '?'}\u6708`);\n\t\t\t\t\t\tconsole.log(`   - \u9069\u7528\u5C64\u7D1A: ${scope} (\u81EA\u52D5\u8A2D\u7F6E)`);\n\t\t\t\t\t}\n\t\t\t\t} catch (err) {\n\t\t\t\t\t// \u77E5\u8B58\u5EAB\u4FDD\u5B58\u5931\u6557\u4E0D\u5F71\u97FF\u9644\u4EF6\u4E0A\u50B3\n\t\t\t\t\tconsole.error(`\u26A0\uFE0F \u4FDD\u5B58\u5230\u77E5\u8B58\u5EAB\u5931\u6557\uFF0C\u4F46\u9644\u4EF6\u5DF2\u4E0A\u50B3:`, err);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\treturn jsonResponse(201, { ok:true, code:\"CREATED\", message:\"\u5DF2\u4E0A\u50B3\", data:{ attachment_id: row?.id, object_key: payload.objectKey }, meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// GET /internal/api/v1/attachments - \u83B7\u53D6\u9644\u4EF6\u5217\u8868\n\tif (path === \"/internal/api/v1/attachments\" && method === \"GET\") {\n\t\ttry {\n\t\t\tconst params = url.searchParams;\n\t\t\tconst entityType = (params.get(\"entity_type\") || \"\").trim();\n\t\t\tconst entityId = (params.get(\"entity_id\") || \"\").trim();\n\t\t\tconsole.log(JSON.stringify({ level:\"info\", requestId, action:\"get_attachments\", entityType, entityId }));\n\t\t\t\n\t\t\tif (!entityType || !entityId) {\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"entity_type \u8207 entity_id \u5FC5\u586B\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t\tif (!['client','receipt','sop','task'].includes(entityType)) {\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"entity_type \u4E0D\u5408\u6CD5\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t\tconst page = Math.max(1, parseInt(params.get(\"page\") || \"1\", 10));\n\t\t\tconst perPage = Math.min(100, Math.max(1, parseInt(params.get(\"perPage\") || \"20\", 10)));\n\t\t\tconst offset = (page - 1) * perPage;\n\t\t\tconst q = (params.get(\"q\") || \"\").trim();\n\t\t\tconst fileType = (params.get(\"file_type\") || \"all\").trim();\n\t\t\tconst dateFrom = (params.get(\"dateFrom\") || \"\").trim();\n\t\t\tconst dateTo = (params.get(\"dateTo\") || \"\").trim();\n\n\t\t\tconst where = [\"is_deleted = 0\", \"entity_type = ?\", \"entity_id = ?\"];\n\t\t\tconst binds = [entityType, entityId];\n\t\t\tif (q) { where.push(\"(filename LIKE ?)\"); binds.push(`%${q}%`); }\n\t\t\tif (/^\\d{4}-\\d{2}-\\d{2}$/.test(dateFrom)) { where.push(\"uploaded_at >= ?\"); binds.push(`${dateFrom}T00:00:00.000Z`); }\n\t\t\tif (/^\\d{4}-\\d{2}-\\d{2}$/.test(dateTo)) { where.push(\"uploaded_at <= ?\"); binds.push(`${dateTo}T23:59:59.999Z`); }\n\t\t\tif (fileType !== 'all') {\n\t\t\t\t// \u4EE5\u526F\u6A94\u540D\u8207 content_type \u7C97\u7565\u5206\u985E\n\t\t\t\tif (fileType === 'pdf') { where.push(\"(LOWER(filename) LIKE '%.pdf' OR LOWER(content_type) = 'application/pdf')\"); }\n\t\t\t\telse if (fileType === 'image') { where.push(\"(LOWER(content_type) LIKE 'image/%' OR LOWER(filename) GLOB '*.jpg' OR LOWER(filename) GLOB '*.jpeg' OR LOWER(filename) GLOB '*.png')\"); }\n\t\t\t\telse if (fileType === 'excel') { where.push(\"(LOWER(filename) GLOB '*.xls' OR LOWER(filename) GLOB '*.xlsx' OR LOWER(content_type) IN ('application/vnd.ms-excel','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'))\"); }\n\t\t\t\telse if (fileType === 'word') { where.push(\"(LOWER(filename) GLOB '*.doc' OR LOWER(filename) GLOB '*.docx' OR LOWER(content_type) IN ('application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document'))\"); }\n\t\t\t}\n\t\t\tconst whereSql = `WHERE ${where.join(\" AND \")}`;\n\t\t\t\n\t\t\tconsole.log(JSON.stringify({ level:\"debug\", requestId, whereSql, binds }));\n\t\t\t\n\t\t\tconst countRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM Attachments ${whereSql}`).bind(...binds).first();\n\t\t\tconst total = Number(countRow?.total || 0);\n\t\t\t\n\t\t\tconsole.log(JSON.stringify({ level:\"debug\", requestId, total }));\n\t\t\t\n\t\t\tconst sql = `SELECT a.attachment_id, a.filename, a.content_type, a.size_bytes, a.uploader_user_id, a.uploaded_at\n\t\t\t\t FROM Attachments a\n\t\t\t\t ${whereSql}\n\t\t\t\t ORDER BY a.uploaded_at DESC\n\t\t\t\t LIMIT ? OFFSET ?`;\n\t\t\t\n\t\t\tconsole.log(JSON.stringify({ level:\"debug\", requestId, sql: sql.substring(0, 200) }));\n\t\t\t\n\t\t\tconst rows = await env.DATABASE.prepare(sql).bind(...binds, perPage, offset).all();\n\t\t\t\n\t\t\tconsole.log(JSON.stringify({ level:\"debug\", requestId, rowCount: rows?.results?.length || 0 }));\n\t\t\t\n\t\t\t// \u5982\u679C\u6709\u7ED3\u679C\uFF0C\u518D\u67E5\u8BE2\u4E0A\u4F20\u8005\u59D3\u540D\n\t\t\tconst uploaderIds = [...new Set((rows?.results || []).map(r => r.uploader_user_id).filter(Boolean))];\n\t\t\tlet uploaderMap = {};\n\t\t\tif (uploaderIds.length > 0) {\n\t\t\t\tconst placeholders = uploaderIds.map(() => '?').join(',');\n\t\t\t\tconst uploaders = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT user_id, name FROM Users WHERE user_id IN (${placeholders})`\n\t\t\t\t).bind(...uploaderIds).all();\n\t\t\t\tuploaders?.results?.forEach(u => {\n\t\t\t\t\tuploaderMap[u.user_id] = u.name;\n\t\t\t\t});\n\t\t\t}\n\t\t\t\n\t\t\tconst data = (rows?.results || []).map(r => ({\n\t\t\t\tid: r.attachment_id,\n\t\t\t\tfilename: r.filename,\n\t\t\t\tcontentType: r.content_type,\n\t\t\t\tsizeBytes: Number(r.size_bytes || 0),\n\t\t\t\tuploaderUserId: r.uploader_user_id,\n\t\t\t\tuploaderName: uploaderMap[r.uploader_user_id] || String(r.uploader_user_id || ''),\n\t\t\t\tuploadedAt: r.uploaded_at,\n\t\t\t}));\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, page, perPage, total } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path:\"/internal/api/v1/attachments\", err:String(err), stack: err.stack }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// GET /internal/api/v1/attachments/:id/download - \u4E0B\u8F7D\u9644\u4EF6\n\tconst matchDownload = path.match(/^\\/internal\\/api\\/v1\\/attachments\\/(\\d+)\\/download$/);\n\tif (method === \"GET\" && matchDownload) {\n\t\tconst attachmentId = matchDownload[1];\n\t\ttry {\n\t\t\tconst attachment = await env.DATABASE.prepare(\n\t\t\t\t`SELECT object_key, filename, content_type FROM Attachments WHERE attachment_id = ? AND is_deleted = 0`\n\t\t\t).bind(attachmentId).first();\n\t\t\t\n\t\t\tif (!attachment) {\n\t\t\t\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u9644\u4EF6\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\tif (!env.R2_BUCKET) {\n\t\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"R2 \u672A\u7D81\u5B9A\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\tconst object = await env.R2_BUCKET.get(attachment.object_key);\n\t\t\tif (!object) {\n\t\t\t\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u6A94\u6848\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\treturn new Response(object.body, {\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': attachment.content_type || 'application/octet-stream',\n\t\t\t\t\t'Content-Disposition': `attachment; filename=\"${attachment.filename}\"`,\n\t\t\t\t\t...corsHeaders\n\t\t\t\t}\n\t\t\t});\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\t// DELETE /internal/api/v1/attachments/:id - \u5220\u9664\u9644\u4EF6\n\tconst matchDelete = path.match(/^\\/internal\\/api\\/v1\\/attachments\\/(\\d+)$/);\n\tif (method === \"DELETE\" && matchDelete) {\n\t\tconst attachmentId = matchDelete[1];\n\t\ttry {\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`UPDATE Attachments SET is_deleted = 1 WHERE attachment_id = ?`\n\t\t\t).bind(attachmentId).run();\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u522A\u9664\", meta:{ requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\treturn jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\n}\n\n\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nexport async function handleSOP(request, env, me, requestId, url, path) {\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\tconst method = request.method.toUpperCase();\r\n\r\n\t// POST /internal/api/v1/sop - \u5275\u5EFA\u65B0 SOP\r\n\tif (path === \"/internal/api/v1/sop\" && method === \"POST\") {\r\n\t\ttry {\r\n\t\t\tconst body = await request.json();\r\n\t\t\tconst { title, content, category, tags, scope, client_id } = body;\r\n\t\t\t\r\n\t\t\tif (!title || !content) {\r\n\t\t\t\treturn jsonResponse(400, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u6A19\u984C\u548C\u5167\u5BB9\u70BA\u5FC5\u586B\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// \u9A57\u8B49scope\u5FC5\u9808\u70BAservice\u6216task\r\n\t\t\tif (!scope || (scope !== 'service' && scope !== 'task')) {\r\n\t\t\t\treturn jsonResponse(400, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u5FC5\u9808\u6307\u5B9ASOP\u9069\u7528\u5C64\u7D1A\uFF08service\u6216task\uFF09\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst tagsJson = JSON.stringify(Array.isArray(tags) ? tags : []);\r\n\t\t\tconst now = new Date().toISOString();\r\n\t\t\t\r\n\t\t\tconst result = await env.DATABASE.prepare(\r\n\t\t\t\t`INSERT INTO SOPDocuments (title, content, category, tags, scope, client_id, version, is_published, created_by, created_at, updated_at, is_deleted)\r\n\t\t\t\t VALUES (?, ?, ?, ?, ?, ?, 1, 1, ?, ?, ?, 0)`\r\n\t\t\t).bind(title, content, category || '', tagsJson, scope, client_id || null, String(me.user_id), now, now).run();\r\n\t\t\t\r\n\t\t\tconst sopId = result.meta.last_row_id;\r\n\t\t\t\r\n\t\t\treturn jsonResponse(201, { ok:true, code:\"CREATED\", message:\"\u5275\u5EFA\u6210\u529F\", data:{ sop_id: sopId }, meta:{ requestId } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\t\r\n\t// GET /internal/api/v1/sop\r\n\tif (path === \"/internal/api/v1/sop\") {\r\n\t\tif (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n\t\ttry {\r\n\t\t\tconst p = url.searchParams;\r\n\t\t\tconst page = Math.max(1, parseInt(p.get(\"page\") || \"1\", 10));\r\n\t\t\tconst perPage = Math.min(100, Math.max(1, parseInt(p.get(\"perPage\") || \"12\", 10)));\r\n\t\t\tconst offset = (page - 1) * perPage;\r\n\t\t\tconst q = (p.get(\"q\") || \"\").trim();\r\n\t\t\tconst category = (p.get(\"category\") || \"\").trim();\r\n\t\t\tconst scope = (p.get(\"scope\") || \"\").trim();\r\n\t\t\tconst clientId = (p.get(\"client_id\") || \"\").trim();\r\n\t\t\tconst tagsCsv = (p.get(\"tags\") || \"\").trim();\r\n\t\t\tconst published = (p.get(\"published\") || \"all\").trim().toLowerCase();\r\n\r\n\t\t\tconst where = [\"is_deleted = 0\"];\r\n\t\t\tconst binds = [];\r\n\t\t\tif (q) { where.push(\"(title LIKE ? OR tags LIKE ?)\"); binds.push(`%${q}%`, `%${q}%`); }\r\n\t\t\tif (category && category !== \"all\") { where.push(\"category = ?\"); binds.push(category); }\r\n\t\t\tif (scope && (scope === \"service\" || scope === \"task\")) { where.push(\"scope = ?\"); binds.push(scope); }\r\n\t\t\tif (clientId && clientId !== \"all\") { where.push(\"client_id = ?\"); binds.push(parseInt(clientId)); }\r\n\t\t\tif (published !== \"all\") {\r\n\t\t\t\tif ([\"1\",\"true\",\"published\"].includes(published)) { where.push(\"is_published = 1\"); }\r\n\t\t\t\telse if ([\"0\",\"false\",\"draft\"].includes(published)) { where.push(\"is_published = 0\"); }\r\n\t\t\t}\r\n\t\t\tif (tagsCsv) {\r\n\t\t\t\tconst tagList = tagsCsv.split(\",\").map(s => s.trim()).filter(Boolean);\r\n\t\t\t\tfor (const t of tagList) { where.push(\"(tags LIKE ?)\"); binds.push(`%${t}%`); }\r\n\t\t\t}\r\n\t\t\tconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n\t\t\tconst countRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM SOPDocuments ${whereSql}`).bind(...binds).first();\r\n\t\t\tconst total = Number(countRow?.total || 0);\r\n\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT sop_id, title, category, tags, scope, client_id, version, is_published, created_by, created_at, updated_at\r\n\t\t\t\t FROM SOPDocuments\r\n\t\t\t\t ${whereSql}\r\n\t\t\t\t ORDER BY updated_at DESC, sop_id DESC\r\n\t\t\t\t LIMIT ? OFFSET ?`\r\n\t\t\t).bind(...binds, perPage, offset).all();\r\n\t\t\tconst items = (rows?.results || []).map(r => ({\r\n\t\t\t\tid: r.sop_id,\r\n\t\t\t\ttitle: r.title,\r\n\t\t\t\tcategory: r.category || \"\",\r\n\t\t\t\tscope: r.scope || null,\r\n\t\t\t\tclientId: r.client_id || null,\r\n\t\t\t\ttags: (() => { try { return JSON.parse(r.tags || \"[]\"); } catch(_) { return []; } })(),\r\n\t\t\t\tversion: Number(r.version || 1),\r\n\t\t\t\tisPublished: r.is_published === 1,\r\n\t\t\t\tcreatedBy: r.created_by,\r\n\t\t\t\tcreatedAt: r.created_at,\r\n\t\t\t\tupdatedAt: r.updated_at,\r\n\t\t\t}));\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data: items, meta:{ requestId, page, perPage, total } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\t// GET /internal/api/v1/sop/:id - \u7372\u53D6\u55AE\u500B SOP \u8A73\u60C5\r\n\tconst matchDetail = path.match(/^\\/internal\\/api\\/v1\\/sop\\/(\\d+)$/);\r\n\tif (method === \"GET\" && matchDetail) {\r\n\t\tconst sopId = parseInt(matchDetail[1]);\r\n\t\ttry {\r\n\t\t\tconst row = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT sop_id, title, content, category, tags, scope, client_id, version, is_published, created_by, created_at, updated_at\r\n\t\t\t\t FROM SOPDocuments\r\n\t\t\t\t WHERE sop_id = ? AND is_deleted = 0`\r\n\t\t\t).bind(sopId).first();\r\n\r\n\t\t\tif (!row) {\r\n\t\t\t\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"SOP \u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\r\n\t\t\tconst data = {\r\n\t\t\t\tid: row.sop_id,\r\n\t\t\t\ttitle: row.title,\r\n\t\t\t\tcontent: row.content || \"\",\r\n\t\t\t\tcategory: row.category || \"\",\r\n\t\t\t\tscope: row.scope || null,\r\n\t\t\t\tclientId: row.client_id || null,\r\n\t\t\t\ttags: (() => { try { return JSON.parse(row.tags || \"[]\"); } catch(_) { return []; } })(),\r\n\t\t\t\tversion: Number(row.version || 1),\r\n\t\t\t\tisPublished: row.is_published === 1,\r\n\t\t\t\tcreatedBy: row.created_by,\r\n\t\t\t\tcreatedAt: row.created_at,\r\n\t\t\t\tupdatedAt: row.updated_at,\r\n\t\t\t};\r\n\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\t\r\n\t// PUT /internal/api/v1/sop/:id - \u66F4\u65B0 SOP\r\n\tconst matchUpdate = path.match(/^\\/internal\\/api\\/v1\\/sop\\/(\\d+)$/);\r\n\tif (method === \"PUT\" && matchUpdate) {\r\n\t\tconst sopId = parseInt(matchUpdate[1]);\r\n\t\ttry {\r\n\t\t\tconst body = await request.json();\r\n\t\t\tconst { title, content, category, tags, scope, client_id } = body;\r\n\t\t\t\r\n\t\t\tif (!title || !content) {\r\n\t\t\t\treturn jsonResponse(400, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u6A19\u984C\u548C\u5167\u5BB9\u70BA\u5FC5\u586B\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst tagsJson = JSON.stringify(Array.isArray(tags) ? tags : []);\r\n\t\t\t\r\n\t\t\t// \u9A57\u8B49scope\u5FC5\u9808\u70BAservice\u6216task\r\n\t\t\tif (!scope || (scope !== 'service' && scope !== 'task')) {\r\n\t\t\t\treturn jsonResponse(400, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u5FC5\u9808\u6307\u5B9ASOP\u9069\u7528\u5C64\u7D1A\uFF08service\u6216task\uFF09\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst now = new Date().toISOString();\r\n\t\t\t\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t`UPDATE SOPDocuments \r\n\t\t\t\t SET title = ?, content = ?, category = ?, tags = ?, scope = ?, client_id = ?, updated_at = ?, version = version + 1\r\n\t\t\t\t WHERE sop_id = ? AND is_deleted = 0`\r\n\t\t\t).bind(title, content, category || '', tagsJson, scope, client_id || null, now, sopId).run();\r\n\t\t\t\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u66F4\u65B0\u6210\u529F\", data:{ sop_id: sopId }, meta:{ requestId } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\t\r\n\t// DELETE /internal/api/v1/sop/:id - \u522A\u9664 SOP\r\n\tconst matchDelete = path.match(/^\\/internal\\/api\\/v1\\/sop\\/(\\d+)$/);\r\n\tif (method === \"DELETE\" && matchDelete) {\r\n\t\tconst sopId = parseInt(matchDelete[1]);\r\n\t\ttry {\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t`UPDATE SOPDocuments SET is_deleted = 1, updated_at = ? WHERE sop_id = ?`\r\n\t\t\t).bind(new Date().toISOString(), sopId).run();\r\n\t\t\t\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u522A\u9664\u6210\u529F\", meta:{ requestId } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n", "/**\r\n * FAQ\u7BA1\u7406 API\r\n * \u63D0\u4F9BFAQ\u7684CRUD\u64CD\u4F5C\r\n */\r\n\r\nexport async function handleFAQRequest(request, env, ctx, pathname, me) {\r\n  const method = request.method;\r\n  \r\n  // GET /internal/api/v1/faq - \u83B7\u53D6FAQ\u5217\u8868\r\n  if (method === 'GET' && pathname === '/internal/api/v1/faq') {\r\n    return await getFAQList(request, env, me);\r\n  }\r\n  \r\n  // GET /internal/api/v1/faq/:id - \u83B7\u53D6\u5355\u4E2AFAQ\u8BE6\u60C5\r\n  if (method === 'GET' && pathname.match(/^\\/internal\\/api\\/v1\\/faq\\/\\d+$/)) {\r\n    const faqId = parseInt(pathname.split('/').pop());\r\n    return await getFAQById(env, faqId, me);\r\n  }\r\n  \r\n  // POST /internal/api/v1/faq - \u521B\u5EFAFAQ\r\n  if (method === 'POST' && pathname === '/internal/api/v1/faq') {\r\n    return await createFAQ(request, env, me);\r\n  }\r\n  \r\n  // PUT /internal/api/v1/faq/:id - \u66F4\u65B0FAQ\r\n  if (method === 'PUT' && pathname.match(/^\\/internal\\/api\\/v1\\/faq\\/\\d+$/)) {\r\n    const faqId = parseInt(pathname.split('/').pop());\r\n    return await updateFAQ(request, env, faqId, me);\r\n  }\r\n  \r\n  // DELETE /internal/api/v1/faq/:id - \u5220\u9664FAQ\uFF08\u8F6F\u5220\u9664\uFF09\r\n  if (method === 'DELETE' && pathname.match(/^\\/internal\\/api\\/v1\\/faq\\/\\d+$/)) {\r\n    const faqId = parseInt(pathname.split('/').pop());\r\n    return await deleteFAQ(env, faqId, me);\r\n  }\r\n  \r\n  return null;\r\n}\r\n\r\n// \u83B7\u53D6FAQ\u5217\u8868\r\nasync function getFAQList(request, env, me) {\r\n  try {\r\n    const url = new URL(request.url);\r\n    const page = parseInt(url.searchParams.get('page')) || 1;\r\n    const perPage = parseInt(url.searchParams.get('perPage')) || 20;\r\n    const q = url.searchParams.get('q') || '';\r\n    const category = url.searchParams.get('category') || '';\r\n    const scope = url.searchParams.get('scope') || '';\r\n    const clientId = url.searchParams.get('client_id') || '';\r\n    const tags = url.searchParams.get('tags') || '';\r\n    \r\n    const offset = (page - 1) * perPage;\r\n    \r\n    // \u6784\u5EFA\u67E5\u8BE2\u6761\u4EF6\r\n    let whereClauses = ['is_deleted = 0'];\r\n    const params = [];\r\n    \r\n    if (q) {\r\n      whereClauses.push('(question LIKE ? OR answer LIKE ?)');\r\n      params.push(`%${q}%`, `%${q}%`);\r\n    }\r\n    \r\n    if (category && category !== 'all') {\r\n      whereClauses.push('category = ?');\r\n      params.push(category);\r\n    }\r\n    \r\n    if (scope && (scope === 'service' || scope === 'task')) {\r\n      whereClauses.push('scope = ?');\r\n      params.push(scope);\r\n    }\r\n    \r\n    if (clientId && clientId !== 'all') {\r\n      whereClauses.push('client_id = ?');\r\n      params.push(parseInt(clientId));\r\n    }\r\n    \r\n    if (tags) {\r\n      const tagList = tags.split(',').map(t => t.trim()).filter(Boolean);\r\n      tagList.forEach(tag => {\r\n        whereClauses.push('tags LIKE ?');\r\n        params.push(`%${tag}%`);\r\n      });\r\n    }\r\n    \r\n    const whereSQL = whereClauses.length > 0 ? 'WHERE ' + whereClauses.join(' AND ') : '';\r\n    \r\n    // \u67E5\u8BE2\u603B\u6570\r\n    const countSQL = `SELECT COUNT(*) as total FROM InternalFAQ ${whereSQL}`;\r\n    const countResult = await env.DATABASE.prepare(countSQL).bind(...params).first();\r\n    const total = countResult?.total || 0;\r\n    \r\n    // \u67E5\u8BE2\u6570\u636E\r\n    const dataSQL = `\r\n      SELECT \r\n        faq_id, \r\n        question, \r\n        answer, \r\n        category, \r\n        scope,\r\n        client_id,\r\n        tags, \r\n        created_by, \r\n        created_at, \r\n        updated_at\r\n      FROM InternalFAQ\r\n      ${whereSQL}\r\n      ORDER BY updated_at DESC\r\n      LIMIT ? OFFSET ?\r\n    `;\r\n    \r\n    const results = await env.DATABASE.prepare(dataSQL)\r\n      .bind(...params, perPage, offset)\r\n      .all();\r\n    \r\n    const faqs = (results.results || []).map(row => ({\r\n      faq_id: row.faq_id,\r\n      question: row.question,\r\n      answer: row.answer,\r\n      category: row.category,\r\n      scope: row.scope || null,\r\n      clientId: row.client_id || null,\r\n      tags: row.tags ? row.tags.split(',').map(t => t.trim()) : [],\r\n      createdBy: row.created_by,\r\n      createdAt: row.created_at,\r\n      updatedAt: row.updated_at\r\n    }));\r\n    \r\n    return new Response(JSON.stringify({\r\n      ok: true,\r\n      data: faqs,\r\n      meta: { total, page, perPage }\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n    \r\n  } catch (err) {\r\n    console.error('\u83B7\u53D6FAQ\u5217\u8868\u5931\u8D25:', err);\r\n    return new Response(JSON.stringify({\r\n      ok: false,\r\n      error: '\u83B7\u53D6FAQ\u5217\u8868\u5931\u8D25'\r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n}\r\n\r\n// \u83B7\u53D6\u5355\u4E2AFAQ\u8BE6\u60C5\r\nasync function getFAQById(env, faqId, me) {\r\n  try {\r\n    const result = await env.DATABASE.prepare(`\r\n      SELECT \r\n        faq_id, \r\n        question, \r\n        answer, \r\n        category, \r\n        scope,\r\n        client_id,\r\n        tags, \r\n        created_by, \r\n        created_at, \r\n        updated_at\r\n      FROM InternalFAQ\r\n      WHERE faq_id = ? AND is_deleted = 0\r\n    `).bind(faqId).first();\r\n    \r\n    if (!result) {\r\n      return new Response(JSON.stringify({\r\n        ok: false,\r\n        error: 'FAQ\u4E0D\u5B58\u5728'\r\n      }), {\r\n        status: 404,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n    \r\n    const faq = {\r\n      faq_id: result.faq_id,\r\n      question: result.question,\r\n      answer: result.answer,\r\n      category: result.category,\r\n      scope: result.scope || null,\r\n      clientId: result.client_id || null,\r\n      tags: result.tags ? result.tags.split(',').map(t => t.trim()) : [],\r\n      createdBy: result.created_by,\r\n      createdAt: result.created_at,\r\n      updatedAt: result.updated_at\r\n    };\r\n    \r\n    return new Response(JSON.stringify({\r\n      ok: true,\r\n      data: faq\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n    \r\n  } catch (err) {\r\n    console.error('\u83B7\u53D6FAQ\u8BE6\u60C5\u5931\u8D25:', err);\r\n    return new Response(JSON.stringify({\r\n      ok: false,\r\n      error: '\u83B7\u53D6FAQ\u8BE6\u60C5\u5931\u8D25'\r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n}\r\n\r\n// \u521B\u5EFAFAQ\r\nasync function createFAQ(request, env, me) {\r\n  try {\r\n    const body = await request.json();\r\n    const { question, answer, category, scope, client_id, tags } = body;\r\n    \r\n    // \u9A8C\u8BC1\u5FC5\u586B\u5B57\u6BB5\r\n    if (!question || !answer) {\r\n      return new Response(JSON.stringify({\r\n        ok: false,\r\n        error: '\u95EE\u9898\u548C\u7B54\u6848\u4E3A\u5FC5\u586B\u9879'\r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n    \r\n    if (!scope || (scope !== 'service' && scope !== 'task')) {\r\n      return new Response(JSON.stringify({\r\n        ok: false,\r\n        error: '\u5FC5\u9808\u6307\u5B9AFAQ\u9069\u7528\u5C64\u7D1A\uFF08service\u6216task\uFF09'\r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n    \r\n    const tagsStr = Array.isArray(tags) ? tags.join(',') : (tags || '');\r\n    const now = new Date().toISOString();\r\n    \r\n    const result = await env.DATABASE.prepare(`\r\n      INSERT INTO InternalFAQ (\r\n        question, \r\n        answer, \r\n        category, \r\n        scope,\r\n        client_id,\r\n        tags, \r\n        created_by, \r\n        created_at, \r\n        updated_at,\r\n        is_deleted\r\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 0)\r\n    `).bind(\r\n      question,\r\n      answer,\r\n      category || null,\r\n      scope,\r\n      client_id || null,\r\n      tagsStr,\r\n      me?.user_id || null,\r\n      now,\r\n      now\r\n    ).run();\r\n    \r\n    return new Response(JSON.stringify({\r\n      ok: true,\r\n      data: { \r\n        faq_id: result.meta.last_row_id,\r\n        question,\r\n        answer,\r\n        category,\r\n        scope,\r\n        clientId: client_id || null,\r\n        tags: tagsStr ? tagsStr.split(',').map(t => t.trim()) : [],\r\n        createdBy: me?.user_id,\r\n        createdAt: now,\r\n        updatedAt: now\r\n      }\r\n    }), {\r\n      status: 201,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n    \r\n  } catch (err) {\r\n    console.error('\u521B\u5EFAFAQ\u5931\u8D25:', err);\r\n    return new Response(JSON.stringify({\r\n      ok: false,\r\n      error: '\u521B\u5EFAFAQ\u5931\u8D25'\r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n}\r\n\r\n// \u66F4\u65B0FAQ\r\nasync function updateFAQ(request, env, faqId, me) {\r\n  try {\r\n    const body = await request.json();\r\n    const { question, answer, category, scope, client_id, tags } = body;\r\n    \r\n    // \u9A8C\u8BC1FAQ\u662F\u5426\u5B58\u5728\r\n    const existing = await env.DATABASE.prepare(\r\n      'SELECT faq_id FROM InternalFAQ WHERE faq_id = ? AND is_deleted = 0'\r\n    ).bind(faqId).first();\r\n    \r\n    if (!existing) {\r\n      return new Response(JSON.stringify({\r\n        ok: false,\r\n        error: 'FAQ\u4E0D\u5B58\u5728'\r\n      }), {\r\n        status: 404,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n    \r\n    // \u9A8C\u8BC1\u5FC5\u586B\u5B57\u6BB5\r\n    if (!question || !answer) {\r\n      return new Response(JSON.stringify({\r\n        ok: false,\r\n        error: '\u95EE\u9898\u548C\u7B54\u6848\u4E3A\u5FC5\u586B\u9879'\r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n    \r\n    if (!scope || (scope !== 'service' && scope !== 'task')) {\r\n      return new Response(JSON.stringify({\r\n        ok: false,\r\n        error: '\u5FC5\u9808\u6307\u5B9AFAQ\u9069\u7528\u5C64\u7D1A\uFF08service\u6216task\uFF09'\r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n    \r\n    const tagsStr = Array.isArray(tags) ? tags.join(',') : (tags || '');\r\n    const now = new Date().toISOString();\r\n    \r\n    await env.DATABASE.prepare(`\r\n      UPDATE InternalFAQ\r\n      SET \r\n        question = ?,\r\n        answer = ?,\r\n        category = ?,\r\n        scope = ?,\r\n        client_id = ?,\r\n        tags = ?,\r\n        updated_at = ?\r\n      WHERE faq_id = ? AND is_deleted = 0\r\n    `).bind(\r\n      question,\r\n      answer,\r\n      category || null,\r\n      scope,\r\n      client_id || null,\r\n      tagsStr,\r\n      now,\r\n      faqId\r\n    ).run();\r\n    \r\n    return new Response(JSON.stringify({\r\n      ok: true,\r\n      data: {\r\n        faq_id: faqId,\r\n        question,\r\n        answer,\r\n        category,\r\n        scope,\r\n        clientId: client_id || null,\r\n        tags: tagsStr ? tagsStr.split(',').map(t => t.trim()) : [],\r\n        updatedAt: now\r\n      }\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n    \r\n  } catch (err) {\r\n    console.error('\u66F4\u65B0FAQ\u5931\u8D25:', err);\r\n    return new Response(JSON.stringify({\r\n      ok: false,\r\n      error: '\u66F4\u65B0FAQ\u5931\u8D25'\r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n}\r\n\r\n// \u5220\u9664FAQ\uFF08\u8F6F\u5220\u9664\uFF09\r\nasync function deleteFAQ(env, faqId, me) {\r\n  try {\r\n    // \u9A8C\u8BC1FAQ\u662F\u5426\u5B58\u5728\r\n    const existing = await env.DATABASE.prepare(\r\n      'SELECT faq_id FROM InternalFAQ WHERE faq_id = ? AND is_deleted = 0'\r\n    ).bind(faqId).first();\r\n    \r\n    if (!existing) {\r\n      return new Response(JSON.stringify({\r\n        ok: false,\r\n        error: 'FAQ\u4E0D\u5B58\u5728'\r\n      }), {\r\n        status: 404,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      });\r\n    }\r\n    \r\n    // \u8F6F\u5220\u9664\r\n    await env.DATABASE.prepare(`\r\n      UPDATE InternalFAQ\r\n      SET is_deleted = 1, updated_at = ?\r\n      WHERE faq_id = ?\r\n    `).bind(new Date().toISOString(), faqId).run();\r\n    \r\n    return new Response(JSON.stringify({\r\n      ok: true,\r\n      message: 'FAQ\u5DF2\u5220\u9664'\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n    \r\n  } catch (err) {\r\n    console.error('\u5220\u9664FAQ\u5931\u8D25:', err);\r\n    return new Response(JSON.stringify({\r\n      ok: false,\r\n      error: '\u5220\u9664FAQ\u5931\u8D25'\r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n}\r\n\r\n", "/**\n * \u5185\u90E8\u6587\u6863\u8D44\u6E90\u4E2D\u5FC3 API\n * \u63D0\u4F9B\u6587\u6863\u4E0A\u4F20\u3001\u5217\u8868\u3001\u5220\u9664\u529F\u80FD\n */\n\nimport { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\n\nexport async function handleDocumentsRequest(request, env, ctx, pathname, me) {\n  const corsHeaders = getCorsHeadersForRequest(request, env);\n  const method = request.method;\n  \n  // GET /internal/api/v1/documents - \u83B7\u53D6\u6587\u6863\u5217\u8868\n  if (method === 'GET' && pathname === '/internal/api/v1/documents') {\n    return await getDocumentsList(request, env, me, corsHeaders);\n  }\n  \n  // GET /internal/api/v1/documents/:id - \u83B7\u53D6\u5355\u4E2A\u6587\u6863\u8BE6\u60C5\n  if (method === 'GET' && pathname.match(/^\\/internal\\/api\\/v1\\/documents\\/\\d+$/)) {\n    const docId = parseInt(pathname.split('/').pop());\n    return await getDocumentById(env, docId, me, corsHeaders);\n  }\n  \n  // GET /internal/api/v1/documents/:id/download - \u4E0B\u8F7D\u6587\u6863\n  if (method === 'GET' && pathname.match(/^\\/internal\\/api\\/v1\\/documents\\/\\d+\\/download$/)) {\n    const docId = parseInt(pathname.split('/').slice(-2)[0]);\n    return await downloadDocument(env, docId, me, corsHeaders);\n  }\n  \n  // POST /internal/api/v1/documents/upload - \u4E0A\u4F20\u6587\u6863\uFF08\u4E00\u6B65\u5B8C\u6210\uFF09\n  if (method === 'POST' && pathname === '/internal/api/v1/documents/upload') {\n    return await uploadDocument(request, env, me, corsHeaders);\n  }\n  \n  // POST /internal/api/v1/documents - \u521B\u5EFA\u6587\u6863\u8BB0\u5F55\uFF08\u4E0A\u4F20\u540E\uFF09\n  if (method === 'POST' && pathname === '/internal/api/v1/documents') {\n    return await createDocument(request, env, me, corsHeaders);\n  }\n  \n  // PUT /internal/api/v1/documents/:id - \u66F4\u65B0\u6587\u6863\u4FE1\u606F\n  if (method === 'PUT' && pathname.match(/^\\/internal\\/api\\/v1\\/documents\\/\\d+$/)) {\n    const docId = parseInt(pathname.split('/').pop());\n    return await updateDocument(request, env, docId, me, corsHeaders);\n  }\n  \n  // DELETE /internal/api/v1/documents/:id - \u5220\u9664\u6587\u6863\n  if (method === 'DELETE' && pathname.match(/^\\/internal\\/api\\/v1\\/documents\\/\\d+$/)) {\n    const docId = parseInt(pathname.split('/').pop());\n    return await deleteDocument(env, docId, me, corsHeaders);\n  }\n  \n  return null;\n}\n\n// \u83B7\u53D6\u6587\u6863\u5217\u8868\nasync function getDocumentsList(request, env, me, corsHeaders) {\n  try {\n    const url = new URL(request.url);\n    const page = parseInt(url.searchParams.get('page')) || 1;\n    const perPage = parseInt(url.searchParams.get('perPage')) || 20;\n    const q = url.searchParams.get('q') || '';\n    const category = url.searchParams.get('category') || '';\n    const scope = url.searchParams.get('scope') || '';\n    const clientId = url.searchParams.get('client_id') || '';\n    const year = url.searchParams.get('year') || '';\n    const month = url.searchParams.get('month') || '';\n    const tags = url.searchParams.get('tags') || '';\n    \n    const offset = (page - 1) * perPage;\n    \n    // \u6784\u5EFA\u67E5\u8BE2\u6761\u4EF6\n    let whereClauses = ['d.is_deleted = 0'];\n    const params = [];\n    \n    if (q) {\n      whereClauses.push('(d.title LIKE ? OR d.description LIKE ? OR d.file_name LIKE ?)');\n      params.push(`%${q}%`, `%${q}%`, `%${q}%`);\n    }\n    \n    if (category && category !== 'all') {\n      whereClauses.push('d.category = ?');\n      params.push(category);\n    }\n    \n    if (scope && (scope === 'service' || scope === 'task')) {\n      whereClauses.push('d.scope = ?');\n      params.push(scope);\n    }\n    \n    if (clientId && clientId !== 'all') {\n      whereClauses.push('d.client_id = ?');\n      params.push(parseInt(clientId));\n    }\n    \n    if (year && year !== 'all') {\n      whereClauses.push('d.doc_year = ?');\n      params.push(parseInt(year));\n    }\n    \n    if (month && month !== 'all') {\n      whereClauses.push('d.doc_month = ?');\n      params.push(parseInt(month));\n    }\n    \n    if (tags) {\n      const tagList = tags.split(',').map(t => t.trim()).filter(Boolean);\n      tagList.forEach(tag => {\n        whereClauses.push('d.tags LIKE ?');\n        params.push(`%${tag}%`);\n      });\n    }\n    \n    const whereSQL = whereClauses.length > 0 ? 'WHERE ' + whereClauses.join(' AND ') : '';\n    \n    // \u67E5\u8BE2\u603B\u6570\n    const countSQL = `SELECT COUNT(*) as total FROM InternalDocuments d ${whereSQL}`;\n    const countResult = await env.DATABASE.prepare(countSQL).bind(...params).first();\n    const total = countResult?.total || 0;\n    \n    // \u67E5\u8BE2\u6570\u636E\n    const dataSQL = `\n      SELECT \n        d.document_id,\n        d.title,\n        d.description,\n        d.file_name,\n        d.file_url,\n        d.file_size,\n        d.file_type,\n        d.category,\n        d.scope,\n        d.client_id,\n        d.doc_year,\n        d.doc_month,\n        d.task_id,\n        d.tags,\n        d.uploaded_by,\n        d.created_at,\n        d.updated_at,\n        COALESCE(u.username, u.name, '\u672A\u77E5') as uploader_name\n      FROM InternalDocuments d\n      LEFT JOIN Users u ON d.uploaded_by = u.user_id\n      ${whereSQL}\n      ORDER BY d.created_at DESC\n      LIMIT ? OFFSET ?\n    `;\n    \n    const results = await env.DATABASE.prepare(dataSQL)\n      .bind(...params, perPage, offset)\n      .all();\n    \n    const documents = (results.results || []).map(row => ({\n      document_id: row.document_id,\n      title: row.title,\n      description: row.description,\n      fileName: row.file_name,\n      fileUrl: row.file_url,\n      fileSize: row.file_size,\n      fileType: row.file_type,\n      category: row.category,\n      scope: row.scope || null,\n      clientId: row.client_id || null,\n      docYear: row.doc_year || null,\n      docMonth: row.doc_month || null,\n      taskId: row.task_id || null,\n      tags: row.tags ? row.tags.split(',').map(t => t.trim()) : [],\n      uploadedBy: row.uploaded_by,\n      uploaderName: row.uploader_name,\n      createdAt: row.created_at,\n      updatedAt: row.updated_at\n    }));\n    \n    return new Response(JSON.stringify({\n      ok: true,\n      code: 'OK',\n      message: '\u6210\u529F',\n      data: documents,\n      meta: { total, page, perPage, requestId: 'doc-list' }\n    }), {\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\n    });\n    \n  } catch (err) {\n    console.error('\u83B7\u53D6\u6587\u6863\u5217\u8868\u5931\u8D25:', err);\n    console.error('\u9519\u8BEF\u8BE6\u60C5:', err.message, err.stack);\n    return new Response(JSON.stringify({\n      ok: false,\n      code: 'INTERNAL_ERROR',\n      message: '\u4F3A\u670D\u5668\u932F\u8AA4',\n      error: err.message || String(err),\n      stack: err.stack || '',\n      meta: { requestId: 'doc-list' }\n    }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\n    });\n  }\n}\n\n// \u83B7\u53D6\u5355\u4E2A\u6587\u6863\u8BE6\u60C5\nasync function getDocumentById(env, docId, me, corsHeaders) {\n  try {\n    const result = await env.DATABASE.prepare(`\n      SELECT \n        d.document_id,\n        d.title,\n        d.description,\n        d.file_name,\n        d.file_url,\n        d.file_size,\n        d.file_type,\n        d.category,\n        d.client_id,\n        d.doc_year,\n        d.doc_month,\n        d.task_id,\n        d.tags,\n        d.uploaded_by,\n        d.created_at,\n        d.updated_at,\n        COALESCE(u.username, u.name, '\u672A\u77E5') as uploader_name\n      FROM InternalDocuments d\n      LEFT JOIN Users u ON d.uploaded_by = u.user_id\n      WHERE d.document_id = ? AND d.is_deleted = 0\n    `).bind(docId).first();\n    \n    if (!result) {\n      return new Response(JSON.stringify({\n        ok: false,\n        error: '\u6587\u6863\u4E0D\u5B58\u5728'\n      }), {\n        status: 404,\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\n      });\n    }\n    \n    const document = {\n      document_id: result.document_id,\n      title: result.title,\n      description: result.description,\n      fileName: result.file_name,\n      fileUrl: result.file_url,\n      fileSize: result.file_size,\n      fileType: result.file_type,\n      category: result.category,\n      clientId: result.client_id || null,\n      docYear: result.doc_year || null,\n      docMonth: result.doc_month || null,\n      taskId: result.task_id || null,\n      tags: result.tags ? result.tags.split(',').map(t => t.trim()) : [],\n      uploadedBy: result.uploaded_by,\n      uploaderName: result.uploader_name,\n      createdAt: result.created_at,\n      updatedAt: result.updated_at\n    };\n    \n    return new Response(JSON.stringify({\n      ok: true,\n      data: document\n    }), {\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\n    });\n    \n  } catch (err) {\n    console.error('\u83B7\u53D6\u6587\u6863\u8BE6\u60C5\u5931\u8D25:', err);\n    return new Response(JSON.stringify({\n      ok: false,\n      error: '\u83B7\u53D6\u6587\u6863\u8BE6\u60C5\u5931\u8D25'\n    }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\n    });\n  }\n}\n\n// \u4E0B\u8F7D\u6587\u6863\nasync function downloadDocument(env, docId, me, corsHeaders) {\n  try {\n    // \u83B7\u53D6\u6587\u6863\u4FE1\u606F\n    const doc = await env.DATABASE.prepare(`\n      SELECT file_url, file_name, file_type\n      FROM InternalDocuments\n      WHERE document_id = ? AND is_deleted = 0\n    `).bind(docId).first();\n    \n    if (!doc) {\n      return new Response(JSON.stringify({\n        ok: false,\n        error: '\u6587\u6863\u4E0D\u5B58\u5728'\n      }), {\n        status: 404,\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\n      });\n    }\n    \n    // \u4ECE R2 \u83B7\u53D6\u6587\u4EF6\n    if (!env.R2_BUCKET) {\n      return new Response(JSON.stringify({\n        ok: false,\n        error: 'R2 \u672A\u914D\u7F6E'\n      }), {\n        status: 500,\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\n      });\n    }\n    \n    const object = await env.R2_BUCKET.get(doc.file_url);\n    \n    if (!object) {\n      return new Response(JSON.stringify({\n        ok: false,\n        error: '\u6587\u4EF6\u4E0D\u5B58\u5728\u65BC\u5B58\u5132\u4E2D'\n      }), {\n        status: 404,\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\n      });\n    }\n    \n    // \u8FD4\u56DE\u6587\u4EF6\n    return new Response(object.body, {\n      headers: {\n        'Content-Type': doc.file_type || 'application/octet-stream',\n        'Content-Disposition': `inline; filename=\"${doc.file_name || 'document'}\"`,\n        'Cache-Control': 'private, max-age=3600',\n        ...corsHeaders\n      }\n    });\n    \n  } catch (err) {\n    console.error('\u4E0B\u8F7D\u6587\u6863\u5931\u8D25:', err);\n    return new Response(JSON.stringify({\n      ok: false,\n      error: '\u4E0B\u8F7D\u6587\u6863\u5931\u8D25'\n    }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\n    });\n  }\n}\n\n// \u4E0A\u4F20\u6587\u6863\uFF08\u4E00\u6B65\u5B8C\u6210\uFF1A\u4E0A\u4F20\u5230R2 + \u521B\u5EFADB\u8BB0\u5F55\uFF09\nasync function uploadDocument(request, env, me, corsHeaders) {\n  try {\n    const formData = await request.formData();\n    const file = formData.get('file');\n    const title = formData.get('title');\n    const description = formData.get('description') || '';\n    const category = formData.get('category') || '';\n    const scope = formData.get('scope') || '';\n    const clientId = formData.get('client_id') || '';\n    const docYear = formData.get('doc_year') || '';\n    const docMonth = formData.get('doc_month') || '';\n    const taskId = formData.get('task_id') || '';\n    const tags = formData.get('tags') || '';\n    \n    // \u9A8C\u8BC1\u5FC5\u586B\u5B57\u6BB5\n    if (!file || !title) {\n      return new Response(JSON.stringify({\n        ok: false,\n        error: '\u6587\u4EF6\u548C\u6807\u9898\u4E3A\u5FC5\u586B\u9879'\n      }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\n      });\n    }\n    \n    if (!scope || (scope !== 'service' && scope !== 'task')) {\n      return new Response(JSON.stringify({\n        ok: false,\n        error: '\u5FC5\u9808\u6307\u5B9A\u8CC7\u6E90\u9069\u7528\u5C64\u7D1A\uFF08service\u6216task\uFF09'\n      }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\n      });\n    }\n    \n    // \u9A8C\u8BC1\u6587\u4EF6\u5927\u5C0F\uFF08\u6700\u5927 10MB\uFF09\n    if (file.size > 10 * 1024 * 1024) {\n      return new Response(JSON.stringify({\n        ok: false,\n        error: '\u6587\u4EF6\u5927\u5C0F\u4E0D\u80FD\u8D85\u8FC7 10MB'\n      }), {\n        status: 413,\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\n      });\n    }\n    \n    // \u751F\u6210 R2 \u5BF9\u8C61\u952E\n    const now = Date.now();\n    const envName = String(env.APP_ENV || 'dev');\n    const ext = file.name.split('.').pop() || 'bin';\n    const objectKey = `private/${envName}/documents/${now}_${file.name}`;\n    \n    // \u4E0A\u4F20\u5230 R2\n    if (!env.R2_BUCKET) {\n      return new Response(JSON.stringify({\n        ok: false,\n        error: 'R2 \u672A\u914D\u7F6E'\n      }), {\n        status: 500,\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\n      });\n    }\n    \n    await env.R2_BUCKET.put(objectKey, file.stream(), {\n      httpMetadata: {\n        contentType: file.type,\n        contentDisposition: `attachment; filename=\"${file.name}\"`\n      },\n      customMetadata: {\n        ownerId: String(me.user_id),\n        module: 'documents'\n      }\n    });\n    \n    // \u521B\u5EFA\u6570\u636E\u5E93\u8BB0\u5F55\n    const tagsStr = tags;\n    const nowISO = new Date().toISOString();\n    \n    const result = await env.DATABASE.prepare(`\n      INSERT INTO InternalDocuments (\n        title,\n        description,\n        file_name,\n        file_url,\n        file_size,\n        file_type,\n        category,\n        scope,\n        client_id,\n        doc_year,\n        doc_month,\n        task_id,\n        tags,\n        uploaded_by,\n        created_at,\n        updated_at,\n        is_deleted\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0)\n    `).bind(\n      title,\n      description || null,\n      file.name,\n      objectKey,\n      file.size,\n      file.type,\n      category || null,\n      scope,\n      clientId ? parseInt(clientId) : null,\n      docYear ? parseInt(docYear) : null,\n      docMonth ? parseInt(docMonth) : null,\n      taskId ? parseInt(taskId) : null,\n      tagsStr,\n      me?.user_id || null,\n      nowISO,\n      nowISO\n    ).run();\n    \n    return new Response(JSON.stringify({\n      ok: true,\n      data: {\n        document_id: result.meta.last_row_id,\n        title,\n        description,\n        fileName: file.name,\n        fileUrl: objectKey,\n        fileSize: file.size,\n        fileType: file.type,\n        category,\n        scope,\n        clientId: clientId ? parseInt(clientId) : null,\n        docYear: docYear ? parseInt(docYear) : null,\n        docMonth: docMonth ? parseInt(docMonth) : null,\n        taskId: taskId ? parseInt(taskId) : null,\n        tags: tagsStr ? tagsStr.split(',').map(t => t.trim()) : [],\n        uploadedBy: me?.user_id,\n        createdAt: nowISO,\n        updatedAt: nowISO\n      }\n    }), {\n      status: 201,\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\n    });\n    \n  } catch (err) {\n    console.error('\u4E0A\u4F20\u6587\u6863\u5931\u8D25:', err);\n    console.error('\u9519\u8BEF\u8BE6\u60C5:', err.message, err.stack);\n    return new Response(JSON.stringify({\n      ok: false,\n      error: '\u4E0A\u4F20\u6587\u6863\u5931\u8D25\uFF1A' + (err.message || String(err))\n    }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\n    });\n  }\n}\n\n// \u521B\u5EFA\u6587\u6863\u8BB0\u5F55\nasync function createDocument(request, env, me, corsHeaders) {\n  try {\n    const body = await request.json();\n    const { title, description, file_name, file_url, file_size, file_type, category, scope, client_id, doc_year, doc_month, task_id, tags } = body;\n    \n    // \u9A8C\u8BC1\u5FC5\u586B\u5B57\u6BB5\n    if (!title || !file_name || !file_url) {\n      return new Response(JSON.stringify({\n        ok: false,\n        error: '\u6807\u9898\u3001\u6587\u4EF6\u540D\u548C\u6587\u4EF6URL\u4E3A\u5FC5\u586B\u9879'\n      }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\n      });\n    }\n    \n    if (!scope || (scope !== 'service' && scope !== 'task')) {\n      return new Response(JSON.stringify({\n        ok: false,\n        error: '\u5FC5\u9808\u6307\u5B9A\u8CC7\u6E90\u9069\u7528\u5C64\u7D1A\uFF08service\u6216task\uFF09'\n      }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\n      });\n    }\n    \n    const tagsStr = Array.isArray(tags) ? tags.join(',') : (tags || '');\n    const now = new Date().toISOString();\n    \n    const result = await env.DATABASE.prepare(`\n      INSERT INTO InternalDocuments (\n        title,\n        description,\n        file_name,\n        file_url,\n        file_size,\n        file_type,\n        category,\n        scope,\n        client_id,\n        doc_year,\n        doc_month,\n        task_id,\n        tags,\n        uploaded_by,\n        created_at,\n        updated_at,\n        is_deleted\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0)\n    `).bind(\n      title,\n      description || null,\n      file_name,\n      file_url,\n      file_size || null,\n      file_type || null,\n      category || null,\n      scope,\n      client_id || null,\n      doc_year || null,\n      doc_month || null,\n      task_id || null,\n      tagsStr,\n      me?.user_id || null,\n      now,\n      now\n    ).run();\n    \n    return new Response(JSON.stringify({\n      ok: true,\n      data: {\n        document_id: result.meta.last_row_id,\n        title,\n        description,\n        fileName: file_name,\n        fileUrl: file_url,\n        fileSize: file_size,\n        fileType: file_type,\n        category,\n        scope,\n        clientId: client_id || null,\n        docYear: doc_year || null,\n        docMonth: doc_month || null,\n        taskId: task_id || null,\n        tags: tagsStr ? tagsStr.split(',').map(t => t.trim()) : [],\n        uploadedBy: me?.user_id,\n        createdAt: now,\n        updatedAt: now\n      }\n    }), {\n      status: 201,\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\n    });\n    \n  } catch (err) {\n    console.error('\u521B\u5EFA\u6587\u6863\u8BB0\u5F55\u5931\u8D25:', err);\n    return new Response(JSON.stringify({\n      ok: false,\n      error: '\u521B\u5EFA\u6587\u6863\u8BB0\u5F55\u5931\u8D25'\n    }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\n    });\n  }\n}\n\n// \u66F4\u65B0\u6587\u6863\u4FE1\u606F\nasync function updateDocument(request, env, docId, me, corsHeaders) {\n  try {\n    const body = await request.json();\n    const { title, description, category, scope, client_id, doc_year, doc_month, task_id, tags } = body;\n    \n    // \u9A8C\u8BC1\u6587\u6863\u662F\u5426\u5B58\u5728\n    const existing = await env.DATABASE.prepare(\n      'SELECT document_id FROM InternalDocuments WHERE document_id = ? AND is_deleted = 0'\n    ).bind(docId).first();\n    \n    if (!existing) {\n      return new Response(JSON.stringify({\n        ok: false,\n        error: '\u6587\u6863\u4E0D\u5B58\u5728'\n      }), {\n        status: 404,\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\n      });\n    }\n    \n    // \u9A8C\u8BC1\u5FC5\u586B\u5B57\u6BB5\n    if (!title) {\n      return new Response(JSON.stringify({\n        ok: false,\n        error: '\u6807\u9898\u4E3A\u5FC5\u586B\u9879'\n      }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\n      });\n    }\n    \n    if (!scope || (scope !== 'service' && scope !== 'task')) {\n      return new Response(JSON.stringify({\n        ok: false,\n        error: '\u5FC5\u9808\u6307\u5B9A\u8CC7\u6E90\u9069\u7528\u5C64\u7D1A\uFF08service\u6216task\uFF09'\n      }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\n      });\n    }\n    \n    const tagsStr = Array.isArray(tags) ? tags.join(',') : (tags || '');\n    const now = new Date().toISOString();\n    \n    await env.DATABASE.prepare(`\n      UPDATE InternalDocuments\n      SET \n        title = ?,\n        description = ?,\n        category = ?,\n        scope = ?,\n        client_id = ?,\n        doc_year = ?,\n        doc_month = ?,\n        task_id = ?,\n        tags = ?,\n        updated_at = ?\n      WHERE document_id = ? AND is_deleted = 0\n    `).bind(\n      title,\n      description || null,\n      category || null,\n      scope,\n      client_id || null,\n      doc_year || null,\n      doc_month || null,\n      task_id || null,\n      tagsStr,\n      now,\n      docId\n    ).run();\n    \n    return new Response(JSON.stringify({\n      ok: true,\n      data: {\n        document_id: docId,\n        title,\n        description,\n        category,\n        scope,\n        clientId: client_id || null,\n        docYear: doc_year || null,\n        docMonth: doc_month || null,\n        taskId: task_id || null,\n        tags: tagsStr ? tagsStr.split(',').map(t => t.trim()) : [],\n        updatedAt: now\n      }\n    }), {\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\n    });\n    \n  } catch (err) {\n    console.error('\u66F4\u65B0\u6587\u6863\u4FE1\u606F\u5931\u8D25:', err);\n    return new Response(JSON.stringify({\n      ok: false,\n      error: '\u66F4\u65B0\u6587\u6863\u4FE1\u606F\u5931\u8D25'\n    }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\n    });\n  }\n}\n\n// \u5220\u9664\u6587\u6863\nasync function deleteDocument(env, docId, me, corsHeaders) {\n  try {\n    // \u9A8C\u8BC1\u6587\u6863\u662F\u5426\u5B58\u5728\n    const existing = await env.DATABASE.prepare(\n      'SELECT document_id, file_url FROM InternalDocuments WHERE document_id = ? AND is_deleted = 0'\n    ).bind(docId).first();\n    \n    if (!existing) {\n      return new Response(JSON.stringify({\n        ok: false,\n        error: '\u6587\u6863\u4E0D\u5B58\u5728'\n      }), {\n        status: 404,\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\n      });\n    }\n    \n    // \u8F6F\u5220\u9664\n    await env.DATABASE.prepare(`\n      UPDATE InternalDocuments\n      SET is_deleted = 1, updated_at = ?\n      WHERE document_id = ?\n    `).bind(new Date().toISOString(), docId).run();\n    \n    // TODO: \u53EF\u9009\uFF1A\u4ECER2\u5220\u9664\u5B9E\u9645\u6587\u4EF6\n    // if (existing.file_url && env.R2_BUCKET) {\n    //   const key = existing.file_url.split('/').pop();\n    //   await env.R2_BUCKET.delete(key);\n    // }\n    \n    return new Response(JSON.stringify({\n      ok: true,\n      message: '\u6587\u6863\u5DF2\u5220\u9664'\n    }), {\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\n    });\n    \n  } catch (err) {\n    console.error('\u5220\u9664\u6587\u6863\u5931\u8D25:', err);\n    return new Response(JSON.stringify({\n      ok: false,\n      error: '\u5220\u9664\u6587\u6863\u5931\u8D25'\n    }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\n    });\n  }\n}\n\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nfunction parseId(s) {\r\n  const n = parseInt(String(s || \"\"), 10);\r\n  return Number.isFinite(n) && n > 0 ? n : null;\r\n}\r\n\r\nfunction todayStr() {\r\n  const d = new Date();\r\n  const y = d.getUTCFullYear();\r\n  const m = String(d.getUTCMonth() + 1).padStart(2, '0');\r\n  const day = String(d.getUTCDate()).padStart(2, '0');\r\n  return `${y}-${m}-${day}`;\r\n}\r\n\r\nfunction isValidYmd(s) { return /^\\d{4}-\\d{2}-\\d{2}$/.test(String(s || \"\")); }\r\n\r\nexport async function handleClientServices(request, env, me, requestId, url, path) {\r\n  const corsHeaders = getCorsHeadersForRequest(request, env);\r\n  const method = request.method.toUpperCase();\r\n\r\n  // POST /internal/api/v1/client-services - \u521B\u5EFA\u5BA2\u6237\u670D\u52A1\u5173\u7CFB\r\n  if (path === \"/internal/api/v1/client-services\" && method === \"POST\") {\r\n    let body;\r\n    try { body = await request.json(); } catch (_) {\r\n      return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n    \r\n    const clientId = String(body?.client_id || \"\").trim();\r\n    const serviceId = parseInt(body?.service_id, 10);\r\n    const status = String(body?.status || \"active\").trim();\r\n    \r\n    if (!clientId) {\r\n      return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u5BA2\u6236ID\u5FC5\u586B\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n    if (!Number.isFinite(serviceId) || serviceId <= 0) {\r\n      return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u670D\u52D9ID\u7121\u6548\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n    \r\n    try {\r\n      // \u6AA2\u67E5\u5BA2\u6236\u662F\u5426\u5B58\u5728\r\n      const client = await env.DATABASE.prepare(\"SELECT 1 FROM Clients WHERE client_id = ? AND is_deleted = 0\").bind(clientId).first();\r\n      if (!client) {\r\n        return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u5BA2\u6236\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n      }\r\n      \r\n      // \u6AA2\u67E5\u670D\u52D9\u662F\u5426\u5B58\u5728\r\n      const service = await env.DATABASE.prepare(\"SELECT 1 FROM Services WHERE service_id = ? AND is_active = 1\").bind(serviceId).first();\r\n      if (!service) {\r\n        return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u670D\u52D9\u985E\u578B\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n      }\r\n      \r\n      // \u6AA2\u67E5\u662F\u5426\u5DF2\u5B58\u5728\r\n      const existing = await env.DATABASE.prepare(\r\n        \"SELECT client_service_id FROM ClientServices WHERE client_id = ? AND service_id = ? AND is_deleted = 0\"\r\n      ).bind(clientId, serviceId).first();\r\n      \r\n      if (existing) {\r\n        return jsonResponse(200, { \r\n          ok:true, \r\n          code:\"EXISTS\", \r\n          message:\"\u5BA2\u6236\u670D\u52D9\u95DC\u4FC2\u5DF2\u5B58\u5728\", \r\n          data:{ client_service_id: existing.client_service_id },\r\n          meta:{ requestId } \r\n        }, corsHeaders);\r\n      }\r\n      \r\n      // \u5275\u5EFA\u65B0\u95DC\u4FC2\r\n      const result = await env.DATABASE.prepare(`\r\n        INSERT INTO ClientServices (client_id, service_id, status, created_at)\r\n        VALUES (?, ?, ?, datetime('now'))\r\n      `).bind(clientId, serviceId, status).run();\r\n      \r\n      const clientServiceId = result.meta.last_row_id;\r\n      \r\n      return jsonResponse(201, {\r\n        ok:true,\r\n        code:\"CREATED\",\r\n        message:\"\u5DF2\u5EFA\u7ACB\u5BA2\u6236\u670D\u52D9\u95DC\u4FC2\",\r\n        data:{ client_service_id: clientServiceId },\r\n        meta:{ requestId }\r\n      }, corsHeaders);\r\n      \r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n  \r\n  // GET list: /internal/api/v1/client-services?status=active&q=...\r\n  if (path === \"/internal/api/v1/client-services\" && method === \"GET\") {\r\n    try {\r\n      const p = url.searchParams;\r\n      const status = (p.get(\"status\") || \"all\").trim();\r\n      const q = (p.get(\"q\") || \"\").trim();\r\n      const page = Math.max(1, parseInt(p.get(\"page\") || \"1\", 10));\r\n      const perPage = Math.min(100, Math.max(1, parseInt(p.get(\"perPage\") || \"12\", 10)));\r\n      const offset = (page - 1) * perPage;\r\n      const where = [\"cs.is_deleted = 0\"]; const binds = [];\r\n      if ([\"active\",\"suspended\",\"expired\",\"cancelled\"].includes(status)) { where.push(\"cs.status = ?\"); binds.push(status); }\r\n      if (q) { where.push(\"(c.company_name LIKE ?)\"); binds.push(`%${q}%`); }\r\n      const whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n      const totalRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM ClientServices cs LEFT JOIN Clients c ON c.client_id = cs.client_id ${whereSql}`).bind(...binds).first();\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT cs.client_service_id, cs.client_id, cs.service_id, cs.status, cs.suspension_effective_date, \r\n                c.company_name, s.service_name\r\n         FROM ClientServices cs \r\n         LEFT JOIN Clients c ON c.client_id = cs.client_id\r\n         LEFT JOIN Services s ON s.service_id = cs.service_id\r\n         ${whereSql}\r\n         ORDER BY cs.client_service_id DESC\r\n         LIMIT ? OFFSET ?`\r\n      ).bind(...binds, perPage, offset).all();\r\n      const data = (rows?.results || []).map(r => ({\r\n        client_service_id: r.client_service_id,\r\n        client_id: r.client_id,\r\n        client_name: r.company_name || r.client_id,\r\n        service_id: r.service_id || null,\r\n        service_name: r.service_name || null,\r\n        status: r.status,\r\n        suspension_effective_date: r.suspension_effective_date || null,\r\n      }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, page, perPage, total: Number(totalRow?.total || 0) } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // POST suspend/resume/cancel\r\n  const suspendMatch = path.match(/^\\/internal\\/api\\/v1\\/client-services\\/(\\d+)\\/suspend$/);\r\n  const resumeMatch = path.match(/^\\/internal\\/api\\/v1\\/client-services\\/(\\d+)\\/resume$/);\r\n  const cancelMatch = path.match(/^\\/internal\\/api\\/v1\\/client-services\\/(\\d+)\\/cancel$/);\r\n  const historyMatch = path.match(/^\\/internal\\/api\\/v1\\/client-services\\/(\\d+)\\/history$/);\r\n\r\n  // Suspend\r\n  if (suspendMatch) {\r\n    if (method !== \"POST\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n    let body; try { body = await request.json(); } catch (_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n    const id = parseId(suspendMatch[1]);\r\n    const reason = String(body?.reason || \"\").trim();\r\n    const notes = String(body?.notes || \"\").trim();\r\n    const effective = String(body?.effective_date || \"\").trim();\r\n    if (!id) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u670D\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n    if (!isValidYmd(effective)) return jsonResponse(400, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u65E5\u671F\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    if (!reason) return jsonResponse(400, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u539F\u56E0\u5FC5\u586B\", meta:{ requestId } }, corsHeaders);\r\n    try {\r\n      const svc = await env.DATABASE.prepare(\"SELECT client_service_id, status, suspension_effective_date FROM ClientServices WHERE client_service_id = ? AND is_deleted = 0\").bind(id).first();\r\n      if (!svc) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u670D\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n      if (svc.status !== 'active') return jsonResponse(400, { ok:false, code:\"INVALID_STATE\", message:\"\u76EE\u524D\u72C0\u614B\u4E0D\u5141\u8A31\u6B64\u64CD\u4F5C\", meta:{ requestId } }, corsHeaders);\r\n      if (svc.suspension_effective_date && svc.suspension_effective_date > todayStr()) return jsonResponse(400, { ok:false, code:\"ALREADY_SCHEDULED\", message:\"\u5DF2\u6709\u672A\u4F86\u6392\u7A0B\uFF0C\u4E0D\u53EF\u91CD\u8907\u6392\u7A0B\", meta:{ requestId } }, corsHeaders);\r\n      const nowIso = new Date().toISOString();\r\n      if (effective <= todayStr()) {\r\n        await env.DATABASE.prepare(\"UPDATE ClientServices SET status='suspended', suspended_at = ?, suspension_reason = ?, suspension_effective_date = NULL WHERE client_service_id = ?\").bind(nowIso, reason, id).run();\r\n        await env.DATABASE.prepare(\"INSERT INTO ServiceChangeHistory (client_service_id, old_status, new_status, changed_by, reason, notes) VALUES (?, 'active', 'suspended', ?, ?, ?)\").bind(id, String(me.user_id), reason, notes).run();\r\n        return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u670D\u52D9\u5DF2\u66AB\u505C\", data:{ client_service_id: id, status:'suspended', suspended_at: nowIso } }, corsHeaders);\r\n      }\r\n      await env.DATABASE.prepare(\"UPDATE ClientServices SET suspension_effective_date = ?, suspension_reason = ? WHERE client_service_id = ?\").bind(effective, reason, id).run();\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:`\u5DF2\u6392\u7A0B\u65BC ${effective} \u66AB\u505C`, data:{ client_service_id: id, status:'active', suspension_effective_date: effective } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // Resume\r\n  if (resumeMatch) {\r\n    if (method !== \"POST\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n    let body; try { body = await request.json(); } catch (_) { body = {}; }\r\n    const id = parseId(resumeMatch[1]);\r\n    const notes = String(body?.notes || \"\").trim();\r\n    if (!id) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u670D\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n    try {\r\n      const svc = await env.DATABASE.prepare(\"SELECT client_service_id, status FROM ClientServices WHERE client_service_id = ? AND is_deleted = 0\").bind(id).first();\r\n      if (!svc) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u670D\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n      if (svc.status !== 'suspended') return jsonResponse(400, { ok:false, code:\"INVALID_STATE\", message:\"\u76EE\u524D\u72C0\u614B\u4E0D\u5141\u8A31\u6B64\u64CD\u4F5C\", meta:{ requestId } }, corsHeaders);\r\n      const nowIso = new Date().toISOString();\r\n      await env.DATABASE.prepare(\"UPDATE ClientServices SET status='active', resumed_at = ?, suspended_at = NULL, suspension_reason = NULL, suspension_effective_date = NULL WHERE client_service_id = ?\").bind(nowIso, id).run();\r\n      await env.DATABASE.prepare(\"INSERT INTO ServiceChangeHistory (client_service_id, old_status, new_status, changed_by, reason, notes) VALUES (?, 'suspended', 'active', ?, '', ?)\").bind(id, String(me.user_id), notes).run();\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u670D\u52D9\u5DF2\u6062\u5FA9\", data:{ client_service_id: id, status:'active', resumed_at: nowIso } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // Cancel\r\n  if (cancelMatch) {\r\n    if (method !== \"POST\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n    if (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\r\n    let body; try { body = await request.json(); } catch (_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n    const id = parseId(cancelMatch[1]);\r\n    const reason = String(body?.reason || \"\").trim();\r\n    const cancelTasks = Boolean(body?.cancel_pending_tasks);\r\n    if (!id) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u670D\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n    if (!reason) return jsonResponse(400, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u53D6\u6D88\u539F\u56E0\u5FC5\u586B\", meta:{ requestId } }, corsHeaders);\r\n    try {\r\n      const svc = await env.DATABASE.prepare(\"SELECT client_service_id, status FROM ClientServices WHERE client_service_id = ? AND is_deleted = 0\").bind(id).first();\r\n      if (!svc) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u670D\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n      if (svc.status === 'cancelled') return jsonResponse(400, { ok:false, code:\"INVALID_STATE\", message:\"\u5DF2\u70BA\u53D6\u6D88\u72C0\u614B\", meta:{ requestId } }, corsHeaders);\r\n      const nowIso = new Date().toISOString();\r\n      await env.DATABASE.prepare(\"UPDATE ClientServices SET status='cancelled', cancelled_at = ?, cancelled_by = ? WHERE client_service_id = ?\").bind(nowIso, String(me.user_id), id).run();\r\n      await env.DATABASE.prepare(\"INSERT INTO ServiceChangeHistory (client_service_id, old_status, new_status, changed_by, reason, notes) VALUES (?, ?, 'cancelled', ?, ?, '')\").bind(id, svc.status, String(me.user_id), reason).run();\r\n      let tasksCancelled = false;\r\n      if (cancelTasks) {\r\n        await env.DATABASE.prepare(\"UPDATE ActiveTasks SET status='cancelled' WHERE client_service_id = ? AND status NOT IN ('completed','cancelled')\").bind(id).run();\r\n        tasksCancelled = true;\r\n      }\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u670D\u52D9\u5DF2\u53D6\u6D88\", data:{ client_service_id: id, status:'cancelled', tasks_cancelled: tasksCancelled } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // History\r\n  if (historyMatch) {\r\n    if (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n    const id = parseId(historyMatch[1]);\r\n    if (!id) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u670D\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n    try {\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT h.change_id, h.old_status, h.new_status, h.changed_by, u.name AS changed_by_name, h.changed_at, h.reason, h.notes\r\n         FROM ServiceChangeHistory h LEFT JOIN Users u ON u.user_id = h.changed_by\r\n         WHERE h.client_service_id = ?\r\n         ORDER BY h.changed_at DESC, h.change_id DESC`\r\n      ).bind(id).all();\r\n      const data = (rows?.results || []).map(r => ({ change_id: r.change_id, old_status: r.old_status, new_status: r.new_status, changed_by: r.changed_by_name || String(r.changed_by), changed_at: r.changed_at, reason: r.reason || '', notes: r.notes || '' }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, count: data.length } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nexport async function handleCMS(request, env, me, requestId, url, path) {\r\n  const corsHeaders = getCorsHeadersForRequest(request, env);\r\n  const method = request.method.toUpperCase();\r\n\r\n  // \u5168\u90E8\u7AEF\u9EDE\u7686\u8981\u6C42\u7BA1\u7406\u54E1\uFF1B\u4E0A\u5C64 router \u5DF2\u6AA2\u67E5\uFF0C\u4F46\u9019\u88E1\u518D\u4FDD\u96AA\r\n  if (!me?.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\r\n\r\n  // Articles list\r\n  if (path === \"/internal/api/v1/admin/articles\" && method === \"GET\") {\r\n    try {\r\n      const p = url.searchParams;\r\n      const status = (p.get(\"status\") || \"all\").trim();\r\n      const category = (p.get(\"category\") || \"\").trim();\r\n      const tag = (p.get(\"tag\") || \"\").trim();\r\n      const keyword = (p.get(\"keyword\") || p.get(\"q\") || \"\").trim();\r\n      const page = Math.max(1, parseInt(p.get(\"page\") || \"1\", 10));\r\n      const perPage = Math.min(100, Math.max(1, parseInt(p.get(\"perPage\") || \"20\", 10)));\r\n      const offset = (page - 1) * perPage;\r\n      const where = [\"is_deleted = 0\"]; const binds = [];\r\n      if (status === 'published') { where.push(\"is_published = 1\"); }\r\n      if (status === 'draft') { where.push(\"is_published = 0\"); }\r\n      if (category) { where.push(\"category = ?\"); binds.push(category); }\r\n      if (tag) { where.push(\"tags LIKE ?\"); binds.push(`%${tag}%`); }\r\n      if (keyword) { where.push(\"(title LIKE ? OR summary LIKE ?)\"); binds.push(`%${keyword}%`, `%${keyword}%`); }\r\n      const whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n      const totalRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM ExternalArticles ${whereSql}`).bind(...binds).first();\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT article_id, title, slug, category, tags, is_published, updated_at, view_count\r\n         FROM ExternalArticles\r\n         ${whereSql}\r\n         ORDER BY updated_at DESC, article_id DESC\r\n         LIMIT ? OFFSET ?`\r\n      ).bind(...binds, perPage, offset).all();\r\n      const data = (rows?.results || []).map(r => ({\r\n        id: r.article_id,\r\n        title: r.title,\r\n        slug: r.slug,\r\n        category: r.category || '',\r\n        tags: (()=>{ try { return JSON.parse(r.tags || '[]'); } catch(_) { return []; } })(),\r\n        isPublished: r.is_published === 1,\r\n        updatedAt: r.updated_at,\r\n        viewCount: Number(r.view_count || 0),\r\n      }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, page, perPage, total: Number(totalRow?.total || 0) } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // FAQ list\r\n  if (path === \"/internal/api/v1/admin/faq\" && method === \"GET\") {\r\n    try {\r\n      const p = url.searchParams;\r\n      const status = (p.get(\"status\") || \"all\").trim();\r\n      const category = (p.get(\"category\") || \"\").trim();\r\n      const keyword = (p.get(\"keyword\") || p.get(\"q\") || \"\").trim();\r\n      const page = Math.max(1, parseInt(p.get(\"page\") || \"1\", 10));\r\n      const perPage = Math.min(100, Math.max(1, parseInt(p.get(\"perPage\") || \"20\", 10)));\r\n      const offset = (page - 1) * perPage;\r\n      const where = [\"is_deleted = 0\"]; const binds = [];\r\n      if (status === 'published') where.push(\"is_published = 1\");\r\n      if (status === 'draft') where.push(\"is_published = 0\");\r\n      if (category) { where.push(\"category = ?\"); binds.push(category); }\r\n      if (keyword) { where.push(\"question LIKE ?\"); binds.push(`%${keyword}%`); }\r\n      const whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n      const totalRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM ExternalFAQ ${whereSql}`).bind(...binds).first();\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT faq_id, question, category, sort_order, is_published, updated_at\r\n         FROM ExternalFAQ\r\n         ${whereSql}\r\n         ORDER BY updated_at DESC, sort_order ASC, faq_id DESC\r\n         LIMIT ? OFFSET ?`\r\n      ).bind(...binds, perPage, offset).all();\r\n      const data = (rows?.results || []).map(r => ({\r\n        id: r.faq_id,\r\n        question: r.question,\r\n        category: r.category || '',\r\n        sortOrder: Number(r.sort_order || 0),\r\n        isPublished: r.is_published === 1,\r\n        updatedAt: r.updated_at,\r\n      }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, page, perPage, total: Number(totalRow?.total || 0) } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // Resources list\r\n  if (path === \"/internal/api/v1/admin/resources\" && method === \"GET\") {\r\n    try {\r\n      const p = url.searchParams;\r\n      const category = (p.get(\"category\") || \"\").trim();\r\n      const fileType = (p.get(\"file_type\") || p.get(\"type\") || \"\").trim();\r\n      const keyword = (p.get(\"keyword\") || p.get(\"q\") || \"\").trim();\r\n      const page = Math.max(1, parseInt(p.get(\"page\") || \"1\", 10));\r\n      const perPage = Math.min(100, Math.max(1, parseInt(p.get(\"perPage\") || \"20\", 10)));\r\n      const offset = (page - 1) * perPage;\r\n      const where = [\"is_deleted = 0\"]; const binds = [];\r\n      if (category) { where.push(\"category = ?\"); binds.push(category); }\r\n      if (fileType) { where.push(\"file_type = ?\"); binds.push(fileType); }\r\n      if (keyword) { where.push(\"title LIKE ?\"); binds.push(`%${keyword}%`); }\r\n      const whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n      const totalRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM ResourceCenter ${whereSql}`).bind(...binds).first();\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT resource_id, title, category, file_type, file_size, download_count, updated_at\r\n         FROM ResourceCenter\r\n         ${whereSql}\r\n         ORDER BY updated_at DESC, resource_id DESC\r\n         LIMIT ? OFFSET ?`\r\n      ).bind(...binds, perPage, offset).all();\r\n      const data = (rows?.results || []).map(r => ({\r\n        id: r.resource_id,\r\n        title: r.title,\r\n        category: r.category || '',\r\n        fileType: r.file_type || '',\r\n        fileSize: Number(r.file_size || 0),\r\n        downloadCount: Number(r.download_count || 0),\r\n        updatedAt: r.updated_at,\r\n      }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, page, perPage, total: Number(totalRow?.total || 0) } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // Services list (admin): return all services including unpublished\r\n  if (path === \"/internal/api/v1/admin/services\" && method === \"GET\") {\r\n    try {\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT service_id, service_key, title, is_published, sort_order, updated_at\r\n         FROM ExternalServices\r\n         WHERE is_deleted = 0\r\n         ORDER BY sort_order ASC, service_id ASC`\r\n      ).all();\r\n      const data = (rows?.results || []).map(r => ({\r\n        id: r.service_id,\r\n        key: r.service_key,\r\n        title: r.title,\r\n        isPublished: r.is_published === 1,\r\n        sortOrder: Number(r.sort_order || 0),\r\n        updatedAt: r.updated_at,\r\n      }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, count: data.length } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nconst DANGEROUS_KEYS = new Set([\"rule_comp_hours_expiry\"]);\r\nconst ALLOWED_KEYS = new Set([\r\n  \"company_name\",\r\n  \"contact_email\",\r\n  \"timezone\",\r\n  \"currency\",\r\n  \"timesheet_min_unit\",\r\n  \"soft_delete_enabled\",\r\n  \"workday_start\",\r\n  \"workday_end\",\r\n  \"report_locale\",\r\n  \"rule_comp_hours_expiry\",\r\n  \"attendance_bonus_amount\",\r\n  \"overhead_cost_per_hour\",\r\n  \"target_profit_margin\",\r\n]);\r\n\r\nfunction normalizeKey(key){\r\n  return String(key||\"\").trim();\r\n}\r\n\r\nexport async function handleSettings(request, env, me, requestId, url, path){\r\n  const corsHeaders = getCorsHeadersForRequest(request, env);\r\n  const method = request.method.toUpperCase();\r\n  \r\n  // GET /internal/api/v1/users - \u83B7\u53D6\u6240\u6709\u5458\u5DE5\u5217\u8868\uFF08\u6240\u6709\u767B\u5F55\u7528\u6237\u90FD\u53EF\u8BBF\u95EE\uFF09\r\n  if (path === \"/internal/api/v1/users\" && method === \"GET\"){\r\n    try {\r\n      const rows = await env.DATABASE.prepare(\r\n        \"SELECT user_id, username, name, is_admin FROM Users WHERE is_deleted = 0 ORDER BY user_id ASC\"\r\n      ).all();\r\n      const data = (rows?.results || []).map(r => ({\r\n        user_id: r.user_id,\r\n        username: r.username,\r\n        name: r.name || r.username,\r\n        is_admin: Boolean(r.is_admin)\r\n      }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n  \r\n  if (!me?.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\r\n\r\n  // GET all settings\r\n  if (path === \"/internal/api/v1/admin/settings\" && method === \"GET\"){\r\n    try {\r\n      const rows = await env.DATABASE.prepare(\r\n        \"SELECT setting_key AS key, setting_value AS value, is_dangerous AS isDangerous, description, updated_at AS updatedAt, updated_by AS updatedBy FROM Settings ORDER BY setting_key\"\r\n      ).all();\r\n      const map = {};\r\n      for (const r of (rows?.results||[])) map[r.key] = r.value;\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data:{ items: rows?.results||[], map }, meta:{ requestId } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // PUT update single setting: /internal/api/v1/admin/settings/:key\r\n  if (path.startsWith(\"/internal/api/v1/admin/settings/\") && method === \"PUT\"){\r\n    const key = normalizeKey(path.replace(\"/internal/api/v1/admin/settings/\", \"\"));\r\n    if (!ALLOWED_KEYS.has(key)) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u4E0D\u652F\u63F4\u7684\u8A2D\u5B9A\u9375\", meta:{ requestId } }, corsHeaders);\r\n    let payload;\r\n    try { payload = await request.json(); } catch(_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n    const value = String(payload?.value ?? \"\");\r\n    if (key === \"contact_email\" && value && !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(value)){\r\n      return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"Email \u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n    if (key === \"timesheet_min_unit\"){\r\n      const n = parseFloat(value);\r\n      if (!Number.isFinite(n) || (n!==0.25 && n!==0.5 && n!==1)){\r\n        return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u5DE5\u6642\u6700\u5C0F\u55AE\u4F4D\u50C5\u5141\u8A31 0.25/0.5/1\", meta:{ requestId } }, corsHeaders);\r\n      }\r\n    }\r\n    if (key === \"soft_delete_enabled\"){\r\n      if (!(value === \"0\" || value === \"1\")) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8EDF\u522A\u9664\u503C\u50C5\u80FD\u70BA 0 \u6216 1\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n    if (key === \"workday_start\" || key === \"workday_end\"){\r\n      if (!/^\\d{2}:\\d{2}$/.test(value)) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u6642\u9593\u683C\u5F0F\u9700\u70BA HH:MM\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n    if (key === \"rule_comp_hours_expiry\"){\r\n      const okVals = new Set([\"current_month\",\"next_month\",\"3_months\",\"6_months\"]);\r\n      if (!okVals.has(value)) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u7121\u6548\u7684\u898F\u5247\u503C\", meta:{ requestId } }, corsHeaders);\r\n      if (DANGEROUS_KEYS.has(key) && payload?.confirmed !== true){\r\n        return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u5371\u96AA\u8A2D\u5B9A\u9700\u78BA\u8A8D\", meta:{ requestId, field:key } }, corsHeaders);\r\n      }\r\n    }\r\n    if (key === \"attendance_bonus_amount\"){\r\n      const n = parseInt(value, 10);\r\n      if (!Number.isInteger(n) || n < 0) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u5168\u52E4\u734E\u91D1\u5FC5\u9808\u70BA\u975E\u8CA0\u6574\u6578\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n    if (key === \"overhead_cost_per_hour\"){\r\n      const n = parseFloat(value);\r\n      if (!Number.isFinite(n) || n < 0) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u7BA1\u7406\u6210\u672C\u5FC5\u9808\u70BA\u975E\u8CA0\u6578\u5B57\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n    if (key === \"target_profit_margin\"){\r\n      const n = parseFloat(value);\r\n      if (!Number.isFinite(n) || n < 0 || n > 100) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u76EE\u6A19\u6BDB\u5229\u7387\u5FC5\u9808\u5728 0-100 \u4E4B\u9593\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n    try {\r\n      const nowIso = new Date().toISOString();\r\n      await env.DATABASE.prepare(\r\n        \"INSERT INTO Settings(setting_key, setting_value, updated_at, updated_by) VALUES(?, ?, ?, ?) ON CONFLICT(setting_key) DO UPDATE SET setting_value=excluded.setting_value, updated_at=excluded.updated_at, updated_by=excluded.updated_by\"\r\n      ).bind(key, value, nowIso, String(me.user_id||me.userId||\"1\")).run();\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u66F4\u65B0\", data:{ key, value }, meta:{ requestId } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u7121\u6B64\u7AEF\u9EDE\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\n\nfunction ymToday() {\n  const d = new Date();\n  return `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, '0')}`;\n}\n\nfunction todayYmd() {\n  const d = new Date();\n  return `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, '0')}-${String(d.getUTCDate()).padStart(2, '0')}`;\n}\n\nexport async function handleDashboard(request, env, me, requestId, url, path) {\n  const corsHeaders = getCorsHeadersForRequest(request, env);\n  const method = request.method.toUpperCase();\n  if (path !== \"/internal/api/v1/dashboard\" || method !== \"GET\") {\n    return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\n  }\n\n  try {\n    // \u4ECE\u67E5\u8BE2\u53C2\u6570\u83B7\u53D6\u6708\u4EFD\uFF0C\u5982\u679C\u6CA1\u6709\u5219\u4F7F\u7528\u5F53\u524D\u6708\u4EFD\n    const searchParams = new URL(url).searchParams;\n    const requestedYm = searchParams.get('ym');\n    const ym = requestedYm && /^\\d{4}-\\d{2}$/.test(requestedYm) ? requestedYm : ymToday();\n    \n    // \u8D22\u52A1\u72B6\u51B5\u7684\u6708\u4EFD\u548C\u6A21\u5F0F\n    const financeYm = searchParams.get('financeYm') && /^\\d{4}-\\d{2}$/.test(searchParams.get('financeYm')) ? searchParams.get('financeYm') : ym;\n    const financeMode = searchParams.get('financeMode') || 'month'; // 'month' \u6216 'ytd'\n    \n    const today = todayYmd();\n\n    // Employee metrics\n    async function getEmployeeMetrics() {\n      const res = { myHours: null, myTasks: { items: [], counts: { pending: 0, inProgress: 0, overdue: 0, dueSoon: 0 } }, myLeaves: null, recentActivities: [], notifications: [] };\n      // Hours\n      try {\n        const h = await env.DATABASE.prepare(\n          `SELECT \n              SUM(hours) AS total,\n              SUM(CASE WHEN work_type = 'normal' THEN hours ELSE 0 END) AS normal,\n              SUM(CASE WHEN work_type LIKE 'ot-%' THEN hours ELSE 0 END) AS overtime\n           FROM Timesheets WHERE is_deleted = 0 AND user_id = ? AND substr(work_date,1,7) = ?`\n        ).bind(String(me.user_id), ym).first();\n        const total = Number(h?.total || 0), normal = Number(h?.normal || 0), overtime = Number(h?.overtime || 0);\n        const target = 160; const completionRate = target ? Math.round((total / target) * 1000) / 10 : 0;\n        res.myHours = { month: ym, total, normal, overtime, targetHours: target, completionRate };\n      } catch (_) {}\n\n      // Tasks (pending/in_progress)\n      try {\n        const rows = await env.DATABASE.prepare(\n          `SELECT task_id, task_name, due_date, status, related_sop_id, client_specific_sop_id,\n                  status_note, blocker_reason, overdue_reason\n           FROM ActiveTasks\n           WHERE is_deleted = 0 AND assignee_user_id = ? AND status IN ('pending','in_progress')\n           ORDER BY COALESCE(due_date, '9999-12-31') ASC LIMIT 10`\n        ).bind(String(me.user_id)).all();\n        const items = (rows?.results || []).map(r => {\n          const due = r.due_date || null;\n          let urgency = 'normal';\n          let daysUntilDue = null; let daysOverdue = null; const now = new Date();\n          if (due) {\n            const d = new Date(due); const delta = Math.floor((d.getTime() - now.getTime()) / 86400000);\n            daysUntilDue = delta;\n            if (delta < 0) { urgency = 'overdue'; daysOverdue = -delta; }\n            else if (delta <= 3) urgency = 'urgent';\n          }\n          return { \n            id: r.task_id, \n            name: r.task_name, \n            dueDate: due, \n            status: r.status, \n            urgency, \n            daysUntilDue, \n            daysOverdue, \n            hasSop: !!(r.related_sop_id || r.client_specific_sop_id),\n            statusNote: r.status_note || null,\n            blockerReason: r.blocker_reason || null,\n            overdueReason: r.overdue_reason || null\n          };\n        });\n        const counts = { pending: 0, inProgress: 0, overdue: 0, dueSoon: 0 };\n        for (const it of items) {\n          if (it.status === 'pending') counts.pending++;\n          if (it.status === 'in_progress') counts.inProgress++;\n          if (it.urgency === 'overdue') counts.overdue++;\n          if (typeof it.daysUntilDue === 'number' && it.daysUntilDue >= 0 && it.daysUntilDue <= 3) counts.dueSoon++;\n        }\n        res.myTasks = { items, counts };\n      } catch (_) {}\n\n      // Leaves (balances and recent)\n      try {\n        // \u6392\u9664\u88DC\u4F11\u985E\u578B\uFF08\u88DC\u4F11\u7531 CompensatoryLeaveGrants \u8A08\u7B97\uFF09\n        const rows = await env.DATABASE.prepare(\n          `SELECT leave_type AS type, remain AS remaining, total, used FROM LeaveBalances WHERE user_id = ? AND leave_type != 'comp'`\n        ).bind(String(me.user_id)).all();\n        const bal = { annual: 0, sick: 0, compHours: 0 };\n        for (const r of (rows?.results || [])) {\n          const t = (r.type || '').toLowerCase();\n          if (t === 'annual') bal.annual = Number(r.remaining || 0);\n          else if (t === 'sick') bal.sick = Number(r.remaining || 0);\n        }\n        \n        // \u88DC\u4F11\u9918\u984D\u5F9E CompensatoryLeaveGrants \u8A08\u7B97\n        const compRow = await env.DATABASE.prepare(\n          `SELECT SUM(hours_remaining) as total FROM CompensatoryLeaveGrants \n           WHERE user_id = ? AND status = 'active' AND hours_remaining > 0`\n        ).bind(String(me.user_id)).first();\n        bal.compHours = Number(compRow?.total || 0);\n        const recentRows = await env.DATABASE.prepare(\n          `SELECT leave_type AS type, start_date, end_date, amount, status FROM LeaveRequests WHERE user_id = ? ORDER BY submitted_at DESC LIMIT 3`\n        ).bind(String(me.user_id)).all();\n        const recent = (recentRows?.results || []).map(r => ({ type: r.type, startDate: r.start_date, days: Number(r.amount || 0), status: r.status }));\n        res.myLeaves = { balances: bal, recent };\n      } catch (_) {}\n\n      return res;\n    }\n\n    // Admin metrics\n    async function getAdminMetrics(targetYm, finYm, finMode, params) {\n      const res = { employeeHours: [], employeeTasks: [], financialStatus: null, revenueTrend: [], recentActivities: [], teamMembers: [] };\n      \n      // Employee hours (\u5404\u5458\u5DE5\u5206\u522B\u5DE5\u65F6 - \u6309\u6307\u5B9A\u6708\u4EFD\u67E5\u8BE2)\n      // work_type: 1=\u6B63\u5E38\u5DE5\u65F6\uFF0C2-11=\u5404\u79CD\u52A0\u73ED\u7C7B\u578B\n      try {\n        const result = await env.DATABASE.prepare(\n          `SELECT u.user_id, u.name, u.username,\n                  COALESCE(SUM(t.hours), 0) AS total,\n                  COALESCE(SUM(CASE WHEN CAST(t.work_type AS INTEGER) = 1 THEN t.hours ELSE 0 END), 0) AS normal,\n                  COALESCE(SUM(CASE WHEN CAST(t.work_type AS INTEGER) >= 2 THEN t.hours ELSE 0 END), 0) AS overtime\n           FROM Users u\n           LEFT JOIN Timesheets t ON t.user_id = u.user_id AND t.is_deleted = 0 AND substr(t.work_date, 1, 7) = ?\n           WHERE u.is_deleted = 0\n           GROUP BY u.user_id, u.name, u.username\n           ORDER BY total DESC, u.name ASC`\n        ).bind(targetYm).all();\n        \n        // D1 returns { results: [...], success: true }\n        const rows = result?.results || [];\n        res.employeeHours = rows.map(r => ({\n          userId: r.user_id,\n          name: r.name || r.username || '\u672A\u547D\u540D',\n          total: Number(r.total || 0),\n          normal: Number(r.normal || 0),\n          overtime: Number(r.overtime || 0)\n        }));\n      } catch (e) {\n        console.error('[Dashboard] Employee hours query error:', e);\n      }\n\n      // Financial status - \u6839\u636EfinMode\u8FD4\u56DE\u5BF9\u5E94\u6570\u636E\n      try {\n        const currentYear = finYm.split('-')[0]; // \u4ECEfinYm\u83B7\u53D6\u5E74\u4EFD\n        \n        // \u73B0\u91D1\u6D41\u6570\u636E\uFF08\u5B9E\u65F6\uFF0C\u4E0D\u5206\u6708\u4EFD\uFF09\n        const arRow = await env.DATABASE.prepare(\n          `SELECT SUM(total_amount) AS ar FROM Receipts WHERE is_deleted = 0 AND status IN ('unpaid','partial')`\n        ).first();\n        const overdueRow = await env.DATABASE.prepare(\n          `SELECT SUM(total_amount) AS od FROM Receipts WHERE is_deleted = 0 AND status IN ('unpaid','partial') AND due_date < ?`\n        ).bind(today).first();\n        const ar = Math.round(Number(arRow?.ar || 0));\n        const overdue = Math.round(Number(overdueRow?.od || 0));\n        \n        let monthData = null;\n        let ytdData = null;\n        \n        if (finMode === 'month') {\n          // \u6708\u5EA6\u6570\u636E\n          const monthPaidRow = await env.DATABASE.prepare(\n            `SELECT SUM(total_amount) AS paid FROM Receipts WHERE is_deleted = 0 AND status = 'paid' AND substr(receipt_date,1,7) = ?`\n          ).bind(finYm).first();\n          const monthRevRow = await env.DATABASE.prepare(\n            `SELECT SUM(total_amount) AS revenue FROM Receipts WHERE is_deleted = 0 AND status != 'cancelled' AND substr(receipt_date,1,7) = ?`\n          ).bind(finYm).first();\n          let monthCost = 0;\n          try {\n            const pr = await env.DATABASE.prepare(`SELECT SUM(total_cents) AS c FROM MonthlyPayroll mp JOIN PayrollRuns pr ON pr.run_id = mp.run_id WHERE pr.month = ?`).bind(finYm).first();\n            monthCost = Math.round(Number(pr?.c || 0) / 100);\n          } catch (_) {}\n          \n          const monthRevenue = Math.round(Number(monthRevRow?.revenue || 0));\n          const monthPaid = Math.round(Number(monthPaidRow?.paid || 0));\n          const monthProfit = monthRevenue - monthCost;\n          const monthMargin = monthRevenue > 0 ? Math.round((monthProfit / monthRevenue) * 1000) / 10 : 0;\n          const monthCollectionRate = monthRevenue > 0 ? Math.round((monthPaid / monthRevenue) * 1000) / 10 : 0;\n          \n          monthData = {\n            period: finYm,\n            revenue: monthRevenue,\n            cost: monthCost,\n            profit: monthProfit,\n            margin: monthMargin,\n            ar,\n            paid: monthPaid,\n            overdue,\n            collectionRate: monthCollectionRate\n          };\n        } else {\n          // \u5E74\u5EA6\u7D2F\u8BA1\u6570\u636E\uFF08\u622A\u81F3\u4ECA\u65E5\uFF09\n          const ytdPaidRow = await env.DATABASE.prepare(\n            `SELECT SUM(total_amount) AS paid FROM Receipts WHERE is_deleted = 0 AND status = 'paid' AND substr(receipt_date,1,4) = ? AND receipt_date <= ?`\n          ).bind(currentYear, today).first();\n          const ytdRevRow = await env.DATABASE.prepare(\n            `SELECT SUM(total_amount) AS revenue FROM Receipts WHERE is_deleted = 0 AND status != 'cancelled' AND substr(receipt_date,1,4) = ? AND receipt_date <= ?`\n          ).bind(currentYear, today).first();\n          let ytdCost = 0;\n          try {\n            const pr = await env.DATABASE.prepare(`SELECT SUM(total_cents) AS c FROM MonthlyPayroll mp JOIN PayrollRuns pr ON pr.run_id = mp.run_id WHERE substr(pr.month,1,4) = ?`).bind(currentYear).first();\n            ytdCost = Math.round(Number(pr?.c || 0) / 100);\n          } catch (_) {}\n          \n          const ytdRevenue = Math.round(Number(ytdRevRow?.revenue || 0));\n          const ytdPaid = Math.round(Number(ytdPaidRow?.paid || 0));\n          const ytdProfit = ytdRevenue - ytdCost;\n          const ytdMargin = ytdRevenue > 0 ? Math.round((ytdProfit / ytdRevenue) * 1000) / 10 : 0;\n          const ytdCollectionRate = ytdRevenue > 0 ? Math.round((ytdPaid / ytdRevenue) * 1000) / 10 : 0;\n          \n          ytdData = {\n            period: `${currentYear}\u5E74\u7D2F\u8A08`,\n            revenue: ytdRevenue,\n            cost: ytdCost,\n            profit: ytdProfit,\n            margin: ytdMargin,\n            ar,\n            paid: ytdPaid,\n            overdue,\n            collectionRate: ytdCollectionRate\n          };\n        }\n        \n        res.financialStatus = { \n          month: monthData,\n          ytd: ytdData\n        };\n      } catch (_) {}\n\n      // Employee tasks (\u5404\u5458\u5DE5\u4EFB\u52A1\u72B6\u6001\uFF1A\u5DF2\u5B8C\u6210/\u8FDB\u884C\u4E2D/\u903E\u671F)\n      // \u667A\u80FD\u7B5B\u9009\u903B\u8F91\uFF1A\n      // - \u5DF2\u5B8C\u6210\u7684\u4EFB\u52A1\uFF1A\u53EA\u663E\u793A\u6307\u5B9A\u6708\u4EFD\u7684\uFF08\u907F\u514D\u65E0\u9650\u7D2F\u79EF\uFF09\n      // - \u672A\u5B8C\u6210\u7684\u4EFB\u52A1\uFF1A\u663E\u793A\u6240\u6709\u6708\u4EFD\u7684\uFF08\u907F\u514D\u9057\u6F0F\u9700\u8981\u5904\u7406\u7684\u4EFB\u52A1\uFF09\n      try {\n        // \u5148\u83B7\u53D6\u57FA\u672C\u7EDF\u8BA1\n        const summaryRows = await env.DATABASE.prepare(\n          `SELECT u.user_id, u.name, u.username,\n                  COUNT(CASE WHEN t.status = 'completed' AND t.service_month = ? THEN 1 END) AS completed\n           FROM Users u\n           LEFT JOIN ActiveTasks t ON t.assignee_user_id = u.user_id AND t.is_deleted = 0\n           WHERE u.is_deleted = 0\n           GROUP BY u.user_id, u.name, u.username`\n        ).bind(targetYm).all();\n        \n        // \u83B7\u53D6\u672A\u5B8C\u6210\u4EFB\u52A1\u7684\u6708\u4EFD\u5206\u5E03\u8BE6\u60C5\n        const detailRows = await env.DATABASE.prepare(\n          `SELECT u.user_id, \n                  t.service_month,\n                  t.status,\n                  CASE WHEN t.status NOT IN ('completed','cancelled') AND t.due_date < ? THEN 1 ELSE 0 END as is_overdue,\n                  COUNT(*) as count\n           FROM Users u\n           LEFT JOIN ActiveTasks t ON t.assignee_user_id = u.user_id \n                  AND t.is_deleted = 0 \n                  AND t.status NOT IN ('completed', 'cancelled')\n           WHERE u.is_deleted = 0 AND t.task_id IS NOT NULL\n           GROUP BY u.user_id, t.service_month, t.status, is_overdue`\n        ).bind(today).all();\n        \n        // \u6784\u5EFA\u7528\u6237\u4EFB\u52A1\u6620\u5C04\n        const userTasksMap = {};\n        (summaryRows?.results || []).forEach(r => {\n          userTasksMap[r.user_id] = {\n            userId: r.user_id,\n            name: r.name || r.username,\n            completed: Number(r.completed || 0),\n            inProgress: {},\n            overdue: {}\n          };\n        });\n        \n        // \u586B\u5145\u6708\u4EFD\u5206\u5E03\u8BE6\u60C5\n        (detailRows?.results || []).forEach(r => {\n          const user = userTasksMap[r.user_id];\n          if (!user) return;\n          \n          const month = r.service_month || '\u672A\u77E5';\n          const count = Number(r.count || 0);\n          \n          if (r.is_overdue === 1) {\n            user.overdue[month] = (user.overdue[month] || 0) + count;\n          } else if (r.status === 'in_progress') {\n            user.inProgress[month] = (user.inProgress[month] || 0) + count;\n          }\n          // \u6CE8\u610F\uFF1A\u5DF2\u79FB\u9664 pending \u72B6\u6001\uFF0C\u6240\u6709\u4EFB\u52A1\u9ED8\u8BA4\u4E3A in_progress\n        });\n        \n        res.employeeTasks = Object.values(userTasksMap).sort((a, b) => {\n          const aOverdue = Object.values(a.overdue).reduce((sum, n) => sum + n, 0);\n          const bOverdue = Object.values(b.overdue).reduce((sum, n) => sum + n, 0);\n          const aInProgress = Object.values(a.inProgress).reduce((sum, n) => sum + n, 0);\n          const bInProgress = Object.values(b.inProgress).reduce((sum, n) => sum + n, 0);\n          return (bOverdue - aOverdue) || (bInProgress - aInProgress);\n        });\n      } catch (err) {\n        console.error('[Dashboard] Employee tasks query error:', err);\n      }\n\n      // Revenue trend (last 6 months)\n      try {\n        const rows = await env.DATABASE.prepare(\n          `SELECT strftime('%Y-%m', receipt_date) AS ym, SUM(total_amount) AS revenue,\n                  SUM(CASE WHEN status='paid' THEN total_amount ELSE 0 END) AS paid\n           FROM Receipts WHERE is_deleted = 0 AND status != 'cancelled'\n           GROUP BY ym ORDER BY ym DESC LIMIT 6`\n        ).all();\n        const list = (rows?.results || []).map(r => ({ month: r.ym, revenue: Number(r.revenue || 0), paid: Number(r.paid || 0) }));\n        res.revenueTrend = list.sort((a,b)=> a.month.localeCompare(b.month));\n      } catch (_) {}\n\n      // Recent Activities (\u4EFB\u52A1\u8C03\u6574\u3001\u72B6\u6001\u66F4\u65B0\u3001\u5047\u671F\u7533\u8BF7\u3001\u5DE5\u65F6\u63D0\u9192)\n      // \u5DE5\u65F6\u4FA6\u6D4B\u8BF4\u660E\uFF1A\u5DE5\u65F6\u63D0\u9192\u662F\u6BCF\u6B21\u8BF7\u6C42\u4EEA\u8868\u677F\u65F6\u5B9E\u65F6\u8BA1\u7B97\u7684\uFF0C\u68C0\u67E5\u7528\u6237\u9009\u62E9\u7684\u5929\u6570\u5185\uFF08\u6392\u9664\u5468\u672B\u548C\u56FD\u5B9A\u5047\u65E5\uFF09\n      // \u54EA\u4E9B\u5458\u5DE5\u6CA1\u6709\u586B\u5199\u5DE5\u65F6\u8BB0\u5F55\u3002\u8FD9\u4E2A\u903B\u8F91\u5728\u4E0B\u65B9\u7684 timesheetReminders \u90E8\u5206\u5B9E\u73B0\u3002\n      console.log('========================================');\n      console.log('[\u4EEA\u8868\u677F] \u5F00\u59CB\u5904\u7406 Recent Activities');\n      console.log('========================================');\n      try {\n        // \u4ECE\u67E5\u8BE2\u53C2\u6570\u83B7\u53D6\u7B5B\u9009\u6761\u4EF6\uFF08\u9ED8\u8BA430\u5929\uFF09\n        const days = parseInt(params.get('activity_days') || '30', 10);\n        const filterUserId = params.get('activity_user_id');\n        const filterType = params.get('activity_type'); // \u7C7B\u578B\u7B5B\u9009\uFF1Astatus_update, due_date_adjustment, leave_application, timesheet_reminder\n        console.log('[\u4EEA\u8868\u677F] \u7B5B\u9009\u53C2\u6570 - days:', days, 'filterUserId:', filterUserId, 'filterType:', filterType);\n        \n        // \u4E0D\u518D\u4F7F\u7528 JavaScript \u751F\u6210\u65F6\u95F4\u5B57\u7B26\u4E32\uFF0C\u76F4\u63A5\u5728 SQL \u4E2D\u4F7F\u7528 SQLite \u7684 datetime \u51FD\u6570\n        // \u8FD9\u6837\u53EF\u4EE5\u907F\u514D\u65F6\u95F4\u683C\u5F0F\u4E0D\u5339\u914D\u7684\u95EE\u9898\n        \n        // \u6784\u5EFA\u7528\u6237\u7B5B\u9009\u6761\u4EF6\n        const userFilter = filterUserId ? `AND adj.requested_by = ${filterUserId}` : '';\n        const userFilter2 = filterUserId ? `AND su.updated_by = ${filterUserId}` : '';\n        const userFilter3 = filterUserId ? `AND l.user_id = ${filterUserId}` : '';\n        \n        // \u67E5\u8BE2\u4EFB\u52A1\u671F\u9650\u8C03\u6574\n        const adjustments = await env.DATABASE.prepare(`\n          SELECT \n            adj.adjustment_id,\n            adj.requested_at as activity_time,\n            adj.old_due_date,\n            adj.new_due_date,\n            adj.adjustment_reason as reason,\n            adj.requested_by,\n            u.name as user_name,\n            t.task_name,\n            t.task_id,\n            t.status as current_status,\n            t.due_date as current_due_date,\n            t.assignee_user_id,\n            assignee.name as assignee_name,\n            c.company_name as client_name,\n            s.service_name\n          FROM TaskDueDateAdjustments adj\n          JOIN Users u ON u.user_id = adj.requested_by\n          JOIN ActiveTasks t ON t.task_id = adj.task_id\n          LEFT JOIN Users assignee ON assignee.user_id = t.assignee_user_id\n          LEFT JOIN ClientServices cs ON cs.client_service_id = t.client_service_id\n          LEFT JOIN Clients c ON c.client_id = cs.client_id\n          LEFT JOIN Services s ON s.service_id = cs.service_id\n          WHERE adj.requested_at >= datetime('now', '-${days} days')\n            AND adj.old_due_date IS NOT NULL \n            AND adj.new_due_date IS NOT NULL\n            AND adj.adjustment_type IS NOT NULL\n            ${userFilter}\n          ORDER BY adj.requested_at DESC\n          LIMIT 30\n        `).all();\n        \n        // \u67E5\u8BE2\u4EFB\u52A1\u72B6\u6001\u66F4\u65B0\n        console.log('[\u4EEA\u8868\u677F] \u67E5\u8BE2\u72B6\u6001\u66F4\u65B0\uFF0C\u5929\u6570:', days);\n        const statusUpdates = await env.DATABASE.prepare(`\n          SELECT \n            su.update_id,\n            su.updated_at as activity_time,\n            su.old_status,\n            su.new_status,\n            su.progress_note,\n            su.blocker_reason,\n            su.overdue_reason,\n            su.updated_by,\n            u.name as user_name,\n            t.task_name,\n            t.task_id,\n            t.status as current_status,\n            t.due_date as current_due_date,\n            t.assignee_user_id,\n            assignee.name as assignee_name,\n            c.company_name as client_name,\n            s.service_name\n          FROM TaskStatusUpdates su\n          LEFT JOIN Users u ON u.user_id = su.updated_by\n          LEFT JOIN ActiveTasks t ON t.task_id = su.task_id\n          LEFT JOIN Users assignee ON assignee.user_id = t.assignee_user_id\n          LEFT JOIN ClientServices cs ON cs.client_service_id = t.client_service_id\n          LEFT JOIN Clients c ON c.client_id = cs.client_id\n          LEFT JOIN Services s ON s.service_id = cs.service_id\n          WHERE su.updated_at >= datetime('now', '-${days} days')\n            AND su.old_status IS NOT NULL\n            AND su.new_status IS NOT NULL\n            ${userFilter2}\n          ORDER BY su.updated_at DESC\n          LIMIT 30\n        `).all();\n        console.log('[\u4EEA\u8868\u677F] \u72B6\u6001\u66F4\u65B0\u67E5\u8BE2\u7ED3\u679C:', statusUpdates?.results?.length || 0, '\u6761');\n        if (statusUpdates?.results?.length > 0) {\n          console.log('[\u4EEA\u8868\u677F] \u7B2C\u4E00\u6761\u72B6\u6001\u66F4\u65B0:', JSON.stringify(statusUpdates.results[0], null, 2));\n        }\n        \n        // \u67E5\u8BE2\u5047\u671F\u7533\u8BF7\n        const leaveApplications = await env.DATABASE.prepare(`\n          SELECT \n            l.leave_id,\n            l.submitted_at as activity_time,\n            l.leave_type,\n            l.start_date,\n            l.end_date,\n            l.amount as leave_days,\n            l.status as leave_status,\n            l.reason,\n            l.user_id,\n            u.name as user_name\n          FROM LeaveRequests l\n          LEFT JOIN Users u ON u.user_id = l.user_id\n          WHERE l.submitted_at >= datetime('now', '-${days} days')\n            ${userFilter3}\n          ORDER BY l.submitted_at DESC\n          LIMIT 30\n        `).all();\n        \n        // \u67E5\u8BE2\u5DE5\u65F6\u7F3A\u5931\u63D0\u9192\uFF08\u6839\u636E\u7528\u6237\u9009\u62E9\u7684\u5929\u6570\u68C0\u67E5\u672A\u586B\u5199\u5DE5\u65F6\u7684\u5458\u5DE5\uFF09\n        let timesheetReminders = [];\n        try {\n          // \u83B7\u53D6\u6307\u5B9A\u5929\u6570\u5185\u7684\u65E5\u671F\u5217\u8868\uFF08\u6392\u9664\u5468\u672B\u548C\u56FD\u5B9A\u5047\u65E5\uFF09\n          const today = new Date();\n          const dates = [];\n          \n          // \u5148\u83B7\u53D6\u56FD\u5B9A\u5047\u65E5\u5217\u8868\n          const holidaysResult = await env.DATABASE.prepare(`\n            SELECT holiday_date \n            FROM Holidays \n            WHERE holiday_date >= date('now', '-${days} days') \n              AND holiday_date <= date('now')\n          `).all();\n          const holidays = new Set((holidaysResult?.results || []).map(h => h.holiday_date));\n          \n          for (let i = 1; i <= days; i++) {\n            const d = new Date(today);\n            d.setDate(d.getDate() - i);\n            const dayOfWeek = d.getDay();\n            const dateStr = d.toISOString().slice(0, 10);\n            \n            // \u6392\u9664\u5468\u672B\u548C\u56FD\u5B9A\u5047\u65E5\n            if (dayOfWeek !== 0 && dayOfWeek !== 6 && !holidays.has(dateStr)) {\n              dates.push(dateStr);\n            }\n          }\n          \n          // \u67E5\u8BE2\u6BCF\u4E2A\u7528\u6237\u7684\u5DE5\u65F6\u586B\u5199\u60C5\u51B5\n          if (dates.length > 0) {\n            const datesList = dates.map(d => `'${d}'`).join(',');\n            const userFilterForTimesheet = filterUserId ? `AND u.user_id = ${filterUserId}` : '';\n            \n            const missingTimesheets = await env.DATABASE.prepare(`\n              WITH AllUserDates AS (\n                SELECT u.user_id, u.name, u.start_date, dates.work_date\n                FROM Users u\n                CROSS JOIN (${dates.map(d => `SELECT '${d}' as work_date`).join(' UNION ALL ')}) dates\n                WHERE u.is_deleted = 0 ${userFilterForTimesheet}\n              )\n              SELECT \n                aud.user_id,\n                aud.name as user_name,\n                aud.work_date,\n                CASE WHEN t.timesheet_id IS NULL THEN 1 ELSE 0 END as is_missing\n              FROM AllUserDates aud\n              LEFT JOIN Timesheets t ON t.user_id = aud.user_id AND t.work_date = aud.work_date\n              WHERE t.timesheet_id IS NULL\n                AND aud.work_date >= aud.start_date\n              ORDER BY aud.work_date DESC, aud.name ASC\n              LIMIT 30\n            `).all();\n            \n            // \u6309\u7528\u6237\u5206\u7EC4\uFF0C\u751F\u6210\u63D0\u9192\u8BB0\u5F55\n            const groupedByUser = {};\n            (missingTimesheets?.results || []).forEach(r => {\n              if (!groupedByUser[r.user_id]) {\n                groupedByUser[r.user_id] = {\n                  user_id: r.user_id,\n                  user_name: r.user_name,\n                  missing_dates: []\n                };\n              }\n              groupedByUser[r.user_id].missing_dates.push(r.work_date);\n            });\n            \n            // \u8F6C\u6362\u4E3A\u6D3B\u52A8\u8BB0\u5F55\u683C\u5F0F\n            timesheetReminders = Object.values(groupedByUser).map(item => ({\n              activity_type: 'timesheet_reminder',\n              user_id: item.user_id,\n              user_name: item.user_name,\n              missing_dates: item.missing_dates,\n              missing_count: item.missing_dates.length,\n              activity_time: today.toISOString() // \u4F7F\u7528\u5F53\u524D\u65F6\u95F4\u4F5C\u4E3A\u6D3B\u52A8\u65F6\u95F4\n            }));\n          }\n        } catch (err) {\n          console.error('[\u4EEA\u8868\u677F] \u83B7\u53D6\u5DE5\u65F6\u63D0\u9192\u5931\u8D25:', err);\n        }\n        \n        // \u5408\u5E76\u5E76\u6392\u5E8F\uFF08\u6DFB\u52A0 activity_type \u6807\u8BC6\uFF09\n        console.log('[\u4EEA\u8868\u677F] \u5408\u5E76\u6D3B\u52A8\u524D:');\n        console.log('  - adjustments.results:', adjustments?.results?.length || 0);\n        console.log('  - statusUpdates.results:', statusUpdates?.results?.length || 0);\n        console.log('  - leaveApplications.results:', leaveApplications?.results?.length || 0);\n        console.log('  - timesheetReminders:', timesheetReminders?.length || 0);\n        \n        const allActivities = [\n          ...(adjustments?.results || []).map(a => ({...a, activity_type: 'due_date_adjustment'})),\n          ...(statusUpdates?.results || []).map(s => ({...s, activity_type: 'status_update'})),\n          ...(leaveApplications?.results || []).map(l => ({...l, activity_type: 'leave_application'})),\n          ...timesheetReminders\n        ].sort((a, b) => (b.activity_time || '').localeCompare(a.activity_time || ''));\n        \n        console.log('[\u4EEA\u8868\u677F] \u5408\u5E76\u540E\u603B\u6D3B\u52A8\u6570:', allActivities.length);\n        if (allActivities.length > 0) {\n          console.log('[\u4EEA\u8868\u677F] \u7B2C\u4E00\u6761\u6D3B\u52A8\u793A\u4F8B:', allActivities[0]);\n        }\n        \n        // \u6839\u636E\u7C7B\u578B\u7B5B\u9009\n        let filteredActivities = allActivities;\n        if (filterType) {\n          filteredActivities = allActivities.filter(act => act.activity_type === filterType);\n          console.log('[\u4EEA\u8868\u677F] \u7C7B\u578B\u7B5B\u9009\u540E\u6D3B\u52A8\u6570:', filteredActivities.length, '(\u7B5B\u9009\u7C7B\u578B:', filterType, ')');\n        }\n        \n        // \u683C\u5F0F\u5316\u6D3B\u52A8\u8BB0\u5F55\n        res.recentActivities = filteredActivities.slice(0, 15).map(act => {\n          // \u5904\u7406\u65F6\u533A\u8F6C\u6362\uFF1ASQLite \u8FD4\u56DE\u7684\u65F6\u95F4\u662F UTC \u65F6\u95F4\uFF08\u683C\u5F0F\uFF1AYYYY-MM-DD HH:MM:SS\uFF09\n          // \u9700\u8981\u660E\u786E\u6DFB\u52A0 'Z' \u6807\u8BC6\u4E3A UTC\uFF0C\u7136\u540E\u8F6C\u6362\u4E3A\u53F0\u6E7E\u65F6\u533A\uFF08UTC+8\uFF09\n          let time = '';\n          if (act.activity_time) {\n            let dateStr = act.activity_time;\n            // \u5982\u679C\u662F SQLite \u683C\u5F0F\uFF08YYYY-MM-DD HH:MM:SS\uFF09\uFF0C\u6DFB\u52A0 'Z' \u6807\u8BC6\u4E3A UTC\n            if (dateStr.includes(' ') && !dateStr.includes('T')) {\n              dateStr = dateStr.replace(' ', 'T') + 'Z';\n            }\n            time = new Date(dateStr).toLocaleString('zh-TW', { \n              timeZone: 'Asia/Taipei',\n              month: '2-digit', \n              day: '2-digit', \n              hour: '2-digit', \n              minute: '2-digit' \n            });\n          }\n          \n          const statusMap = {\n            'pending': '\u5F85\u958B\u59CB',\n            'in_progress': '\u9032\u884C\u4E2D',\n            'completed': '\u5DF2\u5B8C\u6210',\n            'cancelled': '\u5DF2\u53D6\u6D88'\n          };\n          \n          const currentStatus = statusMap[act.current_status] || act.current_status || '\u2014';\n          const currentDueDate = act.current_due_date ? act.current_due_date.slice(5) : '\u2014';\n          const assigneeName = act.assignee_name || '\u672A\u5206\u914D';\n          const serviceName = act.service_name || '\u2014';\n          \n          if (act.activity_type === 'due_date_adjustment') {\n            const oldDate = act.old_due_date ? act.old_due_date.slice(5) : '';\n            const newDate = act.new_due_date ? act.new_due_date.slice(5) : '';\n            return {\n              activity_type: 'due_date_adjustment',\n              text: `${act.user_name} \u8ABF\u6574\u4E86\u4EFB\u52D9\u671F\u9650`,\n              taskName: act.task_name,\n              clientName: act.client_name || '\u2014',\n              serviceName: serviceName,\n              change: `${oldDate} \u2192 ${newDate}`,\n              reason: act.reason || '',\n              currentStatus: currentStatus,\n              currentDueDate: currentDueDate,\n              assigneeName: assigneeName,\n              time: time,\n              link: `/internal/task-detail?id=${act.task_id}`\n            };\n          } else if (act.activity_type === 'status_update') {\n            const oldStatus = statusMap[act.old_status] || act.old_status;\n            const newStatus = statusMap[act.new_status] || act.new_status;\n            \n            let note = '';\n            if (act.blocker_reason) note = `\uD83D\uDEAB ${act.blocker_reason}`;\n            else if (act.overdue_reason) note = `\u23F0 ${act.overdue_reason}`;\n            else if (act.progress_note) note = `\uD83D\uDCAC ${act.progress_note}`;\n            \n            return {\n              activity_type: 'status_update',\n              text: `${act.user_name} \u66F4\u65B0\u4E86\u4EFB\u52D9\u72C0\u614B`,\n              taskName: act.task_name,\n              clientName: act.client_name || '\u2014',\n              serviceName: serviceName,\n              change: `${oldStatus} \u2192 ${newStatus}`,\n              note: note,\n              currentStatus: currentStatus,\n              currentDueDate: currentDueDate,\n              assigneeName: assigneeName,\n              time: time,\n              link: `/internal/task-detail?id=${act.task_id}`\n            };\n          } else if (act.activity_type === 'leave_application') {\n            const leaveTypeMap = {\n              'annual': '\u7279\u4F11',\n              'sick': '\u75C5\u5047',\n              'personal': '\u4E8B\u5047',\n              'comp': '\u88DC\u4F11',\n              'maternity': '\u7522\u5047',\n              'paternity': '\u966A\u7522\u5047',\n              'marriage': '\u5A5A\u5047',\n              'bereavement': '\u55AA\u5047',\n              'unpaid': '\u7121\u85AA\u5047'\n            };\n            const leaveType = leaveTypeMap[act.leave_type] || act.leave_type;\n            \n            const startDate = act.start_date ? act.start_date.slice(5) : '';\n            const endDate = act.end_date ? act.end_date.slice(5) : '';\n            const leaveDays = act.leave_days || 0;\n            \n            return {\n              activity_type: 'leave_application',\n              text: `${act.user_name} \u7533\u8ACB${leaveType}`,\n              leaveType: leaveType,\n              leaveDays: leaveDays,\n              period: `${startDate} ~ ${endDate}`,\n              reason: act.reason || '',\n              userName: act.user_name,\n              time: time,\n              link: `/internal/leaves`\n            };\n          } else if (act.activity_type === 'timesheet_reminder') {\n            const missingDates = (act.missing_dates || []).map(d => d.slice(5)).join(', ');\n            return {\n              activity_type: 'timesheet_reminder',\n              text: `${act.user_name} \u5C1A\u672A\u586B\u5BEB\u5DE5\u6642`,\n              userName: act.user_name,\n              missingCount: act.missing_count || 0,\n              missingDates: missingDates,\n              time: time,\n              link: `/internal/timesheets`\n            };\n          }\n          return null;\n        }).filter(Boolean);\n        \n      } catch (err) {\n        console.error('[\u4EEA\u8868\u677F] \u83B7\u53D6\u6700\u8FD1\u52A8\u6001\u5931\u8D25:', err);\n        console.error('[\u4EEA\u8868\u677F] \u9519\u8BEF\u5806\u6808:', err.stack);\n        console.error('[\u4EEA\u8868\u677F] \u9519\u8BEF\u8BE6\u60C5:', JSON.stringify(err, null, 2));\n        res.recentActivities = [];\n      }\n\n      // Team Members (\u6240\u6709\u7528\u6237\u5217\u8868\uFF0C\u7528\u4E8E\u7B5B\u9009)\n      try {\n        const usersResult = await env.DATABASE.prepare(`\n          SELECT user_id, name, email\n          FROM Users\n          WHERE is_deleted = 0\n          ORDER BY name ASC\n        `).all();\n        res.teamMembers = (usersResult?.results || []).map(u => ({\n          userId: u.user_id,\n          name: u.name,\n          email: u.email\n        }));\n      } catch (err) {\n        console.error('[\u4EEA\u8868\u677F] \u83B7\u53D6\u56E2\u961F\u6210\u5458\u5931\u8D25:', err);\n        res.teamMembers = [];\n      }\n\n      console.log('[\u4EEA\u8868\u677F] \u6700\u7EC8\u8FD4\u56DE\u6570\u636E:');\n      console.log('  - recentActivities.length:', res.recentActivities?.length || 0);\n      console.log('  - teamMembers.length:', res.teamMembers?.length || 0);\n      console.log('  - employeeHours.length:', res.employeeHours?.length || 0);\n      console.log('  - employeeTasks.length:', res.employeeTasks?.length || 0);\n      \n      return res;\n    }\n\n    // \u83B7\u53D6\u6536\u636E\u5DF2\u5F00\u4F46\u4EFB\u52A1\u672A\u5B8C\u6210\u7684\u63D0\u9192\n    async function getReceiptsPendingTasks() {\n      try {\n        const receipts = await env.DATABASE.prepare(`\n          SELECT \n            r.receipt_id,\n            r.receipt_id as receipt_number,\n            r.due_date as receipt_due_date,\n            r.status as receipt_status,\n            c.client_id,\n            c.company_name,\n            cs.client_service_id,\n            s.service_name,\n            COUNT(DISTINCT t.task_id) as total_tasks,\n            COUNT(DISTINCT CASE WHEN t.status = 'completed' THEN t.task_id END) as completed_tasks\n          FROM Receipts r\n          JOIN ClientServices cs ON cs.client_service_id = r.client_service_id\n          JOIN Clients c ON c.client_id = cs.client_id\n          LEFT JOIN Services s ON s.service_id = cs.service_id\n          LEFT JOIN ActiveTasks t ON t.client_service_id = cs.client_service_id \n            AND t.service_month = r.service_month\n            AND t.is_deleted = 0\n          WHERE r.is_deleted = 0\n            AND r.status IN ('pending', 'partial')\n          GROUP BY r.receipt_id\n          HAVING completed_tasks < total_tasks AND total_tasks > 0\n          ORDER BY r.due_date ASC\n          LIMIT 10\n        `).all();\n        \n        return (receipts.results || []).map(r => ({\n          receipt_id: r.receipt_id,\n          receipt_number: r.receipt_number,\n          receipt_due_date: r.receipt_due_date,\n          receipt_status: r.receipt_status,\n          client_id: r.client_id,\n          client_name: r.company_name,\n          service_name: r.service_name || '',\n          total_tasks: Number(r.total_tasks || 0),\n          completed_tasks: Number(r.completed_tasks || 0),\n          pending_tasks: Number(r.total_tasks || 0) - Number(r.completed_tasks || 0)\n        }));\n      } catch (err) {\n        console.error('[Dashboard] getReceiptsPendingTasks \u5931\u8D25:', err);\n        return [];\n      }\n    }\n\n    const data = { role: me.is_admin ? 'admin' : 'employee' };\n    if (me.is_admin) {\n      data.admin = await getAdminMetrics(ym, financeYm, financeMode, searchParams);\n      data.admin.receiptsPendingTasks = await getReceiptsPendingTasks();\n    } else {\n      data.employee = await getEmployeeMetrics();\n      data.employee.receiptsPendingTasks = await getReceiptsPendingTasks();\n    }\n\n    return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, month: ym, financeYm, financeMode, today } }, corsHeaders);\n  } catch (err) {\n    console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n    return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n  }\n}\n\n\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nfunction isValidSchedule(type, value) {\r\n  if (!['daily','weekly','monthly','cron'].includes(type)) return false;\r\n  if (type === 'daily') return /^\\d{2}:\\d{2}$/.test(value||'');\r\n  if (type === 'weekly') return /^([A-Z][a-z]{2})\\s+\\d{2}:\\d{2}$/.test(value||''); // e.g. Mon 03:00\r\n  if (type === 'monthly') return /^(\\d{1,2})\\s+\\d{2}:\\d{2}$/.test(value||''); // e.g. 1 02:00\r\n  if (type === 'cron') return typeof value === 'string' && value.trim().length > 0; // accept any non-empty; real cron parser omitted\r\n  return false;\r\n}\r\n\r\nfunction parseJsonSafe(s, def=null) { try { return JSON.parse(String(s||'null')); } catch(_) { return def; } }\r\n\r\nexport async function handleAutomation(request, env, me, requestId, url, path) {\r\n  const corsHeaders = getCorsHeadersForRequest(request, env);\r\n  if (!me?.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\r\n  const method = request.method.toUpperCase();\r\n\r\n  // List\r\n  if (path === \"/internal/api/v1/admin/automation-rules\" && method === \"GET\") {\r\n    try {\r\n      const p = url.searchParams; const q = (p.get('q')||'').trim(); const enabled = p.get('enabled');\r\n      const page = Math.max(1, parseInt(p.get('page')||'1',10)); const perPage = Math.min(100, Math.max(1, parseInt(p.get('perPage')||'20',10)));\r\n      const offset = (page-1)*perPage; const where=[\"is_deleted=0\"]; const binds=[];\r\n      if (q) { where.push(\"rule_name LIKE ?\"); binds.push(`%${q}%`); }\r\n      if (enabled==='0' || enabled==='1') { where.push(\"is_enabled = ?\"); binds.push(parseInt(enabled,10)); }\r\n      const whereSql = where.length?`WHERE ${where.join(' AND ')}`:'';\r\n      const totalRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM AutomationRules ${whereSql}`).bind(...binds).first();\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT rule_id, rule_name, schedule_type, schedule_value, is_enabled, last_run_at, created_at, updated_at\r\n         FROM AutomationRules ${whereSql} ORDER BY updated_at DESC, rule_id DESC LIMIT ? OFFSET ?`\r\n      ).bind(...binds, perPage, offset).all();\r\n      const data = (rows?.results||[]).map(r=>({ id:r.rule_id, name:r.rule_name, scheduleType:r.schedule_type, scheduleValue:r.schedule_value, isEnabled:r.is_enabled===1, lastRunAt:r.last_run_at, createdAt:r.created_at, updatedAt:r.updated_at }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, page, perPage, total:Number(totalRow?.total||0) } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // Create\r\n  if (path === \"/internal/api/v1/admin/automation-rules\" && method === \"POST\") {\r\n    let body; try { body = await request.json(); } catch(_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n    const name = String(body?.rule_name || body?.name || '').trim();\r\n    const scheduleType = String(body?.schedule_type || body?.scheduleType || '').trim();\r\n    const scheduleValue = String(body?.schedule_value || body?.scheduleValue || '').trim();\r\n    const condition = body?.condition_json ?? body?.condition ?? null;\r\n    const action = body?.action_json ?? body?.action ?? null;\r\n    const errors = [];\r\n    if (!name) errors.push({ field:'rule_name', message:'\u5FC5\u586B' });\r\n    if (!isValidSchedule(scheduleType, scheduleValue)) errors.push({ field:'schedule', message:'\u6392\u7A0B\u4E0D\u5408\u6CD5' });\r\n    if (!action) errors.push({ field:'action', message:'\u5FC5\u586B' });\r\n    if (errors.length) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\r\n    try {\r\n      await env.DATABASE.prepare(\r\n        `INSERT INTO AutomationRules (rule_name, schedule_type, schedule_value, condition_json, action_json, is_enabled) VALUES (?, ?, ?, ?, ?, 1)`\r\n      ).bind(name, scheduleType, scheduleValue, JSON.stringify(condition ?? {}), JSON.stringify(action ?? {})).run();\r\n      const idRow = await env.DATABASE.prepare(`SELECT last_insert_rowid() AS id`).first();\r\n      return jsonResponse(201, { ok:true, code:\"CREATED\", message:\"\u5DF2\u5EFA\u7ACB\", data:{ id:Number(idRow?.id||0) }, meta:{ requestId } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // Update\r\n  const updateMatch = path.match(/^\\/internal\\/api\\/v1\\/admin\\/automation-rules\\/(\\d+)$/);\r\n  if (updateMatch) {\r\n    if (!['PUT','DELETE'].includes(method)) return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n    const id = parseInt(updateMatch[1],10);\r\n    if (method === 'DELETE') {\r\n      try {\r\n        await env.DATABASE.prepare(`UPDATE AutomationRules SET is_deleted = 1 WHERE rule_id = ?`).bind(id).run();\r\n        return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u522A\u9664\", data:{ id }, meta:{ requestId } }, corsHeaders);\r\n      } catch (err) {\r\n        console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n        return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n      }\r\n    }\r\n    let body; try { body = await request.json(); } catch(_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n    const name = body?.rule_name !== undefined ? String(body.rule_name).trim() : undefined;\r\n    const scheduleType = body?.schedule_type !== undefined ? String(body.schedule_type).trim() : undefined;\r\n    const scheduleValue = body?.schedule_value !== undefined ? String(body.schedule_value).trim() : undefined;\r\n    const isEnabled = body?.is_enabled;\r\n    const condition = body?.condition_json !== undefined ? JSON.stringify(parseJsonSafe(body.condition_json, {})) : undefined;\r\n    const action = body?.action_json !== undefined ? JSON.stringify(parseJsonSafe(body.action_json, {})) : undefined;\r\n    const sets = []; const binds = [];\r\n    if (name !== undefined) { if (!name) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u540D\u7A31\u5FC5\u586B\", meta:{ requestId } }, corsHeaders); sets.push('rule_name = ?'); binds.push(name); }\r\n    if (scheduleType !== undefined || scheduleValue !== undefined) {\r\n      const t = scheduleType ?? (await env.DATABASE.prepare(`SELECT schedule_type FROM AutomationRules WHERE rule_id = ?`).bind(id).first())?.schedule_type;\r\n      const v = scheduleValue ?? (await env.DATABASE.prepare(`SELECT schedule_value FROM AutomationRules WHERE rule_id = ?`).bind(id).first())?.schedule_value;\r\n      if (!isValidSchedule(t, v)) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u6392\u7A0B\u4E0D\u5408\u6CD5\", meta:{ requestId } }, corsHeaders);\r\n      if (scheduleType !== undefined) { sets.push('schedule_type = ?'); binds.push(scheduleType); }\r\n      if (scheduleValue !== undefined) { sets.push('schedule_value = ?'); binds.push(scheduleValue); }\r\n    }\r\n    if (condition !== undefined) { sets.push('condition_json = ?'); binds.push(condition); }\r\n    if (action !== undefined) { sets.push('action_json = ?'); binds.push(action); }\r\n    if (isEnabled === 0 || isEnabled === 1 || isEnabled === true || isEnabled === false) { sets.push('is_enabled = ?'); binds.push((isEnabled===1||isEnabled===true)?1:0); }\r\n    if (!sets.length) return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u7121\u53EF\u66F4\u65B0\u6B04\u4F4D\", meta:{ requestId } }, corsHeaders);\r\n    sets.push('updated_at = datetime(\\'now\\')');\r\n    try {\r\n      await env.DATABASE.prepare(`UPDATE AutomationRules SET ${sets.join(', ')} WHERE rule_id = ?`).bind(...binds, id).run();\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u66F4\u65B0\", data:{ id }, meta:{ requestId } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // Test execution (dry run)\r\n  const testMatch = path.match(/^\\/internal\\/api\\/v1\\/admin\\/automation-rules\\/(\\d+)\\/test$/);\r\n  if (testMatch) {\r\n    if (method !== 'POST') return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n    const id = parseInt(testMatch[1], 10);\r\n    try {\r\n      const row = await env.DATABASE.prepare(`SELECT rule_id, rule_name, schedule_type, schedule_value, condition_json, action_json, is_enabled FROM AutomationRules WHERE rule_id = ? AND is_deleted = 0`).bind(id).first();\r\n      if (!row) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u898F\u5247\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n      const condition = parseJsonSafe(row.condition_json, {});\r\n      const action = parseJsonSafe(row.action_json, {});\r\n      // \u9019\u88E1\u50C5\u56DE\u50B3\u5C07\u57F7\u884C\u7684\u52D5\u4F5C\u6458\u8981\uFF08\u4E7E\u8DD1\uFF09\uFF1B\u5BE6\u969B\u57F7\u884C\u4EA4\u7531\u6392\u7A0B\u5668\r\n      const summary = { ruleId: row.rule_id, ruleName: row.rule_name, willExecute: !!row.is_enabled, condition, action };\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6E2C\u8A66\u6210\u529F\", data: summary, meta:{ requestId } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\nimport { generateCacheKey, getCache, saveCache } from \"../cache-helper.js\";\r\n\r\n/**\r\n * GET /api/v1/holidays - \u67E5\u8A62\u5047\u65E5\u8CC7\u6599\r\n */\r\nexport async function handleHolidays(request, env, me, requestId, url) {\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\tconst method = request.method.toUpperCase();\r\n\t\r\n\tif (method === \"GET\") {\r\n\t\ttry {\r\n\t\t\tconst params = url.searchParams;\r\n\t\t\tconst startDate = (params.get(\"start_date\") || \"\").trim();\r\n\t\t\tconst endDate = (params.get(\"end_date\") || \"\").trim();\r\n\t\t\t\r\n\t\t\t// \u26A1 \u5C1D\u8BD5\u4ECE\u7F13\u5B58\u8BFB\u53D6\r\n\t\t\tconst cacheKey = generateCacheKey('holidays_all', { start: startDate, end: endDate });\r\n\t\t\tconst cached = await getCache(env, cacheKey);\r\n\t\t\t\r\n\t\t\tif (cached && cached.data) {\r\n\t\t\t\treturn jsonResponse(200, { \r\n\t\t\t\t\tok: true, \r\n\t\t\t\t\tcode: \"SUCCESS\", \r\n\t\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\uFF08\u7F13\u5B58\uFF09\", \r\n\t\t\t\t\tdata: cached.data, \r\n\t\t\t\t\tmeta: { requestId, ...cached.meta } \r\n\t\t\t\t}, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst where = [];\r\n\t\t\tconst binds = [];\r\n\t\t\t\r\n\t\t\t// \u65E5\u671F\u7BC4\u570D\u7BE9\u9078\r\n\t\t\tif (startDate) {\r\n\t\t\t\twhere.push(\"holiday_date >= ?\");\r\n\t\t\t\tbinds.push(startDate);\r\n\t\t\t}\r\n\t\t\tif (endDate) {\r\n\t\t\t\twhere.push(\"holiday_date <= ?\");\r\n\t\t\t\tbinds.push(endDate);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n\t\t\t\r\n\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT holiday_date, name, is_national_holiday, is_weekly_restday, is_makeup_workday\r\n\t\t\t\t FROM Holidays\r\n\t\t\t\t ${whereSql}\r\n\t\t\t\t ORDER BY holiday_date ASC`\r\n\t\t\t).bind(...binds).all();\r\n\t\t\t\r\n\t\tconst data = (rows?.results || []).map(r => ({\r\n\t\t\tholiday_date: r.holiday_date, // \u524D\u7AEF\u671F\u671B\u7684\u6B04\u4F4D\u540D\u7A31\r\n\t\t\tdate: r.holiday_date,         // \u5411\u5F8C\u517C\u5BB9\r\n\t\t\tname: r.name || \"\",\r\n\t\t\tis_national_holiday: Boolean(r.is_national_holiday),\r\n\t\t\tis_weekly_restday: Boolean(r.is_weekly_restday),\r\n\t\t\tis_makeup_workday: Boolean(r.is_makeup_workday),\r\n\t\t}));\r\n\t\t\t\r\n\t\t\t// \u26A1 \u4FDD\u5B58\u5230\u7F13\u5B58\uFF08\u4E0D\u7B49\u5F85\u5B8C\u6210\uFF09\r\n\t\t\tsaveCache(env, cacheKey, 'holidays_all', data, {\r\n\t\t\t\tscopeParams: { start: startDate, end: endDate }\r\n\t\t\t}).catch(err => console.error('[HOLIDAYS] \u7F13\u5B58\u4FDD\u5B58\u5931\u8D25:', err));\r\n\t\t\t\r\n\t\t\treturn jsonResponse(200, { \r\n\t\t\t\tok: true, \r\n\t\t\t\tcode: \"SUCCESS\", \r\n\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\", \r\n\t\t\t\tdata, \r\n\t\t\t\tmeta: { requestId } \r\n\t\t\t}, corsHeaders);\r\n\t\t\t\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\r\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, getCorsHeadersForRequest(request, env));\r\n\t\t}\r\n\t}\r\n\t\r\n\treturn jsonResponse(405, { \r\n\t\tok: false, \r\n\t\tcode: \"METHOD_NOT_ALLOWED\", \r\n\t\tmessage: \"\u65B9\u6CD5\u4E0D\u5141\u8A31\", \r\n\t\tmeta: { requestId } \r\n\t}, corsHeaders);\r\n}\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\n/**\r\n * \u6A19\u7C64\u7BA1\u7406 API\r\n * GET /api/v1/tags - \u67E5\u8A62\u6240\u6709\u6A19\u7C64\r\n * POST /api/v1/tags - \u65B0\u589E\u6A19\u7C64\r\n * PUT /api/v1/tags/:id - \u66F4\u65B0\u6A19\u7C64\r\n * DELETE /api/v1/tags/:id - \u522A\u9664\u6A19\u7C64\r\n */\r\nexport async function handleTags(request, env, me, requestId, url) {\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\tconst method = request.method.toUpperCase();\r\n\t\r\n\t// GET /api/v1/tags - \u67E5\u8A62\u6240\u6709\u6A19\u7C64\r\n\tif (method === \"GET\" && !url.pathname.match(/\\/tags\\/\\d+$/)) {\r\n\t\ttry {\r\n\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t\"SELECT tag_id, tag_name, tag_color, created_at FROM CustomerTags ORDER BY tag_name ASC\"\r\n\t\t\t).all();\r\n\t\t\t\r\n\t\t\tconst data = (rows?.results || []).map(r => ({\r\n\t\t\t\ttag_id: r.tag_id,\r\n\t\t\t\ttag_name: r.tag_name,\r\n\t\t\t\ttag_color: r.tag_color || null,\r\n\t\t\t\tcreated_at: r.created_at\r\n\t\t\t}));\r\n\t\t\t\r\n\t\t\treturn jsonResponse(200, { \r\n\t\t\t\tok: true, \r\n\t\t\t\tcode: \"SUCCESS\", \r\n\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\", \r\n\t\t\t\tdata, \r\n\t\t\t\tmeta: { requestId } \r\n\t\t\t}, corsHeaders);\r\n\t\t\t\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\r\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, corsHeaders);\r\n\t\t}\r\n\t}\r\n\t\r\n\t// GET /api/v1/tags/:id - \u67E5\u8A62\u55AE\u4E00\u6A19\u7C64\r\n\tif (method === \"GET\" && url.pathname.match(/\\/tags\\/\\d+$/)) {\r\n\t\tconst tagId = parseInt(url.pathname.split(\"/\").pop(), 10);\r\n\t\ttry {\r\n\t\t\tconst row = await env.DATABASE.prepare(\r\n\t\t\t\t\"SELECT tag_id, tag_name, tag_color, created_at FROM CustomerTags WHERE tag_id = ?\"\r\n\t\t\t).bind(tagId).first();\r\n\t\t\t\r\n\t\t\tif (!row) {\r\n\t\t\t\treturn jsonResponse(404, { \r\n\t\t\t\t\tok: false, \r\n\t\t\t\t\tcode: \"NOT_FOUND\", \r\n\t\t\t\t\tmessage: \"\u6A19\u7C64\u4E0D\u5B58\u5728\", \r\n\t\t\t\t\tmeta: { requestId } \r\n\t\t\t\t}, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst data = {\r\n\t\t\t\ttag_id: row.tag_id,\r\n\t\t\t\ttag_name: row.tag_name,\r\n\t\t\t\ttag_color: row.tag_color || null,\r\n\t\t\t\tcreated_at: row.created_at\r\n\t\t\t};\r\n\t\t\t\r\n\t\t\treturn jsonResponse(200, { \r\n\t\t\t\tok: true, \r\n\t\t\t\tcode: \"SUCCESS\", \r\n\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\", \r\n\t\t\t\tdata, \r\n\t\t\t\tmeta: { requestId } \r\n\t\t\t}, corsHeaders);\r\n\t\t\t\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\r\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, corsHeaders);\r\n\t\t}\r\n\t}\r\n\t\r\n\t// POST /api/v1/tags - \u65B0\u589E\u6A19\u7C64\r\n\tif (method === \"POST\") {\r\n\t\tlet body;\r\n\t\ttry {\r\n\t\t\tbody = await request.json();\r\n\t\t} catch (_) {\r\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\r\n\t\t}\r\n\t\t\r\n\t\tconst errors = [];\r\n\t\tconst tagName = String(body?.tag_name || \"\").trim();\r\n\t\tconst tagColor = String(body?.tag_color || \"\").trim();\r\n\t\t\r\n\t\t// \u9A57\u8B49\r\n\t\tif (!tagName || tagName.length < 1 || tagName.length > 50) {\r\n\t\t\terrors.push({ field: \"tag_name\", message: \"\u6A19\u7C64\u540D\u7A31\u70BA\u5FC5\u586B\uFF081-50\u5B57\uFF09\" });\r\n\t\t}\r\n\t\tif (tagColor && !/^#[0-9A-Fa-f]{6}$/.test(tagColor)) {\r\n\t\t\terrors.push({ field: \"tag_color\", message: \"\u984F\u8272\u78BC\u683C\u5F0F\u932F\u8AA4\uFF08\u9700\u70BA #RRGGBB\uFF09\" });\r\n\t\t}\r\n\t\tif (errors.length) {\r\n\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, corsHeaders);\r\n\t\t}\r\n\t\t\r\n\t\ttry {\r\n\t\t\t// \u6AA2\u67E5\u6A19\u7C64\u540D\u7A31\u552F\u4E00\u6027\r\n\t\t\tconst existing = await env.DATABASE.prepare(\"SELECT 1 FROM CustomerTags WHERE tag_name = ? LIMIT 1\").bind(tagName).first();\r\n\t\t\tif (existing) {\r\n\t\t\t\treturn jsonResponse(409, { ok: false, code: \"CONFLICT\", message: \"\u6A19\u7C64\u540D\u7A31\u5DF2\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst now = new Date().toISOString();\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\"INSERT INTO CustomerTags (tag_name, tag_color, created_at) VALUES (?, ?, ?)\"\r\n\t\t\t).bind(tagName, tagColor || null, now).run();\r\n\t\t\t\r\n\t\t\tconst idRow = await env.DATABASE.prepare(\"SELECT last_insert_rowid() AS id\").first();\r\n\t\t\tconst data = { tag_id: idRow?.id, tag_name: tagName, tag_color: tagColor || null, created_at: now };\r\n\t\t\t\r\n\t\t\treturn jsonResponse(201, { ok: true, code: \"CREATED\", message: \"\u5DF2\u5EFA\u7ACB\", data, meta: { requestId } }, corsHeaders);\r\n\t\t\t\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\r\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, corsHeaders);\r\n\t\t}\r\n\t}\r\n\t\r\n\t// PUT /api/v1/tags/:id - \u66F4\u65B0\u6A19\u7C64\r\n\tif (method === \"PUT\" && url.pathname.match(/\\/tags\\/\\d+$/)) {\r\n\t\tconst tagId = parseInt(url.pathname.split(\"/\").pop(), 10);\r\n\t\tlet body;\r\n\t\ttry {\r\n\t\t\tbody = await request.json();\r\n\t\t} catch (_) {\r\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\r\n\t\t}\r\n\t\t\r\n\t\tconst errors = [];\r\n\t\tconst tagName = body?.tag_name ? String(body.tag_name).trim() : null;\r\n\t\tconst tagColor = body?.tag_color ? String(body.tag_color).trim() : null;\r\n\t\t\r\n\t\t// \u9A57\u8B49\r\n\t\tif (tagName !== null && (tagName.length < 1 || tagName.length > 50)) {\r\n\t\t\terrors.push({ field: \"tag_name\", message: \"\u6A19\u7C64\u540D\u7A31\u9577\u5EA6\u9700\u70BA 1-50\u5B57\" });\r\n\t\t}\r\n\t\tif (tagColor !== null && tagColor !== \"\" && !/^#[0-9A-Fa-f]{6}$/.test(tagColor)) {\r\n\t\t\terrors.push({ field: \"tag_color\", message: \"\u984F\u8272\u78BC\u683C\u5F0F\u932F\u8AA4\uFF08\u9700\u70BA #RRGGBB\uFF09\" });\r\n\t\t}\r\n\t\tif (errors.length) {\r\n\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, corsHeaders);\r\n\t\t}\r\n\t\t\r\n\t\ttry {\r\n\t\t\t// \u6AA2\u67E5\u6A19\u7C64\u662F\u5426\u5B58\u5728\r\n\t\t\tconst existing = await env.DATABASE.prepare(\"SELECT 1 FROM CustomerTags WHERE tag_id = ? LIMIT 1\").bind(tagId).first();\r\n\t\t\tif (!existing) {\r\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6A19\u7C64\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// \u5982\u679C\u66F4\u65B0\u540D\u7A31\uFF0C\u6AA2\u67E5\u552F\u4E00\u6027\r\n\t\t\tif (tagName !== null) {\r\n\t\t\t\tconst dup = await env.DATABASE.prepare(\"SELECT 1 FROM CustomerTags WHERE tag_name = ? AND tag_id != ? LIMIT 1\").bind(tagName, tagId).first();\r\n\t\t\t\tif (dup) {\r\n\t\t\t\t\treturn jsonResponse(409, { ok: false, code: \"CONFLICT\", message: \"\u6A19\u7C64\u540D\u7A31\u5DF2\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// \u69CB\u5EFA\u66F4\u65B0\u8A9E\u53E5\r\n\t\t\tconst updates = [];\r\n\t\t\tconst binds = [];\r\n\t\t\tif (tagName !== null) {\r\n\t\t\t\tupdates.push(\"tag_name = ?\");\r\n\t\t\t\tbinds.push(tagName);\r\n\t\t\t}\r\n\t\t\tif (tagColor !== null) {\r\n\t\t\t\tupdates.push(\"tag_color = ?\");\r\n\t\t\t\tbinds.push(tagColor === \"\" ? null : tagColor);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (updates.length === 0) {\r\n\t\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u6C92\u6709\u53EF\u66F4\u65B0\u7684\u6B04\u4F4D\", meta: { requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tbinds.push(tagId);\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t`UPDATE CustomerTags SET ${updates.join(\", \")} WHERE tag_id = ?`\r\n\t\t\t).bind(...binds).run();\r\n\t\t\t\r\n\t\t\tconst data = { tag_id: tagId, tag_name: tagName, tag_color: tagColor };\r\n\t\t\treturn jsonResponse(200, { ok: true, code: \"SUCCESS\", message: \"\u5DF2\u66F4\u65B0\", data, meta: { requestId } }, corsHeaders);\r\n\t\t\t\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\r\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, corsHeaders);\r\n\t\t}\r\n\t}\r\n\t\r\n\t// DELETE /api/v1/tags/:id - \u522A\u9664\u6A19\u7C64\r\n\tif (method === \"DELETE\" && url.pathname.match(/\\/tags\\/\\d+$/)) {\r\n\t\tconst tagId = parseInt(url.pathname.split(\"/\").pop(), 10);\r\n\t\ttry {\r\n\t\t\t// \u6AA2\u67E5\u6A19\u7C64\u662F\u5426\u5B58\u5728\r\n\t\t\tconst existing = await env.DATABASE.prepare(\"SELECT 1 FROM CustomerTags WHERE tag_id = ? LIMIT 1\").bind(tagId).first();\r\n\t\t\tif (!existing) {\r\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6A19\u7C64\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// \u6AA2\u67E5\u662F\u5426\u6709\u5BA2\u6236\u4F7F\u7528\u6B64\u6A19\u7C64\r\n\t\t\tconst usage = await env.DATABASE.prepare(\"SELECT COUNT(1) as cnt FROM ClientTagAssignments WHERE tag_id = ?\").bind(tagId).first();\r\n\t\t\tif (Number(usage?.cnt || 0) > 0) {\r\n\t\t\t\treturn jsonResponse(409, { \r\n\t\t\t\t\tok: false, \r\n\t\t\t\t\tcode: \"CONFLICT\", \r\n\t\t\t\t\tmessage: `\u6B64\u6A19\u7C64\u6B63\u88AB ${usage.cnt} \u500B\u5BA2\u6236\u4F7F\u7528\uFF0C\u7121\u6CD5\u522A\u9664`, \r\n\t\t\t\t\tmeta: { requestId } \r\n\t\t\t\t}, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// \u522A\u9664\u6A19\u7C64\r\n\t\t\tawait env.DATABASE.prepare(\"DELETE FROM CustomerTags WHERE tag_id = ?\").bind(tagId).run();\r\n\t\t\t\r\n\t\t\treturn jsonResponse(200, { ok: true, code: \"SUCCESS\", message: \"\u5DF2\u522A\u9664\", meta: { requestId } }, corsHeaders);\r\n\t\t\t\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\r\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, corsHeaders);\r\n\t\t}\r\n\t}\r\n\t\r\n\treturn jsonResponse(405, { ok: false, code: \"METHOD_NOT_ALLOWED\", message: \"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta: { requestId } }, corsHeaders);\r\n}\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nfunction parseId(s) {\r\n  const n = parseInt(String(s || \"\"), 10);\r\n  return Number.isFinite(n) && n > 0 ? n : null;\r\n}\r\n\r\nexport async function handleBilling(request, env, me, requestId, url, path) {\r\n  const corsHeaders = getCorsHeadersForRequest(request, env);\r\n  const method = request.method.toUpperCase();\r\n\r\n  // GET /internal/api/v1/billing/service/:serviceId - \u83B7\u53D6\u670D\u52A1\u7684\u6536\u8D39\u660E\u7EC6\r\n  const matchGet = path.match(/^\\/internal\\/api\\/v1\\/billing\\/service\\/(\\d+)$/);\r\n  if (method === \"GET\" && matchGet) {\r\n    const clientServiceId = parseId(matchGet[1]);\r\n    if (!clientServiceId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u670D\u52A1ID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u670D\u52A1\u662F\u5426\u5B58\u5728\u4E14\u6709\u6743\u9650\u8BBF\u95EE\r\n      const service = await env.DATABASE.prepare(\r\n        `SELECT cs.client_service_id, cs.client_id, c.assignee_user_id\r\n         FROM ClientServices cs\r\n         LEFT JOIN Clients c ON c.client_id = cs.client_id\r\n         WHERE cs.client_service_id = ? AND cs.is_deleted = 0`\r\n      ).bind(clientServiceId).first();\r\n\r\n      if (!service) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u670D\u52A1\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u6743\u9650\u68C0\u67E5\uFF1A\u7BA1\u7406\u5458\u6216\u8D1F\u8D23\u4EBA\u53EF\u67E5\u770B\r\n      if (!me.is_admin && service.assignee_user_id !== me.user_id) {\r\n        return jsonResponse(403, { ok: false, code: \"FORBIDDEN\", message: \"\u65E0\u6743\u9650\u8BBF\u95EE\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u83B7\u53D6\u6536\u8D39\u660E\u7EC6\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT schedule_id, billing_month, billing_amount, payment_due_days, notes, \r\n                billing_type, billing_date, description, created_at, updated_at\r\n         FROM ServiceBillingSchedule\r\n         WHERE client_service_id = ?\r\n         ORDER BY billing_type ASC, billing_month ASC`\r\n      ).bind(clientServiceId).all();\r\n\r\n      const data = (rows?.results || []).map(r => ({\r\n        schedule_id: r.schedule_id,\r\n        billing_month: r.billing_month,\r\n        billing_amount: Number(r.billing_amount || 0),\r\n        payment_due_days: Number(r.payment_due_days || 30),\r\n        notes: r.notes || \"\",\r\n        billing_type: r.billing_type || 'monthly',\r\n        billing_date: r.billing_date || null,\r\n        description: r.description || null,\r\n        created_at: r.created_at,\r\n        updated_at: r.updated_at\r\n      }));\r\n\r\n      // \u8BA1\u7B97\u5E74\u5EA6\u603B\u989D\r\n      const yearTotal = data.reduce((sum, item) => sum + item.billing_amount, 0);\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u67E5\u8BE2\u6210\u529F\",\r\n        data: {\r\n          schedules: data,\r\n          year_total: yearTotal\r\n        },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // POST /internal/api/v1/billing - \u65B0\u589E\u6536\u8D39\u660E\u7EC6\uFF08\u65B0endpoint\uFF09\r\n  if (method === \"POST\" && path === \"/internal/api/v1/billing\") {\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch (_) {\r\n      return jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    const clientServiceId = parseId(body?.client_service_id);\r\n    if (!clientServiceId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u670D\u52A1ID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    const errors = [];\r\n    const billingType = String(body?.billing_type || \"monthly\").trim();\r\n    const billingMonth = parseInt(body?.billing_month, 10);\r\n    const billingAmount = parseFloat(body?.billing_amount);\r\n    const paymentDueDays = parseInt(body?.payment_due_days || 30, 10);\r\n    const notes = String(body?.notes || \"\").trim();\r\n    const billingDate = String(body?.billing_date || \"\").trim();\r\n    const description = String(body?.description || \"\").trim();\r\n\r\n    // \u9A8C\u8BC1\u6536\u8D39\u7C7B\u578B\r\n    if (!['monthly', 'one-time'].includes(billingType)) {\r\n      errors.push({ field: \"billing_type\", message: \"\u6536\u8D39\u7C7B\u578B\u5FC5\u987B\u4E3Amonthly\u6216one-time\" });\r\n    }\r\n\r\n    // \u6839\u636E\u7C7B\u578B\u9A8C\u8BC1\u5B57\u6BB5\r\n    if (billingType === 'monthly') {\r\n      if (!Number.isInteger(billingMonth) || billingMonth < 1 || billingMonth > 12) {\r\n        errors.push({ field: \"billing_month\", message: \"\u6708\u4EFD\u5FC5\u987B\u57281-12\u4E4B\u95F4\" });\r\n      }\r\n    } else if (billingType === 'one-time') {\r\n      if (!billingDate) {\r\n        errors.push({ field: \"billing_date\", message: \"\u4E00\u6B21\u6027\u6536\u8D39\u5FC5\u987B\u63D0\u4F9B\u65E5\u671F\" });\r\n      }\r\n      if (!description) {\r\n        errors.push({ field: \"description\", message: \"\u4E00\u6B21\u6027\u6536\u8D39\u5FC5\u987B\u63D0\u4F9B\u8BF4\u660E\" });\r\n      }\r\n    }\r\n\r\n    if (isNaN(billingAmount) || billingAmount < 0) {\r\n      errors.push({ field: \"billing_amount\", message: \"\u91D1\u989D\u5FC5\u987B\u4E3A\u975E\u8D1F\u6570\" });\r\n    }\r\n    if (!Number.isInteger(paymentDueDays) || paymentDueDays < 1) {\r\n      errors.push({ field: \"payment_due_days\", message: \"\u6536\u6B3E\u671F\u9650\u5FC5\u987B\u5927\u4E8E0\" });\r\n    }\r\n\r\n    if (errors.length) {\r\n      return jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F93\u5165\u6709\u8BEF\", errors, meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u670D\u52A1\u662F\u5426\u5B58\u5728\r\n      const service = await env.DATABASE.prepare(\r\n        \"SELECT client_service_id FROM ClientServices WHERE client_service_id = ? AND is_deleted = 0\"\r\n      ).bind(clientServiceId).first();\r\n\r\n      if (!service) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u670D\u52A1\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u5982\u679C\u662F\u6309\u6708\u6536\u8D39\uFF0C\u68C0\u67E5\u8BE5\u6708\u4EFD\u662F\u5426\u5DF2\u5B58\u5728\r\n      if (billingType === 'monthly') {\r\n        const existing = await env.DATABASE.prepare(\r\n          \"SELECT schedule_id FROM ServiceBillingSchedule WHERE client_service_id = ? AND billing_month = ? AND billing_type = 'monthly'\"\r\n        ).bind(clientServiceId, billingMonth).first();\r\n\r\n        if (existing) {\r\n          return jsonResponse(422, {\r\n            ok: false,\r\n            code: \"DUPLICATE\",\r\n            message: \"\u8BE5\u6708\u4EFD\u5DF2\u8BBE\u5B9A\u6536\u8D39\",\r\n            errors: [{ field: \"billing_month\", message: \"\u8BE5\u6708\u4EFD\u5DF2\u5B58\u5728\" }],\r\n            meta: { requestId }\r\n          }, corsHeaders);\r\n        }\r\n      }\r\n\r\n      // \u63D2\u5165\u6536\u8D39\u660E\u7EC6\r\n      const result = await env.DATABASE.prepare(\r\n        `INSERT INTO ServiceBillingSchedule \r\n         (client_service_id, billing_type, billing_month, billing_amount, payment_due_days, notes, billing_date, description)\r\n         VALUES (?, ?, ?, ?, ?, ?, ?, ?)`\r\n      ).bind(\r\n        clientServiceId, \r\n        billingType, \r\n        billingType === 'monthly' ? billingMonth : 0, \r\n        billingAmount, \r\n        paymentDueDays, \r\n        notes || null,\r\n        billingDate || null,\r\n        description || null\r\n      ).run();\r\n\r\n      const scheduleId = result?.meta?.last_row_id;\r\n\r\n      return jsonResponse(201, {\r\n        ok: true,\r\n        code: \"CREATED\",\r\n        message: \"\u6536\u8D39\u660E\u7EC6\u5DF2\u65B0\u589E\",\r\n        data: { schedule_id: scheduleId },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n  \r\n  // POST /internal/api/v1/billing/service/:serviceId - \u65B0\u589E\u6536\u8D39\u660E\u7EC6\uFF08\u65E7endpoint\uFF0C\u4FDD\u7559\u517C\u5BB9\u6027\uFF09\r\n  if (method === \"POST\" && matchGet) {\r\n    const clientServiceId = parseId(matchGet[1]);\r\n    if (!clientServiceId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u670D\u52A1ID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch (_) {\r\n      return jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    const errors = [];\r\n    const billingMonth = parseInt(body?.billing_month, 10);\r\n    const billingAmount = parseFloat(body?.billing_amount);\r\n    const paymentDueDays = parseInt(body?.payment_due_days || 30, 10);\r\n    const notes = String(body?.notes || \"\").trim();\r\n\r\n    // \u9A8C\u8BC1\r\n    if (!Number.isInteger(billingMonth) || billingMonth < 1 || billingMonth > 12) {\r\n      errors.push({ field: \"billing_month\", message: \"\u6708\u4EFD\u5FC5\u987B\u57281-12\u4E4B\u95F4\" });\r\n    }\r\n    if (isNaN(billingAmount) || billingAmount < 0) {\r\n      errors.push({ field: \"billing_amount\", message: \"\u91D1\u989D\u5FC5\u987B\u4E3A\u975E\u8D1F\u6570\" });\r\n    }\r\n    if (!Number.isInteger(paymentDueDays) || paymentDueDays < 1) {\r\n      errors.push({ field: \"payment_due_days\", message: \"\u6536\u6B3E\u671F\u9650\u5FC5\u987B\u5927\u4E8E0\" });\r\n    }\r\n\r\n    if (errors.length) {\r\n      return jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F93\u5165\u6709\u8BEF\", errors, meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u670D\u52A1\u662F\u5426\u5B58\u5728\r\n      const service = await env.DATABASE.prepare(\r\n        \"SELECT client_service_id FROM ClientServices WHERE client_service_id = ? AND is_deleted = 0\"\r\n      ).bind(clientServiceId).first();\r\n\r\n      if (!service) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u670D\u52A1\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u68C0\u67E5\u8BE5\u6708\u4EFD\u662F\u5426\u5DF2\u5B58\u5728\r\n      const existing = await env.DATABASE.prepare(\r\n        \"SELECT schedule_id FROM ServiceBillingSchedule WHERE client_service_id = ? AND billing_month = ?\"\r\n      ).bind(clientServiceId, billingMonth).first();\r\n\r\n      if (existing) {\r\n        return jsonResponse(422, {\r\n          ok: false,\r\n          code: \"DUPLICATE\",\r\n          message: \"\u8BE5\u6708\u4EFD\u5DF2\u8BBE\u5B9A\u6536\u8D39\",\r\n          errors: [{ field: \"billing_month\", message: \"\u8BE5\u6708\u4EFD\u5DF2\u5B58\u5728\" }],\r\n          meta: { requestId }\r\n        }, corsHeaders);\r\n      }\r\n\r\n      // \u63D2\u5165\u6536\u8D39\u660E\u7EC6\r\n      const result = await env.DATABASE.prepare(\r\n        `INSERT INTO ServiceBillingSchedule (client_service_id, billing_type, billing_month, billing_amount, payment_due_days, notes)\r\n         VALUES (?, 'monthly', ?, ?, ?, ?)`\r\n      ).bind(clientServiceId, billingMonth, billingAmount, paymentDueDays, notes).run();\r\n\r\n      const scheduleId = result?.meta?.last_row_id;\r\n\r\n      return jsonResponse(201, {\r\n        ok: true,\r\n        code: \"CREATED\",\r\n        message: \"\u6536\u8D39\u660E\u7EC6\u5DF2\u65B0\u589E\",\r\n        data: { schedule_id: scheduleId },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // PUT /internal/api/v1/billing/:scheduleId - \u66F4\u65B0\u6536\u8D39\u660E\u7EC6\r\n  const matchUpdate = path.match(/^\\/internal\\/api\\/v1\\/billing\\/(\\d+)$/);\r\n  if (method === \"PUT\" && matchUpdate) {\r\n    const scheduleId = parseId(matchUpdate[1]);\r\n    if (!scheduleId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u660E\u7EC6ID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch (_) {\r\n      return jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    const errors = [];\r\n    const billingAmount = parseFloat(body?.billing_amount);\r\n    const paymentDueDays = parseInt(body?.payment_due_days || 30, 10);\r\n    const notes = String(body?.notes || \"\").trim();\r\n\r\n    // \u9A8C\u8BC1\r\n    if (isNaN(billingAmount) || billingAmount < 0) {\r\n      errors.push({ field: \"billing_amount\", message: \"\u91D1\u989D\u5FC5\u987B\u4E3A\u975E\u8D1F\u6570\" });\r\n    }\r\n    if (!Number.isInteger(paymentDueDays) || paymentDueDays < 1) {\r\n      errors.push({ field: \"payment_due_days\", message: \"\u6536\u6B3E\u671F\u9650\u5FC5\u987B\u5927\u4E8E0\" });\r\n    }\r\n\r\n    if (errors.length) {\r\n      return jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F93\u5165\u6709\u8BEF\", errors, meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u660E\u7EC6\u662F\u5426\u5B58\u5728\r\n      const existing = await env.DATABASE.prepare(\r\n        \"SELECT schedule_id FROM ServiceBillingSchedule WHERE schedule_id = ?\"\r\n      ).bind(scheduleId).first();\r\n\r\n      if (!existing) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6536\u8D39\u660E\u7EC6\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u66F4\u65B0\u6536\u8D39\u660E\u7EC6\r\n      await env.DATABASE.prepare(\r\n        `UPDATE ServiceBillingSchedule \r\n         SET billing_amount = ?, payment_due_days = ?, notes = ?, updated_at = datetime('now')\r\n         WHERE schedule_id = ?`\r\n      ).bind(billingAmount, paymentDueDays, notes, scheduleId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u6536\u8D39\u660E\u7EC6\u5DF2\u66F4\u65B0\",\r\n        data: { schedule_id: scheduleId },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // DELETE /internal/api/v1/billing/:scheduleId - \u5220\u9664\u6536\u8D39\u660E\u7EC6\r\n  if (method === \"DELETE\" && matchUpdate) {\r\n    const scheduleId = parseId(matchUpdate[1]);\r\n    if (!scheduleId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u660E\u7EC6ID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u660E\u7EC6\u662F\u5426\u5B58\u5728\r\n      const existing = await env.DATABASE.prepare(\r\n        \"SELECT schedule_id FROM ServiceBillingSchedule WHERE schedule_id = ?\"\r\n      ).bind(scheduleId).first();\r\n\r\n      if (!existing) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6536\u8D39\u660E\u7EC6\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u5220\u9664\u6536\u8D39\u660E\u7EC6\r\n      await env.DATABASE.prepare(\r\n        \"DELETE FROM ServiceBillingSchedule WHERE schedule_id = ?\"\r\n      ).bind(scheduleId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u6536\u8D39\u660E\u7EC6\u5DF2\u5220\u9664\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u8DEF\u7531\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n}\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nfunction parseId(s) {\r\n  const n = parseInt(String(s || \"\"), 10);\r\n  return Number.isFinite(n) && n > 0 ? n : null;\r\n}\r\n\r\nexport async function handleTaskTemplates(request, env, me, requestId, url, path) {\r\n  const corsHeaders = getCorsHeadersForRequest(request, env);\r\n  const method = request.method.toUpperCase();\r\n\r\n  // GET /internal/api/v1/task-templates - \u83B7\u53D6\u4EFB\u52A1\u6A21\u677F\u5217\u8868\r\n  if (method === \"GET\" && path === \"/internal/api/v1/task-templates\") {\r\n    const serviceId = url.searchParams.get(\"service_id\");\r\n    const clientId = url.searchParams.get(\"client_id\");\r\n\r\n    try {\r\n      let query = `\r\n        SELECT tt.template_id, tt.template_name, tt.service_id, tt.client_id, tt.description, \r\n               tt.sop_id, tt.is_active, tt.created_at,\r\n               tt.default_due_date_rule, tt.default_due_date_value, \r\n               tt.default_due_date_offset_days, tt.default_advance_days,\r\n               s.service_name, s.service_code,\r\n               c.company_name as client_name,\r\n               (SELECT COUNT(*) FROM TaskTemplateStages WHERE template_id = tt.template_id) as stages_count\r\n        FROM TaskTemplates tt\r\n        LEFT JOIN Services s ON s.service_id = tt.service_id\r\n        LEFT JOIN Clients c ON c.client_id = tt.client_id\r\n        WHERE 1=1\r\n      `;\r\n      const params = [];\r\n\r\n      if (serviceId) {\r\n        query += ` AND tt.service_id = ?`;\r\n        params.push(parseInt(serviceId, 10));\r\n      }\r\n\r\n      if (clientId) {\r\n        if (clientId === 'null') {\r\n          query += ` AND tt.client_id IS NULL`;\r\n        } else {\r\n          query += ` AND tt.client_id = ?`;\r\n          params.push(parseInt(clientId, 10));\r\n        }\r\n      }\r\n\r\n      query += ` ORDER BY tt.template_name ASC`;\r\n\r\n      const stmt = params.length > 0 \r\n        ? env.DATABASE.prepare(query).bind(...params)\r\n        : env.DATABASE.prepare(query);\r\n\r\n      const rows = await stmt.all();\r\n\r\n      const data = (rows?.results || []).map(r => ({\r\n        template_id: r.template_id,\r\n        template_name: r.template_name || \"\",\r\n        service_id: r.service_id || null,\r\n        service_name: r.service_name || \"\",\r\n        service_code: r.service_code || \"\",\r\n        client_id: r.client_id || null,\r\n        client_name: r.client_name || \"\",\r\n        description: r.description || \"\",\r\n        sop_id: r.sop_id || null,\r\n        is_active: Boolean(r.is_active),\r\n        created_at: r.created_at,\r\n        stages_count: r.stages_count || 0,\r\n        default_due_date_rule: r.default_due_date_rule || null,\r\n        default_due_date_value: r.default_due_date_value || null,\r\n        default_due_date_offset_days: r.default_due_date_offset_days || 0,\r\n        default_advance_days: r.default_advance_days || 7\r\n      }));\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u67E5\u8BE2\u6210\u529F\",\r\n        data: data,\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // GET /internal/api/v1/task-templates/:id - \u83B7\u53D6\u4EFB\u52A1\u6A21\u677F\u8BE6\u60C5\uFF08\u542B\u9636\u6BB5\uFF09\r\n  const matchGet = path.match(/^\\/internal\\/api\\/v1\\/task-templates\\/(\\d+)$/);\r\n  if (method === \"GET\" && matchGet) {\r\n    const templateId = parseId(matchGet[1]);\r\n    if (!templateId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u6A21\u677FID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u83B7\u53D6\u6A21\u677F\u57FA\u672C\u4FE1\u606F\r\n      const template = await env.DATABASE.prepare(\r\n        `SELECT tt.template_id, tt.template_name, tt.service_id, tt.description, \r\n                tt.sop_id, tt.is_active, tt.created_at,\r\n                s.service_name, s.service_code\r\n         FROM TaskTemplates tt\r\n         LEFT JOIN Services s ON s.service_id = tt.service_id\r\n         WHERE tt.template_id = ?`\r\n      ).bind(templateId).first();\r\n\r\n      if (!template) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6A21\u677F\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u83B7\u53D6\u9636\u6BB5\u5217\u8868\r\n      const stagesRows = await env.DATABASE.prepare(\r\n        `SELECT stage_id, stage_name, stage_order, description, estimated_hours\r\n         FROM TaskTemplateStages\r\n         WHERE template_id = ?\r\n         ORDER BY stage_order ASC`\r\n      ).bind(templateId).all();\r\n\r\n      const stages = (stagesRows?.results || []).map(s => ({\r\n        stage_id: s.stage_id,\r\n        stage_name: s.stage_name || \"\",\r\n        stage_order: s.stage_order,\r\n        description: s.description || \"\",\r\n        estimated_hours: Number(s.estimated_hours || 0)\r\n      }));\r\n\r\n      const data = {\r\n        template_id: template.template_id,\r\n        template_name: template.template_name || \"\",\r\n        service_id: template.service_id || null,\r\n        service_name: template.service_name || \"\",\r\n        service_code: template.service_code || \"\",\r\n        description: template.description || \"\",\r\n        sop_id: template.sop_id || null,\r\n        is_active: Boolean(template.is_active),\r\n        created_at: template.created_at,\r\n        stages: stages\r\n      };\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u67E5\u8BE2\u6210\u529F\",\r\n        data: data,\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // POST /internal/api/v1/task-templates - \u521B\u5EFA\u4EFB\u52A1\u6A21\u677F\r\n  if (method === \"POST\" && path === \"/internal/api/v1/task-templates\") {\r\n    // \u4EC5\u7BA1\u7406\u5458\u53EF\u521B\u5EFA\u6A21\u677F\r\n    if (!me.is_admin) {\r\n      return jsonResponse(403, { ok: false, code: \"FORBIDDEN\", message: \"\u4EC5\u7BA1\u7406\u5458\u53EF\u521B\u5EFA\u6A21\u677F\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch (_) {\r\n      return jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    const errors = [];\r\n    const templateName = String(body?.template_name || \"\").trim();\r\n    const serviceId = body?.service_id ? parseInt(body.service_id, 10) : null;\r\n    const clientId = body?.client_id ? parseInt(body.client_id, 10) : null;\r\n    const description = String(body?.description || \"\").trim();\r\n    const sopId = body?.sop_id ? parseInt(body.sop_id, 10) : null;\r\n    const stages = Array.isArray(body?.stages) ? body.stages : [];\r\n\r\n    // \u9A8C\u8BC1\r\n    if (!templateName) {\r\n      errors.push({ field: \"template_name\", message: \"\u8BF7\u8F93\u5165\u6A21\u677F\u540D\u79F0\" });\r\n    }\r\n\r\n    if (errors.length) {\r\n      return jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F93\u5165\u6709\u8BEF\", errors, meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u63D2\u5165\u6A21\u677F\r\n      const result = await env.DATABASE.prepare(\r\n        `INSERT INTO TaskTemplates (template_name, service_id, client_id, description, sop_id, is_active)\r\n         VALUES (?, ?, ?, ?, ?, 1)`\r\n      ).bind(templateName, serviceId, clientId, description, sopId).run();\r\n\r\n      const templateId = result?.meta?.last_row_id;\r\n\r\n      // \u63D2\u5165\u9636\u6BB5\uFF08\u5982\u679C\u6709\uFF09\r\n      if (stages.length > 0) {\r\n        for (let i = 0; i < stages.length; i++) {\r\n          const stage = stages[i];\r\n          const stageName = String(stage?.stage_name || \"\").trim();\r\n          const stageDesc = String(stage?.description || \"\").trim();\r\n          const estimatedHours = parseFloat(stage?.estimated_hours || 0);\r\n\r\n          if (stageName) {\r\n            await env.DATABASE.prepare(\r\n              `INSERT INTO TaskTemplateStages (template_id, stage_name, stage_order, description, estimated_hours)\r\n               VALUES (?, ?, ?, ?, ?)`\r\n            ).bind(templateId, stageName, i + 1, stageDesc, estimatedHours).run();\r\n          }\r\n        }\r\n      }\r\n\r\n      return jsonResponse(201, {\r\n        ok: true,\r\n        code: \"CREATED\",\r\n        message: \"\u6A21\u677F\u5DF2\u521B\u5EFA\",\r\n        data: { template_id: templateId },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // PUT /internal/api/v1/task-templates/:id - \u66F4\u65B0\u4EFB\u52A1\u6A21\u677F\r\n  const matchUpdate = path.match(/^\\/internal\\/api\\/v1\\/task-templates\\/(\\d+)$/);\r\n  if (method === \"PUT\" && matchUpdate) {\r\n    const templateId = parseId(matchUpdate[1]);\r\n    if (!templateId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u6A21\u677FID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    // \u4EC5\u7BA1\u7406\u5458\u53EF\u66F4\u65B0\u6A21\u677F\r\n    if (!me.is_admin) {\r\n      return jsonResponse(403, { ok: false, code: \"FORBIDDEN\", message: \"\u4EC5\u7BA1\u7406\u5458\u53EF\u66F4\u65B0\u6A21\u677F\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch (_) {\r\n      return jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    const errors = [];\r\n    const templateName = String(body?.template_name || \"\").trim();\r\n    const serviceId = body?.service_id ? parseInt(body.service_id, 10) : null;\r\n    const description = String(body?.description || \"\").trim();\r\n    const sopId = body?.sop_id ? parseInt(body.sop_id, 10) : null;\r\n    const isActive = body?.is_active !== false; // \u9ED8\u8BA4true\r\n    const stages = Array.isArray(body?.stages) ? body.stages : null; // null\u8868\u793A\u4E0D\u66F4\u65B0\u9636\u6BB5\r\n\r\n    // \u9A8C\u8BC1\r\n    if (!templateName) {\r\n      errors.push({ field: \"template_name\", message: \"\u8BF7\u8F93\u5165\u6A21\u677F\u540D\u79F0\" });\r\n    }\r\n\r\n    if (errors.length) {\r\n      return jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F93\u5165\u6709\u8BEF\", errors, meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u6A21\u677F\u662F\u5426\u5B58\u5728\r\n      const existing = await env.DATABASE.prepare(\r\n        \"SELECT template_id FROM TaskTemplates WHERE template_id = ?\"\r\n      ).bind(templateId).first();\r\n\r\n      if (!existing) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6A21\u677F\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u66F4\u65B0\u6A21\u677F\u57FA\u672C\u4FE1\u606F\r\n      await env.DATABASE.prepare(\r\n        `UPDATE TaskTemplates \r\n         SET template_name = ?, service_id = ?, description = ?, sop_id = ?, is_active = ?\r\n         WHERE template_id = ?`\r\n      ).bind(templateName, serviceId, description, sopId, isActive ? 1 : 0, templateId).run();\r\n\r\n      // \u66F4\u65B0\u9636\u6BB5\uFF08\u5982\u679C\u63D0\u4F9B\u4E86stages\u6570\u7EC4\uFF09\r\n      if (stages !== null) {\r\n        // \u5220\u9664\u73B0\u6709\u9636\u6BB5\r\n        await env.DATABASE.prepare(\r\n          \"DELETE FROM TaskTemplateStages WHERE template_id = ?\"\r\n        ).bind(templateId).run();\r\n\r\n        // \u63D2\u5165\u65B0\u9636\u6BB5\r\n        for (let i = 0; i < stages.length; i++) {\r\n          const stage = stages[i];\r\n          const stageName = String(stage?.stage_name || \"\").trim();\r\n          const stageDesc = String(stage?.description || \"\").trim();\r\n          const estimatedHours = parseFloat(stage?.estimated_hours || 0);\r\n\r\n          if (stageName) {\r\n            await env.DATABASE.prepare(\r\n              `INSERT INTO TaskTemplateStages (template_id, stage_name, stage_order, description, estimated_hours)\r\n               VALUES (?, ?, ?, ?, ?)`\r\n            ).bind(templateId, stageName, i + 1, stageDesc, estimatedHours).run();\r\n          }\r\n        }\r\n      }\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u6A21\u677F\u5DF2\u66F4\u65B0\",\r\n        data: { template_id: templateId },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // DELETE /internal/api/v1/task-templates/:id - \u5220\u9664\u4EFB\u52A1\u6A21\u677F\r\n  if (method === \"DELETE\" && matchUpdate) {\r\n    const templateId = parseId(matchUpdate[1]);\r\n    if (!templateId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u6A21\u677FID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    // \u4EC5\u7BA1\u7406\u5458\u53EF\u5220\u9664\u6A21\u677F\r\n    if (!me.is_admin) {\r\n      return jsonResponse(403, { ok: false, code: \"FORBIDDEN\", message: \"\u4EC5\u7BA1\u7406\u5458\u53EF\u5220\u9664\u6A21\u677F\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u6A21\u677F\u662F\u5426\u5B58\u5728\r\n      const existing = await env.DATABASE.prepare(\r\n        \"SELECT template_id FROM TaskTemplates WHERE template_id = ?\"\r\n      ).bind(templateId).first();\r\n\r\n      if (!existing) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6A21\u677F\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u68C0\u67E5\u662F\u5426\u6709\u5BA2\u6237\u670D\u52A1\u6B63\u5728\u4F7F\u7528\u6B64\u6A21\u677F\r\n      const inUse = await env.DATABASE.prepare(\r\n        \"SELECT client_service_id FROM ClientServices WHERE task_template_id = ? AND is_deleted = 0 LIMIT 1\"\r\n      ).bind(templateId).first();\r\n\r\n      if (inUse) {\r\n        return jsonResponse(422, {\r\n          ok: false,\r\n          code: \"IN_USE\",\r\n          message: \"\u8BE5\u6A21\u677F\u6B63\u5728\u88AB\u4F7F\u7528\uFF0C\u65E0\u6CD5\u5220\u9664\",\r\n          meta: { requestId }\r\n        }, corsHeaders);\r\n      }\r\n\r\n      // \u5220\u9664\u9636\u6BB5\r\n      await env.DATABASE.prepare(\r\n        \"DELETE FROM TaskTemplateStages WHERE template_id = ?\"\r\n      ).bind(templateId).run();\r\n\r\n      // \u5220\u9664\u6A21\u677F\r\n      await env.DATABASE.prepare(\r\n        \"DELETE FROM TaskTemplates WHERE template_id = ?\"\r\n      ).bind(templateId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u6A21\u677F\u5DF2\u5220\u9664\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // GET /internal/api/v1/task-templates/:id/stages - \u83B7\u53D6\u6A21\u677F\u7684\u9636\u6BB5\u5217\u8868\r\n  const matchStages = path.match(/^\\/internal\\/api\\/v1\\/task-templates\\/(\\d+)\\/stages$/);\r\n  if (method === \"GET\" && matchStages) {\r\n    const templateId = parseId(matchStages[1]);\r\n    if (!templateId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u6A21\u677FID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      const stagesRows = await env.DATABASE.prepare(\r\n        `SELECT stage_id, stage_name, stage_order, description, \r\n                estimated_hours, sop_id, attachment_id,\r\n                due_date_rule, due_date_value, due_date_offset_days, advance_days\r\n         FROM TaskTemplateStages\r\n         WHERE template_id = ?\r\n         ORDER BY stage_order ASC`\r\n      ).bind(templateId).all();\r\n\r\n      const stages = (stagesRows?.results || []).map(s => ({\r\n        stage_id: s.stage_id,\r\n        stage_name: s.stage_name || \"\",\r\n        stage_order: s.stage_order,\r\n        description: s.description || \"\",\r\n        estimated_hours: Number(s.estimated_hours || 0),\r\n        sop_id: s.sop_id || null,\r\n        attachment_id: s.attachment_id || null,\r\n        due_date_rule: s.due_date_rule || 'end_of_month',\r\n        due_date_value: s.due_date_value || null,\r\n        due_date_offset_days: s.due_date_offset_days || 0,\r\n        advance_days: s.advance_days || 7\r\n      }));\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u67E5\u8BE2\u6210\u529F\",\r\n        data: stages,\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // POST /internal/api/v1/task-templates/:id/stages - \u4E3A\u6A21\u677F\u6DFB\u52A0\u9636\u6BB5\r\n  if (method === \"POST\" && matchStages) {\r\n    const templateId = parseId(matchStages[1]);\r\n    if (!templateId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u6A21\u677FID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    // \u4EC5\u7BA1\u7406\u5458\u53EF\u6DFB\u52A0\u9636\u6BB5\r\n    if (!me.is_admin) {\r\n      return jsonResponse(403, { ok: false, code: \"FORBIDDEN\", message: \"\u4EC5\u7BA1\u7406\u5458\u53EF\u6DFB\u52A0\u9636\u6BB5\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch (_) {\r\n      return jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    const errors = [];\r\n    const stageName = String(body?.stage_name || \"\").trim();\r\n    const stageOrder = body?.stage_order ? parseInt(body.stage_order, 10) : null;\r\n    const description = String(body?.description || \"\").trim();\r\n    const estimatedHours = body?.estimated_hours ? parseFloat(body.estimated_hours) : null;\r\n    const sopId = body?.sop_id ? parseInt(body.sop_id, 10) : null;\r\n    const attachmentId = body?.attachment_id ? parseInt(body.attachment_id, 10) : null;\r\n\r\n    // \u9A8C\u8BC1\r\n    if (!stageName) {\r\n      errors.push({ field: \"stage_name\", message: \"\u8BF7\u8F93\u5165\u4EFB\u52A1\u540D\u79F0\" });\r\n    }\r\n    if (!stageOrder || stageOrder < 1) {\r\n      errors.push({ field: \"stage_order\", message: \"\u8BF7\u8F93\u5165\u6709\u6548\u7684\u987A\u5E8F\" });\r\n    }\r\n\r\n    if (errors.length) {\r\n      return jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F93\u5165\u6709\u8BEF\", errors, meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u6A21\u677F\u662F\u5426\u5B58\u5728\r\n      const template = await env.DATABASE.prepare(\r\n        \"SELECT template_id FROM TaskTemplates WHERE template_id = ?\"\r\n      ).bind(templateId).first();\r\n\r\n      if (!template) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6A21\u677F\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u63D2\u5165\u9636\u6BB5\r\n      const result = await env.DATABASE.prepare(\r\n        `INSERT INTO TaskTemplateStages (template_id, stage_name, stage_order, description, estimated_hours, sop_id, attachment_id)\r\n         VALUES (?, ?, ?, ?, ?, ?, ?)`\r\n      ).bind(templateId, stageName, stageOrder, description, estimatedHours, sopId, attachmentId).run();\r\n\r\n      return jsonResponse(201, {\r\n        ok: true,\r\n        code: \"CREATED\",\r\n        message: \"\u4EFB\u52A1\u5DF2\u6DFB\u52A0\",\r\n        data: { stage_id: result?.meta?.last_row_id },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // DELETE /internal/api/v1/task-templates/:templateId/stages/:stageId - \u5220\u9664\u9636\u6BB5\r\n  const matchDeleteStage = path.match(/^\\/internal\\/api\\/v1\\/task-templates\\/(\\d+)\\/stages\\/(\\d+)$/);\r\n  if (method === \"DELETE\" && matchDeleteStage) {\r\n    const templateId = parseId(matchDeleteStage[1]);\r\n    const stageId = parseId(matchDeleteStage[2]);\r\n    \r\n    if (!templateId || !stageId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"ID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    // \u4EC5\u7BA1\u7406\u5458\u53EF\u5220\u9664\u9636\u6BB5\r\n    if (!me.is_admin) {\r\n      return jsonResponse(403, { ok: false, code: \"FORBIDDEN\", message: \"\u4EC5\u7BA1\u7406\u5458\u53EF\u5220\u9664\u9636\u6BB5\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u9636\u6BB5\u662F\u5426\u5B58\u5728\r\n      const stage = await env.DATABASE.prepare(\r\n        \"SELECT stage_id FROM TaskTemplateStages WHERE template_id = ? AND stage_id = ?\"\r\n      ).bind(templateId, stageId).first();\r\n\r\n      if (!stage) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u4EFB\u52A1\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u5220\u9664\u9636\u6BB5\r\n      await env.DATABASE.prepare(\r\n        \"DELETE FROM TaskTemplateStages WHERE template_id = ? AND stage_id = ?\"\r\n      ).bind(templateId, stageId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u4EFB\u52A1\u5DF2\u5220\u9664\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u8DEF\u7531\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n}\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nfunction parseId(s) {\r\n  const n = parseInt(String(s || \"\"), 10);\r\n  return Number.isFinite(n) && n > 0 ? n : null;\r\n}\r\n\r\nexport async function handleServices(request, env, me, requestId, url, path) {\r\n  const corsHeaders = getCorsHeadersForRequest(request, env);\r\n  const method = request.method.toUpperCase();\r\n\r\n  // ========================================\r\n  // \u670D\u52A1\u9879\u76EE\uFF08Services\uFF09\u7BA1\u7406\r\n  // ========================================\r\n\r\n  // GET /internal/api/v1/services - \u83B7\u53D6\u6240\u6709\u670D\u52A1\u9879\u76EE\r\n  if (method === \"GET\" && path === \"/internal/api/v1/services\") {\r\n    try {\r\n      const rows = await env.DATABASE.prepare(`\r\n        SELECT service_id, service_name, service_code, description, \r\n               is_active, sort_order, created_at, updated_at\r\n        FROM Services\r\n        WHERE is_active = 1\r\n        ORDER BY sort_order ASC, service_id ASC\r\n      `).all();\r\n\r\n      const data = (rows?.results || []).map(r => ({\r\n        service_id: r.service_id,\r\n        service_name: r.service_name || \"\",\r\n        service_code: r.service_code || \"\",\r\n        description: r.description || \"\",\r\n        is_active: Boolean(r.is_active),\r\n        sort_order: r.sort_order || 0,\r\n        created_at: r.created_at,\r\n        updated_at: r.updated_at\r\n      }));\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"SUCCESS\",\r\n        message: \"\u67E5\u8BE2\u6210\u529F\",\r\n        data,\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u670D\u52A1\u5668\u9519\u8BEF\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // POST /internal/api/v1/services - \u521B\u5EFA\u670D\u52A1\u9879\u76EE\r\n  if (method === \"POST\" && path === \"/internal/api/v1/services\") {\r\n    if (!me?.is_admin) {\r\n      return jsonResponse(403, {\r\n        ok: false,\r\n        code: \"FORBIDDEN\",\r\n        message: \"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const serviceName = String(body?.service_name || \"\").trim();\r\n    const serviceCode = String(body?.service_code || \"\").trim();\r\n    const description = String(body?.description || \"\").trim();\r\n    const sortOrder = parseInt(body?.sort_order || \"0\", 10);\r\n\r\n    if (!serviceName) {\r\n      return jsonResponse(422, {\r\n        ok: false,\r\n        code: \"VALIDATION_ERROR\",\r\n        message: \"\u670D\u52A1\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      const result = await env.DATABASE.prepare(`\r\n        INSERT INTO Services (service_name, service_code, description, sort_order, is_active)\r\n        VALUES (?, ?, ?, ?, 1)\r\n      `).bind(serviceName, serviceCode || null, description || null, sortOrder).run();\r\n\r\n      return jsonResponse(201, {\r\n        ok: true,\r\n        code: \"CREATED\",\r\n        message: \"\u521B\u5EFA\u6210\u529F\",\r\n        data: { service_id: result.meta.last_row_id },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u521B\u5EFA\u5931\u8D25\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // PUT /internal/api/v1/services/:id - \u66F4\u65B0\u670D\u52A1\u9879\u76EE\r\n  const matchUpdate = path.match(/^\\/internal\\/api\\/v1\\/services\\/(\\d+)$/);\r\n  if (method === \"PUT\" && matchUpdate) {\r\n    if (!me?.is_admin) {\r\n      return jsonResponse(403, {\r\n        ok: false,\r\n        code: \"FORBIDDEN\",\r\n        message: \"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const serviceId = parseId(matchUpdate[1]);\r\n    if (!serviceId) {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u65E0\u6548\u7684\u670D\u52A1ID\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const serviceName = String(body?.service_name || \"\").trim();\r\n    const serviceCode = String(body?.service_code || \"\").trim();\r\n    const description = String(body?.description || \"\").trim();\r\n    const sortOrder = parseInt(body?.sort_order || \"0\", 10);\r\n\r\n    if (!serviceName) {\r\n      return jsonResponse(422, {\r\n        ok: false,\r\n        code: \"VALIDATION_ERROR\",\r\n        message: \"\u670D\u52A1\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      await env.DATABASE.prepare(`\r\n        UPDATE Services \r\n        SET service_name = ?, service_code = ?, description = ?, \r\n            sort_order = ?, updated_at = datetime('now')\r\n        WHERE service_id = ?\r\n      `).bind(serviceName, serviceCode || null, description || null, sortOrder, serviceId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"SUCCESS\",\r\n        message: \"\u66F4\u65B0\u6210\u529F\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u66F4\u65B0\u5931\u8D25\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // DELETE /internal/api/v1/services/:id - \u5220\u9664\u670D\u52A1\u9879\u76EE\uFF08\u8F6F\u5220\u9664\uFF09\r\n  const matchDelete = path.match(/^\\/internal\\/api\\/v1\\/services\\/(\\d+)$/);\r\n  if (method === \"DELETE\" && matchDelete) {\r\n    if (!me?.is_admin) {\r\n      return jsonResponse(403, {\r\n        ok: false,\r\n        code: \"FORBIDDEN\",\r\n        message: \"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const serviceId = parseId(matchDelete[1]);\r\n    if (!serviceId) {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u65E0\u6548\u7684\u670D\u52A1ID\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      await env.DATABASE.prepare(`\r\n        UPDATE Services SET is_active = 0, updated_at = datetime('now')\r\n        WHERE service_id = ?\r\n      `).bind(serviceId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"SUCCESS\",\r\n        message: \"\u5220\u9664\u6210\u529F\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u5220\u9664\u5931\u8D25\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // ========================================\r\n  // \u670D\u52A1\u5B50\u9879\u76EE\uFF08ServiceItems\uFF09\u7BA1\u7406\r\n  // ========================================\r\n\r\n  // GET /internal/api/v1/services/items - \u83B7\u53D6\u6240\u6709\u670D\u52A1\u9879\r\n  if (method === \"GET\" && path === \"/internal/api/v1/services/items\") {\r\n    try {\r\n      const rows = await env.DATABASE.prepare(`\r\n        SELECT si.item_id, si.service_id, si.item_name, si.item_code, si.description,\r\n               si.is_active, si.sort_order, si.created_at, si.updated_at,\r\n               s.service_name\r\n        FROM ServiceItems si\r\n        LEFT JOIN Services s ON s.service_id = si.service_id\r\n        WHERE si.is_active = 1\r\n        ORDER BY si.service_id ASC, si.sort_order ASC, si.item_id ASC\r\n      `).all();\r\n\r\n      const data = (rows?.results || []).map(r => ({\r\n        item_id: r.item_id,\r\n        service_id: r.service_id,\r\n        service_name: r.service_name || \"\",\r\n        item_name: r.item_name || \"\",\r\n        item_code: r.item_code || \"\",\r\n        description: r.description || \"\",\r\n        is_active: Boolean(r.is_active),\r\n        sort_order: r.sort_order || 0,\r\n        created_at: r.created_at,\r\n        updated_at: r.updated_at\r\n      }));\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"SUCCESS\",\r\n        message: \"\u67E5\u8BE2\u6210\u529F\",\r\n        data,\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u670D\u52A1\u5668\u9519\u8BEF\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // GET /internal/api/v1/services/:id/items - \u83B7\u53D6\u670D\u52A1\u7684\u6240\u6709\u5B50\u9879\u76EE\r\n  const matchGetItems = path.match(/^\\/internal\\/api\\/v1\\/services\\/(\\d+)\\/items$/);\r\n  if (method === \"GET\" && matchGetItems) {\r\n    const serviceId = parseId(matchGetItems[1]);\r\n    if (!serviceId) {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u65E0\u6548\u7684\u670D\u52A1ID\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      const rows = await env.DATABASE.prepare(`\r\n        SELECT item_id, service_id, item_name, item_code, description,\r\n               is_active, sort_order, created_at, updated_at\r\n        FROM ServiceItems\r\n        WHERE service_id = ? AND is_active = 1\r\n        ORDER BY sort_order ASC, item_id ASC\r\n      `).bind(serviceId).all();\r\n\r\n      const data = (rows?.results || []).map(r => ({\r\n        item_id: r.item_id,\r\n        service_id: r.service_id,\r\n        item_name: r.item_name || \"\",\r\n        item_code: r.item_code || \"\",\r\n        description: r.description || \"\",\r\n        is_active: Boolean(r.is_active),\r\n        sort_order: r.sort_order || 0,\r\n        created_at: r.created_at,\r\n        updated_at: r.updated_at\r\n      }));\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"SUCCESS\",\r\n        message: \"\u67E5\u8BE2\u6210\u529F\",\r\n        data,\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u670D\u52A1\u5668\u9519\u8BEF\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // POST /internal/api/v1/services/:id/items - \u521B\u5EFA\u670D\u52A1\u5B50\u9879\u76EE\r\n  const matchCreateItem = path.match(/^\\/internal\\/api\\/v1\\/services\\/(\\d+)\\/items$/);\r\n  if (method === \"POST\" && matchCreateItem) {\r\n    if (!me?.is_admin) {\r\n      return jsonResponse(403, {\r\n        ok: false,\r\n        code: \"FORBIDDEN\",\r\n        message: \"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const serviceId = parseId(matchCreateItem[1]);\r\n    if (!serviceId) {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u65E0\u6548\u7684\u670D\u52A1ID\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const itemName = String(body?.item_name || \"\").trim();\r\n    const itemCode = String(body?.item_code || \"\").trim();\r\n    const description = String(body?.description || \"\").trim();\r\n    const sortOrder = parseInt(body?.sort_order || \"0\", 10);\r\n\r\n    if (!itemName) {\r\n      return jsonResponse(422, {\r\n        ok: false,\r\n        code: \"VALIDATION_ERROR\",\r\n        message: \"\u5B50\u9879\u76EE\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      const result = await env.DATABASE.prepare(`\r\n        INSERT INTO ServiceItems (service_id, item_name, item_code, description, sort_order, is_active)\r\n        VALUES (?, ?, ?, ?, ?, 1)\r\n      `).bind(serviceId, itemName, itemCode || null, description || null, sortOrder).run();\r\n\r\n      return jsonResponse(201, {\r\n        ok: true,\r\n        code: \"CREATED\",\r\n        message: \"\u521B\u5EFA\u6210\u529F\",\r\n        data: { item_id: result.meta.last_row_id },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u521B\u5EFA\u5931\u8D25\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // PUT /internal/api/v1/services/:sid/items/:iid - \u66F4\u65B0\u670D\u52A1\u5B50\u9879\u76EE\r\n  const matchUpdateItem = path.match(/^\\/internal\\/api\\/v1\\/services\\/(\\d+)\\/items\\/(\\d+)$/);\r\n  if (method === \"PUT\" && matchUpdateItem) {\r\n    if (!me?.is_admin) {\r\n      return jsonResponse(403, {\r\n        ok: false,\r\n        code: \"FORBIDDEN\",\r\n        message: \"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const serviceId = parseId(matchUpdateItem[1]);\r\n    const itemId = parseId(matchUpdateItem[2]);\r\n    \r\n    if (!serviceId || !itemId) {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u65E0\u6548\u7684ID\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const itemName = String(body?.item_name || \"\").trim();\r\n    const itemCode = String(body?.item_code || \"\").trim();\r\n    const description = String(body?.description || \"\").trim();\r\n    const sortOrder = parseInt(body?.sort_order || \"0\", 10);\r\n\r\n    if (!itemName) {\r\n      return jsonResponse(422, {\r\n        ok: false,\r\n        code: \"VALIDATION_ERROR\",\r\n        message: \"\u5B50\u9879\u76EE\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      await env.DATABASE.prepare(`\r\n        UPDATE ServiceItems \r\n        SET item_name = ?, item_code = ?, description = ?, \r\n            sort_order = ?, updated_at = datetime('now')\r\n        WHERE service_id = ? AND item_id = ?\r\n      `).bind(itemName, itemCode || null, description || null, sortOrder, serviceId, itemId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"SUCCESS\",\r\n        message: \"\u66F4\u65B0\u6210\u529F\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u66F4\u65B0\u5931\u8D25\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // DELETE /internal/api/v1/services/:sid/items/:iid - \u5220\u9664\u670D\u52A1\u5B50\u9879\u76EE\r\n  const matchDeleteItem = path.match(/^\\/internal\\/api\\/v1\\/services\\/(\\d+)\\/items\\/(\\d+)$/);\r\n  if (method === \"DELETE\" && matchDeleteItem) {\r\n    if (!me?.is_admin) {\r\n      return jsonResponse(403, {\r\n        ok: false,\r\n        code: \"FORBIDDEN\",\r\n        message: \"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const serviceId = parseId(matchDeleteItem[1]);\r\n    const itemId = parseId(matchDeleteItem[2]);\r\n    \r\n    if (!serviceId || !itemId) {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u65E0\u6548\u7684ID\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      await env.DATABASE.prepare(`\r\n        UPDATE ServiceItems SET is_active = 0, updated_at = datetime('now')\r\n        WHERE service_id = ? AND item_id = ?\r\n      `).bind(serviceId, itemId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"SUCCESS\",\r\n        message: \"\u5220\u9664\u6210\u529F\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u5220\u9664\u5931\u8D25\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  return jsonResponse(404, {\r\n    ok: false,\r\n    code: \"NOT_FOUND\",\r\n    message: \"API\u8DEF\u5F84\u4E0D\u5B58\u5728\",\r\n    meta: { requestId }\r\n  }, corsHeaders);\r\n}\r\n\r\n", "/**\n * Service Components API\n * \u7BA1\u7406\u5BA2\u6237\u670D\u52A1\u7684\u7EC4\u6210\u90E8\u5206\n */\n\nimport { jsonResponse, getCorsHeadersForRequest } from '../utils.js';\n\nexport async function handleServiceComponents(request, env, path) {\n  const url = new URL(request.url);\n  const method = request.method;\n  \n  // \u9700\u8981\u767B\u5F55\u9A8C\u8BC1 - \u5728 index.js \u4E2D\u5DF2\u5904\u7406\n  const corsHeaders = getCorsHeadersForRequest(request, env);\n\n  // OPTIONS \u8BF7\u6C42\n  if (method === 'OPTIONS') {\n    return new Response(null, { headers: corsHeaders });\n  }\n\n  // GET /internal/api/v1/client-services/:id/components\n  if (method === 'GET' && path.match(/^\\/internal\\/api\\/v1\\/client-services\\/(\\d+)\\/components$/)) {\n    const clientServiceId = parseInt(path.match(/\\/client-services\\/(\\d+)\\/components$/)[1]);\n    return await listServiceComponents(env, corsHeaders, clientServiceId);\n  }\n\n  // POST /internal/api/v1/client-services/:id/components\n  if (method === 'POST' && path.match(/^\\/internal\\/api\\/v1\\/client-services\\/(\\d+)\\/components$/)) {\n    const clientServiceId = parseInt(path.match(/\\/client-services\\/(\\d+)\\/components$/)[1]);\n    return await createServiceComponent(request, env, corsHeaders, clientServiceId);\n  }\n\n  // PUT /internal/api/v1/service-components/:id\n  if (method === 'PUT' && path.match(/^\\/internal\\/api\\/v1\\/service-components\\/(\\d+)$/)) {\n    const componentId = parseInt(path.match(/\\/service-components\\/(\\d+)$/)[1]);\n    return await updateServiceComponent(request, env, corsHeaders, componentId);\n  }\n\n  // DELETE /internal/api/v1/service-components/:id\n  if (method === 'DELETE' && path.match(/^\\/internal\\/api\\/v1\\/service-components\\/(\\d+)$/)) {\n    const componentId = parseInt(path.match(/\\/service-components\\/(\\d+)$/)[1]);\n    return await deleteServiceComponent(env, corsHeaders, componentId);\n  }\n\n  return null;\n}\n\nasync function listServiceComponents(env, corsHeaders, clientServiceId) {\n  try {\n    console.log('[listServiceComponents] \u5F00\u59CB\u67E5\u8BE2, clientServiceId:', clientServiceId);\n    \n    const components = await env.DATABASE.prepare(`\n      SELECT \n        sc.*,\n        s.service_name,\n        si.item_name as service_item_name,\n        tt.template_name\n      FROM ServiceComponents sc\n      LEFT JOIN Services s ON sc.service_id = s.service_id\n      LEFT JOIN ServiceItems si ON sc.service_item_id = si.item_id\n      LEFT JOIN TaskTemplates tt ON sc.task_template_id = tt.template_id\n      WHERE sc.client_service_id = ? AND sc.is_active = 1\n      ORDER BY sc.component_id\n    `).bind(clientServiceId).all();\n    \n    console.log('[listServiceComponents] \u67E5\u8BE2\u5230\u7EC4\u4EF6\u6570\u91CF:', components.results?.length || 0);\n\n    // \u67E5\u8BE2\u6BCF\u4E2A\u7EC4\u4EF6\u7684\u591A\u4E2A\u670D\u52A1\u5C42\u7EA7SOP\u548C\u4EFB\u52A1\u914D\u7F6E\n    const componentsWithDetails = await Promise.all(\n      (components.results || []).map(async (c, index) => {\n        try {\n          console.log(`[listServiceComponents] \u5904\u7406\u7EC4\u4EF6 ${index + 1}/${components.results.length}, component_id:`, c.component_id);\n          \n          // \u68C0\u67E5component_id\n          if (!c.component_id && c.component_id !== 0) {\n            console.error('[listServiceComponents] \u7EC4\u4EF6\u7F3A\u5C11component_id!', c);\n            throw new Error('\u7EC4\u4EF6\u7F3A\u5C11component_id');\n          }\n          \n          // \u67E5\u8BE2\u670D\u52A1\u5C42\u7EA7\u7684\u591A\u4E2ASOP\n          const componentSOPs = await env.DATABASE.prepare(`\n            SELECT sop.sop_id, sop.title, sop.category, scs.sort_order\n            FROM ServiceComponentSOPs scs\n            JOIN SOPDocuments sop ON sop.sop_id = scs.sop_id\n            WHERE scs.component_id = ? AND sop.is_deleted = 0\n            ORDER BY scs.sort_order\n          `).bind(c.component_id).all();\n          \n          console.log(`[listServiceComponents] \u7EC4\u4EF6 ${c.component_id} \u7684\u670D\u52A1SOP\u6570\u91CF:`, componentSOPs.results?.length || 0);\n          \n          // \u67E5\u8BE2\u4EFB\u52A1\u914D\u7F6E\u53CA\u5176\u5173\u8054\u7684SOP\n          const tasks = await env.DATABASE.prepare(`\n            SELECT \n              config_id, component_id, task_order, task_name, \n              assignee_user_id, notes, due_rule, due_value, \n              estimated_hours, advance_days, created_at\n            FROM ServiceComponentTasks\n            WHERE component_id = ?\n            ORDER BY task_order\n          `).bind(c.component_id).all();\n          \n          console.log(`[listServiceComponents] \u7EC4\u4EF6 ${c.component_id} \u7684\u4EFB\u52A1\u6570\u91CF:`, tasks.results?.length || 0);\n          \n          const tasksWithSOPs = await Promise.all(\n            (tasks.results || []).map(async (task) => {\n              console.log(`[listServiceComponents] \u67E5\u8BE2\u4EFB\u52A1SOP, task\u5BF9\u8C61:`, JSON.stringify(task));\n              \n              // \u68C0\u67E5config_id\u662F\u5426\u5B58\u5728\n              if (!task.config_id && task.config_id !== 0) {\n                console.error(`[listServiceComponents] \u8B66\u544A\uFF1A\u4EFB\u52A1\u7F3A\u5C11config_id\u5B57\u6BB5\uFF01task\u5BF9\u8C61:`, task);\n                return {\n                  ...task,\n                  sops: []\n                };\n              }\n              \n              const taskSOPs = await env.DATABASE.prepare(`\n                SELECT sop.sop_id, sop.title, sop.category, scts.sort_order\n                FROM ServiceComponentTaskSOPs scts\n                JOIN SOPDocuments sop ON sop.sop_id = scts.sop_id\n                WHERE scts.task_config_id = ? AND sop.is_deleted = 0\n                ORDER BY scts.sort_order\n              `).bind(task.config_id).all();\n              \n              console.log(`[listServiceComponents] \u4EFB\u52A1 ${task.config_id} \u7684SOP\u6570\u91CF:`, taskSOPs.results?.length || 0);\n              \n              return {\n                ...task,\n                sops: taskSOPs.results || []\n              };\n            })\n          );\n          \n          console.log(`[listServiceComponents] \u7EC4\u4EF6 ${c.component_id} \u5904\u7406\u5B8C\u6210`);\n          \n          return {\n            ...c,\n            component_sops: componentSOPs.results || [],\n            tasks: tasksWithSOPs,\n            delivery_months: c.delivery_months ? JSON.parse(c.delivery_months) : null\n          };\n        } catch (err) {\n          console.error(`[listServiceComponents] \u5904\u7406\u7EC4\u4EF6 ${c.component_id} \u65F6\u51FA\u9519:`, err);\n          throw err;\n        }\n      })\n    );\n    \n    console.log('[listServiceComponents] \u6240\u6709\u7EC4\u4EF6\u5904\u7406\u5B8C\u6210\uFF0C\u51C6\u5907\u8FD4\u56DE');\n\n    return jsonResponse(200, {\n      ok: true,\n      data: componentsWithDetails\n    }, corsHeaders);\n  } catch (err) {\n    console.error('\u83B7\u53D6\u670D\u52A1\u7EC4\u6210\u90E8\u5206\u5931\u8D25:', err);\n    console.error('\u9519\u8BEF\u5806\u6808:', err.stack);\n    return jsonResponse(500, { \n      ok: false, \n      message: '\u83B7\u53D6\u5931\u8D25', \n      error: String(err),\n      debug: err.message || String(err)\n    }, corsHeaders);\n  }\n}\n\nasync function createServiceComponent(request, env, corsHeaders, clientServiceId) {\n  try {\n    const body = await request.json();\n    const {\n      service_id,\n      service_item_id,\n      component_name,\n      delivery_frequency,\n      delivery_months,\n      task_template_id,\n      auto_generate_task = true,\n      advance_days = 7,\n      due_date_rule,\n      due_date_value,\n      due_date_offset_days = 0,\n      estimated_hours,\n      notes,\n      component_sop_ids = [],  // \u670D\u52A1\u5C42\u7EA7SOP\uFF08\u591A\u9009\uFF09\n      tasks = []\n    } = body;\n\n    // \u9A8C\u8BC1\u5FC5\u586B\u5B57\u6BB5\n    if (!component_name || !service_id) {\n      return jsonResponse(400, {\n        ok: false,\n        message: '\u7F3A\u5C11\u5FC5\u586B\u5B57\u6BB5',\n        debug: { component_name, service_id, delivery_frequency }\n      }, corsHeaders);\n    }\n\n    // \u9A8C\u8BC1\u81F3\u5C11\u8981\u6709\u4EFB\u52A1\u914D\u7F6E\n    if (!tasks || tasks.length === 0) {\n      return jsonResponse(400, {\n        ok: false,\n        message: '\u8ACB\u81F3\u5C11\u65B0\u589E\u4E00\u500B\u4EFB\u52D9'\n      }, corsHeaders);\n    }\n\n    const result = await env.DATABASE.prepare(`\n      INSERT INTO ServiceComponents (\n        client_service_id, service_id, service_item_id, component_name,\n        delivery_frequency, delivery_months,\n        task_template_id, auto_generate_task, advance_days,\n        due_date_rule, due_date_value, due_date_offset_days,\n        estimated_hours, notes, sop_id\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n    `).bind(\n      clientServiceId,\n      service_id,\n      service_item_id || null,\n      component_name || '\u4EFB\u52D9\u914D\u7F6E',\n      delivery_frequency || 'monthly',\n      delivery_months ? JSON.stringify(delivery_months) : null,\n      task_template_id || null,\n      auto_generate_task ? 1 : 0,\n      advance_days || 7,\n      due_date_rule || null,\n      due_date_value || null,\n      due_date_offset_days || 0,\n      estimated_hours || null,\n      notes || null,\n      null  // sop_id\u4FDD\u7559\u4E3Anull\uFF0C\u6539\u7528ServiceComponentSOPs\u8868\n    ).run();\n\n    const componentId = result.meta.last_row_id;\n\n    // \u4FDD\u5B58\u670D\u52A1\u5C42\u7EA7SOP\u5173\u8054\uFF08\u591A\u4E2A\uFF09\n    if (component_sop_ids && Array.isArray(component_sop_ids) && component_sop_ids.length > 0) {\n      // \u8FC7\u6EE4\u6389\u65E0\u6548\u7684ID\n      const validSopIds = component_sop_ids.filter(id => id && !isNaN(id) && id > 0);\n      \n      for (let i = 0; i < validSopIds.length; i++) {\n        await env.DATABASE.prepare(`\n          INSERT INTO ServiceComponentSOPs (component_id, sop_id, sort_order)\n          VALUES (?, ?, ?)\n        `).bind(componentId, validSopIds[i], i).run();\n      }\n    }\n\n    // \u4FDD\u5B58\u4EFB\u52A1\u914D\u7F6E\u548C\u4EFB\u52A1\u5C42\u7EA7\u7684SOP\n    if (tasks && Array.isArray(tasks) && tasks.length > 0) {\n      for (let i = 0; i < tasks.length; i++) {\n        const task = tasks[i];\n        \n        // \u63D2\u5165\u4EFB\u52A1\u914D\u7F6E\n        const taskResult = await env.DATABASE.prepare(`\n          INSERT INTO ServiceComponentTasks (\n            component_id, task_order, task_name, assignee_user_id, notes,\n            due_rule, due_value, estimated_hours, advance_days\n          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n        `).bind(\n          componentId,\n          i,\n          task.task_name || '',\n          task.assignee_user_id || null,\n          task.notes || null,\n          task.due_rule || 'end_of_month',\n          task.due_value || null,\n          task.estimated_hours || null,\n          task.advance_days || 7\n        ).run();\n\n        const taskConfigId = taskResult.meta.last_row_id;\n\n        // \u63D2\u5165\u4EFB\u52A1\u7684SOP\u5173\u8054\n        if (task.sop_ids && Array.isArray(task.sop_ids) && task.sop_ids.length > 0) {\n          // \u8FC7\u6EE4\u6389\u65E0\u6548\u7684ID\n          const validTaskSopIds = task.sop_ids.filter(id => id && !isNaN(id) && id > 0);\n          \n          for (let j = 0; j < validTaskSopIds.length; j++) {\n            await env.DATABASE.prepare(`\n              INSERT INTO ServiceComponentTaskSOPs (task_config_id, sop_id, sort_order)\n              VALUES (?, ?, ?)\n            `).bind(taskConfigId, validTaskSopIds[j], j).run();\n          }\n        }\n      }\n    }\n\n    return jsonResponse(201, {\n      ok: true,\n      message: '\u670D\u52A1\u7EC4\u6210\u90E8\u5206\u5DF2\u521B\u5EFA',\n      data: { component_id: componentId }\n    }, corsHeaders);\n  } catch (err) {\n    console.error('\u521B\u5EFA\u670D\u52A1\u7EC4\u6210\u90E8\u5206\u5931\u8D25:', err);\n    console.error('\u9519\u8BEF\u8BE6\u60C5:', err.message);\n    console.error('\u9519\u8BEF\u5806\u6808:', err.stack);\n    return jsonResponse(500, { \n      ok: false, \n      message: '\u521B\u5EFA\u5931\u8D25\uFF1A' + err.message,\n      debug: String(err)\n    }, corsHeaders);\n  }\n}\n\nasync function updateServiceComponent(request, env, corsHeaders, componentId) {\n  try {\n    const body = await request.json();\n    const {\n      component_name,\n      delivery_frequency,\n      delivery_months,\n      task_template_id,\n      auto_generate_task = true,\n      advance_days = 7,\n      due_date_rule,\n      due_date_value,\n      due_date_offset_days = 0,\n      estimated_hours,\n      notes,\n      component_sop_ids = [],\n      tasks = []\n    } = body;\n\n    if (!component_name || !delivery_frequency) {\n      return jsonResponse(400, {\n        ok: false,\n        message: '\u7F3A\u5C11\u5FC5\u586B\u5B57\u6BB5'\n      }, corsHeaders);\n    }\n\n    // \u66F4\u65B0\u57FA\u672C\u4FE1\u606F\n    await env.DATABASE.prepare(`\n      UPDATE ServiceComponents SET\n        component_name = ?,\n        delivery_frequency = ?,\n        delivery_months = ?,\n        task_template_id = ?,\n        auto_generate_task = ?,\n        advance_days = ?,\n        due_date_rule = ?,\n        due_date_value = ?,\n        due_date_offset_days = ?,\n        estimated_hours = ?,\n        notes = ?,\n        updated_at = CURRENT_TIMESTAMP\n      WHERE component_id = ?\n    `).bind(\n      component_name,\n      delivery_frequency,\n      delivery_months ? JSON.stringify(delivery_months) : null,\n      task_template_id || null,\n      auto_generate_task ? 1 : 0,\n      advance_days,\n      due_date_rule || null,\n      due_date_value || null,\n      due_date_offset_days,\n      estimated_hours || null,\n      notes || null,\n      componentId\n    ).run();\n\n    // \u5220\u9664\u5E76\u91CD\u65B0\u63D2\u5165\u670D\u52A1\u5C42\u7EA7SOP\n    await env.DATABASE.prepare(\n      'DELETE FROM ServiceComponentSOPs WHERE component_id = ?'\n    ).bind(componentId).run();\n    \n    if (component_sop_ids && Array.isArray(component_sop_ids) && component_sop_ids.length > 0) {\n      // \u8FC7\u6EE4\u6389\u65E0\u6548\u7684ID\n      const validSopIds = component_sop_ids.filter(id => id && !isNaN(id) && id > 0);\n      \n      for (let i = 0; i < validSopIds.length; i++) {\n        await env.DATABASE.prepare(`\n          INSERT INTO ServiceComponentSOPs (component_id, sop_id, sort_order)\n          VALUES (?, ?, ?)\n        `).bind(componentId, validSopIds[i], i).run();\n      }\n    }\n\n    // \u5220\u9664\u65E7\u7684\u4EFB\u52A1\u914D\u7F6E\u53CA\u5176SOP\u5173\u8054\n    const oldTasks = await env.DATABASE.prepare(\n      'SELECT config_id FROM ServiceComponentTasks WHERE component_id = ?'\n    ).bind(componentId).all();\n    \n    for (const oldTask of (oldTasks.results || [])) {\n      await env.DATABASE.prepare(\n        'DELETE FROM ServiceComponentTaskSOPs WHERE task_config_id = ?'\n      ).bind(oldTask.config_id).run();\n    }\n    \n    await env.DATABASE.prepare(\n      'DELETE FROM ServiceComponentTasks WHERE component_id = ?'\n    ).bind(componentId).run();\n\n    // \u63D2\u5165\u65B0\u7684\u4EFB\u52A1\u914D\u7F6E\n    if (tasks && Array.isArray(tasks) && tasks.length > 0) {\n      for (let i = 0; i < tasks.length; i++) {\n        const task = tasks[i];\n        \n        const taskResult = await env.DATABASE.prepare(`\n          INSERT INTO ServiceComponentTasks (\n            component_id, task_order, task_name, assignee_user_id, notes,\n            due_rule, due_value, estimated_hours, advance_days\n          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n        `).bind(\n          componentId,\n          i,\n          task.task_name || '',\n          task.assignee_user_id || null,\n          task.notes || null,\n          task.due_rule || 'end_of_month',\n          task.due_value || null,\n          task.estimated_hours || null,\n          task.advance_days || 7\n        ).run();\n\n        const taskConfigId = taskResult.meta.last_row_id;\n\n        if (task.sop_ids && Array.isArray(task.sop_ids) && task.sop_ids.length > 0) {\n          // \u8FC7\u6EE4\u6389\u65E0\u6548\u7684ID\n          const validTaskSopIds = task.sop_ids.filter(id => id && !isNaN(id) && id > 0);\n          \n          for (let j = 0; j < validTaskSopIds.length; j++) {\n            await env.DATABASE.prepare(`\n              INSERT INTO ServiceComponentTaskSOPs (task_config_id, sop_id, sort_order)\n              VALUES (?, ?, ?)\n            `).bind(taskConfigId, validTaskSopIds[j], j).run();\n          }\n        }\n      }\n    }\n\n    return jsonResponse(200, {\n      ok: true,\n      message: '\u670D\u52A1\u7EC4\u6210\u90E8\u5206\u5DF2\u66F4\u65B0',\n      data: { component_id: componentId }\n    }, corsHeaders);\n  } catch (err) {\n    console.error('\u66F4\u65B0\u670D\u52A1\u7EC4\u6210\u90E8\u5206\u5931\u8D25:', err);\n    return jsonResponse(500, { ok: false, message: '\u66F4\u65B0\u5931\u8D25', error: String(err) }, corsHeaders);\n  }\n}\n\nasync function deleteServiceComponent(env, corsHeaders, componentId) {\n  try {\n    const tasks = await env.DATABASE.prepare(\n      'SELECT COUNT(*) as count FROM ActiveTasks WHERE component_id = ? AND is_deleted = 0'\n    ).bind(componentId).first();\n\n    if (tasks && tasks.count > 0) {\n      return jsonResponse(400, {\n        ok: false,\n        message: `\u65E0\u6CD5\u5220\u9664\uFF1A\u8FD8\u6709 ${tasks.count} \u4E2A\u5173\u8054\u7684\u4EFB\u52A1`\n      }, corsHeaders);\n    }\n\n    await env.DATABASE.prepare(\n      'UPDATE ServiceComponents SET is_active = 0 WHERE component_id = ?'\n    ).bind(componentId).run();\n\n    return jsonResponse(200, {\n      ok: true,\n      message: '\u670D\u52A1\u7EC4\u6210\u90E8\u5206\u5DF2\u5220\u9664'\n    }, corsHeaders);\n  } catch (err) {\n    console.error('\u5220\u9664\u670D\u52A1\u7EC4\u6210\u90E8\u5206\u5931\u8D25:', err);\n    return jsonResponse(500, { ok: false, message: '\u5220\u9664\u5931\u8D25' }, corsHeaders);\n  }\n}\n", "/**\r\n * \u4EFB\u52A1\u81EA\u52A8\u751F\u6210\u5668\r\n * \u6839\u636E ServiceComponents \u914D\u7F6E\u81EA\u52A8\u751F\u6210\u4EFB\u52A1\r\n */\r\n\r\n/**\r\n * \u8BA1\u7B97\u622A\u6B62\u65E5\u671F\r\n */\r\nfunction calculateDueDate(component, targetYear, targetMonth) {\r\n  const dueRule = component.due_date_rule;\r\n  const dueValue = component.due_date_value;\r\n  const offsetDays = component.due_date_offset_days || 0;\r\n  \r\n  let dueDate;\r\n  \r\n  switch (dueRule) {\r\n    case 'end_of_month':\r\n      // \u5F53\u6708\u6700\u540E\u4E00\u5929\r\n      dueDate = new Date(targetYear, targetMonth + 1, 0);\r\n      break;\r\n      \r\n    case 'specific_day':\r\n      // \u5F53\u6708\u6307\u5B9A\u65E5\r\n      dueDate = new Date(targetYear, targetMonth, dueValue || 1);\r\n      break;\r\n      \r\n    case 'next_month_day':\r\n      // \u6B21\u6708\u6307\u5B9A\u65E5\r\n      dueDate = new Date(targetYear, targetMonth + 1, dueValue || 1);\r\n      break;\r\n      \r\n    case 'days_after_start':\r\n      // \u76F8\u5BF9\u5929\u6570\r\n      dueDate = new Date(targetYear, targetMonth, 1);\r\n      dueDate.setDate(dueDate.getDate() + (dueValue || 30));\r\n      break;\r\n      \r\n    default:\r\n      // \u9ED8\u8BA4\uFF1A\u5F53\u6708\u6700\u540E\u4E00\u5929\r\n      dueDate = new Date(targetYear, targetMonth + 1, 0);\r\n  }\r\n  \r\n  // \u5E94\u7528\u5FAE\u8C03\u5929\u6570\r\n  if (offsetDays) {\r\n    dueDate.setDate(dueDate.getDate() + offsetDays);\r\n  }\r\n  \r\n  return dueDate;\r\n}\r\n\r\n/**\r\n * \u68C0\u67E5\u7EC4\u4EF6\u662F\u5426\u5E94\u8BE5\u5728\u6307\u5B9A\u6708\u4EFD\u751F\u6210\u4EFB\u52A1\r\n */\r\nfunction shouldGenerateInMonth(component, month) {\r\n  const frequency = component.delivery_frequency;\r\n  const deliveryMonths = component.delivery_months ? JSON.parse(component.delivery_months) : null;\r\n  \r\n  // \u5982\u679C\u6307\u5B9A\u4E86\u5177\u4F53\u6708\u4EFD\uFF0C\u68C0\u67E5\u662F\u5426\u5728\u5217\u8868\u4E2D\r\n  if (deliveryMonths && Array.isArray(deliveryMonths)) {\r\n    return deliveryMonths.includes(month + 1); // month is 0-based, deliveryMonths is 1-based\r\n  }\r\n  \r\n  // \u6839\u636E\u9891\u7387\u5224\u65AD\r\n  switch (frequency) {\r\n    case 'monthly':\r\n      return true; // \u6BCF\u6708\u90FD\u751F\u6210\r\n      \r\n    case 'bi-monthly':\r\n      return (month + 1) % 2 === 1; // \u5947\u6570\u6708\r\n      \r\n    case 'quarterly':\r\n      return [0, 3, 6, 9].includes(month); // 1,4,7,10\u6708\r\n      \r\n    case 'yearly':\r\n      return month === 0; // \u4EC51\u6708\r\n      \r\n    case 'one-time':\r\n      return false; // \u4E00\u6B21\u6027\u670D\u52A1\u9700\u8981\u624B\u52A8\u521B\u5EFA\r\n      \r\n    default:\r\n      return false;\r\n  }\r\n}\r\n\r\n/**\r\n * \u683C\u5F0F\u5316\u65E5\u671F\u4E3A YYYY-MM-DD\r\n */\r\nfunction formatDate(date) {\r\n  const year = date.getFullYear();\r\n  const month = String(date.getMonth() + 1).padStart(2, '0');\r\n  const day = String(date.getDate()).padStart(2, '0');\r\n  return `${year}-${month}-${day}`;\r\n}\r\n\r\n/**\r\n * \u751F\u6210\u4EFB\u52A1\u540D\u79F0\r\n */\r\nfunction generateTaskName(component, client, targetYear, targetMonth) {\r\n  const monthStr = `${targetYear}\u5E74${targetMonth + 1}\u6708`;\r\n  const compName = component.component_name || component.service_name || '\u670D\u52A1';\r\n  const clientName = client.company_name || '\u5BA2\u6237';\r\n  \r\n  return `${clientName} - ${monthStr}${compName}`;\r\n}\r\n\r\n/**\r\n * \u4ECE\u6A21\u677F\u590D\u5236\u9636\u6BB5\r\n */\r\nasync function copyStagesFromTemplate(env, taskId, templateId) {\r\n  if (!templateId) return;\r\n  \r\n  try {\r\n    const stages = await env.DATABASE.prepare(`\r\n      SELECT stage_name, stage_order, description, estimated_hours\r\n      FROM TaskTemplateStages\r\n      WHERE template_id = ?\r\n      ORDER BY stage_order\r\n    `).bind(templateId).all();\r\n    \r\n    for (const stage of stages.results || []) {\r\n      await env.DATABASE.prepare(`\r\n        INSERT INTO ActiveTaskStages (task_id, stage_name, stage_order, status)\r\n        VALUES (?, ?, ?, 'pending')\r\n      `).bind(taskId, stage.stage_name, stage.stage_order).run();\r\n    }\r\n  } catch (err) {\r\n    console.error('\u590D\u5236\u4EFB\u52A1\u9636\u6BB5\u5931\u8D25:', err);\r\n  }\r\n}\r\n\r\n/**\r\n * \u590D\u5236\u670D\u52A1\u5C42\u7EA7\u7684 SOP \u5230\u4EFB\u52A1\uFF08\u6765\u81EAServiceComponentSOPs\uFF09\r\n */\r\nasync function copyServiceSOPsToTask(env, taskId, componentId) {\r\n  if (!componentId) return;\r\n  \r\n  try {\r\n    const componentSOPs = await env.DATABASE.prepare(`\r\n      SELECT sop_id, sort_order\r\n      FROM ServiceComponentSOPs\r\n      WHERE component_id = ?\r\n      ORDER BY sort_order\r\n    `).bind(componentId).all();\r\n    \r\n    for (const sop of componentSOPs.results || []) {\r\n      await env.DATABASE.prepare(`\r\n        INSERT OR IGNORE INTO ActiveTaskSOPs (task_id, sop_id, sort_order)\r\n        VALUES (?, ?, ?)\r\n      `).bind(taskId, sop.sop_id, sop.sort_order).run();\r\n    }\r\n    \r\n    if (componentSOPs.results && componentSOPs.results.length > 0) {\r\n      console.log(`[\u4EFB\u52A1\u751F\u6210\u5668] \u5DF2\u590D\u5236 ${componentSOPs.results.length} \u4E2A\u670D\u52A1\u5C42\u7EA7 SOP \u5230\u4EFB\u52A1 ${taskId}`);\r\n    }\r\n  } catch (err) {\r\n    console.error('\u590D\u5236\u670D\u52A1\u5C42\u7EA7 SOP \u5931\u8D25:', err);\r\n  }\r\n}\r\n\r\n/**\r\n * \u590D\u5236\u4EFB\u52A1\u5C42\u7EA7\u7684 SOP \u5230\u4EFB\u52A1\uFF08\u6765\u81EAServiceComponentTaskSOPs\uFF09\r\n */\r\nasync function copyTaskSOPsToActiveTask(env, taskId, taskConfigId) {\r\n  if (!taskConfigId) return;\r\n  \r\n  try {\r\n    const taskSOPs = await env.DATABASE.prepare(`\r\n      SELECT sop_id, sort_order\r\n      FROM ServiceComponentTaskSOPs\r\n      WHERE task_config_id = ?\r\n      ORDER BY sort_order\r\n    `).bind(taskConfigId).all();\r\n    \r\n    // \u83B7\u53D6\u5F53\u524D\u4EFB\u52A1\u5DF2\u6709\u7684 SOP \u6570\u91CF\uFF0C\u7528\u4E8E\u7EE7\u7EED\u6392\u5E8F\r\n    const countRow = await env.DATABASE.prepare(`\r\n      SELECT MAX(sort_order) as max_order\r\n      FROM ActiveTaskSOPs\r\n      WHERE task_id = ?\r\n    `).bind(taskId).first();\r\n    \r\n    let nextSortOrder = (countRow?.max_order || -1) + 1;\r\n    \r\n    for (const sop of taskSOPs.results || []) {\r\n      await env.DATABASE.prepare(`\r\n        INSERT OR IGNORE INTO ActiveTaskSOPs (task_id, sop_id, sort_order)\r\n        VALUES (?, ?, ?)\r\n      `).bind(taskId, sop.sop_id, nextSortOrder++).run();\r\n    }\r\n    \r\n    if (taskSOPs.results && taskSOPs.results.length > 0) {\r\n      console.log(`[\u4EFB\u52A1\u751F\u6210\u5668] \u5DF2\u590D\u5236 ${taskSOPs.results.length} \u4E2A\u4EFB\u52A1\u5C42\u7EA7 SOP \u5230\u4EFB\u52A1 ${taskId}`);\r\n    }\r\n  } catch (err) {\r\n    console.error('\u590D\u5236\u4EFB\u52A1\u5C42\u7EA7 SOP \u5931\u8D25:', err);\r\n  }\r\n}\r\n\r\n/**\r\n * \u4E3B\u51FD\u6570\uFF1A\u751F\u6210\u6240\u6709\u9700\u8981\u7684\u4EFB\u52A1\r\n */\r\nexport async function generateTasksForComponents(env, targetDate = null) {\r\n  const now = targetDate ? new Date(targetDate) : new Date();\r\n  const currentYear = now.getFullYear();\r\n  const currentMonth = now.getMonth();\r\n  \r\n  console.log(`[\u4EFB\u52A1\u751F\u6210\u5668] \u5F00\u59CB\u68C0\u67E5 ${currentYear}-${currentMonth + 1} \u7684\u4EFB\u52A1`);\r\n  \r\n  const result = {\r\n    checked: 0,\r\n    generated: 0,\r\n    skipped: 0,\r\n    errors: []\r\n  };\r\n  \r\n  try {\r\n    // \u83B7\u53D6\u6240\u6709\u542F\u7528\u7684\u670D\u52A1\u7EC4\u6210\u90E8\u5206\r\n    const components = await env.DATABASE.prepare(`\r\n      SELECT \r\n        sc.*,\r\n        cs.client_id,\r\n        c.company_name,\r\n        c.assignee_user_id,\r\n        s.service_name\r\n      FROM ServiceComponents sc\r\n      JOIN ClientServices cs ON sc.client_service_id = cs.client_service_id\r\n      JOIN Clients c ON cs.client_id = c.client_id\r\n      LEFT JOIN Services s ON sc.service_id = s.service_id\r\n      WHERE sc.is_active = 1 \r\n        AND cs.is_deleted = 0\r\n        AND c.is_deleted = 0\r\n        AND sc.auto_generate_task = 1\r\n        AND cs.status = 'active'\r\n    `).all();\r\n    \r\n    console.log(`[\u4EFB\u52A1\u751F\u6210\u5668] \u627E\u5230 ${components.results.length} \u4E2A\u670D\u52A1\u7EC4\u6210\u90E8\u5206`);\r\n    \r\n    for (const component of components.results || []) {\r\n      result.checked++;\r\n      \r\n      // \u68C0\u67E5\u662F\u5426\u5E94\u8BE5\u5728\u8FD9\u4E2A\u6708\u751F\u6210\r\n      if (!shouldGenerateInMonth(component, currentMonth)) {\r\n        result.skipped++;\r\n        continue;\r\n      }\r\n      \r\n      // \u8BA1\u7B97\u622A\u6B62\u65E5\u671F\r\n      const dueDate = calculateDueDate(component, currentYear, currentMonth);\r\n      const dueDateStr = formatDate(dueDate);\r\n      \r\n      // \u8BA1\u7B97\u4EFB\u52A1\u5E94\u8BE5\u751F\u6210\u7684\u65E5\u671F\uFF08\u63D0\u524DN\u5929\uFF09\r\n      const advanceDays = component.advance_days || 7;\r\n      const generateDate = new Date(dueDate);\r\n      generateDate.setDate(generateDate.getDate() - advanceDays);\r\n      \r\n      // \u5982\u679C\u8FD8\u6CA1\u5230\u751F\u6210\u65E5\u671F\uFF0C\u8DF3\u8FC7\r\n      if (now < generateDate) {\r\n        result.skipped++;\r\n        continue;\r\n      }\r\n      \r\n      // \u68C0\u67E5\u662F\u5426\u5DF2\u7ECF\u751F\u6210\u8FC7\uFF08\u907F\u514D\u91CD\u590D\uFF09\r\n      const existing = await env.DATABASE.prepare(`\r\n        SELECT task_id FROM ActiveTasks\r\n        WHERE component_id = ?\r\n          AND due_date = ?\r\n          AND is_deleted = 0\r\n      `).bind(component.component_id, dueDateStr).first();\r\n      \r\n      if (existing) {\r\n        console.log(`[\u4EFB\u52A1\u751F\u6210\u5668] \u4EFB\u52A1\u5DF2\u5B58\u5728: ${component.component_name} - ${dueDateStr}`);\r\n        result.skipped++;\r\n        continue;\r\n      }\r\n      \r\n      // \u67E5\u8BE2\u8BE5\u670D\u52A1\u7EC4\u6210\u914D\u7F6E\u7684\u5B50\u4EFB\u52A1\r\n      try {\r\n        const taskConfigs = await env.DATABASE.prepare(`\r\n          SELECT config_id, task_order, task_name, assignee_user_id, notes\r\n          FROM ServiceComponentTasks\r\n          WHERE component_id = ?\r\n          ORDER BY task_order\r\n        `).bind(component.component_id).all();\r\n        \r\n        const startDateStr = formatDate(now);\r\n        const serviceMonth = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;\r\n        \r\n        // \u5982\u679C\u6CA1\u6709\u914D\u7F6E\u5B50\u4EFB\u52A1\uFF0C\u751F\u6210\u4E00\u4E2A\u9ED8\u8BA4\u4EFB\u52A1\r\n        if (!taskConfigs.results || taskConfigs.results.length === 0) {\r\n          const taskName = generateTaskName(\r\n            component,\r\n            { company_name: component.company_name },\r\n            currentYear,\r\n            currentMonth\r\n          );\r\n          \r\n          const insertResult = await env.DATABASE.prepare(`\r\n            INSERT INTO ActiveTasks (\r\n              client_service_id,\r\n              component_id,\r\n              template_id,\r\n              task_name,\r\n              start_date,\r\n              due_date,\r\n              original_due_date,\r\n              service_month,\r\n              status,\r\n              assignee_user_id,\r\n              notes\r\n            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'pending', ?, ?)\r\n          `).bind(\r\n            component.client_service_id,\r\n            component.component_id,\r\n            component.task_template_id || null,\r\n            taskName,\r\n            startDateStr,\r\n            dueDateStr,\r\n            dueDateStr, // \u81EA\u52A8\u751F\u6210\u65F6\uFF0Coriginal_due_date \u4E0E due_date \u76F8\u540C\r\n            serviceMonth,\r\n            component.assignee_user_id || null,\r\n            `\u7531\u7CFB\u7D71\u65BC ${startDateStr} \u81EA\u52D5\u751F\u6210`\r\n          ).run();\r\n          \r\n          const taskId = insertResult.meta.last_row_id;\r\n          \r\n          // \u4ECE\u6A21\u677F\u590D\u5236\u9636\u6BB5\r\n          if (component.task_template_id) {\r\n            await copyStagesFromTemplate(env, taskId, component.task_template_id);\r\n          }\r\n          \r\n          // \u4ECE\u670D\u52A1\u7EC4\u6210\u590D\u5236\u670D\u52A1\u5C42\u7EA7SOP\r\n          await copyServiceSOPsToTask(env, taskId, component.component_id);\r\n          \r\n          console.log(`[\u4EFB\u52A1\u751F\u6210\u5668] \u5DF2\u751F\u6210\u4EFB\u52A1: ${taskName} (ID: ${taskId})`);\r\n          result.generated++;\r\n        } else {\r\n          // \u4E3A\u6BCF\u4E2A\u5B50\u4EFB\u52A1\u914D\u7F6E\u751F\u6210\u72EC\u7ACB\u7684\u4EFB\u52A1\r\n          for (const taskConfig of taskConfigs.results) {\r\n            const taskName = `${component.company_name} - ${taskConfig.task_name}`;\r\n            \r\n            const insertResult = await env.DATABASE.prepare(`\r\n              INSERT INTO ActiveTasks (\r\n                client_service_id,\r\n                component_id,\r\n                template_id,\r\n                task_name,\r\n                start_date,\r\n                due_date,\r\n                original_due_date,\r\n                service_month,\r\n                status,\r\n                assignee_user_id,\r\n                notes\r\n              ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'pending', ?, ?)\r\n            `).bind(\r\n              component.client_service_id,\r\n              component.component_id,\r\n              component.task_template_id || null,\r\n              taskName,\r\n              startDateStr,\r\n              dueDateStr,\r\n              dueDateStr, // \u81EA\u52A8\u751F\u6210\u65F6\uFF0Coriginal_due_date \u4E0E due_date \u76F8\u540C\r\n              serviceMonth,\r\n              taskConfig.assignee_user_id || component.assignee_user_id || null,\r\n              taskConfig.notes || `\u7531\u7CFB\u7D71\u65BC ${startDateStr} \u81EA\u52D5\u751F\u6210`\r\n            ).run();\r\n            \r\n            const taskId = insertResult.meta.last_row_id;\r\n            \r\n            // \u590D\u5236\u670D\u52A1\u5C42\u7EA7SOP\uFF08\u6765\u81EAServiceComponentSOPs\uFF09\r\n            await copyServiceSOPsToTask(env, taskId, component.component_id);\r\n            \r\n            // \u590D\u5236\u4EFB\u52A1\u5C42\u7EA7SOP\uFF08\u6765\u81EAServiceComponentTaskSOPs\uFF09\r\n            await copyTaskSOPsToActiveTask(env, taskId, taskConfig.config_id);\r\n            \r\n            console.log(`[\u4EFB\u52A1\u751F\u6210\u5668] \u5DF2\u751F\u6210\u4EFB\u52A1: ${taskName} (ID: ${taskId})`);\r\n            result.generated++;\r\n          }\r\n        }\r\n        \r\n      } catch (err) {\r\n        console.error(`[\u4EFB\u52A1\u751F\u6210\u5668] \u751F\u6210\u4EFB\u52A1\u5931\u8D25:`, err);\r\n        result.errors.push({\r\n          component_id: component.component_id,\r\n          component_name: component.component_name,\r\n          error: String(err)\r\n        });\r\n      }\r\n    }\r\n    \r\n  } catch (err) {\r\n    console.error('[\u4EFB\u52A1\u751F\u6210\u5668] \u6267\u884C\u5931\u8D25:', err);\r\n    throw err;\r\n  }\r\n  \r\n  console.log(`[\u4EFB\u52A1\u751F\u6210\u5668] \u5B8C\u6210: \u68C0\u67E5 ${result.checked}, \u751F\u6210 ${result.generated}, \u8DF3\u8FC7 ${result.skipped}, \u9519\u8BEF ${result.errors.length}`);\r\n  \r\n  return result;\r\n}\r\n\r\n/**\r\n * API\u7AEF\u70B9\uFF1A\u624B\u52A8\u89E6\u53D1\u4EFB\u52A1\u751F\u6210\r\n * POST /internal/api/v1/admin/tasks/generate-from-components\r\n */\r\nexport async function handleManualGeneration(request, env) {\r\n  try {\r\n    const result = await generateTasksForComponents(env);\r\n    \r\n    return new Response(JSON.stringify({\r\n      ok: true,\r\n      message: '\u4EFB\u52A1\u751F\u6210\u5B8C\u6210',\r\n      data: result\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n    \r\n  } catch (err) {\r\n    console.error('\u624B\u52A8\u4EFB\u52A1\u751F\u6210\u5931\u8D25:', err);\r\n    return new Response(JSON.stringify({\r\n      ok: false,\r\n      message: '\u4EFB\u52A1\u751F\u6210\u5931\u8D25',\r\n      error: String(err)\r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    });\r\n  }\r\n}\r\n\r\n", "/**\r\n * \u5DE5\u65F6\u7EDF\u8BA1API\r\n * \u533A\u5206\u5458\u5DE5\u548C\u7BA1\u7406\u5458\u6743\u9650\r\n */\r\n\r\nimport { jsonResponse, getCorsHeadersForRequest, getSessionUser } from '../utils.js';\r\n\r\n/**\r\n * \u83B7\u53D6\u6211\u7684\u5DE5\u65F6\u7EDF\u8BA1\uFF08\u5458\u5DE5\u6743\u9650\uFF09\r\n * GET /internal/api/v1/timesheets/my-stats?month=2025-01\r\n */\r\nasync function getMyStats(request, env, userId) {\r\n  const url = new URL(request.url);\r\n  const month = url.searchParams.get('month'); // YYYY-MM format\r\n  \r\n  let dateFilter = '';\r\n  const binds = [userId];\r\n  \r\n  if (month) {\r\n    const [year, monthNum] = month.split('-');\r\n    dateFilter = ` AND strftime('%Y-%m', work_date) = ?`;\r\n    binds.push(month);\r\n  }\r\n  \r\n  try {\r\n    // \u83B7\u53D6\u5DE5\u65F6\u6570\u636E\uFF08\u652F\u6301\u6709\u4EFB\u52A1\u548C\u65E0\u4EFB\u52A1\u4E24\u79CD\u60C5\u51B5\uFF09\r\n    const stats = await env.DATABASE.prepare(`\r\n      SELECT \r\n        t.timesheet_id,\r\n        t.work_date,\r\n        t.client_id,\r\n        t.task_id,\r\n        t.service_id,\r\n        t.service_item_id,\r\n        t.hours,\r\n        t.note,\r\n        c.company_name,\r\n        at.task_name,\r\n        at.component_id,\r\n        sc.component_name,\r\n        sc.estimated_hours,\r\n        cs.client_service_id,\r\n        s1.service_name as task_service_name,\r\n        s2.service_name as direct_service_name,\r\n        si.item_name as service_item_name\r\n      FROM Timesheets t\r\n      LEFT JOIN Clients c ON t.client_id = c.client_id\r\n      -- \u5982\u679C\u6709task_id\uFF0C\u5173\u8054\u4EFB\u52A1\r\n      LEFT JOIN ActiveTasks at ON t.task_id = at.task_id\r\n      LEFT JOIN ServiceComponents sc ON at.component_id = sc.component_id\r\n      LEFT JOIN ClientServices cs ON at.client_service_id = cs.client_service_id\r\n      LEFT JOIN Services s1 ON cs.service_id = s1.service_id\r\n      -- \u5982\u679C\u6CA1\u6709task_id\uFF0C\u76F4\u63A5\u4F7F\u7528service_id\r\n      LEFT JOIN Services s2 ON t.service_id = s2.service_id\r\n      LEFT JOIN ServiceItems si ON t.service_item_id = si.item_id\r\n      WHERE t.user_id = ? ${dateFilter}\r\n        AND t.is_deleted = 0\r\n      ORDER BY t.work_date DESC, t.timesheet_id DESC\r\n    `).bind(...binds).all();\r\n    \r\n    // \u8BA1\u7B97\u603B\u5DE5\u65F6\r\n    const totalHours = stats.results.reduce((sum, row) => sum + (row.hours || 0), 0);\r\n    \r\n    // \u6309\u5BA2\u6237\u5206\u7EC4\u7EDF\u8BA1\r\n    const byClient = {};\r\n    \r\n    for (const row of stats.results) {\r\n      const clientKey = row.client_id || 'internal';\r\n      const clientName = row.company_name || '\u5185\u90E8\u5DE5\u65F6';\r\n      \r\n      if (!byClient[clientKey]) {\r\n        byClient[clientKey] = {\r\n          client_id: row.client_id,\r\n          client_name: clientName,\r\n          total_hours: 0,\r\n          services: {}\r\n        };\r\n      }\r\n      \r\n      byClient[clientKey].total_hours += row.hours || 0;\r\n      \r\n      // \u6309\u670D\u52A1\u5B50\u9879\u76EE\u5206\u7EC4\uFF08\u4E0D\u7BA1\u6709\u6CA1\u6709\u4EFB\u52A1\uFF09\r\n      const serviceName = row.direct_service_name || row.task_service_name || '\u5176\u4ED6';\r\n      const itemName = row.service_item_name || '\u4E00\u822C\u5DE5\u4F5C';\r\n      const serviceKey = `${serviceName}_${itemName}`;\r\n      \r\n      if (!byClient[clientKey].services[serviceKey]) {\r\n        byClient[clientKey].services[serviceKey] = {\r\n          service_name: serviceName,\r\n          service_item_name: itemName,\r\n          actual_hours: 0,\r\n          estimated_hours: row.component_id ? row.estimated_hours : null,\r\n          has_estimate: !!row.component_id\r\n        };\r\n      }\r\n      \r\n      byClient[clientKey].services[serviceKey].actual_hours += row.hours || 0;\r\n    }\r\n    \r\n    // \u8F6C\u6362\u4E3A\u6570\u7EC4\r\n    const clientStats = Object.values(byClient).map(client => ({\r\n      ...client,\r\n      services: Object.values(client.services).map(svc => ({\r\n        ...svc,\r\n        over_time: svc.estimated_hours ? (svc.actual_hours - svc.estimated_hours) : null,\r\n        status: !svc.estimated_hours ? '\u65E0\u9884\u4F30' : \r\n                (svc.actual_hours <= svc.estimated_hours ? '\u6B63\u5E38' : '\u8D85\u65F6')\r\n      }))\r\n    }));\r\n    \r\n    return jsonResponse({\r\n      ok: true,\r\n      data: {\r\n        total_hours: totalHours,\r\n        period: month || '\u6240\u6709\u65F6\u95F4',\r\n        by_client: clientStats,\r\n        details: stats.results\r\n      }\r\n    });\r\n    \r\n  } catch (err) {\r\n    console.error('\u83B7\u53D6\u5DE5\u65F6\u7EDF\u8BA1\u5931\u8D25:', err);\r\n    return errorResponse('\u83B7\u53D6\u7EDF\u8BA1\u5931\u8D25', 500);\r\n  }\r\n}\r\n\r\n/**\r\n * \u83B7\u53D6\u6210\u672C\u5206\u6790\uFF08\u7BA1\u7406\u5458\u6743\u9650\uFF09\r\n * GET /internal/api/v1/admin/cost-analysis?client_id=xxx&month=2025-01\r\n */\r\nasync function getCostAnalysis(request, env) {\r\n  const url = new URL(request.url);\r\n  const clientId = url.searchParams.get('client_id');\r\n  const month = url.searchParams.get('month');\r\n  \r\n  if (!clientId) {\r\n    return errorResponse('\u7F3A\u5C11client_id\u53C2\u6570', 400);\r\n  }\r\n  \r\n  let dateFilter = '';\r\n  const binds = [clientId];\r\n  \r\n  if (month) {\r\n    dateFilter = ` AND strftime('%Y-%m', t.work_date) = ?`;\r\n    binds.push(month);\r\n  }\r\n  \r\n  try {\r\n    // \u83B7\u53D6\u5BA2\u6237\u4FE1\u606F\u548C\u6536\u8D39\r\n    const client = await env.DATABASE.prepare(`\r\n      SELECT \r\n        c.*,\r\n        cs.client_service_id,\r\n        srv.service_name,\r\n        SUM(sb.billing_amount) as monthly_revenue\r\n      FROM Clients c\r\n      LEFT JOIN ClientServices cs ON c.client_id = cs.client_id AND cs.is_deleted = 0\r\n      LEFT JOIN Services srv ON cs.service_id = srv.service_id\r\n      LEFT JOIN ServiceBillingSchedule sb ON cs.client_service_id = sb.client_service_id\r\n      WHERE c.client_id = ?\r\n        AND c.is_deleted = 0\r\n      GROUP BY c.client_id\r\n    `).bind(clientId).first();\r\n    \r\n    if (!client) {\r\n      return errorResponse('\u5BA2\u6237\u4E0D\u5B58\u5728', 404);\r\n    }\r\n    \r\n    // \u83B7\u53D6\u5DE5\u65F6\u548C\u6210\u672C\u6570\u636E\r\n    const costData = await env.DATABASE.prepare(`\r\n      SELECT \r\n        sc.component_id,\r\n        sc.component_name,\r\n        sc.estimated_hours,\r\n        SUM(t.hours) as actual_hours,\r\n        COUNT(DISTINCT t.user_id) as worker_count,\r\n        GROUP_CONCAT(DISTINCT u.name) as workers,\r\n        SUM(t.hours * COALESCE(u.hourly_cost, 200)) as total_cost\r\n      FROM Timesheets t\r\n      JOIN Users u ON t.user_id = u.user_id\r\n      JOIN ActiveTasks at ON t.task_id = at.task_id\r\n      JOIN ServiceComponents sc ON at.component_id = sc.component_id\r\n      WHERE t.client_id = ? ${dateFilter}\r\n        AND t.is_deleted = 0\r\n        AND at.is_deleted = 0\r\n      GROUP BY sc.component_id\r\n    `).bind(...binds).all();\r\n    \r\n    // \u8BA1\u7B97\u603B\u6210\u672C\u548C\u5229\u6DA6\r\n    const totalCost = costData.results.reduce((sum, row) => sum + (row.total_cost || 0), 0);\r\n    const revenue = client.monthly_revenue || 0;\r\n    const profit = revenue - totalCost;\r\n    const profitRate = revenue > 0 ? ((profit / revenue) * 100).toFixed(1) : '0';\r\n    \r\n    return jsonResponse({\r\n      ok: true,\r\n      data: {\r\n        client: {\r\n          client_id: client.client_id,\r\n          company_name: client.company_name,\r\n          service_name: client.service_name\r\n        },\r\n        period: month || '\u6240\u6709\u65F6\u95F4',\r\n        revenue: revenue,\r\n        total_cost: totalCost,\r\n        profit: profit,\r\n        profit_rate: profitRate + '%',\r\n        components: costData.results.map(row => ({\r\n          component_id: row.component_id,\r\n          component_name: row.component_name,\r\n          estimated_hours: row.estimated_hours,\r\n          actual_hours: row.actual_hours,\r\n          over_time: row.actual_hours - (row.estimated_hours || 0),\r\n          total_cost: row.total_cost,\r\n          worker_count: row.worker_count,\r\n          workers: row.workers ? row.workers.split(',') : []\r\n        }))\r\n      }\r\n    });\r\n    \r\n  } catch (err) {\r\n    console.error('\u83B7\u53D6\u6210\u672C\u5206\u6790\u5931\u8D25:', err);\r\n    return errorResponse('\u83B7\u53D6\u5206\u6790\u5931\u8D25', 500);\r\n  }\r\n}\r\n\r\n/**\r\n * \u8DEF\u7531\u5904\u7406\r\n */\r\nexport async function handleTimesheetStats(request, env, path) {\r\n  const user = await requireLogin(request, env);\r\n  if (!user.ok) return user.response;\r\n  \r\n  const method = request.method;\r\n  \r\n  if (method !== 'GET') {\r\n    return errorResponse('\u65B9\u6CD5\u4E0D\u5141\u8BB8', 405);\r\n  }\r\n  \r\n  // \u5458\u5DE5\u5DE5\u65F6\u7EDF\u8BA1\r\n  if (path === '/internal/api/v1/timesheets/my-stats') {\r\n    return await getMyStats(request, env, user.data.user_id);\r\n  }\r\n  \r\n  // \u7BA1\u7406\u5458\u6210\u672C\u5206\u6790\r\n  if (path === '/internal/api/v1/admin/cost-analysis') {\r\n    if (!user.data.is_admin) {\r\n      return errorResponse('\u65E0\u6743\u8BBF\u95EE', 403);\r\n    }\r\n    return await getCostAnalysis(request, env);\r\n  }\r\n  \r\n  return errorResponse('\u8DEF\u7531\u4E0D\u5B58\u5728', 404);\r\n}\r\n\r\n", "import { jsonResponse, generateRequestId, corsPreflightResponse, getSessionUser, getCorsHeadersForRequest } from \"./utils.js\";\nimport { handleLogin, handleAuthMe, handleLogout } from \"./auth.js\";\nimport { handleClients } from \"./api/clients.js\";\nimport { handleTasks } from \"./api/tasks.js\";\nimport { handleTimesheets } from \"./api/timesheets.js\";\nimport { handleReceipts } from \"./api/receipts.js\";\nimport { handlePayroll } from \"./api/payroll.js\";\nimport { handleLeaves } from \"./api/leaves.js\";\nimport { handleDevSeeding } from \"./api/dev.js\";\nimport { handleOverhead } from \"./api/overhead.js\";\nimport { handleReports } from \"./api/reports.js\";\nimport { handleAttachments } from \"./api/attachments.js\";\nimport { handleSOP } from \"./api/sop.js\";\nimport { handleFAQRequest } from \"./api/faq.js\";\nimport { handleDocumentsRequest } from \"./api/documents.js\";\nimport { handleClientServices } from \"./api/client_services.js\";\nimport { handleCMS } from \"./api/cms.js\";\nimport { handleSettings } from \"./api/settings.js\";\nimport { handleDashboard } from \"./api/dashboard.js\";\nimport { handleAutomation } from \"./api/automation.js\";\nimport { handleHolidays } from \"./api/holidays.js\";\nimport { handleTags } from \"./api/tags.js\";\nimport { handleBilling } from \"./api/billing.js\";\nimport { handleTaskTemplates } from \"./api/task_templates.js\";\nimport { handleServices } from \"./api/services.js\";\nimport { handleServiceComponents } from \"./api/service_components.js\";\nimport { handleManualGeneration } from \"./api/task_generator.js\";\nimport { handleTimesheetStats } from \"./api/timesheet_stats.js\";\n\nexport default {\n\tasync fetch(request, env) {\n\t\tconst url = new URL(request.url);\n\t\tconst path = url.pathname;\n\t\tconst method = request.method.toUpperCase();\n\t\tconst requestId = request.headers.get(\"X-Request-Id\") || generateRequestId();\n\n\t\tconst proxy = (host, newPath) => {\n\t\t\tconst target = new URL(request.url);\n\t\t\ttarget.protocol = \"https:\";\n\t\t\ttarget.hostname = host;\n\t\t\ttarget.pathname = newPath;\n\t\t\treturn fetch(new Request(target.toString(), request));\n\t\t};\n\n\t\t// CORS Preflight\uFF1A\u8655\u7406 /internal/api/* \u7684 OPTIONS\n\t\tif (path.startsWith(\"/internal/api/\") && method === \"OPTIONS\") {\n\t\t\treturn corsPreflightResponse(request, env);\n\t\t}\n\n\t// Auth routes\n\tif (path === \"/internal/api/v1/auth/login\") {\n\t\treturn handleLogin(request, env, requestId);\n\t}\n\tif (path === \"/internal/api/v1/auth/me\") {\n\t\treturn handleAuthMe(request, env, requestId);\n\t}\n\tif (path === \"/internal/api/v1/auth/logout\") {\n\t\treturn handleLogout(request, env, requestId);\n\t}\n\n\t\t// DEV routes (no session required, but env must not be prod)\n\t\tif (path.startsWith(\"/internal/api/v1/admin/dev-\")) {\n\t\t\treturn handleDevSeeding(request, env, requestId, path);\n\t\t}\n\n\t\t// Protected API routes we implement here\n\t\tif (path === \"/internal/api/v1/clients\" || path.startsWith(\"/internal/api/v1/clients/\")) {\n\t\t\tconst me = await getSessionUser(request, env);\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\treturn handleClients(request, env, me, requestId, url);\n\t\t}\n\t\tif (path === \"/internal/api/v1/tags\" || path.startsWith(\"/internal/api/v1/tags/\")) {\n\t\t\tconst me = await getSessionUser(request, env);\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\treturn handleTags(request, env, me, requestId, url);\n\t\t}\n\t\t\n\t\t// \u6536\u8D39\u660E\u7EC6API\n\t\tif (path.startsWith(\"/internal/api/v1/billing/\")) {\n\t\t\tconst me = await getSessionUser(request, env);\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\treturn handleBilling(request, env, me, requestId, url, path);\n\t\t}\n\t\t\n\t// \u4EFB\u52A1\u6A21\u677FAPI\n\tif (path.startsWith(\"/internal/api/v1/task-templates\")) {\n\t\tconst me = await getSessionUser(request, env);\n\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\treturn handleTaskTemplates(request, env, me, requestId, url, path);\n\t}\n\t\n\t// \u670D\u52A1\u9879\u76EEAPI\uFF08\u5FC5\u987B\u7CBE\u786E\u5339\u914D\uFF0C\u907F\u514D\u4E0E/clients/.../services\u51B2\u7A81\uFF09\n\tif (path === \"/internal/api/v1/services\" || \n\t    path === \"/internal/api/v1/services/items\" ||\n\t    /^\\/internal\\/api\\/v1\\/services\\/\\d+(\\/|$)/.test(path) ||\n\t    /^\\/internal\\/api\\/v1\\/services\\/\\d+\\/items/.test(path)) {\n\t\tconst me = await getSessionUser(request, env);\n\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\treturn handleServices(request, env, me, requestId, url, path);\n\t}\n\t\n\t// \u670D\u52A1\u7EC4\u6210\u90E8\u5206API\n\tif (path.includes(\"/client-services/\") && path.includes(\"/components\") || \n\t    path.includes(\"/service-components/\")) {\n\t\tconst me = await getSessionUser(request, env);\n\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\tconst result = await handleServiceComponents(request, env, path);\n\t\tif (result) return result;\n\t}\n\t\n\tif (path === \"/internal/api/v1/tasks\" || path.startsWith(\"/internal/api/v1/tasks/\")) {\n\t\tconst me = await getSessionUser(request, env);\n\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\treturn handleTasks(request, env, me, requestId, url);\n\t}\n\tif (path === \"/internal/api/v1/timesheets\" || path.startsWith(\"/internal/api/v1/timelogs\")) {\n\t\tconst me = await getSessionUser(request, env);\n\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\treturn handleTimesheets(request, env, me, requestId, url);\n\t}\n\t\n\t// \u5DE5\u65F6\u7EDF\u8BA1\u548C\u6210\u672C\u5206\u6790\n\tif (path === \"/internal/api/v1/timesheets/my-stats\" || path === \"/internal/api/v1/admin/cost-analysis\") {\n\t\tconst result = await handleTimesheetStats(request, env, path);\n\t\tif (result) return result;\n\t}\n\tif (path === \"/internal/api/v1/receipts\" || path.startsWith(\"/internal/api/v1/receipts/\")) {\n\t\tconst me = await getSessionUser(request, env);\n\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\treturn handleReceipts(request, env, me, requestId, url);\n\t}\n\tif (path === \"/internal/api/v1/attachments\" || path.startsWith(\"/internal/api/v1/attachments/\")) {\n\t\tconst me = await getSessionUser(request, env);\n\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\treturn handleAttachments(request, env, me, requestId, url, path);\n\t}\n\t\tif (path === \"/internal/api/v1/leaves\" || path === \"/internal/api/v1/leaves/balances\" || path === \"/internal/api/v1/leaves/life-events\" || path === \"/internal/api/v1/admin/cron/execute\" || path === \"/internal/api/v1/admin/cron/history\") {\n\t\t\tconst me = await getSessionUser(request, env);\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\treturn handleLeaves(request, env, me, requestId, url, path);\n\t\t}\n\t\tif (path === \"/internal/api/v1/holidays\") {\n\t\t\tconst me = await getSessionUser(request, env);\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\treturn handleHolidays(request, env, me, requestId, url);\n\t\t}\n\t\tif (path.startsWith(\"/internal/api/v1/admin/payroll\")) {\n\t\t\tconst me = await getSessionUser(request, env);\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\treturn handlePayroll(request, env, me, requestId, url, path);\n\t\t}\n\t\tif (path.startsWith(\"/internal/api/v1/admin/overhead\") || path.startsWith(\"/internal/api/v1/admin/costs\")) {\n\t\t\tconst me = await getSessionUser(request, env);\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\treturn handleOverhead(request, env, me, requestId, url, path);\n\t\t}\n\t\t// \u624B\u52A8\u89E6\u53D1\u4EFB\u52A1\u751F\u6210\n\t\tif (path === \"/internal/api/v1/admin/tasks/generate-from-components\" && method === \"POST\") {\n\t\t\tconst me = await getSessionUser(request, env);\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\treturn handleManualGeneration(request, env);\n\t\t}\n\t\tif (path === \"/internal/api/v1/admin/articles\" || path === \"/internal/api/v1/admin/faq\" || path === \"/internal/api/v1/admin/resources\" || path === \"/internal/api/v1/admin/services\") {\n\t\t\tconst me = await getSessionUser(request, env);\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\treturn handleCMS(request, env, me, requestId, url, path);\n\t\t}\n\t\tif (path.startsWith(\"/internal/api/v1/reports\")) {\n\t\t\tconst me = await getSessionUser(request, env);\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\treturn handleReports(request, env, me, requestId, url, path);\n\t\t}\n\n\tif (path === \"/internal/api/v1/sop\" || path.startsWith(\"/internal/api/v1/sop/\")) {\n\t\tconst me = await getSessionUser(request, env);\n\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\treturn handleSOP(request, env, me, requestId, url, path);\n\t}\n\t\n\t// FAQ API\n\tif (path === \"/internal/api/v1/faq\" || path.startsWith(\"/internal/api/v1/faq/\")) {\n\t\tconst me = await getSessionUser(request, env);\n\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\tconst result = await handleFAQRequest(request, env, null, path, me);\n\t\tif (result) return result;\n\t}\n\t\n\t// \u5185\u90E8\u6587\u6863\u8D44\u6E90\u4E2D\u5FC3 API\n\tif (path === \"/internal/api/v1/documents\" || path.startsWith(\"/internal/api/v1/documents/\")) {\n\t\tconst me = await getSessionUser(request, env);\n\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\tconst result = await handleDocumentsRequest(request, env, null, path, me);\n\t\tif (result) return result;\n\t}\n\n\tif (path === \"/internal/api/v1/dashboard\") {\n\t\t\tconst me = await getSessionUser(request, env);\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\treturn handleDashboard(request, env, me, requestId, url, path);\n\t\t}\n\n\t\tif (path === \"/internal/api/v1/admin/automation-rules\" || /\\/internal\\/api\\/v1\\/admin\\/automation-rules\\//.test(path)) {\n\t\t\tconst me = await getSessionUser(request, env);\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\treturn handleAutomation(request, env, me, requestId, url, path);\n\t\t}\n\n\t\t// \u7528\u6236\u5217\u8868\uFF08\u6240\u6709\u767B\u5F55\u7528\u6237\u53EF\u8BBF\u95EE\uFF09\n\t\tif (path === \"/internal/api/v1/users\") {\n\t\t\tconst me = await getSessionUser(request, env);\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\treturn handleSettings(request, env, me, requestId, url, path);\n\t\t}\n\t\t\n\t\t// \u7CFB\u7D71\u8A2D\u5B9A\uFF08\u7BA1\u7406\u54E1\uFF09\n\t\tif (path === \"/internal/api/v1/admin/settings\" || path.startsWith(\"/internal/api/v1/admin/settings/\")) {\n\t\t\tconst me = await getSessionUser(request, env);\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\treturn handleSettings(request, env, me, requestId, url, path);\n\t\t}\n\n\t\tif (path === \"/internal/api/v1/client-services\" || /\\/internal\\/api\\/v1\\/client-services\\//.test(path)) {\n\t\t\tconst me = await getSessionUser(request, env);\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\n\t\t\treturn handleClientServices(request, env, me, requestId, url, path);\n\t\t}\n\n\t\t// API \u4EE3\u7406\uFF1A/internal/api/* \u2192 <INTERNAL_API_HOST>/api/*\n\t\tif (path.startsWith(\"/internal/api/\")) {\n\t\t\treturn proxy(env.INTERNAL_API_HOST, path.replace(\"/internal\", \"\"));\n\t\t}\n\n\t\t// \u767B\u5165\u9801\uFF1A/login \u2192 <INTERNAL_BASE_HOST>/login\n\t\tif (path === \"/login\" || path.startsWith(\"/login/\")) {\n\t\t\treturn proxy(env.INTERNAL_BASE_HOST, \"/login\");\n\t\t}\n\n\t\t// \u5176\u4ED6\u5167\u90E8\u9801\u9762\uFF1A/internal/* \u2192 \u9700\u8981\u767B\u5165\uFF0C\u5426\u5247\u5C0E\u5411 /login\n\t\tif (path.startsWith(\"/internal/\")) {\n\t\t\tconst row = await getSessionUser(request, env);\n\t\t\tif (!row) {\n\t\t\t\tconst location = `/login?redirect=${encodeURIComponent(path)}`;\n\t\t\t\treturn new Response(null, { status: 302, headers: { Location: location } });\n\t\t\t}\n\t\t\treturn proxy(env.INTERNAL_BASE_HOST, path.replace(\"/internal\", \"\"));\n\t\t}\n\n\t\t// \u672A\u5339\u914D\u8DEF\u5F91\uFF08\u7406\u8AD6\u4E0A\u4E0D\u6703\u56E0\u70BA routes \u53EA\u7D81\u5B9A\u7279\u5B9A\u8DEF\u5F91\uFF09\n\t\treturn fetch(request);\n\t},\n\n\t// Scheduled Handler\uFF08Cron Triggers\uFF09\n\tasync scheduled(event, env, ctx) {\n\t\tconst requestId = crypto.randomUUID();\n\t\tconsole.log(JSON.stringify({ \n\t\t\tlevel: \"info\", \n\t\t\trequestId, \n\t\t\tevent: \"cron_triggered\", \n\t\t\tscheduledTime: new Date(event.scheduledTime).toISOString(),\n\t\t\tcron: event.cron \n\t\t}));\n\n\t\ttry {\n\t\t\t// \u57F7\u884C\u88DC\u4F11\u5230\u671F\u8F49\u52A0\u73ED\u8CBB\n\t\t\tconst now = new Date(event.scheduledTime);\n\t\t\tconst lastMonth = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() - 1, 1));\n\t\t\tconst lastDayOfLastMonth = new Date(Date.UTC(lastMonth.getUTCFullYear(), lastMonth.getUTCMonth() + 1, 0));\n\t\t\tconst expiryDate = `${lastDayOfLastMonth.getUTCFullYear()}-${String(lastDayOfLastMonth.getUTCMonth() + 1).padStart(2, '0')}-${String(lastDayOfLastMonth.getUTCDate()).padStart(2, '0')}`;\n\t\t\tconst currentMonth = `${now.getUTCFullYear()}-${String(now.getUTCMonth() + 1).padStart(2, '0')}`;\n\n\t\t\t// \u6383\u63CF\u5230\u671F\u7684\u88DC\u4F11\u8A18\u9304\n\t\t\tconst expiredGrants = await env.DATABASE.prepare(\n\t\t\t\t`SELECT g.grant_id, g.user_id, g.hours_remaining, g.original_rate, u.base_salary\n\t\t\t\t FROM CompensatoryLeaveGrants g\n\t\t\t\t LEFT JOIN Users u ON g.user_id = u.user_id\n\t\t\t\t WHERE g.expiry_date = ? AND g.status = 'active' AND g.hours_remaining > 0`\n\t\t\t).bind(expiryDate).all();\n\n\t\t\tlet processedCount = 0;\n\t\t\tconst grantIds = [];\n\n\t\t\tfor (const grant of (expiredGrants?.results || [])) {\n\t\t\t\tconst baseSalary = Number(grant.base_salary || 0);\n\t\t\t\tconst hourlyRate = baseSalary / 240;\n\t\t\t\tconst hours = Number(grant.hours_remaining || 0);\n\t\t\t\tconst rate = Number(grant.original_rate || 1);\n\t\t\t\tconst amountCents = Math.round(hours * hourlyRate * rate * 100);\n\n\t\t\t\t// \u5BEB\u5165\u52A0\u73ED\u8CBB\u8A18\u9304\n\t\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\t`INSERT INTO CompensatoryOvertimePay \n\t\t\t\t\t (user_id, year_month, hours_expired, amount_cents, source_grant_ids)\n\t\t\t\t\t VALUES (?, ?, ?, ?, ?)`\n\t\t\t\t).bind(\n\t\t\t\t\tString(grant.user_id),\n\t\t\t\t\tcurrentMonth,\n\t\t\t\t\thours,\n\t\t\t\t\tamountCents,\n\t\t\t\t\tJSON.stringify([grant.grant_id])\n\t\t\t\t).run();\n\n\t\t\t\t// \u66F4\u65B0\u88DC\u4F11\u8A18\u9304\u72C0\u614B\u70BA expired\n\t\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\t`UPDATE CompensatoryLeaveGrants SET status = 'expired' WHERE grant_id = ?`\n\t\t\t\t).bind(grant.grant_id).run();\n\n\t\t\t\tgrantIds.push(grant.grant_id);\n\t\t\t\tprocessedCount++;\n\t\t\t}\n\n\t\t\t// \u8A18\u9304\u57F7\u884C\u6210\u529F\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`INSERT INTO CronJobExecutions \n\t\t\t\t (job_name, status, executed_at, details)\n\t\t\t\t VALUES (?, 'success', datetime('now'), ?)`\n\t\t\t).bind('comp_leave_expiry', JSON.stringify({\n\t\t\t\texpiryDate,\n\t\t\t\tprocessedCount,\n\t\t\t\tgrantIds,\n\t\t\t\tcurrentMonth,\n\t\t\t\ttriggeredBy: 'cron'\n\t\t\t})).run();\n\n\t\t\tconsole.log(JSON.stringify({ \n\t\t\t\tlevel: \"info\", \n\t\t\t\trequestId, \n\t\t\t\tevent: \"cron_completed\", \n\t\t\t\tprocessedCount,\n\t\t\t\texpiryDate,\n\t\t\t\tcurrentMonth\n\t\t\t}));\n\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ \n\t\t\t\tlevel: \"error\", \n\t\t\t\trequestId, \n\t\t\t\tevent: \"cron_failed\", \n\t\t\t\terror: String(err) \n\t\t\t}));\n\n\t\t\t// \u8A18\u9304\u57F7\u884C\u5931\u6557\n\t\t\ttry {\n\t\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\t`INSERT INTO CronJobExecutions \n\t\t\t\t\t (job_name, status, executed_at, error_message)\n\t\t\t\t\t VALUES (?, 'failed', datetime('now'), ?)`\n\t\t\t\t).bind('comp_leave_expiry', String(err)).run();\n\t\t\t} catch (_) {\n\t\t\t\tconsole.error(JSON.stringify({ \n\t\t\t\t\tlevel: \"error\", \n\t\t\t\t\trequestId, \n\t\t\t\t\tevent: \"failed_to_log_cron_error\" \n\t\t\t\t}));\n\t\t\t}\n\t\t}\n\t},\n};\n\n\n\n"],
  "mappings": "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",
  "names": ["body", "body", "workType", "body", "body", "body", "MANDATORY_COMP_LEAVE_TYPES", "today", "body", "parseId", "parseId", "parseId"]
}
