var Ie=Object.defineProperty;var w=(d,t)=>Ie(d,"name",{value:t,configurable:!0});function a(d,t,f={}){return new Response(JSON.stringify(t),{status:d,headers:{"Content-Type":"application/json; charset=utf-8",...f}})}w(a,"jsonResponse");function ae(){let d=crypto.getRandomValues(new Uint8Array(8));return"req_"+Array.from(d).map(t=>t.toString(16).padStart(2,"0")).join("")}w(ae,"generateRequestId");async function se(d,t){if(!t||typeof t!="string")return!1;let f=t.split("$");if(f.length!==4||f[0]!=="pbkdf2")return!1;let e=parseInt(f[1],10);if(!Number.isFinite(e)||e<1e5)return!1;let h=Uint8Array.from(atob(f[2]),p=>p.charCodeAt(0)),r=Uint8Array.from(atob(f[3]),p=>p.charCodeAt(0)),s=new TextEncoder,_=await crypto.subtle.importKey("raw",s.encode(d),{name:"PBKDF2"},!1,["deriveBits"]),o=await crypto.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:h,iterations:e},_,r.byteLength*8),g=new Uint8Array(o);if(g.byteLength!==r.byteLength)return!1;let l=0;for(let p=0;p<g.byteLength;p++)l|=g[p]^r[p];return l===0}w(se,"verifyPasswordPBKDF2");async function re(d,t=1e5,f=32){let e=crypto.getRandomValues(new Uint8Array(16)),h=new TextEncoder,r=await crypto.subtle.importKey("raw",h.encode(d),{name:"PBKDF2"},!1,["deriveBits"]),s=await crypto.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:e,iterations:t},r,f*8),_=new Uint8Array(s),o=w(g=>btoa(String.fromCharCode(...g)),"b64");return`pbkdf2$${t}$${o(e)}$${o(_)}`}w(re,"hashPasswordPBKDF2");function ie(){let d=crypto.getRandomValues(new Uint8Array(32));return btoa(String.fromCharCode(...d)).replaceAll("=","").replaceAll("+","-").replaceAll("/","_")}w(ie,"generateSessionId");function D(d,t){let f=d.headers.get("Origin")||"";if(!f)return{};try{let h=new URL(f).hostname||"";if(h.endsWith(".pages.dev")||h.endsWith("horgoscpa.com"))return{"Access-Control-Allow-Origin":f,"Access-Control-Allow-Credentials":"true",Vary:"Origin"}}catch{}return{}}w(D,"getCorsHeadersForRequest");function ne(d,t){let f={...D(d,t),"Access-Control-Allow-Methods":"GET,POST,OPTIONS","Access-Control-Allow-Headers":d.headers.get("Access-Control-Request-Headers")||"Content-Type, X-Request-Id","Access-Control-Max-Age":"600"};return new Response(null,{status:204,headers:f})}w(ne,"corsPreflightResponse");function X(d,t){let e=(d.headers.get("Cookie")||"").split(";");for(let h of e){let[r,...s]=h.trim().split("=");if(r===t)return s.join("=")}return null}w(X,"getCookie");async function F(d,t){let f=String(t.SESSION_COOKIE_NAME||"session"),e=X(d,f);if(!e||!t.DATABASE)return null;let h=await t.DATABASE.prepare("SELECT s.id as session_id, s.user_id, s.expires_at, u.username, u.name, u.email, u.is_admin FROM sessions s JOIN Users u ON u.user_id = s.user_id WHERE s.id = ? LIMIT 1").bind(e).first();if(!h)return null;let r=Date.parse(h.expires_at);return Number.isNaN(r)||r<=Date.now()?null:h}w(F,"getSessionUser");async function oe(d,t,f){if(d.method.toUpperCase()!=="POST")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:f}},D(d,t));let e;try{e=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:f}},D(d,t))}let h=(e?.username||"").trim().toLowerCase(),r=e?.password||"",s=[];if(h||s.push({field:"username",message:"\u5FC5\u586B"}),r||s.push({field:"password",message:"\u5FC5\u586B"}),s.length>0)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F38\u5165\u6709\u8AA4",errors:s,meta:{requestId:f}},D(d,t));if(!t.DATABASE)return a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u8CC7\u6599\u5EAB\u672A\u7D81\u5B9A",meta:{requestId:f}},D(d,t));try{let _=await t.DATABASE.prepare("SELECT user_id, username, password_hash, name, email, is_admin, is_deleted FROM Users WHERE LOWER(username) = ? LIMIT 1").bind(h).first(),o=D(d,t),g=w(()=>a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u5E33\u865F\u6216\u5BC6\u78BC\u932F\u8AA4",meta:{requestId:f}},o),"unauthorized");if(!_||_.is_deleted===1)return g();let l=_.password_hash||"";if(!await se(r,l))return g();await t.DATABASE.prepare("UPDATE Users SET last_login = ? WHERE user_id = ?").bind(new Date().toISOString(),_.user_id).run();let m=ie(),c=parseInt(t.SESSION_TTL_SECONDS||"2592000",10),n=new Date,i=new Date(n.getTime()+c*1e3);await t.DATABASE.prepare("INSERT INTO sessions (id, user_id, created_at, expires_at, meta_json) VALUES (?, ?, ?, ?, ?)").bind(m,String(_.user_id),n.toISOString(),i.toISOString(),JSON.stringify({ua:d.headers.get("User-Agent")||""})).run();let E=[`${String(t.SESSION_COOKIE_NAME||"session")}=${m}`,"Domain=horgoscpa.com","Path=/","HttpOnly","Secure","SameSite=Lax",`Max-Age=${c}`].join("; "),A={userId:String(_.user_id),username:_.username,name:_.name,email:_.email,isAdmin:_.is_admin===1};return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:A,meta:{requestId:f}},{"Set-Cookie":E,...o})}catch(_){console.error(JSON.stringify({level:"error",requestId:f,path:"/internal/api/v1/auth/login",err:String(_)}));let o={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:f}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(o.error=String(_)),a(500,o,D(d,t))}}w(oe,"handleLogin");async function ce(d,t,f){if(d.method.toUpperCase()!=="GET")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:f}},D(d,t));try{let e=await F(d,t);if(!e)return a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:f}},D(d,t));let h={userId:String(e.user_id),username:e.username,name:e.name,email:e.email,isAdmin:e.is_admin===1};return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:h,meta:{requestId:f}},D(d,t))}catch(e){console.error(JSON.stringify({level:"error",requestId:f,path:"/internal/api/v1/auth/me",err:String(e)}));let h={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:f}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(h.error=String(e)),a(500,h,D(d,t))}}w(ce,"handleAuthMe");async function de(d,t,f,e,h){let r=D(d,t),s=d.method.toUpperCase();console.log(`[CLIENTS.JS] \u6536\u5230\u8ACB\u6C42: ${s} ${h.pathname}`);let _=h.pathname.match(/^\/internal\/api\/v1\/clients\/([^\/]+)\/services\/(\d+)\/items$/);if(console.log("[CLIENTS.JS] \u8DEF\u75311\u5339\u914D\u7D50\u679C (items):",_),s==="GET"&&_){let c=_[1],n=parseInt(_[2]);try{if(!await t.DATABASE.prepare("SELECT client_id FROM Clients WHERE client_id = ? AND is_deleted = 0").bind(c).first())return a(404,{ok:!1,code:"NOT_FOUND",message:"\u5BA2\u6236\u4E0D\u5B58\u5728",meta:{requestId:e}},r);let E=(await t.DATABASE.prepare(`SELECT item_id, item_name, item_code, description, sort_order
				 FROM ServiceItems
				 WHERE service_id = ? AND is_active = 1
				 ORDER BY sort_order ASC, item_id ASC`).bind(n).all()).results.map(A=>({item_id:A.item_id,item_name:A.item_name,item_code:A.item_code,description:A.description||""}));return a(200,{ok:!0,code:"SUCCESS",message:"\u67E5\u8A62\u6210\u529F",data:E,meta:{requestId:e}},r)}catch(i){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(i)}));let u={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(u.error=String(i)),a(500,u,r)}}let o=h.pathname.match(/^\/internal\/api\/v1\/clients\/([^\/]+)\/services$/);if(console.log("[CLIENTS.JS] \u8DEF\u75312\u5339\u914D\u7D50\u679C (services):",o),s==="GET"&&o){let c=o[1];console.log("[API DEBUG] \u670D\u52D9\u9805\u76EE\u8DEF\u7531\u5339\u914D\uFF01clientId:",c);try{if(!await t.DATABASE.prepare("SELECT client_id FROM Clients WHERE client_id = ? AND is_deleted = 0").bind(c).first())return a(404,{ok:!1,code:"NOT_FOUND",message:"\u5BA2\u6236\u4E0D\u5B58\u5728",meta:{requestId:e}},r);let i=await t.DATABASE.prepare(`SELECT DISTINCT cs.service_id
				 FROM ClientServices cs
				 WHERE cs.client_id = ? AND cs.is_deleted = 0 AND cs.service_id IS NOT NULL`).bind(c).all();console.log("[API DEBUG] ClientServices \u67E5\u8A62\u7D50\u679C:",i.results);let u;if(i.results&&i.results.length>0){let A=i.results.map(R=>R.service_id),T=A.map(()=>"?").join(",");console.log("[API DEBUG] \u5BA2\u6236\u6709\u6307\u5B9A\u670D\u52D9\uFF0CserviceIds:",A),u=await t.DATABASE.prepare(`SELECT service_id, service_name, service_code, description
					 FROM Services
					 WHERE service_id IN (${T}) AND is_active = 1
					 ORDER BY sort_order ASC, service_id ASC`).bind(...A).all()}else console.log("[API DEBUG] \u5BA2\u6236\u6C92\u6709\u6307\u5B9A\u670D\u52D9\uFF0C\u8FD4\u56DE\u6240\u6709\u53EF\u7528\u670D\u52D9"),u=await t.DATABASE.prepare(`SELECT service_id, service_name, service_code, description
					 FROM Services
					 WHERE is_active = 1
					 ORDER BY sort_order ASC, service_id ASC`).all();let E=u.results.map(A=>({service_id:A.service_id,service_name:A.service_name,service_code:A.service_code,description:A.description||""}));return console.log("[API DEBUG] \u6700\u7D42\u8FD4\u56DE\u670D\u52D9\u5217\u8868:",E),a(200,{ok:!0,code:"SUCCESS",message:"\u67E5\u8A62\u6210\u529F",data:E,meta:{requestId:e}},r)}catch(n){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(n)}));let i={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(i.error=String(n)),a(500,i,r)}}let g=h.pathname.match(/\/clients\/[^\/]+$/);if(console.log("[CLIENTS.JS] \u8DEF\u75313\u5339\u914D\u7D50\u679C (single):",g),s==="GET"&&g){let c=h.pathname.split("/").pop();try{let n=await t.DATABASE.prepare(`SELECT c.client_id, c.company_name, c.tax_registration_number, c.phone, c.email, 
				        c.client_notes, c.payment_notes, c.created_at, c.updated_at,
				        u.user_id as assignee_id, u.name as assignee_name,
				        GROUP_CONCAT(t.tag_id || ':' || t.tag_name || ':' || COALESCE(t.tag_color, ''), '|') as tags
				 FROM Clients c
				 LEFT JOIN Users u ON u.user_id = c.assignee_user_id
				 LEFT JOIN ClientTagAssignments a ON a.client_id = c.client_id
				 LEFT JOIN CustomerTags t ON t.tag_id = a.tag_id
				 WHERE c.client_id = ? AND c.is_deleted = 0
				 GROUP BY c.client_id`).bind(c).first();if(!n)return a(404,{ok:!1,code:"NOT_FOUND",message:"\u5BA2\u6236\u4E0D\u5B58\u5728",meta:{requestId:e}},r);let i=[];n.tags&&String(n.tags).split("|").forEach(R=>{let[S,N,O]=R.split(":");S&&N&&i.push({tag_id:parseInt(S),tag_name:N,tag_color:O||null})});let u=await t.DATABASE.prepare(`SELECT cs.client_service_id, cs.service_id, cs.status, cs.service_cycle,
				        cs.task_template_id, cs.auto_generate_tasks,
				        cs.start_date, cs.end_date, cs.service_notes,
				        s.service_name, s.service_code
				 FROM ClientServices cs
				 LEFT JOIN Services s ON s.service_id = cs.service_id
				 WHERE cs.client_id = ? AND cs.is_deleted = 0
				 ORDER BY cs.client_service_id ASC`).bind(c).all(),E=await Promise.all((u?.results||[]).map(async T=>{let S=((await t.DATABASE.prepare(`SELECT billing_month, billing_amount, payment_due_days, notes
					 FROM ServiceBillingSchedule
					 WHERE client_service_id = ?
					 ORDER BY billing_month ASC`).bind(T.client_service_id).all())?.results||[]).map(O=>({billing_month:O.billing_month,billing_amount:Number(O.billing_amount||0),payment_due_days:Number(O.payment_due_days||30),notes:O.notes||""})),N=S.reduce((O,b)=>O+b.billing_amount,0);return{client_service_id:T.client_service_id,service_id:T.service_id,service_name:T.service_name||"",service_code:T.service_code||"",status:T.status||"active",service_cycle:T.service_cycle||"monthly",task_template_id:T.task_template_id||null,auto_generate_tasks:!!T.auto_generate_tasks,start_date:T.start_date||null,end_date:T.end_date||null,service_notes:T.service_notes||"",billing_schedule:S,year_total:N}})),A={clientId:n.client_id,companyName:n.company_name,taxId:n.tax_registration_number,assigneeUserId:n.assignee_id,assigneeName:n.assignee_name||"",phone:n.phone||"",email:n.email||"",clientNotes:n.client_notes||"",paymentNotes:n.payment_notes||"",tags:i,services:E,createdAt:n.created_at,updatedAt:n.updated_at};return a(200,{ok:!0,code:"SUCCESS",message:"\u67E5\u8A62\u6210\u529F",data:A,meta:{requestId:e}},r)}catch(n){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(n)}));let i={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(i.error=String(n)),a(500,i,r)}}let l=h.pathname==="/internal/api/v1/clients";if(console.log("[CLIENTS.JS] \u8DEF\u75314\u5339\u914D\u7D50\u679C (list):",l,"pathname:",h.pathname),s==="GET"&&l){let c=h.searchParams,n=Math.max(1,parseInt(c.get("page")||"1",10)),i=Math.min(100,Math.max(1,parseInt(c.get("perPage")||"50",10))),u=(n-1)*i,E=(c.get("company_name")||c.get("q")||"").trim();try{let A=["c.is_deleted = 0"],T=[];E&&(A.push("c.company_name LIKE ?"),T.push(`%${E}%`));let R=A.length?`WHERE ${A.join(" AND ")}`:"",S=await t.DATABASE.prepare(`SELECT COUNT(1) as total FROM Clients c ${R}`).bind(...T).first(),N=Number(S?.total||0),b=((await t.DATABASE.prepare(`SELECT c.client_id, c.company_name, c.tax_registration_number, c.phone, c.email, c.created_at, 
				        u.name as assignee_name,
				        GROUP_CONCAT(t.tag_name, ',') as tags
				 FROM Clients c
				 LEFT JOIN Users u ON u.user_id = c.assignee_user_id
				 LEFT JOIN ClientTagAssignments a ON a.client_id = c.client_id
				 LEFT JOIN CustomerTags t ON t.tag_id = a.tag_id
				 ${R}
				 GROUP BY c.client_id
				 ORDER BY c.created_at DESC
				 LIMIT ? OFFSET ?`).bind(...T,i,u).all())?.results||[]).map(B=>({clientId:B.client_id,companyName:B.company_name,taxId:B.tax_registration_number,assigneeName:B.assignee_name||"",tags:B.tags?String(B.tags).split(",").filter(Boolean):[],phone:B.phone||"",email:B.email||"",createdAt:B.created_at})),y={requestId:e,page:n,perPage:i,total:N,hasNext:u+i<N};return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:b,meta:y},r)}catch(A){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(A)}));let T={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(T.error=String(A)),a(500,T,r)}}if(console.log(`[CLIENTS.JS] \u6AA2\u67E5\u5275\u5EFA\u5BA2\u6236\u8DEF\u7531: ${s} === "POST" && ${h.pathname} === "/internal/api/v1/clients" => ${s==="POST"&&h.pathname==="/internal/api/v1/clients"}`),s==="POST"&&h.pathname==="/internal/api/v1/clients"){console.log("[CLIENTS.JS] \u2705 \u5339\u914D\u5275\u5EFA\u5BA2\u6236\u8DEF\u7531");let c;try{c=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},r)}let n=[],i=String(c?.client_id||"").trim(),u=String(c?.company_name||"").trim(),E=Number(c?.assignee_user_id||0),A=(c?.phone||"").trim(),T=(c?.email||"").trim(),R=(c?.client_notes||"").trim(),S=(c?.payment_notes||"").trim(),N=Array.isArray(c?.tag_ids)?c.tag_ids.map(O=>Number(O)).filter(O=>Number.isFinite(O)):[];if(/^\d{8}$/.test(i)||n.push({field:"client_id",message:"\u5FC5\u586B\u4E14\u9808\u70BA8\u4F4D\u6578\u5B57"}),(u.length<1||u.length>100)&&n.push({field:"company_name",message:"\u9577\u5EA6\u9700 1\u2013100"}),(!Number.isInteger(E)||E<=0)&&n.push({field:"assignee_user_id",message:"\u5FC5\u586B"}),T&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(T)&&n.push({field:"email",message:"Email \u683C\u5F0F\u932F\u8AA4"}),A&&!/^[-+()\s0-9]{6,}$/.test(A)&&n.push({field:"phone",message:"\u96FB\u8A71\u683C\u5F0F\u932F\u8AA4"}),n.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F38\u5165\u6709\u8AA4",errors:n,meta:{requestId:e}},r);try{if(await t.DATABASE.prepare("SELECT 1 FROM Clients WHERE client_id = ? AND is_deleted = 0 LIMIT 1").bind(i).first())return a(409,{ok:!1,code:"CONFLICT",message:"\u5BA2\u6236\u5DF2\u5B58\u5728",meta:{requestId:e}},r);if(!await t.DATABASE.prepare("SELECT 1 FROM Users WHERE user_id = ? AND is_deleted = 0 LIMIT 1").bind(E).first())return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8CA0\u8CAC\u4EBA\u4E0D\u5B58\u5728",errors:[{field:"assignee_user_id",message:"\u4E0D\u5B58\u5728"}],meta:{requestId:e}},r);if(N.length>0){let I=N.map(()=>"?").join(","),M=await t.DATABASE.prepare(`SELECT COUNT(1) as cnt FROM CustomerTags WHERE tag_id IN (${I})`).bind(...N).first();if(Number(M?.cnt||0)!==N.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u6A19\u7C64\u4E0D\u5B58\u5728",meta:{requestId:e}},r)}let y=new Date().toISOString();await t.DATABASE.prepare("INSERT INTO Clients (client_id, company_name, assignee_user_id, phone, email, client_notes, payment_notes, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)").bind(i,u,E,A,T,R,S,y,y).run();for(let I of N)await t.DATABASE.prepare("INSERT OR IGNORE INTO ClientTagAssignments (client_id, tag_id, assigned_at) VALUES (?, ?, ?)").bind(i,I,y).run();return a(201,{ok:!0,code:"CREATED",message:"\u5DF2\u5EFA\u7ACB",data:{clientId:i,companyName:u,assigneeUserId:E,phone:A,email:T,clientNotes:R,paymentNotes:S,tags:N},meta:{requestId:e}},r)}catch(O){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(O)}));let b={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(b.error=String(O)),a(500,b,r)}}if(s==="PUT"&&h.pathname.match(/\/clients\/[^\/]+$/)){let c=h.pathname.split("/").pop(),n;try{n=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},r)}let i=[],u=String(n?.company_name||"").trim(),E=Number(n?.assignee_user_id||0),A=(n?.phone||"").trim(),T=(n?.email||"").trim(),R=(n?.client_notes||"").trim(),S=(n?.payment_notes||"").trim(),N=Array.isArray(n?.tag_ids)?n.tag_ids.map(O=>Number(O)).filter(O=>Number.isFinite(O)):[];if((u.length<1||u.length>100)&&i.push({field:"company_name",message:"\u9577\u5EA6\u9700 1\u2013100"}),(!Number.isInteger(E)||E<=0)&&i.push({field:"assignee_user_id",message:"\u5FC5\u586B"}),T&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(T)&&i.push({field:"email",message:"Email \u683C\u5F0F\u932F\u8AA4"}),A&&!/^[-+()\s0-9]{6,}$/.test(A)&&i.push({field:"phone",message:"\u96FB\u8A71\u683C\u5F0F\u932F\u8AA4"}),i.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F38\u5165\u6709\u8AA4",errors:i,meta:{requestId:e}},r);try{if(!await t.DATABASE.prepare("SELECT 1 FROM Clients WHERE client_id = ? AND is_deleted = 0 LIMIT 1").bind(c).first())return a(404,{ok:!1,code:"NOT_FOUND",message:"\u5BA2\u6236\u4E0D\u5B58\u5728",meta:{requestId:e}},r);if(!await t.DATABASE.prepare("SELECT 1 FROM Users WHERE user_id = ? AND is_deleted = 0 LIMIT 1").bind(E).first())return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8CA0\u8CAC\u4EBA\u4E0D\u5B58\u5728",errors:[{field:"assignee_user_id",message:"\u4E0D\u5B58\u5728"}],meta:{requestId:e}},r);if(N.length>0){let I=N.map(()=>"?").join(","),M=await t.DATABASE.prepare(`SELECT COUNT(1) as cnt FROM CustomerTags WHERE tag_id IN (${I})`).bind(...N).first();if(Number(M?.cnt||0)!==N.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u6A19\u7C64\u4E0D\u5B58\u5728",meta:{requestId:e}},r)}let y=new Date().toISOString();await t.DATABASE.prepare("UPDATE Clients SET company_name = ?, assignee_user_id = ?, phone = ?, email = ?, client_notes = ?, payment_notes = ?, updated_at = ? WHERE client_id = ?").bind(u,E,A,T,R,S,y,c).run(),await t.DATABASE.prepare("DELETE FROM ClientTagAssignments WHERE client_id = ?").bind(c).run();for(let I of N)await t.DATABASE.prepare("INSERT INTO ClientTagAssignments (client_id, tag_id, assigned_at) VALUES (?, ?, ?)").bind(c,I,y).run();return a(200,{ok:!0,code:"SUCCESS",message:"\u5DF2\u66F4\u65B0",data:{clientId:c,companyName:u,assigneeUserId:E,phone:A,email:T,clientNotes:R,paymentNotes:S,tags:N,updatedAt:y},meta:{requestId:e}},r)}catch(O){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(O)}));let b={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(b.error=String(O)),a(500,b,r)}}if(s==="DELETE"&&h.pathname.match(/\/clients\/[^\/]+$/)){let c=h.pathname.split("/").pop();try{if(!await t.DATABASE.prepare("SELECT 1 FROM Clients WHERE client_id = ? AND is_deleted = 0 LIMIT 1").bind(c).first())return a(404,{ok:!1,code:"NOT_FOUND",message:"\u5BA2\u6236\u4E0D\u5B58\u5728",meta:{requestId:e}},r);let i=new Date().toISOString();return await t.DATABASE.prepare("UPDATE Clients SET is_deleted = 1, deleted_at = ?, deleted_by = ? WHERE client_id = ?").bind(i,f.user_id,c).run(),a(200,{ok:!0,code:"SUCCESS",message:"\u5DF2\u522A\u9664",meta:{requestId:e}},r)}catch(n){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(n)}));let i={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(i.error=String(n)),a(500,i,r)}}if(s==="POST"&&h.pathname==="/internal/api/v1/clients/batch-assign"){if(!f.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u6B0A\u9650\u4E0D\u8DB3\uFF0C\u50C5\u7BA1\u7406\u54E1\u53EF\u57F7\u884C",meta:{requestId:e}},r);let c;try{c=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},r)}let n=[],i=Array.isArray(c?.client_ids)?c.client_ids:[],u=Number(c?.assignee_user_id||0);if(i.length===0&&n.push({field:"client_ids",message:"\u8ACB\u9078\u64C7\u81F3\u5C11\u4E00\u500B\u5BA2\u6236"}),i.length>100&&n.push({field:"client_ids",message:"\u4E00\u6B21\u6700\u591A\u5206\u914D 100 \u500B\u5BA2\u6236"}),(!Number.isInteger(u)||u<=0)&&n.push({field:"assignee_user_id",message:"\u8ACB\u9078\u64C7\u8CA0\u8CAC\u4EBA\u54E1"}),n.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F38\u5165\u6709\u8AA4",errors:n,meta:{requestId:e}},r);try{if(!await t.DATABASE.prepare("SELECT 1 FROM Users WHERE user_id = ? AND is_deleted = 0 LIMIT 1").bind(u).first())return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8CA0\u8CAC\u4EBA\u4E0D\u5B58\u5728",errors:[{field:"assignee_user_id",message:"\u4E0D\u5B58\u5728"}],meta:{requestId:e}},r);let A=new Date().toISOString(),T=i.map(()=>"?").join(","),S=(await t.DATABASE.prepare(`UPDATE Clients SET assignee_user_id = ?, updated_at = ? WHERE client_id IN (${T}) AND is_deleted = 0`).bind(u,A,...i).run())?.meta?.changes||0;return a(200,{ok:!0,code:"SUCCESS",message:`\u5DF2\u66F4\u65B0 ${S} \u500B\u5BA2\u6236`,data:{updated_count:S},meta:{requestId:e}},r)}catch(E){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(E)}));let A={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(A.error=String(E)),a(500,A,r)}}let p=h.pathname.match(/^\/internal\/api\/v1\/clients\/([^\/]+)\/services$/);if(console.log("[CLIENTS.JS] \u6AA2\u67E5\u65B0\u589E\u670D\u52D9\u8DEF\u7531: matchAddService =",p,`method = ${s}`),s==="POST"&&p){console.log("[CLIENTS.JS] \u2705 \u5339\u914D\u65B0\u589E\u670D\u52D9\u8DEF\u7531");let c=p[1],n;try{n=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},r)}let i=[],u=Number(n?.service_id||0),E=String(n?.service_cycle||"monthly").trim(),A=String(n?.status||"active").trim(),T=n?.task_template_id?Number(n.task_template_id):null,R=n?.auto_generate_tasks!==!1,S=String(n?.start_date||"").trim(),N=String(n?.end_date||"").trim(),O=String(n?.service_notes||"").trim();if((!u||u<=0)&&i.push({field:"service_id",message:"\u8ACB\u9078\u64C7\u670D\u52D9\u9805\u76EE"}),["monthly","quarterly","yearly","one-time"].includes(E)||i.push({field:"service_cycle",message:"\u670D\u52D9\u9031\u671F\u683C\u5F0F\u932F\u8AA4"}),["active","suspended","expired","cancelled"].includes(A)||i.push({field:"status",message:"\u72C0\u614B\u683C\u5F0F\u932F\u8AA4"}),S&&!/^\d{4}-\d{2}-\d{2}$/.test(S)&&i.push({field:"start_date",message:"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD"}),N&&!/^\d{4}-\d{2}-\d{2}$/.test(N)&&i.push({field:"end_date",message:"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD"}),i.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F38\u5165\u6709\u8AA4",errors:i,meta:{requestId:e}},r);try{if(!await t.DATABASE.prepare("SELECT client_id FROM Clients WHERE client_id = ? AND is_deleted = 0").bind(c).first())return a(404,{ok:!1,code:"NOT_FOUND",message:"\u5BA2\u6236\u4E0D\u5B58\u5728",meta:{requestId:e}},r);if(!await t.DATABASE.prepare("SELECT service_id FROM Services WHERE service_id = ? AND is_active = 1").bind(u).first())return a(404,{ok:!1,code:"NOT_FOUND",message:"\u670D\u52D9\u4E0D\u5B58\u5728",meta:{requestId:e}},r);let I=(await t.DATABASE.prepare(`INSERT INTO ClientServices (client_id, service_id, status, service_cycle, 
				 task_template_id, auto_generate_tasks, start_date, end_date, service_notes)
				 VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`).bind(c,u,A,E,T,R?1:0,S||null,N||null,O).run())?.meta?.last_row_id;return a(201,{ok:!0,code:"CREATED",message:"\u670D\u52D9\u5DF2\u65B0\u589E",data:{client_service_id:I},meta:{requestId:e}},r)}catch(b){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(b)}));let y={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(y.error=String(b)),a(500,y,r)}}let m=h.pathname.match(/^\/internal\/api\/v1\/clients\/([^\/]+)\/services\/(\d+)$/);if(s==="PUT"&&m){let c=m[1],n=Number(m[2]),i;try{i=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},r)}let u=[],E=String(i?.service_cycle||"monthly").trim(),A=i?.task_template_id?Number(i.task_template_id):null,T=i?.auto_generate_tasks!==!1,R=String(i?.start_date||"").trim(),S=String(i?.end_date||"").trim(),N=String(i?.service_notes||"").trim(),O=String(i?.status||"active").trim();if(["monthly","quarterly","yearly","one-time"].includes(E)||u.push({field:"service_cycle",message:"\u670D\u52D9\u9031\u671F\u683C\u5F0F\u932F\u8AA4"}),["active","suspended","expired","cancelled"].includes(O)||u.push({field:"status",message:"\u72C0\u614B\u683C\u5F0F\u932F\u8AA4"}),u.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F38\u5165\u6709\u8AA4",errors:u,meta:{requestId:e}},r);try{return await t.DATABASE.prepare("SELECT client_service_id FROM ClientServices WHERE client_service_id = ? AND client_id = ? AND is_deleted = 0").bind(n,c).first()?(await t.DATABASE.prepare(`UPDATE ClientServices SET service_cycle = ?, task_template_id = ?, auto_generate_tasks = ?,
				 start_date = ?, end_date = ?, service_notes = ?, status = ?
				 WHERE client_service_id = ?`).bind(E,A,T?1:0,R||null,S||null,N,O,n).run(),a(200,{ok:!0,code:"SUCCESS",message:"\u670D\u52D9\u5DF2\u66F4\u65B0",data:{client_service_id:n},meta:{requestId:e}},r)):a(404,{ok:!1,code:"NOT_FOUND",message:"\u5BA2\u6236\u670D\u52D9\u4E0D\u5B58\u5728",meta:{requestId:e}},r)}catch(b){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(b)}));let y={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(y.error=String(b)),a(500,y,r)}}if(s==="DELETE"&&m){let c=m[1],n=Number(m[2]);try{return await t.DATABASE.prepare("SELECT client_service_id FROM ClientServices WHERE client_service_id = ? AND client_id = ? AND is_deleted = 0").bind(n,c).first()?(await t.DATABASE.prepare("UPDATE ClientServices SET is_deleted = 1 WHERE client_service_id = ?").bind(n).run(),a(200,{ok:!0,code:"SUCCESS",message:"\u670D\u52D9\u5DF2\u522A\u9664",meta:{requestId:e}},r)):a(404,{ok:!1,code:"NOT_FOUND",message:"\u5BA2\u6236\u670D\u52D9\u4E0D\u5B58\u5728",meta:{requestId:e}},r)}catch(i){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(i)}));let u={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(u.error=String(i)),a(500,u,r)}}return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},r)}w(de,"handleClients");async function le(d,t,f,e,h){let r=D(d,t),s=d.method.toUpperCase();if(s==="GET")try{let _=h.searchParams,o=Math.max(1,parseInt(_.get("page")||"1",10)),g=Math.min(100,Math.max(1,parseInt(_.get("perPage")||"20",10))),l=(o-1)*g,p=(_.get("q")||"").trim(),m=(_.get("status")||"").trim(),c=(_.get("due")||"").trim(),n=["t.is_deleted = 0"],i=[];f.is_admin||(n.push("t.assignee_user_id = ?"),i.push(String(f.user_id))),p&&(n.push("(t.task_name LIKE ? OR c.company_name LIKE ?)"),i.push(`%${p}%`,`%${p}%`)),m&&["pending","in_progress","completed","cancelled"].includes(m)&&(n.push("t.status = ?"),i.push(m)),c==="overdue"&&n.push("date(t.due_date) < date('now') AND t.status != 'completed'"),c==="soon"&&n.push("date(t.due_date) BETWEEN date('now') AND date('now','+3 days')");let u=n.length?`WHERE ${n.join(" AND ")}`:"",E=await t.DATABASE.prepare(`SELECT COUNT(1) as total
				 FROM ActiveTasks t
				 LEFT JOIN ClientServices cs ON cs.client_service_id = t.client_service_id
				 LEFT JOIN Clients c ON c.client_id = cs.client_id
				 ${u}`).bind(...i).first(),A=Number(E?.total||0),R=((await t.DATABASE.prepare(`SELECT t.task_id, t.task_name, t.due_date, t.status, t.assignee_user_id,
				        c.company_name AS client_name,
				        (SELECT COUNT(1) FROM ActiveTaskStages s WHERE s.task_id = t.task_id) AS total_stages,
				        (SELECT COUNT(1) FROM ActiveTaskStages s WHERE s.task_id = t.task_id AND s.status = 'completed') AS completed_stages,
				        (CASE WHEN t.related_sop_id IS NOT NULL OR t.client_specific_sop_id IS NOT NULL THEN 1 ELSE 0 END) AS has_sop,
				        u.name AS assignee_name
				 FROM ActiveTasks t
				 LEFT JOIN ClientServices cs ON cs.client_service_id = t.client_service_id
				 LEFT JOIN Clients c ON c.client_id = cs.client_id
				 LEFT JOIN Users u ON u.user_id = t.assignee_user_id
				 ${u}
				 ORDER BY date(t.due_date) ASC NULLS LAST, t.task_id DESC
				 LIMIT ? OFFSET ?`).bind(...i,g,l).all())?.results||[]).map(N=>({taskId:String(N.task_id),taskName:N.task_name,clientName:N.client_name||"",assigneeName:N.assignee_name||"",progress:{completed:Number(N.completed_stages||0),total:Number(N.total_stages||0)},dueDate:N.due_date||null,status:N.status,hasSop:Number(N.has_sop||0)===1})),S={requestId:e,page:o,perPage:g,total:A,hasNext:l+g<A};return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:R,meta:S},r)}catch(_){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(_)}));let o={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(o.error=String(_)),a(500,o,D(d,t))}if(s==="POST"){let _;try{_=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},r)}let o=Number(_?.client_service_id||0),g=String(_?.task_name||"").trim(),l=_?.due_date?String(_.due_date):null,p=_?.assignee_user_id?Number(_.assignee_user_id):null,m=Array.isArray(_?.stage_names)?_.stage_names.filter(n=>typeof n=="string"&&n.trim().length>0).map(n=>n.trim()):[],c=[];if((!Number.isInteger(o)||o<=0)&&c.push({field:"client_service_id",message:"\u5FC5\u586B"}),(g.length<1||g.length>200)&&c.push({field:"task_name",message:"\u9577\u5EA6\u9700 1\u2013200"}),l&&!/^\d{4}-\d{2}-\d{2}$/.test(l)&&c.push({field:"due_date",message:"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD"}),p!==null&&(!Number.isInteger(p)||p<=0)&&c.push({field:"assignee_user_id",message:"\u683C\u5F0F\u932F\u8AA4"}),c.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F38\u5165\u6709\u8AA4",errors:c,meta:{requestId:e}},r);try{if(!await t.DATABASE.prepare("SELECT client_service_id FROM ClientServices WHERE client_service_id = ? LIMIT 1").bind(o).first())return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u5BA2\u6236\u670D\u52D9\u4E0D\u5B58\u5728",errors:[{field:"client_service_id",message:"\u4E0D\u5B58\u5728"}],meta:{requestId:e}},r);if(p&&!await t.DATABASE.prepare("SELECT 1 FROM Users WHERE user_id = ? AND is_deleted = 0 LIMIT 1").bind(p).first())return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8CA0\u8CAC\u4EBA\u4E0D\u5B58\u5728",errors:[{field:"assignee_user_id",message:"\u4E0D\u5B58\u5728"}],meta:{requestId:e}},r);let i=new Date().toISOString();await t.DATABASE.prepare("INSERT INTO ActiveTasks (client_service_id, template_id, task_name, start_date, due_date, status, assignee_user_id, created_at) VALUES (?, NULL, ?, NULL, ?, 'pending', ?, ?)").bind(o,g,l,p,i).run();let u=await t.DATABASE.prepare("SELECT last_insert_rowid() AS id").first(),E=String(u?.id);if(m.length>0){let A=1;for(let T of m)await t.DATABASE.prepare("INSERT INTO ActiveTaskStages (task_id, stage_name, stage_order, status) VALUES (?, ?, ?, 'pending')").bind(E,T,A++).run()}return a(201,{ok:!0,code:"CREATED",message:"\u5DF2\u5EFA\u7ACB",data:{taskId:E,taskName:g,clientServiceId:o,dueDate:l,assigneeUserId:p},meta:{requestId:e}},r)}catch(n){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(n)}));let i={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(i.error=String(n)),a(500,i,r)}}return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},r)}w(le,"handleTasks");var Y={1:{name:"\u6B63\u5E38\u5DE5\u6642",multiplier:1,isOvertime:!1},2:{name:"\u5E73\u65E5\u52A0\u73ED\uFF08\u524D2\u5C0F\u6642\uFF09",multiplier:1.34,isOvertime:!0},3:{name:"\u5E73\u65E5\u52A0\u73ED\uFF08\u5F8C2\u5C0F\u6642\uFF09",multiplier:1.67,isOvertime:!0},4:{name:"\u4F11\u606F\u65E5\u52A0\u73ED\uFF08\u524D2\u5C0F\u6642\uFF09",multiplier:1.34,isOvertime:!0},5:{name:"\u4F11\u606F\u65E5\u52A0\u73ED\uFF08\u7B2C3-8\u5C0F\u6642\uFF09",multiplier:1.67,isOvertime:!0},6:{name:"\u4F11\u606F\u65E5\u52A0\u73ED\uFF08\u7B2C9-12\u5C0F\u6642\uFF09",multiplier:2.67,isOvertime:!0},7:{name:"\u570B\u5B9A\u5047\u65E5\u52A0\u73ED\uFF088\u5C0F\u6642\u5167\uFF09",multiplier:2,isOvertime:!0,maxHours:8,special:"fixed_8h"},8:{name:"\u570B\u5B9A\u5047\u65E5\u52A0\u73ED\uFF08\u7B2C9-10\u5C0F\u6642\uFF09",multiplier:1.34,isOvertime:!0},9:{name:"\u570B\u5B9A\u5047\u65E5\u52A0\u73ED\uFF08\u7B2C11-12\u5C0F\u6642\uFF09",multiplier:1.67,isOvertime:!0},10:{name:"\u4F8B\u5047\u65E5\u52A0\u73ED\uFF088\u5C0F\u6642\u5167\uFF09",multiplier:2,isOvertime:!0,maxHours:8,special:"fixed_8h"},11:{name:"\u4F8B\u5047\u65E5\u52A0\u73ED\uFF08\u7B2C9-12\u5C0F\u6642\uFF09",multiplier:2,isOvertime:!0}};function me(d,t){let f=Y[d];return f?f.special==="fixed_8h"?8:t*f.multiplier:t}w(me,"calculateWeightedHours");async function Me(d,t,f,e,h){let r=D(d,t);try{let s=h.searchParams,_=(s.get("start_date")||"").trim(),o=(s.get("end_date")||"").trim(),g=["t.is_deleted = 0"],l=[];f.is_admin||(g.push("t.user_id = ?"),l.push(String(f.user_id))),_&&(g.push("t.work_date >= ?"),l.push(_)),o&&(g.push("t.work_date <= ?"),l.push(o));let p=g.length?`WHERE ${g.join(" AND ")}`:"",c=((await t.DATABASE.prepare(`SELECT t.timesheet_id, t.user_id, t.work_date, t.client_id, t.service_id, t.service_item_id, t.service_name, t.work_type, t.hours, t.note,
		        u.name as user_name, u.username
		 FROM Timesheets t
		 LEFT JOIN Users u ON t.user_id = u.user_id
		 ${p}
		 ORDER BY t.work_date ASC, t.timesheet_id ASC`).bind(...l).all())?.results||[]).map(n=>({log_id:n.timesheet_id,timesheet_id:n.timesheet_id,user_id:n.user_id,user_name:n.user_name||n.username||"\u672A\u77E5",work_date:n.work_date,client_id:n.client_id||"",service_id:parseInt(n.service_id)||parseInt(n.service_name)||1,service_item_id:parseInt(n.service_item_id)||1,work_type_id:parseInt(n.work_type)||1,hours:Number(n.hours||0),notes:n.note||""}));return a(200,{ok:!0,code:"SUCCESS",message:"\u67E5\u8A62\u6210\u529F",data:c,meta:{requestId:e}},r)}catch(s){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(s)}));let _={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(_.error=String(s)),a(500,_,D(d,t))}}w(Me,"handleGetTimelogs");async function ve(d,t,f,e,h){let r=D(d,t),s;try{s=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},r)}let _=String(s?.work_date||"").trim(),o=String(s?.client_id||"").trim(),g=parseInt(s?.service_id)||0,l=parseInt(s?.service_item_id)||0,p=parseInt(s?.work_type_id)||0,m=Number(s?.hours),c=String(s?.notes||"").trim(),n=s?.timesheet_id?parseInt(s.timesheet_id):null,i=[];/^\d{4}-\d{2}-\d{2}$/.test(_)||i.push({field:"work_date",message:"\u65E5\u671F\u683C\u5F0F\u5FC5\u9808\u70BA YYYY-MM-DD"}),o||i.push({field:"client_id",message:"\u8ACB\u9078\u64C7\u5BA2\u6236"}),g||i.push({field:"service_id",message:"\u8ACB\u9078\u64C7\u670D\u52D9\u9805\u76EE"}),l||i.push({field:"service_item_id",message:"\u8ACB\u9078\u64C7\u670D\u52D9\u5B50\u9805\u76EE"}),(!p||!Y[p])&&i.push({field:"work_type_id",message:"\u8ACB\u9078\u64C7\u6709\u6548\u7684\u5DE5\u6642\u985E\u578B"}),(!Number.isFinite(m)||m<=0)&&i.push({field:"hours",message:"\u5DE5\u6642\u5FC5\u9808\u5927\u65BC 0"}),Math.abs(m*2-Math.round(m*2))>1e-9&&i.push({field:"hours",message:"\u5DE5\u6642\u5FC5\u9808\u662F 0.5 \u7684\u500D\u6578"});let u=Y[p];if(u&&u.maxHours&&m>u.maxHours&&i.push({field:"hours",message:`${u.name}\u6700\u591A\u53EA\u80FD\u586B ${u.maxHours} \u5C0F\u6642`}),m>12&&i.push({field:"hours",message:"\u5DE5\u6642\u4E0D\u53EF\u8D85\u904E 12 \u5C0F\u6642"}),i.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F38\u5165\u6709\u8AA4",errors:i,meta:{requestId:e}},r);try{let E=Y[p];if(!E)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u7121\u6548\u7684\u5DE5\u6642\u985E\u578B",errors:[{field:"work_type_id",message:"\u5DE5\u6642\u985E\u578B\u4E0D\u5B58\u5728"}],meta:{requestId:e}},r);let A=await t.DATABASE.prepare("SELECT is_national_holiday FROM Holidays WHERE holiday_date = ?").bind(_).first(),R=new Date(_+"T00:00:00").getDay(),S="workday";A?.is_national_holiday===1?S="national_holiday":R===0?S="weekly_restday":R===6&&(S="restday");let N={workday:[1,2,3],restday:[4,5,6],weekly_restday:[10,11],national_holiday:[7,8,9]},O={workday:"\u5DE5\u4F5C\u65E5",restday:"\u4F11\u606F\u65E5",weekly_restday:"\u4F8B\u5047\u65E5",national_holiday:"\u570B\u5B9A\u5047\u65E5"};if(!N[S].includes(p)){let M=O[S]||S;return a(422,{ok:!1,code:"VALIDATION_ERROR",message:`${_}\uFF08${M}\uFF09\u4E0D\u53EF\u4F7F\u7528\u300C${E.name}\u300D`,errors:[{field:"work_type_id",message:`\u8A72\u65E5\u671F\u985E\u578B\u70BA${M}\uFF0C\u8ACB\u9078\u64C7\u9069\u5408\u7684\u5DE5\u6642\u985E\u578B`}],meta:{requestId:e,work_date:_,dateType:S,workType:E.name}},r)}let b=me(p,m),y,B=!1;if(n)if(await t.DATABASE.prepare(`SELECT timesheet_id FROM Timesheets 
				 WHERE timesheet_id = ? AND user_id = ? AND is_deleted = 0`).bind(n,String(f.user_id)).first()){y=n,B=!0;let L=await t.DATABASE.prepare("SELECT hours, work_type FROM Timesheets WHERE timesheet_id = ?").bind(y).first(),k=Number(L?.hours||0),U=m-k;if(U>0){let C=await t.DATABASE.prepare(`SELECT COALESCE(SUM(hours), 0) AS s 
					 FROM Timesheets 
					 WHERE user_id = ? AND work_date = ? AND is_deleted = 0`).bind(String(f.user_id),_).first();if(Number(C?.s||0)+U>12+1e-9)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u4FEE\u6539\u5F8C\u6BCF\u65E5\u5DE5\u6642\u5408\u8A08\u4E0D\u53EF\u8D85\u904E 12 \u5C0F\u6642",errors:[{field:"hours",message:"\u8D85\u904E\u6BCF\u65E5\u4E0A\u9650"}],meta:{requestId:e}},r)}if(E.maxHours){let C=await t.DATABASE.prepare(`SELECT COALESCE(SUM(hours), 0) AS s 
					 FROM Timesheets 
					 WHERE user_id = ? AND work_date = ? AND work_type = ? AND is_deleted = 0`).bind(String(f.user_id),_,String(p)).first(),v=Number(C?.s||0),H=v-k+m;if(H>E.maxHours+1e-9)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:`\u4FEE\u6539\u5F8C\u300C${E.name}\u300D\u7576\u65E5\u7D2F\u8A08\u4E0D\u53EF\u8D85\u904E ${E.maxHours} \u5C0F\u6642`,errors:[{field:"hours",message:`\u7576\u65E5\u5DF2\u6709 ${v} \u5C0F\u6642\uFF0C\u4FEE\u6539\u5F8C\u5C07\u8B8A\u6210 ${H.toFixed(1)} \u5C0F\u6642\uFF08\u8D85\u904E\u4E0A\u9650\uFF09`}],meta:{requestId:e}},r)}await t.DATABASE.prepare(`UPDATE Timesheets 
				 SET client_id = ?, 
				     service_id = ?, 
				     service_item_id = ?, 
				     service_name = ?, 
				     work_type = ?, 
				     hours = ?, 
				     note = ?, 
				     updated_at = ?
				 WHERE timesheet_id = ?`).bind(o,g,l,String(g),String(p),m,c,new Date().toISOString(),y).run()}else y=null;if(!y){let M=await t.DATABASE.prepare(`SELECT timesheet_id 
				 FROM Timesheets 
				 WHERE user_id = ? 
				   AND work_date = ? 
				   AND client_id = ? 
				   AND service_id = ? 
				   AND service_item_id = ? 
				   AND work_type = ? 
				   AND is_deleted = 0`).bind(String(f.user_id),_,o,g,l,String(p)).first();if(M){y=M.timesheet_id,B=!0;let L=await t.DATABASE.prepare("SELECT hours FROM Timesheets WHERE timesheet_id = ?").bind(y).first(),k=Number(L?.hours||0),U=k+m;if(E.maxHours&&U>E.maxHours)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:`\u7D2F\u52A0\u5F8C\u300C${E.name}\u300D\u5DE5\u6642\u70BA ${U} \u5C0F\u6642\uFF0C\u8D85\u904E\u4E0A\u9650 ${E.maxHours} \u5C0F\u6642`,errors:[{field:"hours",message:`\u8A72\u65E5\u5DF2\u6709 ${k} \u5C0F\u6642\uFF0C\u6700\u591A\u9084\u53EF\u586B ${E.maxHours-k} \u5C0F\u6642`}]},r);let C=await t.DATABASE.prepare(`SELECT COALESCE(SUM(hours), 0) AS s 
				 FROM Timesheets 
				 WHERE user_id = ? AND work_date = ? AND is_deleted = 0 AND timesheet_id != ?`).bind(String(f.user_id),_,y).first(),v=Number(C?.s||0),H=v+U;if(H>12+1e-9)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:`\u7D2F\u52A0\u5F8C\u7576\u65E5\u7E3D\u5DE5\u6642\u70BA ${H.toFixed(1)} \u5C0F\u6642\uFF0C\u8D85\u904E\u4E0A\u9650 12 \u5C0F\u6642`,errors:[{field:"hours",message:`\u7576\u65E5\u5DF2\u6709 ${v.toFixed(1)} \u5C0F\u6642\uFF0C\u672C\u8A18\u9304\u5DF2\u6709 ${k} \u5C0F\u6642\uFF0C\u6700\u591A\u9084\u53EF\u7D2F\u52A0 ${Math.max(0,12-v-k).toFixed(1)} \u5C0F\u6642`}]},r);await t.DATABASE.prepare(`UPDATE Timesheets 
				 SET hours = hours + ?, updated_at = ?
				 WHERE timesheet_id = ?`).bind(m,new Date().toISOString(),y).run()}}if(!y){let M=await t.DATABASE.prepare(`SELECT COALESCE(SUM(hours), 0) AS s 
				 FROM Timesheets 
				 WHERE user_id = ? AND work_date = ? AND is_deleted = 0`).bind(String(f.user_id),_).first();if(Number(M?.s||0)+m>12+1e-9)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u6BCF\u65E5\u5DE5\u6642\u5408\u8A08\u4E0D\u53EF\u8D85\u904E 12 \u5C0F\u6642",errors:[{field:"hours",message:"\u8D85\u904E\u6BCF\u65E5\u4E0A\u9650"}],meta:{requestId:e}},r);if(E.maxHours){let U=await t.DATABASE.prepare(`SELECT COALESCE(SUM(hours), 0) AS s 
				 FROM Timesheets 
				 WHERE user_id = ? AND work_date = ? AND work_type = ? AND is_deleted = 0`).bind(String(f.user_id),_,String(p)).first(),C=Number(U?.s||0);if(C+m>E.maxHours+1e-9)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:`\u300C${E.name}\u300D\u7576\u65E5\u7D2F\u8A08\u4E0D\u53EF\u8D85\u904E ${E.maxHours} \u5C0F\u6642`,errors:[{field:"hours",message:`\u8A72\u65E5\u5DF2\u6709 ${C} \u5C0F\u6642\u300C${E.name}\u300D\uFF0C\u6700\u591A\u9084\u53EF\u586B ${Math.max(0,E.maxHours-C)} \u5C0F\u6642`}],meta:{requestId:e}},r)}await t.DATABASE.prepare(`INSERT INTO Timesheets (user_id, work_date, client_id, service_id, service_item_id, service_name, work_type, hours, note, created_at, updated_at)
				 VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`).bind(String(f.user_id),_,o,g,l,String(g),String(p),m,c,new Date().toISOString(),new Date().toISOString()).run(),y=(await t.DATABASE.prepare("SELECT last_insert_rowid() AS id").first())?.id}let I=E.isOvertime?E.special==="fixed_8h"?8:m:0;if(I>0){let M=_,L=new Date(_+"T00:00:00Z"),k=L.getUTCFullYear(),U=L.getUTCMonth(),C=new Date(Date.UTC(k,U+1,0)),v=`${C.getUTCFullYear()}-${String(C.getUTCMonth()+1).padStart(2,"0")}-${String(C.getUTCDate()).padStart(2,"0")}`;await t.DATABASE.prepare(`INSERT INTO CompensatoryLeaveGrants 
				 (user_id, source_timelog_id, hours_generated, hours_remaining, generated_date, expiry_date, original_rate, status)
				 VALUES (?, ?, ?, ?, ?, ?, ?, 'active')`).bind(String(f.user_id),y,I,I,M,v,E.multiplier).run()}return console.log("[TIMELOG] \u4FDD\u5B58\u6210\u529F:",{log_id:y,weighted_hours:b,comp_hours_generated:I}),a(200,{ok:!0,code:"SUCCESS",message:B?"\u5DF2\u66F4\u65B0":"\u5DF2\u5EFA\u7ACB",data:{log_id:y,weighted_hours:b,comp_hours_generated:I},meta:{requestId:e}},r)}catch(E){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(E),stack:E.stack}));let A={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(A.error=String(E)),a(500,A,r)}}w(ve,"handlePostTimelogs");async function Fe(d,t,f,e,h){let r=D(d,t),s;try{s=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},r)}let _=String(s?.start_date||"").trim(),o=String(s?.end_date||"").trim(),g=String(s?.client_id||"").trim(),l=parseInt(s?.service_id)||0,p=parseInt(s?.service_item_id)||0,m=String(s?.work_type_id||"").trim();if(!_||!o||!g||!l||!p||!m)return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u7F3A\u5C11\u5FC5\u8981\u53C3\u6578",meta:{requestId:e}},r);try{let n=(await t.DATABASE.prepare(`UPDATE Timesheets 
			 SET is_deleted = 1, updated_at = ?
			 WHERE user_id = ? 
			   AND work_date >= ? 
			   AND work_date <= ? 
			   AND client_id = ? 
			   AND service_id = ? 
			   AND service_item_id = ?
			   AND work_type = ?
			   AND is_deleted = 0`).bind(new Date().toISOString(),String(f.user_id),_,o,g,l,p,m).run()).changes||0;return a(200,{ok:!0,code:"SUCCESS",message:`\u5DF2\u522A\u9664 ${n} \u7B46\u8A18\u9304`,data:{deleted_count:n},meta:{requestId:e}},r)}catch(c){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(c)}));let n={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(n.error=String(c)),a(500,n,r)}}w(Fe,"handleDeleteTimelogsBatch");async function He(d,t,f,e,h){let r=D(d,t);try{let s=h.searchParams,_=(s.get("month")||"").trim();if(!_||!/^\d{4}-\d{2}$/.test(_))return a(400,{ok:!1,code:"INVALID_MONTH",message:"\u6708\u4EFD\u683C\u5F0F\u932F\u8AA4\uFF0C\u61C9\u70BA YYYY-MM",meta:{requestId:e}},r);let[o,g]=_.split("-"),l=`${o}-${g}-01`,m=`${parseInt(g)===12?`${parseInt(o)+1}-01`:`${o}-${String(parseInt(g)+1).padStart(2,"0")}`}-01`,c=f.user_id;f.is_admin&&s.get("user_id")&&(c=parseInt(s.get("user_id")));let n=await t.DATABASE.prepare(`SELECT work_type, hours
			 FROM Timesheets
			 WHERE user_id = ?
			   AND work_date >= ?
			   AND work_date < ?
			   AND is_deleted = 0`).bind(c,l,m).all(),i=0,u=0,E=0;n.results.forEach(R=>{let S=parseFloat(R.hours)||0,N=parseInt(R.work_type)||1,O=Y[N];O&&(i+=S,O.isOvertime&&(u+=S),E+=me(N,S))});let A=await t.DATABASE.prepare(`SELECT unit, amount
		 FROM LeaveRequests
		 WHERE user_id = ?
		   AND start_date >= ?
		   AND start_date < ?
		   AND status = 'approved'
		   AND is_deleted = 0`).bind(c,l,m).all(),T=0;return A.results&&A.results.forEach(R=>{let S=parseFloat(R.amount)||0;R.unit==="hour"?T+=S:R.unit==="day"&&(T+=S*8)}),a(200,{ok:!0,code:"SUCCESS",message:"\u67E5\u8A62\u6210\u529F",data:{month:_,total_hours:Math.round(i*10)/10,overtime_hours:Math.round(u*10)/10,weighted_hours:Math.round(E*10)/10,leave_hours:Math.round(T*10)/10},meta:{requestId:e}},r)}catch(s){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(s)}));let _={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(_.error=String(s)),a(500,_,r)}}w(He,"handleGetMonthlySummary");async function _e(d,t,f,e,h){let r=D(d,t),s=d.method.toUpperCase();return s==="GET"&&h.pathname.endsWith("/summary")?He(d,t,f,e,h):s==="GET"?Me(d,t,f,e,h):s==="POST"?ve(d,t,f,e,h):s==="DELETE"&&h.pathname.endsWith("/batch")?Fe(d,t,f,e,h):a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},r)}w(_e,"handleTimesheets");async function pe(d,t,f,e,h){let r=D(d,t),s=d.method.toUpperCase(),_=h.pathname;if(s==="GET"&&_==="/internal/api/v1/receipts/suggest-amount"){let o=parseInt(h.searchParams.get("client_service_id")||"0",10),g=parseInt(h.searchParams.get("billing_month")||"0",10);if(!o||g<1||g>12)return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8BF7\u63D0\u4F9B\u6709\u6548\u7684client_service_id\u548Cbilling_month\uFF081-12\uFF09",meta:{requestId:e}},r);try{let l=await t.DATABASE.prepare(`SELECT billing_amount, payment_due_days 
				 FROM ServiceBillingSchedule 
				 WHERE client_service_id = ? AND billing_month = ?`).bind(o,g).first();return l?a(200,{ok:!0,code:"OK",message:"\u6210\u529F\u83B7\u53D6\u5EFA\u8BAE\u91D1\u989D",data:{suggested_amount:Number(l.billing_amount||0),payment_due_days:Number(l.payment_due_days||30),has_schedule:!0},meta:{requestId:e}},r):a(200,{ok:!0,code:"OK",message:"\u8BE5\u6708\u4EFD\u672A\u8BBE\u5B9A\u6536\u8D39",data:{suggested_amount:0,payment_due_days:30,has_schedule:!1},meta:{requestId:e}},r)}catch(l){return console.error(JSON.stringify({level:"error",requestId:e,path:_,err:String(l)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u670D\u52A1\u5668\u9519\u8BEF",meta:{requestId:e}},r)}}if(s==="GET"&&_==="/internal/api/v1/receipts")try{let o=h.searchParams,g=Math.max(1,parseInt(o.get("page")||"1",10)),l=Math.min(100,Math.max(1,parseInt(o.get("perPage")||"20",10))),p=(g-1)*l,m=(o.get("q")||"").trim(),c=(o.get("status")||"").trim(),n=(o.get("receipt_type")||"").trim(),i=(o.get("dateFrom")||"").trim(),u=(o.get("dateTo")||"").trim(),E=["r.is_deleted = 0"],A=[];m&&(E.push("(r.receipt_id LIKE ? OR c.company_name LIKE ?)"),A.push(`%${m}%`,`%${m}%`)),c&&["unpaid","partial","paid","cancelled"].includes(c)&&(E.push("r.status = ?"),A.push(c)),n&&["normal","prepayment","deposit"].includes(n)&&(E.push("r.receipt_type = ?"),A.push(n)),i&&(E.push("r.receipt_date >= ?"),A.push(i)),u&&(E.push("r.receipt_date <= ?"),A.push(u));let T=E.length?`WHERE ${E.join(" AND ")}`:"",R=await t.DATABASE.prepare(`SELECT COUNT(1) AS total FROM Receipts r LEFT JOIN Clients c ON c.client_id = r.client_id ${T}`).bind(...A).first(),S=Number(R?.total||0),O=((await t.DATABASE.prepare(`SELECT r.receipt_id, r.client_id, c.company_name AS client_name, r.total_amount, 
				        r.receipt_date, r.due_date, r.status, r.receipt_type
				 FROM Receipts r LEFT JOIN Clients c ON c.client_id = r.client_id
				 ${T}
				 ORDER BY r.receipt_date DESC, r.receipt_id DESC
				 LIMIT ? OFFSET ?`).bind(...A,l,p).all())?.results||[]).map(y=>({receiptId:y.receipt_id,clientId:y.client_id,clientName:y.client_name||"",totalAmount:Number(y.total_amount||0),receiptDate:y.receipt_date,dueDate:y.due_date||null,status:y.status,receiptType:y.receipt_type||"normal"})),b={requestId:e,page:g,perPage:l,total:S,hasNext:p+l<S};return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:O,meta:b},r)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},D(d,t))}if(s==="POST"&&_==="/internal/api/v1/receipts"){let o;try{o=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},r)}let g=String(o?.client_id||"").trim(),l=String(o?.receipt_date||"").trim(),p=String(o?.due_date||"").trim(),m=Number(o?.total_amount),c=String(o?.status||"unpaid").trim(),n=(o?.notes||"").trim(),i=String(o?.receipt_type||"normal").trim(),u=o?.related_task_id?parseInt(o.related_task_id,10):null,E=o?.client_service_id?parseInt(o.client_service_id,10):null,A=o?.billing_month?parseInt(o.billing_month,10):null,T=[];if(g||T.push({field:"client_id",message:"\u5FC5\u586B"}),/^\d{4}-\d{2}-\d{2}$/.test(l)||T.push({field:"receipt_date",message:"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD"}),(!Number.isFinite(m)||m<=0)&&T.push({field:"total_amount",message:"\u5FC5\u9808\u5927\u65BC 0"}),c||(c="unpaid"),["unpaid","partial","paid","cancelled"].includes(c)||T.push({field:"status",message:"\u72C0\u614B\u4E0D\u5408\u6CD5"}),["normal","prepayment","deposit"].includes(i)||(i="normal"),A&&(A<1||A>12)&&T.push({field:"billing_month",message:"\u6708\u4EFD\u5FC5\u987B\u57281-12\u4E4B\u95F4"}),T.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F38\u5165\u6709\u8AA4",errors:T,meta:{requestId:e}},r);try{if(!await t.DATABASE.prepare("SELECT 1 FROM Clients WHERE client_id = ? AND is_deleted = 0 LIMIT 1").bind(g).first())return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u5BA2\u6236\u4E0D\u5B58\u5728",errors:[{field:"client_id",message:"\u4E0D\u5B58\u5728"}],meta:{requestId:e}},r);let[S,N]=l.split("-"),O=`${S}${N}`,b=await t.DATABASE.prepare("SELECT receipt_id FROM Receipts WHERE receipt_id LIKE ? ORDER BY receipt_id DESC LIMIT 1").bind(`${O}-%`).first(),y=1;if(b&&typeof b.receipt_id=="string"){let L=b.receipt_id.match(/^(\d{6})-(\d{3})$/);L&&(y=Math.max(y,parseInt(L[2],10)+1))}let B=`${O}-${String(y).padStart(3,"0")}`,I=p;if(!I){let L=30;if(E&&A){let H=await t.DATABASE.prepare("SELECT payment_due_days FROM ServiceBillingSchedule WHERE client_service_id = ? AND billing_month = ?").bind(E,A).first();H&&H.payment_due_days&&(L=Number(H.payment_due_days))}let k=new Date(l+"T00:00:00Z");k.setUTCDate(k.getUTCDate()+L);let U=k.getUTCFullYear(),C=String(k.getUTCMonth()+1).padStart(2,"0"),v=String(k.getUTCDate()).padStart(2,"0");I=`${U}-${C}-${v}`}return await t.DATABASE.prepare(`INSERT INTO Receipts (receipt_id, client_id, receipt_date, due_date, total_amount, status, 
				 receipt_type, related_task_id, client_service_id, billing_month, 
				 is_auto_generated, notes, created_by, created_at, updated_at) 
				 VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0, ?, ?, ?, ?)`).bind(B,g,l,I,m,c,i,u,E,A,n,String(f.user_id),new Date().toISOString(),new Date().toISOString()).run(),a(201,{ok:!0,code:"CREATED",message:"\u5DF2\u5EFA\u7ACB",data:{receiptId:B,clientId:g,totalAmount:m,receiptDate:l,dueDate:I,status:c,receiptType:i,relatedTaskId:u,clientServiceId:E,billingMonth:A},meta:{requestId:e}},r)}catch(R){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(R)}));let S={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(S.error=String(R)),a(500,S,r)}}return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},r)}w(pe,"handleReceipts");async function ue(d,t,f,e,h,r){let s=D(d,t);return a(501,{ok:!1,code:"NOT_IMPLEMENTED",message:"\u85AA\u8CC7\u529F\u80FD\u5C1A\u672A\u5BE6\u4F5C",meta:{requestId:e}},s)}w(ue,"handlePayroll");async function Ee(d,t,f,e,h,r){let s=D(d,t),_=d.method.toUpperCase();if(r==="/internal/api/v1/leaves/balances"){if(_!=="GET")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s);try{let o=h.searchParams,g=parseInt(o.get("year")||String(new Date().getFullYear()),10),p=((await t.DATABASE.prepare("SELECT leave_type, year, total, used, remain FROM LeaveBalances WHERE user_id = ? AND year = ?").bind(String(f.user_id),g).all())?.results||[]).map(n=>({type:n.leave_type,year:Number(n.year),total:Number(n.total),used:Number(n.used),remain:Number(n.remain)})),m=await t.DATABASE.prepare(`SELECT SUM(hours_remaining) as total FROM CompensatoryLeaveGrants 
				 WHERE user_id = ? AND status = 'active' AND hours_remaining > 0`).bind(String(f.user_id)).first(),c=Number(m?.total||0);return c>0&&p.push({type:"comp",year:g,total:c,used:0,remain:c}),a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:p,meta:{requestId:e,year:g}},s)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}if(r==="/internal/api/v1/leaves"){if(_==="GET")try{let o=h.searchParams,g=Math.max(1,parseInt(o.get("page")||"1",10)),l=Math.min(100,Math.max(1,parseInt(o.get("perPage")||"20",10))),p=(g-1)*l,m=(o.get("q")||"").trim(),c=(o.get("status")||"").trim(),n=(o.get("type")||"").trim(),i=(o.get("dateFrom")||"").trim(),u=(o.get("dateTo")||"").trim(),E=["l.is_deleted = 0"],A=[];f.is_admin||(E.push("l.user_id = ?"),A.push(String(f.user_id))),m&&(E.push("(l.reason LIKE ? OR l.leave_type LIKE ?)"),A.push(`%${m}%`,`%${m}%`)),c&&["pending","approved","rejected"].includes(c)&&(E.push("l.status = ?"),A.push(c)),n&&(E.push("l.leave_type = ?"),A.push(n)),i&&(E.push("l.start_date >= ?"),A.push(i)),u&&(E.push("l.end_date <= ?"),A.push(u));let T=E.length?`WHERE ${E.join(" AND ")}`:"",R=await t.DATABASE.prepare(`SELECT COUNT(1) AS total FROM LeaveRequests l ${T}`).bind(...A).first(),S=Number(R?.total||0),O=((await t.DATABASE.prepare(`SELECT l.leave_id, l.leave_type, l.start_date, l.end_date, l.unit, l.amount, l.reason, l.status, l.submitted_at
					 FROM LeaveRequests l
					 ${T}
					 ORDER BY l.submitted_at DESC, l.leave_id DESC
					 LIMIT ? OFFSET ?`).bind(...A,l,p).all())?.results||[]).map(y=>({leaveId:String(y.leave_id),type:y.leave_type,start:y.start_date,end:y.end_date,unit:y.unit,amount:Number(y.amount||0),reason:y.reason||"",status:y.status,submittedAt:y.submitted_at})),b={requestId:e,page:g,perPage:l,total:S,hasNext:p+l<S};return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:O,meta:b},s)}catch(o){console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(o)}));let g={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(g.error=String(o)),a(500,g,D(d,t))}if(_==="POST"){let o;try{o=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},s)}let g=String(o?.leave_type||"").trim(),l=String(o?.start_date||"").trim(),p=String(o?.end_date||"").trim(),m=String(o?.unit||"day").trim(),c=Number(o?.amount),n=(o?.reason||"").trim(),i=[];if(g||i.push({field:"leave_type",message:"\u5FC5\u9078\u5047\u5225"}),/^\d{4}-\d{2}-\d{2}$/.test(l)||i.push({field:"start_date",message:"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD"}),/^\d{4}-\d{2}-\d{2}$/.test(p)||i.push({field:"end_date",message:"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD"}),l&&p&&p<l&&i.push({field:"end_date",message:"\u7D50\u675F\u65E5\u671F\u4E0D\u53EF\u65E9\u65BC\u958B\u59CB\u65E5\u671F"}),["day","half","hour"].includes(m)||i.push({field:"unit",message:"\u55AE\u4F4D\u932F\u8AA4"}),(!Number.isFinite(c)||c<=0)&&i.push({field:"amount",message:"\u9700\u5927\u65BC 0"}),m==="hour"&&Math.abs(c*2-Math.round(c*2))>1e-9&&i.push({field:"amount",message:"\u8ACB\u5047\u5C0F\u6642\u6578\u5FC5\u9808\u662F 0.5 \u7684\u500D\u6578\uFF08\u4F8B\u5982\uFF1A0.5\u30011\u30011.5\u30012\uFF09"}),n.length>200&&i.push({field:"reason",message:"\u8ACB\u52FF\u8D85\u904E 200 \u5B57"}),["maternity","menstrual"].includes(g)&&f.gender==="M"&&i.push({field:"leave_type",message:"\u6B64\u5047\u5225\u50C5\u9650\u5973\u6027"}),g==="paternity"&&f.gender==="F"&&i.push({field:"leave_type",message:"\u6B64\u5047\u5225\u50C5\u9650\u7537\u6027"}),g==="comp"){let u=m==="hour"?c:(m==="half"?4:8)*c,A=((await t.DATABASE.prepare(`SELECT grant_id, hours_remaining FROM CompensatoryLeaveGrants 
					 WHERE user_id = ? AND status = 'active' AND hours_remaining > 0 
					 ORDER BY generated_date ASC`).bind(String(f.user_id)).all())?.results||[]).reduce((T,R)=>T+Number(R.hours_remaining||0),0);A<u&&i.push({field:"amount",message:`\u88DC\u4F11\u4E0D\u8DB3\uFF08\u5269\u9918 ${A} \u5C0F\u6642\uFF0C\u9700\u8981 ${u} \u5C0F\u6642\uFF09`})}if(i.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F38\u5165\u6709\u8AA4",errors:i,meta:{requestId:e}},s);try{await t.DATABASE.prepare("INSERT INTO LeaveRequests (user_id, leave_type, start_date, end_date, unit, amount, reason, status, submitted_at) VALUES (?, ?, ?, ?, ?, ?, ?, 'pending', datetime('now'))").bind(String(f.user_id),g,l,p,m,c,n).run();let u=await t.DATABASE.prepare("SELECT last_insert_rowid() AS id").first(),E=String(u?.id);if(g==="comp"){let A=m==="hour"?c:(m==="half"?4:8)*c,T=await t.DATABASE.prepare(`SELECT grant_id, hours_remaining FROM CompensatoryLeaveGrants 
						 WHERE user_id = ? AND status = 'active' AND hours_remaining > 0 
						 ORDER BY generated_date ASC`).bind(String(f.user_id)).all(),R=A;for(let S of T?.results||[]){if(R<=0)break;let N=Math.min(R,Number(S.hours_remaining||0)),O=Number(S.hours_remaining||0)-N,b=(await t.DATABASE.prepare("SELECT hours_used FROM CompensatoryLeaveGrants WHERE grant_id = ?").bind(S.grant_id).first())?.hours_used||0,y=O<=0?"fully_used":"active";await t.DATABASE.prepare(`UPDATE CompensatoryLeaveGrants 
							 SET hours_used = ?, hours_remaining = ?, status = ? 
							 WHERE grant_id = ?`).bind(Number(b)+N,O,y,S.grant_id).run(),R-=N}}return a(201,{ok:!0,code:"CREATED",message:"\u5DF2\u9001\u51FA\u5BE9\u6838",data:{leaveId:E},meta:{requestId:e}},s)}catch(u){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(u)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}}if(r==="/internal/api/v1/admin/cron/execute"&&_==="POST"){if(!f?.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u6C92\u6709\u6B0A\u9650",meta:{requestId:e}},s);let o;try{o=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},s)}let g=String(o?.job_name||"").trim();if(g!=="comp_leave_expiry")return a(400,{ok:!1,code:"INVALID_JOB",message:"\u4E0D\u652F\u63F4\u7684 Job \u540D\u7A31",meta:{requestId:e}},s);try{let l=new Date,p=new Date(Date.UTC(l.getUTCFullYear(),l.getUTCMonth()-1,1)),m=new Date(Date.UTC(p.getUTCFullYear(),p.getUTCMonth()+1,0)),c=`${m.getUTCFullYear()}-${String(m.getUTCMonth()+1).padStart(2,"0")}-${String(m.getUTCDate()).padStart(2,"0")}`,n=`${l.getUTCFullYear()}-${String(l.getUTCMonth()+1).padStart(2,"0")}`,i=await t.DATABASE.prepare(`SELECT g.grant_id, g.user_id, g.hours_remaining, g.original_rate, u.base_salary
				 FROM CompensatoryLeaveGrants g
				 LEFT JOIN Users u ON g.user_id = u.user_id
				 WHERE g.expiry_date = ? AND g.status = 'active' AND g.hours_remaining > 0`).bind(c).all(),u=0,E=[];for(let A of i?.results||[]){let R=Number(A.base_salary||0)/240,S=Number(A.hours_remaining||0),N=Number(A.original_rate||1),O=Math.round(S*R*N*100);await t.DATABASE.prepare(`INSERT INTO CompensatoryOvertimePay 
					 (user_id, year_month, hours_expired, amount_cents, source_grant_ids)
					 VALUES (?, ?, ?, ?, ?)`).bind(String(A.user_id),n,S,O,JSON.stringify([A.grant_id])).run(),await t.DATABASE.prepare("UPDATE CompensatoryLeaveGrants SET status = 'expired' WHERE grant_id = ?").bind(A.grant_id).run(),E.push(A.grant_id),u++}return await t.DATABASE.prepare(`INSERT INTO CronJobExecutions 
				 (job_name, status, executed_at, details)
				 VALUES (?, 'success', datetime('now'), ?)`).bind(g,JSON.stringify({expiryDate:c,processedCount:u,grantIds:E,currentMonth:n})).run(),a(200,{ok:!0,code:"SUCCESS",message:`\u5DF2\u8655\u7406 ${u} \u7B46\u5230\u671F\u88DC\u4F11`,data:{processedCount:u,expiryDate:c,currentMonth:n},meta:{requestId:e}},s)}catch(l){console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(l)}));try{await t.DATABASE.prepare(`INSERT INTO CronJobExecutions 
					 (job_name, status, executed_at, error_message)
					 VALUES (?, 'failed', datetime('now'), ?)`).bind(g,String(l)).run()}catch{}return a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}if(r==="/internal/api/v1/admin/cron/history"&&_==="GET"){if(!f?.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u6C92\u6709\u6B0A\u9650",meta:{requestId:e}},s);try{let o=h.searchParams,g=o.get("job_name")||"",l=Math.max(1,parseInt(o.get("page")||"1",10)),p=Math.min(100,Math.max(1,parseInt(o.get("perPage")||"20",10))),m=(l-1)*p,c=g?"WHERE job_name = ?":"",n=g?[g]:[],i=await t.DATABASE.prepare(`SELECT COUNT(1) AS total FROM CronJobExecutions ${c}`).bind(...n).first(),E=((await t.DATABASE.prepare(`SELECT execution_id, job_name, status, executed_at, details, error_message
				 FROM CronJobExecutions ${c}
				 ORDER BY executed_at DESC LIMIT ? OFFSET ?`).bind(...n,p,m).all())?.results||[]).map(A=>({id:A.execution_id,jobName:A.job_name,status:A.status,executedAt:A.executed_at,details:A.details?JSON.parse(A.details):null,errorMessage:A.error_message}));return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:E,meta:{requestId:e,page:l,perPage:p,total:Number(i?.total||0)}},s)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s)}w(Ee,"handleLeaves");async function ge(d,t,f,e){if(t.APP_ENV==="prod")return a(404,{ok:!1,code:"NOT_FOUND",message:"\u4E0D\u5B58\u5728",meta:{requestId:f}});let h=D(d,t);if(e==="/internal/api/v1/admin/dev-debug-cookie"){let r=String(t.SESSION_COOKIE_NAME||"session"),s=X(d,r),_=null,o=null;if(s&&t.DATABASE){let g=await t.DATABASE.prepare("SELECT id, expires_at FROM sessions WHERE id = ? LIMIT 1").bind(s).first();_=!!g,o=g?.expires_at||null}return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:{cookieName:r,sid:s,exists:_,exp:o},meta:{requestId:f}},h)}if(d.method.toUpperCase()!=="POST")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:f}},h);if(e==="/internal/api/v1/admin/dev-seed-user"){let r;try{r=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:f}},h)}let s=(r?.username||"").trim().toLowerCase(),_=(r?.name||"\u6E2C\u8A66\u7528\u6236").trim(),o=r?.password||"changeme",g=(r?.email||"").trim();if(!s||!o)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"username/password \u5FC5\u586B",meta:{requestId:f}},h);try{let l=await t.DATABASE.prepare("SELECT user_id FROM Users WHERE LOWER(username) = ? LIMIT 1").bind(s).first();g||(g=`${s}@example.com`);let p=await re(o);return l?await t.DATABASE.prepare("UPDATE Users SET username = ?, name = ?, email = ?, password_hash = ?, updated_at = ? WHERE user_id = ?").bind(s,_,g,p,new Date().toISOString(),l.user_id).run():await t.DATABASE.prepare("INSERT INTO Users (username, password_hash, name, email, gender, start_date, created_at, updated_at) VALUES (?, ?, ?, ?, 'M', date('now'), datetime('now'), datetime('now'))").bind(s,p,_,g).run(),a(200,{ok:!0,code:"OK",message:"\u5DF2\u5EFA\u7ACB/\u66F4\u65B0\u6E2C\u8A66\u7528\u6236",data:{username:s,email:g},meta:{requestId:f}},h)}catch(l){console.error(JSON.stringify({level:"error",requestId:f,path:e,err:String(l)}));let p={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:f}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(p.error=String(l)),a(500,p,h)}}if(e==="/internal/api/v1/admin/dev-seed-clients")try{await t.DATABASE.prepare("INSERT OR IGNORE INTO CustomerTags(tag_id, tag_name, tag_color) VALUES (1,'\u4E00\u822C','#3b5bdb'),(2,'VIP','#ef4444')").run();let r=new Date().toISOString();return await t.DATABASE.prepare("INSERT OR IGNORE INTO Clients(client_id, company_name, tax_registration_number, assignee_user_id, phone, email, created_at, updated_at) VALUES ('c_001','\u661F\u6CB3\u8CC7\u8A0A\u80A1\u4EFD\u6709\u9650\u516C\u53F8','12345678',1,'02-1234-5678','contact@galaxy.com',?,?),('c_002','\u677E\u67CF\u6709\u9650\u516C\u53F8','87654321',1,'02-8765-4321','service@pine.com',?,?),('c_003','\u5B89\u548C\u9867\u554F\u80A1\u4EFD\u6709\u9650\u516C\u53F8','11223344',1,'02-5566-7788','info@anhe.com',?,?)").bind(r,r,r,r,r,r).run(),await t.DATABASE.prepare("INSERT OR IGNORE INTO ClientTagAssignments(client_id, tag_id) VALUES ('c_001',1),('c_001',2),('c_002',2),('c_003',1)").run(),a(200,{ok:!0,code:"OK",message:"\u5DF2\u5EFA\u7ACB\u6E2C\u8A66\u5BA2\u6236/\u6A19\u7C64",meta:{requestId:f}},h)}catch(r){console.error(JSON.stringify({level:"error",requestId:f,path:e,err:String(r)}));let s={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:f}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(s.error=String(r)),a(500,s)}if(e==="/internal/api/v1/admin/dev-seed-tasks")try{await t.DATABASE.prepare("INSERT OR IGNORE INTO ClientServices(client_id, service_id, status) VALUES ('c_001',1,'active'),('c_002',1,'active'),('c_003',1,'active')").run();let r=await t.DATABASE.prepare("SELECT client_service_id FROM ClientServices WHERE client_id='c_001' LIMIT 1").first(),s=await t.DATABASE.prepare("SELECT client_service_id FROM ClientServices WHERE client_id='c_002' LIMIT 1").first(),_=await t.DATABASE.prepare("SELECT client_service_id FROM ClientServices WHERE client_id='c_003' LIMIT 1").first(),o=new Date,g=w(l=>new Date(o.getTime()+l*864e5).toISOString().slice(0,10),"fmt");return await t.DATABASE.prepare("INSERT INTO ActiveTasks (client_service_id, task_name, due_date, status, assignee_user_id, created_at) VALUES (?,?,?,?,?,datetime('now'))").bind(r.client_service_id,"\u661F\u6CB3\u8CC7\u8A0A \u2212 12 \u6708\u8A18\u5E33",g(2),"pending",1).run(),await t.DATABASE.prepare("INSERT INTO ActiveTasks (client_service_id, task_name, due_date, status, assignee_user_id, created_at) VALUES (?,?,?,?,?,datetime('now'))").bind(s.client_service_id,"\u677E\u67CF \u2212 12 \u6708\u71DF\u696D\u7A05",g(-1),"in_progress",1).run(),await t.DATABASE.prepare("INSERT INTO ActiveTasks (client_service_id, task_name, due_date, status, assignee_user_id, created_at) VALUES (?,?,?,?,?,datetime('now'))").bind(_.client_service_id,"\u5B89\u548C \u2212 \u5E74\u5EA6\u7D50\u7B97",g(10),"completed",1).run(),a(200,{ok:!0,code:"OK",message:"\u5DF2\u5EFA\u7ACB\u6E2C\u8A66\u4EFB\u52D9",meta:{requestId:f}})}catch(r){console.error(JSON.stringify({level:"error",requestId:f,path:e,err:String(r)}));let s={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:f}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(s.error=String(r)),a(500,s)}if(e==="/internal/api/v1/admin/dev-seed-timesheets")try{let r=new Date,s=w(_=>new Date(r.getTime()+_*864e5).toISOString().slice(0,10),"d");return await t.DATABASE.prepare("INSERT INTO Timesheets (user_id, work_date, client_id, service_name, work_type, hours, note) VALUES (1, ?, 'c_001', '\u8A18\u5E33', 'normal', 2.5, ''),(1, ?, 'c_002', '\u71DF\u696D\u7A05', 'ot-weekday', 1.0, '\u52A0\u73ED'),(1, ?, 'c_003', '\u7D50\u7B97', 'normal', 3.0, '\u6574\u7406')").bind(s(-2),s(-1),s(0)).run(),a(200,{ok:!0,code:"OK",message:"\u5DF2\u5EFA\u7ACB\u6E2C\u8A66\u5DE5\u6642",meta:{requestId:f}})}catch(r){return console.error(JSON.stringify({level:"error",requestId:f,path:e,err:String(r)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:f}})}if(e==="/internal/api/v1/admin/dev-seed-leaves")try{let r=new Date().getFullYear();return await t.DATABASE.prepare("INSERT OR REPLACE INTO LeaveBalances(user_id, leave_type, year, total, used, remain, updated_at) VALUES (1,'annual',?,30,3,27,datetime('now')),(1,'sick',?,30,1,29,datetime('now')),(1,'comp',?,24,16,8,datetime('now'))").bind(r,r,r).run(),await t.DATABASE.prepare("INSERT INTO LeaveRequests (user_id, leave_type, start_date, end_date, unit, amount, reason, status, submitted_at) VALUES (1,'annual',date('now','-10 day'),date('now','-10 day'),'day',1,'', 'approved', datetime('now','-10 day')),(1,'sick',date('now','-25 day'),date('now','-25 day'),'half',0.5,'\u770B\u91AB\u751F','approved', datetime('now','-25 day')),(1,'comp',date('now','-5 day'),date('now','-5 day'),'hour',2,'\u52A0\u73ED\u88DC\u4F11','pending', datetime('now','-5 day'))").run(),a(200,{ok:!0,code:"OK",message:"\u5DF2\u5EFA\u7ACB\u5047\u671F\u9918\u984D\u8207\u7533\u8ACB\u8CC7\u6599",meta:{requestId:f,year:r}})}catch(r){return console.error(JSON.stringify({level:"error",requestId:f,path:e,err:String(r)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:f}})}if(e==="/internal/api/v1/admin/dev-seed-receipts")try{return await t.DATABASE.prepare("INSERT OR IGNORE INTO Receipts (receipt_id, client_id, receipt_date, due_date, total_amount, status, is_auto_generated, created_by) VALUES ('202510-001','c_001','2025-10-01','2025-10-31',12000,'paid',1,1),('202510-002','c_002','2025-10-10','2025-10-30',8000,'unpaid',1,1),('202509-003','c_003','2025-09-20','2025-10-05',5000,'unpaid',1,1)").run(),a(200,{ok:!0,code:"OK",message:"\u5DF2\u5EFA\u7ACB\u6E2C\u8A66\u6536\u64DA",meta:{requestId:f}})}catch(r){return console.error(JSON.stringify({level:"error",requestId:f,path:e,err:String(r)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:f}})}return a(404,{ok:!1,code:"NOT_FOUND",message:"\u4E0D\u5B58\u5728",meta:{requestId:f}},h)}w(ge,"handleDevSeeding");async function Ae(d,t,f,e,h,r){let s=D(d,t),_=d.method.toUpperCase();if(r==="/internal/api/v1/admin/overhead-types"){if(_==="GET")try{let o=h.searchParams,g=Math.max(1,parseInt(o.get("page")||"1",10)),l=Math.min(100,Math.max(1,parseInt(o.get("perPage")||"50",10))),p=(g-1)*l,m=(o.get("q")||"").trim(),c=(o.get("category")||"").trim(),n=o.get("is_active"),i=[],u=[];m&&(i.push("(cost_code LIKE ? OR cost_name LIKE ?)"),u.push(`%${m}%`,`%${m}%`)),c&&["fixed","variable"].includes(c)&&(i.push("category = ?"),u.push(c)),(n==="0"||n==="1")&&(i.push("is_active = ?"),u.push(parseInt(n,10)));let E=i.length?`WHERE ${i.join(" AND ")}`:"",A=await t.DATABASE.prepare(`SELECT COUNT(1) AS total FROM OverheadCostTypes ${E}`).bind(...u).first(),T=Number(A?.total||0),S=((await t.DATABASE.prepare(`SELECT cost_type_id, cost_code, cost_name, category, allocation_method, description, is_active, display_order, created_at, updated_at
					 FROM OverheadCostTypes
					 ${E}
					 ORDER BY display_order ASC, cost_code ASC
					 LIMIT ? OFFSET ?`).bind(...u,l,p).all())?.results||[]).map(N=>({id:N.cost_type_id,code:N.cost_code,name:N.cost_name,category:N.category,allocationMethod:N.allocation_method,description:N.description||"",isActive:N.is_active===1,displayOrder:Number(N.display_order||0),createdAt:N.created_at,updatedAt:N.updated_at}));return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:S,meta:{requestId:e,page:g,perPage:l,total:T}},s)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}if(_==="POST"){let o;try{o=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},s)}let g=String(o?.cost_code||o?.code||"").trim(),l=String(o?.cost_name||o?.name||"").trim(),p=String(o?.category||"").trim(),m=String(o?.allocation_method||o?.allocationMethod||"").trim(),c=(o?.description||"").trim(),n=[];if(/^[A-Z0-9_]{1,20}$/.test(g)||n.push({field:"cost_code",message:"\u683C\u5F0F\u9700\u70BA A-Z0-9_\uFF0C\u226420"}),(!l||l.length>50)&&n.push({field:"cost_name",message:"\u5FC5\u586B\u4E14 \u2264 50"}),["fixed","variable"].includes(p)||n.push({field:"category",message:"\u4E0D\u5408\u6CD5"}),["per_employee","per_hour","per_revenue"].includes(m)||n.push({field:"allocation_method",message:"\u4E0D\u5408\u6CD5"}),n.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F38\u5165\u6709\u8AA4",errors:n,meta:{requestId:e}},s);try{await t.DATABASE.prepare("INSERT INTO OverheadCostTypes (cost_code, cost_name, category, allocation_method, description, is_active) VALUES (?, ?, ?, ?, ?, 1)").bind(g,l,p,m,c).run();let i=await t.DATABASE.prepare("SELECT cost_type_id FROM OverheadCostTypes WHERE cost_code = ?").bind(g).first();return a(201,{ok:!0,code:"CREATED",message:"\u5DF2\u5EFA\u7ACB",data:{id:i?.cost_type_id,code:g,name:l,category:p,allocationMethod:m},meta:{requestId:e}},s)}catch(i){let u=String(i||"");return u.includes("UNIQUE")&&u.includes("cost_code")?a(409,{ok:!1,code:"CONFLICT",message:"\u4EE3\u78BC\u5DF2\u5B58\u5728",meta:{requestId:e}},s):(console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(i)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s))}}}if(r==="/internal/api/v1/admin/overhead-costs"){if(_==="GET")try{let o=h.searchParams,g=parseInt(o.get("year")||"0",10),l=parseInt(o.get("month")||"0",10);if(!Number.isFinite(g)||g<2e3||l<1||l>12)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"year/month \u4E0D\u5408\u6CD5",meta:{requestId:e}},s);let p=(o.get("q")||"").trim(),m=["m.is_deleted = 0","m.year = ?","m.month = ?"],c=[g,l];p&&(m.push("(t.cost_code LIKE ? OR t.cost_name LIKE ? OR m.notes LIKE ?)"),c.push(`%${p}%`,`%${p}%`,`%${p}%`));let n=`WHERE ${m.join(" AND ")}`,u=((await t.DATABASE.prepare(`SELECT m.overhead_id, m.cost_type_id, t.cost_name, t.cost_code, t.category, t.allocation_method, m.amount, m.notes, m.recorded_by, m.recorded_at, m.updated_at
					 FROM MonthlyOverheadCosts m
					 JOIN OverheadCostTypes t ON t.cost_type_id = m.cost_type_id
					 ${n}
					 ORDER BY t.display_order ASC, t.cost_code ASC`).bind(...c).all())?.results||[]).map(R=>({id:R.overhead_id,costTypeId:R.cost_type_id,costName:R.cost_name,costCode:R.cost_code,category:R.category,allocationMethod:R.allocation_method,amount:Number(R.amount||0),notes:R.notes||"",recordedBy:R.recorded_by,recordedAt:R.recorded_at,updatedAt:R.updated_at})),E=u.reduce((R,S)=>R+S.amount,0),A=u.filter(R=>R.category==="fixed").reduce((R,S)=>R+S.amount,0),T=E-A;return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:{year:g,month:l,items:u,total:E,totalFixed:A,totalVariable:T},meta:{requestId:e,count:u.length}},s)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}if(_==="POST"){let o;try{o=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},s)}let g=parseInt(o?.cost_type_id,10),l=parseInt(o?.year,10),p=parseInt(o?.month,10),m=Number(o?.amount),c=(o?.notes||"").trim(),n=[];if(Number.isFinite(g)||n.push({field:"cost_type_id",message:"\u5FC5\u586B"}),(!Number.isFinite(l)||l<2e3)&&n.push({field:"year",message:"\u4E0D\u5408\u6CD5"}),(!Number.isFinite(p)||p<1||p>12)&&n.push({field:"month",message:"\u4E0D\u5408\u6CD5"}),(!Number.isFinite(m)||m<=0||m>1e9)&&n.push({field:"amount",message:"\u9700\u4ECB\u65BC 0 ~ 1e9"}),n.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F38\u5165\u6709\u8AA4",errors:n,meta:{requestId:e}},s);try{if(!await t.DATABASE.prepare("SELECT cost_type_id FROM OverheadCostTypes WHERE cost_type_id = ? AND is_active = 1 LIMIT 1").bind(g).first())return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u6210\u672C\u9805\u76EE\u4E0D\u5B58\u5728\u6216\u672A\u555F\u7528",errors:[{field:"cost_type_id",message:"\u4E0D\u5B58\u5728\u6216\u672A\u555F\u7528"}],meta:{requestId:e}},s);await t.DATABASE.prepare("INSERT INTO MonthlyOverheadCosts (cost_type_id, year, month, amount, notes, recorded_by) VALUES (?, ?, ?, ?, ?, ?)").bind(g,l,p,m,c,String(f.user_id)).run();let u=await t.DATABASE.prepare("SELECT last_insert_rowid() AS id").first();return a(201,{ok:!0,code:"CREATED",message:"\u5DF2\u5EFA\u7ACB",data:{id:String(u?.id)},meta:{requestId:e}},s)}catch(i){let u=String(i||"");return u.includes("UNIQUE")&&u.includes("MonthlyOverheadCosts")?a(409,{ok:!1,code:"CONFLICT",message:"\u8A72\u6708\u4EFD\u5DF2\u6709\u6B64\u9805\u76EE\u8A18\u9304",meta:{requestId:e}},s):(console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(i)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s))}}}if(r==="/internal/api/v1/admin/overhead-summary"||r==="/internal/api/v1/admin/overhead-analysis"){if(_!=="GET")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s);try{let o=h.searchParams,g=parseInt(o.get("year")||"0",10),l=parseInt(o.get("month")||"0",10);if(!Number.isFinite(g)||g<2e3||l<1||l>12)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"year/month \u4E0D\u5408\u6CD5",meta:{requestId:e}},s);let m=(await t.DATABASE.prepare(`SELECT t.category, t.cost_type_id, t.cost_name, SUM(m.amount) AS amt
				 FROM MonthlyOverheadCosts m JOIN OverheadCostTypes t ON t.cost_type_id = m.cost_type_id
				 WHERE m.is_deleted = 0 AND m.year = ? AND m.month = ?
				 GROUP BY t.category, t.cost_type_id, t.cost_name`).bind(g,l).all())?.results||[],c=m.reduce((R,S)=>R+Number(S.amt||0),0),n={fixed:0,variable:0};for(let R of m)n[R.category]=(n[R.category]||0)+Number(R.amt||0);let i=m.map(R=>({costTypeId:R.cost_type_id,costName:R.cost_name,amount:Number(R.amt||0),percentage:c?Number((Number(R.amt||0)/c*100).toFixed(1)):0})),u=await t.DATABASE.prepare("SELECT COUNT(1) AS c FROM Users WHERE is_deleted = 0").first(),E=Number(u?.c||0),A=E?Math.round(c/E):0;return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:{year:g,month:l,total_overhead:c,employee_count:E,overhead_per_employee:A,breakdown_by_category:n,breakdown_by_type:i},meta:{requestId:e}},s)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}return a(404,{ok:!1,code:"NOT_FOUND",message:"\u4E0D\u5B58\u5728",meta:{requestId:e}},s)}w(Ae,"handleOverhead");async function fe(d,t,f,e,h,r){let s=D(d,t),_=d.method.toUpperCase(),o=w(l=>{if(!l||typeof l!="string"||!l.match(/^\d{4}-\d{2}-\d{2}$/))return null;let m=new Date(l);return Number.isNaN(m.getTime())?null:l},"parseDate"),g=w(l=>{if(!l||typeof l!="string")return null;let p=l.match(/^(\d{4})-(\d{2})$/);if(!p)return null;let m=parseInt(p[1],10),c=parseInt(p[2],10);return!Number.isFinite(m)||!Number.isFinite(c)||c<1||c>12?null:{year:m,month:c}},"parseYearMonth");if(r==="/internal/api/v1/reports/client-cost-analysis"){if(_!=="GET")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s);if(!f.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u6C92\u6709\u6B0A\u9650",meta:{requestId:e}},s);try{let l=h.searchParams,p=o(l.get("start_date")),m=o(l.get("end_date")),c=(l.get("client_id")||"").trim()||null,n=(l.get("include_year_end_bonus")||"").toLowerCase()==="true";if(!p||!m||p>m)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8ACB\u9078\u64C7\u6709\u6548\u65E5\u671F\u5340\u9593",meta:{requestId:e}},s);let i=[p,m],u="t.is_deleted = 0 AND t.work_date >= ? AND t.work_date <= ?";c&&(u+=" AND t.client_id = ?",i.push(c));let E=await t.DATABASE.prepare(`SELECT t.client_id, SUM(t.hours) AS actual_hours
				 FROM Timesheets t
				 WHERE ${u}
				 GROUP BY t.client_id`).bind(...i).all(),A=new Map;for(let C of E?.results||[])C.client_id&&A.set(C.client_id,Number(C.actual_hours||0));let T=Array.from(A.keys()),R=[p,m],S="is_deleted = 0 AND status != 'cancelled' AND receipt_date >= ? AND receipt_date <= ?";c&&(S+=" AND client_id = ?",R.push(c));let N=await t.DATABASE.prepare(`SELECT client_id, SUM(total_amount) AS total_receipts
				 FROM Receipts
				 WHERE ${S}
				 GROUP BY client_id`).bind(...R).all(),O=new Map;for(let C of N?.results||[])O.set(C.client_id,Number(C.total_receipts||0)),A.has(C.client_id)||T.push(C.client_id);let b=parseInt(p.slice(0,4)+p.slice(5,7),10),y=parseInt(m.slice(0,4)+m.slice(5,7),10),I=((await t.DATABASE.prepare(`SELECT (year*100+month) AS ym, SUM(amount) AS amt
				 FROM MonthlyOverheadCosts
				 WHERE is_deleted = 0 AND (year*100+month) >= ? AND (year*100+month) <= ?
				 GROUP BY ym`).bind(b,y).all())?.results||[]).reduce((C,v)=>C+Number(v.amt||0),0),M=Array.from(A.values()).reduce((C,v)=>C+v,0),L=[];I<=0&&L.push({type:"overhead_missing",message:"\u672C\u671F\u9593\u7BA1\u7406\u6210\u672C\u672A\u8F38\u5165"});let k=new Map;if(T.length){let C=T.map(()=>"?").join(","),v=await t.DATABASE.prepare(`SELECT client_id, company_name FROM Clients WHERE client_id IN (${C})`).bind(...T).all();for(let H of v?.results||[])k.set(H.client_id,H.company_name)}let U=[];for(let C of T){let v=Number(A.get(C)||0),H=v,P=Number(O.get(C)||0),W=M>0?Math.round(I*(v/M)):0,x=0,G=0,V=x+W+G,$=P-V,z=P>0?Number(($/P*100).toFixed(1)):0;U.push({client_id:C,company_name:k.get(C)||C,total_actual_hours:Number(v.toFixed(2)),total_weighted_hours:Number(H.toFixed(2)),cost_breakdown:{salary_cost:x,overhead_cost:W,year_end_bonus:G,total_cost:V},labor_cost:V,revenue:P,gross_profit:$,profit_margin:z,cost_percentage:V>0?{salary:Number((x/V*100).toFixed(1)),overhead:Number((W/V*100).toFixed(1))}:{salary:0,overhead:0},user_breakdown:[]})}return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:U,warnings:L,meta:{requestId:e}},s)}catch(l){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(l)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}if(r==="/internal/api/v1/reports/employee-hours"){if(_!=="GET")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s);try{let l=h.searchParams,p=parseInt(l.get("year")||"0",10),m=parseInt(l.get("month")||"0",10),c=l.get("user_id");if(!Number.isFinite(p)||p<2e3||!Number.isFinite(m)||m<1||m>12)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8ACB\u9078\u64C7\u67E5\u8A62\u6708\u4EFD",meta:{requestId:e}},s);let n=null;f.is_admin?c&&(n=String(parseInt(c,10))):n=String(f.user_id);let i=`${p}-${String(m).padStart(2,"0")}`,E="t.is_deleted = 0 AND substr(t.work_date,1,7) = ?",A=[i];n&&(E+=" AND t.user_id = ?",A.push(n));let T=await t.DATABASE.prepare(`SELECT t.user_id, SUM(t.hours) AS total_hours,
					SUM(CASE WHEN t.work_type = 'normal' THEN t.hours ELSE 0 END) AS normal_hours,
					SUM(CASE WHEN t.work_type LIKE 'ot-%' THEN t.hours ELSE 0 END) AS overtime_hours
				 FROM Timesheets t
				 WHERE ${E}
				 GROUP BY t.user_id`).bind(...A).all(),R=await t.DATABASE.prepare(`SELECT t.user_id, t.work_date, SUM(t.hours) AS hours
				 FROM Timesheets t
				 WHERE ${E}
				 GROUP BY t.user_id, t.work_date
				 ORDER BY t.work_date ASC`).bind(...A).all(),S=await t.DATABASE.prepare(`SELECT t.user_id, t.client_id, SUM(t.hours) AS hours
				 FROM Timesheets t
				 WHERE ${E} AND t.client_id IS NOT NULL
				 GROUP BY t.user_id, t.client_id`).bind(...A).all(),N=(T?.results||[]).map(L=>L.user_id),O=new Map;if(N.length){let L=N.map(()=>"?").join(","),k=await t.DATABASE.prepare(`SELECT user_id, username FROM Users WHERE user_id IN (${L})`).bind(...N).all();O=new Map((k?.results||[]).map(U=>[String(U.user_id),U.username]))}let b=Array.from(new Set((S?.results||[]).map(L=>L.client_id).filter(Boolean))),y=new Map;if(b.length){let L=b.map(()=>"?").join(","),k=await t.DATABASE.prepare(`SELECT client_id, company_name FROM Clients WHERE client_id IN (${L})`).bind(...b).all();y=new Map((k?.results||[]).map(U=>[U.client_id,U.company_name]))}let B=new Map;for(let L of R?.results||[]){let k=B.get(String(L.user_id))||[];k.push({date:L.work_date,hours:Number(L.hours||0)}),B.set(String(L.user_id),k)}let I=new Map;for(let L of S?.results||[]){let k=I.get(String(L.user_id))||[],U=Number(L.hours||0);k.push({client_id:L.client_id,company_name:y.get(L.client_id)||L.client_id,hours:U}),I.set(String(L.user_id),k)}let M=[];for(let L of T?.results||[]){let k=String(L.user_id),U=Number(L.total_hours||0),C=Number(L.normal_hours||0),v=Number(L.overtime_hours||0),H=U,P=0,W=U>0?Number((H/U*100).toFixed(2)):0,x=I.get(k)||[],G=x.reduce(($,z)=>$+z.hours,0)||1;x=x.map($=>({client_id:$.client_id,company_name:$.company_name,hours:$.hours,percentage:Number(($.hours/G*100).toFixed(2))}));let V=B.get(k)||[];M.push({user_id:Number(k),username:O.get(k)||k,total_hours:Number(U.toFixed(2)),normal_hours:Number(C.toFixed(2)),overtime_hours:Number(v.toFixed(2)),billable_hours:Number(H.toFixed(2)),non_billable_hours:Number(P.toFixed(2)),utilization_rate:W,client_distribution:x,daily_hours:V})}return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:M,meta:{requestId:e,year:p,month:m}},s)}catch(l){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(l)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}if(r==="/internal/api/v1/reports/payroll-summary"){if(_!=="GET")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s);if(!f.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u6C92\u6709\u6B0A\u9650",meta:{requestId:e}},s);try{let l=h.searchParams,p=parseInt(l.get("year")||"0",10),m=parseInt(l.get("month")||"0",10),c=l.get("user_id");if(!Number.isFinite(p)||p<2e3||!Number.isFinite(m)||m<1||m>12)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8ACB\u9078\u64C7\u67E5\u8A62\u6708\u4EFD",meta:{requestId:e}},s);let n=`${p}-${String(m).padStart(2,"0")}`,i=await t.DATABASE.prepare("SELECT run_id FROM PayrollRuns WHERE month = ? LIMIT 1").bind(n).first();if(!i)return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:{summary:{total_base_salary:0,total_allowances:0,total_bonuses:0,total_overtime_pay:0,total_gross_salary:0,total_net_salary:0},by_employee:[]},meta:{requestId:e,month:n}},s);let u="SELECT mp.user_id, u.username, mp.base_salary_cents, mp.regular_allowance_cents, mp.bonus_cents, mp.overtime_cents, mp.total_cents, mp.is_full_attendance FROM MonthlyPayroll mp JOIN Users u ON u.user_id = mp.user_id WHERE mp.run_id = ?",E=[i.run_id];c&&(u+=" AND mp.user_id = ?",E.push(String(parseInt(c,10))));let T=(await t.DATABASE.prepare(u).bind(...E).all())?.results||[],R=w(y=>Number(y||0),"cents"),S=w(y=>Math.round(y/100),"toAmt"),N=T.map(y=>({user_id:y.user_id,username:y.username,base_salary:S(R(y.base_salary_cents)),total_allowances:S(R(y.regular_allowance_cents)),total_bonuses:S(R(y.bonus_cents)),overtime_pay:S(R(y.overtime_cents)),gross_salary:S(R(y.total_cents)),net_salary:S(R(y.total_cents)),has_full_attendance:y.is_full_attendance===1})),O=w(y=>N.reduce((B,I)=>B+Number(I[y]||0),0),"sum"),b={total_base_salary:O("base_salary"),total_allowances:O("total_allowances"),total_bonuses:O("total_bonuses"),total_overtime_pay:O("overtime_pay"),total_gross_salary:O("gross_salary"),total_net_salary:O("net_salary")};return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:{summary:b,by_employee:N},meta:{requestId:e,month:n}},s)}catch(l){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(l)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}if(r==="/internal/api/v1/reports/revenue"){if(_!=="GET")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s);if(!f.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u6C92\u6709\u6B0A\u9650",meta:{requestId:e}},s);try{let l=h.searchParams,p=o(l.get("start_date")),m=o(l.get("end_date"));if(!p||!m||p>m)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8ACB\u9078\u64C7\u6709\u6548\u65E5\u671F\u5340\u9593",meta:{requestId:e}},s);let n=((await t.DATABASE.prepare(`SELECT strftime('%Y-%m', receipt_date) AS ym,
					SUM(total_amount) AS receipts,
					SUM(CASE WHEN status = 'paid' THEN total_amount ELSE 0 END) AS paid
				 FROM Receipts
				 WHERE is_deleted = 0 AND status != 'cancelled' AND receipt_date >= ? AND receipt_date <= ?
				 GROUP BY ym
				 ORDER BY ym`).bind(p,m).all())?.results||[]).map(S=>({month:S.ym,receipts:Number(S.receipts||0),paid:Number(S.paid||0),outstanding:Math.max(0,Number(S.receipts||0)-Number(S.paid||0))})),i=n.reduce((S,N)=>S+N.receipts,0),u=n.reduce((S,N)=>S+N.paid,0),E=Math.max(0,i-u),A=i>0?Number((u/i*100).toFixed(1)):0,R=((await t.DATABASE.prepare(`SELECT r.client_id, c.company_name, SUM(r.total_amount) AS total_receipts,
					SUM(CASE WHEN r.status = 'paid' THEN r.total_amount ELSE 0 END) AS total_paid
				 FROM Receipts r LEFT JOIN Clients c ON c.client_id = r.client_id
				 WHERE r.is_deleted = 0 AND r.status != 'cancelled' AND r.receipt_date >= ? AND r.receipt_date <= ?
				 GROUP BY r.client_id, c.company_name`).bind(p,m).all())?.results||[]).map(S=>({client_id:S.client_id,company_name:S.company_name||S.client_id,total_receipts:Number(S.total_receipts||0),total_paid:Number(S.total_paid||0),total_outstanding:Math.max(0,Number(S.total_receipts||0)-Number(S.total_paid||0))}));return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:{summary:{total_receipts:i,total_paid:u,total_outstanding:E,collection_rate:A},monthly_trend:n,by_client:R},meta:{requestId:e}},s)}catch(l){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(l)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}return a(404,{ok:!1,code:"NOT_FOUND",message:"\u4E0D\u5B58\u5728",meta:{requestId:e}},s)}w(fe,"handleReports");function q(d){return btoa(String.fromCharCode(...d)).replaceAll("+","-").replaceAll("/","_").replaceAll("=","")}w(q,"b64urlEncode");async function Se(d,t){let f=await crypto.subtle.importKey("raw",d,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),e=await crypto.subtle.sign("HMAC",f,t);return new Uint8Array(e)}w(Se,"hmacSha256");function ee(d){return new TextEncoder().encode(d)}w(ee,"utf8");function Te(d){return String(d||"").replace(/[\\/]/g,"_").replace(/\.{2,}/g,".").slice(0,200)||"file"}w(Te,"sanitizeFilename");function Pe(d){let t=String(d||"").toLowerCase().match(/\.([a-z0-9]{1,10})$/);return t?t[1]:""}w(Pe,"extFromFilename");async function Re(d,t,f,e,h,r){let s=D(d,t),_=d.method.toUpperCase();if(r==="/internal/api/v1/attachments/upload-sign"){if(_!=="POST")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s);let o;try{o=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},s)}let g=String(o?.entity_type||"").trim(),l=String(o?.entity_id||"").trim(),p=String(o?.filename||"").trim(),m=String(o?.content_type||"").trim().toLowerCase(),c=Number(o?.content_length||0);if(!["client","receipt","sop","task"].includes(g))return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"entity_type \u4E0D\u5408\u6CD5",meta:{requestId:e}},s);if(!l)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"entity_id \u5FC5\u586B",meta:{requestId:e}},s);if(!p)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"filename \u5FC5\u586B",meta:{requestId:e}},s);if(!Number.isFinite(c)||c<=0)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"content_length \u4E0D\u5408\u6CD5",meta:{requestId:e}},s);if(c>10*1024*1024)return a(413,{ok:!1,code:"PAYLOAD_TOO_LARGE",message:"\u6A94\u6848\u5927\u5C0F\u8D85\u904E\u9650\u5236\uFF08\u6700\u5927 10MB\uFF09",meta:{requestId:e}},s);let n=["pdf","jpg","jpeg","png","xlsx","xls","docx","doc"],i=["application/pdf","image/jpeg","image/png","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/msword"],u=Te(p),E=Pe(u);if(!n.includes(E))return a(422,{ok:!1,code:"INVALID_EXTENSION",message:"\u4E0D\u652F\u63F4\u7684\u526F\u6A94\u540D",meta:{requestId:e}},s);if(!i.includes(m))return a(422,{ok:!1,code:"INVALID_FILE_TYPE",message:"\u4E0D\u652F\u63F4\u7684\u6A94\u6848\u578B\u5225",meta:{requestId:e}},s);let T={client:20,receipt:5,sop:10,task:10}[g]??20,R=await t.DATABASE.prepare("SELECT COUNT(1) AS c FROM Attachments WHERE is_deleted = 0 AND entity_type = ? AND entity_id = ?").bind(g,l).first();if(Number(R?.c||0)>=T)return a(409,{ok:!1,code:"TOO_MANY_FILES",message:`\u5DF2\u9054\u5230\u9644\u4EF6\u6578\u91CF\u4E0A\u9650\uFF08\u6700\u591A ${T} \u500B\uFF09`,meta:{requestId:e}},s);let S=String(t.APP_ENV||"dev"),N=Math.floor(Date.now()/1e3),O=crypto.getRandomValues(new Uint8Array(6)),b=q(O),B=`${`private/${S}/attachments/${g}_${l}`}/f_${N}_${b}.${E}`,I=N+300,M={objectKey:B,entityType:g,entityId:l,filename:u,contentType:m,contentLength:c,userId:String(f.user_id),exp:I},L=String(t.UPLOAD_SIGNING_SECRET||"change-me"),k=ee(JSON.stringify(M)),U=await Se(ee(L),k),C=`${q(k)}.${q(U)}`,H={uploadUrl:`${h.origin}/internal/api/v1/attachments/upload-direct?token=${C}`,objectKey:B,headers:{"Content-Type":m,"Content-Length":String(c)}};return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:H,meta:{requestId:e,expiresAt:I}},s)}if(r==="/internal/api/v1/attachments/upload-direct"){if(_!=="PUT")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s);try{let g=(h.searchParams.get("token")||"").split(".");if(g.length!==2)return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u7C3D\u540D\u7121\u6548",meta:{requestId:e}},s);let l=Uint8Array.from(atob(g[0].replaceAll("-","+").replaceAll("_","/")),R=>R.charCodeAt(0)),p=Uint8Array.from(atob(g[1].replaceAll("-","+").replaceAll("_","/")),R=>R.charCodeAt(0)),m=String(t.UPLOAD_SIGNING_SECRET||"change-me"),c=await Se(ee(m),l);if(c.length!==p.length)return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u7C3D\u540D\u7121\u6548",meta:{requestId:e}},s);let n=0;for(let R=0;R<c.length;R++)n|=c[R]^p[R];if(n!==0)return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u7C3D\u540D\u7121\u6548",meta:{requestId:e}},s);let i=JSON.parse(new TextDecoder().decode(l));if(!i||typeof i!="object")return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u7C3D\u540D\u7121\u6548",meta:{requestId:e}},s);if(i.exp<Math.floor(Date.now()/1e3))return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u7C3D\u540D\u5DF2\u904E\u671F",meta:{requestId:e}},s);if(String(i.userId)!==String(f.user_id))return a(403,{ok:!1,code:"FORBIDDEN",message:"\u4E0D\u5141\u8A31\u7684\u4F7F\u7528\u8005",meta:{requestId:e}},s);let u=(d.headers.get("Content-Type")||"").toLowerCase(),E=parseInt(d.headers.get("Content-Length")||"0",10);if(u!==String(i.contentType).toLowerCase())return a(415,{ok:!1,code:"INVALID_FILE_TYPE",message:"Content-Type \u4E0D\u5339\u914D",meta:{requestId:e}},s);if(!Number.isFinite(E)||E!==Number(i.contentLength))return a(400,{ok:!1,code:"VALIDATION_ERROR",message:"Content-Length \u4E0D\u5339\u914D",meta:{requestId:e}},s);if(!t.R2_BUCKET_ATTACHMENTS)return a(500,{ok:!1,code:"INTERNAL_ERROR",message:"R2 \u672A\u7D81\u5B9A",meta:{requestId:e}},s);let A=`attachment; filename="${Te(i.filename)}"`;await t.R2_BUCKET_ATTACHMENTS.put(i.objectKey,d.body,{httpMetadata:{contentType:i.contentType,contentDisposition:A},customMetadata:{ownerId:String(f.user_id),module:"attachments",entityId:`${i.entityType}:${i.entityId}`}}),await t.DATABASE.prepare("INSERT INTO Attachments (entity_type, entity_id, object_key, filename, content_type, size_bytes, uploader_user_id, uploaded_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)").bind(i.entityType,i.entityId,i.objectKey,i.filename,i.contentType,String(i.contentLength),String(f.user_id),new Date().toISOString()).run();let T=await t.DATABASE.prepare("SELECT last_insert_rowid() AS id").first();return a(201,{ok:!0,code:"CREATED",message:"\u5DF2\u4E0A\u50B3",data:{attachment_id:T?.id,object_key:i.objectKey},meta:{requestId:e}},s)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}if(_==="GET")try{let o=h.searchParams,g=(o.get("entity_type")||"").trim(),l=(o.get("entity_id")||"").trim();if(!g||!l)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"entity_type \u8207 entity_id \u5FC5\u586B",meta:{requestId:e}},s);if(!["client","receipt","sop","task"].includes(g))return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"entity_type \u4E0D\u5408\u6CD5",meta:{requestId:e}},s);let p=Math.max(1,parseInt(o.get("page")||"1",10)),m=Math.min(100,Math.max(1,parseInt(o.get("perPage")||"20",10))),c=(p-1)*m,n=(o.get("q")||"").trim(),i=(o.get("file_type")||"all").trim(),u=(o.get("dateFrom")||"").trim(),E=(o.get("dateTo")||"").trim(),A=["is_deleted = 0","entity_type = ?","entity_id = ?"],T=[g,l];n&&(A.push("(filename LIKE ?)"),T.push(`%${n}%`)),/^\d{4}-\d{2}-\d{2}$/.test(u)&&(A.push("uploaded_at >= ?"),T.push(`${u}T00:00:00.000Z`)),/^\d{4}-\d{2}-\d{2}$/.test(E)&&(A.push("uploaded_at <= ?"),T.push(`${E}T23:59:59.999Z`)),i!=="all"&&(i==="pdf"?A.push("(LOWER(filename) LIKE '%.pdf' OR LOWER(content_type) = 'application/pdf')"):i==="image"?A.push("(LOWER(content_type) LIKE 'image/%' OR LOWER(filename) GLOB '*.jpg' OR LOWER(filename) GLOB '*.jpeg' OR LOWER(filename) GLOB '*.png')"):i==="excel"?A.push("(LOWER(filename) GLOB '*.xls' OR LOWER(filename) GLOB '*.xlsx' OR LOWER(content_type) IN ('application/vnd.ms-excel','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'))"):i==="word"&&A.push("(LOWER(filename) GLOB '*.doc' OR LOWER(filename) GLOB '*.docx' OR LOWER(content_type) IN ('application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document'))"));let R=`WHERE ${A.join(" AND ")}`,S=await t.DATABASE.prepare(`SELECT COUNT(1) AS total FROM Attachments ${R}`).bind(...T).first(),N=Number(S?.total||0),b=((await t.DATABASE.prepare(`SELECT a.attachment_id, a.filename, a.content_type, a.size_bytes, a.uploader_user_id, a.uploaded_at, u.username AS uploader_name
				 FROM Attachments a LEFT JOIN Users u ON u.user_id = a.uploader_user_id
				 ${R}
				 ORDER BY a.uploaded_at DESC
				 LIMIT ? OFFSET ?`).bind(...T,m,c).all())?.results||[]).map(y=>({id:y.attachment_id,filename:y.filename,contentType:y.content_type,sizeBytes:Number(y.size_bytes||0),uploaderUserId:y.uploader_user_id,uploaderName:y.uploader_name||String(y.uploader_user_id||""),uploadedAt:y.uploaded_at}));return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:b,meta:{requestId:e,page:p,perPage:m,total:N}},s)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:"/internal/api/v1/attachments",err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s)}w(Re,"handleAttachments");async function he(d,t,f,e,h,r){let s=D(d,t),_=d.method.toUpperCase();if(r==="/internal/api/v1/sop"){if(_!=="GET")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s);try{let o=h.searchParams,g=Math.max(1,parseInt(o.get("page")||"1",10)),l=Math.min(100,Math.max(1,parseInt(o.get("perPage")||"12",10))),p=(g-1)*l,m=(o.get("q")||"").trim(),c=(o.get("category")||"").trim(),n=(o.get("tags")||"").trim(),i=(o.get("published")||"all").trim().toLowerCase(),u=["is_deleted = 0"],E=[];if(m&&(u.push("(title LIKE ? OR tags LIKE ?)"),E.push(`%${m}%`,`%${m}%`)),c&&c!=="all"&&(u.push("category = ?"),E.push(c)),i!=="all"&&(["1","true","published"].includes(i)?u.push("is_published = 1"):["0","false","draft"].includes(i)&&u.push("is_published = 0")),n){let O=n.split(",").map(b=>b.trim()).filter(Boolean);for(let b of O)u.push("(tags LIKE ?)"),E.push(`%${b}%`)}let A=u.length?`WHERE ${u.join(" AND ")}`:"",T=await t.DATABASE.prepare(`SELECT COUNT(1) AS total FROM SOPDocuments ${A}`).bind(...E).first(),R=Number(T?.total||0),N=((await t.DATABASE.prepare(`SELECT sop_id, title, category, tags, version, is_published, created_by, created_at, updated_at
				 FROM SOPDocuments
				 ${A}
				 ORDER BY updated_at DESC, sop_id DESC
				 LIMIT ? OFFSET ?`).bind(...E,l,p).all())?.results||[]).map(O=>({id:O.sop_id,title:O.title,category:O.category||"",tags:(()=>{try{return JSON.parse(O.tags||"[]")}catch{return[]}})(),version:Number(O.version||1),isPublished:O.is_published===1,createdBy:O.created_by,createdAt:O.created_at,updatedAt:O.updated_at}));return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:N,meta:{requestId:e,page:g,perPage:l,total:R}},s)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}return a(404,{ok:!1,code:"NOT_FOUND",message:"\u4E0D\u5B58\u5728",meta:{requestId:e}},s)}w(he,"handleSOP");function K(d){let t=parseInt(String(d||""),10);return Number.isFinite(t)&&t>0?t:null}w(K,"parseId");function Ne(){let d=new Date,t=d.getUTCFullYear(),f=String(d.getUTCMonth()+1).padStart(2,"0"),e=String(d.getUTCDate()).padStart(2,"0");return`${t}-${f}-${e}`}w(Ne,"todayStr");function We(d){return/^\d{4}-\d{2}-\d{2}$/.test(String(d||""))}w(We,"isValidYmd");async function Oe(d,t,f,e,h,r){let s=D(d,t),_=d.method.toUpperCase();if(r==="/internal/api/v1/client-services"&&_==="GET")try{let m=h.searchParams,c=(m.get("status")||"all").trim(),n=(m.get("q")||"").trim(),i=Math.max(1,parseInt(m.get("page")||"1",10)),u=Math.min(100,Math.max(1,parseInt(m.get("perPage")||"12",10))),E=(i-1)*u,A=["cs.is_deleted = 0"],T=[];["active","suspended","expired","cancelled"].includes(c)&&(A.push("cs.status = ?"),T.push(c)),n&&(A.push("(c.company_name LIKE ?)"),T.push(`%${n}%`));let R=A.length?`WHERE ${A.join(" AND ")}`:"",S=await t.DATABASE.prepare(`SELECT COUNT(1) AS total FROM ClientServices cs LEFT JOIN Clients c ON c.client_id = cs.client_id ${R}`).bind(...T).first(),O=((await t.DATABASE.prepare(`SELECT cs.client_service_id, cs.client_id, cs.status, cs.suspension_effective_date, c.company_name
         FROM ClientServices cs LEFT JOIN Clients c ON c.client_id = cs.client_id
         ${R}
         ORDER BY cs.client_service_id DESC
         LIMIT ? OFFSET ?`).bind(...T,u,E).all())?.results||[]).map(b=>({id:b.client_service_id,clientId:b.client_id,clientName:b.company_name||b.client_id,status:b.status,suspensionEffectiveDate:b.suspension_effective_date||null}));return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:O,meta:{requestId:e,page:i,perPage:u,total:Number(S?.total||0)}},s)}catch(m){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(m)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}let o=r.match(/^\/internal\/api\/v1\/client-services\/(\d+)\/suspend$/),g=r.match(/^\/internal\/api\/v1\/client-services\/(\d+)\/resume$/),l=r.match(/^\/internal\/api\/v1\/client-services\/(\d+)\/cancel$/),p=r.match(/^\/internal\/api\/v1\/client-services\/(\d+)\/history$/);if(o){if(_!=="POST")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s);let m;try{m=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},s)}let c=K(o[1]),n=String(m?.reason||"").trim(),i=String(m?.notes||"").trim(),u=String(m?.effective_date||"").trim();if(!c)return a(404,{ok:!1,code:"NOT_FOUND",message:"\u670D\u52D9\u4E0D\u5B58\u5728",meta:{requestId:e}},s);if(!We(u))return a(400,{ok:!1,code:"VALIDATION_ERROR",message:"\u65E5\u671F\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},s);if(!n)return a(400,{ok:!1,code:"VALIDATION_ERROR",message:"\u539F\u56E0\u5FC5\u586B",meta:{requestId:e}},s);try{let E=await t.DATABASE.prepare("SELECT client_service_id, status, suspension_effective_date FROM ClientServices WHERE client_service_id = ? AND is_deleted = 0").bind(c).first();if(!E)return a(404,{ok:!1,code:"NOT_FOUND",message:"\u670D\u52D9\u4E0D\u5B58\u5728",meta:{requestId:e}},s);if(E.status!=="active")return a(400,{ok:!1,code:"INVALID_STATE",message:"\u76EE\u524D\u72C0\u614B\u4E0D\u5141\u8A31\u6B64\u64CD\u4F5C",meta:{requestId:e}},s);if(E.suspension_effective_date&&E.suspension_effective_date>Ne())return a(400,{ok:!1,code:"ALREADY_SCHEDULED",message:"\u5DF2\u6709\u672A\u4F86\u6392\u7A0B\uFF0C\u4E0D\u53EF\u91CD\u8907\u6392\u7A0B",meta:{requestId:e}},s);let A=new Date().toISOString();return u<=Ne()?(await t.DATABASE.prepare("UPDATE ClientServices SET status='suspended', suspended_at = ?, suspension_reason = ?, suspension_effective_date = NULL WHERE client_service_id = ?").bind(A,n,c).run(),await t.DATABASE.prepare("INSERT INTO ServiceChangeHistory (client_service_id, old_status, new_status, changed_by, reason, notes) VALUES (?, 'active', 'suspended', ?, ?, ?)").bind(c,String(f.user_id),n,i).run(),a(200,{ok:!0,code:"OK",message:"\u670D\u52D9\u5DF2\u66AB\u505C",data:{client_service_id:c,status:"suspended",suspended_at:A}},s)):(await t.DATABASE.prepare("UPDATE ClientServices SET suspension_effective_date = ?, suspension_reason = ? WHERE client_service_id = ?").bind(u,n,c).run(),a(200,{ok:!0,code:"OK",message:`\u5DF2\u6392\u7A0B\u65BC ${u} \u66AB\u505C`,data:{client_service_id:c,status:"active",suspension_effective_date:u}},s))}catch(E){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(E)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}if(g){if(_!=="POST")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s);let m;try{m=await d.json()}catch{m={}}let c=K(g[1]),n=String(m?.notes||"").trim();if(!c)return a(404,{ok:!1,code:"NOT_FOUND",message:"\u670D\u52D9\u4E0D\u5B58\u5728",meta:{requestId:e}},s);try{let i=await t.DATABASE.prepare("SELECT client_service_id, status FROM ClientServices WHERE client_service_id = ? AND is_deleted = 0").bind(c).first();if(!i)return a(404,{ok:!1,code:"NOT_FOUND",message:"\u670D\u52D9\u4E0D\u5B58\u5728",meta:{requestId:e}},s);if(i.status!=="suspended")return a(400,{ok:!1,code:"INVALID_STATE",message:"\u76EE\u524D\u72C0\u614B\u4E0D\u5141\u8A31\u6B64\u64CD\u4F5C",meta:{requestId:e}},s);let u=new Date().toISOString();return await t.DATABASE.prepare("UPDATE ClientServices SET status='active', resumed_at = ?, suspended_at = NULL, suspension_reason = NULL, suspension_effective_date = NULL WHERE client_service_id = ?").bind(u,c).run(),await t.DATABASE.prepare("INSERT INTO ServiceChangeHistory (client_service_id, old_status, new_status, changed_by, reason, notes) VALUES (?, 'suspended', 'active', ?, '', ?)").bind(c,String(f.user_id),n).run(),a(200,{ok:!0,code:"OK",message:"\u670D\u52D9\u5DF2\u6062\u5FA9",data:{client_service_id:c,status:"active",resumed_at:u}},s)}catch(i){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(i)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}if(l){if(_!=="POST")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s);if(!f.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u6C92\u6709\u6B0A\u9650",meta:{requestId:e}},s);let m;try{m=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},s)}let c=K(l[1]),n=String(m?.reason||"").trim(),i=!!m?.cancel_pending_tasks;if(!c)return a(404,{ok:!1,code:"NOT_FOUND",message:"\u670D\u52D9\u4E0D\u5B58\u5728",meta:{requestId:e}},s);if(!n)return a(400,{ok:!1,code:"VALIDATION_ERROR",message:"\u53D6\u6D88\u539F\u56E0\u5FC5\u586B",meta:{requestId:e}},s);try{let u=await t.DATABASE.prepare("SELECT client_service_id, status FROM ClientServices WHERE client_service_id = ? AND is_deleted = 0").bind(c).first();if(!u)return a(404,{ok:!1,code:"NOT_FOUND",message:"\u670D\u52D9\u4E0D\u5B58\u5728",meta:{requestId:e}},s);if(u.status==="cancelled")return a(400,{ok:!1,code:"INVALID_STATE",message:"\u5DF2\u70BA\u53D6\u6D88\u72C0\u614B",meta:{requestId:e}},s);let E=new Date().toISOString();await t.DATABASE.prepare("UPDATE ClientServices SET status='cancelled', cancelled_at = ?, cancelled_by = ? WHERE client_service_id = ?").bind(E,String(f.user_id),c).run(),await t.DATABASE.prepare("INSERT INTO ServiceChangeHistory (client_service_id, old_status, new_status, changed_by, reason, notes) VALUES (?, ?, 'cancelled', ?, ?, '')").bind(c,u.status,String(f.user_id),n).run();let A=!1;return i&&(await t.DATABASE.prepare("UPDATE ActiveTasks SET status='cancelled' WHERE client_service_id = ? AND status NOT IN ('completed','cancelled')").bind(c).run(),A=!0),a(200,{ok:!0,code:"OK",message:"\u670D\u52D9\u5DF2\u53D6\u6D88",data:{client_service_id:c,status:"cancelled",tasks_cancelled:A}},s)}catch(u){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(u)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}if(p){if(_!=="GET")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s);let m=K(p[1]);if(!m)return a(404,{ok:!1,code:"NOT_FOUND",message:"\u670D\u52D9\u4E0D\u5B58\u5728",meta:{requestId:e}},s);try{let n=((await t.DATABASE.prepare(`SELECT h.change_id, h.old_status, h.new_status, h.changed_by, u.name AS changed_by_name, h.changed_at, h.reason, h.notes
         FROM ServiceChangeHistory h LEFT JOIN Users u ON u.user_id = h.changed_by
         WHERE h.client_service_id = ?
         ORDER BY h.changed_at DESC, h.change_id DESC`).bind(m).all())?.results||[]).map(i=>({change_id:i.change_id,old_status:i.old_status,new_status:i.new_status,changed_by:i.changed_by_name||String(i.changed_by),changed_at:i.changed_at,reason:i.reason||"",notes:i.notes||""}));return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:n,meta:{requestId:e,count:n.length}},s)}catch(c){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(c)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}return a(404,{ok:!1,code:"NOT_FOUND",message:"\u4E0D\u5B58\u5728",meta:{requestId:e}},s)}w(Oe,"handleClientServices");async function ye(d,t,f,e,h,r){let s=D(d,t),_=d.method.toUpperCase();if(!f?.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u6C92\u6709\u6B0A\u9650",meta:{requestId:e}},s);if(r==="/internal/api/v1/admin/articles"&&_==="GET")try{let o=h.searchParams,g=(o.get("status")||"all").trim(),l=(o.get("category")||"").trim(),p=(o.get("tag")||"").trim(),m=(o.get("keyword")||o.get("q")||"").trim(),c=Math.max(1,parseInt(o.get("page")||"1",10)),n=Math.min(100,Math.max(1,parseInt(o.get("perPage")||"20",10))),i=(c-1)*n,u=["is_deleted = 0"],E=[];g==="published"&&u.push("is_published = 1"),g==="draft"&&u.push("is_published = 0"),l&&(u.push("category = ?"),E.push(l)),p&&(u.push("tags LIKE ?"),E.push(`%${p}%`)),m&&(u.push("(title LIKE ? OR summary LIKE ?)"),E.push(`%${m}%`,`%${m}%`));let A=u.length?`WHERE ${u.join(" AND ")}`:"",T=await t.DATABASE.prepare(`SELECT COUNT(1) AS total FROM ExternalArticles ${A}`).bind(...E).first(),S=((await t.DATABASE.prepare(`SELECT article_id, title, slug, category, tags, is_published, updated_at, view_count
         FROM ExternalArticles
         ${A}
         ORDER BY updated_at DESC, article_id DESC
         LIMIT ? OFFSET ?`).bind(...E,n,i).all())?.results||[]).map(N=>({id:N.article_id,title:N.title,slug:N.slug,category:N.category||"",tags:(()=>{try{return JSON.parse(N.tags||"[]")}catch{return[]}})(),isPublished:N.is_published===1,updatedAt:N.updated_at,viewCount:Number(N.view_count||0)}));return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:S,meta:{requestId:e,page:c,perPage:n,total:Number(T?.total||0)}},s)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}if(r==="/internal/api/v1/admin/faq"&&_==="GET")try{let o=h.searchParams,g=(o.get("status")||"all").trim(),l=(o.get("category")||"").trim(),p=(o.get("keyword")||o.get("q")||"").trim(),m=Math.max(1,parseInt(o.get("page")||"1",10)),c=Math.min(100,Math.max(1,parseInt(o.get("perPage")||"20",10))),n=(m-1)*c,i=["is_deleted = 0"],u=[];g==="published"&&i.push("is_published = 1"),g==="draft"&&i.push("is_published = 0"),l&&(i.push("category = ?"),u.push(l)),p&&(i.push("question LIKE ?"),u.push(`%${p}%`));let E=i.length?`WHERE ${i.join(" AND ")}`:"",A=await t.DATABASE.prepare(`SELECT COUNT(1) AS total FROM ExternalFAQ ${E}`).bind(...u).first(),R=((await t.DATABASE.prepare(`SELECT faq_id, question, category, sort_order, is_published, updated_at
         FROM ExternalFAQ
         ${E}
         ORDER BY updated_at DESC, sort_order ASC, faq_id DESC
         LIMIT ? OFFSET ?`).bind(...u,c,n).all())?.results||[]).map(S=>({id:S.faq_id,question:S.question,category:S.category||"",sortOrder:Number(S.sort_order||0),isPublished:S.is_published===1,updatedAt:S.updated_at}));return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:R,meta:{requestId:e,page:m,perPage:c,total:Number(A?.total||0)}},s)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}if(r==="/internal/api/v1/admin/resources"&&_==="GET")try{let o=h.searchParams,g=(o.get("category")||"").trim(),l=(o.get("file_type")||o.get("type")||"").trim(),p=(o.get("keyword")||o.get("q")||"").trim(),m=Math.max(1,parseInt(o.get("page")||"1",10)),c=Math.min(100,Math.max(1,parseInt(o.get("perPage")||"20",10))),n=(m-1)*c,i=["is_deleted = 0"],u=[];g&&(i.push("category = ?"),u.push(g)),l&&(i.push("file_type = ?"),u.push(l)),p&&(i.push("title LIKE ?"),u.push(`%${p}%`));let E=i.length?`WHERE ${i.join(" AND ")}`:"",A=await t.DATABASE.prepare(`SELECT COUNT(1) AS total FROM ResourceCenter ${E}`).bind(...u).first(),R=((await t.DATABASE.prepare(`SELECT resource_id, title, category, file_type, file_size, download_count, updated_at
         FROM ResourceCenter
         ${E}
         ORDER BY updated_at DESC, resource_id DESC
         LIMIT ? OFFSET ?`).bind(...u,c,n).all())?.results||[]).map(S=>({id:S.resource_id,title:S.title,category:S.category||"",fileType:S.file_type||"",fileSize:Number(S.file_size||0),downloadCount:Number(S.download_count||0),updatedAt:S.updated_at}));return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:R,meta:{requestId:e,page:m,perPage:c,total:Number(A?.total||0)}},s)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}if(r==="/internal/api/v1/admin/services"&&_==="GET")try{let g=((await t.DATABASE.prepare(`SELECT service_id, service_key, title, is_published, sort_order, updated_at
         FROM ExternalServices
         WHERE is_deleted = 0
         ORDER BY sort_order ASC, service_id ASC`).all())?.results||[]).map(l=>({id:l.service_id,key:l.service_key,title:l.title,isPublished:l.is_published===1,sortOrder:Number(l.sort_order||0),updatedAt:l.updated_at}));return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:g,meta:{requestId:e,count:g.length}},s)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}return a(404,{ok:!1,code:"NOT_FOUND",message:"\u4E0D\u5B58\u5728",meta:{requestId:e}},s)}w(ye,"handleCMS");var $e=new Set(["rule_comp_hours_expiry"]),xe=new Set(["company_name","contact_email","timezone","currency","timesheet_min_unit","soft_delete_enabled","workday_start","workday_end","report_locale","rule_comp_hours_expiry","attendance_bonus_amount","overhead_cost_per_hour","target_profit_margin"]);function Ve(d){return String(d||"").trim()}w(Ve,"normalizeKey");async function te(d,t,f,e,h,r){let s=D(d,t),_=d.method.toUpperCase();if(r==="/internal/api/v1/users"&&_==="GET")try{let g=((await t.DATABASE.prepare("SELECT user_id, username, name, is_admin FROM Users WHERE is_deleted = 0 ORDER BY user_id ASC").all())?.results||[]).map(l=>({user_id:l.user_id,username:l.username,name:l.name||l.username,is_admin:!!l.is_admin}));return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:g,meta:{requestId:e}},s)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}if(!f?.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u6C92\u6709\u6B0A\u9650",meta:{requestId:e}},s);if(r==="/internal/api/v1/admin/settings"&&_==="GET")try{let o=await t.DATABASE.prepare("SELECT setting_key AS key, setting_value AS value, is_dangerous AS isDangerous, description, updated_at AS updatedAt, updated_by AS updatedBy FROM Settings ORDER BY setting_key").all(),g={};for(let l of o?.results||[])g[l.key]=l.value;return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:{items:o?.results||[],map:g},meta:{requestId:e}},s)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}if(r.startsWith("/internal/api/v1/admin/settings/")&&_==="PUT"){let o=Ve(r.replace("/internal/api/v1/admin/settings/",""));if(!xe.has(o))return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u4E0D\u652F\u63F4\u7684\u8A2D\u5B9A\u9375",meta:{requestId:e}},s);let g;try{g=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},s)}let l=String(g?.value??"");if(o==="contact_email"&&l&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(l))return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"Email \u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},s);if(o==="timesheet_min_unit"){let p=parseFloat(l);if(!Number.isFinite(p)||p!==.25&&p!==.5&&p!==1)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u5DE5\u6642\u6700\u5C0F\u55AE\u4F4D\u50C5\u5141\u8A31 0.25/0.5/1",meta:{requestId:e}},s)}if(o==="soft_delete_enabled"&&!(l==="0"||l==="1"))return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8EDF\u522A\u9664\u503C\u50C5\u80FD\u70BA 0 \u6216 1",meta:{requestId:e}},s);if((o==="workday_start"||o==="workday_end")&&!/^\d{2}:\d{2}$/.test(l))return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u6642\u9593\u683C\u5F0F\u9700\u70BA HH:MM",meta:{requestId:e}},s);if(o==="rule_comp_hours_expiry"){if(!new Set(["current_month","next_month","3_months","6_months"]).has(l))return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u7121\u6548\u7684\u898F\u5247\u503C",meta:{requestId:e}},s);if($e.has(o)&&g?.confirmed!==!0)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u5371\u96AA\u8A2D\u5B9A\u9700\u78BA\u8A8D",meta:{requestId:e,field:o}},s)}if(o==="attendance_bonus_amount"){let p=parseInt(l,10);if(!Number.isInteger(p)||p<0)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u5168\u52E4\u734E\u91D1\u5FC5\u9808\u70BA\u975E\u8CA0\u6574\u6578",meta:{requestId:e}},s)}if(o==="overhead_cost_per_hour"){let p=parseFloat(l);if(!Number.isFinite(p)||p<0)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u7BA1\u7406\u6210\u672C\u5FC5\u9808\u70BA\u975E\u8CA0\u6578\u5B57",meta:{requestId:e}},s)}if(o==="target_profit_margin"){let p=parseFloat(l);if(!Number.isFinite(p)||p<0||p>100)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u76EE\u6A19\u6BDB\u5229\u7387\u5FC5\u9808\u5728 0-100 \u4E4B\u9593",meta:{requestId:e}},s)}try{let p=new Date().toISOString();return await t.DATABASE.prepare("INSERT INTO Settings(setting_key, setting_value, updated_at, updated_by) VALUES(?, ?, ?, ?) ON CONFLICT(setting_key) DO UPDATE SET setting_value=excluded.setting_value, updated_at=excluded.updated_at, updated_by=excluded.updated_by").bind(o,l,p,String(f.user_id||f.userId||"1")).run(),a(200,{ok:!0,code:"OK",message:"\u5DF2\u66F4\u65B0",data:{key:o,value:l},meta:{requestId:e}},s)}catch(p){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(p)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}return a(404,{ok:!1,code:"NOT_FOUND",message:"\u7121\u6B64\u7AEF\u9EDE",meta:{requestId:e}},s)}w(te,"handleSettings");function Je(){let d=new Date;return`${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,"0")}`}w(Je,"ymToday");function je(){let d=new Date;return`${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,"0")}-${String(d.getUTCDate()).padStart(2,"0")}`}w(je,"todayYmd");async function De(d,t,f,e,h,r){let s=D(d,t),_=d.method.toUpperCase();if(r!=="/internal/api/v1/dashboard"||_!=="GET")return a(404,{ok:!1,code:"NOT_FOUND",message:"\u4E0D\u5B58\u5728",meta:{requestId:e}},s);try{let o=new URL(h).searchParams,g=o.get("ym"),l=g&&/^\d{4}-\d{2}$/.test(g)?g:Je(),p=o.get("financeYm")&&/^\d{4}-\d{2}$/.test(o.get("financeYm"))?o.get("financeYm"):l,m=o.get("financeMode")||"month",c=je();async function n(){let E={myHours:null,myTasks:{items:[],counts:{pending:0,inProgress:0,overdue:0,dueSoon:0}},myLeaves:null,recentActivities:[],notifications:[]};try{let A=await t.DATABASE.prepare(`SELECT 
              SUM(hours) AS total,
              SUM(CASE WHEN work_type = 'normal' THEN hours ELSE 0 END) AS normal,
              SUM(CASE WHEN work_type LIKE 'ot-%' THEN hours ELSE 0 END) AS overtime
           FROM Timesheets WHERE is_deleted = 0 AND user_id = ? AND substr(work_date,1,7) = ?`).bind(String(f.user_id),l).first(),T=Number(A?.total||0),R=Number(A?.normal||0),S=Number(A?.overtime||0),N=160,O=N?Math.round(T/N*1e3)/10:0;E.myHours={month:l,total:T,normal:R,overtime:S,targetHours:N,completionRate:O}}catch{}try{let T=((await t.DATABASE.prepare(`SELECT task_id, task_name, due_date, status, related_sop_id, client_specific_sop_id
           FROM ActiveTasks
           WHERE is_deleted = 0 AND assignee_user_id = ? AND status IN ('pending','in_progress')
           ORDER BY COALESCE(due_date, '9999-12-31') ASC LIMIT 10`).bind(String(f.user_id)).all())?.results||[]).map(S=>{let N=S.due_date||null,O="normal",b=null,y=null,B=new Date;if(N){let I=new Date(N),M=Math.floor((I.getTime()-B.getTime())/864e5);b=M,M<0?(O="overdue",y=-M):M<=3&&(O="urgent")}return{id:S.task_id,name:S.task_name,dueDate:N,status:S.status,urgency:O,daysUntilDue:b,daysOverdue:y,hasSop:!!(S.related_sop_id||S.client_specific_sop_id)}}),R={pending:0,inProgress:0,overdue:0,dueSoon:0};for(let S of T)S.status==="pending"&&R.pending++,S.status==="in_progress"&&R.inProgress++,S.urgency==="overdue"&&R.overdue++,typeof S.daysUntilDue=="number"&&S.daysUntilDue>=0&&S.daysUntilDue<=3&&R.dueSoon++;E.myTasks={items:T,counts:R}}catch{}try{let A=await t.DATABASE.prepare("SELECT leave_type AS type, remain AS remaining, total, used FROM LeaveBalances WHERE user_id = ?").bind(String(f.user_id)).all(),T={annual:0,sick:0,compHours:0};for(let N of A?.results||[]){let O=(N.type||"").toLowerCase();O==="annual"?T.annual=Number(N.remaining||0):O==="sick"?T.sick=Number(N.remaining||0):O==="comp"&&(T.compHours=Number(N.remaining||0))}let S=((await t.DATABASE.prepare("SELECT leave_type AS type, start_date, end_date, amount, status FROM LeaveRequests WHERE user_id = ? ORDER BY submitted_at DESC LIMIT 3").bind(String(f.user_id)).all())?.results||[]).map(N=>({type:N.type,startDate:N.start_date,days:Number(N.amount||0),status:N.status}));E.myLeaves={balances:T,recent:S}}catch{}return E}w(n,"getEmployeeMetrics");async function i(E,A,T){let R={employeeHours:[],employeeTasks:[],financialStatus:null,revenueTrend:[]};try{let N=(await t.DATABASE.prepare(`SELECT u.user_id, u.name, u.username,
                  COALESCE(SUM(t.hours), 0) AS total,
                  COALESCE(SUM(CASE WHEN CAST(t.work_type AS INTEGER) = 1 THEN t.hours ELSE 0 END), 0) AS normal,
                  COALESCE(SUM(CASE WHEN CAST(t.work_type AS INTEGER) >= 2 THEN t.hours ELSE 0 END), 0) AS overtime
           FROM Users u
           LEFT JOIN Timesheets t ON t.user_id = u.user_id AND t.is_deleted = 0 AND substr(t.work_date, 1, 7) = ?
           WHERE u.is_deleted = 0
           GROUP BY u.user_id, u.name, u.username
           ORDER BY total DESC, u.name ASC`).bind(E).all())?.results||[];R.employeeHours=N.map(O=>({userId:O.user_id,name:O.name||O.username||"\u672A\u547D\u540D",total:Number(O.total||0),normal:Number(O.normal||0),overtime:Number(O.overtime||0)}))}catch(S){console.error("[Dashboard] Employee hours query error:",S)}try{let S=A.split("-")[0],N=await t.DATABASE.prepare("SELECT SUM(total_amount) AS ar FROM Receipts WHERE is_deleted = 0 AND status IN ('unpaid','partial')").first(),O=await t.DATABASE.prepare("SELECT SUM(total_amount) AS od FROM Receipts WHERE is_deleted = 0 AND status IN ('unpaid','partial') AND due_date < ?").bind(c).first(),b=Math.round(Number(N?.ar||0)),y=Math.round(Number(O?.od||0)),B=null,I=null;if(T==="month"){let M=await t.DATABASE.prepare("SELECT SUM(total_amount) AS paid FROM Receipts WHERE is_deleted = 0 AND status = 'paid' AND substr(receipt_date,1,7) = ?").bind(A).first(),L=await t.DATABASE.prepare("SELECT SUM(total_amount) AS revenue FROM Receipts WHERE is_deleted = 0 AND status != 'cancelled' AND substr(receipt_date,1,7) = ?").bind(A).first(),k=0;try{let W=await t.DATABASE.prepare("SELECT SUM(total_cents) AS c FROM MonthlyPayroll mp JOIN PayrollRuns pr ON pr.run_id = mp.run_id WHERE pr.month = ?").bind(A).first();k=Math.round(Number(W?.c||0)/100)}catch{}let U=Math.round(Number(L?.revenue||0)),C=Math.round(Number(M?.paid||0)),v=U-k,H=U>0?Math.round(v/U*1e3)/10:0,P=U>0?Math.round(C/U*1e3)/10:0;B={period:A,revenue:U,cost:k,profit:v,margin:H,ar:b,paid:C,overdue:y,collectionRate:P}}else{let M=await t.DATABASE.prepare("SELECT SUM(total_amount) AS paid FROM Receipts WHERE is_deleted = 0 AND status = 'paid' AND substr(receipt_date,1,4) = ? AND receipt_date <= ?").bind(S,c).first(),L=await t.DATABASE.prepare("SELECT SUM(total_amount) AS revenue FROM Receipts WHERE is_deleted = 0 AND status != 'cancelled' AND substr(receipt_date,1,4) = ? AND receipt_date <= ?").bind(S,c).first(),k=0;try{let W=await t.DATABASE.prepare("SELECT SUM(total_cents) AS c FROM MonthlyPayroll mp JOIN PayrollRuns pr ON pr.run_id = mp.run_id WHERE substr(pr.month,1,4) = ?").bind(S).first();k=Math.round(Number(W?.c||0)/100)}catch{}let U=Math.round(Number(L?.revenue||0)),C=Math.round(Number(M?.paid||0)),v=U-k,H=U>0?Math.round(v/U*1e3)/10:0,P=U>0?Math.round(C/U*1e3)/10:0;I={period:`${S}\u5E74\u7D2F\u8A08`,revenue:U,cost:k,profit:v,margin:H,ar:b,paid:C,overdue:y,collectionRate:P}}R.financialStatus={month:B,ytd:I}}catch{}try{let S=await t.DATABASE.prepare(`SELECT u.user_id, u.name, u.username,
                  COUNT(CASE WHEN t.status = 'completed' THEN 1 END) AS completed,
                  COUNT(CASE WHEN t.status = 'in_progress' THEN 1 END) AS inProgress,
                  COUNT(CASE WHEN t.status NOT IN ('completed','cancelled') AND t.due_date < ? THEN 1 END) AS overdue,
                  COUNT(CASE WHEN t.status = 'pending' THEN 1 END) AS pending
           FROM Users u
           LEFT JOIN ActiveTasks t ON t.assignee_user_id = u.user_id AND t.is_deleted = 0
           WHERE u.is_deleted = 0
           GROUP BY u.user_id, u.name, u.username
           ORDER BY overdue DESC, inProgress DESC`).bind(c).all();R.employeeTasks=(S?.results||[]).map(N=>({userId:N.user_id,name:N.name||N.username,completed:Number(N.completed||0),inProgress:Number(N.inProgress||0),overdue:Number(N.overdue||0),pending:Number(N.pending||0)}))}catch{}try{let N=((await t.DATABASE.prepare(`SELECT strftime('%Y-%m', receipt_date) AS ym, SUM(total_amount) AS revenue,
                  SUM(CASE WHEN status='paid' THEN total_amount ELSE 0 END) AS paid
           FROM Receipts WHERE is_deleted = 0 AND status != 'cancelled'
           GROUP BY ym ORDER BY ym DESC LIMIT 6`).all())?.results||[]).map(O=>({month:O.ym,revenue:Number(O.revenue||0),paid:Number(O.paid||0)}));R.revenueTrend=N.sort((O,b)=>O.month.localeCompare(b.month))}catch{}return R}w(i,"getAdminMetrics");let u={role:f.is_admin?"admin":"employee"};return f.is_admin?u.admin=await i(l,p,m):u.employee=await n(),a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:u,meta:{requestId:e,month:l,financeYm:p,financeMode:m,today:c}},s)}catch(o){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(o)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}w(De,"handleDashboard");function we(d,t){return["daily","weekly","monthly","cron"].includes(d)?d==="daily"?/^\d{2}:\d{2}$/.test(t||""):d==="weekly"?/^([A-Z][a-z]{2})\s+\d{2}:\d{2}$/.test(t||""):d==="monthly"?/^(\d{1,2})\s+\d{2}:\d{2}$/.test(t||""):d==="cron"?typeof t=="string"&&t.trim().length>0:!1:!1}w(we,"isValidSchedule");function Q(d,t=null){try{return JSON.parse(String(d||"null"))}catch{return t}}w(Q,"parseJsonSafe");async function be(d,t,f,e,h,r){let s=D(d,t);if(!f?.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u6C92\u6709\u6B0A\u9650",meta:{requestId:e}},s);let _=d.method.toUpperCase();if(r==="/internal/api/v1/admin/automation-rules"&&_==="GET")try{let l=h.searchParams,p=(l.get("q")||"").trim(),m=l.get("enabled"),c=Math.max(1,parseInt(l.get("page")||"1",10)),n=Math.min(100,Math.max(1,parseInt(l.get("perPage")||"20",10))),i=(c-1)*n,u=["is_deleted=0"],E=[];p&&(u.push("rule_name LIKE ?"),E.push(`%${p}%`)),(m==="0"||m==="1")&&(u.push("is_enabled = ?"),E.push(parseInt(m,10)));let A=u.length?`WHERE ${u.join(" AND ")}`:"",T=await t.DATABASE.prepare(`SELECT COUNT(1) AS total FROM AutomationRules ${A}`).bind(...E).first(),S=((await t.DATABASE.prepare(`SELECT rule_id, rule_name, schedule_type, schedule_value, is_enabled, last_run_at, created_at, updated_at
         FROM AutomationRules ${A} ORDER BY updated_at DESC, rule_id DESC LIMIT ? OFFSET ?`).bind(...E,n,i).all())?.results||[]).map(N=>({id:N.rule_id,name:N.rule_name,scheduleType:N.schedule_type,scheduleValue:N.schedule_value,isEnabled:N.is_enabled===1,lastRunAt:N.last_run_at,createdAt:N.created_at,updatedAt:N.updated_at}));return a(200,{ok:!0,code:"OK",message:"\u6210\u529F",data:S,meta:{requestId:e,page:c,perPage:n,total:Number(T?.total||0)}},s)}catch(l){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(l)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}if(r==="/internal/api/v1/admin/automation-rules"&&_==="POST"){let l;try{l=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},s)}let p=String(l?.rule_name||l?.name||"").trim(),m=String(l?.schedule_type||l?.scheduleType||"").trim(),c=String(l?.schedule_value||l?.scheduleValue||"").trim(),n=l?.condition_json??l?.condition??null,i=l?.action_json??l?.action??null,u=[];if(p||u.push({field:"rule_name",message:"\u5FC5\u586B"}),we(m,c)||u.push({field:"schedule",message:"\u6392\u7A0B\u4E0D\u5408\u6CD5"}),i||u.push({field:"action",message:"\u5FC5\u586B"}),u.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F38\u5165\u6709\u8AA4",errors:u,meta:{requestId:e}},s);try{await t.DATABASE.prepare("INSERT INTO AutomationRules (rule_name, schedule_type, schedule_value, condition_json, action_json, is_enabled) VALUES (?, ?, ?, ?, ?, 1)").bind(p,m,c,JSON.stringify(n??{}),JSON.stringify(i??{})).run();let E=await t.DATABASE.prepare("SELECT last_insert_rowid() AS id").first();return a(201,{ok:!0,code:"CREATED",message:"\u5DF2\u5EFA\u7ACB",data:{id:Number(E?.id||0)},meta:{requestId:e}},s)}catch(E){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(E)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}let o=r.match(/^\/internal\/api\/v1\/admin\/automation-rules\/(\d+)$/);if(o){if(!["PUT","DELETE"].includes(_))return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s);let l=parseInt(o[1],10);if(_==="DELETE")try{return await t.DATABASE.prepare("UPDATE AutomationRules SET is_deleted = 1 WHERE rule_id = ?").bind(l).run(),a(200,{ok:!0,code:"OK",message:"\u5DF2\u522A\u9664",data:{id:l},meta:{requestId:e}},s)}catch(R){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(R)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}let p;try{p=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},s)}let m=p?.rule_name!==void 0?String(p.rule_name).trim():void 0,c=p?.schedule_type!==void 0?String(p.schedule_type).trim():void 0,n=p?.schedule_value!==void 0?String(p.schedule_value).trim():void 0,i=p?.is_enabled,u=p?.condition_json!==void 0?JSON.stringify(Q(p.condition_json,{})):void 0,E=p?.action_json!==void 0?JSON.stringify(Q(p.action_json,{})):void 0,A=[],T=[];if(m!==void 0){if(!m)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u540D\u7A31\u5FC5\u586B",meta:{requestId:e}},s);A.push("rule_name = ?"),T.push(m)}if(c!==void 0||n!==void 0){let R=c??(await t.DATABASE.prepare("SELECT schedule_type FROM AutomationRules WHERE rule_id = ?").bind(l).first())?.schedule_type,S=n??(await t.DATABASE.prepare("SELECT schedule_value FROM AutomationRules WHERE rule_id = ?").bind(l).first())?.schedule_value;if(!we(R,S))return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u6392\u7A0B\u4E0D\u5408\u6CD5",meta:{requestId:e}},s);c!==void 0&&(A.push("schedule_type = ?"),T.push(c)),n!==void 0&&(A.push("schedule_value = ?"),T.push(n))}if(u!==void 0&&(A.push("condition_json = ?"),T.push(u)),E!==void 0&&(A.push("action_json = ?"),T.push(E)),(i===0||i===1||i===!0||i===!1)&&(A.push("is_enabled = ?"),T.push(i===1||i===!0?1:0)),!A.length)return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u7121\u53EF\u66F4\u65B0\u6B04\u4F4D",meta:{requestId:e}},s);A.push("updated_at = datetime('now')");try{return await t.DATABASE.prepare(`UPDATE AutomationRules SET ${A.join(", ")} WHERE rule_id = ?`).bind(...T,l).run(),a(200,{ok:!0,code:"OK",message:"\u5DF2\u66F4\u65B0",data:{id:l},meta:{requestId:e}},s)}catch(R){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(R)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}let g=r.match(/^\/internal\/api\/v1\/admin\/automation-rules\/(\d+)\/test$/);if(g){if(_!=="POST")return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},s);let l=parseInt(g[1],10);try{let p=await t.DATABASE.prepare("SELECT rule_id, rule_name, schedule_type, schedule_value, condition_json, action_json, is_enabled FROM AutomationRules WHERE rule_id = ? AND is_deleted = 0").bind(l).first();if(!p)return a(404,{ok:!1,code:"NOT_FOUND",message:"\u898F\u5247\u4E0D\u5B58\u5728",meta:{requestId:e}},s);let m=Q(p.condition_json,{}),c=Q(p.action_json,{}),n={ruleId:p.rule_id,ruleName:p.rule_name,willExecute:!!p.is_enabled,condition:m,action:c};return a(200,{ok:!0,code:"OK",message:"\u6E2C\u8A66\u6210\u529F",data:n,meta:{requestId:e}},s)}catch(p){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(p)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}},s)}}return a(404,{ok:!1,code:"NOT_FOUND",message:"\u4E0D\u5B58\u5728",meta:{requestId:e}},s)}w(be,"handleAutomation");async function Le(d,t,f,e,h){let r=D(d,t);if(d.method.toUpperCase()==="GET")try{let _=h.searchParams,o=(_.get("start_date")||"").trim(),g=(_.get("end_date")||"").trim(),l=[],p=[];o&&(l.push("holiday_date >= ?"),p.push(o)),g&&(l.push("holiday_date <= ?"),p.push(g));let m=l.length?`WHERE ${l.join(" AND ")}`:"",n=((await t.DATABASE.prepare(`SELECT holiday_date, name, is_national_holiday, is_weekly_restday, is_makeup_workday
				 FROM Holidays
				 ${m}
				 ORDER BY holiday_date ASC`).bind(...p).all())?.results||[]).map(i=>({holiday_date:i.holiday_date,date:i.holiday_date,name:i.name||"",is_national_holiday:!!i.is_national_holiday,is_weekly_restday:!!i.is_weekly_restday,is_makeup_workday:!!i.is_makeup_workday}));return a(200,{ok:!0,code:"SUCCESS",message:"\u67E5\u8A62\u6210\u529F",data:n,meta:{requestId:e}},r)}catch(_){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(_)}));let o={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(o.error=String(_)),a(500,o,D(d,t))}return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},r)}w(Le,"handleHolidays");async function ke(d,t,f,e,h){let r=D(d,t),s=d.method.toUpperCase();if(s==="GET"&&!h.pathname.match(/\/tags\/\d+$/))try{let o=((await t.DATABASE.prepare("SELECT tag_id, tag_name, tag_color, created_at FROM CustomerTags ORDER BY tag_name ASC").all())?.results||[]).map(g=>({tag_id:g.tag_id,tag_name:g.tag_name,tag_color:g.tag_color||null,created_at:g.created_at}));return a(200,{ok:!0,code:"SUCCESS",message:"\u67E5\u8A62\u6210\u529F",data:o,meta:{requestId:e}},r)}catch(_){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(_)}));let o={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(o.error=String(_)),a(500,o,r)}if(s==="GET"&&h.pathname.match(/\/tags\/\d+$/)){let _=parseInt(h.pathname.split("/").pop(),10);try{let o=await t.DATABASE.prepare("SELECT tag_id, tag_name, tag_color, created_at FROM CustomerTags WHERE tag_id = ?").bind(_).first();if(!o)return a(404,{ok:!1,code:"NOT_FOUND",message:"\u6A19\u7C64\u4E0D\u5B58\u5728",meta:{requestId:e}},r);let g={tag_id:o.tag_id,tag_name:o.tag_name,tag_color:o.tag_color||null,created_at:o.created_at};return a(200,{ok:!0,code:"SUCCESS",message:"\u67E5\u8A62\u6210\u529F",data:g,meta:{requestId:e}},r)}catch(o){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(o)}));let g={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(g.error=String(o)),a(500,g,r)}}if(s==="POST"){let _;try{_=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},r)}let o=[],g=String(_?.tag_name||"").trim(),l=String(_?.tag_color||"").trim();if((!g||g.length<1||g.length>50)&&o.push({field:"tag_name",message:"\u6A19\u7C64\u540D\u7A31\u70BA\u5FC5\u586B\uFF081-50\u5B57\uFF09"}),l&&!/^#[0-9A-Fa-f]{6}$/.test(l)&&o.push({field:"tag_color",message:"\u984F\u8272\u78BC\u683C\u5F0F\u932F\u8AA4\uFF08\u9700\u70BA #RRGGBB\uFF09"}),o.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F38\u5165\u6709\u8AA4",errors:o,meta:{requestId:e}},r);try{if(await t.DATABASE.prepare("SELECT 1 FROM CustomerTags WHERE tag_name = ? LIMIT 1").bind(g).first())return a(409,{ok:!1,code:"CONFLICT",message:"\u6A19\u7C64\u540D\u7A31\u5DF2\u5B58\u5728",meta:{requestId:e}},r);let m=new Date().toISOString();await t.DATABASE.prepare("INSERT INTO CustomerTags (tag_name, tag_color, created_at) VALUES (?, ?, ?)").bind(g,l||null,m).run();let n={tag_id:(await t.DATABASE.prepare("SELECT last_insert_rowid() AS id").first())?.id,tag_name:g,tag_color:l||null,created_at:m};return a(201,{ok:!0,code:"CREATED",message:"\u5DF2\u5EFA\u7ACB",data:n,meta:{requestId:e}},r)}catch(p){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(p)}));let m={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(m.error=String(p)),a(500,m,r)}}if(s==="PUT"&&h.pathname.match(/\/tags\/\d+$/)){let _=parseInt(h.pathname.split("/").pop(),10),o;try{o=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4",meta:{requestId:e}},r)}let g=[],l=o?.tag_name?String(o.tag_name).trim():null,p=o?.tag_color?String(o.tag_color).trim():null;if(l!==null&&(l.length<1||l.length>50)&&g.push({field:"tag_name",message:"\u6A19\u7C64\u540D\u7A31\u9577\u5EA6\u9700\u70BA 1-50\u5B57"}),p!==null&&p!==""&&!/^#[0-9A-Fa-f]{6}$/.test(p)&&g.push({field:"tag_color",message:"\u984F\u8272\u78BC\u683C\u5F0F\u932F\u8AA4\uFF08\u9700\u70BA #RRGGBB\uFF09"}),g.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F38\u5165\u6709\u8AA4",errors:g,meta:{requestId:e}},r);try{if(!await t.DATABASE.prepare("SELECT 1 FROM CustomerTags WHERE tag_id = ? LIMIT 1").bind(_).first())return a(404,{ok:!1,code:"NOT_FOUND",message:"\u6A19\u7C64\u4E0D\u5B58\u5728",meta:{requestId:e}},r);if(l!==null&&await t.DATABASE.prepare("SELECT 1 FROM CustomerTags WHERE tag_name = ? AND tag_id != ? LIMIT 1").bind(l,_).first())return a(409,{ok:!1,code:"CONFLICT",message:"\u6A19\u7C64\u540D\u7A31\u5DF2\u5B58\u5728",meta:{requestId:e}},r);let c=[],n=[];return l!==null&&(c.push("tag_name = ?"),n.push(l)),p!==null&&(c.push("tag_color = ?"),n.push(p===""?null:p)),c.length===0?a(400,{ok:!1,code:"BAD_REQUEST",message:"\u6C92\u6709\u53EF\u66F4\u65B0\u7684\u6B04\u4F4D",meta:{requestId:e}},r):(n.push(_),await t.DATABASE.prepare(`UPDATE CustomerTags SET ${c.join(", ")} WHERE tag_id = ?`).bind(...n).run(),a(200,{ok:!0,code:"SUCCESS",message:"\u5DF2\u66F4\u65B0",data:{tag_id:_,tag_name:l,tag_color:p},meta:{requestId:e}},r))}catch(m){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(m)}));let c={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(c.error=String(m)),a(500,c,r)}}if(s==="DELETE"&&h.pathname.match(/\/tags\/\d+$/)){let _=parseInt(h.pathname.split("/").pop(),10);try{if(!await t.DATABASE.prepare("SELECT 1 FROM CustomerTags WHERE tag_id = ? LIMIT 1").bind(_).first())return a(404,{ok:!1,code:"NOT_FOUND",message:"\u6A19\u7C64\u4E0D\u5B58\u5728",meta:{requestId:e}},r);let g=await t.DATABASE.prepare("SELECT COUNT(1) as cnt FROM ClientTagAssignments WHERE tag_id = ?").bind(_).first();return Number(g?.cnt||0)>0?a(409,{ok:!1,code:"CONFLICT",message:`\u6B64\u6A19\u7C64\u6B63\u88AB ${g.cnt} \u500B\u5BA2\u6236\u4F7F\u7528\uFF0C\u7121\u6CD5\u522A\u9664`,meta:{requestId:e}},r):(await t.DATABASE.prepare("DELETE FROM CustomerTags WHERE tag_id = ?").bind(_).run(),a(200,{ok:!0,code:"SUCCESS",message:"\u5DF2\u522A\u9664",meta:{requestId:e}},r))}catch(o){console.error(JSON.stringify({level:"error",requestId:e,path:h.pathname,err:String(o)}));let g={ok:!1,code:"INTERNAL_ERROR",message:"\u4F3A\u670D\u5668\u932F\u8AA4",meta:{requestId:e}};return t.APP_ENV&&t.APP_ENV!=="prod"&&(g.error=String(o)),a(500,g,r)}}return a(405,{ok:!1,code:"METHOD_NOT_ALLOWED",message:"\u65B9\u6CD5\u4E0D\u5141\u8A31",meta:{requestId:e}},r)}w(ke,"handleTags");function Z(d){let t=parseInt(String(d||""),10);return Number.isFinite(t)&&t>0?t:null}w(Z,"parseId");async function Ce(d,t,f,e,h,r){let s=D(d,t),_=d.method.toUpperCase(),o=r.match(/^\/internal\/api\/v1\/billing\/service\/(\d+)$/);if(_==="GET"&&o){let l=Z(o[1]);if(!l)return a(400,{ok:!1,code:"INVALID_ID",message:"\u670D\u52A1ID\u65E0\u6548",meta:{requestId:e}},s);try{let p=await t.DATABASE.prepare(`SELECT cs.client_service_id, cs.client_id, c.assignee_user_id
         FROM ClientServices cs
         LEFT JOIN Clients c ON c.client_id = cs.client_id
         WHERE cs.client_service_id = ? AND cs.is_deleted = 0`).bind(l).first();if(!p)return a(404,{ok:!1,code:"NOT_FOUND",message:"\u670D\u52A1\u4E0D\u5B58\u5728",meta:{requestId:e}},s);if(!f.is_admin&&p.assignee_user_id!==f.user_id)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u65E0\u6743\u9650\u8BBF\u95EE",meta:{requestId:e}},s);let c=((await t.DATABASE.prepare(`SELECT schedule_id, billing_month, billing_amount, payment_due_days, notes, created_at, updated_at
         FROM ServiceBillingSchedule
         WHERE client_service_id = ?
         ORDER BY billing_month ASC`).bind(l).all())?.results||[]).map(i=>({schedule_id:i.schedule_id,billing_month:i.billing_month,billing_amount:Number(i.billing_amount||0),payment_due_days:Number(i.payment_due_days||30),notes:i.notes||"",created_at:i.created_at,updated_at:i.updated_at})),n=c.reduce((i,u)=>i+u.billing_amount,0);return a(200,{ok:!0,code:"OK",message:"\u67E5\u8BE2\u6210\u529F",data:{schedules:c,year_total:n},meta:{requestId:e}},s)}catch(p){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(p)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u670D\u52A1\u5668\u9519\u8BEF",meta:{requestId:e}},s)}}if(_==="POST"&&o){let l=Z(o[1]);if(!l)return a(400,{ok:!1,code:"INVALID_ID",message:"\u670D\u52A1ID\u65E0\u6548",meta:{requestId:e}},s);let p;try{p=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF",meta:{requestId:e}},s)}let m=[],c=parseInt(p?.billing_month,10),n=parseFloat(p?.billing_amount),i=parseInt(p?.payment_due_days||30,10),u=String(p?.notes||"").trim();if((!Number.isInteger(c)||c<1||c>12)&&m.push({field:"billing_month",message:"\u6708\u4EFD\u5FC5\u987B\u57281-12\u4E4B\u95F4"}),(isNaN(n)||n<0)&&m.push({field:"billing_amount",message:"\u91D1\u989D\u5FC5\u987B\u4E3A\u975E\u8D1F\u6570"}),(!Number.isInteger(i)||i<1)&&m.push({field:"payment_due_days",message:"\u6536\u6B3E\u671F\u9650\u5FC5\u987B\u5927\u4E8E0"}),m.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F93\u5165\u6709\u8BEF",errors:m,meta:{requestId:e}},s);try{if(!await t.DATABASE.prepare("SELECT client_service_id FROM ClientServices WHERE client_service_id = ? AND is_deleted = 0").bind(l).first())return a(404,{ok:!1,code:"NOT_FOUND",message:"\u670D\u52A1\u4E0D\u5B58\u5728",meta:{requestId:e}},s);if(await t.DATABASE.prepare("SELECT schedule_id FROM ServiceBillingSchedule WHERE client_service_id = ? AND billing_month = ?").bind(l,c).first())return a(422,{ok:!1,code:"DUPLICATE",message:"\u8BE5\u6708\u4EFD\u5DF2\u8BBE\u5B9A\u6536\u8D39",errors:[{field:"billing_month",message:"\u8BE5\u6708\u4EFD\u5DF2\u5B58\u5728"}],meta:{requestId:e}},s);let R=(await t.DATABASE.prepare(`INSERT INTO ServiceBillingSchedule (client_service_id, billing_month, billing_amount, payment_due_days, notes)
         VALUES (?, ?, ?, ?, ?)`).bind(l,c,n,i,u).run())?.meta?.last_row_id;return a(201,{ok:!0,code:"CREATED",message:"\u6536\u8D39\u660E\u7EC6\u5DF2\u65B0\u589E",data:{schedule_id:R},meta:{requestId:e}},s)}catch(E){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(E)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u670D\u52A1\u5668\u9519\u8BEF",meta:{requestId:e}},s)}}let g=r.match(/^\/internal\/api\/v1\/billing\/(\d+)$/);if(_==="PUT"&&g){let l=Z(g[1]);if(!l)return a(400,{ok:!1,code:"INVALID_ID",message:"\u660E\u7EC6ID\u65E0\u6548",meta:{requestId:e}},s);let p;try{p=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF",meta:{requestId:e}},s)}let m=[],c=parseFloat(p?.billing_amount),n=parseInt(p?.payment_due_days||30,10),i=String(p?.notes||"").trim();if((isNaN(c)||c<0)&&m.push({field:"billing_amount",message:"\u91D1\u989D\u5FC5\u987B\u4E3A\u975E\u8D1F\u6570"}),(!Number.isInteger(n)||n<1)&&m.push({field:"payment_due_days",message:"\u6536\u6B3E\u671F\u9650\u5FC5\u987B\u5927\u4E8E0"}),m.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F93\u5165\u6709\u8BEF",errors:m,meta:{requestId:e}},s);try{return await t.DATABASE.prepare("SELECT schedule_id FROM ServiceBillingSchedule WHERE schedule_id = ?").bind(l).first()?(await t.DATABASE.prepare(`UPDATE ServiceBillingSchedule 
         SET billing_amount = ?, payment_due_days = ?, notes = ?, updated_at = datetime('now')
         WHERE schedule_id = ?`).bind(c,n,i,l).run(),a(200,{ok:!0,code:"OK",message:"\u6536\u8D39\u660E\u7EC6\u5DF2\u66F4\u65B0",data:{schedule_id:l},meta:{requestId:e}},s)):a(404,{ok:!1,code:"NOT_FOUND",message:"\u6536\u8D39\u660E\u7EC6\u4E0D\u5B58\u5728",meta:{requestId:e}},s)}catch(u){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(u)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u670D\u52A1\u5668\u9519\u8BEF",meta:{requestId:e}},s)}}if(_==="DELETE"&&g){let l=Z(g[1]);if(!l)return a(400,{ok:!1,code:"INVALID_ID",message:"\u660E\u7EC6ID\u65E0\u6548",meta:{requestId:e}},s);try{return await t.DATABASE.prepare("SELECT schedule_id FROM ServiceBillingSchedule WHERE schedule_id = ?").bind(l).first()?(await t.DATABASE.prepare("DELETE FROM ServiceBillingSchedule WHERE schedule_id = ?").bind(l).run(),a(200,{ok:!0,code:"OK",message:"\u6536\u8D39\u660E\u7EC6\u5DF2\u5220\u9664",meta:{requestId:e}},s)):a(404,{ok:!1,code:"NOT_FOUND",message:"\u6536\u8D39\u660E\u7EC6\u4E0D\u5B58\u5728",meta:{requestId:e}},s)}catch(p){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(p)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u670D\u52A1\u5668\u9519\u8BEF",meta:{requestId:e}},s)}}return a(404,{ok:!1,code:"NOT_FOUND",message:"\u8DEF\u7531\u4E0D\u5B58\u5728",meta:{requestId:e}},s)}w(Ce,"handleBilling");function j(d){let t=parseInt(String(d||""),10);return Number.isFinite(t)&&t>0?t:null}w(j,"parseId");async function Ue(d,t,f,e,h,r){let s=D(d,t),_=d.method.toUpperCase();if(_==="GET"&&r==="/internal/api/v1/task-templates"){let m=h.searchParams.get("service_id"),c=h.searchParams.get("client_id");try{let n=`
        SELECT tt.template_id, tt.template_name, tt.service_id, tt.client_id, tt.description, 
               tt.sop_id, tt.is_active, tt.created_at,
               s.service_name, s.service_code,
               c.company_name as client_name,
               (SELECT COUNT(*) FROM TaskTemplateStages WHERE template_id = tt.template_id) as stages_count
        FROM TaskTemplates tt
        LEFT JOIN Services s ON s.service_id = tt.service_id
        LEFT JOIN Clients c ON c.client_id = tt.client_id
        WHERE 1=1
      `,i=[];m&&(n+=" AND tt.service_id = ?",i.push(parseInt(m,10))),c&&(c==="null"?n+=" AND tt.client_id IS NULL":(n+=" AND tt.client_id = ?",i.push(parseInt(c,10)))),n+=" ORDER BY tt.template_name ASC";let A=((await(i.length>0?t.DATABASE.prepare(n).bind(...i):t.DATABASE.prepare(n)).all())?.results||[]).map(T=>({template_id:T.template_id,template_name:T.template_name||"",service_id:T.service_id||null,service_name:T.service_name||"",service_code:T.service_code||"",client_id:T.client_id||null,client_name:T.client_name||"",description:T.description||"",sop_id:T.sop_id||null,is_active:!!T.is_active,created_at:T.created_at,stages_count:T.stages_count||0}));return a(200,{ok:!0,code:"OK",message:"\u67E5\u8BE2\u6210\u529F",data:A,meta:{requestId:e}},s)}catch(n){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(n)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u670D\u52A1\u5668\u9519\u8BEF",meta:{requestId:e}},s)}}let o=r.match(/^\/internal\/api\/v1\/task-templates\/(\d+)$/);if(_==="GET"&&o){let m=j(o[1]);if(!m)return a(400,{ok:!1,code:"INVALID_ID",message:"\u6A21\u677FID\u65E0\u6548",meta:{requestId:e}},s);try{let c=await t.DATABASE.prepare(`SELECT tt.template_id, tt.template_name, tt.service_id, tt.description, 
                tt.sop_id, tt.is_active, tt.created_at,
                s.service_name, s.service_code
         FROM TaskTemplates tt
         LEFT JOIN Services s ON s.service_id = tt.service_id
         WHERE tt.template_id = ?`).bind(m).first();if(!c)return a(404,{ok:!1,code:"NOT_FOUND",message:"\u6A21\u677F\u4E0D\u5B58\u5728",meta:{requestId:e}},s);let i=((await t.DATABASE.prepare(`SELECT stage_id, stage_name, stage_order, description, estimated_hours
         FROM TaskTemplateStages
         WHERE template_id = ?
         ORDER BY stage_order ASC`).bind(m).all())?.results||[]).map(E=>({stage_id:E.stage_id,stage_name:E.stage_name||"",stage_order:E.stage_order,description:E.description||"",estimated_hours:Number(E.estimated_hours||0)})),u={template_id:c.template_id,template_name:c.template_name||"",service_id:c.service_id||null,service_name:c.service_name||"",service_code:c.service_code||"",description:c.description||"",sop_id:c.sop_id||null,is_active:!!c.is_active,created_at:c.created_at,stages:i};return a(200,{ok:!0,code:"OK",message:"\u67E5\u8BE2\u6210\u529F",data:u,meta:{requestId:e}},s)}catch(c){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(c)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u670D\u52A1\u5668\u9519\u8BEF",meta:{requestId:e}},s)}}if(_==="POST"&&r==="/internal/api/v1/task-templates"){if(!f.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u4EC5\u7BA1\u7406\u5458\u53EF\u521B\u5EFA\u6A21\u677F",meta:{requestId:e}},s);let m;try{m=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF",meta:{requestId:e}},s)}let c=[],n=String(m?.template_name||"").trim(),i=m?.service_id?parseInt(m.service_id,10):null,u=m?.client_id?parseInt(m.client_id,10):null,E=String(m?.description||"").trim(),A=m?.sop_id?parseInt(m.sop_id,10):null,T=Array.isArray(m?.stages)?m.stages:[];if(n||c.push({field:"template_name",message:"\u8BF7\u8F93\u5165\u6A21\u677F\u540D\u79F0"}),c.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F93\u5165\u6709\u8BEF",errors:c,meta:{requestId:e}},s);try{let S=(await t.DATABASE.prepare(`INSERT INTO TaskTemplates (template_name, service_id, client_id, description, sop_id, is_active)
         VALUES (?, ?, ?, ?, ?, 1)`).bind(n,i,u,E,A).run())?.meta?.last_row_id;if(T.length>0)for(let N=0;N<T.length;N++){let O=T[N],b=String(O?.stage_name||"").trim(),y=String(O?.description||"").trim(),B=parseFloat(O?.estimated_hours||0);b&&await t.DATABASE.prepare(`INSERT INTO TaskTemplateStages (template_id, stage_name, stage_order, description, estimated_hours)
               VALUES (?, ?, ?, ?, ?)`).bind(S,b,N+1,y,B).run()}return a(201,{ok:!0,code:"CREATED",message:"\u6A21\u677F\u5DF2\u521B\u5EFA",data:{template_id:S},meta:{requestId:e}},s)}catch(R){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(R)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u670D\u52A1\u5668\u9519\u8BEF",meta:{requestId:e}},s)}}let g=r.match(/^\/internal\/api\/v1\/task-templates\/(\d+)$/);if(_==="PUT"&&g){let m=j(g[1]);if(!m)return a(400,{ok:!1,code:"INVALID_ID",message:"\u6A21\u677FID\u65E0\u6548",meta:{requestId:e}},s);if(!f.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u4EC5\u7BA1\u7406\u5458\u53EF\u66F4\u65B0\u6A21\u677F",meta:{requestId:e}},s);let c;try{c=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF",meta:{requestId:e}},s)}let n=[],i=String(c?.template_name||"").trim(),u=c?.service_id?parseInt(c.service_id,10):null,E=String(c?.description||"").trim(),A=c?.sop_id?parseInt(c.sop_id,10):null,T=c?.is_active!==!1,R=Array.isArray(c?.stages)?c.stages:null;if(i||n.push({field:"template_name",message:"\u8BF7\u8F93\u5165\u6A21\u677F\u540D\u79F0"}),n.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F93\u5165\u6709\u8BEF",errors:n,meta:{requestId:e}},s);try{if(!await t.DATABASE.prepare("SELECT template_id FROM TaskTemplates WHERE template_id = ?").bind(m).first())return a(404,{ok:!1,code:"NOT_FOUND",message:"\u6A21\u677F\u4E0D\u5B58\u5728",meta:{requestId:e}},s);if(await t.DATABASE.prepare(`UPDATE TaskTemplates 
         SET template_name = ?, service_id = ?, description = ?, sop_id = ?, is_active = ?
         WHERE template_id = ?`).bind(i,u,E,A,T?1:0,m).run(),R!==null){await t.DATABASE.prepare("DELETE FROM TaskTemplateStages WHERE template_id = ?").bind(m).run();for(let N=0;N<R.length;N++){let O=R[N],b=String(O?.stage_name||"").trim(),y=String(O?.description||"").trim(),B=parseFloat(O?.estimated_hours||0);b&&await t.DATABASE.prepare(`INSERT INTO TaskTemplateStages (template_id, stage_name, stage_order, description, estimated_hours)
               VALUES (?, ?, ?, ?, ?)`).bind(m,b,N+1,y,B).run()}}return a(200,{ok:!0,code:"OK",message:"\u6A21\u677F\u5DF2\u66F4\u65B0",data:{template_id:m},meta:{requestId:e}},s)}catch(S){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(S)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u670D\u52A1\u5668\u9519\u8BEF",meta:{requestId:e}},s)}}if(_==="DELETE"&&g){let m=j(g[1]);if(!m)return a(400,{ok:!1,code:"INVALID_ID",message:"\u6A21\u677FID\u65E0\u6548",meta:{requestId:e}},s);if(!f.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u4EC5\u7BA1\u7406\u5458\u53EF\u5220\u9664\u6A21\u677F",meta:{requestId:e}},s);try{return await t.DATABASE.prepare("SELECT template_id FROM TaskTemplates WHERE template_id = ?").bind(m).first()?await t.DATABASE.prepare("SELECT client_service_id FROM ClientServices WHERE task_template_id = ? AND is_deleted = 0 LIMIT 1").bind(m).first()?a(422,{ok:!1,code:"IN_USE",message:"\u8BE5\u6A21\u677F\u6B63\u5728\u88AB\u4F7F\u7528\uFF0C\u65E0\u6CD5\u5220\u9664",meta:{requestId:e}},s):(await t.DATABASE.prepare("DELETE FROM TaskTemplateStages WHERE template_id = ?").bind(m).run(),await t.DATABASE.prepare("DELETE FROM TaskTemplates WHERE template_id = ?").bind(m).run(),a(200,{ok:!0,code:"OK",message:"\u6A21\u677F\u5DF2\u5220\u9664",meta:{requestId:e}},s)):a(404,{ok:!1,code:"NOT_FOUND",message:"\u6A21\u677F\u4E0D\u5B58\u5728",meta:{requestId:e}},s)}catch(c){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(c)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u670D\u52A1\u5668\u9519\u8BEF",meta:{requestId:e}},s)}}let l=r.match(/^\/internal\/api\/v1\/task-templates\/(\d+)\/stages$/);if(_==="GET"&&l){let m=j(l[1]);if(!m)return a(400,{ok:!1,code:"INVALID_ID",message:"\u6A21\u677FID\u65E0\u6548",meta:{requestId:e}},s);try{let n=((await t.DATABASE.prepare(`SELECT tts.stage_id, tts.stage_name, tts.stage_order, tts.description, 
                tts.estimated_hours, tts.dependencies, tts.sop_id, tts.attachment_id,
                sop.title as sop_title,
                att.original_filename as attachment_name, att.file_url as attachment_url
         FROM TaskTemplateStages tts
         LEFT JOIN SOPDocuments sop ON sop.sop_id = tts.sop_id
         LEFT JOIN Attachments att ON att.attachment_id = tts.attachment_id
         WHERE tts.template_id = ?
         ORDER BY tts.stage_order ASC`).bind(m).all())?.results||[]).map(i=>({stage_id:i.stage_id,stage_name:i.stage_name||"",stage_order:i.stage_order,description:i.description||"",estimated_hours:Number(i.estimated_hours||0),dependencies:i.dependencies||"",sop_id:i.sop_id||null,sop_title:i.sop_title||"",attachment_id:i.attachment_id||null,attachment_name:i.attachment_name||"",attachment_url:i.attachment_url||""}));return a(200,{ok:!0,code:"OK",message:"\u67E5\u8BE2\u6210\u529F",data:n,meta:{requestId:e}},s)}catch(c){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(c)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u670D\u52A1\u5668\u9519\u8BEF",meta:{requestId:e}},s)}}if(_==="POST"&&l){let m=j(l[1]);if(!m)return a(400,{ok:!1,code:"INVALID_ID",message:"\u6A21\u677FID\u65E0\u6548",meta:{requestId:e}},s);if(!f.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u4EC5\u7BA1\u7406\u5458\u53EF\u6DFB\u52A0\u9636\u6BB5",meta:{requestId:e}},s);let c;try{c=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF",meta:{requestId:e}},s)}let n=[],i=String(c?.stage_name||"").trim(),u=c?.stage_order?parseInt(c.stage_order,10):null,E=String(c?.description||"").trim(),A=c?.estimated_hours?parseFloat(c.estimated_hours):null,T=String(c?.dependencies||"").trim(),R=c?.sop_id?parseInt(c.sop_id,10):null,S=c?.attachment_id?parseInt(c.attachment_id,10):null;if(i||n.push({field:"stage_name",message:"\u8BF7\u8F93\u5165\u4EFB\u52A1\u540D\u79F0"}),(!u||u<1)&&n.push({field:"stage_order",message:"\u8BF7\u8F93\u5165\u6709\u6548\u7684\u987A\u5E8F"}),n.length)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u8F93\u5165\u6709\u8BEF",errors:n,meta:{requestId:e}},s);try{if(!await t.DATABASE.prepare("SELECT template_id FROM TaskTemplates WHERE template_id = ?").bind(m).first())return a(404,{ok:!1,code:"NOT_FOUND",message:"\u6A21\u677F\u4E0D\u5B58\u5728",meta:{requestId:e}},s);let O=await t.DATABASE.prepare(`INSERT INTO TaskTemplateStages (template_id, stage_name, stage_order, description, estimated_hours, dependencies, sop_id, attachment_id)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?)`).bind(m,i,u,E,A,T,R,S).run();return a(201,{ok:!0,code:"CREATED",message:"\u4EFB\u52A1\u5DF2\u6DFB\u52A0",data:{stage_id:O?.meta?.last_row_id},meta:{requestId:e}},s)}catch(N){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(N)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u670D\u52A1\u5668\u9519\u8BEF",meta:{requestId:e}},s)}}let p=r.match(/^\/internal\/api\/v1\/task-templates\/(\d+)\/stages\/(\d+)$/);if(_==="DELETE"&&p){let m=j(p[1]),c=j(p[2]);if(!m||!c)return a(400,{ok:!1,code:"INVALID_ID",message:"ID\u65E0\u6548",meta:{requestId:e}},s);if(!f.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u4EC5\u7BA1\u7406\u5458\u53EF\u5220\u9664\u9636\u6BB5",meta:{requestId:e}},s);try{return await t.DATABASE.prepare("SELECT stage_id FROM TaskTemplateStages WHERE template_id = ? AND stage_id = ?").bind(m,c).first()?(await t.DATABASE.prepare("DELETE FROM TaskTemplateStages WHERE template_id = ? AND stage_id = ?").bind(m,c).run(),a(200,{ok:!0,code:"OK",message:"\u4EFB\u52A1\u5DF2\u5220\u9664",meta:{requestId:e}},s)):a(404,{ok:!1,code:"NOT_FOUND",message:"\u4EFB\u52A1\u4E0D\u5B58\u5728",meta:{requestId:e}},s)}catch(n){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(n)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u670D\u52A1\u5668\u9519\u8BEF",meta:{requestId:e}},s)}}return a(404,{ok:!1,code:"NOT_FOUND",message:"\u8DEF\u7531\u4E0D\u5B58\u5728",meta:{requestId:e}},s)}w(Ue,"handleTaskTemplates");function J(d){let t=parseInt(String(d||""),10);return Number.isFinite(t)&&t>0?t:null}w(J,"parseId");async function Be(d,t,f,e,h,r){let s=D(d,t),_=d.method.toUpperCase();if(_==="GET"&&r==="/internal/api/v1/services")try{let i=((await t.DATABASE.prepare(`
        SELECT service_id, service_name, service_code, description, 
               is_active, sort_order, created_at, updated_at
        FROM Services
        WHERE is_active = 1
        ORDER BY sort_order ASC, service_id ASC
      `).all())?.results||[]).map(u=>({service_id:u.service_id,service_name:u.service_name||"",service_code:u.service_code||"",description:u.description||"",is_active:!!u.is_active,sort_order:u.sort_order||0,created_at:u.created_at,updated_at:u.updated_at}));return a(200,{ok:!0,code:"SUCCESS",message:"\u67E5\u8BE2\u6210\u529F",data:i,meta:{requestId:e}},s)}catch(n){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(n)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u670D\u52A1\u5668\u9519\u8BEF",meta:{requestId:e}},s)}if(_==="POST"&&r==="/internal/api/v1/services"){if(!f?.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650",meta:{requestId:e}},s);let n;try{n=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF",meta:{requestId:e}},s)}let i=String(n?.service_name||"").trim(),u=String(n?.service_code||"").trim(),E=String(n?.description||"").trim(),A=parseInt(n?.sort_order||"0",10);if(!i)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u670D\u52A1\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A",meta:{requestId:e}},s);try{let T=await t.DATABASE.prepare(`
        INSERT INTO Services (service_name, service_code, description, sort_order, is_active)
        VALUES (?, ?, ?, ?, 1)
      `).bind(i,u||null,E||null,A).run();return a(201,{ok:!0,code:"CREATED",message:"\u521B\u5EFA\u6210\u529F",data:{service_id:T.meta.last_row_id},meta:{requestId:e}},s)}catch(T){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(T)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u521B\u5EFA\u5931\u8D25",meta:{requestId:e}},s)}}let o=r.match(/^\/internal\/api\/v1\/services\/(\d+)$/);if(_==="PUT"&&o){if(!f?.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650",meta:{requestId:e}},s);let n=J(o[1]);if(!n)return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u65E0\u6548\u7684\u670D\u52A1ID",meta:{requestId:e}},s);let i;try{i=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF",meta:{requestId:e}},s)}let u=String(i?.service_name||"").trim(),E=String(i?.service_code||"").trim(),A=String(i?.description||"").trim(),T=parseInt(i?.sort_order||"0",10);if(!u)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u670D\u52A1\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A",meta:{requestId:e}},s);try{return await t.DATABASE.prepare(`
        UPDATE Services 
        SET service_name = ?, service_code = ?, description = ?, 
            sort_order = ?, updated_at = datetime('now')
        WHERE service_id = ?
      `).bind(u,E||null,A||null,T,n).run(),a(200,{ok:!0,code:"SUCCESS",message:"\u66F4\u65B0\u6210\u529F",meta:{requestId:e}},s)}catch(R){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(R)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u66F4\u65B0\u5931\u8D25",meta:{requestId:e}},s)}}let g=r.match(/^\/internal\/api\/v1\/services\/(\d+)$/);if(_==="DELETE"&&g){if(!f?.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650",meta:{requestId:e}},s);let n=J(g[1]);if(!n)return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u65E0\u6548\u7684\u670D\u52A1ID",meta:{requestId:e}},s);try{return await t.DATABASE.prepare(`
        UPDATE Services SET is_active = 0, updated_at = datetime('now')
        WHERE service_id = ?
      `).bind(n).run(),a(200,{ok:!0,code:"SUCCESS",message:"\u5220\u9664\u6210\u529F",meta:{requestId:e}},s)}catch(i){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(i)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u5220\u9664\u5931\u8D25",meta:{requestId:e}},s)}}let l=r.match(/^\/internal\/api\/v1\/services\/(\d+)\/items$/);if(_==="GET"&&l){let n=J(l[1]);if(!n)return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u65E0\u6548\u7684\u670D\u52A1ID",meta:{requestId:e}},s);try{let u=((await t.DATABASE.prepare(`
        SELECT item_id, service_id, item_name, item_code, description,
               is_active, sort_order, created_at, updated_at
        FROM ServiceItems
        WHERE service_id = ? AND is_active = 1
        ORDER BY sort_order ASC, item_id ASC
      `).bind(n).all())?.results||[]).map(E=>({item_id:E.item_id,service_id:E.service_id,item_name:E.item_name||"",item_code:E.item_code||"",description:E.description||"",is_active:!!E.is_active,sort_order:E.sort_order||0,created_at:E.created_at,updated_at:E.updated_at}));return a(200,{ok:!0,code:"SUCCESS",message:"\u67E5\u8BE2\u6210\u529F",data:u,meta:{requestId:e}},s)}catch(i){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(i)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u670D\u52A1\u5668\u9519\u8BEF",meta:{requestId:e}},s)}}let p=r.match(/^\/internal\/api\/v1\/services\/(\d+)\/items$/);if(_==="POST"&&p){if(!f?.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650",meta:{requestId:e}},s);let n=J(p[1]);if(!n)return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u65E0\u6548\u7684\u670D\u52A1ID",meta:{requestId:e}},s);let i;try{i=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF",meta:{requestId:e}},s)}let u=String(i?.item_name||"").trim(),E=String(i?.item_code||"").trim(),A=String(i?.description||"").trim(),T=parseInt(i?.sort_order||"0",10);if(!u)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u5B50\u9879\u76EE\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A",meta:{requestId:e}},s);try{let R=await t.DATABASE.prepare(`
        INSERT INTO ServiceItems (service_id, item_name, item_code, description, sort_order, is_active)
        VALUES (?, ?, ?, ?, ?, 1)
      `).bind(n,u,E||null,A||null,T).run();return a(201,{ok:!0,code:"CREATED",message:"\u521B\u5EFA\u6210\u529F",data:{item_id:R.meta.last_row_id},meta:{requestId:e}},s)}catch(R){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(R)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u521B\u5EFA\u5931\u8D25",meta:{requestId:e}},s)}}let m=r.match(/^\/internal\/api\/v1\/services\/(\d+)\/items\/(\d+)$/);if(_==="PUT"&&m){if(!f?.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650",meta:{requestId:e}},s);let n=J(m[1]),i=J(m[2]);if(!n||!i)return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u65E0\u6548\u7684ID",meta:{requestId:e}},s);let u;try{u=await d.json()}catch{return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF",meta:{requestId:e}},s)}let E=String(u?.item_name||"").trim(),A=String(u?.item_code||"").trim(),T=String(u?.description||"").trim(),R=parseInt(u?.sort_order||"0",10);if(!E)return a(422,{ok:!1,code:"VALIDATION_ERROR",message:"\u5B50\u9879\u76EE\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A",meta:{requestId:e}},s);try{return await t.DATABASE.prepare(`
        UPDATE ServiceItems 
        SET item_name = ?, item_code = ?, description = ?, 
            sort_order = ?, updated_at = datetime('now')
        WHERE service_id = ? AND item_id = ?
      `).bind(E,A||null,T||null,R,n,i).run(),a(200,{ok:!0,code:"SUCCESS",message:"\u66F4\u65B0\u6210\u529F",meta:{requestId:e}},s)}catch(S){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(S)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u66F4\u65B0\u5931\u8D25",meta:{requestId:e}},s)}}let c=r.match(/^\/internal\/api\/v1\/services\/(\d+)\/items\/(\d+)$/);if(_==="DELETE"&&c){if(!f?.is_admin)return a(403,{ok:!1,code:"FORBIDDEN",message:"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650",meta:{requestId:e}},s);let n=J(c[1]),i=J(c[2]);if(!n||!i)return a(400,{ok:!1,code:"BAD_REQUEST",message:"\u65E0\u6548\u7684ID",meta:{requestId:e}},s);try{return await t.DATABASE.prepare(`
        UPDATE ServiceItems SET is_active = 0, updated_at = datetime('now')
        WHERE service_id = ? AND item_id = ?
      `).bind(n,i).run(),a(200,{ok:!0,code:"SUCCESS",message:"\u5220\u9664\u6210\u529F",meta:{requestId:e}},s)}catch(u){return console.error(JSON.stringify({level:"error",requestId:e,path:r,err:String(u)})),a(500,{ok:!1,code:"INTERNAL_ERROR",message:"\u5220\u9664\u5931\u8D25",meta:{requestId:e}},s)}}return a(404,{ok:!1,code:"NOT_FOUND",message:"API\u8DEF\u5F84\u4E0D\u5B58\u5728",meta:{requestId:e}},s)}w(Be,"handleServices");var ka={async fetch(d,t){let f=new URL(d.url),e=f.pathname,h=d.method.toUpperCase(),r=d.headers.get("X-Request-Id")||ae(),s=w((_,o)=>{let g=new URL(d.url);return g.protocol="https:",g.hostname=_,g.pathname=o,fetch(new Request(g.toString(),d))},"proxy");if(e.startsWith("/internal/api/")&&h==="OPTIONS")return ne(d,t);if(e==="/internal/api/v1/auth/login")return oe(d,t,r);if(e==="/internal/api/v1/auth/me")return ce(d,t,r);if(e.startsWith("/internal/api/v1/admin/dev-"))return ge(d,t,r,e);if(e==="/internal/api/v1/clients"||e.startsWith("/internal/api/v1/clients/")){let _=await F(d,t);return _?de(d,t,_,r,f):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e==="/internal/api/v1/tags"||e.startsWith("/internal/api/v1/tags/")){let _=await F(d,t);return _?ke(d,t,_,r,f):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e.startsWith("/internal/api/v1/billing/")){let _=await F(d,t);return _?Ce(d,t,_,r,f,e):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e.startsWith("/internal/api/v1/task-templates")){let _=await F(d,t);return _?Ue(d,t,_,r,f,e):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e==="/internal/api/v1/services"||/^\/internal\/api\/v1\/services\/\d+(\/|$)/.test(e)){let _=await F(d,t);return _?Be(d,t,_,r,f,e):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e==="/internal/api/v1/tasks"){let _=await F(d,t);return _?le(d,t,_,r,f):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e==="/internal/api/v1/timesheets"||e.startsWith("/internal/api/v1/timelogs")){let _=await F(d,t);return _?_e(d,t,_,r,f):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e==="/internal/api/v1/receipts"){let _=await F(d,t);return _?pe(d,t,_,r,f):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e==="/internal/api/v1/attachments"||e==="/internal/api/v1/attachments/upload-sign"||e==="/internal/api/v1/attachments/upload-direct"){let _=await F(d,t);return _?Re(d,t,_,r,f,e):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e==="/internal/api/v1/leaves"||e==="/internal/api/v1/leaves/balances"||e==="/internal/api/v1/admin/cron/execute"||e==="/internal/api/v1/admin/cron/history"){let _=await F(d,t);return _?Ee(d,t,_,r,f,e):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e==="/internal/api/v1/holidays"){let _=await F(d,t);return _?Le(d,t,_,r,f):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e.startsWith("/internal/api/v1/admin/payroll")){let _=await F(d,t);return _?_.is_admin?ue(d,t,_,r,f,e):a(403,{ok:!1,code:"FORBIDDEN",message:"\u6C92\u6709\u6B0A\u9650",meta:{requestId:r}},D(d,t)):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e.startsWith("/internal/api/v1/admin/overhead")){let _=await F(d,t);return _?_.is_admin?Ae(d,t,_,r,f,e):a(403,{ok:!1,code:"FORBIDDEN",message:"\u6C92\u6709\u6B0A\u9650",meta:{requestId:r}},D(d,t)):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e==="/internal/api/v1/admin/articles"||e==="/internal/api/v1/admin/faq"||e==="/internal/api/v1/admin/resources"||e==="/internal/api/v1/admin/services"){let _=await F(d,t);return _?_.is_admin?ye(d,t,_,r,f,e):a(403,{ok:!1,code:"FORBIDDEN",message:"\u6C92\u6709\u6B0A\u9650",meta:{requestId:r}},D(d,t)):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e.startsWith("/internal/api/v1/reports")){let _=await F(d,t);return _?fe(d,t,_,r,f,e):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e==="/internal/api/v1/sop"){let _=await F(d,t);return _?he(d,t,_,r,f,e):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e==="/internal/api/v1/dashboard"){let _=await F(d,t);return _?De(d,t,_,r,f,e):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e==="/internal/api/v1/admin/automation-rules"||/\/internal\/api\/v1\/admin\/automation-rules\//.test(e)){let _=await F(d,t);return _?_.is_admin?be(d,t,_,r,f,e):a(403,{ok:!1,code:"FORBIDDEN",message:"\u6C92\u6709\u6B0A\u9650",meta:{requestId:r}},D(d,t)):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e==="/internal/api/v1/users"){let _=await F(d,t);return _?te(d,t,_,r,f,e):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e==="/internal/api/v1/admin/settings"||e.startsWith("/internal/api/v1/admin/settings/")){let _=await F(d,t);return _?_.is_admin?te(d,t,_,r,f,e):a(403,{ok:!1,code:"FORBIDDEN",message:"\u6C92\u6709\u6B0A\u9650",meta:{requestId:r}},D(d,t)):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e==="/internal/api/v1/client-services"||/\/internal\/api\/v1\/client-services\//.test(e)){let _=await F(d,t);return _?Oe(d,t,_,r,f,e):a(401,{ok:!1,code:"UNAUTHORIZED",message:"\u672A\u767B\u5165",meta:{requestId:r}},D(d,t))}if(e.startsWith("/internal/api/"))return s(t.INTERNAL_API_HOST,e.replace("/internal",""));if(e==="/login"||e.startsWith("/login/"))return s(t.INTERNAL_BASE_HOST,"/login");if(e.startsWith("/internal/")){if(!await F(d,t)){let o=`/login?redirect=${encodeURIComponent(e)}`;return new Response(null,{status:302,headers:{Location:o}})}return s(t.INTERNAL_BASE_HOST,e.replace("/internal",""))}return fetch(d)},async scheduled(d,t,f){let e=crypto.randomUUID();console.log(JSON.stringify({level:"info",requestId:e,event:"cron_triggered",scheduledTime:new Date(d.scheduledTime).toISOString(),cron:d.cron}));try{let h=new Date(d.scheduledTime),r=new Date(Date.UTC(h.getUTCFullYear(),h.getUTCMonth()-1,1)),s=new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth()+1,0)),_=`${s.getUTCFullYear()}-${String(s.getUTCMonth()+1).padStart(2,"0")}-${String(s.getUTCDate()).padStart(2,"0")}`,o=`${h.getUTCFullYear()}-${String(h.getUTCMonth()+1).padStart(2,"0")}`,g=await t.DATABASE.prepare(`SELECT g.grant_id, g.user_id, g.hours_remaining, g.original_rate, u.base_salary
				 FROM CompensatoryLeaveGrants g
				 LEFT JOIN Users u ON g.user_id = u.user_id
				 WHERE g.expiry_date = ? AND g.status = 'active' AND g.hours_remaining > 0`).bind(_).all(),l=0,p=[];for(let m of g?.results||[]){let n=Number(m.base_salary||0)/240,i=Number(m.hours_remaining||0),u=Number(m.original_rate||1),E=Math.round(i*n*u*100);await t.DATABASE.prepare(`INSERT INTO CompensatoryOvertimePay 
					 (user_id, year_month, hours_expired, amount_cents, source_grant_ids)
					 VALUES (?, ?, ?, ?, ?)`).bind(String(m.user_id),o,i,E,JSON.stringify([m.grant_id])).run(),await t.DATABASE.prepare("UPDATE CompensatoryLeaveGrants SET status = 'expired' WHERE grant_id = ?").bind(m.grant_id).run(),p.push(m.grant_id),l++}await t.DATABASE.prepare(`INSERT INTO CronJobExecutions 
				 (job_name, status, executed_at, details)
				 VALUES (?, 'success', datetime('now'), ?)`).bind("comp_leave_expiry",JSON.stringify({expiryDate:_,processedCount:l,grantIds:p,currentMonth:o,triggeredBy:"cron"})).run(),console.log(JSON.stringify({level:"info",requestId:e,event:"cron_completed",processedCount:l,expiryDate:_,currentMonth:o}))}catch(h){console.error(JSON.stringify({level:"error",requestId:e,event:"cron_failed",error:String(h)}));try{await t.DATABASE.prepare(`INSERT INTO CronJobExecutions 
					 (job_name, status, executed_at, error_message)
					 VALUES (?, 'failed', datetime('now'), ?)`).bind("comp_leave_expiry",String(h)).run()}catch{console.error(JSON.stringify({level:"error",requestId:e,event:"failed_to_log_cron_error"}))}}}};export{ka as default};
//# sourceMappingURL=index.js.map
