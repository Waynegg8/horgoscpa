{
  "version": 3,
  "sources": ["../../../src/utils.js", "../../../src/auth.js", "../../../src/api/clients.js", "../../../src/api/tasks.js", "../../../src/api/timesheets.js", "../../../src/api/receipts.js", "../../../src/api/payroll.js", "../../../src/api/leaves.js", "../../../src/api/dev.js", "../../../src/api/overhead.js", "../../../src/api/reports.js", "../../../src/api/attachments.js", "../../../src/api/sop.js", "../../../src/api/client_services.js", "../../../src/api/cms.js", "../../../src/api/settings.js", "../../../src/api/dashboard.js", "../../../src/api/automation.js", "../../../src/api/holidays.js", "../../../src/api/tags.js", "../../../src/api/billing.js", "../../../src/api/task_templates.js", "../../../src/api/services.js", "../../../src/index.js"],
  "sourceRoot": "C:\\Users\\miama\\Desktop\\horgoscpa\\cloudflare\\worker-router\\.wrangler\\tmp\\deploy-Md41QD",
  "sourcesContent": ["// \u5DE5\u5177\uFF1AJSON \u56DE\u61C9\uFF08\u7B26\u5408 Envelope\uFF09\r\nexport function jsonResponse(status, body, extraHeaders = {}) {\r\n\treturn new Response(JSON.stringify(body), {\r\n\t\tstatus,\r\n\t\theaders: {\r\n\t\t\t\"Content-Type\": \"application/json; charset=utf-8\",\r\n\t\t\t...extraHeaders,\r\n\t\t},\r\n\t});\r\n}\r\n\r\n// \u5DE5\u5177\uFF1A\u751F\u6210 Request Id\uFF08\u7C21\u6613\uFF09\r\nexport function generateRequestId() {\r\n\tconst random = crypto.getRandomValues(new Uint8Array(8));\r\n\treturn (\r\n\t\t\"req_\" + Array.from(random).map((b) => b.toString(16).padStart(2, \"0\")).join(\"\")\r\n\t);\r\n}\r\n\r\n// \u5DE5\u5177\uFF1APBKDF2-SHA256 \u9A57\u8B49\uFF08\u5132\u5B58\u683C\u5F0F\uFF1Apbkdf2$<iterations>$<saltBase64>$<hashBase64>\uFF09\r\nexport async function verifyPasswordPBKDF2(password, stored) {\r\n\tif (!stored || typeof stored !== \"string\") return false;\r\n\tconst parts = stored.split(\"$\");\r\n\tif (parts.length !== 4 || parts[0] !== \"pbkdf2\") return false;\r\n\tconst iterations = parseInt(parts[1], 10);\r\n\t// Cloudflare Workers \u9650\u5236\uFF1A\u8FED\u4EE3\u4E0A\u9650\u8F03\u4F4E\uFF1B\u653E\u5BEC\u4E0B\u9650\u81F3 100k\r\n\tif (!Number.isFinite(iterations) || iterations < 100000) return false;\r\n\tconst salt = Uint8Array.from(atob(parts[2]), (c) => c.charCodeAt(0));\r\n\tconst expected = Uint8Array.from(atob(parts[3]), (c) => c.charCodeAt(0));\r\n\r\n\tconst enc = new TextEncoder();\r\n\tconst keyMaterial = await crypto.subtle.importKey(\r\n\t\t\"raw\",\r\n\t\tenc.encode(password),\r\n\t\t{ name: \"PBKDF2\" },\r\n\t\tfalse,\r\n\t\t[\"deriveBits\"]\r\n\t);\r\n\tconst derivedBits = await crypto.subtle.deriveBits(\r\n\t\t{\r\n\t\t\tname: \"PBKDF2\",\r\n\t\t\thash: \"SHA-256\",\r\n\t\t\tsalt,\r\n\t\t\titerations,\r\n\t\t},\r\n\t\tkeyMaterial,\r\n\t\texpected.byteLength * 8\r\n\t);\r\n\tconst derived = new Uint8Array(derivedBits);\r\n\tif (derived.byteLength !== expected.byteLength) return false;\r\n\tlet diff = 0;\r\n\tfor (let i = 0; i < derived.byteLength; i++) diff |= derived[i] ^ expected[i];\r\n\treturn diff === 0;\r\n}\r\n\r\n// \u5DE5\u5177\uFF1APBKDF2-SHA256 \u7522\u751F\u96DC\u6E4A\uFF08\u5132\u5B58\u683C\u5F0F\uFF1Apbkdf2$<iterations>$<saltBase64>$<hashBase64>\uFF09\r\nexport async function hashPasswordPBKDF2(password, iterations = 100000, keyLen = 32) {\r\n\tconst salt = crypto.getRandomValues(new Uint8Array(16));\r\n\tconst enc = new TextEncoder();\r\n\tconst keyMaterial = await crypto.subtle.importKey(\r\n\t\t\"raw\",\r\n\t\tenc.encode(password),\r\n\t\t{ name: \"PBKDF2\" },\r\n\t\tfalse,\r\n\t\t[\"deriveBits\"]\r\n\t);\r\n\tconst derivedBits = await crypto.subtle.deriveBits(\r\n\t\t{ name: \"PBKDF2\", hash: \"SHA-256\", salt, iterations },\r\n\t\tkeyMaterial,\r\n\t\tkeyLen * 8\r\n\t);\r\n\tconst derived = new Uint8Array(derivedBits);\r\n\tconst b64 = (u8) => btoa(String.fromCharCode(...u8));\r\n\treturn `pbkdf2${\"$\"}${iterations}${\"$\"}${b64(salt)}${\"$\"}${b64(derived)}`;\r\n}\r\n\r\n// \u5DE5\u5177\uFF1A\u96A8\u6A5F Session Id\uFF0832 bytes base64\uFF09\r\nexport function generateSessionId() {\r\n\tconst bytes = crypto.getRandomValues(new Uint8Array(32));\r\n\treturn btoa(String.fromCharCode(...bytes)).replaceAll(\"=\", \"\").replaceAll(\"+\", \"-\").replaceAll(\"/\", \"_\");\r\n}\r\n\r\n// CORS\uFF1A\u5141\u8A31\u7279\u5B9A\u4F86\u6E90\uFF08pages.dev \u8207\u4E3B\u7AD9\uFF09\uFF0C\u56DE\u50B3\u6A19\u982D\r\nexport function getCorsHeadersForRequest(request, env) {\r\n\tconst origin = request.headers.get(\"Origin\") || \"\";\r\n\tif (!origin) return {};\r\n\ttry {\r\n\t\tconst o = new URL(origin);\r\n\t\tconst host = o.hostname || \"\";\r\n\t\tif (host.endsWith(\".pages.dev\") || host.endsWith(\"horgoscpa.com\")) {\r\n\t\t\treturn {\r\n\t\t\t\t\"Access-Control-Allow-Origin\": origin,\r\n\t\t\t\t\"Access-Control-Allow-Credentials\": \"true\",\r\n\t\t\t\t\"Vary\": \"Origin\",\r\n\t\t\t};\r\n\t\t}\r\n\t} catch (_) {}\r\n\treturn {};\r\n}\r\n\r\nexport function corsPreflightResponse(request, env) {\r\n\tconst headers = {\r\n\t\t...getCorsHeadersForRequest(request, env),\r\n\t\t\"Access-Control-Allow-Methods\": \"GET,POST,OPTIONS\",\r\n\t\t\"Access-Control-Allow-Headers\": request.headers.get(\"Access-Control-Request-Headers\") || \"Content-Type, X-Request-Id\",\r\n\t\t\"Access-Control-Max-Age\": \"600\",\r\n\t};\r\n\treturn new Response(null, { status: 204, headers });\r\n}\r\n\r\n// Cookie \u8B80\u53D6\r\nexport function getCookie(request, name) {\r\n\tconst raw = request.headers.get(\"Cookie\") || \"\";\r\n\tconst parts = raw.split(\";\");\r\n\tfor (const p of parts) {\r\n\t\tconst [k, ...v] = p.trim().split(\"=\");\r\n\t\tif (k === name) return v.join(\"=\");\r\n\t}\r\n\treturn null;\r\n}\r\n\r\n// \u53D6\u5F97\u76EE\u524D\u6703\u8A71\u7684\u4F7F\u7528\u8005\uFF08\u82E5\u7121\u6216\u904E\u671F\uFF0C\u56DE null\uFF09\r\nexport async function getSessionUser(request, env) {\r\n\tconst cookieName = String(env.SESSION_COOKIE_NAME || \"session\");\r\n\tconst sessionId = getCookie(request, cookieName);\r\n\tif (!sessionId || !env.DATABASE) return null;\r\n\tconst row = await env.DATABASE.prepare(\r\n\t\t\"SELECT s.id as session_id, s.user_id, s.expires_at, u.username, u.name, u.email, u.is_admin FROM sessions s JOIN Users u ON u.user_id = s.user_id WHERE s.id = ? LIMIT 1\"\r\n\t).bind(sessionId).first();\r\n\tif (!row) return null;\r\n\tconst exp = Date.parse(row.expires_at);\r\n\tif (Number.isNaN(exp) || exp <= Date.now()) return null;\r\n\treturn row;\r\n}\r\n\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest, verifyPasswordPBKDF2, generateSessionId, getSessionUser } from \"./utils.js\";\r\n\r\nexport async function handleLogin(request, env, requestId) {\r\n\tif (request.method.toUpperCase() !== \"POST\") {\r\n\t\treturn jsonResponse(405, { ok: false, code: \"METHOD_NOT_ALLOWED\", message: \"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta: { requestId } }, getCorsHeadersForRequest(request, env));\r\n\t}\r\n\tlet payload;\r\n\ttry {\r\n\t\tpayload = await request.json();\r\n\t} catch (_) {\r\n\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, getCorsHeadersForRequest(request, env));\r\n\t}\r\n\tconst username = (payload?.username || \"\").trim().toLowerCase();\r\n\tconst password = payload?.password || \"\";\r\n\tconst errors = [];\r\n\tif (!username) errors.push({ field: \"username\", message: \"\u5FC5\u586B\" });\r\n\tif (!password) errors.push({ field: \"password\", message: \"\u5FC5\u586B\" });\r\n\tif (errors.length > 0) {\r\n\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, getCorsHeadersForRequest(request, env));\r\n\t}\r\n\r\n\tif (!env.DATABASE) {\r\n\t\treturn jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u8CC7\u6599\u5EAB\u672A\u7D81\u5B9A\", meta: { requestId } }, getCorsHeadersForRequest(request, env));\r\n\t}\r\n\r\n\ttry {\r\n\t\t// \u8B80\u53D6\u4F7F\u7528\u8005\r\n\t\tconst userRow = await env.DATABASE.prepare(\r\n\t\t\t\"SELECT user_id, username, password_hash, name, email, is_admin, is_deleted FROM Users WHERE LOWER(username) = ? LIMIT 1\"\r\n\t\t).bind(username).first();\r\n\r\n\t\t// \u907F\u514D\u6D29\u6F0F\u5E33\u865F\u5B58\u5728\u8207\u5426\r\n\t\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\t\tconst unauthorized = () => jsonResponse(401, { ok: false, code: \"UNAUTHORIZED\", message: \"\u5E33\u865F\u6216\u5BC6\u78BC\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\r\n\r\n\t\tif (!userRow || userRow.is_deleted === 1) {\r\n\t\t\treturn unauthorized();\r\n\t\t}\r\n\r\n\t\t// \u5BC6\u78BC\u9A57\u8B49\r\n\t\tconst hash = userRow.password_hash || \"\";\r\n\t\tconst passOk = await verifyPasswordPBKDF2(password, hash);\r\n\t\tif (!passOk) {\r\n\t\t\treturn unauthorized();\r\n\t\t}\r\n\r\n\t\t// \u6210\u529F\uFF1A\u66F4\u65B0 last_login\r\n\t\tawait env.DATABASE.prepare(\r\n\t\t\t\"UPDATE Users SET last_login = ? WHERE user_id = ?\"\r\n\t\t).bind(new Date().toISOString(), userRow.user_id).run();\r\n\r\n\t\t// \u5EFA\u7ACB\u6703\u8A71\r\n\t\tconst sessionId = generateSessionId();\r\n\t\tconst ttlSec = parseInt(env.SESSION_TTL_SECONDS || \"2592000\", 10);\r\n\t\tconst createdAt = new Date();\r\n\t\tconst expiresAt = new Date(createdAt.getTime() + ttlSec * 1000);\r\n\t\tawait env.DATABASE.prepare(\r\n\t\t\t\"INSERT INTO sessions (id, user_id, created_at, expires_at, meta_json) VALUES (?, ?, ?, ?, ?)\"\r\n\t\t).bind(sessionId, String(userRow.user_id), createdAt.toISOString(), expiresAt.toISOString(), JSON.stringify({ ua: request.headers.get(\"User-Agent\") || \"\" })).run();\r\n\r\n\t\t// \u8A2D\u5B9A Cookie\r\n\t\tconst cookieName = String(env.SESSION_COOKIE_NAME || \"session\");\r\n\t\tconst cookie = [\r\n\t\t\t`${cookieName}=${sessionId}`,\r\n\t\t\t\"Domain=horgoscpa.com\",\r\n\t\t\t\"Path=/\",\r\n\t\t\t\"HttpOnly\",\r\n\t\t\t\"Secure\",\r\n\t\t\t\"SameSite=Lax\",\r\n\t\t\t`Max-Age=${ttlSec}`,\r\n\t\t].join(\"; \");\r\n\r\n\t\tconst data = {\r\n\t\t\tuserId: String(userRow.user_id),\r\n\t\t\tusername: userRow.username,\r\n\t\t\tname: userRow.name,\r\n\t\t\temail: userRow.email,\r\n\t\t\tisAdmin: userRow.is_admin === 1,\r\n\t\t};\r\n\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u6210\u529F\", data, meta: { requestId } }, { \"Set-Cookie\": cookie, ...corsHeaders });\r\n\t} catch (err) {\r\n\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: \"/internal/api/v1/auth/login\", err: String(err) }));\r\n\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\treturn jsonResponse(500, body, getCorsHeadersForRequest(request, env));\r\n\t}\r\n}\r\n\r\nexport async function handleAuthMe(request, env, requestId) {\r\n\tif (request.method.toUpperCase() !== \"GET\") {\r\n\t\treturn jsonResponse(405, { ok: false, code: \"METHOD_NOT_ALLOWED\", message: \"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta: { requestId } }, getCorsHeadersForRequest(request, env));\r\n\t}\r\n\ttry {\r\n\t\tconst row = await getSessionUser(request, env);\r\n\t\tif (!row) {\r\n\t\t\treturn jsonResponse(401, { ok: false, code: \"UNAUTHORIZED\", message: \"\u672A\u767B\u5165\", meta: { requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t}\r\n\t\tconst data = {\r\n\t\t\tuserId: String(row.user_id),\r\n\t\t\tusername: row.username,\r\n\t\t\tname: row.name,\r\n\t\t\temail: row.email,\r\n\t\t\tisAdmin: row.is_admin === 1,\r\n\t\t};\r\n\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u6210\u529F\", data, meta: { requestId } }, getCorsHeadersForRequest(request, env));\r\n\t} catch (err) {\r\n\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: \"/internal/api/v1/auth/me\", err: String(err) }));\r\n\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\treturn jsonResponse(500, body, getCorsHeadersForRequest(request, env));\r\n\t}\r\n}\r\n\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\n\nexport async function handleClients(request, env, me, requestId, url) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\tconst method = request.method.toUpperCase();\n\t\n\t// \uD83D\uDD0D \u8C03\u8BD5\u65E5\u5FD7\uFF1A\u663E\u793A\u6536\u5230\u7684\u8DEF\u5F84\n\tconsole.log(`[CLIENTS.JS] \u6536\u5230\u8ACB\u6C42: ${method} ${url.pathname}`);\n\t\n\t// \u2B50 \u8DEF\u7531\u4F18\u5148\u7EA7 1: GET /api/v1/clients/:clientId/services/:serviceId/items\n\tconst matchItems = url.pathname.match(/^\\/internal\\/api\\/v1\\/clients\\/([^\\/]+)\\/services\\/(\\d+)\\/items$/);\n\tconsole.log(`[CLIENTS.JS] \u8DEF\u75311\u5339\u914D\u7D50\u679C (items):`, matchItems);\n\tif (method === \"GET\" && matchItems) {\n\t\tconst clientId = matchItems[1];\n\t\tconst serviceId = parseInt(matchItems[2]);\n\t\t\n\t\ttry {\n\t\t\tconst client = await env.DATABASE.prepare(\n\t\t\t\t`SELECT client_id FROM Clients WHERE client_id = ? AND is_deleted = 0`\n\t\t\t).bind(clientId).first();\n\t\t\t\n\t\t\tif (!client) {\n\t\t\t\treturn jsonResponse(404, {\n\t\t\t\t\tok: false,\n\t\t\t\t\tcode: \"NOT_FOUND\",\n\t\t\t\t\tmessage: \"\u5BA2\u6236\u4E0D\u5B58\u5728\",\n\t\t\t\t\tmeta: { requestId }\n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\tconst items = await env.DATABASE.prepare(\n\t\t\t\t`SELECT item_id, item_name, item_code, description, sort_order\n\t\t\t\t FROM ServiceItems\n\t\t\t\t WHERE service_id = ? AND is_active = 1\n\t\t\t\t ORDER BY sort_order ASC, item_id ASC`\n\t\t\t).bind(serviceId).all();\n\t\t\t\n\t\t\tconst data = items.results.map(item => ({\n\t\t\t\titem_id: item.item_id,\n\t\t\t\titem_name: item.item_name,\n\t\t\t\titem_code: item.item_code,\n\t\t\t\tdescription: item.description || \"\"\n\t\t\t}));\n\t\t\t\n\t\t\treturn jsonResponse(200, {\n\t\t\t\tok: true,\n\t\t\t\tcode: \"SUCCESS\",\n\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\",\n\t\t\t\tdata,\n\t\t\t\tmeta: { requestId }\n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\t\n\t// \u2B50 \u8DEF\u7531\u4F18\u5148\u7EA7 2: GET /api/v1/clients/:clientId/services\n\tconst matchServices = url.pathname.match(/^\\/internal\\/api\\/v1\\/clients\\/([^\\/]+)\\/services$/);\n\tconsole.log(`[CLIENTS.JS] \u8DEF\u75312\u5339\u914D\u7D50\u679C (services):`, matchServices);\n\tif (method === \"GET\" && matchServices) {\n\t\tconst clientId = matchServices[1];\n\t\t\n\t\tconsole.log('[API DEBUG] \u670D\u52D9\u9805\u76EE\u8DEF\u7531\u5339\u914D\uFF01clientId:', clientId);\n\t\t\n\t\ttry {\n\t\t\tconst client = await env.DATABASE.prepare(\n\t\t\t\t`SELECT client_id FROM Clients WHERE client_id = ? AND is_deleted = 0`\n\t\t\t).bind(clientId).first();\n\t\t\t\n\t\t\tif (!client) {\n\t\t\t\treturn jsonResponse(404, {\n\t\t\t\t\tok: false,\n\t\t\t\t\tcode: \"NOT_FOUND\",\n\t\t\t\t\tmessage: \"\u5BA2\u6236\u4E0D\u5B58\u5728\",\n\t\t\t\t\tmeta: { requestId }\n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\tconst clientServices = await env.DATABASE.prepare(\n\t\t\t\t`SELECT DISTINCT cs.service_id\n\t\t\t\t FROM ClientServices cs\n\t\t\t\t WHERE cs.client_id = ? AND cs.is_deleted = 0 AND cs.service_id IS NOT NULL`\n\t\t\t).bind(clientId).all();\n\t\t\t\n\t\t\tconsole.log('[API DEBUG] ClientServices \u67E5\u8A62\u7D50\u679C:', clientServices.results);\n\t\t\t\n\t\t\tlet services;\n\t\t\t\n\t\t\tif (clientServices.results && clientServices.results.length > 0) {\n\t\t\t\tconst serviceIds = clientServices.results.map(r => r.service_id);\n\t\t\t\tconst placeholders = serviceIds.map(() => '?').join(',');\n\t\t\t\t\n\t\t\t\tconsole.log('[API DEBUG] \u5BA2\u6236\u6709\u6307\u5B9A\u670D\u52D9\uFF0CserviceIds:', serviceIds);\n\t\t\t\t\n\t\t\t\tservices = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT service_id, service_name, service_code, description\n\t\t\t\t\t FROM Services\n\t\t\t\t\t WHERE service_id IN (${placeholders}) AND is_active = 1\n\t\t\t\t\t ORDER BY sort_order ASC, service_id ASC`\n\t\t\t\t).bind(...serviceIds).all();\n\t\t\t} else {\n\t\t\t\tconsole.log('[API DEBUG] \u5BA2\u6236\u6C92\u6709\u6307\u5B9A\u670D\u52D9\uFF0C\u8FD4\u56DE\u6240\u6709\u53EF\u7528\u670D\u52D9');\n\t\t\t\tservices = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT service_id, service_name, service_code, description\n\t\t\t\t\t FROM Services\n\t\t\t\t\t WHERE is_active = 1\n\t\t\t\t\t ORDER BY sort_order ASC, service_id ASC`\n\t\t\t\t).all();\n\t\t\t}\n\t\t\t\n\t\t\tconst data = services.results.map(service => ({\n\t\t\t\tservice_id: service.service_id,\n\t\t\t\tservice_name: service.service_name,\n\t\t\t\tservice_code: service.service_code,\n\t\t\t\tdescription: service.description || \"\"\n\t\t\t}));\n\t\t\t\n\t\t\tconsole.log('[API DEBUG] \u6700\u7D42\u8FD4\u56DE\u670D\u52D9\u5217\u8868:', data);\n\t\t\t\n\t\t\treturn jsonResponse(200, {\n\t\t\t\tok: true,\n\t\t\t\tcode: \"SUCCESS\",\n\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\",\n\t\t\t\tdata,\n\t\t\t\tmeta: { requestId }\n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\t\n\t// \u2B50 \u8DEF\u7531\u4F18\u5148\u7EA7 3: GET /api/v1/clients/:id - \u5BA2\u6236\u8A73\u60C5\n\tconst matchSingle = url.pathname.match(/\\/clients\\/[^\\/]+$/);\n\tconsole.log(`[CLIENTS.JS] \u8DEF\u75313\u5339\u914D\u7D50\u679C (single):`, matchSingle);\n\tif (method === \"GET\" && matchSingle) {\n\t\tconst clientId = url.pathname.split(\"/\").pop();\n\t\ttry {\n\t\t\tconst row = await env.DATABASE.prepare(\n\t\t\t\t`SELECT c.client_id, c.company_name, c.tax_registration_number, c.phone, c.email, \n\t\t\t\t        c.client_notes, c.payment_notes, c.created_at, c.updated_at,\n\t\t\t\t        u.user_id as assignee_id, u.name as assignee_name,\n\t\t\t\t        GROUP_CONCAT(t.tag_id || ':' || t.tag_name || ':' || COALESCE(t.tag_color, ''), '|') as tags\n\t\t\t\t FROM Clients c\n\t\t\t\t LEFT JOIN Users u ON u.user_id = c.assignee_user_id\n\t\t\t\t LEFT JOIN ClientTagAssignments a ON a.client_id = c.client_id\n\t\t\t\t LEFT JOIN CustomerTags t ON t.tag_id = a.tag_id\n\t\t\t\t WHERE c.client_id = ? AND c.is_deleted = 0\n\t\t\t\t GROUP BY c.client_id`\n\t\t\t).bind(clientId).first();\n\t\t\t\n\t\t\tif (!row) {\n\t\t\t\treturn jsonResponse(404, { \n\t\t\t\t\tok: false, \n\t\t\t\t\tcode: \"NOT_FOUND\", \n\t\t\t\t\tmessage: \"\u5BA2\u6236\u4E0D\u5B58\u5728\", \n\t\t\t\t\tmeta: { requestId } \n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u89E3\u6790\u6A19\u7C64\n\t\t\tconst tags = [];\n\t\t\tif (row.tags) {\n\t\t\t\tconst tagParts = String(row.tags).split('|');\n\t\t\t\ttagParts.forEach(part => {\n\t\t\t\t\tconst [id, name, color] = part.split(':');\n\t\t\t\t\tif (id && name) {\n\t\t\t\t\t\ttags.push({\n\t\t\t\t\t\t\ttag_id: parseInt(id),\n\t\t\t\t\t\t\ttag_name: name,\n\t\t\t\t\t\t\ttag_color: color || null\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\t\n\t\t\t// \u67E5\u8BE2\u5BA2\u6237\u670D\u52A1\u5217\u8868\uFF08\u65B0\u7ED3\u6784\uFF09\n\t\t\tconst servicesRows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT cs.client_service_id, cs.service_id, cs.status, cs.service_cycle,\n\t\t\t\t        cs.task_template_id, cs.auto_generate_tasks,\n\t\t\t\t        cs.start_date, cs.end_date, cs.service_notes,\n\t\t\t\t        s.service_name, s.service_code\n\t\t\t\t FROM ClientServices cs\n\t\t\t\t LEFT JOIN Services s ON s.service_id = cs.service_id\n\t\t\t\t WHERE cs.client_id = ? AND cs.is_deleted = 0\n\t\t\t\t ORDER BY cs.client_service_id ASC`\n\t\t\t).bind(clientId).all();\n\t\t\t\n\t\t\t// \u4E3A\u6BCF\u4E2A\u670D\u52A1\u67E5\u8BE2\u6536\u8D39\u660E\u7EC6\u548C\u5E74\u5EA6\u603B\u989D\n\t\t\tconst services = await Promise.all((servicesRows?.results || []).map(async (svc) => {\n\t\t\t\tconst billingRows = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT billing_month, billing_amount, payment_due_days, notes\n\t\t\t\t\t FROM ServiceBillingSchedule\n\t\t\t\t\t WHERE client_service_id = ?\n\t\t\t\t\t ORDER BY billing_month ASC`\n\t\t\t\t).bind(svc.client_service_id).all();\n\t\t\t\t\n\t\t\t\tconst billing_schedule = (billingRows?.results || []).map(b => ({\n\t\t\t\t\tbilling_month: b.billing_month,\n\t\t\t\t\tbilling_amount: Number(b.billing_amount || 0),\n\t\t\t\t\tpayment_due_days: Number(b.payment_due_days || 30),\n\t\t\t\t\tnotes: b.notes || \"\"\n\t\t\t\t}));\n\t\t\t\t\n\t\t\t\tconst year_total = billing_schedule.reduce((sum, b) => sum + b.billing_amount, 0);\n\t\t\t\t\n\t\t\t\treturn {\n\t\t\t\t\tclient_service_id: svc.client_service_id,\n\t\t\t\t\tservice_id: svc.service_id,\n\t\t\t\t\tservice_name: svc.service_name || \"\",\n\t\t\t\t\tservice_code: svc.service_code || \"\",\n\t\t\t\t\tstatus: svc.status || \"active\",\n\t\t\t\t\tservice_cycle: svc.service_cycle || \"monthly\",\n\t\t\t\t\ttask_template_id: svc.task_template_id || null,\n\t\t\t\t\tauto_generate_tasks: Boolean(svc.auto_generate_tasks),\n\t\t\t\t\tstart_date: svc.start_date || null,\n\t\t\t\t\tend_date: svc.end_date || null,\n\t\t\t\t\tservice_notes: svc.service_notes || \"\",\n\t\t\t\t\tbilling_schedule: billing_schedule,\n\t\t\t\t\tyear_total: year_total\n\t\t\t\t};\n\t\t\t}));\n\t\t\t\n\t\t\tconst data = {\n\t\t\t\tclientId: row.client_id,\n\t\t\t\tcompanyName: row.company_name,\n\t\t\t\ttaxId: row.tax_registration_number,\n\t\t\t\tassigneeUserId: row.assignee_id,\n\t\t\t\tassigneeName: row.assignee_name || \"\",\n\t\t\t\tphone: row.phone || \"\",\n\t\t\t\temail: row.email || \"\",\n\t\t\t\tclientNotes: row.client_notes || \"\",\n\t\t\t\tpaymentNotes: row.payment_notes || \"\",\n\t\t\t\ttags: tags,\n\t\t\t\tservices: services,\n\t\t\t\tcreatedAt: row.created_at,\n\t\t\t\tupdatedAt: row.updated_at\n\t\t\t};\n\t\t\t\n\t\t\treturn jsonResponse(200, { \n\t\t\t\tok: true, \n\t\t\t\tcode: \"SUCCESS\", \n\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\", \n\t\t\t\tdata, \n\t\t\t\tmeta: { requestId } \n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\t\n\t// \u2B50 \u8DEF\u7531\u4F18\u5148\u7EA7 4: GET /api/v1/clients - \u5BA2\u6236\u5217\u8868\uFF08\u5FC5\u987B\u660E\u786E\u68C0\u67E5\u8DEF\u5F84\uFF09\n\tconst matchList = (url.pathname === \"/internal/api/v1/clients\");\n\tconsole.log(`[CLIENTS.JS] \u8DEF\u75314\u5339\u914D\u7D50\u679C (list):`, matchList, 'pathname:', url.pathname);\n\tif (method === \"GET\" && matchList) {\n\t\tconst params = url.searchParams;\n\t\tconst page = Math.max(1, parseInt(params.get(\"page\") || \"1\", 10));\n\t\tconst perPage = Math.min(100, Math.max(1, parseInt(params.get(\"perPage\") || \"50\", 10)));\n\t\tconst offset = (page - 1) * perPage;\n\t\tconst companyName = (params.get(\"company_name\") || params.get(\"q\") || \"\").trim();\n\t\ttry {\n\t\t\tconst where = [\"c.is_deleted = 0\"];\n\t\t\tconst binds = [];\n\t\t\tif (companyName) {\n\t\t\t\twhere.push(\"c.company_name LIKE ?\");\n\t\t\t\tbinds.push(`%${companyName}%`);\n\t\t\t}\n\t\t\tconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\n\t\t\tconst countRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT COUNT(1) as total FROM Clients c ${whereSql}`\n\t\t\t).bind(...binds).first();\n\t\t\tconst total = Number(countRow?.total || 0);\n\t\t\tconst rows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT c.client_id, c.company_name, c.tax_registration_number, c.phone, c.email, c.created_at, \n\t\t\t\t        u.name as assignee_name,\n\t\t\t\t        GROUP_CONCAT(t.tag_name, ',') as tags\n\t\t\t\t FROM Clients c\n\t\t\t\t LEFT JOIN Users u ON u.user_id = c.assignee_user_id\n\t\t\t\t LEFT JOIN ClientTagAssignments a ON a.client_id = c.client_id\n\t\t\t\t LEFT JOIN CustomerTags t ON t.tag_id = a.tag_id\n\t\t\t\t ${whereSql}\n\t\t\t\t GROUP BY c.client_id\n\t\t\t\t ORDER BY c.created_at DESC\n\t\t\t\t LIMIT ? OFFSET ?`\n\t\t\t).bind(...binds, perPage, offset).all();\n\t\t\tconst data = (rows?.results || []).map((r) => ({\n\t\t\t\tclientId: r.client_id,\n\t\t\t\tcompanyName: r.company_name,\n\t\t\t\ttaxId: r.tax_registration_number,\n\t\t\t\tassigneeName: r.assignee_name || \"\",\n\t\t\t\ttags: (r.tags ? String(r.tags).split(\",\").filter(Boolean) : []),\n\t\t\t\tphone: r.phone || \"\",\n\t\t\t\temail: r.email || \"\",\n\t\t\t\tcreatedAt: r.created_at,\n\t\t\t}));\n\t\t\tconst meta = { requestId, page, perPage, total, hasNext: offset + perPage < total };\n\t\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u6210\u529F\", data, meta }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\n\t// POST /api/v1/clients - \u65B0\u589E\u5BA2\u6237\uFF08\u5FC5\u987B\u5728/clients/:id/services\u4E4B\u524D\u68C0\u67E5\uFF0C\u5E76\u786E\u4FDD\u4E0D\u5339\u914D\u5B50\u8DEF\u5F84\uFF09\n\tconsole.log(`[CLIENTS.JS] \u6AA2\u67E5\u5275\u5EFA\u5BA2\u6236\u8DEF\u7531: ${method} === \"POST\" && ${url.pathname} === \"/internal/api/v1/clients\" => ${method === \"POST\" && url.pathname === \"/internal/api/v1/clients\"}`);\n\tif (method === \"POST\" && url.pathname === \"/internal/api/v1/clients\") {\n\t\tconsole.log('[CLIENTS.JS] \u2705 \u5339\u914D\u5275\u5EFA\u5BA2\u6236\u8DEF\u7531');\n\t\tlet body;\n\t\ttry {\n\t\t\tbody = await request.json();\n\t\t} catch (_) {\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t\tconst errors = [];\n\t\tconst clientId = String(body?.client_id || \"\").trim();\n\t\tconst companyName = String(body?.company_name || \"\").trim();\n\t\tconst assigneeUserId = Number(body?.assignee_user_id || 0);\n\t\tconst phone = (body?.phone || \"\").trim();\n\t\tconst email = (body?.email || \"\").trim();\n\t\tconst clientNotes = (body?.client_notes || \"\").trim();\n\t\tconst paymentNotes = (body?.payment_notes || \"\").trim();\n\t\tconst tagIds = Array.isArray(body?.tag_ids) ? body.tag_ids.map((x) => Number(x)).filter((n) => Number.isFinite(n)) : [];\n\n\t\tif (!/^\\d{8}$/.test(clientId)) errors.push({ field: \"client_id\", message: \"\u5FC5\u586B\u4E14\u9808\u70BA8\u4F4D\u6578\u5B57\" });\n\t\tif (companyName.length < 1 || companyName.length > 100) errors.push({ field: \"company_name\", message: \"\u9577\u5EA6\u9700 1\u2013100\" });\n\t\tif (!Number.isInteger(assigneeUserId) || assigneeUserId <= 0) errors.push({ field: \"assignee_user_id\", message: \"\u5FC5\u586B\" });\n\t\tif (email && !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) errors.push({ field: \"email\", message: \"Email \u683C\u5F0F\u932F\u8AA4\" });\n\t\tif (phone && !/^[-+()\\s0-9]{6,}$/.test(phone)) errors.push({ field: \"phone\", message: \"\u96FB\u8A71\u683C\u5F0F\u932F\u8AA4\" });\n\t\tif (errors.length) {\n\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, corsHeaders);\n\t\t}\n\t\ttry {\n\t\t\t// \u6AA2\u67E5\u552F\u4E00/\u5B58\u5728\n\t\t\tconst dup = await env.DATABASE.prepare(\"SELECT 1 FROM Clients WHERE client_id = ? AND is_deleted = 0 LIMIT 1\").bind(clientId).first();\n\t\t\tif (dup) {\n\t\t\t\treturn jsonResponse(409, { ok: false, code: \"CONFLICT\", message: \"\u5BA2\u6236\u5DF2\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\tconst assExist = await env.DATABASE.prepare(\"SELECT 1 FROM Users WHERE user_id = ? AND is_deleted = 0 LIMIT 1\").bind(assigneeUserId).first();\n\t\t\tif (!assExist) {\n\t\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8CA0\u8CAC\u4EBA\u4E0D\u5B58\u5728\", errors: [{ field: \"assignee_user_id\", message: \"\u4E0D\u5B58\u5728\" }], meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\tif (tagIds.length > 0) {\n\t\t\t\tconst placeholders = tagIds.map(() => \"?\").join(\",\");\n\t\t\t\tconst row = await env.DATABASE.prepare(`SELECT COUNT(1) as cnt FROM CustomerTags WHERE tag_id IN (${placeholders})`).bind(...tagIds).first();\n\t\t\t\tif (Number(row?.cnt || 0) !== tagIds.length) {\n\t\t\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u6A19\u7C64\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst now = new Date().toISOString();\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\"INSERT INTO Clients (client_id, company_name, assignee_user_id, phone, email, client_notes, payment_notes, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\"\n\t\t\t).bind(clientId, companyName, assigneeUserId, phone, email, clientNotes, paymentNotes, now, now).run();\n\t\t\tfor (const tagId of tagIds) {\n\t\t\t\tawait env.DATABASE.prepare(\"INSERT OR IGNORE INTO ClientTagAssignments (client_id, tag_id, assigned_at) VALUES (?, ?, ?)\").bind(clientId, tagId, now).run();\n\t\t\t}\n\t\t\tconst data = { clientId, companyName, assigneeUserId, phone, email, clientNotes, paymentNotes, tags: tagIds };\n\t\t\treturn jsonResponse(201, { ok: true, code: \"CREATED\", message: \"\u5DF2\u5EFA\u7ACB\", data, meta: { requestId } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\n\t// PUT /api/v1/clients/:id - \u7DE8\u8F2F\u5BA2\u6236\n\tif (method === \"PUT\" && url.pathname.match(/\\/clients\\/[^\\/]+$/)) {\n\t\tconst clientId = url.pathname.split(\"/\").pop();\n\t\tlet body;\n\t\ttry {\n\t\t\tbody = await request.json();\n\t\t} catch (_) {\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tconst errors = [];\n\t\tconst companyName = String(body?.company_name || \"\").trim();\n\t\tconst assigneeUserId = Number(body?.assignee_user_id || 0);\n\t\tconst phone = (body?.phone || \"\").trim();\n\t\tconst email = (body?.email || \"\").trim();\n\t\tconst clientNotes = (body?.client_notes || \"\").trim();\n\t\tconst paymentNotes = (body?.payment_notes || \"\").trim();\n\t\tconst tagIds = Array.isArray(body?.tag_ids) ? body.tag_ids.map((x) => Number(x)).filter((n) => Number.isFinite(n)) : [];\n\n\t\t// \u9A57\u8B49\n\t\tif (companyName.length < 1 || companyName.length > 100) errors.push({ field: \"company_name\", message: \"\u9577\u5EA6\u9700 1\u2013100\" });\n\t\tif (!Number.isInteger(assigneeUserId) || assigneeUserId <= 0) errors.push({ field: \"assignee_user_id\", message: \"\u5FC5\u586B\" });\n\t\tif (email && !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) errors.push({ field: \"email\", message: \"Email \u683C\u5F0F\u932F\u8AA4\" });\n\t\tif (phone && !/^[-+()\\s0-9]{6,}$/.test(phone)) errors.push({ field: \"phone\", message: \"\u96FB\u8A71\u683C\u5F0F\u932F\u8AA4\" });\n\t\tif (errors.length) {\n\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, corsHeaders);\n\t\t}\n\n\t\ttry {\n\t\t\t// \u6AA2\u67E5\u5BA2\u6236\u662F\u5426\u5B58\u5728\n\t\t\tconst existing = await env.DATABASE.prepare(\"SELECT 1 FROM Clients WHERE client_id = ? AND is_deleted = 0 LIMIT 1\").bind(clientId).first();\n\t\t\tif (!existing) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u5BA2\u6236\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u6AA2\u67E5\u8CA0\u8CAC\u4EBA\u54E1\u662F\u5426\u5B58\u5728\n\t\t\tconst assExist = await env.DATABASE.prepare(\"SELECT 1 FROM Users WHERE user_id = ? AND is_deleted = 0 LIMIT 1\").bind(assigneeUserId).first();\n\t\t\tif (!assExist) {\n\t\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8CA0\u8CAC\u4EBA\u4E0D\u5B58\u5728\", errors: [{ field: \"assignee_user_id\", message: \"\u4E0D\u5B58\u5728\" }], meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u6AA2\u67E5\u6A19\u7C64\u662F\u5426\u5B58\u5728\n\t\t\tif (tagIds.length > 0) {\n\t\t\t\tconst placeholders = tagIds.map(() => \"?\").join(\",\");\n\t\t\t\tconst row = await env.DATABASE.prepare(`SELECT COUNT(1) as cnt FROM CustomerTags WHERE tag_id IN (${placeholders})`).bind(...tagIds).first();\n\t\t\t\tif (Number(row?.cnt || 0) !== tagIds.length) {\n\t\t\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u6A19\u7C64\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tconst now = new Date().toISOString();\n\t\t\t\n\t\t\t// \u66F4\u65B0\u5BA2\u6236\u8CC7\u6599\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\"UPDATE Clients SET company_name = ?, assignee_user_id = ?, phone = ?, email = ?, client_notes = ?, payment_notes = ?, updated_at = ? WHERE client_id = ?\"\n\t\t\t).bind(companyName, assigneeUserId, phone, email, clientNotes, paymentNotes, now, clientId).run();\n\t\t\t\n\t\t\t// \u522A\u9664\u820A\u7684\u6A19\u7C64\u95DC\u806F\n\t\t\tawait env.DATABASE.prepare(\"DELETE FROM ClientTagAssignments WHERE client_id = ?\").bind(clientId).run();\n\t\t\t\n\t\t\t// \u65B0\u589E\u65B0\u7684\u6A19\u7C64\u95DC\u806F\n\t\t\tfor (const tagId of tagIds) {\n\t\t\t\tawait env.DATABASE.prepare(\"INSERT INTO ClientTagAssignments (client_id, tag_id, assigned_at) VALUES (?, ?, ?)\").bind(clientId, tagId, now).run();\n\t\t\t}\n\t\t\t\n\t\t\tconst data = { clientId, companyName, assigneeUserId, phone, email, clientNotes, paymentNotes, tags: tagIds, updatedAt: now };\n\t\t\treturn jsonResponse(200, { ok: true, code: \"SUCCESS\", message: \"\u5DF2\u66F4\u65B0\", data, meta: { requestId } }, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\n\t// DELETE /api/v1/clients/:id - \u522A\u9664\u5BA2\u6236\uFF08\u8EDF\u522A\u9664\uFF09\n\tif (method === \"DELETE\" && url.pathname.match(/\\/clients\\/[^\\/]+$/)) {\n\t\tconst clientId = url.pathname.split(\"/\").pop();\n\t\ttry {\n\t\t\t// \u6AA2\u67E5\u5BA2\u6236\u662F\u5426\u5B58\u5728\n\t\t\tconst existing = await env.DATABASE.prepare(\"SELECT 1 FROM Clients WHERE client_id = ? AND is_deleted = 0 LIMIT 1\").bind(clientId).first();\n\t\t\tif (!existing) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u5BA2\u6236\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\tconst now = new Date().toISOString();\n\t\t\t\n\t\t\t// \u8EDF\u522A\u9664\uFF1A\u8A2D\u7F6E is_deleted = 1\uFF0C\u8A18\u9304 deleted_at \u548C deleted_by\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\"UPDATE Clients SET is_deleted = 1, deleted_at = ?, deleted_by = ? WHERE client_id = ?\"\n\t\t\t).bind(now, me.user_id, clientId).run();\n\t\t\t\n\t\t\treturn jsonResponse(200, { \n\t\t\t\tok: true, \n\t\t\t\tcode: \"SUCCESS\", \n\t\t\t\tmessage: \"\u5DF2\u522A\u9664\", \n\t\t\t\tmeta: { requestId } \n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\n\t// POST /api/v1/clients/batch-assign - \u6279\u91CF\u5206\u914D\u8CA0\u8CAC\u4EBA\uFF08\u50C5\u7BA1\u7406\u54E1\uFF09\n\tif (method === \"POST\" && url.pathname === \"/internal/api/v1/clients/batch-assign\") {\n\t\t// \u6AA2\u67E5\u7BA1\u7406\u54E1\u6B0A\u9650\n\t\tif (!me.is_admin) {\n\t\t\treturn jsonResponse(403, { \n\t\t\t\tok: false, \n\t\t\t\tcode: \"FORBIDDEN\", \n\t\t\t\tmessage: \"\u6B0A\u9650\u4E0D\u8DB3\uFF0C\u50C5\u7BA1\u7406\u54E1\u53EF\u57F7\u884C\", \n\t\t\t\tmeta: { requestId } \n\t\t\t}, corsHeaders);\n\t\t}\n\t\t\n\t\tlet body;\n\t\ttry {\n\t\t\tbody = await request.json();\n\t\t} catch (_) {\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tconst errors = [];\n\t\tconst clientIds = Array.isArray(body?.client_ids) ? body.client_ids : [];\n\t\tconst assigneeUserId = Number(body?.assignee_user_id || 0);\n\t\t\n\t\t// \u9A57\u8B49\n\t\tif (clientIds.length === 0) {\n\t\t\terrors.push({ field: \"client_ids\", message: \"\u8ACB\u9078\u64C7\u81F3\u5C11\u4E00\u500B\u5BA2\u6236\" });\n\t\t}\n\t\tif (clientIds.length > 100) {\n\t\t\terrors.push({ field: \"client_ids\", message: \"\u4E00\u6B21\u6700\u591A\u5206\u914D 100 \u500B\u5BA2\u6236\" });\n\t\t}\n\t\tif (!Number.isInteger(assigneeUserId) || assigneeUserId <= 0) {\n\t\t\terrors.push({ field: \"assignee_user_id\", message: \"\u8ACB\u9078\u64C7\u8CA0\u8CAC\u4EBA\u54E1\" });\n\t\t}\n\t\tif (errors.length) {\n\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\ttry {\n\t\t\t// \u6AA2\u67E5\u8CA0\u8CAC\u4EBA\u54E1\u662F\u5426\u5B58\u5728\n\t\t\tconst assExist = await env.DATABASE.prepare(\"SELECT 1 FROM Users WHERE user_id = ? AND is_deleted = 0 LIMIT 1\").bind(assigneeUserId).first();\n\t\t\tif (!assExist) {\n\t\t\t\treturn jsonResponse(422, { \n\t\t\t\t\tok: false, \n\t\t\t\t\tcode: \"VALIDATION_ERROR\", \n\t\t\t\t\tmessage: \"\u8CA0\u8CAC\u4EBA\u4E0D\u5B58\u5728\", \n\t\t\t\t\terrors: [{ field: \"assignee_user_id\", message: \"\u4E0D\u5B58\u5728\" }], \n\t\t\t\t\tmeta: { requestId } \n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\tconst now = new Date().toISOString();\n\t\t\tconst placeholders = clientIds.map(() => \"?\").join(\",\");\n\t\t\t\n\t\t\t// \u6279\u91CF\u66F4\u65B0\n\t\t\tconst result = await env.DATABASE.prepare(\n\t\t\t\t`UPDATE Clients SET assignee_user_id = ?, updated_at = ? WHERE client_id IN (${placeholders}) AND is_deleted = 0`\n\t\t\t).bind(assigneeUserId, now, ...clientIds).run();\n\t\t\t\n\t\t\tconst updatedCount = result?.meta?.changes || 0;\n\t\t\t\n\t\t\treturn jsonResponse(200, { \n\t\t\t\tok: true, \n\t\t\t\tcode: \"SUCCESS\", \n\t\t\t\tmessage: `\u5DF2\u66F4\u65B0 ${updatedCount} \u500B\u5BA2\u6236`, \n\t\t\t\tdata: { updated_count: updatedCount },\n\t\t\t\tmeta: { requestId } \n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\n\t// ==================== \u5BA2\u6237\u670D\u52A1\u7BA1\u7406 API ====================\n\t\n\t// POST /api/v1/clients/:clientId/services - \u65B0\u589E\u5BA2\u6237\u670D\u52A1\uFF08\u65B0\u7ED3\u6784\uFF09\n\tconst matchAddService = url.pathname.match(/^\\/internal\\/api\\/v1\\/clients\\/([^\\/]+)\\/services$/);\n\tconsole.log(`[CLIENTS.JS] \u6AA2\u67E5\u65B0\u589E\u670D\u52D9\u8DEF\u7531: matchAddService =`, matchAddService, `method = ${method}`);\n\tif (method === \"POST\" && matchAddService) {\n\t\tconsole.log('[CLIENTS.JS] \u2705 \u5339\u914D\u65B0\u589E\u670D\u52D9\u8DEF\u7531');\n\t\tconst clientId = matchAddService[1];\n\t\tlet body;\n\t\ttry {\n\t\t\tbody = await request.json();\n\t\t} catch (_) {\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tconst errors = [];\n\t\tconst serviceId = Number(body?.service_id || 0);\n\t\tconst serviceCycle = String(body?.service_cycle || \"monthly\").trim();\n\t\tconst status = String(body?.status || \"active\").trim();\n\t\tconst taskTemplateId = body?.task_template_id ? Number(body.task_template_id) : null;\n\t\tconst autoGenerateTasks = body?.auto_generate_tasks !== false; // \u9ED8\u8BA4true\n\t\tconst startDate = String(body?.start_date || \"\").trim();\n\t\tconst endDate = String(body?.end_date || \"\").trim();\n\t\tconst serviceNotes = String(body?.service_notes || \"\").trim();\n\t\t\n\t\t// \u9A8C\u8BC1\n\t\tif (!serviceId || serviceId <= 0) {\n\t\t\terrors.push({ field: \"service_id\", message: \"\u8ACB\u9078\u64C7\u670D\u52D9\u9805\u76EE\" });\n\t\t}\n\t\tif (![\"monthly\", \"quarterly\", \"yearly\", \"one-time\"].includes(serviceCycle)) {\n\t\t\terrors.push({ field: \"service_cycle\", message: \"\u670D\u52D9\u9031\u671F\u683C\u5F0F\u932F\u8AA4\" });\n\t\t}\n\t\tif (![\"active\", \"suspended\", \"expired\", \"cancelled\"].includes(status)) {\n\t\t\terrors.push({ field: \"status\", message: \"\u72C0\u614B\u683C\u5F0F\u932F\u8AA4\" });\n\t\t}\n\t\tif (startDate && !/^\\d{4}-\\d{2}-\\d{2}$/.test(startDate)) {\n\t\t\terrors.push({ field: \"start_date\", message: \"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD\" });\n\t\t}\n\t\tif (endDate && !/^\\d{4}-\\d{2}-\\d{2}$/.test(endDate)) {\n\t\t\terrors.push({ field: \"end_date\", message: \"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD\" });\n\t\t}\n\t\tif (errors.length) {\n\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\ttry {\n\t\t\t// \u68C0\u67E5\u5BA2\u6237\u662F\u5426\u5B58\u5728\n\t\t\tconst client = await env.DATABASE.prepare(\n\t\t\t\t\"SELECT client_id FROM Clients WHERE client_id = ? AND is_deleted = 0\"\n\t\t\t).bind(clientId).first();\n\t\t\tif (!client) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u5BA2\u6236\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u68C0\u67E5\u670D\u52A1\u662F\u5426\u5B58\u5728\n\t\t\tconst service = await env.DATABASE.prepare(\n\t\t\t\t\"SELECT service_id FROM Services WHERE service_id = ? AND is_active = 1\"\n\t\t\t).bind(serviceId).first();\n\t\t\tif (!service) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u670D\u52D9\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u63D2\u5165\u5BA2\u6237\u670D\u52A1\uFF08\u65B0\u7ED3\u6784\uFF09\n\t\t\tconst result = await env.DATABASE.prepare(\n\t\t\t\t`INSERT INTO ClientServices (client_id, service_id, status, service_cycle, \n\t\t\t\t task_template_id, auto_generate_tasks, start_date, end_date, service_notes)\n\t\t\t\t VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`\n\t\t\t).bind(clientId, serviceId, status, serviceCycle, taskTemplateId, autoGenerateTasks ? 1 : 0,\n\t\t\t\tstartDate || null, endDate || null, serviceNotes).run();\n\t\t\t\n\t\t\tconst clientServiceId = result?.meta?.last_row_id;\n\t\t\t\n\t\t\treturn jsonResponse(201, {\n\t\t\t\tok: true,\n\t\t\t\tcode: \"CREATED\",\n\t\t\t\tmessage: \"\u670D\u52D9\u5DF2\u65B0\u589E\",\n\t\t\t\tdata: { client_service_id: clientServiceId },\n\t\t\t\tmeta: { requestId }\n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\t\n\t// PUT /api/v1/clients/:clientId/services/:serviceId - \u66F4\u65B0\u5BA2\u6237\u670D\u52A1\uFF08\u65B0\u7ED3\u6784\uFF09\n\tconst matchUpdateService = url.pathname.match(/^\\/internal\\/api\\/v1\\/clients\\/([^\\/]+)\\/services\\/(\\d+)$/);\n\tif (method === \"PUT\" && matchUpdateService) {\n\t\tconst clientId = matchUpdateService[1];\n\t\tconst clientServiceId = Number(matchUpdateService[2]);\n\t\tlet body;\n\t\ttry {\n\t\t\tbody = await request.json();\n\t\t} catch (_) {\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tconst errors = [];\n\t\tconst serviceCycle = String(body?.service_cycle || \"monthly\").trim();\n\t\tconst taskTemplateId = body?.task_template_id ? Number(body.task_template_id) : null;\n\t\tconst autoGenerateTasks = body?.auto_generate_tasks !== false; // \u9ED8\u8BA4true\n\t\tconst startDate = String(body?.start_date || \"\").trim();\n\t\tconst endDate = String(body?.end_date || \"\").trim();\n\t\tconst serviceNotes = String(body?.service_notes || \"\").trim();\n\t\tconst status = String(body?.status || \"active\").trim();\n\t\t\n\t\t// \u9A8C\u8BC1\n\t\tif (![\"monthly\", \"quarterly\", \"yearly\", \"one-time\"].includes(serviceCycle)) {\n\t\t\terrors.push({ field: \"service_cycle\", message: \"\u670D\u52D9\u9031\u671F\u683C\u5F0F\u932F\u8AA4\" });\n\t\t}\n\t\tif (![\"active\", \"suspended\", \"expired\", \"cancelled\"].includes(status)) {\n\t\t\terrors.push({ field: \"status\", message: \"\u72C0\u614B\u683C\u5F0F\u932F\u8AA4\" });\n\t\t}\n\t\tif (errors.length) {\n\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\ttry {\n\t\t\t// \u68C0\u67E5\u5BA2\u6237\u670D\u52A1\u662F\u5426\u5B58\u5728\n\t\t\tconst existing = await env.DATABASE.prepare(\n\t\t\t\t\"SELECT client_service_id FROM ClientServices WHERE client_service_id = ? AND client_id = ? AND is_deleted = 0\"\n\t\t\t).bind(clientServiceId, clientId).first();\n\t\t\tif (!existing) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u5BA2\u6236\u670D\u52D9\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u66F4\u65B0\u5BA2\u6237\u670D\u52A1\uFF08\u65B0\u7ED3\u6784\uFF09\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`UPDATE ClientServices SET service_cycle = ?, task_template_id = ?, auto_generate_tasks = ?,\n\t\t\t\t start_date = ?, end_date = ?, service_notes = ?, status = ?\n\t\t\t\t WHERE client_service_id = ?`\n\t\t\t).bind(serviceCycle, taskTemplateId, autoGenerateTasks ? 1 : 0,\n\t\t\t\tstartDate || null, endDate || null, serviceNotes, status, clientServiceId).run();\n\t\t\t\n\t\t\treturn jsonResponse(200, {\n\t\t\t\tok: true,\n\t\t\t\tcode: \"SUCCESS\",\n\t\t\t\tmessage: \"\u670D\u52D9\u5DF2\u66F4\u65B0\",\n\t\t\t\tdata: { client_service_id: clientServiceId },\n\t\t\t\tmeta: { requestId }\n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\t\n\t// DELETE /api/v1/clients/:clientId/services/:serviceId - \u5220\u9664\u5BA2\u6237\u670D\u52A1\n\tif (method === \"DELETE\" && matchUpdateService) {\n\t\tconst clientId = matchUpdateService[1];\n\t\tconst clientServiceId = Number(matchUpdateService[2]);\n\t\t\n\t\ttry {\n\t\t\t// \u68C0\u67E5\u5BA2\u6237\u670D\u52A1\u662F\u5426\u5B58\u5728\n\t\t\tconst existing = await env.DATABASE.prepare(\n\t\t\t\t\"SELECT client_service_id FROM ClientServices WHERE client_service_id = ? AND client_id = ? AND is_deleted = 0\"\n\t\t\t).bind(clientServiceId, clientId).first();\n\t\t\tif (!existing) {\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u5BA2\u6236\u670D\u52D9\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u8F6F\u5220\u9664\u5BA2\u6237\u670D\u52A1\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\"UPDATE ClientServices SET is_deleted = 1 WHERE client_service_id = ?\"\n\t\t\t).bind(clientServiceId).run();\n\t\t\t\n\t\t\treturn jsonResponse(200, {\n\t\t\t\tok: true,\n\t\t\t\tcode: \"SUCCESS\",\n\t\t\t\tmessage: \"\u670D\u52D9\u5DF2\u522A\u9664\",\n\t\t\t\tmeta: { requestId }\n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\treturn jsonResponse(500, body, corsHeaders);\n\t\t}\n\t}\n\n\treturn jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\n}\n\n\n\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nexport async function handleTasks(request, env, me, requestId, url) {\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\tconst method = request.method.toUpperCase();\r\n\tif (method === \"GET\") {\r\n\t\ttry {\r\n\t\t\tconst params = url.searchParams;\r\n\t\t\tconst page = Math.max(1, parseInt(params.get(\"page\") || \"1\", 10));\r\n\t\t\tconst perPage = Math.min(100, Math.max(1, parseInt(params.get(\"perPage\") || \"20\", 10)));\r\n\t\t\tconst offset = (page - 1) * perPage;\r\n\t\t\tconst q = (params.get(\"q\") || \"\").trim();\r\n\t\t\tconst status = (params.get(\"status\") || \"\").trim();\r\n\t\t\tconst due = (params.get(\"due\") || \"\").trim();\r\n\t\t\tconst where = [\"t.is_deleted = 0\"];\r\n\t\t\tconst binds = [];\r\n\t\t\tif (!me.is_admin) {\r\n\t\t\t\twhere.push(\"t.assignee_user_id = ?\");\r\n\t\t\t\tbinds.push(String(me.user_id));\r\n\t\t\t}\r\n\t\t\tif (q) {\r\n\t\t\t\twhere.push(\"(t.task_name LIKE ? OR c.company_name LIKE ?)\");\r\n\t\t\t\tbinds.push(`%${q}%`, `%${q}%`);\r\n\t\t\t}\r\n\t\t\tif (status && [\"pending\",\"in_progress\",\"completed\",\"cancelled\"].includes(status)) {\r\n\t\t\t\twhere.push(\"t.status = ?\");\r\n\t\t\t\tbinds.push(status);\r\n\t\t\t}\r\n\t\t\tif (due === \"overdue\") {\r\n\t\t\t\twhere.push(\"date(t.due_date) < date('now') AND t.status != 'completed'\");\r\n\t\t\t}\r\n\t\t\tif (due === \"soon\") {\r\n\t\t\t\twhere.push(\"date(t.due_date) BETWEEN date('now') AND date('now','+3 days')\");\r\n\t\t\t}\r\n\t\t\tconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n\t\t\tconst countRow = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT COUNT(1) as total\r\n\t\t\t\t FROM ActiveTasks t\r\n\t\t\t\t LEFT JOIN ClientServices cs ON cs.client_service_id = t.client_service_id\r\n\t\t\t\t LEFT JOIN Clients c ON c.client_id = cs.client_id\r\n\t\t\t\t ${whereSql}`\r\n\t\t\t).bind(...binds).first();\r\n\t\t\tconst total = Number(countRow?.total || 0);\r\n\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT t.task_id, t.task_name, t.due_date, t.status, t.assignee_user_id,\r\n\t\t\t\t        c.company_name AS client_name,\r\n\t\t\t\t        (SELECT COUNT(1) FROM ActiveTaskStages s WHERE s.task_id = t.task_id) AS total_stages,\r\n\t\t\t\t        (SELECT COUNT(1) FROM ActiveTaskStages s WHERE s.task_id = t.task_id AND s.status = 'completed') AS completed_stages,\r\n\t\t\t\t        (CASE WHEN t.related_sop_id IS NOT NULL OR t.client_specific_sop_id IS NOT NULL THEN 1 ELSE 0 END) AS has_sop,\r\n\t\t\t\t        u.name AS assignee_name\r\n\t\t\t\t FROM ActiveTasks t\r\n\t\t\t\t LEFT JOIN ClientServices cs ON cs.client_service_id = t.client_service_id\r\n\t\t\t\t LEFT JOIN Clients c ON c.client_id = cs.client_id\r\n\t\t\t\t LEFT JOIN Users u ON u.user_id = t.assignee_user_id\r\n\t\t\t\t ${whereSql}\r\n\t\t\t\t ORDER BY date(t.due_date) ASC NULLS LAST, t.task_id DESC\r\n\t\t\t\t LIMIT ? OFFSET ?`\r\n\t\t\t).bind(...binds, perPage, offset).all();\r\n\t\t\tconst data = (rows?.results || []).map((r) => ({\r\n\t\t\t\ttaskId: String(r.task_id),\r\n\t\t\t\ttaskName: r.task_name,\r\n\t\t\t\tclientName: r.client_name || \"\",\r\n\t\t\t\tassigneeName: r.assignee_name || \"\",\r\n\t\t\t\tprogress: { completed: Number(r.completed_stages || 0), total: Number(r.total_stages || 0) },\r\n\t\t\t\tdueDate: r.due_date || null,\r\n\t\t\t\tstatus: r.status,\r\n\t\t\t\thasSop: Number(r.has_sop || 0) === 1,\r\n\t\t\t}));\r\n\t\t\tconst meta = { requestId, page, perPage, total, hasNext: offset + perPage < total };\r\n\t\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u6210\u529F\", data, meta }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\r\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, getCorsHeadersForRequest(request, env));\r\n\t\t}\r\n\t}\r\n\r\n\tif (method === \"POST\") {\r\n\t\tlet body;\r\n\t\ttry { body = await request.json(); } catch (_) {\r\n\t\t\treturn jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t\tconst clientServiceId = Number(body?.client_service_id || 0);\r\n\t\tconst taskName = String(body?.task_name || \"\").trim();\r\n\t\tconst dueDate = body?.due_date ? String(body.due_date) : null;\r\n\t\tconst assigneeUserId = body?.assignee_user_id ? Number(body.assignee_user_id) : null;\r\n\t\tconst stageNames = Array.isArray(body?.stage_names) ? body.stage_names.filter(s => typeof s === 'string' && s.trim().length > 0).map(s => s.trim()) : [];\r\n\t\tconst errors = [];\r\n\t\tif (!Number.isInteger(clientServiceId) || clientServiceId <= 0) errors.push({ field:\"client_service_id\", message:\"\u5FC5\u586B\" });\r\n\t\tif (taskName.length < 1 || taskName.length > 200) errors.push({ field:\"task_name\", message:\"\u9577\u5EA6\u9700 1\u2013200\" });\r\n\t\tif (dueDate && !/^\\d{4}-\\d{2}-\\d{2}$/.test(dueDate)) errors.push({ field:\"due_date\", message:\"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD\" });\r\n\t\tif (assigneeUserId !== null && (!Number.isInteger(assigneeUserId) || assigneeUserId <= 0)) errors.push({ field:\"assignee_user_id\", message:\"\u683C\u5F0F\u932F\u8AA4\" });\r\n\t\tif (errors.length) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\r\n\r\n\t\ttry {\r\n\t\t\tconst cs = await env.DATABASE.prepare(\"SELECT client_service_id FROM ClientServices WHERE client_service_id = ? LIMIT 1\").bind(clientServiceId).first();\r\n\t\t\tif (!cs) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u5BA2\u6236\u670D\u52D9\u4E0D\u5B58\u5728\", errors:[{ field:\"client_service_id\", message:\"\u4E0D\u5B58\u5728\" }], meta:{ requestId } }, corsHeaders);\r\n\t\t\tif (assigneeUserId) {\r\n\t\t\t\tconst u = await env.DATABASE.prepare(\"SELECT 1 FROM Users WHERE user_id = ? AND is_deleted = 0 LIMIT 1\").bind(assigneeUserId).first();\r\n\t\t\t\tif (!u) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8CA0\u8CAC\u4EBA\u4E0D\u5B58\u5728\", errors:[{ field:\"assignee_user_id\", message:\"\u4E0D\u5B58\u5728\" }], meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\tconst now = new Date().toISOString();\r\n\t\t\tawait env.DATABASE.prepare(\"INSERT INTO ActiveTasks (client_service_id, template_id, task_name, start_date, due_date, status, assignee_user_id, created_at) VALUES (?, NULL, ?, NULL, ?, 'pending', ?, ?)\").bind(clientServiceId, taskName, dueDate, assigneeUserId, now).run();\r\n\t\t\tconst idRow = await env.DATABASE.prepare(\"SELECT last_insert_rowid() AS id\").first();\r\n\t\t\tconst taskId = String(idRow?.id);\r\n\t\t\tif (stageNames.length > 0) {\r\n\t\t\t\tlet order = 1;\r\n\t\t\t\tfor (const s of stageNames) {\r\n\t\t\t\t\tawait env.DATABASE.prepare(\"INSERT INTO ActiveTaskStages (task_id, stage_name, stage_order, status) VALUES (?, ?, ?, 'pending')\").bind(taskId, s, order++).run();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn jsonResponse(201, { ok:true, code:\"CREATED\", message:\"\u5DF2\u5EFA\u7ACB\", data:{ taskId, taskName, clientServiceId, dueDate, assigneeUserId }, meta:{ requestId } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err) }));\r\n\t\t\tconst body = { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\treturn jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\n\n/**\n * \u5DE5\u6642\u985E\u578B\u5B9A\u7FA9\uFF08\u7B26\u5408\u52DE\u57FA\u6CD5\u898F\u5B9A\uFF09\n */\nconst WORK_TYPES = {\n\t1: { name: '\u6B63\u5E38\u5DE5\u6642', multiplier: 1.0, isOvertime: false },\n\t2: { name: '\u5E73\u65E5\u52A0\u73ED\uFF08\u524D2\u5C0F\u6642\uFF09', multiplier: 1.34, isOvertime: true },\n\t3: { name: '\u5E73\u65E5\u52A0\u73ED\uFF08\u5F8C2\u5C0F\u6642\uFF09', multiplier: 1.67, isOvertime: true },\n\t4: { name: '\u4F11\u606F\u65E5\u52A0\u73ED\uFF08\u524D2\u5C0F\u6642\uFF09', multiplier: 1.34, isOvertime: true },\n\t5: { name: '\u4F11\u606F\u65E5\u52A0\u73ED\uFF08\u7B2C3-8\u5C0F\u6642\uFF09', multiplier: 1.67, isOvertime: true },\n\t6: { name: '\u4F11\u606F\u65E5\u52A0\u73ED\uFF08\u7B2C9-12\u5C0F\u6642\uFF09', multiplier: 2.67, isOvertime: true },\n\t7: { name: '\u570B\u5B9A\u5047\u65E5\u52A0\u73ED\uFF088\u5C0F\u6642\u5167\uFF09', multiplier: 2.0, isOvertime: true, maxHours: 8, special: 'fixed_8h' },\n\t8: { name: '\u570B\u5B9A\u5047\u65E5\u52A0\u73ED\uFF08\u7B2C9-10\u5C0F\u6642\uFF09', multiplier: 1.34, isOvertime: true },\n\t9: { name: '\u570B\u5B9A\u5047\u65E5\u52A0\u73ED\uFF08\u7B2C11-12\u5C0F\u6642\uFF09', multiplier: 1.67, isOvertime: true },\n\t10: { name: '\u4F8B\u5047\u65E5\u52A0\u73ED\uFF088\u5C0F\u6642\u5167\uFF09', multiplier: 2.0, isOvertime: true, maxHours: 8, special: 'fixed_8h' },\n\t11: { name: '\u4F8B\u5047\u65E5\u52A0\u73ED\uFF08\u7B2C9-12\u5C0F\u6642\uFF09', multiplier: 2.0, isOvertime: true },\n};\n\n/**\n * \u8A08\u7B97\u52A0\u6B0A\u5DE5\u6642\n */\nfunction calculateWeightedHours(workTypeId, hours) {\n\tconst workType = WORK_TYPES[workTypeId];\n\tif (!workType) return hours;\n\t\n\t// \u7279\u6B8A\u60C5\u6CC1\uFF1A\u570B\u5B9A\u5047\u65E5/\u4F8B\u5047\u65E5 8\u5C0F\u6642\u5167\u985E\u578B\uFF0C\u56FA\u5B9A\u70BA 8.0 \u52A0\u6B0A\u5DE5\u6642\n\tif (workType.special === 'fixed_8h') {\n\t\treturn 8.0;\n\t}\n\t\n\t// \u4E00\u822C\u60C5\u6CC1\uFF1A\u5BE6\u969B\u5DE5\u6642 \u00D7 \u500D\u7387\n\treturn hours * workType.multiplier;\n}\n\n/**\n * GET /api/v1/timelogs - \u67E5\u8A62\u5DE5\u6642\u8A18\u9304\n */\nasync function handleGetTimelogs(request, env, me, requestId, url) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\t\n\ttry {\n\t\tconst params = url.searchParams;\n\t\tconst startDate = (params.get(\"start_date\") || \"\").trim();\n\t\tconst endDate = (params.get(\"end_date\") || \"\").trim();\n\t\t\n\tconst where = [\"t.is_deleted = 0\"];\n\tconst binds = [];\n\t\n\t// \u6B0A\u9650\u63A7\u5236\uFF1A\u54E1\u5DE5\u53EA\u80FD\u770B\u81EA\u5DF1\u7684\n\tif (!me.is_admin) {\n\t\twhere.push(\"t.user_id = ?\");\n\t\tbinds.push(String(me.user_id));\n\t}\n\t\n\t// \u65E5\u671F\u7BC4\u570D\u7BE9\u9078\n\tif (startDate) {\n\t\twhere.push(\"t.work_date >= ?\");\n\t\tbinds.push(startDate);\n\t}\n\tif (endDate) {\n\t\twhere.push(\"t.work_date <= ?\");\n\t\tbinds.push(endDate);\n\t}\n\t\nconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\n\t\n\tconst rows = await env.DATABASE.prepare(\n\t\t`SELECT t.timesheet_id, t.user_id, t.work_date, t.client_id, t.service_id, t.service_item_id, t.service_name, t.work_type, t.hours, t.note,\n\t\t        u.name as user_name, u.username\n\t\t FROM Timesheets t\n\t\t LEFT JOIN Users u ON t.user_id = u.user_id\n\t\t ${whereSql}\n\t\t ORDER BY t.work_date ASC, t.timesheet_id ASC`\n\t).bind(...binds).all();\n\t\n\tconst data = (rows?.results || []).map(r => ({\n\t\tlog_id: r.timesheet_id,\n\t\ttimesheet_id: r.timesheet_id, // \u65B0\u589E\uFF1A\u540C\u6642\u8FD4\u56DE timesheet_id \u6B04\u4F4D\n\t\tuser_id: r.user_id,\n\t\tuser_name: r.user_name || r.username || '\u672A\u77E5',\n\t\twork_date: r.work_date,\n\t\tclient_id: r.client_id || \"\",\n\t\tservice_id: parseInt(r.service_id) || parseInt(r.service_name) || 1, // \u512A\u5148\u4F7F\u7528\u65B0\u6B04\u4F4D\uFF0C\u5411\u5F8C\u76F8\u5BB9\n\t\tservice_item_id: parseInt(r.service_item_id) || 1,\n\t\twork_type_id: parseInt(r.work_type) || 1,\n\t\thours: Number(r.hours || 0),\n\t\tnotes: r.note || \"\",\n\t}));\n\t\t\n\t\treturn jsonResponse(200, { \n\t\t\tok: true, \n\t\t\tcode: \"SUCCESS\", \n\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\", \n\t\t\tdata, \n\t\t\tmeta: { requestId } \n\t\t}, corsHeaders);\n\t\t\n\t} catch (err) {\n\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\treturn jsonResponse(500, body, getCorsHeadersForRequest(request, env));\n\t}\n}\n\n/**\n * POST /api/v1/timelogs - \u65B0\u589E/\u66F4\u65B0\u5DE5\u6642\uFF08UPSERT\uFF09\n */\nasync function handlePostTimelogs(request, env, me, requestId, url) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\t\n\tlet body;\n\ttry { \n\t\tbody = await request.json(); \n\t} catch (_) {\n\t\treturn jsonResponse(400, { \n\t\t\tok: false, \n\t\t\tcode: \"BAD_REQUEST\", \n\t\t\tmessage: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", \n\t\t\tmeta: { requestId } \n\t\t}, corsHeaders);\n\t}\n\t\n\t// \u89E3\u6790\u6B04\u4F4D\n\tconst work_date = String(body?.work_date || \"\").trim();\n\tconst client_id = String(body?.client_id || \"\").trim();\n\tconst service_id = parseInt(body?.service_id) || 0;\n\tconst service_item_id = parseInt(body?.service_item_id) || 0;\n\tconst work_type_id = parseInt(body?.work_type_id) || 0;\n\tconst hours = Number(body?.hours);\n\tconst notes = String(body?.notes || \"\").trim();\n\tconst timesheet_id = body?.timesheet_id ? parseInt(body.timesheet_id) : null;\n\t\n\t// \u9A57\u8B49\n\tconst errors = [];\n\t\n\tif (!/^\\d{4}-\\d{2}-\\d{2}$/.test(work_date)) {\n\t\terrors.push({ field: \"work_date\", message: \"\u65E5\u671F\u683C\u5F0F\u5FC5\u9808\u70BA YYYY-MM-DD\" });\n\t}\n\t\n\tif (!client_id) {\n\t\terrors.push({ field: \"client_id\", message: \"\u8ACB\u9078\u64C7\u5BA2\u6236\" });\n\t}\n\t\n\tif (!service_id) {\n\t\terrors.push({ field: \"service_id\", message: \"\u8ACB\u9078\u64C7\u670D\u52D9\u9805\u76EE\" });\n\t}\n\t\n\tif (!service_item_id) {\n\t\terrors.push({ field: \"service_item_id\", message: \"\u8ACB\u9078\u64C7\u670D\u52D9\u5B50\u9805\u76EE\" });\n\t}\n\t\n\tif (!work_type_id || !WORK_TYPES[work_type_id]) {\n\t\terrors.push({ field: \"work_type_id\", message: \"\u8ACB\u9078\u64C7\u6709\u6548\u7684\u5DE5\u6642\u985E\u578B\" });\n\t}\n\t\n\tif (!Number.isFinite(hours) || hours <= 0) {\n\t\terrors.push({ field: \"hours\", message: \"\u5DE5\u6642\u5FC5\u9808\u5927\u65BC 0\" });\n\t}\n\t\n\t// \u6AA2\u67E5 0.5 \u500D\u6578\n\tif (Math.abs(hours * 2 - Math.round(hours * 2)) > 1e-9) {\n\t\terrors.push({ field: \"hours\", message: \"\u5DE5\u6642\u5FC5\u9808\u662F 0.5 \u7684\u500D\u6578\" });\n\t}\n\t\n\t// \u6AA2\u67E5\u6700\u5927\u503C\u9650\u5236\n\tconst workType = WORK_TYPES[work_type_id];\n\tif (workType && workType.maxHours && hours > workType.maxHours) {\n\t\terrors.push({ \n\t\t\tfield: \"hours\", \n\t\t\tmessage: `${workType.name}\u6700\u591A\u53EA\u80FD\u586B ${workType.maxHours} \u5C0F\u6642` \n\t\t});\n\t}\n\t\n\tif (hours > 12) {\n\t\terrors.push({ field: \"hours\", message: \"\u5DE5\u6642\u4E0D\u53EF\u8D85\u904E 12 \u5C0F\u6642\" });\n\t}\n\t\n\tif (errors.length) {\n\t\treturn jsonResponse(422, { \n\t\t\tok: false, \n\t\t\tcode: \"VALIDATION_ERROR\", \n\t\t\tmessage: \"\u8F38\u5165\u6709\u8AA4\", \n\t\t\terrors, \n\t\t\tmeta: { requestId } \n\t\t}, corsHeaders);\n\t}\n\t\n\ttry {\n\t\t// \u7372\u53D6\u5DE5\u6642\u985E\u578B\n\t\tconst workType = WORK_TYPES[work_type_id];\n\t\tif (!workType) {\n\t\t\treturn jsonResponse(422, {\n\t\t\t\tok: false,\n\t\t\t\tcode: \"VALIDATION_ERROR\",\n\t\t\t\tmessage: \"\u7121\u6548\u7684\u5DE5\u6642\u985E\u578B\",\n\t\t\t\terrors: [{ field: \"work_type_id\", message: \"\u5DE5\u6642\u985E\u578B\u4E0D\u5B58\u5728\" }],\n\t\t\t\tmeta: { requestId }\n\t\t\t}, corsHeaders);\n\t\t}\n\t\t\n\t\t// \u7372\u53D6\u8A72\u65E5\u671F\u7684\u5047\u65E5\u4FE1\u606F\uFF0C\u5224\u65B7\u65E5\u671F\u985E\u578B\n\t\tconst holidayRow = await env.DATABASE.prepare(\n\t\t\t`SELECT is_national_holiday FROM Holidays WHERE holiday_date = ?`\n\t\t).bind(work_date).first();\n\t\t\n\t\tconst date = new Date(work_date + 'T00:00:00');\n\t\tconst dow = date.getDay();\n\t\t\n\t\t// \u5224\u65B7\u65E5\u671F\u985E\u578B\n\t\tlet dateType = 'workday';\n\t\tif (holidayRow?.is_national_holiday === 1) {\n\t\t\tdateType = 'national_holiday';\n\t\t} else if (dow === 0) {\n\t\t\tdateType = 'weekly_restday'; // \u9031\u65E5\uFF08\u4F8B\u5047\uFF09\n\t\t} else if (dow === 6) {\n\t\t\tdateType = 'restday'; // \u9031\u516D\uFF08\u4F11\u606F\u65E5\uFF09\n\t\t}\n\t\t\n\t\t// \u9A57\u8B49\u5DE5\u6642\u985E\u578B\u662F\u5426\u9069\u7528\u65BC\u8A72\u65E5\u671F\u985E\u578B\n\t\tconst allowedTypes = {\n\t\t\t'workday': [1, 2, 3], // \u4E00\u822C\u3001\u5E73\u65E5OT\u524D2h\u3001\u5E73\u65E5OT\u5F8C2h\n\t\t\t'restday': [4, 5, 6], // \u4F11\u606F\u65E5\u524D2h\u3001\u4F11\u606F\u65E53-8h\u3001\u4F11\u606F\u65E59-12h\n\t\t\t'weekly_restday': [10, 11], // \u4F8B\u5047\u65E5\u52A0\u73ED\n\t\t\t'national_holiday': [7, 8, 9] // \u570B\u5B9A\u5047\u65E5\u52A0\u73ED\n\t\t};\n\t\t\n\t\tconst dateTypeNames = {\n\t\t\t'workday': '\u5DE5\u4F5C\u65E5',\n\t\t\t'restday': '\u4F11\u606F\u65E5',\n\t\t\t'weekly_restday': '\u4F8B\u5047\u65E5',\n\t\t\t'national_holiday': '\u570B\u5B9A\u5047\u65E5'\n\t\t};\n\t\t\n\t\tif (!allowedTypes[dateType].includes(work_type_id)) {\n\t\t\tconst dateTypeName = dateTypeNames[dateType] || dateType;\n\t\t\treturn jsonResponse(422, {\n\t\t\t\tok: false,\n\t\t\t\tcode: \"VALIDATION_ERROR\",\n\t\t\t\tmessage: `${work_date}\uFF08${dateTypeName}\uFF09\u4E0D\u53EF\u4F7F\u7528\u300C${workType.name}\u300D`,\n\t\t\t\terrors: [{ \n\t\t\t\t\tfield: \"work_type_id\", \n\t\t\t\t\tmessage: `\u8A72\u65E5\u671F\u985E\u578B\u70BA${dateTypeName}\uFF0C\u8ACB\u9078\u64C7\u9069\u5408\u7684\u5DE5\u6642\u985E\u578B` \n\t\t\t\t}],\n\t\t\t\tmeta: { requestId, work_date, dateType, workType: workType.name }\n\t\t\t}, corsHeaders);\n\t\t}\n\t\t\n\t\t// \u8A08\u7B97\u52A0\u6B0A\u5DE5\u6642\n\t\tconst weighted_hours = calculateWeightedHours(work_type_id, hours);\n\t\t\n\t\tlet log_id;\n\t\tlet isUpdate = false; // \u8FFD\u8E64\u662F\u65B0\u5EFA\u9084\u662F\u66F4\u65B0\n\t\t\n\t\t// \u7B56\u7565\uFF1A\u5982\u679C\u63D0\u4F9B\u4E86 timesheet_id\uFF0C\u76F4\u63A5\u66F4\u65B0\u8A72\u8A18\u9304\u7684\u6240\u6709\u6B04\u4F4D\n\t\t// \u9019\u6A23\u53EF\u4EE5\u652F\u6301\u4FEE\u6539 service_id/service_item_id \u800C\u4E0D\u5275\u5EFA\u91CD\u8907\u8A18\u9304\uFF0C\u4E5F\u4E0D\u6703\u89F8\u767C\u5916\u9375\u7D04\u675F\u554F\u984C\n\t\tif (timesheet_id) {\n\t\t\t// \u9A57\u8B49\u8A72\u8A18\u9304\u5C6C\u65BC\u7576\u524D\u7528\u6236\n\t\t\tconst existingRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT timesheet_id FROM Timesheets \n\t\t\t\t WHERE timesheet_id = ? AND user_id = ? AND is_deleted = 0`\n\t\t\t).bind(timesheet_id, String(me.user_id)).first();\n\t\t\t\n\t\tif (existingRow) {\n\t\t\t// \u76F4\u63A5\u66F4\u65B0\u6240\u6709\u6B04\u4F4D\uFF08\u5305\u62EC service_id, service_item_id, work_type, hours\uFF09\n\t\t\tlog_id = timesheet_id;\n\t\t\tisUpdate = true;\n\t\t\t\n\t\t\t// \u7372\u53D6\u820A\u7684\u5DE5\u6642\u6578\u64DA\uFF0C\u7528\u65BC\u9A57\u8B49\n\t\t\tconst oldData = await env.DATABASE.prepare(\n\t\t\t\t`SELECT hours, work_type FROM Timesheets WHERE timesheet_id = ?`\n\t\t\t).bind(log_id).first();\n\t\t\t\n\t\t\tconst oldHours = Number(oldData?.hours || 0);\n\t\t\tconst hoursDiff = hours - oldHours;  // \u6B63\u6578\u8868\u793A\u589E\u52A0\uFF0C\u8CA0\u6578\u8868\u793A\u6E1B\u5C11\n\t\t\t\n\t\t\t// \u9A57\u8B49\u4FEE\u6539\u5F8C\u7576\u65E5\u7E3D\u5DE5\u6642\u662F\u5426\u8D85\u904E 12 \u5C0F\u6642\n\t\t\tif (hoursDiff > 0) {  // \u53EA\u5728\u589E\u52A0\u5DE5\u6642\u6642\u6AA2\u67E5\n\t\t\t\tconst sumRow = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT COALESCE(SUM(hours), 0) AS s \n\t\t\t\t\t FROM Timesheets \n\t\t\t\t\t WHERE user_id = ? AND work_date = ? AND is_deleted = 0`\n\t\t\t\t).bind(String(me.user_id), work_date).first();\n\t\t\t\t\n\t\t\t\tconst currentTotal = Number(sumRow?.s || 0);\n\t\t\t\tif (currentTotal + hoursDiff > 12 + 1e-9) {\n\t\t\t\t\treturn jsonResponse(422, {\n\t\t\t\t\t\tok: false,\n\t\t\t\t\t\tcode: \"VALIDATION_ERROR\",\n\t\t\t\t\t\tmessage: \"\u4FEE\u6539\u5F8C\u6BCF\u65E5\u5DE5\u6642\u5408\u8A08\u4E0D\u53EF\u8D85\u904E 12 \u5C0F\u6642\",\n\t\t\t\t\t\terrors: [{ field: \"hours\", message: \"\u8D85\u904E\u6BCF\u65E5\u4E0A\u9650\" }],\n\t\t\t\t\t\tmeta: { requestId }\n\t\t\t\t\t}, corsHeaders);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t// \u9A57\u8B49\u4FEE\u6539\u5F8C\u540C\u4E00\u5DE5\u6642\u985E\u578B\u7684\u7D2F\u8A08\u662F\u5426\u8D85\u904E\u4E0A\u9650\n\t\t\tif (workType.maxHours) {\n\t\t\t\tconst workTypeSum = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT COALESCE(SUM(hours), 0) AS s \n\t\t\t\t\t FROM Timesheets \n\t\t\t\t\t WHERE user_id = ? AND work_date = ? AND work_type = ? AND is_deleted = 0`\n\t\t\t\t).bind(String(me.user_id), work_date, String(work_type_id)).first();\n\t\t\t\t\n\t\t\t\tconst currentWorkTypeTotal = Number(workTypeSum?.s || 0);\n\t\t\t\tconst newWorkTypeTotal = currentWorkTypeTotal - oldHours + hours;\n\t\t\t\t\n\t\t\t\tif (newWorkTypeTotal > workType.maxHours + 1e-9) {\n\t\t\t\t\treturn jsonResponse(422, {\n\t\t\t\t\t\tok: false,\n\t\t\t\t\t\tcode: \"VALIDATION_ERROR\",\n\t\t\t\t\t\tmessage: `\u4FEE\u6539\u5F8C\u300C${workType.name}\u300D\u7576\u65E5\u7D2F\u8A08\u4E0D\u53EF\u8D85\u904E ${workType.maxHours} \u5C0F\u6642`,\n\t\t\t\t\t\terrors: [{ \n\t\t\t\t\t\t\tfield: \"hours\", \n\t\t\t\t\t\t\tmessage: `\u7576\u65E5\u5DF2\u6709 ${currentWorkTypeTotal} \u5C0F\u6642\uFF0C\u4FEE\u6539\u5F8C\u5C07\u8B8A\u6210 ${newWorkTypeTotal.toFixed(1)} \u5C0F\u6642\uFF08\u8D85\u904E\u4E0A\u9650\uFF09` \n\t\t\t\t\t\t}],\n\t\t\t\t\t\tmeta: { requestId }\n\t\t\t\t\t}, corsHeaders);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`UPDATE Timesheets \n\t\t\t\t SET client_id = ?, \n\t\t\t\t     service_id = ?, \n\t\t\t\t     service_item_id = ?, \n\t\t\t\t     service_name = ?, \n\t\t\t\t     work_type = ?, \n\t\t\t\t     hours = ?, \n\t\t\t\t     note = ?, \n\t\t\t\t     updated_at = ?\n\t\t\t\t WHERE timesheet_id = ?`\n\t\t\t).bind(\n\t\t\t\tclient_id,\n\t\t\t\tservice_id,\n\t\t\t\tservice_item_id,\n\t\t\t\tString(service_id), // \u4FDD\u7559\u820A\u6B04\u4F4D\u4EE5\u5411\u5F8C\u76F8\u5BB9\n\t\t\t\tString(work_type_id),\n\t\t\t\thours,\n\t\t\t\tnotes,\n\t\t\t\tnew Date().toISOString(),\n\t\t\t\tlog_id\n\t\t\t).run();\n\t\t\t\n\t\t\t// \u5DF2\u66F4\u65B0\uFF0C\u8DF3\u904E\u5F8C\u7E8C\u7684\u63D2\u5165\u908F\u8F2F\n\t\t} else {\n\t\t\t\t// \u5982\u679C\u8A18\u9304\u4E0D\u5B58\u5728\u6216\u4E0D\u5C6C\u65BC\u7576\u524D\u7528\u6236\uFF0C\u5C07 timesheet_id \u8A2D\u70BA null\uFF0C\u5141\u8A31\u65B0\u589E\n\t\t\t\tlog_id = null;\n\t\t\t}\n\t\t}\n\t\t\n\t\t// \u5982\u679C\u6C92\u6709\u63D0\u4F9B timesheet_id\uFF0C\u6216\u8005\u63D0\u4F9B\u7684 timesheet_id \u7121\u6548\uFF0C\u6AA2\u67E5\u662F\u5426\u5DF2\u5B58\u5728\u76F8\u540C\u7D44\u5408\n\t\tif (!log_id) {\n\t\t\tconst duplicateRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT timesheet_id \n\t\t\t\t FROM Timesheets \n\t\t\t\t WHERE user_id = ? \n\t\t\t\t   AND work_date = ? \n\t\t\t\t   AND client_id = ? \n\t\t\t\t   AND service_id = ? \n\t\t\t\t   AND service_item_id = ? \n\t\t\t\t   AND work_type = ? \n\t\t\t\t   AND is_deleted = 0`\n\t\t\t).bind(\n\t\t\t\tString(me.user_id), \n\t\t\t\twork_date, \n\t\t\t\tclient_id, \n\t\t\t\tservice_id,\n\t\t\t\tservice_item_id,\n\t\t\t\tString(work_type_id)\n\t\t\t).first();\n\t\t\t\n\t\tif (duplicateRow) {\n\t\t\t// \u5982\u679C\u5DF2\u5B58\u5728\u76F8\u540C\u7D44\u5408\uFF0C\u7D2F\u52A0\u5DE5\u6642\uFF08\u81EA\u52D5\u5408\u4F75\uFF09\n\t\t\tlog_id = duplicateRow.timesheet_id;\n\t\t\tisUpdate = true;\n\t\t\t\n\t\t\t// \u7372\u53D6\u73FE\u6709\u5DE5\u6642\n\t\t\tconst existingRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT hours FROM Timesheets WHERE timesheet_id = ?`\n\t\t\t).bind(log_id).first();\n\t\t\t\n\t\t\tconst existingHours = Number(existingRow?.hours || 0);\n\t\t\tconst newTotalHours = existingHours + hours;\n\t\t\t\n\t\t\t// \u9A57\u8B49\u7D2F\u52A0\u5F8C\u662F\u5426\u8D85\u904E\u5DE5\u6642\u985E\u578B\u7684\u4E0A\u9650\n\t\t\tif (workType.maxHours && newTotalHours > workType.maxHours) {\n\t\t\t\treturn jsonResponse(422, {\n\t\t\t\t\tok: false,\n\t\t\t\t\tcode: \"VALIDATION_ERROR\",\n\t\t\t\t\tmessage: `\u7D2F\u52A0\u5F8C\u300C${workType.name}\u300D\u5DE5\u6642\u70BA ${newTotalHours} \u5C0F\u6642\uFF0C\u8D85\u904E\u4E0A\u9650 ${workType.maxHours} \u5C0F\u6642`,\n\t\t\t\t\terrors: [{ \n\t\t\t\t\t\tfield: \"hours\", \n\t\t\t\t\t\tmessage: `\u8A72\u65E5\u5DF2\u6709 ${existingHours} \u5C0F\u6642\uFF0C\u6700\u591A\u9084\u53EF\u586B ${workType.maxHours - existingHours} \u5C0F\u6642` \n\t\t\t\t\t}]\n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u9A57\u8B49\u7D2F\u52A0\u5F8C\u7576\u65E5\u7E3D\u5DE5\u6642\u662F\u5426\u8D85\u904E 12 \u5C0F\u6642\n\t\t\tconst sumRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT COALESCE(SUM(hours), 0) AS s \n\t\t\t\t FROM Timesheets \n\t\t\t\t WHERE user_id = ? AND work_date = ? AND is_deleted = 0 AND timesheet_id != ?`\n\t\t\t).bind(String(me.user_id), work_date, log_id).first();\n\t\t\t\n\t\t\tconst otherHoursTotal = Number(sumRow?.s || 0);\n\t\t\tconst dailyTotal = otherHoursTotal + newTotalHours;\n\t\t\t\n\t\t\tif (dailyTotal > 12 + 1e-9) {\n\t\t\t\treturn jsonResponse(422, {\n\t\t\t\t\tok: false,\n\t\t\t\t\tcode: \"VALIDATION_ERROR\",\n\t\t\t\t\tmessage: `\u7D2F\u52A0\u5F8C\u7576\u65E5\u7E3D\u5DE5\u6642\u70BA ${dailyTotal.toFixed(1)} \u5C0F\u6642\uFF0C\u8D85\u904E\u4E0A\u9650 12 \u5C0F\u6642`,\n\t\t\t\t\terrors: [{ \n\t\t\t\t\t\tfield: \"hours\", \n\t\t\t\t\t\tmessage: `\u7576\u65E5\u5DF2\u6709 ${otherHoursTotal.toFixed(1)} \u5C0F\u6642\uFF0C\u672C\u8A18\u9304\u5DF2\u6709 ${existingHours} \u5C0F\u6642\uFF0C\u6700\u591A\u9084\u53EF\u7D2F\u52A0 ${Math.max(0, 12 - otherHoursTotal - existingHours).toFixed(1)} \u5C0F\u6642` \n\t\t\t\t\t}]\n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\t\t\t\n\t\t\t// \u7D2F\u52A0\u5DE5\u6642\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`UPDATE Timesheets \n\t\t\t\t SET hours = hours + ?, updated_at = ?\n\t\t\t\t WHERE timesheet_id = ?`\n\t\t\t).bind(hours, new Date().toISOString(), log_id).run();\n\t\t}\n\t\t}\n\t\t\n\t\t// \u5982\u679C\u9084\u662F\u6C92\u6709 log_id\uFF0C\u8868\u793A\u9700\u8981\u65B0\u589E\u8A18\u9304\n\t\tif (!log_id) {\n\t\t\t// INSERT\uFF1A\u65B0\u589E\u8A18\u9304\n\t\t\t// \u5148\u6AA2\u67E5\u55AE\u65E5\u7E3D\u5DE5\u6642\u662F\u5426\u8D85\u904E 12\n\t\t\tconst sumRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT COALESCE(SUM(hours), 0) AS s \n\t\t\t\t FROM Timesheets \n\t\t\t\t WHERE user_id = ? AND work_date = ? AND is_deleted = 0`\n\t\t\t).bind(String(me.user_id), work_date).first();\n\t\t\t\n\t\tconst currentTotal = Number(sumRow?.s || 0);\n\t\tif (currentTotal + hours > 12 + 1e-9) {\n\t\t\treturn jsonResponse(422, { \n\t\t\t\tok: false, \n\t\t\t\tcode: \"VALIDATION_ERROR\", \n\t\t\t\tmessage: \"\u6BCF\u65E5\u5DE5\u6642\u5408\u8A08\u4E0D\u53EF\u8D85\u904E 12 \u5C0F\u6642\", \n\t\t\t\terrors: [{ field: \"hours\", message: \"\u8D85\u904E\u6BCF\u65E5\u4E0A\u9650\" }], \n\t\t\t\tmeta: { requestId } \n\t\t\t}, corsHeaders);\n\t\t}\n\t\t\n\t\t// \u6AA2\u67E5\u540C\u4E00\u5929\u540C\u4E00\u5DE5\u6642\u985E\u578B\u7684\u7D2F\u8A08\u5DE5\u6642\u662F\u5426\u8D85\u904E\u8A72\u985E\u578B\u7684\u4E0A\u9650\n\t\tif (workType.maxHours) {\n\t\t\tconst workTypeSum = await env.DATABASE.prepare(\n\t\t\t\t`SELECT COALESCE(SUM(hours), 0) AS s \n\t\t\t\t FROM Timesheets \n\t\t\t\t WHERE user_id = ? AND work_date = ? AND work_type = ? AND is_deleted = 0`\n\t\t\t).bind(String(me.user_id), work_date, String(work_type_id)).first();\n\t\t\t\n\t\t\tconst existingWorkTypeTotal = Number(workTypeSum?.s || 0);\n\t\t\tconst newWorkTypeTotal = existingWorkTypeTotal + hours;\n\t\t\t\n\t\t\tif (newWorkTypeTotal > workType.maxHours + 1e-9) {\n\t\t\t\treturn jsonResponse(422, {\n\t\t\t\t\tok: false,\n\t\t\t\t\tcode: \"VALIDATION_ERROR\",\n\t\t\t\t\tmessage: `\u300C${workType.name}\u300D\u7576\u65E5\u7D2F\u8A08\u4E0D\u53EF\u8D85\u904E ${workType.maxHours} \u5C0F\u6642`,\n\t\t\t\t\terrors: [{ \n\t\t\t\t\t\tfield: \"hours\", \n\t\t\t\t\t\tmessage: `\u8A72\u65E5\u5DF2\u6709 ${existingWorkTypeTotal} \u5C0F\u6642\u300C${workType.name}\u300D\uFF0C\u6700\u591A\u9084\u53EF\u586B ${Math.max(0, workType.maxHours - existingWorkTypeTotal)} \u5C0F\u6642` \n\t\t\t\t\t}],\n\t\t\t\t\tmeta: { requestId }\n\t\t\t\t}, corsHeaders);\n\t\t\t}\n\t\t}\n\t\t\n\t\tawait env.DATABASE.prepare(\n\t\t\t\t`INSERT INTO Timesheets (user_id, work_date, client_id, service_id, service_item_id, service_name, work_type, hours, note, created_at, updated_at)\n\t\t\t\t VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`\n\t\t\t).bind(\n\t\t\t\tString(me.user_id), \n\t\t\t\twork_date, \n\t\t\t\tclient_id, \n\t\t\t\tservice_id,\n\t\t\t\tservice_item_id,\n\t\t\t\tString(service_id), // \u4FDD\u7559\u820A\u6B04\u4F4D\u4EE5\u5411\u5F8C\u76F8\u5BB9\n\t\t\t\tString(work_type_id),\n\t\t\t\thours, \n\t\t\t\tnotes, \n\t\t\t\tnew Date().toISOString(), \n\t\t\t\tnew Date().toISOString()\n\t\t\t).run();\n\t\t\t\n\t\t\tconst idRow = await env.DATABASE.prepare(\"SELECT last_insert_rowid() AS id\").first();\n\t\t\tlog_id = idRow?.id;\n\t\t}\n\t\t\n\t\t// \u8A08\u7B97\u88DC\u4F11\u5DE5\u6642\uFF08\u5982\u679C\u662F\u52A0\u73ED\uFF09\n\t\tconst comp_hours_generated = workType.isOvertime ? (workType.special === 'fixed_8h' ? 8 : hours) : 0;\n\t\t\n\t\t// \u5982\u679C\u662F\u52A0\u73ED\uFF0C\u5BEB\u5165\u88DC\u4F11\u8FFD\u8E64\u8868\n\t\tif (comp_hours_generated > 0) {\n\t\t\tconst generatedDate = work_date;\n\t\t\t// \u8A08\u7B97\u5230\u671F\u65E5\uFF08\u7576\u6708\u5E95\uFF09\n\t\t\tconst dateObj = new Date(work_date + 'T00:00:00Z');\n\t\t\tconst year = dateObj.getUTCFullYear();\n\t\t\tconst month = dateObj.getUTCMonth();\n\t\t\tconst lastDay = new Date(Date.UTC(year, month + 1, 0));\n\t\t\tconst expiryDate = `${lastDay.getUTCFullYear()}-${String(lastDay.getUTCMonth() + 1).padStart(2, '0')}-${String(lastDay.getUTCDate()).padStart(2, '0')}`;\n\t\t\t\n\t\t\t// \u5BEB\u5165 CompensatoryLeaveGrants (\u4F7F\u7528 timesheet_id \u4F5C\u70BA source_timelog_id)\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`INSERT INTO CompensatoryLeaveGrants \n\t\t\t\t (user_id, source_timelog_id, hours_generated, hours_remaining, generated_date, expiry_date, original_rate, status)\n\t\t\t\t VALUES (?, ?, ?, ?, ?, ?, ?, 'active')`\n\t\t\t).bind(\n\t\t\t\tString(me.user_id),\n\t\t\t\tlog_id,  // log_id \u5C31\u662F timesheet_id\n\t\t\t\tcomp_hours_generated,\n\t\t\t\tcomp_hours_generated,  // \u521D\u59CB\u6642 remaining = generated\n\t\t\t\tgeneratedDate,\n\t\t\t\texpiryDate,\n\t\t\t\tworkType.multiplier\n\t\t\t).run();\n\t\t}\n\t\t\n\t\tconsole.log('[TIMELOG] \u4FDD\u5B58\u6210\u529F:', { log_id, weighted_hours, comp_hours_generated });\n\t\t\n\t\treturn jsonResponse(200, { \n\t\t\tok: true, \n\t\t\tcode: \"SUCCESS\", \n\t\t\tmessage: isUpdate ? \"\u5DF2\u66F4\u65B0\" : \"\u5DF2\u5EFA\u7ACB\", \n\t\t\tdata: { \n\t\t\t\tlog_id, \n\t\t\t\tweighted_hours, \n\t\t\t\tcomp_hours_generated \n\t\t\t}, \n\t\t\tmeta: { requestId } \n\t\t}, corsHeaders);\n\t\t\n\t} catch (err) {\n\t\tconsole.error(JSON.stringify({ \n\t\t\tlevel: \"error\", \n\t\t\trequestId, \n\t\t\tpath: url.pathname, \n\t\t\terr: String(err),\n\t\t\tstack: err.stack \n\t\t}));\n\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\treturn jsonResponse(500, body, corsHeaders);\n\t}\n}\n\n/**\n * DELETE /api/v1/timelogs/batch - \u6279\u6B21\u522A\u9664\u5DE5\u6642\uFF08\u522A\u9664\u6574\u5217\uFF09\n */\nasync function handleDeleteTimelogsBatch(request, env, me, requestId, url) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\t\n\tlet body;\n\ttry { \n\t\tbody = await request.json(); \n\t} catch (_) {\n\t\treturn jsonResponse(400, { \n\t\t\tok: false, \n\t\t\tcode: \"BAD_REQUEST\", \n\t\t\tmessage: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", \n\t\t\tmeta: { requestId } \n\t\t}, corsHeaders);\n\t}\n\t\n\tconst start_date = String(body?.start_date || \"\").trim();\n\tconst end_date = String(body?.end_date || \"\").trim();\n\tconst client_id = String(body?.client_id || \"\").trim();\n\tconst service_id = parseInt(body?.service_id) || 0;\n\tconst service_item_id = parseInt(body?.service_item_id) || 0;\n\tconst work_type_id = String(body?.work_type_id || \"\").trim();\n\t\n\tif (!start_date || !end_date || !client_id || !service_id || !service_item_id || !work_type_id) {\n\t\treturn jsonResponse(400, { \n\t\t\tok: false, \n\t\t\tcode: \"BAD_REQUEST\", \n\t\t\tmessage: \"\u7F3A\u5C11\u5FC5\u8981\u53C3\u6578\", \n\t\t\tmeta: { requestId } \n\t\t}, corsHeaders);\n\t}\n\t\n\ttry {\n\t\t// \u8EDF\u522A\u9664\u7B26\u5408\u689D\u4EF6\u7684\u6240\u6709\u8A18\u9304\n\t\tconst result = await env.DATABASE.prepare(\n\t\t\t`UPDATE Timesheets \n\t\t\t SET is_deleted = 1, updated_at = ?\n\t\t\t WHERE user_id = ? \n\t\t\t   AND work_date >= ? \n\t\t\t   AND work_date <= ? \n\t\t\t   AND client_id = ? \n\t\t\t   AND service_id = ? \n\t\t\t   AND service_item_id = ?\n\t\t\t   AND work_type = ?\n\t\t\t   AND is_deleted = 0`\n\t\t).bind(\n\t\t\tnew Date().toISOString(),\n\t\t\tString(me.user_id), \n\t\t\tstart_date, \n\t\t\tend_date, \n\t\t\tclient_id, \n\t\t\tservice_id,\n\t\t\tservice_item_id,\n\t\t\twork_type_id\n\t\t).run();\n\t\t\n\t\tconst deleted_count = result.changes || 0;\n\t\t\n\t\treturn jsonResponse(200, { \n\t\t\tok: true, \n\t\t\tcode: \"SUCCESS\", \n\t\t\tmessage: `\u5DF2\u522A\u9664 ${deleted_count} \u7B46\u8A18\u9304`, \n\t\t\tdata: { deleted_count }, \n\t\t\tmeta: { requestId } \n\t\t}, corsHeaders);\n\t\t\n\t} catch (err) {\n\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\treturn jsonResponse(500, body, corsHeaders);\n\t}\n}\n\n/**\n * GET /api/v1/timelogs/summary - \u6708\u7D71\u8A08\n */\nasync function handleGetMonthlySummary(request, env, me, requestId, url) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\t\n\ttry {\n\t\tconst params = url.searchParams;\n\t\tconst month = (params.get(\"month\") || \"\").trim(); // \u683C\u5F0F\uFF1AYYYY-MM\n\t\t\n\t\t// \u9A57\u8B49\u6708\u4EFD\u683C\u5F0F\n\t\tif (!month || !/^\\d{4}-\\d{2}$/.test(month)) {\n\t\t\treturn jsonResponse(400, {\n\t\t\t\tok: false,\n\t\t\t\tcode: \"INVALID_MONTH\",\n\t\t\t\tmessage: \"\u6708\u4EFD\u683C\u5F0F\u932F\u8AA4\uFF0C\u61C9\u70BA YYYY-MM\",\n\t\t\t\tmeta: { requestId }\n\t\t\t}, corsHeaders);\n\t\t}\n\t\t\n\t\t// \u8A08\u7B97\u6708\u4EFD\u8D77\u59CB\u548C\u7D50\u675F\u65E5\u671F\n\t\tconst [year, monthNum] = month.split('-');\n\t\tconst startDate = `${year}-${monthNum}-01`;\n\t\tconst nextMonth = parseInt(monthNum) === 12 ? `${parseInt(year) + 1}-01` : `${year}-${String(parseInt(monthNum) + 1).padStart(2, '0')}`;\n\t\tconst endDate = `${nextMonth}-01`;\n\t\t\n\t// \u6B0A\u9650\u63A7\u5236\uFF1A\u54E1\u5DE5\u53EA\u80FD\u67E5\u8A62\u81EA\u5DF1\u7684\uFF0C\u7BA1\u7406\u54E1\u53EF\u4EE5\u6307\u5B9A user_id\n\tlet userId = me.user_id;\n\tif (me.is_admin && params.get(\"user_id\")) {\n\t\tuserId = parseInt(params.get(\"user_id\"));\n\t}\n\t\t\n\t\t// \u67E5\u8A62\u7576\u6708\u5DE5\u6642\u8A18\u9304\n\t\tconst timelogs = await env.DATABASE.prepare(\n\t\t\t`SELECT work_type, hours\n\t\t\t FROM Timesheets\n\t\t\t WHERE user_id = ?\n\t\t\t   AND work_date >= ?\n\t\t\t   AND work_date < ?\n\t\t\t   AND is_deleted = 0`\n\t\t).bind(userId, startDate, endDate).all();\n\t\t\n\t\t// \u8A08\u7B97\u7D71\u8A08\u6578\u64DA\n\t\tlet totalHours = 0;\n\t\tlet overtimeHours = 0;\n\t\tlet weightedHours = 0;\n\t\t\n\t\ttimelogs.results.forEach(log => {\n\t\t\tconst hours = parseFloat(log.hours) || 0;\n\t\t\tconst workTypeId = parseInt(log.work_type) || 1;\n\t\t\tconst workType = WORK_TYPES[workTypeId];\n\t\t\t\n\t\t\tif (workType) {\n\t\t\t\ttotalHours += hours;\n\t\t\t\t\n\t\t\t\tif (workType.isOvertime) {\n\t\t\t\t\tovertimeHours += hours;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tweightedHours += calculateWeightedHours(workTypeId, hours);\n\t\t\t}\n\t\t});\n\t\t\n\t// \u67E5\u8A62\u7576\u6708\u8ACB\u5047\u6642\u6578\uFF08\u9700\u8981\u6839\u64DA unit \u8F49\u63DB\uFF09\n\tconst leaveRows = await env.DATABASE.prepare(\n\t\t`SELECT unit, amount\n\t\t FROM LeaveRequests\n\t\t WHERE user_id = ?\n\t\t   AND start_date >= ?\n\t\t   AND start_date < ?\n\t\t   AND status = 'approved'\n\t\t   AND is_deleted = 0`\n\t).bind(userId, startDate, endDate).all();\n\t\n\t// \u8A08\u7B97\u7E3D\u8ACB\u5047\u6642\u6578\uFF08day \u63DB\u7B97\u70BA 8 \u5C0F\u6642\uFF09\n\tlet leaveHours = 0;\n\tif (leaveRows.results) {\n\t\tleaveRows.results.forEach(row => {\n\t\t\tconst amount = parseFloat(row.amount) || 0;\n\t\t\tif (row.unit === 'hour') {\n\t\t\t\tleaveHours += amount;\n\t\t\t} else if (row.unit === 'day') {\n\t\t\t\tleaveHours += amount * 8; // 1\u5929 = 8\u5C0F\u6642\n\t\t\t}\n\t\t});\n\t}\n\t\t\n\t\t// \u56DE\u50B3\u7D71\u8A08\u7D50\u679C\n\t\treturn jsonResponse(200, {\n\t\t\tok: true,\n\t\t\tcode: \"SUCCESS\",\n\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\",\n\t\t\tdata: {\n\t\t\t\tmonth,\n\t\t\t\ttotal_hours: Math.round(totalHours * 10) / 10,\n\t\t\t\tovertime_hours: Math.round(overtimeHours * 10) / 10,\n\t\t\t\tweighted_hours: Math.round(weightedHours * 10) / 10,\n\t\t\t\tleave_hours: Math.round(leaveHours * 10) / 10\n\t\t\t},\n\t\t\tmeta: { requestId }\n\t\t}, corsHeaders);\n\t\t\n\t} catch (err) {\n\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\n\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\n\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\treturn jsonResponse(500, body, corsHeaders);\n\t}\n}\n\n/**\n * \u4E3B\u8DEF\u7531\u8655\u7406\n */\nexport async function handleTimesheets(request, env, me, requestId, url) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\tconst method = request.method.toUpperCase();\n\t\n\t// GET /api/v1/timelogs/summary - \u6708\u7D71\u8A08\n\tif (method === \"GET\" && url.pathname.endsWith(\"/summary\")) {\n\t\treturn handleGetMonthlySummary(request, env, me, requestId, url);\n\t}\n\t\n\t// GET /api/v1/timelogs\n\tif (method === \"GET\") {\n\t\treturn handleGetTimelogs(request, env, me, requestId, url);\n\t}\n\t\n\t// POST /api/v1/timelogs\n\tif (method === \"POST\") {\n\t\treturn handlePostTimelogs(request, env, me, requestId, url);\n\t}\n\t\n\t// DELETE /api/v1/timelogs/batch\n\tif (method === \"DELETE\" && url.pathname.endsWith(\"/batch\")) {\n\t\treturn handleDeleteTimelogsBatch(request, env, me, requestId, url);\n\t}\n\t\n\treturn jsonResponse(405, { \n\t\tok: false, \n\t\tcode: \"METHOD_NOT_ALLOWED\", \n\t\tmessage: \"\u65B9\u6CD5\u4E0D\u5141\u8A31\", \n\t\tmeta: { requestId } \n\t}, corsHeaders);\n}\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nexport async function handleReceipts(request, env, me, requestId, url) {\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\tconst method = request.method.toUpperCase();\r\n\tconst path = url.pathname;\r\n\r\n\t// GET /internal/api/v1/receipts/suggest-amount - \u6839\u636E\u670D\u52A1\u548C\u6708\u4EFD\u5EFA\u8BAE\u91D1\u989D\r\n\tif (method === \"GET\" && path === \"/internal/api/v1/receipts/suggest-amount\") {\r\n\t\tconst clientServiceId = parseInt(url.searchParams.get(\"client_service_id\") || \"0\", 10);\r\n\t\tconst billingMonth = parseInt(url.searchParams.get(\"billing_month\") || \"0\", 10);\r\n\r\n\t\tif (!clientServiceId || billingMonth < 1 || billingMonth > 12) {\r\n\t\t\treturn jsonResponse(400, { \r\n\t\t\t\tok: false, \r\n\t\t\t\tcode: \"BAD_REQUEST\", \r\n\t\t\t\tmessage: \"\u8BF7\u63D0\u4F9B\u6709\u6548\u7684client_service_id\u548Cbilling_month\uFF081-12\uFF09\", \r\n\t\t\t\tmeta: { requestId } \r\n\t\t\t}, corsHeaders);\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\t// \u67E5\u8BE2\u6536\u8D39\u660E\u7EC6\r\n\t\t\tconst schedule = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT billing_amount, payment_due_days \r\n\t\t\t\t FROM ServiceBillingSchedule \r\n\t\t\t\t WHERE client_service_id = ? AND billing_month = ?`\r\n\t\t\t).bind(clientServiceId, billingMonth).first();\r\n\r\n\t\t\tif (!schedule) {\r\n\t\t\t\treturn jsonResponse(200, {\r\n\t\t\t\t\tok: true,\r\n\t\t\t\t\tcode: \"OK\",\r\n\t\t\t\t\tmessage: \"\u8BE5\u6708\u4EFD\u672A\u8BBE\u5B9A\u6536\u8D39\",\r\n\t\t\t\t\tdata: {\r\n\t\t\t\t\t\tsuggested_amount: 0,\r\n\t\t\t\t\t\tpayment_due_days: 30,\r\n\t\t\t\t\t\thas_schedule: false\r\n\t\t\t\t\t},\r\n\t\t\t\t\tmeta: { requestId }\r\n\t\t\t\t}, corsHeaders);\r\n\t\t\t}\r\n\r\n\t\t\treturn jsonResponse(200, {\r\n\t\t\t\tok: true,\r\n\t\t\t\tcode: \"OK\",\r\n\t\t\t\tmessage: \"\u6210\u529F\u83B7\u53D6\u5EFA\u8BAE\u91D1\u989D\",\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tsuggested_amount: Number(schedule.billing_amount || 0),\r\n\t\t\t\t\tpayment_due_days: Number(schedule.payment_due_days || 30),\r\n\t\t\t\t\thas_schedule: true\r\n\t\t\t\t},\r\n\t\t\t\tmeta: { requestId }\r\n\t\t\t}, corsHeaders);\r\n\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\t// GET /internal/api/v1/receipts - \u6536\u636E\u5217\u8868\r\n\tif (method === \"GET\" && path === \"/internal/api/v1/receipts\") {\r\n\t\ttry {\r\n\t\t\tconst params = url.searchParams;\r\n\t\t\tconst page = Math.max(1, parseInt(params.get(\"page\") || \"1\", 10));\r\n\t\t\tconst perPage = Math.min(100, Math.max(1, parseInt(params.get(\"perPage\") || \"20\", 10)));\r\n\t\t\tconst offset = (page - 1) * perPage;\r\n\t\t\tconst q = (params.get(\"q\") || \"\").trim();\r\n\t\t\tconst status = (params.get(\"status\") || \"\").trim();\r\n\t\t\tconst receiptType = (params.get(\"receipt_type\") || \"\").trim();\r\n\t\t\tconst dateFrom = (params.get(\"dateFrom\") || \"\").trim();\r\n\t\t\tconst dateTo = (params.get(\"dateTo\") || \"\").trim();\r\n\t\t\tconst where = [\"r.is_deleted = 0\"];\r\n\t\t\tconst binds = [];\r\n\t\t\tif (q) { where.push(\"(r.receipt_id LIKE ? OR c.company_name LIKE ?)\"); binds.push(`%${q}%`, `%${q}%`); }\r\n\t\t\tif (status && [\"unpaid\",\"partial\",\"paid\",\"cancelled\"].includes(status)) { where.push(\"r.status = ?\"); binds.push(status); }\r\n\t\t\tif (receiptType && [\"normal\",\"prepayment\",\"deposit\"].includes(receiptType)) { where.push(\"r.receipt_type = ?\"); binds.push(receiptType); }\r\n\t\t\tif (dateFrom) { where.push(\"r.receipt_date >= ?\"); binds.push(dateFrom); }\r\n\t\t\tif (dateTo) { where.push(\"r.receipt_date <= ?\"); binds.push(dateTo); }\r\n\t\t\tconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n\t\t\tconst countRow = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT COUNT(1) AS total FROM Receipts r LEFT JOIN Clients c ON c.client_id = r.client_id ${whereSql}`\r\n\t\t\t).bind(...binds).first();\r\n\t\t\tconst total = Number(countRow?.total || 0);\r\n\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT r.receipt_id, r.client_id, c.company_name AS client_name, r.total_amount, \r\n\t\t\t\t        r.receipt_date, r.due_date, r.status, r.receipt_type\r\n\t\t\t\t FROM Receipts r LEFT JOIN Clients c ON c.client_id = r.client_id\r\n\t\t\t\t ${whereSql}\r\n\t\t\t\t ORDER BY r.receipt_date DESC, r.receipt_id DESC\r\n\t\t\t\t LIMIT ? OFFSET ?`\r\n\t\t\t).bind(...binds, perPage, offset).all();\r\n\t\t\tconst data = (rows?.results || []).map(r => ({\r\n\t\t\t\treceiptId: r.receipt_id,\r\n\t\t\t\tclientId: r.client_id,\r\n\t\t\t\tclientName: r.client_name || \"\",\r\n\t\t\t\ttotalAmount: Number(r.total_amount || 0),\r\n\t\t\t\treceiptDate: r.receipt_date,\r\n\t\t\t\tdueDate: r.due_date || null,\r\n\t\t\t\tstatus: r.status,\r\n\t\t\t\treceiptType: r.receipt_type || \"normal\",\r\n\t\t\t}));\r\n\t\t\tconst meta = { requestId, page, perPage, total, hasNext: offset + perPage < total };\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t}\r\n\t}\r\n\r\n\tif (method === \"POST\" && path === \"/internal/api/v1/receipts\") {\r\n\t\tlet body;\r\n\t\ttry { body = await request.json(); } catch (_) {\r\n\t\t\treturn jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t\tconst client_id = String(body?.client_id || \"\").trim();\r\n\t\tconst receipt_date = String(body?.receipt_date || \"\").trim();\r\n\t\tconst due_date_raw = String(body?.due_date || \"\").trim();\r\n\t\tconst total_amount = Number(body?.total_amount);\r\n\t\tlet statusVal = String(body?.status || \"unpaid\").trim();\r\n\t\tconst notes = (body?.notes || \"\").trim();\r\n\t\t\r\n\t\t// \u65B0\u5B57\u6BB5\r\n\t\tlet receiptType = String(body?.receipt_type || \"normal\").trim();\r\n\t\tconst relatedTaskId = body?.related_task_id ? parseInt(body.related_task_id, 10) : null;\r\n\t\tconst clientServiceId = body?.client_service_id ? parseInt(body.client_service_id, 10) : null;\r\n\t\tconst billingMonth = body?.billing_month ? parseInt(body.billing_month, 10) : null;\r\n\t\t\r\n\t\tconst errors = [];\r\n\t\tif (!client_id) errors.push({ field:\"client_id\", message:\"\u5FC5\u586B\" });\r\n\t\tif (!/^\\d{4}-\\d{2}-\\d{2}$/.test(receipt_date)) errors.push({ field:\"receipt_date\", message:\"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD\" });\r\n\t\tif (!Number.isFinite(total_amount) || total_amount <= 0) errors.push({ field:\"total_amount\", message:\"\u5FC5\u9808\u5927\u65BC 0\" });\r\n\t\tif (!statusVal) statusVal = \"unpaid\";\r\n\t\tif (![\"unpaid\",\"partial\",\"paid\",\"cancelled\"].includes(statusVal)) errors.push({ field:\"status\", message:\"\u72C0\u614B\u4E0D\u5408\u6CD5\" });\r\n\t\tif (![\"normal\",\"prepayment\",\"deposit\"].includes(receiptType)) {\r\n\t\t\treceiptType = \"normal\"; // \u9ED8\u8BA4\u4E3Anormal\r\n\t\t}\r\n\t\tif (billingMonth && (billingMonth < 1 || billingMonth > 12)) {\r\n\t\t\terrors.push({ field:\"billing_month\", message:\"\u6708\u4EFD\u5FC5\u987B\u57281-12\u4E4B\u95F4\" });\r\n\t\t}\r\n\t\tif (errors.length) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\r\n\r\n\t\ttry {\r\n\t\t\t// \u9A57\u8B49\u5BA2\u6236\u5B58\u5728\r\n\t\t\tconst c = await env.DATABASE.prepare(\"SELECT 1 FROM Clients WHERE client_id = ? AND is_deleted = 0 LIMIT 1\").bind(client_id).first();\r\n\t\t\tif (!c) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u5BA2\u6236\u4E0D\u5B58\u5728\", errors:[{ field:\"client_id\", message:\"\u4E0D\u5B58\u5728\" }], meta:{ requestId } }, corsHeaders);\r\n\r\n\t\t\t// \u7522\u751F\u6536\u64DA\u865F\uFF1AYYYYMM-XXX\r\n\t\t\tconst [yyyy, mm] = receipt_date.split(\"-\");\r\n\t\t\tconst prefix = `${yyyy}${mm}`;\r\n\t\t\tconst maxRow = await env.DATABASE.prepare(\"SELECT receipt_id FROM Receipts WHERE receipt_id LIKE ? ORDER BY receipt_id DESC LIMIT 1\").bind(`${prefix}-%`).first();\r\n\t\t\tlet seq = 1;\r\n\t\t\tif (maxRow && typeof maxRow.receipt_id === \"string\") {\r\n\t\t\t\tconst m = maxRow.receipt_id.match(/^(\\d{6})-(\\d{3})$/);\r\n\t\t\t\tif (m) seq = Math.max(seq, parseInt(m[2], 10) + 1);\r\n\t\t\t}\r\n\t\t\tconst receipt_id = `${prefix}-${String(seq).padStart(3, \"0\")}`;\r\n\r\n\t\t\t// \u5230\u671F\u65E5\uFF1A\u672A\u63D0\u4F9B\u5247\u6839\u636E\u6536\u8D39\u660E\u7EC6\u6216\u9ED8\u8BA4+30\u5929\r\n\t\t\tlet due_date = due_date_raw;\r\n\t\t\tif (!due_date) {\r\n\t\t\t\tlet dueDays = 30; // \u9ED8\u8BA430\u5929\r\n\t\t\t\t\r\n\t\t\t\t// \u5982\u679C\u63D0\u4F9B\u4E86client_service_id\u548Cbilling_month\uFF0C\u5C1D\u8BD5\u4ECE\u6536\u8D39\u660E\u7EC6\u83B7\u53D6payment_due_days\r\n\t\t\t\tif (clientServiceId && billingMonth) {\r\n\t\t\t\t\tconst schedule = await env.DATABASE.prepare(\r\n\t\t\t\t\t\t\"SELECT payment_due_days FROM ServiceBillingSchedule WHERE client_service_id = ? AND billing_month = ?\"\r\n\t\t\t\t\t).bind(clientServiceId, billingMonth).first();\r\n\t\t\t\t\tif (schedule && schedule.payment_due_days) {\r\n\t\t\t\t\t\tdueDays = Number(schedule.payment_due_days);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconst d = new Date(receipt_date + \"T00:00:00Z\");\r\n\t\t\t\td.setUTCDate(d.getUTCDate() + dueDays);\r\n\t\t\t\tconst y = d.getUTCFullYear();\r\n\t\t\t\tconst m2 = String(d.getUTCMonth() + 1).padStart(2, \"0\");\r\n\t\t\t\tconst day = String(d.getUTCDate()).padStart(2, \"0\");\r\n\t\t\t\tdue_date = `${y}-${m2}-${day}`;\r\n\t\t\t}\r\n\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t`INSERT INTO Receipts (receipt_id, client_id, receipt_date, due_date, total_amount, status, \r\n\t\t\t\t receipt_type, related_task_id, client_service_id, billing_month, \r\n\t\t\t\t is_auto_generated, notes, created_by, created_at, updated_at) \r\n\t\t\t\t VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0, ?, ?, ?, ?)`\r\n\t\t\t).bind(\r\n\t\t\t\treceipt_id, client_id, receipt_date, due_date, total_amount, statusVal, \r\n\t\t\t\treceiptType, relatedTaskId, clientServiceId, billingMonth,\r\n\t\t\t\tnotes, String(me.user_id), new Date().toISOString(), new Date().toISOString()\r\n\t\t\t).run();\r\n\t\t\t\r\n\t\t\tconst data = { \r\n\t\t\t\treceiptId: receipt_id, \r\n\t\t\t\tclientId: client_id, \r\n\t\t\t\ttotalAmount: total_amount, \r\n\t\t\t\treceiptDate: receipt_date, \r\n\t\t\t\tdueDate: due_date, \r\n\t\t\t\tstatus: statusVal,\r\n\t\t\t\treceiptType: receiptType,\r\n\t\t\t\trelatedTaskId: relatedTaskId,\r\n\t\t\t\tclientServiceId: clientServiceId,\r\n\t\t\t\tbillingMonth: billingMonth\r\n\t\t\t};\r\n\t\t\treturn jsonResponse(201, { ok:true, code:\"CREATED\", message:\"\u5DF2\u5EFA\u7ACB\", data, meta:{ requestId } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path: url.pathname, err:String(err) }));\r\n\t\t\tconst body = { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\treturn jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nexport async function handlePayroll(request, env, me, requestId, url, path) {\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\t\r\n\t// \u85AA\u8CC7\u529F\u80FD\u5C1A\u672A\u5BE6\u4F5C\r\n\treturn jsonResponse(501, { \r\n\t\tok: false, \r\n\t\tcode: \"NOT_IMPLEMENTED\", \r\n\t\tmessage: \"\u85AA\u8CC7\u529F\u80FD\u5C1A\u672A\u5BE6\u4F5C\", \r\n\t\tmeta: { requestId } \r\n\t}, corsHeaders);\r\n}\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\n\nexport async function handleLeaves(request, env, me, requestId, url, path) {\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\n\tconst method = request.method.toUpperCase();\n\n\tif (path === \"/internal/api/v1/leaves/balances\") {\n\t\tif (method !== \"GET\") {\n\t\t\treturn jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\ttry {\n\t\t\tconst params = url.searchParams; const year = parseInt(params.get(\"year\") || String(new Date().getFullYear()), 10);\n\t\t\tconst rows = await env.DATABASE.prepare(\n\t\t\t\t\"SELECT leave_type, year, total, used, remain FROM LeaveBalances WHERE user_id = ? AND year = ?\"\n\t\t\t).bind(String(me.user_id), year).all();\n\t\t\tconst data = (rows?.results || []).map(r => ({ type: r.leave_type, year: Number(r.year), total: Number(r.total), used: Number(r.used), remain: Number(r.remain) }));\n\t\t\t\n\t\t\t// \u88DC\u4F11\u9918\u984D\u5F9E CompensatoryLeaveGrants \u8A08\u7B97\uFF08\u7576\u6708\u6709\u6548\uFF09\n\t\t\tconst compRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT SUM(hours_remaining) as total FROM CompensatoryLeaveGrants \n\t\t\t\t WHERE user_id = ? AND status = 'active' AND hours_remaining > 0`\n\t\t\t).bind(String(me.user_id)).first();\n\t\t\tconst compRemain = Number(compRow?.total || 0);\n\t\t\t\n\t\t\tif (compRemain > 0) {\n\t\t\t\tdata.push({ type: 'comp', year, total: compRemain, used: 0, remain: compRemain });\n\t\t\t}\n\t\t\t\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, year } }, corsHeaders);\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\tif (path === \"/internal/api/v1/leaves\") {\n\t\tif (method === \"GET\") {\n\t\t\ttry {\n\t\t\t\tconst params = url.searchParams;\n\t\t\t\tconst page = Math.max(1, parseInt(params.get(\"page\") || \"1\", 10));\n\t\t\t\tconst perPage = Math.min(100, Math.max(1, parseInt(params.get(\"perPage\") || \"20\", 10)));\n\t\t\t\tconst offset = (page - 1) * perPage;\n\t\t\t\tconst q = (params.get(\"q\") || \"\").trim();\n\t\t\t\tconst status = (params.get(\"status\") || \"\").trim();\n\t\t\t\tconst type = (params.get(\"type\") || \"\").trim();\n\t\t\t\tconst dateFrom = (params.get(\"dateFrom\") || \"\").trim();\n\t\t\t\tconst dateTo = (params.get(\"dateTo\") || \"\").trim();\n\t\t\t\tconst where = [\"l.is_deleted = 0\"];\n\t\t\t\tconst binds = [];\n\t\t\t\tif (!me.is_admin) { where.push(\"l.user_id = ?\"); binds.push(String(me.user_id)); }\n\t\t\t\tif (q) { where.push(\"(l.reason LIKE ? OR l.leave_type LIKE ?)\"); binds.push(`%${q}%`, `%${q}%`); }\n\t\t\t\tif (status && [\"pending\",\"approved\",\"rejected\"].includes(status)) { where.push(\"l.status = ?\"); binds.push(status); }\n\t\t\t\tif (type) { where.push(\"l.leave_type = ?\"); binds.push(type); }\n\t\t\t\tif (dateFrom) { where.push(\"l.start_date >= ?\"); binds.push(dateFrom); }\n\t\t\t\tif (dateTo) { where.push(\"l.end_date <= ?\"); binds.push(dateTo); }\n\t\t\t\tconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\n\t\t\t\tconst countRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM LeaveRequests l ${whereSql}`).bind(...binds).first();\n\t\t\t\tconst total = Number(countRow?.total || 0);\n\t\t\t\tconst rows = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT l.leave_id, l.leave_type, l.start_date, l.end_date, l.unit, l.amount, l.reason, l.status, l.submitted_at\n\t\t\t\t\t FROM LeaveRequests l\n\t\t\t\t\t ${whereSql}\n\t\t\t\t\t ORDER BY l.submitted_at DESC, l.leave_id DESC\n\t\t\t\t\t LIMIT ? OFFSET ?`\n\t\t\t\t).bind(...binds, perPage, offset).all();\n\t\t\t\tconst data = (rows?.results || []).map(r => ({\n\t\t\t\t\tleaveId: String(r.leave_id),\n\t\t\t\t\ttype: r.leave_type,\n\t\t\t\t\tstart: r.start_date,\n\t\t\t\t\tend: r.end_date,\n\t\t\t\t\tunit: r.unit,\n\t\t\t\t\tamount: Number(r.amount || 0),\n\t\t\t\t\treason: r.reason || \"\",\n\t\t\t\t\tstatus: r.status,\n\t\t\t\t\tsubmittedAt: r.submitted_at,\n\t\t\t\t}));\n\t\t\t\tconst meta = { requestId, page, perPage, total, hasNext: offset + perPage < total };\n\t\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta }, corsHeaders);\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\t\tconst body = { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } };\n\t\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\n\t\t\t\treturn jsonResponse(500, body, getCorsHeadersForRequest(request, env));\n\t\t\t}\n\t\t}\n\n\t\tif (method === \"POST\") {\n\t\t\tlet body;\n\t\t\ttry { body = await request.json(); } catch (_) {\n\t\t\t\treturn jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t\tconst leave_type = String(body?.leave_type || \"\").trim();\n\t\t\tconst start_date = String(body?.start_date || \"\").trim();\n\t\t\tconst end_date = String(body?.end_date || \"\").trim();\n\t\t\tconst unit = String(body?.unit || \"day\").trim();\n\t\t\tconst amount = Number(body?.amount);\n\t\t\tconst reason = (body?.reason || \"\").trim();\n\t\t\tconst errors = [];\n\t\t\tif (!leave_type) errors.push({ field:\"leave_type\", message:\"\u5FC5\u9078\u5047\u5225\" });\n\t\t\tif (!/^\\d{4}-\\d{2}-\\d{2}$/.test(start_date)) errors.push({ field:\"start_date\", message:\"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD\" });\n\t\t\tif (!/^\\d{4}-\\d{2}-\\d{2}$/.test(end_date)) errors.push({ field:\"end_date\", message:\"\u65E5\u671F\u683C\u5F0F YYYY-MM-DD\" });\n\t\t\tif (start_date && end_date && end_date < start_date) errors.push({ field:\"end_date\", message:\"\u7D50\u675F\u65E5\u671F\u4E0D\u53EF\u65E9\u65BC\u958B\u59CB\u65E5\u671F\" });\n\t\t\tif (![\"day\",\"half\",\"hour\"].includes(unit)) errors.push({ field:\"unit\", message:\"\u55AE\u4F4D\u932F\u8AA4\" });\n\t\t\tif (!Number.isFinite(amount) || amount <= 0) errors.push({ field:\"amount\", message:\"\u9700\u5927\u65BC 0\" });\n\t\t\t// \u5982\u679C\u55AE\u4F4D\u662F\u5C0F\u6642\uFF0C\u9A57\u8B49\u5FC5\u9808\u662F 0.5 \u7684\u500D\u6578\uFF08\u8207\u5DE5\u6642\u7CFB\u7D71\u4FDD\u6301\u4E00\u81F4\uFF09\n\t\t\tif (unit === 'hour' && Math.abs(amount * 2 - Math.round(amount * 2)) > 1e-9) {\n\t\t\t\terrors.push({ field:\"amount\", message:\"\u8ACB\u5047\u5C0F\u6642\u6578\u5FC5\u9808\u662F 0.5 \u7684\u500D\u6578\uFF08\u4F8B\u5982\uFF1A0.5\u30011\u30011.5\u30012\uFF09\" });\n\t\t\t}\n\t\t\tif (reason.length > 200) errors.push({ field:\"reason\", message:\"\u8ACB\u52FF\u8D85\u904E 200 \u5B57\" });\n\t\t\tif ([\"maternity\",\"menstrual\"].includes(leave_type) && me.gender === 'M') errors.push({ field:\"leave_type\", message:\"\u6B64\u5047\u5225\u50C5\u9650\u5973\u6027\" });\n\t\t\tif (leave_type === 'paternity' && me.gender === 'F') errors.push({ field:\"leave_type\", message:\"\u6B64\u5047\u5225\u50C5\u9650\u7537\u6027\" });\n\t\t\t\n\t\t\t// \u88DC\u4F11\u7279\u6B8A\u8655\u7406\uFF1A\u6AA2\u67E5\u9918\u984D\uFF08FIFO\uFF09\n\t\t\tif (leave_type === 'comp') {\n\t\t\t\tconst hoursNeeded = unit === 'hour' ? amount : (unit === 'half' ? 4 : 8) * amount;\n\t\t\t\tconst compGrants = await env.DATABASE.prepare(\n\t\t\t\t\t`SELECT grant_id, hours_remaining FROM CompensatoryLeaveGrants \n\t\t\t\t\t WHERE user_id = ? AND status = 'active' AND hours_remaining > 0 \n\t\t\t\t\t ORDER BY generated_date ASC`\n\t\t\t\t).bind(String(me.user_id)).all();\n\t\t\t\tconst totalAvailable = (compGrants?.results || []).reduce((sum, g) => sum + Number(g.hours_remaining || 0), 0);\n\t\t\t\tif (totalAvailable < hoursNeeded) {\n\t\t\t\t\terrors.push({ field:\"amount\", message:`\u88DC\u4F11\u4E0D\u8DB3\uFF08\u5269\u9918 ${totalAvailable} \u5C0F\u6642\uFF0C\u9700\u8981 ${hoursNeeded} \u5C0F\u6642\uFF09` });\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tif (errors.length) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\n\n\t\t\ttry {\n\t\t\t\t// \u5EFA\u7ACB\u8ACB\u5047\u7533\u8ACB\n\t\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\t\"INSERT INTO LeaveRequests (user_id, leave_type, start_date, end_date, unit, amount, reason, status, submitted_at) VALUES (?, ?, ?, ?, ?, ?, ?, 'pending', datetime('now'))\"\n\t\t\t\t).bind(String(me.user_id), leave_type, start_date, end_date, unit, amount, reason).run();\n\t\t\t\tconst idRow = await env.DATABASE.prepare(\"SELECT last_insert_rowid() AS id\").first();\n\t\t\t\tconst leaveId = String(idRow?.id);\n\t\t\t\t\n\t\t\t\t// \u5982\u679C\u662F\u88DC\u4F11\uFF0C\u7ACB\u5373\u6263\u6E1B\uFF08FIFO\uFF09\n\t\t\t\tif (leave_type === 'comp') {\n\t\t\t\t\tconst hoursNeeded = unit === 'hour' ? amount : (unit === 'half' ? 4 : 8) * amount;\n\t\t\t\t\tconst compGrants = await env.DATABASE.prepare(\n\t\t\t\t\t\t`SELECT grant_id, hours_remaining FROM CompensatoryLeaveGrants \n\t\t\t\t\t\t WHERE user_id = ? AND status = 'active' AND hours_remaining > 0 \n\t\t\t\t\t\t ORDER BY generated_date ASC`\n\t\t\t\t\t).bind(String(me.user_id)).all();\n\t\t\t\t\t\n\t\t\t\t\tlet remaining = hoursNeeded;\n\t\t\t\t\tfor (const grant of (compGrants?.results || [])) {\n\t\t\t\t\t\tif (remaining <= 0) break;\n\t\t\t\t\t\tconst deduct = Math.min(remaining, Number(grant.hours_remaining || 0));\n\t\t\t\t\t\tconst newRemaining = Number(grant.hours_remaining || 0) - deduct;\n\t\t\t\t\t\tconst newUsed = (await env.DATABASE.prepare(`SELECT hours_used FROM CompensatoryLeaveGrants WHERE grant_id = ?`).bind(grant.grant_id).first())?.hours_used || 0;\n\t\t\t\t\t\tconst newStatus = newRemaining <= 0 ? 'fully_used' : 'active';\n\t\t\t\t\t\t\n\t\t\t\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\t\t\t`UPDATE CompensatoryLeaveGrants \n\t\t\t\t\t\t\t SET hours_used = ?, hours_remaining = ?, status = ? \n\t\t\t\t\t\t\t WHERE grant_id = ?`\n\t\t\t\t\t\t).bind(Number(newUsed) + deduct, newRemaining, newStatus, grant.grant_id).run();\n\t\t\t\t\t\t\n\t\t\t\t\t\tremaining -= deduct;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\treturn jsonResponse(201, { ok:true, code:\"CREATED\", message:\"\u5DF2\u9001\u51FA\u5BE9\u6838\", data:{ leaveId }, meta:{ requestId } }, corsHeaders);\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t\t}\n\t\t}\n\t}\n\n\t// Cron Job: \u624B\u52D5\u89F8\u767C\u88DC\u4F11\u5230\u671F\u8F49\u52A0\u73ED\u8CBB\n\tif (path === \"/internal/api/v1/admin/cron/execute\" && method === \"POST\") {\n\t\tif (!me?.is_admin) {\n\t\t\treturn jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tlet body;\n\t\ttry { body = await request.json(); } catch (_) {\n\t\t\treturn jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\tconst jobName = String(body?.job_name || '').trim();\n\t\tif (jobName !== 'comp_leave_expiry') {\n\t\t\treturn jsonResponse(400, { ok:false, code:\"INVALID_JOB\", message:\"\u4E0D\u652F\u63F4\u7684 Job \u540D\u7A31\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\ttry {\n\t\t\t// \u8A08\u7B97\u4E0A\u6708\u5E95\u65E5\u671F\n\t\t\tconst now = new Date();\n\t\t\tconst lastMonth = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() - 1, 1));\n\t\t\tconst lastDayOfLastMonth = new Date(Date.UTC(lastMonth.getUTCFullYear(), lastMonth.getUTCMonth() + 1, 0));\n\t\t\tconst expiryDate = `${lastDayOfLastMonth.getUTCFullYear()}-${String(lastDayOfLastMonth.getUTCMonth() + 1).padStart(2, '0')}-${String(lastDayOfLastMonth.getUTCDate()).padStart(2, '0')}`;\n\t\t\tconst currentMonth = `${now.getUTCFullYear()}-${String(now.getUTCMonth() + 1).padStart(2, '0')}`;\n\t\t\t\n\t\t\t// \u6383\u63CF\u5230\u671F\u7684\u88DC\u4F11\u8A18\u9304\n\t\t\tconst expiredGrants = await env.DATABASE.prepare(\n\t\t\t\t`SELECT g.grant_id, g.user_id, g.hours_remaining, g.original_rate, u.base_salary\n\t\t\t\t FROM CompensatoryLeaveGrants g\n\t\t\t\t LEFT JOIN Users u ON g.user_id = u.user_id\n\t\t\t\t WHERE g.expiry_date = ? AND g.status = 'active' AND g.hours_remaining > 0`\n\t\t\t).bind(expiryDate).all();\n\t\t\t\n\t\t\tlet processedCount = 0;\n\t\t\tconst grantIds = [];\n\t\t\t\n\t\t\tfor (const grant of (expiredGrants?.results || [])) {\n\t\t\t\tconst baseSalary = Number(grant.base_salary || 0);\n\t\t\t\tconst hourlyRate = baseSalary / 240;  // \u6708\u85AA \u00F7 240 = \u6642\u85AA\n\t\t\t\tconst hours = Number(grant.hours_remaining || 0);\n\t\t\t\tconst rate = Number(grant.original_rate || 1);\n\t\t\t\tconst amountCents = Math.round(hours * hourlyRate * rate * 100);  // \u8F49\u70BA\u5206\n\t\t\t\t\n\t\t\t\t// \u5BEB\u5165\u52A0\u73ED\u8CBB\u8A18\u9304\n\t\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\t`INSERT INTO CompensatoryOvertimePay \n\t\t\t\t\t (user_id, year_month, hours_expired, amount_cents, source_grant_ids)\n\t\t\t\t\t VALUES (?, ?, ?, ?, ?)`\n\t\t\t\t).bind(\n\t\t\t\t\tString(grant.user_id),\n\t\t\t\t\tcurrentMonth,\n\t\t\t\t\thours,\n\t\t\t\t\tamountCents,\n\t\t\t\t\tJSON.stringify([grant.grant_id])\n\t\t\t\t).run();\n\t\t\t\t\n\t\t\t\t// \u66F4\u65B0\u88DC\u4F11\u8A18\u9304\u72C0\u614B\u70BA expired\n\t\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\t`UPDATE CompensatoryLeaveGrants SET status = 'expired' WHERE grant_id = ?`\n\t\t\t\t).bind(grant.grant_id).run();\n\t\t\t\t\n\t\t\t\tgrantIds.push(grant.grant_id);\n\t\t\t\tprocessedCount++;\n\t\t\t}\n\t\t\t\n\t\t\t// \u8A18\u9304 Cron \u57F7\u884C\n\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t`INSERT INTO CronJobExecutions \n\t\t\t\t (job_name, status, executed_at, details)\n\t\t\t\t VALUES (?, 'success', datetime('now'), ?)`\n\t\t\t).bind(jobName, JSON.stringify({ \n\t\t\t\texpiryDate, \n\t\t\t\tprocessedCount, \n\t\t\t\tgrantIds,\n\t\t\t\tcurrentMonth \n\t\t\t})).run();\n\t\t\t\n\t\t\treturn jsonResponse(200, { \n\t\t\t\tok:true, \n\t\t\t\tcode:\"SUCCESS\", \n\t\t\t\tmessage:`\u5DF2\u8655\u7406 ${processedCount} \u7B46\u5230\u671F\u88DC\u4F11`, \n\t\t\t\tdata:{ \n\t\t\t\t\tprocessedCount, \n\t\t\t\t\texpiryDate, \n\t\t\t\t\tcurrentMonth \n\t\t\t\t}, \n\t\t\t\tmeta:{ requestId } \n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\t\n\t\t\t// \u8A18\u9304\u5931\u6557\n\t\t\ttry {\n\t\t\t\tawait env.DATABASE.prepare(\n\t\t\t\t\t`INSERT INTO CronJobExecutions \n\t\t\t\t\t (job_name, status, executed_at, error_message)\n\t\t\t\t\t VALUES (?, 'failed', datetime('now'), ?)`\n\t\t\t\t).bind(jobName, String(err)).run();\n\t\t\t} catch (_) {}\n\t\t\t\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\t\n\t// Cron Job: \u67E5\u8A62\u57F7\u884C\u6B77\u53F2\n\tif (path === \"/internal/api/v1/admin/cron/history\" && method === \"GET\") {\n\t\tif (!me?.is_admin) {\n\t\t\treturn jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t\t\n\t\ttry {\n\t\t\tconst params = url.searchParams;\n\t\t\tconst jobName = params.get('job_name') || '';\n\t\t\tconst page = Math.max(1, parseInt(params.get('page') || '1', 10));\n\t\t\tconst perPage = Math.min(100, Math.max(1, parseInt(params.get('perPage') || '20', 10)));\n\t\t\tconst offset = (page - 1) * perPage;\n\t\t\t\n\t\t\tconst whereSql = jobName ? 'WHERE job_name = ?' : '';\n\t\t\tconst binds = jobName ? [jobName] : [];\n\t\t\t\n\t\t\tconst totalRow = await env.DATABASE.prepare(\n\t\t\t\t`SELECT COUNT(1) AS total FROM CronJobExecutions ${whereSql}`\n\t\t\t).bind(...binds).first();\n\t\t\t\n\t\t\tconst rows = await env.DATABASE.prepare(\n\t\t\t\t`SELECT execution_id, job_name, status, executed_at, details, error_message\n\t\t\t\t FROM CronJobExecutions ${whereSql}\n\t\t\t\t ORDER BY executed_at DESC LIMIT ? OFFSET ?`\n\t\t\t).bind(...binds, perPage, offset).all();\n\t\t\t\n\t\t\tconst data = (rows?.results || []).map(r => ({\n\t\t\t\tid: r.execution_id,\n\t\t\t\tjobName: r.job_name,\n\t\t\t\tstatus: r.status,\n\t\t\t\texecutedAt: r.executed_at,\n\t\t\t\tdetails: r.details ? JSON.parse(r.details) : null,\n\t\t\t\terrorMessage: r.error_message\n\t\t\t}));\n\t\t\t\n\t\t\treturn jsonResponse(200, { \n\t\t\t\tok:true, \n\t\t\t\tcode:\"OK\", \n\t\t\t\tmessage:\"\u6210\u529F\", \n\t\t\t\tdata, \n\t\t\t\tmeta:{ \n\t\t\t\t\trequestId, \n\t\t\t\t\tpage, \n\t\t\t\t\tperPage, \n\t\t\t\t\ttotal: Number(totalRow?.total || 0) \n\t\t\t\t} \n\t\t\t}, corsHeaders);\n\t\t\t\n\t\t} catch (err) {\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\n\t\t}\n\t}\n\n\treturn jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\n}\n\n\n\n", "import { jsonResponse, getCorsHeadersForRequest, getCookie, hashPasswordPBKDF2 } from \"../utils.js\";\r\n\r\nexport async function handleDevSeeding(request, env, requestId, path) {\r\n\t// \u50C5\u975E prod \u53EF\u7528\r\n\tif (env.APP_ENV === \"prod\") {\r\n\t\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } });\r\n\t}\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\r\n\t// /internal/api/v1/admin/dev-debug-cookie\r\n\tif (path === \"/internal/api/v1/admin/dev-debug-cookie\") {\r\n\t\tconst cookieName = String(env.SESSION_COOKIE_NAME || \"session\");\r\n\t\tconst sid = getCookie(request, cookieName);\r\n\t\tlet exists = null; let exp = null;\r\n\t\tif (sid && env.DATABASE) {\r\n\t\t\tconst row = await env.DATABASE.prepare(\"SELECT id, expires_at FROM sessions WHERE id = ? LIMIT 1\").bind(sid).first();\r\n\t\t\texists = !!row;\r\n\t\t\texp = row?.expires_at || null;\r\n\t\t}\r\n\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data:{ cookieName, sid, exists, exp }, meta:{ requestId } }, corsHeaders);\r\n\t}\r\n\r\n\tif (request.method.toUpperCase() !== \"POST\") {\r\n\t\treturn jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n\t}\r\n\r\n\t// /internal/api/v1/admin/dev-seed-user\r\n\tif (path === \"/internal/api/v1/admin/dev-seed-user\") {\r\n\t\tlet body; try { body = await request.json(); } catch (_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n\t\tconst username = (body?.username || \"\").trim().toLowerCase();\r\n\t\tconst name = (body?.name || \"\u6E2C\u8A66\u7528\u6236\").trim();\r\n\t\tconst password = body?.password || \"changeme\";\r\n\t\tlet email = (body?.email || \"\").trim();\r\n\t\tif (!username || !password) {\r\n\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"username/password \u5FC5\u586B\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t\ttry {\r\n\t\t\tconst exists = await env.DATABASE.prepare(\"SELECT user_id FROM Users WHERE LOWER(username) = ? LIMIT 1\").bind(username).first();\r\n\t\t\tif (!email) email = `${username}@example.com`;\r\n\t\t\tconst passwordHash = await hashPasswordPBKDF2(password);\r\n\t\t\tif (exists) {\r\n\t\t\t\tawait env.DATABASE.prepare(\"UPDATE Users SET username = ?, name = ?, email = ?, password_hash = ?, updated_at = ? WHERE user_id = ?\").bind(username, name, email, passwordHash, new Date().toISOString(), exists.user_id).run();\r\n\t\t\t} else {\r\n\t\t\t\tawait env.DATABASE.prepare(\"INSERT INTO Users (username, password_hash, name, email, gender, start_date, created_at, updated_at) VALUES (?, ?, ?, ?, 'M', date('now'), datetime('now'), datetime('now'))\").bind(username, passwordHash, name, email).run();\r\n\t\t\t}\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u5EFA\u7ACB/\u66F4\u65B0\u6E2C\u8A66\u7528\u6236\", data:{ username, email }, meta:{ requestId } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\tconst body = { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\t// /internal/api/v1/admin/dev-seed-clients\r\n\tif (path === \"/internal/api/v1/admin/dev-seed-clients\") {\r\n\t\ttry {\r\n\t\t\tawait env.DATABASE.prepare(\"INSERT OR IGNORE INTO CustomerTags(tag_id, tag_name, tag_color) VALUES (1,'\u4E00\u822C','#3b5bdb'),(2,'VIP','#ef4444')\").run();\r\n\t\t\tconst now = new Date().toISOString();\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\"INSERT OR IGNORE INTO Clients(client_id, company_name, tax_registration_number, assignee_user_id, phone, email, created_at, updated_at) VALUES \" +\r\n\t\t\t\t\"('c_001','\u661F\u6CB3\u8CC7\u8A0A\u80A1\u4EFD\u6709\u9650\u516C\u53F8','12345678',1,'02-1234-5678','contact@galaxy.com',?,?),\" +\r\n\t\t\t\t\"('c_002','\u677E\u67CF\u6709\u9650\u516C\u53F8','87654321',1,'02-8765-4321','service@pine.com',?,?),\" +\r\n\t\t\t\t\"('c_003','\u5B89\u548C\u9867\u554F\u80A1\u4EFD\u6709\u9650\u516C\u53F8','11223344',1,'02-5566-7788','info@anhe.com',?,?)\"\r\n\t\t\t).bind(now, now, now, now, now, now).run();\r\n\t\t\tawait env.DATABASE.prepare(\"INSERT OR IGNORE INTO ClientTagAssignments(client_id, tag_id) VALUES ('c_001',1),('c_001',2),('c_002',2),('c_003',1)\").run();\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u5EFA\u7ACB\u6E2C\u8A66\u5BA2\u6236/\u6A19\u7C64\", meta:{ requestId } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n\t\t\tconst body = { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body);\r\n\t\t}\r\n\t}\r\n\r\n\t// /internal/api/v1/admin/dev-seed-tasks\r\n\tif (path === \"/internal/api/v1/admin/dev-seed-tasks\") {\r\n\t\ttry {\r\n\t\t\tawait env.DATABASE.prepare(\"INSERT OR IGNORE INTO ClientServices(client_id, service_id, status) VALUES ('c_001',1,'active'),('c_002',1,'active'),('c_003',1,'active')\").run();\r\n\t\t\tconst cs1 = await env.DATABASE.prepare(\"SELECT client_service_id FROM ClientServices WHERE client_id='c_001' LIMIT 1\").first();\r\n\t\t\tconst cs2 = await env.DATABASE.prepare(\"SELECT client_service_id FROM ClientServices WHERE client_id='c_002' LIMIT 1\").first();\r\n\t\t\tconst cs3 = await env.DATABASE.prepare(\"SELECT client_service_id FROM ClientServices WHERE client_id='c_003' LIMIT 1\").first();\r\n\t\t\tconst today = new Date();\r\n\t\t\tconst fmt = (d)=> new Date(today.getTime()+d*86400000).toISOString().slice(0,10);\r\n\t\t\tawait env.DATABASE.prepare(\"INSERT INTO ActiveTasks (client_service_id, task_name, due_date, status, assignee_user_id, created_at) VALUES (?,?,?,?,?,datetime('now'))\").bind(cs1.client_service_id, '\u661F\u6CB3\u8CC7\u8A0A \u2212 12 \u6708\u8A18\u5E33', fmt(2), 'pending', 1).run();\r\n\t\t\tawait env.DATABASE.prepare(\"INSERT INTO ActiveTasks (client_service_id, task_name, due_date, status, assignee_user_id, created_at) VALUES (?,?,?,?,?,datetime('now'))\").bind(cs2.client_service_id, '\u677E\u67CF \u2212 12 \u6708\u71DF\u696D\u7A05', fmt(-1), 'in_progress', 1).run();\r\n\t\t\tawait env.DATABASE.prepare(\"INSERT INTO ActiveTasks (client_service_id, task_name, due_date, status, assignee_user_id, created_at) VALUES (?,?,?,?,?,datetime('now'))\").bind(cs3.client_service_id, '\u5B89\u548C \u2212 \u5E74\u5EA6\u7D50\u7B97', fmt(10), 'completed', 1).run();\r\n\t\t\treturn jsonResponse(200, { ok: true, code: \"OK\", message: \"\u5DF2\u5EFA\u7ACB\u6E2C\u8A66\u4EFB\u52D9\", meta: { requestId } });\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body);\r\n\t\t}\r\n\t}\r\n\r\n\t// /internal/api/v1/admin/dev-seed-timesheets\r\n\tif (path === \"/internal/api/v1/admin/dev-seed-timesheets\") {\r\n\t\ttry {\r\n\t\t\tconst today = new Date();\r\n\t\t\tconst d = (off)=> new Date(today.getTime()+off*86400000).toISOString().slice(0,10);\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\"INSERT INTO Timesheets (user_id, work_date, client_id, service_name, work_type, hours, note) VALUES \"+\r\n\t\t\t\t\"(1, ?, 'c_001', '\u8A18\u5E33', 'normal', 2.5, ''),\"+\r\n\t\t\t\t\"(1, ?, 'c_002', '\u71DF\u696D\u7A05', 'ot-weekday', 1.0, '\u52A0\u73ED'),\"+\r\n\t\t\t\t\"(1, ?, 'c_003', '\u7D50\u7B97', 'normal', 3.0, '\u6574\u7406')\"\r\n\t\t\t).bind(d(-2), d(-1), d(0)).run();\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u5EFA\u7ACB\u6E2C\u8A66\u5DE5\u6642\", meta:{ requestId } });\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } });\r\n\t\t}\r\n\t}\r\n\r\n\t// /internal/api/v1/admin/dev-seed-leaves\r\n\tif (path === \"/internal/api/v1/admin/dev-seed-leaves\") {\r\n\t\ttry {\r\n\t\t\tconst y = new Date().getFullYear();\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\"INSERT OR REPLACE INTO LeaveBalances(user_id, leave_type, year, total, used, remain, updated_at) VALUES \"+\r\n\t\t\t\t\"(1,'annual',?,30,3,27,datetime('now')),\"+\r\n\t\t\t\t\"(1,'sick',?,30,1,29,datetime('now')),\"+\r\n\t\t\t\t\"(1,'comp',?,24,16,8,datetime('now'))\"\r\n\t\t\t).bind(y, y, y).run();\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\"INSERT INTO LeaveRequests (user_id, leave_type, start_date, end_date, unit, amount, reason, status, submitted_at) VALUES \"+\r\n\t\t\t\t\"(1,'annual',date('now','-10 day'),date('now','-10 day'),'day',1,'', 'approved', datetime('now','-10 day')),\"+\r\n\t\t\t\t\"(1,'sick',date('now','-25 day'),date('now','-25 day'),'half',0.5,'\u770B\u91AB\u751F','approved', datetime('now','-25 day')),\"+\r\n\t\t\t\t\"(1,'comp',date('now','-5 day'),date('now','-5 day'),'hour',2,'\u52A0\u73ED\u88DC\u4F11','pending', datetime('now','-5 day'))\"\r\n\t\t\t).run();\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u5EFA\u7ACB\u5047\u671F\u9918\u984D\u8207\u7533\u8ACB\u8CC7\u6599\", meta:{ requestId, year:y } });\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } });\r\n\t\t}\r\n\t}\r\n\r\n\t// /internal/api/v1/admin/dev-seed-receipts\r\n\tif (path === \"/internal/api/v1/admin/dev-seed-receipts\") {\r\n\t\ttry {\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\"INSERT OR IGNORE INTO Receipts (receipt_id, client_id, receipt_date, due_date, total_amount, status, is_auto_generated, created_by) VALUES \"+\r\n\t\t\t\t\"('202510-001','c_001','2025-10-01','2025-10-31',12000,'paid',1,1),\"+\r\n\t\t\t\t\"('202510-002','c_002','2025-10-10','2025-10-30',8000,'unpaid',1,1),\"+\r\n\t\t\t\t\"('202509-003','c_003','2025-09-20','2025-10-05',5000,'unpaid',1,1)\"\r\n\t\t\t).run();\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u5EFA\u7ACB\u6E2C\u8A66\u6536\u64DA\", meta:{ requestId } });\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } });\r\n\t\t}\r\n\t}\r\n\r\n\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nexport async function handleOverhead(request, env, me, requestId, url, path) {\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\tconst method = request.method.toUpperCase();\r\n\r\n\tif (path === \"/internal/api/v1/admin/overhead-types\") {\r\n\t\tif (method === \"GET\") {\r\n\t\t\ttry {\r\n\t\t\t\tconst params = url.searchParams;\r\n\t\t\t\tconst page = Math.max(1, parseInt(params.get(\"page\") || \"1\", 10));\r\n\t\t\t\tconst perPage = Math.min(100, Math.max(1, parseInt(params.get(\"perPage\") || \"50\", 10)));\r\n\t\t\t\tconst offset = (page - 1) * perPage;\r\n\t\t\t\tconst q = (params.get(\"q\") || \"\").trim();\r\n\t\t\t\tconst category = (params.get(\"category\") || \"\").trim();\r\n\t\t\t\tconst isActive = params.get(\"is_active\");\r\n\t\t\t\tconst where = [];\r\n\t\t\t\tconst binds = [];\r\n\t\t\t\tif (q) { where.push(\"(cost_code LIKE ? OR cost_name LIKE ?)\"); binds.push(`%${q}%`, `%${q}%`); }\r\n\t\t\t\tif (category && [\"fixed\",\"variable\"].includes(category)) { where.push(\"category = ?\"); binds.push(category); }\r\n\t\t\t\tif (isActive === \"0\" || isActive === \"1\") { where.push(\"is_active = ?\"); binds.push(parseInt(isActive,10)); }\r\n\t\t\t\tconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n\t\t\t\tconst countRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM OverheadCostTypes ${whereSql}`).bind(...binds).first();\r\n\t\t\t\tconst total = Number(countRow?.total || 0);\r\n\t\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t\t`SELECT cost_type_id, cost_code, cost_name, category, allocation_method, description, is_active, display_order, created_at, updated_at\r\n\t\t\t\t\t FROM OverheadCostTypes\r\n\t\t\t\t\t ${whereSql}\r\n\t\t\t\t\t ORDER BY display_order ASC, cost_code ASC\r\n\t\t\t\t\t LIMIT ? OFFSET ?`\r\n\t\t\t\t).bind(...binds, perPage, offset).all();\r\n\t\t\t\tconst data = (rows?.results || []).map(r => ({\r\n\t\t\t\t\tid: r.cost_type_id,\r\n\t\t\t\t\tcode: r.cost_code,\r\n\t\t\t\t\tname: r.cost_name,\r\n\t\t\t\t\tcategory: r.category,\r\n\t\t\t\t\tallocationMethod: r.allocation_method,\r\n\t\t\t\t\tdescription: r.description || \"\",\r\n\t\t\t\t\tisActive: r.is_active === 1,\r\n\t\t\t\t\tdisplayOrder: Number(r.display_order || 0),\r\n\t\t\t\t\tcreatedAt: r.created_at,\r\n\t\t\t\t\tupdatedAt: r.updated_at,\r\n\t\t\t\t}));\r\n\t\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, page, perPage, total } }, corsHeaders);\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (method === \"POST\") {\r\n\t\t\tlet body; try { body = await request.json(); } catch (_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n\t\t\tconst code = String(body?.cost_code || body?.code || \"\").trim();\r\n\t\t\tconst name = String(body?.cost_name || body?.name || \"\").trim();\r\n\t\t\tconst category = String(body?.category || \"\").trim();\r\n\t\t\tconst methodVal = String(body?.allocation_method || body?.allocationMethod || \"\").trim();\r\n\t\t\tconst description = (body?.description || \"\").trim();\r\n\t\t\tconst errors = [];\r\n\t\t\tif (!/^[A-Z0-9_]{1,20}$/.test(code)) errors.push({ field:\"cost_code\", message:\"\u683C\u5F0F\u9700\u70BA A-Z0-9_\uFF0C\u226420\" });\r\n\t\t\tif (!name || name.length > 50) errors.push({ field:\"cost_name\", message:\"\u5FC5\u586B\u4E14 \u2264 50\" });\r\n\t\t\tif (![\"fixed\",\"variable\"].includes(category)) errors.push({ field:\"category\", message:\"\u4E0D\u5408\u6CD5\" });\r\n\t\t\tif (![\"per_employee\",\"per_hour\",\"per_revenue\"].includes(methodVal)) errors.push({ field:\"allocation_method\", message:\"\u4E0D\u5408\u6CD5\" });\r\n\t\t\tif (errors.length) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\r\n\t\t\ttry {\r\n\t\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\t\"INSERT INTO OverheadCostTypes (cost_code, cost_name, category, allocation_method, description, is_active) VALUES (?, ?, ?, ?, ?, 1)\"\r\n\t\t\t\t).bind(code, name, category, methodVal, description).run();\r\n\t\t\t\tconst row = await env.DATABASE.prepare(\"SELECT cost_type_id FROM OverheadCostTypes WHERE cost_code = ?\").bind(code).first();\r\n\t\t\t\treturn jsonResponse(201, { ok:true, code:\"CREATED\", message:\"\u5DF2\u5EFA\u7ACB\", data:{ id: row?.cost_type_id, code, name, category, allocationMethod: methodVal }, meta:{ requestId } }, corsHeaders);\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconst msg = String(err || \"\");\r\n\t\t\t\tif (msg.includes(\"UNIQUE\") && msg.includes(\"cost_code\")) {\r\n\t\t\t\t\treturn jsonResponse(409, { ok:false, code:\"CONFLICT\", message:\"\u4EE3\u78BC\u5DF2\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t\t}\r\n\t\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (path === \"/internal/api/v1/admin/overhead-costs\") {\r\n\t\tif (method === \"GET\") {\r\n\t\t\ttry {\r\n\t\t\t\tconst params = url.searchParams;\r\n\t\t\t\tconst year = parseInt(params.get(\"year\") || \"0\", 10);\r\n\t\t\t\tconst month = parseInt(params.get(\"month\") || \"0\", 10);\r\n\t\t\t\tif (!Number.isFinite(year) || year < 2000 || month < 1 || month > 12) {\r\n\t\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"year/month \u4E0D\u5408\u6CD5\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t\t}\r\n\t\t\t\tconst q = (params.get(\"q\") || \"\").trim();\r\n\t\t\t\tconst where = [\"m.is_deleted = 0\", \"m.year = ?\", \"m.month = ?\"];\r\n\t\t\t\tconst binds = [year, month];\r\n\t\t\t\tif (q) { where.push(\"(t.cost_code LIKE ? OR t.cost_name LIKE ? OR m.notes LIKE ?)\"); binds.push(`%${q}%`, `%${q}%`, `%${q}%`); }\r\n\t\t\t\tconst whereSql = `WHERE ${where.join(\" AND \")}`;\r\n\t\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t\t`SELECT m.overhead_id, m.cost_type_id, t.cost_name, t.cost_code, t.category, t.allocation_method, m.amount, m.notes, m.recorded_by, m.recorded_at, m.updated_at\r\n\t\t\t\t\t FROM MonthlyOverheadCosts m\r\n\t\t\t\t\t JOIN OverheadCostTypes t ON t.cost_type_id = m.cost_type_id\r\n\t\t\t\t\t ${whereSql}\r\n\t\t\t\t\t ORDER BY t.display_order ASC, t.cost_code ASC`\r\n\t\t\t\t).bind(...binds).all();\r\n\t\t\t\tconst items = (rows?.results || []).map(r => ({\r\n\t\t\t\t\tid: r.overhead_id,\r\n\t\t\t\t\tcostTypeId: r.cost_type_id,\r\n\t\t\t\t\tcostName: r.cost_name,\r\n\t\t\t\t\tcostCode: r.cost_code,\r\n\t\t\t\t\tcategory: r.category,\r\n\t\t\t\t\tallocationMethod: r.allocation_method,\r\n\t\t\t\t\tamount: Number(r.amount || 0),\r\n\t\t\t\t\tnotes: r.notes || \"\",\r\n\t\t\t\t\trecordedBy: r.recorded_by,\r\n\t\t\t\t\trecordedAt: r.recorded_at,\r\n\t\t\t\t\tupdatedAt: r.updated_at,\r\n\t\t\t\t}));\r\n\t\t\t\tconst total = items.reduce((s, x) => s + x.amount, 0);\r\n\t\t\t\tconst totalFixed = items.filter(x => x.category === 'fixed').reduce((s, x) => s + x.amount, 0);\r\n\t\t\t\tconst totalVariable = total - totalFixed;\r\n\t\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data:{ year, month, items, total, totalFixed, totalVariable }, meta:{ requestId, count: items.length } }, corsHeaders);\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (method === \"POST\") {\r\n\t\t\tlet body; try { body = await request.json(); } catch (_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n\t\t\tconst cost_type_id = parseInt(body?.cost_type_id, 10);\r\n\t\t\tconst year = parseInt(body?.year, 10);\r\n\t\t\tconst month = parseInt(body?.month, 10);\r\n\t\t\tconst amount = Number(body?.amount);\r\n\t\t\tconst notes = (body?.notes || \"\").trim();\r\n\t\t\tconst errors = [];\r\n\t\t\tif (!Number.isFinite(cost_type_id)) errors.push({ field:\"cost_type_id\", message:\"\u5FC5\u586B\" });\r\n\t\t\tif (!Number.isFinite(year) || year < 2000) errors.push({ field:\"year\", message:\"\u4E0D\u5408\u6CD5\" });\r\n\t\t\tif (!Number.isFinite(month) || month < 1 || month > 12) errors.push({ field:\"month\", message:\"\u4E0D\u5408\u6CD5\" });\r\n\t\t\tif (!Number.isFinite(amount) || amount <= 0 || amount > 1e9) errors.push({ field:\"amount\", message:\"\u9700\u4ECB\u65BC 0 ~ 1e9\" });\r\n\t\t\tif (errors.length) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\r\n\t\t\ttry {\r\n\t\t\t\tconst t = await env.DATABASE.prepare(\"SELECT cost_type_id FROM OverheadCostTypes WHERE cost_type_id = ? AND is_active = 1 LIMIT 1\").bind(cost_type_id).first();\r\n\t\t\t\tif (!t) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u6210\u672C\u9805\u76EE\u4E0D\u5B58\u5728\u6216\u672A\u555F\u7528\", errors:[{ field:\"cost_type_id\", message:\"\u4E0D\u5B58\u5728\u6216\u672A\u555F\u7528\" }], meta:{ requestId } }, corsHeaders);\r\n\t\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\t\"INSERT INTO MonthlyOverheadCosts (cost_type_id, year, month, amount, notes, recorded_by) VALUES (?, ?, ?, ?, ?, ?)\"\r\n\t\t\t\t).bind(cost_type_id, year, month, amount, notes, String(me.user_id)).run();\r\n\t\t\t\tconst idRow = await env.DATABASE.prepare(\"SELECT last_insert_rowid() AS id\").first();\r\n\t\t\t\treturn jsonResponse(201, { ok:true, code:\"CREATED\", message:\"\u5DF2\u5EFA\u7ACB\", data:{ id:String(idRow?.id) }, meta:{ requestId } }, corsHeaders);\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconst msg = String(err || \"\");\r\n\t\t\t\tif (msg.includes(\"UNIQUE\") && msg.includes(\"MonthlyOverheadCosts\")) {\r\n\t\t\t\t\treturn jsonResponse(409, { ok:false, code:\"CONFLICT\", message:\"\u8A72\u6708\u4EFD\u5DF2\u6709\u6B64\u9805\u76EE\u8A18\u9304\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t\t}\r\n\t\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (path === \"/internal/api/v1/admin/overhead-summary\" || path === \"/internal/api/v1/admin/overhead-analysis\") {\r\n\t\tif (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n\t\ttry {\r\n\t\t\tconst params = url.searchParams;\r\n\t\t\tconst year = parseInt(params.get(\"year\") || \"0\", 10);\r\n\t\t\tconst month = parseInt(params.get(\"month\") || \"0\", 10);\r\n\t\t\tif (!Number.isFinite(year) || year < 2000 || month < 1 || month > 12) {\r\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"year/month \u4E0D\u5408\u6CD5\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT t.category, t.cost_type_id, t.cost_name, SUM(m.amount) AS amt\r\n\t\t\t\t FROM MonthlyOverheadCosts m JOIN OverheadCostTypes t ON t.cost_type_id = m.cost_type_id\r\n\t\t\t\t WHERE m.is_deleted = 0 AND m.year = ? AND m.month = ?\r\n\t\t\t\t GROUP BY t.category, t.cost_type_id, t.cost_name`\r\n\t\t\t).bind(year, month).all();\r\n\t\t\tconst list = rows?.results || [];\r\n\t\t\tconst total = list.reduce((s, r) => s + Number(r.amt || 0), 0);\r\n\t\t\tconst byCategory = { fixed: 0, variable: 0 };\r\n\t\t\tfor (const r of list) { byCategory[r.category] = (byCategory[r.category] || 0) + Number(r.amt || 0); }\r\n\t\t\tconst typeBreakdown = list.map(r => ({ costTypeId: r.cost_type_id, costName: r.cost_name, amount: Number(r.amt || 0), percentage: total ? Number((Number(r.amt||0)/total*100).toFixed(1)) : 0 }));\r\n\t\t\tconst empRow = await env.DATABASE.prepare(\"SELECT COUNT(1) AS c FROM Users WHERE is_deleted = 0\").first();\r\n\t\t\tconst employeeCount = Number(empRow?.c || 0);\r\n\t\t\tconst overheadPerEmployee = employeeCount ? Math.round(total / employeeCount) : 0;\r\n\t\t\tconst data = { year, month, total_overhead: total, employee_count: employeeCount, overhead_per_employee: overheadPerEmployee, breakdown_by_category: byCategory, breakdown_by_type: typeBreakdown };\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nexport async function handleReports(request, env, me, requestId, url, path) {\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\tconst method = request.method.toUpperCase();\r\n\r\n\tconst parseDate = (s) => {\r\n\t\tif (!s || typeof s !== \"string\") return null;\r\n\t\tconst m = s.match(/^\\d{4}-\\d{2}-\\d{2}$/);\r\n\t\tif (!m) return null;\r\n\t\tconst d = new Date(s);\r\n\t\treturn Number.isNaN(d.getTime()) ? null : s; // keep original yyyy-mm-dd\r\n\t};\r\n\r\n\tconst parseYearMonth = (s) => {\r\n\t\tif (!s || typeof s !== \"string\") return null;\r\n\t\tconst m = s.match(/^(\\d{4})-(\\d{2})$/);\r\n\t\tif (!m) return null;\r\n\t\tconst y = parseInt(m[1], 10);\r\n\t\tconst mo = parseInt(m[2], 10);\r\n\t\tif (!Number.isFinite(y) || !Number.isFinite(mo) || mo < 1 || mo > 12) return null;\r\n\t\treturn { year: y, month: mo };\r\n\t};\r\n\r\n\t// /internal/api/v1/reports/client-cost-analysis (GET, admin only)\r\n\tif (path === \"/internal/api/v1/reports/client-cost-analysis\") {\r\n\t\tif (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\r\n\t\ttry {\r\n\t\t\tconst p = url.searchParams;\r\n\t\t\tconst start = parseDate(p.get(\"start_date\"));\r\n\t\t\tconst end = parseDate(p.get(\"end_date\"));\r\n\t\t\tconst clientId = (p.get(\"client_id\") || \"\").trim() || null;\r\n\t\t\tconst includeBonus = (p.get(\"include_year_end_bonus\") || \"\").toLowerCase() === \"true\";\r\n\t\t\tif (!start || !end || start > end) {\r\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8ACB\u9078\u64C7\u6709\u6548\u65E5\u671F\u5340\u9593\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\r\n\t\t\t// \u5BE6\u969B\u5DE5\u6642\uFF08\u4EE5 Timesheets \u70BA\u6E96\uFF0C\u7C21\u5316\uFF1Aweighted_hours = hours\uFF09\r\n\t\t\tconst binds = [start, end];\r\n\t\t\tlet where = \"t.is_deleted = 0 AND t.work_date >= ? AND t.work_date <= ?\";\r\n\t\t\tif (clientId) { where += \" AND t.client_id = ?\"; binds.push(clientId); }\r\n\t\t\tconst hoursRows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT t.client_id, SUM(t.hours) AS actual_hours\r\n\t\t\t\t FROM Timesheets t\r\n\t\t\t\t WHERE ${where}\r\n\t\t\t\t GROUP BY t.client_id`\r\n\t\t\t).bind(...binds).all();\r\n\t\t\tconst hoursByClient = new Map();\r\n\t\t\tfor (const r of (hoursRows?.results || [])) {\r\n\t\t\t\tif (!r.client_id) continue;\r\n\t\t\t\thoursByClient.set(r.client_id, Number(r.actual_hours || 0));\r\n\t\t\t}\r\n\t\t\tconst clientIds = Array.from(hoursByClient.keys());\r\n\r\n\t\t\t// \u71DF\u6536\uFF08Receipts\uFF1A\u6392\u9664 cancelled\uFF09\r\n\t\t\tconst recBinds = [start, end];\r\n\t\t\tlet recWhere = \"is_deleted = 0 AND status != 'cancelled' AND receipt_date >= ? AND receipt_date <= ?\";\r\n\t\t\tif (clientId) { recWhere += \" AND client_id = ?\"; recBinds.push(clientId); }\r\n\t\t\tconst recRows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT client_id, SUM(total_amount) AS total_receipts\r\n\t\t\t\t FROM Receipts\r\n\t\t\t\t WHERE ${recWhere}\r\n\t\t\t\t GROUP BY client_id`\r\n\t\t\t).bind(...recBinds).all();\r\n\t\t\tconst revenueByClient = new Map();\r\n\t\t\tfor (const r of (recRows?.results || [])) {\r\n\t\t\t\trevenueByClient.set(r.client_id, Number(r.total_receipts || 0));\r\n\t\t\t\tif (!hoursByClient.has(r.client_id)) clientIds.push(r.client_id);\r\n\t\t\t}\r\n\r\n\t\t\t// \u7BA1\u7406\u6210\u672C\u7E3D\u984D\uFF08\u8DE8\u6708\u4EFD\u52A0\u7E3D\uFF09\r\n\t\t\tconst startYm = parseInt(start.slice(0,4) + start.slice(5,7), 10);\r\n\t\t\tconst endYm = parseInt(end.slice(0,4) + end.slice(5,7), 10);\r\n\t\t\tconst ohRows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT (year*100+month) AS ym, SUM(amount) AS amt\r\n\t\t\t\t FROM MonthlyOverheadCosts\r\n\t\t\t\t WHERE is_deleted = 0 AND (year*100+month) >= ? AND (year*100+month) <= ?\r\n\t\t\t\t GROUP BY ym`\r\n\t\t\t).bind(startYm, endYm).all();\r\n\t\t\tconst totalOverhead = (ohRows?.results || []).reduce((s, r) => s + Number(r.amt || 0), 0);\r\n\r\n\t\t\t// \u4EE5\u5DE5\u6642\u5360\u6BD4\u5206\u6524\u7BA1\u7406\u6210\u672C\uFF08\u7C21\u5316\uFF09\r\n\t\t\tconst totalHours = Array.from(hoursByClient.values()).reduce((s, x) => s + x, 0);\r\n\t\t\tconst warnings = [];\r\n\t\t\tif (totalOverhead <= 0) warnings.push({ type: \"overhead_missing\", message: \"\u672C\u671F\u9593\u7BA1\u7406\u6210\u672C\u672A\u8F38\u5165\" });\r\n\r\n\t\t\t// \u53D6\u516C\u53F8\u540D\u7A31\r\n\t\t\tconst nameMap = new Map();\r\n\t\t\tif (clientIds.length) {\r\n\t\t\t\tconst placeholders = clientIds.map(() => \"?\").join(\",\");\r\n\t\t\t\tconst nameRows = await env.DATABASE.prepare(\r\n\t\t\t\t\t`SELECT client_id, company_name FROM Clients WHERE client_id IN (${placeholders})`\r\n\t\t\t\t).bind(...clientIds).all();\r\n\t\t\t\tfor (const r of (nameRows?.results || [])) nameMap.set(r.client_id, r.company_name);\r\n\t\t\t}\r\n\r\n\t\t\tconst data = [];\r\n\t\t\tfor (const cid of clientIds) {\r\n\t\t\t\tconst actual = Number(hoursByClient.get(cid) || 0);\r\n\t\t\t\tconst weighted = actual; // \u7C21\u5316\uFF1A\u672A\u6709\u500D\u7387\u7DAD\u8868\r\n\t\t\t\tconst revenue = Number(revenueByClient.get(cid) || 0);\r\n\t\t\t\tconst ohAlloc = totalHours > 0 ? Math.round(totalOverhead * (actual / totalHours)) : 0;\r\n\t\t\t\tconst salaryCost = 0; // \u5C1A\u7121\u8DB3\u5920\u8CC7\u6599\uFF0C\u5148\u56DE 0\r\n\t\t\t\tconst bonusAlloc = includeBonus ? 0 : 0; // \u5C1A\u7121\u5E74\u7D42\u8CC7\u6599\u4F86\u6E90\r\n\t\t\t\tconst totalCost = salaryCost + ohAlloc + bonusAlloc;\r\n\t\t\t\tconst grossProfit = revenue - totalCost;\r\n\t\t\t\tconst margin = revenue > 0 ? Number(((grossProfit / revenue) * 100).toFixed(1)) : 0;\r\n\t\t\t\tdata.push({\r\n\t\t\t\t\tclient_id: cid,\r\n\t\t\t\t\tcompany_name: nameMap.get(cid) || cid,\r\n\t\t\t\t\ttotal_actual_hours: Number(actual.toFixed(2)),\r\n\t\t\t\t\ttotal_weighted_hours: Number(weighted.toFixed(2)),\r\n\t\t\t\t\tcost_breakdown: {\r\n\t\t\t\t\t\tsalary_cost: salaryCost,\r\n\t\t\t\t\t\toverhead_cost: ohAlloc,\r\n\t\t\t\t\t\tyear_end_bonus: bonusAlloc,\r\n\t\t\t\t\t\ttotal_cost: totalCost,\r\n\t\t\t\t\t},\r\n\t\t\t\t\tlabor_cost: totalCost,\r\n\t\t\t\t\trevenue,\r\n\t\t\t\t\tgross_profit: grossProfit,\r\n\t\t\t\t\tprofit_margin: margin,\r\n\t\t\t\t\tcost_percentage: totalCost > 0 ? { salary: Number(((salaryCost/totalCost)*100).toFixed(1)), overhead: Number((((ohAlloc)/(totalCost))*100).toFixed(1)) } : { salary: 0, overhead: 0 },\r\n\t\t\t\t\tuser_breakdown: [],\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, warnings, meta:{ requestId } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\t// /internal/api/v1/reports/employee-hours (GET)\r\n\tif (path === \"/internal/api/v1/reports/employee-hours\") {\r\n\t\tif (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n\t\ttry {\r\n\t\t\tconst p = url.searchParams;\r\n\t\t\tconst y = parseInt(p.get(\"year\") || \"0\", 10);\r\n\t\t\tconst m = parseInt(p.get(\"month\") || \"0\", 10);\r\n\t\t\tlet qUserId = p.get(\"user_id\");\r\n\t\t\tif (!Number.isFinite(y) || y < 2000 || !Number.isFinite(m) || m < 1 || m > 12) {\r\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8ACB\u9078\u64C7\u67E5\u8A62\u6708\u4EFD\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\t// \u6B0A\u9650\uFF1A\u54E1\u5DE5\u50C5\u80FD\u770B\u81EA\u5DF1\r\n\t\t\tlet userFilterId = null;\r\n\t\t\tif (!me.is_admin) userFilterId = String(me.user_id);\r\n\t\t\telse if (qUserId) userFilterId = String(parseInt(qUserId, 10));\r\n\r\n\t\t\tconst ym = `${y}-${String(m).padStart(2,'0')}`;\r\n\t\t\tconst whereBase = \"t.is_deleted = 0 AND substr(t.work_date,1,7) = ?\";\r\n\t\t\tlet where = whereBase;\r\n\t\t\tconst binds = [ym];\r\n\t\t\tif (userFilterId) { where += \" AND t.user_id = ?\"; binds.push(userFilterId); }\r\n\r\n\t\t\t// \u5F59\u7E3D\uFF08\u6BCF\u4EBA\uFF09\r\n\t\t\tconst aggRows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT t.user_id, SUM(t.hours) AS total_hours,\r\n\t\t\t\t\tSUM(CASE WHEN t.work_type = 'normal' THEN t.hours ELSE 0 END) AS normal_hours,\r\n\t\t\t\t\tSUM(CASE WHEN t.work_type LIKE 'ot-%' THEN t.hours ELSE 0 END) AS overtime_hours\r\n\t\t\t\t FROM Timesheets t\r\n\t\t\t\t WHERE ${where}\r\n\t\t\t\t GROUP BY t.user_id`\r\n\t\t\t).bind(...binds).all();\r\n\r\n\t\t\t// \u6BCF\u65E5\u5DE5\u6642\r\n\t\t\tconst dailyRows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT t.user_id, t.work_date, SUM(t.hours) AS hours\r\n\t\t\t\t FROM Timesheets t\r\n\t\t\t\t WHERE ${where}\r\n\t\t\t\t GROUP BY t.user_id, t.work_date\r\n\t\t\t\t ORDER BY t.work_date ASC`\r\n\t\t\t).bind(...binds).all();\r\n\r\n\t\t\t// \u5BA2\u6236\u5206\u5E03\r\n\t\t\tconst distRows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT t.user_id, t.client_id, SUM(t.hours) AS hours\r\n\t\t\t\t FROM Timesheets t\r\n\t\t\t\t WHERE ${where} AND t.client_id IS NOT NULL\r\n\t\t\t\t GROUP BY t.user_id, t.client_id`\r\n\t\t\t).bind(...binds).all();\r\n\r\n\t\t\t// \u4F7F\u7528\u8005\u540D\u7A31\r\n\t\t\tconst userIds = (aggRows?.results || []).map(r => r.user_id);\r\n\t\t\tlet usersMap = new Map();\r\n\t\t\tif (userIds.length) {\r\n\t\t\t\tconst placeholders = userIds.map(()=>\"?\").join(\",\");\r\n\t\t\t\tconst uRows = await env.DATABASE.prepare(`SELECT user_id, username FROM Users WHERE user_id IN (${placeholders})`).bind(...userIds).all();\r\n\t\t\t\tusersMap = new Map((uRows?.results || []).map(r => [String(r.user_id), r.username]));\r\n\t\t\t}\r\n\r\n\t\t\t// \u5BA2\u6236\u540D\u7A31\r\n\t\t\tconst clientIds = Array.from(new Set((distRows?.results || []).map(r => r.client_id).filter(Boolean)));\r\n\t\t\tlet clientMap = new Map();\r\n\t\t\tif (clientIds.length) {\r\n\t\t\t\tconst placeholders = clientIds.map(()=>\"?\").join(\",\");\r\n\t\t\t\tconst cRows = await env.DATABASE.prepare(`SELECT client_id, company_name FROM Clients WHERE client_id IN (${placeholders})`).bind(...clientIds).all();\r\n\t\t\t\tclientMap = new Map((cRows?.results || []).map(r => [r.client_id, r.company_name]));\r\n\t\t\t}\r\n\r\n\t\t\tconst dailyByUser = new Map();\r\n\t\t\tfor (const r of (dailyRows?.results || [])) {\r\n\t\t\t\tconst arr = dailyByUser.get(String(r.user_id)) || [];\r\n\t\t\t\tarr.push({ date: r.work_date, hours: Number(r.hours || 0) });\r\n\t\t\t\tdailyByUser.set(String(r.user_id), arr);\r\n\t\t\t}\r\n\r\n\t\t\tconst distByUser = new Map();\r\n\t\t\tfor (const r of (distRows?.results || [])) {\r\n\t\t\t\tconst arr = distByUser.get(String(r.user_id)) || [];\r\n\t\t\t\tconst hours = Number(r.hours || 0);\r\n\t\t\t\tarr.push({ client_id: r.client_id, company_name: clientMap.get(r.client_id) || r.client_id, hours });\r\n\t\t\t\tdistByUser.set(String(r.user_id), arr);\r\n\t\t\t}\r\n\r\n\t\t\tconst data = [];\r\n\t\t\tfor (const r of (aggRows?.results || [])) {\r\n\t\t\t\tconst uid = String(r.user_id);\r\n\t\t\t\tconst total = Number(r.total_hours || 0);\r\n\t\t\t\tconst normal = Number(r.normal_hours || 0);\r\n\t\t\t\tconst ot = Number(r.overtime_hours || 0);\r\n\t\t\t\tconst billable = total; // \u7C21\u5316\uFF1A\u7121 is_billable \u8CC7\u6599\uFF0C\u5168\u90E8\u8996\u70BA\u53EF\u8A08\u8CBB\r\n\t\t\t\tconst nonBillable = 0;\r\n\t\t\t\tconst utilization = total > 0 ? Number(((billable/total)*100).toFixed(2)) : 0;\r\n\t\t\t\tlet dist = distByUser.get(uid) || [];\r\n\t\t\t\tconst distTotal = dist.reduce((s,x)=> s + x.hours, 0) || 1;\r\n\t\t\t\tdist = dist.map(x => ({ client_id: x.client_id, company_name: x.company_name, hours: x.hours, percentage: Number(((x.hours/distTotal)*100).toFixed(2)) }));\r\n\t\t\t\tconst daily = dailyByUser.get(uid) || [];\r\n\t\t\t\tdata.push({\r\n\t\t\t\t\tuser_id: Number(uid),\r\n\t\t\t\t\tusername: usersMap.get(uid) || uid,\r\n\t\t\t\t\ttotal_hours: Number(total.toFixed(2)),\r\n\t\t\t\t\tnormal_hours: Number(normal.toFixed(2)),\r\n\t\t\t\t\tovertime_hours: Number(ot.toFixed(2)),\r\n\t\t\t\t\tbillable_hours: Number(billable.toFixed(2)),\r\n\t\t\t\t\tnon_billable_hours: Number(nonBillable.toFixed(2)),\r\n\t\t\t\t\tutilization_rate: utilization,\r\n\t\t\t\t\tclient_distribution: dist,\r\n\t\t\t\t\tdaily_hours: daily,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, year:y, month:m } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\t// /internal/api/v1/reports/payroll-summary (GET, admin only)\r\n\tif (path === \"/internal/api/v1/reports/payroll-summary\") {\r\n\t\tif (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\r\n\t\ttry {\r\n\t\t\tconst p = url.searchParams;\r\n\t\t\tconst y = parseInt(p.get(\"year\") || \"0\", 10);\r\n\t\t\tconst m = parseInt(p.get(\"month\") || \"0\", 10);\r\n\t\t\tlet userId = p.get(\"user_id\");\r\n\t\t\tif (!Number.isFinite(y) || y < 2000 || !Number.isFinite(m) || m < 1 || m > 12) {\r\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8ACB\u9078\u64C7\u67E5\u8A62\u6708\u4EFD\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\tconst ym = `${y}-${String(m).padStart(2,'0')}`;\r\n\t\t\tconst run = await env.DATABASE.prepare(\"SELECT run_id FROM PayrollRuns WHERE month = ? LIMIT 1\").bind(ym).first();\r\n\t\t\tif (!run) {\r\n\t\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data:{ summary:{ total_base_salary:0, total_allowances:0, total_bonuses:0, total_overtime_pay:0, total_gross_salary:0, total_net_salary:0 }, by_employee:[] }, meta:{ requestId, month:ym } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\tlet q = \"SELECT mp.user_id, u.username, mp.base_salary_cents, mp.regular_allowance_cents, mp.bonus_cents, mp.overtime_cents, mp.total_cents, mp.is_full_attendance FROM MonthlyPayroll mp JOIN Users u ON u.user_id = mp.user_id WHERE mp.run_id = ?\";\r\n\t\t\tconst binds = [run.run_id];\r\n\t\t\tif (userId) { q += \" AND mp.user_id = ?\"; binds.push(String(parseInt(userId,10))); }\r\n\t\t\tconst rows = await env.DATABASE.prepare(q).bind(...binds).all();\r\n\t\t\tconst list = rows?.results || [];\r\n\t\t\tconst cents = (v)=> Number(v||0);\r\n\t\t\tconst toAmt = (c)=> Math.round(c/100);\r\n\t\t\tconst byEmployee = list.map(r => ({\r\n\t\t\t\tuser_id: r.user_id,\r\n\t\t\t\tusername: r.username,\r\n\t\t\t\tbase_salary: toAmt(cents(r.base_salary_cents)),\r\n\t\t\t\ttotal_allowances: toAmt(cents(r.regular_allowance_cents)),\r\n\t\t\t\ttotal_bonuses: toAmt(cents(r.bonus_cents)),\r\n\t\t\t\tovertime_pay: toAmt(cents(r.overtime_cents)),\r\n\t\t\t\tgross_salary: toAmt(cents(r.total_cents)),\r\n\t\t\t\tnet_salary: toAmt(cents(r.total_cents)),\r\n\t\t\t\thas_full_attendance: r.is_full_attendance === 1,\r\n\t\t\t}));\r\n\t\t\tconst sum = (k)=> byEmployee.reduce((s,x)=> s + Number(x[k]||0), 0);\r\n\t\t\tconst summary = {\r\n\t\t\t\ttotal_base_salary: sum('base_salary'),\r\n\t\t\t\ttotal_allowances: sum('total_allowances'),\r\n\t\t\t\ttotal_bonuses: sum('total_bonuses'),\r\n\t\t\t\ttotal_overtime_pay: sum('overtime_pay'),\r\n\t\t\t\ttotal_gross_salary: sum('gross_salary'),\r\n\t\t\t\ttotal_net_salary: sum('net_salary'),\r\n\t\t\t};\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data:{ summary, by_employee: byEmployee }, meta:{ requestId, month:ym } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\t// /internal/api/v1/reports/revenue (GET, admin only)\r\n\tif (path === \"/internal/api/v1/reports/revenue\") {\r\n\t\tif (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\r\n\t\ttry {\r\n\t\t\tconst p = url.searchParams;\r\n\t\t\tconst start = parseDate(p.get(\"start_date\"));\r\n\t\t\tconst end = parseDate(p.get(\"end_date\"));\r\n\t\t\tif (!start || !end || start > end) {\r\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8ACB\u9078\u64C7\u6709\u6548\u65E5\u671F\u5340\u9593\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT strftime('%Y-%m', receipt_date) AS ym,\r\n\t\t\t\t\tSUM(total_amount) AS receipts,\r\n\t\t\t\t\tSUM(CASE WHEN status = 'paid' THEN total_amount ELSE 0 END) AS paid\r\n\t\t\t\t FROM Receipts\r\n\t\t\t\t WHERE is_deleted = 0 AND status != 'cancelled' AND receipt_date >= ? AND receipt_date <= ?\r\n\t\t\t\t GROUP BY ym\r\n\t\t\t\t ORDER BY ym`\r\n\t\t\t).bind(start, end).all();\r\n\t\t\tconst monthly_trend = (rows?.results || []).map(r => ({ month: r.ym, receipts: Number(r.receipts||0), paid: Number(r.paid||0), outstanding: Math.max(0, Number(r.receipts||0) - Number(r.paid||0)) }));\r\n\t\t\tconst total_receipts = monthly_trend.reduce((s,x)=> s + x.receipts, 0);\r\n\t\t\tconst total_paid = monthly_trend.reduce((s,x)=> s + x.paid, 0);\r\n\t\t\tconst total_outstanding = Math.max(0, total_receipts - total_paid);\r\n\t\t\tconst collection_rate = total_receipts > 0 ? Number(((total_paid/total_receipts)*100).toFixed(1)) : 0;\r\n\r\n\t\t\tconst byClientRows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT r.client_id, c.company_name, SUM(r.total_amount) AS total_receipts,\r\n\t\t\t\t\tSUM(CASE WHEN r.status = 'paid' THEN r.total_amount ELSE 0 END) AS total_paid\r\n\t\t\t\t FROM Receipts r LEFT JOIN Clients c ON c.client_id = r.client_id\r\n\t\t\t\t WHERE r.is_deleted = 0 AND r.status != 'cancelled' AND r.receipt_date >= ? AND r.receipt_date <= ?\r\n\t\t\t\t GROUP BY r.client_id, c.company_name`\r\n\t\t\t).bind(start, end).all();\r\n\t\t\tconst by_client = (byClientRows?.results || []).map(r => ({ client_id: r.client_id, company_name: r.company_name || r.client_id, total_receipts: Number(r.total_receipts||0), total_paid: Number(r.total_paid||0), total_outstanding: Math.max(0, Number(r.total_receipts||0) - Number(r.total_paid||0)) }));\r\n\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data:{ summary:{ total_receipts, total_paid, total_outstanding, collection_rate }, monthly_trend, by_client }, meta:{ requestId } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nfunction b64urlEncode(u8) {\r\n\tconst b64 = btoa(String.fromCharCode(...u8));\r\n\treturn b64.replaceAll(\"+\", \"-\").replaceAll(\"/\", \"_\").replaceAll(\"=\", \"\");\r\n}\r\n\r\nasync function hmacSha256(keyBytes, msgBytes) {\r\n\tconst key = await crypto.subtle.importKey(\"raw\", keyBytes, { name: \"HMAC\", hash: \"SHA-256\" }, false, [\"sign\"]);\r\n\tconst sig = await crypto.subtle.sign(\"HMAC\", key, msgBytes);\r\n\treturn new Uint8Array(sig);\r\n}\r\n\r\nfunction utf8(str) { return new TextEncoder().encode(str); }\r\n\r\nfunction sanitizeFilename(name) {\r\n\tconst n = String(name || \"\");\r\n\treturn n.replace(/[\\\\/]/g, \"_\").replace(/\\.{2,}/g, \".\").slice(0, 200) || \"file\";\r\n}\r\n\r\nfunction extFromFilename(name) {\r\n\tconst m = String(name||\"\").toLowerCase().match(/\\.([a-z0-9]{1,10})$/);\r\n\treturn m ? m[1] : \"\";\r\n}\r\n\r\nexport async function handleAttachments(request, env, me, requestId, url, path) {\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\tconst method = request.method.toUpperCase();\r\n\r\n\t// 1) \u4E0A\u50B3\u7C3D\u540D\uFF08POST\uFF09\r\n\tif (path === \"/internal/api/v1/attachments/upload-sign\") {\r\n\t\tif (method !== \"POST\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n\t\tlet body; try { body = await request.json(); } catch (_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n\t\tconst entityType = String(body?.entity_type || \"\").trim();\r\n\t\tconst entityId = String(body?.entity_id || \"\").trim();\r\n\t\tconst filenameRaw = String(body?.filename || \"\").trim();\r\n\t\tconst contentType = String(body?.content_type || \"\").trim().toLowerCase();\r\n\t\tconst contentLength = Number(body?.content_length || 0);\r\n\t\tif (!['client','receipt','sop','task'].includes(entityType)) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"entity_type \u4E0D\u5408\u6CD5\", meta:{ requestId } }, corsHeaders);\r\n\t\tif (!entityId) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"entity_id \u5FC5\u586B\", meta:{ requestId } }, corsHeaders);\r\n\t\tif (!filenameRaw) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"filename \u5FC5\u586B\", meta:{ requestId } }, corsHeaders);\r\n\t\tif (!Number.isFinite(contentLength) || contentLength <= 0) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"content_length \u4E0D\u5408\u6CD5\", meta:{ requestId } }, corsHeaders);\r\n\t\tif (contentLength > 10 * 1024 * 1024) return jsonResponse(413, { ok:false, code:\"PAYLOAD_TOO_LARGE\", message:\"\u6A94\u6848\u5927\u5C0F\u8D85\u904E\u9650\u5236\uFF08\u6700\u5927 10MB\uFF09\", meta:{ requestId } }, corsHeaders);\r\n\t\tconst allowedExt = [\"pdf\",\"jpg\",\"jpeg\",\"png\",\"xlsx\",\"xls\",\"docx\",\"doc\"];\r\n\t\tconst allowedMime = [\r\n\t\t\t\"application/pdf\",\"image/jpeg\",\"image/png\",\r\n\t\t\t\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\"application/vnd.ms-excel\",\r\n\t\t\t\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\"application/msword\"\r\n\t\t];\r\n\t\tconst safeName = sanitizeFilename(filenameRaw);\r\n\t\tconst ext = extFromFilename(safeName);\r\n\t\tif (!allowedExt.includes(ext)) return jsonResponse(422, { ok:false, code:\"INVALID_EXTENSION\", message:\"\u4E0D\u652F\u63F4\u7684\u526F\u6A94\u540D\", meta:{ requestId } }, corsHeaders);\r\n\t\tif (!allowedMime.includes(contentType)) return jsonResponse(422, { ok:false, code:\"INVALID_FILE_TYPE\", message:\"\u4E0D\u652F\u63F4\u7684\u6A94\u6848\u578B\u5225\", meta:{ requestId } }, corsHeaders);\r\n\t\t// \u6578\u91CF\u4E0A\u9650\r\n\t\tconst limits = { client:20, receipt:5, sop:10, task:10 };\r\n\t\tconst limit = limits[entityType] ?? 20;\r\n\t\tconst cntRow = await env.DATABASE.prepare(\"SELECT COUNT(1) AS c FROM Attachments WHERE is_deleted = 0 AND entity_type = ? AND entity_id = ?\").bind(entityType, entityId).first();\r\n\t\tif (Number(cntRow?.c || 0) >= limit) return jsonResponse(409, { ok:false, code:\"TOO_MANY_FILES\", message:`\u5DF2\u9054\u5230\u9644\u4EF6\u6578\u91CF\u4E0A\u9650\uFF08\u6700\u591A ${limit} \u500B\uFF09`, meta:{ requestId } }, corsHeaders);\r\n\t\t// \u7522\u751F objectKey \u8207 token\r\n\t\tconst envName = String(env.APP_ENV || \"dev\");\r\n\t\tconst now = Math.floor(Date.now()/1000);\r\n\t\tconst rand = crypto.getRandomValues(new Uint8Array(6));\r\n\t\tconst randStr = b64urlEncode(rand);\r\n\t\tconst folder = `private/${envName}/attachments/${entityType}_${entityId}`;\r\n\t\tconst objectKey = `${folder}/f_${now}_${randStr}.${ext}`;\r\n\t\tconst expiresAt = now + 300; // 5 \u5206\u9418\r\n\t\tconst payload = {\r\n\t\t\tobjectKey,\r\n\t\t\tentityType,\r\n\t\t\tentityId,\r\n\t\t\tfilename: safeName,\r\n\t\t\tcontentType,\r\n\t\t\tcontentLength,\r\n\t\t\tuserId: String(me.user_id),\r\n\t\t\texp: expiresAt,\r\n\t\t};\r\n\t\tconst secret = String(env.UPLOAD_SIGNING_SECRET || \"change-me\");\r\n\t\tconst pBytes = utf8(JSON.stringify(payload));\r\n\t\tconst sig = await hmacSha256(utf8(secret), pBytes);\r\n\t\tconst token = `${b64urlEncode(pBytes)}.${b64urlEncode(sig)}`;\r\n\t\tconst uploadUrl = `${url.origin}/internal/api/v1/attachments/upload-direct?token=${token}`;\r\n\t\tconst data = { uploadUrl, objectKey, headers: { \"Content-Type\": contentType, \"Content-Length\": String(contentLength) } };\r\n\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, expiresAt } }, corsHeaders);\r\n\t}\r\n\r\n\t// 2) \u76F4\u50B3\u5165\u53E3\uFF08PUT\uFF09\r\n\tif (path === \"/internal/api/v1/attachments/upload-direct\") {\r\n\t\tif (method !== \"PUT\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n\t\ttry {\r\n\t\t\tconst token = url.searchParams.get(\"token\") || \"\";\r\n\t\t\tconst parts = token.split(\".\");\r\n\t\t\tif (parts.length !== 2) return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u7C3D\u540D\u7121\u6548\", meta:{ requestId } }, corsHeaders);\r\n\t\t\tconst pBytes = Uint8Array.from(atob(parts[0].replaceAll(\"-\",\"+\").replaceAll(\"_\",\"/\")), c => c.charCodeAt(0));\r\n\t\t\tconst sBytes = Uint8Array.from(atob(parts[1].replaceAll(\"-\",\"+\").replaceAll(\"_\",\"/\")), c => c.charCodeAt(0));\r\n\t\t\tconst secret = String(env.UPLOAD_SIGNING_SECRET || \"change-me\");\r\n\t\t\tconst expected = await hmacSha256(utf8(secret), pBytes);\r\n\t\t\tif (expected.length !== sBytes.length) return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u7C3D\u540D\u7121\u6548\", meta:{ requestId } }, corsHeaders);\r\n\t\t\tlet okSig = 0; for (let i=0;i<expected.length;i++) okSig |= (expected[i]^sBytes[i]);\r\n\t\t\tif (okSig !== 0) return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u7C3D\u540D\u7121\u6548\", meta:{ requestId } }, corsHeaders);\r\n\t\t\tconst payload = JSON.parse(new TextDecoder().decode(pBytes));\r\n\t\t\tif (!payload || typeof payload !== 'object') return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u7C3D\u540D\u7121\u6548\", meta:{ requestId } }, corsHeaders);\r\n\t\t\tif (payload.exp < Math.floor(Date.now()/1000)) return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u7C3D\u540D\u5DF2\u904E\u671F\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t// \u518D\u6B21\u6AA2\u67E5\u7576\u524D\u4F7F\u7528\u8005\u4E00\u81F4\r\n\t\t\tif (String(payload.userId) !== String(me.user_id)) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u4E0D\u5141\u8A31\u7684\u4F7F\u7528\u8005\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t// Header \u9A57\u8B49\r\n\t\t\tconst reqCt = (request.headers.get(\"Content-Type\") || \"\").toLowerCase();\r\n\t\t\tconst reqLen = parseInt(request.headers.get(\"Content-Length\") || \"0\", 10);\r\n\t\t\tif (reqCt !== String(payload.contentType).toLowerCase()) return jsonResponse(415, { ok:false, code:\"INVALID_FILE_TYPE\", message:\"Content-Type \u4E0D\u5339\u914D\", meta:{ requestId } }, corsHeaders);\r\n\t\t\tif (!Number.isFinite(reqLen) || reqLen !== Number(payload.contentLength)) return jsonResponse(400, { ok:false, code:\"VALIDATION_ERROR\", message:\"Content-Length \u4E0D\u5339\u914D\", meta:{ requestId } }, corsHeaders);\r\n\t\t\tif (!env.R2_BUCKET_ATTACHMENTS) return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"R2 \u672A\u7D81\u5B9A\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t// \u5BEB\u5165 R2\r\n\t\t\tconst cd = `attachment; filename=\"${sanitizeFilename(payload.filename)}\"`;\r\n\t\t\tawait env.R2_BUCKET_ATTACHMENTS.put(payload.objectKey, request.body, {\r\n\t\t\t\thttpMetadata: { contentType: payload.contentType, contentDisposition: cd },\r\n\t\t\t\tcustomMetadata: { ownerId: String(me.user_id), module: \"attachments\", entityId: `${payload.entityType}:${payload.entityId}` },\r\n\t\t\t});\r\n\t\t\t// \u5EFA\u7ACB DB \u7D00\u9304\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\"INSERT INTO Attachments (entity_type, entity_id, object_key, filename, content_type, size_bytes, uploader_user_id, uploaded_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)\"\r\n\t\t\t).bind(payload.entityType, payload.entityId, payload.objectKey, payload.filename, payload.contentType, String(payload.contentLength), String(me.user_id), new Date().toISOString()).run();\r\n\t\t\tconst row = await env.DATABASE.prepare(\"SELECT last_insert_rowid() AS id\").first();\r\n\t\t\treturn jsonResponse(201, { ok:true, code:\"CREATED\", message:\"\u5DF2\u4E0A\u50B3\", data:{ attachment_id: row?.id, object_key: payload.objectKey }, meta:{ requestId } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\tif (method === \"GET\") {\r\n\t\ttry {\r\n\t\t\tconst params = url.searchParams;\r\n\t\t\tconst entityType = (params.get(\"entity_type\") || \"\").trim();\r\n\t\t\tconst entityId = (params.get(\"entity_id\") || \"\").trim();\r\n\t\t\tif (!entityType || !entityId) {\r\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"entity_type \u8207 entity_id \u5FC5\u586B\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\tif (!['client','receipt','sop','task'].includes(entityType)) {\r\n\t\t\t\treturn jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"entity_type \u4E0D\u5408\u6CD5\", meta:{ requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\tconst page = Math.max(1, parseInt(params.get(\"page\") || \"1\", 10));\r\n\t\t\tconst perPage = Math.min(100, Math.max(1, parseInt(params.get(\"perPage\") || \"20\", 10)));\r\n\t\t\tconst offset = (page - 1) * perPage;\r\n\t\t\tconst q = (params.get(\"q\") || \"\").trim();\r\n\t\t\tconst fileType = (params.get(\"file_type\") || \"all\").trim();\r\n\t\t\tconst dateFrom = (params.get(\"dateFrom\") || \"\").trim();\r\n\t\t\tconst dateTo = (params.get(\"dateTo\") || \"\").trim();\r\n\r\n\t\t\tconst where = [\"is_deleted = 0\", \"entity_type = ?\", \"entity_id = ?\"];\r\n\t\t\tconst binds = [entityType, entityId];\r\n\t\t\tif (q) { where.push(\"(filename LIKE ?)\"); binds.push(`%${q}%`); }\r\n\t\t\tif (/^\\d{4}-\\d{2}-\\d{2}$/.test(dateFrom)) { where.push(\"uploaded_at >= ?\"); binds.push(`${dateFrom}T00:00:00.000Z`); }\r\n\t\t\tif (/^\\d{4}-\\d{2}-\\d{2}$/.test(dateTo)) { where.push(\"uploaded_at <= ?\"); binds.push(`${dateTo}T23:59:59.999Z`); }\r\n\t\t\tif (fileType !== 'all') {\r\n\t\t\t\t// \u4EE5\u526F\u6A94\u540D\u8207 content_type \u7C97\u7565\u5206\u985E\r\n\t\t\t\tif (fileType === 'pdf') { where.push(\"(LOWER(filename) LIKE '%.pdf' OR LOWER(content_type) = 'application/pdf')\"); }\r\n\t\t\t\telse if (fileType === 'image') { where.push(\"(LOWER(content_type) LIKE 'image/%' OR LOWER(filename) GLOB '*.jpg' OR LOWER(filename) GLOB '*.jpeg' OR LOWER(filename) GLOB '*.png')\"); }\r\n\t\t\t\telse if (fileType === 'excel') { where.push(\"(LOWER(filename) GLOB '*.xls' OR LOWER(filename) GLOB '*.xlsx' OR LOWER(content_type) IN ('application/vnd.ms-excel','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'))\"); }\r\n\t\t\t\telse if (fileType === 'word') { where.push(\"(LOWER(filename) GLOB '*.doc' OR LOWER(filename) GLOB '*.docx' OR LOWER(content_type) IN ('application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document'))\"); }\r\n\t\t\t}\r\n\t\t\tconst whereSql = `WHERE ${where.join(\" AND \")}`;\r\n\t\t\tconst countRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM Attachments ${whereSql}`).bind(...binds).first();\r\n\t\t\tconst total = Number(countRow?.total || 0);\r\n\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT a.attachment_id, a.filename, a.content_type, a.size_bytes, a.uploader_user_id, a.uploaded_at, u.username AS uploader_name\r\n\t\t\t\t FROM Attachments a LEFT JOIN Users u ON u.user_id = a.uploader_user_id\r\n\t\t\t\t ${whereSql}\r\n\t\t\t\t ORDER BY a.uploaded_at DESC\r\n\t\t\t\t LIMIT ? OFFSET ?`\r\n\t\t\t).bind(...binds, perPage, offset).all();\r\n\t\t\tconst data = (rows?.results || []).map(r => ({\r\n\t\t\t\tid: r.attachment_id,\r\n\t\t\t\tfilename: r.filename,\r\n\t\t\t\tcontentType: r.content_type,\r\n\t\t\t\tsizeBytes: Number(r.size_bytes || 0),\r\n\t\t\t\tuploaderUserId: r.uploader_user_id,\r\n\t\t\t\tuploaderName: r.uploader_name || String(r.uploader_user_id || ''),\r\n\t\t\t\tuploadedAt: r.uploaded_at,\r\n\t\t\t}));\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, page, perPage, total } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path:\"/internal/api/v1/attachments\", err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\treturn jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nexport async function handleSOP(request, env, me, requestId, url, path) {\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\tconst method = request.method.toUpperCase();\r\n\r\n\t// GET /internal/api/v1/sop\r\n\tif (path === \"/internal/api/v1/sop\") {\r\n\t\tif (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n\t\ttry {\r\n\t\t\tconst p = url.searchParams;\r\n\t\t\tconst page = Math.max(1, parseInt(p.get(\"page\") || \"1\", 10));\r\n\t\t\tconst perPage = Math.min(100, Math.max(1, parseInt(p.get(\"perPage\") || \"12\", 10)));\r\n\t\t\tconst offset = (page - 1) * perPage;\r\n\t\t\tconst q = (p.get(\"q\") || \"\").trim();\r\n\t\t\tconst category = (p.get(\"category\") || \"\").trim();\r\n\t\t\tconst tagsCsv = (p.get(\"tags\") || \"\").trim();\r\n\t\t\tconst published = (p.get(\"published\") || \"all\").trim().toLowerCase();\r\n\r\n\t\t\tconst where = [\"is_deleted = 0\"];\r\n\t\t\tconst binds = [];\r\n\t\t\tif (q) { where.push(\"(title LIKE ? OR tags LIKE ?)\"); binds.push(`%${q}%`, `%${q}%`); }\r\n\t\t\tif (category && category !== \"all\") { where.push(\"category = ?\"); binds.push(category); }\r\n\t\t\tif (published !== \"all\") {\r\n\t\t\t\tif ([\"1\",\"true\",\"published\"].includes(published)) { where.push(\"is_published = 1\"); }\r\n\t\t\t\telse if ([\"0\",\"false\",\"draft\"].includes(published)) { where.push(\"is_published = 0\"); }\r\n\t\t\t}\r\n\t\t\tif (tagsCsv) {\r\n\t\t\t\tconst tagList = tagsCsv.split(\",\").map(s => s.trim()).filter(Boolean);\r\n\t\t\t\tfor (const t of tagList) { where.push(\"(tags LIKE ?)\"); binds.push(`%${t}%`); }\r\n\t\t\t}\r\n\t\t\tconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n\t\t\tconst countRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM SOPDocuments ${whereSql}`).bind(...binds).first();\r\n\t\t\tconst total = Number(countRow?.total || 0);\r\n\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT sop_id, title, category, tags, version, is_published, created_by, created_at, updated_at\r\n\t\t\t\t FROM SOPDocuments\r\n\t\t\t\t ${whereSql}\r\n\t\t\t\t ORDER BY updated_at DESC, sop_id DESC\r\n\t\t\t\t LIMIT ? OFFSET ?`\r\n\t\t\t).bind(...binds, perPage, offset).all();\r\n\t\t\tconst items = (rows?.results || []).map(r => ({\r\n\t\t\t\tid: r.sop_id,\r\n\t\t\t\ttitle: r.title,\r\n\t\t\t\tcategory: r.category || \"\",\r\n\t\t\t\ttags: (() => { try { return JSON.parse(r.tags || \"[]\"); } catch(_) { return []; } })(),\r\n\t\t\t\tversion: Number(r.version || 1),\r\n\t\t\t\tisPublished: r.is_published === 1,\r\n\t\t\t\tcreatedBy: r.created_by,\r\n\t\t\t\tcreatedAt: r.created_at,\r\n\t\t\t\tupdatedAt: r.updated_at,\r\n\t\t\t}));\r\n\t\t\treturn jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data: items, meta:{ requestId, page, perPage, total } }, corsHeaders);\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n\t\t\treturn jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n\t\t}\r\n\t}\r\n\r\n\treturn jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nfunction parseId(s) {\r\n  const n = parseInt(String(s || \"\"), 10);\r\n  return Number.isFinite(n) && n > 0 ? n : null;\r\n}\r\n\r\nfunction todayStr() {\r\n  const d = new Date();\r\n  const y = d.getUTCFullYear();\r\n  const m = String(d.getUTCMonth() + 1).padStart(2, '0');\r\n  const day = String(d.getUTCDate()).padStart(2, '0');\r\n  return `${y}-${m}-${day}`;\r\n}\r\n\r\nfunction isValidYmd(s) { return /^\\d{4}-\\d{2}-\\d{2}$/.test(String(s || \"\")); }\r\n\r\nexport async function handleClientServices(request, env, me, requestId, url, path) {\r\n  const corsHeaders = getCorsHeadersForRequest(request, env);\r\n  const method = request.method.toUpperCase();\r\n\r\n  // GET list: /internal/api/v1/client-services?status=active&q=...\r\n  if (path === \"/internal/api/v1/client-services\" && method === \"GET\") {\r\n    try {\r\n      const p = url.searchParams;\r\n      const status = (p.get(\"status\") || \"all\").trim();\r\n      const q = (p.get(\"q\") || \"\").trim();\r\n      const page = Math.max(1, parseInt(p.get(\"page\") || \"1\", 10));\r\n      const perPage = Math.min(100, Math.max(1, parseInt(p.get(\"perPage\") || \"12\", 10)));\r\n      const offset = (page - 1) * perPage;\r\n      const where = [\"cs.is_deleted = 0\"]; const binds = [];\r\n      if ([\"active\",\"suspended\",\"expired\",\"cancelled\"].includes(status)) { where.push(\"cs.status = ?\"); binds.push(status); }\r\n      if (q) { where.push(\"(c.company_name LIKE ?)\"); binds.push(`%${q}%`); }\r\n      const whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n      const totalRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM ClientServices cs LEFT JOIN Clients c ON c.client_id = cs.client_id ${whereSql}`).bind(...binds).first();\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT cs.client_service_id, cs.client_id, cs.status, cs.suspension_effective_date, c.company_name\r\n         FROM ClientServices cs LEFT JOIN Clients c ON c.client_id = cs.client_id\r\n         ${whereSql}\r\n         ORDER BY cs.client_service_id DESC\r\n         LIMIT ? OFFSET ?`\r\n      ).bind(...binds, perPage, offset).all();\r\n      const data = (rows?.results || []).map(r => ({\r\n        id: r.client_service_id,\r\n        clientId: r.client_id,\r\n        clientName: r.company_name || r.client_id,\r\n        status: r.status,\r\n        suspensionEffectiveDate: r.suspension_effective_date || null,\r\n      }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, page, perPage, total: Number(totalRow?.total || 0) } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // POST suspend/resume/cancel\r\n  const suspendMatch = path.match(/^\\/internal\\/api\\/v1\\/client-services\\/(\\d+)\\/suspend$/);\r\n  const resumeMatch = path.match(/^\\/internal\\/api\\/v1\\/client-services\\/(\\d+)\\/resume$/);\r\n  const cancelMatch = path.match(/^\\/internal\\/api\\/v1\\/client-services\\/(\\d+)\\/cancel$/);\r\n  const historyMatch = path.match(/^\\/internal\\/api\\/v1\\/client-services\\/(\\d+)\\/history$/);\r\n\r\n  // Suspend\r\n  if (suspendMatch) {\r\n    if (method !== \"POST\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n    let body; try { body = await request.json(); } catch (_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n    const id = parseId(suspendMatch[1]);\r\n    const reason = String(body?.reason || \"\").trim();\r\n    const notes = String(body?.notes || \"\").trim();\r\n    const effective = String(body?.effective_date || \"\").trim();\r\n    if (!id) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u670D\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n    if (!isValidYmd(effective)) return jsonResponse(400, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u65E5\u671F\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    if (!reason) return jsonResponse(400, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u539F\u56E0\u5FC5\u586B\", meta:{ requestId } }, corsHeaders);\r\n    try {\r\n      const svc = await env.DATABASE.prepare(\"SELECT client_service_id, status, suspension_effective_date FROM ClientServices WHERE client_service_id = ? AND is_deleted = 0\").bind(id).first();\r\n      if (!svc) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u670D\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n      if (svc.status !== 'active') return jsonResponse(400, { ok:false, code:\"INVALID_STATE\", message:\"\u76EE\u524D\u72C0\u614B\u4E0D\u5141\u8A31\u6B64\u64CD\u4F5C\", meta:{ requestId } }, corsHeaders);\r\n      if (svc.suspension_effective_date && svc.suspension_effective_date > todayStr()) return jsonResponse(400, { ok:false, code:\"ALREADY_SCHEDULED\", message:\"\u5DF2\u6709\u672A\u4F86\u6392\u7A0B\uFF0C\u4E0D\u53EF\u91CD\u8907\u6392\u7A0B\", meta:{ requestId } }, corsHeaders);\r\n      const nowIso = new Date().toISOString();\r\n      if (effective <= todayStr()) {\r\n        await env.DATABASE.prepare(\"UPDATE ClientServices SET status='suspended', suspended_at = ?, suspension_reason = ?, suspension_effective_date = NULL WHERE client_service_id = ?\").bind(nowIso, reason, id).run();\r\n        await env.DATABASE.prepare(\"INSERT INTO ServiceChangeHistory (client_service_id, old_status, new_status, changed_by, reason, notes) VALUES (?, 'active', 'suspended', ?, ?, ?)\").bind(id, String(me.user_id), reason, notes).run();\r\n        return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u670D\u52D9\u5DF2\u66AB\u505C\", data:{ client_service_id: id, status:'suspended', suspended_at: nowIso } }, corsHeaders);\r\n      }\r\n      await env.DATABASE.prepare(\"UPDATE ClientServices SET suspension_effective_date = ?, suspension_reason = ? WHERE client_service_id = ?\").bind(effective, reason, id).run();\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:`\u5DF2\u6392\u7A0B\u65BC ${effective} \u66AB\u505C`, data:{ client_service_id: id, status:'active', suspension_effective_date: effective } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // Resume\r\n  if (resumeMatch) {\r\n    if (method !== \"POST\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n    let body; try { body = await request.json(); } catch (_) { body = {}; }\r\n    const id = parseId(resumeMatch[1]);\r\n    const notes = String(body?.notes || \"\").trim();\r\n    if (!id) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u670D\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n    try {\r\n      const svc = await env.DATABASE.prepare(\"SELECT client_service_id, status FROM ClientServices WHERE client_service_id = ? AND is_deleted = 0\").bind(id).first();\r\n      if (!svc) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u670D\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n      if (svc.status !== 'suspended') return jsonResponse(400, { ok:false, code:\"INVALID_STATE\", message:\"\u76EE\u524D\u72C0\u614B\u4E0D\u5141\u8A31\u6B64\u64CD\u4F5C\", meta:{ requestId } }, corsHeaders);\r\n      const nowIso = new Date().toISOString();\r\n      await env.DATABASE.prepare(\"UPDATE ClientServices SET status='active', resumed_at = ?, suspended_at = NULL, suspension_reason = NULL, suspension_effective_date = NULL WHERE client_service_id = ?\").bind(nowIso, id).run();\r\n      await env.DATABASE.prepare(\"INSERT INTO ServiceChangeHistory (client_service_id, old_status, new_status, changed_by, reason, notes) VALUES (?, 'suspended', 'active', ?, '', ?)\").bind(id, String(me.user_id), notes).run();\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u670D\u52D9\u5DF2\u6062\u5FA9\", data:{ client_service_id: id, status:'active', resumed_at: nowIso } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // Cancel\r\n  if (cancelMatch) {\r\n    if (method !== \"POST\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n    if (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\r\n    let body; try { body = await request.json(); } catch (_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n    const id = parseId(cancelMatch[1]);\r\n    const reason = String(body?.reason || \"\").trim();\r\n    const cancelTasks = Boolean(body?.cancel_pending_tasks);\r\n    if (!id) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u670D\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n    if (!reason) return jsonResponse(400, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u53D6\u6D88\u539F\u56E0\u5FC5\u586B\", meta:{ requestId } }, corsHeaders);\r\n    try {\r\n      const svc = await env.DATABASE.prepare(\"SELECT client_service_id, status FROM ClientServices WHERE client_service_id = ? AND is_deleted = 0\").bind(id).first();\r\n      if (!svc) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u670D\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n      if (svc.status === 'cancelled') return jsonResponse(400, { ok:false, code:\"INVALID_STATE\", message:\"\u5DF2\u70BA\u53D6\u6D88\u72C0\u614B\", meta:{ requestId } }, corsHeaders);\r\n      const nowIso = new Date().toISOString();\r\n      await env.DATABASE.prepare(\"UPDATE ClientServices SET status='cancelled', cancelled_at = ?, cancelled_by = ? WHERE client_service_id = ?\").bind(nowIso, String(me.user_id), id).run();\r\n      await env.DATABASE.prepare(\"INSERT INTO ServiceChangeHistory (client_service_id, old_status, new_status, changed_by, reason, notes) VALUES (?, ?, 'cancelled', ?, ?, '')\").bind(id, svc.status, String(me.user_id), reason).run();\r\n      let tasksCancelled = false;\r\n      if (cancelTasks) {\r\n        await env.DATABASE.prepare(\"UPDATE ActiveTasks SET status='cancelled' WHERE client_service_id = ? AND status NOT IN ('completed','cancelled')\").bind(id).run();\r\n        tasksCancelled = true;\r\n      }\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u670D\u52D9\u5DF2\u53D6\u6D88\", data:{ client_service_id: id, status:'cancelled', tasks_cancelled: tasksCancelled } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // History\r\n  if (historyMatch) {\r\n    if (method !== \"GET\") return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n    const id = parseId(historyMatch[1]);\r\n    if (!id) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u670D\u52D9\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n    try {\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT h.change_id, h.old_status, h.new_status, h.changed_by, u.name AS changed_by_name, h.changed_at, h.reason, h.notes\r\n         FROM ServiceChangeHistory h LEFT JOIN Users u ON u.user_id = h.changed_by\r\n         WHERE h.client_service_id = ?\r\n         ORDER BY h.changed_at DESC, h.change_id DESC`\r\n      ).bind(id).all();\r\n      const data = (rows?.results || []).map(r => ({ change_id: r.change_id, old_status: r.old_status, new_status: r.new_status, changed_by: r.changed_by_name || String(r.changed_by), changed_at: r.changed_at, reason: r.reason || '', notes: r.notes || '' }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, count: data.length } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nexport async function handleCMS(request, env, me, requestId, url, path) {\r\n  const corsHeaders = getCorsHeadersForRequest(request, env);\r\n  const method = request.method.toUpperCase();\r\n\r\n  // \u5168\u90E8\u7AEF\u9EDE\u7686\u8981\u6C42\u7BA1\u7406\u54E1\uFF1B\u4E0A\u5C64 router \u5DF2\u6AA2\u67E5\uFF0C\u4F46\u9019\u88E1\u518D\u4FDD\u96AA\r\n  if (!me?.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\r\n\r\n  // Articles list\r\n  if (path === \"/internal/api/v1/admin/articles\" && method === \"GET\") {\r\n    try {\r\n      const p = url.searchParams;\r\n      const status = (p.get(\"status\") || \"all\").trim();\r\n      const category = (p.get(\"category\") || \"\").trim();\r\n      const tag = (p.get(\"tag\") || \"\").trim();\r\n      const keyword = (p.get(\"keyword\") || p.get(\"q\") || \"\").trim();\r\n      const page = Math.max(1, parseInt(p.get(\"page\") || \"1\", 10));\r\n      const perPage = Math.min(100, Math.max(1, parseInt(p.get(\"perPage\") || \"20\", 10)));\r\n      const offset = (page - 1) * perPage;\r\n      const where = [\"is_deleted = 0\"]; const binds = [];\r\n      if (status === 'published') { where.push(\"is_published = 1\"); }\r\n      if (status === 'draft') { where.push(\"is_published = 0\"); }\r\n      if (category) { where.push(\"category = ?\"); binds.push(category); }\r\n      if (tag) { where.push(\"tags LIKE ?\"); binds.push(`%${tag}%`); }\r\n      if (keyword) { where.push(\"(title LIKE ? OR summary LIKE ?)\"); binds.push(`%${keyword}%`, `%${keyword}%`); }\r\n      const whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n      const totalRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM ExternalArticles ${whereSql}`).bind(...binds).first();\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT article_id, title, slug, category, tags, is_published, updated_at, view_count\r\n         FROM ExternalArticles\r\n         ${whereSql}\r\n         ORDER BY updated_at DESC, article_id DESC\r\n         LIMIT ? OFFSET ?`\r\n      ).bind(...binds, perPage, offset).all();\r\n      const data = (rows?.results || []).map(r => ({\r\n        id: r.article_id,\r\n        title: r.title,\r\n        slug: r.slug,\r\n        category: r.category || '',\r\n        tags: (()=>{ try { return JSON.parse(r.tags || '[]'); } catch(_) { return []; } })(),\r\n        isPublished: r.is_published === 1,\r\n        updatedAt: r.updated_at,\r\n        viewCount: Number(r.view_count || 0),\r\n      }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, page, perPage, total: Number(totalRow?.total || 0) } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // FAQ list\r\n  if (path === \"/internal/api/v1/admin/faq\" && method === \"GET\") {\r\n    try {\r\n      const p = url.searchParams;\r\n      const status = (p.get(\"status\") || \"all\").trim();\r\n      const category = (p.get(\"category\") || \"\").trim();\r\n      const keyword = (p.get(\"keyword\") || p.get(\"q\") || \"\").trim();\r\n      const page = Math.max(1, parseInt(p.get(\"page\") || \"1\", 10));\r\n      const perPage = Math.min(100, Math.max(1, parseInt(p.get(\"perPage\") || \"20\", 10)));\r\n      const offset = (page - 1) * perPage;\r\n      const where = [\"is_deleted = 0\"]; const binds = [];\r\n      if (status === 'published') where.push(\"is_published = 1\");\r\n      if (status === 'draft') where.push(\"is_published = 0\");\r\n      if (category) { where.push(\"category = ?\"); binds.push(category); }\r\n      if (keyword) { where.push(\"question LIKE ?\"); binds.push(`%${keyword}%`); }\r\n      const whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n      const totalRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM ExternalFAQ ${whereSql}`).bind(...binds).first();\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT faq_id, question, category, sort_order, is_published, updated_at\r\n         FROM ExternalFAQ\r\n         ${whereSql}\r\n         ORDER BY updated_at DESC, sort_order ASC, faq_id DESC\r\n         LIMIT ? OFFSET ?`\r\n      ).bind(...binds, perPage, offset).all();\r\n      const data = (rows?.results || []).map(r => ({\r\n        id: r.faq_id,\r\n        question: r.question,\r\n        category: r.category || '',\r\n        sortOrder: Number(r.sort_order || 0),\r\n        isPublished: r.is_published === 1,\r\n        updatedAt: r.updated_at,\r\n      }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, page, perPage, total: Number(totalRow?.total || 0) } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // Resources list\r\n  if (path === \"/internal/api/v1/admin/resources\" && method === \"GET\") {\r\n    try {\r\n      const p = url.searchParams;\r\n      const category = (p.get(\"category\") || \"\").trim();\r\n      const fileType = (p.get(\"file_type\") || p.get(\"type\") || \"\").trim();\r\n      const keyword = (p.get(\"keyword\") || p.get(\"q\") || \"\").trim();\r\n      const page = Math.max(1, parseInt(p.get(\"page\") || \"1\", 10));\r\n      const perPage = Math.min(100, Math.max(1, parseInt(p.get(\"perPage\") || \"20\", 10)));\r\n      const offset = (page - 1) * perPage;\r\n      const where = [\"is_deleted = 0\"]; const binds = [];\r\n      if (category) { where.push(\"category = ?\"); binds.push(category); }\r\n      if (fileType) { where.push(\"file_type = ?\"); binds.push(fileType); }\r\n      if (keyword) { where.push(\"title LIKE ?\"); binds.push(`%${keyword}%`); }\r\n      const whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n      const totalRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM ResourceCenter ${whereSql}`).bind(...binds).first();\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT resource_id, title, category, file_type, file_size, download_count, updated_at\r\n         FROM ResourceCenter\r\n         ${whereSql}\r\n         ORDER BY updated_at DESC, resource_id DESC\r\n         LIMIT ? OFFSET ?`\r\n      ).bind(...binds, perPage, offset).all();\r\n      const data = (rows?.results || []).map(r => ({\r\n        id: r.resource_id,\r\n        title: r.title,\r\n        category: r.category || '',\r\n        fileType: r.file_type || '',\r\n        fileSize: Number(r.file_size || 0),\r\n        downloadCount: Number(r.download_count || 0),\r\n        updatedAt: r.updated_at,\r\n      }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, page, perPage, total: Number(totalRow?.total || 0) } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // Services list (admin): return all services including unpublished\r\n  if (path === \"/internal/api/v1/admin/services\" && method === \"GET\") {\r\n    try {\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT service_id, service_key, title, is_published, sort_order, updated_at\r\n         FROM ExternalServices\r\n         WHERE is_deleted = 0\r\n         ORDER BY sort_order ASC, service_id ASC`\r\n      ).all();\r\n      const data = (rows?.results || []).map(r => ({\r\n        id: r.service_id,\r\n        key: r.service_key,\r\n        title: r.title,\r\n        isPublished: r.is_published === 1,\r\n        sortOrder: Number(r.sort_order || 0),\r\n        updatedAt: r.updated_at,\r\n      }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, count: data.length } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nconst DANGEROUS_KEYS = new Set([\"rule_comp_hours_expiry\"]);\r\nconst ALLOWED_KEYS = new Set([\r\n  \"company_name\",\r\n  \"contact_email\",\r\n  \"timezone\",\r\n  \"currency\",\r\n  \"timesheet_min_unit\",\r\n  \"soft_delete_enabled\",\r\n  \"workday_start\",\r\n  \"workday_end\",\r\n  \"report_locale\",\r\n  \"rule_comp_hours_expiry\",\r\n  \"attendance_bonus_amount\",\r\n  \"overhead_cost_per_hour\",\r\n  \"target_profit_margin\",\r\n]);\r\n\r\nfunction normalizeKey(key){\r\n  return String(key||\"\").trim();\r\n}\r\n\r\nexport async function handleSettings(request, env, me, requestId, url, path){\r\n  const corsHeaders = getCorsHeadersForRequest(request, env);\r\n  const method = request.method.toUpperCase();\r\n  \r\n  // GET /internal/api/v1/users - \u83B7\u53D6\u6240\u6709\u5458\u5DE5\u5217\u8868\uFF08\u6240\u6709\u767B\u5F55\u7528\u6237\u90FD\u53EF\u8BBF\u95EE\uFF09\r\n  if (path === \"/internal/api/v1/users\" && method === \"GET\"){\r\n    try {\r\n      const rows = await env.DATABASE.prepare(\r\n        \"SELECT user_id, username, name, is_admin FROM Users WHERE is_deleted = 0 ORDER BY user_id ASC\"\r\n      ).all();\r\n      const data = (rows?.results || []).map(r => ({\r\n        user_id: r.user_id,\r\n        username: r.username,\r\n        name: r.name || r.username,\r\n        is_admin: Boolean(r.is_admin)\r\n      }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n  \r\n  if (!me?.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\r\n\r\n  // GET all settings\r\n  if (path === \"/internal/api/v1/admin/settings\" && method === \"GET\"){\r\n    try {\r\n      const rows = await env.DATABASE.prepare(\r\n        \"SELECT setting_key AS key, setting_value AS value, is_dangerous AS isDangerous, description, updated_at AS updatedAt, updated_by AS updatedBy FROM Settings ORDER BY setting_key\"\r\n      ).all();\r\n      const map = {};\r\n      for (const r of (rows?.results||[])) map[r.key] = r.value;\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data:{ items: rows?.results||[], map }, meta:{ requestId } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // PUT update single setting: /internal/api/v1/admin/settings/:key\r\n  if (path.startsWith(\"/internal/api/v1/admin/settings/\") && method === \"PUT\"){\r\n    const key = normalizeKey(path.replace(\"/internal/api/v1/admin/settings/\", \"\"));\r\n    if (!ALLOWED_KEYS.has(key)) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u4E0D\u652F\u63F4\u7684\u8A2D\u5B9A\u9375\", meta:{ requestId } }, corsHeaders);\r\n    let payload;\r\n    try { payload = await request.json(); } catch(_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n    const value = String(payload?.value ?? \"\");\r\n    if (key === \"contact_email\" && value && !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(value)){\r\n      return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"Email \u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n    if (key === \"timesheet_min_unit\"){\r\n      const n = parseFloat(value);\r\n      if (!Number.isFinite(n) || (n!==0.25 && n!==0.5 && n!==1)){\r\n        return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u5DE5\u6642\u6700\u5C0F\u55AE\u4F4D\u50C5\u5141\u8A31 0.25/0.5/1\", meta:{ requestId } }, corsHeaders);\r\n      }\r\n    }\r\n    if (key === \"soft_delete_enabled\"){\r\n      if (!(value === \"0\" || value === \"1\")) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8EDF\u522A\u9664\u503C\u50C5\u80FD\u70BA 0 \u6216 1\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n    if (key === \"workday_start\" || key === \"workday_end\"){\r\n      if (!/^\\d{2}:\\d{2}$/.test(value)) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u6642\u9593\u683C\u5F0F\u9700\u70BA HH:MM\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n    if (key === \"rule_comp_hours_expiry\"){\r\n      const okVals = new Set([\"current_month\",\"next_month\",\"3_months\",\"6_months\"]);\r\n      if (!okVals.has(value)) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u7121\u6548\u7684\u898F\u5247\u503C\", meta:{ requestId } }, corsHeaders);\r\n      if (DANGEROUS_KEYS.has(key) && payload?.confirmed !== true){\r\n        return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u5371\u96AA\u8A2D\u5B9A\u9700\u78BA\u8A8D\", meta:{ requestId, field:key } }, corsHeaders);\r\n      }\r\n    }\r\n    if (key === \"attendance_bonus_amount\"){\r\n      const n = parseInt(value, 10);\r\n      if (!Number.isInteger(n) || n < 0) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u5168\u52E4\u734E\u91D1\u5FC5\u9808\u70BA\u975E\u8CA0\u6574\u6578\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n    if (key === \"overhead_cost_per_hour\"){\r\n      const n = parseFloat(value);\r\n      if (!Number.isFinite(n) || n < 0) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u7BA1\u7406\u6210\u672C\u5FC5\u9808\u70BA\u975E\u8CA0\u6578\u5B57\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n    if (key === \"target_profit_margin\"){\r\n      const n = parseFloat(value);\r\n      if (!Number.isFinite(n) || n < 0 || n > 100) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u76EE\u6A19\u6BDB\u5229\u7387\u5FC5\u9808\u5728 0-100 \u4E4B\u9593\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n    try {\r\n      const nowIso = new Date().toISOString();\r\n      await env.DATABASE.prepare(\r\n        \"INSERT INTO Settings(setting_key, setting_value, updated_at, updated_by) VALUES(?, ?, ?, ?) ON CONFLICT(setting_key) DO UPDATE SET setting_value=excluded.setting_value, updated_at=excluded.updated_at, updated_by=excluded.updated_by\"\r\n      ).bind(key, value, nowIso, String(me.user_id||me.userId||\"1\")).run();\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u66F4\u65B0\", data:{ key, value }, meta:{ requestId } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u7121\u6B64\u7AEF\u9EDE\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nfunction ymToday() {\r\n  const d = new Date();\r\n  return `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, '0')}`;\r\n}\r\n\r\nfunction todayYmd() {\r\n  const d = new Date();\r\n  return `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, '0')}-${String(d.getUTCDate()).padStart(2, '0')}`;\r\n}\r\n\r\nexport async function handleDashboard(request, env, me, requestId, url, path) {\r\n  const corsHeaders = getCorsHeadersForRequest(request, env);\r\n  const method = request.method.toUpperCase();\r\n  if (path !== \"/internal/api/v1/dashboard\" || method !== \"GET\") {\r\n    return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n  }\r\n\r\n  try {\r\n    // \u4ECE\u67E5\u8BE2\u53C2\u6570\u83B7\u53D6\u6708\u4EFD\uFF0C\u5982\u679C\u6CA1\u6709\u5219\u4F7F\u7528\u5F53\u524D\u6708\u4EFD\r\n    const searchParams = new URL(url).searchParams;\r\n    const requestedYm = searchParams.get('ym');\r\n    const ym = requestedYm && /^\\d{4}-\\d{2}$/.test(requestedYm) ? requestedYm : ymToday();\r\n    \r\n    // \u8D22\u52A1\u72B6\u51B5\u7684\u6708\u4EFD\u548C\u6A21\u5F0F\r\n    const financeYm = searchParams.get('financeYm') && /^\\d{4}-\\d{2}$/.test(searchParams.get('financeYm')) ? searchParams.get('financeYm') : ym;\r\n    const financeMode = searchParams.get('financeMode') || 'month'; // 'month' \u6216 'ytd'\r\n    \r\n    const today = todayYmd();\r\n\r\n    // Employee metrics\r\n    async function getEmployeeMetrics() {\r\n      const res = { myHours: null, myTasks: { items: [], counts: { pending: 0, inProgress: 0, overdue: 0, dueSoon: 0 } }, myLeaves: null, recentActivities: [], notifications: [] };\r\n      // Hours\r\n      try {\r\n        const h = await env.DATABASE.prepare(\r\n          `SELECT \r\n              SUM(hours) AS total,\r\n              SUM(CASE WHEN work_type = 'normal' THEN hours ELSE 0 END) AS normal,\r\n              SUM(CASE WHEN work_type LIKE 'ot-%' THEN hours ELSE 0 END) AS overtime\r\n           FROM Timesheets WHERE is_deleted = 0 AND user_id = ? AND substr(work_date,1,7) = ?`\r\n        ).bind(String(me.user_id), ym).first();\r\n        const total = Number(h?.total || 0), normal = Number(h?.normal || 0), overtime = Number(h?.overtime || 0);\r\n        const target = 160; const completionRate = target ? Math.round((total / target) * 1000) / 10 : 0;\r\n        res.myHours = { month: ym, total, normal, overtime, targetHours: target, completionRate };\r\n      } catch (_) {}\r\n\r\n      // Tasks (pending/in_progress)\r\n      try {\r\n        const rows = await env.DATABASE.prepare(\r\n          `SELECT task_id, task_name, due_date, status, related_sop_id, client_specific_sop_id\r\n           FROM ActiveTasks\r\n           WHERE is_deleted = 0 AND assignee_user_id = ? AND status IN ('pending','in_progress')\r\n           ORDER BY COALESCE(due_date, '9999-12-31') ASC LIMIT 10`\r\n        ).bind(String(me.user_id)).all();\r\n        const items = (rows?.results || []).map(r => {\r\n          const due = r.due_date || null;\r\n          let urgency = 'normal';\r\n          let daysUntilDue = null; let daysOverdue = null; const now = new Date();\r\n          if (due) {\r\n            const d = new Date(due); const delta = Math.floor((d.getTime() - now.getTime()) / 86400000);\r\n            daysUntilDue = delta;\r\n            if (delta < 0) { urgency = 'overdue'; daysOverdue = -delta; }\r\n            else if (delta <= 3) urgency = 'urgent';\r\n          }\r\n          return { id: r.task_id, name: r.task_name, dueDate: due, status: r.status, urgency, daysUntilDue, daysOverdue, hasSop: !!(r.related_sop_id || r.client_specific_sop_id) };\r\n        });\r\n        const counts = { pending: 0, inProgress: 0, overdue: 0, dueSoon: 0 };\r\n        for (const it of items) {\r\n          if (it.status === 'pending') counts.pending++;\r\n          if (it.status === 'in_progress') counts.inProgress++;\r\n          if (it.urgency === 'overdue') counts.overdue++;\r\n          if (typeof it.daysUntilDue === 'number' && it.daysUntilDue >= 0 && it.daysUntilDue <= 3) counts.dueSoon++;\r\n        }\r\n        res.myTasks = { items, counts };\r\n      } catch (_) {}\r\n\r\n      // Leaves (balances and recent)\r\n      try {\r\n        const rows = await env.DATABASE.prepare(\r\n          `SELECT leave_type AS type, remain AS remaining, total, used FROM LeaveBalances WHERE user_id = ?`\r\n        ).bind(String(me.user_id)).all();\r\n        const bal = { annual: 0, sick: 0, compHours: 0 };\r\n        for (const r of (rows?.results || [])) {\r\n          const t = (r.type || '').toLowerCase();\r\n          if (t === 'annual') bal.annual = Number(r.remaining || 0);\r\n          else if (t === 'sick') bal.sick = Number(r.remaining || 0);\r\n          else if (t === 'comp') bal.compHours = Number(r.remaining || 0);\r\n        }\r\n        const recentRows = await env.DATABASE.prepare(\r\n          `SELECT leave_type AS type, start_date, end_date, amount, status FROM LeaveRequests WHERE user_id = ? ORDER BY submitted_at DESC LIMIT 3`\r\n        ).bind(String(me.user_id)).all();\r\n        const recent = (recentRows?.results || []).map(r => ({ type: r.type, startDate: r.start_date, days: Number(r.amount || 0), status: r.status }));\r\n        res.myLeaves = { balances: bal, recent };\r\n      } catch (_) {}\r\n\r\n      return res;\r\n    }\r\n\r\n    // Admin metrics\r\n    async function getAdminMetrics(targetYm, finYm, finMode) {\r\n      const res = { employeeHours: [], employeeTasks: [], financialStatus: null, revenueTrend: [] };\r\n      \r\n      // Employee hours (\u5404\u5458\u5DE5\u5206\u522B\u5DE5\u65F6 - \u6309\u6307\u5B9A\u6708\u4EFD\u67E5\u8BE2)\r\n      // work_type: 1=\u6B63\u5E38\u5DE5\u65F6\uFF0C2-11=\u5404\u79CD\u52A0\u73ED\u7C7B\u578B\r\n      try {\r\n        const result = await env.DATABASE.prepare(\r\n          `SELECT u.user_id, u.name, u.username,\r\n                  COALESCE(SUM(t.hours), 0) AS total,\r\n                  COALESCE(SUM(CASE WHEN CAST(t.work_type AS INTEGER) = 1 THEN t.hours ELSE 0 END), 0) AS normal,\r\n                  COALESCE(SUM(CASE WHEN CAST(t.work_type AS INTEGER) >= 2 THEN t.hours ELSE 0 END), 0) AS overtime\r\n           FROM Users u\r\n           LEFT JOIN Timesheets t ON t.user_id = u.user_id AND t.is_deleted = 0 AND substr(t.work_date, 1, 7) = ?\r\n           WHERE u.is_deleted = 0\r\n           GROUP BY u.user_id, u.name, u.username\r\n           ORDER BY total DESC, u.name ASC`\r\n        ).bind(targetYm).all();\r\n        \r\n        // D1 returns { results: [...], success: true }\r\n        const rows = result?.results || [];\r\n        res.employeeHours = rows.map(r => ({\r\n          userId: r.user_id,\r\n          name: r.name || r.username || '\u672A\u547D\u540D',\r\n          total: Number(r.total || 0),\r\n          normal: Number(r.normal || 0),\r\n          overtime: Number(r.overtime || 0)\r\n        }));\r\n      } catch (e) {\r\n        console.error('[Dashboard] Employee hours query error:', e);\r\n      }\r\n\r\n      // Financial status - \u6839\u636EfinMode\u8FD4\u56DE\u5BF9\u5E94\u6570\u636E\r\n      try {\r\n        const currentYear = finYm.split('-')[0]; // \u4ECEfinYm\u83B7\u53D6\u5E74\u4EFD\r\n        \r\n        // \u73B0\u91D1\u6D41\u6570\u636E\uFF08\u5B9E\u65F6\uFF0C\u4E0D\u5206\u6708\u4EFD\uFF09\r\n        const arRow = await env.DATABASE.prepare(\r\n          `SELECT SUM(total_amount) AS ar FROM Receipts WHERE is_deleted = 0 AND status IN ('unpaid','partial')`\r\n        ).first();\r\n        const overdueRow = await env.DATABASE.prepare(\r\n          `SELECT SUM(total_amount) AS od FROM Receipts WHERE is_deleted = 0 AND status IN ('unpaid','partial') AND due_date < ?`\r\n        ).bind(today).first();\r\n        const ar = Math.round(Number(arRow?.ar || 0));\r\n        const overdue = Math.round(Number(overdueRow?.od || 0));\r\n        \r\n        let monthData = null;\r\n        let ytdData = null;\r\n        \r\n        if (finMode === 'month') {\r\n          // \u6708\u5EA6\u6570\u636E\r\n          const monthPaidRow = await env.DATABASE.prepare(\r\n            `SELECT SUM(total_amount) AS paid FROM Receipts WHERE is_deleted = 0 AND status = 'paid' AND substr(receipt_date,1,7) = ?`\r\n          ).bind(finYm).first();\r\n          const monthRevRow = await env.DATABASE.prepare(\r\n            `SELECT SUM(total_amount) AS revenue FROM Receipts WHERE is_deleted = 0 AND status != 'cancelled' AND substr(receipt_date,1,7) = ?`\r\n          ).bind(finYm).first();\r\n          let monthCost = 0;\r\n          try {\r\n            const pr = await env.DATABASE.prepare(`SELECT SUM(total_cents) AS c FROM MonthlyPayroll mp JOIN PayrollRuns pr ON pr.run_id = mp.run_id WHERE pr.month = ?`).bind(finYm).first();\r\n            monthCost = Math.round(Number(pr?.c || 0) / 100);\r\n          } catch (_) {}\r\n          \r\n          const monthRevenue = Math.round(Number(monthRevRow?.revenue || 0));\r\n          const monthPaid = Math.round(Number(monthPaidRow?.paid || 0));\r\n          const monthProfit = monthRevenue - monthCost;\r\n          const monthMargin = monthRevenue > 0 ? Math.round((monthProfit / monthRevenue) * 1000) / 10 : 0;\r\n          const monthCollectionRate = monthRevenue > 0 ? Math.round((monthPaid / monthRevenue) * 1000) / 10 : 0;\r\n          \r\n          monthData = {\r\n            period: finYm,\r\n            revenue: monthRevenue,\r\n            cost: monthCost,\r\n            profit: monthProfit,\r\n            margin: monthMargin,\r\n            ar,\r\n            paid: monthPaid,\r\n            overdue,\r\n            collectionRate: monthCollectionRate\r\n          };\r\n        } else {\r\n          // \u5E74\u5EA6\u7D2F\u8BA1\u6570\u636E\uFF08\u622A\u81F3\u4ECA\u65E5\uFF09\r\n          const ytdPaidRow = await env.DATABASE.prepare(\r\n            `SELECT SUM(total_amount) AS paid FROM Receipts WHERE is_deleted = 0 AND status = 'paid' AND substr(receipt_date,1,4) = ? AND receipt_date <= ?`\r\n          ).bind(currentYear, today).first();\r\n          const ytdRevRow = await env.DATABASE.prepare(\r\n            `SELECT SUM(total_amount) AS revenue FROM Receipts WHERE is_deleted = 0 AND status != 'cancelled' AND substr(receipt_date,1,4) = ? AND receipt_date <= ?`\r\n          ).bind(currentYear, today).first();\r\n          let ytdCost = 0;\r\n          try {\r\n            const pr = await env.DATABASE.prepare(`SELECT SUM(total_cents) AS c FROM MonthlyPayroll mp JOIN PayrollRuns pr ON pr.run_id = mp.run_id WHERE substr(pr.month,1,4) = ?`).bind(currentYear).first();\r\n            ytdCost = Math.round(Number(pr?.c || 0) / 100);\r\n          } catch (_) {}\r\n          \r\n          const ytdRevenue = Math.round(Number(ytdRevRow?.revenue || 0));\r\n          const ytdPaid = Math.round(Number(ytdPaidRow?.paid || 0));\r\n          const ytdProfit = ytdRevenue - ytdCost;\r\n          const ytdMargin = ytdRevenue > 0 ? Math.round((ytdProfit / ytdRevenue) * 1000) / 10 : 0;\r\n          const ytdCollectionRate = ytdRevenue > 0 ? Math.round((ytdPaid / ytdRevenue) * 1000) / 10 : 0;\r\n          \r\n          ytdData = {\r\n            period: `${currentYear}\u5E74\u7D2F\u8A08`,\r\n            revenue: ytdRevenue,\r\n            cost: ytdCost,\r\n            profit: ytdProfit,\r\n            margin: ytdMargin,\r\n            ar,\r\n            paid: ytdPaid,\r\n            overdue,\r\n            collectionRate: ytdCollectionRate\r\n          };\r\n        }\r\n        \r\n        res.financialStatus = { \r\n          month: monthData,\r\n          ytd: ytdData\r\n        };\r\n      } catch (_) {}\r\n\r\n      // Employee tasks (\u5404\u5458\u5DE5\u4EFB\u52A1\u72B6\u6001\uFF1A\u5DF2\u5B8C\u6210/\u8FDB\u884C\u4E2D/\u903E\u671F)\r\n      try {\r\n        const rows = await env.DATABASE.prepare(\r\n          `SELECT u.user_id, u.name, u.username,\r\n                  COUNT(CASE WHEN t.status = 'completed' THEN 1 END) AS completed,\r\n                  COUNT(CASE WHEN t.status = 'in_progress' THEN 1 END) AS inProgress,\r\n                  COUNT(CASE WHEN t.status NOT IN ('completed','cancelled') AND t.due_date < ? THEN 1 END) AS overdue,\r\n                  COUNT(CASE WHEN t.status = 'pending' THEN 1 END) AS pending\r\n           FROM Users u\r\n           LEFT JOIN ActiveTasks t ON t.assignee_user_id = u.user_id AND t.is_deleted = 0\r\n           WHERE u.is_deleted = 0\r\n           GROUP BY u.user_id, u.name, u.username\r\n           ORDER BY overdue DESC, inProgress DESC`\r\n        ).bind(today).all();\r\n        \r\n        res.employeeTasks = (rows?.results || []).map(r => ({\r\n          userId: r.user_id,\r\n          name: r.name || r.username,\r\n          completed: Number(r.completed || 0),\r\n          inProgress: Number(r.inProgress || 0),\r\n          overdue: Number(r.overdue || 0),\r\n          pending: Number(r.pending || 0)\r\n        }));\r\n      } catch (_) {}\r\n\r\n      // Revenue trend (last 6 months)\r\n      try {\r\n        const rows = await env.DATABASE.prepare(\r\n          `SELECT strftime('%Y-%m', receipt_date) AS ym, SUM(total_amount) AS revenue,\r\n                  SUM(CASE WHEN status='paid' THEN total_amount ELSE 0 END) AS paid\r\n           FROM Receipts WHERE is_deleted = 0 AND status != 'cancelled'\r\n           GROUP BY ym ORDER BY ym DESC LIMIT 6`\r\n        ).all();\r\n        const list = (rows?.results || []).map(r => ({ month: r.ym, revenue: Number(r.revenue || 0), paid: Number(r.paid || 0) }));\r\n        res.revenueTrend = list.sort((a,b)=> a.month.localeCompare(b.month));\r\n      } catch (_) {}\r\n\r\n      return res;\r\n    }\r\n\r\n    const data = { role: me.is_admin ? 'admin' : 'employee' };\r\n    if (me.is_admin) {\r\n      data.admin = await getAdminMetrics(ym, financeYm, financeMode);\r\n    } else {\r\n      data.employee = await getEmployeeMetrics();\r\n    }\r\n\r\n    return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, month: ym, financeYm, financeMode, today } }, corsHeaders);\r\n  } catch (err) {\r\n    console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n    return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n  }\r\n}\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nfunction isValidSchedule(type, value) {\r\n  if (!['daily','weekly','monthly','cron'].includes(type)) return false;\r\n  if (type === 'daily') return /^\\d{2}:\\d{2}$/.test(value||'');\r\n  if (type === 'weekly') return /^([A-Z][a-z]{2})\\s+\\d{2}:\\d{2}$/.test(value||''); // e.g. Mon 03:00\r\n  if (type === 'monthly') return /^(\\d{1,2})\\s+\\d{2}:\\d{2}$/.test(value||''); // e.g. 1 02:00\r\n  if (type === 'cron') return typeof value === 'string' && value.trim().length > 0; // accept any non-empty; real cron parser omitted\r\n  return false;\r\n}\r\n\r\nfunction parseJsonSafe(s, def=null) { try { return JSON.parse(String(s||'null')); } catch(_) { return def; } }\r\n\r\nexport async function handleAutomation(request, env, me, requestId, url, path) {\r\n  const corsHeaders = getCorsHeadersForRequest(request, env);\r\n  if (!me?.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, corsHeaders);\r\n  const method = request.method.toUpperCase();\r\n\r\n  // List\r\n  if (path === \"/internal/api/v1/admin/automation-rules\" && method === \"GET\") {\r\n    try {\r\n      const p = url.searchParams; const q = (p.get('q')||'').trim(); const enabled = p.get('enabled');\r\n      const page = Math.max(1, parseInt(p.get('page')||'1',10)); const perPage = Math.min(100, Math.max(1, parseInt(p.get('perPage')||'20',10)));\r\n      const offset = (page-1)*perPage; const where=[\"is_deleted=0\"]; const binds=[];\r\n      if (q) { where.push(\"rule_name LIKE ?\"); binds.push(`%${q}%`); }\r\n      if (enabled==='0' || enabled==='1') { where.push(\"is_enabled = ?\"); binds.push(parseInt(enabled,10)); }\r\n      const whereSql = where.length?`WHERE ${where.join(' AND ')}`:'';\r\n      const totalRow = await env.DATABASE.prepare(`SELECT COUNT(1) AS total FROM AutomationRules ${whereSql}`).bind(...binds).first();\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT rule_id, rule_name, schedule_type, schedule_value, is_enabled, last_run_at, created_at, updated_at\r\n         FROM AutomationRules ${whereSql} ORDER BY updated_at DESC, rule_id DESC LIMIT ? OFFSET ?`\r\n      ).bind(...binds, perPage, offset).all();\r\n      const data = (rows?.results||[]).map(r=>({ id:r.rule_id, name:r.rule_name, scheduleType:r.schedule_type, scheduleValue:r.schedule_value, isEnabled:r.is_enabled===1, lastRunAt:r.last_run_at, createdAt:r.created_at, updatedAt:r.updated_at }));\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6210\u529F\", data, meta:{ requestId, page, perPage, total:Number(totalRow?.total||0) } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // Create\r\n  if (path === \"/internal/api/v1/admin/automation-rules\" && method === \"POST\") {\r\n    let body; try { body = await request.json(); } catch(_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n    const name = String(body?.rule_name || body?.name || '').trim();\r\n    const scheduleType = String(body?.schedule_type || body?.scheduleType || '').trim();\r\n    const scheduleValue = String(body?.schedule_value || body?.scheduleValue || '').trim();\r\n    const condition = body?.condition_json ?? body?.condition ?? null;\r\n    const action = body?.action_json ?? body?.action ?? null;\r\n    const errors = [];\r\n    if (!name) errors.push({ field:'rule_name', message:'\u5FC5\u586B' });\r\n    if (!isValidSchedule(scheduleType, scheduleValue)) errors.push({ field:'schedule', message:'\u6392\u7A0B\u4E0D\u5408\u6CD5' });\r\n    if (!action) errors.push({ field:'action', message:'\u5FC5\u586B' });\r\n    if (errors.length) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u8F38\u5165\u6709\u8AA4\", errors, meta:{ requestId } }, corsHeaders);\r\n    try {\r\n      await env.DATABASE.prepare(\r\n        `INSERT INTO AutomationRules (rule_name, schedule_type, schedule_value, condition_json, action_json, is_enabled) VALUES (?, ?, ?, ?, ?, 1)`\r\n      ).bind(name, scheduleType, scheduleValue, JSON.stringify(condition ?? {}), JSON.stringify(action ?? {})).run();\r\n      const idRow = await env.DATABASE.prepare(`SELECT last_insert_rowid() AS id`).first();\r\n      return jsonResponse(201, { ok:true, code:\"CREATED\", message:\"\u5DF2\u5EFA\u7ACB\", data:{ id:Number(idRow?.id||0) }, meta:{ requestId } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // Update\r\n  const updateMatch = path.match(/^\\/internal\\/api\\/v1\\/admin\\/automation-rules\\/(\\d+)$/);\r\n  if (updateMatch) {\r\n    if (!['PUT','DELETE'].includes(method)) return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n    const id = parseInt(updateMatch[1],10);\r\n    if (method === 'DELETE') {\r\n      try {\r\n        await env.DATABASE.prepare(`UPDATE AutomationRules SET is_deleted = 1 WHERE rule_id = ?`).bind(id).run();\r\n        return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u522A\u9664\", data:{ id }, meta:{ requestId } }, corsHeaders);\r\n      } catch (err) {\r\n        console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n        return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n      }\r\n    }\r\n    let body; try { body = await request.json(); } catch(_) { return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta:{ requestId } }, corsHeaders); }\r\n    const name = body?.rule_name !== undefined ? String(body.rule_name).trim() : undefined;\r\n    const scheduleType = body?.schedule_type !== undefined ? String(body.schedule_type).trim() : undefined;\r\n    const scheduleValue = body?.schedule_value !== undefined ? String(body.schedule_value).trim() : undefined;\r\n    const isEnabled = body?.is_enabled;\r\n    const condition = body?.condition_json !== undefined ? JSON.stringify(parseJsonSafe(body.condition_json, {})) : undefined;\r\n    const action = body?.action_json !== undefined ? JSON.stringify(parseJsonSafe(body.action_json, {})) : undefined;\r\n    const sets = []; const binds = [];\r\n    if (name !== undefined) { if (!name) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u540D\u7A31\u5FC5\u586B\", meta:{ requestId } }, corsHeaders); sets.push('rule_name = ?'); binds.push(name); }\r\n    if (scheduleType !== undefined || scheduleValue !== undefined) {\r\n      const t = scheduleType ?? (await env.DATABASE.prepare(`SELECT schedule_type FROM AutomationRules WHERE rule_id = ?`).bind(id).first())?.schedule_type;\r\n      const v = scheduleValue ?? (await env.DATABASE.prepare(`SELECT schedule_value FROM AutomationRules WHERE rule_id = ?`).bind(id).first())?.schedule_value;\r\n      if (!isValidSchedule(t, v)) return jsonResponse(422, { ok:false, code:\"VALIDATION_ERROR\", message:\"\u6392\u7A0B\u4E0D\u5408\u6CD5\", meta:{ requestId } }, corsHeaders);\r\n      if (scheduleType !== undefined) { sets.push('schedule_type = ?'); binds.push(scheduleType); }\r\n      if (scheduleValue !== undefined) { sets.push('schedule_value = ?'); binds.push(scheduleValue); }\r\n    }\r\n    if (condition !== undefined) { sets.push('condition_json = ?'); binds.push(condition); }\r\n    if (action !== undefined) { sets.push('action_json = ?'); binds.push(action); }\r\n    if (isEnabled === 0 || isEnabled === 1 || isEnabled === true || isEnabled === false) { sets.push('is_enabled = ?'); binds.push((isEnabled===1||isEnabled===true)?1:0); }\r\n    if (!sets.length) return jsonResponse(400, { ok:false, code:\"BAD_REQUEST\", message:\"\u7121\u53EF\u66F4\u65B0\u6B04\u4F4D\", meta:{ requestId } }, corsHeaders);\r\n    sets.push('updated_at = datetime(\\'now\\')');\r\n    try {\r\n      await env.DATABASE.prepare(`UPDATE AutomationRules SET ${sets.join(', ')} WHERE rule_id = ?`).bind(...binds, id).run();\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u5DF2\u66F4\u65B0\", data:{ id }, meta:{ requestId } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // Test execution (dry run)\r\n  const testMatch = path.match(/^\\/internal\\/api\\/v1\\/admin\\/automation-rules\\/(\\d+)\\/test$/);\r\n  if (testMatch) {\r\n    if (method !== 'POST') return jsonResponse(405, { ok:false, code:\"METHOD_NOT_ALLOWED\", message:\"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta:{ requestId } }, corsHeaders);\r\n    const id = parseInt(testMatch[1], 10);\r\n    try {\r\n      const row = await env.DATABASE.prepare(`SELECT rule_id, rule_name, schedule_type, schedule_value, condition_json, action_json, is_enabled FROM AutomationRules WHERE rule_id = ? AND is_deleted = 0`).bind(id).first();\r\n      if (!row) return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u898F\u5247\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n      const condition = parseJsonSafe(row.condition_json, {});\r\n      const action = parseJsonSafe(row.action_json, {});\r\n      // \u9019\u88E1\u50C5\u56DE\u50B3\u5C07\u57F7\u884C\u7684\u52D5\u4F5C\u6458\u8981\uFF08\u4E7E\u8DD1\uFF09\uFF1B\u5BE6\u969B\u57F7\u884C\u4EA4\u7531\u6392\u7A0B\u5668\r\n      const summary = { ruleId: row.rule_id, ruleName: row.rule_name, willExecute: !!row.is_enabled, condition, action };\r\n      return jsonResponse(200, { ok:true, code:\"OK\", message:\"\u6E2C\u8A66\u6210\u529F\", data: summary, meta:{ requestId } }, corsHeaders);\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level:\"error\", requestId, path, err:String(err) }));\r\n      return jsonResponse(500, { ok:false, code:\"INTERNAL_ERROR\", message:\"\u4F3A\u670D\u5668\u932F\u8AA4\", meta:{ requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  return jsonResponse(404, { ok:false, code:\"NOT_FOUND\", message:\"\u4E0D\u5B58\u5728\", meta:{ requestId } }, corsHeaders);\r\n}\r\n\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\n/**\r\n * GET /api/v1/holidays - \u67E5\u8A62\u5047\u65E5\u8CC7\u6599\r\n */\r\nexport async function handleHolidays(request, env, me, requestId, url) {\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\tconst method = request.method.toUpperCase();\r\n\t\r\n\tif (method === \"GET\") {\r\n\t\ttry {\r\n\t\t\tconst params = url.searchParams;\r\n\t\t\tconst startDate = (params.get(\"start_date\") || \"\").trim();\r\n\t\t\tconst endDate = (params.get(\"end_date\") || \"\").trim();\r\n\t\t\t\r\n\t\t\tconst where = [];\r\n\t\t\tconst binds = [];\r\n\t\t\t\r\n\t\t\t// \u65E5\u671F\u7BC4\u570D\u7BE9\u9078\r\n\t\t\tif (startDate) {\r\n\t\t\t\twhere.push(\"holiday_date >= ?\");\r\n\t\t\t\tbinds.push(startDate);\r\n\t\t\t}\r\n\t\t\tif (endDate) {\r\n\t\t\t\twhere.push(\"holiday_date <= ?\");\r\n\t\t\t\tbinds.push(endDate);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst whereSql = where.length ? `WHERE ${where.join(\" AND \")}` : \"\";\r\n\t\t\t\r\n\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT holiday_date, name, is_national_holiday, is_weekly_restday, is_makeup_workday\r\n\t\t\t\t FROM Holidays\r\n\t\t\t\t ${whereSql}\r\n\t\t\t\t ORDER BY holiday_date ASC`\r\n\t\t\t).bind(...binds).all();\r\n\t\t\t\r\n\t\tconst data = (rows?.results || []).map(r => ({\r\n\t\t\tholiday_date: r.holiday_date, // \u524D\u7AEF\u671F\u671B\u7684\u6B04\u4F4D\u540D\u7A31\r\n\t\t\tdate: r.holiday_date,         // \u5411\u5F8C\u517C\u5BB9\r\n\t\t\tname: r.name || \"\",\r\n\t\t\tis_national_holiday: Boolean(r.is_national_holiday),\r\n\t\t\tis_weekly_restday: Boolean(r.is_weekly_restday),\r\n\t\t\tis_makeup_workday: Boolean(r.is_makeup_workday),\r\n\t\t}));\r\n\t\t\t\r\n\t\t\treturn jsonResponse(200, { \r\n\t\t\t\tok: true, \r\n\t\t\t\tcode: \"SUCCESS\", \r\n\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\", \r\n\t\t\t\tdata, \r\n\t\t\t\tmeta: { requestId } \r\n\t\t\t}, corsHeaders);\r\n\t\t\t\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\r\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, getCorsHeadersForRequest(request, env));\r\n\t\t}\r\n\t}\r\n\t\r\n\treturn jsonResponse(405, { \r\n\t\tok: false, \r\n\t\tcode: \"METHOD_NOT_ALLOWED\", \r\n\t\tmessage: \"\u65B9\u6CD5\u4E0D\u5141\u8A31\", \r\n\t\tmeta: { requestId } \r\n\t}, corsHeaders);\r\n}\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\n/**\r\n * \u6A19\u7C64\u7BA1\u7406 API\r\n * GET /api/v1/tags - \u67E5\u8A62\u6240\u6709\u6A19\u7C64\r\n * POST /api/v1/tags - \u65B0\u589E\u6A19\u7C64\r\n * PUT /api/v1/tags/:id - \u66F4\u65B0\u6A19\u7C64\r\n * DELETE /api/v1/tags/:id - \u522A\u9664\u6A19\u7C64\r\n */\r\nexport async function handleTags(request, env, me, requestId, url) {\r\n\tconst corsHeaders = getCorsHeadersForRequest(request, env);\r\n\tconst method = request.method.toUpperCase();\r\n\t\r\n\t// GET /api/v1/tags - \u67E5\u8A62\u6240\u6709\u6A19\u7C64\r\n\tif (method === \"GET\" && !url.pathname.match(/\\/tags\\/\\d+$/)) {\r\n\t\ttry {\r\n\t\t\tconst rows = await env.DATABASE.prepare(\r\n\t\t\t\t\"SELECT tag_id, tag_name, tag_color, created_at FROM CustomerTags ORDER BY tag_name ASC\"\r\n\t\t\t).all();\r\n\t\t\t\r\n\t\t\tconst data = (rows?.results || []).map(r => ({\r\n\t\t\t\ttag_id: r.tag_id,\r\n\t\t\t\ttag_name: r.tag_name,\r\n\t\t\t\ttag_color: r.tag_color || null,\r\n\t\t\t\tcreated_at: r.created_at\r\n\t\t\t}));\r\n\t\t\t\r\n\t\t\treturn jsonResponse(200, { \r\n\t\t\t\tok: true, \r\n\t\t\t\tcode: \"SUCCESS\", \r\n\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\", \r\n\t\t\t\tdata, \r\n\t\t\t\tmeta: { requestId } \r\n\t\t\t}, corsHeaders);\r\n\t\t\t\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\r\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, corsHeaders);\r\n\t\t}\r\n\t}\r\n\t\r\n\t// GET /api/v1/tags/:id - \u67E5\u8A62\u55AE\u4E00\u6A19\u7C64\r\n\tif (method === \"GET\" && url.pathname.match(/\\/tags\\/\\d+$/)) {\r\n\t\tconst tagId = parseInt(url.pathname.split(\"/\").pop(), 10);\r\n\t\ttry {\r\n\t\t\tconst row = await env.DATABASE.prepare(\r\n\t\t\t\t\"SELECT tag_id, tag_name, tag_color, created_at FROM CustomerTags WHERE tag_id = ?\"\r\n\t\t\t).bind(tagId).first();\r\n\t\t\t\r\n\t\t\tif (!row) {\r\n\t\t\t\treturn jsonResponse(404, { \r\n\t\t\t\t\tok: false, \r\n\t\t\t\t\tcode: \"NOT_FOUND\", \r\n\t\t\t\t\tmessage: \"\u6A19\u7C64\u4E0D\u5B58\u5728\", \r\n\t\t\t\t\tmeta: { requestId } \r\n\t\t\t\t}, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst data = {\r\n\t\t\t\ttag_id: row.tag_id,\r\n\t\t\t\ttag_name: row.tag_name,\r\n\t\t\t\ttag_color: row.tag_color || null,\r\n\t\t\t\tcreated_at: row.created_at\r\n\t\t\t};\r\n\t\t\t\r\n\t\t\treturn jsonResponse(200, { \r\n\t\t\t\tok: true, \r\n\t\t\t\tcode: \"SUCCESS\", \r\n\t\t\t\tmessage: \"\u67E5\u8A62\u6210\u529F\", \r\n\t\t\t\tdata, \r\n\t\t\t\tmeta: { requestId } \r\n\t\t\t}, corsHeaders);\r\n\t\t\t\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\r\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, corsHeaders);\r\n\t\t}\r\n\t}\r\n\t\r\n\t// POST /api/v1/tags - \u65B0\u589E\u6A19\u7C64\r\n\tif (method === \"POST\") {\r\n\t\tlet body;\r\n\t\ttry {\r\n\t\t\tbody = await request.json();\r\n\t\t} catch (_) {\r\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\r\n\t\t}\r\n\t\t\r\n\t\tconst errors = [];\r\n\t\tconst tagName = String(body?.tag_name || \"\").trim();\r\n\t\tconst tagColor = String(body?.tag_color || \"\").trim();\r\n\t\t\r\n\t\t// \u9A57\u8B49\r\n\t\tif (!tagName || tagName.length < 1 || tagName.length > 50) {\r\n\t\t\terrors.push({ field: \"tag_name\", message: \"\u6A19\u7C64\u540D\u7A31\u70BA\u5FC5\u586B\uFF081-50\u5B57\uFF09\" });\r\n\t\t}\r\n\t\tif (tagColor && !/^#[0-9A-Fa-f]{6}$/.test(tagColor)) {\r\n\t\t\terrors.push({ field: \"tag_color\", message: \"\u984F\u8272\u78BC\u683C\u5F0F\u932F\u8AA4\uFF08\u9700\u70BA #RRGGBB\uFF09\" });\r\n\t\t}\r\n\t\tif (errors.length) {\r\n\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, corsHeaders);\r\n\t\t}\r\n\t\t\r\n\t\ttry {\r\n\t\t\t// \u6AA2\u67E5\u6A19\u7C64\u540D\u7A31\u552F\u4E00\u6027\r\n\t\t\tconst existing = await env.DATABASE.prepare(\"SELECT 1 FROM CustomerTags WHERE tag_name = ? LIMIT 1\").bind(tagName).first();\r\n\t\t\tif (existing) {\r\n\t\t\t\treturn jsonResponse(409, { ok: false, code: \"CONFLICT\", message: \"\u6A19\u7C64\u540D\u7A31\u5DF2\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst now = new Date().toISOString();\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\"INSERT INTO CustomerTags (tag_name, tag_color, created_at) VALUES (?, ?, ?)\"\r\n\t\t\t).bind(tagName, tagColor || null, now).run();\r\n\t\t\t\r\n\t\t\tconst idRow = await env.DATABASE.prepare(\"SELECT last_insert_rowid() AS id\").first();\r\n\t\t\tconst data = { tag_id: idRow?.id, tag_name: tagName, tag_color: tagColor || null, created_at: now };\r\n\t\t\t\r\n\t\t\treturn jsonResponse(201, { ok: true, code: \"CREATED\", message: \"\u5DF2\u5EFA\u7ACB\", data, meta: { requestId } }, corsHeaders);\r\n\t\t\t\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\r\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, corsHeaders);\r\n\t\t}\r\n\t}\r\n\t\r\n\t// PUT /api/v1/tags/:id - \u66F4\u65B0\u6A19\u7C64\r\n\tif (method === \"PUT\" && url.pathname.match(/\\/tags\\/\\d+$/)) {\r\n\t\tconst tagId = parseInt(url.pathname.split(\"/\").pop(), 10);\r\n\t\tlet body;\r\n\t\ttry {\r\n\t\t\tbody = await request.json();\r\n\t\t} catch (_) {\r\n\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8ACB\u6C42\u683C\u5F0F\u932F\u8AA4\", meta: { requestId } }, corsHeaders);\r\n\t\t}\r\n\t\t\r\n\t\tconst errors = [];\r\n\t\tconst tagName = body?.tag_name ? String(body.tag_name).trim() : null;\r\n\t\tconst tagColor = body?.tag_color ? String(body.tag_color).trim() : null;\r\n\t\t\r\n\t\t// \u9A57\u8B49\r\n\t\tif (tagName !== null && (tagName.length < 1 || tagName.length > 50)) {\r\n\t\t\terrors.push({ field: \"tag_name\", message: \"\u6A19\u7C64\u540D\u7A31\u9577\u5EA6\u9700\u70BA 1-50\u5B57\" });\r\n\t\t}\r\n\t\tif (tagColor !== null && tagColor !== \"\" && !/^#[0-9A-Fa-f]{6}$/.test(tagColor)) {\r\n\t\t\terrors.push({ field: \"tag_color\", message: \"\u984F\u8272\u78BC\u683C\u5F0F\u932F\u8AA4\uFF08\u9700\u70BA #RRGGBB\uFF09\" });\r\n\t\t}\r\n\t\tif (errors.length) {\r\n\t\t\treturn jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F38\u5165\u6709\u8AA4\", errors, meta: { requestId } }, corsHeaders);\r\n\t\t}\r\n\t\t\r\n\t\ttry {\r\n\t\t\t// \u6AA2\u67E5\u6A19\u7C64\u662F\u5426\u5B58\u5728\r\n\t\t\tconst existing = await env.DATABASE.prepare(\"SELECT 1 FROM CustomerTags WHERE tag_id = ? LIMIT 1\").bind(tagId).first();\r\n\t\t\tif (!existing) {\r\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6A19\u7C64\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// \u5982\u679C\u66F4\u65B0\u540D\u7A31\uFF0C\u6AA2\u67E5\u552F\u4E00\u6027\r\n\t\t\tif (tagName !== null) {\r\n\t\t\t\tconst dup = await env.DATABASE.prepare(\"SELECT 1 FROM CustomerTags WHERE tag_name = ? AND tag_id != ? LIMIT 1\").bind(tagName, tagId).first();\r\n\t\t\t\tif (dup) {\r\n\t\t\t\t\treturn jsonResponse(409, { ok: false, code: \"CONFLICT\", message: \"\u6A19\u7C64\u540D\u7A31\u5DF2\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// \u69CB\u5EFA\u66F4\u65B0\u8A9E\u53E5\r\n\t\t\tconst updates = [];\r\n\t\t\tconst binds = [];\r\n\t\t\tif (tagName !== null) {\r\n\t\t\t\tupdates.push(\"tag_name = ?\");\r\n\t\t\t\tbinds.push(tagName);\r\n\t\t\t}\r\n\t\t\tif (tagColor !== null) {\r\n\t\t\t\tupdates.push(\"tag_color = ?\");\r\n\t\t\t\tbinds.push(tagColor === \"\" ? null : tagColor);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (updates.length === 0) {\r\n\t\t\t\treturn jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u6C92\u6709\u53EF\u66F4\u65B0\u7684\u6B04\u4F4D\", meta: { requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tbinds.push(tagId);\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t`UPDATE CustomerTags SET ${updates.join(\", \")} WHERE tag_id = ?`\r\n\t\t\t).bind(...binds).run();\r\n\t\t\t\r\n\t\t\tconst data = { tag_id: tagId, tag_name: tagName, tag_color: tagColor };\r\n\t\t\treturn jsonResponse(200, { ok: true, code: \"SUCCESS\", message: \"\u5DF2\u66F4\u65B0\", data, meta: { requestId } }, corsHeaders);\r\n\t\t\t\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\r\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, corsHeaders);\r\n\t\t}\r\n\t}\r\n\t\r\n\t// DELETE /api/v1/tags/:id - \u522A\u9664\u6A19\u7C64\r\n\tif (method === \"DELETE\" && url.pathname.match(/\\/tags\\/\\d+$/)) {\r\n\t\tconst tagId = parseInt(url.pathname.split(\"/\").pop(), 10);\r\n\t\ttry {\r\n\t\t\t// \u6AA2\u67E5\u6A19\u7C64\u662F\u5426\u5B58\u5728\r\n\t\t\tconst existing = await env.DATABASE.prepare(\"SELECT 1 FROM CustomerTags WHERE tag_id = ? LIMIT 1\").bind(tagId).first();\r\n\t\t\tif (!existing) {\r\n\t\t\t\treturn jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6A19\u7C64\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// \u6AA2\u67E5\u662F\u5426\u6709\u5BA2\u6236\u4F7F\u7528\u6B64\u6A19\u7C64\r\n\t\t\tconst usage = await env.DATABASE.prepare(\"SELECT COUNT(1) as cnt FROM ClientTagAssignments WHERE tag_id = ?\").bind(tagId).first();\r\n\t\t\tif (Number(usage?.cnt || 0) > 0) {\r\n\t\t\t\treturn jsonResponse(409, { \r\n\t\t\t\t\tok: false, \r\n\t\t\t\t\tcode: \"CONFLICT\", \r\n\t\t\t\t\tmessage: `\u6B64\u6A19\u7C64\u6B63\u88AB ${usage.cnt} \u500B\u5BA2\u6236\u4F7F\u7528\uFF0C\u7121\u6CD5\u522A\u9664`, \r\n\t\t\t\t\tmeta: { requestId } \r\n\t\t\t\t}, corsHeaders);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// \u522A\u9664\u6A19\u7C64\r\n\t\t\tawait env.DATABASE.prepare(\"DELETE FROM CustomerTags WHERE tag_id = ?\").bind(tagId).run();\r\n\t\t\t\r\n\t\t\treturn jsonResponse(200, { ok: true, code: \"SUCCESS\", message: \"\u5DF2\u522A\u9664\", meta: { requestId } }, corsHeaders);\r\n\t\t\t\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ level: \"error\", requestId, path: url.pathname, err: String(err) }));\r\n\t\t\tconst body = { ok: false, code: \"INTERNAL_ERROR\", message: \"\u4F3A\u670D\u5668\u932F\u8AA4\", meta: { requestId } };\r\n\t\t\tif (env.APP_ENV && env.APP_ENV !== \"prod\") body.error = String(err);\r\n\t\t\treturn jsonResponse(500, body, corsHeaders);\r\n\t\t}\r\n\t}\r\n\t\r\n\treturn jsonResponse(405, { ok: false, code: \"METHOD_NOT_ALLOWED\", message: \"\u65B9\u6CD5\u4E0D\u5141\u8A31\", meta: { requestId } }, corsHeaders);\r\n}\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nfunction parseId(s) {\r\n  const n = parseInt(String(s || \"\"), 10);\r\n  return Number.isFinite(n) && n > 0 ? n : null;\r\n}\r\n\r\nexport async function handleBilling(request, env, me, requestId, url, path) {\r\n  const corsHeaders = getCorsHeadersForRequest(request, env);\r\n  const method = request.method.toUpperCase();\r\n\r\n  // GET /internal/api/v1/billing/service/:serviceId - \u83B7\u53D6\u670D\u52A1\u7684\u6536\u8D39\u660E\u7EC6\r\n  const matchGet = path.match(/^\\/internal\\/api\\/v1\\/billing\\/service\\/(\\d+)$/);\r\n  if (method === \"GET\" && matchGet) {\r\n    const clientServiceId = parseId(matchGet[1]);\r\n    if (!clientServiceId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u670D\u52A1ID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u670D\u52A1\u662F\u5426\u5B58\u5728\u4E14\u6709\u6743\u9650\u8BBF\u95EE\r\n      const service = await env.DATABASE.prepare(\r\n        `SELECT cs.client_service_id, cs.client_id, c.assignee_user_id\r\n         FROM ClientServices cs\r\n         LEFT JOIN Clients c ON c.client_id = cs.client_id\r\n         WHERE cs.client_service_id = ? AND cs.is_deleted = 0`\r\n      ).bind(clientServiceId).first();\r\n\r\n      if (!service) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u670D\u52A1\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u6743\u9650\u68C0\u67E5\uFF1A\u7BA1\u7406\u5458\u6216\u8D1F\u8D23\u4EBA\u53EF\u67E5\u770B\r\n      if (!me.is_admin && service.assignee_user_id !== me.user_id) {\r\n        return jsonResponse(403, { ok: false, code: \"FORBIDDEN\", message: \"\u65E0\u6743\u9650\u8BBF\u95EE\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u83B7\u53D6\u6536\u8D39\u660E\u7EC6\r\n      const rows = await env.DATABASE.prepare(\r\n        `SELECT schedule_id, billing_month, billing_amount, payment_due_days, notes, created_at, updated_at\r\n         FROM ServiceBillingSchedule\r\n         WHERE client_service_id = ?\r\n         ORDER BY billing_month ASC`\r\n      ).bind(clientServiceId).all();\r\n\r\n      const data = (rows?.results || []).map(r => ({\r\n        schedule_id: r.schedule_id,\r\n        billing_month: r.billing_month,\r\n        billing_amount: Number(r.billing_amount || 0),\r\n        payment_due_days: Number(r.payment_due_days || 30),\r\n        notes: r.notes || \"\",\r\n        created_at: r.created_at,\r\n        updated_at: r.updated_at\r\n      }));\r\n\r\n      // \u8BA1\u7B97\u5E74\u5EA6\u603B\u989D\r\n      const yearTotal = data.reduce((sum, item) => sum + item.billing_amount, 0);\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u67E5\u8BE2\u6210\u529F\",\r\n        data: {\r\n          schedules: data,\r\n          year_total: yearTotal\r\n        },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // POST /internal/api/v1/billing/service/:serviceId - \u65B0\u589E\u6536\u8D39\u660E\u7EC6\r\n  if (method === \"POST\" && matchGet) {\r\n    const clientServiceId = parseId(matchGet[1]);\r\n    if (!clientServiceId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u670D\u52A1ID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch (_) {\r\n      return jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    const errors = [];\r\n    const billingMonth = parseInt(body?.billing_month, 10);\r\n    const billingAmount = parseFloat(body?.billing_amount);\r\n    const paymentDueDays = parseInt(body?.payment_due_days || 30, 10);\r\n    const notes = String(body?.notes || \"\").trim();\r\n\r\n    // \u9A8C\u8BC1\r\n    if (!Number.isInteger(billingMonth) || billingMonth < 1 || billingMonth > 12) {\r\n      errors.push({ field: \"billing_month\", message: \"\u6708\u4EFD\u5FC5\u987B\u57281-12\u4E4B\u95F4\" });\r\n    }\r\n    if (isNaN(billingAmount) || billingAmount < 0) {\r\n      errors.push({ field: \"billing_amount\", message: \"\u91D1\u989D\u5FC5\u987B\u4E3A\u975E\u8D1F\u6570\" });\r\n    }\r\n    if (!Number.isInteger(paymentDueDays) || paymentDueDays < 1) {\r\n      errors.push({ field: \"payment_due_days\", message: \"\u6536\u6B3E\u671F\u9650\u5FC5\u987B\u5927\u4E8E0\" });\r\n    }\r\n\r\n    if (errors.length) {\r\n      return jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F93\u5165\u6709\u8BEF\", errors, meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u670D\u52A1\u662F\u5426\u5B58\u5728\r\n      const service = await env.DATABASE.prepare(\r\n        \"SELECT client_service_id FROM ClientServices WHERE client_service_id = ? AND is_deleted = 0\"\r\n      ).bind(clientServiceId).first();\r\n\r\n      if (!service) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u670D\u52A1\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u68C0\u67E5\u8BE5\u6708\u4EFD\u662F\u5426\u5DF2\u5B58\u5728\r\n      const existing = await env.DATABASE.prepare(\r\n        \"SELECT schedule_id FROM ServiceBillingSchedule WHERE client_service_id = ? AND billing_month = ?\"\r\n      ).bind(clientServiceId, billingMonth).first();\r\n\r\n      if (existing) {\r\n        return jsonResponse(422, {\r\n          ok: false,\r\n          code: \"DUPLICATE\",\r\n          message: \"\u8BE5\u6708\u4EFD\u5DF2\u8BBE\u5B9A\u6536\u8D39\",\r\n          errors: [{ field: \"billing_month\", message: \"\u8BE5\u6708\u4EFD\u5DF2\u5B58\u5728\" }],\r\n          meta: { requestId }\r\n        }, corsHeaders);\r\n      }\r\n\r\n      // \u63D2\u5165\u6536\u8D39\u660E\u7EC6\r\n      const result = await env.DATABASE.prepare(\r\n        `INSERT INTO ServiceBillingSchedule (client_service_id, billing_month, billing_amount, payment_due_days, notes)\r\n         VALUES (?, ?, ?, ?, ?)`\r\n      ).bind(clientServiceId, billingMonth, billingAmount, paymentDueDays, notes).run();\r\n\r\n      const scheduleId = result?.meta?.last_row_id;\r\n\r\n      return jsonResponse(201, {\r\n        ok: true,\r\n        code: \"CREATED\",\r\n        message: \"\u6536\u8D39\u660E\u7EC6\u5DF2\u65B0\u589E\",\r\n        data: { schedule_id: scheduleId },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // PUT /internal/api/v1/billing/:scheduleId - \u66F4\u65B0\u6536\u8D39\u660E\u7EC6\r\n  const matchUpdate = path.match(/^\\/internal\\/api\\/v1\\/billing\\/(\\d+)$/);\r\n  if (method === \"PUT\" && matchUpdate) {\r\n    const scheduleId = parseId(matchUpdate[1]);\r\n    if (!scheduleId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u660E\u7EC6ID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch (_) {\r\n      return jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    const errors = [];\r\n    const billingAmount = parseFloat(body?.billing_amount);\r\n    const paymentDueDays = parseInt(body?.payment_due_days || 30, 10);\r\n    const notes = String(body?.notes || \"\").trim();\r\n\r\n    // \u9A8C\u8BC1\r\n    if (isNaN(billingAmount) || billingAmount < 0) {\r\n      errors.push({ field: \"billing_amount\", message: \"\u91D1\u989D\u5FC5\u987B\u4E3A\u975E\u8D1F\u6570\" });\r\n    }\r\n    if (!Number.isInteger(paymentDueDays) || paymentDueDays < 1) {\r\n      errors.push({ field: \"payment_due_days\", message: \"\u6536\u6B3E\u671F\u9650\u5FC5\u987B\u5927\u4E8E0\" });\r\n    }\r\n\r\n    if (errors.length) {\r\n      return jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F93\u5165\u6709\u8BEF\", errors, meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u660E\u7EC6\u662F\u5426\u5B58\u5728\r\n      const existing = await env.DATABASE.prepare(\r\n        \"SELECT schedule_id FROM ServiceBillingSchedule WHERE schedule_id = ?\"\r\n      ).bind(scheduleId).first();\r\n\r\n      if (!existing) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6536\u8D39\u660E\u7EC6\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u66F4\u65B0\u6536\u8D39\u660E\u7EC6\r\n      await env.DATABASE.prepare(\r\n        `UPDATE ServiceBillingSchedule \r\n         SET billing_amount = ?, payment_due_days = ?, notes = ?, updated_at = datetime('now')\r\n         WHERE schedule_id = ?`\r\n      ).bind(billingAmount, paymentDueDays, notes, scheduleId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u6536\u8D39\u660E\u7EC6\u5DF2\u66F4\u65B0\",\r\n        data: { schedule_id: scheduleId },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // DELETE /internal/api/v1/billing/:scheduleId - \u5220\u9664\u6536\u8D39\u660E\u7EC6\r\n  if (method === \"DELETE\" && matchUpdate) {\r\n    const scheduleId = parseId(matchUpdate[1]);\r\n    if (!scheduleId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u660E\u7EC6ID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u660E\u7EC6\u662F\u5426\u5B58\u5728\r\n      const existing = await env.DATABASE.prepare(\r\n        \"SELECT schedule_id FROM ServiceBillingSchedule WHERE schedule_id = ?\"\r\n      ).bind(scheduleId).first();\r\n\r\n      if (!existing) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6536\u8D39\u660E\u7EC6\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u5220\u9664\u6536\u8D39\u660E\u7EC6\r\n      await env.DATABASE.prepare(\r\n        \"DELETE FROM ServiceBillingSchedule WHERE schedule_id = ?\"\r\n      ).bind(scheduleId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u6536\u8D39\u660E\u7EC6\u5DF2\u5220\u9664\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u8DEF\u7531\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n}\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nfunction parseId(s) {\r\n  const n = parseInt(String(s || \"\"), 10);\r\n  return Number.isFinite(n) && n > 0 ? n : null;\r\n}\r\n\r\nexport async function handleTaskTemplates(request, env, me, requestId, url, path) {\r\n  const corsHeaders = getCorsHeadersForRequest(request, env);\r\n  const method = request.method.toUpperCase();\r\n\r\n  // GET /internal/api/v1/task-templates - \u83B7\u53D6\u4EFB\u52A1\u6A21\u677F\u5217\u8868\r\n  if (method === \"GET\" && path === \"/internal/api/v1/task-templates\") {\r\n    const serviceId = url.searchParams.get(\"service_id\");\r\n    const clientId = url.searchParams.get(\"client_id\");\r\n\r\n    try {\r\n      let query = `\r\n        SELECT tt.template_id, tt.template_name, tt.service_id, tt.client_id, tt.description, \r\n               tt.sop_id, tt.is_active, tt.created_at,\r\n               s.service_name, s.service_code,\r\n               c.company_name as client_name,\r\n               (SELECT COUNT(*) FROM TaskTemplateStages WHERE template_id = tt.template_id) as stages_count\r\n        FROM TaskTemplates tt\r\n        LEFT JOIN Services s ON s.service_id = tt.service_id\r\n        LEFT JOIN Clients c ON c.client_id = tt.client_id\r\n        WHERE 1=1\r\n      `;\r\n      const params = [];\r\n\r\n      if (serviceId) {\r\n        query += ` AND tt.service_id = ?`;\r\n        params.push(parseInt(serviceId, 10));\r\n      }\r\n\r\n      if (clientId) {\r\n        if (clientId === 'null') {\r\n          query += ` AND tt.client_id IS NULL`;\r\n        } else {\r\n          query += ` AND tt.client_id = ?`;\r\n          params.push(parseInt(clientId, 10));\r\n        }\r\n      }\r\n\r\n      query += ` ORDER BY tt.template_name ASC`;\r\n\r\n      const stmt = params.length > 0 \r\n        ? env.DATABASE.prepare(query).bind(...params)\r\n        : env.DATABASE.prepare(query);\r\n\r\n      const rows = await stmt.all();\r\n\r\n      const data = (rows?.results || []).map(r => ({\r\n        template_id: r.template_id,\r\n        template_name: r.template_name || \"\",\r\n        service_id: r.service_id || null,\r\n        service_name: r.service_name || \"\",\r\n        service_code: r.service_code || \"\",\r\n        client_id: r.client_id || null,\r\n        client_name: r.client_name || \"\",\r\n        description: r.description || \"\",\r\n        sop_id: r.sop_id || null,\r\n        is_active: Boolean(r.is_active),\r\n        created_at: r.created_at,\r\n        stages_count: r.stages_count || 0\r\n      }));\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u67E5\u8BE2\u6210\u529F\",\r\n        data: data,\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // GET /internal/api/v1/task-templates/:id - \u83B7\u53D6\u4EFB\u52A1\u6A21\u677F\u8BE6\u60C5\uFF08\u542B\u9636\u6BB5\uFF09\r\n  const matchGet = path.match(/^\\/internal\\/api\\/v1\\/task-templates\\/(\\d+)$/);\r\n  if (method === \"GET\" && matchGet) {\r\n    const templateId = parseId(matchGet[1]);\r\n    if (!templateId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u6A21\u677FID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u83B7\u53D6\u6A21\u677F\u57FA\u672C\u4FE1\u606F\r\n      const template = await env.DATABASE.prepare(\r\n        `SELECT tt.template_id, tt.template_name, tt.service_id, tt.description, \r\n                tt.sop_id, tt.is_active, tt.created_at,\r\n                s.service_name, s.service_code\r\n         FROM TaskTemplates tt\r\n         LEFT JOIN Services s ON s.service_id = tt.service_id\r\n         WHERE tt.template_id = ?`\r\n      ).bind(templateId).first();\r\n\r\n      if (!template) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6A21\u677F\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u83B7\u53D6\u9636\u6BB5\u5217\u8868\r\n      const stagesRows = await env.DATABASE.prepare(\r\n        `SELECT stage_id, stage_name, stage_order, description, estimated_hours\r\n         FROM TaskTemplateStages\r\n         WHERE template_id = ?\r\n         ORDER BY stage_order ASC`\r\n      ).bind(templateId).all();\r\n\r\n      const stages = (stagesRows?.results || []).map(s => ({\r\n        stage_id: s.stage_id,\r\n        stage_name: s.stage_name || \"\",\r\n        stage_order: s.stage_order,\r\n        description: s.description || \"\",\r\n        estimated_hours: Number(s.estimated_hours || 0)\r\n      }));\r\n\r\n      const data = {\r\n        template_id: template.template_id,\r\n        template_name: template.template_name || \"\",\r\n        service_id: template.service_id || null,\r\n        service_name: template.service_name || \"\",\r\n        service_code: template.service_code || \"\",\r\n        description: template.description || \"\",\r\n        sop_id: template.sop_id || null,\r\n        is_active: Boolean(template.is_active),\r\n        created_at: template.created_at,\r\n        stages: stages\r\n      };\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u67E5\u8BE2\u6210\u529F\",\r\n        data: data,\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // POST /internal/api/v1/task-templates - \u521B\u5EFA\u4EFB\u52A1\u6A21\u677F\r\n  if (method === \"POST\" && path === \"/internal/api/v1/task-templates\") {\r\n    // \u4EC5\u7BA1\u7406\u5458\u53EF\u521B\u5EFA\u6A21\u677F\r\n    if (!me.is_admin) {\r\n      return jsonResponse(403, { ok: false, code: \"FORBIDDEN\", message: \"\u4EC5\u7BA1\u7406\u5458\u53EF\u521B\u5EFA\u6A21\u677F\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch (_) {\r\n      return jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    const errors = [];\r\n    const templateName = String(body?.template_name || \"\").trim();\r\n    const serviceId = body?.service_id ? parseInt(body.service_id, 10) : null;\r\n    const clientId = body?.client_id ? parseInt(body.client_id, 10) : null;\r\n    const description = String(body?.description || \"\").trim();\r\n    const sopId = body?.sop_id ? parseInt(body.sop_id, 10) : null;\r\n    const stages = Array.isArray(body?.stages) ? body.stages : [];\r\n\r\n    // \u9A8C\u8BC1\r\n    if (!templateName) {\r\n      errors.push({ field: \"template_name\", message: \"\u8BF7\u8F93\u5165\u6A21\u677F\u540D\u79F0\" });\r\n    }\r\n\r\n    if (errors.length) {\r\n      return jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F93\u5165\u6709\u8BEF\", errors, meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u63D2\u5165\u6A21\u677F\r\n      const result = await env.DATABASE.prepare(\r\n        `INSERT INTO TaskTemplates (template_name, service_id, client_id, description, sop_id, is_active)\r\n         VALUES (?, ?, ?, ?, ?, 1)`\r\n      ).bind(templateName, serviceId, clientId, description, sopId).run();\r\n\r\n      const templateId = result?.meta?.last_row_id;\r\n\r\n      // \u63D2\u5165\u9636\u6BB5\uFF08\u5982\u679C\u6709\uFF09\r\n      if (stages.length > 0) {\r\n        for (let i = 0; i < stages.length; i++) {\r\n          const stage = stages[i];\r\n          const stageName = String(stage?.stage_name || \"\").trim();\r\n          const stageDesc = String(stage?.description || \"\").trim();\r\n          const estimatedHours = parseFloat(stage?.estimated_hours || 0);\r\n\r\n          if (stageName) {\r\n            await env.DATABASE.prepare(\r\n              `INSERT INTO TaskTemplateStages (template_id, stage_name, stage_order, description, estimated_hours)\r\n               VALUES (?, ?, ?, ?, ?)`\r\n            ).bind(templateId, stageName, i + 1, stageDesc, estimatedHours).run();\r\n          }\r\n        }\r\n      }\r\n\r\n      return jsonResponse(201, {\r\n        ok: true,\r\n        code: \"CREATED\",\r\n        message: \"\u6A21\u677F\u5DF2\u521B\u5EFA\",\r\n        data: { template_id: templateId },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // PUT /internal/api/v1/task-templates/:id - \u66F4\u65B0\u4EFB\u52A1\u6A21\u677F\r\n  const matchUpdate = path.match(/^\\/internal\\/api\\/v1\\/task-templates\\/(\\d+)$/);\r\n  if (method === \"PUT\" && matchUpdate) {\r\n    const templateId = parseId(matchUpdate[1]);\r\n    if (!templateId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u6A21\u677FID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    // \u4EC5\u7BA1\u7406\u5458\u53EF\u66F4\u65B0\u6A21\u677F\r\n    if (!me.is_admin) {\r\n      return jsonResponse(403, { ok: false, code: \"FORBIDDEN\", message: \"\u4EC5\u7BA1\u7406\u5458\u53EF\u66F4\u65B0\u6A21\u677F\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch (_) {\r\n      return jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    const errors = [];\r\n    const templateName = String(body?.template_name || \"\").trim();\r\n    const serviceId = body?.service_id ? parseInt(body.service_id, 10) : null;\r\n    const description = String(body?.description || \"\").trim();\r\n    const sopId = body?.sop_id ? parseInt(body.sop_id, 10) : null;\r\n    const isActive = body?.is_active !== false; // \u9ED8\u8BA4true\r\n    const stages = Array.isArray(body?.stages) ? body.stages : null; // null\u8868\u793A\u4E0D\u66F4\u65B0\u9636\u6BB5\r\n\r\n    // \u9A8C\u8BC1\r\n    if (!templateName) {\r\n      errors.push({ field: \"template_name\", message: \"\u8BF7\u8F93\u5165\u6A21\u677F\u540D\u79F0\" });\r\n    }\r\n\r\n    if (errors.length) {\r\n      return jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F93\u5165\u6709\u8BEF\", errors, meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u6A21\u677F\u662F\u5426\u5B58\u5728\r\n      const existing = await env.DATABASE.prepare(\r\n        \"SELECT template_id FROM TaskTemplates WHERE template_id = ?\"\r\n      ).bind(templateId).first();\r\n\r\n      if (!existing) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6A21\u677F\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u66F4\u65B0\u6A21\u677F\u57FA\u672C\u4FE1\u606F\r\n      await env.DATABASE.prepare(\r\n        `UPDATE TaskTemplates \r\n         SET template_name = ?, service_id = ?, description = ?, sop_id = ?, is_active = ?\r\n         WHERE template_id = ?`\r\n      ).bind(templateName, serviceId, description, sopId, isActive ? 1 : 0, templateId).run();\r\n\r\n      // \u66F4\u65B0\u9636\u6BB5\uFF08\u5982\u679C\u63D0\u4F9B\u4E86stages\u6570\u7EC4\uFF09\r\n      if (stages !== null) {\r\n        // \u5220\u9664\u73B0\u6709\u9636\u6BB5\r\n        await env.DATABASE.prepare(\r\n          \"DELETE FROM TaskTemplateStages WHERE template_id = ?\"\r\n        ).bind(templateId).run();\r\n\r\n        // \u63D2\u5165\u65B0\u9636\u6BB5\r\n        for (let i = 0; i < stages.length; i++) {\r\n          const stage = stages[i];\r\n          const stageName = String(stage?.stage_name || \"\").trim();\r\n          const stageDesc = String(stage?.description || \"\").trim();\r\n          const estimatedHours = parseFloat(stage?.estimated_hours || 0);\r\n\r\n          if (stageName) {\r\n            await env.DATABASE.prepare(\r\n              `INSERT INTO TaskTemplateStages (template_id, stage_name, stage_order, description, estimated_hours)\r\n               VALUES (?, ?, ?, ?, ?)`\r\n            ).bind(templateId, stageName, i + 1, stageDesc, estimatedHours).run();\r\n          }\r\n        }\r\n      }\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u6A21\u677F\u5DF2\u66F4\u65B0\",\r\n        data: { template_id: templateId },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // DELETE /internal/api/v1/task-templates/:id - \u5220\u9664\u4EFB\u52A1\u6A21\u677F\r\n  if (method === \"DELETE\" && matchUpdate) {\r\n    const templateId = parseId(matchUpdate[1]);\r\n    if (!templateId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u6A21\u677FID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    // \u4EC5\u7BA1\u7406\u5458\u53EF\u5220\u9664\u6A21\u677F\r\n    if (!me.is_admin) {\r\n      return jsonResponse(403, { ok: false, code: \"FORBIDDEN\", message: \"\u4EC5\u7BA1\u7406\u5458\u53EF\u5220\u9664\u6A21\u677F\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u6A21\u677F\u662F\u5426\u5B58\u5728\r\n      const existing = await env.DATABASE.prepare(\r\n        \"SELECT template_id FROM TaskTemplates WHERE template_id = ?\"\r\n      ).bind(templateId).first();\r\n\r\n      if (!existing) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6A21\u677F\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u68C0\u67E5\u662F\u5426\u6709\u5BA2\u6237\u670D\u52A1\u6B63\u5728\u4F7F\u7528\u6B64\u6A21\u677F\r\n      const inUse = await env.DATABASE.prepare(\r\n        \"SELECT client_service_id FROM ClientServices WHERE task_template_id = ? AND is_deleted = 0 LIMIT 1\"\r\n      ).bind(templateId).first();\r\n\r\n      if (inUse) {\r\n        return jsonResponse(422, {\r\n          ok: false,\r\n          code: \"IN_USE\",\r\n          message: \"\u8BE5\u6A21\u677F\u6B63\u5728\u88AB\u4F7F\u7528\uFF0C\u65E0\u6CD5\u5220\u9664\",\r\n          meta: { requestId }\r\n        }, corsHeaders);\r\n      }\r\n\r\n      // \u5220\u9664\u9636\u6BB5\r\n      await env.DATABASE.prepare(\r\n        \"DELETE FROM TaskTemplateStages WHERE template_id = ?\"\r\n      ).bind(templateId).run();\r\n\r\n      // \u5220\u9664\u6A21\u677F\r\n      await env.DATABASE.prepare(\r\n        \"DELETE FROM TaskTemplates WHERE template_id = ?\"\r\n      ).bind(templateId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u6A21\u677F\u5DF2\u5220\u9664\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // GET /internal/api/v1/task-templates/:id/stages - \u83B7\u53D6\u6A21\u677F\u7684\u9636\u6BB5\u5217\u8868\r\n  const matchStages = path.match(/^\\/internal\\/api\\/v1\\/task-templates\\/(\\d+)\\/stages$/);\r\n  if (method === \"GET\" && matchStages) {\r\n    const templateId = parseId(matchStages[1]);\r\n    if (!templateId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u6A21\u677FID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      const stagesRows = await env.DATABASE.prepare(\r\n        `SELECT tts.stage_id, tts.stage_name, tts.stage_order, tts.description, \r\n                tts.estimated_hours, tts.dependencies, tts.sop_id, tts.attachment_id,\r\n                sop.title as sop_title,\r\n                att.original_filename as attachment_name, att.file_url as attachment_url\r\n         FROM TaskTemplateStages tts\r\n         LEFT JOIN SOPDocuments sop ON sop.sop_id = tts.sop_id\r\n         LEFT JOIN Attachments att ON att.attachment_id = tts.attachment_id\r\n         WHERE tts.template_id = ?\r\n         ORDER BY tts.stage_order ASC`\r\n      ).bind(templateId).all();\r\n\r\n      const stages = (stagesRows?.results || []).map(s => ({\r\n        stage_id: s.stage_id,\r\n        stage_name: s.stage_name || \"\",\r\n        stage_order: s.stage_order,\r\n        description: s.description || \"\",\r\n        estimated_hours: Number(s.estimated_hours || 0),\r\n        dependencies: s.dependencies || \"\",\r\n        sop_id: s.sop_id || null,\r\n        sop_title: s.sop_title || \"\",\r\n        attachment_id: s.attachment_id || null,\r\n        attachment_name: s.attachment_name || \"\",\r\n        attachment_url: s.attachment_url || \"\"\r\n      }));\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u67E5\u8BE2\u6210\u529F\",\r\n        data: stages,\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // POST /internal/api/v1/task-templates/:id/stages - \u4E3A\u6A21\u677F\u6DFB\u52A0\u9636\u6BB5\r\n  if (method === \"POST\" && matchStages) {\r\n    const templateId = parseId(matchStages[1]);\r\n    if (!templateId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"\u6A21\u677FID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    // \u4EC5\u7BA1\u7406\u5458\u53EF\u6DFB\u52A0\u9636\u6BB5\r\n    if (!me.is_admin) {\r\n      return jsonResponse(403, { ok: false, code: \"FORBIDDEN\", message: \"\u4EC5\u7BA1\u7406\u5458\u53EF\u6DFB\u52A0\u9636\u6BB5\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch (_) {\r\n      return jsonResponse(400, { ok: false, code: \"BAD_REQUEST\", message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    const errors = [];\r\n    const stageName = String(body?.stage_name || \"\").trim();\r\n    const stageOrder = body?.stage_order ? parseInt(body.stage_order, 10) : null;\r\n    const description = String(body?.description || \"\").trim();\r\n    const estimatedHours = body?.estimated_hours ? parseFloat(body.estimated_hours) : null;\r\n    const dependencies = String(body?.dependencies || \"\").trim();\r\n    const sopId = body?.sop_id ? parseInt(body.sop_id, 10) : null;\r\n    const attachmentId = body?.attachment_id ? parseInt(body.attachment_id, 10) : null;\r\n\r\n    // \u9A8C\u8BC1\r\n    if (!stageName) {\r\n      errors.push({ field: \"stage_name\", message: \"\u8BF7\u8F93\u5165\u4EFB\u52A1\u540D\u79F0\" });\r\n    }\r\n    if (!stageOrder || stageOrder < 1) {\r\n      errors.push({ field: \"stage_order\", message: \"\u8BF7\u8F93\u5165\u6709\u6548\u7684\u987A\u5E8F\" });\r\n    }\r\n\r\n    if (errors.length) {\r\n      return jsonResponse(422, { ok: false, code: \"VALIDATION_ERROR\", message: \"\u8F93\u5165\u6709\u8BEF\", errors, meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u6A21\u677F\u662F\u5426\u5B58\u5728\r\n      const template = await env.DATABASE.prepare(\r\n        \"SELECT template_id FROM TaskTemplates WHERE template_id = ?\"\r\n      ).bind(templateId).first();\r\n\r\n      if (!template) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u6A21\u677F\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u63D2\u5165\u9636\u6BB5\r\n      const result = await env.DATABASE.prepare(\r\n        `INSERT INTO TaskTemplateStages (template_id, stage_name, stage_order, description, estimated_hours, dependencies, sop_id, attachment_id)\r\n         VALUES (?, ?, ?, ?, ?, ?, ?, ?)`\r\n      ).bind(templateId, stageName, stageOrder, description, estimatedHours, dependencies, sopId, attachmentId).run();\r\n\r\n      return jsonResponse(201, {\r\n        ok: true,\r\n        code: \"CREATED\",\r\n        message: \"\u4EFB\u52A1\u5DF2\u6DFB\u52A0\",\r\n        data: { stage_id: result?.meta?.last_row_id },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // DELETE /internal/api/v1/task-templates/:templateId/stages/:stageId - \u5220\u9664\u9636\u6BB5\r\n  const matchDeleteStage = path.match(/^\\/internal\\/api\\/v1\\/task-templates\\/(\\d+)\\/stages\\/(\\d+)$/);\r\n  if (method === \"DELETE\" && matchDeleteStage) {\r\n    const templateId = parseId(matchDeleteStage[1]);\r\n    const stageId = parseId(matchDeleteStage[2]);\r\n    \r\n    if (!templateId || !stageId) {\r\n      return jsonResponse(400, { ok: false, code: \"INVALID_ID\", message: \"ID\u65E0\u6548\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    // \u4EC5\u7BA1\u7406\u5458\u53EF\u5220\u9664\u9636\u6BB5\r\n    if (!me.is_admin) {\r\n      return jsonResponse(403, { ok: false, code: \"FORBIDDEN\", message: \"\u4EC5\u7BA1\u7406\u5458\u53EF\u5220\u9664\u9636\u6BB5\", meta: { requestId } }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      // \u68C0\u67E5\u9636\u6BB5\u662F\u5426\u5B58\u5728\r\n      const stage = await env.DATABASE.prepare(\r\n        \"SELECT stage_id FROM TaskTemplateStages WHERE template_id = ? AND stage_id = ?\"\r\n      ).bind(templateId, stageId).first();\r\n\r\n      if (!stage) {\r\n        return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u4EFB\u52A1\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n      }\r\n\r\n      // \u5220\u9664\u9636\u6BB5\r\n      await env.DATABASE.prepare(\r\n        \"DELETE FROM TaskTemplateStages WHERE template_id = ? AND stage_id = ?\"\r\n      ).bind(templateId, stageId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"OK\",\r\n        message: \"\u4EFB\u52A1\u5DF2\u5220\u9664\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, { ok: false, code: \"INTERNAL_ERROR\", message: \"\u670D\u52A1\u5668\u9519\u8BEF\", meta: { requestId } }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  return jsonResponse(404, { ok: false, code: \"NOT_FOUND\", message: \"\u8DEF\u7531\u4E0D\u5B58\u5728\", meta: { requestId } }, corsHeaders);\r\n}\r\n\r\n", "import { jsonResponse, getCorsHeadersForRequest } from \"../utils.js\";\r\n\r\nfunction parseId(s) {\r\n  const n = parseInt(String(s || \"\"), 10);\r\n  return Number.isFinite(n) && n > 0 ? n : null;\r\n}\r\n\r\nexport async function handleServices(request, env, me, requestId, url, path) {\r\n  const corsHeaders = getCorsHeadersForRequest(request, env);\r\n  const method = request.method.toUpperCase();\r\n\r\n  // ========================================\r\n  // \u670D\u52A1\u9879\u76EE\uFF08Services\uFF09\u7BA1\u7406\r\n  // ========================================\r\n\r\n  // GET /internal/api/v1/services - \u83B7\u53D6\u6240\u6709\u670D\u52A1\u9879\u76EE\r\n  if (method === \"GET\" && path === \"/internal/api/v1/services\") {\r\n    try {\r\n      const rows = await env.DATABASE.prepare(`\r\n        SELECT service_id, service_name, service_code, description, \r\n               is_active, sort_order, created_at, updated_at\r\n        FROM Services\r\n        WHERE is_active = 1\r\n        ORDER BY sort_order ASC, service_id ASC\r\n      `).all();\r\n\r\n      const data = (rows?.results || []).map(r => ({\r\n        service_id: r.service_id,\r\n        service_name: r.service_name || \"\",\r\n        service_code: r.service_code || \"\",\r\n        description: r.description || \"\",\r\n        is_active: Boolean(r.is_active),\r\n        sort_order: r.sort_order || 0,\r\n        created_at: r.created_at,\r\n        updated_at: r.updated_at\r\n      }));\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"SUCCESS\",\r\n        message: \"\u67E5\u8BE2\u6210\u529F\",\r\n        data,\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u670D\u52A1\u5668\u9519\u8BEF\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // POST /internal/api/v1/services - \u521B\u5EFA\u670D\u52A1\u9879\u76EE\r\n  if (method === \"POST\" && path === \"/internal/api/v1/services\") {\r\n    if (!me?.is_admin) {\r\n      return jsonResponse(403, {\r\n        ok: false,\r\n        code: \"FORBIDDEN\",\r\n        message: \"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const serviceName = String(body?.service_name || \"\").trim();\r\n    const serviceCode = String(body?.service_code || \"\").trim();\r\n    const description = String(body?.description || \"\").trim();\r\n    const sortOrder = parseInt(body?.sort_order || \"0\", 10);\r\n\r\n    if (!serviceName) {\r\n      return jsonResponse(422, {\r\n        ok: false,\r\n        code: \"VALIDATION_ERROR\",\r\n        message: \"\u670D\u52A1\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      const result = await env.DATABASE.prepare(`\r\n        INSERT INTO Services (service_name, service_code, description, sort_order, is_active)\r\n        VALUES (?, ?, ?, ?, 1)\r\n      `).bind(serviceName, serviceCode || null, description || null, sortOrder).run();\r\n\r\n      return jsonResponse(201, {\r\n        ok: true,\r\n        code: \"CREATED\",\r\n        message: \"\u521B\u5EFA\u6210\u529F\",\r\n        data: { service_id: result.meta.last_row_id },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u521B\u5EFA\u5931\u8D25\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // PUT /internal/api/v1/services/:id - \u66F4\u65B0\u670D\u52A1\u9879\u76EE\r\n  const matchUpdate = path.match(/^\\/internal\\/api\\/v1\\/services\\/(\\d+)$/);\r\n  if (method === \"PUT\" && matchUpdate) {\r\n    if (!me?.is_admin) {\r\n      return jsonResponse(403, {\r\n        ok: false,\r\n        code: \"FORBIDDEN\",\r\n        message: \"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const serviceId = parseId(matchUpdate[1]);\r\n    if (!serviceId) {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u65E0\u6548\u7684\u670D\u52A1ID\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const serviceName = String(body?.service_name || \"\").trim();\r\n    const serviceCode = String(body?.service_code || \"\").trim();\r\n    const description = String(body?.description || \"\").trim();\r\n    const sortOrder = parseInt(body?.sort_order || \"0\", 10);\r\n\r\n    if (!serviceName) {\r\n      return jsonResponse(422, {\r\n        ok: false,\r\n        code: \"VALIDATION_ERROR\",\r\n        message: \"\u670D\u52A1\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      await env.DATABASE.prepare(`\r\n        UPDATE Services \r\n        SET service_name = ?, service_code = ?, description = ?, \r\n            sort_order = ?, updated_at = datetime('now')\r\n        WHERE service_id = ?\r\n      `).bind(serviceName, serviceCode || null, description || null, sortOrder, serviceId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"SUCCESS\",\r\n        message: \"\u66F4\u65B0\u6210\u529F\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u66F4\u65B0\u5931\u8D25\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // DELETE /internal/api/v1/services/:id - \u5220\u9664\u670D\u52A1\u9879\u76EE\uFF08\u8F6F\u5220\u9664\uFF09\r\n  const matchDelete = path.match(/^\\/internal\\/api\\/v1\\/services\\/(\\d+)$/);\r\n  if (method === \"DELETE\" && matchDelete) {\r\n    if (!me?.is_admin) {\r\n      return jsonResponse(403, {\r\n        ok: false,\r\n        code: \"FORBIDDEN\",\r\n        message: \"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const serviceId = parseId(matchDelete[1]);\r\n    if (!serviceId) {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u65E0\u6548\u7684\u670D\u52A1ID\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      await env.DATABASE.prepare(`\r\n        UPDATE Services SET is_active = 0, updated_at = datetime('now')\r\n        WHERE service_id = ?\r\n      `).bind(serviceId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"SUCCESS\",\r\n        message: \"\u5220\u9664\u6210\u529F\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u5220\u9664\u5931\u8D25\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // ========================================\r\n  // \u670D\u52A1\u5B50\u9879\u76EE\uFF08ServiceItems\uFF09\u7BA1\u7406\r\n  // ========================================\r\n\r\n  // GET /internal/api/v1/services/:id/items - \u83B7\u53D6\u670D\u52A1\u7684\u6240\u6709\u5B50\u9879\u76EE\r\n  const matchGetItems = path.match(/^\\/internal\\/api\\/v1\\/services\\/(\\d+)\\/items$/);\r\n  if (method === \"GET\" && matchGetItems) {\r\n    const serviceId = parseId(matchGetItems[1]);\r\n    if (!serviceId) {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u65E0\u6548\u7684\u670D\u52A1ID\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      const rows = await env.DATABASE.prepare(`\r\n        SELECT item_id, service_id, item_name, item_code, description,\r\n               is_active, sort_order, created_at, updated_at\r\n        FROM ServiceItems\r\n        WHERE service_id = ? AND is_active = 1\r\n        ORDER BY sort_order ASC, item_id ASC\r\n      `).bind(serviceId).all();\r\n\r\n      const data = (rows?.results || []).map(r => ({\r\n        item_id: r.item_id,\r\n        service_id: r.service_id,\r\n        item_name: r.item_name || \"\",\r\n        item_code: r.item_code || \"\",\r\n        description: r.description || \"\",\r\n        is_active: Boolean(r.is_active),\r\n        sort_order: r.sort_order || 0,\r\n        created_at: r.created_at,\r\n        updated_at: r.updated_at\r\n      }));\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"SUCCESS\",\r\n        message: \"\u67E5\u8BE2\u6210\u529F\",\r\n        data,\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u670D\u52A1\u5668\u9519\u8BEF\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // POST /internal/api/v1/services/:id/items - \u521B\u5EFA\u670D\u52A1\u5B50\u9879\u76EE\r\n  const matchCreateItem = path.match(/^\\/internal\\/api\\/v1\\/services\\/(\\d+)\\/items$/);\r\n  if (method === \"POST\" && matchCreateItem) {\r\n    if (!me?.is_admin) {\r\n      return jsonResponse(403, {\r\n        ok: false,\r\n        code: \"FORBIDDEN\",\r\n        message: \"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const serviceId = parseId(matchCreateItem[1]);\r\n    if (!serviceId) {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u65E0\u6548\u7684\u670D\u52A1ID\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const itemName = String(body?.item_name || \"\").trim();\r\n    const itemCode = String(body?.item_code || \"\").trim();\r\n    const description = String(body?.description || \"\").trim();\r\n    const sortOrder = parseInt(body?.sort_order || \"0\", 10);\r\n\r\n    if (!itemName) {\r\n      return jsonResponse(422, {\r\n        ok: false,\r\n        code: \"VALIDATION_ERROR\",\r\n        message: \"\u5B50\u9879\u76EE\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      const result = await env.DATABASE.prepare(`\r\n        INSERT INTO ServiceItems (service_id, item_name, item_code, description, sort_order, is_active)\r\n        VALUES (?, ?, ?, ?, ?, 1)\r\n      `).bind(serviceId, itemName, itemCode || null, description || null, sortOrder).run();\r\n\r\n      return jsonResponse(201, {\r\n        ok: true,\r\n        code: \"CREATED\",\r\n        message: \"\u521B\u5EFA\u6210\u529F\",\r\n        data: { item_id: result.meta.last_row_id },\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u521B\u5EFA\u5931\u8D25\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // PUT /internal/api/v1/services/:sid/items/:iid - \u66F4\u65B0\u670D\u52A1\u5B50\u9879\u76EE\r\n  const matchUpdateItem = path.match(/^\\/internal\\/api\\/v1\\/services\\/(\\d+)\\/items\\/(\\d+)$/);\r\n  if (method === \"PUT\" && matchUpdateItem) {\r\n    if (!me?.is_admin) {\r\n      return jsonResponse(403, {\r\n        ok: false,\r\n        code: \"FORBIDDEN\",\r\n        message: \"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const serviceId = parseId(matchUpdateItem[1]);\r\n    const itemId = parseId(matchUpdateItem[2]);\r\n    \r\n    if (!serviceId || !itemId) {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u65E0\u6548\u7684ID\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    let body;\r\n    try {\r\n      body = await request.json();\r\n    } catch {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u8BF7\u6C42\u683C\u5F0F\u9519\u8BEF\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const itemName = String(body?.item_name || \"\").trim();\r\n    const itemCode = String(body?.item_code || \"\").trim();\r\n    const description = String(body?.description || \"\").trim();\r\n    const sortOrder = parseInt(body?.sort_order || \"0\", 10);\r\n\r\n    if (!itemName) {\r\n      return jsonResponse(422, {\r\n        ok: false,\r\n        code: \"VALIDATION_ERROR\",\r\n        message: \"\u5B50\u9879\u76EE\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      await env.DATABASE.prepare(`\r\n        UPDATE ServiceItems \r\n        SET item_name = ?, item_code = ?, description = ?, \r\n            sort_order = ?, updated_at = datetime('now')\r\n        WHERE service_id = ? AND item_id = ?\r\n      `).bind(itemName, itemCode || null, description || null, sortOrder, serviceId, itemId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"SUCCESS\",\r\n        message: \"\u66F4\u65B0\u6210\u529F\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u66F4\u65B0\u5931\u8D25\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  // DELETE /internal/api/v1/services/:sid/items/:iid - \u5220\u9664\u670D\u52A1\u5B50\u9879\u76EE\r\n  const matchDeleteItem = path.match(/^\\/internal\\/api\\/v1\\/services\\/(\\d+)\\/items\\/(\\d+)$/);\r\n  if (method === \"DELETE\" && matchDeleteItem) {\r\n    if (!me?.is_admin) {\r\n      return jsonResponse(403, {\r\n        ok: false,\r\n        code: \"FORBIDDEN\",\r\n        message: \"\u9700\u8981\u7BA1\u7406\u5458\u6743\u9650\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    const serviceId = parseId(matchDeleteItem[1]);\r\n    const itemId = parseId(matchDeleteItem[2]);\r\n    \r\n    if (!serviceId || !itemId) {\r\n      return jsonResponse(400, {\r\n        ok: false,\r\n        code: \"BAD_REQUEST\",\r\n        message: \"\u65E0\u6548\u7684ID\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n\r\n    try {\r\n      await env.DATABASE.prepare(`\r\n        UPDATE ServiceItems SET is_active = 0, updated_at = datetime('now')\r\n        WHERE service_id = ? AND item_id = ?\r\n      `).bind(serviceId, itemId).run();\r\n\r\n      return jsonResponse(200, {\r\n        ok: true,\r\n        code: \"SUCCESS\",\r\n        message: \"\u5220\u9664\u6210\u529F\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n\r\n    } catch (err) {\r\n      console.error(JSON.stringify({ level: \"error\", requestId, path, err: String(err) }));\r\n      return jsonResponse(500, {\r\n        ok: false,\r\n        code: \"INTERNAL_ERROR\",\r\n        message: \"\u5220\u9664\u5931\u8D25\",\r\n        meta: { requestId }\r\n      }, corsHeaders);\r\n    }\r\n  }\r\n\r\n  return jsonResponse(404, {\r\n    ok: false,\r\n    code: \"NOT_FOUND\",\r\n    message: \"API\u8DEF\u5F84\u4E0D\u5B58\u5728\",\r\n    meta: { requestId }\r\n  }, corsHeaders);\r\n}\r\n\r\n", "import { jsonResponse, generateRequestId, corsPreflightResponse, getSessionUser, getCorsHeadersForRequest } from \"./utils.js\";\r\nimport { handleLogin, handleAuthMe } from \"./auth.js\";\r\nimport { handleClients } from \"./api/clients.js\";\r\nimport { handleTasks } from \"./api/tasks.js\";\r\nimport { handleTimesheets } from \"./api/timesheets.js\";\r\nimport { handleReceipts } from \"./api/receipts.js\";\r\nimport { handlePayroll } from \"./api/payroll.js\";\r\nimport { handleLeaves } from \"./api/leaves.js\";\r\nimport { handleDevSeeding } from \"./api/dev.js\";\r\nimport { handleOverhead } from \"./api/overhead.js\";\r\nimport { handleReports } from \"./api/reports.js\";\r\nimport { handleAttachments } from \"./api/attachments.js\";\r\nimport { handleSOP } from \"./api/sop.js\";\r\nimport { handleClientServices } from \"./api/client_services.js\";\r\nimport { handleCMS } from \"./api/cms.js\";\r\nimport { handleSettings } from \"./api/settings.js\";\r\nimport { handleDashboard } from \"./api/dashboard.js\";\r\nimport { handleAutomation } from \"./api/automation.js\";\r\nimport { handleHolidays } from \"./api/holidays.js\";\r\nimport { handleTags } from \"./api/tags.js\";\r\nimport { handleBilling } from \"./api/billing.js\";\r\nimport { handleTaskTemplates } from \"./api/task_templates.js\";\r\nimport { handleServices } from \"./api/services.js\";\r\n\r\nexport default {\r\n\tasync fetch(request, env) {\r\n\t\tconst url = new URL(request.url);\r\n\t\tconst path = url.pathname;\r\n\t\tconst method = request.method.toUpperCase();\r\n\t\tconst requestId = request.headers.get(\"X-Request-Id\") || generateRequestId();\r\n\r\n\t\tconst proxy = (host, newPath) => {\r\n\t\t\tconst target = new URL(request.url);\r\n\t\t\ttarget.protocol = \"https:\";\r\n\t\t\ttarget.hostname = host;\r\n\t\t\ttarget.pathname = newPath;\r\n\t\t\treturn fetch(new Request(target.toString(), request));\r\n\t\t};\r\n\r\n\t\t// CORS Preflight\uFF1A\u8655\u7406 /internal/api/* \u7684 OPTIONS\r\n\t\tif (path.startsWith(\"/internal/api/\") && method === \"OPTIONS\") {\r\n\t\t\treturn corsPreflightResponse(request, env);\r\n\t\t}\r\n\r\n\t\t// Auth routes\r\n\t\tif (path === \"/internal/api/v1/auth/login\") {\r\n\t\t\treturn handleLogin(request, env, requestId);\r\n\t\t}\r\n\t\tif (path === \"/internal/api/v1/auth/me\") {\r\n\t\t\treturn handleAuthMe(request, env, requestId);\r\n\t\t}\r\n\r\n\t\t// DEV routes (no session required, but env must not be prod)\r\n\t\tif (path.startsWith(\"/internal/api/v1/admin/dev-\")) {\r\n\t\t\treturn handleDevSeeding(request, env, requestId, path);\r\n\t\t}\r\n\r\n\t\t// Protected API routes we implement here\r\n\t\tif (path === \"/internal/api/v1/clients\" || path.startsWith(\"/internal/api/v1/clients/\")) {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleClients(request, env, me, requestId, url);\r\n\t\t}\r\n\t\tif (path === \"/internal/api/v1/tags\" || path.startsWith(\"/internal/api/v1/tags/\")) {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleTags(request, env, me, requestId, url);\r\n\t\t}\r\n\t\t\r\n\t\t// \u6536\u8D39\u660E\u7EC6API\r\n\t\tif (path.startsWith(\"/internal/api/v1/billing/\")) {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleBilling(request, env, me, requestId, url, path);\r\n\t\t}\r\n\t\t\r\n\t// \u4EFB\u52A1\u6A21\u677FAPI\r\n\tif (path.startsWith(\"/internal/api/v1/task-templates\")) {\r\n\t\tconst me = await getSessionUser(request, env);\r\n\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\treturn handleTaskTemplates(request, env, me, requestId, url, path);\r\n\t}\r\n\t\r\n\t// \u670D\u52A1\u9879\u76EEAPI\uFF08\u5FC5\u987B\u7CBE\u786E\u5339\u914D\uFF0C\u907F\u514D\u4E0E/clients/.../services\u51B2\u7A81\uFF09\r\n\tif (path === \"/internal/api/v1/services\" || /^\\/internal\\/api\\/v1\\/services\\/\\d+(\\/|$)/.test(path)) {\r\n\t\tconst me = await getSessionUser(request, env);\r\n\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\treturn handleServices(request, env, me, requestId, url, path);\r\n\t}\r\n\t\tif (path === \"/internal/api/v1/tasks\") {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleTasks(request, env, me, requestId, url);\r\n\t\t}\r\n\tif (path === \"/internal/api/v1/timesheets\" || path.startsWith(\"/internal/api/v1/timelogs\")) {\r\n\t\tconst me = await getSessionUser(request, env);\r\n\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\treturn handleTimesheets(request, env, me, requestId, url);\r\n\t}\r\n\t\tif (path === \"/internal/api/v1/receipts\") {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleReceipts(request, env, me, requestId, url);\r\n\t\t}\r\n\t\tif (path === \"/internal/api/v1/attachments\" || path === \"/internal/api/v1/attachments/upload-sign\" || path === \"/internal/api/v1/attachments/upload-direct\") {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleAttachments(request, env, me, requestId, url, path);\r\n\t\t}\r\n\t\tif (path === \"/internal/api/v1/leaves\" || path === \"/internal/api/v1/leaves/balances\" || path === \"/internal/api/v1/admin/cron/execute\" || path === \"/internal/api/v1/admin/cron/history\") {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleLeaves(request, env, me, requestId, url, path);\r\n\t\t}\r\n\t\tif (path === \"/internal/api/v1/holidays\") {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleHolidays(request, env, me, requestId, url);\r\n\t\t}\r\n\t\tif (path.startsWith(\"/internal/api/v1/admin/payroll\")) {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handlePayroll(request, env, me, requestId, url, path);\r\n\t\t}\r\n\t\tif (path.startsWith(\"/internal/api/v1/admin/overhead\")) {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleOverhead(request, env, me, requestId, url, path);\r\n\t\t}\r\n\t\tif (path === \"/internal/api/v1/admin/articles\" || path === \"/internal/api/v1/admin/faq\" || path === \"/internal/api/v1/admin/resources\" || path === \"/internal/api/v1/admin/services\") {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleCMS(request, env, me, requestId, url, path);\r\n\t\t}\r\n\t\tif (path.startsWith(\"/internal/api/v1/reports\")) {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleReports(request, env, me, requestId, url, path);\r\n\t\t}\r\n\r\n\t\tif (path === \"/internal/api/v1/sop\") {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleSOP(request, env, me, requestId, url, path);\r\n\t\t}\r\n\r\n\t\tif (path === \"/internal/api/v1/dashboard\") {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleDashboard(request, env, me, requestId, url, path);\r\n\t\t}\r\n\r\n\t\tif (path === \"/internal/api/v1/admin/automation-rules\" || /\\/internal\\/api\\/v1\\/admin\\/automation-rules\\//.test(path)) {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleAutomation(request, env, me, requestId, url, path);\r\n\t\t}\r\n\r\n\t\t// \u7528\u6236\u5217\u8868\uFF08\u6240\u6709\u767B\u5F55\u7528\u6237\u53EF\u8BBF\u95EE\uFF09\r\n\t\tif (path === \"/internal/api/v1/users\") {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleSettings(request, env, me, requestId, url, path);\r\n\t\t}\r\n\t\t\r\n\t\t// \u7CFB\u7D71\u8A2D\u5B9A\uFF08\u7BA1\u7406\u54E1\uFF09\r\n\t\tif (path === \"/internal/api/v1/admin/settings\" || path.startsWith(\"/internal/api/v1/admin/settings/\")) {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\tif (!me.is_admin) return jsonResponse(403, { ok:false, code:\"FORBIDDEN\", message:\"\u6C92\u6709\u6B0A\u9650\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleSettings(request, env, me, requestId, url, path);\r\n\t\t}\r\n\r\n\t\tif (path === \"/internal/api/v1/client-services\" || /\\/internal\\/api\\/v1\\/client-services\\//.test(path)) {\r\n\t\t\tconst me = await getSessionUser(request, env);\r\n\t\t\tif (!me) return jsonResponse(401, { ok:false, code:\"UNAUTHORIZED\", message:\"\u672A\u767B\u5165\", meta:{ requestId } }, getCorsHeadersForRequest(request, env));\r\n\t\t\treturn handleClientServices(request, env, me, requestId, url, path);\r\n\t\t}\r\n\r\n\t\t// API \u4EE3\u7406\uFF1A/internal/api/* \u2192 <INTERNAL_API_HOST>/api/*\r\n\t\tif (path.startsWith(\"/internal/api/\")) {\r\n\t\t\treturn proxy(env.INTERNAL_API_HOST, path.replace(\"/internal\", \"\"));\r\n\t\t}\r\n\r\n\t\t// \u767B\u5165\u9801\uFF1A/login \u2192 <INTERNAL_BASE_HOST>/login\r\n\t\tif (path === \"/login\" || path.startsWith(\"/login/\")) {\r\n\t\t\treturn proxy(env.INTERNAL_BASE_HOST, \"/login\");\r\n\t\t}\r\n\r\n\t\t// \u5176\u4ED6\u5167\u90E8\u9801\u9762\uFF1A/internal/* \u2192 \u9700\u8981\u767B\u5165\uFF0C\u5426\u5247\u5C0E\u5411 /login\r\n\t\tif (path.startsWith(\"/internal/\")) {\r\n\t\t\tconst row = await getSessionUser(request, env);\r\n\t\t\tif (!row) {\r\n\t\t\t\tconst location = `/login?redirect=${encodeURIComponent(path)}`;\r\n\t\t\t\treturn new Response(null, { status: 302, headers: { Location: location } });\r\n\t\t\t}\r\n\t\t\treturn proxy(env.INTERNAL_BASE_HOST, path.replace(\"/internal\", \"\"));\r\n\t\t}\r\n\r\n\t\t// \u672A\u5339\u914D\u8DEF\u5F91\uFF08\u7406\u8AD6\u4E0A\u4E0D\u6703\u56E0\u70BA routes \u53EA\u7D81\u5B9A\u7279\u5B9A\u8DEF\u5F91\uFF09\r\n\t\treturn fetch(request);\r\n\t},\r\n\r\n\t// Scheduled Handler\uFF08Cron Triggers\uFF09\r\n\tasync scheduled(event, env, ctx) {\r\n\t\tconst requestId = crypto.randomUUID();\r\n\t\tconsole.log(JSON.stringify({ \r\n\t\t\tlevel: \"info\", \r\n\t\t\trequestId, \r\n\t\t\tevent: \"cron_triggered\", \r\n\t\t\tscheduledTime: new Date(event.scheduledTime).toISOString(),\r\n\t\t\tcron: event.cron \r\n\t\t}));\r\n\r\n\t\ttry {\r\n\t\t\t// \u57F7\u884C\u88DC\u4F11\u5230\u671F\u8F49\u52A0\u73ED\u8CBB\r\n\t\t\tconst now = new Date(event.scheduledTime);\r\n\t\t\tconst lastMonth = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() - 1, 1));\r\n\t\t\tconst lastDayOfLastMonth = new Date(Date.UTC(lastMonth.getUTCFullYear(), lastMonth.getUTCMonth() + 1, 0));\r\n\t\t\tconst expiryDate = `${lastDayOfLastMonth.getUTCFullYear()}-${String(lastDayOfLastMonth.getUTCMonth() + 1).padStart(2, '0')}-${String(lastDayOfLastMonth.getUTCDate()).padStart(2, '0')}`;\r\n\t\t\tconst currentMonth = `${now.getUTCFullYear()}-${String(now.getUTCMonth() + 1).padStart(2, '0')}`;\r\n\r\n\t\t\t// \u6383\u63CF\u5230\u671F\u7684\u88DC\u4F11\u8A18\u9304\r\n\t\t\tconst expiredGrants = await env.DATABASE.prepare(\r\n\t\t\t\t`SELECT g.grant_id, g.user_id, g.hours_remaining, g.original_rate, u.base_salary\r\n\t\t\t\t FROM CompensatoryLeaveGrants g\r\n\t\t\t\t LEFT JOIN Users u ON g.user_id = u.user_id\r\n\t\t\t\t WHERE g.expiry_date = ? AND g.status = 'active' AND g.hours_remaining > 0`\r\n\t\t\t).bind(expiryDate).all();\r\n\r\n\t\t\tlet processedCount = 0;\r\n\t\t\tconst grantIds = [];\r\n\r\n\t\t\tfor (const grant of (expiredGrants?.results || [])) {\r\n\t\t\t\tconst baseSalary = Number(grant.base_salary || 0);\r\n\t\t\t\tconst hourlyRate = baseSalary / 240;\r\n\t\t\t\tconst hours = Number(grant.hours_remaining || 0);\r\n\t\t\t\tconst rate = Number(grant.original_rate || 1);\r\n\t\t\t\tconst amountCents = Math.round(hours * hourlyRate * rate * 100);\r\n\r\n\t\t\t\t// \u5BEB\u5165\u52A0\u73ED\u8CBB\u8A18\u9304\r\n\t\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\t`INSERT INTO CompensatoryOvertimePay \r\n\t\t\t\t\t (user_id, year_month, hours_expired, amount_cents, source_grant_ids)\r\n\t\t\t\t\t VALUES (?, ?, ?, ?, ?)`\r\n\t\t\t\t).bind(\r\n\t\t\t\t\tString(grant.user_id),\r\n\t\t\t\t\tcurrentMonth,\r\n\t\t\t\t\thours,\r\n\t\t\t\t\tamountCents,\r\n\t\t\t\t\tJSON.stringify([grant.grant_id])\r\n\t\t\t\t).run();\r\n\r\n\t\t\t\t// \u66F4\u65B0\u88DC\u4F11\u8A18\u9304\u72C0\u614B\u70BA expired\r\n\t\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\t`UPDATE CompensatoryLeaveGrants SET status = 'expired' WHERE grant_id = ?`\r\n\t\t\t\t).bind(grant.grant_id).run();\r\n\r\n\t\t\t\tgrantIds.push(grant.grant_id);\r\n\t\t\t\tprocessedCount++;\r\n\t\t\t}\r\n\r\n\t\t\t// \u8A18\u9304\u57F7\u884C\u6210\u529F\r\n\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t`INSERT INTO CronJobExecutions \r\n\t\t\t\t (job_name, status, executed_at, details)\r\n\t\t\t\t VALUES (?, 'success', datetime('now'), ?)`\r\n\t\t\t).bind('comp_leave_expiry', JSON.stringify({\r\n\t\t\t\texpiryDate,\r\n\t\t\t\tprocessedCount,\r\n\t\t\t\tgrantIds,\r\n\t\t\t\tcurrentMonth,\r\n\t\t\t\ttriggeredBy: 'cron'\r\n\t\t\t})).run();\r\n\r\n\t\t\tconsole.log(JSON.stringify({ \r\n\t\t\t\tlevel: \"info\", \r\n\t\t\t\trequestId, \r\n\t\t\t\tevent: \"cron_completed\", \r\n\t\t\t\tprocessedCount,\r\n\t\t\t\texpiryDate,\r\n\t\t\t\tcurrentMonth\r\n\t\t\t}));\r\n\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(JSON.stringify({ \r\n\t\t\t\tlevel: \"error\", \r\n\t\t\t\trequestId, \r\n\t\t\t\tevent: \"cron_failed\", \r\n\t\t\t\terror: String(err) \r\n\t\t\t}));\r\n\r\n\t\t\t// \u8A18\u9304\u57F7\u884C\u5931\u6557\r\n\t\t\ttry {\r\n\t\t\t\tawait env.DATABASE.prepare(\r\n\t\t\t\t\t`INSERT INTO CronJobExecutions \r\n\t\t\t\t\t (job_name, status, executed_at, error_message)\r\n\t\t\t\t\t VALUES (?, 'failed', datetime('now'), ?)`\r\n\t\t\t\t).bind('comp_leave_expiry', String(err)).run();\r\n\t\t\t} catch (_) {\r\n\t\t\t\tconsole.error(JSON.stringify({ \r\n\t\t\t\t\tlevel: \"error\", \r\n\t\t\t\t\trequestId, \r\n\t\t\t\t\tevent: \"failed_to_log_cron_error\" \r\n\t\t\t\t}));\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n};\r\n\r\n\r\n\r\n"],
  "mappings": "iFACO,SAASA,EAAaC,EAAQC,EAAMC,EAAe,CAAC,EAAG,CAC7D,OAAO,IAAI,SAAS,KAAK,UAAUD,CAAI,EAAG,CACzC,OAAAD,EACA,QAAS,CACR,eAAgB,kCAChB,GAAGE,CACJ,CACD,CAAC,CACF,CARgBC,EAAAJ,EAAA,gBAWT,SAASK,IAAoB,CACnC,IAAMC,EAAS,OAAO,gBAAgB,IAAI,WAAW,CAAC,CAAC,EACvD,MACC,OAAS,MAAM,KAAKA,CAAM,EAAE,IAAKC,GAAMA,EAAE,SAAS,EAAE,EAAE,SAAS,EAAG,GAAG,CAAC,EAAE,KAAK,EAAE,CAEjF,CALgBH,EAAAC,GAAA,qBAQhB,eAAsBG,GAAqBC,EAAUC,EAAQ,CAC5D,GAAI,CAACA,GAAU,OAAOA,GAAW,SAAU,MAAO,GAClD,IAAMC,EAAQD,EAAO,MAAM,GAAG,EAC9B,GAAIC,EAAM,SAAW,GAAKA,EAAM,CAAC,IAAM,SAAU,MAAO,GACxD,IAAMC,EAAa,SAASD,EAAM,CAAC,EAAG,EAAE,EAExC,GAAI,CAAC,OAAO,SAASC,CAAU,GAAKA,EAAa,IAAQ,MAAO,GAChE,IAAMC,EAAO,WAAW,KAAK,KAAKF,EAAM,CAAC,CAAC,EAAIG,GAAMA,EAAE,WAAW,CAAC,CAAC,EAC7DC,EAAW,WAAW,KAAK,KAAKJ,EAAM,CAAC,CAAC,EAAIG,GAAMA,EAAE,WAAW,CAAC,CAAC,EAEjEE,EAAM,IAAI,YACVC,EAAc,MAAM,OAAO,OAAO,UACvC,MACAD,EAAI,OAAOP,CAAQ,EACnB,CAAE,KAAM,QAAS,EACjB,GACA,CAAC,YAAY,CACd,EACMS,EAAc,MAAM,OAAO,OAAO,WACvC,CACC,KAAM,SACN,KAAM,UACN,KAAAL,EACA,WAAAD,CACD,EACAK,EACAF,EAAS,WAAa,CACvB,EACMI,EAAU,IAAI,WAAWD,CAAW,EAC1C,GAAIC,EAAQ,aAAeJ,EAAS,WAAY,MAAO,GACvD,IAAIK,EAAO,EACX,QAASC,EAAI,EAAGA,EAAIF,EAAQ,WAAYE,IAAKD,GAAQD,EAAQE,CAAC,EAAIN,EAASM,CAAC,EAC5E,OAAOD,IAAS,CACjB,CAjCsBhB,EAAAI,GAAA,wBAoCtB,eAAsBc,GAAmBb,EAAUG,EAAa,IAAQW,EAAS,GAAI,CACpF,IAAMV,EAAO,OAAO,gBAAgB,IAAI,WAAW,EAAE,CAAC,EAChDG,EAAM,IAAI,YACVC,EAAc,MAAM,OAAO,OAAO,UACvC,MACAD,EAAI,OAAOP,CAAQ,EACnB,CAAE,KAAM,QAAS,EACjB,GACA,CAAC,YAAY,CACd,EACMS,EAAc,MAAM,OAAO,OAAO,WACvC,CAAE,KAAM,SAAU,KAAM,UAAW,KAAAL,EAAM,WAAAD,CAAW,EACpDK,EACAM,EAAS,CACV,EACMJ,EAAU,IAAI,WAAWD,CAAW,EACpCM,EAAMpB,EAACqB,GAAO,KAAK,OAAO,aAAa,GAAGA,CAAE,CAAC,EAAvC,OACZ,MAAO,UAAeb,CAAU,IAASY,EAAIX,CAAI,CAAC,IAASW,EAAIL,CAAO,CAAC,EACxE,CAlBsBf,EAAAkB,GAAA,sBAqBf,SAASI,IAAoB,CACnC,IAAMC,EAAQ,OAAO,gBAAgB,IAAI,WAAW,EAAE,CAAC,EACvD,OAAO,KAAK,OAAO,aAAa,GAAGA,CAAK,CAAC,EAAE,WAAW,IAAK,EAAE,EAAE,WAAW,IAAK,GAAG,EAAE,WAAW,IAAK,GAAG,CACxG,CAHgBvB,EAAAsB,GAAA,qBAMT,SAASE,EAAyBC,EAASC,EAAK,CACtD,IAAMC,EAASF,EAAQ,QAAQ,IAAI,QAAQ,GAAK,GAChD,GAAI,CAACE,EAAQ,MAAO,CAAC,EACrB,GAAI,CAEH,IAAMC,EADI,IAAI,IAAID,CAAM,EACT,UAAY,GAC3B,GAAIC,EAAK,SAAS,YAAY,GAAKA,EAAK,SAAS,eAAe,EAC/D,MAAO,CACN,8BAA+BD,EAC/B,mCAAoC,OACpC,KAAQ,QACT,CAEF,MAAY,CAAC,CACb,MAAO,CAAC,CACT,CAfgB3B,EAAAwB,EAAA,4BAiBT,SAASK,GAAsBJ,EAASC,EAAK,CACnD,IAAMI,EAAU,CACf,GAAGN,EAAyBC,EAASC,CAAG,EACxC,+BAAgC,mBAChC,+BAAgCD,EAAQ,QAAQ,IAAI,gCAAgC,GAAK,6BACzF,yBAA0B,KAC3B,EACA,OAAO,IAAI,SAAS,KAAM,CAAE,OAAQ,IAAK,QAAAK,CAAQ,CAAC,CACnD,CARgB9B,EAAA6B,GAAA,yBAWT,SAASE,EAAUN,EAASO,EAAM,CAExC,IAAMzB,GADMkB,EAAQ,QAAQ,IAAI,QAAQ,GAAK,IAC3B,MAAM,GAAG,EAC3B,QAAWQ,KAAK1B,EAAO,CACtB,GAAM,CAAC2B,EAAG,GAAGC,CAAC,EAAIF,EAAE,KAAK,EAAE,MAAM,GAAG,EACpC,GAAIC,IAAMF,EAAM,OAAOG,EAAE,KAAK,GAAG,CAClC,CACA,OAAO,IACR,CARgBnC,EAAA+B,EAAA,aAWhB,eAAsBK,EAAeX,EAASC,EAAK,CAClD,IAAMW,EAAa,OAAOX,EAAI,qBAAuB,SAAS,EACxDY,EAAYP,EAAUN,EAASY,CAAU,EAC/C,GAAI,CAACC,GAAa,CAACZ,EAAI,SAAU,OAAO,KACxC,IAAMa,EAAM,MAAMb,EAAI,SAAS,QAC9B,0KACD,EAAE,KAAKY,CAAS,EAAE,MAAM,EACxB,GAAI,CAACC,EAAK,OAAO,KACjB,IAAMC,EAAM,KAAK,MAAMD,EAAI,UAAU,EACrC,OAAI,OAAO,MAAMC,CAAG,GAAKA,GAAO,KAAK,IAAI,EAAU,KAC5CD,CACR,CAXsBvC,EAAAoC,EAAA,kBCxHtB,eAAsBK,GAAYC,EAASC,EAAKC,EAAW,CAC1D,GAAIF,EAAQ,OAAO,YAAY,IAAM,OACpC,OAAOG,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,qBAAsB,QAAS,iCAAS,KAAM,CAAE,UAAAD,CAAU,CAAE,EAAGE,EAAyBJ,EAASC,CAAG,CAAC,EAElJ,IAAII,EACJ,GAAI,CACHA,EAAU,MAAML,EAAQ,KAAK,CAC9B,MAAY,CACX,OAAOG,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,cAAe,QAAS,uCAAU,KAAM,CAAE,UAAAD,CAAU,CAAE,EAAGE,EAAyBJ,EAASC,CAAG,CAAC,CAC5I,CACA,IAAMK,GAAYD,GAAS,UAAY,IAAI,KAAK,EAAE,YAAY,EACxDE,EAAWF,GAAS,UAAY,GAChCG,EAAS,CAAC,EAGhB,GAFKF,GAAUE,EAAO,KAAK,CAAE,MAAO,WAAY,QAAS,cAAK,CAAC,EAC1DD,GAAUC,EAAO,KAAK,CAAE,MAAO,WAAY,QAAS,cAAK,CAAC,EAC3DA,EAAO,OAAS,EACnB,OAAOL,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,2BAAQ,OAAAK,EAAQ,KAAM,CAAE,UAAAN,CAAU,CAAE,EAAGE,EAAyBJ,EAASC,CAAG,CAAC,EAGvJ,GAAI,CAACA,EAAI,SACR,OAAOE,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,uCAAU,KAAM,CAAE,UAAAD,CAAU,CAAE,EAAGE,EAAyBJ,EAASC,CAAG,CAAC,EAG/I,GAAI,CAEH,IAAMQ,EAAU,MAAMR,EAAI,SAAS,QAClC,yHACD,EAAE,KAAKK,CAAQ,EAAE,MAAM,EAGjBI,EAAcN,EAAyBJ,EAASC,CAAG,EACnDU,EAAeC,EAAA,IAAMT,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,eAAgB,QAAS,6CAAW,KAAM,CAAE,UAAAD,CAAU,CAAE,EAAGQ,CAAW,EAAjH,gBAErB,GAAI,CAACD,GAAWA,EAAQ,aAAe,EACtC,OAAOE,EAAa,EAIrB,IAAME,EAAOJ,EAAQ,eAAiB,GAEtC,GAAI,CADW,MAAMK,GAAqBP,EAAUM,CAAI,EAEvD,OAAOF,EAAa,EAIrB,MAAMV,EAAI,SAAS,QAClB,mDACD,EAAE,KAAK,IAAI,KAAK,EAAE,YAAY,EAAGQ,EAAQ,OAAO,EAAE,IAAI,EAGtD,IAAMM,EAAYC,GAAkB,EAC9BC,EAAS,SAAShB,EAAI,qBAAuB,UAAW,EAAE,EAC1DiB,EAAY,IAAI,KAChBC,EAAY,IAAI,KAAKD,EAAU,QAAQ,EAAID,EAAS,GAAI,EAC9D,MAAMhB,EAAI,SAAS,QAClB,8FACD,EAAE,KAAKc,EAAW,OAAON,EAAQ,OAAO,EAAGS,EAAU,YAAY,EAAGC,EAAU,YAAY,EAAG,KAAK,UAAU,CAAE,GAAInB,EAAQ,QAAQ,IAAI,YAAY,GAAK,EAAG,CAAC,CAAC,EAAE,IAAI,EAIlK,IAAMoB,EAAS,CACd,GAFkB,OAAOnB,EAAI,qBAAuB,SAAS,CAEhD,IAAIc,CAAS,GAC1B,uBACA,SACA,WACA,SACA,eACA,WAAWE,CAAM,EAClB,EAAE,KAAK,IAAI,EAELI,EAAO,CACZ,OAAQ,OAAOZ,EAAQ,OAAO,EAC9B,SAAUA,EAAQ,SAClB,KAAMA,EAAQ,KACd,MAAOA,EAAQ,MACf,QAASA,EAAQ,WAAa,CAC/B,EACA,OAAON,EAAa,IAAK,CAAE,GAAI,GAAM,KAAM,KAAM,QAAS,eAAM,KAAAkB,EAAM,KAAM,CAAE,UAAAnB,CAAU,CAAE,EAAG,CAAE,aAAckB,EAAQ,GAAGV,CAAY,CAAC,CACtI,OAASY,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAApB,EAAW,KAAM,8BAA+B,IAAK,OAAOoB,CAAG,CAAE,CAAC,CAAC,EAClH,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAArB,CAAU,CAAE,EACxF,OAAID,EAAI,SAAWA,EAAI,UAAY,SAAQsB,EAAK,MAAQ,OAAOD,CAAG,GAC3DnB,EAAa,IAAKoB,EAAMnB,EAAyBJ,EAASC,CAAG,CAAC,CACtE,CACD,CApFsBW,EAAAb,GAAA,eAsFtB,eAAsByB,GAAaxB,EAASC,EAAKC,EAAW,CAC3D,GAAIF,EAAQ,OAAO,YAAY,IAAM,MACpC,OAAOG,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,qBAAsB,QAAS,iCAAS,KAAM,CAAE,UAAAD,CAAU,CAAE,EAAGE,EAAyBJ,EAASC,CAAG,CAAC,EAElJ,GAAI,CACH,IAAMwB,EAAM,MAAMC,EAAe1B,EAASC,CAAG,EAC7C,GAAI,CAACwB,EACJ,OAAOtB,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,eAAgB,QAAS,qBAAO,KAAM,CAAE,UAAAD,CAAU,CAAE,EAAGE,EAAyBJ,EAASC,CAAG,CAAC,EAE1I,IAAMoB,EAAO,CACZ,OAAQ,OAAOI,EAAI,OAAO,EAC1B,SAAUA,EAAI,SACd,KAAMA,EAAI,KACV,MAAOA,EAAI,MACX,QAASA,EAAI,WAAa,CAC3B,EACA,OAAOtB,EAAa,IAAK,CAAE,GAAI,GAAM,KAAM,KAAM,QAAS,eAAM,KAAAkB,EAAM,KAAM,CAAE,UAAAnB,CAAU,CAAE,EAAGE,EAAyBJ,EAASC,CAAG,CAAC,CACpI,OAASqB,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAApB,EAAW,KAAM,2BAA4B,IAAK,OAAOoB,CAAG,CAAE,CAAC,CAAC,EAC/G,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAArB,CAAU,CAAE,EACxF,OAAID,EAAI,SAAWA,EAAI,UAAY,SAAQsB,EAAK,MAAQ,OAAOD,CAAG,GAC3DnB,EAAa,IAAKoB,EAAMnB,EAAyBJ,EAASC,CAAG,CAAC,CACtE,CACD,CAvBsBW,EAAAY,GAAA,gBCtFtB,eAAsBG,GAAcC,EAASC,EAAKC,EAAIC,EAAWC,EAAK,CACrE,IAAMC,EAAcC,EAAyBN,EAASC,CAAG,EACnDM,EAASP,EAAQ,OAAO,YAAY,EAG1C,QAAQ,IAAI,0CAAsBO,CAAM,IAAIH,EAAI,QAAQ,EAAE,EAG1D,IAAMI,EAAaJ,EAAI,SAAS,MAAM,kEAAkE,EAExG,GADA,QAAQ,IAAI,8DAAiCI,CAAU,EACnDD,IAAW,OAASC,EAAY,CACnC,IAAMC,EAAWD,EAAW,CAAC,EACvBE,EAAY,SAASF,EAAW,CAAC,CAAC,EAExC,GAAI,CAKH,GAAI,CAJW,MAAMP,EAAI,SAAS,QACjC,sEACD,EAAE,KAAKQ,CAAQ,EAAE,MAAM,EAGtB,OAAOE,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,YACN,QAAS,iCACT,KAAM,CAAE,UAAAR,CAAU,CACnB,EAAGE,CAAW,EAUf,IAAMO,GAPQ,MAAMX,EAAI,SAAS,QAChC;AAAA;AAAA;AAAA,0CAID,EAAE,KAAKS,CAAS,EAAE,IAAI,GAEH,QAAQ,IAAIG,IAAS,CACvC,QAASA,EAAK,QACd,UAAWA,EAAK,UAChB,UAAWA,EAAK,UAChB,YAAaA,EAAK,aAAe,EAClC,EAAE,EAEF,OAAOF,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAAC,EACA,KAAM,CAAE,UAAAT,CAAU,CACnB,EAAGE,CAAW,CAEf,OAASS,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAX,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOU,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQc,EAAK,MAAQ,OAAOD,CAAG,GAC3DH,EAAa,IAAKI,EAAMV,CAAW,CAC3C,CACD,CAGA,IAAMW,EAAgBZ,EAAI,SAAS,MAAM,oDAAoD,EAE7F,GADA,QAAQ,IAAI,iEAAoCY,CAAa,EACzDT,IAAW,OAASS,EAAe,CACtC,IAAMP,EAAWO,EAAc,CAAC,EAEhC,QAAQ,IAAI,8EAAkCP,CAAQ,EAEtD,GAAI,CAKH,GAAI,CAJW,MAAMR,EAAI,SAAS,QACjC,sEACD,EAAE,KAAKQ,CAAQ,EAAE,MAAM,EAGtB,OAAOE,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,YACN,QAAS,iCACT,KAAM,CAAE,UAAAR,CAAU,CACnB,EAAGE,CAAW,EAGf,IAAMY,EAAiB,MAAMhB,EAAI,SAAS,QACzC;AAAA;AAAA,gFAGD,EAAE,KAAKQ,CAAQ,EAAE,IAAI,EAErB,QAAQ,IAAI,uDAAoCQ,EAAe,OAAO,EAEtE,IAAIC,EAEJ,GAAID,EAAe,SAAWA,EAAe,QAAQ,OAAS,EAAG,CAChE,IAAME,EAAaF,EAAe,QAAQ,IAAIG,GAAKA,EAAE,UAAU,EACzDC,EAAeF,EAAW,IAAI,IAAM,GAAG,EAAE,KAAK,GAAG,EAEvD,QAAQ,IAAI,0EAAmCA,CAAU,EAEzDD,EAAW,MAAMjB,EAAI,SAAS,QAC7B;AAAA;AAAA,6BAEwBoB,CAAY;AAAA,8CAErC,EAAE,KAAK,GAAGF,CAAU,EAAE,IAAI,CAC3B,MACC,QAAQ,IAAI,oHAA+B,EAC3CD,EAAW,MAAMjB,EAAI,SAAS,QAC7B;AAAA;AAAA;AAAA,8CAID,EAAE,IAAI,EAGP,IAAMW,EAAOM,EAAS,QAAQ,IAAII,IAAY,CAC7C,WAAYA,EAAQ,WACpB,aAAcA,EAAQ,aACtB,aAAcA,EAAQ,aACtB,YAAaA,EAAQ,aAAe,EACrC,EAAE,EAEF,eAAQ,IAAI,gEAAyBV,CAAI,EAElCD,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAAC,EACA,KAAM,CAAE,UAAAT,CAAU,CACnB,EAAGE,CAAW,CAEf,OAASS,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAX,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOU,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQc,EAAK,MAAQ,OAAOD,CAAG,GAC3DH,EAAa,IAAKI,EAAMV,CAAW,CAC3C,CACD,CAGA,IAAMkB,EAAcnB,EAAI,SAAS,MAAM,oBAAoB,EAE3D,GADA,QAAQ,IAAI,+DAAkCmB,CAAW,EACrDhB,IAAW,OAASgB,EAAa,CACpC,IAAMd,EAAWL,EAAI,SAAS,MAAM,GAAG,EAAE,IAAI,EAC7C,GAAI,CACH,IAAMoB,EAAM,MAAMvB,EAAI,SAAS,QAC9B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,0BAUD,EAAE,KAAKQ,CAAQ,EAAE,MAAM,EAEvB,GAAI,CAACe,EACJ,OAAOb,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,YACN,QAAS,iCACT,KAAM,CAAE,UAAAR,CAAU,CACnB,EAAGE,CAAW,EAIf,IAAMoB,EAAO,CAAC,EACVD,EAAI,MACU,OAAOA,EAAI,IAAI,EAAE,MAAM,GAAG,EAClC,QAAQE,GAAQ,CACxB,GAAM,CAACC,EAAIC,EAAMC,CAAK,EAAIH,EAAK,MAAM,GAAG,EACpCC,GAAMC,GACTH,EAAK,KAAK,CACT,OAAQ,SAASE,CAAE,EACnB,SAAUC,EACV,UAAWC,GAAS,IACrB,CAAC,CAEH,CAAC,EAIF,IAAMC,EAAe,MAAM7B,EAAI,SAAS,QACvC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uCAQD,EAAE,KAAKQ,CAAQ,EAAE,IAAI,EAGfS,EAAW,MAAM,QAAQ,KAAKY,GAAc,SAAW,CAAC,GAAG,IAAI,MAAOC,GAAQ,CAQnF,IAAMC,IAPc,MAAM/B,EAAI,SAAS,QACtC;AAAA;AAAA;AAAA,iCAID,EAAE,KAAK8B,EAAI,iBAAiB,EAAE,IAAI,IAEK,SAAW,CAAC,GAAG,IAAIE,IAAM,CAC/D,cAAeA,EAAE,cACjB,eAAgB,OAAOA,EAAE,gBAAkB,CAAC,EAC5C,iBAAkB,OAAOA,EAAE,kBAAoB,EAAE,EACjD,MAAOA,EAAE,OAAS,EACnB,EAAE,EAEIC,EAAaF,EAAiB,OAAO,CAACG,EAAK,IAAMA,EAAM,EAAE,eAAgB,CAAC,EAEhF,MAAO,CACN,kBAAmBJ,EAAI,kBACvB,WAAYA,EAAI,WAChB,aAAcA,EAAI,cAAgB,GAClC,aAAcA,EAAI,cAAgB,GAClC,OAAQA,EAAI,QAAU,SACtB,cAAeA,EAAI,eAAiB,UACpC,iBAAkBA,EAAI,kBAAoB,KAC1C,oBAAqB,EAAQA,EAAI,oBACjC,WAAYA,EAAI,YAAc,KAC9B,SAAUA,EAAI,UAAY,KAC1B,cAAeA,EAAI,eAAiB,GACpC,iBAAkBC,EAClB,WAAYE,CACb,CACD,CAAC,CAAC,EAEItB,EAAO,CACZ,SAAUY,EAAI,UACd,YAAaA,EAAI,aACjB,MAAOA,EAAI,wBACX,eAAgBA,EAAI,YACpB,aAAcA,EAAI,eAAiB,GACnC,MAAOA,EAAI,OAAS,GACpB,MAAOA,EAAI,OAAS,GACpB,YAAaA,EAAI,cAAgB,GACjC,aAAcA,EAAI,eAAiB,GACnC,KAAMC,EACN,SAAUP,EACV,UAAWM,EAAI,WACf,UAAWA,EAAI,UAChB,EAEA,OAAOb,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAAC,EACA,KAAM,CAAE,UAAAT,CAAU,CACnB,EAAGE,CAAW,CAEf,OAASS,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAX,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOU,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQc,EAAK,MAAQ,OAAOD,CAAG,GAC3DH,EAAa,IAAKI,EAAMV,CAAW,CAC3C,CACD,CAGA,IAAM+B,EAAahC,EAAI,WAAa,2BAEpC,GADA,QAAQ,IAAI,6DAAgCgC,EAAW,YAAahC,EAAI,QAAQ,EAC5EG,IAAW,OAAS6B,EAAW,CAClC,IAAMC,EAASjC,EAAI,aACbkC,EAAO,KAAK,IAAI,EAAG,SAASD,EAAO,IAAI,MAAM,GAAK,IAAK,EAAE,CAAC,EAC1DE,EAAU,KAAK,IAAI,IAAK,KAAK,IAAI,EAAG,SAASF,EAAO,IAAI,SAAS,GAAK,KAAM,EAAE,CAAC,CAAC,EAChFG,GAAUF,EAAO,GAAKC,EACtBE,GAAeJ,EAAO,IAAI,cAAc,GAAKA,EAAO,IAAI,GAAG,GAAK,IAAI,KAAK,EAC/E,GAAI,CACH,IAAMK,EAAQ,CAAC,kBAAkB,EAC3BC,EAAQ,CAAC,EACXF,IACHC,EAAM,KAAK,uBAAuB,EAClCC,EAAM,KAAK,IAAIF,CAAW,GAAG,GAE9B,IAAMG,EAAWF,EAAM,OAAS,SAASA,EAAM,KAAK,OAAO,CAAC,GAAK,GAC3DG,EAAW,MAAM5C,EAAI,SAAS,QACnC,2CAA2C2C,CAAQ,EACpD,EAAE,KAAK,GAAGD,CAAK,EAAE,MAAM,EACjBG,EAAQ,OAAOD,GAAU,OAAS,CAAC,EAcnCjC,IAbO,MAAMX,EAAI,SAAS,QAC/B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAOG2C,CAAQ;AAAA;AAAA;AAAA,sBAIZ,EAAE,KAAK,GAAGD,EAAOJ,EAASC,CAAM,EAAE,IAAI,IAClB,SAAW,CAAC,GAAG,IAAKpB,IAAO,CAC9C,SAAUA,EAAE,UACZ,YAAaA,EAAE,aACf,MAAOA,EAAE,wBACT,aAAcA,EAAE,eAAiB,GACjC,KAAOA,EAAE,KAAO,OAAOA,EAAE,IAAI,EAAE,MAAM,GAAG,EAAE,OAAO,OAAO,EAAI,CAAC,EAC7D,MAAOA,EAAE,OAAS,GAClB,MAAOA,EAAE,OAAS,GAClB,UAAWA,EAAE,UACd,EAAE,EACI2B,EAAO,CAAE,UAAA5C,EAAW,KAAAmC,EAAM,QAAAC,EAAS,MAAAO,EAAO,QAASN,EAASD,EAAUO,CAAM,EAClF,OAAOnC,EAAa,IAAK,CAAE,GAAI,GAAM,KAAM,KAAM,QAAS,eAAM,KAAAC,EAAM,KAAAmC,CAAK,EAAG1C,CAAW,CAC1F,OAASS,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAX,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOU,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQc,EAAK,MAAQ,OAAOD,CAAG,GAC3DH,EAAa,IAAKI,EAAMV,CAAW,CAC3C,CACD,CAIA,GADA,QAAQ,IAAI,kEAA0BE,CAAM,kBAAkBH,EAAI,QAAQ,sCAAsCG,IAAW,QAAUH,EAAI,WAAa,0BAA0B,EAAE,EAC9KG,IAAW,QAAUH,EAAI,WAAa,2BAA4B,CACrE,QAAQ,IAAI,sEAAyB,EACrC,IAAIW,EACJ,GAAI,CACHA,EAAO,MAAMf,EAAQ,KAAK,CAC3B,MAAY,CACX,OAAOW,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,cAAe,QAAS,uCAAU,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,CACjH,CACA,IAAM2C,EAAS,CAAC,EACVvC,EAAW,OAAOM,GAAM,WAAa,EAAE,EAAE,KAAK,EAC9C0B,EAAc,OAAO1B,GAAM,cAAgB,EAAE,EAAE,KAAK,EACpDkC,EAAiB,OAAOlC,GAAM,kBAAoB,CAAC,EACnDmC,GAASnC,GAAM,OAAS,IAAI,KAAK,EACjCoC,GAASpC,GAAM,OAAS,IAAI,KAAK,EACjCqC,GAAerC,GAAM,cAAgB,IAAI,KAAK,EAC9CsC,GAAgBtC,GAAM,eAAiB,IAAI,KAAK,EAChDuC,EAAS,MAAM,QAAQvC,GAAM,OAAO,EAAIA,EAAK,QAAQ,IAAKwC,GAAM,OAAOA,CAAC,CAAC,EAAE,OAAQC,GAAM,OAAO,SAASA,CAAC,CAAC,EAAI,CAAC,EAOtH,GALK,UAAU,KAAK/C,CAAQ,GAAGuC,EAAO,KAAK,CAAE,MAAO,YAAa,QAAS,mDAAY,CAAC,GACnFP,EAAY,OAAS,GAAKA,EAAY,OAAS,MAAKO,EAAO,KAAK,CAAE,MAAO,eAAgB,QAAS,+BAAY,CAAC,GAC/G,CAAC,OAAO,UAAUC,CAAc,GAAKA,GAAkB,IAAGD,EAAO,KAAK,CAAE,MAAO,mBAAoB,QAAS,cAAK,CAAC,EAClHG,GAAS,CAAC,6BAA6B,KAAKA,CAAK,GAAGH,EAAO,KAAK,CAAE,MAAO,QAAS,QAAS,gCAAa,CAAC,EACzGE,GAAS,CAAC,oBAAoB,KAAKA,CAAK,GAAGF,EAAO,KAAK,CAAE,MAAO,QAAS,QAAS,sCAAS,CAAC,EAC5FA,EAAO,OACV,OAAOrC,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,2BAAQ,OAAAqC,EAAQ,KAAM,CAAE,UAAA7C,CAAU,CAAE,EAAGE,CAAW,EAE5H,GAAI,CAGH,GADY,MAAMJ,EAAI,SAAS,QAAQ,sEAAsE,EAAE,KAAKQ,CAAQ,EAAE,MAAM,EAEnI,OAAOE,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,WAAY,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,EAG7G,GAAI,CADa,MAAMJ,EAAI,SAAS,QAAQ,kEAAkE,EAAE,KAAKgD,CAAc,EAAE,MAAM,EAE1I,OAAOtC,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,uCAAU,OAAQ,CAAC,CAAE,MAAO,mBAAoB,QAAS,oBAAM,CAAC,EAAG,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,EAE/K,GAAIiD,EAAO,OAAS,EAAG,CACtB,IAAMjC,EAAeiC,EAAO,IAAI,IAAM,GAAG,EAAE,KAAK,GAAG,EAC7C9B,EAAM,MAAMvB,EAAI,SAAS,QAAQ,6DAA6DoB,CAAY,GAAG,EAAE,KAAK,GAAGiC,CAAM,EAAE,MAAM,EAC3I,GAAI,OAAO9B,GAAK,KAAO,CAAC,IAAM8B,EAAO,OACpC,OAAO3C,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,CAEtH,CACA,IAAMoD,EAAM,IAAI,KAAK,EAAE,YAAY,EACnC,MAAMxD,EAAI,SAAS,QAClB,uKACD,EAAE,KAAKQ,EAAUgC,EAAaQ,EAAgBC,EAAOC,EAAOC,EAAaC,EAAcI,EAAKA,CAAG,EAAE,IAAI,EACrG,QAAWC,KAASJ,EACnB,MAAMrD,EAAI,SAAS,QAAQ,8FAA8F,EAAE,KAAKQ,EAAUiD,EAAOD,CAAG,EAAE,IAAI,EAG3J,OAAO9C,EAAa,IAAK,CAAE,GAAI,GAAM,KAAM,UAAW,QAAS,qBAAO,KADzD,CAAE,SAAAF,EAAU,YAAAgC,EAAa,eAAAQ,EAAgB,MAAAC,EAAO,MAAAC,EAAO,YAAAC,EAAa,aAAAC,EAAc,KAAMC,CAAO,EAChC,KAAM,CAAE,UAAAnD,CAAU,CAAE,EAAGE,CAAW,CAC/G,OAASS,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAX,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOU,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQc,EAAK,MAAQ,OAAOD,CAAG,GAC3DH,EAAa,IAAKI,EAAMV,CAAW,CAC3C,CACD,CAGA,GAAIE,IAAW,OAASH,EAAI,SAAS,MAAM,oBAAoB,EAAG,CACjE,IAAMK,EAAWL,EAAI,SAAS,MAAM,GAAG,EAAE,IAAI,EACzCW,EACJ,GAAI,CACHA,EAAO,MAAMf,EAAQ,KAAK,CAC3B,MAAY,CACX,OAAOW,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,cAAe,QAAS,uCAAU,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,CACjH,CAEA,IAAM2C,EAAS,CAAC,EACVP,EAAc,OAAO1B,GAAM,cAAgB,EAAE,EAAE,KAAK,EACpDkC,EAAiB,OAAOlC,GAAM,kBAAoB,CAAC,EACnDmC,GAASnC,GAAM,OAAS,IAAI,KAAK,EACjCoC,GAASpC,GAAM,OAAS,IAAI,KAAK,EACjCqC,GAAerC,GAAM,cAAgB,IAAI,KAAK,EAC9CsC,GAAgBtC,GAAM,eAAiB,IAAI,KAAK,EAChDuC,EAAS,MAAM,QAAQvC,GAAM,OAAO,EAAIA,EAAK,QAAQ,IAAKwC,GAAM,OAAOA,CAAC,CAAC,EAAE,OAAQC,GAAM,OAAO,SAASA,CAAC,CAAC,EAAI,CAAC,EAOtH,IAJIf,EAAY,OAAS,GAAKA,EAAY,OAAS,MAAKO,EAAO,KAAK,CAAE,MAAO,eAAgB,QAAS,+BAAY,CAAC,GAC/G,CAAC,OAAO,UAAUC,CAAc,GAAKA,GAAkB,IAAGD,EAAO,KAAK,CAAE,MAAO,mBAAoB,QAAS,cAAK,CAAC,EAClHG,GAAS,CAAC,6BAA6B,KAAKA,CAAK,GAAGH,EAAO,KAAK,CAAE,MAAO,QAAS,QAAS,gCAAa,CAAC,EACzGE,GAAS,CAAC,oBAAoB,KAAKA,CAAK,GAAGF,EAAO,KAAK,CAAE,MAAO,QAAS,QAAS,sCAAS,CAAC,EAC5FA,EAAO,OACV,OAAOrC,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,2BAAQ,OAAAqC,EAAQ,KAAM,CAAE,UAAA7C,CAAU,CAAE,EAAGE,CAAW,EAG5H,GAAI,CAGH,GAAI,CADa,MAAMJ,EAAI,SAAS,QAAQ,sEAAsE,EAAE,KAAKQ,CAAQ,EAAE,MAAM,EAExI,OAAOE,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,EAK9G,GAAI,CADa,MAAMJ,EAAI,SAAS,QAAQ,kEAAkE,EAAE,KAAKgD,CAAc,EAAE,MAAM,EAE1I,OAAOtC,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,uCAAU,OAAQ,CAAC,CAAE,MAAO,mBAAoB,QAAS,oBAAM,CAAC,EAAG,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,EAI/K,GAAIiD,EAAO,OAAS,EAAG,CACtB,IAAMjC,EAAeiC,EAAO,IAAI,IAAM,GAAG,EAAE,KAAK,GAAG,EAC7C9B,EAAM,MAAMvB,EAAI,SAAS,QAAQ,6DAA6DoB,CAAY,GAAG,EAAE,KAAK,GAAGiC,CAAM,EAAE,MAAM,EAC3I,GAAI,OAAO9B,GAAK,KAAO,CAAC,IAAM8B,EAAO,OACpC,OAAO3C,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,CAEtH,CAEA,IAAMoD,EAAM,IAAI,KAAK,EAAE,YAAY,EAGnC,MAAMxD,EAAI,SAAS,QAClB,0JACD,EAAE,KAAKwC,EAAaQ,EAAgBC,EAAOC,EAAOC,EAAaC,EAAcI,EAAKhD,CAAQ,EAAE,IAAI,EAGhG,MAAMR,EAAI,SAAS,QAAQ,sDAAsD,EAAE,KAAKQ,CAAQ,EAAE,IAAI,EAGtG,QAAWiD,KAASJ,EACnB,MAAMrD,EAAI,SAAS,QAAQ,oFAAoF,EAAE,KAAKQ,EAAUiD,EAAOD,CAAG,EAAE,IAAI,EAIjJ,OAAO9C,EAAa,IAAK,CAAE,GAAI,GAAM,KAAM,UAAW,QAAS,qBAAO,KADzD,CAAE,SAAAF,EAAU,YAAAgC,EAAa,eAAAQ,EAAgB,MAAAC,EAAO,MAAAC,EAAO,YAAAC,EAAa,aAAAC,EAAc,KAAMC,EAAQ,UAAWG,CAAI,EAChD,KAAM,CAAE,UAAAtD,CAAU,CAAE,EAAGE,CAAW,CAE/G,OAASS,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAX,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOU,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQc,EAAK,MAAQ,OAAOD,CAAG,GAC3DH,EAAa,IAAKI,EAAMV,CAAW,CAC3C,CACD,CAGA,GAAIE,IAAW,UAAYH,EAAI,SAAS,MAAM,oBAAoB,EAAG,CACpE,IAAMK,EAAWL,EAAI,SAAS,MAAM,GAAG,EAAE,IAAI,EAC7C,GAAI,CAGH,GAAI,CADa,MAAMH,EAAI,SAAS,QAAQ,sEAAsE,EAAE,KAAKQ,CAAQ,EAAE,MAAM,EAExI,OAAOE,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,EAG9G,IAAMoD,EAAM,IAAI,KAAK,EAAE,YAAY,EAGnC,aAAMxD,EAAI,SAAS,QAClB,uFACD,EAAE,KAAKwD,EAAKvD,EAAG,QAASO,CAAQ,EAAE,IAAI,EAE/BE,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,UACN,QAAS,qBACT,KAAM,CAAE,UAAAR,CAAU,CACnB,EAAGE,CAAW,CAEf,OAASS,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAX,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOU,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQc,EAAK,MAAQ,OAAOD,CAAG,GAC3DH,EAAa,IAAKI,EAAMV,CAAW,CAC3C,CACD,CAGA,GAAIE,IAAW,QAAUH,EAAI,WAAa,wCAAyC,CAElF,GAAI,CAACF,EAAG,SACP,OAAOS,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,YACN,QAAS,2EACT,KAAM,CAAE,UAAAR,CAAU,CACnB,EAAGE,CAAW,EAGf,IAAIU,EACJ,GAAI,CACHA,EAAO,MAAMf,EAAQ,KAAK,CAC3B,MAAY,CACX,OAAOW,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,cAAe,QAAS,uCAAU,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,CACjH,CAEA,IAAM2C,EAAS,CAAC,EACVW,EAAY,MAAM,QAAQ5C,GAAM,UAAU,EAAIA,EAAK,WAAa,CAAC,EACjEkC,EAAiB,OAAOlC,GAAM,kBAAoB,CAAC,EAYzD,GATI4C,EAAU,SAAW,GACxBX,EAAO,KAAK,CAAE,MAAO,aAAc,QAAS,wDAAY,CAAC,EAEtDW,EAAU,OAAS,KACtBX,EAAO,KAAK,CAAE,MAAO,aAAc,QAAS,6DAAiB,CAAC,GAE3D,CAAC,OAAO,UAAUC,CAAc,GAAKA,GAAkB,IAC1DD,EAAO,KAAK,CAAE,MAAO,mBAAoB,QAAS,4CAAU,CAAC,EAE1DA,EAAO,OACV,OAAOrC,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,2BAAQ,OAAAqC,EAAQ,KAAM,CAAE,UAAA7C,CAAU,CAAE,EAAGE,CAAW,EAG5H,GAAI,CAGH,GAAI,CADa,MAAMJ,EAAI,SAAS,QAAQ,kEAAkE,EAAE,KAAKgD,CAAc,EAAE,MAAM,EAE1I,OAAOtC,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,mBACN,QAAS,uCACT,OAAQ,CAAC,CAAE,MAAO,mBAAoB,QAAS,oBAAM,CAAC,EACtD,KAAM,CAAE,UAAAR,CAAU,CACnB,EAAGE,CAAW,EAGf,IAAMoD,EAAM,IAAI,KAAK,EAAE,YAAY,EAC7BpC,EAAesC,EAAU,IAAI,IAAM,GAAG,EAAE,KAAK,GAAG,EAOhDC,GAJS,MAAM3D,EAAI,SAAS,QACjC,+EAA+EoB,CAAY,sBAC5F,EAAE,KAAK4B,EAAgBQ,EAAK,GAAGE,CAAS,EAAE,IAAI,IAEjB,MAAM,SAAW,EAE9C,OAAOhD,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,UACN,QAAS,sBAAOiD,CAAY,sBAC5B,KAAM,CAAE,cAAeA,CAAa,EACpC,KAAM,CAAE,UAAAzD,CAAU,CACnB,EAAGE,CAAW,CAEf,OAASS,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAX,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOU,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQc,EAAK,MAAQ,OAAOD,CAAG,GAC3DH,EAAa,IAAKI,EAAMV,CAAW,CAC3C,CACD,CAKA,IAAMwD,EAAkBzD,EAAI,SAAS,MAAM,oDAAoD,EAE/F,GADA,QAAQ,IAAI,mFAA4CyD,EAAiB,YAAYtD,CAAM,EAAE,EACzFA,IAAW,QAAUsD,EAAiB,CACzC,QAAQ,IAAI,sEAAyB,EACrC,IAAMpD,EAAWoD,EAAgB,CAAC,EAC9B9C,EACJ,GAAI,CACHA,EAAO,MAAMf,EAAQ,KAAK,CAC3B,MAAY,CACX,OAAOW,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,cAAe,QAAS,uCAAU,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,CACjH,CAEA,IAAM2C,EAAS,CAAC,EACVtC,EAAY,OAAOK,GAAM,YAAc,CAAC,EACxC+C,EAAe,OAAO/C,GAAM,eAAiB,SAAS,EAAE,KAAK,EAC7DgD,EAAS,OAAOhD,GAAM,QAAU,QAAQ,EAAE,KAAK,EAC/CiD,EAAiBjD,GAAM,iBAAmB,OAAOA,EAAK,gBAAgB,EAAI,KAC1EkD,EAAoBlD,GAAM,sBAAwB,GAClDmD,EAAY,OAAOnD,GAAM,YAAc,EAAE,EAAE,KAAK,EAChDoD,EAAU,OAAOpD,GAAM,UAAY,EAAE,EAAE,KAAK,EAC5CqD,EAAe,OAAOrD,GAAM,eAAiB,EAAE,EAAE,KAAK,EAkB5D,IAfI,CAACL,GAAaA,GAAa,IAC9BsC,EAAO,KAAK,CAAE,MAAO,aAAc,QAAS,4CAAU,CAAC,EAEnD,CAAC,UAAW,YAAa,SAAU,UAAU,EAAE,SAASc,CAAY,GACxEd,EAAO,KAAK,CAAE,MAAO,gBAAiB,QAAS,kDAAW,CAAC,EAEvD,CAAC,SAAU,YAAa,UAAW,WAAW,EAAE,SAASe,CAAM,GACnEf,EAAO,KAAK,CAAE,MAAO,SAAU,QAAS,sCAAS,CAAC,EAE/CkB,GAAa,CAAC,sBAAsB,KAAKA,CAAS,GACrDlB,EAAO,KAAK,CAAE,MAAO,aAAc,QAAS,qCAAkB,CAAC,EAE5DmB,GAAW,CAAC,sBAAsB,KAAKA,CAAO,GACjDnB,EAAO,KAAK,CAAE,MAAO,WAAY,QAAS,qCAAkB,CAAC,EAE1DA,EAAO,OACV,OAAOrC,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,2BAAQ,OAAAqC,EAAQ,KAAM,CAAE,UAAA7C,CAAU,CAAE,EAAGE,CAAW,EAG5H,GAAI,CAKH,GAAI,CAHW,MAAMJ,EAAI,SAAS,QACjC,sEACD,EAAE,KAAKQ,CAAQ,EAAE,MAAM,EAEtB,OAAOE,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,EAO9G,GAAI,CAHY,MAAMJ,EAAI,SAAS,QAClC,wEACD,EAAE,KAAKS,CAAS,EAAE,MAAM,EAEvB,OAAOC,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,EAW9G,IAAMgE,GAPS,MAAMpE,EAAI,SAAS,QACjC;AAAA;AAAA,wCAGD,EAAE,KAAKQ,EAAUC,EAAWqD,EAAQD,EAAcE,EAAgBC,EAAoB,EAAI,EACzFC,GAAa,KAAMC,GAAW,KAAMC,CAAY,EAAE,IAAI,IAEvB,MAAM,YAEtC,OAAOzD,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,UACN,QAAS,iCACT,KAAM,CAAE,kBAAmB0D,CAAgB,EAC3C,KAAM,CAAE,UAAAlE,CAAU,CACnB,EAAGE,CAAW,CAEf,OAASS,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAX,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOU,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQc,EAAK,MAAQ,OAAOD,CAAG,GAC3DH,EAAa,IAAKI,EAAMV,CAAW,CAC3C,CACD,CAGA,IAAMiE,EAAqBlE,EAAI,SAAS,MAAM,2DAA2D,EACzG,GAAIG,IAAW,OAAS+D,EAAoB,CAC3C,IAAM7D,EAAW6D,EAAmB,CAAC,EAC/BD,EAAkB,OAAOC,EAAmB,CAAC,CAAC,EAChDvD,EACJ,GAAI,CACHA,EAAO,MAAMf,EAAQ,KAAK,CAC3B,MAAY,CACX,OAAOW,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,cAAe,QAAS,uCAAU,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,CACjH,CAEA,IAAM2C,EAAS,CAAC,EACVc,EAAe,OAAO/C,GAAM,eAAiB,SAAS,EAAE,KAAK,EAC7DiD,EAAiBjD,GAAM,iBAAmB,OAAOA,EAAK,gBAAgB,EAAI,KAC1EkD,EAAoBlD,GAAM,sBAAwB,GAClDmD,EAAY,OAAOnD,GAAM,YAAc,EAAE,EAAE,KAAK,EAChDoD,EAAU,OAAOpD,GAAM,UAAY,EAAE,EAAE,KAAK,EAC5CqD,EAAe,OAAOrD,GAAM,eAAiB,EAAE,EAAE,KAAK,EACtDgD,EAAS,OAAOhD,GAAM,QAAU,QAAQ,EAAE,KAAK,EASrD,GANK,CAAC,UAAW,YAAa,SAAU,UAAU,EAAE,SAAS+C,CAAY,GACxEd,EAAO,KAAK,CAAE,MAAO,gBAAiB,QAAS,kDAAW,CAAC,EAEvD,CAAC,SAAU,YAAa,UAAW,WAAW,EAAE,SAASe,CAAM,GACnEf,EAAO,KAAK,CAAE,MAAO,SAAU,QAAS,sCAAS,CAAC,EAE/CA,EAAO,OACV,OAAOrC,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,2BAAQ,OAAAqC,EAAQ,KAAM,CAAE,UAAA7C,CAAU,CAAE,EAAGE,CAAW,EAG5H,GAAI,CAKH,OAHiB,MAAMJ,EAAI,SAAS,QACnC,+GACD,EAAE,KAAKoE,EAAiB5D,CAAQ,EAAE,MAAM,GAMxC,MAAMR,EAAI,SAAS,QAClB;AAAA;AAAA,iCAGD,EAAE,KAAK6D,EAAcE,EAAgBC,EAAoB,EAAI,EAC5DC,GAAa,KAAMC,GAAW,KAAMC,EAAcL,EAAQM,CAAe,EAAE,IAAI,EAEzE1D,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,UACN,QAAS,iCACT,KAAM,CAAE,kBAAmB0D,CAAgB,EAC3C,KAAM,CAAE,UAAAlE,CAAU,CACnB,EAAGE,CAAW,GAjBNM,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,6CAAW,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,CAmBjH,OAASS,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAX,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOU,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQc,EAAK,MAAQ,OAAOD,CAAG,GAC3DH,EAAa,IAAKI,EAAMV,CAAW,CAC3C,CACD,CAGA,GAAIE,IAAW,UAAY+D,EAAoB,CAC9C,IAAM7D,EAAW6D,EAAmB,CAAC,EAC/BD,EAAkB,OAAOC,EAAmB,CAAC,CAAC,EAEpD,GAAI,CAKH,OAHiB,MAAMrE,EAAI,SAAS,QACnC,+GACD,EAAE,KAAKoE,EAAiB5D,CAAQ,EAAE,MAAM,GAMxC,MAAMR,EAAI,SAAS,QAClB,sEACD,EAAE,KAAKoE,CAAe,EAAE,IAAI,EAErB1D,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,UACN,QAAS,iCACT,KAAM,CAAE,UAAAR,CAAU,CACnB,EAAGE,CAAW,GAbNM,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,6CAAW,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,CAejH,OAASS,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAX,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOU,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQc,EAAK,MAAQ,OAAOD,CAAG,GAC3DH,EAAa,IAAKI,EAAMV,CAAW,CAC3C,CACD,CAEA,OAAOM,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,CACnH,CA5uBsBkE,EAAAxE,GAAA,iBCAtB,eAAsByE,GAAYC,EAASC,EAAKC,EAAIC,EAAWC,EAAK,CACnE,IAAMC,EAAcC,EAAyBN,EAASC,CAAG,EACnDM,EAASP,EAAQ,OAAO,YAAY,EAC1C,GAAIO,IAAW,MACd,GAAI,CACH,IAAMC,EAASJ,EAAI,aACbK,EAAO,KAAK,IAAI,EAAG,SAASD,EAAO,IAAI,MAAM,GAAK,IAAK,EAAE,CAAC,EAC1DE,EAAU,KAAK,IAAI,IAAK,KAAK,IAAI,EAAG,SAASF,EAAO,IAAI,SAAS,GAAK,KAAM,EAAE,CAAC,CAAC,EAChFG,GAAUF,EAAO,GAAKC,EACtBE,GAAKJ,EAAO,IAAI,GAAG,GAAK,IAAI,KAAK,EACjCK,GAAUL,EAAO,IAAI,QAAQ,GAAK,IAAI,KAAK,EAC3CM,GAAON,EAAO,IAAI,KAAK,GAAK,IAAI,KAAK,EACrCO,EAAQ,CAAC,kBAAkB,EAC3BC,EAAQ,CAAC,EACVd,EAAG,WACPa,EAAM,KAAK,wBAAwB,EACnCC,EAAM,KAAK,OAAOd,EAAG,OAAO,CAAC,GAE1BU,IACHG,EAAM,KAAK,+CAA+C,EAC1DC,EAAM,KAAK,IAAIJ,CAAC,IAAK,IAAIA,CAAC,GAAG,GAE1BC,GAAU,CAAC,UAAU,cAAc,YAAY,WAAW,EAAE,SAASA,CAAM,IAC9EE,EAAM,KAAK,cAAc,EACzBC,EAAM,KAAKH,CAAM,GAEdC,IAAQ,WACXC,EAAM,KAAK,4DAA4D,EAEpED,IAAQ,QACXC,EAAM,KAAK,gEAAgE,EAE5E,IAAME,EAAWF,EAAM,OAAS,SAASA,EAAM,KAAK,OAAO,CAAC,GAAK,GAC3DG,EAAW,MAAMjB,EAAI,SAAS,QACnC;AAAA;AAAA;AAAA;AAAA,OAIGgB,CAAQ,EACZ,EAAE,KAAK,GAAGD,CAAK,EAAE,MAAM,EACjBG,EAAQ,OAAOD,GAAU,OAAS,CAAC,EAgBnCE,IAfO,MAAMnB,EAAI,SAAS,QAC/B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAUGgB,CAAQ;AAAA;AAAA,sBAGZ,EAAE,KAAK,GAAGD,EAAON,EAASC,CAAM,EAAE,IAAI,IAClB,SAAW,CAAC,GAAG,IAAKU,IAAO,CAC9C,OAAQ,OAAOA,EAAE,OAAO,EACxB,SAAUA,EAAE,UACZ,WAAYA,EAAE,aAAe,GAC7B,aAAcA,EAAE,eAAiB,GACjC,SAAU,CAAE,UAAW,OAAOA,EAAE,kBAAoB,CAAC,EAAG,MAAO,OAAOA,EAAE,cAAgB,CAAC,CAAE,EAC3F,QAASA,EAAE,UAAY,KACvB,OAAQA,EAAE,OACV,OAAQ,OAAOA,EAAE,SAAW,CAAC,IAAM,CACpC,EAAE,EACIC,EAAO,CAAE,UAAAnB,EAAW,KAAAM,EAAM,QAAAC,EAAS,MAAAS,EAAO,QAASR,EAASD,EAAUS,CAAM,EAClF,OAAOI,EAAa,IAAK,CAAE,GAAI,GAAM,KAAM,KAAM,QAAS,eAAM,KAAAH,EAAM,KAAAE,CAAK,EAAGjB,CAAW,CAC1F,OAASmB,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAArB,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOoB,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAtB,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQwB,EAAK,MAAQ,OAAOD,CAAG,GAC3DD,EAAa,IAAKE,EAAMnB,EAAyBN,EAASC,CAAG,CAAC,CACtE,CAGD,GAAIM,IAAW,OAAQ,CACtB,IAAIkB,EACJ,GAAI,CAAEA,EAAO,MAAMzB,EAAQ,KAAK,CAAG,MAAY,CAC9C,OAAOuB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,uCAAU,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGE,CAAW,CAC7G,CACA,IAAMqB,EAAkB,OAAOD,GAAM,mBAAqB,CAAC,EACrDE,EAAW,OAAOF,GAAM,WAAa,EAAE,EAAE,KAAK,EAC9CG,EAAUH,GAAM,SAAW,OAAOA,EAAK,QAAQ,EAAI,KACnDI,EAAiBJ,GAAM,iBAAmB,OAAOA,EAAK,gBAAgB,EAAI,KAC1EK,EAAa,MAAM,QAAQL,GAAM,WAAW,EAAIA,EAAK,YAAY,OAAOM,GAAK,OAAOA,GAAM,UAAYA,EAAE,KAAK,EAAE,OAAS,CAAC,EAAE,IAAIA,GAAKA,EAAE,KAAK,CAAC,EAAI,CAAC,EACjJC,EAAS,CAAC,EAKhB,IAJI,CAAC,OAAO,UAAUN,CAAe,GAAKA,GAAmB,IAAGM,EAAO,KAAK,CAAE,MAAM,oBAAqB,QAAQ,cAAK,CAAC,GACnHL,EAAS,OAAS,GAAKA,EAAS,OAAS,MAAKK,EAAO,KAAK,CAAE,MAAM,YAAa,QAAQ,+BAAY,CAAC,EACpGJ,GAAW,CAAC,sBAAsB,KAAKA,CAAO,GAAGI,EAAO,KAAK,CAAE,MAAM,WAAY,QAAQ,qCAAkB,CAAC,EAC5GH,IAAmB,OAAS,CAAC,OAAO,UAAUA,CAAc,GAAKA,GAAkB,IAAIG,EAAO,KAAK,CAAE,MAAM,mBAAoB,QAAQ,0BAAO,CAAC,EAC/IA,EAAO,OAAQ,OAAOT,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,2BAAQ,OAAAS,EAAQ,KAAK,CAAE,UAAA7B,CAAU,CAAE,EAAGE,CAAW,EAE1I,GAAI,CAEH,GAAI,CADO,MAAMJ,EAAI,SAAS,QAAQ,kFAAkF,EAAE,KAAKyB,CAAe,EAAE,MAAM,EAC7I,OAAOH,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,6CAAW,OAAO,CAAC,CAAE,MAAM,oBAAqB,QAAQ,oBAAM,CAAC,EAAG,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGE,CAAW,EAClL,GAAIwB,GAEC,CADM,MAAM5B,EAAI,SAAS,QAAQ,kEAAkE,EAAE,KAAK4B,CAAc,EAAE,MAAM,EAC5H,OAAON,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,uCAAU,OAAO,CAAC,CAAE,MAAM,mBAAoB,QAAQ,oBAAM,CAAC,EAAG,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGE,CAAW,EAEhL,IAAM4B,EAAM,IAAI,KAAK,EAAE,YAAY,EACnC,MAAMhC,EAAI,SAAS,QAAQ,+KAA+K,EAAE,KAAKyB,EAAiBC,EAAUC,EAASC,EAAgBI,CAAG,EAAE,IAAI,EAC9Q,IAAMC,EAAQ,MAAMjC,EAAI,SAAS,QAAQ,kCAAkC,EAAE,MAAM,EAC7EkC,EAAS,OAAOD,GAAO,EAAE,EAC/B,GAAIJ,EAAW,OAAS,EAAG,CAC1B,IAAIM,EAAQ,EACZ,QAAWL,KAAKD,EACf,MAAM7B,EAAI,SAAS,QAAQ,qGAAqG,EAAE,KAAKkC,EAAQJ,EAAGK,GAAO,EAAE,IAAI,CAEjK,CACA,OAAOb,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,UAAW,QAAQ,qBAAO,KAAK,CAAE,OAAAY,EAAQ,SAAAR,EAAU,gBAAAD,EAAiB,QAAAE,EAAS,eAAAC,CAAe,EAAG,KAAK,CAAE,UAAA1B,CAAU,CAAE,EAAGE,CAAW,CAC1K,OAASmB,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAArB,EAAW,KAAMC,EAAI,SAAU,IAAI,OAAOoB,CAAG,CAAE,CAAC,CAAC,EAC/F,IAAMC,EAAO,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAtB,CAAU,CAAE,EACpF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQwB,EAAK,MAAQ,OAAOD,CAAG,GAC3DD,EAAa,IAAKE,EAAMpB,CAAW,CAC3C,CACD,CAEA,OAAOkB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGE,CAAW,CACnH,CAxHsBgC,EAAAtC,GAAA,eCGtB,IAAMuC,EAAa,CAClB,EAAG,CAAE,KAAM,2BAAQ,WAAY,EAAK,WAAY,EAAM,EACtD,EAAG,CAAE,KAAM,0DAAc,WAAY,KAAM,WAAY,EAAK,EAC5D,EAAG,CAAE,KAAM,0DAAc,WAAY,KAAM,WAAY,EAAK,EAC5D,EAAG,CAAE,KAAM,gEAAe,WAAY,KAAM,WAAY,EAAK,EAC7D,EAAG,CAAE,KAAM,kEAAiB,WAAY,KAAM,WAAY,EAAK,EAC/D,EAAG,CAAE,KAAM,mEAAkB,WAAY,KAAM,WAAY,EAAK,EAChE,EAAG,CAAE,KAAM,sEAAgB,WAAY,EAAK,WAAY,GAAM,SAAU,EAAG,QAAS,UAAW,EAC/F,EAAG,CAAE,KAAM,yEAAmB,WAAY,KAAM,WAAY,EAAK,EACjE,EAAG,CAAE,KAAM,0EAAoB,WAAY,KAAM,WAAY,EAAK,EAClE,GAAI,CAAE,KAAM,gEAAe,WAAY,EAAK,WAAY,GAAM,SAAU,EAAG,QAAS,UAAW,EAC/F,GAAI,CAAE,KAAM,mEAAkB,WAAY,EAAK,WAAY,EAAK,CACjE,EAKA,SAASC,GAAuBC,EAAYC,EAAO,CAClD,IAAMC,EAAWJ,EAAWE,CAAU,EACtC,OAAKE,EAGDA,EAAS,UAAY,WACjB,EAIDD,EAAQC,EAAS,WARFD,CASvB,CAXSE,EAAAJ,GAAA,0BAgBT,eAAeK,GAAkBC,EAASC,EAAKC,EAAIC,EAAWC,EAAK,CAClE,IAAMC,EAAcC,EAAyBN,EAASC,CAAG,EAEzD,GAAI,CACH,IAAMM,EAASH,EAAI,aACbI,GAAaD,EAAO,IAAI,YAAY,GAAK,IAAI,KAAK,EAClDE,GAAWF,EAAO,IAAI,UAAU,GAAK,IAAI,KAAK,EAE/CG,EAAQ,CAAC,kBAAkB,EAC3BC,EAAQ,CAAC,EAGVT,EAAG,WACPQ,EAAM,KAAK,eAAe,EAC1BC,EAAM,KAAK,OAAOT,EAAG,OAAO,CAAC,GAI1BM,IACHE,EAAM,KAAK,kBAAkB,EAC7BC,EAAM,KAAKH,CAAS,GAEjBC,IACHC,EAAM,KAAK,kBAAkB,EAC7BC,EAAM,KAAKF,CAAO,GAGpB,IAAMG,EAAWF,EAAM,OAAS,SAASA,EAAM,KAAK,OAAO,CAAC,GAAK,GAW1DG,IATO,MAAMZ,EAAI,SAAS,QAC/B;AAAA;AAAA;AAAA;AAAA,KAIGW,CAAQ;AAAA,gDAEZ,EAAE,KAAK,GAAGD,CAAK,EAAE,IAAI,IAED,SAAW,CAAC,GAAG,IAAIG,IAAM,CAC5C,OAAQA,EAAE,aACV,aAAcA,EAAE,aAChB,QAASA,EAAE,QACX,UAAWA,EAAE,WAAaA,EAAE,UAAY,eACxC,UAAWA,EAAE,UACb,UAAWA,EAAE,WAAa,GAC1B,WAAY,SAASA,EAAE,UAAU,GAAK,SAASA,EAAE,YAAY,GAAK,EAClE,gBAAiB,SAASA,EAAE,eAAe,GAAK,EAChD,aAAc,SAASA,EAAE,SAAS,GAAK,EACvC,MAAO,OAAOA,EAAE,OAAS,CAAC,EAC1B,MAAOA,EAAE,MAAQ,EAClB,EAAE,EAED,OAAOC,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAAF,EACA,KAAM,CAAE,UAAAV,CAAU,CACnB,EAAGE,CAAW,CAEf,OAASW,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAb,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOY,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAd,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQgB,EAAK,MAAQ,OAAOD,CAAG,GAC3DD,EAAa,IAAKE,EAAMX,EAAyBN,EAASC,CAAG,CAAC,CACtE,CACD,CAlEeH,EAAAC,GAAA,qBAuEf,eAAemB,GAAmBlB,EAASC,EAAKC,EAAIC,EAAWC,EAAK,CACnE,IAAMC,EAAcC,EAAyBN,EAASC,CAAG,EAErDgB,EACJ,GAAI,CACHA,EAAO,MAAMjB,EAAQ,KAAK,CAC3B,MAAY,CACX,OAAOe,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,cACN,QAAS,uCACT,KAAM,CAAE,UAAAZ,CAAU,CACnB,EAAGE,CAAW,CACf,CAGA,IAAMc,EAAY,OAAOF,GAAM,WAAa,EAAE,EAAE,KAAK,EAC/CG,EAAY,OAAOH,GAAM,WAAa,EAAE,EAAE,KAAK,EAC/CI,EAAa,SAASJ,GAAM,UAAU,GAAK,EAC3CK,EAAkB,SAASL,GAAM,eAAe,GAAK,EACrDM,EAAe,SAASN,GAAM,YAAY,GAAK,EAC/CrB,EAAQ,OAAOqB,GAAM,KAAK,EAC1BO,EAAQ,OAAOP,GAAM,OAAS,EAAE,EAAE,KAAK,EACvCQ,EAAeR,GAAM,aAAe,SAASA,EAAK,YAAY,EAAI,KAGlES,EAAS,CAAC,EAEX,sBAAsB,KAAKP,CAAS,GACxCO,EAAO,KAAK,CAAE,MAAO,YAAa,QAAS,uDAAqB,CAAC,EAG7DN,GACJM,EAAO,KAAK,CAAE,MAAO,YAAa,QAAS,gCAAQ,CAAC,EAGhDL,GACJK,EAAO,KAAK,CAAE,MAAO,aAAc,QAAS,4CAAU,CAAC,EAGnDJ,GACJI,EAAO,KAAK,CAAE,MAAO,kBAAmB,QAAS,kDAAW,CAAC,GAG1D,CAACH,GAAgB,CAAC9B,EAAW8B,CAAY,IAC5CG,EAAO,KAAK,CAAE,MAAO,eAAgB,QAAS,8DAAa,CAAC,GAGzD,CAAC,OAAO,SAAS9B,CAAK,GAAKA,GAAS,IACvC8B,EAAO,KAAK,CAAE,MAAO,QAAS,QAAS,wCAAW,CAAC,EAIhD,KAAK,IAAI9B,EAAQ,EAAI,KAAK,MAAMA,EAAQ,CAAC,CAAC,EAAI,MACjD8B,EAAO,KAAK,CAAE,MAAO,QAAS,QAAS,uDAAgB,CAAC,EAIzD,IAAM7B,EAAWJ,EAAW8B,CAAY,EAYxC,GAXI1B,GAAYA,EAAS,UAAYD,EAAQC,EAAS,UACrD6B,EAAO,KAAK,CACX,MAAO,QACP,QAAS,GAAG7B,EAAS,IAAI,kCAASA,EAAS,QAAQ,eACpD,CAAC,EAGED,EAAQ,IACX8B,EAAO,KAAK,CAAE,MAAO,QAAS,QAAS,sDAAe,CAAC,EAGpDA,EAAO,OACV,OAAOX,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,mBACN,QAAS,2BACT,OAAAW,EACA,KAAM,CAAE,UAAAvB,CAAU,CACnB,EAAGE,CAAW,EAGf,GAAI,CAEH,IAAMR,EAAWJ,EAAW8B,CAAY,EACxC,GAAI,CAAC1B,EACJ,OAAOkB,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,mBACN,QAAS,6CACT,OAAQ,CAAC,CAAE,MAAO,eAAgB,QAAS,4CAAU,CAAC,EACtD,KAAM,CAAE,UAAAZ,CAAU,CACnB,EAAGE,CAAW,EAIf,IAAMsB,EAAa,MAAM1B,EAAI,SAAS,QACrC,iEACD,EAAE,KAAKkB,CAAS,EAAE,MAAM,EAGlBS,EADO,IAAI,KAAKT,EAAY,WAAW,EAC5B,OAAO,EAGpBU,EAAW,UACXF,GAAY,sBAAwB,EACvCE,EAAW,mBACDD,IAAQ,EAClBC,EAAW,iBACDD,IAAQ,IAClBC,EAAW,WAIZ,IAAMC,EAAe,CACpB,QAAW,CAAC,EAAG,EAAG,CAAC,EACnB,QAAW,CAAC,EAAG,EAAG,CAAC,EACnB,eAAkB,CAAC,GAAI,EAAE,EACzB,iBAAoB,CAAC,EAAG,EAAG,CAAC,CAC7B,EAEMC,EAAgB,CACrB,QAAW,qBACX,QAAW,qBACX,eAAkB,qBAClB,iBAAoB,0BACrB,EAEA,GAAI,CAACD,EAAaD,CAAQ,EAAE,SAASN,CAAY,EAAG,CACnD,IAAMS,EAAeD,EAAcF,CAAQ,GAAKA,EAChD,OAAOd,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,mBACN,QAAS,GAAGI,CAAS,SAAIa,CAAY,uCAASnC,EAAS,IAAI,SAC3D,OAAQ,CAAC,CACR,MAAO,eACP,QAAS,uCAASmC,CAAY,oEAC/B,CAAC,EACD,KAAM,CAAE,UAAA7B,EAAW,UAAAgB,EAAW,SAAAU,EAAU,SAAUhC,EAAS,IAAK,CACjE,EAAGQ,CAAW,CACf,CAGA,IAAM4B,EAAiBvC,GAAuB6B,EAAc3B,CAAK,EAE7DsC,EACAC,EAAW,GAIf,GAAIV,EAOJ,GALqB,MAAMxB,EAAI,SAAS,QACtC;AAAA,+DAED,EAAE,KAAKwB,EAAc,OAAOvB,EAAG,OAAO,CAAC,EAAE,MAAM,EAE/B,CAEhBgC,EAAST,EACTU,EAAW,GAGX,IAAMC,EAAU,MAAMnC,EAAI,SAAS,QAClC,gEACD,EAAE,KAAKiC,CAAM,EAAE,MAAM,EAEfG,EAAW,OAAOD,GAAS,OAAS,CAAC,EACrCE,EAAY1C,EAAQyC,EAG1B,GAAIC,EAAY,EAAG,CAClB,IAAMC,EAAS,MAAMtC,EAAI,SAAS,QACjC;AAAA;AAAA,6DAGD,EAAE,KAAK,OAAOC,EAAG,OAAO,EAAGiB,CAAS,EAAE,MAAM,EAG5C,GADqB,OAAOoB,GAAQ,GAAK,CAAC,EACvBD,EAAY,GAAK,KACnC,OAAOvB,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,mBACN,QAAS,iGACT,OAAQ,CAAC,CAAE,MAAO,QAAS,QAAS,sCAAS,CAAC,EAC9C,KAAM,CAAE,UAAAZ,CAAU,CACnB,EAAGE,CAAW,CAEhB,CAGA,GAAIR,EAAS,SAAU,CACtB,IAAM2C,EAAc,MAAMvC,EAAI,SAAS,QACtC;AAAA;AAAA,+EAGD,EAAE,KAAK,OAAOC,EAAG,OAAO,EAAGiB,EAAW,OAAOI,CAAY,CAAC,EAAE,MAAM,EAE5DkB,EAAuB,OAAOD,GAAa,GAAK,CAAC,EACjDE,EAAmBD,EAAuBJ,EAAWzC,EAE3D,GAAI8C,EAAmB7C,EAAS,SAAW,KAC1C,OAAOkB,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,mBACN,QAAS,2BAAOlB,EAAS,IAAI,0DAAaA,EAAS,QAAQ,gBAC3D,OAAQ,CAAC,CACR,MAAO,QACP,QAAS,4BAAQ4C,CAAoB,2DAAcC,EAAiB,QAAQ,CAAC,CAAC,mDAC/E,CAAC,EACD,KAAM,CAAE,UAAAvC,CAAU,CACnB,EAAGE,CAAW,CAEhB,CAEA,MAAMJ,EAAI,SAAS,QAClB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,4BAUD,EAAE,KACDmB,EACAC,EACAC,EACA,OAAOD,CAAU,EACjB,OAAOE,CAAY,EACnB3B,EACA4B,EACA,IAAI,KAAK,EAAE,YAAY,EACvBU,CACD,EAAE,IAAI,CAGP,MAEEA,EAAS,KAKX,GAAI,CAACA,EAAQ,CACZ,IAAMS,EAAe,MAAM1C,EAAI,SAAS,QACvC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,0BASD,EAAE,KACD,OAAOC,EAAG,OAAO,EACjBiB,EACAC,EACAC,EACAC,EACA,OAAOC,CAAY,CACpB,EAAE,MAAM,EAET,GAAIoB,EAAc,CAEjBT,EAASS,EAAa,aACtBR,EAAW,GAGX,IAAMS,EAAc,MAAM3C,EAAI,SAAS,QACtC,qDACD,EAAE,KAAKiC,CAAM,EAAE,MAAM,EAEfW,EAAgB,OAAOD,GAAa,OAAS,CAAC,EAC9CE,EAAgBD,EAAgBjD,EAGtC,GAAIC,EAAS,UAAYiD,EAAgBjD,EAAS,SACjD,OAAOkB,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,mBACN,QAAS,2BAAOlB,EAAS,IAAI,4BAAQiD,CAAa,+CAAYjD,EAAS,QAAQ,gBAC/E,OAAQ,CAAC,CACR,MAAO,QACP,QAAS,4BAAQgD,CAAa,qDAAahD,EAAS,SAAWgD,CAAa,eAC7E,CAAC,CACF,EAAGxC,CAAW,EAIf,IAAMkC,EAAS,MAAMtC,EAAI,SAAS,QACjC;AAAA;AAAA,kFAGD,EAAE,KAAK,OAAOC,EAAG,OAAO,EAAGiB,EAAWe,CAAM,EAAE,MAAM,EAE9Ca,EAAkB,OAAOR,GAAQ,GAAK,CAAC,EACvCS,EAAaD,EAAkBD,EAErC,GAAIE,EAAa,GAAK,KACrB,OAAOjC,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,mBACN,QAAS,0DAAaiC,EAAW,QAAQ,CAAC,CAAC,8DAC3C,OAAQ,CAAC,CACR,MAAO,QACP,QAAS,4BAAQD,EAAgB,QAAQ,CAAC,CAAC,qDAAaF,CAAa,2DAAc,KAAK,IAAI,EAAG,GAAKE,EAAkBF,CAAa,EAAE,QAAQ,CAAC,CAAC,eAChJ,CAAC,CACF,EAAGxC,CAAW,EAIf,MAAMJ,EAAI,SAAS,QAClB;AAAA;AAAA,4BAGD,EAAE,KAAKL,EAAO,IAAI,KAAK,EAAE,YAAY,EAAGsC,CAAM,EAAE,IAAI,CACrD,CACA,CAGA,GAAI,CAACA,EAAQ,CAGZ,IAAMK,EAAS,MAAMtC,EAAI,SAAS,QACjC;AAAA;AAAA,4DAGD,EAAE,KAAK,OAAOC,EAAG,OAAO,EAAGiB,CAAS,EAAE,MAAM,EAG7C,GADqB,OAAOoB,GAAQ,GAAK,CAAC,EACvB3C,EAAQ,GAAK,KAC/B,OAAOmB,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,mBACN,QAAS,+EACT,OAAQ,CAAC,CAAE,MAAO,QAAS,QAAS,sCAAS,CAAC,EAC9C,KAAM,CAAE,UAAAZ,CAAU,CACnB,EAAGE,CAAW,EAIf,GAAIR,EAAS,SAAU,CACtB,IAAM2C,EAAc,MAAMvC,EAAI,SAAS,QACtC;AAAA;AAAA,8EAGD,EAAE,KAAK,OAAOC,EAAG,OAAO,EAAGiB,EAAW,OAAOI,CAAY,CAAC,EAAE,MAAM,EAE5D0B,EAAwB,OAAOT,GAAa,GAAK,CAAC,EAGxD,GAFyBS,EAAwBrD,EAE1BC,EAAS,SAAW,KAC1C,OAAOkB,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,mBACN,QAAS,SAAIlB,EAAS,IAAI,0DAAaA,EAAS,QAAQ,gBACxD,OAAQ,CAAC,CACR,MAAO,QACP,QAAS,4BAAQoD,CAAqB,sBAAOpD,EAAS,IAAI,8CAAW,KAAK,IAAI,EAAGA,EAAS,SAAWoD,CAAqB,CAAC,eAC5H,CAAC,EACD,KAAM,CAAE,UAAA9C,CAAU,CACnB,EAAGE,CAAW,CAEhB,CAEA,MAAMJ,EAAI,SAAS,QACjB;AAAA,8CAED,EAAE,KACD,OAAOC,EAAG,OAAO,EACjBiB,EACAC,EACAC,EACAC,EACA,OAAOD,CAAU,EACjB,OAAOE,CAAY,EACnB3B,EACA4B,EACA,IAAI,KAAK,EAAE,YAAY,EACvB,IAAI,KAAK,EAAE,YAAY,CACxB,EAAE,IAAI,EAGNU,GADc,MAAMjC,EAAI,SAAS,QAAQ,kCAAkC,EAAE,MAAM,IACnE,EACjB,CAGA,IAAMiD,EAAuBrD,EAAS,WAAcA,EAAS,UAAY,WAAa,EAAID,EAAS,EAGnG,GAAIsD,EAAuB,EAAG,CAC7B,IAAMC,EAAgBhC,EAEhBiC,EAAU,IAAI,KAAKjC,EAAY,YAAY,EAC3CkC,EAAOD,EAAQ,eAAe,EAC9BE,EAAQF,EAAQ,YAAY,EAC5BG,EAAU,IAAI,KAAK,KAAK,IAAIF,EAAMC,EAAQ,EAAG,CAAC,CAAC,EAC/CE,EAAa,GAAGD,EAAQ,eAAe,CAAC,IAAI,OAAOA,EAAQ,YAAY,EAAI,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,IAAI,OAAOA,EAAQ,WAAW,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,GAGrJ,MAAMtD,EAAI,SAAS,QAClB;AAAA;AAAA,4CAGD,EAAE,KACD,OAAOC,EAAG,OAAO,EACjBgC,EACAgB,EACAA,EACAC,EACAK,EACA3D,EAAS,UACV,EAAE,IAAI,CACP,CAEA,eAAQ,IAAI,sCAAmB,CAAE,OAAAqC,EAAQ,eAAAD,EAAgB,qBAAAiB,CAAqB,CAAC,EAExEnC,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,UACN,QAASoB,EAAW,qBAAQ,qBAC5B,KAAM,CACL,OAAAD,EACA,eAAAD,EACA,qBAAAiB,CACD,EACA,KAAM,CAAE,UAAA/C,CAAU,CACnB,EAAGE,CAAW,CAEf,OAASW,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAC5B,MAAO,QACP,UAAAb,EACA,KAAMC,EAAI,SACV,IAAK,OAAOY,CAAG,EACf,MAAOA,EAAI,KACZ,CAAC,CAAC,EACF,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAd,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQgB,EAAK,MAAQ,OAAOD,CAAG,GAC3DD,EAAa,IAAKE,EAAMZ,CAAW,CAC3C,CACD,CA3beP,EAAAoB,GAAA,sBAgcf,eAAeuC,GAA0BzD,EAASC,EAAKC,EAAIC,EAAWC,EAAK,CAC1E,IAAMC,EAAcC,EAAyBN,EAASC,CAAG,EAErDgB,EACJ,GAAI,CACHA,EAAO,MAAMjB,EAAQ,KAAK,CAC3B,MAAY,CACX,OAAOe,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,cACN,QAAS,uCACT,KAAM,CAAE,UAAAZ,CAAU,CACnB,EAAGE,CAAW,CACf,CAEA,IAAMqD,EAAa,OAAOzC,GAAM,YAAc,EAAE,EAAE,KAAK,EACjD0C,EAAW,OAAO1C,GAAM,UAAY,EAAE,EAAE,KAAK,EAC7CG,EAAY,OAAOH,GAAM,WAAa,EAAE,EAAE,KAAK,EAC/CI,EAAa,SAASJ,GAAM,UAAU,GAAK,EAC3CK,EAAkB,SAASL,GAAM,eAAe,GAAK,EACrDM,EAAe,OAAON,GAAM,cAAgB,EAAE,EAAE,KAAK,EAE3D,GAAI,CAACyC,GAAc,CAACC,GAAY,CAACvC,GAAa,CAACC,GAAc,CAACC,GAAmB,CAACC,EACjF,OAAOR,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,cACN,QAAS,uCACT,KAAM,CAAE,UAAAZ,CAAU,CACnB,EAAGE,CAAW,EAGf,GAAI,CAwBH,IAAMuD,GAtBS,MAAM3D,EAAI,SAAS,QACjC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yBAUD,EAAE,KACD,IAAI,KAAK,EAAE,YAAY,EACvB,OAAOC,EAAG,OAAO,EACjBwD,EACAC,EACAvC,EACAC,EACAC,EACAC,CACD,EAAE,IAAI,GAEuB,SAAW,EAExC,OAAOR,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,UACN,QAAS,sBAAO6C,CAAa,sBAC7B,KAAM,CAAE,cAAAA,CAAc,EACtB,KAAM,CAAE,UAAAzD,CAAU,CACnB,EAAGE,CAAW,CAEf,OAASW,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAb,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOY,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAd,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQgB,EAAK,MAAQ,OAAOD,CAAG,GAC3DD,EAAa,IAAKE,EAAMZ,CAAW,CAC3C,CACD,CAvEeP,EAAA2D,GAAA,6BA4Ef,eAAeI,GAAwB7D,EAASC,EAAKC,EAAIC,EAAWC,EAAK,CACxE,IAAMC,EAAcC,EAAyBN,EAASC,CAAG,EAEzD,GAAI,CACH,IAAMM,EAASH,EAAI,aACbkD,GAAS/C,EAAO,IAAI,OAAO,GAAK,IAAI,KAAK,EAG/C,GAAI,CAAC+C,GAAS,CAAC,gBAAgB,KAAKA,CAAK,EACxC,OAAOvC,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,gBACN,QAAS,iEACT,KAAM,CAAE,UAAAZ,CAAU,CACnB,EAAGE,CAAW,EAIf,GAAM,CAACgD,EAAMS,CAAQ,EAAIR,EAAM,MAAM,GAAG,EAClC9C,EAAY,GAAG6C,CAAI,IAAIS,CAAQ,MAE/BrD,EAAU,GADE,SAASqD,CAAQ,IAAM,GAAK,GAAG,SAAST,CAAI,EAAI,CAAC,MAAQ,GAAGA,CAAI,IAAI,OAAO,SAASS,CAAQ,EAAI,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,EACzG,MAGzBC,EAAS7D,EAAG,QACZA,EAAG,UAAYK,EAAO,IAAI,SAAS,IACtCwD,EAAS,SAASxD,EAAO,IAAI,SAAS,CAAC,GAIvC,IAAMyD,EAAW,MAAM/D,EAAI,SAAS,QACnC;AAAA;AAAA;AAAA;AAAA;AAAA,yBAMD,EAAE,KAAK8D,EAAQvD,EAAWC,CAAO,EAAE,IAAI,EAGnCwD,EAAa,EACbC,EAAgB,EAChBC,EAAgB,EAEpBH,EAAS,QAAQ,QAAQI,GAAO,CAC/B,IAAMxE,EAAQ,WAAWwE,EAAI,KAAK,GAAK,EACjCzE,EAAa,SAASyE,EAAI,SAAS,GAAK,EACxCvE,EAAWJ,EAAWE,CAAU,EAElCE,IACHoE,GAAcrE,EAEVC,EAAS,aACZqE,GAAiBtE,GAGlBuE,GAAiBzE,GAAuBC,EAAYC,CAAK,EAE3D,CAAC,EAGF,IAAMyE,EAAY,MAAMpE,EAAI,SAAS,QACpC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,wBAOD,EAAE,KAAK8D,EAAQvD,EAAWC,CAAO,EAAE,IAAI,EAGnC6D,EAAa,EACjB,OAAID,EAAU,SACbA,EAAU,QAAQ,QAAQE,GAAO,CAChC,IAAMC,EAAS,WAAWD,EAAI,MAAM,GAAK,EACrCA,EAAI,OAAS,OAChBD,GAAcE,EACJD,EAAI,OAAS,QACvBD,GAAcE,EAAS,EAEzB,CAAC,EAIMzD,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAM,CACL,MAAAuC,EACA,YAAa,KAAK,MAAMW,EAAa,EAAE,EAAI,GAC3C,eAAgB,KAAK,MAAMC,EAAgB,EAAE,EAAI,GACjD,eAAgB,KAAK,MAAMC,EAAgB,EAAE,EAAI,GACjD,YAAa,KAAK,MAAMG,EAAa,EAAE,EAAI,EAC5C,EACA,KAAM,CAAE,UAAAnE,CAAU,CACnB,EAAGE,CAAW,CAEf,OAASW,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAb,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOY,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAd,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQgB,EAAK,MAAQ,OAAOD,CAAG,GAC3DD,EAAa,IAAKE,EAAMZ,CAAW,CAC3C,CACD,CAzGeP,EAAA+D,GAAA,2BA8Gf,eAAsBY,GAAiBzE,EAASC,EAAKC,EAAIC,EAAWC,EAAK,CACxE,IAAMC,EAAcC,EAAyBN,EAASC,CAAG,EACnDyE,EAAS1E,EAAQ,OAAO,YAAY,EAG1C,OAAI0E,IAAW,OAAStE,EAAI,SAAS,SAAS,UAAU,EAChDyD,GAAwB7D,EAASC,EAAKC,EAAIC,EAAWC,CAAG,EAI5DsE,IAAW,MACP3E,GAAkBC,EAASC,EAAKC,EAAIC,EAAWC,CAAG,EAItDsE,IAAW,OACPxD,GAAmBlB,EAASC,EAAKC,EAAIC,EAAWC,CAAG,EAIvDsE,IAAW,UAAYtE,EAAI,SAAS,SAAS,QAAQ,EACjDqD,GAA0BzD,EAASC,EAAKC,EAAIC,EAAWC,CAAG,EAG3DW,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,qBACN,QAAS,iCACT,KAAM,CAAE,UAAAZ,CAAU,CACnB,EAAGE,CAAW,CACf,CA9BsBP,EAAA2E,GAAA,oBCruBtB,eAAsBE,GAAeC,EAASC,EAAKC,EAAIC,EAAWC,EAAK,CACtE,IAAMC,EAAcC,EAAyBN,EAASC,CAAG,EACnDM,EAASP,EAAQ,OAAO,YAAY,EACpCQ,EAAOJ,EAAI,SAGjB,GAAIG,IAAW,OAASC,IAAS,2CAA4C,CAC5E,IAAMC,EAAkB,SAASL,EAAI,aAAa,IAAI,mBAAmB,GAAK,IAAK,EAAE,EAC/EM,EAAe,SAASN,EAAI,aAAa,IAAI,eAAe,GAAK,IAAK,EAAE,EAE9E,GAAI,CAACK,GAAmBC,EAAe,GAAKA,EAAe,GAC1D,OAAOC,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,cACN,QAAS,2FACT,KAAM,CAAE,UAAAR,CAAU,CACnB,EAAGE,CAAW,EAGf,GAAI,CAEH,IAAMO,EAAW,MAAMX,EAAI,SAAS,QACnC;AAAA;AAAA,uDAGD,EAAE,KAAKQ,EAAiBC,CAAY,EAAE,MAAM,EAE5C,OAAKE,EAcED,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,KACN,QAAS,mDACT,KAAM,CACL,iBAAkB,OAAOC,EAAS,gBAAkB,CAAC,EACrD,iBAAkB,OAAOA,EAAS,kBAAoB,EAAE,EACxD,aAAc,EACf,EACA,KAAM,CAAE,UAAAT,CAAU,CACnB,EAAGE,CAAW,EAvBNM,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,KACN,QAAS,mDACT,KAAM,CACL,iBAAkB,EAClB,iBAAkB,GAClB,aAAc,EACf,EACA,KAAM,CAAE,UAAAR,CAAU,CACnB,EAAGE,CAAW,CAehB,OAASQ,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAV,EAAW,KAAAK,EAAM,IAAK,OAAOK,CAAG,CAAE,CAAC,CAAC,EAC5EF,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,CACnH,CACD,CAGA,GAAIE,IAAW,OAASC,IAAS,4BAChC,GAAI,CACH,IAAMM,EAASV,EAAI,aACbW,EAAO,KAAK,IAAI,EAAG,SAASD,EAAO,IAAI,MAAM,GAAK,IAAK,EAAE,CAAC,EAC1DE,EAAU,KAAK,IAAI,IAAK,KAAK,IAAI,EAAG,SAASF,EAAO,IAAI,SAAS,GAAK,KAAM,EAAE,CAAC,CAAC,EAChFG,GAAUF,EAAO,GAAKC,EACtBE,GAAKJ,EAAO,IAAI,GAAG,GAAK,IAAI,KAAK,EACjCK,GAAUL,EAAO,IAAI,QAAQ,GAAK,IAAI,KAAK,EAC3CM,GAAeN,EAAO,IAAI,cAAc,GAAK,IAAI,KAAK,EACtDO,GAAYP,EAAO,IAAI,UAAU,GAAK,IAAI,KAAK,EAC/CQ,GAAUR,EAAO,IAAI,QAAQ,GAAK,IAAI,KAAK,EAC3CS,EAAQ,CAAC,kBAAkB,EAC3BC,EAAQ,CAAC,EACXN,IAAKK,EAAM,KAAK,gDAAgD,EAAGC,EAAM,KAAK,IAAIN,CAAC,IAAK,IAAIA,CAAC,GAAG,GAChGC,GAAU,CAAC,SAAS,UAAU,OAAO,WAAW,EAAE,SAASA,CAAM,IAAKI,EAAM,KAAK,cAAc,EAAGC,EAAM,KAAKL,CAAM,GACnHC,GAAe,CAAC,SAAS,aAAa,SAAS,EAAE,SAASA,CAAW,IAAKG,EAAM,KAAK,oBAAoB,EAAGC,EAAM,KAAKJ,CAAW,GAClIC,IAAYE,EAAM,KAAK,qBAAqB,EAAGC,EAAM,KAAKH,CAAQ,GAClEC,IAAUC,EAAM,KAAK,qBAAqB,EAAGC,EAAM,KAAKF,CAAM,GAClE,IAAMG,EAAWF,EAAM,OAAS,SAASA,EAAM,KAAK,OAAO,CAAC,GAAK,GAC3DG,EAAW,MAAMzB,EAAI,SAAS,QACnC,6FAA6FwB,CAAQ,EACtG,EAAE,KAAK,GAAGD,CAAK,EAAE,MAAM,EACjBG,EAAQ,OAAOD,GAAU,OAAS,CAAC,EASnCE,IARO,MAAM3B,EAAI,SAAS,QAC/B;AAAA;AAAA;AAAA,OAGGwB,CAAQ;AAAA;AAAA,sBAGZ,EAAE,KAAK,GAAGD,EAAOR,EAASC,CAAM,EAAE,IAAI,IAClB,SAAW,CAAC,GAAG,IAAIY,IAAM,CAC5C,UAAWA,EAAE,WACb,SAAUA,EAAE,UACZ,WAAYA,EAAE,aAAe,GAC7B,YAAa,OAAOA,EAAE,cAAgB,CAAC,EACvC,YAAaA,EAAE,aACf,QAASA,EAAE,UAAY,KACvB,OAAQA,EAAE,OACV,YAAaA,EAAE,cAAgB,QAChC,EAAE,EACIC,EAAO,CAAE,UAAA3B,EAAW,KAAAY,EAAM,QAAAC,EAAS,MAAAW,EAAO,QAASV,EAASD,EAAUW,CAAM,EAClF,OAAOhB,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAiB,EAAM,KAAAE,CAAK,EAAGzB,CAAW,CACvF,OAASQ,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAV,EAAW,KAAMC,EAAI,SAAU,IAAI,OAAOS,CAAG,CAAE,CAAC,CAAC,EACxFF,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,EAAyBN,EAASC,CAAG,CAAC,CAC1I,CAGD,GAAIM,IAAW,QAAUC,IAAS,4BAA6B,CAC9D,IAAIuB,EACJ,GAAI,CAAEA,EAAO,MAAM/B,EAAQ,KAAK,CAAG,MAAY,CAC9C,OAAOW,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,uCAAU,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,CAC7G,CACA,IAAM2B,EAAY,OAAOD,GAAM,WAAa,EAAE,EAAE,KAAK,EAC/CE,EAAe,OAAOF,GAAM,cAAgB,EAAE,EAAE,KAAK,EACrDG,EAAe,OAAOH,GAAM,UAAY,EAAE,EAAE,KAAK,EACjDI,EAAe,OAAOJ,GAAM,YAAY,EAC1CK,EAAY,OAAOL,GAAM,QAAU,QAAQ,EAAE,KAAK,EAChDM,GAASN,GAAM,OAAS,IAAI,KAAK,EAGnCX,EAAc,OAAOW,GAAM,cAAgB,QAAQ,EAAE,KAAK,EACxDO,EAAgBP,GAAM,gBAAkB,SAASA,EAAK,gBAAiB,EAAE,EAAI,KAC7EtB,EAAkBsB,GAAM,kBAAoB,SAASA,EAAK,kBAAmB,EAAE,EAAI,KACnFrB,EAAeqB,GAAM,cAAgB,SAASA,EAAK,cAAe,EAAE,EAAI,KAExEQ,EAAS,CAAC,EAYhB,GAXKP,GAAWO,EAAO,KAAK,CAAE,MAAM,YAAa,QAAQ,cAAK,CAAC,EAC1D,sBAAsB,KAAKN,CAAY,GAAGM,EAAO,KAAK,CAAE,MAAM,eAAgB,QAAQ,qCAAkB,CAAC,GAC1G,CAAC,OAAO,SAASJ,CAAY,GAAKA,GAAgB,IAAGI,EAAO,KAAK,CAAE,MAAM,eAAgB,QAAQ,4BAAS,CAAC,EAC1GH,IAAWA,EAAY,UACvB,CAAC,SAAS,UAAU,OAAO,WAAW,EAAE,SAASA,CAAS,GAAGG,EAAO,KAAK,CAAE,MAAM,SAAU,QAAQ,gCAAQ,CAAC,EAC5G,CAAC,SAAS,aAAa,SAAS,EAAE,SAASnB,CAAW,IAC1DA,EAAc,UAEXV,IAAiBA,EAAe,GAAKA,EAAe,KACvD6B,EAAO,KAAK,CAAE,MAAM,gBAAiB,QAAQ,gDAAc,CAAC,EAEzDA,EAAO,OAAQ,OAAO5B,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,2BAAQ,OAAA4B,EAAQ,KAAK,CAAE,UAAApC,CAAU,CAAE,EAAGE,CAAW,EAE1I,GAAI,CAGH,GAAI,CADM,MAAMJ,EAAI,SAAS,QAAQ,sEAAsE,EAAE,KAAK+B,CAAS,EAAE,MAAM,EAC3H,OAAOrB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,iCAAS,OAAO,CAAC,CAAE,MAAM,YAAa,QAAQ,oBAAM,CAAC,EAAG,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,EAGvK,GAAM,CAACmC,EAAMC,CAAE,EAAIR,EAAa,MAAM,GAAG,EACnCS,EAAS,GAAGF,CAAI,GAAGC,CAAE,GACrBE,EAAS,MAAM1C,EAAI,SAAS,QAAQ,0FAA0F,EAAE,KAAK,GAAGyC,CAAM,IAAI,EAAE,MAAM,EAC5JE,EAAM,EACV,GAAID,GAAU,OAAOA,EAAO,YAAe,SAAU,CACpD,IAAME,EAAIF,EAAO,WAAW,MAAM,mBAAmB,EACjDE,IAAGD,EAAM,KAAK,IAAIA,EAAK,SAASC,EAAE,CAAC,EAAG,EAAE,EAAI,CAAC,EAClD,CACA,IAAMC,EAAa,GAAGJ,CAAM,IAAI,OAAOE,CAAG,EAAE,SAAS,EAAG,GAAG,CAAC,GAGxDG,EAAWb,EACf,GAAI,CAACa,EAAU,CACd,IAAIC,EAAU,GAGd,GAAIvC,GAAmBC,EAAc,CACpC,IAAME,EAAW,MAAMX,EAAI,SAAS,QACnC,uGACD,EAAE,KAAKQ,EAAiBC,CAAY,EAAE,MAAM,EACxCE,GAAYA,EAAS,mBACxBoC,EAAU,OAAOpC,EAAS,gBAAgB,EAE5C,CAEA,IAAMqC,EAAI,IAAI,KAAKhB,EAAe,YAAY,EAC9CgB,EAAE,WAAWA,EAAE,WAAW,EAAID,CAAO,EACrC,IAAME,EAAID,EAAE,eAAe,EACrBE,EAAK,OAAOF,EAAE,YAAY,EAAI,CAAC,EAAE,SAAS,EAAG,GAAG,EAChDG,EAAM,OAAOH,EAAE,WAAW,CAAC,EAAE,SAAS,EAAG,GAAG,EAClDF,EAAW,GAAGG,CAAC,IAAIC,CAAE,IAAIC,CAAG,EAC7B,CAEA,aAAMnD,EAAI,SAAS,QAClB;AAAA;AAAA;AAAA,0DAID,EAAE,KACD6C,EAAYd,EAAWC,EAAcc,EAAUZ,EAAcC,EAC7DhB,EAAakB,EAAe7B,EAAiBC,EAC7C2B,EAAO,OAAOnC,EAAG,OAAO,EAAG,IAAI,KAAK,EAAE,YAAY,EAAG,IAAI,KAAK,EAAE,YAAY,CAC7E,EAAE,IAAI,EAcCS,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,UAAW,QAAQ,qBAAO,KAZtD,CACZ,UAAWmC,EACX,SAAUd,EACV,YAAaG,EACb,YAAaF,EACb,QAASc,EACT,OAAQX,EACR,YAAahB,EACb,cAAekB,EACf,gBAAiB7B,EACjB,aAAcC,CACf,EACyE,KAAK,CAAE,UAAAP,CAAU,CAAE,EAAGE,CAAW,CAC3G,OAASQ,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAV,EAAW,KAAMC,EAAI,SAAU,IAAI,OAAOS,CAAG,CAAE,CAAC,CAAC,EAC/F,IAAMkB,EAAO,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAA5B,CAAU,CAAE,EACpF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQ8B,EAAK,MAAQ,OAAOlB,CAAG,GAC3DF,EAAa,IAAKoB,EAAM1B,CAAW,CAC3C,CACD,CAEA,OAAOM,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGE,CAAW,CACnH,CArNsBgD,EAAAtD,GAAA,kBCAtB,eAAsBuD,GAAcC,EAASC,EAAKC,EAAIC,EAAWC,EAAKC,EAAM,CAC3E,IAAMC,EAAcC,EAAyBP,EAASC,CAAG,EAGzD,OAAOO,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,kBACN,QAAS,mDACT,KAAM,CAAE,UAAAL,CAAU,CACnB,EAAGG,CAAW,CACf,CAVsBG,EAAAV,GAAA,iBCAtB,eAAsBW,GAAaC,EAASC,EAAKC,EAAIC,EAAWC,EAAKC,EAAM,CAC1E,IAAMC,EAAcC,EAAyBP,EAASC,CAAG,EACnDO,EAASR,EAAQ,OAAO,YAAY,EAE1C,GAAIK,IAAS,mCAAoC,CAChD,GAAIG,IAAW,MACd,OAAOC,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EAEnH,GAAI,CACH,IAAMI,EAASN,EAAI,aAAoBO,EAAO,SAASD,EAAO,IAAI,MAAM,GAAK,OAAO,IAAI,KAAK,EAAE,YAAY,CAAC,EAAG,EAAE,EAI3GE,IAHO,MAAMX,EAAI,SAAS,QAC/B,gGACD,EAAE,KAAK,OAAOC,EAAG,OAAO,EAAGS,CAAI,EAAE,IAAI,IACjB,SAAW,CAAC,GAAG,IAAIE,IAAM,CAAE,KAAMA,EAAE,WAAY,KAAM,OAAOA,EAAE,IAAI,EAAG,MAAO,OAAOA,EAAE,KAAK,EAAG,KAAM,OAAOA,EAAE,IAAI,EAAG,OAAQ,OAAOA,EAAE,MAAM,CAAE,EAAE,EAG5JC,EAAU,MAAMb,EAAI,SAAS,QAClC;AAAA,qEAED,EAAE,KAAK,OAAOC,EAAG,OAAO,CAAC,EAAE,MAAM,EAC3Ba,EAAa,OAAOD,GAAS,OAAS,CAAC,EAE7C,OAAIC,EAAa,GAChBH,EAAK,KAAK,CAAE,KAAM,OAAQ,KAAAD,EAAM,MAAOI,EAAY,KAAM,EAAG,OAAQA,CAAW,CAAC,EAG1EN,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAG,EAAM,KAAK,CAAE,UAAAT,EAAW,KAAAQ,CAAK,CAAE,EAAGL,CAAW,CAC3G,OAASU,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAb,EAAW,KAAAE,EAAM,IAAI,OAAOW,CAAG,CAAE,CAAC,CAAC,EAC1EP,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CAC/G,CACD,CAEA,GAAID,IAAS,0BAA2B,CACvC,GAAIG,IAAW,MACd,GAAI,CACH,IAAME,EAASN,EAAI,aACba,EAAO,KAAK,IAAI,EAAG,SAASP,EAAO,IAAI,MAAM,GAAK,IAAK,EAAE,CAAC,EAC1DQ,EAAU,KAAK,IAAI,IAAK,KAAK,IAAI,EAAG,SAASR,EAAO,IAAI,SAAS,GAAK,KAAM,EAAE,CAAC,CAAC,EAChFS,GAAUF,EAAO,GAAKC,EACtBE,GAAKV,EAAO,IAAI,GAAG,GAAK,IAAI,KAAK,EACjCW,GAAUX,EAAO,IAAI,QAAQ,GAAK,IAAI,KAAK,EAC3CY,GAAQZ,EAAO,IAAI,MAAM,GAAK,IAAI,KAAK,EACvCa,GAAYb,EAAO,IAAI,UAAU,GAAK,IAAI,KAAK,EAC/Cc,GAAUd,EAAO,IAAI,QAAQ,GAAK,IAAI,KAAK,EAC3Ce,EAAQ,CAAC,kBAAkB,EAC3BC,EAAQ,CAAC,EACVxB,EAAG,WAAYuB,EAAM,KAAK,eAAe,EAAGC,EAAM,KAAK,OAAOxB,EAAG,OAAO,CAAC,GAC1EkB,IAAKK,EAAM,KAAK,0CAA0C,EAAGC,EAAM,KAAK,IAAIN,CAAC,IAAK,IAAIA,CAAC,GAAG,GAC1FC,GAAU,CAAC,UAAU,WAAW,UAAU,EAAE,SAASA,CAAM,IAAKI,EAAM,KAAK,cAAc,EAAGC,EAAM,KAAKL,CAAM,GAC7GC,IAAQG,EAAM,KAAK,kBAAkB,EAAGC,EAAM,KAAKJ,CAAI,GACvDC,IAAYE,EAAM,KAAK,mBAAmB,EAAGC,EAAM,KAAKH,CAAQ,GAChEC,IAAUC,EAAM,KAAK,iBAAiB,EAAGC,EAAM,KAAKF,CAAM,GAC9D,IAAMG,EAAWF,EAAM,OAAS,SAASA,EAAM,KAAK,OAAO,CAAC,GAAK,GAC3DG,EAAW,MAAM3B,EAAI,SAAS,QAAQ,iDAAiD0B,CAAQ,EAAE,EAAE,KAAK,GAAGD,CAAK,EAAE,MAAM,EACxHG,EAAQ,OAAOD,GAAU,OAAS,CAAC,EAQnChB,IAPO,MAAMX,EAAI,SAAS,QAC/B;AAAA;AAAA,QAEG0B,CAAQ;AAAA;AAAA,uBAGZ,EAAE,KAAK,GAAGD,EAAOR,EAASC,CAAM,EAAE,IAAI,IAClB,SAAW,CAAC,GAAG,IAAIN,IAAM,CAC5C,QAAS,OAAOA,EAAE,QAAQ,EAC1B,KAAMA,EAAE,WACR,MAAOA,EAAE,WACT,IAAKA,EAAE,SACP,KAAMA,EAAE,KACR,OAAQ,OAAOA,EAAE,QAAU,CAAC,EAC5B,OAAQA,EAAE,QAAU,GACpB,OAAQA,EAAE,OACV,YAAaA,EAAE,YAChB,EAAE,EACIiB,EAAO,CAAE,UAAA3B,EAAW,KAAAc,EAAM,QAAAC,EAAS,MAAAW,EAAO,QAASV,EAASD,EAAUW,CAAM,EAClF,OAAOpB,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAG,EAAM,KAAAkB,CAAK,EAAGxB,CAAW,CACvF,OAASU,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAb,EAAW,KAAAE,EAAM,IAAI,OAAOW,CAAG,CAAE,CAAC,CAAC,EACjF,IAAMe,EAAO,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAA5B,CAAU,CAAE,EACpF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQ8B,EAAK,MAAQ,OAAOf,CAAG,GAC3DP,EAAa,IAAKsB,EAAMxB,EAAyBP,EAASC,CAAG,CAAC,CACtE,CAGD,GAAIO,IAAW,OAAQ,CACtB,IAAIuB,EACJ,GAAI,CAAEA,EAAO,MAAM/B,EAAQ,KAAK,CAAG,MAAY,CAC9C,OAAOS,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,uCAAU,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CAC7G,CACA,IAAM0B,EAAa,OAAOD,GAAM,YAAc,EAAE,EAAE,KAAK,EACjDE,EAAa,OAAOF,GAAM,YAAc,EAAE,EAAE,KAAK,EACjDG,EAAW,OAAOH,GAAM,UAAY,EAAE,EAAE,KAAK,EAC7CI,EAAO,OAAOJ,GAAM,MAAQ,KAAK,EAAE,KAAK,EACxCK,EAAS,OAAOL,GAAM,MAAM,EAC5BM,GAAUN,GAAM,QAAU,IAAI,KAAK,EACnCO,EAAS,CAAC,EAgBhB,GAfKN,GAAYM,EAAO,KAAK,CAAE,MAAM,aAAc,QAAQ,0BAAO,CAAC,EAC9D,sBAAsB,KAAKL,CAAU,GAAGK,EAAO,KAAK,CAAE,MAAM,aAAc,QAAQ,qCAAkB,CAAC,EACrG,sBAAsB,KAAKJ,CAAQ,GAAGI,EAAO,KAAK,CAAE,MAAM,WAAY,QAAQ,qCAAkB,CAAC,EAClGL,GAAcC,GAAYA,EAAWD,GAAYK,EAAO,KAAK,CAAE,MAAM,WAAY,QAAQ,0EAAe,CAAC,EACxG,CAAC,MAAM,OAAO,MAAM,EAAE,SAASH,CAAI,GAAGG,EAAO,KAAK,CAAE,MAAM,OAAQ,QAAQ,0BAAO,CAAC,GACnF,CAAC,OAAO,SAASF,CAAM,GAAKA,GAAU,IAAGE,EAAO,KAAK,CAAE,MAAM,SAAU,QAAQ,sBAAQ,CAAC,EAExFH,IAAS,QAAU,KAAK,IAAIC,EAAS,EAAI,KAAK,MAAMA,EAAS,CAAC,CAAC,EAAI,MACtEE,EAAO,KAAK,CAAE,MAAM,SAAU,QAAQ,iIAAmC,CAAC,EAEvED,EAAO,OAAS,KAAKC,EAAO,KAAK,CAAE,MAAM,SAAU,QAAQ,qCAAa,CAAC,EACzE,CAAC,YAAY,WAAW,EAAE,SAASN,CAAU,GAAK9B,EAAG,SAAW,KAAKoC,EAAO,KAAK,CAAE,MAAM,aAAc,QAAQ,4CAAU,CAAC,EAC1HN,IAAe,aAAe9B,EAAG,SAAW,KAAKoC,EAAO,KAAK,CAAE,MAAM,aAAc,QAAQ,4CAAU,CAAC,EAGtGN,IAAe,OAAQ,CAC1B,IAAMO,EAAcJ,IAAS,OAASC,GAAUD,IAAS,OAAS,EAAI,GAAKC,EAMrEI,IALa,MAAMvC,EAAI,SAAS,QACrC;AAAA;AAAA,kCAGD,EAAE,KAAK,OAAOC,EAAG,OAAO,CAAC,EAAE,IAAI,IACK,SAAW,CAAC,GAAG,OAAO,CAACuC,EAAKC,IAAMD,EAAM,OAAOC,EAAE,iBAAmB,CAAC,EAAG,CAAC,EACzGF,EAAiBD,GACpBD,EAAO,KAAK,CAAE,MAAM,SAAU,QAAQ,8CAAWE,CAAc,mCAAUD,CAAW,qBAAO,CAAC,CAE9F,CAEA,GAAID,EAAO,OAAQ,OAAO7B,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,2BAAQ,OAAA6B,EAAQ,KAAK,CAAE,UAAAnC,CAAU,CAAE,EAAGG,CAAW,EAE1I,GAAI,CAEH,MAAML,EAAI,SAAS,QAClB,4KACD,EAAE,KAAK,OAAOC,EAAG,OAAO,EAAG8B,EAAYC,EAAYC,EAAUC,EAAMC,EAAQC,CAAM,EAAE,IAAI,EACvF,IAAMM,EAAQ,MAAM1C,EAAI,SAAS,QAAQ,kCAAkC,EAAE,MAAM,EAC7E2C,EAAU,OAAOD,GAAO,EAAE,EAGhC,GAAIX,IAAe,OAAQ,CAC1B,IAAMO,EAAcJ,IAAS,OAASC,GAAUD,IAAS,OAAS,EAAI,GAAKC,EACrES,EAAa,MAAM5C,EAAI,SAAS,QACrC;AAAA;AAAA,mCAGD,EAAE,KAAK,OAAOC,EAAG,OAAO,CAAC,EAAE,IAAI,EAE3B4C,EAAYP,EAChB,QAAWQ,KAAUF,GAAY,SAAW,CAAC,EAAI,CAChD,GAAIC,GAAa,EAAG,MACpB,IAAME,EAAS,KAAK,IAAIF,EAAW,OAAOC,EAAM,iBAAmB,CAAC,CAAC,EAC/DE,EAAe,OAAOF,EAAM,iBAAmB,CAAC,EAAIC,EACpDE,GAAW,MAAMjD,EAAI,SAAS,QAAQ,mEAAmE,EAAE,KAAK8C,EAAM,QAAQ,EAAE,MAAM,IAAI,YAAc,EACxJI,EAAYF,GAAgB,EAAI,aAAe,SAErD,MAAMhD,EAAI,SAAS,QAClB;AAAA;AAAA,2BAGD,EAAE,KAAK,OAAOiD,CAAO,EAAIF,EAAQC,EAAcE,EAAWJ,EAAM,QAAQ,EAAE,IAAI,EAE9ED,GAAaE,CACd,CACD,CAEA,OAAOvC,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,UAAW,QAAQ,iCAAS,KAAK,CAAE,QAAAmC,CAAQ,EAAG,KAAK,CAAE,UAAAzC,CAAU,CAAE,EAAGG,CAAW,CACzH,OAASU,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAb,EAAW,KAAAE,EAAM,IAAI,OAAOW,CAAG,CAAE,CAAC,CAAC,EAC1EP,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CAC/G,CACD,CACD,CAGA,GAAID,IAAS,uCAAyCG,IAAW,OAAQ,CACxE,GAAI,CAACN,GAAI,SACR,OAAOO,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,2BAAQ,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EAGzG,IAAIyB,EACJ,GAAI,CAAEA,EAAO,MAAM/B,EAAQ,KAAK,CAAG,MAAY,CAC9C,OAAOS,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,uCAAU,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CAC7G,CAEA,IAAM8C,EAAU,OAAOrB,GAAM,UAAY,EAAE,EAAE,KAAK,EAClD,GAAIqB,IAAY,oBACf,OAAO3C,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,4CAAe,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EAGlH,GAAI,CAEH,IAAM+C,EAAM,IAAI,KACVC,EAAY,IAAI,KAAK,KAAK,IAAID,EAAI,eAAe,EAAGA,EAAI,YAAY,EAAI,EAAG,CAAC,CAAC,EAC7EE,EAAqB,IAAI,KAAK,KAAK,IAAID,EAAU,eAAe,EAAGA,EAAU,YAAY,EAAI,EAAG,CAAC,CAAC,EAClGE,EAAa,GAAGD,EAAmB,eAAe,CAAC,IAAI,OAAOA,EAAmB,YAAY,EAAI,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,IAAI,OAAOA,EAAmB,WAAW,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,GAChLE,EAAe,GAAGJ,EAAI,eAAe,CAAC,IAAI,OAAOA,EAAI,YAAY,EAAI,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,GAGxFK,EAAgB,MAAMzD,EAAI,SAAS,QACxC;AAAA;AAAA;AAAA,+EAID,EAAE,KAAKuD,CAAU,EAAE,IAAI,EAEnBG,EAAiB,EACfC,EAAW,CAAC,EAElB,QAAWb,KAAUW,GAAe,SAAW,CAAC,EAAI,CAEnD,IAAMG,EADa,OAAOd,EAAM,aAAe,CAAC,EAChB,IAC1Be,EAAQ,OAAOf,EAAM,iBAAmB,CAAC,EACzCgB,EAAO,OAAOhB,EAAM,eAAiB,CAAC,EACtCiB,EAAc,KAAK,MAAMF,EAAQD,EAAaE,EAAO,GAAG,EAG9D,MAAM9D,EAAI,SAAS,QAClB;AAAA;AAAA,6BAGD,EAAE,KACD,OAAO8C,EAAM,OAAO,EACpBU,EACAK,EACAE,EACA,KAAK,UAAU,CAACjB,EAAM,QAAQ,CAAC,CAChC,EAAE,IAAI,EAGN,MAAM9C,EAAI,SAAS,QAClB,0EACD,EAAE,KAAK8C,EAAM,QAAQ,EAAE,IAAI,EAE3Ba,EAAS,KAAKb,EAAM,QAAQ,EAC5BY,GACD,CAGA,aAAM1D,EAAI,SAAS,QAClB;AAAA;AAAA,+CAGD,EAAE,KAAKmD,EAAS,KAAK,UAAU,CAC9B,WAAAI,EACA,eAAAG,EACA,SAAAC,EACA,aAAAH,CACD,CAAC,CAAC,EAAE,IAAI,EAEDhD,EAAa,IAAK,CACxB,GAAG,GACH,KAAK,UACL,QAAQ,sBAAOkD,CAAc,kCAC7B,KAAK,CACJ,eAAAA,EACA,WAAAH,EACA,aAAAC,CACD,EACA,KAAK,CAAE,UAAAtD,CAAU,CAClB,EAAGG,CAAW,CAEf,OAASU,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAb,EAAW,KAAAE,EAAM,IAAI,OAAOW,CAAG,CAAE,CAAC,CAAC,EAGjF,GAAI,CACH,MAAMf,EAAI,SAAS,QAClB;AAAA;AAAA,+CAGD,EAAE,KAAKmD,EAAS,OAAOpC,CAAG,CAAC,EAAE,IAAI,CAClC,MAAY,CAAC,CAEb,OAAOP,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CAC/G,CACD,CAGA,GAAID,IAAS,uCAAyCG,IAAW,MAAO,CACvE,GAAI,CAACN,GAAI,SACR,OAAOO,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,2BAAQ,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EAGzG,GAAI,CACH,IAAMI,EAASN,EAAI,aACbgD,EAAU1C,EAAO,IAAI,UAAU,GAAK,GACpCO,EAAO,KAAK,IAAI,EAAG,SAASP,EAAO,IAAI,MAAM,GAAK,IAAK,EAAE,CAAC,EAC1DQ,EAAU,KAAK,IAAI,IAAK,KAAK,IAAI,EAAG,SAASR,EAAO,IAAI,SAAS,GAAK,KAAM,EAAE,CAAC,CAAC,EAChFS,GAAUF,EAAO,GAAKC,EAEtBS,EAAWyB,EAAU,qBAAuB,GAC5C1B,EAAQ0B,EAAU,CAACA,CAAO,EAAI,CAAC,EAE/Ba,EAAW,MAAMhE,EAAI,SAAS,QACnC,mDAAmD0B,CAAQ,EAC5D,EAAE,KAAK,GAAGD,CAAK,EAAE,MAAM,EAQjBd,IANO,MAAMX,EAAI,SAAS,QAC/B;AAAA,8BAC0B0B,CAAQ;AAAA,gDAEnC,EAAE,KAAK,GAAGD,EAAOR,EAASC,CAAM,EAAE,IAAI,IAElB,SAAW,CAAC,GAAG,IAAIN,IAAM,CAC5C,GAAIA,EAAE,aACN,QAASA,EAAE,SACX,OAAQA,EAAE,OACV,WAAYA,EAAE,YACd,QAASA,EAAE,QAAU,KAAK,MAAMA,EAAE,OAAO,EAAI,KAC7C,aAAcA,EAAE,aACjB,EAAE,EAEF,OAAOJ,EAAa,IAAK,CACxB,GAAG,GACH,KAAK,KACL,QAAQ,eACR,KAAAG,EACA,KAAK,CACJ,UAAAT,EACA,KAAAc,EACA,QAAAC,EACA,MAAO,OAAO+C,GAAU,OAAS,CAAC,CACnC,CACD,EAAG3D,CAAW,CAEf,OAASU,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAb,EAAW,KAAAE,EAAM,IAAI,OAAOW,CAAG,CAAE,CAAC,CAAC,EAC1EP,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CAC/G,CACD,CAEA,OAAOG,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CACnH,CAxUsB4D,EAAAnE,GAAA,gBCAtB,eAAsBoE,GAAiBC,EAASC,EAAKC,EAAWC,EAAM,CAErE,GAAIF,EAAI,UAAY,OACnB,OAAOG,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,qBAAO,KAAK,CAAE,UAAAF,CAAU,CAAE,CAAC,EAE3F,IAAMG,EAAcC,EAAyBN,EAASC,CAAG,EAGzD,GAAIE,IAAS,0CAA2C,CACvD,IAAMI,EAAa,OAAON,EAAI,qBAAuB,SAAS,EACxDO,EAAMC,EAAUT,EAASO,CAAU,EACrCG,EAAS,KAAUC,EAAM,KAC7B,GAAIH,GAAOP,EAAI,SAAU,CACxB,IAAMW,EAAM,MAAMX,EAAI,SAAS,QAAQ,0DAA0D,EAAE,KAAKO,CAAG,EAAE,MAAM,EACnHE,EAAS,CAAC,CAACE,EACXD,EAAMC,GAAK,YAAc,IAC1B,CACA,OAAOR,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAK,CAAE,WAAAG,EAAY,IAAAC,EAAK,OAAAE,EAAQ,IAAAC,CAAI,EAAG,KAAK,CAAE,UAAAT,CAAU,CAAE,EAAGG,CAAW,CACtI,CAEA,GAAIL,EAAQ,OAAO,YAAY,IAAM,OACpC,OAAOI,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAF,CAAU,CAAE,EAAGG,CAAW,EAInH,GAAIF,IAAS,uCAAwC,CACpD,IAAIU,EAAM,GAAI,CAAEA,EAAO,MAAMb,EAAQ,KAAK,CAAG,MAAY,CAAE,OAAOI,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,uCAAU,KAAK,CAAE,UAAAF,CAAU,CAAE,EAAGG,CAAW,CAAG,CAC1K,IAAMS,GAAYD,GAAM,UAAY,IAAI,KAAK,EAAE,YAAY,EACrDE,GAAQF,GAAM,MAAQ,4BAAQ,KAAK,EACnCG,EAAWH,GAAM,UAAY,WAC/BI,GAASJ,GAAM,OAAS,IAAI,KAAK,EACrC,GAAI,CAACC,GAAY,CAACE,EACjB,OAAOZ,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,iCAAwB,KAAK,CAAE,UAAAF,CAAU,CAAE,EAAGG,CAAW,EAEhI,GAAI,CACH,IAAMK,EAAS,MAAMT,EAAI,SAAS,QAAQ,6DAA6D,EAAE,KAAKa,CAAQ,EAAE,MAAM,EACzHG,IAAOA,EAAQ,GAAGH,CAAQ,gBAC/B,IAAMI,EAAe,MAAMC,GAAmBH,CAAQ,EACtD,OAAIN,EACH,MAAMT,EAAI,SAAS,QAAQ,yGAAyG,EAAE,KAAKa,EAAUC,EAAME,EAAOC,EAAc,IAAI,KAAK,EAAE,YAAY,EAAGR,EAAO,OAAO,EAAE,IAAI,EAE9N,MAAMT,EAAI,SAAS,QAAQ,8KAA8K,EAAE,KAAKa,EAAUI,EAAcH,EAAME,CAAK,EAAE,IAAI,EAEnPb,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,0DAAc,KAAK,CAAE,SAAAU,EAAU,MAAAG,CAAM,EAAG,KAAK,CAAE,UAAAf,CAAU,CAAE,EAAGG,CAAW,CACjI,OAASe,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAlB,EAAW,KAAAC,EAAM,IAAI,OAAOiB,CAAG,CAAE,CAAC,CAAC,EACjF,IAAMP,EAAO,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAX,CAAU,CAAE,EACpF,OAAID,EAAI,SAAWA,EAAI,UAAY,SAAQY,EAAK,MAAQ,OAAOO,CAAG,GAC3DhB,EAAa,IAAKS,EAAMR,CAAW,CAC3C,CACD,CAGA,GAAIF,IAAS,0CACZ,GAAI,CACH,MAAMF,EAAI,SAAS,QAAQ,yHAA+G,EAAE,IAAI,EAChJ,IAAMoB,EAAM,IAAI,KAAK,EAAE,YAAY,EACnC,aAAMpB,EAAI,SAAS,QAClB,2eAID,EAAE,KAAKoB,EAAKA,EAAKA,EAAKA,EAAKA,EAAKA,CAAG,EAAE,IAAI,EACzC,MAAMpB,EAAI,SAAS,QAAQ,sHAAsH,EAAE,IAAI,EAChJG,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,0DAAc,KAAK,CAAE,UAAAF,CAAU,CAAE,EAAGG,CAAW,CACvG,OAASe,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAlB,EAAW,KAAAC,EAAM,IAAK,OAAOiB,CAAG,CAAE,CAAC,CAAC,EACnF,IAAMP,EAAO,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAX,CAAU,CAAE,EACpF,OAAID,EAAI,SAAWA,EAAI,UAAY,SAAQY,EAAK,MAAQ,OAAOO,CAAG,GAC3DhB,EAAa,IAAKS,CAAI,CAC9B,CAID,GAAIV,IAAS,wCACZ,GAAI,CACH,MAAMF,EAAI,SAAS,QAAQ,2IAA2I,EAAE,IAAI,EAC5K,IAAMqB,EAAM,MAAMrB,EAAI,SAAS,QAAQ,8EAA8E,EAAE,MAAM,EACvHsB,EAAM,MAAMtB,EAAI,SAAS,QAAQ,8EAA8E,EAAE,MAAM,EACvHuB,EAAM,MAAMvB,EAAI,SAAS,QAAQ,8EAA8E,EAAE,MAAM,EACvHwB,EAAQ,IAAI,KACZC,EAAMC,EAACC,GAAK,IAAI,KAAKH,EAAM,QAAQ,EAAEG,EAAE,KAAQ,EAAE,YAAY,EAAE,MAAM,EAAE,EAAE,EAAnE,OACZ,aAAM3B,EAAI,SAAS,QAAQ,2IAA2I,EAAE,KAAKqB,EAAI,kBAAmB,wDAAiBI,EAAI,CAAC,EAAG,UAAW,CAAC,EAAE,IAAI,EAC/O,MAAMzB,EAAI,SAAS,QAAQ,2IAA2I,EAAE,KAAKsB,EAAI,kBAAmB,kDAAgBG,EAAI,EAAE,EAAG,cAAe,CAAC,EAAE,IAAI,EACnP,MAAMzB,EAAI,SAAS,QAAQ,2IAA2I,EAAE,KAAKuB,EAAI,kBAAmB,+CAAaE,EAAI,EAAE,EAAG,YAAa,CAAC,EAAE,IAAI,EACvOtB,EAAa,IAAK,CAAE,GAAI,GAAM,KAAM,KAAM,QAAS,6CAAW,KAAM,CAAE,UAAAF,CAAU,CAAE,CAAC,CAC3F,OAASkB,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAlB,EAAW,KAAAC,EAAM,IAAK,OAAOiB,CAAG,CAAE,CAAC,CAAC,EACnF,IAAMP,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAX,CAAU,CAAE,EACxF,OAAID,EAAI,SAAWA,EAAI,UAAY,SAAQY,EAAK,MAAQ,OAAOO,CAAG,GAC3DhB,EAAa,IAAKS,CAAI,CAC9B,CAID,GAAIV,IAAS,6CACZ,GAAI,CACH,IAAMsB,EAAQ,IAAI,KACZG,EAAID,EAACE,GAAO,IAAI,KAAKJ,EAAM,QAAQ,EAAEI,EAAI,KAAQ,EAAE,YAAY,EAAE,MAAM,EAAE,EAAE,EAAvE,KACV,aAAM5B,EAAI,SAAS,QAClB,gSAID,EAAE,KAAK2B,EAAE,EAAE,EAAGA,EAAE,EAAE,EAAGA,EAAE,CAAC,CAAC,EAAE,IAAI,EACxBxB,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,6CAAW,KAAK,CAAE,UAAAF,CAAU,CAAE,CAAC,CACvF,OAASkB,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAlB,EAAW,KAAAC,EAAM,IAAI,OAAOiB,CAAG,CAAE,CAAC,CAAC,EAC1EhB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAF,CAAU,CAAE,CAAC,CAClG,CAID,GAAIC,IAAS,yCACZ,GAAI,CACH,IAAM2B,EAAI,IAAI,KAAK,EAAE,YAAY,EACjC,aAAM7B,EAAI,SAAS,QAClB,0NAID,EAAE,KAAK6B,EAAGA,EAAGA,CAAC,EAAE,IAAI,EACpB,MAAM7B,EAAI,SAAS,QAClB,+dAID,EAAE,IAAI,EACCG,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,2EAAgB,KAAK,CAAE,UAAAF,EAAW,KAAK4B,CAAE,CAAE,CAAC,CACpG,OAASV,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAlB,EAAW,KAAAC,EAAM,IAAI,OAAOiB,CAAG,CAAE,CAAC,CAAC,EAC1EhB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAF,CAAU,CAAE,CAAC,CAClG,CAID,GAAIC,IAAS,2CACZ,GAAI,CACH,aAAMF,EAAI,SAAS,QAClB,oVAID,EAAE,IAAI,EACCG,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,6CAAW,KAAK,CAAE,UAAAF,CAAU,CAAE,CAAC,CACvF,OAASkB,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAlB,EAAW,KAAAC,EAAM,IAAI,OAAOiB,CAAG,CAAE,CAAC,CAAC,EAC1EhB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAF,CAAU,CAAE,CAAC,CAClG,CAGD,OAAOE,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,qBAAO,KAAK,CAAE,UAAAF,CAAU,CAAE,EAAGG,CAAW,CACxG,CAxJsBsB,EAAA5B,GAAA,oBCAtB,eAAsBgC,GAAeC,EAASC,EAAKC,EAAIC,EAAWC,EAAKC,EAAM,CAC5E,IAAMC,EAAcC,EAAyBP,EAASC,CAAG,EACnDO,EAASR,EAAQ,OAAO,YAAY,EAE1C,GAAIK,IAAS,wCAAyC,CACrD,GAAIG,IAAW,MACd,GAAI,CACH,IAAMC,EAASL,EAAI,aACbM,EAAO,KAAK,IAAI,EAAG,SAASD,EAAO,IAAI,MAAM,GAAK,IAAK,EAAE,CAAC,EAC1DE,EAAU,KAAK,IAAI,IAAK,KAAK,IAAI,EAAG,SAASF,EAAO,IAAI,SAAS,GAAK,KAAM,EAAE,CAAC,CAAC,EAChFG,GAAUF,EAAO,GAAKC,EACtBE,GAAKJ,EAAO,IAAI,GAAG,GAAK,IAAI,KAAK,EACjCK,GAAYL,EAAO,IAAI,UAAU,GAAK,IAAI,KAAK,EAC/CM,EAAWN,EAAO,IAAI,WAAW,EACjCO,EAAQ,CAAC,EACTC,EAAQ,CAAC,EACXJ,IAAKG,EAAM,KAAK,wCAAwC,EAAGC,EAAM,KAAK,IAAIJ,CAAC,IAAK,IAAIA,CAAC,GAAG,GACxFC,GAAY,CAAC,QAAQ,UAAU,EAAE,SAASA,CAAQ,IAAKE,EAAM,KAAK,cAAc,EAAGC,EAAM,KAAKH,CAAQ,IACtGC,IAAa,KAAOA,IAAa,OAAOC,EAAM,KAAK,eAAe,EAAGC,EAAM,KAAK,SAASF,EAAS,EAAE,CAAC,GACzG,IAAMG,EAAWF,EAAM,OAAS,SAASA,EAAM,KAAK,OAAO,CAAC,GAAK,GAC3DG,EAAW,MAAMlB,EAAI,SAAS,QAAQ,mDAAmDiB,CAAQ,EAAE,EAAE,KAAK,GAAGD,CAAK,EAAE,MAAM,EAC1HG,EAAQ,OAAOD,GAAU,OAAS,CAAC,EAQnCE,IAPO,MAAMpB,EAAI,SAAS,QAC/B;AAAA;AAAA,QAEGiB,CAAQ;AAAA;AAAA,uBAGZ,EAAE,KAAK,GAAGD,EAAON,EAASC,CAAM,EAAE,IAAI,IAClB,SAAW,CAAC,GAAG,IAAIU,IAAM,CAC5C,GAAIA,EAAE,aACN,KAAMA,EAAE,UACR,KAAMA,EAAE,UACR,SAAUA,EAAE,SACZ,iBAAkBA,EAAE,kBACpB,YAAaA,EAAE,aAAe,GAC9B,SAAUA,EAAE,YAAc,EAC1B,aAAc,OAAOA,EAAE,eAAiB,CAAC,EACzC,UAAWA,EAAE,WACb,UAAWA,EAAE,UACd,EAAE,EACF,OAAOC,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAF,EAAM,KAAK,CAAE,UAAAlB,EAAW,KAAAO,EAAM,QAAAC,EAAS,MAAAS,CAAM,CAAE,EAAGd,CAAW,CAC3H,OAASkB,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAArB,EAAW,KAAAE,EAAM,IAAI,OAAOmB,CAAG,CAAE,CAAC,CAAC,EAC1ED,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGG,CAAW,CAC/G,CAED,GAAIE,IAAW,OAAQ,CACtB,IAAIiB,EAAM,GAAI,CAAEA,EAAO,MAAMzB,EAAQ,KAAK,CAAG,MAAY,CAAE,OAAOuB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,uCAAU,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGG,CAAW,CAAG,CAC1K,IAAMoB,EAAO,OAAOD,GAAM,WAAaA,GAAM,MAAQ,EAAE,EAAE,KAAK,EACxDE,EAAO,OAAOF,GAAM,WAAaA,GAAM,MAAQ,EAAE,EAAE,KAAK,EACxDX,EAAW,OAAOW,GAAM,UAAY,EAAE,EAAE,KAAK,EAC7CG,EAAY,OAAOH,GAAM,mBAAqBA,GAAM,kBAAoB,EAAE,EAAE,KAAK,EACjFI,GAAeJ,GAAM,aAAe,IAAI,KAAK,EAC7CK,EAAS,CAAC,EAKhB,GAJK,oBAAoB,KAAKJ,CAAI,GAAGI,EAAO,KAAK,CAAE,MAAM,YAAa,QAAQ,gDAAmB,CAAC,GAC9F,CAACH,GAAQA,EAAK,OAAS,KAAIG,EAAO,KAAK,CAAE,MAAM,YAAa,QAAQ,8BAAW,CAAC,EAC/E,CAAC,QAAQ,UAAU,EAAE,SAAShB,CAAQ,GAAGgB,EAAO,KAAK,CAAE,MAAM,WAAY,QAAQ,oBAAM,CAAC,EACxF,CAAC,eAAe,WAAW,aAAa,EAAE,SAASF,CAAS,GAAGE,EAAO,KAAK,CAAE,MAAM,oBAAqB,QAAQ,oBAAM,CAAC,EACxHA,EAAO,OAAQ,OAAOP,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,2BAAQ,OAAAO,EAAQ,KAAK,CAAE,UAAA3B,CAAU,CAAE,EAAGG,CAAW,EAC1I,GAAI,CACH,MAAML,EAAI,SAAS,QAClB,qIACD,EAAE,KAAKyB,EAAMC,EAAMb,EAAUc,EAAWC,CAAW,EAAE,IAAI,EACzD,IAAME,EAAM,MAAM9B,EAAI,SAAS,QAAQ,gEAAgE,EAAE,KAAKyB,CAAI,EAAE,MAAM,EAC1H,OAAOH,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,UAAW,QAAQ,qBAAO,KAAK,CAAE,GAAIQ,GAAK,aAAc,KAAAL,EAAM,KAAAC,EAAM,SAAAb,EAAU,iBAAkBc,CAAU,EAAG,KAAK,CAAE,UAAAzB,CAAU,CAAE,EAAGG,CAAW,CACxL,OAASkB,EAAK,CACb,IAAMQ,EAAM,OAAOR,GAAO,EAAE,EAC5B,OAAIQ,EAAI,SAAS,QAAQ,GAAKA,EAAI,SAAS,WAAW,EAC9CT,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,WAAY,QAAQ,iCAAS,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGG,CAAW,GAEzG,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAH,EAAW,KAAAE,EAAM,IAAI,OAAOmB,CAAG,CAAE,CAAC,CAAC,EAC1ED,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGG,CAAW,EAC/G,CACD,CACD,CAEA,GAAID,IAAS,wCAAyC,CACrD,GAAIG,IAAW,MACd,GAAI,CACH,IAAMC,EAASL,EAAI,aACb6B,EAAO,SAASxB,EAAO,IAAI,MAAM,GAAK,IAAK,EAAE,EAC7CyB,EAAQ,SAASzB,EAAO,IAAI,OAAO,GAAK,IAAK,EAAE,EACrD,GAAI,CAAC,OAAO,SAASwB,CAAI,GAAKA,EAAO,KAAQC,EAAQ,GAAKA,EAAQ,GACjE,OAAOX,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,gCAAkB,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGG,CAAW,EAE1H,IAAMO,GAAKJ,EAAO,IAAI,GAAG,GAAK,IAAI,KAAK,EACjCO,EAAQ,CAAC,mBAAoB,aAAc,aAAa,EACxDC,EAAQ,CAACgB,EAAMC,CAAK,EACtBrB,IAAKG,EAAM,KAAK,8DAA8D,EAAGC,EAAM,KAAK,IAAIJ,CAAC,IAAK,IAAIA,CAAC,IAAK,IAAIA,CAAC,GAAG,GAC5H,IAAMK,EAAW,SAASF,EAAM,KAAK,OAAO,CAAC,GAQvCmB,IAPO,MAAMlC,EAAI,SAAS,QAC/B;AAAA;AAAA;AAAA,QAGGiB,CAAQ;AAAA,oDAEZ,EAAE,KAAK,GAAGD,CAAK,EAAE,IAAI,IACA,SAAW,CAAC,GAAG,IAAIK,IAAM,CAC7C,GAAIA,EAAE,YACN,WAAYA,EAAE,aACd,SAAUA,EAAE,UACZ,SAAUA,EAAE,UACZ,SAAUA,EAAE,SACZ,iBAAkBA,EAAE,kBACpB,OAAQ,OAAOA,EAAE,QAAU,CAAC,EAC5B,MAAOA,EAAE,OAAS,GAClB,WAAYA,EAAE,YACd,WAAYA,EAAE,YACd,UAAWA,EAAE,UACd,EAAE,EACIF,EAAQe,EAAM,OAAO,CAACC,EAAGC,IAAMD,EAAIC,EAAE,OAAQ,CAAC,EAC9CC,EAAaH,EAAM,OAAOE,GAAKA,EAAE,WAAa,OAAO,EAAE,OAAO,CAACD,EAAGC,IAAMD,EAAIC,EAAE,OAAQ,CAAC,EACvFE,EAAgBnB,EAAQkB,EAC9B,OAAOf,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAK,CAAE,KAAAU,EAAM,MAAAC,EAAO,MAAAC,EAAO,MAAAf,EAAO,WAAAkB,EAAY,cAAAC,CAAc,EAAG,KAAK,CAAE,UAAApC,EAAW,MAAOgC,EAAM,MAAO,CAAE,EAAG7B,CAAW,CACnL,OAASkB,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAArB,EAAW,KAAAE,EAAM,IAAI,OAAOmB,CAAG,CAAE,CAAC,CAAC,EAC1ED,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGG,CAAW,CAC/G,CAED,GAAIE,IAAW,OAAQ,CACtB,IAAIiB,EAAM,GAAI,CAAEA,EAAO,MAAMzB,EAAQ,KAAK,CAAG,MAAY,CAAE,OAAOuB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,uCAAU,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGG,CAAW,CAAG,CAC1K,IAAMkC,EAAe,SAASf,GAAM,aAAc,EAAE,EAC9CQ,EAAO,SAASR,GAAM,KAAM,EAAE,EAC9BS,EAAQ,SAAST,GAAM,MAAO,EAAE,EAChCgB,EAAS,OAAOhB,GAAM,MAAM,EAC5BiB,GAASjB,GAAM,OAAS,IAAI,KAAK,EACjCK,EAAS,CAAC,EAKhB,GAJK,OAAO,SAASU,CAAY,GAAGV,EAAO,KAAK,CAAE,MAAM,eAAgB,QAAQ,cAAK,CAAC,GAClF,CAAC,OAAO,SAASG,CAAI,GAAKA,EAAO,MAAMH,EAAO,KAAK,CAAE,MAAM,OAAQ,QAAQ,oBAAM,CAAC,GAClF,CAAC,OAAO,SAASI,CAAK,GAAKA,EAAQ,GAAKA,EAAQ,KAAIJ,EAAO,KAAK,CAAE,MAAM,QAAS,QAAQ,oBAAM,CAAC,GAChG,CAAC,OAAO,SAASW,CAAM,GAAKA,GAAU,GAAKA,EAAS,MAAKX,EAAO,KAAK,CAAE,MAAM,SAAU,QAAQ,4BAAc,CAAC,EAC9GA,EAAO,OAAQ,OAAOP,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,2BAAQ,OAAAO,EAAQ,KAAK,CAAE,UAAA3B,CAAU,CAAE,EAAGG,CAAW,EAC1I,GAAI,CAEH,GAAI,CADM,MAAML,EAAI,SAAS,QAAQ,6FAA6F,EAAE,KAAKuC,CAAY,EAAE,MAAM,EACrJ,OAAOjB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,qEAAe,OAAO,CAAC,CAAE,MAAM,eAAgB,QAAQ,4CAAU,CAAC,EAAG,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGG,CAAW,EACpL,MAAML,EAAI,SAAS,QAClB,oHACD,EAAE,KAAKuC,EAAcP,EAAMC,EAAOO,EAAQC,EAAO,OAAOxC,EAAG,OAAO,CAAC,EAAE,IAAI,EACzE,IAAMyC,EAAQ,MAAM1C,EAAI,SAAS,QAAQ,kCAAkC,EAAE,MAAM,EACnF,OAAOsB,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,UAAW,QAAQ,qBAAO,KAAK,CAAE,GAAG,OAAOoB,GAAO,EAAE,CAAE,EAAG,KAAK,CAAE,UAAAxC,CAAU,CAAE,EAAGG,CAAW,CACpI,OAASkB,EAAK,CACb,IAAMQ,EAAM,OAAOR,GAAO,EAAE,EAC5B,OAAIQ,EAAI,SAAS,QAAQ,GAAKA,EAAI,SAAS,sBAAsB,EACzDT,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,WAAY,QAAQ,+DAAc,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGG,CAAW,GAE9G,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAH,EAAW,KAAAE,EAAM,IAAI,OAAOmB,CAAG,CAAE,CAAC,CAAC,EAC1ED,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGG,CAAW,EAC/G,CACD,CACD,CAEA,GAAID,IAAS,2CAA6CA,IAAS,2CAA4C,CAC9G,GAAIG,IAAW,MAAO,OAAOe,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGG,CAAW,EACxI,GAAI,CACH,IAAMG,EAASL,EAAI,aACb6B,EAAO,SAASxB,EAAO,IAAI,MAAM,GAAK,IAAK,EAAE,EAC7CyB,EAAQ,SAASzB,EAAO,IAAI,OAAO,GAAK,IAAK,EAAE,EACrD,GAAI,CAAC,OAAO,SAASwB,CAAI,GAAKA,EAAO,KAAQC,EAAQ,GAAKA,EAAQ,GACjE,OAAOX,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,gCAAkB,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGG,CAAW,EAQ1H,IAAMsC,GANO,MAAM3C,EAAI,SAAS,QAC/B;AAAA;AAAA;AAAA,sDAID,EAAE,KAAKgC,EAAMC,CAAK,EAAE,IAAI,IACL,SAAW,CAAC,EACzBd,EAAQwB,EAAK,OAAO,CAACR,EAAGd,IAAMc,EAAI,OAAOd,EAAE,KAAO,CAAC,EAAG,CAAC,EACvDuB,EAAa,CAAE,MAAO,EAAG,SAAU,CAAE,EAC3C,QAAWvB,KAAKsB,EAAQC,EAAWvB,EAAE,QAAQ,GAAKuB,EAAWvB,EAAE,QAAQ,GAAK,GAAK,OAAOA,EAAE,KAAO,CAAC,EAClG,IAAMwB,EAAgBF,EAAK,IAAItB,IAAM,CAAE,WAAYA,EAAE,aAAc,SAAUA,EAAE,UAAW,OAAQ,OAAOA,EAAE,KAAO,CAAC,EAAG,WAAYF,EAAQ,QAAQ,OAAOE,EAAE,KAAK,CAAC,EAAEF,EAAM,KAAK,QAAQ,CAAC,CAAC,EAAI,CAAE,EAAE,EAC1L2B,EAAS,MAAM9C,EAAI,SAAS,QAAQ,sDAAsD,EAAE,MAAM,EAClG+C,EAAgB,OAAOD,GAAQ,GAAK,CAAC,EACrCE,EAAsBD,EAAgB,KAAK,MAAM5B,EAAQ4B,CAAa,EAAI,EAEhF,OAAOzB,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KADhD,CAAE,KAAAU,EAAM,MAAAC,EAAO,eAAgBd,EAAO,eAAgB4B,EAAe,sBAAuBC,EAAqB,sBAAuBJ,EAAY,kBAAmBC,CAAc,EAC/H,KAAK,CAAE,UAAA3C,CAAU,CAAE,EAAGG,CAAW,CACrG,OAASkB,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAArB,EAAW,KAAAE,EAAM,IAAI,OAAOmB,CAAG,CAAE,CAAC,CAAC,EAC1ED,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGG,CAAW,CAC/G,CACD,CAEA,OAAOiB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,qBAAO,KAAK,CAAE,UAAApB,CAAU,CAAE,EAAGG,CAAW,CACxG,CAxLsB4C,EAAAnD,GAAA,kBCAtB,eAAsBoD,GAAcC,EAASC,EAAKC,EAAIC,EAAWC,EAAKC,EAAM,CAC3E,IAAMC,EAAcC,EAAyBP,EAASC,CAAG,EACnDO,EAASR,EAAQ,OAAO,YAAY,EAEpCS,EAAYC,EAACC,GAAM,CAGxB,GAFI,CAACA,GAAK,OAAOA,GAAM,UAEnB,CADMA,EAAE,MAAM,qBAAqB,EAC/B,OAAO,KACf,IAAMC,EAAI,IAAI,KAAKD,CAAC,EACpB,OAAO,OAAO,MAAMC,EAAE,QAAQ,CAAC,EAAI,KAAOD,CAC3C,EANkB,aAQZE,EAAiBH,EAACC,GAAM,CAC7B,GAAI,CAACA,GAAK,OAAOA,GAAM,SAAU,OAAO,KACxC,IAAMG,EAAIH,EAAE,MAAM,mBAAmB,EACrC,GAAI,CAACG,EAAG,OAAO,KACf,IAAMC,EAAI,SAASD,EAAE,CAAC,EAAG,EAAE,EACrBE,EAAK,SAASF,EAAE,CAAC,EAAG,EAAE,EAC5B,MAAI,CAAC,OAAO,SAASC,CAAC,GAAK,CAAC,OAAO,SAASC,CAAE,GAAKA,EAAK,GAAKA,EAAK,GAAW,KACtE,CAAE,KAAMD,EAAG,MAAOC,CAAG,CAC7B,EARuB,kBAWvB,GAAIX,IAAS,gDAAiD,CAC7D,GAAIG,IAAW,MAAO,OAAOS,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,EACxI,GAAI,CAACJ,EAAG,SAAU,OAAOe,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,2BAAQ,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,EAC1H,GAAI,CACH,IAAMY,EAAId,EAAI,aACRe,EAAQV,EAAUS,EAAE,IAAI,YAAY,CAAC,EACrCE,EAAMX,EAAUS,EAAE,IAAI,UAAU,CAAC,EACjCG,GAAYH,EAAE,IAAI,WAAW,GAAK,IAAI,KAAK,GAAK,KAChDI,GAAgBJ,EAAE,IAAI,wBAAwB,GAAK,IAAI,YAAY,IAAM,OAC/E,GAAI,CAACC,GAAS,CAACC,GAAOD,EAAQC,EAC7B,OAAOH,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,yDAAa,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,EAIrH,IAAMiB,EAAQ,CAACJ,EAAOC,CAAG,EACrBI,EAAQ,6DACRH,IAAYG,GAAS,uBAAwBD,EAAM,KAAKF,CAAQ,GACpE,IAAMI,EAAY,MAAMxB,EAAI,SAAS,QACpC;AAAA;AAAA,aAESuB,CAAK;AAAA,0BAEf,EAAE,KAAK,GAAGD,CAAK,EAAE,IAAI,EACfG,EAAgB,IAAI,IAC1B,QAAWC,KAAMF,GAAW,SAAW,CAAC,EAClCE,EAAE,WACPD,EAAc,IAAIC,EAAE,UAAW,OAAOA,EAAE,cAAgB,CAAC,CAAC,EAE3D,IAAMC,EAAY,MAAM,KAAKF,EAAc,KAAK,CAAC,EAG3CG,EAAW,CAACV,EAAOC,CAAG,EACxBU,EAAW,uFACXT,IAAYS,GAAY,qBAAsBD,EAAS,KAAKR,CAAQ,GACxE,IAAMU,EAAU,MAAM9B,EAAI,SAAS,QAClC;AAAA;AAAA,aAES6B,CAAQ;AAAA,wBAElB,EAAE,KAAK,GAAGD,CAAQ,EAAE,IAAI,EAClBG,EAAkB,IAAI,IAC5B,QAAWL,KAAMI,GAAS,SAAW,CAAC,EACrCC,EAAgB,IAAIL,EAAE,UAAW,OAAOA,EAAE,gBAAkB,CAAC,CAAC,EACzDD,EAAc,IAAIC,EAAE,SAAS,GAAGC,EAAU,KAAKD,EAAE,SAAS,EAIhE,IAAMM,EAAU,SAASd,EAAM,MAAM,EAAE,CAAC,EAAIA,EAAM,MAAM,EAAE,CAAC,EAAG,EAAE,EAC1De,EAAQ,SAASd,EAAI,MAAM,EAAE,CAAC,EAAIA,EAAI,MAAM,EAAE,CAAC,EAAG,EAAE,EAOpDe,IANS,MAAMlC,EAAI,SAAS,QACjC;AAAA;AAAA;AAAA,iBAID,EAAE,KAAKgC,EAASC,CAAK,EAAE,IAAI,IACI,SAAW,CAAC,GAAG,OAAO,CAACvB,EAAGgB,IAAMhB,EAAI,OAAOgB,EAAE,KAAO,CAAC,EAAG,CAAC,EAGlFS,EAAa,MAAM,KAAKV,EAAc,OAAO,CAAC,EAAE,OAAO,CAACf,EAAG0B,IAAM1B,EAAI0B,EAAG,CAAC,EACzEC,EAAW,CAAC,EACdH,GAAiB,GAAGG,EAAS,KAAK,CAAE,KAAM,mBAAoB,QAAS,8DAAa,CAAC,EAGzF,IAAMC,EAAU,IAAI,IACpB,GAAIX,EAAU,OAAQ,CACrB,IAAMY,EAAeZ,EAAU,IAAI,IAAM,GAAG,EAAE,KAAK,GAAG,EAChDa,EAAW,MAAMxC,EAAI,SAAS,QACnC,mEAAmEuC,CAAY,GAChF,EAAE,KAAK,GAAGZ,CAAS,EAAE,IAAI,EACzB,QAAWD,KAAMc,GAAU,SAAW,CAAC,EAAIF,EAAQ,IAAIZ,EAAE,UAAWA,EAAE,YAAY,CACnF,CAEA,IAAMe,EAAO,CAAC,EACd,QAAWC,KAAOf,EAAW,CAC5B,IAAMgB,EAAS,OAAOlB,EAAc,IAAIiB,CAAG,GAAK,CAAC,EAC3CE,EAAWD,EACXE,EAAU,OAAOd,EAAgB,IAAIW,CAAG,GAAK,CAAC,EAC9CI,EAAUX,EAAa,EAAI,KAAK,MAAMD,GAAiBS,EAASR,EAAW,EAAI,EAC/EY,EAAa,EACbC,EAA4B,EAC5BC,EAAYF,EAAaD,EAAUE,EACnCE,EAAcL,EAAUI,EACxBE,EAASN,EAAU,EAAI,QAASK,EAAcL,EAAW,KAAK,QAAQ,CAAC,CAAC,EAAI,EAClFJ,EAAK,KAAK,CACT,UAAWC,EACX,aAAcJ,EAAQ,IAAII,CAAG,GAAKA,EAClC,mBAAoB,OAAOC,EAAO,QAAQ,CAAC,CAAC,EAC5C,qBAAsB,OAAOC,EAAS,QAAQ,CAAC,CAAC,EAChD,eAAgB,CACf,YAAaG,EACb,cAAeD,EACf,eAAgBE,EAChB,WAAYC,CACb,EACA,WAAYA,EACZ,QAAAJ,EACA,aAAcK,EACd,cAAeC,EACf,gBAAiBF,EAAY,EAAI,CAAE,OAAQ,QAASF,EAAWE,EAAW,KAAK,QAAQ,CAAC,CAAC,EAAG,SAAU,QAAUH,EAAUG,EAAY,KAAK,QAAQ,CAAC,CAAC,CAAE,EAAI,CAAE,OAAQ,EAAG,SAAU,CAAE,EACpL,eAAgB,CAAC,CAClB,CAAC,CACF,CAEA,OAAOjC,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAyB,EAAM,SAAAJ,EAAU,KAAK,CAAE,UAAAnC,CAAU,CAAE,EAAGG,CAAW,CAC/G,OAAS+C,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAlD,EAAW,KAAAE,EAAM,IAAI,OAAOgD,CAAG,CAAE,CAAC,CAAC,EAC1EpC,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,CAC/G,CACD,CAGA,GAAID,IAAS,0CAA2C,CACvD,GAAIG,IAAW,MAAO,OAAOS,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,EACxI,GAAI,CACH,IAAMY,EAAId,EAAI,aACRW,EAAI,SAASG,EAAE,IAAI,MAAM,GAAK,IAAK,EAAE,EACrC,EAAI,SAASA,EAAE,IAAI,OAAO,GAAK,IAAK,EAAE,EACxCoC,EAAUpC,EAAE,IAAI,SAAS,EAC7B,GAAI,CAAC,OAAO,SAASH,CAAC,GAAKA,EAAI,KAAQ,CAAC,OAAO,SAAS,CAAC,GAAK,EAAI,GAAK,EAAI,GAC1E,OAAOE,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,6CAAW,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,EAGnH,IAAIiD,EAAe,KACdrD,EAAG,SACCoD,IAASC,EAAe,OAAO,SAASD,EAAS,EAAE,CAAC,GAD3CC,EAAe,OAAOrD,EAAG,OAAO,EAGlD,IAAMsD,EAAK,GAAGzC,CAAC,IAAI,OAAO,CAAC,EAAE,SAAS,EAAE,GAAG,CAAC,GAExCS,EADc,mDAEZD,EAAQ,CAACiC,CAAE,EACbD,IAAgB/B,GAAS,qBAAsBD,EAAM,KAAKgC,CAAY,GAG1E,IAAME,EAAU,MAAMxD,EAAI,SAAS,QAClC;AAAA;AAAA;AAAA;AAAA,aAISuB,CAAK;AAAA,wBAEf,EAAE,KAAK,GAAGD,CAAK,EAAE,IAAI,EAGfmC,EAAY,MAAMzD,EAAI,SAAS,QACpC;AAAA;AAAA,aAESuB,CAAK;AAAA;AAAA,8BAGf,EAAE,KAAK,GAAGD,CAAK,EAAE,IAAI,EAGfoC,EAAW,MAAM1D,EAAI,SAAS,QACnC;AAAA;AAAA,aAESuB,CAAK;AAAA,qCAEf,EAAE,KAAK,GAAGD,CAAK,EAAE,IAAI,EAGfqC,GAAWH,GAAS,SAAW,CAAC,GAAG,IAAI9B,GAAKA,EAAE,OAAO,EACvDkC,EAAW,IAAI,IACnB,GAAID,EAAQ,OAAQ,CACnB,IAAMpB,EAAeoB,EAAQ,IAAI,IAAI,GAAG,EAAE,KAAK,GAAG,EAC5CE,EAAQ,MAAM7D,EAAI,SAAS,QAAQ,yDAAyDuC,CAAY,GAAG,EAAE,KAAK,GAAGoB,CAAO,EAAE,IAAI,EACxIC,EAAW,IAAI,KAAKC,GAAO,SAAW,CAAC,GAAG,IAAInC,GAAK,CAAC,OAAOA,EAAE,OAAO,EAAGA,EAAE,QAAQ,CAAC,CAAC,CACpF,CAGA,IAAMC,EAAY,MAAM,KAAK,IAAI,KAAK+B,GAAU,SAAW,CAAC,GAAG,IAAIhC,GAAKA,EAAE,SAAS,EAAE,OAAO,OAAO,CAAC,CAAC,EACjGoC,EAAY,IAAI,IACpB,GAAInC,EAAU,OAAQ,CACrB,IAAMY,EAAeZ,EAAU,IAAI,IAAI,GAAG,EAAE,KAAK,GAAG,EAC9CoC,EAAQ,MAAM/D,EAAI,SAAS,QAAQ,mEAAmEuC,CAAY,GAAG,EAAE,KAAK,GAAGZ,CAAS,EAAE,IAAI,EACpJmC,EAAY,IAAI,KAAKC,GAAO,SAAW,CAAC,GAAG,IAAIrC,GAAK,CAACA,EAAE,UAAWA,EAAE,YAAY,CAAC,CAAC,CACnF,CAEA,IAAMsC,EAAc,IAAI,IACxB,QAAWtC,KAAM+B,GAAW,SAAW,CAAC,EAAI,CAC3C,IAAMQ,EAAMD,EAAY,IAAI,OAAOtC,EAAE,OAAO,CAAC,GAAK,CAAC,EACnDuC,EAAI,KAAK,CAAE,KAAMvC,EAAE,UAAW,MAAO,OAAOA,EAAE,OAAS,CAAC,CAAE,CAAC,EAC3DsC,EAAY,IAAI,OAAOtC,EAAE,OAAO,EAAGuC,CAAG,CACvC,CAEA,IAAMC,EAAa,IAAI,IACvB,QAAWxC,KAAMgC,GAAU,SAAW,CAAC,EAAI,CAC1C,IAAMO,EAAMC,EAAW,IAAI,OAAOxC,EAAE,OAAO,CAAC,GAAK,CAAC,EAC5CyC,EAAQ,OAAOzC,EAAE,OAAS,CAAC,EACjCuC,EAAI,KAAK,CAAE,UAAWvC,EAAE,UAAW,aAAcoC,EAAU,IAAIpC,EAAE,SAAS,GAAKA,EAAE,UAAW,MAAAyC,CAAM,CAAC,EACnGD,EAAW,IAAI,OAAOxC,EAAE,OAAO,EAAGuC,CAAG,CACtC,CAEA,IAAMxB,EAAO,CAAC,EACd,QAAWf,KAAM8B,GAAS,SAAW,CAAC,EAAI,CACzC,IAAMY,EAAM,OAAO1C,EAAE,OAAO,EACtB2C,EAAQ,OAAO3C,EAAE,aAAe,CAAC,EACjC4C,EAAS,OAAO5C,EAAE,cAAgB,CAAC,EACnC6C,EAAK,OAAO7C,EAAE,gBAAkB,CAAC,EACjC8C,EAAWH,EACXI,EAAc,EACdC,EAAcL,EAAQ,EAAI,QAASG,EAASH,EAAO,KAAK,QAAQ,CAAC,CAAC,EAAI,EACxEM,EAAOT,EAAW,IAAIE,CAAG,GAAK,CAAC,EAC7BQ,EAAYD,EAAK,OAAO,CAACjE,EAAE0B,IAAK1B,EAAI0B,EAAE,MAAO,CAAC,GAAK,EACzDuC,EAAOA,EAAK,IAAIvC,IAAM,CAAE,UAAWA,EAAE,UAAW,aAAcA,EAAE,aAAc,MAAOA,EAAE,MAAO,WAAY,QAASA,EAAE,MAAMwC,EAAW,KAAK,QAAQ,CAAC,CAAC,CAAE,EAAE,EACzJ,IAAMC,EAAQb,EAAY,IAAII,CAAG,GAAK,CAAC,EACvC3B,EAAK,KAAK,CACT,QAAS,OAAO2B,CAAG,EACnB,SAAUR,EAAS,IAAIQ,CAAG,GAAKA,EAC/B,YAAa,OAAOC,EAAM,QAAQ,CAAC,CAAC,EACpC,aAAc,OAAOC,EAAO,QAAQ,CAAC,CAAC,EACtC,eAAgB,OAAOC,EAAG,QAAQ,CAAC,CAAC,EACpC,eAAgB,OAAOC,EAAS,QAAQ,CAAC,CAAC,EAC1C,mBAAoB,OAAOC,EAAY,QAAQ,CAAC,CAAC,EACjD,iBAAkBC,EAClB,oBAAqBC,EACrB,YAAaE,CACd,CAAC,CACF,CAEA,OAAO7D,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAyB,EAAM,KAAK,CAAE,UAAAvC,EAAW,KAAKY,EAAG,MAAM,CAAE,CAAE,EAAGT,CAAW,CACtH,OAAS+C,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAlD,EAAW,KAAAE,EAAM,IAAI,OAAOgD,CAAG,CAAE,CAAC,CAAC,EAC1EpC,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,CAC/G,CACD,CAGA,GAAID,IAAS,2CAA4C,CACxD,GAAIG,IAAW,MAAO,OAAOS,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,EACxI,GAAI,CAACJ,EAAG,SAAU,OAAOe,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,2BAAQ,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,EAC1H,GAAI,CACH,IAAMY,EAAId,EAAI,aACRW,EAAI,SAASG,EAAE,IAAI,MAAM,GAAK,IAAK,EAAE,EACrC,EAAI,SAASA,EAAE,IAAI,OAAO,GAAK,IAAK,EAAE,EACxC6D,EAAS7D,EAAE,IAAI,SAAS,EAC5B,GAAI,CAAC,OAAO,SAASH,CAAC,GAAKA,EAAI,KAAQ,CAAC,OAAO,SAAS,CAAC,GAAK,EAAI,GAAK,EAAI,GAC1E,OAAOE,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,6CAAW,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,EAEnH,IAAMkD,EAAK,GAAGzC,CAAC,IAAI,OAAO,CAAC,EAAE,SAAS,EAAE,GAAG,CAAC,GACtCiE,EAAM,MAAM/E,EAAI,SAAS,QAAQ,wDAAwD,EAAE,KAAKuD,CAAE,EAAE,MAAM,EAChH,GAAI,CAACwB,EACJ,OAAO/D,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAK,CAAE,QAAQ,CAAE,kBAAkB,EAAG,iBAAiB,EAAG,cAAc,EAAG,mBAAmB,EAAG,mBAAmB,EAAG,iBAAiB,CAAE,EAAG,YAAY,CAAC,CAAE,EAAG,KAAK,CAAE,UAAAd,EAAW,MAAMqD,CAAG,CAAE,EAAGlD,CAAW,EAExQ,IAAI2E,EAAI,8OACF1D,EAAQ,CAACyD,EAAI,MAAM,EACrBD,IAAUE,GAAK,sBAAuB1D,EAAM,KAAK,OAAO,SAASwD,EAAO,EAAE,CAAC,CAAC,GAEhF,IAAMG,GADO,MAAMjF,EAAI,SAAS,QAAQgF,CAAC,EAAE,KAAK,GAAG1D,CAAK,EAAE,IAAI,IAC3C,SAAW,CAAC,EACzB4D,EAAQzE,EAAC0E,GAAK,OAAOA,GAAG,CAAC,EAAjB,SACRC,EAAQ3E,EAAC4E,GAAK,KAAK,MAAMA,EAAE,GAAG,EAAtB,SACRC,EAAaL,EAAK,IAAIvD,IAAM,CACjC,QAASA,EAAE,QACX,SAAUA,EAAE,SACZ,YAAa0D,EAAMF,EAAMxD,EAAE,iBAAiB,CAAC,EAC7C,iBAAkB0D,EAAMF,EAAMxD,EAAE,uBAAuB,CAAC,EACxD,cAAe0D,EAAMF,EAAMxD,EAAE,WAAW,CAAC,EACzC,aAAc0D,EAAMF,EAAMxD,EAAE,cAAc,CAAC,EAC3C,aAAc0D,EAAMF,EAAMxD,EAAE,WAAW,CAAC,EACxC,WAAY0D,EAAMF,EAAMxD,EAAE,WAAW,CAAC,EACtC,oBAAqBA,EAAE,qBAAuB,CAC/C,EAAE,EACI6D,EAAM9E,EAAC+E,GAAKF,EAAW,OAAO,CAAC5E,EAAE0B,IAAK1B,EAAI,OAAO0B,EAAEoD,CAAC,GAAG,CAAC,EAAG,CAAC,EAAtD,OACNC,EAAU,CACf,kBAAmBF,EAAI,aAAa,EACpC,iBAAkBA,EAAI,kBAAkB,EACxC,cAAeA,EAAI,eAAe,EAClC,mBAAoBA,EAAI,cAAc,EACtC,mBAAoBA,EAAI,cAAc,EACtC,iBAAkBA,EAAI,YAAY,CACnC,EACA,OAAOvE,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAK,CAAE,QAAAyE,EAAS,YAAaH,CAAW,EAAG,KAAK,CAAE,UAAApF,EAAW,MAAMqD,CAAG,CAAE,EAAGlD,CAAW,CACpJ,OAAS+C,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAlD,EAAW,KAAAE,EAAM,IAAI,OAAOgD,CAAG,CAAE,CAAC,CAAC,EAC1EpC,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,CAC/G,CACD,CAGA,GAAID,IAAS,mCAAoC,CAChD,GAAIG,IAAW,MAAO,OAAOS,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,EACxI,GAAI,CAACJ,EAAG,SAAU,OAAOe,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,2BAAQ,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,EAC1H,GAAI,CACH,IAAMY,EAAId,EAAI,aACRe,EAAQV,EAAUS,EAAE,IAAI,YAAY,CAAC,EACrCE,EAAMX,EAAUS,EAAE,IAAI,UAAU,CAAC,EACvC,GAAI,CAACC,GAAS,CAACC,GAAOD,EAAQC,EAC7B,OAAOH,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,yDAAa,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,EAWrH,IAAMqF,IATO,MAAM1F,EAAI,SAAS,QAC/B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iBAOD,EAAE,KAAKkB,EAAOC,CAAG,EAAE,IAAI,IACM,SAAW,CAAC,GAAG,IAAIO,IAAM,CAAE,MAAOA,EAAE,GAAI,SAAU,OAAOA,EAAE,UAAU,CAAC,EAAG,KAAM,OAAOA,EAAE,MAAM,CAAC,EAAG,YAAa,KAAK,IAAI,EAAG,OAAOA,EAAE,UAAU,CAAC,EAAI,OAAOA,EAAE,MAAM,CAAC,CAAC,CAAE,EAAE,EAC/LiE,EAAiBD,EAAc,OAAO,CAAChF,EAAE0B,IAAK1B,EAAI0B,EAAE,SAAU,CAAC,EAC/DwD,EAAaF,EAAc,OAAO,CAAChF,EAAE0B,IAAK1B,EAAI0B,EAAE,KAAM,CAAC,EACvDyD,EAAoB,KAAK,IAAI,EAAGF,EAAiBC,CAAU,EAC3DE,EAAkBH,EAAiB,EAAI,QAASC,EAAWD,EAAgB,KAAK,QAAQ,CAAC,CAAC,EAAI,EAS9FI,IAPe,MAAM/F,EAAI,SAAS,QACvC;AAAA;AAAA;AAAA;AAAA,0CAKD,EAAE,KAAKkB,EAAOC,CAAG,EAAE,IAAI,IACU,SAAW,CAAC,GAAG,IAAIO,IAAM,CAAE,UAAWA,EAAE,UAAW,aAAcA,EAAE,cAAgBA,EAAE,UAAW,eAAgB,OAAOA,EAAE,gBAAgB,CAAC,EAAG,WAAY,OAAOA,EAAE,YAAY,CAAC,EAAG,kBAAmB,KAAK,IAAI,EAAG,OAAOA,EAAE,gBAAgB,CAAC,EAAI,OAAOA,EAAE,YAAY,CAAC,CAAC,CAAE,EAAE,EAE3S,OAAOV,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAK,CAAE,QAAQ,CAAE,eAAA2E,EAAgB,WAAAC,EAAY,kBAAAC,EAAmB,gBAAAC,CAAgB,EAAG,cAAAJ,EAAe,UAAAK,CAAU,EAAG,KAAK,CAAE,UAAA7F,CAAU,CAAE,EAAGG,CAAW,CAC9M,OAAS+C,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAlD,EAAW,KAAAE,EAAM,IAAI,OAAOgD,CAAG,CAAE,CAAC,CAAC,EAC1EpC,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,CAC/G,CACD,CAEA,OAAOW,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGG,CAAW,CACxG,CAvVsBI,EAAAX,GAAA,iBCAtB,SAASkG,EAAaC,EAAI,CAEzB,OADY,KAAK,OAAO,aAAa,GAAGA,CAAE,CAAC,EAChC,WAAW,IAAK,GAAG,EAAE,WAAW,IAAK,GAAG,EAAE,WAAW,IAAK,EAAE,CACxE,CAHSC,EAAAF,EAAA,gBAKT,eAAeG,GAAWC,EAAUC,EAAU,CAC7C,IAAMC,EAAM,MAAM,OAAO,OAAO,UAAU,MAAOF,EAAU,CAAE,KAAM,OAAQ,KAAM,SAAU,EAAG,GAAO,CAAC,MAAM,CAAC,EACvGG,EAAM,MAAM,OAAO,OAAO,KAAK,OAAQD,EAAKD,CAAQ,EAC1D,OAAO,IAAI,WAAWE,CAAG,CAC1B,CAJeL,EAAAC,GAAA,cAMf,SAASK,GAAKC,EAAK,CAAE,OAAO,IAAI,YAAY,EAAE,OAAOA,CAAG,CAAG,CAAlDP,EAAAM,GAAA,QAET,SAASE,GAAiBC,EAAM,CAE/B,OADU,OAAOA,GAAQ,EAAE,EAClB,QAAQ,SAAU,GAAG,EAAE,QAAQ,UAAW,GAAG,EAAE,MAAM,EAAG,GAAG,GAAK,MAC1E,CAHST,EAAAQ,GAAA,oBAKT,SAASE,GAAgBD,EAAM,CAC9B,IAAME,EAAI,OAAOF,GAAM,EAAE,EAAE,YAAY,EAAE,MAAM,qBAAqB,EACpE,OAAOE,EAAIA,EAAE,CAAC,EAAI,EACnB,CAHSX,EAAAU,GAAA,mBAKT,eAAsBE,GAAkBC,EAASC,EAAKC,EAAIC,EAAWC,EAAKC,EAAM,CAC/E,IAAMC,EAAcC,EAAyBP,EAASC,CAAG,EACnDO,EAASR,EAAQ,OAAO,YAAY,EAG1C,GAAIK,IAAS,2CAA4C,CACxD,GAAIG,IAAW,OAAQ,OAAOC,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EACzI,IAAII,EAAM,GAAI,CAAEA,EAAO,MAAMV,EAAQ,KAAK,CAAG,MAAY,CAAE,OAAOS,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,uCAAU,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CAAG,CAC1K,IAAMK,EAAa,OAAOD,GAAM,aAAe,EAAE,EAAE,KAAK,EAClDE,EAAW,OAAOF,GAAM,WAAa,EAAE,EAAE,KAAK,EAC9CG,EAAc,OAAOH,GAAM,UAAY,EAAE,EAAE,KAAK,EAChDI,EAAc,OAAOJ,GAAM,cAAgB,EAAE,EAAE,KAAK,EAAE,YAAY,EAClEK,EAAgB,OAAOL,GAAM,gBAAkB,CAAC,EACtD,GAAI,CAAC,CAAC,SAAS,UAAU,MAAM,MAAM,EAAE,SAASC,CAAU,EAAG,OAAOF,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,iCAAmB,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EACvL,GAAI,CAACM,EAAU,OAAOH,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,yBAAgB,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EACtI,GAAI,CAACO,EAAa,OAAOJ,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,wBAAe,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EACxI,GAAI,CAAC,OAAO,SAASS,CAAa,GAAKA,GAAiB,EAAG,OAAON,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,oCAAsB,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EACxL,GAAIS,EAAgB,GAAK,KAAO,KAAM,OAAON,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,oBAAqB,QAAQ,gFAAqB,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EACnK,IAAMU,EAAa,CAAC,MAAM,MAAM,OAAO,MAAM,OAAO,MAAM,OAAO,KAAK,EAChEC,EAAc,CACnB,kBAAkB,aAAa,YAC/B,oEAAoE,2BACpE,0EAA0E,oBAC3E,EACMC,EAAWvB,GAAiBkB,CAAW,EACvCM,EAAMtB,GAAgBqB,CAAQ,EACpC,GAAI,CAACF,EAAW,SAASG,CAAG,EAAG,OAAOV,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,oBAAqB,QAAQ,6CAAW,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EAClJ,GAAI,CAACW,EAAY,SAASH,CAAW,EAAG,OAAOL,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,oBAAqB,QAAQ,mDAAY,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EAG5J,IAAMc,EADS,CAAE,OAAO,GAAI,QAAQ,EAAG,IAAI,GAAI,KAAK,EAAG,EAClCT,CAAU,GAAK,GAC9BU,EAAS,MAAMpB,EAAI,SAAS,QAAQ,kGAAkG,EAAE,KAAKU,EAAYC,CAAQ,EAAE,MAAM,EAC/K,GAAI,OAAOS,GAAQ,GAAK,CAAC,GAAKD,EAAO,OAAOX,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,4EAAgBW,CAAK,gBAAO,KAAK,CAAE,UAAAjB,CAAU,CAAE,EAAGG,CAAW,EAEtK,IAAMgB,EAAU,OAAOrB,EAAI,SAAW,KAAK,EACrCsB,EAAM,KAAK,MAAM,KAAK,IAAI,EAAE,GAAI,EAChCC,EAAO,OAAO,gBAAgB,IAAI,WAAW,CAAC,CAAC,EAC/CC,EAAUxC,EAAauC,CAAI,EAE3BE,EAAY,GADH,WAAWJ,CAAO,gBAAgBX,CAAU,IAAIC,CAAQ,EAC5C,MAAMW,CAAG,IAAIE,CAAO,IAAIN,CAAG,GAChDQ,EAAYJ,EAAM,IAClBK,EAAU,CACf,UAAAF,EACA,WAAAf,EACA,SAAAC,EACA,SAAUM,EACV,YAAAJ,EACA,cAAAC,EACA,OAAQ,OAAOb,EAAG,OAAO,EACzB,IAAKyB,CACN,EACME,EAAS,OAAO5B,EAAI,uBAAyB,WAAW,EACxD6B,EAASrC,GAAK,KAAK,UAAUmC,CAAO,CAAC,EACrCpC,EAAM,MAAMJ,GAAWK,GAAKoC,CAAM,EAAGC,CAAM,EAC3CC,EAAQ,GAAG9C,EAAa6C,CAAM,CAAC,IAAI7C,EAAaO,CAAG,CAAC,GAEpDwC,EAAO,CAAE,UADG,GAAG5B,EAAI,MAAM,oDAAoD2B,CAAK,GAC9D,UAAAL,EAAW,QAAS,CAAE,eAAgBZ,EAAa,iBAAkB,OAAOC,CAAa,CAAE,CAAE,EACvH,OAAON,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAuB,EAAM,KAAK,CAAE,UAAA7B,EAAW,UAAAwB,CAAU,CAAE,EAAGrB,CAAW,CAChH,CAGA,GAAID,IAAS,6CAA8C,CAC1D,GAAIG,IAAW,MAAO,OAAOC,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EACxI,GAAI,CAEH,IAAM2B,GADQ7B,EAAI,aAAa,IAAI,OAAO,GAAK,IAC3B,MAAM,GAAG,EAC7B,GAAI6B,EAAM,SAAW,EAAG,OAAOxB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,2BAAQ,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EAClI,IAAMwB,EAAS,WAAW,KAAK,KAAKG,EAAM,CAAC,EAAE,WAAW,IAAI,GAAG,EAAE,WAAW,IAAI,GAAG,CAAC,EAAGC,GAAKA,EAAE,WAAW,CAAC,CAAC,EACrGC,EAAS,WAAW,KAAK,KAAKF,EAAM,CAAC,EAAE,WAAW,IAAI,GAAG,EAAE,WAAW,IAAI,GAAG,CAAC,EAAGC,GAAKA,EAAE,WAAW,CAAC,CAAC,EACrGL,EAAS,OAAO5B,EAAI,uBAAyB,WAAW,EACxDmC,EAAW,MAAMhD,GAAWK,GAAKoC,CAAM,EAAGC,CAAM,EACtD,GAAIM,EAAS,SAAWD,EAAO,OAAQ,OAAO1B,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,2BAAQ,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EACjJ,IAAI+B,EAAQ,EAAG,QAASC,EAAE,EAAEA,EAAEF,EAAS,OAAOE,IAAKD,GAAUD,EAASE,CAAC,EAAEH,EAAOG,CAAC,EACjF,GAAID,IAAU,EAAG,OAAO5B,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,2BAAQ,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EAC3H,IAAMsB,EAAU,KAAK,MAAM,IAAI,YAAY,EAAE,OAAOE,CAAM,CAAC,EAC3D,GAAI,CAACF,GAAW,OAAOA,GAAY,SAAU,OAAOnB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,2BAAQ,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EACvJ,GAAIsB,EAAQ,IAAM,KAAK,MAAM,KAAK,IAAI,EAAE,GAAI,EAAG,OAAOnB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EAE1J,GAAI,OAAOsB,EAAQ,MAAM,IAAM,OAAO1B,EAAG,OAAO,EAAG,OAAOO,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,6CAAW,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EAE9J,IAAMiC,GAASvC,EAAQ,QAAQ,IAAI,cAAc,GAAK,IAAI,YAAY,EAChEwC,EAAS,SAASxC,EAAQ,QAAQ,IAAI,gBAAgB,GAAK,IAAK,EAAE,EACxE,GAAIuC,IAAU,OAAOX,EAAQ,WAAW,EAAE,YAAY,EAAG,OAAOnB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,oBAAqB,QAAQ,kCAAoB,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EACrL,GAAI,CAAC,OAAO,SAASkC,CAAM,GAAKA,IAAW,OAAOZ,EAAQ,aAAa,EAAG,OAAOnB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,oCAAsB,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EACvM,GAAI,CAACL,EAAI,sBAAuB,OAAOQ,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,wBAAU,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EAE/I,IAAMmC,EAAK,yBAAyB9C,GAAiBiC,EAAQ,QAAQ,CAAC,IACtE,MAAM3B,EAAI,sBAAsB,IAAI2B,EAAQ,UAAW5B,EAAQ,KAAM,CACpE,aAAc,CAAE,YAAa4B,EAAQ,YAAa,mBAAoBa,CAAG,EACzE,eAAgB,CAAE,QAAS,OAAOvC,EAAG,OAAO,EAAG,OAAQ,cAAe,SAAU,GAAG0B,EAAQ,UAAU,IAAIA,EAAQ,QAAQ,EAAG,CAC7H,CAAC,EAED,MAAM3B,EAAI,SAAS,QAClB,iKACD,EAAE,KAAK2B,EAAQ,WAAYA,EAAQ,SAAUA,EAAQ,UAAWA,EAAQ,SAAUA,EAAQ,YAAa,OAAOA,EAAQ,aAAa,EAAG,OAAO1B,EAAG,OAAO,EAAG,IAAI,KAAK,EAAE,YAAY,CAAC,EAAE,IAAI,EACxL,IAAMwC,EAAM,MAAMzC,EAAI,SAAS,QAAQ,kCAAkC,EAAE,MAAM,EACjF,OAAOQ,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,UAAW,QAAQ,qBAAO,KAAK,CAAE,cAAeiC,GAAK,GAAI,WAAYd,EAAQ,SAAU,EAAG,KAAK,CAAE,UAAAzB,CAAU,CAAE,EAAGG,CAAW,CACrK,OAASqC,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAxC,EAAW,KAAAE,EAAM,IAAI,OAAOsC,CAAG,CAAE,CAAC,CAAC,EAC1ElC,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CAC/G,CACD,CAEA,GAAIE,IAAW,MACd,GAAI,CACH,IAAMoC,EAASxC,EAAI,aACbO,GAAciC,EAAO,IAAI,aAAa,GAAK,IAAI,KAAK,EACpDhC,GAAYgC,EAAO,IAAI,WAAW,GAAK,IAAI,KAAK,EACtD,GAAI,CAACjC,GAAc,CAACC,EACnB,OAAOH,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,4CAA8B,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EAEtI,GAAI,CAAC,CAAC,SAAS,UAAU,MAAM,MAAM,EAAE,SAASK,CAAU,EACzD,OAAOF,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,iCAAmB,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EAE3H,IAAMuC,EAAO,KAAK,IAAI,EAAG,SAASD,EAAO,IAAI,MAAM,GAAK,IAAK,EAAE,CAAC,EAC1DE,EAAU,KAAK,IAAI,IAAK,KAAK,IAAI,EAAG,SAASF,EAAO,IAAI,SAAS,GAAK,KAAM,EAAE,CAAC,CAAC,EAChFG,GAAUF,EAAO,GAAKC,EACtBE,GAAKJ,EAAO,IAAI,GAAG,GAAK,IAAI,KAAK,EACjCK,GAAYL,EAAO,IAAI,WAAW,GAAK,OAAO,KAAK,EACnDM,GAAYN,EAAO,IAAI,UAAU,GAAK,IAAI,KAAK,EAC/CO,GAAUP,EAAO,IAAI,QAAQ,GAAK,IAAI,KAAK,EAE3CQ,EAAQ,CAAC,iBAAkB,kBAAmB,eAAe,EAC7DC,EAAQ,CAAC1C,EAAYC,CAAQ,EAC/BoC,IAAKI,EAAM,KAAK,mBAAmB,EAAGC,EAAM,KAAK,IAAIL,CAAC,GAAG,GACzD,sBAAsB,KAAKE,CAAQ,IAAKE,EAAM,KAAK,kBAAkB,EAAGC,EAAM,KAAK,GAAGH,CAAQ,gBAAgB,GAC9G,sBAAsB,KAAKC,CAAM,IAAKC,EAAM,KAAK,kBAAkB,EAAGC,EAAM,KAAK,GAAGF,CAAM,gBAAgB,GAC1GF,IAAa,QAEZA,IAAa,MAASG,EAAM,KAAK,2EAA2E,EACvGH,IAAa,QAAWG,EAAM,KAAK,uIAAuI,EAC1KH,IAAa,QAAWG,EAAM,KAAK,4LAA4L,EAC/NH,IAAa,QAAUG,EAAM,KAAK,4LAA4L,GAExO,IAAME,EAAW,SAASF,EAAM,KAAK,OAAO,CAAC,GACvCG,EAAW,MAAMtD,EAAI,SAAS,QAAQ,6CAA6CqD,CAAQ,EAAE,EAAE,KAAK,GAAGD,CAAK,EAAE,MAAM,EACpHG,EAAQ,OAAOD,GAAU,OAAS,CAAC,EAQnCvB,IAPO,MAAM/B,EAAI,SAAS,QAC/B;AAAA;AAAA,OAEGqD,CAAQ;AAAA;AAAA,sBAGZ,EAAE,KAAK,GAAGD,EAAOP,EAASC,CAAM,EAAE,IAAI,IAClB,SAAW,CAAC,GAAG,IAAIU,IAAM,CAC5C,GAAIA,EAAE,cACN,SAAUA,EAAE,SACZ,YAAaA,EAAE,aACf,UAAW,OAAOA,EAAE,YAAc,CAAC,EACnC,eAAgBA,EAAE,iBAClB,aAAcA,EAAE,eAAiB,OAAOA,EAAE,kBAAoB,EAAE,EAChE,WAAYA,EAAE,WACf,EAAE,EACF,OAAOhD,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAuB,EAAM,KAAK,CAAE,UAAA7B,EAAW,KAAA0C,EAAM,QAAAC,EAAS,MAAAU,CAAM,CAAE,EAAGlD,CAAW,CAC3H,OAASqC,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAxC,EAAW,KAAK,+BAAgC,IAAI,OAAOwC,CAAG,CAAE,CAAC,CAAC,EACzGlC,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CAC/G,CAGD,OAAOG,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CACnH,CAjKsBnB,EAAAY,GAAA,qBCvBtB,eAAsB2D,GAAUC,EAASC,EAAKC,EAAIC,EAAWC,EAAKC,EAAM,CACvE,IAAMC,EAAcC,EAAyBP,EAASC,CAAG,EACnDO,EAASR,EAAQ,OAAO,YAAY,EAG1C,GAAIK,IAAS,uBAAwB,CACpC,GAAIG,IAAW,MAAO,OAAOC,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EACxI,GAAI,CACH,IAAMI,EAAIN,EAAI,aACRO,EAAO,KAAK,IAAI,EAAG,SAASD,EAAE,IAAI,MAAM,GAAK,IAAK,EAAE,CAAC,EACrDE,EAAU,KAAK,IAAI,IAAK,KAAK,IAAI,EAAG,SAASF,EAAE,IAAI,SAAS,GAAK,KAAM,EAAE,CAAC,CAAC,EAC3EG,GAAUF,EAAO,GAAKC,EACtBE,GAAKJ,EAAE,IAAI,GAAG,GAAK,IAAI,KAAK,EAC5BK,GAAYL,EAAE,IAAI,UAAU,GAAK,IAAI,KAAK,EAC1CM,GAAWN,EAAE,IAAI,MAAM,GAAK,IAAI,KAAK,EACrCO,GAAaP,EAAE,IAAI,WAAW,GAAK,OAAO,KAAK,EAAE,YAAY,EAE7DQ,EAAQ,CAAC,gBAAgB,EACzBC,EAAQ,CAAC,EAOf,GANIL,IAAKI,EAAM,KAAK,+BAA+B,EAAGC,EAAM,KAAK,IAAIL,CAAC,IAAK,IAAIA,CAAC,GAAG,GAC/EC,GAAYA,IAAa,QAASG,EAAM,KAAK,cAAc,EAAGC,EAAM,KAAKJ,CAAQ,GACjFE,IAAc,QACb,CAAC,IAAI,OAAO,WAAW,EAAE,SAASA,CAAS,EAAKC,EAAM,KAAK,kBAAkB,EACxE,CAAC,IAAI,QAAQ,OAAO,EAAE,SAASD,CAAS,GAAKC,EAAM,KAAK,kBAAkB,GAEhFF,EAAS,CACZ,IAAMI,EAAUJ,EAAQ,MAAM,GAAG,EAAE,IAAIK,GAAKA,EAAE,KAAK,CAAC,EAAE,OAAO,OAAO,EACpE,QAAWC,KAAKF,EAAWF,EAAM,KAAK,eAAe,EAAGC,EAAM,KAAK,IAAIG,CAAC,GAAG,CAC5E,CACA,IAAMC,EAAWL,EAAM,OAAS,SAASA,EAAM,KAAK,OAAO,CAAC,GAAK,GAC3DM,EAAW,MAAMvB,EAAI,SAAS,QAAQ,8CAA8CsB,CAAQ,EAAE,EAAE,KAAK,GAAGJ,CAAK,EAAE,MAAM,EACrHM,EAAQ,OAAOD,GAAU,OAAS,CAAC,EAQnCE,IAPO,MAAMzB,EAAI,SAAS,QAC/B;AAAA;AAAA,OAEGsB,CAAQ;AAAA;AAAA,sBAGZ,EAAE,KAAK,GAAGJ,EAAOP,EAASC,CAAM,EAAE,IAAI,IACjB,SAAW,CAAC,GAAG,IAAIc,IAAM,CAC7C,GAAIA,EAAE,OACN,MAAOA,EAAE,MACT,SAAUA,EAAE,UAAY,GACxB,MAAO,IAAM,CAAE,GAAI,CAAE,OAAO,KAAK,MAAMA,EAAE,MAAQ,IAAI,CAAG,MAAW,CAAE,MAAO,CAAC,CAAG,CAAE,GAAG,EACrF,QAAS,OAAOA,EAAE,SAAW,CAAC,EAC9B,YAAaA,EAAE,eAAiB,EAChC,UAAWA,EAAE,WACb,UAAWA,EAAE,WACb,UAAWA,EAAE,UACd,EAAE,EACF,OAAOlB,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAMiB,EAAO,KAAK,CAAE,UAAAvB,EAAW,KAAAQ,EAAM,QAAAC,EAAS,MAAAa,CAAM,CAAE,EAAGnB,CAAW,CAClI,OAASsB,EAAK,CACb,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAzB,EAAW,KAAAE,EAAM,IAAI,OAAOuB,CAAG,CAAE,CAAC,CAAC,EAC1EnB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CAC/G,CACD,CAEA,OAAOG,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,qBAAO,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CACxG,CA1DsBuB,EAAA9B,GAAA,aCAtB,SAAS+B,EAAQC,EAAG,CAClB,IAAMC,EAAI,SAAS,OAAOD,GAAK,EAAE,EAAG,EAAE,EACtC,OAAO,OAAO,SAASC,CAAC,GAAKA,EAAI,EAAIA,EAAI,IAC3C,CAHSC,EAAAH,EAAA,WAKT,SAASI,IAAW,CAClB,IAAM,EAAI,IAAI,KACRC,EAAI,EAAE,eAAe,EACrBC,EAAI,OAAO,EAAE,YAAY,EAAI,CAAC,EAAE,SAAS,EAAG,GAAG,EAC/CC,EAAM,OAAO,EAAE,WAAW,CAAC,EAAE,SAAS,EAAG,GAAG,EAClD,MAAO,GAAGF,CAAC,IAAIC,CAAC,IAAIC,CAAG,EACzB,CANSJ,EAAAC,GAAA,YAQT,SAASI,GAAWP,EAAG,CAAE,MAAO,sBAAsB,KAAK,OAAOA,GAAK,EAAE,CAAC,CAAG,CAApEE,EAAAK,GAAA,cAET,eAAsBC,GAAqBC,EAASC,EAAKC,EAAIC,EAAWC,EAAKC,EAAM,CACjF,IAAMC,EAAcC,EAAyBP,EAASC,CAAG,EACnDO,EAASR,EAAQ,OAAO,YAAY,EAG1C,GAAIK,IAAS,oCAAsCG,IAAW,MAC5D,GAAI,CACF,IAAMC,EAAIL,EAAI,aACRM,GAAUD,EAAE,IAAI,QAAQ,GAAK,OAAO,KAAK,EACzCE,GAAKF,EAAE,IAAI,GAAG,GAAK,IAAI,KAAK,EAC5BG,EAAO,KAAK,IAAI,EAAG,SAASH,EAAE,IAAI,MAAM,GAAK,IAAK,EAAE,CAAC,EACrDI,EAAU,KAAK,IAAI,IAAK,KAAK,IAAI,EAAG,SAASJ,EAAE,IAAI,SAAS,GAAK,KAAM,EAAE,CAAC,CAAC,EAC3EK,GAAUF,EAAO,GAAKC,EACtBE,EAAQ,CAAC,mBAAmB,EAASC,EAAQ,CAAC,EAChD,CAAC,SAAS,YAAY,UAAU,WAAW,EAAE,SAASN,CAAM,IAAKK,EAAM,KAAK,eAAe,EAAGC,EAAM,KAAKN,CAAM,GAC/GC,IAAKI,EAAM,KAAK,yBAAyB,EAAGC,EAAM,KAAK,IAAIL,CAAC,GAAG,GACnE,IAAMM,EAAWF,EAAM,OAAS,SAASA,EAAM,KAAK,OAAO,CAAC,GAAK,GAC3DG,EAAW,MAAMjB,EAAI,SAAS,QAAQ,qGAAqGgB,CAAQ,EAAE,EAAE,KAAK,GAAGD,CAAK,EAAE,MAAM,EAQ5KG,IAPO,MAAMlB,EAAI,SAAS,QAC9B;AAAA;AAAA,WAEGgB,CAAQ;AAAA;AAAA,0BAGb,EAAE,KAAK,GAAGD,EAAOH,EAASC,CAAM,EAAE,IAAI,IAClB,SAAW,CAAC,GAAG,IAAIM,IAAM,CAC3C,GAAIA,EAAE,kBACN,SAAUA,EAAE,UACZ,WAAYA,EAAE,cAAgBA,EAAE,UAChC,OAAQA,EAAE,OACV,wBAAyBA,EAAE,2BAA6B,IAC1D,EAAE,EACF,OAAOC,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAF,EAAM,KAAK,CAAE,UAAAhB,EAAW,KAAAS,EAAM,QAAAC,EAAS,MAAO,OAAOK,GAAU,OAAS,CAAC,CAAE,CAAE,EAAGZ,CAAW,CAC1J,OAASgB,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAnB,EAAW,KAAAE,EAAM,IAAI,OAAOiB,CAAG,CAAE,CAAC,CAAC,EAC1ED,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,CAChH,CAIF,IAAMiB,EAAelB,EAAK,MAAM,wDAAwD,EAClFmB,EAAcnB,EAAK,MAAM,uDAAuD,EAChFoB,EAAcpB,EAAK,MAAM,uDAAuD,EAChFqB,EAAerB,EAAK,MAAM,wDAAwD,EAGxF,GAAIkB,EAAc,CAChB,GAAIf,IAAW,OAAQ,OAAOa,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EACzI,IAAIqB,EAAM,GAAI,CAAEA,EAAO,MAAM3B,EAAQ,KAAK,CAAG,MAAY,CAAE,OAAOqB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,uCAAU,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,CAAG,CAC1K,IAAMsB,EAAKtC,EAAQiC,EAAa,CAAC,CAAC,EAC5BM,EAAS,OAAOF,GAAM,QAAU,EAAE,EAAE,KAAK,EACzCG,EAAQ,OAAOH,GAAM,OAAS,EAAE,EAAE,KAAK,EACvCI,EAAY,OAAOJ,GAAM,gBAAkB,EAAE,EAAE,KAAK,EAC1D,GAAI,CAACC,EAAI,OAAOP,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EAClH,GAAI,CAACR,GAAWiC,CAAS,EAAG,OAAOV,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,uCAAU,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EAC7I,GAAI,CAACuB,EAAQ,OAAOR,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,2BAAQ,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EAC5H,GAAI,CACF,IAAM0B,EAAM,MAAM/B,EAAI,SAAS,QAAQ,gIAAgI,EAAE,KAAK2B,CAAE,EAAE,MAAM,EACxL,GAAI,CAACI,EAAK,OAAOX,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EACnH,GAAI0B,EAAI,SAAW,SAAU,OAAOX,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,gBAAiB,QAAQ,+DAAc,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EAC/I,GAAI0B,EAAI,2BAA6BA,EAAI,0BAA4BtC,GAAS,EAAG,OAAO2B,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,oBAAqB,QAAQ,iFAAiB,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EAC1M,IAAM2B,EAAS,IAAI,KAAK,EAAE,YAAY,EACtC,OAAIF,GAAarC,GAAS,GACxB,MAAMO,EAAI,SAAS,QAAQ,qJAAqJ,EAAE,KAAKgC,EAAQJ,EAAQD,CAAE,EAAE,IAAI,EAC/M,MAAM3B,EAAI,SAAS,QAAQ,oJAAoJ,EAAE,KAAK2B,EAAI,OAAO1B,EAAG,OAAO,EAAG2B,EAAQC,CAAK,EAAE,IAAI,EAC1NT,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,iCAAS,KAAK,CAAE,kBAAmBO,EAAI,OAAO,YAAa,aAAcK,CAAO,CAAE,EAAG3B,CAAW,IAEzJ,MAAML,EAAI,SAAS,QAAQ,4GAA4G,EAAE,KAAK8B,EAAWF,EAAQD,CAAE,EAAE,IAAI,EAClKP,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,4BAAQU,CAAS,gBAAO,KAAK,CAAE,kBAAmBH,EAAI,OAAO,SAAU,0BAA2BG,CAAU,CAAE,EAAGzB,CAAW,EACrL,OAASgB,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAnB,EAAW,KAAAE,EAAM,IAAI,OAAOiB,CAAG,CAAE,CAAC,CAAC,EAC1ED,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,CAChH,CACF,CAGA,GAAIkB,EAAa,CACf,GAAIhB,IAAW,OAAQ,OAAOa,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EACzI,IAAIqB,EAAM,GAAI,CAAEA,EAAO,MAAM3B,EAAQ,KAAK,CAAG,MAAY,CAAE2B,EAAO,CAAC,CAAG,CACtE,IAAMC,EAAKtC,EAAQkC,EAAY,CAAC,CAAC,EAC3BM,EAAQ,OAAOH,GAAM,OAAS,EAAE,EAAE,KAAK,EAC7C,GAAI,CAACC,EAAI,OAAOP,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EAClH,GAAI,CACF,IAAM0B,EAAM,MAAM/B,EAAI,SAAS,QAAQ,qGAAqG,EAAE,KAAK2B,CAAE,EAAE,MAAM,EAC7J,GAAI,CAACI,EAAK,OAAOX,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EACnH,GAAI0B,EAAI,SAAW,YAAa,OAAOX,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,gBAAiB,QAAQ,+DAAc,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EAClJ,IAAM2B,EAAS,IAAI,KAAK,EAAE,YAAY,EACtC,aAAMhC,EAAI,SAAS,QAAQ,wKAAwK,EAAE,KAAKgC,EAAQL,CAAE,EAAE,IAAI,EAC1N,MAAM3B,EAAI,SAAS,QAAQ,qJAAqJ,EAAE,KAAK2B,EAAI,OAAO1B,EAAG,OAAO,EAAG4B,CAAK,EAAE,IAAI,EACnNT,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,iCAAS,KAAK,CAAE,kBAAmBO,EAAI,OAAO,SAAU,WAAYK,CAAO,CAAE,EAAG3B,CAAW,CACpJ,OAASgB,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAnB,EAAW,KAAAE,EAAM,IAAI,OAAOiB,CAAG,CAAE,CAAC,CAAC,EAC1ED,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,CAChH,CACF,CAGA,GAAImB,EAAa,CACf,GAAIjB,IAAW,OAAQ,OAAOa,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EACzI,GAAI,CAACJ,EAAG,SAAU,OAAOmB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,2BAAQ,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EAC1H,IAAIqB,EAAM,GAAI,CAAEA,EAAO,MAAM3B,EAAQ,KAAK,CAAG,MAAY,CAAE,OAAOqB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,uCAAU,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,CAAG,CAC1K,IAAMsB,EAAKtC,EAAQmC,EAAY,CAAC,CAAC,EAC3BI,EAAS,OAAOF,GAAM,QAAU,EAAE,EAAE,KAAK,EACzCO,EAAc,EAAQP,GAAM,qBAClC,GAAI,CAACC,EAAI,OAAOP,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EAClH,GAAI,CAACuB,EAAQ,OAAOR,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,uCAAU,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EAC9H,GAAI,CACF,IAAM0B,EAAM,MAAM/B,EAAI,SAAS,QAAQ,qGAAqG,EAAE,KAAK2B,CAAE,EAAE,MAAM,EAC7J,GAAI,CAACI,EAAK,OAAOX,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EACnH,GAAI0B,EAAI,SAAW,YAAa,OAAOX,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,gBAAiB,QAAQ,uCAAU,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EAC9I,IAAM2B,EAAS,IAAI,KAAK,EAAE,YAAY,EACtC,MAAMhC,EAAI,SAAS,QAAQ,8GAA8G,EAAE,KAAKgC,EAAQ,OAAO/B,EAAG,OAAO,EAAG0B,CAAE,EAAE,IAAI,EACpL,MAAM3B,EAAI,SAAS,QAAQ,8IAA8I,EAAE,KAAK2B,EAAII,EAAI,OAAQ,OAAO9B,EAAG,OAAO,EAAG2B,CAAM,EAAE,IAAI,EAChO,IAAIM,EAAiB,GACrB,OAAID,IACF,MAAMjC,EAAI,SAAS,QAAQ,mHAAmH,EAAE,KAAK2B,CAAE,EAAE,IAAI,EAC7JO,EAAiB,IAEZd,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,iCAAS,KAAK,CAAE,kBAAmBO,EAAI,OAAO,YAAa,gBAAiBO,CAAe,CAAE,EAAG7B,CAAW,CACpK,OAASgB,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAnB,EAAW,KAAAE,EAAM,IAAI,OAAOiB,CAAG,CAAE,CAAC,CAAC,EAC1ED,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,CAChH,CACF,CAGA,GAAIoB,EAAc,CAChB,GAAIlB,IAAW,MAAO,OAAOa,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EACxI,IAAMsB,EAAKtC,EAAQoC,EAAa,CAAC,CAAC,EAClC,GAAI,CAACE,EAAI,OAAOP,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,EAClH,GAAI,CAOF,IAAMa,IANO,MAAMlB,EAAI,SAAS,QAC9B;AAAA;AAAA;AAAA,sDAIF,EAAE,KAAK2B,CAAE,EAAE,IAAI,IACK,SAAW,CAAC,GAAG,IAAIR,IAAM,CAAE,UAAWA,EAAE,UAAW,WAAYA,EAAE,WAAY,WAAYA,EAAE,WAAY,WAAYA,EAAE,iBAAmB,OAAOA,EAAE,UAAU,EAAG,WAAYA,EAAE,WAAY,OAAQA,EAAE,QAAU,GAAI,MAAOA,EAAE,OAAS,EAAG,EAAE,EAC3P,OAAOC,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAF,EAAM,KAAK,CAAE,UAAAhB,EAAW,MAAOgB,EAAK,MAAO,CAAE,EAAGb,CAAW,CAC1H,OAASgB,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAnB,EAAW,KAAAE,EAAM,IAAI,OAAOiB,CAAG,CAAE,CAAC,CAAC,EAC1ED,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,CAChH,CACF,CAEA,OAAOe,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,qBAAO,KAAK,CAAE,UAAAlB,CAAU,CAAE,EAAGG,CAAW,CACzG,CAlJsBb,EAAAM,GAAA,wBCftB,eAAsBqC,GAAUC,EAASC,EAAKC,EAAIC,EAAWC,EAAKC,EAAM,CACtE,IAAMC,EAAcC,EAAyBP,EAASC,CAAG,EACnDO,EAASR,EAAQ,OAAO,YAAY,EAG1C,GAAI,CAACE,GAAI,SAAU,OAAOO,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,2BAAQ,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EAG3H,GAAID,IAAS,mCAAqCG,IAAW,MAC3D,GAAI,CACF,IAAME,EAAIN,EAAI,aACRO,GAAUD,EAAE,IAAI,QAAQ,GAAK,OAAO,KAAK,EACzCE,GAAYF,EAAE,IAAI,UAAU,GAAK,IAAI,KAAK,EAC1CG,GAAOH,EAAE,IAAI,KAAK,GAAK,IAAI,KAAK,EAChCI,GAAWJ,EAAE,IAAI,SAAS,GAAKA,EAAE,IAAI,GAAG,GAAK,IAAI,KAAK,EACtDK,EAAO,KAAK,IAAI,EAAG,SAASL,EAAE,IAAI,MAAM,GAAK,IAAK,EAAE,CAAC,EACrDM,EAAU,KAAK,IAAI,IAAK,KAAK,IAAI,EAAG,SAASN,EAAE,IAAI,SAAS,GAAK,KAAM,EAAE,CAAC,CAAC,EAC3EO,GAAUF,EAAO,GAAKC,EACtBE,EAAQ,CAAC,gBAAgB,EAASC,EAAQ,CAAC,EAC7CR,IAAW,aAAeO,EAAM,KAAK,kBAAkB,EACvDP,IAAW,SAAWO,EAAM,KAAK,kBAAkB,EACnDN,IAAYM,EAAM,KAAK,cAAc,EAAGC,EAAM,KAAKP,CAAQ,GAC3DC,IAAOK,EAAM,KAAK,aAAa,EAAGC,EAAM,KAAK,IAAIN,CAAG,GAAG,GACvDC,IAAWI,EAAM,KAAK,kCAAkC,EAAGC,EAAM,KAAK,IAAIL,CAAO,IAAK,IAAIA,CAAO,GAAG,GACxG,IAAMM,EAAWF,EAAM,OAAS,SAASA,EAAM,KAAK,OAAO,CAAC,GAAK,GAC3DG,EAAW,MAAMpB,EAAI,SAAS,QAAQ,kDAAkDmB,CAAQ,EAAE,EAAE,KAAK,GAAGD,CAAK,EAAE,MAAM,EAQzHG,IAPO,MAAMrB,EAAI,SAAS,QAC9B;AAAA;AAAA,WAEGmB,CAAQ;AAAA;AAAA,0BAGb,EAAE,KAAK,GAAGD,EAAOH,EAASC,CAAM,EAAE,IAAI,IAClB,SAAW,CAAC,GAAG,IAAIM,IAAM,CAC3C,GAAIA,EAAE,WACN,MAAOA,EAAE,MACT,KAAMA,EAAE,KACR,SAAUA,EAAE,UAAY,GACxB,MAAO,IAAI,CAAE,GAAI,CAAE,OAAO,KAAK,MAAMA,EAAE,MAAQ,IAAI,CAAG,MAAW,CAAE,MAAO,CAAC,CAAG,CAAE,GAAG,EACnF,YAAaA,EAAE,eAAiB,EAChC,UAAWA,EAAE,WACb,UAAW,OAAOA,EAAE,YAAc,CAAC,CACrC,EAAE,EACF,OAAOd,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAa,EAAM,KAAK,CAAE,UAAAnB,EAAW,KAAAY,EAAM,QAAAC,EAAS,MAAO,OAAOK,GAAU,OAAS,CAAC,CAAE,CAAE,EAAGf,CAAW,CAC1J,OAASkB,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAArB,EAAW,KAAAE,EAAM,IAAI,OAAOmB,CAAG,CAAE,CAAC,CAAC,EAC1Ef,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CAChH,CAIF,GAAID,IAAS,8BAAgCG,IAAW,MACtD,GAAI,CACF,IAAME,EAAIN,EAAI,aACRO,GAAUD,EAAE,IAAI,QAAQ,GAAK,OAAO,KAAK,EACzCE,GAAYF,EAAE,IAAI,UAAU,GAAK,IAAI,KAAK,EAC1CI,GAAWJ,EAAE,IAAI,SAAS,GAAKA,EAAE,IAAI,GAAG,GAAK,IAAI,KAAK,EACtDK,EAAO,KAAK,IAAI,EAAG,SAASL,EAAE,IAAI,MAAM,GAAK,IAAK,EAAE,CAAC,EACrDM,EAAU,KAAK,IAAI,IAAK,KAAK,IAAI,EAAG,SAASN,EAAE,IAAI,SAAS,GAAK,KAAM,EAAE,CAAC,CAAC,EAC3EO,GAAUF,EAAO,GAAKC,EACtBE,EAAQ,CAAC,gBAAgB,EAASC,EAAQ,CAAC,EAC7CR,IAAW,aAAaO,EAAM,KAAK,kBAAkB,EACrDP,IAAW,SAASO,EAAM,KAAK,kBAAkB,EACjDN,IAAYM,EAAM,KAAK,cAAc,EAAGC,EAAM,KAAKP,CAAQ,GAC3DE,IAAWI,EAAM,KAAK,iBAAiB,EAAGC,EAAM,KAAK,IAAIL,CAAO,GAAG,GACvE,IAAMM,EAAWF,EAAM,OAAS,SAASA,EAAM,KAAK,OAAO,CAAC,GAAK,GAC3DG,EAAW,MAAMpB,EAAI,SAAS,QAAQ,6CAA6CmB,CAAQ,EAAE,EAAE,KAAK,GAAGD,CAAK,EAAE,MAAM,EAQpHG,IAPO,MAAMrB,EAAI,SAAS,QAC9B;AAAA;AAAA,WAEGmB,CAAQ;AAAA;AAAA,0BAGb,EAAE,KAAK,GAAGD,EAAOH,EAASC,CAAM,EAAE,IAAI,IAClB,SAAW,CAAC,GAAG,IAAIM,IAAM,CAC3C,GAAIA,EAAE,OACN,SAAUA,EAAE,SACZ,SAAUA,EAAE,UAAY,GACxB,UAAW,OAAOA,EAAE,YAAc,CAAC,EACnC,YAAaA,EAAE,eAAiB,EAChC,UAAWA,EAAE,UACf,EAAE,EACF,OAAOd,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAa,EAAM,KAAK,CAAE,UAAAnB,EAAW,KAAAY,EAAM,QAAAC,EAAS,MAAO,OAAOK,GAAU,OAAS,CAAC,CAAE,CAAE,EAAGf,CAAW,CAC1J,OAASkB,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAArB,EAAW,KAAAE,EAAM,IAAI,OAAOmB,CAAG,CAAE,CAAC,CAAC,EAC1Ef,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CAChH,CAIF,GAAID,IAAS,oCAAsCG,IAAW,MAC5D,GAAI,CACF,IAAME,EAAIN,EAAI,aACRQ,GAAYF,EAAE,IAAI,UAAU,GAAK,IAAI,KAAK,EAC1Ce,GAAYf,EAAE,IAAI,WAAW,GAAKA,EAAE,IAAI,MAAM,GAAK,IAAI,KAAK,EAC5DI,GAAWJ,EAAE,IAAI,SAAS,GAAKA,EAAE,IAAI,GAAG,GAAK,IAAI,KAAK,EACtDK,EAAO,KAAK,IAAI,EAAG,SAASL,EAAE,IAAI,MAAM,GAAK,IAAK,EAAE,CAAC,EACrDM,EAAU,KAAK,IAAI,IAAK,KAAK,IAAI,EAAG,SAASN,EAAE,IAAI,SAAS,GAAK,KAAM,EAAE,CAAC,CAAC,EAC3EO,GAAUF,EAAO,GAAKC,EACtBE,EAAQ,CAAC,gBAAgB,EAASC,EAAQ,CAAC,EAC7CP,IAAYM,EAAM,KAAK,cAAc,EAAGC,EAAM,KAAKP,CAAQ,GAC3Da,IAAYP,EAAM,KAAK,eAAe,EAAGC,EAAM,KAAKM,CAAQ,GAC5DX,IAAWI,EAAM,KAAK,cAAc,EAAGC,EAAM,KAAK,IAAIL,CAAO,GAAG,GACpE,IAAMM,EAAWF,EAAM,OAAS,SAASA,EAAM,KAAK,OAAO,CAAC,GAAK,GAC3DG,EAAW,MAAMpB,EAAI,SAAS,QAAQ,gDAAgDmB,CAAQ,EAAE,EAAE,KAAK,GAAGD,CAAK,EAAE,MAAM,EAQvHG,IAPO,MAAMrB,EAAI,SAAS,QAC9B;AAAA;AAAA,WAEGmB,CAAQ;AAAA;AAAA,0BAGb,EAAE,KAAK,GAAGD,EAAOH,EAASC,CAAM,EAAE,IAAI,IAClB,SAAW,CAAC,GAAG,IAAIM,IAAM,CAC3C,GAAIA,EAAE,YACN,MAAOA,EAAE,MACT,SAAUA,EAAE,UAAY,GACxB,SAAUA,EAAE,WAAa,GACzB,SAAU,OAAOA,EAAE,WAAa,CAAC,EACjC,cAAe,OAAOA,EAAE,gBAAkB,CAAC,EAC3C,UAAWA,EAAE,UACf,EAAE,EACF,OAAOd,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAa,EAAM,KAAK,CAAE,UAAAnB,EAAW,KAAAY,EAAM,QAAAC,EAAS,MAAO,OAAOK,GAAU,OAAS,CAAC,CAAE,CAAE,EAAGf,CAAW,CAC1J,OAASkB,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAArB,EAAW,KAAAE,EAAM,IAAI,OAAOmB,CAAG,CAAE,CAAC,CAAC,EAC1Ef,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CAChH,CAIF,GAAID,IAAS,mCAAqCG,IAAW,MAC3D,GAAI,CAOF,IAAMc,IANO,MAAMrB,EAAI,SAAS,QAC9B;AAAA;AAAA;AAAA,iDAIF,EAAE,IAAI,IACc,SAAW,CAAC,GAAG,IAAIsB,IAAM,CAC3C,GAAIA,EAAE,WACN,IAAKA,EAAE,YACP,MAAOA,EAAE,MACT,YAAaA,EAAE,eAAiB,EAChC,UAAW,OAAOA,EAAE,YAAc,CAAC,EACnC,UAAWA,EAAE,UACf,EAAE,EACF,OAAOd,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAa,EAAM,KAAK,CAAE,UAAAnB,EAAW,MAAOmB,EAAK,MAAO,CAAE,EAAGhB,CAAW,CAC1H,OAASkB,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAArB,EAAW,KAAAE,EAAM,IAAI,OAAOmB,CAAG,CAAE,CAAC,CAAC,EAC1Ef,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CAChH,CAGF,OAAOG,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,qBAAO,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CACzG,CAzJsBoB,EAAA3B,GAAA,aCAtB,IAAM4B,GAAiB,IAAI,IAAI,CAAC,wBAAwB,CAAC,EACnDC,GAAe,IAAI,IAAI,CAC3B,eACA,gBACA,WACA,WACA,qBACA,sBACA,gBACA,cACA,gBACA,yBACA,0BACA,yBACA,sBACF,CAAC,EAED,SAASC,GAAaC,EAAI,CACxB,OAAO,OAAOA,GAAK,EAAE,EAAE,KAAK,CAC9B,CAFSC,EAAAF,GAAA,gBAIT,eAAsBG,GAAeC,EAASC,EAAKC,EAAIC,EAAWC,EAAKC,EAAK,CAC1E,IAAMC,EAAcC,EAAyBP,EAASC,CAAG,EACnDO,EAASR,EAAQ,OAAO,YAAY,EAG1C,GAAIK,IAAS,0BAA4BG,IAAW,MAClD,GAAI,CAIF,IAAMC,IAHO,MAAMR,EAAI,SAAS,QAC9B,+FACF,EAAE,IAAI,IACc,SAAW,CAAC,GAAG,IAAIS,IAAM,CAC3C,QAASA,EAAE,QACX,SAAUA,EAAE,SACZ,KAAMA,EAAE,MAAQA,EAAE,SAClB,SAAU,EAAQA,EAAE,QACtB,EAAE,EACF,OAAOC,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAF,EAAM,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CACtG,OAASM,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAT,EAAW,KAAAE,EAAM,IAAI,OAAOO,CAAG,CAAE,CAAC,CAAC,EAC1ED,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CAChH,CAGF,GAAI,CAACJ,GAAI,SAAU,OAAOS,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,2BAAQ,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,EAG3H,GAAID,IAAS,mCAAqCG,IAAW,MAC3D,GAAI,CACF,IAAMK,EAAO,MAAMZ,EAAI,SAAS,QAC9B,kLACF,EAAE,IAAI,EACAa,EAAM,CAAC,EACb,QAAWJ,KAAMG,GAAM,SAAS,CAAC,EAAIC,EAAIJ,EAAE,GAAG,EAAIA,EAAE,MACpD,OAAOC,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAK,CAAE,MAAOE,GAAM,SAAS,CAAC,EAAG,IAAAC,CAAI,EAAG,KAAK,CAAE,UAAAX,CAAU,CAAE,EAAGG,CAAW,CACxI,OAASM,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAT,EAAW,KAAAE,EAAM,IAAI,OAAOO,CAAG,CAAE,CAAC,CAAC,EAC1ED,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CAChH,CAIF,GAAID,EAAK,WAAW,kCAAkC,GAAKG,IAAW,MAAM,CAC1E,IAAMX,EAAMD,GAAaS,EAAK,QAAQ,mCAAoC,EAAE,CAAC,EAC7E,GAAI,CAACV,GAAa,IAAIE,CAAG,EAAG,OAAOc,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,6CAAW,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,EAC9I,IAAIS,EACJ,GAAI,CAAEA,EAAU,MAAMf,EAAQ,KAAK,CAAG,MAAW,CAAE,OAAOW,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,uCAAU,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CAAG,CAClK,IAAMU,EAAQ,OAAOD,GAAS,OAAS,EAAE,EACzC,GAAIlB,IAAQ,iBAAmBmB,GAAS,CAAC,6BAA6B,KAAKA,CAAK,EAC9E,OAAOL,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,iCAAc,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,EAEvH,GAAIT,IAAQ,qBAAqB,CAC/B,IAAMoB,EAAI,WAAWD,CAAK,EAC1B,GAAI,CAAC,OAAO,SAASC,CAAC,GAAMA,IAAI,KAAQA,IAAI,IAAOA,IAAI,EACrD,OAAON,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,oEAAwB,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CAEnI,CACA,GAAIT,IAAQ,uBACN,EAAEmB,IAAU,KAAOA,IAAU,KAAM,OAAOL,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,wDAAiB,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,EAEjK,IAAIT,IAAQ,iBAAmBA,IAAQ,gBACjC,CAAC,gBAAgB,KAAKmB,CAAK,EAAG,OAAOL,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,6CAAgB,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,EAE3J,GAAIT,IAAQ,yBAAyB,CAEnC,GAAI,CADW,IAAI,IAAI,CAAC,gBAAgB,aAAa,WAAW,UAAU,CAAC,EAC/D,IAAImB,CAAK,EAAG,OAAOL,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,uCAAU,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,EACzI,GAAIZ,GAAe,IAAIG,CAAG,GAAKkB,GAAS,YAAc,GACpD,OAAOJ,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,6CAAW,KAAK,CAAE,UAAAR,EAAW,MAAMN,CAAI,CAAE,EAAGS,CAAW,CAEjI,CACA,GAAIT,IAAQ,0BAA0B,CACpC,IAAMoB,EAAI,SAASD,EAAO,EAAE,EAC5B,GAAI,CAAC,OAAO,UAAUC,CAAC,GAAKA,EAAI,EAAG,OAAON,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,qEAAe,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CAC3J,CACA,GAAIT,IAAQ,yBAAyB,CACnC,IAAMoB,EAAI,WAAWD,CAAK,EAC1B,GAAI,CAAC,OAAO,SAASC,CAAC,GAAKA,EAAI,EAAG,OAAON,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,qEAAe,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CAC1J,CACA,GAAIT,IAAQ,uBAAuB,CACjC,IAAMoB,EAAI,WAAWD,CAAK,EAC1B,GAAI,CAAC,OAAO,SAASC,CAAC,GAAKA,EAAI,GAAKA,EAAI,IAAK,OAAON,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,sEAAqB,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CAC3K,CACA,GAAI,CACF,IAAMY,EAAS,IAAI,KAAK,EAAE,YAAY,EACtC,aAAMjB,EAAI,SAAS,QACjB,yOACF,EAAE,KAAKJ,EAAKmB,EAAOE,EAAQ,OAAOhB,EAAG,SAASA,EAAG,QAAQ,GAAG,CAAC,EAAE,IAAI,EAC5DS,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,qBAAO,KAAK,CAAE,IAAAd,EAAK,MAAAmB,CAAM,EAAG,KAAK,CAAE,UAAAb,CAAU,CAAE,EAAGG,CAAW,CACtH,OAASM,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAT,EAAW,KAAAE,EAAM,IAAI,OAAOO,CAAG,CAAE,CAAC,CAAC,EAC1ED,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CAChH,CACF,CAEA,OAAOK,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,2BAAQ,KAAK,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CAC1G,CA9FsBR,EAAAC,GAAA,kBCrBtB,SAASoB,IAAU,CACjB,IAAM,EAAI,IAAI,KACd,MAAO,GAAG,EAAE,eAAe,CAAC,IAAI,OAAO,EAAE,YAAY,EAAI,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,EAC9E,CAHSC,EAAAD,GAAA,WAKT,SAASE,IAAW,CAClB,IAAM,EAAI,IAAI,KACd,MAAO,GAAG,EAAE,eAAe,CAAC,IAAI,OAAO,EAAE,YAAY,EAAI,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,IAAI,OAAO,EAAE,WAAW,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,EACzH,CAHSD,EAAAC,GAAA,YAKT,eAAsBC,GAAgBC,EAASC,EAAKC,EAAIC,EAAWC,EAAKC,EAAM,CAC5E,IAAMC,EAAcC,EAAyBP,EAASC,CAAG,EACnDO,EAASR,EAAQ,OAAO,YAAY,EAC1C,GAAIK,IAAS,8BAAgCG,IAAW,MACtD,OAAOC,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,qBAAO,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,EAGzG,GAAI,CAEF,IAAMI,EAAe,IAAI,IAAIN,CAAG,EAAE,aAC5BO,EAAcD,EAAa,IAAI,IAAI,EACnCE,EAAKD,GAAe,gBAAgB,KAAKA,CAAW,EAAIA,EAAcf,GAAQ,EAG9EiB,EAAYH,EAAa,IAAI,WAAW,GAAK,gBAAgB,KAAKA,EAAa,IAAI,WAAW,CAAC,EAAIA,EAAa,IAAI,WAAW,EAAIE,EACnIE,EAAcJ,EAAa,IAAI,aAAa,GAAK,QAEjDK,EAAQjB,GAAS,EAGvB,eAAekB,GAAqB,CAClC,IAAMC,EAAM,CAAE,QAAS,KAAM,QAAS,CAAE,MAAO,CAAC,EAAG,OAAQ,CAAE,QAAS,EAAG,WAAY,EAAG,QAAS,EAAG,QAAS,CAAE,CAAE,EAAG,SAAU,KAAM,iBAAkB,CAAC,EAAG,cAAe,CAAC,CAAE,EAE5K,GAAI,CACF,IAAMC,EAAI,MAAMjB,EAAI,SAAS,QAC3B;AAAA;AAAA;AAAA;AAAA,8FAKF,EAAE,KAAK,OAAOC,EAAG,OAAO,EAAGU,CAAE,EAAE,MAAM,EAC/BO,EAAQ,OAAOD,GAAG,OAAS,CAAC,EAAGE,EAAS,OAAOF,GAAG,QAAU,CAAC,EAAGG,EAAW,OAAOH,GAAG,UAAY,CAAC,EAClGI,EAAS,IAAWC,EAAiBD,EAAS,KAAK,MAAOH,EAAQG,EAAU,GAAI,EAAI,GAAK,EAC/FL,EAAI,QAAU,CAAE,MAAOL,EAAI,MAAAO,EAAO,OAAAC,EAAQ,SAAAC,EAAU,YAAaC,EAAQ,eAAAC,CAAe,CAC1F,MAAY,CAAC,CAGb,GAAI,CAOF,IAAMC,IANO,MAAMvB,EAAI,SAAS,QAC9B;AAAA;AAAA;AAAA,kEAIF,EAAE,KAAK,OAAOC,EAAG,OAAO,CAAC,EAAE,IAAI,IACV,SAAW,CAAC,GAAG,IAAIuB,GAAK,CAC3C,IAAMC,EAAMD,EAAE,UAAY,KACtBE,EAAU,SACVC,EAAe,KAAUC,EAAc,KAAYC,EAAM,IAAI,KACjE,GAAIJ,EAAK,CACP,IAAMK,EAAI,IAAI,KAAKL,CAAG,EAASM,EAAQ,KAAK,OAAOD,EAAE,QAAQ,EAAID,EAAI,QAAQ,GAAK,KAAQ,EAC1FF,EAAeI,EACXA,EAAQ,GAAKL,EAAU,UAAWE,EAAc,CAACG,GAC5CA,GAAS,IAAGL,EAAU,SACjC,CACA,MAAO,CAAE,GAAIF,EAAE,QAAS,KAAMA,EAAE,UAAW,QAASC,EAAK,OAAQD,EAAE,OAAQ,QAAAE,EAAS,aAAAC,EAAc,YAAAC,EAAa,OAAQ,CAAC,EAAEJ,EAAE,gBAAkBA,EAAE,uBAAwB,CAC1K,CAAC,EACKQ,EAAS,CAAE,QAAS,EAAG,WAAY,EAAG,QAAS,EAAG,QAAS,CAAE,EACnE,QAAWC,KAAMV,EACXU,EAAG,SAAW,WAAWD,EAAO,UAChCC,EAAG,SAAW,eAAeD,EAAO,aACpCC,EAAG,UAAY,WAAWD,EAAO,UACjC,OAAOC,EAAG,cAAiB,UAAYA,EAAG,cAAgB,GAAKA,EAAG,cAAgB,GAAGD,EAAO,UAElGhB,EAAI,QAAU,CAAE,MAAAO,EAAO,OAAAS,CAAO,CAChC,MAAY,CAAC,CAGb,GAAI,CACF,IAAME,EAAO,MAAMlC,EAAI,SAAS,QAC9B,kGACF,EAAE,KAAK,OAAOC,EAAG,OAAO,CAAC,EAAE,IAAI,EACzBkC,EAAM,CAAE,OAAQ,EAAG,KAAM,EAAG,UAAW,CAAE,EAC/C,QAAWX,KAAMU,GAAM,SAAW,CAAC,EAAI,CACrC,IAAME,GAAKZ,EAAE,MAAQ,IAAI,YAAY,EACjCY,IAAM,SAAUD,EAAI,OAAS,OAAOX,EAAE,WAAa,CAAC,EAC/CY,IAAM,OAAQD,EAAI,KAAO,OAAOX,EAAE,WAAa,CAAC,EAChDY,IAAM,SAAQD,EAAI,UAAY,OAAOX,EAAE,WAAa,CAAC,EAChE,CAIA,IAAMa,IAHa,MAAMrC,EAAI,SAAS,QACpC,yIACF,EAAE,KAAK,OAAOC,EAAG,OAAO,CAAC,EAAE,IAAI,IACH,SAAW,CAAC,GAAG,IAAIuB,IAAM,CAAE,KAAMA,EAAE,KAAM,UAAWA,EAAE,WAAY,KAAM,OAAOA,EAAE,QAAU,CAAC,EAAG,OAAQA,EAAE,MAAO,EAAE,EAC9IR,EAAI,SAAW,CAAE,SAAUmB,EAAK,OAAAE,CAAO,CACzC,MAAY,CAAC,CAEb,OAAOrB,CACT,CAlEepB,EAAAmB,EAAA,sBAqEf,eAAeuB,EAAgBC,EAAUC,EAAOC,EAAS,CACvD,IAAMzB,EAAM,CAAE,cAAe,CAAC,EAAG,cAAe,CAAC,EAAG,gBAAiB,KAAM,aAAc,CAAC,CAAE,EAI5F,GAAI,CAcF,IAAMkB,GAbS,MAAMlC,EAAI,SAAS,QAChC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,2CASF,EAAE,KAAKuC,CAAQ,EAAE,IAAI,IAGA,SAAW,CAAC,EACjCvB,EAAI,cAAgBkB,EAAK,IAAIV,IAAM,CACjC,OAAQA,EAAE,QACV,KAAMA,EAAE,MAAQA,EAAE,UAAY,qBAC9B,MAAO,OAAOA,EAAE,OAAS,CAAC,EAC1B,OAAQ,OAAOA,EAAE,QAAU,CAAC,EAC5B,SAAU,OAAOA,EAAE,UAAY,CAAC,CAClC,EAAE,CACJ,OAASkB,EAAG,CACV,QAAQ,MAAM,0CAA2CA,CAAC,CAC5D,CAGA,GAAI,CACF,IAAMC,EAAcH,EAAM,MAAM,GAAG,EAAE,CAAC,EAGhCI,EAAQ,MAAM5C,EAAI,SAAS,QAC/B,sGACF,EAAE,MAAM,EACF6C,EAAa,MAAM7C,EAAI,SAAS,QACpC,uHACF,EAAE,KAAKc,CAAK,EAAE,MAAM,EACdgC,EAAK,KAAK,MAAM,OAAOF,GAAO,IAAM,CAAC,CAAC,EACtCG,EAAU,KAAK,MAAM,OAAOF,GAAY,IAAM,CAAC,CAAC,EAElDG,EAAY,KACZC,EAAU,KAEd,GAAIR,IAAY,QAAS,CAEvB,IAAMS,EAAe,MAAMlD,EAAI,SAAS,QACtC,0HACF,EAAE,KAAKwC,CAAK,EAAE,MAAM,EACdW,EAAc,MAAMnD,EAAI,SAAS,QACrC,mIACF,EAAE,KAAKwC,CAAK,EAAE,MAAM,EAChBY,EAAY,EAChB,GAAI,CACF,IAAMC,EAAK,MAAMrD,EAAI,SAAS,QAAQ,qHAAqH,EAAE,KAAKwC,CAAK,EAAE,MAAM,EAC/KY,EAAY,KAAK,MAAM,OAAOC,GAAI,GAAK,CAAC,EAAI,GAAG,CACjD,MAAY,CAAC,CAEb,IAAMC,EAAe,KAAK,MAAM,OAAOH,GAAa,SAAW,CAAC,CAAC,EAC3DI,EAAY,KAAK,MAAM,OAAOL,GAAc,MAAQ,CAAC,CAAC,EACtDM,EAAcF,EAAeF,EAC7BK,EAAcH,EAAe,EAAI,KAAK,MAAOE,EAAcF,EAAgB,GAAI,EAAI,GAAK,EACxFI,EAAsBJ,EAAe,EAAI,KAAK,MAAOC,EAAYD,EAAgB,GAAI,EAAI,GAAK,EAEpGN,EAAY,CACV,OAAQR,EACR,QAASc,EACT,KAAMF,EACN,OAAQI,EACR,OAAQC,EACR,GAAAX,EACA,KAAMS,EACN,QAAAR,EACA,eAAgBW,CAClB,CACF,KAAO,CAEL,IAAMC,EAAa,MAAM3D,EAAI,SAAS,QACpC,gJACF,EAAE,KAAK2C,EAAa7B,CAAK,EAAE,MAAM,EAC3B8C,EAAY,MAAM5D,EAAI,SAAS,QACnC,yJACF,EAAE,KAAK2C,EAAa7B,CAAK,EAAE,MAAM,EAC7B+C,EAAU,EACd,GAAI,CACF,IAAMR,EAAK,MAAMrD,EAAI,SAAS,QAAQ,iIAAiI,EAAE,KAAK2C,CAAW,EAAE,MAAM,EACjMkB,EAAU,KAAK,MAAM,OAAOR,GAAI,GAAK,CAAC,EAAI,GAAG,CAC/C,MAAY,CAAC,CAEb,IAAMS,EAAa,KAAK,MAAM,OAAOF,GAAW,SAAW,CAAC,CAAC,EACvDG,EAAU,KAAK,MAAM,OAAOJ,GAAY,MAAQ,CAAC,CAAC,EAClDK,EAAYF,EAAaD,EACzBI,EAAYH,EAAa,EAAI,KAAK,MAAOE,EAAYF,EAAc,GAAI,EAAI,GAAK,EAChFI,EAAoBJ,EAAa,EAAI,KAAK,MAAOC,EAAUD,EAAc,GAAI,EAAI,GAAK,EAE5Fb,EAAU,CACR,OAAQ,GAAGN,CAAW,qBACtB,QAASmB,EACT,KAAMD,EACN,OAAQG,EACR,OAAQC,EACR,GAAAnB,EACA,KAAMiB,EACN,QAAAhB,EACA,eAAgBmB,CAClB,CACF,CAEAlD,EAAI,gBAAkB,CACpB,MAAOgC,EACP,IAAKC,CACP,CACF,MAAY,CAAC,CAGb,GAAI,CACF,IAAMf,EAAO,MAAMlC,EAAI,SAAS,QAC9B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kDAUF,EAAE,KAAKc,CAAK,EAAE,IAAI,EAElBE,EAAI,eAAiBkB,GAAM,SAAW,CAAC,GAAG,IAAIV,IAAM,CAClD,OAAQA,EAAE,QACV,KAAMA,EAAE,MAAQA,EAAE,SAClB,UAAW,OAAOA,EAAE,WAAa,CAAC,EAClC,WAAY,OAAOA,EAAE,YAAc,CAAC,EACpC,QAAS,OAAOA,EAAE,SAAW,CAAC,EAC9B,QAAS,OAAOA,EAAE,SAAW,CAAC,CAChC,EAAE,CACJ,MAAY,CAAC,CAGb,GAAI,CAOF,IAAM2C,IANO,MAAMnE,EAAI,SAAS,QAC9B;AAAA;AAAA;AAAA,gDAIF,EAAE,IAAI,IACc,SAAW,CAAC,GAAG,IAAIwB,IAAM,CAAE,MAAOA,EAAE,GAAI,QAAS,OAAOA,EAAE,SAAW,CAAC,EAAG,KAAM,OAAOA,EAAE,MAAQ,CAAC,CAAE,EAAE,EACzHR,EAAI,aAAemD,EAAK,KAAK,CAACC,EAAE,IAAKA,EAAE,MAAM,cAAc,EAAE,KAAK,CAAC,CACrE,MAAY,CAAC,CAEb,OAAOpD,CACT,CA5JepB,EAAA0C,EAAA,mBA8Jf,IAAM+B,EAAO,CAAE,KAAMpE,EAAG,SAAW,QAAU,UAAW,EACxD,OAAIA,EAAG,SACLoE,EAAK,MAAQ,MAAM/B,EAAgB3B,EAAIC,EAAWC,CAAW,EAE7DwD,EAAK,SAAW,MAAMtD,EAAmB,EAGpCP,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAA6D,EAAM,KAAK,CAAE,UAAAnE,EAAW,MAAOS,EAAI,UAAAC,EAAW,YAAAC,EAAa,MAAAC,CAAM,CAAE,EAAGT,CAAW,CAChJ,OAASiE,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAApE,EAAW,KAAAE,EAAM,IAAI,OAAOkE,CAAG,CAAE,CAAC,CAAC,EAC1E9D,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAN,CAAU,CAAE,EAAGG,CAAW,CAChH,CACF,CAnQsBT,EAAAE,GAAA,mBCVtB,SAASyE,GAAgBC,EAAMC,EAAO,CACpC,MAAK,CAAC,QAAQ,SAAS,UAAU,MAAM,EAAE,SAASD,CAAI,EAClDA,IAAS,QAAgB,gBAAgB,KAAKC,GAAO,EAAE,EACvDD,IAAS,SAAiB,kCAAkC,KAAKC,GAAO,EAAE,EAC1ED,IAAS,UAAkB,4BAA4B,KAAKC,GAAO,EAAE,EACrED,IAAS,OAAe,OAAOC,GAAU,UAAYA,EAAM,KAAK,EAAE,OAAS,EACxE,GALyD,EAMlE,CAPSC,EAAAH,GAAA,mBAST,SAASI,EAAcC,EAAGC,EAAI,KAAM,CAAE,GAAI,CAAE,OAAO,KAAK,MAAM,OAAOD,GAAG,MAAM,CAAC,CAAG,MAAW,CAAE,OAAOC,CAAK,CAAE,CAApGH,EAAAC,EAAA,iBAET,eAAsBG,GAAiBC,EAASC,EAAKC,EAAIC,EAAWC,EAAKC,EAAM,CAC7E,IAAMC,EAAcC,EAAyBP,EAASC,CAAG,EACzD,GAAI,CAACC,GAAI,SAAU,OAAOM,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,2BAAQ,KAAK,CAAE,UAAAL,CAAU,CAAE,EAAGG,CAAW,EAC3H,IAAMG,EAAST,EAAQ,OAAO,YAAY,EAG1C,GAAIK,IAAS,2CAA6CI,IAAW,MACnE,GAAI,CACF,IAAMC,EAAIN,EAAI,aAAoBO,GAAKD,EAAE,IAAI,GAAG,GAAG,IAAI,KAAK,EAASE,EAAUF,EAAE,IAAI,SAAS,EACxFG,EAAO,KAAK,IAAI,EAAG,SAASH,EAAE,IAAI,MAAM,GAAG,IAAI,EAAE,CAAC,EAASI,EAAU,KAAK,IAAI,IAAK,KAAK,IAAI,EAAG,SAASJ,EAAE,IAAI,SAAS,GAAG,KAAK,EAAE,CAAC,CAAC,EACnIK,GAAUF,EAAK,GAAGC,EAAeE,EAAM,CAAC,cAAc,EAASC,EAAM,CAAC,EACxEN,IAAKK,EAAM,KAAK,kBAAkB,EAAGC,EAAM,KAAK,IAAIN,CAAC,GAAG,IACxDC,IAAU,KAAOA,IAAU,OAAOI,EAAM,KAAK,gBAAgB,EAAGC,EAAM,KAAK,SAASL,EAAQ,EAAE,CAAC,GACnG,IAAMM,EAAWF,EAAM,OAAO,SAASA,EAAM,KAAK,OAAO,CAAC,GAAG,GACvDG,EAAW,MAAMlB,EAAI,SAAS,QAAQ,iDAAiDiB,CAAQ,EAAE,EAAE,KAAK,GAAGD,CAAK,EAAE,MAAM,EAKxHG,IAJO,MAAMnB,EAAI,SAAS,QAC9B;AAAA,gCACwBiB,CAAQ,0DAClC,EAAE,KAAK,GAAGD,EAAOH,EAASC,CAAM,EAAE,IAAI,IAClB,SAAS,CAAC,GAAG,IAAIM,IAAI,CAAE,GAAGA,EAAE,QAAS,KAAKA,EAAE,UAAW,aAAaA,EAAE,cAAe,cAAcA,EAAE,eAAgB,UAAUA,EAAE,aAAa,EAAG,UAAUA,EAAE,YAAa,UAAUA,EAAE,WAAY,UAAUA,EAAE,UAAW,EAAE,EAC/O,OAAOb,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,eAAM,KAAAY,EAAM,KAAK,CAAE,UAAAjB,EAAW,KAAAU,EAAM,QAAAC,EAAS,MAAM,OAAOK,GAAU,OAAO,CAAC,CAAE,CAAE,EAAGb,CAAW,CACvJ,OAASgB,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAnB,EAAW,KAAAE,EAAM,IAAI,OAAOiB,CAAG,CAAE,CAAC,CAAC,EAC1Ed,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAL,CAAU,CAAE,EAAGG,CAAW,CAChH,CAIF,GAAID,IAAS,2CAA6CI,IAAW,OAAQ,CAC3E,IAAIc,EAAM,GAAI,CAAEA,EAAO,MAAMvB,EAAQ,KAAK,CAAG,MAAW,CAAE,OAAOQ,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,uCAAU,KAAK,CAAE,UAAAL,CAAU,CAAE,EAAGG,CAAW,CAAG,CACzK,IAAMkB,EAAO,OAAOD,GAAM,WAAaA,GAAM,MAAQ,EAAE,EAAE,KAAK,EACxDE,EAAe,OAAOF,GAAM,eAAiBA,GAAM,cAAgB,EAAE,EAAE,KAAK,EAC5EG,EAAgB,OAAOH,GAAM,gBAAkBA,GAAM,eAAiB,EAAE,EAAE,KAAK,EAC/EI,EAAYJ,GAAM,gBAAkBA,GAAM,WAAa,KACvDK,EAASL,GAAM,aAAeA,GAAM,QAAU,KAC9CM,EAAS,CAAC,EAIhB,GAHKL,GAAMK,EAAO,KAAK,CAAE,MAAM,YAAa,QAAQ,cAAK,CAAC,EACrDrC,GAAgBiC,EAAcC,CAAa,GAAGG,EAAO,KAAK,CAAE,MAAM,WAAY,QAAQ,gCAAQ,CAAC,EAC/FD,GAAQC,EAAO,KAAK,CAAE,MAAM,SAAU,QAAQ,cAAK,CAAC,EACrDA,EAAO,OAAQ,OAAOrB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,2BAAQ,OAAAqB,EAAQ,KAAK,CAAE,UAAA1B,CAAU,CAAE,EAAGG,CAAW,EAC1I,GAAI,CACF,MAAML,EAAI,SAAS,QACjB,2IACF,EAAE,KAAKuB,EAAMC,EAAcC,EAAe,KAAK,UAAUC,GAAa,CAAC,CAAC,EAAG,KAAK,UAAUC,GAAU,CAAC,CAAC,CAAC,EAAE,IAAI,EAC7G,IAAME,EAAQ,MAAM7B,EAAI,SAAS,QAAQ,kCAAkC,EAAE,MAAM,EACnF,OAAOO,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,UAAW,QAAQ,qBAAO,KAAK,CAAE,GAAG,OAAOsB,GAAO,IAAI,CAAC,CAAE,EAAG,KAAK,CAAE,UAAA3B,CAAU,CAAE,EAAGG,CAAW,CACxI,OAASgB,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAnB,EAAW,KAAAE,EAAM,IAAI,OAAOiB,CAAG,CAAE,CAAC,CAAC,EAC1Ed,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAL,CAAU,CAAE,EAAGG,CAAW,CAChH,CACF,CAGA,IAAMyB,EAAc1B,EAAK,MAAM,uDAAuD,EACtF,GAAI0B,EAAa,CACf,GAAI,CAAC,CAAC,MAAM,QAAQ,EAAE,SAAStB,CAAM,EAAG,OAAOD,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAL,CAAU,CAAE,EAAGG,CAAW,EAC1J,IAAM0B,EAAK,SAASD,EAAY,CAAC,EAAE,EAAE,EACrC,GAAItB,IAAW,SACb,GAAI,CACF,aAAMR,EAAI,SAAS,QAAQ,6DAA6D,EAAE,KAAK+B,CAAE,EAAE,IAAI,EAChGxB,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,qBAAO,KAAK,CAAE,GAAAwB,CAAG,EAAG,KAAK,CAAE,UAAA7B,CAAU,CAAE,EAAGG,CAAW,CAC9G,OAASgB,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAnB,EAAW,KAAAE,EAAM,IAAI,OAAOiB,CAAG,CAAE,CAAC,CAAC,EAC1Ed,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAL,CAAU,CAAE,EAAGG,CAAW,CAChH,CAEF,IAAIiB,EAAM,GAAI,CAAEA,EAAO,MAAMvB,EAAQ,KAAK,CAAG,MAAW,CAAE,OAAOQ,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,uCAAU,KAAK,CAAE,UAAAL,CAAU,CAAE,EAAGG,CAAW,CAAG,CACzK,IAAMkB,EAAOD,GAAM,YAAc,OAAY,OAAOA,EAAK,SAAS,EAAE,KAAK,EAAI,OACvEE,EAAeF,GAAM,gBAAkB,OAAY,OAAOA,EAAK,aAAa,EAAE,KAAK,EAAI,OACvFG,EAAgBH,GAAM,iBAAmB,OAAY,OAAOA,EAAK,cAAc,EAAE,KAAK,EAAI,OAC1FU,EAAYV,GAAM,WAClBI,EAAYJ,GAAM,iBAAmB,OAAY,KAAK,UAAU3B,EAAc2B,EAAK,eAAgB,CAAC,CAAC,CAAC,EAAI,OAC1GK,EAASL,GAAM,cAAgB,OAAY,KAAK,UAAU3B,EAAc2B,EAAK,YAAa,CAAC,CAAC,CAAC,EAAI,OACjGW,EAAO,CAAC,EAASjB,EAAQ,CAAC,EAChC,GAAIO,IAAS,OAAW,CAAE,GAAI,CAACA,EAAM,OAAOhB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,2BAAQ,KAAK,CAAE,UAAAL,CAAU,CAAE,EAAGG,CAAW,EAAG4B,EAAK,KAAK,eAAe,EAAGjB,EAAM,KAAKO,CAAI,CAAG,CACrM,GAAIC,IAAiB,QAAaC,IAAkB,OAAW,CAC7D,IAAMS,EAAIV,IAAiB,MAAMxB,EAAI,SAAS,QAAQ,6DAA6D,EAAE,KAAK+B,CAAE,EAAE,MAAM,IAAI,cAClII,EAAIV,IAAkB,MAAMzB,EAAI,SAAS,QAAQ,8DAA8D,EAAE,KAAK+B,CAAE,EAAE,MAAM,IAAI,eAC1I,GAAI,CAACxC,GAAgB2C,EAAGC,CAAC,EAAG,OAAO5B,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,mBAAoB,QAAQ,iCAAS,KAAK,CAAE,UAAAL,CAAU,CAAE,EAAGG,CAAW,EACxImB,IAAiB,SAAaS,EAAK,KAAK,mBAAmB,EAAGjB,EAAM,KAAKQ,CAAY,GACrFC,IAAkB,SAAaQ,EAAK,KAAK,oBAAoB,EAAGjB,EAAM,KAAKS,CAAa,EAC9F,CAIA,GAHIC,IAAc,SAAaO,EAAK,KAAK,oBAAoB,EAAGjB,EAAM,KAAKU,CAAS,GAChFC,IAAW,SAAaM,EAAK,KAAK,iBAAiB,EAAGjB,EAAM,KAAKW,CAAM,IACvEK,IAAc,GAAKA,IAAc,GAAKA,IAAc,IAAQA,IAAc,MAASC,EAAK,KAAK,gBAAgB,EAAGjB,EAAM,KAAMgB,IAAY,GAAGA,IAAY,GAAM,EAAE,CAAC,GAChK,CAACC,EAAK,OAAQ,OAAO1B,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,cAAe,QAAQ,uCAAU,KAAK,CAAE,UAAAL,CAAU,CAAE,EAAGG,CAAW,EAC9H4B,EAAK,KAAK,8BAAgC,EAC1C,GAAI,CACF,aAAMjC,EAAI,SAAS,QAAQ,8BAA8BiC,EAAK,KAAK,IAAI,CAAC,oBAAoB,EAAE,KAAK,GAAGjB,EAAOe,CAAE,EAAE,IAAI,EAC9GxB,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,qBAAO,KAAK,CAAE,GAAAwB,CAAG,EAAG,KAAK,CAAE,UAAA7B,CAAU,CAAE,EAAGG,CAAW,CAC9G,OAASgB,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAnB,EAAW,KAAAE,EAAM,IAAI,OAAOiB,CAAG,CAAE,CAAC,CAAC,EAC1Ed,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAL,CAAU,CAAE,EAAGG,CAAW,CAChH,CACF,CAGA,IAAM+B,EAAYhC,EAAK,MAAM,6DAA6D,EAC1F,GAAIgC,EAAW,CACb,GAAI5B,IAAW,OAAQ,OAAOD,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,qBAAsB,QAAQ,iCAAS,KAAK,CAAE,UAAAL,CAAU,CAAE,EAAGG,CAAW,EACzI,IAAM0B,EAAK,SAASK,EAAU,CAAC,EAAG,EAAE,EACpC,GAAI,CACF,IAAMC,EAAM,MAAMrC,EAAI,SAAS,QAAQ,6JAA6J,EAAE,KAAK+B,CAAE,EAAE,MAAM,EACrN,GAAI,CAACM,EAAK,OAAO9B,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,iCAAS,KAAK,CAAE,UAAAL,CAAU,CAAE,EAAGG,CAAW,EACnH,IAAMqB,EAAY/B,EAAc0C,EAAI,eAAgB,CAAC,CAAC,EAChDV,EAAShC,EAAc0C,EAAI,YAAa,CAAC,CAAC,EAE1CC,EAAU,CAAE,OAAQD,EAAI,QAAS,SAAUA,EAAI,UAAW,YAAa,CAAC,CAACA,EAAI,WAAY,UAAAX,EAAW,OAAAC,CAAO,EACjH,OAAOpB,EAAa,IAAK,CAAE,GAAG,GAAM,KAAK,KAAM,QAAQ,2BAAQ,KAAM+B,EAAS,KAAK,CAAE,UAAApC,CAAU,CAAE,EAAGG,CAAW,CACjH,OAASgB,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAM,QAAS,UAAAnB,EAAW,KAAAE,EAAM,IAAI,OAAOiB,CAAG,CAAE,CAAC,CAAC,EAC1Ed,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,iBAAkB,QAAQ,iCAAS,KAAK,CAAE,UAAAL,CAAU,CAAE,EAAGG,CAAW,CAChH,CACF,CAEA,OAAOE,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,qBAAO,KAAK,CAAE,UAAAL,CAAU,CAAE,EAAGG,CAAW,CACzG,CApHsBX,EAAAI,GAAA,oBCRtB,eAAsByC,GAAeC,EAASC,EAAKC,EAAIC,EAAWC,EAAK,CACtE,IAAMC,EAAcC,EAAyBN,EAASC,CAAG,EAGzD,GAFeD,EAAQ,OAAO,YAAY,IAE3B,MACd,GAAI,CACH,IAAMO,EAASH,EAAI,aACbI,GAAaD,EAAO,IAAI,YAAY,GAAK,IAAI,KAAK,EAClDE,GAAWF,EAAO,IAAI,UAAU,GAAK,IAAI,KAAK,EAE9CG,EAAQ,CAAC,EACTC,EAAQ,CAAC,EAGXH,IACHE,EAAM,KAAK,mBAAmB,EAC9BC,EAAM,KAAKH,CAAS,GAEjBC,IACHC,EAAM,KAAK,mBAAmB,EAC9BC,EAAM,KAAKF,CAAO,GAGnB,IAAMG,EAAWF,EAAM,OAAS,SAASA,EAAM,KAAK,OAAO,CAAC,GAAK,GAS5DG,IAPQ,MAAMZ,EAAI,SAAS,QAC/B;AAAA;AAAA,OAEGW,CAAQ;AAAA,+BAEZ,EAAE,KAAK,GAAGD,CAAK,EAAE,IAAI,IAEF,SAAW,CAAC,GAAG,IAAIG,IAAM,CAC5C,aAAcA,EAAE,aAChB,KAAMA,EAAE,aACR,KAAMA,EAAE,MAAQ,GAChB,oBAAqB,EAAQA,EAAE,oBAC/B,kBAAmB,EAAQA,EAAE,kBAC7B,kBAAmB,EAAQA,EAAE,iBAC9B,EAAE,EAED,OAAOC,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAAF,EACA,KAAM,CAAE,UAAAV,CAAU,CACnB,EAAGE,CAAW,CAEf,OAASW,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAb,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOY,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAd,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQgB,EAAK,MAAQ,OAAOD,CAAG,GAC3DD,EAAa,IAAKE,EAAMX,EAAyBN,EAASC,CAAG,CAAC,CACtE,CAGD,OAAOc,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,qBACN,QAAS,iCACT,KAAM,CAAE,UAAAZ,CAAU,CACnB,EAAGE,CAAW,CACf,CA/DsBa,EAAAnB,GAAA,kBCItB,eAAsBoB,GAAWC,EAASC,EAAKC,EAAIC,EAAWC,EAAK,CAClE,IAAMC,EAAcC,EAAyBN,EAASC,CAAG,EACnDM,EAASP,EAAQ,OAAO,YAAY,EAG1C,GAAIO,IAAW,OAAS,CAACH,EAAI,SAAS,MAAM,cAAc,EACzD,GAAI,CAKH,IAAMI,IAJO,MAAMP,EAAI,SAAS,QAC/B,wFACD,EAAE,IAAI,IAEc,SAAW,CAAC,GAAG,IAAIQ,IAAM,CAC5C,OAAQA,EAAE,OACV,SAAUA,EAAE,SACZ,UAAWA,EAAE,WAAa,KAC1B,WAAYA,EAAE,UACf,EAAE,EAEF,OAAOC,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAAF,EACA,KAAM,CAAE,UAAAL,CAAU,CACnB,EAAGE,CAAW,CAEf,OAASM,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAR,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOO,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAT,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQW,EAAK,MAAQ,OAAOD,CAAG,GAC3DD,EAAa,IAAKE,EAAMP,CAAW,CAC3C,CAID,GAAIE,IAAW,OAASH,EAAI,SAAS,MAAM,cAAc,EAAG,CAC3D,IAAMS,EAAQ,SAAST,EAAI,SAAS,MAAM,GAAG,EAAE,IAAI,EAAG,EAAE,EACxD,GAAI,CACH,IAAMU,EAAM,MAAMb,EAAI,SAAS,QAC9B,mFACD,EAAE,KAAKY,CAAK,EAAE,MAAM,EAEpB,GAAI,CAACC,EACJ,OAAOJ,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,YACN,QAAS,iCACT,KAAM,CAAE,UAAAP,CAAU,CACnB,EAAGE,CAAW,EAGf,IAAMG,EAAO,CACZ,OAAQM,EAAI,OACZ,SAAUA,EAAI,SACd,UAAWA,EAAI,WAAa,KAC5B,WAAYA,EAAI,UACjB,EAEA,OAAOJ,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAAF,EACA,KAAM,CAAE,UAAAL,CAAU,CACnB,EAAGE,CAAW,CAEf,OAASM,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAR,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOO,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAT,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQW,EAAK,MAAQ,OAAOD,CAAG,GAC3DD,EAAa,IAAKE,EAAMP,CAAW,CAC3C,CACD,CAGA,GAAIE,IAAW,OAAQ,CACtB,IAAIK,EACJ,GAAI,CACHA,EAAO,MAAMZ,EAAQ,KAAK,CAC3B,MAAY,CACX,OAAOU,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,cAAe,QAAS,uCAAU,KAAM,CAAE,UAAAP,CAAU,CAAE,EAAGE,CAAW,CACjH,CAEA,IAAMU,EAAS,CAAC,EACVC,EAAU,OAAOJ,GAAM,UAAY,EAAE,EAAE,KAAK,EAC5CK,EAAW,OAAOL,GAAM,WAAa,EAAE,EAAE,KAAK,EASpD,IANI,CAACI,GAAWA,EAAQ,OAAS,GAAKA,EAAQ,OAAS,KACtDD,EAAO,KAAK,CAAE,MAAO,WAAY,QAAS,kEAAiB,CAAC,EAEzDE,GAAY,CAAC,oBAAoB,KAAKA,CAAQ,GACjDF,EAAO,KAAK,CAAE,MAAO,YAAa,QAAS,4EAAsB,CAAC,EAE/DA,EAAO,OACV,OAAOL,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,2BAAQ,OAAAK,EAAQ,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGE,CAAW,EAG5H,GAAI,CAGH,GADiB,MAAMJ,EAAI,SAAS,QAAQ,uDAAuD,EAAE,KAAKe,CAAO,EAAE,MAAM,EAExH,OAAON,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,WAAY,QAAS,6CAAW,KAAM,CAAE,UAAAP,CAAU,CAAE,EAAGE,CAAW,EAG/G,IAAMa,EAAM,IAAI,KAAK,EAAE,YAAY,EACnC,MAAMjB,EAAI,SAAS,QAClB,6EACD,EAAE,KAAKe,EAASC,GAAY,KAAMC,CAAG,EAAE,IAAI,EAG3C,IAAMV,EAAO,CAAE,QADD,MAAMP,EAAI,SAAS,QAAQ,kCAAkC,EAAE,MAAM,IACrD,GAAI,SAAUe,EAAS,UAAWC,GAAY,KAAM,WAAYC,CAAI,EAElG,OAAOR,EAAa,IAAK,CAAE,GAAI,GAAM,KAAM,UAAW,QAAS,qBAAO,KAAAF,EAAM,KAAM,CAAE,UAAAL,CAAU,CAAE,EAAGE,CAAW,CAE/G,OAASM,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAR,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOO,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAT,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQW,EAAK,MAAQ,OAAOD,CAAG,GAC3DD,EAAa,IAAKE,EAAMP,CAAW,CAC3C,CACD,CAGA,GAAIE,IAAW,OAASH,EAAI,SAAS,MAAM,cAAc,EAAG,CAC3D,IAAMS,EAAQ,SAAST,EAAI,SAAS,MAAM,GAAG,EAAE,IAAI,EAAG,EAAE,EACpDQ,EACJ,GAAI,CACHA,EAAO,MAAMZ,EAAQ,KAAK,CAC3B,MAAY,CACX,OAAOU,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,cAAe,QAAS,uCAAU,KAAM,CAAE,UAAAP,CAAU,CAAE,EAAGE,CAAW,CACjH,CAEA,IAAMU,EAAS,CAAC,EACVC,EAAUJ,GAAM,SAAW,OAAOA,EAAK,QAAQ,EAAE,KAAK,EAAI,KAC1DK,EAAWL,GAAM,UAAY,OAAOA,EAAK,SAAS,EAAE,KAAK,EAAI,KASnE,GANII,IAAY,OAASA,EAAQ,OAAS,GAAKA,EAAQ,OAAS,KAC/DD,EAAO,KAAK,CAAE,MAAO,WAAY,QAAS,6DAAiB,CAAC,EAEzDE,IAAa,MAAQA,IAAa,IAAM,CAAC,oBAAoB,KAAKA,CAAQ,GAC7EF,EAAO,KAAK,CAAE,MAAO,YAAa,QAAS,4EAAsB,CAAC,EAE/DA,EAAO,OACV,OAAOL,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,2BAAQ,OAAAK,EAAQ,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGE,CAAW,EAG5H,GAAI,CAGH,GAAI,CADa,MAAMJ,EAAI,SAAS,QAAQ,qDAAqD,EAAE,KAAKY,CAAK,EAAE,MAAM,EAEpH,OAAOH,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAP,CAAU,CAAE,EAAGE,CAAW,EAI9G,GAAIW,IAAY,MACH,MAAMf,EAAI,SAAS,QAAQ,uEAAuE,EAAE,KAAKe,EAASH,CAAK,EAAE,MAAM,EAE1I,OAAOH,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,WAAY,QAAS,6CAAW,KAAM,CAAE,UAAAP,CAAU,CAAE,EAAGE,CAAW,EAKhH,IAAMc,EAAU,CAAC,EACXC,EAAQ,CAAC,EAUf,OATIJ,IAAY,OACfG,EAAQ,KAAK,cAAc,EAC3BC,EAAM,KAAKJ,CAAO,GAEfC,IAAa,OAChBE,EAAQ,KAAK,eAAe,EAC5BC,EAAM,KAAKH,IAAa,GAAK,KAAOA,CAAQ,GAGzCE,EAAQ,SAAW,EACfT,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,cAAe,QAAS,mDAAY,KAAM,CAAE,UAAAP,CAAU,CAAE,EAAGE,CAAW,GAGnHe,EAAM,KAAKP,CAAK,EAChB,MAAMZ,EAAI,SAAS,QAClB,2BAA2BkB,EAAQ,KAAK,IAAI,CAAC,mBAC9C,EAAE,KAAK,GAAGC,CAAK,EAAE,IAAI,EAGdV,EAAa,IAAK,CAAE,GAAI,GAAM,KAAM,UAAW,QAAS,qBAAO,KADzD,CAAE,OAAQG,EAAO,SAAUG,EAAS,UAAWC,CAAS,EACO,KAAM,CAAE,UAAAd,CAAU,CAAE,EAAGE,CAAW,EAE/G,OAASM,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAR,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOO,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAT,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQW,EAAK,MAAQ,OAAOD,CAAG,GAC3DD,EAAa,IAAKE,EAAMP,CAAW,CAC3C,CACD,CAGA,GAAIE,IAAW,UAAYH,EAAI,SAAS,MAAM,cAAc,EAAG,CAC9D,IAAMS,EAAQ,SAAST,EAAI,SAAS,MAAM,GAAG,EAAE,IAAI,EAAG,EAAE,EACxD,GAAI,CAGH,GAAI,CADa,MAAMH,EAAI,SAAS,QAAQ,qDAAqD,EAAE,KAAKY,CAAK,EAAE,MAAM,EAEpH,OAAOH,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAP,CAAU,CAAE,EAAGE,CAAW,EAI9G,IAAMgB,EAAQ,MAAMpB,EAAI,SAAS,QAAQ,mEAAmE,EAAE,KAAKY,CAAK,EAAE,MAAM,EAChI,OAAI,OAAOQ,GAAO,KAAO,CAAC,EAAI,EACtBX,EAAa,IAAK,CACxB,GAAI,GACJ,KAAM,WACN,QAAS,kCAASW,EAAM,GAAG,gEAC3B,KAAM,CAAE,UAAAlB,CAAU,CACnB,EAAGE,CAAW,GAIf,MAAMJ,EAAI,SAAS,QAAQ,2CAA2C,EAAE,KAAKY,CAAK,EAAE,IAAI,EAEjFH,EAAa,IAAK,CAAE,GAAI,GAAM,KAAM,UAAW,QAAS,qBAAO,KAAM,CAAE,UAAAP,CAAU,CAAE,EAAGE,CAAW,EAEzG,OAASM,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAR,EAAW,KAAMC,EAAI,SAAU,IAAK,OAAOO,CAAG,CAAE,CAAC,CAAC,EACjG,IAAMC,EAAO,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAT,CAAU,CAAE,EACxF,OAAIF,EAAI,SAAWA,EAAI,UAAY,SAAQW,EAAK,MAAQ,OAAOD,CAAG,GAC3DD,EAAa,IAAKE,EAAMP,CAAW,CAC3C,CACD,CAEA,OAAOK,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,qBAAsB,QAAS,iCAAS,KAAM,CAAE,UAAAP,CAAU,CAAE,EAAGE,CAAW,CACvH,CAtOsBiB,EAAAvB,GAAA,cCPtB,SAASwB,EAAQC,EAAG,CAClB,IAAMC,EAAI,SAAS,OAAOD,GAAK,EAAE,EAAG,EAAE,EACtC,OAAO,OAAO,SAASC,CAAC,GAAKA,EAAI,EAAIA,EAAI,IAC3C,CAHSC,EAAAH,EAAA,WAKT,eAAsBI,GAAcC,EAASC,EAAKC,EAAIC,EAAWC,EAAKC,EAAM,CAC1E,IAAMC,EAAcC,EAAyBP,EAASC,CAAG,EACnDO,EAASR,EAAQ,OAAO,YAAY,EAGpCS,EAAWJ,EAAK,MAAM,gDAAgD,EAC5E,GAAIG,IAAW,OAASC,EAAU,CAChC,IAAMC,EAAkBf,EAAQc,EAAS,CAAC,CAAC,EAC3C,GAAI,CAACC,EACH,OAAOC,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,aAAc,QAAS,6BAAU,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,EAGjH,GAAI,CAEF,IAAMM,EAAU,MAAMX,EAAI,SAAS,QACjC;AAAA;AAAA;AAAA,8DAIF,EAAE,KAAKS,CAAe,EAAE,MAAM,EAE9B,GAAI,CAACE,EACH,OAAOD,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,EAI/G,GAAI,CAACJ,EAAG,UAAYU,EAAQ,mBAAqBV,EAAG,QAClD,OAAOS,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,EAW/G,IAAMO,IAPO,MAAMZ,EAAI,SAAS,QAC9B;AAAA;AAAA;AAAA,oCAIF,EAAE,KAAKS,CAAe,EAAE,IAAI,IAER,SAAW,CAAC,GAAG,IAAII,IAAM,CAC3C,YAAaA,EAAE,YACf,cAAeA,EAAE,cACjB,eAAgB,OAAOA,EAAE,gBAAkB,CAAC,EAC5C,iBAAkB,OAAOA,EAAE,kBAAoB,EAAE,EACjD,MAAOA,EAAE,OAAS,GAClB,WAAYA,EAAE,WACd,WAAYA,EAAE,UAChB,EAAE,EAGIC,EAAYF,EAAK,OAAO,CAACG,EAAKC,IAASD,EAAMC,EAAK,eAAgB,CAAC,EAEzE,OAAON,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,KACN,QAAS,2BACT,KAAM,CACJ,UAAWE,EACX,WAAYE,CACd,EACA,KAAM,CAAE,UAAAZ,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASY,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAf,EAAW,KAAAE,EAAM,IAAK,OAAOa,CAAG,CAAE,CAAC,CAAC,EAC5EP,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CACpH,CACF,CAGA,GAAIE,IAAW,QAAUC,EAAU,CACjC,IAAMC,EAAkBf,EAAQc,EAAS,CAAC,CAAC,EAC3C,GAAI,CAACC,EACH,OAAOC,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,aAAc,QAAS,6BAAU,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,EAGjH,IAAIa,EACJ,GAAI,CACFA,EAAO,MAAMnB,EAAQ,KAAK,CAC5B,MAAY,CACV,OAAOW,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,cAAe,QAAS,uCAAU,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CAClH,CAEA,IAAMc,EAAS,CAAC,EACVC,EAAe,SAASF,GAAM,cAAe,EAAE,EAC/CG,EAAgB,WAAWH,GAAM,cAAc,EAC/CI,EAAiB,SAASJ,GAAM,kBAAoB,GAAI,EAAE,EAC1DK,EAAQ,OAAOL,GAAM,OAAS,EAAE,EAAE,KAAK,EAa7C,IAVI,CAAC,OAAO,UAAUE,CAAY,GAAKA,EAAe,GAAKA,EAAe,KACxED,EAAO,KAAK,CAAE,MAAO,gBAAiB,QAAS,gDAAc,CAAC,GAE5D,MAAME,CAAa,GAAKA,EAAgB,IAC1CF,EAAO,KAAK,CAAE,MAAO,iBAAkB,QAAS,kDAAW,CAAC,GAE1D,CAAC,OAAO,UAAUG,CAAc,GAAKA,EAAiB,IACxDH,EAAO,KAAK,CAAE,MAAO,mBAAoB,QAAS,mDAAY,CAAC,EAG7DA,EAAO,OACT,OAAOT,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,2BAAQ,OAAAS,EAAQ,KAAM,CAAE,UAAAjB,CAAU,CAAE,EAAGG,CAAW,EAG7H,GAAI,CAMF,GAAI,CAJY,MAAML,EAAI,SAAS,QACjC,6FACF,EAAE,KAAKS,CAAe,EAAE,MAAM,EAG5B,OAAOC,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,EAQ/G,GAJiB,MAAML,EAAI,SAAS,QAClC,kGACF,EAAE,KAAKS,EAAiBW,CAAY,EAAE,MAAM,EAG1C,OAAOV,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,YACN,QAAS,mDACT,OAAQ,CAAC,CAAE,MAAO,gBAAiB,QAAS,sCAAS,CAAC,EACtD,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAShB,IAAMmB,GALS,MAAMxB,EAAI,SAAS,QAChC;AAAA,gCAEF,EAAE,KAAKS,EAAiBW,EAAcC,EAAeC,EAAgBC,CAAK,EAAE,IAAI,IAErD,MAAM,YAEjC,OAAOb,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,UACN,QAAS,6CACT,KAAM,CAAE,YAAac,CAAW,EAChC,KAAM,CAAE,UAAAtB,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASY,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAf,EAAW,KAAAE,EAAM,IAAK,OAAOa,CAAG,CAAE,CAAC,CAAC,EAC5EP,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CACpH,CACF,CAGA,IAAMoB,EAAcrB,EAAK,MAAM,uCAAuC,EACtE,GAAIG,IAAW,OAASkB,EAAa,CACnC,IAAMD,EAAa9B,EAAQ+B,EAAY,CAAC,CAAC,EACzC,GAAI,CAACD,EACH,OAAOd,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,aAAc,QAAS,6BAAU,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,EAGjH,IAAIa,EACJ,GAAI,CACFA,EAAO,MAAMnB,EAAQ,KAAK,CAC5B,MAAY,CACV,OAAOW,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,cAAe,QAAS,uCAAU,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CAClH,CAEA,IAAMc,EAAS,CAAC,EACVE,EAAgB,WAAWH,GAAM,cAAc,EAC/CI,EAAiB,SAASJ,GAAM,kBAAoB,GAAI,EAAE,EAC1DK,EAAQ,OAAOL,GAAM,OAAS,EAAE,EAAE,KAAK,EAU7C,IAPI,MAAMG,CAAa,GAAKA,EAAgB,IAC1CF,EAAO,KAAK,CAAE,MAAO,iBAAkB,QAAS,kDAAW,CAAC,GAE1D,CAAC,OAAO,UAAUG,CAAc,GAAKA,EAAiB,IACxDH,EAAO,KAAK,CAAE,MAAO,mBAAoB,QAAS,mDAAY,CAAC,EAG7DA,EAAO,OACT,OAAOT,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,2BAAQ,OAAAS,EAAQ,KAAM,CAAE,UAAAjB,CAAU,CAAE,EAAGG,CAAW,EAG7H,GAAI,CAMF,OAJiB,MAAML,EAAI,SAAS,QAClC,sEACF,EAAE,KAAKwB,CAAU,EAAE,MAAM,GAOzB,MAAMxB,EAAI,SAAS,QACjB;AAAA;AAAA,+BAGF,EAAE,KAAKqB,EAAeC,EAAgBC,EAAOC,CAAU,EAAE,IAAI,EAEtDd,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,KACN,QAAS,6CACT,KAAM,CAAE,YAAac,CAAW,EAChC,KAAM,CAAE,UAAAtB,CAAU,CACpB,EAAGG,CAAW,GAhBLK,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,6CAAW,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CAkBnH,OAASY,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAf,EAAW,KAAAE,EAAM,IAAK,OAAOa,CAAG,CAAE,CAAC,CAAC,EAC5EP,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CACpH,CACF,CAGA,GAAIE,IAAW,UAAYkB,EAAa,CACtC,IAAMD,EAAa9B,EAAQ+B,EAAY,CAAC,CAAC,EACzC,GAAI,CAACD,EACH,OAAOd,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,aAAc,QAAS,6BAAU,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,EAGjH,GAAI,CAMF,OAJiB,MAAML,EAAI,SAAS,QAClC,sEACF,EAAE,KAAKwB,CAAU,EAAE,MAAM,GAOzB,MAAMxB,EAAI,SAAS,QACjB,0DACF,EAAE,KAAKwB,CAAU,EAAE,IAAI,EAEhBd,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,KACN,QAAS,6CACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,GAbLK,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,6CAAW,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CAenH,OAASY,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAf,EAAW,KAAAE,EAAM,IAAK,OAAOa,CAAG,CAAE,CAAC,CAAC,EAC5EP,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CACpH,CACF,CAEA,OAAOK,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAR,CAAU,CAAE,EAAGG,CAAW,CAC/G,CAzPsBR,EAAAC,GAAA,iBCLtB,SAAS4B,EAAQC,EAAG,CAClB,IAAMC,EAAI,SAAS,OAAOD,GAAK,EAAE,EAAG,EAAE,EACtC,OAAO,OAAO,SAASC,CAAC,GAAKA,EAAI,EAAIA,EAAI,IAC3C,CAHSC,EAAAH,EAAA,WAKT,eAAsBI,GAAoBC,EAASC,EAAKC,EAAIC,EAAWC,EAAKC,EAAM,CAChF,IAAMC,EAAcC,EAAyBP,EAASC,CAAG,EACnDO,EAASR,EAAQ,OAAO,YAAY,EAG1C,GAAIQ,IAAW,OAASH,IAAS,kCAAmC,CAClE,IAAMI,EAAYL,EAAI,aAAa,IAAI,YAAY,EAC7CM,EAAWN,EAAI,aAAa,IAAI,WAAW,EAEjD,GAAI,CACF,IAAIO,EAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAWNC,EAAS,CAAC,EAEZH,IACFE,GAAS,yBACTC,EAAO,KAAK,SAASH,EAAW,EAAE,CAAC,GAGjCC,IACEA,IAAa,OACfC,GAAS,6BAETA,GAAS,wBACTC,EAAO,KAAK,SAASF,EAAU,EAAE,CAAC,IAItCC,GAAS,iCAQT,IAAME,IAFO,MAJAD,EAAO,OAAS,EACzBX,EAAI,SAAS,QAAQU,CAAK,EAAE,KAAK,GAAGC,CAAM,EAC1CX,EAAI,SAAS,QAAQU,CAAK,GAEN,IAAI,IAER,SAAW,CAAC,GAAG,IAAIG,IAAM,CAC3C,YAAaA,EAAE,YACf,cAAeA,EAAE,eAAiB,GAClC,WAAYA,EAAE,YAAc,KAC5B,aAAcA,EAAE,cAAgB,GAChC,aAAcA,EAAE,cAAgB,GAChC,UAAWA,EAAE,WAAa,KAC1B,YAAaA,EAAE,aAAe,GAC9B,YAAaA,EAAE,aAAe,GAC9B,OAAQA,EAAE,QAAU,KACpB,UAAW,EAAQA,EAAE,UACrB,WAAYA,EAAE,WACd,aAAcA,EAAE,cAAgB,CAClC,EAAE,EAEF,OAAOC,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,KACN,QAAS,2BACT,KAAMF,EACN,KAAM,CAAE,UAAAV,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASU,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAb,EAAW,KAAAE,EAAM,IAAK,OAAOW,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,CACpH,CACF,CAGA,IAAMW,EAAWZ,EAAK,MAAM,8CAA8C,EAC1E,GAAIG,IAAW,OAASS,EAAU,CAChC,IAAMC,EAAavB,EAAQsB,EAAS,CAAC,CAAC,EACtC,GAAI,CAACC,EACH,OAAOH,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,aAAc,QAAS,6BAAU,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,EAGjH,GAAI,CAEF,IAAMa,EAAW,MAAMlB,EAAI,SAAS,QAClC;AAAA;AAAA;AAAA;AAAA;AAAA,kCAMF,EAAE,KAAKiB,CAAU,EAAE,MAAM,EAEzB,GAAI,CAACC,EACH,OAAOJ,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,EAW/G,IAAMc,IAPa,MAAMnB,EAAI,SAAS,QACpC;AAAA;AAAA;AAAA,kCAIF,EAAE,KAAKiB,CAAU,EAAE,IAAI,IAEK,SAAW,CAAC,GAAG,IAAItB,IAAM,CACnD,SAAUA,EAAE,SACZ,WAAYA,EAAE,YAAc,GAC5B,YAAaA,EAAE,YACf,YAAaA,EAAE,aAAe,GAC9B,gBAAiB,OAAOA,EAAE,iBAAmB,CAAC,CAChD,EAAE,EAEIiB,EAAO,CACX,YAAaM,EAAS,YACtB,cAAeA,EAAS,eAAiB,GACzC,WAAYA,EAAS,YAAc,KACnC,aAAcA,EAAS,cAAgB,GACvC,aAAcA,EAAS,cAAgB,GACvC,YAAaA,EAAS,aAAe,GACrC,OAAQA,EAAS,QAAU,KAC3B,UAAW,EAAQA,EAAS,UAC5B,WAAYA,EAAS,WACrB,OAAQC,CACV,EAEA,OAAOL,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,KACN,QAAS,2BACT,KAAMF,EACN,KAAM,CAAE,UAAAV,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASU,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAb,EAAW,KAAAE,EAAM,IAAK,OAAOW,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,CACpH,CACF,CAGA,GAAIE,IAAW,QAAUH,IAAS,kCAAmC,CAEnE,GAAI,CAACH,EAAG,SACN,OAAOa,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,yDAAa,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,EAGnH,IAAIe,EACJ,GAAI,CACFA,EAAO,MAAMrB,EAAQ,KAAK,CAC5B,MAAY,CACV,OAAOe,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,cAAe,QAAS,uCAAU,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,CAClH,CAEA,IAAMgB,EAAS,CAAC,EACVC,EAAe,OAAOF,GAAM,eAAiB,EAAE,EAAE,KAAK,EACtDZ,EAAYY,GAAM,WAAa,SAASA,EAAK,WAAY,EAAE,EAAI,KAC/DX,EAAWW,GAAM,UAAY,SAASA,EAAK,UAAW,EAAE,EAAI,KAC5DG,EAAc,OAAOH,GAAM,aAAe,EAAE,EAAE,KAAK,EACnDI,EAAQJ,GAAM,OAAS,SAASA,EAAK,OAAQ,EAAE,EAAI,KACnDD,EAAS,MAAM,QAAQC,GAAM,MAAM,EAAIA,EAAK,OAAS,CAAC,EAO5D,GAJKE,GACHD,EAAO,KAAK,CAAE,MAAO,gBAAiB,QAAS,4CAAU,CAAC,EAGxDA,EAAO,OACT,OAAOP,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,2BAAQ,OAAAO,EAAQ,KAAM,CAAE,UAAAnB,CAAU,CAAE,EAAGG,CAAW,EAG7H,GAAI,CAOF,IAAMY,GALS,MAAMjB,EAAI,SAAS,QAChC;AAAA,mCAEF,EAAE,KAAKsB,EAAcd,EAAWC,EAAUc,EAAaC,CAAK,EAAE,IAAI,IAEvC,MAAM,YAGjC,GAAIL,EAAO,OAAS,EAClB,QAASM,EAAI,EAAGA,EAAIN,EAAO,OAAQM,IAAK,CACtC,IAAMC,EAAQP,EAAOM,CAAC,EAChBE,EAAY,OAAOD,GAAO,YAAc,EAAE,EAAE,KAAK,EACjDE,EAAY,OAAOF,GAAO,aAAe,EAAE,EAAE,KAAK,EAClDG,EAAiB,WAAWH,GAAO,iBAAmB,CAAC,EAEzDC,GACF,MAAM3B,EAAI,SAAS,QACjB;AAAA,sCAEF,EAAE,KAAKiB,EAAYU,EAAWF,EAAI,EAAGG,EAAWC,CAAc,EAAE,IAAI,CAExE,CAGF,OAAOf,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,UACN,QAAS,iCACT,KAAM,CAAE,YAAaG,CAAW,EAChC,KAAM,CAAE,UAAAf,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASU,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAb,EAAW,KAAAE,EAAM,IAAK,OAAOW,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,CACpH,CACF,CAGA,IAAMyB,EAAc1B,EAAK,MAAM,8CAA8C,EAC7E,GAAIG,IAAW,OAASuB,EAAa,CACnC,IAAMb,EAAavB,EAAQoC,EAAY,CAAC,CAAC,EACzC,GAAI,CAACb,EACH,OAAOH,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,aAAc,QAAS,6BAAU,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,EAIjH,GAAI,CAACJ,EAAG,SACN,OAAOa,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,yDAAa,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,EAGnH,IAAIe,EACJ,GAAI,CACFA,EAAO,MAAMrB,EAAQ,KAAK,CAC5B,MAAY,CACV,OAAOe,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,cAAe,QAAS,uCAAU,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,CAClH,CAEA,IAAMgB,EAAS,CAAC,EACVC,EAAe,OAAOF,GAAM,eAAiB,EAAE,EAAE,KAAK,EACtDZ,EAAYY,GAAM,WAAa,SAASA,EAAK,WAAY,EAAE,EAAI,KAC/DG,EAAc,OAAOH,GAAM,aAAe,EAAE,EAAE,KAAK,EACnDI,EAAQJ,GAAM,OAAS,SAASA,EAAK,OAAQ,EAAE,EAAI,KACnDW,EAAWX,GAAM,YAAc,GAC/BD,EAAS,MAAM,QAAQC,GAAM,MAAM,EAAIA,EAAK,OAAS,KAO3D,GAJKE,GACHD,EAAO,KAAK,CAAE,MAAO,gBAAiB,QAAS,4CAAU,CAAC,EAGxDA,EAAO,OACT,OAAOP,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,2BAAQ,OAAAO,EAAQ,KAAM,CAAE,UAAAnB,CAAU,CAAE,EAAGG,CAAW,EAG7H,GAAI,CAMF,GAAI,CAJa,MAAML,EAAI,SAAS,QAClC,6DACF,EAAE,KAAKiB,CAAU,EAAE,MAAM,EAGvB,OAAOH,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,EAW/G,GAPA,MAAML,EAAI,SAAS,QACjB;AAAA;AAAA,+BAGF,EAAE,KAAKsB,EAAcd,EAAWe,EAAaC,EAAOO,EAAW,EAAI,EAAGd,CAAU,EAAE,IAAI,EAGlFE,IAAW,KAAM,CAEnB,MAAMnB,EAAI,SAAS,QACjB,sDACF,EAAE,KAAKiB,CAAU,EAAE,IAAI,EAGvB,QAASQ,EAAI,EAAGA,EAAIN,EAAO,OAAQM,IAAK,CACtC,IAAMC,EAAQP,EAAOM,CAAC,EAChBE,EAAY,OAAOD,GAAO,YAAc,EAAE,EAAE,KAAK,EACjDE,EAAY,OAAOF,GAAO,aAAe,EAAE,EAAE,KAAK,EAClDG,EAAiB,WAAWH,GAAO,iBAAmB,CAAC,EAEzDC,GACF,MAAM3B,EAAI,SAAS,QACjB;AAAA,sCAEF,EAAE,KAAKiB,EAAYU,EAAWF,EAAI,EAAGG,EAAWC,CAAc,EAAE,IAAI,CAExE,CACF,CAEA,OAAOf,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,KACN,QAAS,iCACT,KAAM,CAAE,YAAaG,CAAW,EAChC,KAAM,CAAE,UAAAf,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASU,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAb,EAAW,KAAAE,EAAM,IAAK,OAAOW,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,CACpH,CACF,CAGA,GAAIE,IAAW,UAAYuB,EAAa,CACtC,IAAMb,EAAavB,EAAQoC,EAAY,CAAC,CAAC,EACzC,GAAI,CAACb,EACH,OAAOH,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,aAAc,QAAS,6BAAU,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,EAIjH,GAAI,CAACJ,EAAG,SACN,OAAOa,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,yDAAa,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,EAGnH,GAAI,CAMF,OAJiB,MAAML,EAAI,SAAS,QAClC,6DACF,EAAE,KAAKiB,CAAU,EAAE,MAAM,EAOX,MAAMjB,EAAI,SAAS,QAC/B,oGACF,EAAE,KAAKiB,CAAU,EAAE,MAAM,EAGhBH,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,SACN,QAAS,iFACT,KAAM,CAAE,UAAAZ,CAAU,CACpB,EAAGG,CAAW,GAIhB,MAAML,EAAI,SAAS,QACjB,sDACF,EAAE,KAAKiB,CAAU,EAAE,IAAI,EAGvB,MAAMjB,EAAI,SAAS,QACjB,iDACF,EAAE,KAAKiB,CAAU,EAAE,IAAI,EAEhBH,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,KACN,QAAS,iCACT,KAAM,CAAE,UAAAZ,CAAU,CACpB,EAAGG,CAAW,GAhCLS,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,CAkCjH,OAASU,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAb,EAAW,KAAAE,EAAM,IAAK,OAAOW,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,CACpH,CACF,CAGA,IAAM2B,EAAc5B,EAAK,MAAM,sDAAsD,EACrF,GAAIG,IAAW,OAASyB,EAAa,CACnC,IAAMf,EAAavB,EAAQsC,EAAY,CAAC,CAAC,EACzC,GAAI,CAACf,EACH,OAAOH,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,aAAc,QAAS,6BAAU,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,EAGjH,GAAI,CAaF,IAAMc,IAZa,MAAMnB,EAAI,SAAS,QACpC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sCASF,EAAE,KAAKiB,CAAU,EAAE,IAAI,IAEK,SAAW,CAAC,GAAG,IAAItB,IAAM,CACnD,SAAUA,EAAE,SACZ,WAAYA,EAAE,YAAc,GAC5B,YAAaA,EAAE,YACf,YAAaA,EAAE,aAAe,GAC9B,gBAAiB,OAAOA,EAAE,iBAAmB,CAAC,EAC9C,aAAcA,EAAE,cAAgB,GAChC,OAAQA,EAAE,QAAU,KACpB,UAAWA,EAAE,WAAa,GAC1B,cAAeA,EAAE,eAAiB,KAClC,gBAAiBA,EAAE,iBAAmB,GACtC,eAAgBA,EAAE,gBAAkB,EACtC,EAAE,EAEF,OAAOmB,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,KACN,QAAS,2BACT,KAAMK,EACN,KAAM,CAAE,UAAAjB,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASU,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAb,EAAW,KAAAE,EAAM,IAAK,OAAOW,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,CACpH,CACF,CAGA,GAAIE,IAAW,QAAUyB,EAAa,CACpC,IAAMf,EAAavB,EAAQsC,EAAY,CAAC,CAAC,EACzC,GAAI,CAACf,EACH,OAAOH,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,aAAc,QAAS,6BAAU,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,EAIjH,GAAI,CAACJ,EAAG,SACN,OAAOa,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,yDAAa,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,EAGnH,IAAIe,EACJ,GAAI,CACFA,EAAO,MAAMrB,EAAQ,KAAK,CAC5B,MAAY,CACV,OAAOe,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,cAAe,QAAS,uCAAU,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,CAClH,CAEA,IAAMgB,EAAS,CAAC,EACVM,EAAY,OAAOP,GAAM,YAAc,EAAE,EAAE,KAAK,EAChDa,EAAab,GAAM,YAAc,SAASA,EAAK,YAAa,EAAE,EAAI,KAClEG,EAAc,OAAOH,GAAM,aAAe,EAAE,EAAE,KAAK,EACnDS,EAAiBT,GAAM,gBAAkB,WAAWA,EAAK,eAAe,EAAI,KAC5Ec,EAAe,OAAOd,GAAM,cAAgB,EAAE,EAAE,KAAK,EACrDI,EAAQJ,GAAM,OAAS,SAASA,EAAK,OAAQ,EAAE,EAAI,KACnDe,EAAef,GAAM,cAAgB,SAASA,EAAK,cAAe,EAAE,EAAI,KAU9E,GAPKO,GACHN,EAAO,KAAK,CAAE,MAAO,aAAc,QAAS,4CAAU,CAAC,GAErD,CAACY,GAAcA,EAAa,IAC9BZ,EAAO,KAAK,CAAE,MAAO,cAAe,QAAS,kDAAW,CAAC,EAGvDA,EAAO,OACT,OAAOP,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,mBAAoB,QAAS,2BAAQ,OAAAO,EAAQ,KAAM,CAAE,UAAAnB,CAAU,CAAE,EAAGG,CAAW,EAG7H,GAAI,CAMF,GAAI,CAJa,MAAML,EAAI,SAAS,QAClC,6DACF,EAAE,KAAKiB,CAAU,EAAE,MAAM,EAGvB,OAAOH,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,EAI/G,IAAM+B,EAAS,MAAMpC,EAAI,SAAS,QAChC;AAAA,yCAEF,EAAE,KAAKiB,EAAYU,EAAWM,EAAYV,EAAaM,EAAgBK,EAAcV,EAAOW,CAAY,EAAE,IAAI,EAE9G,OAAOrB,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,UACN,QAAS,iCACT,KAAM,CAAE,SAAUsB,GAAQ,MAAM,WAAY,EAC5C,KAAM,CAAE,UAAAlC,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASU,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAb,EAAW,KAAAE,EAAM,IAAK,OAAOW,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,CACpH,CACF,CAGA,IAAMgC,EAAmBjC,EAAK,MAAM,6DAA6D,EACjG,GAAIG,IAAW,UAAY8B,EAAkB,CAC3C,IAAMpB,EAAavB,EAAQ2C,EAAiB,CAAC,CAAC,EACxCC,EAAU5C,EAAQ2C,EAAiB,CAAC,CAAC,EAE3C,GAAI,CAACpB,GAAc,CAACqB,EAClB,OAAOxB,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,aAAc,QAAS,iBAAQ,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,EAI/G,GAAI,CAACJ,EAAG,SACN,OAAOa,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,yDAAa,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,EAGnH,GAAI,CAMF,OAJc,MAAML,EAAI,SAAS,QAC/B,gFACF,EAAE,KAAKiB,EAAYqB,CAAO,EAAE,MAAM,GAOlC,MAAMtC,EAAI,SAAS,QACjB,uEACF,EAAE,KAAKiB,EAAYqB,CAAO,EAAE,IAAI,EAEzBxB,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,KACN,QAAS,iCACT,KAAM,CAAE,UAAAZ,CAAU,CACpB,EAAGG,CAAW,GAbLS,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,CAejH,OAASU,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAb,EAAW,KAAAE,EAAM,IAAK,OAAOW,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,iBAAkB,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,CACpH,CACF,CAEA,OAAOS,EAAa,IAAK,CAAE,GAAI,GAAO,KAAM,YAAa,QAAS,iCAAS,KAAM,CAAE,UAAAZ,CAAU,CAAE,EAAGG,CAAW,CAC/G,CA5gBsBR,EAAAC,GAAA,uBCLtB,SAASyC,EAAQC,EAAG,CAClB,IAAMC,EAAI,SAAS,OAAOD,GAAK,EAAE,EAAG,EAAE,EACtC,OAAO,OAAO,SAASC,CAAC,GAAKA,EAAI,EAAIA,EAAI,IAC3C,CAHSC,EAAAH,EAAA,WAKT,eAAsBI,GAAeC,EAASC,EAAKC,EAAIC,EAAWC,EAAKC,EAAM,CAC3E,IAAMC,EAAcC,EAAyBP,EAASC,CAAG,EACnDO,EAASR,EAAQ,OAAO,YAAY,EAO1C,GAAIQ,IAAW,OAASH,IAAS,4BAC/B,GAAI,CASF,IAAMI,IARO,MAAMR,EAAI,SAAS,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAMvC,EAAE,IAAI,IAEa,SAAW,CAAC,GAAG,IAAIS,IAAM,CAC3C,WAAYA,EAAE,WACd,aAAcA,EAAE,cAAgB,GAChC,aAAcA,EAAE,cAAgB,GAChC,YAAaA,EAAE,aAAe,GAC9B,UAAW,EAAQA,EAAE,UACrB,WAAYA,EAAE,YAAc,EAC5B,WAAYA,EAAE,WACd,WAAYA,EAAE,UAChB,EAAE,EAEF,OAAOC,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAAF,EACA,KAAM,CAAE,UAAAN,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASM,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAT,EAAW,KAAAE,EAAM,IAAK,OAAOO,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,iBACN,QAAS,iCACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAChB,CAIF,GAAIE,IAAW,QAAUH,IAAS,4BAA6B,CAC7D,GAAI,CAACH,GAAI,SACP,OAAOS,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,YACN,QAAS,6CACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,IAAIO,EACJ,GAAI,CACFA,EAAO,MAAMb,EAAQ,KAAK,CAC5B,MAAQ,CACN,OAAOW,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,cACN,QAAS,uCACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAChB,CAEA,IAAMQ,EAAc,OAAOD,GAAM,cAAgB,EAAE,EAAE,KAAK,EACpDE,EAAc,OAAOF,GAAM,cAAgB,EAAE,EAAE,KAAK,EACpDG,EAAc,OAAOH,GAAM,aAAe,EAAE,EAAE,KAAK,EACnDI,EAAY,SAASJ,GAAM,YAAc,IAAK,EAAE,EAEtD,GAAI,CAACC,EACH,OAAOH,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,mBACN,QAAS,mDACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,GAAI,CACF,IAAMY,EAAS,MAAMjB,EAAI,SAAS,QAAQ;AAAA;AAAA;AAAA,OAGzC,EAAE,KAAKa,EAAaC,GAAe,KAAMC,GAAe,KAAMC,CAAS,EAAE,IAAI,EAE9E,OAAON,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAM,CAAE,WAAYO,EAAO,KAAK,WAAY,EAC5C,KAAM,CAAE,UAAAf,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASM,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAT,EAAW,KAAAE,EAAM,IAAK,OAAOO,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,iBACN,QAAS,2BACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAChB,CACF,CAGA,IAAMa,EAAcd,EAAK,MAAM,wCAAwC,EACvE,GAAIG,IAAW,OAASW,EAAa,CACnC,GAAI,CAACjB,GAAI,SACP,OAAOS,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,YACN,QAAS,6CACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,IAAMc,EAAYzB,EAAQwB,EAAY,CAAC,CAAC,EACxC,GAAI,CAACC,EACH,OAAOT,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,cACN,QAAS,mCACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,IAAIO,EACJ,GAAI,CACFA,EAAO,MAAMb,EAAQ,KAAK,CAC5B,MAAQ,CACN,OAAOW,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,cACN,QAAS,uCACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAChB,CAEA,IAAMQ,EAAc,OAAOD,GAAM,cAAgB,EAAE,EAAE,KAAK,EACpDE,EAAc,OAAOF,GAAM,cAAgB,EAAE,EAAE,KAAK,EACpDG,EAAc,OAAOH,GAAM,aAAe,EAAE,EAAE,KAAK,EACnDI,EAAY,SAASJ,GAAM,YAAc,IAAK,EAAE,EAEtD,GAAI,CAACC,EACH,OAAOH,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,mBACN,QAAS,mDACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,GAAI,CACF,aAAML,EAAI,SAAS,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA,OAK1B,EAAE,KAAKa,EAAaC,GAAe,KAAMC,GAAe,KAAMC,EAAWG,CAAS,EAAE,IAAI,EAElFT,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASM,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAT,EAAW,KAAAE,EAAM,IAAK,OAAOO,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,iBACN,QAAS,2BACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAChB,CACF,CAGA,IAAMe,EAAchB,EAAK,MAAM,wCAAwC,EACvE,GAAIG,IAAW,UAAYa,EAAa,CACtC,GAAI,CAACnB,GAAI,SACP,OAAOS,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,YACN,QAAS,6CACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,IAAMc,EAAYzB,EAAQ0B,EAAY,CAAC,CAAC,EACxC,GAAI,CAACD,EACH,OAAOT,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,cACN,QAAS,mCACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,GAAI,CACF,aAAML,EAAI,SAAS,QAAQ;AAAA;AAAA;AAAA,OAG1B,EAAE,KAAKmB,CAAS,EAAE,IAAI,EAEhBT,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASM,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAT,EAAW,KAAAE,EAAM,IAAK,OAAOO,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,iBACN,QAAS,2BACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAChB,CACF,CAOA,IAAMgB,EAAgBjB,EAAK,MAAM,+CAA+C,EAChF,GAAIG,IAAW,OAASc,EAAe,CACrC,IAAMF,EAAYzB,EAAQ2B,EAAc,CAAC,CAAC,EAC1C,GAAI,CAACF,EACH,OAAOT,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,cACN,QAAS,mCACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,GAAI,CASF,IAAMG,IARO,MAAMR,EAAI,SAAS,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAMvC,EAAE,KAAKmB,CAAS,EAAE,IAAI,IAEH,SAAW,CAAC,GAAG,IAAIV,IAAM,CAC3C,QAASA,EAAE,QACX,WAAYA,EAAE,WACd,UAAWA,EAAE,WAAa,GAC1B,UAAWA,EAAE,WAAa,GAC1B,YAAaA,EAAE,aAAe,GAC9B,UAAW,EAAQA,EAAE,UACrB,WAAYA,EAAE,YAAc,EAC5B,WAAYA,EAAE,WACd,WAAYA,EAAE,UAChB,EAAE,EAEF,OAAOC,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAAF,EACA,KAAM,CAAE,UAAAN,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASM,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAT,EAAW,KAAAE,EAAM,IAAK,OAAOO,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,iBACN,QAAS,iCACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAChB,CACF,CAGA,IAAMiB,EAAkBlB,EAAK,MAAM,+CAA+C,EAClF,GAAIG,IAAW,QAAUe,EAAiB,CACxC,GAAI,CAACrB,GAAI,SACP,OAAOS,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,YACN,QAAS,6CACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,IAAMc,EAAYzB,EAAQ4B,EAAgB,CAAC,CAAC,EAC5C,GAAI,CAACH,EACH,OAAOT,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,cACN,QAAS,mCACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,IAAIO,EACJ,GAAI,CACFA,EAAO,MAAMb,EAAQ,KAAK,CAC5B,MAAQ,CACN,OAAOW,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,cACN,QAAS,uCACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAChB,CAEA,IAAMkB,EAAW,OAAOX,GAAM,WAAa,EAAE,EAAE,KAAK,EAC9CY,EAAW,OAAOZ,GAAM,WAAa,EAAE,EAAE,KAAK,EAC9CG,EAAc,OAAOH,GAAM,aAAe,EAAE,EAAE,KAAK,EACnDI,EAAY,SAASJ,GAAM,YAAc,IAAK,EAAE,EAEtD,GAAI,CAACW,EACH,OAAOb,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,mBACN,QAAS,yDACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,GAAI,CACF,IAAMY,EAAS,MAAMjB,EAAI,SAAS,QAAQ;AAAA;AAAA;AAAA,OAGzC,EAAE,KAAKmB,EAAWI,EAAUC,GAAY,KAAMT,GAAe,KAAMC,CAAS,EAAE,IAAI,EAEnF,OAAON,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAM,CAAE,QAASO,EAAO,KAAK,WAAY,EACzC,KAAM,CAAE,UAAAf,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASM,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAT,EAAW,KAAAE,EAAM,IAAK,OAAOO,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,iBACN,QAAS,2BACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAChB,CACF,CAGA,IAAMoB,EAAkBrB,EAAK,MAAM,sDAAsD,EACzF,GAAIG,IAAW,OAASkB,EAAiB,CACvC,GAAI,CAACxB,GAAI,SACP,OAAOS,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,YACN,QAAS,6CACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,IAAMc,EAAYzB,EAAQ+B,EAAgB,CAAC,CAAC,EACtCC,EAAShC,EAAQ+B,EAAgB,CAAC,CAAC,EAEzC,GAAI,CAACN,GAAa,CAACO,EACjB,OAAOhB,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,cACN,QAAS,uBACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,IAAIO,EACJ,GAAI,CACFA,EAAO,MAAMb,EAAQ,KAAK,CAC5B,MAAQ,CACN,OAAOW,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,cACN,QAAS,uCACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAChB,CAEA,IAAMkB,EAAW,OAAOX,GAAM,WAAa,EAAE,EAAE,KAAK,EAC9CY,EAAW,OAAOZ,GAAM,WAAa,EAAE,EAAE,KAAK,EAC9CG,EAAc,OAAOH,GAAM,aAAe,EAAE,EAAE,KAAK,EACnDI,EAAY,SAASJ,GAAM,YAAc,IAAK,EAAE,EAEtD,GAAI,CAACW,EACH,OAAOb,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,mBACN,QAAS,yDACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,GAAI,CACF,aAAML,EAAI,SAAS,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA,OAK1B,EAAE,KAAKuB,EAAUC,GAAY,KAAMT,GAAe,KAAMC,EAAWG,EAAWO,CAAM,EAAE,IAAI,EAEpFhB,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASM,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAT,EAAW,KAAAE,EAAM,IAAK,OAAOO,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,iBACN,QAAS,2BACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAChB,CACF,CAGA,IAAMsB,EAAkBvB,EAAK,MAAM,sDAAsD,EACzF,GAAIG,IAAW,UAAYoB,EAAiB,CAC1C,GAAI,CAAC1B,GAAI,SACP,OAAOS,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,YACN,QAAS,6CACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,IAAMc,EAAYzB,EAAQiC,EAAgB,CAAC,CAAC,EACtCD,EAAShC,EAAQiC,EAAgB,CAAC,CAAC,EAEzC,GAAI,CAACR,GAAa,CAACO,EACjB,OAAOhB,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,cACN,QAAS,uBACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,EAGhB,GAAI,CACF,aAAML,EAAI,SAAS,QAAQ;AAAA;AAAA;AAAA,OAG1B,EAAE,KAAKmB,EAAWO,CAAM,EAAE,IAAI,EAExBhB,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,UACN,QAAS,2BACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAEhB,OAASM,EAAK,CACZ,eAAQ,MAAM,KAAK,UAAU,CAAE,MAAO,QAAS,UAAAT,EAAW,KAAAE,EAAM,IAAK,OAAOO,CAAG,CAAE,CAAC,CAAC,EAC5ED,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,iBACN,QAAS,2BACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAChB,CACF,CAEA,OAAOK,EAAa,IAAK,CACvB,GAAI,GACJ,KAAM,YACN,QAAS,oCACT,KAAM,CAAE,UAAAR,CAAU,CACpB,EAAGG,CAAW,CAChB,CA3esBR,EAAAC,GAAA,kBCiBtB,IAAO8B,GAAQ,CACd,MAAM,MAAMC,EAASC,EAAK,CACzB,IAAMC,EAAM,IAAI,IAAIF,EAAQ,GAAG,EACzBG,EAAOD,EAAI,SACXE,EAASJ,EAAQ,OAAO,YAAY,EACpCK,EAAYL,EAAQ,QAAQ,IAAI,cAAc,GAAKM,GAAkB,EAErEC,EAAQC,EAAA,CAACC,EAAMC,IAAY,CAChC,IAAMC,EAAS,IAAI,IAAIX,EAAQ,GAAG,EAClC,OAAAW,EAAO,SAAW,SAClBA,EAAO,SAAWF,EAClBE,EAAO,SAAWD,EACX,MAAM,IAAI,QAAQC,EAAO,SAAS,EAAGX,CAAO,CAAC,CACrD,EANc,SASd,GAAIG,EAAK,WAAW,gBAAgB,GAAKC,IAAW,UACnD,OAAOQ,GAAsBZ,EAASC,CAAG,EAI1C,GAAIE,IAAS,8BACZ,OAAOU,GAAYb,EAASC,EAAKI,CAAS,EAE3C,GAAIF,IAAS,2BACZ,OAAOW,GAAad,EAASC,EAAKI,CAAS,EAI5C,GAAIF,EAAK,WAAW,6BAA6B,EAChD,OAAOY,GAAiBf,EAASC,EAAKI,EAAWF,CAAI,EAItD,GAAIA,IAAS,4BAA8BA,EAAK,WAAW,2BAA2B,EAAG,CACxF,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACEE,GAAclB,EAASC,EAAKe,EAAIX,EAAWH,CAAG,EADrCiB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CACA,GAAIE,IAAS,yBAA2BA,EAAK,WAAW,wBAAwB,EAAG,CAClF,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACEK,GAAWrB,EAASC,EAAKe,EAAIX,EAAWH,CAAG,EADlCiB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CAGA,GAAIE,EAAK,WAAW,2BAA2B,EAAG,CACjD,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACEM,GAActB,EAASC,EAAKe,EAAIX,EAAWH,EAAKC,CAAI,EAD3CgB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CAGD,GAAIE,EAAK,WAAW,iCAAiC,EAAG,CACvD,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACEO,GAAoBvB,EAASC,EAAKe,EAAIX,EAAWH,EAAKC,CAAI,EADjDgB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CAGA,GAAIE,IAAS,6BAA+B,4CAA4C,KAAKA,CAAI,EAAG,CACnG,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACEQ,GAAexB,EAASC,EAAKe,EAAIX,EAAWH,EAAKC,CAAI,EAD5CgB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CACC,GAAIE,IAAS,yBAA0B,CACtC,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACES,GAAYzB,EAASC,EAAKe,EAAIX,EAAWH,CAAG,EADnCiB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CACD,GAAIE,IAAS,+BAAiCA,EAAK,WAAW,2BAA2B,EAAG,CAC3F,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACEU,GAAiB1B,EAASC,EAAKe,EAAIX,EAAWH,CAAG,EADxCiB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CACC,GAAIE,IAAS,4BAA6B,CACzC,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACEW,GAAe3B,EAASC,EAAKe,EAAIX,EAAWH,CAAG,EADtCiB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CACA,GAAIE,IAAS,gCAAkCA,IAAS,4CAA8CA,IAAS,6CAA8C,CAC5J,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACEY,GAAkB5B,EAASC,EAAKe,EAAIX,EAAWH,EAAKC,CAAI,EAD/CgB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CACA,GAAIE,IAAS,2BAA6BA,IAAS,oCAAsCA,IAAS,uCAAyCA,IAAS,sCAAuC,CAC1L,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACEa,GAAa7B,EAASC,EAAKe,EAAIX,EAAWH,EAAKC,CAAI,EAD1CgB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CACA,GAAIE,IAAS,4BAA6B,CACzC,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACEc,GAAe9B,EAASC,EAAKe,EAAIX,EAAWH,CAAG,EADtCiB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CACA,GAAIE,EAAK,WAAW,gCAAgC,EAAG,CACtD,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACAA,EAAG,SACDe,GAAc/B,EAASC,EAAKe,EAAIX,EAAWH,EAAKC,CAAI,EADlCgB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,2BAAQ,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,EADrIkB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAG/I,CACA,GAAIE,EAAK,WAAW,iCAAiC,EAAG,CACvD,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACAA,EAAG,SACDgB,GAAehC,EAASC,EAAKe,EAAIX,EAAWH,EAAKC,CAAI,EADnCgB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,2BAAQ,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,EADrIkB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAG/I,CACA,GAAIE,IAAS,mCAAqCA,IAAS,8BAAgCA,IAAS,oCAAsCA,IAAS,kCAAmC,CACrL,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACAA,EAAG,SACDiB,GAAUjC,EAASC,EAAKe,EAAIX,EAAWH,EAAKC,CAAI,EAD9BgB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,2BAAQ,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,EADrIkB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAG/I,CACA,GAAIE,EAAK,WAAW,0BAA0B,EAAG,CAChD,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACEkB,GAAclC,EAASC,EAAKe,EAAIX,EAAWH,EAAKC,CAAI,EAD3CgB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CAEA,GAAIE,IAAS,uBAAwB,CACpC,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACEmB,GAAUnC,EAASC,EAAKe,EAAIX,EAAWH,EAAKC,CAAI,EADvCgB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CAEA,GAAIE,IAAS,6BAA8B,CAC1C,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACEoB,GAAgBpC,EAASC,EAAKe,EAAIX,EAAWH,EAAKC,CAAI,EAD7CgB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CAEA,GAAIE,IAAS,2CAA6C,iDAAiD,KAAKA,CAAI,EAAG,CACtH,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACAA,EAAG,SACDqB,GAAiBrC,EAASC,EAAKe,EAAIX,EAAWH,EAAKC,CAAI,EADrCgB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,2BAAQ,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,EADrIkB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAG/I,CAGA,GAAIE,IAAS,yBAA0B,CACtC,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACEsB,GAAetC,EAASC,EAAKe,EAAIX,EAAWH,EAAKC,CAAI,EAD5CgB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CAGA,GAAIE,IAAS,mCAAqCA,EAAK,WAAW,kCAAkC,EAAG,CACtG,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACAA,EAAG,SACDsB,GAAetC,EAASC,EAAKe,EAAIX,EAAWH,EAAKC,CAAI,EADnCgB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,YAAa,QAAQ,2BAAQ,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,EADrIkB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAG/I,CAEA,GAAIE,IAAS,oCAAsC,yCAAyC,KAAKA,CAAI,EAAG,CACvG,IAAMa,EAAK,MAAMC,EAAejB,EAASC,CAAG,EAC5C,OAAKe,EACEuB,GAAqBvC,EAASC,EAAKe,EAAIX,EAAWH,EAAKC,CAAI,EADlDgB,EAAa,IAAK,CAAE,GAAG,GAAO,KAAK,eAAgB,QAAQ,qBAAO,KAAK,CAAE,UAAAd,CAAU,CAAE,EAAGe,EAAyBpB,EAASC,CAAG,CAAC,CAE/I,CAGA,GAAIE,EAAK,WAAW,gBAAgB,EACnC,OAAOI,EAAMN,EAAI,kBAAmBE,EAAK,QAAQ,YAAa,EAAE,CAAC,EAIlE,GAAIA,IAAS,UAAYA,EAAK,WAAW,SAAS,EACjD,OAAOI,EAAMN,EAAI,mBAAoB,QAAQ,EAI9C,GAAIE,EAAK,WAAW,YAAY,EAAG,CAElC,GAAI,CADQ,MAAMc,EAAejB,EAASC,CAAG,EACnC,CACT,IAAMuC,EAAW,mBAAmB,mBAAmBrC,CAAI,CAAC,GAC5D,OAAO,IAAI,SAAS,KAAM,CAAE,OAAQ,IAAK,QAAS,CAAE,SAAUqC,CAAS,CAAE,CAAC,CAC3E,CACA,OAAOjC,EAAMN,EAAI,mBAAoBE,EAAK,QAAQ,YAAa,EAAE,CAAC,CACnE,CAGA,OAAO,MAAMH,CAAO,CACrB,EAGA,MAAM,UAAUyC,EAAOxC,EAAKyC,EAAK,CAChC,IAAMrC,EAAY,OAAO,WAAW,EACpC,QAAQ,IAAI,KAAK,UAAU,CAC1B,MAAO,OACP,UAAAA,EACA,MAAO,iBACP,cAAe,IAAI,KAAKoC,EAAM,aAAa,EAAE,YAAY,EACzD,KAAMA,EAAM,IACb,CAAC,CAAC,EAEF,GAAI,CAEH,IAAME,EAAM,IAAI,KAAKF,EAAM,aAAa,EAClCG,EAAY,IAAI,KAAK,KAAK,IAAID,EAAI,eAAe,EAAGA,EAAI,YAAY,EAAI,EAAG,CAAC,CAAC,EAC7EE,EAAqB,IAAI,KAAK,KAAK,IAAID,EAAU,eAAe,EAAGA,EAAU,YAAY,EAAI,EAAG,CAAC,CAAC,EAClGE,EAAa,GAAGD,EAAmB,eAAe,CAAC,IAAI,OAAOA,EAAmB,YAAY,EAAI,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,IAAI,OAAOA,EAAmB,WAAW,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,GAChLE,EAAe,GAAGJ,EAAI,eAAe,CAAC,IAAI,OAAOA,EAAI,YAAY,EAAI,CAAC,EAAE,SAAS,EAAG,GAAG,CAAC,GAGxFK,EAAgB,MAAM/C,EAAI,SAAS,QACxC;AAAA;AAAA;AAAA,+EAID,EAAE,KAAK6C,CAAU,EAAE,IAAI,EAEnBG,EAAiB,EACfC,EAAW,CAAC,EAElB,QAAWC,KAAUH,GAAe,SAAW,CAAC,EAAI,CAEnD,IAAMI,EADa,OAAOD,EAAM,aAAe,CAAC,EAChB,IAC1BE,EAAQ,OAAOF,EAAM,iBAAmB,CAAC,EACzCG,EAAO,OAAOH,EAAM,eAAiB,CAAC,EACtCI,EAAc,KAAK,MAAMF,EAAQD,EAAaE,EAAO,GAAG,EAG9D,MAAMrD,EAAI,SAAS,QAClB;AAAA;AAAA,6BAGD,EAAE,KACD,OAAOkD,EAAM,OAAO,EACpBJ,EACAM,EACAE,EACA,KAAK,UAAU,CAACJ,EAAM,QAAQ,CAAC,CAChC,EAAE,IAAI,EAGN,MAAMlD,EAAI,SAAS,QAClB,0EACD,EAAE,KAAKkD,EAAM,QAAQ,EAAE,IAAI,EAE3BD,EAAS,KAAKC,EAAM,QAAQ,EAC5BF,GACD,CAGA,MAAMhD,EAAI,SAAS,QAClB;AAAA;AAAA,+CAGD,EAAE,KAAK,oBAAqB,KAAK,UAAU,CAC1C,WAAA6C,EACA,eAAAG,EACA,SAAAC,EACA,aAAAH,EACA,YAAa,MACd,CAAC,CAAC,EAAE,IAAI,EAER,QAAQ,IAAI,KAAK,UAAU,CAC1B,MAAO,OACP,UAAA1C,EACA,MAAO,iBACP,eAAA4C,EACA,WAAAH,EACA,aAAAC,CACD,CAAC,CAAC,CAEH,OAASS,EAAK,CACb,QAAQ,MAAM,KAAK,UAAU,CAC5B,MAAO,QACP,UAAAnD,EACA,MAAO,cACP,MAAO,OAAOmD,CAAG,CAClB,CAAC,CAAC,EAGF,GAAI,CACH,MAAMvD,EAAI,SAAS,QAClB;AAAA;AAAA,+CAGD,EAAE,KAAK,oBAAqB,OAAOuD,CAAG,CAAC,EAAE,IAAI,CAC9C,MAAY,CACX,QAAQ,MAAM,KAAK,UAAU,CAC5B,MAAO,QACP,UAAAnD,EACA,MAAO,0BACR,CAAC,CAAC,CACH,CACD,CACD,CACD",
  "names": ["jsonResponse", "status", "body", "extraHeaders", "__name", "generateRequestId", "random", "b", "verifyPasswordPBKDF2", "password", "stored", "parts", "iterations", "salt", "c", "expected", "enc", "keyMaterial", "derivedBits", "derived", "diff", "i", "hashPasswordPBKDF2", "keyLen", "b64", "u8", "generateSessionId", "bytes", "getCorsHeadersForRequest", "request", "env", "origin", "host", "corsPreflightResponse", "headers", "getCookie", "name", "p", "k", "v", "getSessionUser", "cookieName", "sessionId", "row", "exp", "handleLogin", "request", "env", "requestId", "jsonResponse", "getCorsHeadersForRequest", "payload", "username", "password", "errors", "userRow", "corsHeaders", "unauthorized", "__name", "hash", "verifyPasswordPBKDF2", "sessionId", "generateSessionId", "ttlSec", "createdAt", "expiresAt", "cookie", "data", "err", "body", "handleAuthMe", "row", "getSessionUser", "handleClients", "request", "env", "me", "requestId", "url", "corsHeaders", "getCorsHeadersForRequest", "method", "matchItems", "clientId", "serviceId", "jsonResponse", "data", "item", "err", "body", "matchServices", "clientServices", "services", "serviceIds", "r", "placeholders", "service", "matchSingle", "row", "tags", "part", "id", "name", "color", "servicesRows", "svc", "billing_schedule", "b", "year_total", "sum", "matchList", "params", "page", "perPage", "offset", "companyName", "where", "binds", "whereSql", "countRow", "total", "meta", "errors", "assigneeUserId", "phone", "email", "clientNotes", "paymentNotes", "tagIds", "x", "n", "now", "tagId", "clientIds", "updatedCount", "matchAddService", "serviceCycle", "status", "taskTemplateId", "autoGenerateTasks", "startDate", "endDate", "serviceNotes", "clientServiceId", "matchUpdateService", "__name", "handleTasks", "request", "env", "me", "requestId", "url", "corsHeaders", "getCorsHeadersForRequest", "method", "params", "page", "perPage", "offset", "q", "status", "due", "where", "binds", "whereSql", "countRow", "total", "data", "r", "meta", "jsonResponse", "err", "body", "clientServiceId", "taskName", "dueDate", "assigneeUserId", "stageNames", "s", "errors", "now", "idRow", "taskId", "order", "__name", "WORK_TYPES", "calculateWeightedHours", "workTypeId", "hours", "workType", "__name", "handleGetTimelogs", "request", "env", "me", "requestId", "url", "corsHeaders", "getCorsHeadersForRequest", "params", "startDate", "endDate", "where", "binds", "whereSql", "data", "r", "jsonResponse", "err", "body", "handlePostTimelogs", "work_date", "client_id", "service_id", "service_item_id", "work_type_id", "notes", "timesheet_id", "errors", "holidayRow", "dow", "dateType", "allowedTypes", "dateTypeNames", "dateTypeName", "weighted_hours", "log_id", "isUpdate", "oldData", "oldHours", "hoursDiff", "sumRow", "workTypeSum", "currentWorkTypeTotal", "newWorkTypeTotal", "duplicateRow", "existingRow", "existingHours", "newTotalHours", "otherHoursTotal", "dailyTotal", "existingWorkTypeTotal", "comp_hours_generated", "generatedDate", "dateObj", "year", "month", "lastDay", "expiryDate", "handleDeleteTimelogsBatch", "start_date", "end_date", "deleted_count", "handleGetMonthlySummary", "monthNum", "userId", "timelogs", "totalHours", "overtimeHours", "weightedHours", "log", "leaveRows", "leaveHours", "row", "amount", "handleTimesheets", "method", "handleReceipts", "request", "env", "me", "requestId", "url", "corsHeaders", "getCorsHeadersForRequest", "method", "path", "clientServiceId", "billingMonth", "jsonResponse", "schedule", "err", "params", "page", "perPage", "offset", "q", "status", "receiptType", "dateFrom", "dateTo", "where", "binds", "whereSql", "countRow", "total", "data", "r", "meta", "body", "client_id", "receipt_date", "due_date_raw", "total_amount", "statusVal", "notes", "relatedTaskId", "errors", "yyyy", "mm", "prefix", "maxRow", "seq", "m", "receipt_id", "due_date", "dueDays", "d", "y", "m2", "day", "__name", "handlePayroll", "request", "env", "me", "requestId", "url", "path", "corsHeaders", "getCorsHeadersForRequest", "jsonResponse", "__name", "handleLeaves", "request", "env", "me", "requestId", "url", "path", "corsHeaders", "getCorsHeadersForRequest", "method", "jsonResponse", "params", "year", "data", "r", "compRow", "compRemain", "err", "page", "perPage", "offset", "q", "status", "type", "dateFrom", "dateTo", "where", "binds", "whereSql", "countRow", "total", "meta", "body", "leave_type", "start_date", "end_date", "unit", "amount", "reason", "errors", "hoursNeeded", "totalAvailable", "sum", "g", "idRow", "leaveId", "compGrants", "remaining", "grant", "deduct", "newRemaining", "newUsed", "newStatus", "jobName", "now", "lastMonth", "lastDayOfLastMonth", "expiryDate", "currentMonth", "expiredGrants", "processedCount", "grantIds", "hourlyRate", "hours", "rate", "amountCents", "totalRow", "__name", "handleDevSeeding", "request", "env", "requestId", "path", "jsonResponse", "corsHeaders", "getCorsHeadersForRequest", "cookieName", "sid", "getCookie", "exists", "exp", "row", "body", "username", "name", "password", "email", "passwordHash", "hashPasswordPBKDF2", "err", "now", "cs1", "cs2", "cs3", "today", "fmt", "__name", "d", "off", "y", "handleOverhead", "request", "env", "me", "requestId", "url", "path", "corsHeaders", "getCorsHeadersForRequest", "method", "params", "page", "perPage", "offset", "q", "category", "isActive", "where", "binds", "whereSql", "countRow", "total", "data", "r", "jsonResponse", "err", "body", "code", "name", "methodVal", "description", "errors", "row", "msg", "year", "month", "items", "s", "x", "totalFixed", "totalVariable", "cost_type_id", "amount", "notes", "idRow", "list", "byCategory", "typeBreakdown", "empRow", "employeeCount", "overheadPerEmployee", "__name", "handleReports", "request", "env", "me", "requestId", "url", "path", "corsHeaders", "getCorsHeadersForRequest", "method", "parseDate", "__name", "s", "d", "parseYearMonth", "m", "y", "mo", "jsonResponse", "p", "start", "end", "clientId", "includeBonus", "binds", "where", "hoursRows", "hoursByClient", "r", "clientIds", "recBinds", "recWhere", "recRows", "revenueByClient", "startYm", "endYm", "totalOverhead", "totalHours", "x", "warnings", "nameMap", "placeholders", "nameRows", "data", "cid", "actual", "weighted", "revenue", "ohAlloc", "salaryCost", "bonusAlloc", "totalCost", "grossProfit", "margin", "err", "qUserId", "userFilterId", "ym", "aggRows", "dailyRows", "distRows", "userIds", "usersMap", "uRows", "clientMap", "cRows", "dailyByUser", "arr", "distByUser", "hours", "uid", "total", "normal", "ot", "billable", "nonBillable", "utilization", "dist", "distTotal", "daily", "userId", "run", "q", "list", "cents", "v", "toAmt", "c", "byEmployee", "sum", "k", "summary", "monthly_trend", "total_receipts", "total_paid", "total_outstanding", "collection_rate", "by_client", "b64urlEncode", "u8", "__name", "hmacSha256", "keyBytes", "msgBytes", "key", "sig", "utf8", "str", "sanitizeFilename", "name", "extFromFilename", "m", "handleAttachments", "request", "env", "me", "requestId", "url", "path", "corsHeaders", "getCorsHeadersForRequest", "method", "jsonResponse", "body", "entityType", "entityId", "filenameRaw", "contentType", "contentLength", "allowedExt", "allowedMime", "safeName", "ext", "limit", "cntRow", "envName", "now", "rand", "randStr", "objectKey", "expiresAt", "payload", "secret", "pBytes", "token", "data", "parts", "c", "sBytes", "expected", "okSig", "i", "reqCt", "reqLen", "cd", "row", "err", "params", "page", "perPage", "offset", "q", "fileType", "dateFrom", "dateTo", "where", "binds", "whereSql", "countRow", "total", "r", "handleSOP", "request", "env", "me", "requestId", "url", "path", "corsHeaders", "getCorsHeadersForRequest", "method", "jsonResponse", "p", "page", "perPage", "offset", "q", "category", "tagsCsv", "published", "where", "binds", "tagList", "s", "t", "whereSql", "countRow", "total", "items", "r", "err", "__name", "parseId", "s", "n", "__name", "todayStr", "y", "m", "day", "isValidYmd", "handleClientServices", "request", "env", "me", "requestId", "url", "path", "corsHeaders", "getCorsHeadersForRequest", "method", "p", "status", "q", "page", "perPage", "offset", "where", "binds", "whereSql", "totalRow", "data", "r", "jsonResponse", "err", "suspendMatch", "resumeMatch", "cancelMatch", "historyMatch", "body", "id", "reason", "notes", "effective", "svc", "nowIso", "cancelTasks", "tasksCancelled", "handleCMS", "request", "env", "me", "requestId", "url", "path", "corsHeaders", "getCorsHeadersForRequest", "method", "jsonResponse", "p", "status", "category", "tag", "keyword", "page", "perPage", "offset", "where", "binds", "whereSql", "totalRow", "data", "r", "err", "fileType", "__name", "DANGEROUS_KEYS", "ALLOWED_KEYS", "normalizeKey", "key", "__name", "handleSettings", "request", "env", "me", "requestId", "url", "path", "corsHeaders", "getCorsHeadersForRequest", "method", "data", "r", "jsonResponse", "err", "rows", "map", "payload", "value", "n", "nowIso", "ymToday", "__name", "todayYmd", "handleDashboard", "request", "env", "me", "requestId", "url", "path", "corsHeaders", "getCorsHeadersForRequest", "method", "jsonResponse", "searchParams", "requestedYm", "ym", "financeYm", "financeMode", "today", "getEmployeeMetrics", "res", "h", "total", "normal", "overtime", "target", "completionRate", "items", "r", "due", "urgency", "daysUntilDue", "daysOverdue", "now", "d", "delta", "counts", "it", "rows", "bal", "t", "recent", "getAdminMetrics", "targetYm", "finYm", "finMode", "e", "currentYear", "arRow", "overdueRow", "ar", "overdue", "monthData", "ytdData", "monthPaidRow", "monthRevRow", "monthCost", "pr", "monthRevenue", "monthPaid", "monthProfit", "monthMargin", "monthCollectionRate", "ytdPaidRow", "ytdRevRow", "ytdCost", "ytdRevenue", "ytdPaid", "ytdProfit", "ytdMargin", "ytdCollectionRate", "list", "a", "data", "err", "isValidSchedule", "type", "value", "__name", "parseJsonSafe", "s", "def", "handleAutomation", "request", "env", "me", "requestId", "url", "path", "corsHeaders", "getCorsHeadersForRequest", "jsonResponse", "method", "p", "q", "enabled", "page", "perPage", "offset", "where", "binds", "whereSql", "totalRow", "data", "r", "err", "body", "name", "scheduleType", "scheduleValue", "condition", "action", "errors", "idRow", "updateMatch", "id", "isEnabled", "sets", "t", "v", "testMatch", "row", "summary", "handleHolidays", "request", "env", "me", "requestId", "url", "corsHeaders", "getCorsHeadersForRequest", "params", "startDate", "endDate", "where", "binds", "whereSql", "data", "r", "jsonResponse", "err", "body", "__name", "handleTags", "request", "env", "me", "requestId", "url", "corsHeaders", "getCorsHeadersForRequest", "method", "data", "r", "jsonResponse", "err", "body", "tagId", "row", "errors", "tagName", "tagColor", "now", "updates", "binds", "usage", "__name", "parseId", "s", "n", "__name", "handleBilling", "request", "env", "me", "requestId", "url", "path", "corsHeaders", "getCorsHeadersForRequest", "method", "matchGet", "clientServiceId", "jsonResponse", "service", "data", "r", "yearTotal", "sum", "item", "err", "body", "errors", "billingMonth", "billingAmount", "paymentDueDays", "notes", "scheduleId", "matchUpdate", "parseId", "s", "n", "__name", "handleTaskTemplates", "request", "env", "me", "requestId", "url", "path", "corsHeaders", "getCorsHeadersForRequest", "method", "serviceId", "clientId", "query", "params", "data", "r", "jsonResponse", "err", "matchGet", "templateId", "template", "stages", "body", "errors", "templateName", "description", "sopId", "i", "stage", "stageName", "stageDesc", "estimatedHours", "matchUpdate", "isActive", "matchStages", "stageOrder", "dependencies", "attachmentId", "result", "matchDeleteStage", "stageId", "parseId", "s", "n", "__name", "handleServices", "request", "env", "me", "requestId", "url", "path", "corsHeaders", "getCorsHeadersForRequest", "method", "data", "r", "jsonResponse", "err", "body", "serviceName", "serviceCode", "description", "sortOrder", "result", "matchUpdate", "serviceId", "matchDelete", "matchGetItems", "matchCreateItem", "itemName", "itemCode", "matchUpdateItem", "itemId", "matchDeleteItem", "index_default", "request", "env", "url", "path", "method", "requestId", "generateRequestId", "proxy", "__name", "host", "newPath", "target", "corsPreflightResponse", "handleLogin", "handleAuthMe", "handleDevSeeding", "me", "getSessionUser", "handleClients", "jsonResponse", "getCorsHeadersForRequest", "handleTags", "handleBilling", "handleTaskTemplates", "handleServices", "handleTasks", "handleTimesheets", "handleReceipts", "handleAttachments", "handleLeaves", "handleHolidays", "handlePayroll", "handleOverhead", "handleCMS", "handleReports", "handleSOP", "handleDashboard", "handleAutomation", "handleSettings", "handleClientServices", "location", "event", "ctx", "now", "lastMonth", "lastDayOfLastMonth", "expiryDate", "currentMonth", "expiredGrants", "processedCount", "grantIds", "grant", "hourlyRate", "hours", "rate", "amountCents", "err"]
}
