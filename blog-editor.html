<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Blog æ–‡ç« ç·¨è¼¯å™¨" />
    <title>ç·¨è¼¯æ–‡ç« ï½œCMS</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    
    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/vendor/quill-better-table.css" />
    
    <style>
      * { box-sizing: border-box; }
      
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
        background: #f5f7fa;
      }
      
      /* é¡¶éƒ¨å·¥å…·æ  */
      .top-toolbar {
        background: white;
        border-bottom: 2px solid #e5e7eb;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      }
      
      .top-toolbar-left {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      
      .top-toolbar-right {
        display: flex;
        gap: 12px;
      }
      
      .btn {
        padding: 10px 20px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      
      .btn.primary {
        background: linear-gradient(135deg, #2c5f7c 0%, #1e4a63 100%);
        color: white;
        border-color: #2c5f7c;
      }
      
      .btn.secondary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border-color: #10b981;
      }
      
      /* ä¸»ç¼–è¾‘åŒº */
      .editor-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        height: calc(100vh - 70px);
        gap: 0;
      }
      
      /* å·¦ä¾§ï¼šç¼–è¾‘åŒº */
      .editor-panel {
        background: white;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border-right: 2px solid #e5e7eb;
      }
      
      .editor-header {
        padding: 24px;
        border-bottom: 2px solid #f0f0f0;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      }
      
      .editor-header h2 {
        margin: 0 0 16px 0;
        color: #2c5f7c;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .form-group {
        margin-bottom: 16px;
      }
      
      .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
        color: #374151;
        font-size: 14px;
      }
      
      .form-group input[type="text"],
      .form-group select {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.3s;
      }
      
      .form-group input[type="text"]:focus,
      .form-group select:focus {
        outline: none;
        border-color: #2c5f7c;
        box-shadow: 0 0 0 3px rgba(44, 95, 124, 0.1);
      }
      
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      
      .tags-input-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 8px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        min-height: 44px;
        align-items: center;
      }
      
      .tag-item {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
        padding: 4px 10px;
        border-radius: 16px;
        font-size: 13px;
        font-weight: 600;
      }
      
      .tag-remove {
        cursor: pointer;
        font-weight: bold;
        opacity: 0.7;
      }
      
      .tag-remove:hover {
        opacity: 1;
      }
      
      .tags-input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 120px;
        font-size: 14px;
      }
      
      /* å›¾ç‰‡ä¸Šä¼ åŒº */
      .image-upload-area {
        border: 2px dashed #cbd5e1;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: #f8fafc;
      }
      
      .image-upload-area:hover {
        border-color: #2c5f7c;
        background: #f0f9ff;
      }
      
      .image-upload-area.dragover {
        border-color: #2c5f7c;
        background: #dbeafe;
      }
      
      .image-preview {
        margin-top: 12px;
        max-width: 100%;
        border-radius: 8px;
        overflow: hidden;
      }
      
      .image-preview img {
        max-width: 100%;
        height: auto;
        display: block;
      }
      
      /* Quill ç¼–è¾‘å™¨ */
      .editor-content {
        flex: 1;
        overflow: auto;
        padding: 24px;
      }
      
      #quill-editor {
        height: 100%;
        background: white;
      }
      
      .ql-container {
        font-size: 16px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
      }
      
      /* å³ä¾§ï¼šå®Œæ•´é¢„è§ˆ */
      .preview-panel {
        background: #e5e7eb;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      .preview-header {
        padding: 16px 24px;
        background: white;
        border-bottom: 2px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .preview-header h2 {
        margin: 0;
        color: #2c5f7c;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .preview-mode-switch {
        display: flex;
        gap: 8px;
        background: #f3f4f6;
        padding: 4px;
        border-radius: 8px;
      }
      
      .preview-mode-btn {
        padding: 8px 16px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
      }
      
      .preview-mode-btn.active {
        background: white;
        color: #2c5f7c;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .preview-content {
        flex: 1;
        overflow: auto;
        padding: 24px;
        display: flex;
        justify-content: center;
      }
      
      .preview-iframe-wrapper {
        width: 100%;
        max-width: 100%;
        background: white;
        box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.5s;
      }
      
      .preview-iframe-wrapper.mobile {
        max-width: 375px;
      }
      
      .preview-iframe-wrapper.tablet {
        max-width: 768px;
      }
      
      #preview-frame {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
        min-height: 800px;
      }
      
      /* å“åº”å¼ */
      @media (max-width: 1200px) {
        .editor-layout {
          grid-template-columns: 1fr;
        }
        
        .preview-panel {
          display: none;
        }
      }
      
      /* åŠ è½½æç¤º */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      
      .loading-spinner {
        background: white;
        padding: 32px 48px;
        border-radius: 12px;
        text-align: center;
      }
      
      .spinner {
        border: 4px solid #f3f4f6;
        border-top: 4px solid #2c5f7c;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <!-- åŠ è½½æç¤º -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <div>è™•ç†ä¸­...</div>
      </div>
    </div>
    
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="top-toolbar">
      <div class="top-toolbar-left">
        <button class="btn" onclick="goBack()">â† è¿”å›åˆ—è¡¨</button>
        <span id="articleStatus" style="font-weight: 600; color: #6b7280;">è‰ç¨¿</span>
      </div>
      <div class="top-toolbar-right">
        <button class="btn" id="btnSaveDraft">ğŸ’¾ ä¿å­˜è‰ç¨¿</button>
        <button class="btn secondary" id="btnPublish">âœ“ ç™¼å¸ƒæ–‡ç« </button>
      </div>
    </div>
    
    <!-- ä¸»ç¼–è¾‘åŒº -->
    <div class="editor-layout">
      <!-- å·¦ä¾§ï¼šç¼–è¾‘å™¨ -->
      <div class="editor-panel">
        <div class="editor-header">
          <h2>ğŸ“ å…§å®¹ç·¨è¼¯</h2>
          
          <!-- æ ‡é¢˜ -->
          <div class="form-group">
            <label for="articleTitle">æ–‡ç« æ¨™é¡Œ *</label>
            <input type="text" id="articleTitle" placeholder="è¼¸å…¥æ–‡ç« æ¨™é¡Œ..." maxlength="100" required>
          </div>
          
          <!-- åˆ†ç±»å’Œæ ‡ç­¾ -->
          <div class="form-row">
            <div class="form-group">
              <label for="articleCategory">åˆ†é¡</label>
              <select id="articleCategory">
                <option value="">é¸æ“‡åˆ†é¡</option>
                <option value="å‰µæ¥­æŒ‡å—">å‰µæ¥­æŒ‡å—</option>
                <option value="ç¨…å‹™çŸ¥è­˜">ç¨…å‹™çŸ¥è­˜</option>
                <option value="æœƒè¨ˆå¯¦å‹™">æœƒè¨ˆå¯¦å‹™</option>
                <option value="æ³•è¦æ›´æ–°">æ³•è¦æ›´æ–°</option>
                <option value="ç¶“ç‡Ÿç®¡ç†">ç¶“ç‡Ÿç®¡ç†</option>
              </select>
            </div>
            <div class="form-group">
              <label>æ¨™ç±¤</label>
              <div class="tags-input-wrapper" id="tagsWrapper">
                <input type="text" class="tags-input" id="tagsInput" placeholder="è¼¸å…¥æ¨™ç±¤å¾ŒæŒ‰ Enter...">
              </div>
            </div>
          </div>
          
          <!-- ç‰¹è‰²å›¾ç‰‡ -->
          <div class="form-group">
            <label>ç‰¹è‰²åœ–ç‰‡</label>
            <div class="image-upload-area" id="imageUploadArea">
              <div>ğŸ“· é»æ“Šä¸Šå‚³æˆ–æ‹–æ‹½åœ–ç‰‡åˆ°é€™è£¡</div>
              <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">å»ºè­°å°ºå¯¸ï¼š1200x630pxï¼Œæœ€å¤§ 5MB</div>
              <input type="file" id="imageInput" accept="image/*" style="display: none;">
            </div>
            <div class="image-preview" id="imagePreview" style="display: none;"></div>
          </div>
          
          <!-- æ‘˜è¦ -->
          <div class="form-group">
            <label for="articleSummary">æ–‡ç« æ‘˜è¦</label>
            <input type="text" id="articleSummary" placeholder="ç°¡çŸ­æè¿°æ–‡ç« å…§å®¹ï¼ˆé¸å¡«ï¼‰" maxlength="200">
          </div>
        </div>
        
        <!-- Quill ç¼–è¾‘å™¨ -->
        <div class="editor-content">
          <div id="quill-editor"></div>
        </div>
      </div>
      
      <!-- å³ä¾§ï¼šå®Œæ•´é¢„è§ˆ -->
      <div class="preview-panel">
        <div class="preview-header">
          <h2>ğŸ‘ï¸ å¯¦éš›ç¶²é é è¦½</h2>
          <div class="preview-mode-switch">
            <button class="preview-mode-btn active" data-mode="desktop">ğŸ–¥ï¸ æ¡Œé¢</button>
            <button class="preview-mode-btn" data-mode="tablet">ğŸ“± å¹³æ¿</button>
            <button class="preview-mode-btn" data-mode="mobile">ğŸ“± æ‰‹æ©Ÿ</button>
          </div>
        </div>
        <div class="preview-content">
          <div class="preview-iframe-wrapper" id="previewWrapper">
            <iframe id="preview-frame" sandbox="allow-same-origin allow-scripts"></iframe>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Quill å’Œç›¸å…³åº“ -->
    <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
    <script src="/assets/vendor/quill-better-table.js"></script>
    
    <script>
      // å…¨å±€å˜é‡
      const onProdHost = location.hostname.endsWith('horgoscpa.com');
      const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
      
      let quill = null;
      let currentArticleId = null;
      let featuredImageUrl = '';
      let tags = [];
      let previewUpdateTimer = null;
      
      // ä» URL è·å–æ–‡ç«  IDï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
      const urlParams = new URLSearchParams(window.location.search);
      currentArticleId = urlParams.get('id');
      
      // åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', async () => {
        await checkAuth();
        initQuillEditor();
        initImageUpload();
        initTagsInput();
        initPreviewModeSwitch();
        
        if (currentArticleId) {
          loadArticle(currentArticleId);
        } else {
          updatePreview();
        }
        
        // ç»‘å®šä¿å­˜å’Œå‘å¸ƒæŒ‰é’®
        document.getElementById('btnSaveDraft').addEventListener('click', () => saveArticle(false));
        document.getElementById('btnPublish').addEventListener('click', () => saveArticle(true));
        
        // ç›‘å¬å†…å®¹å˜åŒ–ï¼Œå®æ—¶æ›´æ–°é¢„è§ˆ
        document.getElementById('articleTitle').addEventListener('input', schedulePreviewUpdate);
        document.getElementById('articleCategory').addEventListener('change', schedulePreviewUpdate);
        document.getElementById('articleSummary').addEventListener('input', schedulePreviewUpdate);
        quill.on('text-change', schedulePreviewUpdate);
      });
      
      // æ£€æŸ¥è®¤è¯
      async function checkAuth() {
        try {
          const res = await fetch(`${apiBase}/auth/me`, { credentials: 'include' });
          if (res.status === 401) {
            location.assign('/login?redirect=' + encodeURIComponent(location.pathname + location.search));
            return;
          }
          const json = await res.json();
          if (!json?.ok || !json?.data?.isAdmin) {
            alert('æ‚¨æ²’æœ‰æ¬Šé™å­˜å–æ­¤é é¢');
            location.assign('/internal/cms');
          }
        } catch (err) {
          alert('èªè­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥');
          location.assign('/login');
        }
      }
      
      // åˆå§‹åŒ– Quill ç¼–è¾‘å™¨
      function initQuillEditor() {
        quill = new Quill('#quill-editor', {
          theme: 'snow',
          modules: {
            toolbar: [
              [{ 'header': [1, 2, 3, false] }],
              ['bold', 'italic', 'underline', 'strike'],
              ['blockquote', 'code-block'],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              [{ 'indent': '-1'}, { 'indent': '+1' }],
              ['link', 'image', 'video'],
              [{ 'color': [] }, { 'background': [] }],
              [{ 'align': [] }],
              ['clean']
            ]
          },
          placeholder: 'é–‹å§‹æ’°å¯«æ–‡ç« å…§å®¹...'
        });
        
        // è‡ªå®šä¹‰å›¾ç‰‡å¤„ç†å™¨ï¼ˆæ”¯æŒä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰
        const toolbar = quill.getModule('toolbar');
        toolbar.addHandler('image', imageHandler);
      }
      
      // å›¾ç‰‡å¤„ç†å™¨
      function imageHandler() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();
        
        input.onchange = async () => {
          const file = input.files[0];
          if (!file) return;
          
          if (file.size > 5 * 1024 * 1024) {
            alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB');
            return;
          }
          
          // æš‚æ—¶ä½¿ç”¨ Base64ï¼Œåç»­å¯æ”¹ä¸ºä¸Šä¼ åˆ°æœåŠ¡å™¨
          const reader = new FileReader();
          reader.onload = (e) => {
            const range = quill.getSelection(true);
            quill.insertEmbed(range.index, 'image', e.target.result);
            quill.setSelection(range.index + 1);
          };
          reader.readAsDataURL(file);
        };
      }
      
      // åˆå§‹åŒ–ç‰¹è‰²å›¾ç‰‡ä¸Šä¼ 
      function initImageUpload() {
        const uploadArea = document.getElementById('imageUploadArea');
        const input = document.getElementById('imageInput');
        const preview = document.getElementById('imagePreview');
        
        uploadArea.addEventListener('click', () => input.click());
        
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
          uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadArea.classList.remove('dragover');
          const file = e.dataTransfer.files[0];
          if (file && file.type.startsWith('image/')) {
            handleImageUpload(file);
          }
        });
        
        input.addEventListener('change', () => {
          const file = input.files[0];
          if (file) handleImageUpload(file);
        });
      }
      
      // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
      function handleImageUpload(file) {
        if (file.size > 5 * 1024 * 1024) {
          alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          featuredImageUrl = e.target.result;
          const preview = document.getElementById('imagePreview');
          preview.innerHTML = `<img src="${featuredImageUrl}" alt="ç‰¹è‰²åœ–ç‰‡">`;
          preview.style.display = 'block';
          schedulePreviewUpdate();
        };
        reader.readAsDataURL(file);
      }
      
      // åˆå§‹åŒ–æ ‡ç­¾è¾“å…¥
      function initTagsInput() {
        const wrapper = document.getElementById('tagsWrapper');
        const input = document.getElementById('tagsInput');
        
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            const tag = input.value.trim();
            if (tag && !tags.includes(tag)) {
              tags.push(tag);
              renderTags();
              input.value = '';
              schedulePreviewUpdate();
            }
          }
        });
      }
      
      // æ¸²æŸ“æ ‡ç­¾
      function renderTags() {
        const wrapper = document.getElementById('tagsWrapper');
        const input = document.getElementById('tagsInput');
        const existingTags = wrapper.querySelectorAll('.tag-item');
        existingTags.forEach(tag => tag.remove());
        
        tags.forEach((tag, index) => {
          const tagEl = document.createElement('span');
          tagEl.className = 'tag-item';
          tagEl.innerHTML = `${tag} <span class="tag-remove" onclick="removeTag(${index})">Ã—</span>`;
          wrapper.insertBefore(tagEl, input);
        });
      }
      
      // ç§»é™¤æ ‡ç­¾
      function removeTag(index) {
        tags.splice(index, 1);
        renderTags();
        schedulePreviewUpdate();
      }
      
      // åˆå§‹åŒ–é¢„è§ˆæ¨¡å¼åˆ‡æ¢
      function initPreviewModeSwitch() {
        document.querySelectorAll('.preview-mode-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.preview-mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const mode = btn.dataset.mode;
            const wrapper = document.getElementById('previewWrapper');
            wrapper.className = 'preview-iframe-wrapper';
            if (mode !== 'desktop') {
              wrapper.classList.add(mode);
            }
          });
        });
      }
      
      // å»¶è¿Ÿæ›´æ–°é¢„è§ˆï¼ˆé˜²æŠ–ï¼‰
      function schedulePreviewUpdate() {
        clearTimeout(previewUpdateTimer);
        previewUpdateTimer = setTimeout(updatePreview, 500);
      }
      
      // æ›´æ–°é¢„è§ˆ
      function updatePreview() {
        const title = document.getElementById('articleTitle').value || 'æ–‡ç« æ¨™é¡Œ';
        const category = document.getElementById('articleCategory').value || 'æœªåˆ†é¡';
        const summary = document.getElementById('articleSummary').value || '';
        const content = quill.root.innerHTML;
        
        const previewHTML = `
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title}</title>
  <link rel="stylesheet" href="/assets/css/common.css">
  <link rel="stylesheet" href="/assets/css/blog-article-modern.css">
  <style>
    body { margin: 0; padding: 0; }
    .preview-badge {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #f59e0b;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div class="preview-badge">é è¦½æ¨¡å¼</div>
  
  <!-- å¯¼èˆªæ  -->
  <nav style="background: linear-gradient(135deg, #2c5f7c 0%, #1e4a63 100%); color: white; padding: 20px 0;">
    <div style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="font-size: 24px; font-weight: 700;">é´»é–£æœƒè¨ˆå¸«äº‹å‹™æ‰€</div>
        <div style="display: flex; gap: 24px; font-size: 15px;">
          <a href="/" style="color: white; text-decoration: none;">é¦–é </a>
          <a href="/services.html" style="color: white; text-decoration: none;">æœå‹™é …ç›®</a>
          <a href="/blog.html" style="color: white; text-decoration: none; border-bottom: 2px solid white;">éƒ¨è½æ ¼</a>
          <a href="/team.html" style="color: white; text-decoration: none;">é—œæ–¼æˆ‘å€‘</a>
          <a href="/contact.html" style="color: white; text-decoration: none;">è¯çµ¡æˆ‘å€‘</a>
        </div>
      </div>
    </div>
  </nav>
  
  <!-- æ–‡ç« å†…å®¹ -->
  <article style="max-width: 900px; margin: 40px auto; padding: 0 24px;">
    ${featuredImageUrl ? `
    <div style="margin-bottom: 32px; border-radius: 12px; overflow: hidden;">
      <img src="${featuredImageUrl}" alt="${title}" style="width: 100%; height: auto; display: block;">
    </div>
    ` : ''}
    
    <header style="margin-bottom: 32px;">
      <div style="color: #2c5f7c; font-weight: 600; margin-bottom: 12px;">ğŸ“ ${category}</div>
      <h1 style="font-size: 36px; font-weight: 700; color: #1f2937; margin: 0 0 16px 0; line-height: 1.3;">${title}</h1>
      ${summary ? `<p style="font-size: 18px; color: #6b7280; margin: 0 0 16px 0;">${summary}</p>` : ''}
      <div style="display: flex; gap: 16px; color: #9ca3af; font-size: 14px;">
        <span>ğŸ“… ${new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
        <span>ğŸ‘¤ ç·¨è¼¯è€…</span>
        ${tags.length > 0 ? `<span>ğŸ·ï¸ ${tags.map(t => `<span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-weight: 600;">${t}</span>`).join(' ')}</span>` : ''}
      </div>
    </header>
    
    <div style="font-size: 18px; line-height: 1.8; color: #374151;">
      ${content || '<p style="color: #9ca3af; text-align: center; padding: 60px 0;">é–‹å§‹æ’°å¯«å…§å®¹...</p>'}
    </div>
  </article>
  
  <!-- é¡µè„š -->
  <footer style="background: #1f2937; color: white; padding: 60px 0 30px; margin-top: 80px;">
    <div style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 40px; margin-bottom: 40px;">
        <div>
          <h3 style="margin: 0 0 16px 0;">é´»é–£æœƒè¨ˆå¸«äº‹å‹™æ‰€</h3>
          <p style="color: #9ca3af; line-height: 1.6;">æä¾›å°ˆæ¥­çš„æœƒè¨ˆã€ç¨…å‹™ã€å¯©è¨ˆåŠå•†å‹™è«®è©¢æœå‹™ã€‚</p>
        </div>
        <div>
          <h4 style="margin: 0 0 16px 0;">æœå‹™é …ç›®</h4>
          <ul style="list-style: none; padding: 0; margin: 0; color: #9ca3af;">
            <li style="margin-bottom: 8px;">è¨˜å¸³åŠç¨…å‹™ç”³å ±</li>
            <li style="margin-bottom: 8px;">è²¡å‹™å ±è¡¨ç°½è­‰</li>
            <li style="margin-bottom: 8px;">ç¨…å‹™è«®è©¢è¦åŠƒ</li>
            <li>å•†å‹™é¡§å•æœå‹™</li>
          </ul>
        </div>
        <div>
          <h4 style="margin: 0 0 16px 0;">è¯çµ¡æˆ‘å€‘</h4>
          <p style="color: #9ca3af; line-height: 1.6; margin: 0;">
            é›»è©±ï¼š(02) 1234-5678<br>
            Email: info@horgoscpa.com<br>
            åœ°å€ï¼šå°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ
          </p>
        </div>
      </div>
      <div style="text-align: center; color: #6b7280; padding-top: 24px; border-top: 1px solid #374151;">
        Â© ${new Date().getFullYear()} é´»é–£æœƒè¨ˆå¸«äº‹å‹™æ‰€ ç‰ˆæ¬Šæ‰€æœ‰
      </div>
    </div>
  </footer>
</body>
</html>
        `;
        
        const iframe = document.getElementById('preview-frame');
        iframe.srcdoc = previewHTML;
      }
      
      // åŠ è½½æ–‡ç« ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
      async function loadArticle(id) {
        try {
          showLoading();
          const res = await fetch(`${apiBase}/admin/articles/${id}`, { credentials: 'include' });
          if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
          
          const json = await res.json();
          if (!json.ok) throw new Error(json.message || 'è¼‰å…¥å¤±æ•—');
          
          const article = json.data;
          document.getElementById('articleTitle').value = article.title || '';
          document.getElementById('articleCategory').value = article.category || '';
          document.getElementById('articleSummary').value = article.summary || '';
          quill.root.innerHTML = article.content || '';
          
          if (article.featuredImage) {
            featuredImageUrl = article.featuredImage;
            document.getElementById('imagePreview').innerHTML = `<img src="${featuredImageUrl}">`;
            document.getElementById('imagePreview').style.display = 'block';
          }
          
          if (article.tags) {
            tags = Array.isArray(article.tags) ? article.tags : JSON.parse(article.tags || '[]');
            renderTags();
          }
          
          if (article.isPublished) {
            document.getElementById('articleStatus').textContent = 'å·²ç™¼å¸ƒ';
            document.getElementById('articleStatus').style.color = '#10b981';
          }
          
          updatePreview();
        } catch (err) {
          alert('è¼‰å…¥æ–‡ç« å¤±æ•—ï¼š' + err.message);
          console.error(err);
        } finally {
          hideLoading();
        }
      }
      
      // ä¿å­˜æ–‡ç« 
      async function saveArticle(publish = false) {
        const title = document.getElementById('articleTitle').value.trim();
        if (!title) {
          alert('è«‹è¼¸å…¥æ–‡ç« æ¨™é¡Œ');
          return;
        }
        
        const content = quill.root.innerHTML;
        if (!content || content === '<p><br></p>') {
          alert('è«‹è¼¸å…¥æ–‡ç« å…§å®¹');
          return;
        }
        
        const data = {
          title,
          category: document.getElementById('articleCategory').value,
          summary: document.getElementById('articleSummary').value.trim(),
          content,
          featuredImage: featuredImageUrl,
          tags: JSON.stringify(tags),
          isPublished: publish
        };
        
        try {
          showLoading();
          const url = currentArticleId 
            ? `${apiBase}/admin/articles/${currentArticleId}` 
            : `${apiBase}/admin/articles`;
          const method = currentArticleId ? 'PUT' : 'POST';
          
          const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
          });
          
          const json = await res.json();
          if (!res.ok || !json.ok) {
            throw new Error(json.message || 'ä¿å­˜å¤±æ•—');
          }
          
          alert(publish ? 'æ–‡ç« å·²ç™¼å¸ƒï¼' : 'è‰ç¨¿å·²ä¿å­˜ï¼');
          
          if (!currentArticleId && json.data?.id) {
            currentArticleId = json.data.id;
            history.replaceState(null, '', `?id=${currentArticleId}`);
          }
          
          if (publish) {
            document.getElementById('articleStatus').textContent = 'å·²ç™¼å¸ƒ';
            document.getElementById('articleStatus').style.color = '#10b981';
          }
        } catch (err) {
          alert('ä¿å­˜å¤±æ•—ï¼š' + err.message);
          console.error(err);
        } finally {
          hideLoading();
        }
      }
      
      // è¿”å›åˆ—è¡¨
      function goBack() {
        if (confirm('ç¢ºå®šè¦é›¢é–‹ï¼Ÿæœªä¿å­˜çš„å…§å®¹å°‡æœƒä¸Ÿå¤±ã€‚')) {
          location.assign('/internal/cms');
        }
      }
      
      // æ˜¾ç¤º/éšè—åŠ è½½æç¤º
      function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
      }
      
      function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
      }
    </script>
  </body>
</html>

