<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="附件系統" />
    <title>附件｜列表與上傳</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/attachments-page.css" />
  </head>
  <body class="attachments-page">
    <header class="attachments-header">
      <h1 class="attachments-title">附件</h1>
      <div id="permBar" class="info-bar" style="display:none;" role="alert">您沒有權限上傳附件</div>
      <div class="attachments-toolbar">
        <div class="entity-picker">
          <label for="entityType">實體</label>
          <select id="entityType" aria-label="實體類型">
            <option value="client">客戶</option>
            <option value="receipt">收據</option>
            <option value="sop">SOP</option>
            <option value="task">任務</option>
          </select>
          <input id="entityId" type="text" placeholder="輸入實體ID（例如 c_001）" aria-label="實體ID" />
        </div>
        <div class="toolbar-spacer"></div>
        <div class="filters">
          <input id="q" type="search" placeholder="搜尋檔名/上傳者…" aria-label="搜尋" />
          <select id="fileType" aria-label="檔案類型">
            <option value="all">全部類型</option>
            <option value="pdf">PDF</option>
            <option value="image">圖片</option>
            <option value="excel">Excel</option>
            <option value="word">Word</option>
            <option value="other">其他</option>
          </select>
          <label>起</label><input id="dateFrom" type="date" aria-label="開始日期" />
          <label>迄</label><input id="dateTo" type="date" aria-label="結束日期" />
        </div>
      </div>
    </header>

    <main class="attachments-content">
      <!-- 上傳區（有權限顯示） -->
      <section class="uploader-card" aria-label="上傳區">
        <div class="uploader-header">
          <div class="uploader-title">上傳附件</div>
          <div class="uploader-hint muted">支援 PDF/JPG/PNG/XLSX/DOCX｜單檔 ≤ 10MB</div>
        </div>
        <div class="uploader-body">
          <input id="fileInput" type="file" multiple aria-label="選擇檔案" />
          <button id="btnUpload" class="btn primary" type="button" disabled>選擇檔案</button>
        </div>
        <div id="uploadStatus" class="upload-status" style="margin-top:10px;"></div>
        <div id="uploadNote" class="muted" style="margin-top:8px;">選擇實體後可啟用上傳；達上限時將停用</div>
      </section>

      <!-- 附件列表 -->
      <section class="attachments-card">
        <div class="list-header">
          <div class="list-title">附件列表</div>
          <div class="list-actions">
            <button id="btnRefresh" class="btn" type="button">刷新</button>
          </div>
        </div>
        <table class="attachments-table" aria-label="附件列表">
          <thead>
            <tr>
              <th>檔名</th>
              <th>大小</th>
              <th>類型</th>
              <th>上傳者</th>
              <th>上傳時間</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6" class="muted">尚無附件</td></tr>
          </tbody>
        </table>
      </section>
    </main>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const permBar = document.getElementById('permBar');
        const entityType = document.getElementById('entityType');
        const entityId = document.getElementById('entityId');
        const fileInput = document.getElementById('fileInput');
        const btnUpload = document.getElementById('btnUpload');
        const btnRefresh = document.getElementById('btnRefresh');
        const tbody = document.getElementById('tbody');
        const q = document.getElementById('q');
        const fileType = document.getElementById('fileType');
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const uploadStatus = document.getElementById('uploadStatus');

        let me = null;

        function enableUploaderIfReady(){
          const ready = !!(entityType.value && entityId.value.trim());
          btnUpload.disabled = !ready || !me || permBar.style.display === 'block';
          fileInput.disabled = btnUpload.disabled;
        }

        function validateFileName(name){
          return !(/[\\/]{1,}|\.\./.test(name));
        }

        function validateFileType(file){
          const name = file.name.toLowerCase();
          const okExt = ['.pdf','.jpg','.jpeg','.png','.xlsx','.xls','.docx','.doc'];
          return okExt.some(ext => name.endsWith(ext));
        }

        function validateFileSize(file){
          return file.size <= 10 * 1024 * 1024; // 10MB
        }

        function showError(msg){
          alert(msg || '操作失敗，請稍後再試');
        }

        function inferContentType(name, fallback){
          const n = (name||'').toLowerCase();
          if (n.endsWith('.pdf')) return 'application/pdf';
          if (n.endsWith('.jpg') || n.endsWith('.jpeg')) return 'image/jpeg';
          if (n.endsWith('.png')) return 'image/png';
          if (n.endsWith('.xlsx')) return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
          if (n.endsWith('.xls')) return 'application/vnd.ms-excel';
          if (n.endsWith('.docx')) return 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
          if (n.endsWith('.doc')) return 'application/msword';
          return fallback || 'application/octet-stream';
        }

        function appendStatus(text){
          const div = document.createElement('div');
          div.textContent = text;
          uploadStatus.appendChild(div);
          return div;
        }

        async function signAndUpload(file){
          const et = entityType.value;
          const id = entityId.value.trim();
          if (!et || !id) { showError('請先選擇實體與 ID'); return false; }
          const name = file.name;
          const size = file.size;
          const type = inferContentType(name, file.type);
          // 先向伺服器索取上傳簽名
          let signRes;
          try {
            signRes = await fetch(`${apiBase}/attachments/upload-sign`, {
              method:'POST', credentials:'include', headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({ entity_type: et, entity_id: id, filename: name, content_type: type, content_length: size })
            });
          } catch (_) {
            showError('無法建立上傳簽名');
            return false;
          }
          const signJson = await signRes.json().catch(()=>null);
          if (!signRes.ok || !signJson || signJson.ok !== true) {
            showError(signJson?.message || '建立上傳簽名失敗');
            return false;
          }
          const uploadUrl = signJson.data?.uploadUrl;
          const headers = signJson.data?.headers || {};
          if (!uploadUrl) { showError('簽名 URL 無效'); return false; }
          // 直傳
          try {
            const putRes = await fetch(uploadUrl, { method:'PUT', headers:{ 'Content-Type': headers['Content-Type'] || type }, body: file });
            if (!putRes.ok) {
              const t = await putRes.text();
              showError(t || '上傳失敗');
              return false;
            }
          } catch (err) {
            showError('上傳發生錯誤');
            return false;
          }
          return true;
        }

        async function uploadSelectedFiles(){
          const files = fileInput.files;
          if (!files || !files.length) { showError('請選擇要上傳的檔案'); return; }
          btnUpload.disabled = true;
          fileInput.disabled = true;
          uploadStatus.innerHTML = '';
          let success = 0;
          for (const f of files) {
            if (!validateFileName(f.name)) { appendStatus(`${f.name}：檔名包含非法字元`); continue; }
            if (!validateFileType(f)) { appendStatus(`${f.name}：不支援的檔案類型`); continue; }
            if (!validateFileSize(f)) { appendStatus(`${f.name}：檔案大小超過限制（最大 10MB）`); continue; }
            const row = appendStatus(`${f.name}：上傳中…`);
            const ok = await signAndUpload(f);
            if (ok) { row.textContent = `${f.name}：已上傳`; success++; } else { row.textContent = `${f.name}：上傳失敗`; }
          }
          // 清空 input，並刷新列表
          try { fileInput.value = ''; } catch (_) {}
          await refreshList();
          enableUploaderIfReady();
          if (success > 0) {
            // 可加入 toast；先使用 alert 提示
            // alert(`${success} 個檔案已上傳`);
          }
        }

        async function ensureSession(){
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/attachments'); return false; }
            const json = await res.json();
            me = (json && json.ok && json.data) ? json.data : null;
            // 此模組預設：員工與管理員皆可上傳；若之後有更細權限，可在此控制
            permBar.style.display = 'none';
            return true;
          } catch (_) {
            permBar.textContent = '載入使用者資訊失敗';
            permBar.style.display = 'block';
            return false;
          } finally {
            enableUploaderIfReady();
          }
        }

        function mapTypeLabel(name, contentType){
          const n = (name||'').toLowerCase();
          const ct = (contentType||'').toLowerCase();
          if (n.endsWith('.pdf') || ct === 'application/pdf') return 'PDF';
          if (ct.startsWith('image/') || n.endsWith('.jpg') || n.endsWith('.jpeg') || n.endsWith('.png')) return '圖片';
          if (n.endsWith('.xls') || n.endsWith('.xlsx') || ct.includes('spreadsheet') || ct.includes('ms-excel')) return 'Excel';
          if (n.endsWith('.doc') || n.endsWith('.docx') || ct.includes('msword')) return 'Word';
          return '其他';
        }

        function fmtSize(bytes){
          const n = Number(bytes||0);
          if (n < 1024) return `${n} B`;
          if (n < 1024*1024) return `${(n/1024).toFixed(1)} KB`;
          if (n < 1024*1024*1024) return `${(n/1024/1024).toFixed(1)} MB`;
          return `${(n/1024/1024/1024).toFixed(2)} GB`;
        }

        function getEntityLimit(type){
          switch(type){
            case 'client': return 20;
            case 'receipt': return 5;
            case 'sop': return 10;
            case 'task': return 10;
            default: return 20;
          }
        }

        async function refreshList(){
          const et = entityType.value;
          const id = entityId.value.trim();
          if (!et || !id){
            tbody.innerHTML = '<tr><td colspan="6" class="muted">請先選擇實體與 ID</td></tr>';
            enableUploaderIfReady();
            return;
          }
          const params = new URLSearchParams();
          params.set('entity_type', et);
          params.set('entity_id', id);
          if (q.value.trim()) params.set('q', q.value.trim());
          const ft = fileType.value;
          if (ft && ft !== 'all') params.set('file_type', ft);
          if (dateFrom.value) params.set('dateFrom', dateFrom.value);
          if (dateTo.value) params.set('dateTo', dateTo.value);
          try {
            tbody.innerHTML = '<tr><td colspan="6" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/attachments?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/attachments'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const rows = Array.isArray(json.data) ? json.data : [];
            tbody.innerHTML = '';
            if (!rows.length){
              tbody.innerHTML = '<tr><td colspan="6" class="muted">尚無附件</td></tr>';
            } else {
              rows.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${r.filename||''}</td>
                  <td class="number-cell">${fmtSize(r.sizeBytes)}</td>
                  <td>${mapTypeLabel(r.filename, r.contentType)}</td>
                  <td>${r.uploaderName||r.uploaderUserId||''}</td>
                  <td>${r.uploadedAt||''}</td>
                  <td>
                    <button type="button" class="btn" disabled>下載</button>
                    <button type="button" class="btn" disabled>刪除</button>
                  </td>
                `;
                tbody.appendChild(tr);
              });
            }
            // 上限提示與上傳控制
            const note = document.getElementById('uploadNote');
            const limit = getEntityLimit(et);
            const total = (json.meta && json.meta.total) || rows.length;
            const reached = total >= limit;
            if (reached){
              note.textContent = `已達到附件數量上限（最多 ${limit} 個）`;
              btnUpload.disabled = true;
              fileInput.disabled = true;
            } else {
              note.textContent = '選擇實體後可啟用上傳；達上限時將停用';
              enableUploaderIfReady();
            }
          } catch (_) {
            tbody.innerHTML = '<tr><td colspan="6" style="color:#c0392b;">載入失敗</td></tr>';
          }
        }

        btnRefresh.addEventListener('click', refreshList);
        entityType.addEventListener('change', enableUploaderIfReady);
        entityId.addEventListener('input', enableUploaderIfReady);
        let timer = null;
        q.addEventListener('input', ()=>{ clearTimeout(timer); timer = setTimeout(refreshList, 300); });
        fileType.addEventListener('change', refreshList);
        dateFrom.addEventListener('change', ()=>{ if (dateTo.value) refreshList(); });
        dateTo.addEventListener('change', ()=>{ if (dateFrom.value) refreshList(); });

        btnUpload.addEventListener('click', ()=>{ fileInput.click(); });
        fileInput.addEventListener('change', uploadSelectedFiles);

        // 預設日期區間：當月
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth()+1).padStart(2,'0');
        const d1 = `${y}-${m}-01`;
        const d2 = `${y}-${m}-${String(now.getDate()).padStart(2,'0')}`;
        dateFrom.value = d1; dateTo.value = d2;

        ensureSession();
        refreshList();
      })();
    </script>
  </body>
  </html>


