<!-- âš¡ ç·Šæ€¥åŠ è¼‰é åŠ è¼‰ç³»çµ±ï¼ˆå¿…é ˆåœ¨æ‰€æœ‰å…¶ä»–è…³æœ¬ä¹‹å‰ï¼‰ -->
<script src="/assets/js/data-cache.js"></script>
<script src="/assets/js/fetch-interceptor.js"></script>
<script>
// ç«‹å³å•Ÿå‹•é åŠ è¼‰ï¼ˆå¦‚æœå°šæœªå•Ÿå‹•ï¼‰
if (window.DataCache && !window.DataCache.getPreloadStatus().isPreloading) {
  const status = window.DataCache.getPreloadStatus();
  if (status.completed.length === 0) {
    console.log('[Navbar] ğŸš€ å•Ÿå‹•èƒŒæ™¯é åŠ è¼‰');
    window.DataCache.preloadAll({ adminMode: true });
  }
}
</script>

<header class="internal-navbar">
  <div class="internal-nav-container">
    <a class="internal-nav-brand" href="/internal/dashboard">
      <img src="/assets/images/logo-white.png" alt="HorgosCPA" />
    </a>
    <button class="internal-mobile-toggle" id="internalMobileToggle" aria-label="é–‹å•Ÿé¸å–®">
      <span></span><span></span><span></span>
    </button>
    <nav class="internal-nav-links" id="internalNavLinks" aria-label="ä¸»è¦å°è¦½">
      <a class="internal-nav-link" href="/internal/dashboard">å„€è¡¨æ¿</a>
      <a class="internal-nav-link" href="/internal/clients">å®¢æˆ¶</a>
      <a class="internal-nav-link" href="/internal/timesheets">å·¥æ™‚</a>
      <a class="internal-nav-link" href="/internal/leaves">å‡æœŸ</a>
      <a class="internal-nav-link" href="/internal/trips">å¤–å‡º</a>
      <a class="internal-nav-link" href="/internal/tasks">ä»»å‹™</a>
      <a class="internal-nav-link" href="/internal/task-overview">ä»»å‹™ç¸½è¦½</a>
      <a class="internal-nav-link" href="/internal/receipts">æ”¶æ“š</a>
      <a class="internal-nav-link" href="/internal/payroll">è–ªè³‡</a>
      <a class="internal-nav-link" href="/internal/costs">æˆæœ¬</a>
      <a class="internal-nav-link" href="/internal/knowledge">çŸ¥è­˜åº«</a>
      <a class="internal-nav-link" href="/internal/cms">CMS</a>
      <a class="internal-nav-link" href="/internal/reports">å ±è¡¨</a>
      <a class="internal-nav-link" href="/internal/settings">è¨­å®š</a>
    </nav>
    <div class="internal-nav-user">
      <span class="internal-user-name" id="internalUserName">â€”</span>
      <button class="internal-logout-btn" id="internalLogoutBtn">ç™»å‡º</button>
    </div>
  </div>
  
</header>

<script>
// ä½¿ç”¨ setTimeout ç¡®ä¿ DOM å®Œå…¨åŠ è½½åå†ç»‘å®šäº‹ä»¶
setTimeout(function() {
  'use strict';

  // è™•ç†ç§»å‹•ç«¯é¸å–®åˆ‡æ›
  const mobileToggle = document.getElementById('internalMobileToggle');
  const navLinks = document.getElementById('internalNavLinks');
  if (mobileToggle && navLinks) {
    mobileToggle.addEventListener('click', function() {
      navLinks.classList.toggle('active');
      mobileToggle.classList.toggle('active');
    });
  }

  // è™•ç†ç™»å‡º
  const logoutBtn = document.getElementById('internalLogoutBtn');
  console.log('[Navbar] ç™»å‡ºæŒ‰éˆ•:', logoutBtn);
  
  if (logoutBtn) {
    console.log('[Navbar] é–‹å§‹ç¶å®šç™»å‡ºäº‹ä»¶');
    
    logoutBtn.addEventListener('click', async function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('[Navbar] ç™»å‡ºæŒ‰éˆ•è¢«é»æ“Š');
      
      if (!confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        console.log('[Navbar] ç”¨æˆ¶å–æ¶ˆç™»å‡º');
        return;
      }

      logoutBtn.disabled = true;
      logoutBtn.textContent = 'ç™»å‡ºä¸­...';
      
      console.log('[Navbar] é–‹å§‹ç™»å‡ºæµç¨‹...');

      try {
        const apiUrl = '/internal/api/v1/auth/logout';
        console.log('[Navbar] å‘¼å« API:', apiUrl);
        
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });

        console.log('[Navbar] API å›æ‡‰ç‹€æ…‹:', res.status);
        
        const json = await res.json().catch(() => {
          console.error('[Navbar] ç„¡æ³•è§£æ JSON');
          return null;
        });
        
        console.log('[Navbar] API å›æ‡‰:', json);
        
        if (res.ok && json && json.ok === true) {
          // ç™»å‡ºæˆåŠŸï¼Œå°å‘ç™»å…¥é 
          console.log('[Navbar] ç™»å‡ºæˆåŠŸï¼Œå°å‘ç™»å…¥é ');
          window.location.href = '/login.html';
        } else {
          // ç™»å‡ºå¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
          console.error('[Navbar] ç™»å‡ºå¤±æ•—:', json);
          alert('ç™»å‡ºå¤±æ•—: ' + (json?.message || 'æœªçŸ¥éŒ¯èª¤'));
          logoutBtn.disabled = false;
          logoutBtn.textContent = 'ç™»å‡º';
        }
      } catch (err) {
        console.error('[Navbar] ç™»å‡ºéŒ¯èª¤:', err);
        alert('ç¶²è·¯æˆ–ä¼ºæœå™¨ç•°å¸¸: ' + err.message);
        logoutBtn.disabled = false;
        logoutBtn.textContent = 'ç™»å‡º';
      }
    });
    
    console.log('[Navbar] ç™»å‡ºäº‹ä»¶ç›£è½å™¨å·²è¨»å†Š');
  } else {
    console.error('[Navbar] æ‰¾ä¸åˆ°ç™»å‡ºæŒ‰éˆ•ï¼');
  }

  // é«˜äº®ç•¶å‰é é¢çš„å°èˆªé€£çµ
  const currentPath = window.location.pathname;
  const navLinksElements = document.querySelectorAll('.internal-nav-link');
  navLinksElements.forEach(link => {
    const linkPath = new URL(link.href).pathname;
    if (currentPath === linkPath || (linkPath !== '/internal/dashboard' && currentPath.startsWith(linkPath))) {
      link.classList.add('active');
    }
  });
}, 0);
</script>


