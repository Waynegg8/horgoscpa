<!-- âš¡ ç·Šæ€¥åŠ è¼‰é åŠ è¼‰ç³»çµ±ï¼ˆå¿…é ˆåœ¨æ‰€æœ‰å…¶ä»–è…³æœ¬ä¹‹å‰ï¼‰ -->
<script src="/assets/js/data-cache.js"></script>
<script src="/assets/js/fetch-interceptor.js"></script>
<script>
// ç«‹å³å•Ÿå‹•é åŠ è¼‰ï¼ˆå¦‚æœå°šæœªå•Ÿå‹•ï¼‰
if (window.DataCache && !window.DataCache.getPreloadStatus().isPreloading) {
  const status = window.DataCache.getPreloadStatus();
  if (status.completed.length === 0) {
    console.log('[Navbar] ğŸš€ å•Ÿå‹•èƒŒæ™¯é åŠ è¼‰');
    window.DataCache.preloadAll({ adminMode: true });
  }
}
</script>

<header class="internal-navbar">
  <div class="internal-nav-container">
    <a class="internal-nav-brand" href="/internal/dashboard">
      <img src="/assets/images/logo-white.png" alt="HorgosCPA" />
    </a>
    <button class="internal-mobile-toggle" id="internalMobileToggle" aria-label="é–‹å•Ÿé¸å–®">
      <span></span><span></span><span></span>
    </button>
    <nav class="internal-nav-links" id="internalNavLinks" aria-label="ä¸»è¦å°è¦½">
      <a class="internal-nav-link" href="/internal/dashboard">å„€è¡¨æ¿</a>
      <a class="internal-nav-link" href="/internal/clients">å®¢æˆ¶</a>
      <a class="internal-nav-link" href="/internal/timesheets">å·¥æ™‚</a>
      <a class="internal-nav-link" href="/internal/leaves">å‡æœŸ</a>
      <a class="internal-nav-link" href="/internal/trips">å¤–å‡º</a>
      <a class="internal-nav-link" href="/internal/tasks">ä»»å‹™</a>
      <a class="internal-nav-link" href="/internal/task-overview">ä»»å‹™ç¸½è¦½</a>
      <a class="internal-nav-link" href="/internal/receipts">æ”¶æ“š</a>
      <a class="internal-nav-link" href="/internal/payroll">è–ªè³‡</a>
      <a class="internal-nav-link" href="/internal/costs">æˆæœ¬</a>
      <a class="internal-nav-link" href="/internal/knowledge">çŸ¥è­˜åº«</a>
      <a class="internal-nav-link" href="/internal/cms">CMS</a>
      <a class="internal-nav-link" href="/internal/reports">å ±è¡¨</a>
      <a class="internal-nav-link" href="/internal/settings">è¨­å®š</a>
    </nav>
    <div class="internal-nav-user">
      <span class="internal-user-name" id="internalUserName">â€”</span>
      <button class="internal-logout-btn" id="internalLogoutBtn">ç™»å‡º</button>
    </div>
  </div>
  
</header>

<script>
(function() {
  'use strict';

  // è™•ç†ç§»å‹•ç«¯é¸å–®åˆ‡æ›
  const mobileToggle = document.getElementById('internalMobileToggle');
  const navLinks = document.getElementById('internalNavLinks');
  if (mobileToggle && navLinks) {
    mobileToggle.addEventListener('click', function() {
      navLinks.classList.toggle('active');
      mobileToggle.classList.toggle('active');
    });
  }

  // è™•ç†ç™»å‡º
  const logoutBtn = document.getElementById('internalLogoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async function() {
      if (!confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        return;
      }

      logoutBtn.disabled = true;
      logoutBtn.textContent = 'ç™»å‡ºä¸­...';

      try {
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';
        
        const res = await fetch(apiBase + '/auth/logout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });

        const json = await res.json().catch(() => null);
        
        if (res.ok && json && json.ok === true) {
          // ç™»å‡ºæˆåŠŸï¼Œå°å‘ç™»å…¥é 
          location.assign('/login');
        } else {
          // ç™»å‡ºå¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
          alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          logoutBtn.disabled = false;
          logoutBtn.textContent = 'ç™»å‡º';
        }
      } catch (err) {
        console.error('ç™»å‡ºéŒ¯èª¤:', err);
        alert('ç¶²è·¯æˆ–ä¼ºæœå™¨ç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦');
        logoutBtn.disabled = false;
        logoutBtn.textContent = 'ç™»å‡º';
      }
    });
  }

  // é«˜äº®ç•¶å‰é é¢çš„å°èˆªé€£çµ
  const currentPath = window.location.pathname;
  const navLinksElements = document.querySelectorAll('.internal-nav-link');
  navLinksElements.forEach(link => {
    const linkPath = new URL(link.href).pathname;
    if (currentPath === linkPath || (linkPath !== '/internal/dashboard' && currentPath.startsWith(linkPath))) {
      link.classList.add('active');
    }
  });
})();
</script>


