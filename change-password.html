<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改密碼 - 霍爾果斯會計師事務所</title>
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/images/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="assets/css/common.css">
    <link rel="stylesheet" href="assets/css/navbar.css">
    <link rel="stylesheet" href="assets/css/mobile-navbar.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <style>
        :root {
            --primary-color: #2c5f7c;
            --primary-hover: #1e4258;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --light-bg: #f5f5f5;
            --border-color: #ddd;
        }

        body {
            background-color: var(--light-bg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        main {
            flex: 1;
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
            width: 100%;
        }

        .password-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .password-card h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 24px;
        }

        .password-card .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group .required {
            color: var(--danger-color);
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(44, 95, 124, 0.1);
        }

        .password-requirements {
            background: #f9f9f9;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin: 20px 0;
            font-size: 13px;
            line-height: 1.8;
        }

        .password-requirements h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: var(--primary-color);
        }

        .password-requirements ul {
            margin: 0;
            padding-left: 20px;
        }

        .password-requirements li {
            margin: 5px 0;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background: var(--light-bg);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }

        @media (max-width: 768px) {
            main {
                margin: 20px auto;
                padding: 10px;
            }

            .password-card {
                padding: 20px;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- 導航欄 -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <img src="assets/images/logo-white.png" alt="霍爾果斯會計師事務所">
            </a>
            <div class="nav-menu" id="navMenu">
                <a href="index.html" class="nav-item">首頁</a>
                <a href="timesheet.html" class="nav-item">工時表</a>
                <a href="reports.html" class="nav-item">報表</a>
                <a href="settings.html" class="nav-item">設定</a>
                <div class="nav-user-info" id="navUserInfo" style="display: none;">
                    <span class="user-name" id="navUserName"></span>
                    <button class="btn-logout" id="navLogout">登出</button>
                </div>
            </div>
            <div class="mobile-menu-toggle" id="mobileMenuToggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <main>
        <div class="password-card">
            <h1>修改密碼</h1>
            <p class="subtitle">為了您的帳號安全，請定期更換密碼</p>

            <div id="alertBox" class="alert"></div>

            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="currentPassword">
                        目前密碼 <span class="required">*</span>
                    </label>
                    <input 
                        type="password" 
                        id="currentPassword" 
                        name="currentPassword" 
                        required
                        autocomplete="current-password"
                    >
                </div>

                <div class="form-group">
                    <label for="newPassword">
                        新密碼 <span class="required">*</span>
                    </label>
                    <input 
                        type="password" 
                        id="newPassword" 
                        name="newPassword" 
                        required
                        autocomplete="new-password"
                        minlength="6"
                    >
                </div>

                <div class="form-group">
                    <label for="confirmPassword">
                        確認新密碼 <span class="required">*</span>
                    </label>
                    <input 
                        type="password" 
                        id="confirmPassword" 
                        name="confirmPassword" 
                        required
                        autocomplete="new-password"
                        minlength="6"
                    >
                </div>

                <div class="password-requirements">
                    <h3>密碼要求：</h3>
                    <ul>
                        <li>至少 6 個字元</li>
                        <li>建議包含大小寫字母、數字和特殊符號</li>
                        <li>不要使用過於簡單的密碼（如 123456、password 等）</li>
                    </ul>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="history.back()">
                        取消
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        更新密碼
                    </button>
                </div>
            </form>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2024 霍爾果斯會計師事務所 版權所有</p>
        </div>
    </footer>

    <script src="assets/js/mobile-navbar.js"></script>
    <script>
        const API_BASE = 'https://timesheet-api.hergscpa.workers.dev';

        // 檢查登入狀態
        async function checkAuth() {
            const token = localStorage.getItem('session_token');
            if (!token) {
                window.location.href = 'login.html';
                return null;
            }

            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('session_token');
                        window.location.href = 'login.html';
                        return null;
                    }
                    throw new Error('驗證失敗');
                }

                return await response.json();
            } catch (error) {
                console.error('驗證錯誤:', error);
                showAlert('驗證失敗，請重新登入', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return null;
            }
        }

        // 更新導航欄用戶資訊
        function updateUserInfo(user) {
            const userInfoDiv = document.getElementById('navUserInfo');
            const userNameSpan = document.getElementById('navUserName');
            
            if (user) {
                userNameSpan.textContent = user.username;
                userInfoDiv.style.display = 'flex';
            }
        }

        // 登出功能
        document.getElementById('navLogout')?.addEventListener('click', async () => {
            const token = localStorage.getItem('session_token');
            if (token) {
                try {
                    await fetch(`${API_BASE}/api/auth/logout`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                } catch (error) {
                    console.error('登出錯誤:', error);
                }
            }
            localStorage.removeItem('session_token');
            window.location.href = 'login.html';
        });

        // 顯示提示訊息
        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.style.display = 'block';
            
            // 3秒後自動隱藏（成功訊息）
            if (type === 'success') {
                setTimeout(() => {
                    alertBox.style.display = 'none';
                }, 3000);
            }
        }

        // 修改密碼表單提交
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitBtn = document.getElementById('submitBtn');

            // 前端驗證
            if (newPassword !== confirmPassword) {
                showAlert('新密碼與確認密碼不一致', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showAlert('新密碼至少需要 6 個字元', 'error');
                return;
            }

            if (currentPassword === newPassword) {
                showAlert('新密碼不能與目前密碼相同', 'error');
                return;
            }

            // 禁用按鈕，防止重複提交
            submitBtn.disabled = true;
            submitBtn.textContent = '處理中...';

            try {
                const token = localStorage.getItem('session_token');
                const response = await fetch(`${API_BASE}/api/auth/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('密碼修改成功！即將返回...', 'success');
                    // 清空表單
                    document.getElementById('changePasswordForm').reset();
                    // 2秒後返回上一頁
                    setTimeout(() => {
                        history.back();
                    }, 2000);
                } else {
                    showAlert(data.error || '密碼修改失敗', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = '更新密碼';
                }
            } catch (error) {
                console.error('修改密碼錯誤:', error);
                showAlert('系統錯誤，請稍後再試', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = '更新密碼';
            }
        });

        // 頁面載入時檢查驗證
        window.addEventListener('DOMContentLoaded', async () => {
            const user = await checkAuth();
            if (user) {
                updateUserInfo(user);
            }
        });
    </script>
</body>
</html>

