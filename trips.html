<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="å¤–å‡ºç™»è¨˜ï½œäº¤é€šè£œè²¼ç®¡ç†" />
    <title>å¤–å‡ºç™»è¨˜ï½œäº¤é€šè£œè²¼ç®¡ç†</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/internal-components.css" />
    <link rel="stylesheet" href="/assets/css/trips-page.css" />
  </head>
  <body>
    <div id="internal-navbar"></div>

    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 32px 20px;">
      <!-- é é¢æ¨™é¡Œ -->
      <div class="trips-header">
        <h1>å¤–å‡ºç™»è¨˜</h1>
        <div class="trips-controls">
          <input 
            type="month" 
            id="monthFilter" 
            class="form-control" 
            style="width: 160px;"
          />
          <button class="btn btn-primary" id="btnNewTrip">
            <svg width="16" height="16" fill="currentColor" style="vertical-align: middle; margin-right: 4px;">
              <path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            æ–°å¢å¤–å‡º
          </button>
        </div>
      </div>

      <!-- çµ±è¨ˆæ‘˜è¦ -->
      <div class="trips-summary-bar" id="summaryBar" style="display: none;">
        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-label">æœ¬æœˆå¤–å‡ºæ¬¡æ•¸</div>
            <div class="summary-value" id="summaryTripCount">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">ç¸½è·é›¢</div>
            <div class="summary-value">
              <span id="summaryTotalDistance">0</span>
              <span class="summary-unit">å…¬é‡Œ</span>
            </div>
          </div>
          <div class="summary-item">
            <div class="summary-label">äº¤é€šè£œè²¼ç¸½é¡</div>
            <div class="summary-value">
              NT$ <span id="summaryTotalSubsidy">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ç¯©é¸å™¨ -->
      <div class="trips-filters">
        <div class="filter-row">
          <div class="filter-field" id="userFilterField" style="display: none;">
            <label>å“¡å·¥</label>
            <select id="userFilter">
              <option value="">å…¨éƒ¨å“¡å·¥</option>
            </select>
          </div>
          <div class="filter-field">
            <label>å®¢æˆ¶</label>
            <select id="clientFilter">
              <option value="">å…¨éƒ¨å®¢æˆ¶</option>
            </select>
          </div>
          <div class="filter-field" style="display: flex; align-items: flex-end;">
            <button class="btn btn-secondary" id="btnResetFilters">é‡ç½®ç¯©é¸</button>
          </div>
        </div>
      </div>

      <!-- å¤–å‡ºç™»è¨˜åˆ—è¡¨ -->
      <div class="trips-table-wrapper">
        <table class="trips-table">
          <thead>
            <tr>
              <th>æ—¥æœŸ</th>
              <th>å“¡å·¥</th>
              <th>å®¢æˆ¶</th>
              <th>ç›®çš„åœ°</th>
              <th>è·é›¢</th>
              <th>äº¤é€šè£œè²¼</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tripsTableBody">
            <tr>
              <td colspan="7" class="loading">
                <div class="spinner"></div>
              </td>
            </tr>
          </tbody>
        </table>
        
        <!-- åˆ†é  -->
        <div class="pagination" id="pagination" style="display: none;">
          <button id="btnPrevPage" disabled>ä¸Šä¸€é </button>
          <div class="page-info">
            ç¬¬ <span id="currentPage">1</span> / <span id="totalPages">1</span> é 
          </div>
          <button id="btnNextPage" disabled>ä¸‹ä¸€é </button>
        </div>
      </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯å¤–å‡ºç™»è¨˜æ¨¡æ…‹æ¡† -->
    <div class="modal" id="tripModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">æ–°å¢å¤–å‡ºç™»è¨˜</h2>
        </div>
        <form id="tripForm">
          <div class="modal-body">
            <div class="form-grid">
              <div class="form-field">
                <label>å¤–å‡ºæ—¥æœŸ <span class="required">*</span></label>
                <input type="date" id="tripDate" required />
              </div>

              <div class="form-field">
                <label>ç›®çš„åœ° <span class="required">*</span></label>
                <input type="text" id="destination" placeholder="ä¾‹ï¼šè‡ºåŒ—å¸‚ä¿¡ç¾©å€" required />
              </div>

              <div class="form-field">
                <label>è·é›¢ï¼ˆå…¬é‡Œï¼‰ <span class="required">*</span></label>
                <input type="number" id="distanceKm" placeholder="ä¾‹ï¼š10" step="0.1" min="0.1" required />
                <div class="hint">æ¯5å…¬é‡Œè£œè²¼60å…ƒ</div>
              </div>

              <!-- äº¤é€šè£œè²¼é è¦½ -->
              <div class="subsidy-preview" id="subsidyPreview" style="display: none;">
                <div class="subsidy-preview-label">é è¨ˆäº¤é€šè£œè²¼</div>
                <div class="subsidy-preview-amount">NT$ <span id="subsidyAmount">0</span></div>
              </div>

              <div class="form-field">
                <label>å®¢æˆ¶</label>
                <select id="clientId">
                  <option value="">ç„¡é—œè¯å®¢æˆ¶</option>
                </select>
              </div>

              <div class="form-field">
                <label>å¤–å‡ºç›®çš„</label>
                <textarea id="purpose" placeholder="ä¾‹ï¼šæ‹œè¨ªå®¢æˆ¶ã€é€ä»¶ã€ç¨½æ ¸ç­‰"></textarea>
              </div>

              <div class="form-field">
                <label>å‚™è¨»</label>
                <textarea id="notes" placeholder="å…¶ä»–èªªæ˜"></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="btnCancelTrip">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-primary" id="btnSaveTrip">å„²å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <div id="internal-footer"></div>

    <script>
      (function() {
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        // DOM å…ƒç´ 
        const monthFilter = document.getElementById('monthFilter');
        const clientFilter = document.getElementById('clientFilter');
        const userFilter = document.getElementById('userFilter');
        const userFilterField = document.getElementById('userFilterField');
        const btnNewTrip = document.getElementById('btnNewTrip');
        const btnResetFilters = document.getElementById('btnResetFilters');
        const tripsTableBody = document.getElementById('tripsTableBody');
        const pagination = document.getElementById('pagination');
        const btnPrevPage = document.getElementById('btnPrevPage');
        const btnNextPage = document.getElementById('btnNextPage');
        const currentPageSpan = document.getElementById('currentPage');
        const totalPagesSpan = document.getElementById('totalPages');

        // çµ±è¨ˆæ‘˜è¦
        const summaryBar = document.getElementById('summaryBar');
        const summaryTripCount = document.getElementById('summaryTripCount');
        const summaryTotalDistance = document.getElementById('summaryTotalDistance');
        const summaryTotalSubsidy = document.getElementById('summaryTotalSubsidy');

        // æ¨¡æ…‹æ¡†
        const tripModal = document.getElementById('tripModal');
        const modalTitle = document.getElementById('modalTitle');
        const tripForm = document.getElementById('tripForm');
        const btnCancelTrip = document.getElementById('btnCancelTrip');
        const tripDateInput = document.getElementById('tripDate');
        const destinationInput = document.getElementById('destination');
        const distanceKmInput = document.getElementById('distanceKm');
        const clientIdInput = document.getElementById('clientId');
        const purposeInput = document.getElementById('purpose');
        const notesInput = document.getElementById('notes');
        const subsidyPreview = document.getElementById('subsidyPreview');
        const subsidyAmount = document.getElementById('subsidyAmount');

        // ç‹€æ…‹
        let currentUser = null;
        let allTrips = [];
        let filteredTrips = [];
        let currentPage = 1;
        let perPage = 20;
        let editingTripId = null;

        // åˆå§‹åŒ–
        async function init() {
          try {
            // ç²å–ç•¶å‰ç”¨æˆ¶
            const userRes = await fetch(`${apiBase}/auth/me`, { credentials: 'include' });
            if (userRes.status === 401) {
              location.assign('/login?redirect=/internal/trips');
              return;
            }
            const userData = await userRes.json();
            currentUser = userData.data;

            // è¨­å®š navbar ç”¨æˆ¶åç¨±
            const userNameEl = document.getElementById('internalUserName');
            if (userNameEl && currentUser) {
              userNameEl.textContent = currentUser.name || currentUser.username || 'ç”¨æˆ¶';
            }

            // é¡¯ç¤ºç”¨æˆ¶ç¯©é¸å™¨ï¼ˆåƒ…ç®¡ç†å“¡ï¼‰
            if (currentUser.is_admin) {
              userFilterField.style.display = 'block';
              await loadUsers();
            }

            // è¨­å®šç•¶å‰æœˆä»½
            const today = new Date();
            monthFilter.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

            // è¼‰å…¥å®¢æˆ¶åˆ—è¡¨
            await loadClients();

            // è¼‰å…¥å¤–å‡ºç™»è¨˜
            await loadTrips();
            await loadSummary();

            // ç¶å®šäº‹ä»¶
            bindEvents();
          } catch (err) {
            console.error('åˆå§‹åŒ–å¤±æ•—:', err);
            showError('è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
          }
        }

        // è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨ï¼ˆç®¡ç†å“¡ï¼‰
        async function loadUsers() {
          try {
            const res = await fetch(`${apiBase}/users`, { credentials: 'include' });
            if (!res.ok) return;
            const json = await res.json();
            const users = json.data || [];
            
            userFilter.innerHTML = '<option value="">å…¨éƒ¨å“¡å·¥</option>';
            users.forEach(user => {
              const option = document.createElement('option');
              option.value = user.user_id;
              option.textContent = user.name || user.username;
              userFilter.appendChild(option);
            });
          } catch (err) {
            console.error('è¼‰å…¥ç”¨æˆ¶å¤±æ•—:', err);
          }
        }

        // è¼‰å…¥å®¢æˆ¶åˆ—è¡¨
        async function loadClients() {
          try {
            const res = await fetch(`${apiBase}/clients?per_page=1000`, { credentials: 'include' });
            if (!res.ok) return;
            const json = await res.json();
            const clients = json.data || [];
            
            const options = clients.map(c => 
              `<option value="${c.clientId}">${c.companyName || 'æœªå‘½åå®¢æˆ¶'}</option>`
            ).join('');
            
            clientFilter.innerHTML = '<option value="">å…¨éƒ¨å®¢æˆ¶</option>' + options;
            clientIdInput.innerHTML = '<option value="">ç„¡é—œè¯å®¢æˆ¶</option>' + options;
          } catch (err) {
            console.error('è¼‰å…¥å®¢æˆ¶å¤±æ•—:', err);
          }
        }

        // è¼‰å…¥å¤–å‡ºç™»è¨˜åˆ—è¡¨
        async function loadTrips() {
          try {
            const params = new URLSearchParams();
            
            if (monthFilter.value) {
              params.set('month', monthFilter.value);
            }
            if (clientFilter.value) {
              params.set('client_id', clientFilter.value);
            }
            if (currentUser.is_admin && userFilter.value) {
              params.set('user_id', userFilter.value);
            }

            const res = await fetch(`${apiBase}/trips?${params.toString()}`, { 
              credentials: 'include' 
            });

            if (res.status === 401) {
              location.assign('/login?redirect=/internal/trips');
              return;
            }

            const json = await res.json();
            allTrips = json.data || [];
            filteredTrips = allTrips;
            currentPage = 1;
            
            renderTripsTable();
          } catch (err) {
            console.error('è¼‰å…¥å¤–å‡ºç™»è¨˜å¤±æ•—:', err);
            showError('è¼‰å…¥å¤–å‡ºç™»è¨˜å¤±æ•—');
          }
        }

        // è¼‰å…¥çµ±è¨ˆæ‘˜è¦
        async function loadSummary() {
          if (!monthFilter.value) return;

          try {
            const params = new URLSearchParams();
            params.set('month', monthFilter.value);
            
            if (currentUser.is_admin && userFilter.value) {
              params.set('user_id', userFilter.value);
            }

            const res = await fetch(`${apiBase}/trips/summary?${params.toString()}`, { 
              credentials: 'include' 
            });

            if (!res.ok) return;

            const json = await res.json();
            const data = json.data;

            summaryTripCount.textContent = data.trip_count || 0;
            summaryTotalDistance.textContent = (data.total_distance_km || 0).toFixed(1);
            summaryTotalSubsidy.textContent = (data.total_subsidy_twd || 0).toLocaleString();
            
            summaryBar.style.display = 'block';
          } catch (err) {
            console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', err);
          }
        }

        // æ¸²æŸ“å¤–å‡ºç™»è¨˜è¡¨æ ¼
        function renderTripsTable() {
          const start = (currentPage - 1) * perPage;
          const end = start + perPage;
          const pageTrips = filteredTrips.slice(start, end);

          if (pageTrips.length === 0) {
            tripsTableBody.innerHTML = `
              <tr>
                <td colspan="7" class="empty-state">
                  <p>å°šç„¡å¤–å‡ºç™»è¨˜è¨˜éŒ„</p>
                </td>
              </tr>
            `;
            pagination.style.display = 'none';
            return;
          }

          tripsTableBody.innerHTML = pageTrips.map(trip => {
            const canEdit = trip.user_id === currentUser.user_id || currentUser.is_admin;

            return `
              <tr>
                <td>${trip.trip_date}</td>
                <td>${trip.user_name || '-'}</td>
                <td>${trip.client_name || 'ç„¡'}</td>
                <td>
                  <div style="font-weight: 500;">${trip.destination}</div>
                  ${trip.purpose ? `<div style="font-size: 12px; color: rgba(15,23,42,0.5); margin-top: 2px;">${trip.purpose}</div>` : ''}
                </td>
                <td><span class="distance-badge">${trip.distance_km} km</span></td>
                <td><span class="subsidy-amount">NT$ ${trip.transport_subsidy_twd.toLocaleString()}</span></td>
                <td>
                  <div class="trip-actions">
                    ${canEdit ? `
                      <button class="btn-icon btn-edit" onclick="editTrip(${trip.trip_id})" title="ç·¨è¼¯">
                        âœï¸
                      </button>
                      <button class="btn-icon btn-delete" onclick="deleteTrip(${trip.trip_id})" title="åˆªé™¤">
                        ğŸ—‘ï¸
                      </button>
                    ` : ''}
                  </div>
                </td>
              </tr>
            `;
          }).join('');

          // æ›´æ–°åˆ†é 
          const totalPages = Math.ceil(filteredTrips.length / perPage);
          currentPageSpan.textContent = currentPage;
          totalPagesSpan.textContent = totalPages;
          btnPrevPage.disabled = currentPage === 1;
          btnNextPage.disabled = currentPage === totalPages || totalPages === 0;
          pagination.style.display = totalPages > 1 ? 'flex' : 'none';
        }

        // è¨ˆç®—äº¤é€šè£œè²¼
        function calculateSubsidy(distanceKm) {
          if (!distanceKm || distanceKm <= 0) return 0;
          return Math.floor(distanceKm / 5) * 60;
        }

        // ç¶å®šäº‹ä»¶
        function bindEvents() {
          // ç¯©é¸å™¨
          monthFilter.addEventListener('change', () => {
            loadTrips();
            loadSummary();
          });
          clientFilter.addEventListener('change', loadTrips);
          userFilter.addEventListener('change', () => {
            loadTrips();
            loadSummary();
          });
          btnResetFilters.addEventListener('click', () => {
            clientFilter.value = '';
            if (currentUser.is_admin) {
              userFilter.value = '';
            }
            loadTrips();
            loadSummary();
          });

          // åˆ†é 
          btnPrevPage.addEventListener('click', () => {
            if (currentPage > 1) {
              currentPage--;
              renderTripsTable();
            }
          });
          btnNextPage.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredTrips.length / perPage);
            if (currentPage < totalPages) {
              currentPage++;
              renderTripsTable();
            }
          });

          // æ–°å¢å¤–å‡º
          btnNewTrip.addEventListener('click', openNewTripModal);
          btnCancelTrip.addEventListener('click', closeTripModal);
          
          // é—œé–‰æ¨¡æ…‹æ¡†ï¼ˆé»æ“ŠèƒŒæ™¯ï¼‰
          tripModal.addEventListener('click', (e) => {
            if (e.target === tripModal) closeTripModal();
          });

          // è¡¨å–®æäº¤
          tripForm.addEventListener('submit', handleTripSubmit);

          // è·é›¢è¼¸å…¥è®ŠåŒ–æ™‚æ›´æ–°è£œè²¼é è¦½
          distanceKmInput.addEventListener('input', updateSubsidyPreview);
        }

        // æ›´æ–°è£œè²¼é è¦½
        function updateSubsidyPreview() {
          const distance = parseFloat(distanceKmInput.value);
          if (distance > 0) {
            const subsidy = calculateSubsidy(distance);
            subsidyAmount.textContent = subsidy.toLocaleString();
            subsidyPreview.style.display = 'block';
          } else {
            subsidyPreview.style.display = 'none';
          }
        }

        // é–‹å•Ÿæ–°å¢æ¨¡æ…‹æ¡†
        function openNewTripModal() {
          editingTripId = null;
          modalTitle.textContent = 'æ–°å¢å¤–å‡ºç™»è¨˜';
          tripForm.reset();
          
          // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
          const today = new Date().toISOString().split('T')[0];
          tripDateInput.value = today;
          
          subsidyPreview.style.display = 'none';
          tripModal.classList.add('show');
        }

        // ç·¨è¼¯å¤–å‡ºç™»è¨˜
        window.editTrip = function(tripId) {
          const trip = allTrips.find(t => t.trip_id === tripId);
          if (!trip) return;

          editingTripId = tripId;
          modalTitle.textContent = 'ç·¨è¼¯å¤–å‡ºç™»è¨˜';
          
          tripDateInput.value = trip.trip_date;
          destinationInput.value = trip.destination;
          distanceKmInput.value = trip.distance_km;
          clientIdInput.value = trip.client_id || '';
          purposeInput.value = trip.purpose || '';
          notesInput.value = trip.notes || '';
          
          updateSubsidyPreview();
          tripModal.classList.add('show');
        };

        // é—œé–‰æ¨¡æ…‹æ¡†
        function closeTripModal() {
          tripModal.classList.remove('show');
          tripForm.reset();
          editingTripId = null;
        }

        // è™•ç†è¡¨å–®æäº¤
        async function handleTripSubmit(e) {
          e.preventDefault();

          const data = {
            trip_date: tripDateInput.value,
            destination: destinationInput.value,
            distance_km: parseFloat(distanceKmInput.value),
            client_id: clientIdInput.value ? parseInt(clientIdInput.value) : null,
            purpose: purposeInput.value || null,
            notes: notesInput.value || null
          };

          try {
            const url = editingTripId 
              ? `${apiBase}/trips/${editingTripId}` 
              : `${apiBase}/trips`;
            const method = editingTripId ? 'PATCH' : 'POST';

            const res = await fetch(url, {
              method,
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(data)
            });

            const json = await res.json();

            if (!res.ok) {
              showError(json.message || 'æ“ä½œå¤±æ•—');
              return;
            }

            showSuccess(editingTripId ? 'å¤–å‡ºç™»è¨˜å·²æ›´æ–°' : 'å¤–å‡ºç™»è¨˜å·²æ–°å¢');
            closeTripModal();
            await loadTrips();
            await loadSummary();
          } catch (err) {
            console.error('æäº¤å¤±æ•—:', err);
            showError('æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
        }

        // åˆªé™¤å¤–å‡ºç™»è¨˜
        window.deleteTrip = async function(tripId) {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å¤–å‡ºç™»è¨˜å—ï¼Ÿ')) return;

          try {
            const res = await fetch(`${apiBase}/trips/${tripId}`, {
              method: 'DELETE',
              credentials: 'include'
            });

            const json = await res.json();

            if (!res.ok) {
              showError(json.message || 'åˆªé™¤å¤±æ•—');
              return;
            }

            showSuccess('å¤–å‡ºç™»è¨˜å·²åˆªé™¤');
            await loadTrips();
            await loadSummary();
          } catch (err) {
            console.error('åˆªé™¤å¤±æ•—:', err);
            showError('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          }
        };

        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        function showSuccess(message) {
          alert(message); // å¯ä»¥æ”¹ç”¨æ›´å¥½çš„é€šçŸ¥çµ„ä»¶
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
          alert(message); // å¯ä»¥æ”¹ç”¨æ›´å¥½çš„é€šçŸ¥çµ„ä»¶
        }

        // è¼‰å…¥å°èˆªæ¬„å’Œé è…³
        async function loadNavbarFooter() {
          try {
            const [navbarRes, footerRes] = await Promise.all([
              fetch('/templates/partials/internal-navbar.html'),
              fetch('/templates/partials/internal-footer.html')
            ]);

            if (navbarRes.ok) {
              const navbarHtml = await navbarRes.text();
              const navbarContainer = document.getElementById('internal-navbar');
              navbarContainer.innerHTML = navbarHtml;
              
              // æ‰‹å‹•åŸ·è¡Œ navbar ä¸­çš„ script
              const scripts = navbarContainer.querySelectorAll('script');
              scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                if (oldScript.src) {
                  newScript.src = oldScript.src;
                } else {
                  newScript.textContent = oldScript.textContent;
                }
                oldScript.parentNode.replaceChild(newScript, oldScript);
              });
            }
            if (footerRes.ok) {
              document.getElementById('internal-footer').innerHTML = await footerRes.text();
            }
          } catch (err) {
            console.error('è¼‰å…¥å°èˆªæ¬„/é è…³å¤±æ•—:', err);
          }
        }

        // å•Ÿå‹•
        loadNavbarFooter().then(init);
      })();
    </script>
  </body>
</html>

