<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>工時表 API 全面測試</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { color: #333; margin-bottom: 20px; }
    .section { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h2 { color: #0066cc; margin-bottom: 15px; font-size: 18px; }
    button { background: #0066cc; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }
    button:hover { background: #0052a3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 13px; line-height: 1.5; }
    .success { color: #28a745; font-weight: bold; }
    .error { color: #dc3545; font-weight: bold; }
    .warning { color: #ffc107; font-weight: bold; }
    .info { color: #17a2b8; margin-bottom: 10px; }
    input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔍 工時表 API 全面測試</h1>
    <p class="info">請確保已登入 <a href="https://horgoscpa.com/login" target="_blank">horgoscpa.com/login</a></p>

    <!-- 1. 假期 API -->
    <div class="section">
      <h2>1️⃣ 假期 API (Holidays)</h2>
      <button onclick="testHolidaysAPI()">測試假期 API (10/27-11/2)</button>
      <pre id="holidaysResult">等待測試...</pre>
    </div>

    <!-- 2. 客戶列表 API -->
    <div class="section">
      <h2>2️⃣ 客戶列表 API (Clients)</h2>
      <button onclick="testClientsAPI()">測試客戶列表 API</button>
      <pre id="clientsResult">等待測試...</pre>
    </div>

    <!-- 3. 客戶服務 API -->
    <div class="section">
      <h2>3️⃣ 客戶服務 API (Client Services)</h2>
      <input type="text" id="clientIdForServices" value="c_002" placeholder="客戶 ID">
      <button onclick="testClientServicesAPI()">測試客戶服務 API</button>
      <pre id="clientServicesResult">等待測試...</pre>
    </div>

    <!-- 4. 服務子項目 API -->
    <div class="section">
      <h2>4️⃣ 服務子項目 API (Service Items)</h2>
      <input type="text" id="clientIdForItems" value="c_002" placeholder="客戶 ID">
      <input type="text" id="serviceIdForItems" value="1" placeholder="服務 ID">
      <button onclick="testServiceItemsAPI()">測試服務子項目 API</button>
      <pre id="serviceItemsResult">等待測試...</pre>
    </div>

    <!-- 5. 工時記錄 API -->
    <div class="section">
      <h2>5️⃣ 工時記錄 API (Timelogs)</h2>
      <button onclick="testTimelogsAPI()">測試工時記錄 API (10/27-11/2)</button>
      <pre id="timelogsResult">等待測試...</pre>
    </div>

    <!-- 6. 月統計 API -->
    <div class="section">
      <h2>6️⃣ 月統計 API (Monthly Summary)</h2>
      <input type="text" id="monthForSummary" value="2025-10" placeholder="月份 (YYYY-MM)">
      <button onclick="testMonthlySummaryAPI()">測試月統計 API</button>
      <pre id="monthlySummaryResult">等待測試...</pre>
    </div>

    <!-- 7. 請假記錄 API -->
    <div class="section">
      <h2>7️⃣ 請假記錄 API (Leaves)</h2>
      <button onclick="testLeavesAPI()">測試請假記錄 API (10/27-11/2)</button>
      <pre id="leavesResult">等待測試...</pre>
    </div>

    <!-- 全部測試 -->
    <div class="section">
      <h2>🚀 一鍵測試全部 API</h2>
      <button onclick="testAllAPIs()" style="background: #28a745;">執行全部測試</button>
      <pre id="allTestsResult">等待測試...</pre>
    </div>
  </div>

  <script>
    async function apiCall(url) {
      const response = await fetch(url, { credentials: 'include' });
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
      }
      return response.json();
    }

    function displayResult(elementId, data, testName) {
      const element = document.getElementById(elementId);
      const timestamp = new Date().toLocaleTimeString('zh-TW');
      
      if (data.error) {
        element.innerHTML = `<span class="error">❌ ${testName} 失敗</span> [${timestamp}]\n\n錯誤：${data.error}`;
      } else {
        const dataCount = Array.isArray(data.data) ? data.data.length : (data.data ? 1 : 0);
        element.innerHTML = `<span class="success">✅ ${testName} 成功</span> [${timestamp}]\n\n` +
          `數據筆數：${dataCount}\n\n` +
          `完整響應：\n${JSON.stringify(data, null, 2)}`;
      }
    }

    async function testHolidaysAPI() {
      try {
        const data = await apiCall('/internal/api/v1/holidays?start_date=2025-10-27&end_date=2025-11-02');
        displayResult('holidaysResult', data, '假期 API');
        
        // 特別檢查 10/10 國慶日
        const hasHolidayDate = data.data && data.data.some(h => h.holiday_date);
        if (!hasHolidayDate) {
          document.getElementById('holidaysResult').innerHTML += '\n\n<span class="warning">⚠️ 警告：返回的假期數據沒有 holiday_date 欄位！</span>';
        }
      } catch (error) {
        displayResult('holidaysResult', { error: error.message }, '假期 API');
      }
    }

    async function testClientsAPI() {
      try {
        const data = await apiCall('/internal/api/v1/clients?perPage=100');
        displayResult('clientsResult', data, '客戶列表 API');
      } catch (error) {
        displayResult('clientsResult', { error: error.message }, '客戶列表 API');
      }
    }

    async function testClientServicesAPI() {
      try {
        const clientId = document.getElementById('clientIdForServices').value;
        const data = await apiCall(`/internal/api/v1/clients/${clientId}/services`);
        displayResult('clientServicesResult', data, '客戶服務 API');
      } catch (error) {
        displayResult('clientServicesResult', { error: error.message }, '客戶服務 API');
      }
    }

    async function testServiceItemsAPI() {
      try {
        const clientId = document.getElementById('clientIdForItems').value;
        const serviceId = document.getElementById('serviceIdForItems').value;
        const data = await apiCall(`/internal/api/v1/clients/${clientId}/services/${serviceId}/items`);
        displayResult('serviceItemsResult', data, '服務子項目 API');
      } catch (error) {
        displayResult('serviceItemsResult', { error: error.message }, '服務子項目 API');
      }
    }

    async function testTimelogsAPI() {
      try {
        const data = await apiCall('/internal/api/v1/timelogs?start_date=2025-10-27&end_date=2025-11-02');
        displayResult('timelogsResult', data, '工時記錄 API');
      } catch (error) {
        displayResult('timelogsResult', { error: error.message }, '工時記錄 API');
      }
    }

    async function testMonthlySummaryAPI() {
      try {
        const month = document.getElementById('monthForSummary').value;
        const data = await apiCall(`/internal/api/v1/timelogs/summary?month=${month}`);
        displayResult('monthlySummaryResult', data, '月統計 API');
      } catch (error) {
        displayResult('monthlySummaryResult', { error: error.message }, '月統計 API');
      }
    }

    async function testLeavesAPI() {
      try {
        const data = await apiCall('/internal/api/v1/leaves?start_date=2025-10-27&end_date=2025-11-02');
        displayResult('leavesResult', data, '請假記錄 API');
      } catch (error) {
        displayResult('leavesResult', { error: error.message }, '請假記錄 API');
      }
    }

    async function testAllAPIs() {
      const result = document.getElementById('allTestsResult');
      result.innerHTML = '<span class="info">⏳ 正在執行所有測試...</span>';
      
      const tests = [
        { name: '假期 API', fn: testHolidaysAPI },
        { name: '客戶列表 API', fn: testClientsAPI },
        { name: '客戶服務 API', fn: testClientServicesAPI },
        { name: '服務子項目 API', fn: testServiceItemsAPI },
        { name: '工時記錄 API', fn: testTimelogsAPI },
        { name: '月統計 API', fn: testMonthlySummaryAPI },
        { name: '請假記錄 API', fn: testLeavesAPI }
      ];

      let summary = [];
      for (const test of tests) {
        try {
          await test.fn();
          summary.push(`✅ ${test.name} - 成功`);
        } catch (error) {
          summary.push(`❌ ${test.name} - 失敗: ${error.message}`);
        }
      }

      const timestamp = new Date().toLocaleTimeString('zh-TW');
      result.innerHTML = `<span class="success">🎉 全部測試完成！</span> [${timestamp}]\n\n` +
        `測試摘要：\n` + summary.join('\n');
    }
  </script>
</body>
</html>

