<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="報表分析中心" />
    <title>報表分析｜首頁</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/reports-page.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  </head>
  <body class="reports-page">
    <div id="permBar" class="info-bar" style="display:none;" role="alert">您沒有權限檢視此報表</div>

    <nav class="reports-tabs" role="tablist" aria-label="報表分頁">
      <button class="tab active" role="tab" aria-selected="true" data-tab="employee-hours">員工工時分析</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="client-cost" data-admin-only="true">客戶成本分析</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="payroll" data-admin-only="true">薪資報表</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="receivables" data-admin-only="true">收款分析</button>
    </nav>

    <main class="reports-content">
      <!-- 客戶成本分析（管理員） -->
      <section id="panel-client-cost" class="reports-section panel" role="tabpanel" aria-labelledby="tab-client-cost">
        <div class="report-filters" aria-label="客戶成本分析篩選">
          <div class="filter-row">
            <div class="filter-group">
              <label for="cc-year">年度</label>
              <select id="cc-year" class="form-select"></select>
            </div>
            <div class="filter-group">
              <label for="cc-month">月份</label>
              <select id="cc-month" class="form-select">
                <option value="">全年</option>
                <option value="1">1月</option>
                <option value="2">2月</option>
                <option value="3">3月</option>
                <option value="4">4月</option>
                <option value="5">5月</option>
                <option value="6">6月</option>
                <option value="7">7月</option>
                <option value="8">8月</option>
                <option value="9">9月</option>
                <option value="10">10月</option>
                <option value="11">11月</option>
                <option value="12">12月</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="cc-client">客戶</label>
              <select id="cc-client" class="form-select">
                <option value="">全部客戶</option>
              </select>
            </div>
            <div class="filter-group filter-actions">
              <button id="cc-query" class="btn primary" type="button">查詢</button>
              <button id="cc-reset" class="btn" type="button">重置</button>
            </div>
          </div>
        </div>

        <section class="report-content">
          <div class="report-header">
            <h2>客戶成本分析</h2>
            <p class="subtitle">含加權工時、管理成本警示與毛利率</p>
          </div>
          <div class="report-body">
            <div class="report-summary">
              <div class="summary-card type-info">
                <div class="label">總成本</div>
                <div class="value">—</div>
                <div class="description">期間總管理＋薪資成本</div>
              </div>
              <div class="summary-card type-warning">
                <div class="label">管理成本警示</div>
                <div class="value">—</div>
                <div class="description">未輸入或不完整時提示</div>
              </div>
            </div>

            <div class="report-table-wrapper">
              <table class="report-table" aria-label="客戶成本明細">
                <thead>
                  <tr>
                    <th>客戶</th>
                    <th>實際工時</th>
                    <th>加權工時</th>
                    <th>薪資成本</th>
                    <th>管理成本</th>
                    <th>年終分攤</th>
                    <th>總成本</th>
                    <th>收據金額</th>
                    <th>毛利</th>
                    <th>毛利率</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="10" class="muted">尚無資料</td></tr>
                </tbody>
              </table>
            </div>

            <div class="chart-container">
              <div class="chart-title">客戶毛利率排名</div>
              <div class="chart-wrapper">
                <canvas id="cc-profit-chart"></canvas>
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- 員工工時分析（管理員；員工看到精簡版「我的工時」） -->
      <section id="panel-employee-hours" class="reports-section panel show" role="tabpanel" aria-labelledby="tab-employee-hours">
        <div class="report-filters" aria-label="員工工時分析篩選">
          <div class="filter-row">
            <div class="filter-group">
              <label for="eh-year">年度</label>
              <select id="eh-year" class="form-select"></select>
            </div>
            <div class="filter-group">
              <label for="eh-month">月份</label>
              <select id="eh-month" class="form-select">
                <option value="1">1月</option>
                <option value="2">2月</option>
                <option value="3">3月</option>
                <option value="4">4月</option>
                <option value="5">5月</option>
                <option value="6">6月</option>
                <option value="7">7月</option>
                <option value="8">8月</option>
                <option value="9">9月</option>
                <option value="10">10月</option>
                <option value="11">11月</option>
                <option value="12">12月</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="eh-employee">員工</label>
              <select id="eh-employee" class="form-select">
                <option value="">全部員工</option>
              </select>
            </div>
            <div class="filter-group filter-actions">
              <button id="eh-query" class="btn primary" type="button">查詢</button>
              <button id="eh-reset" class="btn" type="button">重置</button>
            </div>
          </div>
        </div>

        <section class="report-content">
          <div class="report-header">
            <h2>員工工時分析</h2>
            <p class="subtitle">月度工時、客戶分布與每日趨勢</p>
          </div>
          <div class="report-body">
            <div class="report-summary">
              <div class="summary-card type-info">
                <div class="label">總工時</div>
                <div class="value">—</div>
                <div class="description">本月總計</div>
              </div>
              <div class="summary-card type-success">
                <div class="label">使用率</div>
                <div class="value">—</div>
                <div class="description">可計費占比</div>
              </div>
            </div>

            <div class="chart-container">
              <div class="chart-title">客戶工時分布（餅圖）</div>
              <div class="chart-wrapper">
                <canvas id="eh-client-dist-chart"></canvas>
              </div>
            </div>

            <div class="employee-hours-list" aria-label="員工工時一覽">
              <div class="employee-hours-item">
                <div class="employee-hours-name">範例員工</div>
                <div class="employee-hours-value">— <span class="employee-hours-unit">小時</span></div>
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- 薪資報表（管理員） -->
      <section id="panel-payroll" class="reports-section panel" role="tabpanel" aria-labelledby="tab-payroll">
        <div class="report-filters" aria-label="薪資報表篩選">
          <div class="filter-row">
            <div class="filter-group">
              <label for="pr-year">年度</label>
              <select id="pr-year" class="form-select"></select>
            </div>
            <div class="filter-group">
              <label for="pr-month">月份</label>
              <select id="pr-month" class="form-select">
                <option value="1">1月</option>
                <option value="2">2月</option>
                <option value="3">3月</option>
                <option value="4">4月</option>
                <option value="5">5月</option>
                <option value="6">6月</option>
                <option value="7">7月</option>
                <option value="8">8月</option>
                <option value="9">9月</option>
                <option value="10">10月</option>
                <option value="11">11月</option>
                <option value="12">12月</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="pr-employee">員工</label>
              <select id="pr-employee" class="form-select">
                <option value="">全部員工</option>
              </select>
            </div>
            <div class="filter-group filter-actions">
              <button id="pr-query" class="btn primary" type="button">查詢</button>
              <button id="pr-reset" class="btn" type="button">重置</button>
            </div>
          </div>
        </div>

        <section class="report-content">
          <div class="report-header">
            <h2>薪資報表</h2>
            <p class="subtitle">月度薪資匯總與個人明細</p>
          </div>
          <div class="report-body">
            <div class="report-summary">
              <div class="summary-card type-info">
                <div class="label">總薪資</div>
                <div class="value">—</div>
                <div class="description">應發＋淨發概覽</div>
              </div>
            </div>

            <div class="report-table-wrapper">
              <table class="report-table" aria-label="薪資明細">
                <thead>
                  <tr>
                    <th>員工</th>
                    <th>底薪</th>
                    <th>津貼</th>
                    <th>獎金</th>
                    <th>加班費</th>
                    <th>應發</th>
                    <th>淨發</th>
                    <th>全勤</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="8" class="muted">尚無資料</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </section>

      <!-- 收款分析（管理員） -->
      <section id="panel-receivables" class="reports-section panel" role="tabpanel" aria-labelledby="tab-receivables">
        <div class="report-filters" aria-label="收款分析篩選">
          <div class="filter-row">
            <div class="filter-group">
              <label for="rc-year">年度</label>
              <select id="rc-year" class="form-select"></select>
            </div>
            <div class="filter-group">
              <label for="rc-month">月份</label>
              <select id="rc-month" class="form-select">
                <option value="">全年</option>
                <option value="1">1月</option>
                <option value="2">2月</option>
                <option value="3">3月</option>
                <option value="4">4月</option>
                <option value="5">5月</option>
                <option value="6">6月</option>
                <option value="7">7月</option>
                <option value="8">8月</option>
                <option value="9">9月</option>
                <option value="10">10月</option>
                <option value="11">11月</option>
                <option value="12">12月</option>
              </select>
            </div>
            <div class="filter-group filter-actions">
              <button id="rc-query" class="btn primary" type="button">查詢</button>
              <button id="rc-reset" class="btn" type="button">重置</button>
            </div>
          </div>
        </div>

        <section class="report-content">
          <div class="report-header">
            <h2>收款分析</h2>
            <p class="subtitle">應收、收款率、月度趨勢與客戶明細</p>
          </div>
          <div class="report-body">
            <div class="report-summary">
              <div class="summary-card type-info">
                <div class="label">總開立</div>
                <div class="value">—</div>
                <div class="description">查詢期間</div>
              </div>
              <div class="summary-card type-success">
                <div class="label">已收</div>
                <div class="value">—</div>
                <div class="description">查詢期間</div>
              </div>
              <div class="summary-card type-warning">
                <div class="label">應收</div>
                <div class="value">—</div>
                <div class="description">查詢期間</div>
              </div>
              <div class="summary-card type-info">
                <div class="label">收款率</div>
                <div class="value">—</div>
                <div class="description">已收/開立</div>
              </div>
            </div>

            <div class="chart-container">
              <div class="chart-title">月度趨勢：開立 vs 收款</div>
              <div class="chart-wrapper">
                <canvas id="rc-trend-chart"></canvas>
              </div>
            </div>

            <div class="report-table-wrapper">
              <table class="report-table" aria-label="客戶收款明細">
                <thead>
                  <tr>
                    <th>客戶</th>
                    <th>開立</th>
                    <th>已收</th>
                    <th>應收</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="4" class="muted">尚無資料</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </section>
    </main>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const permBar = document.getElementById('permBar');
        const tabs = Array.from(document.querySelectorAll('.reports-tab-header .tab'));
        const panels = {
          'client-cost': document.getElementById('panel-client-cost'),
          'employee-hours': document.getElementById('panel-employee-hours'),
          'payroll': document.getElementById('panel-payroll'),
          'receivables': document.getElementById('panel-receivables'),
        };

        // Chart instances
        let ccProfitChart = null;
        let ehClientDistChart = null;
        let rcTrendChart = null;

        // Helper function to destroy chart if exists
        function destroyChart(chartInstance) {
          if (chartInstance) {
            chartInstance.destroy();
          }
          return null;
        }

        // Generate colors for charts
        function generateColors(count) {
          const colors = [
            '#2c5f7c', '#3498db', '#27ae60', '#f39c12', '#e74c3c', 
            '#9b59b6', '#1abc9c', '#34495e', '#16a085', '#c0392b',
            '#8e44ad', '#2980b9', '#d35400', '#c0392b', '#7f8c8d'
          ];
          return Array.from({length: count}, (_, i) => colors[i % colors.length]);
        }

        function setActiveTab(key){
          tabs.forEach(b=>{
            const selected = b.getAttribute('data-tab') === key;
            b.classList.toggle('active', selected);
            b.setAttribute('aria-selected', selected ? 'true' : 'false');
          });
          Object.entries(panels).forEach(([k,el])=>{
            if (!el) return;
            if (k === key) el.classList.add('show'); else el.classList.remove('show');
          });
          // 自動載入對應分頁資料
          if (key === 'client-cost') loadClientCost();
          else if (key === 'employee-hours') loadEmployeeHours();
          else if (key === 'payroll') loadPayroll();
          else if (key === 'receivables') loadRevenue();
        }

        tabs.forEach(btn => {
          btn.addEventListener('click', ()=>{
            const key = btn.getAttribute('data-tab');
            setActiveTab(key);
          });
        });

        function validateDateRange(fromEl, toEl){
          const a = fromEl.value, b = toEl.value;
          if (!a || !b) return false;
          try { return new Date(a) <= new Date(b); } catch(_) { return false; }
        }

        function initializeYearSelects() {
          const currentYear = new Date().getFullYear();
          const years = [];
          for (let y = currentYear; y >= currentYear - 5; y--) {
            years.push(y);
          }
          
          ['cc-year', 'eh-year', 'pr-year', 'rc-year'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
              select.innerHTML = years.map(y => `<option value="${y}">${y}年</option>`).join('');
              select.value = currentYear;
            }
          });
        }

        async function loadClientsList() {
          try {
            const res = await fetch(`${apiBase}/clients`, { credentials: 'include' });
            if (!res.ok) return;
            const json = await res.json();
            const clients = json.data || [];
            const select = document.getElementById('cc-client');
            if (select) {
              select.innerHTML = '<option value="">全部客戶</option>' + 
                clients.map(c => `<option value="${c.client_id}">${c.company_name}</option>`).join('');
            }
          } catch (e) {
            console.error('Failed to load clients:', e);
          }
        }

        async function loadEmployeesList() {
          try {
            const res = await fetch(`${apiBase}/settings/users`, { credentials: 'include' });
            if (!res.ok) return;
            const json = await res.json();
            const users = json.data || [];
            ['eh-employee', 'pr-employee'].forEach(id => {
              const select = document.getElementById(id);
              if (select) {
                select.innerHTML = '<option value="">全部員工</option>' + 
                  users.map(u => `<option value="${u.user_id}">${u.name || u.username}</option>`).join('');
              }
            });
          } catch (e) {
            console.error('Failed to load employees:', e);
          }
        }

        function attachValidation(){
          const ccQuery = document.getElementById('cc-query');
          const ccReset = document.getElementById('cc-reset');

          const rcQuery = document.getElementById('rc-query');
          const rcReset = document.getElementById('rc-reset');

          const ehQuery = document.getElementById('eh-query');
          const ehReset = document.getElementById('eh-reset');

          const prQuery = document.getElementById('pr-query');
          const prReset = document.getElementById('pr-reset');

          ccQuery?.addEventListener('click', loadClientCost);
          ccReset?.addEventListener('click', ()=>{ 
            document.getElementById('cc-year').value = new Date().getFullYear();
            document.getElementById('cc-month').value = '';
            document.getElementById('cc-client').value = '';
          });

          rcQuery?.addEventListener('click', loadRevenue);
          rcReset?.addEventListener('click', ()=>{ 
            document.getElementById('rc-year').value = new Date().getFullYear();
            document.getElementById('rc-month').value = '';
          });

          ehQuery?.addEventListener('click', loadEmployeeHours);
          ehReset?.addEventListener('click', ()=>{ 
            const now = new Date();
            document.getElementById('eh-year').value = now.getFullYear();
            document.getElementById('eh-month').value = String(now.getMonth() + 1);
            document.getElementById('eh-employee').value = '';
          });

          prQuery?.addEventListener('click', loadPayroll);
          prReset?.addEventListener('click', ()=>{ 
            const now = new Date();
            document.getElementById('pr-year').value = now.getFullYear();
            document.getElementById('pr-month').value = String(now.getMonth() + 1);
            document.getElementById('pr-employee').value = '';
          });
        }

        function formatNumber(n){ try { return Number(n||0).toLocaleString(); } catch(_) { return String(n||0); } }

        async function loadClientCost(){
          const panel = document.getElementById('panel-client-cost');
          const tbody = panel.querySelector('.report-table tbody');
          const totalValueEl = panel.querySelector('.summary-card.type-info .value');
          const warnValueEl = panel.querySelector('.summary-card.type-warning .value');
          const year = document.getElementById('cc-year').value;
          const month = document.getElementById('cc-month').value;
          const client = document.getElementById('cc-client').value;
          
          if (!year) { alert('請選擇年度'); return; }
          
          // 计算日期范围
          let startDate, endDate;
          if (month) {
            const y = parseInt(year);
            const m = parseInt(month);
            startDate = `${y}-${String(m).padStart(2,'0')}-01`;
            const lastDay = new Date(y, m, 0).getDate();
            endDate = `${y}-${String(m).padStart(2,'0')}-${String(lastDay).padStart(2,'0')}`;
          } else {
            startDate = `${year}-01-01`;
            endDate = `${year}-12-31`;
          }
          
          const params = new URLSearchParams();
          params.set('start_date', startDate);
          params.set('end_date', endDate);
          if (client) params.set('client_id', client);
          try {
            tbody.innerHTML = '<tr><td colspan="10" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/reports/client-cost-analysis?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/reports'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const rows = Array.isArray(json.data) ? json.data : [];
            let totalCostAll = 0;
            tbody.innerHTML = '';
            if (!rows.length) {
              tbody.innerHTML = '<tr><td colspan="10" class="muted">尚無資料</td></tr>';
            } else {
              rows.forEach((r, idx) => {
                const salary = Number(r?.cost_breakdown?.salary_cost || 0);
                const oh = Number(r?.cost_breakdown?.overhead_cost || 0);
                const bonus = Number(r?.cost_breakdown?.year_end_bonus || 0);
                const total = Number(r?.cost_breakdown?.total_cost || (salary+oh+bonus));
                totalCostAll += total;
                const tr = document.createElement('tr');
                tr.style.cursor = r.user_breakdown && r.user_breakdown.length > 0 ? 'pointer' : 'default';
                tr.innerHTML = `
                  <td>${r.company_name||r.client_id||''} ${r.user_breakdown && r.user_breakdown.length > 0 ? '<span style="color:#3498db;font-size:0.85em;">▼</span>' : ''}</td>
                  <td class="number-cell">${formatNumber(r.total_actual_hours)}</td>
                  <td class="number-cell">${formatNumber(r.total_weighted_hours)}</td>
                  <td class="number-cell">${formatNumber(salary)}</td>
                  <td class="number-cell">${formatNumber(oh)}</td>
                  <td class="number-cell">${formatNumber(bonus)}</td>
                  <td class="number-cell">${formatNumber(total)}</td>
                  <td class="number-cell">${formatNumber(r.revenue||0)}</td>
                  <td class="number-cell">${formatNumber(r.gross_profit||0)}</td>
                  <td class="number-cell ${Number(r.profit_margin||0) >= 0 ? 'positive-value':'negative-value'}">${Number(r.profit_margin||0).toFixed(1)}%</td>
                `;
                tbody.appendChild(tr);
                
                // Add click handler to toggle user breakdown
                if (r.user_breakdown && r.user_breakdown.length > 0) {
                  const detailRowId = `detail-row-${idx}`;
                  tr.addEventListener('click', function() {
                    const existingDetail = document.getElementById(detailRowId);
                    if (existingDetail) {
                      existingDetail.remove();
                      tr.querySelector('span').textContent = '▼';
                    } else {
                      const detailTr = document.createElement('tr');
                      detailTr.id = detailRowId;
                      detailTr.style.backgroundColor = '#f8f9fa';
                      detailTr.innerHTML = `
                        <td colspan="10" style="padding:15px;">
                          <div style="font-weight:700;margin-bottom:10px;color:var(--primary-color);">員工明細</div>
                          <table style="width:100%;font-size:0.9em;">
                            <thead>
                              <tr style="background:#e9ecef;">
                                <th style="padding:8px;text-align:left;">員工</th>
                                <th style="padding:8px;text-align:right;">實際工時</th>
                                <th style="padding:8px;text-align:right;">加權工時</th>
                                <th style="padding:8px;text-align:right;">時薪成本率</th>
                                <th style="padding:8px;text-align:right;">薪資成本</th>
                                <th style="padding:8px;text-align:right;">管理成本</th>
                                <th style="padding:8px;text-align:right;">總成本</th>
                              </tr>
                            </thead>
                            <tbody>
                              ${r.user_breakdown.map(u => `
                                <tr>
                                  <td style="padding:8px;">${u.username}</td>
                                  <td style="padding:8px;text-align:right;">${formatNumber(u.actual_hours)}</td>
                                  <td style="padding:8px;text-align:right;">${formatNumber(u.weighted_hours)}</td>
                                  <td style="padding:8px;text-align:right;">${formatNumber(u.hourly_cost_rate)}</td>
                                  <td style="padding:8px;text-align:right;">${formatNumber(u.salary_cost)}</td>
                                  <td style="padding:8px;text-align:right;">${formatNumber(u.overhead_cost)}</td>
                                  <td style="padding:8px;text-align:right;font-weight:700;">${formatNumber(u.total_cost)}</td>
                                </tr>
                              `).join('')}
                            </tbody>
                          </table>
                        </td>
                      `;
                      tr.after(detailTr);
                      tr.querySelector('span').textContent = '▲';
                    }
                  });
                }
              });
            }
            totalValueEl.textContent = formatNumber(totalCostAll);
            const hasWarn = Array.isArray(json.warnings) && json.warnings.length > 0;
            warnValueEl.textContent = hasWarn ? '警示' : '正常';

            // Render profit margin chart
            ccProfitChart = destroyChart(ccProfitChart);
            if (rows.length > 0) {
              const ctx = document.getElementById('cc-profit-chart');
              const chartData = rows.slice(0, 10).map(r => ({
                name: r.company_name || r.client_id,
                margin: Number(r.profit_margin || 0)
              }));
              ccProfitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: chartData.map(d => d.name),
                  datasets: [{
                    label: '毛利率 (%)',
                    data: chartData.map(d => d.margin),
                    backgroundColor: chartData.map(d => d.margin >= 0 ? '#27ae60' : '#e74c3c'),
                    borderColor: chartData.map(d => d.margin >= 0 ? '#229954' : '#c0392b'),
                    borderWidth: 1
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { display: false },
                    tooltip: {
                      callbacks: {
                        label: (context) => `毛利率: ${context.parsed.y.toFixed(1)}%`
                      }
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      title: { display: true, text: '毛利率 (%)' },
                      ticks: { callback: (value) => value + '%' }
                    },
                    x: {
                      ticks: { maxRotation: 45, minRotation: 45 }
                    }
                  }
                }
              });
            }
          } catch (_) {
            tbody.innerHTML = '<tr><td colspan="10" style="color:#c0392b;">查詢失敗</td></tr>';
          }
        }

        async function loadEmployeeHours(){
          const panel = document.getElementById('panel-employee-hours');
          const year = document.getElementById('eh-year').value;
          const month = document.getElementById('eh-month').value;
          const userId = document.getElementById('eh-employee').value;
          
          if (!year || !month) { alert('請選擇年度和月份'); return; }
          
          const params = new URLSearchParams();
          params.set('year', year);
          params.set('month', month);
          if (userId) params.set('user_id', userId);
          const totalValueEl = panel.querySelector('.summary-card.type-info .value');
          const utilValueEl = panel.querySelector('.summary-card.type-success .value');
          const listEl = panel.querySelector('.employee-hours-list');
          try {
            listEl.innerHTML = '<div class="muted" style="padding:10px;">載入中…</div>';
            const res = await fetch(`${apiBase}/reports/employee-hours?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/reports'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const rows = Array.isArray(json.data) ? json.data : [];
            let totalHours = 0; let utilSum = 0;
            listEl.innerHTML = '';
            if (!rows.length) {
              listEl.innerHTML = '<div class="muted" style="padding:10px;">尚無資料</div>';
            } else {
              rows.forEach(r => {
                totalHours += Number(r.total_hours||0);
                utilSum += Number(r.utilization_rate||0);
                const item = document.createElement('div');
                item.className = 'employee-hours-item';
                item.innerHTML = `
                  <div class="employee-hours-name">${r.username||r.user_id}</div>
                  <div class="employee-hours-value">${formatNumber(r.total_hours||0)} <span class="employee-hours-unit">小時</span></div>
                `;
                listEl.appendChild(item);
              });
            }
            const avgUtil = rows.length ? (utilSum/rows.length) : 0;
            totalValueEl.textContent = formatNumber(totalHours);
            utilValueEl.textContent = `${avgUtil.toFixed(2)}%`;

            // Render client distribution pie chart
            ehClientDistChart = destroyChart(ehClientDistChart);
            if (rows.length > 0 && rows[0].client_distribution && rows[0].client_distribution.length > 0) {
              const ctx = document.getElementById('eh-client-dist-chart');
              const dist = rows[0].client_distribution;
              const colors = generateColors(dist.length);
              ehClientDistChart = new Chart(ctx, {
                type: 'pie',
                data: {
                  labels: dist.map(d => d.company_name),
                  datasets: [{
                    data: dist.map(d => d.hours),
                    backgroundColor: colors,
                    borderWidth: 2,
                    borderColor: '#fff'
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { position: 'right' },
                    tooltip: {
                      callbacks: {
                        label: (context) => {
                          const label = context.label || '';
                          const value = context.parsed || 0;
                          const pct = dist[context.dataIndex]?.percentage || 0;
                          return `${label}: ${value.toFixed(1)}h (${pct}%)`;
                        }
                      }
                    }
                  }
                }
              });
            }

          } catch (_) {
            listEl.innerHTML = '<div style="color:#c0392b;padding:10px;">查詢失敗</div>';
          }
        }

        async function loadPayroll(){
          const panel = document.getElementById('panel-payroll');
          const year = document.getElementById('pr-year').value;
          const month = document.getElementById('pr-month').value;
          const userId = document.getElementById('pr-employee').value;
          
          if (!year || !month) { alert('請選擇年度和月份'); return; }
          
          const params = new URLSearchParams();
          params.set('year', year);
          params.set('month', month);
          if (userId) params.set('user_id', userId);
          const totalValueEl = panel.querySelector('.summary-card.type-info .value');
          const tbody = panel.querySelector('.report-table tbody');
          try {
            tbody.innerHTML = '<tr><td colspan="8" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/reports/payroll-summary?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/reports'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || { summary:{}, by_employee:[] };
            const byEmp = Array.isArray(data.by_employee) ? data.by_employee : [];
            totalValueEl.textContent = formatNumber(data.summary?.total_gross_salary || 0);
            tbody.innerHTML = '';
            if (!byEmp.length) {
              tbody.innerHTML = '<tr><td colspan="8" class="muted">尚無資料</td></tr>';
            } else {
              byEmp.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${r.username||r.user_id}</td>
                  <td class="number-cell">${formatNumber(r.base_salary)}</td>
                  <td class="number-cell">${formatNumber(r.total_allowances)}</td>
                  <td class="number-cell">${formatNumber(r.total_bonuses)}</td>
                  <td class="number-cell">${formatNumber(r.overtime_pay)}</td>
                  <td class="number-cell">${formatNumber(r.gross_salary)}</td>
                  <td class="number-cell">${formatNumber(r.net_salary)}</td>
                  <td>${r.has_full_attendance ? '是' : '否'}</td>
                `;
                tbody.appendChild(tr);
              });
            }
          } catch (_) {
            tbody.innerHTML = '<tr><td colspan="8" style="color:#c0392b;">查詢失敗</td></tr>';
          }
        }

        async function loadRevenue(){
          const panel = document.getElementById('panel-receivables');
          const year = document.getElementById('rc-year').value;
          const month = document.getElementById('rc-month').value;
          
          if (!year) { alert('請選擇年度'); return; }
          
          // 计算日期范围
          let startDate, endDate;
          if (month) {
            const y = parseInt(year);
            const m = parseInt(month);
            startDate = `${y}-${String(m).padStart(2,'0')}-01`;
            const lastDay = new Date(y, m, 0).getDate();
            endDate = `${y}-${String(m).padStart(2,'0')}-${String(lastDay).padStart(2,'0')}`;
          } else {
            startDate = `${year}-01-01`;
            endDate = `${year}-12-31`;
          }
          
          const params = new URLSearchParams();
          params.set('start_date', startDate);
          params.set('end_date', endDate);
          const values = panel.querySelectorAll('.summary-card .value');
          const tbody = panel.querySelector('.report-table tbody');
          try {
            tbody.innerHTML = '<tr><td colspan="4" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/reports/revenue?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/reports'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const d = json.data || { summary:{}, monthly_trend:[], by_client:[] };
            // Summary cards: 開立 / 已收 / 應收 / 收款率
            if (values[0]) values[0].textContent = formatNumber(d.summary?.total_receipts || 0);
            if (values[1]) values[1].textContent = formatNumber(d.summary?.total_paid || 0);
            if (values[2]) values[2].textContent = formatNumber(d.summary?.total_outstanding || 0);
            if (values[3]) values[3].textContent = `${Number(d.summary?.collection_rate||0).toFixed(1)}%`;
            // Table by client
            const list = Array.isArray(d.by_client) ? d.by_client : [];
            tbody.innerHTML = '';
            if (!list.length) {
              tbody.innerHTML = '<tr><td colspan="4" class="muted">尚無資料</td></tr>';
            } else {
              list.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${r.company_name||r.client_id}</td>
                  <td class="number-cell">${formatNumber(r.total_receipts)}</td>
                  <td class="number-cell">${formatNumber(r.total_paid)}</td>
                  <td class="number-cell">${formatNumber(r.total_outstanding)}</td>
                `;
                tbody.appendChild(tr);
              });
            }
            // Render monthly trend chart
            rcTrendChart = destroyChart(rcTrendChart);
            if (d.monthly_trend && d.monthly_trend.length > 0) {
              const ctx = document.getElementById('rc-trend-chart');
              const trend = d.monthly_trend;
              rcTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: trend.map(t => t.month),
                  datasets: [
                    {
                      label: '開立金額',
                      data: trend.map(t => t.receipts),
                      borderColor: '#3498db',
                      backgroundColor: 'rgba(52, 152, 219, 0.1)',
                      tension: 0.3,
                      fill: true
                    },
                    {
                      label: '收款金額',
                      data: trend.map(t => t.paid),
                      borderColor: '#27ae60',
                      backgroundColor: 'rgba(39, 174, 96, 0.1)',
                      tension: 0.3,
                      fill: true
                    }
                  ]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                      mode: 'index',
                      intersect: false,
                      callbacks: {
                        label: (context) => `${context.dataset.label}: ${formatNumber(context.parsed.y)}`
                      }
                    }
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      title: { display: true, text: '金額 (元)' },
                      ticks: {
                        callback: (value) => formatNumber(value)
                      }
                    },
                    x: {
                      title: { display: true, text: '月份' }
                    }
                  }
                }
              });
            }
          } catch (_) {
            tbody.innerHTML = '<tr><td colspan="4" style="color:#c0392b;">查詢失敗</td></tr>';
          }
        }

        async function bootstrap(){
          // 初始化年度选择器
          initializeYearSelects();
          
          // 設置預設月份
          const now = new Date();
          const currentMonth = String(now.getMonth() + 1);
          document.getElementById('eh-month').value = currentMonth;
          document.getElementById('pr-month').value = currentMonth;

          // 載入客戶和員工列表
          await Promise.all([loadClientsList(), loadEmployeesList()]);

          // 權限：根據 /auth/me 決定可見的分頁
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/reports'); return; }
            const json = await res.json();
            const isAdmin = !!(json && json.ok && json.data && json.data.isAdmin);
            tabs.forEach(btn => {
              const adminOnly = btn.getAttribute('data-admin-only') === 'true';
              if (adminOnly && !isAdmin) btn.style.display = 'none';
            });
            // 預設啟用分頁：員工工時
            setActiveTab('employee-hours');
            permBar.style.display = 'none';
          } catch (_) {
            // 若讀取角色失敗，僅顯示員工工時分頁
            tabs.forEach(btn => { if (btn.getAttribute('data-admin-only') === 'true') btn.style.display = 'none'; });
            setActiveTab('employee-hours');
            permBar.textContent = '載入使用者資訊失敗，僅顯示個人報表';
            permBar.style.display = 'block';
          }

          attachValidation();
        }

        bootstrap();
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


