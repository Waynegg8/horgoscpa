<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="å ±è¡¨åˆ†æä¸­å¿ƒ" />
    <title>å ±è¡¨åˆ†æï½œå…§éƒ¨ç³»çµ±</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/reports-page.css" />
    <!-- é¢„åŠ è½½ä¸ç¼“å­˜ç³»ç»Ÿ -->
    <script src="/assets/js/data-cache.js"></script>
    <script src="/assets/js/fetch-interceptor.js"></script>
  </head>
  <body class="reports-page">
    <div style="padding:16px 20px;">
      <div id="permBar" class="info-bar" style="display:none;" role="alert">æ‚¨æ²’æœ‰æ¬Šé™æª¢è¦–æ­¤å ±è¡¨</div>
      
      <nav class="reports-tabs" role="tablist" aria-label="å ±è¡¨åˆ†é " style="display:flex;gap:8px;border-bottom:2px solid #e5e7eb;margin-bottom:20px;">
        <button class="tab active" role="tab" aria-selected="true" data-tab="monthly">æœˆåº¦å ±è¡¨</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="annual">å¹´åº¦å ±è¡¨</button>
      </nav>
    </div>

    <main class="reports-content" style="padding:0 20px 40px;">
      <!-- ========================================== -->
      <!-- æœˆåº¦æŠ¥è¡¨ -->
      <!-- ========================================== -->
      <section id="panel-monthly" class="reports-section panel show" role="tabpanel">
        <div class="report-filters" style="margin-bottom:24px;display:flex;gap:12px;align-items:center;">
          <label for="monthly-year" style="font-weight:600;">é¸æ“‡æœˆä»½ï¼š</label>
          <select id="monthly-year" class="form-select" style="width:120px;"></select>
          <select id="monthly-month" class="form-select" style="width:100px;">
                <option value="1">1æœˆ</option>
                <option value="2">2æœˆ</option>
                <option value="3">3æœˆ</option>
                <option value="4">4æœˆ</option>
                <option value="5">5æœˆ</option>
                <option value="6">6æœˆ</option>
                <option value="7">7æœˆ</option>
                <option value="8">8æœˆ</option>
                <option value="9">9æœˆ</option>
                <option value="10">10æœˆ</option>
                <option value="11">11æœˆ</option>
                <option value="12">12æœˆ</option>
              </select>
          <button id="monthly-load" class="btn primary" style="margin-left:12px;">è¼‰å…¥å ±è¡¨</button>
            </div>

        <!-- Section 1: æ”¶æ¬¾æŠ¥è¡¨ -->
        <div class="card" style="margin-bottom:24px;">
          <h3 class="card-title" style="margin:0 0 16px 0;font-size:18px;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">ğŸ“Š æœˆåº¦æ”¶æ¬¾å ±è¡¨</h3>
          
          <div class="stats-row" style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px;">
            <div class="stat-item">
              <div class="stat-label">æœ¬æœˆæ‡‰æ”¶é‡‘é¡</div>
              <div class="stat-value" id="m-rev-receivable">â€”</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">æœ¬æœˆå¯¦æ”¶é‡‘é¡</div>
              <div class="stat-value" id="m-rev-received">â€”</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">æœ¬æœˆæ”¶æ¬¾ç‡</div>
              <div class="stat-value" id="m-rev-rate">â€”</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">é€¾æœŸæœªæ”¶</div>
              <div class="stat-value" id="m-rev-overdue" style="color:#dc2626;">â€”</div>
            </div>
          </div>

          <h4 style="font-size:14px;font-weight:600;margin:20px 0 12px 0;color:#64748b;">æŒ‰å®¢æˆ¶æ˜ç´°</h4>
          <div class="report-table-wrapper">
            <table class="report-table">
              <thead>
                <tr>
                  <th>å®¢æˆ¶åç¨±</th>
                  <th>æœå‹™é¡å‹</th>
                  <th class="text-right">æ‡‰æ”¶é‡‘é¡</th>
                  <th class="text-right">å¯¦æ”¶é‡‘é¡</th>
                  <th class="text-right">æœªæ”¶é‡‘é¡</th>
                  <th class="text-right">æ”¶æ¬¾ç‡</th>
                  <th>é€¾æœŸ</th>
                </tr>
              </thead>
              <tbody id="m-rev-details">
                <tr><td colspan="7" class="muted">è«‹é¸æ“‡æœˆä»½å¾Œè¼‰å…¥è³‡æ–™</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Section 2: è–ªèµ„æŠ¥è¡¨ -->
        <div class="card" style="margin-bottom:24px;">
          <h3 class="card-title" style="margin:0 0 16px 0;font-size:18px;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">ğŸ’° æœˆåº¦è–ªè³‡å ±è¡¨</h3>
          
          <div class="stats-row" style="display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:20px;">
            <div class="stat-item">
              <div class="stat-label">ç¸½æ‡‰ç™¼</div>
              <div class="stat-value" id="m-pay-gross">â€”</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">ç¸½å¯¦ç™¼</div>
              <div class="stat-value" id="m-pay-net">â€”</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">äººæ•¸</div>
              <div class="stat-value" id="m-pay-count">â€”</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">å¹³å‡æ‡‰ç™¼</div>
              <div class="stat-value" id="m-pay-avg-gross">â€”</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">å¹³å‡å¯¦ç™¼</div>
              <div class="stat-value" id="m-pay-avg-net">â€”</div>
          </div>
        </div>

          <h4 style="font-size:14px;font-weight:600;margin:20px 0 12px 0;color:#64748b;">è–ªè³‡æ˜ç´°</h4>
          <div class="report-table-wrapper" style="overflow-x:auto;">
            <table class="report-table" style="font-size:12px;">
              <thead>
                <tr>
                  <th>å§“å</th>
                  <th class="text-right">åº•è–ª</th>
                  <th class="text-right">æ´¥è²¼</th>
                  <th class="text-right">çé‡‘</th>
                  <th class="text-right">å…¨å‹¤</th>
                  <th class="text-right">åŠ ç­è²»</th>
                  <th class="text-right">ä¼™é£Ÿ</th>
                  <th class="text-right">äº¤é€š</th>
                  <th class="text-right">ç¸¾æ•ˆ</th>
                  <th class="text-right">å¹´çµ‚</th>
                  <th class="text-right">æ‰£æ¬¾</th>
                  <th class="text-right" style="background:#f0f9ff;font-weight:600;">æ‡‰ç™¼</th>
                  <th class="text-right" style="background:#dbeafe;font-weight:600;">å¯¦ç™¼</th>
                </tr>
              </thead>
              <tbody id="m-pay-details">
                <tr><td colspan="13" class="muted">è«‹é¸æ“‡æœˆä»½å¾Œè¼‰å…¥è³‡æ–™</td></tr>
              </tbody>
            </table>
            </div>

          <h4 style="font-size:14px;font-weight:600;margin:20px 0 12px 0;color:#64748b;">è–ªè³‡æ§‹æˆåˆ†æ</h4>
          <div class="report-table-wrapper">
            <table class="report-table">
              <thead>
                <tr>
                  <th>é …ç›®</th>
                  <th class="text-right">é‡‘é¡</th>
                  <th class="text-right">å æ¯”ï¼ˆæ‡‰ç™¼ï¼‰</th>
                </tr>
              </thead>
              <tbody id="m-pay-composition">
                <tr><td colspan="3" class="muted">è«‹é¸æ“‡æœˆä»½å¾Œè¼‰å…¥è³‡æ–™</td></tr>
              </tbody>
            </table>
            </div>
          </div>

        <!-- Section 3: å‘˜å·¥äº§å€¼æŠ¥è¡¨ -->
        <div class="card" style="margin-bottom:24px;">
          <h3 class="card-title" style="margin:0 0 16px 0;font-size:18px;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">ğŸ‘¥ æœˆåº¦å“¡å·¥ç”¢å€¼åˆ†æ</h3>
          
          <div class="report-table-wrapper" style="overflow-x:auto;">
            <table class="report-table" style="font-size:12px;">
              <thead>
                <tr>
                  <th>å§“å</th>
                  <th class="text-right">æ¨™æº–å·¥æ™‚</th>
                  <th class="text-right">åŠ æ¬Šå·¥æ™‚</th>
                  <th class="text-right">å·¥æ™‚å·®ç•°</th>
                  <th class="text-right">ç”¢ç”Ÿæ”¶å…¥</th>
                  <th class="text-right">è–ªè³‡æˆæœ¬</th>
                  <th class="text-right">ç¸½æˆæœ¬</th>
                  <th class="text-right">æ¯›åˆ©</th>
                  <th class="text-right">æ¯›åˆ©ç‡</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="m-emp-performance">
                <tr><td colspan="10" class="muted">è«‹é¸æ“‡æœˆä»½å¾Œè¼‰å…¥è³‡æ–™</td></tr>
              </tbody>
            </table>
            </div>
          </div>

        <!-- Section 4: å®¢æˆ·æ¯›åˆ©æŠ¥è¡¨ -->
        <div class="card" style="margin-bottom:24px;">
          <h3 class="card-title" style="margin:0 0 16px 0;font-size:18px;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">ğŸ’¼ æœˆåº¦å®¢æˆ¶æ¯›åˆ©åˆ†æ</h3>
          
          <div class="report-table-wrapper">
            <table class="report-table">
              <thead>
                <tr>
                  <th>å®¢æˆ¶åç¨±</th>
                  <th class="text-right">ç¸½å·¥æ™‚</th>
                  <th class="text-right">åŠ æ¬Šå·¥æ™‚</th>
                  <th class="text-right">å¹³å‡æ™‚è–ª</th>
                  <th class="text-right">ç¸½æˆæœ¬</th>
                  <th class="text-right">æœ¬æœˆæ”¶å…¥</th>
                  <th class="text-right">æ¯›åˆ©</th>
                  <th class="text-right">æ¯›åˆ©ç‡</th>
                </tr>
              </thead>
              <tbody id="m-client-profit">
                <tr><td colspan="8" class="muted">è«‹é¸æ“‡æœˆä»½å¾Œè¼‰å…¥è³‡æ–™</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ========================================== -->
      <!-- å¹´åº¦æŠ¥è¡¨ -->
      <!-- ========================================== -->
      <section id="panel-annual" class="reports-section panel" role="tabpanel">
        <div class="report-filters" style="margin-bottom:24px;">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;">
            <label for="annual-year" style="font-weight:600;">é¸æ“‡å¹´åº¦ï¼š</label>
            <select id="annual-year" class="form-select" style="width:120px;"></select>
            </div>
          <div style="display:flex;gap:12px;flex-wrap:wrap;">
            <button id="annual-load-revenue" class="btn primary">ğŸ“Š æ”¶æ¬¾å ±è¡¨</button>
            <button id="annual-load-payroll" class="btn primary">ğŸ’° è–ªè³‡å ±è¡¨</button>
            <button id="annual-load-performance" class="btn primary">ğŸ‘¥ å“¡å·¥ç”¢å€¼</button>
            <button id="annual-load-profit" class="btn primary">ğŸ“ˆ å®¢æˆ¶æ¯›åˆ©</button>
            <button id="annual-load-all" class="btn" style="background:#64748b;margin-left:auto;">ğŸ”„ å…¨éƒ¨è¼‰å…¥</button>
            </div>
          <span id="annual-loading" style="margin-top:12px;color:#64748b;display:none;font-size:14px;"></span>
            </div>

        <!-- Section 1: å¹´åº¦æ”¶æ¬¾æŠ¥è¡¨ -->
        <div class="card" style="margin-bottom:24px;">
          <h3 class="card-title" style="margin:0 0 16px 0;font-size:18px;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">
            ğŸ“Š å¹´åº¦æ”¶æ¬¾å ±è¡¨
            <span id="revenue-status" style="font-size:14px;font-weight:normal;color:#64748b;margin-left:12px;"></span>
          </h3>
          
          <div class="stats-row" style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px;">
            <div class="stat-item">
              <div class="stat-label">å…¨å¹´æ‡‰æ”¶é‡‘é¡</div>
              <div class="stat-value" id="a-rev-receivable">â€”</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">å…¨å¹´å¯¦æ”¶é‡‘é¡</div>
              <div class="stat-value" id="a-rev-received">â€”</div>
          </div>
            <div class="stat-item">
              <div class="stat-label">å…¨å¹´æ”¶æ¬¾ç‡</div>
              <div class="stat-value" id="a-rev-rate">â€”</div>
        </div>
            <div class="stat-item">
              <div class="stat-label">å¹´åº¦é€¾æœŸæœªæ”¶</div>
              <div class="stat-value" id="a-rev-overdue" style="color:#dc2626;">â€”</div>
            </div>
          </div>

          <h4 style="font-size:14px;font-weight:600;margin:20px 0 12px 0;color:#64748b;">æœˆåº¦æ”¶æ¬¾è¶¨å‹¢</h4>
          <div class="report-table-wrapper">
            <table class="report-table">
              <thead>
                <tr>
                  <th>æœˆä»½</th>
                  <th class="text-right">æ‡‰æ”¶é‡‘é¡</th>
                  <th class="text-right">å¯¦æ”¶é‡‘é¡</th>
                  <th class="text-right">æ”¶æ¬¾ç‡</th>
                  <th class="text-right">é€¾æœŸé‡‘é¡</th>
                </tr>
              </thead>
              <tbody id="a-rev-trend">
                <tr><td colspan="5" class="muted">è«‹é¸æ“‡å¹´åº¦å¾Œè¼‰å…¥è³‡æ–™</td></tr>
              </tbody>
            </table>
          </div>

          <h4 style="font-size:14px;font-weight:600;margin:20px 0 12px 0;color:#64748b;">æŒ‰å®¢æˆ¶å¹´åº¦å½™ç¸½</h4>
          <div class="report-table-wrapper">
            <table class="report-table">
              <thead>
                <tr>
                  <th>å®¢æˆ¶åç¨±</th>
                  <th class="text-right">å…¨å¹´æ‡‰æ”¶</th>
                  <th class="text-right">å…¨å¹´å¯¦æ”¶</th>
                  <th class="text-right">æ”¶æ¬¾ç‡</th>
                  <th class="text-right">æœªæ”¶é‡‘é¡</th>
                  <th class="text-right">æœˆå‡æ”¶å…¥</th>
                </tr>
              </thead>
              <tbody id="a-rev-client">
                <tr><td colspan="6" class="muted">è«‹é¸æ“‡å¹´åº¦å¾Œè¼‰å…¥è³‡æ–™</td></tr>
              </tbody>
            </table>
        </div>

          <h4 style="font-size:14px;font-weight:600;margin:20px 0 12px 0;color:#64748b;">æŒ‰æœå‹™é¡å‹å¹´åº¦å½™ç¸½</h4>
          <div class="report-table-wrapper">
            <table class="report-table">
              <thead>
                <tr>
                  <th>æœå‹™é¡å‹</th>
                  <th class="text-right">å…¨å¹´æ‡‰æ”¶</th>
                  <th class="text-right">å…¨å¹´å¯¦æ”¶</th>
                  <th class="text-right">æ”¶æ¬¾ç‡</th>
                  <th class="text-right">æœªæ”¶é‡‘é¡</th>
                </tr>
              </thead>
              <tbody id="a-rev-service">
                <tr><td colspan="5" class="muted">è«‹é¸æ“‡å¹´åº¦å¾Œè¼‰å…¥è³‡æ–™</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Section 2: å¹´åº¦è–ªèµ„æŠ¥è¡¨ -->
        <div class="card" style="margin-bottom:24px;">
          <h3 class="card-title" style="margin:0 0 16px 0;font-size:18px;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">
            ğŸ’° å¹´åº¦è–ªè³‡å ±è¡¨
            <span id="payroll-status" style="font-size:14px;font-weight:normal;color:#64748b;margin-left:12px;"></span>
          </h3>
          
          <div class="stats-row" style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px;">
            <div class="stat-item">
              <div class="stat-label">å…¨å¹´ç¸½æ‡‰ç™¼</div>
              <div class="stat-value" id="a-pay-gross">â€”</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">å…¨å¹´ç¸½å¯¦ç™¼</div>
              <div class="stat-value" id="a-pay-net">â€”</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">æœˆå‡æ‡‰ç™¼</div>
              <div class="stat-value" id="a-pay-avg">â€”</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">å¹³å‡äººæ•¸</div>
              <div class="stat-value" id="a-pay-count">â€”</div>
            </div>
          </div>

          <h4 style="font-size:14px;font-weight:600;margin:20px 0 12px 0;color:#64748b;">æœˆåº¦è–ªè³‡è¶¨å‹¢</h4>
          <div class="report-table-wrapper">
            <table class="report-table">
              <thead>
                <tr>
                  <th>æœˆä»½</th>
                  <th class="text-right">ç¸½æ‡‰ç™¼</th>
                  <th class="text-right">ç¸½å¯¦ç™¼</th>
                  <th class="text-right">äººæ•¸</th>
                  <th class="text-right">å¹³å‡æ‡‰ç™¼</th>
                </tr>
              </thead>
              <tbody id="a-pay-trend">
                <tr><td colspan="5" class="muted">è«‹é¸æ“‡å¹´åº¦å¾Œè¼‰å…¥è³‡æ–™</td></tr>
              </tbody>
            </table>
          </div>

          <h4 style="font-size:14px;font-weight:600;margin:20px 0 12px 0;color:#64748b;">æŒ‰å“¡å·¥å¹´åº¦å½™ç¸½</h4>
          <div class="report-table-wrapper" style="overflow-x:auto;">
            <table class="report-table">
              <thead>
                <tr>
                  <th>å§“å</th>
                  <th class="text-right">å…¨å¹´æ‡‰ç™¼</th>
                  <th class="text-right">å…¨å¹´å¯¦ç™¼</th>
                  <th class="text-right">æœˆå‡æ‡‰ç™¼</th>
                  <th class="text-right">åŠ ç­è²»ç¸½è¨ˆ</th>
                  <th class="text-right">ç¸¾æ•ˆç¸½è¨ˆ</th>
                  <th class="text-right">å¹´çµ‚ç</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="a-pay-employee">
                <tr><td colspan="8" class="muted">è«‹é¸æ“‡å¹´åº¦å¾Œè¼‰å…¥è³‡æ–™</td></tr>
              </tbody>
            </table>
            </div>
          </div>

        <!-- Section 3: å¹´åº¦å‘˜å·¥äº§å€¼æŠ¥è¡¨ -->
        <div class="card" style="margin-bottom:24px;">
          <h3 class="card-title" style="margin:0 0 16px 0;font-size:18px;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">
            ğŸ‘¥ å¹´åº¦å“¡å·¥ç”¢å€¼åˆ†æ
            <span id="performance-status" style="font-size:14px;font-weight:normal;color:#64748b;margin-left:12px;"></span>
          </h3>
          
          <div class="report-table-wrapper" style="overflow-x:auto;">
            <table class="report-table" style="font-size:12px;">
              <thead>
                <tr>
                  <th>å§“å</th>
                  <th class="text-right">å…¨å¹´æ¨™æº–å·¥æ™‚</th>
                  <th class="text-right">å…¨å¹´åŠ æ¬Šå·¥æ™‚</th>
                  <th class="text-right">å·¥æ™‚å·®ç•°</th>
                  <th class="text-right">ç”¢ç”Ÿæ”¶å…¥</th>
                  <th class="text-right">å¹´åº¦æˆæœ¬</th>
                  <th class="text-right">å¹´åº¦æ¯›åˆ©</th>
                  <th class="text-right">æ¯›åˆ©ç‡</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="a-emp-performance">
                <tr><td colspan="9" class="muted">è«‹é¸æ“‡å¹´åº¦å¾Œè¼‰å…¥è³‡æ–™</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Section 4: å¹´åº¦å®¢æˆ·æ¯›åˆ©æŠ¥è¡¨ -->
        <div class="card" style="margin-bottom:24px;">
          <h3 class="card-title" style="margin:0 0 16px 0;font-size:18px;font-weight:600;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">
            ğŸ’¼ å¹´åº¦å®¢æˆ¶æ¯›åˆ©åˆ†æ
            <span id="profit-status" style="font-size:14px;font-weight:normal;color:#64748b;margin-left:12px;"></span>
          </h3>
          
          <h4 style="font-size:14px;font-weight:600;margin:0 0 12px 0;color:#64748b;">æŒ‰å®¢æˆ¶å¹´åº¦å½™ç¸½</h4>
          <div class="report-table-wrapper">
            <table class="report-table">
              <thead>
                <tr>
                  <th>å®¢æˆ¶åç¨±</th>
                  <th class="text-right">å…¨å¹´å·¥æ™‚</th>
                  <th class="text-right">åŠ æ¬Šå·¥æ™‚</th>
                  <th class="text-right">ç¸½æˆæœ¬</th>
                  <th class="text-right">å…¨å¹´æ”¶å…¥</th>
                  <th class="text-right">æ¯›åˆ©</th>
                  <th class="text-right">æ¯›åˆ©ç‡</th>
                  <th class="text-right">æœˆå‡æ”¶å…¥</th>
                </tr>
              </thead>
              <tbody id="a-client-profit">
                <tr><td colspan="8" class="muted">è«‹é¸æ“‡å¹´åº¦å¾Œè¼‰å…¥è³‡æ–™</td></tr>
              </tbody>
            </table>
          </div>

          <h4 style="font-size:14px;font-weight:600;margin:20px 0 12px 0;color:#64748b;">æŒ‰æœå‹™é¡å‹å¹´åº¦å½™ç¸½</h4>
          <div class="report-table-wrapper">
            <table class="report-table">
              <thead>
                <tr>
                  <th>æœå‹™é¡å‹</th>
                  <th class="text-right">å…¨å¹´å·¥æ™‚</th>
                  <th class="text-right">åŠ æ¬Šå·¥æ™‚</th>
                </tr>
              </thead>
              <tbody id="a-client-service">
                <tr><td colspan="3" class="muted">è«‹é¸æ“‡å¹´åº¦å¾Œè¼‰å…¥è³‡æ–™</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <script>
      (function() {
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        // å­˜å‚¨å®¢æˆ·åˆ†å¸ƒæ•°æ®
        const clientDistributionData = {};

        const tabs = document.querySelectorAll('.reports-tabs .tab');
        const panels = {
          monthly: document.getElementById('panel-monthly'),
          annual: document.getElementById('panel-annual')
        };

        let currentTab = 'monthly';

        // Tab åˆ‡æ¢
        tabs.forEach(btn => {
          btn.addEventListener('click', () => {
            const targetTab = btn.getAttribute('data-tab');
            currentTab = targetTab;
            
            tabs.forEach(t => {
              t.classList.remove('active');
              t.setAttribute('aria-selected', 'false');
            });
            btn.classList.add('active');
            btn.setAttribute('aria-selected', 'true');

            Object.entries(panels).forEach(([key, panel]) => {
              if (key === targetTab) {
                panel.classList.add('show');
              } else {
                panel.classList.remove('show');
              }
            });
          });
        });

        // åˆå§‹åŒ–å¹´ä»½é€‰æ‹©å™¨
        function initYearSelectors() {
          const currentYear = new Date().getFullYear();
          const monthlyYearSelect = document.getElementById('monthly-year');
          const annualYearSelect = document.getElementById('annual-year');
          
          for (let year = currentYear; year >= 2020; year--) {
            const option1 = document.createElement('option');
            option1.value = year;
            option1.textContent = `${year}å¹´`;
            monthlyYearSelect.appendChild(option1);

            const option2 = document.createElement('option');
            option2.value = year;
            option2.textContent = `${year}å¹´`;
            annualYearSelect.appendChild(option2);
          }

          // è®¾ç½®é»˜è®¤ä¸ºå½“å‰å¹´æœˆ
          const currentMonth = new Date().getMonth() + 1;
          document.getElementById('monthly-month').value = currentMonth;
        }

        // æ ¼å¼åŒ–é‡‘é¢
      function formatCurrency(val) {
        const num = Number(val || 0);
        if (num === 0) return 'â€”';
        return num.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
      }

        // æ ¼å¼åŒ–ç™¾åˆ†æ¯”
        function formatPercent(val) {
          return Number(val || 0).toFixed(2) + '%';
        }

        // ============================================================
        // æœˆåº¦æŠ¥è¡¨åŠ è½½
        // ============================================================
        async function loadMonthlyReports() {
          const year = document.getElementById('monthly-year').value;
          const month = document.getElementById('monthly-month').value;

          if (!year || !month) {
            alert('è«‹é¸æ“‡å¹´ä»½å’Œæœˆä»½');
            return;
          }

          try {
            await Promise.all([
              loadMonthlyRevenue(year, month),
              loadMonthlyPayroll(year, month),
              loadMonthlyEmployeePerformance(year, month),
              loadMonthlyClientProfitability(year, month)
            ]);
          } catch (err) {
            console.error('è¼‰å…¥æœˆåº¦å ±è¡¨å¤±æ•—:', err);
            alert('è¼‰å…¥å ±è¡¨å¤±æ•—ï¼š' + err.message);
          }
        }

      async function loadMonthlyRevenue(year, month) {
        const res = await fetch(`${apiBase}/reports/monthly/revenue?year=${year}&month=${month}`, {
          credentials: 'include'
        });
        
        if (!res.ok) {
          const text = await res.text();
          console.error('API Error:', text);
          throw new Error(`è¼‰å…¥æ”¶æ¬¾å ±è¡¨å¤±æ•— (${res.status}): ${text.substring(0, 200)}`);
        }
        
            const json = await res.json();
        if (!json.ok) {
          throw new Error(json.message || 'è¼‰å…¥æ”¶æ¬¾å ±è¡¨å¤±æ•—');
        }

          const data = json.data;
          document.getElementById('m-rev-receivable').textContent = formatCurrency(data.summary.totalReceivable);
          document.getElementById('m-rev-received').textContent = formatCurrency(data.summary.totalReceived);
          document.getElementById('m-rev-rate').textContent = formatPercent(data.summary.collectionRate);
          document.getElementById('m-rev-overdue').textContent = formatCurrency(data.summary.overdueAmount);

          const tbody = document.getElementById('m-rev-details');
          if (data.clientDetails.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="muted">æœ¬æœˆç„¡æ”¶æ¬¾è¨˜éŒ„</td></tr>';
          } else {
            tbody.innerHTML = data.clientDetails.map(r => `
              <tr>
                <td>${r.clientName}</td>
                <td>${r.serviceName}</td>
                <td class="text-right">${formatCurrency(r.totalAmount)}</td>
                <td class="text-right">${formatCurrency(r.paidAmount)}</td>
                <td class="text-right">${formatCurrency(r.unpaidAmount)}</td>
                <td class="text-right">${formatPercent(r.collectionRate)}</td>
                <td>${r.isOverdue ? '<span style="color:#dc2626;">æ˜¯</span>' : 'å¦'}</td>
              </tr>
            `).join('');
          }
        }

      async function loadMonthlyPayroll(year, month) {
        const res = await fetch(`${apiBase}/reports/monthly/payroll?year=${year}&month=${month}`, {
          credentials: 'include'
        });
        
        if (!res.ok) {
          const text = await res.text();
          console.error('API Error:', text);
          throw new Error(`è¼‰å…¥è–ªè³‡å ±è¡¨å¤±æ•— (${res.status}): ${text.substring(0, 200)}`);
        }
        
        const json = await res.json();
        if (!json.ok) {
          throw new Error(json.message || 'è¼‰å…¥è–ªè³‡å ±è¡¨å¤±æ•—');
        }

          const data = json.data;
          document.getElementById('m-pay-gross').textContent = formatCurrency(data.summary.totalGrossSalary);
          document.getElementById('m-pay-net').textContent = formatCurrency(data.summary.totalNetSalary);
          document.getElementById('m-pay-count').textContent = data.summary.employeeCount;
          document.getElementById('m-pay-avg-gross').textContent = formatCurrency(data.summary.avgGrossSalary);
          document.getElementById('m-pay-avg-net').textContent = formatCurrency(data.summary.avgNetSalary);

          const tbody = document.getElementById('m-pay-details');
          if (data.payrollDetails.length === 0) {
            tbody.innerHTML = '<tr><td colspan="13" class="muted">æœ¬æœˆç„¡è–ªè³‡è¨˜éŒ„</td></tr>';
          } else {
            tbody.innerHTML = data.payrollDetails.map(p => `
              <tr>
                <td>${p.name}</td>
                <td class="text-right">${formatCurrency(p.baseSalary)}</td>
                <td class="text-right">${formatCurrency(p.regularAllowance + p.irregularAllowance)}</td>
                <td class="text-right">${formatCurrency(p.bonusAmount)}</td>
                <td class="text-right">${formatCurrency(p.fullAttendanceBonus)}</td>
                <td class="text-right">${formatCurrency(p.overtimePay)}</td>
                <td class="text-right">${formatCurrency(p.mealAllowance)}</td>
                <td class="text-right">${formatCurrency(p.transportSubsidy)}</td>
                <td class="text-right">${formatCurrency(p.performanceBonus)}</td>
                <td class="text-right">${formatCurrency(p.yearEndBonus)}</td>
                <td class="text-right">${formatCurrency(-(p.fixedDeduction + p.leaveDeduction))}</td>
                <td class="text-right" style="background:#f0f9ff;font-weight:600;">${formatCurrency(p.grossSalary)}</td>
                <td class="text-right" style="background:#dbeafe;font-weight:600;">${formatCurrency(p.netSalary)}</td>
              </tr>
            `).join('');
          }

          // è–ªèµ„æ„æˆåˆ†æ
          const comp = data.composition;
          const total = data.summary.totalGrossSalary;
          const items = [
            { label: 'åº•è–ª', value: comp.baseSalary },
            { label: 'æ´¥è²¼', value: comp.regularAllowance + comp.irregularAllowance },
            { label: 'çé‡‘', value: comp.bonusAmount },
            { label: 'å…¨å‹¤çé‡‘', value: comp.fullAttendanceBonus },
            { label: 'åŠ ç­è²»', value: comp.overtimePay },
            { label: 'ä¼™é£Ÿæ´¥è²¼', value: comp.mealAllowance },
            { label: 'äº¤é€šè£œè²¼', value: comp.transportSubsidy },
            { label: 'ç¸¾æ•ˆçé‡‘', value: comp.performanceBonus },
            { label: 'å¹´çµ‚çé‡‘', value: comp.yearEndBonus },
            { label: 'æ‰£æ¬¾åˆè¨ˆ', value: -(comp.fixedDeduction + comp.leaveDeduction) }
          ];

          const compTbody = document.getElementById('m-pay-composition');
          compTbody.innerHTML = items.map(item => `
            <tr>
              <td>${item.label}</td>
              <td class="text-right">${formatCurrency(item.value)}</td>
              <td class="text-right">${total > 0 ? formatPercent(item.value / total * 100) : '0%'}</td>
            </tr>
          `).join('');
        }

      async function loadMonthlyEmployeePerformance(year, month) {
        const res = await fetch(`${apiBase}/reports/monthly/employee-performance?year=${year}&month=${month}`, {
          credentials: 'include'
        });
        
        if (!res.ok) {
          const text = await res.text();
          console.error('API Error:', text);
          throw new Error(`è¼‰å…¥å“¡å·¥ç”¢å€¼å ±è¡¨å¤±æ•— (${res.status}): ${text.substring(0, 200)}`);
        }
        
        const json = await res.json();
        if (!json.ok) {
          throw new Error(json.message || 'è¼‰å…¥å“¡å·¥ç”¢å€¼å ±è¡¨å¤±æ•—');
        }

          const data = json.data;
          const tbody = document.getElementById('m-emp-performance');
          
          if (data.employeePerformance.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="muted">æœ¬æœˆç„¡å·¥æ™‚è¨˜éŒ„</td></tr>';
          } else {
            tbody.innerHTML = data.employeePerformance.map(e => {
              // å­˜å‚¨å®¢æˆ·åˆ†å¸ƒæ•°æ®
              const key = `monthly_${e.userId}`;
              clientDistributionData[key] = { name: e.name, distribution: e.clientDistribution };
              
              return `
              <tr>
                <td>${e.name}</td>
                <td class="text-right">${e.standardHours.toFixed(1)}h</td>
                <td class="text-right">${e.weightedHours.toFixed(1)}h</td>
                <td class="text-right" style="color:${e.hoursDifference >= 0 ? '#dc2626' : '#16a34a'};">${e.hoursDifference >= 0 ? '+' : ''}${e.hoursDifference.toFixed(1)}h</td>
                <td class="text-right">${formatCurrency(e.generatedRevenue)}</td>
                <td class="text-right">${formatCurrency(e.laborCost)}</td>
                <td class="text-right">${formatCurrency(e.totalCost)}</td>
                <td class="text-right" style="color:${e.profit >= 0 ? '#16a34a' : '#dc2626'};">${formatCurrency(e.profit)}</td>
                <td class="text-right">${formatPercent(e.profitMargin)}</td>
                <td><button class="btn-link" onclick="showClientDistribution('monthly_${e.userId}')">æŸ¥çœ‹å®¢æˆ¶åˆ†å¸ƒ</button></td>
              </tr>
              `;
            }).join('');
          }
        }

      async function loadMonthlyClientProfitability(year, month) {
        const res = await fetch(`${apiBase}/reports/monthly/client-profitability?year=${year}&month=${month}`, {
          credentials: 'include'
        });
        
        if (!res.ok) {
          const text = await res.text();
          console.error('API Error:', text);
          throw new Error(`è¼‰å…¥å®¢æˆ¶æ¯›åˆ©å ±è¡¨å¤±æ•— (${res.status}): ${text.substring(0, 200)}`);
        }
        
            const json = await res.json();
        if (!json.ok) {
          throw new Error(json.message || 'è¼‰å…¥å®¢æˆ¶æ¯›åˆ©å ±è¡¨å¤±æ•—');
        }

          const data = json.data;
          const tbody = document.getElementById('m-client-profit');
          
          if (data.clients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="muted">æœ¬æœˆç„¡å®¢æˆ¶æˆæœ¬è¨˜éŒ„</td></tr>';
                    } else {
            tbody.innerHTML = data.clients.map(c => `
              <tr>
                <td>${c.clientName}</td>
                <td class="text-right">${c.totalHours.toFixed(1)}h</td>
                <td class="text-right">${c.weightedHours.toFixed(1)}h</td>
                <td class="text-right">${formatCurrency(c.avgHourlyRate)}</td>
                <td class="text-right">${formatCurrency(c.totalCost)}</td>
                <td class="text-right">${formatCurrency(c.revenue)}</td>
                <td class="text-right" style="color:${c.profit >= 0 ? '#16a34a' : '#dc2626'};">${formatCurrency(c.profit)}</td>
                <td class="text-right">${formatPercent(c.profitMargin)}</td>
                                </tr>
            `).join('');
          }
        }

      // ============================================================
      // å¹´åº¦æŠ¥è¡¨åŠ è½½ - ç‹¬ç«‹æŒ‰é’®
      // ============================================================
      
      // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºçŠ¶æ€
      function updateStatus(elementId, status, color = '#64748b') {
        const el = document.getElementById(elementId);
        if (el) {
          el.textContent = status;
          el.style.color = color;
        }
      }
      
      // å•ç‹¬åŠ è½½ï¼šæ”¶æ¬¾æŠ¥è¡¨
      async function loadAnnualRevenueOnly() {
        const year = document.getElementById('annual-year').value;
        if (!year) {
          alert('è«‹é¸æ“‡å¹´åº¦');
          return;
        }
        
        const loadingIndicator = document.getElementById('annual-loading');
        loadingIndicator.style.display = 'block';
        loadingIndicator.innerHTML = 'â³ æ­£åœ¨è¼‰å…¥æ”¶æ¬¾å ±è¡¨...';
        updateStatus('revenue-status', 'è¼‰å…¥ä¸­...', '#f59e0b');
        
        try {
          await loadAnnualRevenue(year);
          updateStatus('revenue-status', 'âœ… å·²è¼‰å…¥', '#16a34a');
          loadingIndicator.innerHTML = 'âœ… æ”¶æ¬¾å ±è¡¨è¼‰å…¥å®Œæˆ';
          setTimeout(() => { loadingIndicator.style.display = 'none'; }, 2000);
        } catch (err) {
          console.error('è¼‰å…¥æ”¶æ¬¾å ±è¡¨å¤±æ•—:', err);
          updateStatus('revenue-status', 'âŒ è¼‰å…¥å¤±æ•—', '#dc2626');
          loadingIndicator.innerHTML = 'âŒ æ”¶æ¬¾å ±è¡¨è¼‰å…¥å¤±æ•—';
          alert('è¼‰å…¥å¤±æ•—ï¼š' + err.message);
          setTimeout(() => { loadingIndicator.style.display = 'none'; }, 3000);
        }
      }
      
      // å•ç‹¬åŠ è½½ï¼šè–ªèµ„æŠ¥è¡¨
      async function loadAnnualPayrollOnly() {
        const year = document.getElementById('annual-year').value;
        if (!year) {
          alert('è«‹é¸æ“‡å¹´åº¦');
          return;
        }
        
        const loadingIndicator = document.getElementById('annual-loading');
        loadingIndicator.style.display = 'block';
        loadingIndicator.innerHTML = 'â³ æ­£åœ¨è¼‰å…¥è–ªè³‡å ±è¡¨...ï¼ˆå¯èƒ½éœ€è¦20-30ç§’ï¼‰';
        updateStatus('payroll-status', 'è¼‰å…¥ä¸­...', '#f59e0b');
        
        try {
          await loadAnnualPayroll(year);
          updateStatus('payroll-status', 'âœ… å·²è¼‰å…¥', '#16a34a');
          loadingIndicator.innerHTML = 'âœ… è–ªè³‡å ±è¡¨è¼‰å…¥å®Œæˆ';
          setTimeout(() => { loadingIndicator.style.display = 'none'; }, 2000);
        } catch (err) {
          console.error('è¼‰å…¥è–ªè³‡å ±è¡¨å¤±æ•—:', err);
          updateStatus('payroll-status', 'âŒ è¼‰å…¥å¤±æ•—', '#dc2626');
          loadingIndicator.innerHTML = 'âŒ è–ªè³‡å ±è¡¨è¼‰å…¥å¤±æ•—';
          alert('è¼‰å…¥å¤±æ•—ï¼š' + err.message);
          setTimeout(() => { loadingIndicator.style.display = 'none'; }, 3000);
        }
      }
      
      // å•ç‹¬åŠ è½½ï¼šå‘˜å·¥äº§å€¼
      async function loadAnnualPerformanceOnly() {
        const year = document.getElementById('annual-year').value;
        if (!year) {
          alert('è«‹é¸æ“‡å¹´åº¦');
          return;
        }
        
        const loadingIndicator = document.getElementById('annual-loading');
        loadingIndicator.style.display = 'block';
        loadingIndicator.innerHTML = 'â³ æ­£åœ¨è¼‰å…¥å“¡å·¥ç”¢å€¼å ±è¡¨...ï¼ˆå¯èƒ½éœ€è¦30-60ç§’ï¼‰';
        updateStatus('performance-status', 'è¼‰å…¥ä¸­...', '#f59e0b');
        
        try {
          await loadAnnualEmployeePerformance(year);
          updateStatus('performance-status', 'âœ… å·²è¼‰å…¥', '#16a34a');
          loadingIndicator.innerHTML = 'âœ… å“¡å·¥ç”¢å€¼å ±è¡¨è¼‰å…¥å®Œæˆ';
          setTimeout(() => { loadingIndicator.style.display = 'none'; }, 2000);
        } catch (err) {
          console.error('è¼‰å…¥å“¡å·¥ç”¢å€¼å ±è¡¨å¤±æ•—:', err);
          updateStatus('performance-status', 'âŒ è¼‰å…¥å¤±æ•—', '#dc2626');
          loadingIndicator.innerHTML = 'âŒ å“¡å·¥ç”¢å€¼å ±è¡¨è¼‰å…¥å¤±æ•—';
          alert('è¼‰å…¥å¤±æ•—ï¼š' + err.message);
          setTimeout(() => { loadingIndicator.style.display = 'none'; }, 3000);
        }
      }
      
      // å•ç‹¬åŠ è½½ï¼šå®¢æˆ·æ¯›åˆ©
      async function loadAnnualProfitOnly() {
        const year = document.getElementById('annual-year').value;
        if (!year) {
          alert('è«‹é¸æ“‡å¹´åº¦');
          return;
        }
        
        const loadingIndicator = document.getElementById('annual-loading');
        loadingIndicator.style.display = 'block';
        loadingIndicator.innerHTML = 'â³ æ­£åœ¨è¼‰å…¥å®¢æˆ¶æ¯›åˆ©å ±è¡¨...';
        updateStatus('profit-status', 'è¼‰å…¥ä¸­...', '#f59e0b');
        
        try {
          await loadAnnualClientProfitability(year);
          updateStatus('profit-status', 'âœ… å·²è¼‰å…¥', '#16a34a');
          loadingIndicator.innerHTML = 'âœ… å®¢æˆ¶æ¯›åˆ©å ±è¡¨è¼‰å…¥å®Œæˆ';
          setTimeout(() => { loadingIndicator.style.display = 'none'; }, 2000);
        } catch (err) {
          console.error('è¼‰å…¥å®¢æˆ¶æ¯›åˆ©å ±è¡¨å¤±æ•—:', err);
          updateStatus('profit-status', 'âŒ è¼‰å…¥å¤±æ•—', '#dc2626');
          loadingIndicator.innerHTML = 'âŒ å®¢æˆ¶æ¯›åˆ©å ±è¡¨è¼‰å…¥å¤±æ•—';
          alert('è¼‰å…¥å¤±æ•—ï¼š' + err.message);
          setTimeout(() => { loadingIndicator.style.display = 'none'; }, 3000);
        }
      }
      
      // å…¨éƒ¨åŠ è½½
      async function loadAnnualReportsAll() {
        const year = document.getElementById('annual-year').value;
        if (!year) {
          alert('è«‹é¸æ“‡å¹´åº¦');
          return;
        }

        const loadingIndicator = document.getElementById('annual-loading');
        loadingIndicator.style.display = 'block';
        loadingIndicator.innerHTML = 'â³ è¼‰å…¥ä¸­ (0/4)...ï¼ˆé è¨ˆéœ€è¦1-2åˆ†é˜ï¼‰';

        try {
          const tasks = [
            { name: 'æ”¶æ¬¾å ±è¡¨', fn: () => loadAnnualRevenue(year), status: 'revenue-status' },
            { name: 'è–ªè³‡å ±è¡¨', fn: () => loadAnnualPayroll(year), status: 'payroll-status' },
            { name: 'å“¡å·¥ç”¢å€¼å ±è¡¨', fn: () => loadAnnualEmployeePerformance(year), status: 'performance-status' },
            { name: 'å®¢æˆ¶æ¯›åˆ©å ±è¡¨', fn: () => loadAnnualClientProfitability(year), status: 'profit-status' }
          ];
          
          for (let i = 0; i < tasks.length; i++) {
            loadingIndicator.innerHTML = `â³ æ­£åœ¨è¼‰å…¥${tasks[i].name} (${i + 1}/4)...`;
            updateStatus(tasks[i].status, 'è¼‰å…¥ä¸­...', '#f59e0b');
            await tasks[i].fn();
            updateStatus(tasks[i].status, 'âœ… å·²è¼‰å…¥', '#16a34a');
          }
          
          loadingIndicator.innerHTML = 'âœ… å…¨éƒ¨è¼‰å…¥å®Œæˆ';
          setTimeout(() => {
            loadingIndicator.style.display = 'none';
          }, 2000);
        } catch (err) {
          console.error('è¼‰å…¥å¹´åº¦å ±è¡¨å¤±æ•—:', err);
          loadingIndicator.innerHTML = 'âŒ è¼‰å…¥å¤±æ•—';
          alert('è¼‰å…¥å ±è¡¨å¤±æ•—ï¼š' + err.message);
          setTimeout(() => {
            loadingIndicator.style.display = 'none';
          }, 3000);
        }
      }

      async function loadAnnualRevenue(year) {
        const res = await fetch(`${apiBase}/reports/annual/revenue?year=${year}`, {
          credentials: 'include'
        });
        
        if (!res.ok) {
          const text = await res.text();
          console.error('API Error:', text);
          throw new Error(`è¼‰å…¥å¹´åº¦æ”¶æ¬¾å ±è¡¨å¤±æ•— (${res.status}): ${text.substring(0, 200)}`);
        }
        
            const json = await res.json();
        if (!json.ok) {
          throw new Error(json.message || 'è¼‰å…¥å¹´åº¦æ”¶æ¬¾å ±è¡¨å¤±æ•—');
        }

          const data = json.data;
          document.getElementById('a-rev-receivable').textContent = formatCurrency(data.summary.totalReceivable);
          document.getElementById('a-rev-received').textContent = formatCurrency(data.summary.totalReceived);
          document.getElementById('a-rev-rate').textContent = formatPercent(data.summary.collectionRate);
          document.getElementById('a-rev-overdue').textContent = formatCurrency(data.summary.overdueAmount);

          // æœˆåº¦è¶‹åŠ¿
          const trendTbody = document.getElementById('a-rev-trend');
          if (data.monthlyTrend.length === 0) {
            trendTbody.innerHTML = '<tr><td colspan="5" class="muted">æœ¬å¹´ç„¡æ”¶æ¬¾è¨˜éŒ„</td></tr>';
            } else {
            trendTbody.innerHTML = data.monthlyTrend.map(m => `
              <tr>
                <td>${m.month}æœˆ</td>
                <td class="text-right">${formatCurrency(m.totalReceivable)}</td>
                <td class="text-right">${formatCurrency(m.totalReceived)}</td>
                <td class="text-right">${formatPercent(m.collectionRate)}</td>
                <td class="text-right">${formatCurrency(m.overdueAmount)}</td>
              </tr>
            `).join('');
          }

          // æŒ‰å®¢æˆ·æ±‡æ€»
          const clientTbody = document.getElementById('a-rev-client');
          if (data.clientSummary.length === 0) {
            clientTbody.innerHTML = '<tr><td colspan="6" class="muted">æœ¬å¹´ç„¡å®¢æˆ¶è¨˜éŒ„</td></tr>';
          } else {
            clientTbody.innerHTML = data.clientSummary.map(c => `
              <tr>
                <td>${c.clientName}</td>
                <td class="text-right">${formatCurrency(c.totalReceivable)}</td>
                <td class="text-right">${formatCurrency(c.totalReceived)}</td>
                <td class="text-right">${formatPercent(c.collectionRate)}</td>
                <td class="text-right">${formatCurrency(c.unpaidAmount)}</td>
                <td class="text-right">${formatCurrency(c.avgMonthlyRevenue)}</td>
              </tr>
            `).join('');
          }

          // æŒ‰æœåŠ¡ç±»å‹æ±‡æ€»
          const serviceTbody = document.getElementById('a-rev-service');
          if (data.serviceTypeSummary.length === 0) {
            serviceTbody.innerHTML = '<tr><td colspan="5" class="muted">æœ¬å¹´ç„¡æœå‹™è¨˜éŒ„</td></tr>';
          } else {
            serviceTbody.innerHTML = data.serviceTypeSummary.map(s => `
              <tr>
                <td>${s.serviceName}</td>
                <td class="text-right">${formatCurrency(s.totalReceivable)}</td>
                <td class="text-right">${formatCurrency(s.totalReceived)}</td>
                <td class="text-right">${formatPercent(s.collectionRate)}</td>
                <td class="text-right">${formatCurrency(s.unpaidAmount)}</td>
              </tr>
            `).join('');
          }
        }

      async function loadAnnualPayroll(year) {
        const res = await fetch(`${apiBase}/reports/annual/payroll?year=${year}`, {
          credentials: 'include'
        });
        
        if (!res.ok) {
          const text = await res.text();
          console.error('API Error:', text);
          throw new Error(`è¼‰å…¥å¹´åº¦è–ªè³‡å ±è¡¨å¤±æ•— (${res.status}): ${text.substring(0, 200)}`);
        }
        
        const json = await res.json();
        if (!json.ok) {
          throw new Error(json.message || 'è¼‰å…¥å¹´åº¦è–ªè³‡å ±è¡¨å¤±æ•—');
        }

          const data = json.data;
          document.getElementById('a-pay-gross').textContent = formatCurrency(data.summary.annualGrossSalary);
          document.getElementById('a-pay-net').textContent = formatCurrency(data.summary.annualNetSalary);
          document.getElementById('a-pay-avg').textContent = formatCurrency(data.summary.avgMonthlySalary);
          document.getElementById('a-pay-count').textContent = data.summary.avgEmployeeCount;

          // æœˆåº¦è¶‹åŠ¿
          const trendTbody = document.getElementById('a-pay-trend');
          trendTbody.innerHTML = data.monthlyTrend.map(m => `
            <tr>
              <td>${m.month}æœˆ</td>
              <td class="text-right">${formatCurrency(m.totalGrossSalary)}</td>
              <td class="text-right">${formatCurrency(m.totalNetSalary)}</td>
              <td class="text-right">${m.employeeCount}</td>
              <td class="text-right">${formatCurrency(m.avgGrossSalary)}</td>
            </tr>
          `).join('');

          // æŒ‰å‘˜å·¥æ±‡æ€»
          const empTbody = document.getElementById('a-pay-employee');
          if (data.employeeSummary.length === 0) {
            empTbody.innerHTML = '<tr><td colspan="8" class="muted">æœ¬å¹´ç„¡å“¡å·¥è¨˜éŒ„</td></tr>';
            } else {
            empTbody.innerHTML = data.employeeSummary.map(e => `
              <tr>
                <td>${e.name}</td>
                <td class="text-right">${formatCurrency(e.annualGrossSalary)}</td>
                <td class="text-right">${formatCurrency(e.annualNetSalary)}</td>
                <td class="text-right">${formatCurrency(e.avgMonthlySalary)}</td>
                <td class="text-right">${formatCurrency(e.totalOvertimePay)}</td>
                <td class="text-right">${formatCurrency(e.totalPerformanceBonus)}</td>
                <td class="text-right">${formatCurrency(e.totalYearEndBonus)}</td>
                <td><button class="btn-link" onclick="alert('æŸ¥çœ‹æœˆåº¦æ˜ç´°åŠŸèƒ½é–‹ç™¼ä¸­')">æŸ¥çœ‹æ˜ç´°</button></td>
              </tr>
            `).join('');
          }
        }

      async function loadAnnualEmployeePerformance(year) {
        const res = await fetch(`${apiBase}/reports/annual/employee-performance?year=${year}`, {
          credentials: 'include'
        });
        
        if (!res.ok) {
          const text = await res.text();
          console.error('API Error:', text);
          throw new Error(`è¼‰å…¥å¹´åº¦å“¡å·¥ç”¢å€¼å ±è¡¨å¤±æ•— (${res.status}): ${text.substring(0, 200)}`);
        }
        
            const json = await res.json();
        if (!json.ok) {
          throw new Error(json.message || 'è¼‰å…¥å¹´åº¦å“¡å·¥ç”¢å€¼å ±è¡¨å¤±æ•—');
        }

          const data = json.data;
          const tbody = document.getElementById('a-emp-performance');
          
          if (data.employeeSummary.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="muted">æœ¬å¹´ç„¡å“¡å·¥å·¥æ™‚è¨˜éŒ„</td></tr>';
            } else {
            tbody.innerHTML = data.employeeSummary.map(e => {
              // å­˜å‚¨å®¢æˆ·åˆ†å¸ƒæ•°æ®
              const key = `annual_${e.userId}`;
              clientDistributionData[key] = { name: e.name, distribution: e.clientDistribution };
              
              return `
              <tr>
                <td>${e.name}</td>
                <td class="text-right">${e.annualStandardHours.toFixed(1)}h</td>
                <td class="text-right">${e.annualWeightedHours.toFixed(1)}h</td>
                <td class="text-right" style="color:${e.hoursDifference >= 0 ? '#dc2626' : '#16a34a'};">${e.hoursDifference >= 0 ? '+' : ''}${e.hoursDifference.toFixed(1)}h</td>
                <td class="text-right">${formatCurrency(e.annualRevenue)}</td>
                <td class="text-right">${formatCurrency(e.annualCost)}</td>
                <td class="text-right" style="color:${e.annualProfit >= 0 ? '#16a34a' : '#dc2626'};">${formatCurrency(e.annualProfit)}</td>
                <td class="text-right">${formatPercent(e.annualProfitMargin)}</td>
                <td>
                  <button class="btn-link" onclick="alert('æŸ¥çœ‹æœˆåº¦è¶¨å‹¢åŠŸèƒ½é–‹ç™¼ä¸­')">è¶¨å‹¢</button>
                  <button class="btn-link" onclick="showAnnualClientDistribution('annual_${e.userId}')">å®¢æˆ¶åˆ†å¸ƒ</button>
                </td>
              </tr>
              `;
            }).join('');
          }
        }

      async function loadAnnualClientProfitability(year) {
        const res = await fetch(`${apiBase}/reports/annual/client-profitability?year=${year}`, {
          credentials: 'include'
        });
        
        if (!res.ok) {
          const text = await res.text();
          console.error('API Error:', text);
          throw new Error(`è¼‰å…¥å¹´åº¦å®¢æˆ¶æ¯›åˆ©å ±è¡¨å¤±æ•— (${res.status}): ${text.substring(0, 200)}`);
        }
        
        const json = await res.json();
        if (!json.ok) {
          throw new Error(json.message || 'è¼‰å…¥å¹´åº¦å®¢æˆ¶æ¯›åˆ©å ±è¡¨å¤±æ•—');
        }

          const data = json.data;
          const tbody = document.getElementById('a-client-profit');
          
          if (data.clientSummary.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="muted">æœ¬å¹´ç„¡å®¢æˆ¶æˆæœ¬è¨˜éŒ„</td></tr>';
          } else {
            tbody.innerHTML = data.clientSummary.map(c => `
              <tr>
                <td>${c.clientName}</td>
                <td class="text-right">${c.annualHours.toFixed(1)}h</td>
                <td class="text-right">${c.annualWeightedHours.toFixed(1)}h</td>
                <td class="text-right">${formatCurrency(c.annualCost)}</td>
                <td class="text-right">${formatCurrency(c.annualRevenue)}</td>
                <td class="text-right" style="color:${c.annualProfit >= 0 ? '#16a34a' : '#dc2626'};">${formatCurrency(c.annualProfit)}</td>
                <td class="text-right">${formatPercent(c.annualProfitMargin)}</td>
                <td class="text-right">${formatCurrency(c.avgMonthlyRevenue)}</td>
              </tr>
            `).join('');
          }

          // æŒ‰æœåŠ¡ç±»å‹æ±‡æ€»
          const serviceTbody = document.getElementById('a-client-service');
          if (data.serviceTypeSummary.length === 0) {
            serviceTbody.innerHTML = '<tr><td colspan="3" class="muted">æœ¬å¹´ç„¡æœå‹™è¨˜éŒ„</td></tr>';
          } else {
            serviceTbody.innerHTML = data.serviceTypeSummary.map(s => `
              <tr>
                <td>${s.serviceName}</td>
                <td class="text-right">${s.totalHours.toFixed(1)}h</td>
                <td class="text-right">${s.weightedHours.toFixed(1)}h</td>
              </tr>
            `).join('');
          }
        }

        // æ˜¾ç¤ºå®¢æˆ·åˆ†å¸ƒå¼¹çª—ï¼ˆæœˆåº¦ï¼‰
        window.showClientDistribution = function(key) {
          const data = clientDistributionData[key];
          if (!data || !data.distribution || data.distribution.length === 0) {
            alert((data?.name || 'è©²å“¡å·¥') + ' æœ¬æœˆç„¡å®¢æˆ¶åˆ†å¸ƒè³‡æ–™');
            return;
          }

          const html = `
            <div style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
              <div style="background:#fff;border-radius:12px;padding:24px;max-width:800px;width:90%;max-height:80vh;overflow:auto;">
                <h3 style="margin:0 0 16px 0;">${data.name} - å®¢æˆ¶åˆ†å¸ƒæ˜ç´°</h3>
                <table class="report-table" style="margin-bottom:16px;">
                  <thead>
                    <tr>
                      <th>å®¢æˆ¶åç¨±</th>
                      <th>æœå‹™é¡å‹</th>
                      <th class="text-right">å·¥æ™‚</th>
                      <th class="text-right">åŠ æ¬Šå·¥æ™‚</th>
                      <th class="text-right">ç”¢ç”Ÿæ”¶å…¥</th>
                      <th class="text-right">å æ¯”</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${data.distribution.map(d => `
                      <tr>
                        <td>${d.clientName}</td>
                        <td>${d.serviceName}</td>
                        <td class="text-right">${d.hours.toFixed(1)}h</td>
                        <td class="text-right">${d.weightedHours.toFixed(1)}h</td>
                        <td class="text-right">${formatCurrency(d.generatedRevenue)}</td>
                        <td class="text-right">${d.revenuePercentage ? formatPercent(d.revenuePercentage) : 'â€”'}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
                <button class="btn primary" onclick="this.closest('div[style*=fixed]').remove()">é—œé–‰</button>
              </div>
            </div>
          `;
          document.body.insertAdjacentHTML('beforeend', html);
        };

        // æ˜¾ç¤ºå®¢æˆ·åˆ†å¸ƒå¼¹çª—ï¼ˆå¹´åº¦ï¼‰
        window.showAnnualClientDistribution = function(key) {
          const data = clientDistributionData[key];
          if (!data || !data.distribution || data.distribution.length === 0) {
            alert((data?.name || 'è©²å“¡å·¥') + ' æœ¬å¹´ç„¡å®¢æˆ¶åˆ†å¸ƒè³‡æ–™');
            return;
          }

          const html = `
            <div style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
              <div style="background:#fff;border-radius:12px;padding:24px;max-width:800px;width:90%;max-height:80vh;overflow:auto;">
                <h3 style="margin:0 0 16px 0;">${data.name} - å¹´åº¦å®¢æˆ¶åˆ†å¸ƒ</h3>
                <table class="report-table" style="margin-bottom:16px;">
                  <thead>
                    <tr>
                      <th>å®¢æˆ¶åç¨±</th>
                      <th>æœå‹™é¡å‹</th>
                      <th class="text-right">å…¨å¹´å·¥æ™‚</th>
                      <th class="text-right">ç”¢ç”Ÿæ”¶å…¥</th>
                      <th class="text-right">å æ¯”</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${data.distribution.map(d => `
                      <tr>
                        <td>${d.clientName}</td>
                        <td>${d.serviceName}</td>
                        <td class="text-right">${d.hours.toFixed(1)}h</td>
                        <td class="text-right">${formatCurrency(d.generatedRevenue)}</td>
                        <td class="text-right">${formatPercent(d.revenuePercentage)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
                <button class="btn primary" onclick="this.closest('div[style*=fixed]').remove()">é—œé–‰</button>
              </div>
            </div>
          `;
          document.body.insertAdjacentHTML('beforeend', html);
        };

        // äº‹ä»¶ç›‘å¬
        document.getElementById('monthly-load').addEventListener('click', loadMonthlyReports);
        
        // å¹´åº¦æŠ¥è¡¨ - ç‹¬ç«‹æŒ‰é’®
        document.getElementById('annual-load-revenue').addEventListener('click', loadAnnualRevenueOnly);
        document.getElementById('annual-load-payroll').addEventListener('click', loadAnnualPayrollOnly);
        document.getElementById('annual-load-performance').addEventListener('click', loadAnnualPerformanceOnly);
        document.getElementById('annual-load-profit').addEventListener('click', loadAnnualProfitOnly);
        document.getElementById('annual-load-all').addEventListener('click', loadAnnualReportsAll);

        // æƒé™æ£€æŸ¥
        async function checkPermission() {
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials: 'include' });
            if (res.status === 401) {
              location.assign('/login?redirect=/internal/reports');
              return;
            }
            const json = await res.json();
            if (!json.ok || !json.data.isAdmin) {
              document.getElementById('permBar').style.display = 'block';
              return;
            }
          } catch (err) {
            console.error('æ¬Šé™æª¢æŸ¥å¤±æ•—:', err);
          }
        }

        // åˆå§‹åŒ–
        initYearSelectors();
        checkPermission();
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>
