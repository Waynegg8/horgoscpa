<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="報表分析中心" />
    <title>報表分析｜首頁</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/reports-page.css" />
  </head>
  <body class="reports-page">
    <header class="reports-header">
      <h1 class="page-title">報表分析</h1>
      <div id="permBar" class="info-bar" style="display:none;" role="alert">您沒有權限檢視此報表</div>
    </header>

    <nav class="reports-tab-container" role="tablist" aria-label="報表分頁">
      <div class="reports-tab-header">
        <button class="tab" role="tab" aria-selected="false" data-tab="client-cost" data-admin-only="true">客戶成本分析</button>
        <button class="tab" role="tab" aria-selected="true" data-tab="employee-hours">員工工時分析</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="payroll" data-admin-only="true">薪資報表</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="receivables" data-admin-only="true">收款分析</button>
      </div>
    </nav>

    <main class="reports-content">
      <!-- 客戶成本分析（管理員） -->
      <section id="panel-client-cost" class="reports-section panel" role="tabpanel" aria-labelledby="tab-client-cost">
        <div class="report-filters" aria-label="客戶成本分析篩選">
          <div class="filter-row">
            <div class="filter-group">
              <label for="cc-date-from">開始日期</label>
              <input id="cc-date-from" type="date" />
            </div>
            <div class="filter-group">
              <label for="cc-date-to">結束日期</label>
              <input id="cc-date-to" type="date" />
            </div>
            <div class="filter-group">
              <label for="cc-client">客戶（可選）</label>
              <input id="cc-client" type="search" placeholder="輸入客戶名稱或代碼" />
            </div>
            <div class="filter-group">
              <label>包含年終獎金分攤</label>
              <input id="cc-include-bonus" type="checkbox" aria-label="包含年終獎金分攤" />
            </div>
            <div class="filter-group" style="min-width:140px;flex:0">
              <button id="cc-query" class="btn primary" type="button">查詢</button>
              <button id="cc-reset" class="btn" type="button" style="margin-left:8px;">重置</button>
            </div>
          </div>
          <div id="cc-yearend-tip" class="info-bar" style="display:none;">建議勾選包含年終獎金以查看真實成本</div>
        </div>

        <section class="report-content">
          <div class="report-header">
            <h2>客戶成本分析</h2>
            <p class="subtitle">含加權工時、管理成本警示與毛利率</p>
          </div>
          <div class="report-body">
            <div class="report-summary">
              <div class="summary-card type-info">
                <div class="label">總成本</div>
                <div class="value">—</div>
                <div class="description">期間總管理＋薪資成本</div>
              </div>
              <div class="summary-card type-warning">
                <div class="label">管理成本警示</div>
                <div class="value">—</div>
                <div class="description">未輸入或不完整時提示</div>
              </div>
            </div>

            <div class="report-table-wrapper">
              <table class="report-table" aria-label="客戶成本明細">
                <thead>
                  <tr>
                    <th>客戶</th>
                    <th>實際工時</th>
                    <th>加權工時</th>
                    <th>薪資成本</th>
                    <th>管理成本</th>
                    <th>年終分攤</th>
                    <th>總成本</th>
                    <th>收據金額</th>
                    <th>毛利</th>
                    <th>毛利率</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="10" class="muted">尚無資料</td></tr>
                </tbody>
              </table>
            </div>

            <div class="chart-container">
              <div class="chart-title">客戶毛利率排名</div>
              <div class="chart-wrapper">
                <div class="placeholder muted" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">圖表占位</div>
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- 員工工時分析（管理員；員工看到精簡版「我的工時」） -->
      <section id="panel-employee-hours" class="reports-section panel show" role="tabpanel" aria-labelledby="tab-employee-hours">
        <div class="report-filters" aria-label="員工工時分析篩選">
          <div class="filter-row">
            <div class="filter-group">
              <label for="eh-year-month">年/月</label>
              <input id="eh-year-month" type="month" />
            </div>
            <div class="filter-group">
              <label for="eh-employee">員工（可選）</label>
              <input id="eh-employee" type="search" placeholder="輸入員工姓名或帳號" />
            </div>
            <div class="filter-group" style="min-width:140px;flex:0">
              <button id="eh-query" class="btn primary" type="button">查詢</button>
              <button id="eh-reset" class="btn" type="button" style="margin-left:8px;">重置</button>
            </div>
          </div>
        </div>

        <section class="report-content">
          <div class="report-header">
            <h2>員工工時分析</h2>
            <p class="subtitle">月度工時、客戶分布與每日趨勢</p>
          </div>
          <div class="report-body">
            <div class="report-summary">
              <div class="summary-card type-info">
                <div class="label">總工時</div>
                <div class="value">—</div>
                <div class="description">本月總計</div>
              </div>
              <div class="summary-card type-success">
                <div class="label">使用率</div>
                <div class="value">—</div>
                <div class="description">可計費占比</div>
              </div>
            </div>

            <div class="chart-container">
              <div class="chart-title">客戶工時分布（餅圖）</div>
              <div class="chart-wrapper">
                <div class="placeholder muted" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">圖表占位</div>
              </div>
            </div>

            <div class="chart-container">
              <div class="chart-title">每日工時（折線）</div>
              <div class="chart-wrapper">
                <div class="placeholder muted" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">圖表占位</div>
              </div>
            </div>

            <div class="employee-hours-list" aria-label="員工工時一覽">
              <div class="employee-hours-item">
                <div class="employee-hours-name">範例員工</div>
                <div class="employee-hours-value">— <span class="employee-hours-unit">小時</span></div>
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- 薪資報表（管理員） -->
      <section id="panel-payroll" class="reports-section panel" role="tabpanel" aria-labelledby="tab-payroll">
        <div class="report-filters" aria-label="薪資報表篩選">
          <div class="filter-row">
            <div class="filter-group">
              <label for="pr-year-month">年/月</label>
              <input id="pr-year-month" type="month" />
            </div>
            <div class="filter-group">
              <label for="pr-employee">員工（可選）</label>
              <input id="pr-employee" type="search" placeholder="輸入員工姓名或帳號" />
            </div>
            <div class="filter-group" style="min-width:140px;flex:0">
              <button id="pr-query" class="btn primary" type="button">查詢</button>
              <button id="pr-reset" class="btn" type="button" style="margin-left:8px;">重置</button>
            </div>
          </div>
        </div>

        <section class="report-content">
          <div class="report-header">
            <h2>薪資報表</h2>
            <p class="subtitle">月度薪資匯總與個人明細</p>
          </div>
          <div class="report-body">
            <div class="report-summary">
              <div class="summary-card type-info">
                <div class="label">總薪資</div>
                <div class="value">—</div>
                <div class="description">應發＋淨發概覽</div>
              </div>
            </div>

            <div class="report-table-wrapper">
              <table class="report-table" aria-label="薪資明細">
                <thead>
                  <tr>
                    <th>員工</th>
                    <th>底薪</th>
                    <th>津貼</th>
                    <th>獎金</th>
                    <th>加班費</th>
                    <th>應發</th>
                    <th>淨發</th>
                    <th>全勤</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="8" class="muted">尚無資料</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </section>

      <!-- 收款分析（管理員） -->
      <section id="panel-receivables" class="reports-section panel" role="tabpanel" aria-labelledby="tab-receivables">
        <div class="report-filters" aria-label="收款分析篩選">
          <div class="filter-row">
            <div class="filter-group">
              <label for="rc-date-from">開始日期</label>
              <input id="rc-date-from" type="date" />
            </div>
            <div class="filter-group">
              <label for="rc-date-to">結束日期</label>
              <input id="rc-date-to" type="date" />
            </div>
            <div class="filter-group" style="min-width:140px;flex:0">
              <button id="rc-query" class="btn primary" type="button">查詢</button>
              <button id="rc-reset" class="btn" type="button" style="margin-left:8px;">重置</button>
            </div>
          </div>
        </div>

        <section class="report-content">
          <div class="report-header">
            <h2>收款分析</h2>
            <p class="subtitle">應收、收款率、月度趨勢與客戶明細</p>
          </div>
          <div class="report-body">
            <div class="report-summary">
              <div class="summary-card type-info">
                <div class="label">總開立</div>
                <div class="value">—</div>
                <div class="description">查詢期間</div>
              </div>
              <div class="summary-card type-success">
                <div class="label">已收</div>
                <div class="value">—</div>
                <div class="description">查詢期間</div>
              </div>
              <div class="summary-card type-warning">
                <div class="label">應收</div>
                <div class="value">—</div>
                <div class="description">查詢期間</div>
              </div>
              <div class="summary-card type-info">
                <div class="label">收款率</div>
                <div class="value">—</div>
                <div class="description">已收/開立</div>
              </div>
            </div>

            <div class="chart-container">
              <div class="chart-title">月度趨勢：開立 vs 收款</div>
              <div class="chart-wrapper">
                <div class="placeholder muted" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">圖表占位</div>
              </div>
            </div>

            <div class="report-table-wrapper">
              <table class="report-table" aria-label="客戶收款明細">
                <thead>
                  <tr>
                    <th>客戶</th>
                    <th>開立</th>
                    <th>已收</th>
                    <th>應收</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="4" class="muted">尚無資料</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </section>
    </main>

    <script>
      (function(){
        const onProdHost = location.hostname.endsWith('horgoscpa.com');
        const apiBase = onProdHost ? '/internal/api/v1' : 'https://www.horgoscpa.com/internal/api/v1';

        const permBar = document.getElementById('permBar');
        const tabs = Array.from(document.querySelectorAll('.reports-tab-header .tab'));
        const panels = {
          'client-cost': document.getElementById('panel-client-cost'),
          'employee-hours': document.getElementById('panel-employee-hours'),
          'payroll': document.getElementById('panel-payroll'),
          'receivables': document.getElementById('panel-receivables'),
        };

        function setActiveTab(key){
          tabs.forEach(b=>{
            const selected = b.getAttribute('data-tab') === key;
            b.classList.toggle('active', selected);
            b.setAttribute('aria-selected', selected ? 'true' : 'false');
          });
          Object.entries(panels).forEach(([k,el])=>{
            if (!el) return;
            if (k === key) el.classList.add('show'); else el.classList.remove('show');
          });
          // 自動載入對應分頁資料
          if (key === 'client-cost') loadClientCost();
          else if (key === 'employee-hours') loadEmployeeHours();
          else if (key === 'payroll') loadPayroll();
          else if (key === 'receivables') loadRevenue();
        }

        tabs.forEach(btn => {
          btn.addEventListener('click', ()=>{
            const key = btn.getAttribute('data-tab');
            setActiveTab(key);
          });
        });

        function validateDateRange(fromEl, toEl){
          const a = fromEl.value, b = toEl.value;
          if (!a || !b) return false;
          try { return new Date(a) <= new Date(b); } catch(_) { return false; }
        }

        function attachValidation(){
          const ccFrom = document.getElementById('cc-date-from');
          const ccTo = document.getElementById('cc-date-to');
          const ccQuery = document.getElementById('cc-query');
          const ccReset = document.getElementById('cc-reset');
          const bonus = document.getElementById('cc-include-bonus');
          const tip = document.getElementById('cc-yearend-tip');

          const rcFrom = document.getElementById('rc-date-from');
          const rcTo = document.getElementById('rc-date-to');
          const rcQuery = document.getElementById('rc-query');
          const rcReset = document.getElementById('rc-reset');

          const ehYM = document.getElementById('eh-year-month');
          const ehQuery = document.getElementById('eh-query');
          const ehReset = document.getElementById('eh-reset');

          const prYM = document.getElementById('pr-year-month');
          const prQuery = document.getElementById('pr-query');
          const prReset = document.getElementById('pr-reset');

          ccQuery?.addEventListener('click', ()=>{
            if (!validateDateRange(ccFrom, ccTo)) { alert('請選擇有效日期區間'); return; }
            loadClientCost();
          });
          ccReset?.addEventListener('click', ()=>{ ccFrom.value=''; ccTo.value=''; document.getElementById('cc-client').value=''; bonus.checked=false; tip.style.display='none'; });
          bonus?.addEventListener('change', ()=>{ /* 切換年終分攤後重新查詢 */ if (validateDateRange(ccFrom, ccTo)) loadClientCost(); });
          ccTo?.addEventListener('change', ()=>{
            // 若包含 12 月，顯示提示
            try {
              const to = new Date(ccTo.value);
              tip.style.display = (to.getMonth() === 11) ? 'block' : 'none';
            } catch(_) { tip.style.display = 'none'; }
          });

          rcQuery?.addEventListener('click', ()=>{
            if (!validateDateRange(rcFrom, rcTo)) { alert('請選擇有效日期區間'); return; }
            loadRevenue();
          });
          rcReset?.addEventListener('click', ()=>{ rcFrom.value=''; rcTo.value=''; });

          ehQuery?.addEventListener('click', ()=>{
            if (!/^\d{4}-\d{2}$/.test(ehYM.value||'')) { alert('請選擇查詢月份'); return; }
            loadEmployeeHours();
          });
          ehReset?.addEventListener('click', ()=>{ ehYM.value=''; document.getElementById('eh-employee').value=''; });

          prQuery?.addEventListener('click', ()=>{
            if (!/^\d{4}-\d{2}$/.test(prYM.value||'')) { alert('請選擇查詢月份'); return; }
            loadPayroll();
          });
          prReset?.addEventListener('click', ()=>{ prYM.value=''; document.getElementById('pr-employee').value=''; });
        }

        function formatNumber(n){ try { return Number(n||0).toLocaleString(); } catch(_) { return String(n||0); } }

        async function loadClientCost(){
          const panel = document.getElementById('panel-client-cost');
          const tbody = panel.querySelector('.report-table tbody');
          const totalValueEl = panel.querySelector('.summary-card.type-info .value');
          const warnValueEl = panel.querySelector('.summary-card.type-warning .value');
          const from = (document.getElementById('cc-date-from')||{}).value;
          const to = (document.getElementById('cc-date-to')||{}).value;
          const client = (document.getElementById('cc-client')||{}).value?.trim();
          const includeBonus = (document.getElementById('cc-include-bonus')||{}).checked === true;
          if (!from || !to) return;
          const params = new URLSearchParams();
          params.set('start_date', from);
          params.set('end_date', to);
          if (client) params.set('client_id', client);
          if (includeBonus) params.set('include_year_end_bonus', 'true');
          try {
            tbody.innerHTML = '<tr><td colspan="10" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/reports/client-cost-analysis?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/reports'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const rows = Array.isArray(json.data) ? json.data : [];
            let totalCostAll = 0;
            tbody.innerHTML = '';
            if (!rows.length) {
              tbody.innerHTML = '<tr><td colspan="10" class="muted">尚無資料</td></tr>';
            } else {
              rows.forEach(r => {
                const salary = Number(r?.cost_breakdown?.salary_cost || 0);
                const oh = Number(r?.cost_breakdown?.overhead_cost || 0);
                const bonus = Number(r?.cost_breakdown?.year_end_bonus || 0);
                const total = Number(r?.cost_breakdown?.total_cost || (salary+oh+bonus));
                totalCostAll += total;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${r.company_name||r.client_id||''}</td>
                  <td class="number-cell">${formatNumber(r.total_actual_hours)}</td>
                  <td class="number-cell">${formatNumber(r.total_weighted_hours)}</td>
                  <td class="number-cell">${formatNumber(salary)}</td>
                  <td class="number-cell">${formatNumber(oh)}</td>
                  <td class="number-cell">${formatNumber(bonus)}</td>
                  <td class="number-cell">${formatNumber(total)}</td>
                  <td class="number-cell">${formatNumber(r.revenue||0)}</td>
                  <td class="number-cell">${formatNumber(r.gross_profit||0)}</td>
                  <td class="number-cell ${Number(r.profit_margin||0) >= 0 ? 'positive-value':'negative-value'}">${Number(r.profit_margin||0).toFixed(1)}%</td>
                `;
                tbody.appendChild(tr);
              });
            }
            totalValueEl.textContent = formatNumber(totalCostAll);
            const hasWarn = Array.isArray(json.warnings) && json.warnings.length > 0;
            warnValueEl.textContent = hasWarn ? '警示' : '正常';
          } catch (_) {
            tbody.innerHTML = '<tr><td colspan="10" style="color:#c0392b;">查詢失敗</td></tr>';
          }
        }

        async function loadEmployeeHours(){
          const panel = document.getElementById('panel-employee-hours');
          const ym = (document.getElementById('eh-year-month')||{}).value;
          if (!/^\d{4}-\d{2}$/.test(ym||'')) return;
          const userField = (document.getElementById('eh-employee')||{}).value?.trim();
          const params = new URLSearchParams();
          params.set('year', ym.slice(0,4));
          params.set('month', ym.slice(5,7));
          if (/^\d+$/.test(userField)) params.set('user_id', userField);
          const totalValueEl = panel.querySelector('.summary-card.type-info .value');
          const utilValueEl = panel.querySelector('.summary-card.type-success .value');
          const listEl = panel.querySelector('.employee-hours-list');
          try {
            listEl.innerHTML = '<div class="muted" style="padding:10px;">載入中…</div>';
            const res = await fetch(`${apiBase}/reports/employee-hours?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/reports'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const rows = Array.isArray(json.data) ? json.data : [];
            let totalHours = 0; let utilSum = 0;
            listEl.innerHTML = '';
            if (!rows.length) {
              listEl.innerHTML = '<div class="muted" style="padding:10px;">尚無資料</div>';
            } else {
              rows.forEach(r => {
                totalHours += Number(r.total_hours||0);
                utilSum += Number(r.utilization_rate||0);
                const item = document.createElement('div');
                item.className = 'employee-hours-item';
                item.innerHTML = `
                  <div class="employee-hours-name">${r.username||r.user_id}</div>
                  <div class="employee-hours-value">${formatNumber(r.total_hours||0)} <span class="employee-hours-unit">小時</span></div>
                `;
                listEl.appendChild(item);
              });
            }
            const avgUtil = rows.length ? (utilSum/rows.length) : 0;
            totalValueEl.textContent = formatNumber(totalHours);
            utilValueEl.textContent = `${avgUtil.toFixed(2)}%`;
          } catch (_) {
            listEl.innerHTML = '<div style="color:#c0392b;padding:10px;">查詢失敗</div>';
          }
        }

        async function loadPayroll(){
          const panel = document.getElementById('panel-payroll');
          const ym = (document.getElementById('pr-year-month')||{}).value;
          if (!/^\d{4}-\d{2}$/.test(ym||'')) return;
          const userField = (document.getElementById('pr-employee')||{}).value?.trim();
          const params = new URLSearchParams();
          params.set('year', ym.slice(0,4));
          params.set('month', ym.slice(5,7));
          if (/^\d+$/.test(userField)) params.set('user_id', userField);
          const totalValueEl = panel.querySelector('.summary-card.type-info .value');
          const tbody = panel.querySelector('.report-table tbody');
          try {
            tbody.innerHTML = '<tr><td colspan="8" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/reports/payroll-summary?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/reports'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const data = json.data || { summary:{}, by_employee:[] };
            const byEmp = Array.isArray(data.by_employee) ? data.by_employee : [];
            totalValueEl.textContent = formatNumber(data.summary?.total_gross_salary || 0);
            tbody.innerHTML = '';
            if (!byEmp.length) {
              tbody.innerHTML = '<tr><td colspan="8" class="muted">尚無資料</td></tr>';
            } else {
              byEmp.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${r.username||r.user_id}</td>
                  <td class="number-cell">${formatNumber(r.base_salary)}</td>
                  <td class="number-cell">${formatNumber(r.total_allowances)}</td>
                  <td class="number-cell">${formatNumber(r.total_bonuses)}</td>
                  <td class="number-cell">${formatNumber(r.overtime_pay)}</td>
                  <td class="number-cell">${formatNumber(r.gross_salary)}</td>
                  <td class="number-cell">${formatNumber(r.net_salary)}</td>
                  <td>${r.has_full_attendance ? '是' : '否'}</td>
                `;
                tbody.appendChild(tr);
              });
            }
          } catch (_) {
            tbody.innerHTML = '<tr><td colspan="8" style="color:#c0392b;">查詢失敗</td></tr>';
          }
        }

        async function loadRevenue(){
          const panel = document.getElementById('panel-receivables');
          const from = (document.getElementById('rc-date-from')||{}).value;
          const to = (document.getElementById('rc-date-to')||{}).value;
          if (!from || !to) return;
          const params = new URLSearchParams();
          params.set('start_date', from);
          params.set('end_date', to);
          const values = panel.querySelectorAll('.summary-card .value');
          const tbody = panel.querySelector('.report-table tbody');
          try {
            tbody.innerHTML = '<tr><td colspan="4" class="muted">載入中…</td></tr>';
            const res = await fetch(`${apiBase}/reports/revenue?${params.toString()}`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/reports'); return; }
            const json = await res.json();
            if (!res.ok || !json || json.ok !== true) throw new Error();
            const d = json.data || { summary:{}, monthly_trend:[], by_client:[] };
            // Summary cards: 開立 / 已收 / 應收 / 收款率
            if (values[0]) values[0].textContent = formatNumber(d.summary?.total_receipts || 0);
            if (values[1]) values[1].textContent = formatNumber(d.summary?.total_paid || 0);
            if (values[2]) values[2].textContent = formatNumber(d.summary?.total_outstanding || 0);
            if (values[3]) values[3].textContent = `${Number(d.summary?.collection_rate||0).toFixed(1)}%`;
            // Table by client
            const list = Array.isArray(d.by_client) ? d.by_client : [];
            tbody.innerHTML = '';
            if (!list.length) {
              tbody.innerHTML = '<tr><td colspan="4" class="muted">尚無資料</td></tr>';
            } else {
              list.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${r.company_name||r.client_id}</td>
                  <td class="number-cell">${formatNumber(r.total_receipts)}</td>
                  <td class="number-cell">${formatNumber(r.total_paid)}</td>
                  <td class="number-cell">${formatNumber(r.total_outstanding)}</td>
                `;
                tbody.appendChild(tr);
              });
            }
            // Chart placeholder update with simple summary
            const chartPH = panel.querySelector('.chart-wrapper .placeholder');
            if (chartPH) chartPH.textContent = `共 ${d.monthly_trend?.length||0} 個月份資料`;
          } catch (_) {
            tbody.innerHTML = '<tr><td colspan="4" style="color:#c0392b;">查詢失敗</td></tr>';
          }
        }

        async function bootstrap(){
          // 預設月份：本月
          const now = new Date();
          const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
          const ehYM = document.getElementById('eh-year-month');
          const prYM = document.getElementById('pr-year-month');
          if (ehYM) ehYM.value = ym;
          if (prYM) prYM.value = ym;

          // 權限：根據 /auth/me 決定可見的分頁
          try {
            const res = await fetch(`${apiBase}/auth/me`, { credentials:'include' });
            if (res.status === 401) { location.assign('/login?redirect=/internal/reports'); return; }
            const json = await res.json();
            const isAdmin = !!(json && json.ok && json.data && json.data.isAdmin);
            tabs.forEach(btn => {
              const adminOnly = btn.getAttribute('data-admin-only') === 'true';
              if (adminOnly && !isAdmin) btn.style.display = 'none';
            });
            // 預設啟用分頁：管理員=客戶成本；員工=員工工時
            setActiveTab(isAdmin ? 'client-cost' : 'employee-hours');
            permBar.style.display = 'none';
          } catch (_) {
            // 若讀取角色失敗，僅顯示員工工時分頁
            tabs.forEach(btn => { if (btn.getAttribute('data-admin-only') === 'true') btn.style.display = 'none'; });
            setActiveTab('employee-hours');
            permBar.textContent = '載入使用者資訊失敗，僅顯示個人報表';
            permBar.style.display = 'block';
          }

          attachValidation();

          // 預設日期區間：當月
          const y = now.getFullYear();
          const m = String(now.getMonth()+1).padStart(2,'0');
          const firstDay = `${y}-${m}-01`;
          const today = `${y}-${m}-${String(now.getDate()).padStart(2,'0')}`;
          const ccFrom = document.getElementById('cc-date-from');
          const ccTo = document.getElementById('cc-date-to');
          const rcFrom = document.getElementById('rc-date-from');
          const rcTo = document.getElementById('rc-date-to');
          if (ccFrom && !ccFrom.value) ccFrom.value = firstDay;
          if (ccTo && !ccTo.value) ccTo.value = today;
          if (rcFrom && !rcFrom.value) rcFrom.value = firstDay;
          if (rcTo && !rcTo.value) rcTo.value = today;
        }

        bootstrap();
      })();
    </script>
    <script defer type="module" src="/assets/js/components/bootstrap.js"></script>
  </body>
  </html>


